{"pr_number": 3613, "pr_title": "Add support for casting row to json with field name", "pr_createdAt": "2020-05-04T15:33:55Z", "pr_url": "https://github.com/trinodb/trino/pull/3613", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE4NTI5Ng==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r447185296", "bodyText": "nit: I would prefer if .. else instead of elvis.", "author": "losipiuk", "createdAt": "2020-06-29T18:56:57Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/RowToJsonCast.java", "diffHunk": "@@ -75,18 +82,43 @@ public ScalarFunctionImplementation specialize(BoundVariables boundVariables, in\n         checkCondition(canCastToJson(type), INVALID_CAST_ARGUMENT, \"Cannot cast %s to JSON\", type);\n \n         List<Type> fieldTypes = type.getTypeParameters();\n+        List<TypeSignatureParameter> typeSignatureParameters = type.getTypeSignature().getParameters();\n+\n+        List<String> fieldNames = new ArrayList<>(fieldTypes.size());\n         List<JsonGeneratorWriter> fieldWriters = new ArrayList<>(fieldTypes.size());\n         for (int i = 0; i < fieldTypes.size(); i++) {\n-            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i)));\n+            fieldNames.add(typeSignatureParameters.get(i).getNamedTypeSignature().getName().orElse(\"field\" + i));\n+            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i), legacyRowToJson));\n         }\n-        MethodHandle methodHandle = METHOD_HANDLE.bindTo(fieldWriters);\n+        MethodHandle methodHandle = legacyRowToJson ? LEGACY_METHOD_HANDLE.bindTo(fieldWriters) : METHOD_HANDLE.bindTo(fieldNames).bindTo(fieldWriters);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5MDM5NQ==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r447190395", "bodyText": "rename toJsonArray", "author": "losipiuk", "createdAt": "2020-06-29T19:06:06Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/RowToJsonCast.java", "diffHunk": "@@ -75,18 +82,43 @@ public ScalarFunctionImplementation specialize(BoundVariables boundVariables, in\n         checkCondition(canCastToJson(type), INVALID_CAST_ARGUMENT, \"Cannot cast %s to JSON\", type);\n \n         List<Type> fieldTypes = type.getTypeParameters();\n+        List<TypeSignatureParameter> typeSignatureParameters = type.getTypeSignature().getParameters();\n+\n+        List<String> fieldNames = new ArrayList<>(fieldTypes.size());\n         List<JsonGeneratorWriter> fieldWriters = new ArrayList<>(fieldTypes.size());\n         for (int i = 0; i < fieldTypes.size(); i++) {\n-            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i)));\n+            fieldNames.add(typeSignatureParameters.get(i).getNamedTypeSignature().getName().orElse(\"field\" + i));\n+            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i), legacyRowToJson));\n         }\n-        MethodHandle methodHandle = METHOD_HANDLE.bindTo(fieldWriters);\n+        MethodHandle methodHandle = legacyRowToJson ? LEGACY_METHOD_HANDLE.bindTo(fieldWriters) : METHOD_HANDLE.bindTo(fieldNames).bindTo(fieldWriters);\n \n         return new ScalarFunctionImplementation(\n                 false,\n                 ImmutableList.of(valueTypeArgumentProperty(RETURN_NULL_ON_NULL)),\n                 methodHandle);\n     }\n \n+    @UsedByGeneratedCode\n+    public static Slice toJson(List<String> fieldNames, List<JsonGeneratorWriter> fieldWriters, ConnectorSession session, Block block)\n+    {\n+        try {\n+            SliceOutput output = new DynamicSliceOutput(40);\n+            try (JsonGenerator jsonGenerator = createJsonGenerator(JSON_FACTORY, output)) {\n+                jsonGenerator.writeStartObject();\n+                for (int i = 0; i < block.getPositionCount(); i++) {\n+                    jsonGenerator.writeFieldName(fieldNames.get(i));\n+                    fieldWriters.get(i).writeJsonValue(jsonGenerator, block, i, session);\n+                }\n+                jsonGenerator.writeEndObject();\n+            }\n+            return output.slice();\n+        }\n+        catch (IOException e) {\n+            throwIfUnchecked(e);\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n     @UsedByGeneratedCode\n     public static Slice toJson(List<JsonGeneratorWriter> fieldWriters, ConnectorSession session, Block block)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5MDY2NQ==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r447190665", "bodyText": "rename to toJsonObject. I did not spot the difference between first and second method at first read.", "author": "losipiuk", "createdAt": "2020-06-29T19:06:33Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/RowToJsonCast.java", "diffHunk": "@@ -75,18 +82,43 @@ public ScalarFunctionImplementation specialize(BoundVariables boundVariables, in\n         checkCondition(canCastToJson(type), INVALID_CAST_ARGUMENT, \"Cannot cast %s to JSON\", type);\n \n         List<Type> fieldTypes = type.getTypeParameters();\n+        List<TypeSignatureParameter> typeSignatureParameters = type.getTypeSignature().getParameters();\n+\n+        List<String> fieldNames = new ArrayList<>(fieldTypes.size());\n         List<JsonGeneratorWriter> fieldWriters = new ArrayList<>(fieldTypes.size());\n         for (int i = 0; i < fieldTypes.size(); i++) {\n-            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i)));\n+            fieldNames.add(typeSignatureParameters.get(i).getNamedTypeSignature().getName().orElse(\"field\" + i));\n+            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i), legacyRowToJson));\n         }\n-        MethodHandle methodHandle = METHOD_HANDLE.bindTo(fieldWriters);\n+        MethodHandle methodHandle = legacyRowToJson ? LEGACY_METHOD_HANDLE.bindTo(fieldWriters) : METHOD_HANDLE.bindTo(fieldNames).bindTo(fieldWriters);\n \n         return new ScalarFunctionImplementation(\n                 false,\n                 ImmutableList.of(valueTypeArgumentProperty(RETURN_NULL_ON_NULL)),\n                 methodHandle);\n     }\n \n+    @UsedByGeneratedCode\n+    public static Slice toJson(List<String> fieldNames, List<JsonGeneratorWriter> fieldWriters, ConnectorSession session, Block block)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb3721e1bbee55ecf8a3c67b5d463b92f53a0754", "url": "https://github.com/trinodb/trino/commit/bb3721e1bbee55ecf8a3c67b5d463b92f53a0754", "message": "Add support for casting row to json with field name", "committedDate": "2020-07-31T04:00:58Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyNjYwMw==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625326603", "bodyText": "If the field name is missing, let's use an empty string as a key (see the discussion on the main conversation thread)", "author": "martint", "createdAt": "2021-05-03T19:51:19Z", "path": "core/trino-main/src/main/java/io/trino/operator/scalar/RowToJsonCast.java", "diffHunk": "@@ -73,11 +80,21 @@ protected ScalarFunctionImplementation specialize(FunctionBinding functionBindin\n         checkCondition(canCastToJson(type), INVALID_CAST_ARGUMENT, \"Cannot cast %s to JSON\", type);\n \n         List<Type> fieldTypes = type.getTypeParameters();\n+        List<TypeSignatureParameter> typeSignatureParameters = type.getTypeSignature().getParameters();\n+\n+        List<String> fieldNames = new ArrayList<>(fieldTypes.size());\n         List<JsonGeneratorWriter> fieldWriters = new ArrayList<>(fieldTypes.size());\n         for (int i = 0; i < fieldTypes.size(); i++) {\n-            fieldWriters.add(createJsonGeneratorWriter(fieldTypes.get(i)));\n+            fieldNames.add(typeSignatureParameters.get(i).getNamedTypeSignature().getName().orElse(\"field\" + i));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyNzMzMQ==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625327331", "bodyText": "Also, move this into the else block of the if below. It's not needed for legacy mode", "author": "martint", "createdAt": "2021-05-03T19:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyNjYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyODA0Mw==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625328043", "bodyText": "Same here. Use empty string for anonymous fields.", "author": "martint", "createdAt": "2021-05-03T19:53:49Z", "path": "core/trino-main/src/main/java/io/trino/util/JsonUtil.java", "diffHunk": "@@ -634,11 +637,23 @@ public void writeJsonValue(JsonGenerator jsonGenerator, Block block, int positio\n             }\n             else {\n                 Block rowBlock = type.getObject(block, position);\n-                jsonGenerator.writeStartArray();\n-                for (int i = 0; i < rowBlock.getPositionCount(); i++) {\n-                    fieldWriters.get(i).writeJsonValue(jsonGenerator, rowBlock, i);\n+\n+                if (legacyRowToJson) {\n+                    jsonGenerator.writeStartArray();\n+                    for (int i = 0; i < rowBlock.getPositionCount(); i++) {\n+                        fieldWriters.get(i).writeJsonValue(jsonGenerator, rowBlock, i);\n+                    }\n+                    jsonGenerator.writeEndArray();\n+                }\n+                else {\n+                    List<TypeSignatureParameter> typeSignatureParameters = type.getTypeSignature().getParameters();\n+                    jsonGenerator.writeStartObject();\n+                    for (int i = 0; i < rowBlock.getPositionCount(); i++) {\n+                        jsonGenerator.writeFieldName(typeSignatureParameters.get(i).getNamedTypeSignature().getName().orElse(\"field\" + i));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyODcyMg==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625328722", "bodyText": "The default should be false", "author": "martint", "createdAt": "2021-05-03T19:55:00Z", "path": "core/trino-main/src/main/java/io/trino/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -88,6 +88,7 @@\n     private boolean pushTableWriteThroughUnion = true;\n     private DataIntegrityVerification exchangeDataIntegrityVerification = DataIntegrityVerification.ABORT;\n     private boolean exchangeCompressionEnabled;\n+    private boolean legacyRowToJsonCast = true;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyOTAxNA==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625329014", "bodyText": "Don't use angle brackets for parametric types. That's the legacy form. Use map(bigint, bigint), instead.", "author": "martint", "createdAt": "2021-05-03T19:55:31Z", "path": "core/trino-main/src/test/java/io/trino/type/TestMapOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestMapOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testMapToJson()\n+    {\n+        // Test key ordering\n+        assertFunction(\"CAST(MAP(ARRAY[7,5,3,1], ARRAY[8,6,4,2]) AS JSON)\", JSON, \"{\\\"1\\\":2,\\\"3\\\":4,\\\"5\\\":6,\\\"7\\\":8}\");\n+        assertFunction(\"CAST(MAP(ARRAY[1,3,5,7], ARRAY[2,4,6,8]) AS JSON)\", JSON, \"{\\\"1\\\":2,\\\"3\\\":4,\\\"5\\\":6,\\\"7\\\":8}\");\n+\n+        // Test null value\n+        assertFunction(\"cast(cast (null as MAP<BIGINT, BIGINT>) AS JSON)\", JSON, null);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTMyOTQ4Mg==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r625329482", "bodyText": "Capitalize AS here and everywhere else.", "author": "martint", "createdAt": "2021-05-03T19:56:16Z", "path": "core/trino-main/src/test/java/io/trino/type/TestRowOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestRowOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestRowOperatorsLegacy() {}\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testRowToJson()\n+    {\n+        assertFunction(\"cast(cast (null as ROW(BIGINT, VARCHAR)) AS JSON)\", JSON, null);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjgxNDA1Ng==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r626814056", "bodyText": "ARRAY(BIGINT)", "author": "martint", "createdAt": "2021-05-05T18:47:02Z", "path": "core/trino-main/src/test/java/io/trino/type/TestArrayOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import io.trino.sql.analyzer.FeaturesConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestArrayOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestArrayOperatorsLegacy()\n+    {\n+        super(new FeaturesConfig().setLegacyRowToJsonCast(true));\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testArrayToJson()\n+    {\n+        assertFunction(\"cast(cast (null AS ARRAY<BIGINT>) AS JSON)\", JSON, null);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjgxNDI0NQ==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r626814245", "bodyText": "ARRAY(SMALLINT)", "author": "martint", "createdAt": "2021-05-05T18:47:22Z", "path": "core/trino-main/src/test/java/io/trino/type/TestArrayOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import io.trino.sql.analyzer.FeaturesConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestArrayOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestArrayOperatorsLegacy()\n+    {\n+        super(new FeaturesConfig().setLegacyRowToJsonCast(true));\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testArrayToJson()\n+    {\n+        assertFunction(\"cast(cast (null AS ARRAY<BIGINT>) AS JSON)\", JSON, null);\n+        assertFunction(\"cast(ARRAY[] AS JSON)\", JSON, \"[]\");\n+        assertFunction(\"cast(ARRAY[null, null] AS JSON)\", JSON, \"[null,null]\");\n+\n+        assertFunction(\"cast(ARRAY[true, false, null] AS JSON)\", JSON, \"[true,false,null]\");\n+\n+        assertFunction(\"cast(cast(ARRAY[1, 2, null] AS ARRAY<TINYINT>) AS JSON)\", JSON, \"[1,2,null]\");\n+        assertFunction(\"cast(cast(ARRAY[12345, -12345, null] AS ARRAY<SMALLINT>) AS JSON)\", JSON, \"[12345,-12345,null]\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjgxNDM2Nw==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r626814367", "bodyText": "ARRAY(TINYINT)", "author": "martint", "createdAt": "2021-05-05T18:47:32Z", "path": "core/trino-main/src/test/java/io/trino/type/TestArrayOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import io.trino.sql.analyzer.FeaturesConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestArrayOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestArrayOperatorsLegacy()\n+    {\n+        super(new FeaturesConfig().setLegacyRowToJsonCast(true));\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testArrayToJson()\n+    {\n+        assertFunction(\"cast(cast (null AS ARRAY<BIGINT>) AS JSON)\", JSON, null);\n+        assertFunction(\"cast(ARRAY[] AS JSON)\", JSON, \"[]\");\n+        assertFunction(\"cast(ARRAY[null, null] AS JSON)\", JSON, \"[null,null]\");\n+\n+        assertFunction(\"cast(ARRAY[true, false, null] AS JSON)\", JSON, \"[true,false,null]\");\n+\n+        assertFunction(\"cast(cast(ARRAY[1, 2, null] AS ARRAY<TINYINT>) AS JSON)\", JSON, \"[1,2,null]\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjgxNDU0Mg==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r626814542", "bodyText": "ARRAY(BIGINT)", "author": "martint", "createdAt": "2021-05-05T18:47:48Z", "path": "core/trino-main/src/test/java/io/trino/type/TestArrayOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import io.trino.sql.analyzer.FeaturesConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestArrayOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestArrayOperatorsLegacy()\n+    {\n+        super(new FeaturesConfig().setLegacyRowToJsonCast(true));\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testArrayToJson()\n+    {\n+        assertFunction(\"cast(cast (null AS ARRAY<BIGINT>) AS JSON)\", JSON, null);\n+        assertFunction(\"cast(ARRAY[] AS JSON)\", JSON, \"[]\");\n+        assertFunction(\"cast(ARRAY[null, null] AS JSON)\", JSON, \"[null,null]\");\n+\n+        assertFunction(\"cast(ARRAY[true, false, null] AS JSON)\", JSON, \"[true,false,null]\");\n+\n+        assertFunction(\"cast(cast(ARRAY[1, 2, null] AS ARRAY<TINYINT>) AS JSON)\", JSON, \"[1,2,null]\");\n+        assertFunction(\"cast(cast(ARRAY[12345, -12345, null] AS ARRAY<SMALLINT>) AS JSON)\", JSON, \"[12345,-12345,null]\");\n+        assertFunction(\"cast(cast(ARRAY[123456789, -123456789, null] AS ARRAY<INTEGER>) AS JSON)\", JSON, \"[123456789,-123456789,null]\");\n+        assertFunction(\"cast(cast(ARRAY[1234567890123456789, -1234567890123456789, null] AS ARRAY<BIGINT>) AS JSON)\", JSON, \"[1234567890123456789,-1234567890123456789,null]\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjgxNDg0Nw==", "url": "https://github.com/trinodb/trino/pull/3613#discussion_r626814847", "bodyText": "ARRAY(TINYINT)", "author": "martint", "createdAt": "2021-05-05T18:48:19Z", "path": "core/trino-main/src/test/java/io/trino/type/TestMapOperatorsLegacy.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.type;\n+\n+import io.airlift.slice.Slice;\n+import io.trino.operator.scalar.AbstractTestFunctions;\n+import io.trino.spi.function.LiteralParameters;\n+import io.trino.spi.function.ScalarFunction;\n+import io.trino.spi.function.SqlType;\n+import io.trino.spi.type.StandardTypes;\n+import io.trino.sql.analyzer.FeaturesConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static io.trino.testing.DateTimeTestingUtils.sqlTimestampOf;\n+import static io.trino.type.JsonType.JSON;\n+import static java.lang.String.format;\n+\n+public class TestMapOperatorsLegacy\n+        extends AbstractTestFunctions\n+{\n+    public TestMapOperatorsLegacy()\n+    {\n+        super(new FeaturesConfig().setLegacyRowToJsonCast(true));\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        registerScalar(getClass());\n+    }\n+\n+    @ScalarFunction\n+    @LiteralParameters(\"x\")\n+    @SqlType(StandardTypes.JSON)\n+    public static Slice uncheckedToJson(@SqlType(\"varchar(x)\") Slice slice)\n+    {\n+        return slice;\n+    }\n+\n+    @Test\n+    public void testMapToJson()\n+    {\n+        // Test key ordering\n+        assertFunction(\"CAST(MAP(ARRAY[7,5,3,1], ARRAY[8,6,4,2]) AS JSON)\", JSON, \"{\\\"1\\\":2,\\\"3\\\":4,\\\"5\\\":6,\\\"7\\\":8}\");\n+        assertFunction(\"CAST(MAP(ARRAY[1,3,5,7], ARRAY[2,4,6,8]) AS JSON)\", JSON, \"{\\\"1\\\":2,\\\"3\\\":4,\\\"5\\\":6,\\\"7\\\":8}\");\n+\n+        // Test null value\n+        assertFunction(\"cast(cast (null AS MAP(BIGINT, BIGINT)) AS JSON)\", JSON, null);\n+        assertFunction(\"cast(MAP() AS JSON)\", JSON, \"{}\");\n+        assertFunction(\"cast(MAP(ARRAY[1, 2], ARRAY[null, null]) AS JSON)\", JSON, \"{\\\"1\\\":null,\\\"2\\\":null}\");\n+\n+        // Test key types\n+        assertFunction(\"CAST(MAP(ARRAY[true, false], ARRAY[1, 2]) AS JSON)\", JSON, \"{\\\"false\\\":2,\\\"true\\\":1}\");\n+\n+        assertFunction(\n+                \"cast(MAP(cast(ARRAY[1, 2, 3] AS ARRAY<TINYINT>), ARRAY[5, 8, null]) AS JSON)\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc06d0a90aa16e7f7439232aa5d502bdc826fe9c", "url": "https://github.com/trinodb/trino/commit/fc06d0a90aa16e7f7439232aa5d502bdc826fe9c", "message": "Add support for casting row to json with field name", "committedDate": "2021-05-06T15:06:52Z", "type": "commit"}, {"oid": "fc06d0a90aa16e7f7439232aa5d502bdc826fe9c", "url": "https://github.com/trinodb/trino/commit/fc06d0a90aa16e7f7439232aa5d502bdc826fe9c", "message": "Add support for casting row to json with field name", "committedDate": "2021-05-06T15:06:52Z", "type": "forcePushed"}]}