{"pr_number": 4043, "pr_title": "Don't block while compacting table on Hive", "pr_createdAt": "2020-06-16T10:06:53Z", "pr_url": "https://github.com/trinodb/trino/pull/4043", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MTcwNQ==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440741705", "bodyText": "Are all columns returned by SHOW COMPACTIONS strings?", "author": "losipiuk", "createdAt": "2020-06-16T10:15:04Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -166,4 +182,66 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n                 bucketingType.getHiveTableProperties().stream())\n                 .collect(joining(\",\", \"TBLPROPERTIES (\", \")\"));\n     }\n+\n+    private static void compactTableAndWait(CompactionMode compactMode, String tableName, Duration timeout)\n+    {\n+        onHive().executeQuery(format(\"ALTER TABLE %s COMPACT '%s'\", tableName, compactMode.name()));\n+\n+        Set<String> tableCompactionsIds = getTableCompactions(compactMode, tableName)\n+                .map(row -> row.get(\"compactionid\"))\n+                .collect(toUnmodifiableSet());\n+\n+        assertEventually(timeout, () -> {\n+            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n+                    .filter(row -> row.get(\"state\").equals(\"succeeded\"))\n+                    .map(row -> row.get(\"compactionid\"))\n+                    .collect(toUnmodifiableSet());\n+\n+            assertTrue(completedCompactionsIds.containsAll(tableCompactionsIds));\n+        });\n+    }\n+\n+    private static Stream<Map<String, String>> getTableCompactions(CompactionMode compactionMode, String tableName)\n+    {\n+        return Stream.of(onHive().executeQuery(\"SHOW COMPACTIONS\")).flatMap(TestHiveTransactionalTable::mapRows)\n+                .filter(row -> isTableCompaction(compactionMode, tableName, row));\n+    }\n+\n+    private static Stream<Map<String, String>> mapRows(QueryResult result)\n+    {\n+        if (result.getRowsCount() == 0) {\n+            return Stream.of();\n+        }\n+\n+        List<?> columnNames = result.row(0).stream()\n+                .filter(Objects::nonNull)\n+                .collect(toUnmodifiableList());\n+\n+        ImmutableList.Builder<Map<String, String>> rows = ImmutableList.builder();\n+        for (int rowIndex = 1; rowIndex < result.getRowsCount(); rowIndex++) {\n+            ImmutableMap.Builder<String, String> singleRow = ImmutableMap.builder();\n+            List<?> row = result.row(rowIndex);\n+\n+            for (int column = 0; column < columnNames.size(); column++) {\n+                String columnName = ((String) columnNames.get(column)).toLowerCase(ENGLISH);\n+                singleRow.put(columnName, (String) row.get(column));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NTQzMQ==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440745431", "bodyText": "Yes.", "author": "wendigo", "createdAt": "2020-06-16T10:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MTcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MjQ4NA==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440742484", "bodyText": "name isCompactionForTable", "author": "losipiuk", "createdAt": "2020-06-16T10:16:25Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -166,4 +182,66 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n                 bucketingType.getHiveTableProperties().stream())\n                 .collect(joining(\",\", \"TBLPROPERTIES (\", \")\"));\n     }\n+\n+    private static void compactTableAndWait(CompactionMode compactMode, String tableName, Duration timeout)\n+    {\n+        onHive().executeQuery(format(\"ALTER TABLE %s COMPACT '%s'\", tableName, compactMode.name()));\n+\n+        Set<String> tableCompactionsIds = getTableCompactions(compactMode, tableName)\n+                .map(row -> row.get(\"compactionid\"))\n+                .collect(toUnmodifiableSet());\n+\n+        assertEventually(timeout, () -> {\n+            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n+                    .filter(row -> row.get(\"state\").equals(\"succeeded\"))\n+                    .map(row -> row.get(\"compactionid\"))\n+                    .collect(toUnmodifiableSet());\n+\n+            assertTrue(completedCompactionsIds.containsAll(tableCompactionsIds));\n+        });\n+    }\n+\n+    private static Stream<Map<String, String>> getTableCompactions(CompactionMode compactionMode, String tableName)\n+    {\n+        return Stream.of(onHive().executeQuery(\"SHOW COMPACTIONS\")).flatMap(TestHiveTransactionalTable::mapRows)\n+                .filter(row -> isTableCompaction(compactionMode, tableName, row));\n+    }\n+\n+    private static Stream<Map<String, String>> mapRows(QueryResult result)\n+    {\n+        if (result.getRowsCount() == 0) {\n+            return Stream.of();\n+        }\n+\n+        List<?> columnNames = result.row(0).stream()\n+                .filter(Objects::nonNull)\n+                .collect(toUnmodifiableList());\n+\n+        ImmutableList.Builder<Map<String, String>> rows = ImmutableList.builder();\n+        for (int rowIndex = 1; rowIndex < result.getRowsCount(); rowIndex++) {\n+            ImmutableMap.Builder<String, String> singleRow = ImmutableMap.builder();\n+            List<?> row = result.row(rowIndex);\n+\n+            for (int column = 0; column < columnNames.size(); column++) {\n+                String columnName = ((String) columnNames.get(column)).toLowerCase(ENGLISH);\n+                singleRow.put(columnName, (String) row.get(column));\n+            }\n+\n+            rows.add(singleRow.build());\n+        }\n+\n+        return rows.build().stream();\n+    }\n+\n+    private static boolean isTableCompaction(CompactionMode compactMode, String tableName, Map<String, String> row)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MzA4MA==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440743080", "bodyText": "why 1?", "author": "losipiuk", "createdAt": "2020-06-16T10:17:27Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -166,4 +182,66 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n                 bucketingType.getHiveTableProperties().stream())\n                 .collect(joining(\",\", \"TBLPROPERTIES (\", \")\"));\n     }\n+\n+    private static void compactTableAndWait(CompactionMode compactMode, String tableName, Duration timeout)\n+    {\n+        onHive().executeQuery(format(\"ALTER TABLE %s COMPACT '%s'\", tableName, compactMode.name()));\n+\n+        Set<String> tableCompactionsIds = getTableCompactions(compactMode, tableName)\n+                .map(row -> row.get(\"compactionid\"))\n+                .collect(toUnmodifiableSet());\n+\n+        assertEventually(timeout, () -> {\n+            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n+                    .filter(row -> row.get(\"state\").equals(\"succeeded\"))\n+                    .map(row -> row.get(\"compactionid\"))\n+                    .collect(toUnmodifiableSet());\n+\n+            assertTrue(completedCompactionsIds.containsAll(tableCompactionsIds));\n+        });\n+    }\n+\n+    private static Stream<Map<String, String>> getTableCompactions(CompactionMode compactionMode, String tableName)\n+    {\n+        return Stream.of(onHive().executeQuery(\"SHOW COMPACTIONS\")).flatMap(TestHiveTransactionalTable::mapRows)\n+                .filter(row -> isTableCompaction(compactionMode, tableName, row));\n+    }\n+\n+    private static Stream<Map<String, String>> mapRows(QueryResult result)\n+    {\n+        if (result.getRowsCount() == 0) {\n+            return Stream.of();\n+        }\n+\n+        List<?> columnNames = result.row(0).stream()\n+                .filter(Objects::nonNull)\n+                .collect(toUnmodifiableList());\n+\n+        ImmutableList.Builder<Map<String, String>> rows = ImmutableList.builder();\n+        for (int rowIndex = 1; rowIndex < result.getRowsCount(); rowIndex++) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NjM3Mw==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440746373", "bodyText": "because first row contains column names (don't ask me why):\n0: jdbc:hive2://localhost:10000/default> show compactions;\nINFO  : Compiling command(queryId=hive_20200616160810_8658fc21-d5df-4028-9955-84af206d7d6a): show compactions\nINFO  : Semantic Analysis Completed (retrial = false)\nINFO  : Created Hive schema: Schema(fieldSchemas:[FieldSchema(name:compactionid, type:string, comment:from deserializer), FieldSchema(name:dbname, type:string, comment:from deserializer), FieldSchema(name:tabname, type:string, comment:from deserializer), FieldSchema(name:partname, type:string, comment:from deserializer), FieldSchema(name:type, type:string, comment:from deserializer), FieldSchema(name:state, type:string, comment:from deserializer), FieldSchema(name:hostname, type:string, comment:from deserializer), FieldSchema(name:workerid, type:string, comment:from deserializer), FieldSchema(name:starttime, type:string, comment:from deserializer), FieldSchema(name:duration, type:string, comment:from deserializer), FieldSchema(name:hadoopjobid, type:string, comment:from deserializer), FieldSchema(name:errormessage, type:string, comment:from deserializer)], properties:null)\nINFO  : Completed compiling command(queryId=hive_20200616160810_8658fc21-d5df-4028-9955-84af206d7d6a); Time taken: 1.118 seconds\nINFO  : Executing command(queryId=hive_20200616160810_8658fc21-d5df-4028-9955-84af206d7d6a): show compactions\nINFO  : Starting task [Stage-0:DDL] in serial mode\nINFO  : Completed executing command(queryId=hive_20200616160810_8658fc21-d5df-4028-9955-84af206d7d6a); Time taken: 0.059 seconds\nINFO  : OK\n+---------------+-----------+----------+------------+-------+--------+-----------+-------------+---------------+--------------+----------------+---------------+\n| compactionid  |  dbname   | tabname  |  partname  | type  | state  | hostname  |  workerid   |   starttime   |   duration   |  hadoopjobid   | errormessage  |\n+---------------+-----------+----------+------------+-------+--------+-----------+-------------+---------------+--------------+----------------+---------------+\n| CompactionId  | Database  | Table    | Partition  | Type  | State  | Worker    | Start Time  | Duration(ms)  | HadoopJobId  | Error message  | NULL          |\n+---------------+-----------+----------+------------+-------+--------+-----------+-------------+---------------+--------------+----------------+---------------+\n1 row selected (1.512 seconds)", "author": "wendigo", "createdAt": "2020-06-16T10:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MzA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NzQ2Nw==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440747467", "bodyText": "Is it possible that tableCompactionIds obtained above will contain a compaction which is in final, but nosucceeded state (e.g. failed)? Then we will never satisfy the assertion.\nNot sure if that is something to worry about. Possibly you may additionally list compactionIds before ALTER TABLE is called. And then ignore those later in assertion. Would that work?", "author": "losipiuk", "createdAt": "2020-06-16T10:25:40Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -166,4 +182,66 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n                 bucketingType.getHiveTableProperties().stream())\n                 .collect(joining(\",\", \"TBLPROPERTIES (\", \")\"));\n     }\n+\n+    private static void compactTableAndWait(CompactionMode compactMode, String tableName, Duration timeout)\n+    {\n+        onHive().executeQuery(format(\"ALTER TABLE %s COMPACT '%s'\", tableName, compactMode.name()));\n+\n+        Set<String> tableCompactionsIds = getTableCompactions(compactMode, tableName)\n+                .map(row -> row.get(\"compactionid\"))\n+                .collect(toUnmodifiableSet());\n+\n+        assertEventually(timeout, () -> {\n+            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n+                    .filter(row -> row.get(\"state\").equals(\"succeeded\"))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MTk3Mw==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r440951973", "bodyText": "Done.", "author": "wendigo", "createdAt": "2020-06-16T15:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NzQ2Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "53061a87af3a9b6e4265cb8032622b3d008c2bbe", "url": "https://github.com/trinodb/trino/commit/53061a87af3a9b6e4265cb8032622b3d008c2bbe", "message": "Don't block while compacting table on Hive", "committedDate": "2020-06-16T18:21:58Z", "type": "commit"}, {"oid": "53061a87af3a9b6e4265cb8032622b3d008c2bbe", "url": "https://github.com/trinodb/trino/commit/53061a87af3a9b6e4265cb8032622b3d008c2bbe", "message": "Don't block while compacting table on Hive", "committedDate": "2020-06-16T18:21:58Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2MDY1NQ==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r441460655", "bodyText": "nit: I would rather wrap the assertion with getHiveVersionMajor() >= 0. Otherwise one can not notice the return in the middle of the test and add assertion at the end. Then it will not be executed for Hive <= 4.0.", "author": "losipiuk", "createdAt": "2020-06-17T10:57:19Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -111,15 +126,21 @@ public void testReadInsertOnly(boolean isPartitioned, BucketingType bucketingTyp\n             assertThat(query(selectFromOnePartitionsSql)).containsExactly(row(1), row(2));\n \n             // test minor compacted data read\n-            onHive().executeQuery(\"ALTER TABLE \" + tableName + \" \" + hivePartitionString + \" COMPACT 'MINOR' AND WAIT\");\n+            compactTableAndWait(MINOR, tableName, hivePartitionString, Duration.valueOf(\"5m\"));\n             assertThat(query(selectFromOnePartitionsSql)).containsExactly(row(1), row(2));\n \n             onHive().executeQuery(\"INSERT OVERWRITE TABLE \" + tableName + hivePartitionString + \" SELECT 3\");\n             assertThat(query(selectFromOnePartitionsSql)).containsOnly(row(3));\n \n+            if (getHiveVersionMajor() < 4) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2MjQ4MA==", "url": "https://github.com/trinodb/trino/pull/4043#discussion_r441462480", "bodyText": "Makes sense :)", "author": "wendigo", "createdAt": "2020-06-17T11:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2MDY1NQ=="}], "type": "inlineReview"}, {"oid": "3eaecb9ac9f63256a6fb7075048bd9eaa7b7dad5", "url": "https://github.com/trinodb/trino/commit/3eaecb9ac9f63256a6fb7075048bd9eaa7b7dad5", "message": "Test MAJOR compaction on ACID insert-only tables on Hive >=4 only - HIVE-21280", "committedDate": "2020-06-17T11:00:41Z", "type": "commit"}, {"oid": "3eaecb9ac9f63256a6fb7075048bd9eaa7b7dad5", "url": "https://github.com/trinodb/trino/commit/3eaecb9ac9f63256a6fb7075048bd9eaa7b7dad5", "message": "Test MAJOR compaction on ACID insert-only tables on Hive >=4 only - HIVE-21280", "committedDate": "2020-06-17T11:00:41Z", "type": "forcePushed"}]}