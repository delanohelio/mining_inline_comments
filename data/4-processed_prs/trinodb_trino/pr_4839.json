{"pr_number": 4839, "pr_title": "Fixes JAVA_HOME in container image", "pr_createdAt": "2020-08-14T21:04:47Z", "pr_url": "https://github.com/trinodb/trino/pull/4839", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNDMyMQ==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472434321", "bodyText": "Do we need to override the entry point? It seems like running the command directly works:\ndocker run --rm \"${CONTAINER_NAME}\" /bin/bash -c '$JAVA_HOME/bin/java -version' &> /dev/null\n\nIf we use ' instead of \" we don't need to escape the $ in the argument.", "author": "electrum", "createdAt": "2020-08-18T19:36:52Z", "path": "docker/container-test.sh", "diffHunk": "@@ -33,3 +33,10 @@ function test_container {\n     # Return proper exit code.\n     [[ ${RESULT} == '\"success\"' ]]\n }\n+\n+function test_javahome {\n+    # Check if JAVA_HOME works\n+    docker run --rm --entrypoint /bin/bash \"${CONTAINER_NAME}\" -c \"\\$JAVA_HOME/bin/java -version\" &> /dev/null", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NzA2MQ==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472557061", "bodyText": "no need to override the entrypoint since I saw it uses CMD instruction only in Dockerfile.", "author": "shawnzhu", "createdAt": "2020-08-18T23:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNDMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNTEyMw==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472435123", "bodyText": "This needs to be called from the two build-* scripts. Alternatively, is it possible to integrate this into the above test_container method so all the tests are in one function?", "author": "electrum", "createdAt": "2020-08-18T19:38:25Z", "path": "docker/container-test.sh", "diffHunk": "@@ -33,3 +33,10 @@ function test_container {\n     # Return proper exit code.\n     [[ ${RESULT} == '\"success\"' ]]\n }\n+\n+function test_javahome {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ1Mjg2Nw==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472452867", "bodyText": "it can certainly be included into the function test_container(). I usually put one test case per function.", "author": "shawnzhu", "createdAt": "2020-08-18T20:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNTEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjYyMQ==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472512621", "bodyText": "We could rename test_container to test_presto_starts, then create a new one that runs all the tests\nfunction test_container {\n    test_javahome && test_presto_starts\n}", "author": "electrum", "createdAt": "2020-08-18T21:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNTEyMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3MjQ0OA==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r472572448", "bodyText": "The variable is CONTAINER_ID", "author": "electrum", "createdAt": "2020-08-19T00:51:48Z", "path": "docker/container-test.sh", "diffHunk": "@@ -33,3 +33,14 @@ function test_container {\n     # Return proper exit code.\n     [[ ${RESULT} == '\"success\"' ]]\n }\n+\n+function test_javahome {\n+    # Check if JAVA_HOME works\n+    docker run --rm \"${CONTAINER_NAME}\" /bin/bash -c '$JAVA_HOME/bin/java -version' &> /dev/null", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA2MDEzNQ==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r473060135", "bodyText": "the container instance with $CONTAINER_ID will be stopped right before test_presto_starts() is executed. this command here is creating a new container and remove it immediately after docker command execution.\nIf you suggest running two tests test_javahome and test_presto_starts within a single container instance, I can refactor it later.", "author": "shawnzhu", "createdAt": "2020-08-19T14:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3MjQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NzU0NA==", "url": "https://github.com/trinodb/trino/pull/4839#discussion_r473077544", "bodyText": "Sorry, I saw an error that the variable wasn\u2019t set and got it mixed up. Your fix is correct.", "author": "electrum", "createdAt": "2020-08-19T14:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3MjQ0OA=="}], "type": "inlineReview"}, {"oid": "50463ebe37a65c2c25ae40a744e52a9f737ba5f9", "url": "https://github.com/trinodb/trino/commit/50463ebe37a65c2c25ae40a744e52a9f737ba5f9", "message": "Fix JAVA_HOME in container image\n\nSigned-off-by: Ke Zhu <kzhu@us.ibm.com>", "committedDate": "2020-08-19T14:07:08Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "a068455d37c6616266f3a4a2229c7bc7ca3f1b4c", "url": "https://github.com/trinodb/trino/commit/a068455d37c6616266f3a4a2229c7bc7ca3f1b4c", "message": "Add new test to verify if JAVA_HOME works\n\nSigned-off-by: Ke Zhu <kzhu@us.ibm.com>", "committedDate": "2020-08-19T14:32:50Z", "type": "commit"}, {"oid": "a068455d37c6616266f3a4a2229c7bc7ca3f1b4c", "url": "https://github.com/trinodb/trino/commit/a068455d37c6616266f3a4a2229c7bc7ca3f1b4c", "message": "Add new test to verify if JAVA_HOME works\n\nSigned-off-by: Ke Zhu <kzhu@us.ibm.com>", "committedDate": "2020-08-19T14:32:50Z", "type": "forcePushed"}]}