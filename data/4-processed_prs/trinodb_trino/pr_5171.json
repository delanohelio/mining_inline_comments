{"pr_number": 5171, "pr_title": "Recreate network on environment startup try", "pr_createdAt": "2020-09-15T14:59:45Z", "pr_url": "https://github.com/trinodb/trino/pull/5171", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r488740663", "bodyText": "i often use the fact that the containers have fixed, easy name\nsee #4834 (comment)", "author": "findepi", "createdAt": "2020-09-15T15:03:10Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environments.java", "diffHunk": "@@ -109,4 +158,45 @@ public static String nameForConfigClass(Class<? extends EnvironmentConfig> clazz\n     {\n         return CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_HYPHEN, clazz.getSimpleName());\n     }\n+\n+    public static String networkName(String environmentName)\n+    {\n+        return format(\"%s.%s\", environmentName, PRODUCT_TEST_ENVIRONMENT);\n+    }\n+\n+    public static String containerId(String environmentName, String containerName)\n+    {\n+        return format(\"%s-%s\", environmentName, containerName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1MTg0NQ==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r488751845", "bodyText": "I've zsh function for that. Is it a big deal for you?", "author": "wendigo", "createdAt": "2020-09-15T15:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2OTY5OQ==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r488769699", "bodyText": "I can reverse the name (containerName-environmentName) which will make it easier to autocomplete", "author": "wendigo", "createdAt": "2020-09-15T15:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MDE4Ng==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489280186", "bodyText": "Would it help me to run docker exec -it ptl-hadoop-master bash -l easily?\noften in a different shell than the one that was starting the environment?", "author": "findepi", "createdAt": "2020-09-16T09:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4Mzk3OQ==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489283979", "bodyText": "I can reverse the name (containerName-environmentName) which will make it easier to autocomplete\n\ninteresting idea!\nfwiw, i am heavy history user (ctrl+r in bash)", "author": "findepi", "createdAt": "2020-09-16T09:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4NDMzOA==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489284338", "bodyText": "Also, if i had 2 envs running side by side, i'd prefer env name to be prefix", "author": "findepi", "createdAt": "2020-09-16T09:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyMzU3Ng==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489323576", "bodyText": "nit: constant?", "author": "losipiuk", "createdAt": "2020-09-16T10:11:51Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -195,20 +197,30 @@ public void close()\n         stop();\n     }\n \n-    public static class Builder\n+    private static void attachNetwork(Collection<DockerContainer> values, Network network)\n     {\n-        private final String name;\n-        private DockerContainer.OutputMode outputMode;\n-        private int startupRetries = 1;\n+        values.forEach(container -> container.withNetwork(network));\n+    }\n \n-        @SuppressWarnings(\"resource\")\n-        private Network network = Network.builder()\n+    private static Network createNetwork(String environmentName)\n+    {\n+        Network network = Network.builder()\n                 .createNetworkCmdModifier(createNetworkCmd ->\n                         createNetworkCmd\n                                 .withName(PRODUCT_TEST_LAUNCHER_NETWORK)\n-                                .withLabels(ImmutableMap.of(PRODUCT_TEST_LAUNCHER_STARTED_LABEL_NAME, PRODUCT_TEST_LAUNCHER_STARTED_LABEL_VALUE)))\n+                                .withLabels(ImmutableMap.of(\n+                                        PRODUCT_TEST_LAUNCHER_STARTED_LABEL_NAME, PRODUCT_TEST_LAUNCHER_STARTED_LABEL_VALUE,\n+                                        \"ptl.environment.name\", environmentName)))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYyMzQyNw==", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489623427", "bodyText": "Shouldn't we warn also in case when Optional is empty?", "author": "losipiuk", "createdAt": "2020-09-16T18:03:04Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -188,12 +188,14 @@ static EnvironmentListener statsPrintingListener()\n             @Override\n             public void containerStopping(DockerContainer container, InspectContainerResponse response)\n             {\n-                try {\n-                    log.info(\"Container %s stats: %s\", container, mapper.writeValueAsString(container.getStats()));\n-                }\n-                catch (JsonProcessingException e) {\n-                    log.warn(\"Could not display container %s stats: %s\", container, e);\n-                }\n+                container.getStats().ifPresent(statistics -> {\n+                    try {\n+                        log.info(\"Container %s stats: %s\", container, mapper.writeValueAsString(statistics));\n+                    }\n+                    catch (JsonProcessingException e) {\n+                        log.warn(\"Could not display container %s stats: %s\", container, e);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "88883cab98bcaae78872b5c70d0b21c679f8c9ad", "url": "https://github.com/trinodb/trino/commit/88883cab98bcaae78872b5c70d0b21c679f8c9ad", "message": "Create new network on environment startup", "committedDate": "2020-09-16T18:16:21Z", "type": "commit"}, {"oid": "0247dc9a51bcdcd666ba9ba1bc62f596b0af915a", "url": "https://github.com/trinodb/trino/commit/0247dc9a51bcdcd666ba9ba1bc62f596b0af915a", "message": "Fix starting multinode environment without presto", "committedDate": "2020-09-16T18:16:21Z", "type": "commit"}, {"oid": "b2affe8d9999ceedafd03e53d2804c519a4761ec", "url": "https://github.com/trinodb/trino/commit/b2affe8d9999ceedafd03e53d2804c519a4761ec", "message": "Remove unused constant", "committedDate": "2020-09-16T18:16:21Z", "type": "commit"}, {"oid": "ec8a3900ec5c27154cd70df7de38a25593f0cf08", "url": "https://github.com/trinodb/trino/commit/ec8a3900ec5c27154cd70df7de38a25593f0cf08", "message": "Make EnvironmentDown callable", "committedDate": "2020-09-16T18:16:21Z", "type": "commit"}, {"oid": "a05db517e3edc4f9a398b83a551ff5ec5ffdb0d2", "url": "https://github.com/trinodb/trino/commit/a05db517e3edc4f9a398b83a551ff5ec5ffdb0d2", "message": "Fix displaying stats", "committedDate": "2020-09-16T18:18:41Z", "type": "commit"}, {"oid": "afa912f8eff43c2e908b16b803477d7d3f88cc2c", "url": "https://github.com/trinodb/trino/commit/afa912f8eff43c2e908b16b803477d7d3f88cc2c", "message": "Intercept and log listener exceptions", "committedDate": "2020-09-16T18:18:42Z", "type": "commit"}, {"oid": "dd636ad948504181bf9192230fe51373484b95b3", "url": "https://github.com/trinodb/trino/commit/dd636ad948504181bf9192230fe51373484b95b3", "message": "Improve hadoop-master-2 container configuration", "committedDate": "2020-09-16T18:18:42Z", "type": "commit"}, {"oid": "dd636ad948504181bf9192230fe51373484b95b3", "url": "https://github.com/trinodb/trino/commit/dd636ad948504181bf9192230fe51373484b95b3", "message": "Improve hadoop-master-2 container configuration", "committedDate": "2020-09-16T18:18:42Z", "type": "forcePushed"}, {"oid": "118ccec75eea78163e7109ec6c3b869f884204a4", "url": "https://github.com/trinodb/trino/commit/118ccec75eea78163e7109ec6c3b869f884204a4", "message": "Improve environment shutdown", "committedDate": "2020-09-17T08:40:52Z", "type": "commit"}]}