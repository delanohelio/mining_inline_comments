{"pr_number": 4123, "pr_title": "Reduce memory usage of TypedSet", "pr_createdAt": "2020-06-21T11:13:05Z", "pr_url": "https://github.com/trinodb/trino/pull/4123", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzNDcyMw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r447534723", "bodyText": "Int array list is backed by primitive array, but provides nicer interface and support for growing. No need to replace it", "author": "sopel39", "createdAt": "2020-06-30T09:12:40Z", "path": "presto-main/src/main/java/io/prestosql/operator/aggregation/TypedSet.java", "diffHunk": "@@ -43,12 +44,11 @@\n     public static final DataSize MAX_FUNCTION_MEMORY = DataSize.of(4, MEGABYTE);\n \n     private static final int INSTANCE_SIZE = ClassLayout.parseClass(TypedSet.class).instanceSize();\n-    private static final int INT_ARRAY_LIST_INSTANCE_SIZE = ClassLayout.parseClass(IntArrayList.class).instanceSize();\n     private static final float FILL_RATIO = 0.75f;\n \n     private final Type elementType;\n     private final Optional<MethodHandle> elementIsDistinctFrom;\n-    private final IntArrayList blockPositionByHash;\n+    private int[] blockPositionByHash;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3MjQ2NQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r450572465", "bodyText": "Agreed. The only real issue is this code uses get instead of getInt", "author": "dain", "createdAt": "2020-07-07T02:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzNDcyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwODEyOA==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r454408128", "bodyText": "The reasons I thought this was a good idea\n\nSmall amount of extra memory for wrapper ClassLayout.parseClass(IntArrayList.class).instanceSize().\nWe don't use any of the fancy features from the wrapper class.\nCode is shorter and easier to read.\nExtra bounds checking on each set and get by the wrapper.\nIntArrays.ensureCapacity allocates a new array and then tries to preserve values from current array. In our usage we explicitly reset all the values anyway after blockPositionByHash.size(hashCapacity) calls so the extra work to preserve values is wasted.\nKeyValuePairs class has almost same code and it also avoids using the wrapper.\n\nBut I'm ok to drop the change if the above are not compelling enough reasons to replace the wrapper.", "author": "raunaqmorarka", "createdAt": "2020-07-14T14:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzNDcyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg0NjkyMA==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r460846920", "bodyText": "But I'm ok to drop the change if the above are not compelling enough reasons to replace the wrapper.\n\n@raunaqmorarka Could you change the PR to use getInt instead of get?", "author": "sopel39", "createdAt": "2020-07-27T12:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzNDcyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyOTU4Ng==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461329586", "bodyText": "Done", "author": "raunaqmorarka", "createdAt": "2020-07-28T05:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzNDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzOTkwNg==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r447539906", "bodyText": "Chart doesn't occupy full declared length. Trailing spaces are not stored.", "author": "sopel39", "createdAt": "2020-06-30T09:20:49Z", "path": "presto-main/src/main/java/io/prestosql/type/TypeUtils.java", "diffHunk": "@@ -45,6 +47,15 @@ public static int expectedValueSize(Type type, int defaultSize)\n         if (type instanceof FixedWidthType) {\n             return ((FixedWidthType) type).getFixedSize();\n         }\n+        else if (type instanceof VarcharType) {\n+            // If bound on length of varchar is smaller than defaultSize, use that as expected size\n+            return ((VarcharType) type).getLength()\n+                    .map(length -> Math.min(length, defaultSize))\n+                    .orElse(defaultSize);\n+        }\n+        else if (type instanceof CharType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyMzg5Mw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461323893", "bodyText": "Currently CharType is not allowed to store trailing spaces https://github.com/prestosql/presto/blob/283f5b3c42002082dcd68b8eab37432b5b90b32f/presto-spi/src/main/java/io/prestosql/spi/type/CharType.java#L144\nThough you're right about not occupying full declared length, will change this.", "author": "raunaqmorarka", "createdAt": "2020-07-28T05:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzOTkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r447540049", "bodyText": "Varchars usually won't occupy full declared length.", "author": "sopel39", "createdAt": "2020-06-30T09:21:05Z", "path": "presto-main/src/main/java/io/prestosql/type/TypeUtils.java", "diffHunk": "@@ -45,6 +47,15 @@ public static int expectedValueSize(Type type, int defaultSize)\n         if (type instanceof FixedWidthType) {\n             return ((FixedWidthType) type).getFixedSize();\n         }\n+        else if (type instanceof VarcharType) {\n+            // If bound on length of varchar is smaller than defaultSize, use that as expected size\n+            return ((VarcharType) type).getLength()\n+                    .map(length -> Math.min(length, defaultSize))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3MzY1OQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r450573659", "bodyText": "varchar length is \"character count\", andvarchar is encoded in UTF-8 which means up to 4 bytes per character.  If this is just an expected size, assuming ascii is reasoanble, but we should note that in a comment here.", "author": "dain", "createdAt": "2020-07-07T02:14:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyOTQ0Nw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461329447", "bodyText": "Added a comment for UTF-8", "author": "raunaqmorarka", "createdAt": "2020-07-28T05:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNjE4MA==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461436180", "bodyText": "I still don't think that assuming that varchar will occupy entire length is the correct one. It seems very pessimistic. What do you think @dain?", "author": "sopel39", "createdAt": "2020-07-28T09:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzOTMwMA==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461439300", "bodyText": "@sopel39 that's why we do min here, right?", "author": "findepi", "createdAt": "2020-07-28T09:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1MTY2MA==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461451660", "bodyText": "I'm not sure what contract of defaultSize is here. Could it be excessively large?", "author": "sopel39", "createdAt": "2020-07-28T09:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3NTkxMw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461575913", "bodyText": "In current usage defaultSize is 16, 32 or 100 depending on where it's getting called from. This change should just reduce the expected size estimate when a smaller bound is known (E.g. varchar(10)). This would help reduce memory usage in cases where a large no. of TypeSet are generated but each set has small no. of entries which are a few characters long.", "author": "raunaqmorarka", "createdAt": "2020-07-28T13:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyOTA4OQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r462629089", "bodyText": "I think we should assume the default size is one byte.  I would update the comment a bit:\nIt can take up to 4 bytes per character due to UTF-8 encoding, but we assume the data is ASCII and only needs one byte.", "author": "dain", "createdAt": "2020-07-29T22:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0NzE2NQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r462847165", "bodyText": "Updated the comments in code", "author": "raunaqmorarka", "createdAt": "2020-07-30T08:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MDA0OQ=="}], "type": "inlineReview"}, {"oid": "0fc03f402286ddd9a16817b46d599241e8761c00", "url": "https://github.com/trinodb/trino/commit/0fc03f402286ddd9a16817b46d599241e8761c00", "message": "Use getInt to access IntArrayList", "committedDate": "2020-07-27T20:01:49Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzOTY1MQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461339651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // We may use up to 4 bytes per character due to UTF-8 encoding, assuming ascii for estimating size\n          \n          \n            \n                    // We may use up to 4 bytes per character due to UTF-8 encoding, assuming ASCII for estimating size", "author": "findepi", "createdAt": "2020-07-28T06:07:42Z", "path": "presto-main/src/main/java/io/prestosql/type/TypeUtils.java", "diffHunk": "@@ -57,6 +59,16 @@ public static int expectedValueSize(Type type, int defaultSize)\n         if (type instanceof FixedWidthType) {\n             return ((FixedWidthType) type).getFixedSize();\n         }\n+        // If bound on length of varchar or char is smaller than defaultSize, use that as expected size\n+        // We may use up to 4 bytes per character due to UTF-8 encoding, assuming ascii for estimating size", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzOTY4Mw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461339683", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    else if (type instanceof VarcharType) {\n          \n          \n            \n                    if (type instanceof VarcharType) {", "author": "findepi", "createdAt": "2020-07-28T06:07:48Z", "path": "presto-main/src/main/java/io/prestosql/type/TypeUtils.java", "diffHunk": "@@ -57,6 +59,16 @@ public static int expectedValueSize(Type type, int defaultSize)\n         if (type instanceof FixedWidthType) {\n             return ((FixedWidthType) type).getFixedSize();\n         }\n+        // If bound on length of varchar or char is smaller than defaultSize, use that as expected size\n+        // We may use up to 4 bytes per character due to UTF-8 encoding, assuming ascii for estimating size\n+        else if (type instanceof VarcharType) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzOTcyMw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461339723", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    else if (type instanceof CharType) {\n          \n          \n            \n                    if (type instanceof CharType) {", "author": "findepi", "createdAt": "2020-07-28T06:07:57Z", "path": "presto-main/src/main/java/io/prestosql/type/TypeUtils.java", "diffHunk": "@@ -57,6 +59,16 @@ public static int expectedValueSize(Type type, int defaultSize)\n         if (type instanceof FixedWidthType) {\n             return ((FixedWidthType) type).getFixedSize();\n         }\n+        // If bound on length of varchar or char is smaller than defaultSize, use that as expected size\n+        // We may use up to 4 bytes per character due to UTF-8 encoding, assuming ascii for estimating size\n+        else if (type instanceof VarcharType) {\n+            return ((VarcharType) type).getLength()\n+                    .map(length -> Math.min(length, defaultSize))\n+                    .orElse(defaultSize);\n+        }\n+        else if (type instanceof CharType) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNzM2Nw==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461437367", "bodyText": "this needs a comment about multibyte UTF-8", "author": "sopel39", "createdAt": "2020-07-28T09:12:59Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/VarcharType.java", "diffHunk": "@@ -136,6 +137,15 @@ public int compareTo(Block leftBlock, int leftPosition, Block rightBlock, int ri\n         return leftBlock.compareTo(leftPosition, 0, leftLength, rightBlock, rightPosition, 0, rightLength);\n     }\n \n+    @Override\n+    public BlockBuilder createBlockBuilder(BlockBuilderStatus blockBuilderStatus, int expectedEntries)\n+    {\n+        return createBlockBuilder(blockBuilderStatus, expectedEntries, getLength()\n+                // If bound on length is smaller than EXPECTED_BYTES_PER_ENTRY, use that as expected size", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNzQ0NQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461437445", "bodyText": "nit: each arg in newline", "author": "sopel39", "createdAt": "2020-07-28T09:13:07Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/VarcharType.java", "diffHunk": "@@ -136,6 +137,15 @@ public int compareTo(Block leftBlock, int leftPosition, Block rightBlock, int ri\n         return leftBlock.compareTo(leftPosition, 0, leftLength, rightBlock, rightPosition, 0, rightLength);\n     }\n \n+    @Override\n+    public BlockBuilder createBlockBuilder(BlockBuilderStatus blockBuilderStatus, int expectedEntries)\n+    {\n+        return createBlockBuilder(blockBuilderStatus, expectedEntries, getLength()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNzQ3OQ==", "url": "https://github.com/trinodb/trino/pull/4123#discussion_r461437479", "bodyText": "this needs a comment about multibyte UTF-8", "author": "sopel39", "createdAt": "2020-07-28T09:13:11Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/CharType.java", "diffHunk": "@@ -108,6 +109,12 @@ public int compareTo(Block leftBlock, int leftPosition, Block rightBlock, int ri\n         return compareChars(leftSlice, rightSlice);\n     }\n \n+    @Override\n+    public BlockBuilder createBlockBuilder(BlockBuilderStatus blockBuilderStatus, int expectedEntries)\n+    {\n+        return createBlockBuilder(blockBuilderStatus, expectedEntries, Math.min(length, EXPECTED_BYTES_PER_ENTRY));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "3fa8534976b5a9672e54a30ae30b5d2bf29fb942", "url": "https://github.com/trinodb/trino/commit/3fa8534976b5a9672e54a30ae30b5d2bf29fb942", "message": "Use length of VarcharType and CharType to calculate EXPECTED_ENTRY_SIZE", "committedDate": "2020-07-30T08:47:38Z", "type": "commit"}, {"oid": "3fa8534976b5a9672e54a30ae30b5d2bf29fb942", "url": "https://github.com/trinodb/trino/commit/3fa8534976b5a9672e54a30ae30b5d2bf29fb942", "message": "Use length of VarcharType and CharType to calculate EXPECTED_ENTRY_SIZE", "committedDate": "2020-07-30T08:47:38Z", "type": "forcePushed"}]}