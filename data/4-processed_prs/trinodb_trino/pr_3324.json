{"pr_number": 3324, "pr_title": "Verify connector's applyProjection result", "pr_createdAt": "2020-04-03T09:55:04Z", "pr_url": "https://github.com/trinodb/trino/pull/3324", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwODQ5MA==", "url": "https://github.com/trinodb/trino/pull/3324#discussion_r403108490", "bodyText": "Be explicit about it (and throw a proper exception):\nif (!result.getProjections().stream().allMatch(Objects::isNull)) {\n    throw new PrestoException(...);\n}\n\nif (!result.getAssignments().stream().allMatch(Objects::isNull)) {\n    throw new PrestoException(...);\n}", "author": "martint", "createdAt": "2020-04-03T16:02:27Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataManager.java", "diffHunk": "@@ -1099,10 +1099,16 @@ public void validateScan(Session session, TableHandle table)\n \n         ConnectorSession connectorSession = session.toConnectorSession(catalogName);\n         return metadata.applyProjection(connectorSession, table.getConnectorHandle(), projections, assignments)\n-                .map(result -> new ProjectionApplicationResult<>(\n-                        new TableHandle(catalogName, result.getHandle(), table.getTransaction(), Optional.empty()),\n-                        result.getProjections(),\n-                        result.getAssignments()));\n+                .map(result -> {\n+                    // verify no nulls\n+                    List<ConnectorExpression> newProjections = ImmutableList.copyOf(result.getProjections());\n+                    List<ProjectionApplicationResult.Assignment> newAssignments = ImmutableList.copyOf(result.getAssignments());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcxOTMxNw==", "url": "https://github.com/trinodb/trino/pull/3324#discussion_r410719317", "bodyText": "changed to explicit code (but slightly different)", "author": "findepi", "createdAt": "2020-04-18T16:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwODQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExMDA5Mg==", "url": "https://github.com/trinodb/trino/pull/3324#discussion_r403110092", "bodyText": "Throw a PrestoException (we'll need a new error code similar to FUNCTION_IMPLEMENTATION_ERROR)", "author": "martint", "createdAt": "2020-04-03T16:05:12Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataManager.java", "diffHunk": "@@ -1104,6 +1104,13 @@ public void validateScan(Session session, TableHandle table)\n                     List<ConnectorExpression> newProjections = ImmutableList.copyOf(result.getProjections());\n                     List<ProjectionApplicationResult.Assignment> newAssignments = ImmutableList.copyOf(result.getAssignments());\n \n+                    verify(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExMDQzNA==", "url": "https://github.com/trinodb/trino/pull/3324#discussion_r403110434", "bodyText": "Throw a proper PrestoException", "author": "martint", "createdAt": "2020-04-03T16:05:50Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataManager.java", "diffHunk": "@@ -1111,6 +1113,15 @@ public void validateScan(Session session, TableHandle table)\n                             projections.size(),\n                             table);\n \n+                    Set<String> assignedVariables = newAssignments.stream()\n+                            .map(ProjectionApplicationResult.Assignment::getVariable)\n+                            .collect(toImmutableSet());\n+                    newProjections.stream()\n+                            .flatMap(connectorExpression -> ConnectorExpressions.extractVariables(connectorExpression).stream())\n+                            .map(Variable::getName)\n+                            .filter(variableName -> !assignedVariables.contains(variableName))\n+                            .findAny().ifPresent(variableName -> { throw new IllegalStateException(\"Unbound variable: \" + variableName); });", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxMjA1Nw==", "url": "https://github.com/trinodb/trino/pull/3324#discussion_r403312057", "bodyText": "i thought about that.\nthis should happen only during connector development, so i decided to go \"lite\" about these exceptions, and use brief forms of verification (like verify)\n(eg if we were to convert all requireNonNull to if ... throw PrestoException would not be fun, and would greatly harm readability for little or no value to end users)", "author": "findepi", "createdAt": "2020-04-03T20:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExMDQzNA=="}], "type": "inlineReview"}, {"oid": "640093b7447450d5286cbd25708eb53506df0cf6", "url": "https://github.com/trinodb/trino/commit/640093b7447450d5286cbd25708eb53506df0cf6", "message": "Verify connector did not return nulls", "committedDate": "2020-04-18T16:30:32Z", "type": "commit"}, {"oid": "3fa4c41416e2fb53791a58905a0ae60b78e29ea9", "url": "https://github.com/trinodb/trino/commit/3fa4c41416e2fb53791a58905a0ae60b78e29ea9", "message": "Verify projections returned from applyProjection()", "committedDate": "2020-04-18T16:30:32Z", "type": "commit"}, {"oid": "49c1a04549280ac0584ab4bf4cfdf265b13e09ab", "url": "https://github.com/trinodb/trino/commit/49c1a04549280ac0584ab4bf4cfdf265b13e09ab", "message": "Verify projections wrt assignments in applyProjection", "committedDate": "2020-04-18T16:30:32Z", "type": "commit"}, {"oid": "49c1a04549280ac0584ab4bf4cfdf265b13e09ab", "url": "https://github.com/trinodb/trino/commit/49c1a04549280ac0584ab4bf4cfdf265b13e09ab", "message": "Verify projections wrt assignments in applyProjection", "committedDate": "2020-04-18T16:30:32Z", "type": "forcePushed"}]}