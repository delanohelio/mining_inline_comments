{"pr_number": 4266, "pr_title": "Handle NaN when extracting predicate", "pr_createdAt": "2020-06-29T22:03:02Z", "pr_url": "https://github.com/trinodb/trino/pull/4266", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxMjk4MQ==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447312981", "bodyText": "We should probably stop using == checks against types to avoid any future backward compatibility issues if we decide to create instances on the fly, and for consistency across all type checks. .equals() is more robust and can be implemented internally to do the == check as necessary.", "author": "martint", "createdAt": "2020-06-29T23:19:31Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeUtils.java", "diffHunk": "@@ -89,6 +93,17 @@ else if (value instanceof String) {\n         }\n     }\n \n+    public static boolean isFloatingPointNaN(Type type, Object value)\n+    {\n+        if (type == DOUBLE) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMDc4MA==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447320780", "bodyText": "this is omnipresent pattern across a codebase, so we would need to (a) update all the paces and (b) have some safeguards on CI.\nespecially until we do (a), there isn't much of an added value in avoiding them in new code.", "author": "findepi", "createdAt": "2020-06-29T23:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxMjk4MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDg3OQ==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447454879", "bodyText": "different commit?", "author": "losipiuk", "createdAt": "2020-06-30T07:02:07Z", "path": "presto-spi/src/main/java/io/prestosql/spi/predicate/SortedRangeSet.java", "diffHunk": "@@ -181,6 +182,9 @@ public boolean isDiscreteSet()\n     @Override\n     public boolean containsValue(Object value)\n     {\n+        if (isFloatingPointNaN(type, value)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNzg0NQ==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447507845", "bodyText": "I will rename Handle NaN when extracting predicate to better describe its holistic approach", "author": "findepi", "createdAt": "2020-06-30T08:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1NDg3OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzMjMwOQ==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447632309", "bodyText": "@sopel39 suggests we can skip the NaN values instead (like we skip NULLs).", "author": "findepi", "createdAt": "2020-06-30T12:08:57Z", "path": "presto-main/src/main/java/io/prestosql/operator/DynamicFilterSourceOperator.java", "diffHunk": "@@ -249,15 +250,20 @@ public void finish()\n \n     private Domain convertToDomain(Type type, Block block)\n     {\n+        // Inner and right join doesn't match rows with null key column values.\n+        boolean nullAllowed = false;\n+\n         ImmutableList.Builder<Object> values = ImmutableList.builder();\n         for (int position = 0; position < block.getPositionCount(); ++position) {\n             Object value = TypeUtils.readNativeValue(type, block, position);\n             if (value != null) {\n+                if (isFloatingPointNaN(type, value)) {\n+                    return Domain.create(ValueSet.all(type), nullAllowed);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzNDA1Mw==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447634053", "bodyText": "i pushed an update", "author": "findepi", "createdAt": "2020-06-30T12:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzMjMwOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "093c8b954d61db61b7ce226bfb35633177a401df", "url": "https://github.com/trinodb/trino/commit/093c8b954d61db61b7ce226bfb35633177a401df", "message": "Fix formatting", "committedDate": "2020-06-30T12:14:35Z", "type": "commit"}, {"oid": "96034b79ee4412de9377e0ad642c303d01c53d4d", "url": "https://github.com/trinodb/trino/commit/96034b79ee4412de9377e0ad642c303d01c53d4d", "message": "Extract isFloatingPointNaN method", "committedDate": "2020-06-30T12:14:36Z", "type": "commit"}, {"oid": "189cf6a2011484129dad810e60ded52c9e6718ba", "url": "https://github.com/trinodb/trino/commit/189cf6a2011484129dad810e60ded52c9e6718ba", "message": "Handle NaN when extracting VALUES predicate", "committedDate": "2020-06-30T12:14:37Z", "type": "commit"}, {"oid": "199daa745679f23cbcbbf844d55b83b933b7bd6d", "url": "https://github.com/trinodb/trino/commit/199daa745679f23cbcbbf844d55b83b933b7bd6d", "message": "Add missing assertions", "committedDate": "2020-06-30T12:14:38Z", "type": "commit"}, {"oid": "a8f44b9d9fa4acccb7d05c8caeac72ab30c2a054", "url": "https://github.com/trinodb/trino/commit/a8f44b9d9fa4acccb7d05c8caeac72ab30c2a054", "message": "Fix dynamic filter failure in presence of NaN", "committedDate": "2020-06-30T12:14:39Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1NzgyMQ==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447657821", "bodyText": "Do we need to handle empty as special case? Should Domain.multipleValues handle that\nin order to reduce iffs?\nFor example:\nDomain.create(ValueSet.copyOf(type, ImmutableList.of()), false).isNone() == true\n\nYet multipleValues is implemented as\n    public static Domain multipleValues(Type type, List<?> values)\n    {\n        if (values.isEmpty()) {\n            throw new IllegalArgumentException(\"values cannot be empty\");\n        }\n        if (values.size() == 1) {\n            return singleValue(type, values.get(0));\n        }\n        return new Domain(ValueSet.of(type, values.get(0), values.subList(1, values.size()).toArray()), false);\n    }", "author": "sopel39", "createdAt": "2020-06-30T12:52:50Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/EffectivePredicateExtractor.java", "diffHunk": "@@ -364,10 +369,15 @@ public Expression visitValues(ValuesNode node, Void context)\n \n                 List<Object> values = builder.build();\n \n-                Domain domain = Domain.none(type);\n-\n-                if (!values.isEmpty()) {\n-                    domain = domain.union(Domain.multipleValues(type, values));\n+                Domain domain;\n+                if (values.isEmpty()) {", "originalCommit": "189cf6a2011484129dad810e60ded52c9e6718ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY4MDI1Mg==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447680252", "bodyText": "i do not have a strong opinion. There are exactly 3 non-test call sites for multipleValues, so updating it in a follow up would not be a problem.", "author": "findepi", "createdAt": "2020-06-30T13:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1NzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1OTQ5OA==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447659498", "bodyText": "Consider adding comment. It might not be obvious for reader why NaN makes TupleDomain accept all non-null values.", "author": "sopel39", "createdAt": "2020-06-30T12:55:29Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/EffectivePredicateExtractor.java", "diffHunk": "@@ -364,10 +369,15 @@ public Expression visitValues(ValuesNode node, Void context)\n \n                 List<Object> values = builder.build();\n \n-                Domain domain = Domain.none(type);\n-\n-                if (!values.isEmpty()) {\n-                    domain = domain.union(Domain.multipleValues(type, values));\n+                Domain domain;\n+                if (values.isEmpty()) {\n+                    domain = Domain.none(type);\n+                }\n+                else if (hasNaN) {", "originalCommit": "189cf6a2011484129dad810e60ded52c9e6718ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY4MDg2Mg==", "url": "https://github.com/trinodb/trino/pull/4266#discussion_r447680862", "bodyText": "This knowledge is sprinkled in multiple places in the code base already.\nThere seems to be no good place to place such a comment though.", "author": "findepi", "createdAt": "2020-06-30T13:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1OTQ5OA=="}], "type": "inlineReview"}, {"oid": "5cdbb7cfd85bf50e3a79b71251ae145451cfe81d", "url": "https://github.com/trinodb/trino/commit/5cdbb7cfd85bf50e3a79b71251ae145451cfe81d", "message": "Fix NaN handling in Hive partition column", "committedDate": "2020-06-30T16:01:35Z", "type": "commit"}, {"oid": "5cdbb7cfd85bf50e3a79b71251ae145451cfe81d", "url": "https://github.com/trinodb/trino/commit/5cdbb7cfd85bf50e3a79b71251ae145451cfe81d", "message": "Fix NaN handling in Hive partition column", "committedDate": "2020-06-30T16:01:35Z", "type": "forcePushed"}]}