{"pr_number": 4049, "pr_title": "Add support for Hive ACID direct insert", "pr_createdAt": "2020-06-16T16:06:07Z", "pr_url": "https://github.com/trinodb/trino/pull/4049", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTAzMw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019033", "bodyText": "Stores information about Acid properties of a partition.", "author": "losipiuk", "createdAt": "2020-06-16T17:24:31Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/AcidInfo.java", "diffHunk": "@@ -27,15 +27,15 @@\n import static java.util.Objects.requireNonNull;\n \n /**\n- * Stores information about ACID DELETE_DELTA for a Partition\n+ * Stores information about Acid properties.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTMwMQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019301", "bodyText": "rename argument.", "author": "losipiuk", "createdAt": "2020-06-16T17:25:00Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSourceProvider.java", "diffHunk": "@@ -149,7 +149,7 @@ public ConnectorPageSource createPageSource(ConnectorTransactionHandle transacti\n             TableToPartitionMapping tableToPartitionMapping,\n             Optional<BucketConversion> bucketConversion,\n             boolean s3SelectPushdownEnabled,\n-            Optional<DeleteDeltaLocations> deleteDeltaLocations)\n+            Optional<AcidInfo> deleteDeltaLocations)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTM1OA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019358", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:25:06Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/InternalHiveSplit.java", "diffHunk": "@@ -55,7 +55,7 @@\n     private final TableToPartitionMapping tableToPartitionMapping;\n     private final Optional<BucketConversion> bucketConversion;\n     private final boolean s3SelectPushdownEnabled;\n-    private final Optional<DeleteDeltaLocations> deleteDeltaLocations;\n+    private final Optional<AcidInfo> deleteDeltaLocations;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTQwNQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019405", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:25:12Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/InternalHiveSplit.java", "diffHunk": "@@ -76,7 +76,7 @@ public InternalHiveSplit(\n             TableToPartitionMapping tableToPartitionMapping,\n             Optional<BucketConversion> bucketConversion,\n             boolean s3SelectPushdownEnabled,\n-            Optional<DeleteDeltaLocations> deleteDeltaLocations)\n+            Optional<AcidInfo> deleteDeltaLocations)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTU3OQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019579", "bodyText": "rename getter", "author": "losipiuk", "createdAt": "2020-06-16T17:25:30Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/InternalHiveSplit.java", "diffHunk": "@@ -219,7 +219,7 @@ public int getEstimatedSizeInBytes()\n         return result;\n     }\n \n-    public Optional<DeleteDeltaLocations> getDeleteDeltaLocations()\n+    public Optional<AcidInfo> getDeleteDeltaLocations()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxOTkzMg==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441019932", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:26:05Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/orc/OrcPageSourceFactory.java", "diffHunk": "@@ -203,7 +203,7 @@ private static OrcPageSource createOrcPageSource(\n             TupleDomain<HiveColumnHandle> effectivePredicate,\n             DateTimeZone hiveStorageTimeZone,\n             OrcReaderOptions options,\n-            Optional<DeleteDeltaLocations> deleteDeltaLocations,\n+            Optional<AcidInfo> deleteDeltaLocations,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDE1Nw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441020157", "bodyText": "rename variable.", "author": "losipiuk", "createdAt": "2020-06-16T17:26:27Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/orc/TestOrcDeletedRows.java", "diffHunk": "@@ -58,7 +58,7 @@ public void setUp()\n     @Test\n     public void testDeleteLocations()\n     {\n-        DeleteDeltaLocations.Builder deleteDeltaLocationsBuilder = DeleteDeltaLocations.builder(partitionDirectory);\n+        AcidInfo.Builder deleteDeltaLocationsBuilder = AcidInfo.builder(partitionDirectory);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDI3OQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441020279", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:26:39Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/orc/TestOrcDeletedRows.java", "diffHunk": "@@ -81,13 +81,13 @@ public void testDeleteLocations()\n         assertEquals(block.getPositionCount(), 10);\n     }\n \n-    private void addDeleteDelta(DeleteDeltaLocations.Builder deleteDeltaLocationsBuilder, long minWriteId, long maxWriteId, int statementId)\n+    private void addDeleteDelta(AcidInfo.Builder deleteDeltaLocationsBuilder, long minWriteId, long maxWriteId, int statementId)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDM5Mg==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441020392", "bodyText": "rename variable", "author": "losipiuk", "createdAt": "2020-06-16T17:26:50Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/orc/TestOrcPageSourceFactory.java", "diffHunk": "@@ -113,15 +113,15 @@ public void testDeletedRows()\n             throws Exception\n     {\n         Path partitionLocation = new Path(getClass().getClassLoader().getResource(\"nation_delete_deltas\") + \"/\");\n-        Optional<DeleteDeltaLocations> deleteDeltaLocations = DeleteDeltaLocations.builder(partitionLocation)\n+        Optional<AcidInfo> deleteDeltaLocations = AcidInfo.builder(partitionLocation)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDQ1NQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441020455", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:26:55Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/orc/TestOrcPageSourceFactory.java", "diffHunk": "@@ -113,15 +113,15 @@ public void testDeletedRows()\n             throws Exception\n     {\n         Path partitionLocation = new Path(getClass().getClassLoader().getResource(\"nation_delete_deltas\") + \"/\");\n-        Optional<DeleteDeltaLocations> deleteDeltaLocations = DeleteDeltaLocations.builder(partitionLocation)\n+        Optional<AcidInfo> deleteDeltaLocations = AcidInfo.builder(partitionLocation)\n                 .addDeleteDelta(new Path(partitionLocation, deleteDeltaSubdir(3L, 3L, 0)), 3L, 3L, 0)\n                 .addDeleteDelta(new Path(partitionLocation, deleteDeltaSubdir(4L, 4L, 0)), 4L, 4L, 0)\n                 .build();\n \n         assertRead(ImmutableSet.copyOf(NationColumn.values()), OptionalLong.empty(), deleteDeltaLocations, nationKey -> nationKey == 5 || nationKey == 19);\n     }\n \n-    private static void assertRead(Set<NationColumn> columns, OptionalLong nationKeyPredicate, Optional<DeleteDeltaLocations> deleteDeltaLocations, LongPredicate deletedRows)\n+    private static void assertRead(Set<NationColumn> columns, OptionalLong nationKeyPredicate, Optional<AcidInfo> deleteDeltaLocations, LongPredicate deletedRows)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDUyMQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441020521", "bodyText": "rename argument", "author": "losipiuk", "createdAt": "2020-06-16T17:27:02Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/orc/TestOrcPageSourceFactory.java", "diffHunk": "@@ -145,7 +145,7 @@ private static void assertRead(Set<NationColumn> columns, OptionalLong nationKey\n         assertEqualsByColumns(columns, actual, expected);\n     }\n \n-    private static List<Nation> readFile(Set<NationColumn> columns, TupleDomain<HiveColumnHandle> tupleDomain, Optional<DeleteDeltaLocations> deleteDeltaLocations)\n+    private static List<Nation> readFile(Set<NationColumn> columns, TupleDomain<HiveColumnHandle> tupleDomain, Optional<AcidInfo> deleteDeltaLocations)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMTQ1MQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441021451", "bodyText": "Does this equal make sense originally? Are deleteDeltas ordered?", "author": "losipiuk", "createdAt": "2020-06-16T17:28:35Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/AcidInfo.java", "diffHunk": "@@ -69,13 +88,15 @@ public boolean equals(Object o)\n \n         AcidInfo that = (AcidInfo) o;\n         return partitionLocation.equals(that.partitionLocation) &&\n-                deleteDeltas.equals(that.deleteDeltas);\n+                deleteDeltas.equals(that.deleteDeltas) &&", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzM5NA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441023394", "bodyText": "adding new pattern should not be part of this commit.", "author": "losipiuk", "createdAt": "2020-06-16T17:31:43Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -112,13 +112,16 @@\n public class BackgroundHiveSplitLoader\n         implements HiveSplitLoader\n {\n+    private static final Pattern DIRECT_INSERT_BUCKET_PATTERN = Pattern.compile(\"bucket_(\\\\d+)(_\\\\d+)\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441023923", "bodyText": "ACID_BUCKET_PATTERN?", "author": "losipiuk", "createdAt": "2020-06-16T17:32:39Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -112,16 +112,15 @@\n public class BackgroundHiveSplitLoader\n         implements HiveSplitLoader\n {\n-    private static final Pattern DIRECT_INSERT_BUCKET_PATTERN = Pattern.compile(\"bucket_(\\\\d+)(_\\\\d+)\");\n+    private static final Pattern BUCKET_PATTERN = Pattern.compile(\"bucket_(\\\\d+)(_\\\\d+)?$\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDczMg==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441074732", "bodyText": "Not exactly. This pattern will catch both non-acid (6 digits) and acid (5 digits) with optional attemptId.", "author": "wendigo", "createdAt": "2020-06-16T18:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4NjE4NQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441386185", "bodyText": "The problem with this name is that it is not specific. How different is this pattern extracted a BUCKET_PATTERN from the other two in BUCKET_PATTERNS list?", "author": "losipiuk", "createdAt": "2020-06-17T08:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQyNzM4MQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441427381", "bodyText": "It's used futher in code to extract attemptId (if it exists) from bucket filename", "author": "wendigo", "createdAt": "2020-06-17T09:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NjA5MA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441476090", "bodyText": "Yeah - I know that. I am just complaining about the name. Not the fact that it is extracted as a constant. Maybe BUCKET_WITH_OPTIONAL_ATTEMPT_ID_PATTERN then?", "author": "losipiuk", "createdAt": "2020-06-17T11:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ4NzA2Mg==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441487062", "bodyText": "add link to hive code that composes those names", "author": "findepi", "createdAt": "2020-06-17T11:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMzkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyNTAxOA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441025018", "bodyText": "Can you rewrite it in less concise, but more readable form. Do not use elvis.", "author": "losipiuk", "createdAt": "2020-06-16T17:34:34Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -648,6 +655,18 @@ static OptionalInt getBucketNumber(String name)\n         return OptionalInt.empty();\n     }\n \n+    static Optional<String> getAttemptId(String bucketFilename)\n+    {\n+        Matcher matcher = BUCKET_PATTERN.matcher(bucketFilename);\n+\n+        if (matcher.matches() && matcher.groupCount() == 2) {\n+            // https://github.com/apache/hive/blob/ffee30e6267e85f00a22767262192abb9681cfb7/ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java#L444\n+            return Optional.ofNullable(matcher.group(2) != null ? matcher.group(2).substring(1) : null);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NjU3NQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441076575", "bodyText": "I've extracted logic from Hive source code but I'm fine with rewriting it.", "author": "wendigo", "createdAt": "2020-06-16T19:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyNTAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDM0OA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441030348", "bodyText": "I am not following the logic here very much. Why not set the new immediately when you create AcidInfo object in loadPartition", "author": "losipiuk", "createdAt": "2020-06-16T17:43:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -534,12 +533,20 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n     private Iterator<InternalHiveSplit> createInternalHiveSplitIterator(Path path, FileSystem fileSystem, InternalHiveSplitFactory splitFactory, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n         return Streams.stream(new HiveFileIterator(table, path, fileSystem, directoryLister, namenodeStats, recursiveDirWalkerEnabled ? RECURSE : IGNORED, ignoreAbsentPartitions))\n-                .map(status -> splitFactory.createInternalHiveSplit(status, OptionalInt.empty(), splittable, acidInfo))\n+                .map(status -> splitFactory.createInternalHiveSplit(status, OptionalInt.empty(), splittable, setIfDirectInsert(acidInfo, status.getPath())))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NjMwNg==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441076306", "bodyText": "Imho if I'm reading code correctly in loadPartition I'm iterating on directories and here I'm iterating on files (HiveFileIterator) and I'm checking whether bucket file has attemptId", "author": "wendigo", "createdAt": "2020-06-16T19:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE0NjcwMw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442146703", "bodyText": "And what about bucketId parameter passed to createInternalHiveSplit. Shouldn't it correspond to bucket id which was possibly discovered in setIfDirectInsert?", "author": "losipiuk", "createdAt": "2020-06-18T11:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIxNDEwNQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442214105", "bodyText": "bucketId was removed from AcidInfo", "author": "wendigo", "createdAt": "2020-06-18T13:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMTYzMQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441031631", "bodyText": "drop (it is by default). It depends on distribution.", "author": "losipiuk", "createdAt": "2020-06-16T17:46:04Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/orc/OrcDeletedRows.java", "diffHunk": "@@ -214,12 +217,20 @@ private void loadValidPositions()\n         return deletedRows;\n     }\n \n-    private static Path createPath(String partitionLocation, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n+    private static Path createPath(AcidInfo acidInfo, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n     {\n-        Path directory = new Path(partitionLocation, deleteDeltaSubdir(\n+        Path directory = new Path(acidInfo.getPartitionLocation(), deleteDeltaSubdir(\n                 deleteDeltaInfo.getMinWriteId(),\n                 deleteDeltaInfo.getMaxWriteId(),\n                 deleteDeltaInfo.getStatementId()));\n+\n+        if (acidInfo.isDirectInsert()) {\n+            checkArgument(acidInfo.getBucketId().isPresent(), \"bucketId is missing\");\n+            // When direct insert is enabled (it is by default) base and delta directories contain bucket_[id]_[attemptId] files", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MTA5MA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r441081090", "bodyText": "It defaults to true in Hive sources.", "author": "wendigo", "createdAt": "2020-06-16T19:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMTYzMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NDUzNA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442154534", "bodyText": "It should be just enough to cut the last _.* part of the original filename, right? It seems a bit safer as we are not recreating whole filename manually which may be error prone. E.g. here we are asssuming that bucket id is formated on 5 digits. while BUCKET_WITH_OPTIONAL_ATTEMPT_ID_PATTERN does not enforce that.\nAlso if we go with this approach we could get rid of bucketId from AcidInfo.\nWould that work?", "author": "losipiuk", "createdAt": "2020-06-18T11:22:35Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/orc/OrcDeletedRows.java", "diffHunk": "@@ -214,12 +217,20 @@ private void loadValidPositions()\n         return deletedRows;\n     }\n \n-    private static Path createPath(String partitionLocation, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n+    private static Path createPath(AcidInfo acidInfo, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n     {\n-        Path directory = new Path(partitionLocation, deleteDeltaSubdir(\n+        Path directory = new Path(acidInfo.getPartitionLocation(), deleteDeltaSubdir(\n                 deleteDeltaInfo.getMinWriteId(),\n                 deleteDeltaInfo.getMaxWriteId(),\n                 deleteDeltaInfo.getStatementId()));\n+\n+        if (acidInfo.isDirectInsert()) {\n+            checkArgument(acidInfo.getBucketId().isPresent(), \"bucketId is missing\");\n+            // When direct insert is enabled base and delta directories contain bucket_[id]_[attemptId] files\n+            // but delete delta directories contain bucket files without attemptId.\n+            return new Path(directory, format(\"bucket_%05d\", acidInfo.getBucketId().getAsInt()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2NDU1OQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442164559", "bodyText": "Yep, that should work but if hive has direct insert then buckets are always 5 digits long. I can change that to strip attempt id from the string.", "author": "wendigo", "createdAt": "2020-06-18T11:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMjkwOA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442202908", "bodyText": "I think I would prefer that approach. This way we may have less information in AcidUtils. If we get rid of bucketId from there it makes it easier to reason what is source of truth.\n@findepi any though on this one?", "author": "losipiuk", "createdAt": "2020-06-18T12:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxNzQ3Nw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r443417477", "bodyText": "i think hive's logic is to recreate the filename. While it seems more err-prone, it may also be more future proof.", "author": "findepi", "createdAt": "2020-06-22T09:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NDUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE1NTY4Nw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r442155687", "bodyText": "the comment above is not valid any more. The filename may be different. Please update.", "author": "losipiuk", "createdAt": "2020-06-18T11:25:02Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -625,7 +636,7 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n                 for (LocatedFileStatus file : bucketFiles.get(partitionBucketNumber)) {\n                     // OrcDeletedRows will load only delete delta files matching current bucket (same file name),\n                     // so we can pass all delete delta locations here, without filtering.\n-                    splitFactory.createInternalHiveSplit(file, OptionalInt.of(readBucketNumber), splittable, acidInfo)\n+                    splitFactory.createInternalHiveSplit(file, OptionalInt.of(readBucketNumber), splittable, setIfDirectInsert(acidInfo, file.getPath()))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2NjE2Mw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r443366163", "bodyText": "nit: you  can put it inside lambda", "author": "losipiuk", "createdAt": "2020-06-22T07:30:13Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -531,12 +534,20 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n     private Iterator<InternalHiveSplit> createInternalHiveSplitIterator(Path path, FileSystem fileSystem, InternalHiveSplitFactory splitFactory, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n         return Streams.stream(new HiveFileIterator(table, path, fileSystem, directoryLister, namenodeStats, recursiveDirWalkerEnabled ? RECURSE : IGNORED, ignoreAbsentPartitions))\n-                .map(status -> splitFactory.createInternalHiveSplit(status, OptionalInt.empty(), splittable, acidInfo))\n+                .map(status -> splitFactory.createInternalHiveSplit(status, OptionalInt.empty(), splittable, setIfDirectInsert(acidInfo, status.getPath())))\n                 .filter(Optional::isPresent)\n                 .map(Optional::get)\n                 .iterator();\n     }\n \n+    private static Optional<AcidInfo> setIfDirectInsert(Optional<AcidInfo> acidInfo, Path filename)\n+    {\n+        Optional<String> attemptId = getAttemptId(filename.getName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2ODgxNQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r443368815", "bodyText": "going further from this place it look that actually we do not need even directId flag in AcidInfo. Right? We can just check for attemptId in fileName here.", "author": "losipiuk", "createdAt": "2020-06-22T07:35:59Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/orc/OrcDeletedRows.java", "diffHunk": "@@ -214,12 +216,20 @@ private void loadValidPositions()\n         return deletedRows;\n     }\n \n-    private static Path createPath(String partitionLocation, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n+    private static Path createPath(AcidInfo acidInfo, AcidInfo.DeleteDeltaInfo deleteDeltaInfo, String fileName)\n     {\n-        Path directory = new Path(partitionLocation, deleteDeltaSubdir(\n+        Path directory = new Path(acidInfo.getPartitionLocation(), deleteDeltaSubdir(\n                 deleteDeltaInfo.getMinWriteId(),\n                 deleteDeltaInfo.getMaxWriteId(),\n                 deleteDeltaInfo.getStatementId()));\n+\n+        if (acidInfo.isDirectInsert()) {\n+            verify(CharMatcher.is('_').countIn(fileName) >= 2, \"Filename should contain attemptId\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNzQ3MA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444127470", "bodyText": "bump", "author": "findepi", "createdAt": "2020-06-23T10:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2ODgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1OTc2OQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444759769", "bodyText": "I'm not really sure if it's safe to assume that if filename has 2 x _ then second substring is an attemptId", "author": "wendigo", "createdAt": "2020-06-24T09:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2ODgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5NzIyOQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444797229", "bodyText": "I agree, but this is how we recognize them. More precisely, we recognize them by BackgroundHiveSplitLoader.BUCKET_WITH_OPTIONAL_ATTEMPT_ID_PATTERN (so: 2 x underscore, literal \"bucket\" and some digits). It doesn't hurt any more to use this logic here as well.", "author": "findepi", "createdAt": "2020-06-24T10:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2ODgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNDQzNw==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444124437", "bodyText": "Copy directInsert field too.", "author": "findepi", "createdAt": "2020-06-23T10:30:13Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/AcidInfo.java", "diffHunk": "@@ -161,22 +172,34 @@ public static Builder builder(Path partitionPath)\n         return new Builder(partitionPath);\n     }\n \n+    public static Builder builder(AcidInfo acidInfo)\n+    {\n+        return new Builder(acidInfo);\n+    }\n+\n     public static class Builder\n     {\n-        private final Path partitionLocation;\n+        private final String partitionLocation;\n         private final ImmutableList.Builder<DeleteDeltaInfo> deleteDeltaInfoBuilder = ImmutableList.builder();\n+        private boolean directInsert;\n \n         private Builder(Path partitionPath)\n         {\n-            partitionLocation = requireNonNull(partitionPath, \"partitionPath is null\");\n+            partitionLocation = requireNonNull(partitionPath, \"partitionPath is null\").toString();\n+        }\n+\n+        private Builder(AcidInfo acidInfo)\n+        {\n+            partitionLocation = acidInfo.getPartitionLocation();\n+            deleteDeltaInfoBuilder.addAll(acidInfo.deleteDeltas);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNDg5OQ==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444124899", "bodyText": "This change seems unrelated. Consider reverting.", "author": "findepi", "createdAt": "2020-06-23T10:31:06Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/AcidInfo.java", "diffHunk": "@@ -161,22 +172,34 @@ public static Builder builder(Path partitionPath)\n         return new Builder(partitionPath);\n     }\n \n+    public static Builder builder(AcidInfo acidInfo)\n+    {\n+        return new Builder(acidInfo);\n+    }\n+\n     public static class Builder\n     {\n-        private final Path partitionLocation;\n+        private final String partitionLocation;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjc2MA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444126760", "bodyText": "checking matcher.groupCount() == 2 is wrong, since the group count is statically defined in the pattern\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (matcher.matches() && matcher.groupCount() == 2 && matcher.group(2) != null) {\n          \n          \n            \n                    if (matcher.matches() && matcher.group(2) != null) {", "author": "findepi", "createdAt": "2020-06-23T10:35:01Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -645,6 +656,17 @@ static OptionalInt getBucketNumber(String name)\n         return OptionalInt.empty();\n     }\n \n+    @VisibleForTesting\n+    static Optional<String> getAttemptId(String bucketFilename)\n+    {\n+        Matcher matcher = BUCKET_WITH_OPTIONAL_ATTEMPT_ID_PATTERN.matcher(bucketFilename);\n+        if (matcher.matches() && matcher.groupCount() == 2 && matcher.group(2) != null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5NzY5NA==", "url": "https://github.com/trinodb/trino/pull/4049#discussion_r444797694", "bodyText": "since we generally discard attemptId information, this could be hasAttemptId", "author": "findepi", "createdAt": "2020-06-24T10:26:46Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -645,6 +656,17 @@ static OptionalInt getBucketNumber(String name)\n         return OptionalInt.empty();\n     }\n \n+    @VisibleForTesting\n+    static Optional<String> getAttemptId(String bucketFilename)\n+    {\n+        Matcher matcher = BUCKET_WITH_OPTIONAL_ATTEMPT_ID_PATTERN.matcher(bucketFilename);\n+        if (matcher.matches() && matcher.group(2) != null) {\n+            return Optional.of(matcher.group(2).substring(1));\n+        }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "98a9885d966b359c87bf19fa9f8b3a4029f01d71", "url": "https://github.com/trinodb/trino/commit/98a9885d966b359c87bf19fa9f8b3a4029f01d71", "message": "Rename DeleteDeltaLocations to AcidInfo", "committedDate": "2020-06-24T19:24:43Z", "type": "commit"}, {"oid": "c47f481fda57508f47a650d23eedc303cacfe0f0", "url": "https://github.com/trinodb/trino/commit/c47f481fda57508f47a650d23eedc303cacfe0f0", "message": "Support Hive direct insert", "committedDate": "2020-06-24T19:24:43Z", "type": "commit"}, {"oid": "c47f481fda57508f47a650d23eedc303cacfe0f0", "url": "https://github.com/trinodb/trino/commit/c47f481fda57508f47a650d23eedc303cacfe0f0", "message": "Support Hive direct insert", "committedDate": "2020-06-24T19:24:43Z", "type": "forcePushed"}]}