{"pr_number": 5059, "pr_title": "Expose containers log paths on host", "pr_createdAt": "2020-09-02T19:10:49Z", "pr_url": "https://github.com/trinodb/trino/pull/5059", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzMDk0MQ==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482330941", "bodyText": "hmm. I recall we already remove it. Please make separate commit anyway.", "author": "losipiuk", "createdAt": "2020-09-02T19:21:30Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/EnvironmentUp.java", "diffHunk": "@@ -82,8 +83,8 @@ public void run()\n         @Option(name = \"--environment\", title = \"environment\", description = \"the name of the environment to start\", required = true)\n         public String environment;\n \n-        @Option(name = \"--startup-timeout\", title = \"environment startup timeout\", description = \"environment startup timeout\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzNDgzNw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482334837", "bodyText": "there can be quite a lot of those. Is there a limit on number of directories bound...\nI guess not very low - we used to bind a lot of stuff before moving to copying.", "author": "losipiuk", "createdAt": "2020-09-02T19:25:32Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -81,6 +91,21 @@ public void copyFileToContainer(Transferable transferable, String containerPath)\n         copyFileToContainer(containerPath, () -> super.copyFileToContainer(transferable, containerPath));\n     }\n \n+    public DockerContainer withExposedLogPaths(String... logPaths)\n+    {\n+        this.logPaths.addAll(Arrays.asList(logPaths));\n+        return this;\n+    }\n+\n+    public void exposeLogsInHostPath(Path hostBasePath)\n+    {\n+        for (String containerLogPath : logPaths) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM1NTc0Nw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482355747", "bodyText": "Neither docker java nor docker docs itself mention any limit on the number of binds", "author": "wendigo", "createdAt": "2020-09-02T19:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzNDgzNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwMTQ2MA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482501460", "bodyText": "Please rebase onto #4908\ntitle should become paramLabel = <dir> and description should start with uppercase", "author": "electrum", "createdAt": "2020-09-02T21:41:36Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/EnvironmentUp.java", "diffHunk": "@@ -82,8 +83,8 @@ public void run()\n         @Option(name = \"--environment\", title = \"environment\", description = \"the name of the environment to start\", required = true)\n         public String environment;\n \n-        @Option(name = \"--startup-timeout\", title = \"environment startup timeout\", description = \"environment startup timeout\")\n-        public Duration startupTimeout = Duration.valueOf(\"10m\");\n+        @Option(name = \"--logs-dir\", title = \"logs dir\", description = \"location of the exported logs directory\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxOTE2OA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482719168", "bodyText": "Sure. Thx @electrum :)", "author": "wendigo", "createdAt": "2020-09-03T05:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwMTQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzY0MA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482767640", "bodyText": "If i eg invoke test run from intellij directly, where will the logs go to?\nthe logs/ folder does not exist, right?\nmaybe it should be null by default, or tempdir?\n(same for env up)", "author": "findepi", "createdAt": "2020-09-03T07:33:27Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/TestRun.java", "diffHunk": "@@ -97,8 +95,11 @@ public void run()\n         @Option(name = \"--environment\", title = \"environment\", description = \"the name of the environment to start\", required = true)\n         public String environment;\n \n+        @Option(name = \"--logs-dir\", title = \"logs dir\", description = \"location of the exported logs directory\")\n+        public String logsDirBase = \"logs/\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MjM2MQ==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482772361", "bodyText": "to logs/ dir which is emptied on every run.", "author": "wendigo", "createdAt": "2020-09-03T07:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAzNTMzMw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r483035333", "bodyText": "At the very least it should be gitignored, but IMO (currently) not exporting logs by default is more reasonable.", "author": "findepi", "createdAt": "2020-09-03T14:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA4NDAzMg==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r483084032", "bodyText": "Yeah - I think it makes sense that default for --logs-dir should be null. And we handle that in a way that we do not bind any host directories for logs to containers.", "author": "losipiuk", "createdAt": "2020-09-03T15:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NzcxNA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482767714", "bodyText": "separate commit?", "author": "findepi", "createdAt": "2020-09-03T07:33:35Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/TestRun.java", "diffHunk": "@@ -97,8 +95,11 @@ public void run()\n         @Option(name = \"--environment\", title = \"environment\", description = \"the name of the environment to start\", required = true)\n         public String environment;\n \n+        @Option(name = \"--logs-dir\", title = \"logs dir\", description = \"location of the exported logs directory\")\n+        public String logsDirBase = \"logs/\";\n+\n         @Option(name = \"--reports-dir\", title = \"reports dir\", description = \"location of the reports directory\")\n-        public String reportsDir = \"presto-product-tests/target/\";\n+        public String reportsDir = \"presto-product-tests/target/reports\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2ODM5NA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482768394", "bodyText": "I'd rather see caller do the cleanup (if needed)\nThis configuration method should ideally be just that -- a configuration method without side effects", "author": "findepi", "createdAt": "2020-09-03T07:34:52Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -81,6 +91,21 @@ public void copyFileToContainer(Transferable transferable, String containerPath)\n         copyFileToContainer(containerPath, () -> super.copyFileToContainer(transferable, containerPath));\n     }\n \n+    public DockerContainer withExposedLogPaths(String... logPaths)\n+    {\n+        this.logPaths.addAll(Arrays.asList(logPaths));\n+        return this;\n+    }\n+\n+    public void exposeLogsInHostPath(Path hostBasePath)\n+    {\n+        for (String containerLogPath : logPaths) {\n+            Path hostLogPath = Paths.get(hostBasePath.toString(), containerLogPath);\n+            cleanOrCreateHostPath(hostLogPath);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MDI0MA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482770240", "bodyText": "withExposedLogPaths and exposeLogsInHostPath look like configuration methods, but currently need to be called in correct order\nlet's add some verify to ensure they are always callled in that order.\nsimplest way would be\n\nto null out logPaths inside exposeLogsInHostPath\nto check logPaths != null yet in withExposedLogPaths\n\n(i don't see a need to support the methods being called in varying order, so let's not spend time on that)", "author": "findepi", "createdAt": "2020-09-03T07:37:47Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -81,6 +91,21 @@ public void copyFileToContainer(Transferable transferable, String containerPath)\n         copyFileToContainer(containerPath, () -> super.copyFileToContainer(transferable, containerPath));\n     }\n \n+    public DockerContainer withExposedLogPaths(String... logPaths)\n+    {\n+        this.logPaths.addAll(Arrays.asList(logPaths));\n+        return this;\n+    }\n+\n+    public void exposeLogsInHostPath(Path hostBasePath)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MDY1MA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482770650", "bodyText": "See https://github.com/prestosql/presto/blob/51263348564d2f1853aad0dbae30ab212fc858a9/presto-raptor-legacy/src/test/java/io/prestosql/plugin/raptor/legacy/storage/TestOrcFileRewriter.java#L81", "author": "findepi", "createdAt": "2020-09-03T07:38:25Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -95,4 +120,24 @@ private static void verifyHostPath(String hostPath)\n             throw new IllegalArgumentException(\"Host path does not exist: \" + hostPath);\n         }\n     }\n+\n+    public static void cleanOrCreateHostPath(Path path)\n+    {\n+        try {\n+            if (Files.exists(path)) {\n+                Files.walk(path)\n+                        .sorted(reverseOrder())\n+                        .map(Path::toFile)\n+                        .forEach(File::delete);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMzQ3Mw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482813473", "bodyText": "nit: separate commit?", "author": "losipiuk", "createdAt": "2020-09-03T08:48:32Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -173,7 +178,7 @@ private static void printTestRunsSummary(List<TestRunResult> results)\n                     .count();\n \n             log.info(\"Test runs summary (%d passed, %d failed): \", results.size() - failedRuns, failedRuns);\n-            results.forEach(result -> log.info(\" * '%s' %s in %s\", result.getSuiteRun(), result.isSuccessful() ? \"PASSED\" : \"FAILED\", result.getDuration()));\n+            results.forEach(result -> log.info(\" * '%s' %s in %s\", result.getSuiteRun(), result.isSuccessful() ? \"PASSED\" : format(\"FAILED (%s)\", result.getThrowable().orElse(null)), result.getDuration()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxODQyOQ==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482818429", "bodyText": "nit: rename to exposeLogsInHostPath for consistency.", "author": "losipiuk", "createdAt": "2020-09-03T08:56:29Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -195,5 +200,15 @@ public Environment build()\n \n             return new Environment(name, containers);\n         }\n+\n+        public Builder exposeLogsInPath(Path basePath)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyMzY3Nw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482823677", "bodyText": "where do we need this?", "author": "losipiuk", "createdAt": "2020-09-03T09:04:42Z", "path": "presto-product-tests-launcher/src/main/resources/launcher.properties", "diffHunk": "@@ -0,0 +1 @@\n+project.version=${project.version}", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNzE4MQ==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482827181", "bodyText": "It's not. Sorry.", "author": "wendigo", "createdAt": "2020-09-03T09:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyMzY3Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NzI3Mw==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482897273", "bodyText": "What drive what is default value of option here. The value assigned to bindPorts variable?\nIf so can you just declare option ss @Option(names = \"--bind\", description = \"Bind ports on localhost\", negatable = true)", "author": "losipiuk", "createdAt": "2020-09-03T11:10:58Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentOptions.java", "diffHunk": "@@ -33,35 +30,12 @@\n     @Option(names = \"--without-presto\", description = \"Do not start presto-master\")\n     public boolean withoutPrestoMaster;\n \n-    @Option(names = \"--bind\", description = \"Bind ports on localhost\")\n-    public boolean bindPorts = toBoolean(firstNonNull(System.getenv(\"PTL_BIND_PORTS\"), \"true\"));\n+    @Option(names = \"--no-bind\", description = \"Bind ports on localhost\", negatable = true)\n+    public boolean bindPorts = true;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNjg2Ng==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482906866", "bodyText": "No I can't. It's just the way negatable works (so by default it's --bind, --no-bind will switch to false)", "author": "wendigo", "createdAt": "2020-09-03T11:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NzI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5OTEyOQ==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482899129", "bodyText": "I am not convinced we need those. And even if we do,  I would put them before failed ones. So it is easy to scroll down to failed list of failed tests on GHA.", "author": "losipiuk", "createdAt": "2020-09-03T11:14:21Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -153,28 +154,41 @@ public void run()\n             }\n \n             List<TestRunResult> testRunsResults = results.build();\n-            boolean allSuccessful = testRunsResults.stream()\n-                    .allMatch(TestRunResult::isSuccessful);\n-\n-            if (allSuccessful) {\n-                log.info(\"Suite succeeded in %s:\", nanosSince(suiteStartTime));\n-                printTestRunsSummary(testRunsResults);\n-                exit(0);\n-            }\n-\n-            log.error(\"Suite failed in %s:\", nanosSince(suiteStartTime));\n-            printTestRunsSummary(testRunsResults);\n-            exit(1);\n+            printTestRunsSummary(suiteStartTime, suiteName, testRunsResults);\n         }\n \n-        private static void printTestRunsSummary(List<TestRunResult> results)\n+        private static void printTestRunsSummary(long startTime, String suiteName, List<TestRunResult> results)\n         {\n             long failedRuns = results.stream()\n                     .filter(TestRunResult::hasFailed)\n                     .count();\n \n-            log.info(\"Test runs summary (%d passed, %d failed): \", results.size() - failedRuns, failedRuns);\n-            results.forEach(result -> log.info(\" * '%s' %s in %s\", result.getSuiteRun(), result.isSuccessful() ? \"PASSED\" : \"FAILED\", result.getDuration()));\n+            if (failedRuns > 0) {\n+                log.info(\"Suite %s failed in %s (%d passed, %d failed): \", suiteName, nanosSince(startTime), results.size() - failedRuns, failedRuns);\n+            }\n+            else {\n+                log.info(\"Suite %s succeeded in %s: \", suiteName, nanosSince(startTime));\n+            }\n+\n+            results.stream()\n+                    .filter(TestRunResult::hasFailed)\n+                    .forEach(Execution::printTestRunSummary);\n+\n+            results.stream()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMjM1OA==", "url": "https://github.com/trinodb/trino/pull/5059#discussion_r482902358", "bodyText": "this is not useful.\nCan we make it a single digit number. Only present if there actually is a conflict.\nOr alternatively you can just put an index of SuiteTestRun in the list in the string. Right?", "author": "losipiuk", "createdAt": "2020-09-03T11:20:01Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -216,11 +219,19 @@ public TestRunResult executeSuiteTestRun(String suiteName, SuiteTestRun suiteTes\n             testRunOptions.environment = suiteTestRun.getEnvironmentName();\n             testRunOptions.testArguments = suiteTestRun.getTemptoRunArguments(environmentConfig);\n             testRunOptions.testJar = suiteRunOptions.testJar;\n-            String targetDirectory = format(\"%s-%s-%s\", suiteName, environmentConfig.getConfigName(), suiteTestRun.getEnvironmentName());\n-            testRunOptions.reportsDir = Paths.get(\"presto-product-tests/target/reports/\" + targetDirectory);\n-            testRunOptions.logsDirBase = logsDirBase.resolve(targetDirectory);\n+            String suiteRunId = suiteRunId(suiteName, suiteTestRun, environmentConfig);\n+            testRunOptions.reportsDir = Paths.get(\"presto-product-tests/target/reports/\" + suiteRunId);\n+            testRunOptions.logsDirBase = logsDirBase.resolve(suiteRunId);\n             return testRunOptions;\n         }\n+\n+        private static String suiteRunId(String suiteName, SuiteTestRun suiteTestRun, EnvironmentConfig environmentConfig)\n+        {\n+            List<String> testArguments = suiteTestRun.getTemptoRunArguments(environmentConfig);\n+            // suite-2 contains two singlenode environment test runs - use tempto arguments to uniquely identify each test run\n+            String testArgumentsHash = Hashing.sha256().hashString(Joiner.on(\"-\").skipNulls().join(testArguments), Charsets.UTF_8).toString();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "c95a7791abbeb2ce940c748f929a7183a42f6e0e", "url": "https://github.com/trinodb/trino/commit/c95a7791abbeb2ce940c748f929a7183a42f6e0e", "message": "Expose containers log paths on host", "committedDate": "2020-09-04T12:42:55Z", "type": "commit"}, {"oid": "38726a921c9e42331816d6ecce02d506ed6ace0b", "url": "https://github.com/trinodb/trino/commit/38726a921c9e42331816d6ecce02d506ed6ace0b", "message": "Remove PathResolver usage", "committedDate": "2020-09-04T12:43:39Z", "type": "commit"}, {"oid": "3cb3d26b020e4d24a3b862fbcf73fcadad6a990a", "url": "https://github.com/trinodb/trino/commit/3cb3d26b020e4d24a3b862fbcf73fcadad6a990a", "message": "Make --bind param negatable", "committedDate": "2020-09-04T12:43:40Z", "type": "commit"}, {"oid": "5fd5c0a68d3357147ed670fffc52ea25b0100838", "url": "https://github.com/trinodb/trino/commit/5fd5c0a68d3357147ed670fffc52ea25b0100838", "message": "Improve suite run summary log", "committedDate": "2020-09-04T12:43:40Z", "type": "commit"}, {"oid": "2409cd70e672c81ab19c8168171cda515d8f07d8", "url": "https://github.com/trinodb/trino/commit/2409cd70e672c81ab19c8168171cda515d8f07d8", "message": "Remove collision when running same environment multiple times in suite", "committedDate": "2020-09-04T12:43:40Z", "type": "commit"}, {"oid": "2409cd70e672c81ab19c8168171cda515d8f07d8", "url": "https://github.com/trinodb/trino/commit/2409cd70e672c81ab19c8168171cda515d8f07d8", "message": "Remove collision when running same environment multiple times in suite", "committedDate": "2020-09-04T12:43:40Z", "type": "forcePushed"}]}