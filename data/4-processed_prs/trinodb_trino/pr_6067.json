{"pr_number": 6067, "pr_title": "Propagate more information from ConnectorSession to ConnectionFactory", "pr_createdAt": "2020-11-23T23:50:42Z", "pr_url": "https://github.com/trinodb/trino/pull/6067", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NzM4MQ==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529287381", "bodyText": "ConnectorSession is not a good candidate for the cache key and we avoided it so far", "author": "findepi", "createdAt": "2020-11-24T08:28:43Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -55,7 +55,7 @@\n     private final JdbcClient delegate;\n     private final boolean cacheMissing;\n \n-    private final LoadingCache<JdbcIdentity, Set<String>> schemaNamesCache;\n+    private final LoadingCache<ConnectorSession, Set<String>> schemaNamesCache;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5NzA0NQ==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529297045", "bodyText": "ConnectorSession has plenty runtime information. Even query id changes every single query.", "author": "kokosing", "createdAt": "2020-11-24T08:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NzM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5NTM1Mw==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529295353", "bodyText": "Do we still need JdbcIdentity? Where it is still used besides caching?", "author": "kokosing", "createdAt": "2020-11-24T08:41:20Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -259,7 +261,7 @@ protected boolean filterSchema(String schemaName)\n     @Override\n     public List<JdbcColumnHandle> getColumns(ConnectorSession session, JdbcTableHandle tableHandle)\n     {\n-        try (Connection connection = connectionFactory.openConnection(JdbcIdentity.from(session));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIxMTIyNA==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r531211224", "bodyText": "Most probably yes. It's used somewhere in security.", "author": "ssheikin", "createdAt": "2020-11-26T20:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5NTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3NzYxNw==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529477617", "bodyText": "First of all we need to fix getColumns. Then we need to use same approach for other methods that are using cache here.\nSession contains properties that may influence the behavior of the method. We need to use them in the cache key. Please handle that in separate commit.", "author": "kokosing", "createdAt": "2020-11-24T11:34:24Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -107,7 +107,7 @@ public boolean schemaExists(JdbcIdentity identity, String schema)\n             return tableHandle.getColumns().get();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIxMTY2Mg==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r531211662", "bodyText": "I'm not sure but most probably this comment is outdated and implemented.", "author": "ssheikin", "createdAt": "2020-11-26T20:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3NzYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3ODE3OA==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529478178", "bodyText": "Do you think it make sense to divide this commit into two? One for jdbc client and other for connection factory?", "author": "kokosing", "createdAt": "2020-11-24T11:35:17Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -167,9 +167,9 @@ public BaseJdbcClient(\n     }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE5OTcxNQ==", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r531199715", "bodyText": "jdbc changes are addressed here:\n#6078\nhttps://github.com/zaz968m/presto/pull/2/files", "author": "ssheikin", "createdAt": "2020-11-26T19:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3ODE3OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "url": "https://github.com/trinodb/trino/commit/0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "message": "Propagate more information from ConnectorSession to ConnectionFactory\n\nAdditional information from ConnectorSession is required\nto support audit in not public connectors\nto correlate query in Presto with query w RDBMS", "committedDate": "2020-11-27T10:27:52Z", "type": "commit"}, {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "url": "https://github.com/trinodb/trino/commit/0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "message": "Propagate more information from ConnectorSession to ConnectionFactory\n\nAdditional information from ConnectorSession is required\nto support audit in not public connectors\nto correlate query in Presto with query w RDBMS", "committedDate": "2020-11-27T10:27:52Z", "type": "forcePushed"}]}