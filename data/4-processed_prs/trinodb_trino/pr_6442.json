{"pr_number": 6442, "pr_title": "Decompress Kinesis message if needed", "pr_createdAt": "2020-12-26T19:46:17Z", "pr_url": "https://github.com/trinodb/trino/pull/6442", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549222145", "bodyText": "Does this support only GZIP or ?", "author": "Praveen2112", "createdAt": "2020-12-28T05:41:49Z", "path": "presto-kinesis/src/main/java/io/prestosql/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +293,23 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private byte[] uncompressIfNeeded(byte[] data)\n+        {\n+            if (data == null || data.length < 2) {\n+                return data;\n+            }\n+            int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+            if (magic == GZIPInputStream.GZIP_MAGIC) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjQwMA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549222400", "bodyText": "How about wrapping this logic in a RowDecoder which decompresses the row and passes it to the underlying decoder.", "author": "Praveen2112", "createdAt": "2020-12-28T05:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1NTUyOQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549255529", "bodyText": "My idea was to limit it now to Kinesis, since other consumer libraries like Kafka and Redis might have an option to uncompress it.", "author": "guyco33", "createdAt": "2020-12-28T08:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NjU2OA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551146568", "bodyText": "nit : Can we capture these changes as a separate commit ?", "author": "Praveen2112", "createdAt": "2021-01-04T07:08:08Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -220,7 +232,7 @@ public boolean advanceNextPosition()\n         {\n             if (shardIterator == null && getRecordsRequest == null) {\n                 getIterator(); // first shard iterator\n-                log.debug(\"Starting read.  Retrieved first shard iterator from AWS Kinesis.\");\n+                log.debug(\"(%s:%s) Starting read.  Retrieved first shard iterator from AWS Kinesis.\", split.getStreamName(), split.getShardId());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NjkyOQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551146929", "bodyText": "How about using try-with-resources ?", "author": "Praveen2112", "createdAt": "2021-01-04T07:09:16Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -305,9 +317,24 @@ private boolean nextRow()\n             totalBytes += messageData.length;\n             totalMessages++;\n \n-            log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n+            log.debug(\"(%s:%s) Fetching %d bytes from current record. %d messages read so far\", split.getStreamName(), split.getShardId(), messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NzE1MA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551147150", "bodyText": "nit : can we move it below createJsonMessages", "author": "Praveen2112", "createdAt": "2021-01-04T07:10:07Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -97,7 +100,21 @@ private void createDummyMessages(String streamName, int count)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n-    private void createJsonMessages(String streamName, int count, int idStart)\n+    private byte[] compressMessage(byte[] data)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0Nzc2OA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551147768", "bodyText": "static import ?", "author": "Praveen2112", "createdAt": "2021-01-04T07:12:20Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -171,6 +174,15 @@ public RecordCursor cursor()\n         return new KinesisRecordCursor();\n     }\n \n+    public static boolean isGZipped(byte[] data)\n+    {\n+        if (data == null || data.length < 2) {\n+            return false;\n+        }\n+        int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+        return magic == GZIPInputStream.GZIP_MAGIC;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDEyOA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180128", "bodyText": "use try-with-resources for byteOS and gzipOS", "author": "kokosing", "createdAt": "2021-01-07T08:38:16Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try {\n+            ByteArrayOutputStream byteOS = new ByteArrayOutputStream();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDU5NA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180594", "bodyText": "can we have utility methods below the usage (below test)? Please reorder methods in separate commit.", "author": "kokosing", "createdAt": "2021-01-07T08:39:19Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -97,7 +100,7 @@ private void createDummyMessages(String streamName, int count)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n-    private void createJsonMessages(String streamName, int count, int idStart)\n+    private void createJsonMessages(String streamName, int count, int idStart, boolean compress)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDkxNg==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180916", "bodyText": "Let's make test parametric. You can use io.trino.testing.DataProviders#trueFalse.", "author": "kokosing", "createdAt": "2021-01-07T08:40:02Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -160,7 +182,8 @@ public void testStreamHasData()\n     public void testJsonStream()\n     {\n         // Simple case: add a few specific items, query object and internal fields:\n-        createJsonMessages(jsonStreamName, 4, 100);\n+        createJsonMessages(jsonStreamName, 2, 100, false);\n+        createJsonMessages(jsonStreamName, 2, 102, true);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTE3Mw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181173", "bodyText": "use try-with-resources for streams.", "author": "kokosing", "createdAt": "2021-01-07T08:40:28Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (\n+                        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTI5MQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181291", "bodyText": "PrestoException or better UncheckedIOException", "author": "kokosing", "createdAt": "2021-01-07T08:40:42Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (\n+                        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);\n+                        GZIPInputStream gZIPInputStream = new GZIPInputStream(byteArrayInputStream)) {\n+                    decodedValue = messageDecoder.decodeRow(gZIPInputStream.readAllBytes());\n+                }\n+                catch (IOException e) {\n+                    throw new RuntimeException(e);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTM3MA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181370", "bodyText": "Please extract a method", "author": "kokosing", "createdAt": "2021-01-07T08:40:55Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE4OTkxMw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557189913", "bodyText": "please put each argument in separate line", "author": "kokosing", "createdAt": "2021-01-14T08:29:02Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -434,8 +434,8 @@ private FieldValueProvider getFieldValueProvider(int field, Class<?> expectedTyp\n         @Override\n         public void close()\n         {\n-            log.info(\"Closing cursor - read complete.  Total read: %d batches %d messages, processed: %d messages and %d bytes.\",\n-                    batchesRead, messagesRead, totalMessages, totalBytes);\n+            log.info(\"(%s:%s) Closing cursor - read complete.  Total read: %d batches %d messages, processed: %d messages and %d bytes.\",\n+                    split.getStreamName(), split.getShardId(), batchesRead, messagesRead, totalMessages, totalBytes);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTI5MA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191290", "bodyText": "Please enum.", "author": "kokosing", "createdAt": "2021-01-14T08:29:53Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -47,17 +49,24 @@\n \n     private final String messageDataFormat;\n \n+    /**\n+     * Compression codec to use for decompressing message. Can be null.\n+     */\n+    private final String compressionCodec;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTU3Mg==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191572", "bodyText": "This is obvious, I would remove this comment.", "author": "kokosing", "createdAt": "2021-01-14T08:30:03Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -47,17 +49,24 @@\n \n     private final String messageDataFormat;\n \n+    /**\n+     * Compression codec to use for decompressing message. Can be null.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTk0NQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191945", "bodyText": "Please return Optional", "author": "kokosing", "createdAt": "2021-01-14T08:30:20Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -84,6 +93,13 @@ public String getMessageDataFormat()\n         return messageDataFormat;\n     }\n \n+    @Nullable", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNTYyOQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559025629", "bodyText": "add a coma at the end GZIP,", "author": "kokosing", "createdAt": "2021-01-16T19:54:34Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisCompressionCodec.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.kinesis;\n+\n+public enum KinesisCompressionCodec\n+{\n+    GZIP", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNTkzMw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559025933", "bodyText": "make it private, and move below the usage", "author": "kokosing", "createdAt": "2021-01-16T19:55:33Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -171,6 +179,15 @@ public RecordCursor cursor()\n         return new KinesisRecordCursor();\n     }\n \n+    public static boolean isGZipped(byte[] data)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559026403", "bodyText": "getCompressionCodec() == GZIP then I guess we should fail if !isGZipped(messageData) as this is unexpected.\nMaybe we could have KinesisCompressionCodec.AUTOMATIC, wdyt?", "author": "kokosing", "createdAt": "2021-01-16T19:56:37Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +307,27 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get().equals(KinesisCompressionCodec.GZIP)) {\n+                if (isGZipped(messageData)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTEwMDM2Mw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559100363", "bodyText": "I guess we should fail if !isGZipped(messageData) as this is unexpected.\n\nIt's expected for cases that both compressed and uncompressed messages exist in stream at the same time.\nFor example: during a deployment rollout, for compression based on message size or for cases that some producers didn't implement the compression yet.\n\nMaybe we could have KinesisCompressionCodec.AUTOMATIC\n\nThat would be the ultimate option. I would expect it to decompress any codec, but it's not needed for now, so I would leave it for further implementation", "author": "guyco33", "createdAt": "2021-01-17T08:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0NzA4OA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559447088", "bodyText": "It's expected for cases that both compressed and uncompressed messages exist in stream at the same time.\n\nThis is the case I would like to be handled by KinesisCompressionCodec.AUTOMATIC", "author": "kokosing", "createdAt": "2021-01-18T10:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNzg4Mw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559027883", "bodyText": "static", "author": "kokosing", "createdAt": "2021-01-16T20:00:28Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyODAwNg==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559028006", "bodyText": "I would not not wrap line here.\nUse:\ntry (ByteArrayOutputStream byteOS = new ByteArrayOutputStream()) {\n\nSame above.", "author": "kokosing", "createdAt": "2021-01-16T20:00:58Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try (", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyODIxNQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559028215", "bodyText": "add it to the try above.", "author": "kokosing", "createdAt": "2021-01-16T20:01:35Z", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try (\n+                ByteArrayOutputStream byteOS = new ByteArrayOutputStream()) {\n+            GZIPOutputStream gzipOS = new GZIPOutputStream(byteOS);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNDA0OA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560024048", "bodyText": "Please invert the condition, so there will be less code nested, and corner case will be handled first.", "author": "kokosing", "createdAt": "2021-01-19T09:17:47Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {\n+                if (isGZipped(messageData)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA3Njg3OQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560076879", "bodyText": "The idea was to skip testing the GZIP header if it's not required", "author": "guyco33", "createdAt": "2021-01-19T10:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNDA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNTc2Mg==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560025762", "bodyText": "Extract variable for split.getCompressionCodec().get(). Or even introduce a method to enum canUseGzip() which would return true for AUTOMATIC and GZIP", "author": "kokosing", "createdAt": "2021-01-19T09:20:16Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNzcxMw==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560027713", "bodyText": "We could add UNCOMPRESSED (default value) then we could merge this block with the one at top of this method.", "author": "kokosing", "createdAt": "2021-01-19T09:23:16Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {\n+                if (isGZipped(messageData)) {\n+                    try (\n+                            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);\n+                            GZIPInputStream gZIPInputStream = new GZIPInputStream(byteArrayInputStream)) {\n+                        return messageDecoder.decodeRow(gZIPInputStream.readAllBytes());\n+                    }\n+                    catch (IOException e) {\n+                        throw new TrinoException(GENERIC_INTERNAL_ERROR, e);\n+                    }\n+                }\n+                if (split.getCompressionCodec().get() == GZIP) {\n+                    throw new TrinoException(GENERIC_INTERNAL_ERROR, format(\"Failed to decompress %s message\", split.getCompressionCodec().get()));\n+                }\n+            }\n+            if (split.getCompressionCodec().get() == AUTOMATIC) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MDU5MA==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560180590", "bodyText": "please invert the condition", "author": "kokosing", "createdAt": "2021-01-19T13:38:36Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,28 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            KinesisCompressionCodec kinesisCompressionCodec = split.getCompressionCodec();\n+            if (isGZipped(messageData)) {\n+                if (canUseGzip(kinesisCompressionCodec)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MTE2NQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560181165", "bodyText": "I am not sure if this going to work. You would need to add round trip json serialization test to verify this. Maybe simply remove this annotation?", "author": "kokosing", "createdAt": "2021-01-19T13:39:30Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisStreamFieldGroup.java", "diffHunk": "@@ -42,6 +47,12 @@ public String getDataFormat()\n         return dataFormat;\n     }\n \n+    @JsonProperty", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMxODc3MQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560318771", "bodyText": "I've just remove the annotation", "author": "guyco33", "createdAt": "2021-01-19T16:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MjM5OQ==", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560182399", "bodyText": "please move this method under the usage", "author": "kokosing", "createdAt": "2021-01-19T13:41:26Z", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,28 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "82f914860aa8fe263648fe85aafe789f8cb39d25", "url": "https://github.com/trinodb/trino/commit/82f914860aa8fe263648fe85aafe789f8cb39d25", "message": "Decompress Kinesis message if needed", "committedDate": "2021-01-20T00:21:22Z", "type": "commit"}, {"oid": "3223a037e1076240e398cb853cc83112d9307782", "url": "https://github.com/trinodb/trino/commit/3223a037e1076240e398cb853cc83112d9307782", "message": "Add stream and shard names to log", "committedDate": "2021-01-20T00:21:52Z", "type": "commit"}, {"oid": "3223a037e1076240e398cb853cc83112d9307782", "url": "https://github.com/trinodb/trino/commit/3223a037e1076240e398cb853cc83112d9307782", "message": "Add stream and shard names to log", "committedDate": "2021-01-20T00:21:52Z", "type": "forcePushed"}]}