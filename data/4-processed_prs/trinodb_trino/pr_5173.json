{"pr_number": 5173, "pr_title": "Add column pruning for EXPLAIN ANALYZE ", "pr_createdAt": "2020-09-15T15:17:33Z", "pr_url": "https://github.com/trinodb/trino/pull/5173", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2MDk5NQ==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r490760995", "bodyText": "The assertion passes even if the table scan has more projections than just this one,\nso it is a wrong test for the change.\nYou can see this by changing the query to EXPLAIN ANALYZE SELECT regionkey, nationkey FROM nation\nwithout changing the expected plan. You would want this to fail.", "author": "findepi", "createdAt": "2020-09-18T07:40:47Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1526,6 +1527,18 @@ public void testSizeBasedSemiJoin()\n                                                 values(\"T_A\"))))));\n     }\n \n+    @Test\n+    public void testExplainAnalyze()\n+    {\n+        assertPlan(\"EXPLAIN ANALYZE SELECT regionkey FROM nation\",\n+                output(\n+                        node(ExplainAnalyzeNode.class,\n+                                exchange(\n+                                        LOCAL,\n+                                        GATHER,\n+                                        tableScan(\"nation\", ImmutableMap.of(\"regionkey\", \"regionkey\"))))));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk1MTEwNA==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r490951104", "bodyText": "I have added a new query", "author": "Praveen2112", "createdAt": "2020-09-18T13:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2MDk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MjA5Ng==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r490882096", "bodyText": "The call to mapper.map() potentially modifies mapping. For clarity, move it before the constructor, like mapping of the output symbols.", "author": "kasiafi", "createdAt": "2020-09-18T11:25:57Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/UnaliasSymbolReferences.java", "diffHunk": "@@ -203,7 +203,7 @@ public PlanAndMappings visitExplainAnalyze(ExplainAnalyzeNode node, UnaliasConte\n             Symbol newOutputSymbol = mapper.map(node.getOutputSymbol());\n \n             return new PlanAndMappings(\n-                    new ExplainAnalyzeNode(node.getId(), rewrittenSource.getRoot(), newOutputSymbol, node.isVerbose()),\n+                    new ExplainAnalyzeNode(node.getId(), rewrittenSource.getRoot(), newOutputSymbol, mapper.map(node.getActualOutputs()), node.isVerbose()),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk1MTE0OA==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r490951148", "bodyText": "Moved it !!", "author": "Praveen2112", "createdAt": "2020-09-18T13:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MjA5Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2Mzk0NQ==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r491463945", "bodyText": "Use node(ExchangeNode.class (or better) instead of any", "author": "findepi", "createdAt": "2020-09-19T15:10:51Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1526,6 +1527,19 @@ public void testSizeBasedSemiJoin()\n                                                 values(\"T_A\"))))));\n     }\n \n+    @Test\n+    public void testExplainAnalyze()\n+    {\n+        assertPlan(\"EXPLAIN ANALYZE SELECT regionkey FROM nation ORDER BY nationkey\",\n+                output(\n+                        node(ExplainAnalyzeNode.class,\n+                                strictProject(ImmutableMap.of(\"regionkey\", expression(\"regionkey\")),\n+                                        any(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2Mzk1OA==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r491463958", "bodyText": "This works, but is a bit indirect way of checking this.\nMaybe, instead of adding ORDER BY and strictProject,\nyou can have \"strictTableScan\" matcher?", "author": "findepi", "createdAt": "2020-09-19T15:10:58Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1526,6 +1527,19 @@ public void testSizeBasedSemiJoin()\n                                                 values(\"T_A\"))))));\n     }\n \n+    @Test\n+    public void testExplainAnalyze()\n+    {\n+        assertPlan(\"EXPLAIN ANALYZE SELECT regionkey FROM nation ORDER BY nationkey\",\n+                output(\n+                        node(ExplainAnalyzeNode.class,\n+                                strictProject(ImmutableMap.of(\"regionkey\", expression(\"regionkey\")),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyODM3MA==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r493628370", "bodyText": "Thanks for the feedback. I have added the previous query with a strictTableScan matcher.", "author": "Praveen2112", "createdAt": "2020-09-23T14:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2Mzk1OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3MzMwMg==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r494773302", "bodyText": "columnNumber isn't used.", "author": "kasiafi", "createdAt": "2020-09-25T06:27:10Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LogicalPlanner.java", "diffHunk": "@@ -267,7 +267,17 @@ private RelationPlan createExplainAnalyzePlan(Analysis analysis, Explain stateme\n         PlanNode root = underlyingPlan.getRoot();\n         Scope scope = analysis.getScope(statement);\n         Symbol outputSymbol = symbolAllocator.newSymbol(scope.getRelationType().getFieldByIndex(0));\n-        root = new ExplainAnalyzeNode(idAllocator.getNextId(), root, outputSymbol, statement.isVerbose());\n+\n+        ImmutableList.Builder<Symbol> actualOutputs = ImmutableList.builder();\n+        int columnNumber = 0;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODczMA==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r497338730", "bodyText": "Removed it", "author": "Praveen2112", "createdAt": "2020-09-30T08:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3MzMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3OTY1Mg==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r494779652", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.actualOutputs = requireNonNull(actualOutputs, \"outputs is null\");\n          \n          \n            \n                    this.actualOutputs = requireNonNull(actualOutputs, \"actualOutputs is null\");", "author": "kasiafi", "createdAt": "2020-09-25T06:43:12Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/plan/ExplainAnalyzeNode.java", "diffHunk": "@@ -31,18 +31,21 @@\n {\n     private final PlanNode source;\n     private final Symbol outputSymbol;\n+    private final List<Symbol> actualOutputs;\n     private final boolean verbose;\n \n     @JsonCreator\n     public ExplainAnalyzeNode(\n             @JsonProperty(\"id\") PlanNodeId id,\n             @JsonProperty(\"source\") PlanNode source,\n             @JsonProperty(\"outputSymbol\") Symbol outputSymbol,\n+            @JsonProperty(\"actualOutputs\") List<Symbol> actualOutputs,\n             @JsonProperty(\"verbose\") boolean verbose)\n     {\n         super(id);\n         this.source = requireNonNull(source, \"source is null\");\n         this.outputSymbol = requireNonNull(outputSymbol, \"outputSymbol is null\");\n+        this.actualOutputs = requireNonNull(actualOutputs, \"outputs is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODYzMw==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r497338633", "bodyText": "Applied comments", "author": "Praveen2112", "createdAt": "2020-09-30T08:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3OTY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc4MTIzNw==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r494781237", "bodyText": "Please add a check that source output symbols contain all actualOutputs.", "author": "kasiafi", "createdAt": "2020-09-25T06:47:02Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/plan/ExplainAnalyzeNode.java", "diffHunk": "@@ -31,18 +31,21 @@\n {\n     private final PlanNode source;\n     private final Symbol outputSymbol;\n+    private final List<Symbol> actualOutputs;\n     private final boolean verbose;\n \n     @JsonCreator\n     public ExplainAnalyzeNode(\n             @JsonProperty(\"id\") PlanNodeId id,\n             @JsonProperty(\"source\") PlanNode source,\n             @JsonProperty(\"outputSymbol\") Symbol outputSymbol,\n+            @JsonProperty(\"actualOutputs\") List<Symbol> actualOutputs,\n             @JsonProperty(\"verbose\") boolean verbose)\n     {\n         super(id);\n         this.source = requireNonNull(source, \"source is null\");\n         this.outputSymbol = requireNonNull(outputSymbol, \"outputSymbol is null\");\n+        this.actualOutputs = requireNonNull(actualOutputs, \"outputs is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODU1Mw==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r497338553", "bodyText": "Applied comments", "author": "Praveen2112", "createdAt": "2020-09-30T08:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc4MTIzNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NDI2Mw==", "url": "https://github.com/trinodb/trino/pull/5173#discussion_r497444263", "bodyText": "Do the non-null check first.", "author": "kasiafi", "createdAt": "2020-09-30T11:44:23Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/plan/ExplainAnalyzeNode.java", "diffHunk": "@@ -31,18 +33,22 @@\n {\n     private final PlanNode source;\n     private final Symbol outputSymbol;\n+    private final List<Symbol> actualOutputs;\n     private final boolean verbose;\n \n     @JsonCreator\n     public ExplainAnalyzeNode(\n             @JsonProperty(\"id\") PlanNodeId id,\n             @JsonProperty(\"source\") PlanNode source,\n             @JsonProperty(\"outputSymbol\") Symbol outputSymbol,\n+            @JsonProperty(\"actualOutputs\") List<Symbol> actualOutputs,\n             @JsonProperty(\"verbose\") boolean verbose)\n     {\n         super(id);\n         this.source = requireNonNull(source, \"source is null\");\n         this.outputSymbol = requireNonNull(outputSymbol, \"outputSymbol is null\");\n+        checkArgument(ImmutableSet.copyOf(source.getOutputSymbols()).containsAll(actualOutputs), \"Source does not supply all required input symbols\");\n+        this.actualOutputs = requireNonNull(actualOutputs, \"actualOutputs is null\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "b466fd56baf755e8c5edacf7a5485d4b1ba1550e", "url": "https://github.com/trinodb/trino/commit/b466fd56baf755e8c5edacf7a5485d4b1ba1550e", "message": "Maintain actual output column details in ExplainAnalyze", "committedDate": "2020-10-06T06:56:38Z", "type": "commit"}, {"oid": "e19c3af10738a59e43adc0d6879e4b45b64bb195", "url": "https://github.com/trinodb/trino/commit/e19c3af10738a59e43adc0d6879e4b45b64bb195", "message": "Add column-pruning rule for ExplainAnalyzeNode", "committedDate": "2020-10-06T06:56:39Z", "type": "commit"}, {"oid": "e19c3af10738a59e43adc0d6879e4b45b64bb195", "url": "https://github.com/trinodb/trino/commit/e19c3af10738a59e43adc0d6879e4b45b64bb195", "message": "Add column-pruning rule for ExplainAnalyzeNode", "committedDate": "2020-10-06T06:56:39Z", "type": "forcePushed"}]}