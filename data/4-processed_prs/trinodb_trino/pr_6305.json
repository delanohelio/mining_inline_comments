{"pr_number": 6305, "pr_title": "Expose PrestoDriverUri class", "pr_createdAt": "2020-12-11T14:23:03Z", "pr_url": "https://github.com/trinodb/trino/pull/6305", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4MzcxMw==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541083713", "bodyText": "\"initialize\" them also when uri's provided is empty:\nthis.schema.set(uri.getSchema().orElse(null))\n...\n\nalso, catalog is set twice", "author": "findepi", "createdAt": "2020-12-11T16:49:12Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoConnection.java", "diffHunk": "@@ -106,8 +106,9 @@\n         requireNonNull(uri, \"uri is null\");\n         this.jdbcUri = uri.getJdbcUri();\n         this.httpUri = uri.getHttpUri();\n-        this.schema.set(uri.getSchema());\n-        this.catalog.set(uri.getCatalog());\n+        uri.getSchema().ifPresent(value -> schema.set(value));\n+        uri.getCatalog().ifPresent(value -> catalog.set(value));\n+        this.catalog.set(uri.getCatalog().orElse(null));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTUzMTA0OA==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541531048", "bodyText": "AtomicReference is null by default", "author": "wendigo", "createdAt": "2020-12-12T08:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4MzcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NDUxNw==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541084517", "bodyText": "Add rationale to the cmt mesg. Perhaps\nThis allows applications using Presto JDBC to validate connection string without need to\nopen a connection, or when opening a connection is not possible.", "author": "findepi", "createdAt": "2020-12-11T16:50:21Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -81,7 +81,7 @@\n /**\n  * Parses and extracts parameters from a Presto JDBC URL.\n  */\n-final class PrestoDriverUri\n+public final class PrestoDriverUri", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NDc2Mw==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541084763", "bodyText": "unrelated", "author": "findepi", "createdAt": "2020-12-11T16:50:41Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -343,6 +344,7 @@ private void initCatalogAndSchema()\n         path = path.substring(1);\n \n         List<String> parts = Splitter.on(\"/\").splitToList(path);\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NTQ1Nw==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541085457", "bodyText": "unrelated?", "author": "findepi", "createdAt": "2020-12-11T16:51:42Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -352,16 +354,22 @@ private void initCatalogAndSchema()\n             throw new SQLException(\"Invalid path segments in URL: \" + uri);\n         }\n \n-        if (parts.get(0).isEmpty()) {\n+        if (parts.size() == 0) {\n+            return;\n+        }\n+\n+        if (Strings.isNullOrEmpty(parts.get(0))) {\n             throw new SQLException(\"Catalog name is empty: \" + uri);\n         }\n-        catalog = parts.get(0);\n+\n+        catalog = Optional.ofNullable(parts.get(0));\n \n         if (parts.size() > 1) {\n-            if (parts.get(1).isEmpty()) {\n+            if (Strings.isNullOrEmpty(parts.get(1))) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc5MjU5MA==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r541792590", "bodyText": "the this.catalog is set twice", "author": "findepi", "createdAt": "2020-12-12T22:25:23Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoConnection.java", "diffHunk": "@@ -106,8 +106,9 @@\n         requireNonNull(uri, \"uri is null\");\n         this.jdbcUri = uri.getJdbcUri();\n         this.httpUri = uri.getHttpUri();\n-        this.schema.set(uri.getSchema());\n-        this.catalog.set(uri.getCatalog());\n+        uri.getSchema().ifPresent(value -> schema.set(value));\n+        uri.getCatalog().ifPresent(value -> catalog.set(value));\n+        this.catalog.set(uri.getCatalog().orElse(null));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3NzU5Mg==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542177592", "bodyText": "This is not reachable, by means of conditions above (a bit implicitly).\nIf you want to have some form of assumption validation, use verify for that\nverify(!parts.isEmpty(), \"parts cannot be empty: %s\", parts); // empty path is handled above", "author": "findepi", "createdAt": "2020-12-14T07:56:51Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -352,16 +352,22 @@ private void initCatalogAndSchema()\n             throw new SQLException(\"Invalid path segments in URL: \" + uri);\n         }\n \n+        if (parts.size() == 0) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3ODY4Ng==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542178686", "bodyText": "What's the benefit?\nespecially that the production code is using String only?\nI think i'd rather not have this change. -- I am fine with hiding the constructor with a factory method, but i don't like additional overloads.", "author": "findepi", "createdAt": "2020-12-14T07:58:56Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -119,6 +119,24 @@ private PrestoDriverUri(URI uri, Properties driverProperties)\n         initCatalogAndSchema();\n     }\n \n+    public static PrestoDriverUri create(URI uri, Properties properties)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4MTgwNA==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542181804", "bodyText": "We have this validation in PrestoDriver, see io.prestosql.jdbc.PrestoDriver#DRIVER_URL_START\nOf course, now that PrestoDriverUri is public, it needs its own validation.\n\nmake the Make PrestoDriverUri accessible outside of package commit last, since all others are actually prerequisites for that\nin this validation here, use io.prestosql.jdbc.PrestoDriver#DRIVER_URL_START const (move it from driver to here)", "author": "findepi", "createdAt": "2020-12-14T08:05:07Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -84,6 +84,7 @@\n public final class PrestoDriverUri\n {\n     private static final String JDBC_URL_START = \"jdbc:\";\n+    private static final String JDBC_SCHEME = \"presto\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0ODQwMQ==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542348401", "bodyText": "Please add a test case verifying \"presto://...\" is not a valid URL\n(apparently before your change it was parsed successfully)", "author": "findepi", "createdAt": "2020-12-14T12:33:26Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestPrestoDriverUri.java", "diffHunk": "@@ -68,17 +77,17 @@ public void testInvalidUrls()\n         assertInvalid(\"jdbc:presto://localhost:8080/hive/default?SSL=true&SSLVerification=\", \"Connection property 'SSLVerification' value is empty\");\n \n         // property in url multiple times\n-        assertInvalid(\"presto://localhost:8080/blackhole?password=a&password=b\", \"Connection property 'password' is in URL multiple times\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0OTQ5NQ==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542349495", "bodyText": "from cmt msg:\n\nPreviously we would parse uri with invalid scheme and without jdbc: prefix\nthat could cause java.lang.StringIndexOutOfBoundsException\n\nthis is not quite accurate, since the code was not reachable\nalso, the cmt title could be improved to suggest the validation is moved not _added:\nVerify if Presto JDBC url is not malformed within PrestoDriverUri", "author": "findepi", "createdAt": "2020-12-14T12:35:20Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriver.java", "diffHunk": "@@ -93,7 +91,7 @@ public Connection connect(String url, Properties info)\n     public boolean acceptsURL(String url)\n             throws SQLException\n     {\n-        return url.startsWith(DRIVER_URL_START);\n+        return PrestoDriverUri.acceptsURL(url);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0OTU3OA==", "url": "https://github.com/trinodb/trino/pull/6305#discussion_r542349578", "bodyText": "We do not need this overload, do we?", "author": "findepi", "createdAt": "2020-12-14T12:35:30Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriverUri.java", "diffHunk": "@@ -119,6 +119,18 @@ private PrestoDriverUri(URI uri, Properties driverProperties)\n         initCatalogAndSchema();\n     }\n \n+    public static PrestoDriverUri create(String url, Properties properties)\n+            throws SQLException\n+    {\n+        return new PrestoDriverUri(url, properties);\n+    }\n+\n+    public static PrestoDriverUri create(String url)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "02cb50e568a231d631655c38554386439f95f648", "url": "https://github.com/trinodb/trino/commit/02cb50e568a231d631655c38554386439f95f648", "message": "Make catalog and schema optional in PrestoDriverUri", "committedDate": "2020-12-14T20:30:55Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "85282868ac2a0029d99b0b6ce944e91b793c9647", "url": "https://github.com/trinodb/trino/commit/85282868ac2a0029d99b0b6ce944e91b793c9647", "message": "Use PrestoDriverUri by static builder methods", "committedDate": "2020-12-14T21:23:22Z", "type": "commit"}, {"oid": "20fd93f322dce127bc115ac31ec406ee1661082b", "url": "https://github.com/trinodb/trino/commit/20fd93f322dce127bc115ac31ec406ee1661082b", "message": "Verify if Presto JDBC uri is not malformed\n\nPreviously we would parse uri with invalid scheme and without jdbc: prefix\nthat could cause java.lang.StringIndexOutOfBoundsException", "committedDate": "2020-12-14T21:23:47Z", "type": "commit"}, {"oid": "cdf986aa35cc8b584b62c26c2b6feaa01258310d", "url": "https://github.com/trinodb/trino/commit/cdf986aa35cc8b584b62c26c2b6feaa01258310d", "message": "Make PrestoDriverUri accessible outside of package\n\nThis allows applications using Presto JDBC to validate connection string without need to\nopen a connection, or when opening a connection is not possible.", "committedDate": "2020-12-14T21:23:48Z", "type": "commit"}, {"oid": "cdf986aa35cc8b584b62c26c2b6feaa01258310d", "url": "https://github.com/trinodb/trino/commit/cdf986aa35cc8b584b62c26c2b6feaa01258310d", "message": "Make PrestoDriverUri accessible outside of package\n\nThis allows applications using Presto JDBC to validate connection string without need to\nopen a connection, or when opening a connection is not possible.", "committedDate": "2020-12-14T21:23:48Z", "type": "forcePushed"}]}