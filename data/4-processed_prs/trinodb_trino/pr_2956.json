{"pr_number": 2956, "pr_title": "Base JDBC connector improvements", "pr_createdAt": "2020-02-26T18:33:09Z", "pr_url": "https://github.com/trinodb/trino/pull/2956", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3Njg1NA==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384776854", "bodyText": "the related issue is not fixed.", "author": "findepi", "createdAt": "2020-02-26T21:28:17Z", "path": "presto-phoenix/src/test/java/io/prestosql/plugin/phoenix/TestPhoenixIntegrationSmokeTest.java", "diffHunk": "@@ -157,12 +157,6 @@ public void testCreateSchema()\n         throw new SkipException(\"test disabled until issue fixed\"); // TODO https://github.com/prestosql/presto/issues/2348\n     }\n \n-    @Override\n-    public void testDropSchema()\n-    {\n-        throw new SkipException(\"test disabled until issue fixed\"); // TODO https://github.com/prestosql/presto/issues/2348", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwOTEzNw==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384809137", "bodyText": "This is moved to TestPhoenixDistributedQueries", "author": "electrum", "createdAt": "2020-02-26T22:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3Njg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzMyNA==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384777324", "bodyText": "Do we need any access control checks for this?", "author": "findepi", "createdAt": "2020-02-26T21:29:07Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -816,6 +816,17 @@ public void createSchema(JdbcIdentity identity, String schemaName)\n         }\n     }\n \n+    @Override\n+    public void dropSchema(JdbcIdentity identity, String schemaName)\n+    {\n+        try (Connection connection = connectionFactory.openConnection(identity)) {\n+            execute(connection, \"DROP SCHEMA \" + quoted(schemaName));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzAzNg==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384803036", "bodyText": "Access control is handled by the engine (see DropSchemaTask)", "author": "dain", "createdAt": "2020-02-26T22:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0MjQ1Mg==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384842452", "bodyText": "We have a legacy check for allowDropTable, which should be removed. Dropping a schema should be safe since databases require the schema to be empty (unless called with CASCADE which we don't use).", "author": "electrum", "createdAt": "2020-02-27T00:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzQwNA==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384777404", "bodyText": "i dont think it's needed", "author": "findepi", "createdAt": "2020-02-26T21:29:17Z", "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/CreateAsSelectDataSetup.java", "diffHunk": "@@ -45,7 +45,12 @@ public TestTable setupTestTable(List<DataTypeTest.Input<?>> inputs)\n         Stream<String> columnValuesWithNames = range(0, columnValues.size())\n                 .mapToObj(i -> format(\"%s col_%d\", columnValues.get(i), i));\n         String selectBody = Joiner.on(\",\\n\").join(columnValuesWithNames.iterator());\n-        return new TestTable(sqlExecutor, tableNamePrefix, \"AS SELECT \" + selectBody);\n+        return new TestTable(sqlExecutor, tableNamePrefix, getTableDefinition(selectBody));\n+    }\n+\n+    protected String getTableDefinition(String selectBody)\n+    {\n+        return \"AS SELECT \" + selectBody;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0MzE4Nw==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384843187", "bodyText": "Removed", "author": "electrum", "createdAt": "2020-02-27T00:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzY1Ng==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384777656", "bodyText": "it's better throw new SkipException", "author": "findepi", "createdAt": "2020-02-26T21:29:50Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/TestAccumuloDistributedQueries.java", "diffHunk": "@@ -45,6 +45,12 @@ protected QueryRunner createQueryRunner()\n         return createAccumuloQueryRunner(ImmutableMap.of());\n     }\n \n+    @Override\n+    public void testCreateSchema()\n+    {\n+        // schema creation is not supported", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwODk3MA==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384808970", "bodyText": "This is existing behavior, and we do this in many other places, so I'll leave it alone here. If we want to change the policy, we'll do it consistently instead of for one method.", "author": "electrum", "createdAt": "2020-02-26T22:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzY1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2NzAzNw==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r385867037", "bodyText": "i believe both  are \"existing behavior\"", "author": "findepi", "createdAt": "2020-02-28T18:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzY1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzNzg2OQ==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r386037869", "bodyText": "eg 789027e", "author": "findepi", "createdAt": "2020-02-29T16:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NzcxOQ==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384777719", "bodyText": "SkipException", "author": "findepi", "createdAt": "2020-02-26T21:29:58Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraDistributedQueries.java", "diffHunk": "@@ -49,6 +49,12 @@ protected boolean supportsViews()\n         return false;\n     }\n \n+    @Override\n+    public void testCreateSchema()\n+    {\n+        // Cassandra does not support creating schemas", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4Mjg3Mg==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384782872", "bodyText": "Please add a javadoc to ATDQ and ATIST governing what goes where.\nAlso, now the test is no longer run for: redis, jdbc+h2, kafka, thrift, ES, Kudu, Accumulo and Mongo", "author": "findepi", "createdAt": "2020-02-26T21:40:15Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1153,4 +1154,19 @@ public void testCreateSchema()\n         assertUpdate(\"DROP SCHEMA test_schema_create\");\n         assertQueryFails(\"DROP SCHEMA test_schema_create\", \"line 1:1: Schema '.*\\\\.test_schema_create' does not exist\");\n     }\n+\n+    @Test\n+    public void testInsertForDefaultColumn()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NDEyNQ==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384784125", "bodyText": "i'd keep image name and version together (\"mysql:8.0.12\") -- no much drawback but a lot more flexible.\nAlso, we should run tests with Maria DB (follow up)", "author": "findepi", "createdAt": "2020-02-26T21:42:48Z", "path": "presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestingMySqlServer.java", "diffHunk": "@@ -22,12 +22,17 @@\n \n import static java.lang.String.format;\n \n-public class TestingMySqlServer\n+public final class TestingMySqlServer\n         extends MySQLContainer<TestingMySqlServer>\n {\n     public TestingMySqlServer()\n     {\n-        super(\"mysql:8.0.12\");\n+        this(\"8.0.12\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTAxNQ==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384785015", "bodyText": "i feel it's better to avoid extending Config classes. can we avoid this?", "author": "findepi", "createdAt": "2020-02-26T21:44:24Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlJdbcConfig.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.mysql;\n+\n+import com.mysql.jdbc.Driver;\n+import io.prestosql.plugin.jdbc.BaseJdbcConfig;\n+\n+import javax.validation.constraints.AssertTrue;\n+\n+import java.sql.SQLException;\n+import java.util.Properties;\n+\n+public class MySqlJdbcConfig\n+        extends BaseJdbcConfig", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NDY1Mw==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384844653", "bodyText": "I'm not sure how the config system would handle multiple bound config classes that have conflicting annotations like ConfigDescription. Also, we want this to be identical to the parent, but with additional validations, so this seems the best way.\nIdeally, there would be some way to bind additional bean validators.", "author": "electrum", "createdAt": "2020-02-27T00:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTQxOA==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384785418", "bodyText": "technically, it's redundant", "author": "findepi", "createdAt": "2020-02-26T21:45:12Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/TestAccumuloIntegrationSmokeTest.java", "diffHunk": "@@ -33,28 +34,22 @@ protected QueryRunner createQueryRunner()\n         return createAccumuloQueryRunner(ImmutableMap.of());\n     }\n \n+    @Test", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NTQ4Nw==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384845487", "bodyText": "Agreed, but it seems cleaner to have them. For example, what if the original had something like @Test(expectedExceptions=...)", "author": "electrum", "createdAt": "2020-02-27T00:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTQ0NQ==", "url": "https://github.com/trinodb/trino/pull/2956#discussion_r384785445", "bodyText": "technically, it's redundant", "author": "findepi", "createdAt": "2020-02-26T21:45:15Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraIntegrationSmokeTest.java", "diffHunk": "@@ -90,16 +92,23 @@ public void tearDown()\n         server.close();\n     }\n \n+    @Test", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "4335b0540cb5dd5b09341be1685d3854562e90e7", "url": "https://github.com/trinodb/trino/commit/4335b0540cb5dd5b09341be1685d3854562e90e7", "message": "Implement DROP SCHEMA for JDBC connectors", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "5de323182af11b14ef07c0089313556a8c136510", "url": "https://github.com/trinodb/trino/commit/5de323182af11b14ef07c0089313556a8c136510", "message": "Move schema creation tests to distributed query tests", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "b86387075bce4bff148125d974ca12ab91b70832", "url": "https://github.com/trinodb/trino/commit/b86387075bce4bff148125d974ca12ab91b70832", "message": "Move insert default tests to distributed query tests", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "65a5712b53b2c5ae11b8d6eccf11948d77c04e6e", "url": "https://github.com/trinodb/trino/commit/65a5712b53b2c5ae11b8d6eccf11948d77c04e6e", "message": "Add CredentialPropertiesProvider for base JDBC", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "e5a0d781b37942e65e3ec1fdc15f89a611791136", "url": "https://github.com/trinodb/trino/commit/e5a0d781b37942e65e3ec1fdc15f89a611791136", "message": "Make assertExplainAnalyze protected", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "60dad01190eadb3850097767d62cb84f233cfb21", "url": "https://github.com/trinodb/trino/commit/60dad01190eadb3850097767d62cb84f233cfb21", "message": "Allow overriding image for TestingMySqlServer", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "8cb956fe8442e036328a76febe0575bdedfc3ecf", "url": "https://github.com/trinodb/trino/commit/8cb956fe8442e036328a76febe0575bdedfc3ecf", "message": "Use bean validation for MySQL connector URL", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "1e81a5ad098ea2f6cc1e98733999f524d4aaa3ca", "url": "https://github.com/trinodb/trino/commit/1e81a5ad098ea2f6cc1e98733999f524d4aaa3ca", "message": "Simplify connector differences for testDescribeTable", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "337dd30d26a0ace0b5b2bd99ccedcc0a556f35de", "url": "https://github.com/trinodb/trino/commit/337dd30d26a0ace0b5b2bd99ccedcc0a556f35de", "message": "Make testDuplicatedRowCreateTable engine only", "committedDate": "2020-02-27T01:02:41Z", "type": "commit"}, {"oid": "337dd30d26a0ace0b5b2bd99ccedcc0a556f35de", "url": "https://github.com/trinodb/trino/commit/337dd30d26a0ace0b5b2bd99ccedcc0a556f35de", "message": "Make testDuplicatedRowCreateTable engine only", "committedDate": "2020-02-27T01:02:41Z", "type": "forcePushed"}]}