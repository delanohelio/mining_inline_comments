{"pr_number": 2414, "pr_title": "Use testcontainers for SQLServer tests", "pr_createdAt": "2020-01-06T04:11:59Z", "pr_url": "https://github.com/trinodb/trino/pull/2414", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MTkyMg==", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r363161922", "bodyText": "I think this can use dockerContainer.createConnection(\"\")", "author": "electrum", "createdAt": "2020-01-06T05:22:55Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestingSqlServer.java", "diffHunk": "@@ -13,49 +13,29 @@\n  */\n package io.prestosql.plugin.sqlserver;\n \n-import com.google.common.collect.ImmutableMap;\n-import io.prestosql.testing.docker.DockerContainer;\n-import io.prestosql.testing.docker.DockerContainer.HostPortProvider;\n+import org.testcontainers.containers.MSSQLServerContainer;\n \n import java.io.Closeable;\n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.Statement;\n \n-import static java.lang.String.format;\n-\n public final class TestingSqlServer\n         implements Closeable\n {\n-    private static final int SQL_SERVER_PORT = 1433;\n-\n-    public static final String USER = \"sa\";\n-    public static final String PASSWORD = \"SQLServerPass1\";\n-\n-    private final DockerContainer dockerContainer;\n+    private final MSSQLServerContainer<?> dockerContainer;\n \n     public TestingSqlServer()\n     {\n-        this.dockerContainer = DockerContainer.forImage(\"microsoft/mssql-server-linux:2017-CU13\")\n-                .setPorts(SQL_SERVER_PORT)\n-                .setEnvironment(ImmutableMap.of(\n-                        \"ACCEPT_EULA\", \"Y\",\n-                        \"SA_PASSWORD\", \"SQLServerPass1\"))\n-                .setHealthCheck(portProvider -> TestingSqlServer.execute(portProvider, \"SELECT 1\"))\n-                .start();\n+        this.dockerContainer = new MSSQLServerContainer(\"microsoft/mssql-server-linux:2017-CU13\");\n+        dockerContainer.start();\n     }\n \n     public void execute(String sql)\n     {\n-        execute(dockerContainer::getHostPort, sql);\n-    }\n-\n-    private static void execute(HostPortProvider hostPortProvider, String sql)\n-    {\n-        String jdbcUrl = getJdbcUrl(hostPortProvider.getHostPort(SQL_SERVER_PORT));\n-        try (Connection conn = DriverManager.getConnection(jdbcUrl, USER, PASSWORD);\n-                Statement stmt = conn.createStatement()) {\n-            stmt.execute(sql);\n+        try (Connection connection = DriverManager.getConnection(dockerContainer.getJdbcUrl(), dockerContainer.getUsername(), dockerContainer.getPassword());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MjEzNQ==", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r363162135", "bodyText": "Consider removing this class. I'm not sure it provides much value compared to using MSSQLServerContainer directly. I did that in these two and it seems to work well: #2408 #2410", "author": "electrum", "createdAt": "2020-01-06T05:24:48Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestingSqlServer.java", "diffHunk": "@@ -13,49 +13,29 @@\n  */\n package io.prestosql.plugin.sqlserver;\n \n-import com.google.common.collect.ImmutableMap;\n-import io.prestosql.testing.docker.DockerContainer;\n-import io.prestosql.testing.docker.DockerContainer.HostPortProvider;\n+import org.testcontainers.containers.MSSQLServerContainer;\n \n import java.io.Closeable;\n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.Statement;\n \n-import static java.lang.String.format;\n-\n public final class TestingSqlServer", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI2NDgwNg==", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r363264806", "bodyText": "I think the small benefit is we can manage the version in a single place. We will need to fix three places in SQLServer connector when we upgrade the version. (Or we could define it as a constant in somewhere)", "author": "ebyhr", "createdAt": "2020-01-06T11:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MjEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ1NzA5MQ==", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r364457091", "bodyText": "Agreed, I came to the same conclusion thanks to @kokosing. One approach is to make TestingSqlServer extend MSSQLServerContainer, like I did in 79b5d4f. Then you don't need getUsername(), etc.", "author": "electrum", "createdAt": "2020-01-08T21:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MjEzNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "01a9ef2b972856c374867a8b291c9ae391cd5de9", "url": "https://github.com/trinodb/trino/commit/01a9ef2b972856c374867a8b291c9ae391cd5de9", "message": "Use testcontainers for SQLServer tests\n\nAdditionally:\n- rename abbreviated variables\n- override createQueryRunner instead of constructor", "committedDate": "2020-01-09T02:47:51Z", "type": "commit"}, {"oid": "01a9ef2b972856c374867a8b291c9ae391cd5de9", "url": "https://github.com/trinodb/trino/commit/01a9ef2b972856c374867a8b291c9ae391cd5de9", "message": "Use testcontainers for SQLServer tests\n\nAdditionally:\n- rename abbreviated variables\n- override createQueryRunner instead of constructor", "committedDate": "2020-01-09T02:47:51Z", "type": "forcePushed"}]}