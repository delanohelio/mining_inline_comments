{"pr_number": 4233, "pr_title": "Fix case-sensitivity failure for DISTINCT + ORDER BY", "pr_createdAt": "2020-06-25T22:40:41Z", "pr_url": "https://github.com/trinodb/trino/pull/4233", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwOTI0Mw==", "url": "https://github.com/trinodb/trino/pull/4233#discussion_r454909243", "bodyText": "move this method below verifySelectDistinct", "author": "kokosing", "createdAt": "2020-07-15T09:13:57Z", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -2597,21 +2545,56 @@ private Scope analyzeWith(Query node, Optional<Scope> scope)\n             return withScope;\n         }\n \n-        private void verifySelectDistinct(QuerySpecification node, List<Expression> outputExpressions)\n+        private Set<CanonicalizationAware<Identifier>> getAliases(Select node)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExOTI3MQ==", "url": "https://github.com/trinodb/trino/pull/4233#discussion_r455119271", "bodyText": "Maybe add a comment why there's need to derive \"aliases\" from Identifiers and DereferenceExpressions?\nIf my understanding is correct, they cannot be identified by ScopeAwareKey, just like other expressions (e.g. a + b) because the Identifiers in ORDER BY are tied to a different RelationId than their source values.", "author": "kasiafi", "createdAt": "2020-07-15T14:57:30Z", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -2597,21 +2545,56 @@ private Scope analyzeWith(Query node, Optional<Scope> scope)\n             return withScope;\n         }\n \n-        private void verifySelectDistinct(QuerySpecification node, List<Expression> outputExpressions)\n+        private Set<CanonicalizationAware<Identifier>> getAliases(Select node)\n         {\n-            for (SortItem item : node.getOrderBy().get().getSortItems()) {\n-                Expression expression = item.getSortKey();\n+            ImmutableSet.Builder<CanonicalizationAware<Identifier>> aliases = ImmutableSet.builder();\n+            for (SelectItem item : node.getSelectItems()) {\n+                if (item instanceof SingleColumn) {\n+                    SingleColumn column = (SingleColumn) item;\n+                    Optional<Identifier> alias = column.getAlias();\n+                    if (alias.isPresent()) {\n+                        aliases.add(canonicalizationAwareKey(alias.get()));\n+                    }\n+                    else if (column.getExpression() instanceof Identifier) {\n+                        aliases.add(canonicalizationAwareKey((Identifier) column.getExpression()));\n+                    }\n+                    else if (column.getExpression() instanceof DereferenceExpression) {\n+                        aliases.add(canonicalizationAwareKey(((DereferenceExpression) column.getExpression()).getField()));\n+                    }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2OTI4MQ==", "url": "https://github.com/trinodb/trino/pull/4233#discussion_r455169281", "bodyText": "Exactly, if you have SELECT a FROM t ORDER BY a, the a in the SELECT clause is bound to the FROM scope, while the a in ORDER BY clause is bound to the a from the SELECT clause, so we can't compare by field id / relation id.", "author": "martint", "createdAt": "2020-07-15T16:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExOTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyMTY1Mw==", "url": "https://github.com/trinodb/trino/pull/4233#discussion_r455121653", "bodyText": "it is withDifferentQualification, too", "author": "kasiafi", "createdAt": "2020-07-15T15:00:56Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestDistinctWithOrderBy.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.sql.query;\n+\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestDistinctWithOrderBy\n+{\n+    private QueryAssertions assertions;\n+\n+    @BeforeClass\n+    public void init()\n+    {\n+        assertions = new QueryAssertions();\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public void teardown()\n+    {\n+        assertions.close();\n+        assertions = null;\n+    }\n+\n+    @Test\n+    public void testOrderByReferenceWithDifferentCapitalization()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyNDEwNw==", "url": "https://github.com/trinodb/trino/pull/4233#discussion_r455124107", "bodyText": "Consider adding a test with conflicting aliases, e.g. SELECT DISTINCT a, b a FROM (VALUES (1, 5), (2, 4)) T(a,b) ORDER BY T.a DESC", "author": "kasiafi", "createdAt": "2020-07-15T15:04:21Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestDistinctWithOrderBy.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.sql.query;\n+\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestDistinctWithOrderBy\n+{\n+    private QueryAssertions assertions;\n+\n+    @BeforeClass\n+    public void init()\n+    {\n+        assertions = new QueryAssertions();\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public void teardown()\n+    {\n+        assertions.close();\n+        assertions = null;\n+    }\n+\n+    @Test\n+    public void testOrderByReferenceWithDifferentCapitalization()\n+    {\n+        assertThat(assertions.query(\"SELECT DISTINCT t.A FROM (VALUES 2, 1, 2) t(a) ORDER BY t.a\"))\n+                .matches(\"VALUES 1, 2\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a FROM (VALUES 2, 1, 2) t(a) ORDER BY A\"))\n+                .matches(\"VALUES 1, 2\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a FROM (VALUES 2, 1, 2) t(a) ORDER BY t.A\"))\n+                .matches(\"VALUES 1, 2\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT t.a FROM (VALUES 2, 1, 2) t(a) ORDER BY A\"))\n+                .matches(\"VALUES 1, 2\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a + B FROM (VALUES (2, 2), (1, 1), (2, 2)) t(a, b) ORDER BY a + b\"))\n+                .matches(\"VALUES 2, 4\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a + B FROM (VALUES (2, 2), (1, 1), (2, 2)) t(a, b) ORDER BY a + t.b\"))\n+                .matches(\"VALUES 2, 4\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a + t.B FROM (VALUES (2, 2), (1, 1), (2, 2)) t(a, b) ORDER BY a + b\"))\n+                .matches(\"VALUES 2, 4\");\n+\n+        assertThat(assertions.query(\"SELECT DISTINCT a + t.B FROM (VALUES (2, 2), (1, 1), (2, 2)) t(a, b) ORDER BY a + t.b\"))\n+                .matches(\"VALUES 2, 4\");\n+    }\n+\n+    @Test\n+    public void testSelectAllAliases()\n+    {\n+        assertThat(assertions.query(\"SELECT DISTINCT t.r.* AS (a, b) FROM (VALUES ROW(CAST(ROW(1,1) AS ROW(a BIGINT, b BIGINT)))) t(r) ORDER BY a\"))\n+                .matches(\"VALUES (BIGINT '1', BIGINT '1')\");\n+    }\n+}", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "ebffa08d0928c153968afc5974d1a731b9d7e97e", "url": "https://github.com/trinodb/trino/commit/ebffa08d0928c153968afc5974d1a731b9d7e97e", "message": "Fix case-sensitivity failure for DISTINCT + ORDER BY", "committedDate": "2020-07-16T17:35:31Z", "type": "commit"}, {"oid": "ebffa08d0928c153968afc5974d1a731b9d7e97e", "url": "https://github.com/trinodb/trino/commit/ebffa08d0928c153968afc5974d1a731b9d7e97e", "message": "Fix case-sensitivity failure for DISTINCT + ORDER BY", "committedDate": "2020-07-16T17:35:31Z", "type": "forcePushed"}]}