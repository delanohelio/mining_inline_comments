{"pr_number": 5870, "pr_title": "Add support for limit pushdown in MongoDB", "pr_createdAt": "2020-11-08T14:27:40Z", "pr_url": "https://github.com/trinodb/trino/pull/5870", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg==", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521151816", "bodyText": "The documentation in https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit mentions that\n\nA limit() value of 0 (i.e. .limit(0)) is equivalent to setting no limit.\n\nIs this true for the API iterable.limit(0) being used here as well?\nGenerally speaking the engine should optimize the LIMIT 0 clause, but the mongodb behavior seems counterintuitive to me. If that is indeed the case, then should we encode/document that special case here?", "author": "phd3", "createdAt": "2020-11-11T06:54:49Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoMetadata.java", "diffHunk": "@@ -250,6 +252,25 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 localProperties.build());\n     }\n \n+    @Override\n+    public Optional<LimitApplicationResult<ConnectorTableHandle>> applyLimit(ConnectorSession session, ConnectorTableHandle table, long limit)\n+    {\n+        MongoTableHandle handle = (MongoTableHandle) table;\n+\n+        // MongoDB doesn't support limit number greater than integer max\n+        if (limit > Integer.MAX_VALUE) {\n+            return Optional.empty();\n+        }\n+\n+        if (handle.getLimit().isPresent() && handle.getLimit().getAsLong() <= limit) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5OTcwMw==", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521299703", "bodyText": "That's true. Though the situation shouldn't be happen as you know, I added following logic and a test.\n        // MongoDB cursor.limit(0) is equivalent to setting no limit\n        if (limit == 0) {\n            return Optional.empty();\n        }", "author": "ebyhr", "createdAt": "2020-11-11T11:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMDE2Mg==", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521310162", "bodyText": "Ideally Presto will replace if it encounters a limit node with count as 0. Anyway it is good to have this check", "author": "Praveen2112", "createdAt": "2020-11-11T12:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTAyMw==", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521311023", "bodyText": "Can we maintain it as OptionalInt as we won't pushdown  limit if is beyond Integer range.", "author": "Praveen2112", "createdAt": "2020-11-11T12:03:45Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoTableHandle.java", "diffHunk": "@@ -29,19 +30,22 @@\n {\n     private final SchemaTableName schemaTableName;\n     private final TupleDomain<ColumnHandle> constraint;\n+    private final OptionalLong limit;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMyNjc4Nw==", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521326787", "bodyText": "Updated to OptionalInt from OptionalLong.", "author": "ebyhr", "createdAt": "2020-11-11T12:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTAyMw=="}], "type": "inlineReview"}, {"oid": "5ac3fd46193f6a32afbf760c37bd009066b7d8fd", "url": "https://github.com/trinodb/trino/commit/5ac3fd46193f6a32afbf760c37bd009066b7d8fd", "message": "Add support for limit pushdown in MongoDB", "committedDate": "2020-11-11T12:29:50Z", "type": "commit"}, {"oid": "5ac3fd46193f6a32afbf760c37bd009066b7d8fd", "url": "https://github.com/trinodb/trino/commit/5ac3fd46193f6a32afbf760c37bd009066b7d8fd", "message": "Add support for limit pushdown in MongoDB", "committedDate": "2020-11-11T12:29:50Z", "type": "forcePushed"}]}