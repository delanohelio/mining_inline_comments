{"pr_number": 2924, "pr_title": "Procedure system access control", "pr_createdAt": "2020-02-24T12:24:27Z", "pr_url": "https://github.com/trinodb/trino/pull/2924", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NTkzOA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383285938", "bodyText": "@AfterClass(alwaysRun = true)", "author": "kokosing", "createdAt": "2020-02-24T14:11:59Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNDY2Mw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384324663", "bodyText": "bump", "author": "findepi", "createdAt": "2020-02-26T08:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NjM3MQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383286371", "bodyText": "long", "author": "kokosing", "createdAt": "2020-02-24T14:12:43Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();\n+    }\n+\n+    @Test\n+    public void testExecute()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new AllowAllAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(1);\n+\n+        new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of());\n+\n+        assertThat(invocations).contains(1L);\n+    }\n+\n+    private Call getProcedureInvocation(int id)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NzUwNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383287505", "bodyText": "s/foo/procedure\nI would inline getTestProcedure()", "author": "kokosing", "createdAt": "2020-02-24T14:14:47Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();\n+    }\n+\n+    @Test\n+    public void testExecute()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new AllowAllAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(1);\n+\n+        new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of());\n+\n+        assertThat(invocations).contains(1L);\n+    }\n+\n+    private Call getProcedureInvocation(int id)\n+    {\n+        return new Call(QualifiedName.of(\"foo\"), ImmutableList.of(new CallArgument(new LongLiteral(Integer.toString(id)))));\n+    }\n+\n+    private MetadataManager createMetadataManager(TransactionManager transactionManager)\n+    {\n+        MetadataManager metadata = createTestMetadataManager(transactionManager, new FeaturesConfig());\n+        Procedure foo = getTestProcedure();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NzYxOA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383287618", "bodyText": "no need for this empty line", "author": "kokosing", "createdAt": "2020-02-24T14:15:00Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();\n+    }\n+\n+    @Test\n+    public void testExecute()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new AllowAllAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(1);\n+\n+        new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of());\n+\n+        assertThat(invocations).contains(1L);\n+    }\n+\n+    private Call getProcedureInvocation(int id)\n+    {\n+        return new Call(QualifiedName.of(\"foo\"), ImmutableList.of(new CallArgument(new LongLiteral(Integer.toString(id)))));\n+    }\n+\n+    private MetadataManager createMetadataManager(TransactionManager transactionManager)\n+    {\n+        MetadataManager metadata = createTestMetadataManager(transactionManager, new FeaturesConfig());\n+        Procedure foo = getTestProcedure();\n+        metadata.getProcedureRegistry().addProcedures(new CatalogName(\"test\"), ImmutableList.of(foo));\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4ODEzNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383288135", "bodyText": "s/foo/testing_procedure", "author": "kokosing", "createdAt": "2020-02-24T14:15:51Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();\n+    }\n+\n+    @Test\n+    public void testExecute()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new AllowAllAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(1);\n+\n+        new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of());\n+\n+        assertThat(invocations).contains(1L);\n+    }\n+\n+    private Call getProcedureInvocation(int id)\n+    {\n+        return new Call(QualifiedName.of(\"foo\"), ImmutableList.of(new CallArgument(new LongLiteral(Integer.toString(id)))));\n+    }\n+\n+    private MetadataManager createMetadataManager(TransactionManager transactionManager)\n+    {\n+        MetadataManager metadata = createTestMetadataManager(transactionManager, new FeaturesConfig());\n+        Procedure foo = getTestProcedure();\n+        metadata.getProcedureRegistry().addProcedures(new CatalogName(\"test\"), ImmutableList.of(foo));\n+\n+        return metadata;\n+    }\n+\n+    private TransactionManager createTransactionManager()\n+    {\n+        CatalogManager catalogManager = new CatalogManager();\n+        catalogManager.registerCatalog(createBogusTestingCatalog(\"test\"));\n+        return createTestTransactionManager(catalogManager);\n+    }\n+\n+    private Procedure getTestProcedure()\n+    {\n+        return new Procedure(\n+                \"test\",\n+                \"foo\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MDM3Nw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383290377", "bodyText": "no need for empty line here", "author": "kokosing", "createdAt": "2020-02-24T14:19:50Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/CatalogSchemaProcedureName.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.connector;\n+\n+import java.util.Objects;\n+\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CatalogSchemaProcedureName\n+{\n+    private final String catalogName;\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MDQxOA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383290418", "bodyText": "final", "author": "kokosing", "createdAt": "2020-02-24T14:19:54Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/CatalogSchemaProcedureName.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.connector;\n+\n+import java.util.Objects;\n+\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CatalogSchemaProcedureName", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MDQ4Mw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r383290483", "bodyText": "final", "author": "kokosing", "createdAt": "2020-02-24T14:20:03Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/SchemaProcedureName.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.connector;\n+\n+import java.util.Objects;\n+\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SchemaProcedureName", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNDgwNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384324805", "bodyText": "shutdownNow", "author": "findepi", "createdAt": "2020-02-26T08:02:52Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNTEzMg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384325132", "bodyText": "should be static. but even better, should be created in @BeforeClass", "author": "findepi", "createdAt": "2020-02-26T08:03:39Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNTM4NQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384325385", "bodyText": "mark the test class as @Test(singleThreaded = true). Today you have 1 test method, but the approach taken won't allow concurrent test executions in the future", "author": "findepi", "createdAt": "2020-02-26T08:04:16Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNTU3OA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384335578", "bodyText": "Why won't it work for concurrent executions? (apart from the fact that the set should be synchronized)", "author": "skrzypo987", "createdAt": "2020-02-26T08:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNTM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1NjUwMw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384356503", "bodyText": "depends how you use the collections. If you make the threads single-threaded, they will be lot ismpler to reason about", "author": "findepi", "createdAt": "2020-02-26T09:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNTM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNjE5OA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384326198", "bodyText": "Maybe test with more meaningful (aka \"more random\") number. 1 is more likely to come from a different place than eg 2382344352.", "author": "findepi", "createdAt": "2020-02-26T08:06:20Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.CallArgument;\n+import io.prestosql.sql.tree.LongLiteral;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.HashSet;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestCallTask\n+{\n+    private final ExecutorService executor = newCachedThreadPool(daemonThreadsNamed(\"call-task-test-%s\"));\n+\n+    private static Set<Long> invocations = new HashSet<>();\n+\n+    @AfterClass\n+    public void close()\n+    {\n+        executor.shutdown();\n+    }\n+\n+    @Test\n+    public void testExecute()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new AllowAllAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(1);\n+\n+        new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of());\n+\n+        assertThat(invocations).contains(1L);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNzUxNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384337515", "bodyText": "I am not entirely sure about that. Just how many times when prompted for file name you typed \"fadsf\" and it turned out that the file already exists. Ideally we could make a static global atomic counter for those numbers but that seems to be an overkill.", "author": "skrzypo987", "createdAt": "2020-02-26T08:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNjE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1Njg0MA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384356840", "bodyText": "Ideally we could make a static global atomic counter for those numbers but that seems to be an overkill.\n\ni agree\n\nI am not entirely sure about that. Just how many times when prompted for file name you typed \"fadsf\" and it turned out that the file already exists.\n\nYes, but still better than \"a.out\"", "author": "findepi", "createdAt": "2020-02-26T09:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNjE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384327787", "bodyText": "if you make the tests singlethreaded, you can clear invocations in @BeforeMethod and here assert it's empty", "author": "findepi", "createdAt": "2020-02-26T08:10:26Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -76,17 +81,38 @@ public void testExecute()\n         assertThat(invocations).contains(1L);\n     }\n \n-    private Call getProcedureInvocation(int id)\n+    @Test\n+    public void testExecuteNoPermission()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new DenyProcedureAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(2);\n+\n+        assertThatThrownBy(\n+                () -> new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of()))\n+                .isInstanceOf(AccessDeniedException.class);\n+\n+        assertThat(invocations).doesNotContain(2L);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM0MTk3NA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384341974", "bodyText": "I think the whole point is that tests should be multi-threaded if possible.I", "author": "skrzypo987", "createdAt": "2020-02-26T08:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1NzMyNw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384357327", "bodyText": "Yes, unless it makes it harder to work with them. So my rule of thumb is: if there is shared mutable state => single threaded. Multithreaded otherwise.", "author": "findepi", "createdAt": "2020-02-26T09:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MTI1Mw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384361253", "bodyText": "It was actually made single threaded at first but did not pass the review because of that. Since I do not want to start a flame war of any kind I will just add the atomic test counter a close this discussion.", "author": "skrzypo987", "createdAt": "2020-02-26T09:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM3OTE0Mw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384379143", "bodyText": "@skrzypo987 it won't make tests better (solid, readable) than single threaded. I didn't find the prev review comment about this. With whom should i discuss my point of view?", "author": "findepi", "createdAt": "2020-02-26T09:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM5OTk2Mg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384399962", "bodyText": "I really do not want to start a philosophical discussion now. It is a proper unit test that runs fast so multiple threads will not benefit us even if new tests are added. Let it be your way.", "author": "skrzypo987", "createdAt": "2020-02-26T10:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNzc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyODA0MA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384328040", "bodyText": "Belongs to previous commit", "author": "findepi", "createdAt": "2020-02-26T08:11:02Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -97,19 +123,10 @@ private TransactionManager createTransactionManager()\n         return createTestTransactionManager(catalogManager);\n     }\n \n-    private Procedure getTestProcedure()\n-    {\n-        return new Procedure(\n-                \"test\",\n-                \"foo\",\n-                ImmutableList.of(new Procedure.Argument(\"id\", BigintType.BIGINT)),\n-                methodHandle(TestCallTask.class, \"testingMethod\", Long.class));\n-    }\n-\n     private QueryStateMachine stateMachine(TransactionManager transactionManager, MetadataManager metadata, AccessControl accessControl)\n     {\n         return QueryStateMachine.begin(\n-                \"CALL foo()\",\n+                \"CALL testing_procedure()\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyODE1OQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384328159", "bodyText": "Belongs to previous commit", "author": "findepi", "createdAt": "2020-02-26T08:11:20Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -76,17 +81,38 @@ public void testExecute()\n         assertThat(invocations).contains(1L);\n     }\n \n-    private Call getProcedureInvocation(int id)\n+    @Test\n+    public void testExecuteNoPermission()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new DenyProcedureAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(2);\n+\n+        assertThatThrownBy(\n+                () -> new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of()))\n+                .isInstanceOf(AccessDeniedException.class);\n+\n+        assertThat(invocations).doesNotContain(2L);\n+    }\n+\n+    private Call getProcedureInvocation(long id)\n     {\n-        return new Call(QualifiedName.of(\"foo\"), ImmutableList.of(new CallArgument(new LongLiteral(Integer.toString(id)))));\n+        return new Call(QualifiedName.of(\"testing_procedure\"), ImmutableList.of(new CallArgument(new LongLiteral(Long.toString(id)))));\n     }\n \n     private MetadataManager createMetadataManager(TransactionManager transactionManager)\n     {\n         MetadataManager metadata = createTestMetadataManager(transactionManager, new FeaturesConfig());\n-        Procedure foo = getTestProcedure();\n-        metadata.getProcedureRegistry().addProcedures(new CatalogName(\"test\"), ImmutableList.of(foo));\n-\n+        Procedure procedure = new Procedure(\n+                \"test\",\n+                \"testing_procedure\",\n+                ImmutableList.of(new Procedure.Argument(\"id\", BigintType.BIGINT)),\n+                methodHandle(TestCallTask.class, \"testingMethod\", Long.class));\n+        metadata.getProcedureRegistry().addProcedures(new CatalogName(\"test\"), ImmutableList.of(procedure));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyODIwMw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384328203", "bodyText": "Belongs to previous commit", "author": "findepi", "createdAt": "2020-02-26T08:11:26Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -76,17 +81,38 @@ public void testExecute()\n         assertThat(invocations).contains(1L);\n     }\n \n-    private Call getProcedureInvocation(int id)\n+    @Test\n+    public void testExecuteNoPermission()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new DenyProcedureAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(2);\n+\n+        assertThatThrownBy(\n+                () -> new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of()))\n+                .isInstanceOf(AccessDeniedException.class);\n+\n+        assertThat(invocations).doesNotContain(2L);\n+    }\n+\n+    private Call getProcedureInvocation(long id)\n     {\n-        return new Call(QualifiedName.of(\"foo\"), ImmutableList.of(new CallArgument(new LongLiteral(Integer.toString(id)))));\n+        return new Call(QualifiedName.of(\"testing_procedure\"), ImmutableList.of(new CallArgument(new LongLiteral(Long.toString(id)))));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyODQxMw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384328413", "bodyText": "You can use generic DenyAll since you're going to verify the exception message anyway", "author": "findepi", "createdAt": "2020-02-26T08:11:55Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -135,4 +152,14 @@ public static void testingMethod(Long id)\n     {\n         invocations.add(id);\n     }\n+\n+    private static class DenyProcedureAccessControl", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyODUwNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384328505", "bodyText": "verify message (with equality rather than pattern matching)", "author": "findepi", "createdAt": "2020-02-26T08:12:13Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -76,17 +81,38 @@ public void testExecute()\n         assertThat(invocations).contains(1L);\n     }\n \n-    private Call getProcedureInvocation(int id)\n+    @Test\n+    public void testExecuteNoPermission()\n+    {\n+        TransactionManager transactionManager = createTransactionManager();\n+        MetadataManager metadata = createMetadataManager(transactionManager);\n+\n+        AccessControl accessControl = new DenyProcedureAccessControl();\n+        QueryStateMachine stateMachine = stateMachine(transactionManager, metadata, accessControl);\n+\n+        Call procedure = getProcedureInvocation(2);\n+\n+        assertThatThrownBy(\n+                () -> new CallTask().execute(procedure, transactionManager, metadata, accessControl, stateMachine, ImmutableList.of()))\n+                .isInstanceOf(AccessDeniedException.class);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyOTE1NA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384329154", "bodyText": "// TODO implement and let's do this as a followup", "author": "findepi", "createdAt": "2020-02-26T08:13:38Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedAccessControl.java", "diffHunk": "@@ -317,6 +318,11 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyOTMyMg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384329322", "bodyText": "// TODO implement", "author": "findepi", "createdAt": "2020-02-26T08:14:06Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -520,4 +521,9 @@ public void checkCanRevokeTablePrivilege(SystemSecurityContext context, Privileg\n     public void checkCanShowRoles(SystemSecurityContext context, String catalogName)\n     {\n     }\n+\n+    @Override\n+    public void checkCanExecuteProcedure(SystemSecurityContext systemSecurityContext, CatalogSchemaProcedureName procedure)\n+    {\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyOTU5OQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384329599", "bodyText": "it should deny", "author": "findepi", "createdAt": "2020-02-26T08:14:50Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/ReadOnlyAccessControl.java", "diffHunk": "@@ -194,4 +195,10 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n         // allow\n     }\n+\n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+        // allow", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyOTgzNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384329835", "bodyText": "it should deny; procedures are purely side-effect invocations, so arguably none is read-only operation", "author": "findepi", "createdAt": "2020-02-26T08:15:24Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/ReadOnlySystemAccessControl.java", "diffHunk": "@@ -143,4 +144,9 @@ public void checkCanShowSchemas(SystemSecurityContext context, String catalogNam\n     public void checkCanShowRoles(SystemSecurityContext context, String catalogName)\n     {\n     }\n+\n+    @Override\n+    public void checkCanExecuteProcedure(SystemSecurityContext systemSecurityContext, CatalogSchemaProcedureName procedure)\n+    {\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwMjU1NA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384402554", "bodyText": "`private", "author": "findepi", "createdAt": "2020-02-26T10:27:07Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.Optional;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+@Test(singleThreaded = true)\n+public class TestCallTask\n+{\n+    private static ExecutorService executor;\n+\n+    public static boolean invoked;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwMjk1Ng==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384402956", "bodyText": "Adding missing test for CallTask\n\nIn the commit message i'd remove \"missing\".\nGenerally whenever you add a test it was previously missing.\nAlso, change Adding -> Add (per our guidelines https://chris.beams.io/posts/git-commit/)", "author": "findepi", "createdAt": "2020-02-26T10:27:49Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestCallTask.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.CatalogManager;\n+import io.prestosql.metadata.MetadataManager;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.security.AllowAllAccessControl;\n+import io.prestosql.spi.procedure.Procedure;\n+import io.prestosql.spi.resourcegroups.ResourceGroupId;\n+import io.prestosql.sql.analyzer.FeaturesConfig;\n+import io.prestosql.sql.tree.Call;\n+import io.prestosql.sql.tree.QualifiedName;\n+import io.prestosql.transaction.TransactionManager;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.Optional;\n+import java.util.concurrent.ExecutorService;\n+\n+import static io.airlift.concurrent.Threads.daemonThreadsNamed;\n+import static io.prestosql.metadata.MetadataManager.createTestMetadataManager;\n+import static io.prestosql.spi.block.MethodHandleUtil.methodHandle;\n+import static io.prestosql.testing.TestingSession.createBogusTestingCatalog;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static io.prestosql.transaction.InMemoryTransactionManager.createTestTransactionManager;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.assertj.core.api.Assertions.assertThat;\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwNjIzOQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384406239", "bodyText": "make this // TODO implement as well", "author": "findepi", "createdAt": "2020-02-26T10:33:38Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/security/LegacyAccessControl.java", "diffHunk": "@@ -269,6 +270,11 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTg2Mg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384849862", "bodyText": "Use format to be consistent with the others", "author": "electrum", "createdAt": "2020-02-27T00:32:37Z", "path": "presto-spi/src/main/java/io/prestosql/spi/security/AccessDeniedException.java", "diffHunk": "@@ -396,6 +396,11 @@ public static void denySetRole(String role)\n         throw new AccessDeniedException(format(\"Cannot set role %s\", role));\n     }\n \n+    public static void denyExecuteProcedure(String procedureName)\n+    {\n+        throw new AccessDeniedException(\"Cannot invoke procedure \" + procedureName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzMjkwMg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r386132902", "bodyText": "Maybe others should be fixed instead? Because: https://github.com/prestosql/presto#code-style\n\nConsider using String formatting ... Sometimes, if you only need to append something, consider using the + operator.", "author": "kokosing", "createdAt": "2020-03-01T19:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzNjU3Nw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r386136577", "bodyText": "@dain wants all of these to use format", "author": "electrum", "createdAt": "2020-03-01T20:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNDk5MA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r386304990", "bodyText": "Maybe we should have a wiki page about Code Style? README section is too small to cover everything.\nIf you agree, I can start one.", "author": "findepi", "createdAt": "2020-03-02T10:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwOTg4OA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r386309888", "bodyText": "I completely agree. Discussions about code style belong there, not in code-review.\nAlthough that specific example is quite clear for me. You can use both format or + in simple cases. This may be a simple case but format has been there already so it is the right choice here.", "author": "skrzypo987", "createdAt": "2020-03-02T10:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDA3Mg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384850072", "bodyText": "Remove this. I'm not sure it makes sense to implement this generically.", "author": "electrum", "createdAt": "2020-02-27T00:33:18Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedAccessControl.java", "diffHunk": "@@ -318,6 +319,12 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+        //TODO implement", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NDA1OA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r385364058", "bodyText": "i asked for this & asked for a follow-up too", "author": "findepi", "createdAt": "2020-02-27T20:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MjgzNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384852835", "bodyText": "We should probably call this CatalogSchemaObjectName so that it's more generic. That way we can reuse it for functions. Same with SchemaObjectName.", "author": "electrum", "createdAt": "2020-02-27T00:42:54Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/CatalogSchemaProcedureName.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.connector;\n+\n+import java.util.Objects;\n+\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public final class CatalogSchemaProcedureName", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1Njc5Nw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384856797", "bodyText": "Actually, I'm not sure if there are any other schema-scoped objects that would matter, so perhaps naming this CatalogSchemaRoutineName would suffice.", "author": "electrum", "createdAt": "2020-02-27T00:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MjgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0Njk5OQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384846999", "bodyText": "The todo isn't needed. The LegacyAccessControl is designed to be backwards compatible with the original Presto Hive security system, and therefore we should I don't think we should be implementing this here.", "author": "dain", "createdAt": "2020-02-27T00:23:27Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/security/LegacyAccessControl.java", "diffHunk": "@@ -269,6 +270,12 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+        //TODO implement", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NDYwNQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r385364605", "bodyText": "From backwards compaitbility perspective... procedures didn't really exist until recently. We opened some problem by adding them and we should somehow fix it.", "author": "findepi", "createdAt": "2020-02-27T20:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0Njk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NzU5Mw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r385457593", "bodyText": "I disagree.  The legacy security system should be removed.  I believe the first step it to change the default from legacy to something else... likely sql standard.", "author": "dain", "createdAt": "2020-02-28T01:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0Njk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTM1NA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384849354", "bodyText": "I don't think this is right.  This would limit important table maintenance to only admins, and instead it should really be based on the procedure and the permissions the user has.  For example, I would expect anyone with DELETE permissions on a table to be able to execute unregister_partition.", "author": "dain", "createdAt": "2020-02-27T00:30:53Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/security/SqlStandardAccessControl.java", "diffHunk": "@@ -390,6 +392,14 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+        if (!isAdmin(context)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1Nzg3Ng==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384857876", "bodyText": "I think we need to allow the procedure itself to perform access control checks based on the object the action is performed on, since procedures are effectively connector-defined operations. We can do this by allowing the procedure to accept ConnectorAccessControl and ConnectorSecurityContext (just like ConnectorSession). The access control implementation would be a facade over the global access control (and thus would delegate to any system or connector access control applicable to the procedure's catalog).", "author": "electrum", "createdAt": "2020-02-27T00:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMzYxMg==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384933612", "bodyText": "I agree. Also we would need to check usage of external_location when. Hive connector is configured in a way it disallows to use that property.", "author": "kokosing", "createdAt": "2020-02-27T06:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwODY2MQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r385908661", "bodyText": "For example, I would expect anyone with DELETE permissions on a table to be able to execute unregister_partition.\n\nThat could work. What checks should the register_partition procedure do?", "author": "findepi", "createdAt": "2020-02-28T20:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDQ4NQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r384850485", "bodyText": "Instead please create an issue if you think this should be implemented, or just implement it.", "author": "dain", "createdAt": "2020-02-27T00:34:41Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedAccessControl.java", "diffHunk": "@@ -318,6 +319,12 @@ public void checkCanShowRoleGrants(ConnectorSecurityContext context, String cata\n     {\n     }\n \n+    @Override\n+    public void checkCanExecuteProcedure(ConnectorSecurityContext context, SchemaProcedureName procedure)\n+    {\n+        //TODO implement", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NTAyMw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r385365023", "bodyText": "i asked for this & asked for a follow-up too", "author": "findepi", "createdAt": "2020-02-27T20:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDQ4NQ=="}], "type": "inlineReview"}, {"oid": "2e6e7fc3b1d6dbb7d6ea3f09e62ef522385f2f6f", "url": "https://github.com/trinodb/trino/commit/2e6e7fc3b1d6dbb7d6ea3f09e62ef522385f2f6f", "message": "Add test for CallTask", "committedDate": "2020-03-04T12:45:09Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MzgzNw==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r388173837", "bodyText": "I don't think lowercasing is appropriate here.\nThis follows  SchemaTableName, but that is about to change\nSee https://github.com/prestosql/presto/pull/2350/files#diff-d86eb3d71bf172e6ebc672efd6346d4c\nLet's get this right from the start.", "author": "findepi", "createdAt": "2020-03-05T09:33:54Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/SchemaRoutineName.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.connector;\n+\n+import java.util.Objects;\n+\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public final class SchemaRoutineName\n+{\n+    private final String schemaName;\n+    private final String routineName;\n+\n+    public SchemaRoutineName(String schemaName, String routineName)\n+    {\n+        this.schemaName = requireNonNull(schemaName, \"schemaName is null\").toLowerCase(ENGLISH);\n+        this.routineName = requireNonNull(routineName, \"routineName is null\").toLowerCase(ENGLISH);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2OTM1OQ==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r388269359", "bodyText": "done", "author": "skrzypo987", "createdAt": "2020-03-05T12:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MzgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA3MjEwMA==", "url": "https://github.com/trinodb/trino/pull/2924#discussion_r389072100", "bodyText": "This change is wrong. We do resolution using lowercase name, but pass mixed case into the access check. So the user can bypass the check by using a mixed case name.", "author": "electrum", "createdAt": "2020-03-06T18:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MzgzNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "778751b5c79a387bcf1452222cbbb78f2817069d", "url": "https://github.com/trinodb/trino/commit/778751b5c79a387bcf1452222cbbb78f2817069d", "message": "Add access control check for Procedures\n\nBoth for system-level and connector-level access control", "committedDate": "2020-03-06T06:49:21Z", "type": "commit"}, {"oid": "778751b5c79a387bcf1452222cbbb78f2817069d", "url": "https://github.com/trinodb/trino/commit/778751b5c79a387bcf1452222cbbb78f2817069d", "message": "Add access control check for Procedures\n\nBoth for system-level and connector-level access control", "committedDate": "2020-03-06T06:49:21Z", "type": "forcePushed"}]}