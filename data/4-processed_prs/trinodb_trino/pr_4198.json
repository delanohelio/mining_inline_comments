{"pr_number": 4198, "pr_title": "Test missing nested array in Parquet files", "pr_createdAt": "2020-06-24T16:55:50Z", "pr_url": "https://github.com/trinodb/trino/pull/4198", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4NTA5Ng==", "url": "https://github.com/trinodb/trino/pull/4198#discussion_r445585096", "bodyText": "can we verify the behavior with sessionUsingColumnName as well?\nalso, as this is a regression test, worth recording original NPE failure (can be directly in the commit message)", "author": "findepi", "createdAt": "2020-06-25T14:06:26Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4376,6 +4376,40 @@ public void testParquetWithMissingColumns()\n         assertUpdate(sessionUsingColumnIndex, \"DROP TABLE \" + multiColumnTableName);\n     }\n \n+    @Test\n+    public void testParquetWithMissingNestedColumns()\n+    {\n+        Session sessionUsingColumnIndex = Session.builder(getSession())\n+                .setCatalogSessionProperty(catalog, \"parquet_use_column_names\", \"true\")\n+                .build();\n+\n+        String missingNestedFieldsTableName = \"test_parquet_missing_nested_fields\";\n+\n+        assertUpdate(format(\n+                \"CREATE TABLE %s(\" +\n+                        \"  a ARRAY(ROW(a2 int))) \" +\n+                        \"WITH (format='PARQUET')\",\n+                missingNestedFieldsTableName));\n+        assertUpdate(sessionUsingColumnIndex, \"INSERT INTO \" + missingNestedFieldsTableName + \" VALUES (ARRAY[ROW(2)])\", 1);\n+\n+        String tableLocation = (String) computeActual(\"SELECT DISTINCT regexp_replace(\\\"$path\\\", '/[^/]*$', '') FROM \" + missingNestedFieldsTableName).getOnlyValue();\n+        String missingNestedArrayTableName = \"test_parquet_missing_nested_array\";\n+        assertUpdate(sessionUsingColumnIndex, format(\n+                \"CREATE TABLE %s(\" +\n+                        \"  a ARRAY(ROW(a1 ARRAY(varchar), a2 int))) \" +\n+                        \"WITH (format='PARQUET', external_location='%s')\",\n+                missingNestedArrayTableName,\n+                tableLocation));\n+\n+        assertQuery(\n+                sessionUsingColumnIndex,\n+                \"SELECT a[1].a1 FROM \" + missingNestedArrayTableName,\n+                \"VALUES (null)\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2MjI0OA==", "url": "https://github.com/trinodb/trino/pull/4198#discussion_r449462248", "bodyText": "(sorry for the latency)\nThis update address both points", "author": "rclaude", "createdAt": "2020-07-03T08:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4NTA5Ng=="}], "type": "inlineReview"}, {"oid": "aaac947330fbed894aa02ade28189c9a5e29a682", "url": "https://github.com/trinodb/trino/commit/aaac947330fbed894aa02ade28189c9a5e29a682", "message": "Test missing nested array in Parquet files\n\nNested array and map present in the metastore schema but missing in the parquet footer used to throw NPEs when the ParquetReader was getting the missing nested fields infos.\nThis got fixed by 6e272ed5f865e50dc8b1675c191fe67f49b09dfe which enrich the schema read from the parquet footer.\nThis test is there to ensure no regression is introduced by future changes in the ParquetPageSourceFactory.", "committedDate": "2020-07-03T08:29:39Z", "type": "commit"}, {"oid": "aaac947330fbed894aa02ade28189c9a5e29a682", "url": "https://github.com/trinodb/trino/commit/aaac947330fbed894aa02ade28189c9a5e29a682", "message": "Test missing nested array in Parquet files\n\nNested array and map present in the metastore schema but missing in the parquet footer used to throw NPEs when the ParquetReader was getting the missing nested fields infos.\nThis got fixed by 6e272ed5f865e50dc8b1675c191fe67f49b09dfe which enrich the schema read from the parquet footer.\nThis test is there to ensure no regression is introduced by future changes in the ParquetPageSourceFactory.", "committedDate": "2020-07-03T08:29:39Z", "type": "forcePushed"}]}