{"pr_number": 3836, "pr_title": "Fix flaky TestRubixCaching tests", "pr_createdAt": "2020-05-23T21:06:27Z", "pr_url": "https://github.com/trinodb/trino/pull/3836", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3ODgyOQ==", "url": "https://github.com/trinodb/trino/pull/3836#discussion_r429578829", "bodyText": "Maybe catch the NPE for now?", "author": "dain", "createdAt": "2020-05-23T21:13:56Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixInitializer.java", "diffHunk": "@@ -125,7 +125,10 @@ public void stopRubix()\n     {\n         try (Closer closer = Closer.create()) {\n             closer.register(() -> {\n-                if (bookKeeperServer != null && bookKeeperServer.isServerUp()) {\n+                if (bookKeeperServer != null) {\n+                    // This might throw NPE if Thrift server hasn't started yet (it's initialized\n+                    // asynchronously from BookKeeperServer thread).\n+                    // TODO: improve stopping of BookKeeperServer server in Rubix", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY2ODIxNw==", "url": "https://github.com/trinodb/trino/pull/3836#discussion_r429668217", "bodyText": "Maybe catch the NPE for now?\n\nIn production this shouldn't happen as bookKeeperServer will initialize thrift server almost immediately. Shutdown of Connector also doesn't terminate Presto.\nIn tests this NPE is used to retry stopRubix, otherwise ports would leak.", "author": "sopel39", "createdAt": "2020-05-24T19:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3ODgyOQ=="}], "type": "inlineReview"}, {"oid": "a0cbd71d87496e4cc3a2a50cb0a9e7023a802d47", "url": "https://github.com/trinodb/trino/commit/a0cbd71d87496e4cc3a2a50cb0a9e7023a802d47", "message": "Always close BookKeeperServer after it was started\n\nPreviously BookKeeperServer#isServerUp was\ncalled to check if server is running before closing it.\nHowever, internally BookKeeperServer is started\nasynchronously so isServerUp might return false\nwhich would lead to a resource leak.", "committedDate": "2020-05-24T19:39:56Z", "type": "commit"}, {"oid": "0d1b92d00fdce2262491efd9c215d6f6a604d979", "url": "https://github.com/trinodb/trino/commit/0d1b92d00fdce2262491efd9c215d6f6a604d979", "message": "Retry stopping of Rubix server in tests\n\nIn case of a quick test (e.g write test) it could\nhappen that Rubix BookKeeper hasn't managed to start yet\nbefre it's being stopped. Because of a race condition\nwihin Rubix, stopping BookKeeper in such case could lead to\nNPE. Therefore stopping needs to be retried in order to make\nsure Rubix BookKeeper is really closed.", "committedDate": "2020-05-24T19:39:56Z", "type": "commit"}, {"oid": "0d1b92d00fdce2262491efd9c215d6f6a604d979", "url": "https://github.com/trinodb/trino/commit/0d1b92d00fdce2262491efd9c215d6f6a604d979", "message": "Retry stopping of Rubix server in tests\n\nIn case of a quick test (e.g write test) it could\nhappen that Rubix BookKeeper hasn't managed to start yet\nbefre it's being stopped. Because of a race condition\nwihin Rubix, stopping BookKeeper in such case could lead to\nNPE. Therefore stopping needs to be retried in order to make\nsure Rubix BookKeeper is really closed.", "committedDate": "2020-05-24T19:39:56Z", "type": "forcePushed"}]}