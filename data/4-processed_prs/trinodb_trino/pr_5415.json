{"pr_number": 5415, "pr_title": "Do not stop attached environment", "pr_createdAt": "2020-10-05T12:21:49Z", "pr_url": "https://github.com/trinodb/trino/pull/5415", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2NzYwMw==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499567603", "bodyText": "does it relly solve Could not attach tests to unhealthy environment xxxxxxx???\nnothing was stopped at my machine, containers were still working as expected, the problem was somewhere in allCOntainersHealthy probably", "author": "iirekm", "createdAt": "2020-10-05T12:40:49Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -150,6 +157,11 @@ private Environment tryStart()\n \n     public void stop()\n     {\n+        if (attached) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2OTU4MA==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499569580", "bodyText": "I removed that in eed10ac", "author": "kokosing", "createdAt": "2020-10-05T12:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2NzYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0NzU4Nw==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499647587", "bodyText": "unrelated", "author": "findepi", "createdAt": "2020-10-05T14:37:24Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -383,10 +395,10 @@ private static void setContainerAutoRemove(CreateContainerCmd createContainerCmd\n         private static List<Ulimit> standardUlimits()\n         {\n             return ImmutableList.of(\n-                // Number of open file descriptors\n-                new Ulimit(\"nofile\", 65535L, 65535L),\n-                // Number of processes\n-                new Ulimit(\"nproc\", 8096L, 8096L));\n+                    // Number of open file descriptors\n+                    new Ulimit(\"nofile\", 65535L, 65535L),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODk3Ng==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499648976", "bodyText": "The fact that stop does not stop is not intuitive.\nperhaps, make it throw illegal state and update  test attach not to call stop, if there is nothing to stop.\nor, just change the test attach flow and then no changes needed in Env clas\nalso, can the test container leak in test attach mode?\n(i hope it's controller by ryuk and \"safe to leak\")", "author": "findepi", "createdAt": "2020-10-05T14:39:16Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -150,6 +157,11 @@ private Environment tryStart()\n \n     public void stop()\n     {\n+        if (attached) {\n+            // do not stop attached, externally controlled environment", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc4Nzk0MA==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499787940", "bodyText": "The fact that stop does not stop is not intuitive.\n\nFact. I will move this if to close method and throw in  stop\n\nalso, can the test container leak in test attach mode?\n\nI tested it and it was cleared. I will test it more with interruptions.", "author": "kokosing", "createdAt": "2020-10-05T18:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0MDUyNA==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499840524", "bodyText": "I tested it and it was cleared. I will test it more with interruptions.\n\nIt works as expected.", "author": "kokosing", "createdAt": "2020-10-05T20:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODk3Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNzU5OQ==", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499817599", "bodyText": "can you add .setAttached() method to Builder instead?", "author": "wendigo", "createdAt": "2020-10-05T19:19:01Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/EnvironmentUp.java", "diffHunk": "@@ -144,7 +144,7 @@ public Integer call()\n                 builder.configureContainers(Standard::enablePrestoJavaDebugger);\n             }\n \n-            Environment environment = builder.build(getStandardListeners(environmentLogPath));\n+            Environment environment = builder.build(getStandardListeners(environmentLogPath), false);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98b371350a4a4a28ab4916f9b85389398b1fb624", "url": "https://github.com/trinodb/trino/commit/98b371350a4a4a28ab4916f9b85389398b1fb624", "message": "Fix indentation", "committedDate": "2020-10-05T20:27:40Z", "type": "commit"}, {"oid": "62518aa56ccfb04e3cf627df0b1a9d9f2a7b81ea", "url": "https://github.com/trinodb/trino/commit/62518aa56ccfb04e3cf627df0b1a9d9f2a7b81ea", "message": "Do not stop attached environment\n\nEnvironment to which `test run` is attaching is controlled by separate\nprocess and so it should be stopped by that process.\nThanks to this environment can be reused multiple times.", "committedDate": "2020-10-05T20:27:41Z", "type": "commit"}, {"oid": "e36bf343fd321d24e572338b37e85611d1c8264e", "url": "https://github.com/trinodb/trino/commit/e36bf343fd321d24e572338b37e85611d1c8264e", "message": "Do not check attached containers health\n\nHealth of these containers is checked by the origin process that\ncontrols them.", "committedDate": "2020-10-05T20:27:43Z", "type": "commit"}, {"oid": "e36bf343fd321d24e572338b37e85611d1c8264e", "url": "https://github.com/trinodb/trino/commit/e36bf343fd321d24e572338b37e85611d1c8264e", "message": "Do not check attached containers health\n\nHealth of these containers is checked by the origin process that\ncontrols them.", "committedDate": "2020-10-05T20:27:43Z", "type": "forcePushed"}]}