{"pr_number": 3428, "pr_title": "Add ping endpoint handler", "pr_createdAt": "2020-04-14T12:03:08Z", "pr_url": "https://github.com/trinodb/trino/pull/3428", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408106753", "bodyText": "Curious - is that possible that HeartbeatFailureDetector pings some already existing, known url? Instead of adding a fake one?", "author": "losipiuk", "createdAt": "2020-04-14T12:45:32Z", "path": "presto-main/src/main/java/io/prestosql/server/PingResource.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server;\n+\n+import javax.ws.rs.HEAD;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Response;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+\n+@Path(\"/\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNTc0MA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408115740", "bodyText": "I did some digging but there wasn't a clear better endpoint to ping. The goal was to keep the endpoint as cheap as possible for both the client and server, hoping it could also be used to serve other \"liveness check\" purposes.\nDo you have an alternative endpoint in mind?", "author": "pettyjamesm", "createdAt": "2020-04-14T12:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyODk2NA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408128964", "bodyText": "No. Not really. Just using \"/\" seems kinda weird. Maybe we should add a specific endpoint \"/ping\" for pinging purposes?\nOr am I reading it wrong and it already serves on \"/ping\" and the path is derived from method name?", "author": "losipiuk", "createdAt": "2020-04-14T13:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEzOTEwMA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408139100", "bodyText": "You would be correct that this is the root path (eg: http://localhost:8080/) since that's currently where the hearbeat pings are directed. I'm not 100% confident in how the service discovery system wires things together so I wasn't sure how to go about changing the endpoint used there is registered and instead put this handler on the path currently used. Would it be as easy as making this @Path(\"/ping\") and putting a hard-coded \"/ping\" suffix here?", "author": "pettyjamesm", "createdAt": "2020-04-14T13:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1ODI3OQ==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408158279", "bodyText": "Don't know neither. @electrum?", "author": "losipiuk", "createdAt": "2020-04-14T13:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NTcxOA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408265718", "bodyText": "The server does a redirect to /ui when you hit /. Not sure why you're seeing 404. Regardless, binding a resource to / is problematic because that url is handled by some other part of Presto, and HEAD should be consistent with GET (minus the response body).", "author": "martint", "createdAt": "2020-04-14T16:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NzE0Ng==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408267146", "bodyText": "Only the coordinator has that redirect installed, workers return 404. I'm fine with moving the route to /ping if that's where you think it should go. The question then becomes whether / how to relate the ping endpoint through ServiceDescriptor since this is really a per-node endpoint.", "author": "pettyjamesm", "createdAt": "2020-04-14T16:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4NTMyMw==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408285323", "bodyText": "Ah, I guess that broke with the recent UI changes.\nThe URI in the service descriptor is published automatically via:\n        discoveryBinder(binder).bindHttpAnnouncement(\"presto\")\n                .addProperty(\"node_version\", nodeVersion.toString())\n                .addProperty(\"coordinator\", String.valueOf(serverConfig.isCoordinator()));\n\nIf we wanted to have a separate URI for ping, we'd need to either:\n\nadd a property to the announcement to indicate what's the (relative) URI for that endpoint\nhard-code the URI in the failure detector\n\nBoth have pros and cons -- let me think about this a little more.", "author": "martint", "createdAt": "2020-04-14T16:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5MjI3Nw==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408292277", "bodyText": "I think it\u2019s reasonable to add a well known /ping endpoint that\u2019s guaranteed to exist on the coordinator and workers and is accessible without authentication. This is useful for external monitoring, load balancers, etc.", "author": "electrum", "createdAt": "2020-04-14T16:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMyMTAzNA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408321034", "bodyText": "We already have such an endpoint. It's called /v1/status", "author": "martint", "createdAt": "2020-04-14T17:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzNTA4NQ==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408335085", "bodyText": "That's a little bit heavy for constant background pinging though, right? We could, I suppose, move this into the StatusResource and handle HEAD requests specifically. Would that work with everyone?", "author": "pettyjamesm", "createdAt": "2020-04-14T18:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0ODQ4MA==", "url": "https://github.com/trinodb/trino/pull/3428#discussion_r408348480", "bodyText": "What it does is actually pretty cheap. The failure detector calls it every half a second anyway, so the impact is minimal. However, adding handling for HEAD in StatusResource is a good idea.", "author": "martint", "createdAt": "2020-04-14T18:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjc1Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "789c024297a7148f302e729e0f6584eddc9c1afe", "url": "https://github.com/trinodb/trino/commit/789c024297a7148f302e729e0f6584eddc9c1afe", "message": "Add status endpoint for HTTP HEAD requests\n\nPreviously, node pings in HeartbeatFailureDetector would go to the\nroot path and return 404 from workers because no endpoint was mapped\nto handle them. Now the failure detector points to /v1/status\nand receives empty HTTP OK responses instead.", "committedDate": "2020-04-16T20:58:38Z", "type": "commit"}, {"oid": "789c024297a7148f302e729e0f6584eddc9c1afe", "url": "https://github.com/trinodb/trino/commit/789c024297a7148f302e729e0f6584eddc9c1afe", "message": "Add status endpoint for HTTP HEAD requests\n\nPreviously, node pings in HeartbeatFailureDetector would go to the\nroot path and return 404 from workers because no endpoint was mapped\nto handle them. Now the failure detector points to /v1/status\nand receives empty HTTP OK responses instead.", "committedDate": "2020-04-16T20:58:38Z", "type": "forcePushed"}]}