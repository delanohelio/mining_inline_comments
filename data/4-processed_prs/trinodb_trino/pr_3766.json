{"pr_number": 3766, "pr_title": "Adding schema access rules to FileBasedSystemAccessControl", "pr_createdAt": "2020-05-17T04:37:09Z", "pr_url": "https://github.com/trinodb/trino/pull/3766", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExODM3Nw==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r427118377", "bodyText": "if (schemaRules.isEmpty()) { return true; }\nThen you don't need to have schemaRules.isPresent() &&  in all the cases above.", "author": "kokosing", "createdAt": "2020-05-19T08:23:19Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -334,6 +338,22 @@ public void checkCanDropSchema(SystemSecurityContext context, CatalogSchemaName\n         if (!canAccessCatalog(context.getIdentity(), schema.getCatalogName(), ALL)) {\n             denyDropSchema(schema.toString());\n         }\n+\n+        if (schemaRules.isPresent() && !isSchemaOwner(context, schema.getSchemaName())) {\n+            denyDropSchema(schema.getSchemaName());\n+        }\n+    }\n+\n+    private boolean isSchemaOwner(SystemSecurityContext context, String schemaName)\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNDMzNQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428414335", "bodyText": "@kokosing - I have made the changes and pushed", "author": "haldes", "createdAt": "2020-05-21T02:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExODM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExOTcyOA==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r427119728", "bodyText": "I think we need a better way to injecting rules to tests. It would be nice to define them next to the test as java object, then do serialization round trip, and the do the test. Maybe this should go as a refactor before this commit or after.\nThen instead of giant test with many cases we could have plenty of smaller test per case.", "author": "kokosing", "createdAt": "2020-05-19T08:25:22Z", "path": "presto-plugin-toolkit/src/test/resources/file-based-system-access-schema.json", "diffHunk": "@@ -0,0 +1,33 @@\n+{", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNDc5NQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428414795", "bodyText": "@kokosing - I get your point. Think we can do it after this commit. Will create a followup ticket to track it.", "author": "haldes", "createdAt": "2020-05-21T02:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExOTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMDgxNg==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r427120816", "bodyText": "it it to the very bottom of this file.\nAlso can you please introduce this method in the commit before and use it for other tests as well?", "author": "kokosing", "createdAt": "2020-05-19T08:27:00Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -53,13 +54,82 @@\n     private static final Identity validSpecialRegexWildDot = Identity.forUser(\".*\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n     private static final Identity validSpecialRegexEndQuote = Identity.forUser(\"\\\\E\").withPrincipal(new KerberosPrincipal(\"special/\\\\E@EXAMPLE.COM\")).build();\n     private static final Identity invalidSpecialRegex = Identity.forUser(\"alice\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n-    private static final Identity bob = Identity.ofUser(\"bob\");\n-    private static final Identity admin = Identity.ofUser(\"admin\");\n+    private static final Identity bob = Identity.forUser(\"bob\").withGroups(ImmutableSet.of(\"staff\")).build();\n+    private static final Identity admin = Identity.forUser(\"admin\").withGroups(ImmutableSet.of(\"admin\", \"staff\")).build();\n     private static final Identity nonAsciiUser = Identity.ofUser(\"\\u0194\\u0194\\u0194\");\n     private static final Set<String> allCatalogs = ImmutableSet.of(\"secret\", \"open-to-all\", \"all-allowed\", \"alice-catalog\", \"allowed-absent\", \"\\u0200\\u0200\\u0200\");\n     private static final CatalogSchemaTableName aliceView = new CatalogSchemaTableName(\"alice-catalog\", \"schema\", \"view\");\n     private static final Optional<QueryId> queryId = Optional.empty();\n \n+    private static final Identity charlie = Identity.forUser(\"charlie\").withGroups(ImmutableSet.of(\"guests\")).build();\n+    private static final Identity joe = Identity.ofUser(\"joe\");\n+    private static final SystemSecurityContext ADMIN = new SystemSecurityContext(admin, queryId);\n+    private static final SystemSecurityContext BOB = new SystemSecurityContext(bob, queryId);\n+    private static final SystemSecurityContext CHARLIE = new SystemSecurityContext(charlie, queryId);\n+\n+    @Test\n+    public void testSchemaRules()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-schema.json\");\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"));\n+\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+\n+        accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\")));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\")));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), \"new_schema\");\n+\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"staff\");\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"authenticated\");\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"bob\");\n+        assertDenied(() -> accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), \"bob\"));\n+        assertDenied(() -> accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"test\"));\n+\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"new_schema\"));\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"new_schema\"));\n+        accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"authenticated\");\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\"), \"new_schema\"));\n+\n+        accessControl.checkCanSetSchemaAuthorization(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\"));\n+        accessControl.checkCanSetSchemaAuthorization(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\"));\n+        accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\"));\n+        accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\"));\n+        assertDenied(() -> accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\")));\n+        assertDenied(() -> accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\")));\n+\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"));\n+\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+\n+        accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\")));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\")));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+    }\n+\n+    private static void assertDenied(ThrowingRunnable runnable)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNDM2NA==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428414364", "bodyText": "@kokosing - I have made the changes and pushed", "author": "haldes", "createdAt": "2020-05-21T02:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMDgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMjE2OQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r427122169", "bodyText": "Please define one test per each schema related access control method. One for checkCanDropSchema, one for checkCanRenameSchema etc...", "author": "kokosing", "createdAt": "2020-05-19T08:29:05Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -53,13 +54,82 @@\n     private static final Identity validSpecialRegexWildDot = Identity.forUser(\".*\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n     private static final Identity validSpecialRegexEndQuote = Identity.forUser(\"\\\\E\").withPrincipal(new KerberosPrincipal(\"special/\\\\E@EXAMPLE.COM\")).build();\n     private static final Identity invalidSpecialRegex = Identity.forUser(\"alice\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n-    private static final Identity bob = Identity.ofUser(\"bob\");\n-    private static final Identity admin = Identity.ofUser(\"admin\");\n+    private static final Identity bob = Identity.forUser(\"bob\").withGroups(ImmutableSet.of(\"staff\")).build();\n+    private static final Identity admin = Identity.forUser(\"admin\").withGroups(ImmutableSet.of(\"admin\", \"staff\")).build();\n     private static final Identity nonAsciiUser = Identity.ofUser(\"\\u0194\\u0194\\u0194\");\n     private static final Set<String> allCatalogs = ImmutableSet.of(\"secret\", \"open-to-all\", \"all-allowed\", \"alice-catalog\", \"allowed-absent\", \"\\u0200\\u0200\\u0200\");\n     private static final CatalogSchemaTableName aliceView = new CatalogSchemaTableName(\"alice-catalog\", \"schema\", \"view\");\n     private static final Optional<QueryId> queryId = Optional.empty();\n \n+    private static final Identity charlie = Identity.forUser(\"charlie\").withGroups(ImmutableSet.of(\"guests\")).build();\n+    private static final Identity joe = Identity.ofUser(\"joe\");\n+    private static final SystemSecurityContext ADMIN = new SystemSecurityContext(admin, queryId);\n+    private static final SystemSecurityContext BOB = new SystemSecurityContext(bob, queryId);\n+    private static final SystemSecurityContext CHARLIE = new SystemSecurityContext(charlie, queryId);\n+\n+    @Test\n+    public void testSchemaRules()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNDM5OQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428414399", "bodyText": "@kokosing - I have made the changes and pushed", "author": "haldes", "createdAt": "2020-05-21T02:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMjE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjI4Mg==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428436282", "bodyText": "please move this method somewhere to the bottom of this class. Favor public interface first and also order methods by usage.", "author": "kokosing", "createdAt": "2020-05-21T04:18:08Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -334,6 +338,26 @@ public void checkCanDropSchema(SystemSecurityContext context, CatalogSchemaName\n         if (!canAccessCatalog(context.getIdentity(), schema.getCatalogName(), ALL)) {\n             denyDropSchema(schema.toString());\n         }\n+\n+        if (!isSchemaOwner(context, schema.getSchemaName())) {\n+            denyDropSchema(schema.getSchemaName());\n+        }\n+    }\n+\n+    private boolean isSchemaOwner(SystemSecurityContext context, String schemaName)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjUzOQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428436539", "bodyText": "can you use assertj. assertThatThrownBy() and assert error message here?", "author": "kokosing", "createdAt": "2020-05-21T04:19:46Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -268,4 +314,14 @@ private String getResourcePath(String resourceName)\n     {\n         return this.getClass().getClassLoader().getResource(resourceName).getPath();\n     }\n+\n+    private static void assertDenied(ThrowingRunnable runnable)\n+    {\n+        assertThrows(AccessDeniedException.class, runnable);\n+    }\n+\n+    private static void assertDeniedWithIllegalArgumentException(ThrowingRunnable runnable)\n+    {\n+        assertThrows(IllegalArgumentException.class, runnable);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMTI5MA==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428501290", "bodyText": "@kokosing - This is done", "author": "haldes", "createdAt": "2020-05-21T07:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjY2NQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428436665", "bodyText": "can you use assertj assertThatThrownBy()? Please also verify error message (it is quite important to know that the proper exception was raised).", "author": "kokosing", "createdAt": "2020-05-21T04:20:26Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -268,4 +314,14 @@ private String getResourcePath(String resourceName)\n     {\n         return this.getClass().getClassLoader().getResource(resourceName).getPath();\n     }\n+\n+    private static void assertDenied(ThrowingRunnable runnable)\n+    {\n+        assertThrows(AccessDeniedException.class, runnable);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTM4OQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428495389", "bodyText": "@kokosing - This is done", "author": "haldes", "createdAt": "2020-05-21T07:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNjY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNzIzOA==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428437238", "bodyText": "Please extract such refactorings as separate preparatory commit. It has nothing to do with actual change of adding schema rules to file based access control.", "author": "kokosing", "createdAt": "2020-05-21T04:22:59Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -53,50 +54,110 @@\n     private static final Identity validSpecialRegexWildDot = Identity.forUser(\".*\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n     private static final Identity validSpecialRegexEndQuote = Identity.forUser(\"\\\\E\").withPrincipal(new KerberosPrincipal(\"special/\\\\E@EXAMPLE.COM\")).build();\n     private static final Identity invalidSpecialRegex = Identity.forUser(\"alice\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n-    private static final Identity bob = Identity.ofUser(\"bob\");\n-    private static final Identity admin = Identity.ofUser(\"admin\");\n+    private static final Identity bob = Identity.forUser(\"bob\").withGroups(ImmutableSet.of(\"staff\")).build();\n+    private static final Identity admin = Identity.forUser(\"admin\").withGroups(ImmutableSet.of(\"admin\", \"staff\")).build();\n     private static final Identity nonAsciiUser = Identity.ofUser(\"\\u0194\\u0194\\u0194\");\n     private static final Set<String> allCatalogs = ImmutableSet.of(\"secret\", \"open-to-all\", \"all-allowed\", \"alice-catalog\", \"allowed-absent\", \"\\u0200\\u0200\\u0200\");\n     private static final CatalogSchemaTableName aliceView = new CatalogSchemaTableName(\"alice-catalog\", \"schema\", \"view\");\n     private static final Optional<QueryId> queryId = Optional.empty();\n \n+    private static final Identity charlie = Identity.forUser(\"charlie\").withGroups(ImmutableSet.of(\"guests\")).build();\n+    private static final Identity joe = Identity.ofUser(\"joe\");\n+    private static final SystemSecurityContext ADMIN = new SystemSecurityContext(admin, queryId);\n+    private static final SystemSecurityContext BOB = new SystemSecurityContext(bob, queryId);\n+    private static final SystemSecurityContext CHARLIE = new SystemSecurityContext(charlie, queryId);\n+\n+    @Test\n+    public void testSchemaRulesForCheckCanDropSchema()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-schema.json\");\n+\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        accessControl.checkCanDropSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"));\n+\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanDropSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+\n+        accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\")));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\")));\n+        assertDenied(() -> accessControl.checkCanDropSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+    }\n+\n+    @Test\n+    public void testSchemaRulesForCheckCanRenameSchema()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-schema.json\");\n+\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"new_schema\");\n+        accessControl.checkCanRenameSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), \"new_schema\");\n+\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"staff\");\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"authenticated\");\n+        accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"bob\");\n+        assertDenied(() -> accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), \"bob\"));\n+        assertDenied(() -> accessControl.checkCanRenameSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"test\"));\n+\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\"), \"new_schema\"));\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\"), \"new_schema\"));\n+        accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"), \"authenticated\");\n+        assertDenied(() -> accessControl.checkCanRenameSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\"), \"new_schema\"));\n+    }\n+\n+    @Test\n+    public void testSchemaRulesForCheckCanSetSchemaAuthorization()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-schema.json\");\n+\n+        accessControl.checkCanSetSchemaAuthorization(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\"));\n+        accessControl.checkCanSetSchemaAuthorization(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\"));\n+        accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\"));\n+        accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\"));\n+        assertDenied(() -> accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.ROLE, \"some_role\")));\n+        assertDenied(() -> accessControl.checkCanSetSchemaAuthorization(BOB, new CatalogSchemaName(\"some-catalog\", \"test\"), new PrestoPrincipal(PrincipalType.USER, \"some_user\")));\n+    }\n+\n+    @Test\n+    public void testSchemaRulesForCheckCanShowCreateSchema()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-schema.json\");\n+\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        accessControl.checkCanShowCreateSchema(ADMIN, new CatalogSchemaName(\"some-catalog\", \"test\"));\n+\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"bob\"));\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"staff\"));\n+        accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(BOB, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+\n+        accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"authenticated\"));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"bob\")));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"staff\")));\n+        assertDenied(() -> accessControl.checkCanShowCreateSchema(CHARLIE, new CatalogSchemaName(\"some-catalog\", \"test\")));\n+    }\n+\n     @Test\n     public void testCanSetUserOperations()\n     {\n         SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"catalog_principal.json\");\n \n-        try {\n-            accessControl.checkCanSetUser(Optional.empty(), alice.getUser());\n-            throw new AssertionError(\"expected AccessDeniedException\");\n-        }\n-        catch (AccessDeniedException expected) {\n-        }\n-\n+        assertDenied(() -> accessControl.checkCanSetUser(Optional.empty(), alice.getUser()));\n         accessControl.checkCanSetUser(kerberosValidAlice.getPrincipal(), kerberosValidAlice.getUser());\n         accessControl.checkCanSetUser(kerberosValidNonAsciiUser.getPrincipal(), kerberosValidNonAsciiUser.getUser());\n-        try {\n-            accessControl.checkCanSetUser(kerberosInvalidAlice.getPrincipal(), kerberosInvalidAlice.getUser());\n-            throw new AssertionError(\"expected AccessDeniedException\");\n-        }\n-        catch (AccessDeniedException expected) {\n-        }\n-\n+        assertDenied(() -> accessControl.checkCanSetUser(kerberosInvalidAlice.getPrincipal(), kerberosInvalidAlice.getUser()));\n         accessControl.checkCanSetUser(kerberosValidShare.getPrincipal(), kerberosValidShare.getUser());\n-        try {\n-            accessControl.checkCanSetUser(kerberosInValidShare.getPrincipal(), kerberosInValidShare.getUser());\n-            throw new AssertionError(\"expected AccessDeniedException\");\n-        }\n-        catch (AccessDeniedException expected) {\n-        }\n-\n+        assertDenied(() -> accessControl.checkCanSetUser(kerberosInValidShare.getPrincipal(), kerberosInValidShare.getUser()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTI0Ng==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428495246", "bodyText": "@kokosing I have reverted this changes and will have a separate ticket to refactor those.", "author": "haldes", "createdAt": "2020-05-21T07:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzNzIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMjUyNQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428502525", "bodyText": "DROP_SCHEMA_ERR_MESSAGE -> DROP_SCHEMA_ACCESS_DENIED_MESSAGE\nSame for all below.", "author": "kokosing", "createdAt": "2020-05-21T07:55:47Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -53,13 +54,102 @@\n     private static final Identity validSpecialRegexWildDot = Identity.forUser(\".*\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n     private static final Identity validSpecialRegexEndQuote = Identity.forUser(\"\\\\E\").withPrincipal(new KerberosPrincipal(\"special/\\\\E@EXAMPLE.COM\")).build();\n     private static final Identity invalidSpecialRegex = Identity.forUser(\"alice\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n-    private static final Identity bob = Identity.ofUser(\"bob\");\n-    private static final Identity admin = Identity.ofUser(\"admin\");\n+    private static final Identity bob = Identity.forUser(\"bob\").withGroups(ImmutableSet.of(\"staff\")).build();\n+    private static final Identity admin = Identity.forUser(\"admin\").withGroups(ImmutableSet.of(\"admin\", \"staff\")).build();\n     private static final Identity nonAsciiUser = Identity.ofUser(\"\\u0194\\u0194\\u0194\");\n     private static final Set<String> allCatalogs = ImmutableSet.of(\"secret\", \"open-to-all\", \"all-allowed\", \"alice-catalog\", \"allowed-absent\", \"\\u0200\\u0200\\u0200\");\n     private static final CatalogSchemaTableName aliceView = new CatalogSchemaTableName(\"alice-catalog\", \"schema\", \"view\");\n     private static final Optional<QueryId> queryId = Optional.empty();\n \n+    private static final Identity charlie = Identity.forUser(\"charlie\").withGroups(ImmutableSet.of(\"guests\")).build();\n+    private static final Identity joe = Identity.ofUser(\"joe\");\n+    private static final SystemSecurityContext ADMIN = new SystemSecurityContext(admin, queryId);\n+    private static final SystemSecurityContext BOB = new SystemSecurityContext(bob, queryId);\n+    private static final SystemSecurityContext CHARLIE = new SystemSecurityContext(charlie, queryId);\n+\n+    private static final String DROP_SCHEMA_ERR_MESSAGE = \"Access Denied: Cannot drop schema\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzMTk2NQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428531965", "bodyText": "This is changed.", "author": "haldes", "createdAt": "2020-05-21T08:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMjgzNw==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428502837", "bodyText": "INVALID_JSON_ERR_MESSAGE -> INVALID_JSON", "author": "kokosing", "createdAt": "2020-05-21T07:56:29Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -53,13 +54,102 @@\n     private static final Identity validSpecialRegexWildDot = Identity.forUser(\".*\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n     private static final Identity validSpecialRegexEndQuote = Identity.forUser(\"\\\\E\").withPrincipal(new KerberosPrincipal(\"special/\\\\E@EXAMPLE.COM\")).build();\n     private static final Identity invalidSpecialRegex = Identity.forUser(\"alice\").withPrincipal(new KerberosPrincipal(\"special/.*@EXAMPLE.COM\")).build();\n-    private static final Identity bob = Identity.ofUser(\"bob\");\n-    private static final Identity admin = Identity.ofUser(\"admin\");\n+    private static final Identity bob = Identity.forUser(\"bob\").withGroups(ImmutableSet.of(\"staff\")).build();\n+    private static final Identity admin = Identity.forUser(\"admin\").withGroups(ImmutableSet.of(\"admin\", \"staff\")).build();\n     private static final Identity nonAsciiUser = Identity.ofUser(\"\\u0194\\u0194\\u0194\");\n     private static final Set<String> allCatalogs = ImmutableSet.of(\"secret\", \"open-to-all\", \"all-allowed\", \"alice-catalog\", \"allowed-absent\", \"\\u0200\\u0200\\u0200\");\n     private static final CatalogSchemaTableName aliceView = new CatalogSchemaTableName(\"alice-catalog\", \"schema\", \"view\");\n     private static final Optional<QueryId> queryId = Optional.empty();\n \n+    private static final Identity charlie = Identity.forUser(\"charlie\").withGroups(ImmutableSet.of(\"guests\")).build();\n+    private static final Identity joe = Identity.ofUser(\"joe\");\n+    private static final SystemSecurityContext ADMIN = new SystemSecurityContext(admin, queryId);\n+    private static final SystemSecurityContext BOB = new SystemSecurityContext(bob, queryId);\n+    private static final SystemSecurityContext CHARLIE = new SystemSecurityContext(charlie, queryId);\n+\n+    private static final String DROP_SCHEMA_ERR_MESSAGE = \"Access Denied: Cannot drop schema\";\n+    private static final String RENAME_SCHEMA_ERR_MESSAGE = \"Access Denied: Cannot rename schema from\";\n+    private static final String AUTH_SCHEMA_ERR_MESSAGE = \"Access Denied: Cannot set authorization for schema\";\n+    private static final String SHOW_CREATE_SCHEMA_ERR_MESSAGE = \"Access Denied: Cannot show create schema for\";\n+    private static final String INVALID_JSON_ERR_MESSAGE = \"Invalid JSON file\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzAyNg==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428503026", "bodyText": "assertDenied  -> assertAccessDenied\nexpectedErrMessage -> expectedMessage", "author": "kokosing", "createdAt": "2020-05-21T07:56:54Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -268,4 +354,18 @@ private String getResourcePath(String resourceName)\n     {\n         return this.getClass().getClassLoader().getResource(resourceName).getPath();\n     }\n+\n+    private static void assertDenied(ThrowingCallable callable, String expectedErrMessage)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzMTg1NQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428531855", "bodyText": "This is changed.", "author": "haldes", "createdAt": "2020-05-21T08:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzA5NA==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428503094", "bodyText": "check that message equals or matches the pattern", "author": "kokosing", "createdAt": "2020-05-21T07:57:05Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -268,4 +354,18 @@ private String getResourcePath(String resourceName)\n     {\n         return this.getClass().getClassLoader().getResource(resourceName).getPath();\n     }\n+\n+    private static void assertDenied(ThrowingCallable callable, String expectedErrMessage)\n+    {\n+        assertThatThrownBy(callable)\n+                .isInstanceOf(AccessDeniedException.class)\n+                .hasMessageStartingWith(expectedErrMessage);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzMTczNw==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428531737", "bodyText": "@kokosing - I have changed to hasMessageMatching() and using pattern to match. Let me know if that's ok.", "author": "haldes", "createdAt": "2020-05-21T08:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzkwMg==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428503902", "bodyText": "I don't think there is a value in this refactor. Let's leave it as it was.", "author": "kokosing", "createdAt": "2020-05-21T07:58:59Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -232,14 +322,10 @@ public void testRefreshing()\n         copy(new File(getResourcePath(\"security-config-file-with-unknown-rules.json\")), configFile);\n         sleep(2);\n \n-        assertThatThrownBy(() -> accessControl.checkCanCreateView(alice, aliceView))\n-                .isInstanceOf(IllegalArgumentException.class)\n-                .hasMessageStartingWith(\"Invalid JSON file\");\n+        assertDeniedWithIllegalArgumentException(() -> accessControl.checkCanCreateView(alice, aliceView), INVALID_JSON_ERR_MESSAGE);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzMTA5OQ==", "url": "https://github.com/trinodb/trino/pull/3766#discussion_r428531099", "bodyText": "I have reverted this back.", "author": "haldes", "createdAt": "2020-05-21T08:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzkwMg=="}], "type": "inlineReview"}, {"oid": "e5413999ec9e36eca693e918ed17bb4a2a85ac51", "url": "https://github.com/trinodb/trino/commit/e5413999ec9e36eca693e918ed17bb4a2a85ac51", "message": "Add schema access rules to FileBasedSystemAccessControl\n\nAdd schema access rules to FileBasedSystemAccessControl\n\nAdd schema access rules to FileBasedSystemAccessControl\n\nAdd schema access rules to FileBasedSystemAccessControl\n\nAdd schema access rules to FileBasedSystemAccessControl\n\nAdd schema access rules to FileBasedSystemAccessControl", "committedDate": "2020-05-26T04:45:59Z", "type": "commit"}]}