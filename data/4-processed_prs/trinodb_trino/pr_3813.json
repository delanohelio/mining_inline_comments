{"pr_number": 3813, "pr_title": "Avoid trivial exchanges for constant projections", "pr_createdAt": "2020-05-22T02:44:28Z", "pr_url": "https://github.com/trinodb/trino/pull/3813", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEzNTUwOA==", "url": "https://github.com/trinodb/trino/pull/3813#discussion_r429135508", "bodyText": "What we repartition on? is it round robin in disguise?", "author": "findepi", "createdAt": "2020-05-22T09:15:33Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/optimizations/TestAddExchangesPlans.java", "diffHunk": "@@ -428,6 +428,17 @@ public void testExchangesAroundTrivialProjection()\n                 anyTree(\n                         project(\n                                 values(\"a\"))));\n+\n+        assertPlan(\n+                \"SELECT 1 UNION ALL SELECT 1\",\n+                anyTree(\n+                        exchange(\n+                                LOCAL,\n+                                REPARTITION,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI3NTI4OA==", "url": "https://github.com/trinodb/trino/pull/3813#discussion_r429275288", "bodyText": "Yes :(", "author": "martint", "createdAt": "2020-05-22T14:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEzNTUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5NDgzOQ==", "url": "https://github.com/trinodb/trino/pull/3813#discussion_r429294839", "bodyText": "uh. maybe worth adding a comment for people coming here for the first (second, third, ...) time, or somehow reflect that in exchange matcher instantiation", "author": "findepi", "createdAt": "2020-05-22T14:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEzNTUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NTk4OQ==", "url": "https://github.com/trinodb/trino/pull/3813#discussion_r429165989", "bodyText": "When refactoring this, you could replace all node(ValuesNode.class)) with values(\"x\"), values(\"y\") etc, accordingly to the actual names used in queries. It would make it easier to follow how the plan has transformed.", "author": "kasiafi", "createdAt": "2020-05-22T10:22:13Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestSubqueries.java", "diffHunk": "@@ -64,14 +53,37 @@ public void teardown()\n     @Test\n     public void testCorrelatedExistsSubqueriesWithOrPredicateAndNull()\n     {\n-        assertExistsRewrittenToAggregationAboveJoin(\n+        assertions.assertQueryAndPlan(\n                 \"SELECT EXISTS(SELECT 1 FROM (VALUES null, 10) t(x) WHERE y > x OR y + 10 > x) FROM (values 11 + if(rand() >= 0, 0)) t2(y)\",\n                 \"VALUES true\",\n-                false);\n-        assertExistsRewrittenToAggregationAboveJoin(\n+                anyTree(\n+                        aggregation(\n+                                ImmutableMap.of(\"COUNT\", functionCall(\"count\", ImmutableList.of(\"NON_NULL\"))),\n+                                aggregation -> aggregation.isStreamable() && aggregation.getStep() == SINGLE,\n+                                node(JoinNode.class,\n+                                        anyTree(\n+                                                node(ValuesNode.class)),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "46c3c6aeb0e3e7ab62787efc512723e081cfbd94", "url": "https://github.com/trinodb/trino/commit/46c3c6aeb0e3e7ab62787efc512723e081cfbd94", "message": "Remove unnecessary abstraction in plan tests\n\nThis form of parameterization makes it harder to understand\nwhat a given test case is trying to verify.", "committedDate": "2020-05-23T22:31:31Z", "type": "commit"}, {"oid": "23472089ff8ea2c301309ec37b821fdcfd09cec7", "url": "https://github.com/trinodb/trino/commit/23472089ff8ea2c301309ec37b821fdcfd09cec7", "message": "Avoid trivial exchanges for constant projections\n\nA query like\n\n    SELECT 10, a FROM (VALUES 1) t(a)\n\nis planned as:\n\n    Output[_col0, a]\n    \u2502   Layout: [expr_2:integer, field:integer]\n    \u2502   Estimates: {rows: 1 (10B), cpu: 15, memory: 0B, network: 0B}\n    \u2502   _col0 := expr_2\n    \u2502   a := field\n    \u2514\u2500 Project[]\n       \u2502   Layout: [expr_2:integer, field:integer]\n       \u2502   Estimates: {rows: 1 (10B), cpu: 15, memory: 0B, network: 0B}\n       \u2502   expr_2 := 10\n       \u2514\u2500 LocalExchange[ROUND_ROBIN] ()\n          \u2502   Layout: [field:integer]\n          \u2502   Estimates: {rows: 1 (5B), cpu: 5, memory: 0B, network: 0B}\n          \u2514\u2500 Values\n                 Layout: [field:integer]\n                 Estimates: {rows: 1 (5B), cpu: 0, memory: 0B, network: 0B}\n                 (1)\n\nThe local round-robin exchange is unnecessary in that case.", "committedDate": "2020-05-23T22:31:31Z", "type": "commit"}, {"oid": "c9c7f1f748fa8064a8c374d35e972174696d9302", "url": "https://github.com/trinodb/trino/commit/c9c7f1f748fa8064a8c374d35e972174696d9302", "message": "Do not force unnecessary parallelism for union inputs", "committedDate": "2020-05-23T22:31:31Z", "type": "commit"}, {"oid": "c9c7f1f748fa8064a8c374d35e972174696d9302", "url": "https://github.com/trinodb/trino/commit/c9c7f1f748fa8064a8c374d35e972174696d9302", "message": "Do not force unnecessary parallelism for union inputs", "committedDate": "2020-05-23T22:31:31Z", "type": "forcePushed"}]}