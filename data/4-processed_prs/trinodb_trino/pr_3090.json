{"pr_number": 3090, "pr_title": "Allow to set custom system access control for tests", "pr_createdAt": "2020-03-13T20:40:55Z", "pr_url": "https://github.com/trinodb/trino/pull/3090", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMDUxMQ==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r392710511", "bodyText": "binder.bind(SqlParserOptions.class).in(Scopes.SINGLETON);\n\ninstead of:\nSqlParserOptions sqlParserOptions = new SqlParserOptions();\nbinder.bind(SqlParserOptions.class).toInstance(sqlParserOptions);", "author": "wendigo", "createdAt": "2020-03-15T20:40:32Z", "path": "presto-main/src/main/java/io/prestosql/server/ServerMainModule.java", "diffHunk": "@@ -191,6 +182,7 @@ protected void setup(Binder binder)\n         configBinder(binder).bindConfig(FeaturesConfig.class);\n \n         binder.bind(SqlParser.class).in(Scopes.SINGLETON);\n+        SqlParserOptions sqlParserOptions = new SqlParserOptions();\n         binder.bind(SqlParserOptions.class).toInstance(sqlParserOptions);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNzE3OA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393037178", "bodyText": "I cannot because in the line below there a method called on this object o_O", "author": "kokosing", "createdAt": "2020-03-16T13:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMDUxMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4OTg2OA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393089868", "bodyText": "also please move sqlParserOptions.useEnhancedErrorHandl... to before guice bind", "author": "findepi", "createdAt": "2020-03-16T15:00:28Z", "path": "presto-main/src/main/java/io/prestosql/server/ServerMainModule.java", "diffHunk": "@@ -191,6 +182,7 @@ protected void setup(Binder binder)\n         configBinder(binder).bindConfig(FeaturesConfig.class);\n \n         binder.bind(SqlParser.class).in(Scopes.SINGLETON);\n+        SqlParserOptions sqlParserOptions = new SqlParserOptions();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5MTIyMA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393091220", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new Builder().build();\n          \n          \n            \n                    return builder().build();", "author": "findepi", "createdAt": "2020-03-16T15:02:19Z", "path": "presto-main/src/main/java/io/prestosql/server/testing/TestingPrestoServer.java", "diffHunk": "@@ -109,6 +109,16 @@\n public class TestingPrestoServer\n         implements Closeable\n {\n+    public static Builder builder()\n+    {\n+        return new Builder();\n+    }\n+\n+    public static TestingPrestoServer create()\n+    {\n+        return new Builder().build();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5MjI4NA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393092284", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Builder setAdditionalModule(Module additionalModule)\n          \n          \n            \n                    public Builder addAdditionalModule(Module additionalModule)\n          \n      \n    \n    \n  \n\n?", "author": "findepi", "createdAt": "2020-03-16T15:03:39Z", "path": "presto-main/src/main/java/io/prestosql/server/testing/TestingPrestoServer.java", "diffHunk": "@@ -537,4 +532,55 @@ private static Path tempDirectory()\n             throw new UncheckedIOException(e);\n         }\n     }\n+\n+    public static class Builder\n+    {\n+        private boolean coordinator = true;\n+        private Map<String, String> properties = ImmutableMap.of();\n+        private String environment;\n+        private URI discoveryUri;\n+        private Module additionalModule = EMPTY_MODULE;\n+        private Optional<Path> baseDataDir = Optional.empty();\n+\n+        public Builder setCoordinator(boolean coordinator)\n+        {\n+            this.coordinator = coordinator;\n+            return this;\n+        }\n+\n+        public Builder setProperties(Map<String, String> properties)\n+        {\n+            this.properties = ImmutableMap.copyOf(requireNonNull(properties, \"properties is null\"));\n+            return this;\n+        }\n+\n+        public Builder setEnvironment(String environment)\n+        {\n+            this.environment = requireNonNull(environment, \"environment is null\");\n+            return this;\n+        }\n+\n+        public Builder setDiscoveryUri(URI discoveryUri)\n+        {\n+            this.discoveryUri = requireNonNull(discoveryUri, \"discoveryUri is null\");\n+            return this;\n+        }\n+\n+        public Builder setAdditionalModule(Module additionalModule)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMTIxNw==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393521217", "bodyText": "No. I don't want to maintain the list. So far it is not needed.", "author": "kokosing", "createdAt": "2020-03-17T08:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5MjI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5MzY1Ng==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393093656", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        .toInstance(systemAccessControlProperties);\n          \n          \n            \n                                        .toInstance(ImmutableMap.copyOf(systemAccessControlProperties));", "author": "findepi", "createdAt": "2020-03-16T15:05:39Z", "path": "presto-main/src/main/java/io/prestosql/server/testing/TestingPrestoServer.java", "diffHunk": "@@ -221,6 +225,12 @@ private TestingPrestoServer(\n                 .add(new ServerMainModule())\n                 .add(new TestingWarningCollectorModule())\n                 .add(binder -> {\n+                    binder.bind(String.class)\n+                            .annotatedWith(TestingAccessControlManager.ForSystemAccessControl.class)\n+                            .toInstance(systemAccessControlName);\n+                    binder.bind(new TypeLiteral<Map<String, String>>() {})\n+                            .annotatedWith(TestingAccessControlManager.ForSystemAccessControl.class)\n+                            .toInstance(systemAccessControlProperties);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NDU0OA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393094548", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @interface ForSystemAccessControl\n          \n          \n            \n                public @interface ForSystemAccessControl {}", "author": "findepi", "createdAt": "2020-03-16T15:06:56Z", "path": "presto-main/src/main/java/io/prestosql/testing/TestingAccessControlManager.java", "diffHunk": "@@ -622,4 +631,11 @@ public int hashCode()\n             return Objects.hash(identity, table, column);\n         }\n     }\n+\n+    @Retention(RUNTIME)\n+    @Target({FIELD, PARAMETER, METHOD})\n+    @Qualifier\n+    public @interface ForSystemAccessControl", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NTYzNA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393095634", "bodyText": "is it avoidable?\ni am concerned we could want to have dep the other way -- use testing goodies in toolkit's tests", "author": "findepi", "createdAt": "2020-03-16T15:08:19Z", "path": "presto-testing/pom.xml", "diffHunk": "@@ -47,6 +47,11 @@\n             <artifactId>presto-tpch</artifactId>\n         </dependency>\n \n+        <dependency>\n+            <groupId>io.prestosql</groupId>\n+            <artifactId>presto-plugin-toolkit</artifactId>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMjczMA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393522730", "bodyText": "I think I haven't added any new dependency, it is now used explicitly (previously it was transitive). Not much changes.", "author": "kokosing", "createdAt": "2020-03-17T08:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NTYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NjM5NQ==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393096395", "bodyText": "don't configure SAC on worker\npeople know it's not required and they don't do this; so we shouldn't do this in tests either", "author": "findepi", "createdAt": "2020-03-16T15:09:32Z", "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -111,14 +114,26 @@ private DistributedQueryRunner(\n             ImmutableList.Builder<TestingPrestoServer> servers = ImmutableList.builder();\n \n             for (int i = 1; i < nodeCount; i++) {\n-                TestingPrestoServer worker = closer.register(createTestingPrestoServer(discoveryServer.getBaseUrl(), false, extraProperties, environment, baseDataDir));\n+                TestingPrestoServer worker = closer.register(createTestingPrestoServer(\n+                        discoveryServer.getBaseUrl(),\n+                        false,\n+                        extraProperties,\n+                        environment,\n+                        baseDataDir,\n+                        systemAccessControl));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyNTA5OA==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393525098", "bodyText": "I wish I could. All I can do right now is to set allow all access control (as it used to be till now), but I am not sure if it is better. TestingPrestoServer requires some non trivial changes to be able to not to require SAC \ud83d\ude1e", "author": "kokosing", "createdAt": "2020-03-17T08:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5Njg5MQ==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393096891", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Builder setSystemAccessControl(TestingSystemAccessControl systemAccessControl)\n          \n          \n            \n                    public Builder setSystemAccessControl(SystemAccessControl systemAccessControl)\n          \n      \n    \n    \n  \n\n-- would it work?", "author": "findepi", "createdAt": "2020-03-16T15:10:20Z", "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -549,10 +578,16 @@ public Builder setBaseDataDir(Optional<Path> baseDataDir)\n             return this;\n         }\n \n+        public Builder setSystemAccessControl(TestingSystemAccessControl systemAccessControl)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODQxOQ==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393528419", "bodyText": "It requires also properties, I changed that to follow your advice", "author": "kokosing", "createdAt": "2020-03-17T08:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5Njg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NzgyMQ==", "url": "https://github.com/trinodb/trino/pull/3090#discussion_r393097821", "bodyText": "It's neither \"testing implementation of SystemAccessControl\" nor \"testing's utilities for SystemAccessControl\" ...\nI don't know what this class represents.\nit may be better to just use two fields (name, properties) everywhere\notherwise call it eg TestingSystemAccessControlConfiguration", "author": "findepi", "createdAt": "2020-03-16T15:11:44Z", "path": "presto-testing/src/main/java/io/prestosql/testing/TestingSystemAccessControl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.prestosql.testing;\n+\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestingSystemAccessControl", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ff1e55b954580db8057f6ace0f6fd4bb8c29788", "url": "https://github.com/trinodb/trino/commit/1ff1e55b954580db8057f6ace0f6fd4bb8c29788", "message": "Remove unused parserOptions parameter", "committedDate": "2020-03-17T08:45:16Z", "type": "commit"}, {"oid": "263bbc2b55283d285cc861a8e701e3f5de80557b", "url": "https://github.com/trinodb/trino/commit/263bbc2b55283d285cc861a8e701e3f5de80557b", "message": "Fallback to delegate for masks and filters", "committedDate": "2020-03-17T09:02:23Z", "type": "commit"}, {"oid": "760fd052b019278d1690112e47340c064b62bbad", "url": "https://github.com/trinodb/trino/commit/760fd052b019278d1690112e47340c064b62bbad", "message": "Introduce builder for TestingPrestoServer", "committedDate": "2020-03-17T09:02:24Z", "type": "commit"}, {"oid": "ee526cd6c89a42c2ad04a5fb0d6429387ee0aab8", "url": "https://github.com/trinodb/trino/commit/ee526cd6c89a42c2ad04a5fb0d6429387ee0aab8", "message": "Allow to set custom system access control for tests", "committedDate": "2020-03-17T09:06:09Z", "type": "commit"}, {"oid": "78e069095061c5eb4ba4286a9d0c5528d4d8f5f6", "url": "https://github.com/trinodb/trino/commit/78e069095061c5eb4ba4286a9d0c5528d4d8f5f6", "message": "Use Optional for nullable variables", "committedDate": "2020-03-17T09:06:09Z", "type": "commit"}, {"oid": "d0c5e0b07bf8aff9cc12cc6599186f6620e56e9c", "url": "https://github.com/trinodb/trino/commit/d0c5e0b07bf8aff9cc12cc6599186f6620e56e9c", "message": "Allow to pass additional modules to DistributedQueryRunner", "committedDate": "2020-03-17T09:06:10Z", "type": "commit"}, {"oid": "8c9f012e56319e3c5085c3313b7a56087c313486", "url": "https://github.com/trinodb/trino/commit/8c9f012e56319e3c5085c3313b7a56087c313486", "message": "Fix formatting", "committedDate": "2020-03-17T09:06:10Z", "type": "commit"}, {"oid": "8c9f012e56319e3c5085c3313b7a56087c313486", "url": "https://github.com/trinodb/trino/commit/8c9f012e56319e3c5085c3313b7a56087c313486", "message": "Fix formatting", "committedDate": "2020-03-17T09:06:10Z", "type": "forcePushed"}]}