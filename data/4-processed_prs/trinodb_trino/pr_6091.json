{"pr_number": 6091, "pr_title": "Fix indeterminism in PlanNodeStats mergeability check", "pr_createdAt": "2020-11-25T11:56:02Z", "pr_url": "https://github.com/trinodb/trino/pull/6091", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTU2OA==", "url": "https://github.com/trinodb/trino/pull/6091#discussion_r530321568", "bodyText": "We don't know make sure all worker nodes have consistent configuration is the root cause yet", "author": "sopel39", "createdAt": "2020-11-25T12:00:55Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/planprinter/PlanNodeStats.java", "diffHunk": "@@ -153,4 +154,9 @@ public PlanNodeStats mergeWith(PlanNodeStats other)\n                 planNodeOutputPositions, planNodeOutputDataSize,\n                 operatorInputStats);\n     }\n+\n+    protected void checkMergeable(PlanNodeStats other)\n+    {\n+        checkArgument(this.getClass() == other.getClass(), \"Cannot merge stats %s and %s, make sure all worker nodes have consistent configuration\", this, other);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNDU3NQ==", "url": "https://github.com/trinodb/trino/pull/6091#discussion_r530324575", "bodyText": "I agree. But we believe it may be the cause, so i think it's a good advice to have", "author": "findepi", "createdAt": "2020-11-25T12:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTU2OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "93e2e0855c3b941ed56ea963c381d928f9fe0eae", "url": "https://github.com/trinodb/trino/commit/93e2e0855c3b941ed56ea963c381d928f9fe0eae", "message": "Fix indeterminism in PlanNodeStats mergeability check\n\nFor example `HashCollisionPlanNodeStats#mergeWith` requires that the\nobject being merged with is also `HashCollisionPlanNodeStats`  and not\ne.g. plain `PlanNodeStats`. However,\nthe same validation logic is not applied when the first stats found are\n`PlanNodeStats` and `HashCollisionPlanNodeStats` are being merged with.\nThus, whether we were getting a result or a failure was not fully\ndeterministic.", "committedDate": "2020-11-26T15:01:12Z", "type": "commit"}, {"oid": "93e2e0855c3b941ed56ea963c381d928f9fe0eae", "url": "https://github.com/trinodb/trino/commit/93e2e0855c3b941ed56ea963c381d928f9fe0eae", "message": "Fix indeterminism in PlanNodeStats mergeability check\n\nFor example `HashCollisionPlanNodeStats#mergeWith` requires that the\nobject being merged with is also `HashCollisionPlanNodeStats`  and not\ne.g. plain `PlanNodeStats`. However,\nthe same validation logic is not applied when the first stats found are\n`PlanNodeStats` and `HashCollisionPlanNodeStats` are being merged with.\nThus, whether we were getting a result or a failure was not fully\ndeterministic.", "committedDate": "2020-11-26T15:01:12Z", "type": "forcePushed"}]}