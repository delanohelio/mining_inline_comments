{"pr_number": 6328, "pr_title": "Add a backup Coordinator to test multi coordinators", "pr_createdAt": "2020-12-14T04:47:30Z", "pr_url": "https://github.com/trinodb/trino/pull/6328", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r553795507", "bodyText": "final", "author": "losipiuk", "createdAt": "2021-01-08T08:05:06Z", "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -81,6 +81,7 @@\n \n     private final TestingDiscoveryServer discoveryServer;\n     private final TestingPrestoServer coordinator;\n+    private TestingPrestoServer backupCoordinator;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQwMzEwMA==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r556403100", "bodyText": "The backupCoordinator is only used to test system connector, so I change it to local variabale.", "author": "yangruochen", "createdAt": "2021-01-13T10:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQxMTMyMA==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r556411320", "bodyText": "Is it ok? @losipiuk", "author": "yangruochen", "createdAt": "2021-01-13T10:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjUxNzUwMQ==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r556517501", "bodyText": "I would prefer to keep it as a field and add getter for it to keep it consistent with coordinator (even though we do not need to access it externally so far).", "author": "losipiuk", "createdAt": "2021-01-13T13:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAxNDcwNw==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r557014707", "bodyText": "I would prefer to keep it as a field and add getter for it to keep it consistent with coordinator (even though we do not need to access it externally so far).\n\nThanks, backup coordinator based on existence of backupCoordinatorProperties, so I keep it as a field but use Optional, and I add getter for it. @losipiuk", "author": "yangruochen", "createdAt": "2021-01-14T03:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTE5MTM1OQ==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r559191359", "bodyText": "@losipiuk Is it ok for this change?", "author": "yangruochen", "createdAt": "2021-01-17T14:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NTYxNQ==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r553795615", "bodyText": "setSingleBackupCoordinatorProperty", "author": "losipiuk", "createdAt": "2021-01-08T08:05:24Z", "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -594,6 +638,11 @@ public Builder setSingleCoordinatorProperty(String key, String value)\n             return setCoordinatorProperties(ImmutableMap.of(key, value));\n         }\n \n+        public Builder setBackupSingleCoordinatorProperty(String key, String value)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc5NjczMw==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r553796733", "bodyText": "If we are to determine if we should use backup coordinator based on existence of backupCoordinatorProperties then declare it as Optional<Map<String, String> and use isPresent() for check.", "author": "losipiuk", "createdAt": "2021-01-08T08:08:23Z", "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -104,9 +105,31 @@ private DistributedQueryRunner(\n             Optional<Path> baseDataDir,\n             List<SystemAccessControl> systemAccessControls)\n             throws Exception\n+    {\n+        this(defaultSession, nodeCount, extraProperties, coordinatorProperties, null, environment, additionalModule, baseDataDir, systemAccessControls);\n+    }\n+\n+    private DistributedQueryRunner(\n+            Session defaultSession,\n+            int nodeCount,\n+            Map<String, String> extraProperties,\n+            Map<String, String> coordinatorProperties,\n+            Map<String, String> backupCoordinatorProperties,\n+            String environment,\n+            Module additionalModule,\n+            Optional<Path> baseDataDir,\n+            List<SystemAccessControl> systemAccessControls)\n+            throws Exception\n     {\n         requireNonNull(defaultSession, \"defaultSession is null\");\n \n+        if (backupCoordinatorProperties != null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjUxNDc4Ng==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r556514786", "bodyText": "add checkArgument(nodeCount >2, ... in the backupCoordinatorProperties.isPresent() section in the constructor and drop it from this if", "author": "losipiuk", "createdAt": "2021-01-13T13:22:32Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/DistributedQueryRunner.java", "diffHunk": "@@ -147,6 +155,20 @@ private DistributedQueryRunner(\n                     baseDataDir,\n                     systemAccessControls));\n             servers.add(coordinator);\n+            if (nodeCount >= 2 && backupCoordinatorProperties.isPresent()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1NzEwOA==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r559457108", "bodyText": "Why do we need this. I would very much prefer that we do not need to set explicit listen ports and use random ones. With 8080 used by tests it is very probable to get a port conflict on test run", "author": "losipiuk", "createdAt": "2021-01-18T10:18:39Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/DistributedQueryRunner.java", "diffHunk": "@@ -107,6 +110,14 @@ private DistributedQueryRunner(\n     {\n         requireNonNull(defaultSession, \"defaultSession is null\");\n \n+        if (backupCoordinatorProperties.isPresent()) {\n+            requireNonNull(coordinatorProperties, \"coordinatorProperties cannot be null, if backupCoordinatorProperties is not null!\");\n+            requireNonNull(coordinatorProperties.get(\"http-server.http.port\"), \"the http-server.http.port of coordinatorProperties cannot be null, if backupCoordinatorProperties is not null!\");\n+            requireNonNull(backupCoordinatorProperties.get().get(\"http-server.http.port\"), \"the http-server.http.port of backupCoordinatorProperties cannot be null, if backupCoordinatorProperties is not null!\");\n+            Assertions.assertNotEquals(coordinatorProperties.get(\"http-server.http.port\"), backupCoordinatorProperties.get().get(\"http-server.http.port\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDY0NTE2OQ==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r560645169", "bodyText": "Why do we need this. I would very much prefer that we do not need to set explicit listen ports and use random ones. With 8080 used by tests it is very probable to get a port conflict on test run\n\nI delete these checks.", "author": "yangruochen", "createdAt": "2021-01-20T03:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1NzEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1ODg3Nw==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r559458877", "bodyText": "I did not notice that before. We should not need a specific port assignement.\nWith that said it may not make sense any more to specify if backup coordinator should be used or not based on existence of backup coordinator properties.\nPlease leave the setSingleBackupCoordinatorProperty method but add another one to explicitly specify that we want to use backup coordinator: enableBackupCoordinator()", "author": "losipiuk", "createdAt": "2021-01-18T10:21:38Z", "path": "testing/trino-tests/src/test/java/io/trino/connector/system/runtime/TestSystemConnector.java", "diffHunk": "@@ -75,7 +75,10 @@ protected QueryRunner createQueryRunner()\n                 .setSchema(\"default\")\n                 .build();\n \n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(defaultSession).build();\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(defaultSession)\n+                .setSingleCoordinatorProperty(\"http-server.http.port\", \"8080\")\n+                .setSingleBackupCoordinatorProperty(\"http-server.http.port\", \"8081\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDY0NDYyMQ==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r560644621", "bodyText": "You are right. I have changed these ports to random ones and added the method. @losipiuk", "author": "yangruochen", "createdAt": "2021-01-20T03:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1ODg3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ4MTA3MA==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r563481070", "bodyText": "Is it ok? @losipiuk", "author": "yangruochen", "createdAt": "2021-01-25T06:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1ODg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYwNzc3OA==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r563607778", "bodyText": "Use Optional.of we do not expect null to be passed here", "author": "losipiuk", "createdAt": "2021-01-25T10:18:38Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/DistributedQueryRunner.java", "diffHunk": "@@ -584,6 +614,12 @@ public Builder setCoordinatorProperties(Map<String, String> coordinatorPropertie\n             return this;\n         }\n \n+        public Builder setBackupCoordinatorProperties(Map<String, String> backupCoordinatorProperties)\n+        {\n+            this.backupCoordinatorProperties = Optional.ofNullable(backupCoordinatorProperties);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDIwMTY5Ng==", "url": "https://github.com/trinodb/trino/pull/6328#discussion_r564201696", "bodyText": "Use Optional.of we do not expect null to be passed here\n\nok", "author": "yangruochen", "createdAt": "2021-01-26T03:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYwNzc3OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "b2bd90946b28d21fca7c19b7042d5252d540d786", "url": "https://github.com/trinodb/trino/commit/b2bd90946b28d21fca7c19b7042d5252d540d786", "message": "Add a backup Coordinator to test multi coordinators", "committedDate": "2021-01-26T07:42:18Z", "type": "commit"}, {"oid": "b2bd90946b28d21fca7c19b7042d5252d540d786", "url": "https://github.com/trinodb/trino/commit/b2bd90946b28d21fca7c19b7042d5252d540d786", "message": "Add a backup Coordinator to test multi coordinators", "committedDate": "2021-01-26T07:42:18Z", "type": "forcePushed"}]}