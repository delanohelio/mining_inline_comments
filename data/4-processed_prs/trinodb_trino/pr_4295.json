{"pr_number": 4295, "pr_title": "Use product version obtained from Hive in Hive tests", "pr_createdAt": "2020-07-01T11:51:01Z", "pr_url": "https://github.com/trinodb/trino/pull/4295", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNzIwMg==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448317202", "bodyText": "local must be on sep line, otherwise it masks exit codes\nwhat does t and d mean?\nbtw my idiom for grep+sed is\nsed -n 's/..../..../p'", "author": "findepi", "createdAt": "2020-07-01T12:06:37Z", "path": "presto-hive-hadoop2/bin/common.sh", "diffHunk": "@@ -132,3 +132,12 @@ function start_hadoop_docker_containers() {\n   # wait until hadoop processes is started\n   retry check_hadoop\n }\n+\n+function get_hive_major_version() {\n+    local version=$(exec_in_hadoop_master_container hive --version 2>/dev/null | sed 's/^Hive.*[ ]\\([0-9]\\)\\..*/\\1/;t;d')", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1MDY2MQ==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448350661", "bodyText": "https://stackoverflow.com/a/1665662.\nDIfferent method. Same result.", "author": "losipiuk", "createdAt": "2020-07-01T13:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNzIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNzI5OA==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448317298", "bodyText": ">&2", "author": "findepi", "createdAt": "2020-07-01T12:06:48Z", "path": "presto-hive-hadoop2/bin/common.sh", "diffHunk": "@@ -132,3 +132,12 @@ function start_hadoop_docker_containers() {\n   # wait until hadoop processes is started\n   retry check_hadoop\n }\n+\n+function get_hive_major_version() {\n+    local version=$(exec_in_hadoop_master_container hive --version 2>/dev/null | sed 's/^Hive.*[ ]\\([0-9]\\)\\..*/\\1/;t;d')\n+    if [[ \"${version}\" == \"\" ]]; then\n+        echo \"Could not obtain Hive major version\"", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNzM1Mg==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448317352", "bodyText": "\" quote", "author": "findepi", "createdAt": "2020-07-01T12:06:53Z", "path": "presto-hive-hadoop2/bin/common.sh", "diffHunk": "@@ -132,3 +132,12 @@ function start_hadoop_docker_containers() {\n   # wait until hadoop processes is started\n   retry check_hadoop\n }\n+\n+function get_hive_major_version() {\n+    local version=$(exec_in_hadoop_master_container hive --version 2>/dev/null | sed 's/^Hive.*[ ]\\([0-9]\\)\\..*/\\1/;t;d')\n+    if [[ \"${version}\" == \"\" ]]; then\n+        echo \"Could not obtain Hive major version\"\n+        return 1\n+    fi\n+    echo ${version}", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNzYwNQ==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448317605", "bodyText": "debug?", "author": "findepi", "createdAt": "2020-07-01T12:07:26Z", "path": "presto-hive-hadoop2/bin/run_hive_tests.sh", "diffHunk": "@@ -7,8 +7,12 @@ set -euo pipefail -x\n cleanup_hadoop_docker_containers\n start_hadoop_docker_containers\n \n+# obtain Hive version\n+TESTS_HIVE_VERSION_MAJOR=$(get_hive_major_version)\n+\n # generate test data\n exec_in_hadoop_master_container sudo -Eu hive beeline -u jdbc:hive2://localhost:10000/default -n hive -f /docker/sql/create-test.sql\n+exec_in_hadoop_master_container sudo -Eu hive beeline -u jdbc:hive2://localhost:10000/default -n hive -f /docker/sql/create-test.sql", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxODExNw==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448318117", "bodyText": "This belongs to Use product version obtained from Hive in Hive product tests commit.", "author": "findepi", "createdAt": "2020-07-01T12:08:29Z", "path": "presto-product-tests/bin/product-tests-suite-8-non-generic.sh", "diffHunk": "@@ -12,7 +12,7 @@ fi\n \n suite_exit_code=0\n \n-TESTS_HIVE_VERSION_MAJOR=\"3\" TESTS_HIVE_VERSION_MINOR=\"1\" presto-product-tests-launcher/bin/run-launcher test run \\", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxODY1Nw==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448318657", "bodyText": "This belongs to Use product version obtained from Hive in Hive integration tests\n(the file is used in Hive integration tests only)", "author": "findepi", "createdAt": "2020-07-01T12:09:27Z", "path": "presto-product-tests/conf/product-tests-defaults.sh", "diffHunk": "@@ -1,13 +1,5 @@\n export DOCKER_IMAGES_VERSION=${DOCKER_IMAGES_VERSION:-28}\n \n-if test -v HADOOP_BASE_IMAGE; then\n-    test -v TESTS_HIVE_VERSION_MAJOR\n-    test -v TESTS_HIVE_VERSION_MINOR\n-else\n-    test ! -v TESTS_HIVE_VERSION_MAJOR\n-    test ! -v TESTS_HIVE_VERSION_MINOR\n-\n+if test ! -v HADOOP_BASE_IMAGE; then\n     export HADOOP_BASE_IMAGE=\"prestodev/hdp2.6-hive\"\n-    export TESTS_HIVE_VERSION_MAJOR=\"1\"\n-    export TESTS_HIVE_VERSION_MINOR=\"2\"", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxOTAxMw==", "url": "https://github.com/trinodb/trino/pull/4295#discussion_r448319013", "bodyText": "This can be now simplified to\nexport HADOOP_BASE_IMAGE=\"${HADOOP_BASE_IMAGE:-prestodev/hdp2.6-hive}\"", "author": "findepi", "createdAt": "2020-07-01T12:10:07Z", "path": "presto-product-tests/conf/product-tests-defaults.sh", "diffHunk": "@@ -1,13 +1,5 @@\n export DOCKER_IMAGES_VERSION=${DOCKER_IMAGES_VERSION:-28}\n \n-if test -v HADOOP_BASE_IMAGE; then\n-    test -v TESTS_HIVE_VERSION_MAJOR\n-    test -v TESTS_HIVE_VERSION_MINOR\n-else\n-    test ! -v TESTS_HIVE_VERSION_MAJOR\n-    test ! -v TESTS_HIVE_VERSION_MINOR\n-\n+if test ! -v HADOOP_BASE_IMAGE; then", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "f1bc131537b144527363fb7909ce8e1c067c8f25", "url": "https://github.com/trinodb/trino/commit/f1bc131537b144527363fb7909ce8e1c067c8f25", "message": "Use product version obtained from Hive in Hive product tests", "committedDate": "2020-07-01T15:42:36Z", "type": "commit"}, {"oid": "401e274e84aa5828f6e2c67a3382cd739c8f9840", "url": "https://github.com/trinodb/trino/commit/401e274e84aa5828f6e2c67a3382cd739c8f9840", "message": "Use product version obtained from Hive in Hive integration tests", "committedDate": "2020-07-01T15:42:36Z", "type": "commit"}, {"oid": "40051e68b162e28bf64b091318766c64d41e72c3", "url": "https://github.com/trinodb/trino/commit/40051e68b162e28bf64b091318766c64d41e72c3", "message": "Remove unused Hive version variable definitions", "committedDate": "2020-07-01T15:42:36Z", "type": "commit"}, {"oid": "40051e68b162e28bf64b091318766c64d41e72c3", "url": "https://github.com/trinodb/trino/commit/40051e68b162e28bf64b091318766c64d41e72c3", "message": "Remove unused Hive version variable definitions", "committedDate": "2020-07-01T15:42:36Z", "type": "forcePushed"}]}