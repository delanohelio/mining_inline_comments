{"pr_number": 6040, "pr_title": "Require calling convention for scalar functions", "pr_createdAt": "2020-11-21T20:51:34Z", "pr_url": "https://github.com/trinodb/trino/pull/6040", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MjI0OQ==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r528242249", "bodyText": "At first sight, it looks not related to the commit?", "author": "findepi", "createdAt": "2020-11-21T20:59:54Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/MapElementAtFunction.java", "diffHunk": "@@ -132,7 +129,7 @@ public static Object elementAt(MethodHandle keyEqualsMethod, Type keyType, Type\n     }\n \n     @UsedByGeneratedCode\n-    public static Object elementAt(MethodHandle keyEqualsMethod, Type keyType, Type valueType, Block map, double key)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0Mjc3Ng==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r528242776", "bodyText": "Doesn't look like it... I'll hoist this to another commit", "author": "dain", "createdAt": "2020-11-21T21:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MjI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MjM0Mw==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r528242343", "bodyText": "why no longer nullable?", "author": "findepi", "createdAt": "2020-11-21T21:00:41Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/TryCastFunction.java", "diffHunk": "@@ -76,20 +75,20 @@ public ScalarFunctionImplementation specialize(FunctionBinding functionBinding,\n         Type fromType = functionBinding.getTypeVariable(\"F\");\n         Type toType = functionBinding.getTypeVariable(\"T\");\n \n-        Class<?> returnType = Primitives.wrap(toType.getJavaType());\n+        Class<?> returnType = wrap(toType.getJavaType());\n \n         // the resulting method needs to return a boxed type\n-        MethodHandle coercion = functionDependencies.getCastInvoker(fromType, toType, Optional.empty()).getMethodHandle();\n+        InvocationConvention invocationConvention = new InvocationConvention(ImmutableList.of(NEVER_NULL), NULLABLE_RETURN, true, false);\n+        MethodHandle coercion = functionDependencies.getCastInvoker(fromType, toType, invocationConvention).getMethodHandle();\n         coercion = coercion.asType(methodType(returnType, coercion.type()));\n \n         MethodHandle exceptionHandler = dropArguments(constant(returnType, null), 0, RuntimeException.class);\n         MethodHandle tryCastHandle = catchException(coercion, RuntimeException.class, exceptionHandler);\n \n-        boolean nullableArgument = functionDependencies.getCastMetadata(fromType, toType).getArgumentDefinitions().get(0).isNullable();\n         return new ChoicesScalarFunctionImplementation(\n                 functionBinding,\n                 NULLABLE_RETURN,\n-                ImmutableList.of(nullableArgument ? BOXED_NULLABLE : NEVER_NULL),\n+                ImmutableList.of(NEVER_NULL),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MjYwMg==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r528242602", "bodyText": "It doesn't need to be nullable.  If the argument is null, the engine will automatically return null for you.", "author": "dain", "createdAt": "2020-11-21T21:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MjM0Mw=="}], "type": "inlineReview"}, {"oid": "f8b80aeb9c0f784ee86c4b90dfeec9b559a84cdc", "url": "https://github.com/trinodb/trino/commit/f8b80aeb9c0f784ee86c4b90dfeec9b559a84cdc", "message": "Remove unused keyEqualsMethod and keyType from MapElementAtFunction", "committedDate": "2020-11-21T23:15:27Z", "type": "commit"}, {"oid": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "url": "https://github.com/trinodb/trino/commit/b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "message": "Require calling convention for scalar functions", "committedDate": "2020-11-21T23:16:28Z", "type": "commit"}, {"oid": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "url": "https://github.com/trinodb/trino/commit/b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "message": "Require calling convention for scalar functions", "committedDate": "2020-11-21T23:16:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534458894", "bodyText": "Why are we getting an EQUALs operator that allows nullable return? That doesn't seem expected for equals as an operator?", "author": "erichwang", "createdAt": "2020-12-02T20:25:58Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/ExpressionInterpreter.java", "diffHunk": "@@ -581,8 +586,8 @@ protected Object visitInPredicate(InPredicate node, Object context)\n                     set = FastutilSetHelper.toFastutilHashSet(\n                             objectSet,\n                             type,\n-                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(HASH_CODE, ImmutableList.of(type)), Optional.empty()).getMethodHandle(),\n-                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(EQUAL, ImmutableList.of(type, type)), Optional.empty()).getMethodHandle());\n+                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(HASH_CODE, ImmutableList.of(type)), simpleConvention(FAIL_ON_NULL, NEVER_NULL)).getMethodHandle(),\n+                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(EQUAL, ImmutableList.of(type, type)), simpleConvention(NULLABLE_RETURN, NEVER_NULL, NEVER_NULL)).getMethodHandle());", "originalCommit": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5MzQzNg==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534493436", "bodyText": "i guess ARRAY[NULL] = ARRAY[1] should return NULL", "author": "findepi", "createdAt": "2020-12-02T21:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNjU5OQ==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534526599", "bodyText": "Yep that is why", "author": "dain", "createdAt": "2020-12-02T22:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA=="}], "type": "inlineReview"}]}