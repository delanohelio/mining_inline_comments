{"pr_number": 2455, "pr_title": "Quote all identifiers for generated Cassandra query", "pr_createdAt": "2020-01-09T15:30:45Z", "pr_url": "https://github.com/trinodb/trino/pull/2455", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIxODk0OA==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365218948", "bodyText": "Please maybe extract a separate commit like \"Retain actual names in CassandraInsertTableHandle\"", "author": "findepi", "createdAt": "2020-01-10T12:50:07Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -333,12 +331,12 @@ public ConnectorInsertTableHandle beginInsert(ConnectorSession session, Connecto\n \n         SchemaTableName schemaTableName = new SchemaTableName(table.getSchemaName(), table.getTableName());\n         List<CassandraColumnHandle> columns = cassandraSession.getTable(schemaTableName).getColumns();\n-        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).map(CassandraCqlUtils::validColumnName).collect(Collectors.toList());\n+        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).collect(Collectors.toList());\n         List<Type> columnTypes = columns.stream().map(CassandraColumnHandle::getType).collect(Collectors.toList());\n \n         return new CassandraInsertTableHandle(\n-                validSchemaName(table.getSchemaName()),\n-                validTableName(table.getTableName()),\n+                table.getSchemaName(),\n+                table.getTableName(),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIxOTAyMw==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365219023", "bodyText": "This would belong to \"Retain actual names in CassandraInsertTableHandle\" if you extract it", "author": "findepi", "createdAt": "2020-01-10T12:50:18Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraPageSink.java", "diffHunk": "@@ -92,14 +95,14 @@ public CassandraPageSink(\n             this.toCassandraDate = value -> LocalDate.fromDaysSinceEpoch(toIntExact(value));\n         }\n \n-        Insert insert = insertInto(schemaName, tableName);\n+        Insert insert = insertInto(validSchemaName(schemaName), validTableName(tableName));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMTE2MQ==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365221161", "bodyText": "In the description you wrote\n\nOnly alphanumeric and underscore are allowed as the identifier in Cassandra.\n\nbut the logic here is different.\nDid you mean something like\nif (!identifier.matches(\"[a-z]([a-z0-9_]*[a-z0-9])?\") {\n    return quoteIdentifier(identifier);\n}\n\nthis would not only impl want you describe (quote everything that contains non-underscore, non-alphanumeric characters), but also\n\nquote names starting with digit (i'm just guessing this isn't legal either)\nquote empty names (eliminating existing check at the beginning of validColumnName method)\nquote non-lowercase names (eliminating existing check at the beginning of validIdentifier method)\n\n(of course, such Pattern should be compiled as static field)", "author": "findepi", "createdAt": "2020-01-10T12:56:28Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/util/CassandraCqlUtils.java", "diffHunk": "@@ -76,6 +76,10 @@ private static String validIdentifier(String identifier)\n         if (keywords.contains(identifier.toUpperCase(ENGLISH))) {\n             return quoteIdentifier(identifier);\n         }\n+\n+        if (identifier.startsWith(\"_\") || identifier.endsWith(\"_\")) {\n+            return quoteIdentifier(identifier);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIzMjYwNw==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365232607", "bodyText": "Sorry, my description was insufficient. Cassandra throws an exception if an identifier contains non-underscore symbols. This case happens when Presto tries to create an table.\nSo, my intent was \"allowed but it is needed to be quoted in some cases\".\nExactly, my current commit misses some cases (e.g. starting/ending with digit). Let me update.", "author": "ebyhr", "createdAt": "2020-01-10T13:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMTE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5NDY2OA==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365294668", "bodyText": "btw, can we quote unconditionally?\ni know you've considered that, but I don't know why you abandoned this idea.", "author": "findepi", "createdAt": "2020-01-10T15:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMTE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU4MzU1OQ==", "url": "https://github.com/trinodb/trino/pull/2455#discussion_r365583559", "bodyText": "It seems like existing tests depend on the condition (I don't think the test is important), so I wanted to confirm more detail. I'll investigate it again before updating this PR.", "author": "ebyhr", "createdAt": "2020-01-12T13:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMTE2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "677c39fc7755b0aeb3e438c177054ec333f5bb2a", "url": "https://github.com/trinodb/trino/commit/677c39fc7755b0aeb3e438c177054ec333f5bb2a", "message": "Retain actual names in CassandraInsertTableHandle", "committedDate": "2020-01-16T01:08:16Z", "type": "commit"}, {"oid": "3ae134546a9d728b3557e6b6cc2124c8d1fd5c79", "url": "https://github.com/trinodb/trino/commit/3ae134546a9d728b3557e6b6cc2124c8d1fd5c79", "message": "Quote all identifiers for generated Cassandra query", "committedDate": "2020-01-16T01:08:30Z", "type": "commit"}, {"oid": "3ae134546a9d728b3557e6b6cc2124c8d1fd5c79", "url": "https://github.com/trinodb/trino/commit/3ae134546a9d728b3557e6b6cc2124c8d1fd5c79", "message": "Quote all identifiers for generated Cassandra query", "committedDate": "2020-01-16T01:08:30Z", "type": "forcePushed"}]}