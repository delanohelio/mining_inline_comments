{"pr_number": 5524, "pr_title": "Push down aggregation with LIMIT into JDBC connectors", "pr_createdAt": "2020-10-12T12:55:02Z", "pr_url": "https://github.com/trinodb/trino/pull/5524", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjM2MQ==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503276361", "bodyText": "#811", "author": "findepi", "createdAt": "2020-10-12T12:55:18Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -527,20 +527,26 @@ public PlanOptimizers(\n                 new CheckSubqueryNodesAreRewritten(),\n                 new StatsRecordingPlanOptimizer(\n                         optimizerStats,\n-                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)),\n-                new IterativeOptimizer(\n-                        ruleStats,\n-                        statsCalculator,\n-                        estimatedExchangesCostCalculator,\n-                        ImmutableSet.<Rule<?>>builder()\n-                                .addAll(columnPruningRules)\n-                                .addAll(projectionPushdownRules)\n-                                .add(new RemoveRedundantIdentityProjections())\n-                                .add(new PushLimitIntoTableScan(metadata))\n-                                .add(new PushPredicateIntoTableScan(metadata, typeOperators, typeAnalyzer))\n-                                .add(new PushSampleIntoTableScan(metadata))\n-                                .add(new PushAggregationIntoTableScan(metadata))\n-                                .build()),\n+                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)));\n+\n+        IterativeOptimizer pushIntoTableScanOptimizer = new IterativeOptimizer(\n+                ruleStats,\n+                statsCalculator,\n+                estimatedExchangesCostCalculator,\n+                ImmutableSet.<Rule<?>>builder()\n+                        .addAll(columnPruningRules)\n+                        .addAll(projectionPushdownRules)\n+                        .add(new RemoveRedundantIdentityProjections())\n+                        .add(new PushLimitIntoTableScan(metadata))\n+                        .add(new PushPredicateIntoTableScan(metadata, typeOperators, typeAnalyzer))\n+                        .add(new PushSampleIntoTableScan(metadata))\n+                        .add(new PushAggregationIntoTableScan(metadata))\n+                        .build());\n+        builder.add(pushIntoTableScanOptimizer);\n+        builder.add(new UnaliasSymbolReferences(metadata));\n+        builder.add(pushIntoTableScanOptimizer); // TODO (https://github.com/prestosql/presto/issues/811) merge merge with the above after migrating UnaliasSymbolReferences to rules", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjUwNA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503276504", "bodyText": "#4313", "author": "findepi", "createdAt": "2020-10-12T12:55:35Z", "path": "presto-druid/src/test/java/io/prestosql/plugin/druid/TestDruidIntegrationSmokeTest.java", "diffHunk": "@@ -283,5 +284,14 @@ public void testLimitPushdown()\n \n         // with filter over varchar column\n         assertThat(query(\"SELECT name FROM nation WHERE name < 'EEE' LIMIT 5\")).isCorrectlyPushedDown();\n+\n+        // with aggregation\n+        assertThat(query(\"SELECT max(regionkey) FROM nation LIMIT 5\")).isNotFullyPushedDown(AggregationNode.class); // global aggregation, LIMIT removed TODO https://github.com/prestosql/presto/pull/4313", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjY2Mw==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503276663", "bodyText": "#5522", "author": "findepi", "createdAt": "2020-10-12T12:55:50Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -385,6 +385,15 @@ public void testLimitPushdown()\n \n         // with filter over varchar column\n         assertThat(query(\"SELECT name FROM nation WHERE name < 'EEE' LIMIT 5\")).isCorrectlyPushedDown();\n+\n+        // with aggregation\n+        assertThat(query(\"SELECT max(regionkey) FROM nation LIMIT 5\")).isCorrectlyPushedDown(); // global aggregation, LIMIT removed\n+        assertThat(query(\"SELECT regionkey, max(name) FROM nation GROUP BY regionkey LIMIT 5\")).isCorrectlyPushedDown();\n+        // TODO (https://github.com/prestosql/presto/issues/5522) assertThat(query(\"SELECT DISTINCT regionkey FROM nation LIMIT 5\")).isCorrectlyPushedDown();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4OTA3MQ==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503489071", "bodyText": "add an example with actual aggregation? like avg(DISTINCT regionkey)`?", "author": "losipiuk", "createdAt": "2020-10-12T19:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjY2Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5MDQ1NQ==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503490455", "bodyText": "General comment. I have some problem with test naming. It claims that pushdown is being tested here. While we do not really have any pushdown related assertions. We are just checking if LIMIT queries are not messed up by connector implementation.", "author": "losipiuk", "createdAt": "2020-10-12T19:27:50Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -866,6 +866,22 @@ public void testLimitPushDown()\n \n         assertEquals(actual.getMaterializedRows().size(), 10);\n         assertContains(all, actual);\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU1OA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503759558", "bodyText": "pre-existing, i can change it still, preferrably as a followup", "author": "findepi", "createdAt": "2020-10-13T08:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5MDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxNDYzNA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503814634", "bodyText": "Sure. Thanks", "author": "losipiuk", "createdAt": "2020-10-13T09:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5MDQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2ODY4NA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503568684", "bodyText": "may be define this at the top where other optimizers/rulesets are defined? just a suggestion.", "author": "phd3", "createdAt": "2020-10-12T22:39:26Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -527,20 +527,26 @@ public PlanOptimizers(\n                 new CheckSubqueryNodesAreRewritten(),\n                 new StatsRecordingPlanOptimizer(\n                         optimizerStats,\n-                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)),\n-                new IterativeOptimizer(\n-                        ruleStats,\n-                        statsCalculator,\n-                        estimatedExchangesCostCalculator,\n-                        ImmutableSet.<Rule<?>>builder()\n-                                .addAll(columnPruningRules)\n-                                .addAll(projectionPushdownRules)\n-                                .add(new RemoveRedundantIdentityProjections())\n-                                .add(new PushLimitIntoTableScan(metadata))\n-                                .add(new PushPredicateIntoTableScan(metadata, typeOperators, typeAnalyzer))\n-                                .add(new PushSampleIntoTableScan(metadata))\n-                                .add(new PushAggregationIntoTableScan(metadata))\n-                                .build()),\n+                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)));\n+\n+        IterativeOptimizer pushIntoTableScanOptimizer = new IterativeOptimizer(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2MDM1NA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503760354", "bodyText": "i thought about that. \"at the top\" is a few screens away, which makes code navigation harder\nit would be definitely better if pushIntoTableScanOptimizer was used in more than one place (i consider current two incantations still  \"one place\")", "author": "findepi", "createdAt": "2020-10-13T08:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2ODY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDEyMw==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503570123", "bodyText": "nit: merge merge --> merge", "author": "phd3", "createdAt": "2020-10-12T22:44:05Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -527,20 +527,26 @@ public PlanOptimizers(\n                 new CheckSubqueryNodesAreRewritten(),\n                 new StatsRecordingPlanOptimizer(\n                         optimizerStats,\n-                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)),\n-                new IterativeOptimizer(\n-                        ruleStats,\n-                        statsCalculator,\n-                        estimatedExchangesCostCalculator,\n-                        ImmutableSet.<Rule<?>>builder()\n-                                .addAll(columnPruningRules)\n-                                .addAll(projectionPushdownRules)\n-                                .add(new RemoveRedundantIdentityProjections())\n-                                .add(new PushLimitIntoTableScan(metadata))\n-                                .add(new PushPredicateIntoTableScan(metadata, typeOperators, typeAnalyzer))\n-                                .add(new PushSampleIntoTableScan(metadata))\n-                                .add(new PushAggregationIntoTableScan(metadata))\n-                                .build()),\n+                        new PredicatePushDown(metadata, typeOperators, typeAnalyzer, false, false)));\n+\n+        IterativeOptimizer pushIntoTableScanOptimizer = new IterativeOptimizer(\n+                ruleStats,\n+                statsCalculator,\n+                estimatedExchangesCostCalculator,\n+                ImmutableSet.<Rule<?>>builder()\n+                        .addAll(columnPruningRules)\n+                        .addAll(projectionPushdownRules)\n+                        .add(new RemoveRedundantIdentityProjections())\n+                        .add(new PushLimitIntoTableScan(metadata))\n+                        .add(new PushPredicateIntoTableScan(metadata, typeOperators, typeAnalyzer))\n+                        .add(new PushSampleIntoTableScan(metadata))\n+                        .add(new PushAggregationIntoTableScan(metadata))\n+                        .build());\n+        builder.add(pushIntoTableScanOptimizer);\n+        builder.add(new UnaliasSymbolReferences(metadata));\n+        builder.add(pushIntoTableScanOptimizer); // TODO (https://github.com/prestosql/presto/issues/811) merge merge with the above after migrating UnaliasSymbolReferences to rules", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2MDU0MA==", "url": "https://github.com/trinodb/trino/pull/5524#discussion_r503760540", "bodyText": "merge merges? OK", "author": "findepi", "createdAt": "2020-10-13T08:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDEyMw=="}], "type": "inlineReview"}, {"oid": "936e8ffbda6307b28753ed717698302bf460bd19", "url": "https://github.com/trinodb/trino/commit/936e8ffbda6307b28753ed717698302bf460bd19", "message": "Push down aggregation with LIMIT into JDBC connectors\n\nFor a query like\n\n    SELECT k, max(v) FROM table LIMIT 5\n\nthe plan after aggregation pushdown looks like this:\n\n    - LIMIT 5\n      - Project k=k, max=generated_column\n        - TableScan producing k, generated_column\n\nThe Project prevents Limit from being pushed into the connector.\nThe `PushProjectionIntoTableScan` cannot remove the projection, because\nit can only narrow down selection of columns, it cannot do renaming\n(also, requiring connector to support _renaming_ would feel abundant).\nThe projection is not an identity projection either. It can currently be\nremoved by `UnaliasSymbolReferences` (which turns it into an identity\nprojection) + `RemoveRedundantIdentityProjections` (which removes it).\n\nThis commit adds another attempt of \"push into table scan\" optimizations\n(which already include `RemoveRedundantIdentityProjections`), preceded\nwith `UnaliasSymbolReferences`, so that the unaliasing can take place\nbetween aggregation and limit pushdown.\n\nIt is considered temporarily adequate for `UnaliasSymbolReferences` to\nbe run once. In the future we may require more invocations of\n`UnaliasSymbolReferences` + \"push into table scan\" optimization pairs.\nBetter yet, the unaliasing is either turned into optimizer rules, or\nmade redundant by other means.", "committedDate": "2020-10-13T08:32:51Z", "type": "commit"}, {"oid": "936e8ffbda6307b28753ed717698302bf460bd19", "url": "https://github.com/trinodb/trino/commit/936e8ffbda6307b28753ed717698302bf460bd19", "message": "Push down aggregation with LIMIT into JDBC connectors\n\nFor a query like\n\n    SELECT k, max(v) FROM table LIMIT 5\n\nthe plan after aggregation pushdown looks like this:\n\n    - LIMIT 5\n      - Project k=k, max=generated_column\n        - TableScan producing k, generated_column\n\nThe Project prevents Limit from being pushed into the connector.\nThe `PushProjectionIntoTableScan` cannot remove the projection, because\nit can only narrow down selection of columns, it cannot do renaming\n(also, requiring connector to support _renaming_ would feel abundant).\nThe projection is not an identity projection either. It can currently be\nremoved by `UnaliasSymbolReferences` (which turns it into an identity\nprojection) + `RemoveRedundantIdentityProjections` (which removes it).\n\nThis commit adds another attempt of \"push into table scan\" optimizations\n(which already include `RemoveRedundantIdentityProjections`), preceded\nwith `UnaliasSymbolReferences`, so that the unaliasing can take place\nbetween aggregation and limit pushdown.\n\nIt is considered temporarily adequate for `UnaliasSymbolReferences` to\nbe run once. In the future we may require more invocations of\n`UnaliasSymbolReferences` + \"push into table scan\" optimization pairs.\nBetter yet, the unaliasing is either turned into optimizer rules, or\nmade redundant by other means.", "committedDate": "2020-10-13T08:32:51Z", "type": "forcePushed"}]}