{"pr_number": 2659, "pr_title": "Fix multi-join dynamic filtering", "pr_createdAt": "2020-01-28T22:40:25Z", "pr_url": "https://github.com/trinodb/trino/pull/2659", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4ODAzOA==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372188038", "bodyText": "I think we should extend DynamicFiltersChecker to verify that there are no DFs at Join operator and add a test to TestDynamicFiltersChecker", "author": "raunaqmorarka", "createdAt": "2020-01-29T04:53:33Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/RemoveUnsupportedDynamicFilters.java", "diffHunk": "@@ -127,7 +127,7 @@ public PlanWithConsumedDynamicFilters visitJoin(JoinNode node, Set<String> allow\n                         right,\n                         node.getCriteria(),\n                         node.getOutputSymbols(),\n-                        node.getFilter(),\n+                        node.getFilter().map(this::removeAllDynamicFilters),  // no DF support at Join operators.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1ODk0Ng==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372658946", "bodyText": "Good point, fixed below.", "author": "rzeyde-varada", "createdAt": "2020-01-29T22:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4ODAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4ODczMw==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372188733", "bodyText": "Since it's a planner bug, it will be better to add the test in TestDynamicFilter instead and verify that we get expected plan there. Once DynamicFiltersChecker is extended to cover this case, that will also ensure that we don't get beyond planning stage if wrong plan is generated.", "author": "raunaqmorarka", "createdAt": "2020-01-29T04:57:05Z", "path": "presto-memory/src/test/java/io/prestosql/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -136,6 +137,25 @@ public void testJoinDynamicFilteringSingleValue()\n         assertEquals(rowsRead, ImmutableSet.of(6L, buildSideRowsCount));\n     }\n \n+    @Test\n+    public void testJoinDynamicFilteringMultiJoin()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1ODg5Ng==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372658896", "bodyText": "Sounds good - added TestDynamicFilter#testNonPushedDownJoinFilterRemoval.", "author": "rzeyde-varada", "createdAt": "2020-01-29T22:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4ODczMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NTIxOQ==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372875219", "bodyText": "Could you inline PlanMatchPattern here ? It's easier to see the plan shape when there is only one pattern to look at, similar to the other test cases", "author": "raunaqmorarka", "createdAt": "2020-01-30T10:41:00Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -259,6 +261,33 @@ public void testNestedDynamicFiltersRemoval()\n                                                         tableScan(\"orders\", ImmutableMap.of(\"ORDERS_CK27\", \"clerk\"))))), metadata)));\n     }\n \n+    @Test\n+    public void testNonPushedDownJoinFilterRemoval()\n+    {\n+        PlanMatchPattern t0 = project(node(FilterNode.class,\n+                tableScan(\"part\", ImmutableMap.of(\"K0\", \"partkey\", \"V0\", \"size\"))));\n+        PlanMatchPattern t1 = exchange(project(node(FilterNode.class,\n+                tableScan(\"part\", ImmutableMap.of(\"K1\", \"partkey\", \"V1\", \"size\")))));\n+        PlanMatchPattern t2 = exchange(project(\n+                tableScan(\"part\", ImmutableMap.of(\"K2\", \"partkey\", \"V2\", \"size\"))));\n+\n+        PlanMatchPattern join1 = join(\n+                INNER,\n+                ImmutableList.of(equiJoinClause(\"K0\", \"K1\")),\n+                t0, t1);\n+        PlanMatchPattern project1 = project(project(ImmutableMap.of(\"S\", expression(\"V0 + V1\")), join1));\n+        PlanMatchPattern join2 = join(\n+                INNER,\n+                ImmutableList.of(equiJoinClause(\"K0\", \"K2\"), equiJoinClause(\"S\", \"V2\")),\n+                project1, t2);\n+        PlanMatchPattern matcher = anyTree(project(join2));\n+\n+        assertPlan(\"SELECT 1 FROM part t0, part t1, part t2 \" +\n+                        \"WHERE t0.partkey = t1.partkey AND t0.partkey = t2.partkey \" +\n+                        \"AND t0.size + t1.size = t2.size\",\n+                noJoinReordering(), matcher);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4NTY2NQ==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372985665", "bodyText": "You're right, fixed.", "author": "rzeyde-varada", "createdAt": "2020-01-30T14:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NTIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3ODY3Ng==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372878676", "bodyText": "I would use:\n.filter(expression -> !expression.equals(TRUE_LITERAL))\n\ninstead.", "author": "sopel39", "createdAt": "2020-01-30T10:48:14Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/RemoveUnsupportedDynamicFilters.java", "diffHunk": "@@ -120,14 +121,17 @@ public PlanWithConsumedDynamicFilters visitJoin(JoinNode node, Set<String> allow\n             PlanNode left = leftResult.getNode();\n             PlanNode right = rightResult.getNode();\n             if (!left.equals(node.getLeft()) || !right.equals(node.getRight()) || !dynamicFilters.equals(node.getDynamicFilters())) {\n+                Optional<Expression> filter = node\n+                        .getFilter().map(this::removeAllDynamicFilters)  // no DF support at Join operators.\n+                        .flatMap(expression -> expression.equals(TRUE_LITERAL) ? Optional.empty() : Optional.of(expression));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4NzQ1OA==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372987458", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2020-01-30T14:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3ODY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4MDAyNw==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372880027", "bodyText": "put this in new line", "author": "sopel39", "createdAt": "2020-01-30T10:51:01Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -259,6 +261,33 @@ public void testNestedDynamicFiltersRemoval()\n                                                         tableScan(\"orders\", ImmutableMap.of(\"ORDERS_CK27\", \"clerk\"))))), metadata)));\n     }\n \n+    @Test\n+    public void testNonPushedDownJoinFilterRemoval()\n+    {\n+        PlanMatchPattern t0 = project(node(FilterNode.class,\n+                tableScan(\"part\", ImmutableMap.of(\"K0\", \"partkey\", \"V0\", \"size\"))));\n+        PlanMatchPattern t1 = exchange(project(node(FilterNode.class,\n+                tableScan(\"part\", ImmutableMap.of(\"K1\", \"partkey\", \"V1\", \"size\")))));\n+        PlanMatchPattern t2 = exchange(project(\n+                tableScan(\"part\", ImmutableMap.of(\"K2\", \"partkey\", \"V2\", \"size\"))));\n+\n+        PlanMatchPattern join1 = join(\n+                INNER,\n+                ImmutableList.of(equiJoinClause(\"K0\", \"K1\")),\n+                t0, t1);\n+        PlanMatchPattern project1 = project(project(ImmutableMap.of(\"S\", expression(\"V0 + V1\")), join1));\n+        PlanMatchPattern join2 = join(\n+                INNER,\n+                ImmutableList.of(equiJoinClause(\"K0\", \"K2\"), equiJoinClause(\"S\", \"V2\")),\n+                project1, t2);\n+        PlanMatchPattern matcher = anyTree(project(join2));\n+\n+        assertPlan(\"SELECT 1 FROM part t0, part t1, part t2 \" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4NTgxOQ==", "url": "https://github.com/trinodb/trino/pull/2659#discussion_r372985819", "bodyText": "Done.", "author": "rzeyde-varada", "createdAt": "2020-01-30T14:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4MDAyNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "601b0693e8e3212c76023c6970a8dc6def06721c", "url": "https://github.com/trinodb/trino/commit/601b0693e8e3212c76023c6970a8dc6def06721c", "message": "Fix multi-join dynamic filtering", "committedDate": "2020-01-31T07:54:52Z", "type": "commit"}, {"oid": "601b0693e8e3212c76023c6970a8dc6def06721c", "url": "https://github.com/trinodb/trino/commit/601b0693e8e3212c76023c6970a8dc6def06721c", "message": "Fix multi-join dynamic filtering", "committedDate": "2020-01-31T07:54:52Z", "type": "forcePushed"}]}