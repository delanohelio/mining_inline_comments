{"pr_number": 3290, "pr_title": "Add access control check while listing views", "pr_createdAt": "2020-03-31T10:16:57Z", "pr_url": "https://github.com/trinodb/trino/pull/3290", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwMTg4Mg==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400801882", "bodyText": "inline createView", "author": "kokosing", "createdAt": "2020-03-31T10:21:11Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4733,6 +4734,39 @@ public void testShowColumnMetadata()\n         assertUpdate(\"DROP TABLE \" + tableName);\n     }\n \n+    @Test\n+    public void testShowViews()\n+    {\n+        String viewName = \"test_show_views\";\n+\n+        @Language(\"SQL\") String createView = \"CREATE VIEW \" + viewName + \" AS SELECT abs(1) as whatever\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwMzA5MA==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400803090", "bodyText": "format(\"... WHERE table_name = '%s', viewName)", "author": "kokosing", "createdAt": "2020-03-31T10:23:10Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4733,6 +4734,39 @@ public void testShowColumnMetadata()\n         assertUpdate(\"DROP TABLE \" + tableName);\n     }\n \n+    @Test\n+    public void testShowViews()\n+    {\n+        String viewName = \"test_show_views\";\n+\n+        @Language(\"SQL\") String createView = \"CREATE VIEW \" + viewName + \" AS SELECT abs(1) as whatever\";\n+\n+        Session testSession = testSessionBuilder()\n+                .setIdentity(Identity.ofUser(\"test_view_access_owner\"))\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(getSession().getSchema().get())\n+                .build();\n+\n+        assertUpdate(createView);\n+        try {\n+            String showViews = \"SELECT * FROM information_schema.views\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwMzUwMw==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400803503", "bodyText": "I would remove this try-finally block. View name is unique and no other test should depend that there is no view in the system.", "author": "kokosing", "createdAt": "2020-03-31T10:23:49Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4733,6 +4734,39 @@ public void testShowColumnMetadata()\n         assertUpdate(\"DROP TABLE \" + tableName);\n     }\n \n+    @Test\n+    public void testShowViews()\n+    {\n+        String viewName = \"test_show_views\";\n+\n+        @Language(\"SQL\") String createView = \"CREATE VIEW \" + viewName + \" AS SELECT abs(1) as whatever\";\n+\n+        Session testSession = testSessionBuilder()\n+                .setIdentity(Identity.ofUser(\"test_view_access_owner\"))\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(getSession().getSchema().get())\n+                .build();\n+\n+        assertUpdate(createView);\n+        try {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwNDAwMw==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400804003", "bodyText": "inline views", "author": "kokosing", "createdAt": "2020-03-31T10:24:38Z", "path": "presto-main/src/main/java/io/prestosql/connector/informationschema/InformationSchemaPageSource.java", "diffHunk": "@@ -288,11 +288,13 @@ private void addTablesRecords(QualifiedTablePrefix prefix)\n \n     private void addViewsRecords(QualifiedTablePrefix prefix)\n     {\n-        for (Map.Entry<QualifiedObjectName, ConnectorViewDefinition> entry : metadata.getViews(session, prefix).entrySet()) {\n+        Map<SchemaTableName, ConnectorViewDefinition> views = getViews(session, metadata, accessControl, prefix);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwNTYzMQ==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400805631", "bodyText": "I don't think listViews should depend on getViews. Notice that you changed the metadata.listViews(...) to metadata.getViews(...). These method could be implemented completely different (one could be cheap and other expensive to call). One only list objects, while the other retrieves all info about them.", "author": "kokosing", "createdAt": "2020-03-31T10:27:30Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataListing.java", "diffHunk": "@@ -69,10 +70,23 @@ private MetadataListing() {}\n \n     public static Set<SchemaTableName> listViews(Session session, Metadata metadata, AccessControl accessControl, QualifiedTablePrefix prefix)\n     {\n-        Set<SchemaTableName> tableNames = metadata.listViews(session, prefix).stream()\n-                .map(QualifiedObjectName::asSchemaTableName)\n-                .collect(toImmutableSet());\n-        return accessControl.filterTables(session.toSecurityContext(), prefix.getCatalogName(), tableNames);\n+        return getViews(session, metadata, accessControl, prefix).keySet();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwNTg5OQ==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400805899", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Map<SchemaTableName, ConnectorViewDefinition> views =\n          \n          \n            \n                            metadata.getViews(session, prefix).entrySet().stream()\n          \n          \n            \n                                    .collect(toImmutableMap(entry -> entry.getKey().asSchemaTableName(), Entry::getValue));\n          \n          \n            \n                    Map<SchemaTableName, ConnectorViewDefinition> views =  metadata.getViews(session, prefix).entrySet().stream()\n          \n          \n            \n                                    .collect(toImmutableMap(entry -> entry.getKey().asSchemaTableName(), Entry::getValue));", "author": "kokosing", "createdAt": "2020-03-31T10:28:01Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataListing.java", "diffHunk": "@@ -69,10 +70,23 @@ private MetadataListing() {}\n \n     public static Set<SchemaTableName> listViews(Session session, Metadata metadata, AccessControl accessControl, QualifiedTablePrefix prefix)\n     {\n-        Set<SchemaTableName> tableNames = metadata.listViews(session, prefix).stream()\n-                .map(QualifiedObjectName::asSchemaTableName)\n-                .collect(toImmutableSet());\n-        return accessControl.filterTables(session.toSecurityContext(), prefix.getCatalogName(), tableNames);\n+        return getViews(session, metadata, accessControl, prefix).keySet();\n+    }\n+\n+    public static Map<SchemaTableName, ConnectorViewDefinition> getViews(Session session, Metadata metadata, AccessControl accessControl, QualifiedTablePrefix prefix)\n+    {\n+        Map<SchemaTableName, ConnectorViewDefinition> views =\n+                metadata.getViews(session, prefix).entrySet().stream()\n+                        .collect(toImmutableMap(entry -> entry.getKey().asSchemaTableName(), Entry::getValue));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwNjMwMQ==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400806301", "bodyText": "I don't think you need to break parameters in separate lines, the line is should not be very long", "author": "kokosing", "createdAt": "2020-03-31T10:28:45Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataListing.java", "diffHunk": "@@ -69,10 +70,23 @@ private MetadataListing() {}\n \n     public static Set<SchemaTableName> listViews(Session session, Metadata metadata, AccessControl accessControl, QualifiedTablePrefix prefix)\n     {\n-        Set<SchemaTableName> tableNames = metadata.listViews(session, prefix).stream()\n-                .map(QualifiedObjectName::asSchemaTableName)\n-                .collect(toImmutableSet());\n-        return accessControl.filterTables(session.toSecurityContext(), prefix.getCatalogName(), tableNames);\n+        return getViews(session, metadata, accessControl, prefix).keySet();\n+    }\n+\n+    public static Map<SchemaTableName, ConnectorViewDefinition> getViews(Session session, Metadata metadata, AccessControl accessControl, QualifiedTablePrefix prefix)\n+    {\n+        Map<SchemaTableName, ConnectorViewDefinition> views =\n+                metadata.getViews(session, prefix).entrySet().stream()\n+                        .collect(toImmutableMap(entry -> entry.getKey().asSchemaTableName(), Entry::getValue));\n+\n+        Set<SchemaTableName> accessible = accessControl.filterTables(\n+                session.toSecurityContext(),\n+                prefix.getCatalogName(),\n+                views.keySet());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwODM1NQ==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400808355", "bodyText": "I don't think you should use denyPrivileges here. This case is very different. Notice how filterCatalogs is implemented and follow same pattern.", "author": "kokosing", "createdAt": "2020-03-31T10:32:10Z", "path": "presto-main/src/main/java/io/prestosql/testing/TestingAccessControlManager.java", "diffHunk": "@@ -514,6 +516,18 @@ public void checkCanExecuteFunction(SecurityContext context, String functionName\n         return super.getColumnMasks(context, tableName, column, type);\n     }\n \n+    @Override\n+    public Set<SchemaTableName> filterTables(SecurityContext context, String catalogName, Set<SchemaTableName> tableNames)\n+    {\n+        if (shouldDenyPrivilege(context.getIdentity().getUser(), catalogName, FILTER_TABLES)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg1NjEwNw==", "url": "https://github.com/trinodb/trino/pull/3290#discussion_r400856107", "bodyText": "assertQuery(\n      format(\"SELECT table_name FROM information_schema.views WHERE table_name = '%s'\", viewName),\n      format(\"VALUES '%s'\", viewName)); \n\nor\nassertQuery(\n      format(\"SELECT count(*) FROM information_schema.views WHERE table_name = '%s'\", viewName),\n      \"VALUES 1\");", "author": "kokosing", "createdAt": "2020-03-31T12:01:24Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4733,6 +4733,35 @@ public void testShowColumnMetadata()\n         assertUpdate(\"DROP TABLE \" + tableName);\n     }\n \n+    @Test\n+    public void testShowViews()\n+    {\n+        String viewName = \"test_show_views\";\n+\n+        Session testSession = testSessionBuilder()\n+                .setIdentity(Identity.ofUser(\"test_view_access_owner\"))\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(getSession().getSchema().get())\n+                .build();\n+\n+        assertUpdate(\"CREATE VIEW \" + viewName + \" AS SELECT abs(1) as whatever\");\n+\n+        String showViews = format(\"SELECT * FROM information_schema.views WHERE table_name = '%s'\", viewName);\n+        assertEquals(1, computeActual(showViews).getRowCount());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "1909afcae120f9407750823fdfce8505aff4bd73", "url": "https://github.com/trinodb/trino/commit/1909afcae120f9407750823fdfce8505aff4bd73", "message": "Add access control check while listing views", "committedDate": "2020-04-01T12:40:19Z", "type": "commit"}, {"oid": "1909afcae120f9407750823fdfce8505aff4bd73", "url": "https://github.com/trinodb/trino/commit/1909afcae120f9407750823fdfce8505aff4bd73", "message": "Add access control check while listing views", "committedDate": "2020-04-01T12:40:19Z", "type": "forcePushed"}]}