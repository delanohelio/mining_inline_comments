{"pr_number": 5362, "pr_title": "Harden environment startup", "pr_createdAt": "2020-09-30T14:02:06Z", "pr_url": "https://github.com/trinodb/trino/pull/5362", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0ODI3NQ==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497548275", "bodyText": "Add a comment why we want to do extra check here", "author": "losipiuk", "createdAt": "2020-09-30T14:19:49Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -131,6 +131,11 @@ private Environment tryStart()\n             }\n \n             Startables.deepStart(containers).get();\n+            if (!allContainersHealthy(containers)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MDA1MA==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497550050", "bodyText": "parameter naming does not make it obvious which container depends on which.\nMaybe name container and dependencyContainer?", "author": "losipiuk", "createdAt": "2020-09-30T14:22:11Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -322,6 +322,15 @@ public String getEnvironmentName()\n             return name;\n         }\n \n+        public Builder containerDependsOn(String container, String otherContainer)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MzUyNw==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497553527", "bodyText": "Also instead we could maybe add getContainer method to builder and go with:\n        builder.addContainers(createZookeeper(), createKafka())\n                .configureContainer(\"kafka\", kafkaContainer -> kafkaContainer.dependsOn(builder.getContainer(\"zookeeper\")));\nBut I think helper method is nice", "author": "losipiuk", "createdAt": "2020-09-30T14:26:32Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -322,6 +322,15 @@ public String getEnvironmentName()\n             return name;\n         }\n \n+        public Builder containerDependsOn(String container, String otherContainer)\n+        {\n+            checkState(containers.containsKey(container), \"Container with name %s is not registered\", name);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NzgwOA==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497567808", "bodyText": "That was my initial thought. I dont't know if builder should have get method though (what's your take on that?)", "author": "wendigo", "createdAt": "2020-09-30T14:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MzUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3ODY1Mw==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497578653", "bodyText": "I would not object if there are more cases when that would be useful.\nBut the helper method you added is fine too. And it does checkState calls which would make the configureContainer bloated.", "author": "losipiuk", "createdAt": "2020-09-30T14:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MzUyNw=="}], "type": "inlineReview"}, {"oid": "4144e88968d96e35125f8dea2cf4c9c5b9104f1e", "url": "https://github.com/trinodb/trino/commit/4144e88968d96e35125f8dea2cf4c9c5b9104f1e", "message": "Check environment health before waiting for test completion", "committedDate": "2020-09-30T15:44:06Z", "type": "commit"}, {"oid": "e609d78773d2ef97ed3d508b1bc467f48f752559", "url": "https://github.com/trinodb/trino/commit/e609d78773d2ef97ed3d508b1bc467f48f752559", "message": "Allow establishing docker container startup dependency", "committedDate": "2020-09-30T15:50:39Z", "type": "commit"}, {"oid": "a3cc11a5a2a9745887cb97912f0bb95e3050d032", "url": "https://github.com/trinodb/trino/commit/a3cc11a5a2a9745887cb97912f0bb95e3050d032", "message": "Remove unused methods", "committedDate": "2020-09-30T15:50:39Z", "type": "commit"}, {"oid": "e9bd045fa74477dfe08f22103d2c7865250a308c", "url": "https://github.com/trinodb/trino/commit/e9bd045fa74477dfe08f22103d2c7865250a308c", "message": "Simplify container dependency", "committedDate": "2020-09-30T15:50:39Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNDM0MA==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497624340", "bodyText": "make it simple for loop", "author": "losipiuk", "createdAt": "2020-09-30T15:59:04Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -284,6 +286,14 @@ public void copyLogsToHostPath(Path hostPath)\n         return statistics.get();\n     }\n \n+    public DockerContainer waitingForAll(WaitStrategy... strategies)\n+    {\n+        WaitAllStrategy strategy = new WaitAllStrategy();\n+        Arrays.stream(strategies).forEach(strategy::withStrategy);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNTQ1MQ==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497625451", "bodyText": "you are adding forHealthCheck() here. SHould be separate commit.", "author": "losipiuk", "createdAt": "2020-09-30T16:00:31Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/Hadoop.java", "diffHunk": "@@ -98,7 +99,7 @@ public static DockerContainer createHadoopContainer(DockerFiles dockerFiles, Str\n                 .withCommand(\"/usr/local/hadoop-run.sh\")\n                 .withExposedLogPaths(\"/var/log/hadoop-yarn\", \"/var/log/hadoop-hdfs\", \"/var/log/hive\", \"/var/log/container-health.log\")\n                 .withStartupCheckStrategy(new IsRunningStartupCheckStrategy())\n-                .waitingFor(new SelectedPortWaitStrategy(10000)) // HiveServer2\n+                .waitingForAll(forSelectedPorts(10000), forHealthcheck()) // HiveServer2", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNTYyMg==", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497625622", "bodyText": "same here", "author": "losipiuk", "createdAt": "2020-09-30T16:00:46Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/Standard.java", "diffHunk": "@@ -125,7 +126,7 @@ public static DockerContainer createPrestoContainer(DockerFiles dockerFiles, Fil\n                 .withFileSystemBind(serverPackage.getPath(), \"/docker/presto-server.tar.gz\", READ_ONLY)\n                 .withCommand(\"/docker/presto-product-tests/run-presto.sh\")\n                 .withStartupCheckStrategy(new IsRunningStartupCheckStrategy())\n-                .waitingFor(Wait.forLogMessage(\".*======== SERVER STARTED ========.*\", 1))\n+                .waitingForAll(forLogMessage(\".*======== SERVER STARTED ========.*\", 1), forHealthcheck())", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "c9ca5364cc8f6a32f9e2cc89ca68d95ba33eb955", "url": "https://github.com/trinodb/trino/commit/c9ca5364cc8f6a32f9e2cc89ca68d95ba33eb955", "message": "Configure Kafka waitStrategy", "committedDate": "2020-09-30T16:04:48Z", "type": "commit"}, {"oid": "1ebe6939229fc871d703b097ecc8b335adc9f5a9", "url": "https://github.com/trinodb/trino/commit/1ebe6939229fc871d703b097ecc8b335adc9f5a9", "message": "Use static forLogMessage", "committedDate": "2020-09-30T16:04:48Z", "type": "commit"}, {"oid": "f42dad246a0b1a8301901f7da22789a1652c6c37", "url": "https://github.com/trinodb/trino/commit/f42dad246a0b1a8301901f7da22789a1652c6c37", "message": "Use forSelectedPorts utility method", "committedDate": "2020-09-30T16:04:48Z", "type": "commit"}, {"oid": "cc1498492a6eb6d4aa1c4f22eb222cb92b38f487", "url": "https://github.com/trinodb/trino/commit/cc1498492a6eb6d4aa1c4f22eb222cb92b38f487", "message": "Wait for containers healthcheck", "committedDate": "2020-09-30T16:04:49Z", "type": "commit"}, {"oid": "50b9f49af423ea199ea077ed2519dbb02b399452", "url": "https://github.com/trinodb/trino/commit/50b9f49af423ea199ea077ed2519dbb02b399452", "message": "Reuse Hadoop container definition in two-mixed-hives environment", "committedDate": "2020-09-30T16:04:49Z", "type": "commit"}, {"oid": "adce65329c7d5577c20db7e259a367650a357c25", "url": "https://github.com/trinodb/trino/commit/adce65329c7d5577c20db7e259a367650a357c25", "message": "Move and clarify container reset", "committedDate": "2020-09-30T16:04:49Z", "type": "commit"}, {"oid": "adce65329c7d5577c20db7e259a367650a357c25", "url": "https://github.com/trinodb/trino/commit/adce65329c7d5577c20db7e259a367650a357c25", "message": "Move and clarify container reset", "committedDate": "2020-09-30T16:04:49Z", "type": "forcePushed"}]}