{"pr_number": 4999, "pr_title": "Allow to configure insert into Hive partition via configuration property", "pr_createdAt": "2020-08-27T14:33:22Z", "pr_url": "https://github.com/trinodb/trino/pull/4999", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxNDIwNg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r478614206", "bodyText": "Please change commit message to:\nAllow to configure insert into Hive partition via configuration property\n\nNo need for anything more than that. Please do not mention internal references to issue tracking system.", "author": "kokosing", "createdAt": "2020-08-27T18:28:01Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -26,6 +26,7 @@\n import org.joda.time.DateTimeZone;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxNDMyNA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r478614324", "bodyText": "Please use enum.\nSee how hiveCompressionCodec is implemented above.\nBy default it should be set to APPEND", "author": "kokosing", "createdAt": "2020-08-27T18:28:15Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -79,6 +80,7 @@\n     private HiveCompressionCodec hiveCompressionCodec = HiveCompressionCodec.GZIP;\n     private boolean respectTableFormat = true;\n     private boolean immutablePartitions;\n+    private String insertExistingPartitionsBehavior;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM4NjQzNg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479386436", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-08-28T15:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxNDMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxNzQ1Nw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r478617457", "bodyText": "Please remove immutablePartitions, notice that it has to be then added to @DefunctConfig at the top of the class, so it raise proper error message when some uses it.\nimmutablePartitions usage should be now replaced with the new property.\nPlease update TestHiveConfig", "author": "kokosing", "createdAt": "2020-08-27T18:34:10Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -79,6 +80,7 @@\n     private HiveCompressionCodec hiveCompressionCodec = HiveCompressionCodec.GZIP;\n     private boolean respectTableFormat = true;\n     private boolean immutablePartitions;\n+    private String insertExistingPartitionsBehavior;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMyODU1Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479328553", "bodyText": "immutablePartitions=true is used to prohibit to set insertExistingPartitionsBehavior to OVERWRITE via session properties. insertExistingPartitionsBehavior is not a superset of immutablePartitions. So I will left it.\nTestHiveConfig is updated.", "author": "ssheikin", "createdAt": "2020-08-28T14:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxNzQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxODI4Ng==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r478618286", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (defaultValue.isEmpty()) {return immutable ? ERROR : APPEND;}\n          \n          \n            \n                        if (defaultValue.isEmpty()) {\n          \n          \n            \n                            return immutable ? ERROR : APPEND;\n          \n          \n            \n                        }\n          \n      \n    \n    \n  \n\nWe do not fold if statements. The only exception is empty method like:\nvoid method() {}\n\nOtherwise we always put curly brackets into separate lines.", "author": "kokosing", "createdAt": "2020-08-27T18:35:42Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -110,6 +111,14 @@ public static InsertExistingPartitionsBehavior valueOf(String value, boolean imm\n \n             return enumValue;\n         }\n+\n+        public static InsertExistingPartitionsBehavior getDefaultValue(HiveConfig hiveConfig)\n+        {\n+            boolean immutable = hiveConfig.isImmutablePartitions();\n+            Optional<String> defaultValue = hiveConfig.getInsertExistingPartitionsBehavior();\n+            if (defaultValue.isEmpty()) {return immutable ? ERROR : APPEND;}", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwMTkxNQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479301915", "bodyText": "I hope this PR will be accepted: airlift/codestyle#12", "author": "ssheikin", "createdAt": "2020-08-28T13:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxODI4Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ2OTM3MA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479469370", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void init()\n          \n          \n            \n                {\n          \n          \n            \n                    verifyDefaultValueForInsertExistingPartitionsBehaviorCouldBeAssigned();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public void verifyDefaultValueForInsertExistingPartitionsBehaviorCouldBeAssigned()\n          \n          \n            \n                {\n          \n          \n            \n                    verifyAndGet(insertExistingPartitionsBehavior, immutablePartitions);\n          \n          \n            \n                }\n          \n          \n            \n                public void validate()\n          \n          \n            \n                {\n          \n          \n            \n                            InsertExistingPartitionsBehavior.validate(...);\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nPlease add tests for that. See io.prestosql.plugin.hive.TestHiveHadoop2Plugin#testGcsAccessTokenAndHiveCachingMutuallyExclusive", "author": "kokosing", "createdAt": "2020-08-28T18:28:32Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -977,4 +995,15 @@ public HiveConfig setProjectionPushdownEnabled(boolean projectionPushdownEnabled\n         this.projectionPushdownEnabled = projectionPushdownEnabled;\n         return this;\n     }\n+\n+    @PostConstruct\n+    public void init()\n+    {\n+        verifyDefaultValueForInsertExistingPartitionsBehaviorCouldBeAssigned();\n+    }\n+\n+    public void verifyDefaultValueForInsertExistingPartitionsBehaviorCouldBeAssigned()\n+    {\n+        verifyAndGet(insertExistingPartitionsBehavior, immutablePartitions);\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzNjc5NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479936795", "bodyText": "I've added additional function to describe in it's name why do we need @PostConstruct at all. You think it worth to keep code as simple as possible without this explanation?", "author": "ssheikin", "createdAt": "2020-08-31T07:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ2OTM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk1NTExMA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479955110", "bodyText": "You think it worth to keep code as simple as possible\n\nNo. However in this case it is self-explanatory.", "author": "kokosing", "createdAt": "2020-08-31T07:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ2OTM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0Mjk5NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r480042995", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-08-31T10:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ2OTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MTk2NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479471965", "bodyText": "verifyAndGet is not needed here. It is already checked in getInsertExistingPartitionsBehavior", "author": "kokosing", "createdAt": "2020-08-28T18:34:32Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -200,10 +202,7 @@ public HiveWriterFactory(\n         this.sortedWritingTempStagingPathEnabled = isTemporaryStagingDirectoryEnabled(session);\n         this.sortedWritingTempStagingPath = getTemporaryStagingDirectoryPath(session);\n         this.immutablePartitions = immutablePartitions;\n-        this.insertExistingPartitionsBehavior = HiveSessionProperties.getInsertExistingPartitionsBehavior(session);\n-        if (immutablePartitions) {\n-            checkArgument(insertExistingPartitionsBehavior != InsertExistingPartitionsBehavior.APPEND, \"insertExistingPartitionsBehavior cannot be APPEND\");\n-        }\n+        this.insertExistingPartitionsBehavior = verifyAndGet(getInsertExistingPartitionsBehavior(session), immutablePartitions);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzNDE3MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479934171", "bodyText": "I believe that it should be checked by decoder, however I'm not sure. I thought that removing this code could be too invasive. In case it could be deleted I'd remove other checks in code checkState(!immutablePartitions);\nWhat do you think?", "author": "ssheikin", "createdAt": "2020-08-31T07:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0NzE2MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r480047161", "bodyText": "Ok, verifyAndGet removed. checkState(!immutablePartitions); removed as well.", "author": "ssheikin", "createdAt": "2020-08-31T10:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MzI5MA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479473290", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static InsertExistingPartitionsBehavior verifyAndGet(InsertExistingPartitionsBehavior value, boolean immutable)\n          \n          \n            \n                    public static void validate(InsertExistingPartitionsBehavior value, boolean immutablePartition)", "author": "kokosing", "createdAt": "2020-08-28T18:37:29Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -101,14 +99,21 @@\n         OVERWRITE,\n         /**/;\n \n-        public static InsertExistingPartitionsBehavior valueOf(String value, boolean immutablePartition)\n+        public static InsertExistingPartitionsBehavior decode(String value, HiveConfig hiveConfig)\n         {\n             InsertExistingPartitionsBehavior enumValue = valueOf(value.toUpperCase(ENGLISH));\n-            if (immutablePartition) {\n-                checkArgument(enumValue != APPEND, \"Presto is configured to treat Hive partitions as immutable. %s is not allowed to be set to %s\", INSERT_EXISTING_PARTITIONS_BEHAVIOR, APPEND);\n-            }\n+            return verifyAndGet(enumValue, hiveConfig.isImmutablePartitions());\n+        }\n \n-            return enumValue;\n+        public static InsertExistingPartitionsBehavior getDefaultValue(HiveConfig hiveConfig)\n+        {\n+            return verifyAndGet(hiveConfig.getInsertExistingPartitionsBehavior(), hiveConfig.isImmutablePartitions());\n+        }\n+\n+        public static InsertExistingPartitionsBehavior verifyAndGet(InsertExistingPartitionsBehavior value, boolean immutable)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA1NzI2NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r480057265", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-08-31T11:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MzI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Mzc1Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479473753", "bodyText": "please do not rename", "author": "kokosing", "createdAt": "2020-08-28T18:38:27Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -101,14 +99,21 @@\n         OVERWRITE,\n         /**/;\n \n-        public static InsertExistingPartitionsBehavior valueOf(String value, boolean immutablePartition)\n+        public static InsertExistingPartitionsBehavior decode(String value, HiveConfig hiveConfig)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMDY3NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479930675", "bodyText": "actually I thought about it as narrow functionality used in some other place to decode enum. I believe that this functionality is never will be used in other places with explicit immutablePartition parameter.", "author": "ssheikin", "createdAt": "2020-08-31T06:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Mzc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA1Njk1Ng==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r480056956", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-08-31T11:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Mzc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Mzg5Mg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479473892", "bodyText": "please inline this method", "author": "kokosing", "createdAt": "2020-08-28T18:38:48Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -101,14 +99,21 @@\n         OVERWRITE,\n         /**/;\n \n-        public static InsertExistingPartitionsBehavior valueOf(String value, boolean immutablePartition)\n+        public static InsertExistingPartitionsBehavior decode(String value, HiveConfig hiveConfig)\n         {\n             InsertExistingPartitionsBehavior enumValue = valueOf(value.toUpperCase(ENGLISH));\n-            if (immutablePartition) {\n-                checkArgument(enumValue != APPEND, \"Presto is configured to treat Hive partitions as immutable. %s is not allowed to be set to %s\", INSERT_EXISTING_PARTITIONS_BEHAVIOR, APPEND);\n-            }\n+            return verifyAndGet(enumValue, hiveConfig.isImmutablePartitions());\n+        }\n \n-            return enumValue;\n+        public static InsertExistingPartitionsBehavior getDefaultValue(HiveConfig hiveConfig)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyOTM2NA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479929364", "bodyText": "My intention was to keep logic related to InsertExistingPartitionsBehavior property inside one class. What do you think?", "author": "ssheikin", "createdAt": "2020-08-31T06:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Mzg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2NTI3NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r479965275", "bodyText": "please inline", "author": "kokosing", "createdAt": "2020-08-31T08:05:48Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -136,9 +141,9 @@ public HiveSessionProperties(\n                         \"Behavior on insert existing partitions; this session property doesn't control behavior on insert existing unpartitioned table\",\n                         VARCHAR,\n                         InsertExistingPartitionsBehavior.class,\n-                        hiveConfig.isImmutablePartitions() ? ERROR : APPEND,\n+                        InsertExistingPartitionsBehavior.getDefaultValue(hiveConfig),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA1NzM5MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r480057391", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-08-31T11:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2NTI3NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTk1MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481989951", "bodyText": "Please mention other possible values. Also you could shortly explain what each of these options mean.", "author": "kokosing", "createdAt": "2020-09-02T11:14:36Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -216,6 +216,8 @@ Property Name                                      Description\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n \n+``hive.insert-existing-partitions-behavior``       Default value for insert existing partitions behavior.       ``APPEND``", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3OTI2NA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r483579264", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-04T12:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDE0MA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481990140", "bodyText": "shutdown won't be called anyway.", "author": "kokosing", "createdAt": "2020-09-02T11:14:56Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveHadoop2Plugin.java", "diffHunk": "@@ -99,6 +99,24 @@ public void testGcsAccessTokenAndHiveCachingMutuallyExclusive()\n                 .hasMessageContaining(\"Use of GCS access token is not compatible with Hive caching\");\n     }\n \n+    @Test\n+    public void testImmutablePartitionsAndInsertOverwriteMutuallyExclusive()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        assertThatThrownBy(() -> connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.insert-existing-partitions-behavior\", \"APPEND\")\n+                        .put(\"hive.immutable-partitions\", \"true\")\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext())\n+                .shutdown())", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0OTI5NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r483549295", "bodyText": "Thank you for the info. I'll left it as is to be consistent with other places.", "author": "ssheikin", "createdAt": "2020-09-04T11:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MzQ0OA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r483563448", "bodyText": "Please don't. It may suggest that exception is thrown by shutdown method.", "author": "kokosing", "createdAt": "2020-09-04T11:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MDk1NA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488670954", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-15T13:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDg5Nw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481990897", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.insertExistingPartitionsBehavior = insertExistingPartitionsBehavior;\n          \n          \n            \n                    this.insertExistingPartitionsBehavior = requireNonNull(insertExistingPartitionsBehavior, \"insertExistingPartitionsBehavior is null\");", "author": "kokosing", "createdAt": "2020-09-02T11:16:28Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -451,6 +455,19 @@ public HiveConfig setImmutablePartitions(boolean immutablePartitions)\n         return this;\n     }\n \n+    public InsertExistingPartitionsBehavior getInsertExistingPartitionsBehavior()\n+    {\n+        return insertExistingPartitionsBehavior;\n+    }\n+\n+    @Config(\"hive.insert-existing-partitions-behavior\")\n+    @ConfigDescription(\"Default value for insert existing partitions behavior\")\n+    public HiveConfig setInsertExistingPartitionsBehavior(InsertExistingPartitionsBehavior insertExistingPartitionsBehavior)\n+    {\n+        this.insertExistingPartitionsBehavior = insertExistingPartitionsBehavior;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzAwMA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482877000", "bodyText": "I don't see how this enum value could be set to null.\nIn my opinion it is set by airlift and in case there no such property in config file method never will be invoked, otherwise only correct enum value will be assigned.", "author": "ssheikin", "createdAt": "2020-09-03T10:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4MzAzOQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482883039", "bodyText": "Usually we don't see how null are passed until the moment when we get NPE. It is yet another defensive programming. airlift can have bugs, we want to catch them as soon as possible.", "author": "kokosing", "createdAt": "2020-09-03T10:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2OTQ0Ng==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r483569446", "bodyText": "Nevertheless I don't think it worth to check NPE here, but I've applied your suggestion.", "author": "ssheikin", "createdAt": "2020-09-04T11:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTgyNA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481991824", "bodyText": "undo, this is just defensive programming.", "author": "kokosing", "createdAt": "2020-09-02T11:18:17Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -353,7 +348,6 @@ public HiveWriter createWriter(Page partitionColumns, int position, OptionalInt\n                 else {\n                     switch (insertExistingPartitionsBehavior) {\n                         case APPEND:\n-                            checkState(!immutablePartitions);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzNjk5NA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482836994", "bodyText": "I believe this is not good idea to pass immutablePartitions variable through 2 classes just to check it here.\nWill not undo.", "author": "ssheikin", "createdAt": "2020-09-03T09:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTg0MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481991841", "bodyText": "undo, this is just defensive programming.", "author": "kokosing", "createdAt": "2020-09-02T11:18:19Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -384,7 +378,6 @@ public HiveWriter createWriter(Page partitionColumns, int position, OptionalInt\n             // Write to: an existing partition in an existing partitioned table\n             if (insertExistingPartitionsBehavior == InsertExistingPartitionsBehavior.APPEND) {\n                 // Append to an existing partition\n-                checkState(!immutablePartitions);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzNjkwNA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482836904", "bodyText": "I believe this is not good idea to pass immutablePartitions variable through 2 classes just to check it here.\nWill not undo.", "author": "ssheikin", "createdAt": "2020-09-03T09:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3Mjc0Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482872743", "bodyText": "Please then extract it to separate commit.", "author": "kokosing", "createdAt": "2020-09-03T10:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjQwNQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r481992405", "bodyText": "do we call validate in getInsertExistingPartitionsBehavior? if not then we should", "author": "kokosing", "createdAt": "2020-09-02T11:19:22Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -199,11 +198,7 @@ public HiveWriterFactory(\n         this.maxOpenSortFiles = maxOpenSortFiles;\n         this.sortedWritingTempStagingPathEnabled = isTemporaryStagingDirectoryEnabled(session);\n         this.sortedWritingTempStagingPath = getTemporaryStagingDirectoryPath(session);\n-        this.immutablePartitions = immutablePartitions;\n-        this.insertExistingPartitionsBehavior = HiveSessionProperties.getInsertExistingPartitionsBehavior(session);\n-        if (immutablePartitions) {\n-            checkArgument(insertExistingPartitionsBehavior != InsertExistingPartitionsBehavior.APPEND, \"insertExistingPartitionsBehavior cannot be APPEND\");\n-        }\n+        this.insertExistingPartitionsBehavior = getInsertExistingPartitionsBehavior(session);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0NDE2Nw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482044167", "bodyText": "@kokosing could you please check this conversation?\n#4999 (comment)\nI'd be glad to hear your opinion about it.", "author": "ssheikin", "createdAt": "2020-09-02T12:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482155000", "bodyText": "Will we deprecate immutable partitions property?", "author": "findepi", "createdAt": "2020-09-02T15:18:07Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -977,4 +994,10 @@ public HiveConfig setProjectionPushdownEnabled(boolean projectionPushdownEnabled\n         this.projectionPushdownEnabled = projectionPushdownEnabled;\n         return this;\n     }\n+\n+    @PostConstruct\n+    public void validate()\n+    {\n+        InsertExistingPartitionsBehavior.validate(insertExistingPartitionsBehavior, immutablePartitions);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NTkzNg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r482295936", "bodyText": "No. immutable partitions = true is used to protect setting hive.insert-existing-partitions-behavior to APPEND state via session properties.", "author": "ssheikin", "createdAt": "2020-09-02T18:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3MjA0MA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486272040", "bodyText": "You could extend hive.insert-existing-partitions-behavior with FORCE_ERROR (name subject to discussion) which behaves as ERROR, but also be non overridable by session property.\nThough personally I feel that having separate properties is easier to understand.", "author": "losipiuk", "createdAt": "2020-09-10T11:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNzI4MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486607281", "bodyText": "For some reason immutable partitions=true allows setting insert-existing-partitions-behavior=OWERWRITE that's why it is not an option. Apart from that deprecating breaks backwards compatibility and requires a longer discussion.\nWon't do.", "author": "ssheikin", "createdAt": "2020-09-10T20:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NDkxNg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r487164916", "bodyText": "If I read the code correctly now if we specify hive.immutable-partitions=true and NOT specify hive.insert-existing-partitions-behavior the Presto will fail to start.\nThis is valid setup today. To be consistent with what we have right now we should default hive.insert-existing-partitions-behavior to ERROR if hive.immutable-partitions is true.", "author": "losipiuk", "createdAt": "2020-09-11T16:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NTUxOA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r487165518", "bodyText": "Also can you add test for above.", "author": "losipiuk", "createdAt": "2020-09-11T16:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ2MTMyOQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488461329", "bodyText": "Good point!\nI've tried to keep old logic of insert-existing-partitions-behavior calculation, when hive.insert-existing-partitions-behavior is NOT specified:\n\nCalculate default value during @PostConstruct phase\n\n    private Optional<InsertExistingPartitionsBehavior> insertExistingPartitionsBehavior = Optional.empty();\n\n    public InsertExistingPartitionsBehavior getInsertExistingPartitionsBehavior()\n    {\n        return insertExistingPartitionsBehavior.orElseThrow(() -> new NoSuchElementException(\"insertExistingPartitionsBehavior was not set during presto initialization\"));\n    }\n\n    @Config(\"hive.insert-existing-partitions-behavior\")\n    @ConfigDescription(\"Default value for insert existing partitions behavior\")\n    public HiveConfig setInsertExistingPartitionsBehavior(InsertExistingPartitionsBehavior insertExistingPartitionsBehavior)\n    {\n        this.insertExistingPartitionsBehavior = Optional.of(requireNonNull(insertExistingPartitionsBehavior, \"insertExistingPartitionsBehavior is null\"));\n        return this;\n    }\n\n    @PostConstruct\n    public void validate()\n    {\n        if (insertExistingPartitionsBehavior.isEmpty()) {\n            insertExistingPartitionsBehavior = getInsertExistingPartitionsBehaviorForBackwardCompatibility();\n        }\n        else {\n            InsertExistingPartitionsBehavior.validate(insertExistingPartitionsBehavior.get(), immutablePartitions);\n        }\n    }\n\n    private Optional<InsertExistingPartitionsBehavior> getInsertExistingPartitionsBehaviorForBackwardCompatibility()\n    {\n        return Optional.of(immutablePartitions ? ERROR : APPEND);\n    }\n\nbut seems it's not good idea from frameworks' point of view (even not looking to even more complicated logic), because tests are not configured to maintain such complex logic TestHiveConfig#testDefaults() does not invoke @PostConstruct method.\n\nHowever it is possible to move logic from @PostConstruct to getter (code becomes not that clear).\n\n    private Optional<InsertExistingPartitionsBehavior> insertExistingPartitionsBehavior = Optional.empty();\n\n    public InsertExistingPartitionsBehavior getInsertExistingPartitionsBehavior()\n    {\n        if (insertExistingPartitionsBehavior.isEmpty()) {\n            insertExistingPartitionsBehavior = getInsertExistingPartitionsBehaviorForBackwardCompatibility();\n        }\n        return insertExistingPartitionsBehavior.orElseThrow(() -> new NoSuchElementException(\"insertExistingPartitionsBehavior was not set during presto initialization\"));\n    }\n\n    private Optional<InsertExistingPartitionsBehavior> getInsertExistingPartitionsBehaviorForBackwardCompatibility()\n    {\n        return Optional.of(immutablePartitions ? ERROR : APPEND);\n    }\n\n    @Config(\"hive.insert-existing-partitions-behavior\")\n    @ConfigDescription(\"Default value for insert existing partitions behavior\")\n    public HiveConfig setInsertExistingPartitionsBehavior(InsertExistingPartitionsBehavior insertExistingPartitionsBehavior)\n    {\n        this.insertExistingPartitionsBehavior = Optional.of(requireNonNull(insertExistingPartitionsBehavior, \"insertExistingPartitionsBehavior is null\"));\n        return this;\n    }\n\n    @PostConstruct\n    public void validate()\n    {\n        insertExistingPartitionsBehavior.ifPresent(v -> InsertExistingPartitionsBehavior.validate(v, immutablePartitions));\n    }\n\n@kokosing I see three possible solutions:\n\napply solution proposed by @losipiuk which changes default value hive.insert-existing-partitions-behavior to ERROR, which breaks backward compatibility when immutablePartitions=false (in this case insert-existing-partitions-behavior was set to APPEND).\nBreak backwards compatibility for one of valid setups today: hive.immutable-partitions=true and hive.insert-existing-partitions-behavior is NOT specified.\nImplement logic in getter.\n\nWhat solution would be better?", "author": "ssheikin", "createdAt": "2020-09-15T07:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MTQ0MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488671441", "bodyText": "I'll implement solution 3.", "author": "ssheikin", "createdAt": "2020-09-15T13:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE1NTAwMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "9f6c3163e6e230b83d64dca01486447ae5135a97", "url": "https://github.com/trinodb/trino/commit/9f6c3163e6e230b83d64dca01486447ae5135a97", "message": "Set HDFS user/group to match destination's when writing", "committedDate": "2020-09-07T14:34:41Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3NTgwMw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486275803", "bodyText": "Why is @PostConstruct validation not enough", "author": "losipiuk", "createdAt": "2020-09-10T11:52:34Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -123,6 +123,9 @@ public HiveSessionProperties(\n             ParquetReaderConfig parquetReaderConfig,\n             ParquetWriterConfig parquetWriterConfig)\n     {\n+        InsertExistingPartitionsBehavior insertExistingPartitionsBehavior = hiveConfig.getInsertExistingPartitionsBehavior();\n+        InsertExistingPartitionsBehavior.validate(insertExistingPartitionsBehavior, hiveConfig.isImmutablePartitions());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwMzc4MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486603781", "bodyText": "Good point! Removed.", "author": "ssheikin", "createdAt": "2020-09-10T20:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3NTgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4Mzk1Ng==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486283956", "bodyText": "can not\nOr\nIf ``true`` setting ``hive.insert-existing-partitions-behavior`` to ``APPEND`` is not allowed.", "author": "losipiuk", "createdAt": "2020-09-10T12:07:59Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -217,6 +217,16 @@ Property Name                                      Description\n                                                    format or the default Presto format?\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n+                                                   If ``true`` then\n+                                                   ``hive.insert-existing-partitions-behavior`` could not be", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTE4OQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r486605189", "bodyText": "updated.", "author": "ssheikin", "createdAt": "2020-09-10T20:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4Mzk1Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODczMjEwMg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488732102", "bodyText": "nit: you can use concrete type here", "author": "losipiuk", "createdAt": "2020-09-15T14:52:23Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveHadoop2Plugin.java", "diffHunk": "@@ -99,6 +103,69 @@ public void testGcsAccessTokenAndHiveCachingMutuallyExclusive()\n                 .hasMessageContaining(\"Use of GCS access token is not compatible with Hive caching\");\n     }\n \n+    @Test\n+    public void testImmutablePartitionsAndInsertOverwriteMutuallyExclusive()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        assertThatThrownBy(() -> connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.insert-existing-partitions-behavior\", \"APPEND\")\n+                        .put(\"hive.immutable-partitions\", \"true\")\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext()))\n+                .hasMessageContaining(\"Presto is configured to treat Hive partitions as immutable. insert_existing_partitions_behavior is not allowed to be set to APPEND\");\n+    }\n+\n+    @Test\n+    public void testInsertOverwriteIsSetToErrorWhenImmutablePartitionsIsTrue()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        Connector connector = connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.immutable-partitions\", \"true\")\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext());\n+\n+        Object actual = getDefaultValueInsertExistingPartitionsBehavior(connector);\n+\n+        assertEquals(ERROR, actual);\n+    }\n+\n+    @Test\n+    public void testInsertOverwriteIsSetToAppendWhenImmutablePartitionsIsFalseByDefault()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        Connector connector = connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext());\n+\n+        Object actual = getDefaultValueInsertExistingPartitionsBehavior(connector);\n+\n+        assertEquals(APPEND, actual);\n+    }\n+\n+    private Object getDefaultValueInsertExistingPartitionsBehavior(Connector connector)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4MzUzNA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488883534", "bodyText": "It requires unnecessary explicit casting. I think it does not worth adding additional characters in this case.\nHowever I would be glad to substitute method's body with shorter and more understandable implementation, but I can't find one.", "author": "ssheikin", "createdAt": "2020-09-15T18:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODczMjEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyOTU4Nw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488929587", "bodyText": "Setters for config beans need to allow null. If null is passed, it should reset to the default value.", "author": "electrum", "createdAt": "2020-09-15T19:43:35Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -452,6 +458,19 @@ public HiveConfig setImmutablePartitions(boolean immutablePartitions)\n         return this;\n     }\n \n+    public InsertExistingPartitionsBehavior getInsertExistingPartitionsBehavior()\n+    {\n+        return insertExistingPartitionsBehavior.orElse(immutablePartitions ? ERROR : APPEND);\n+    }\n+\n+    @Config(\"hive.insert-existing-partitions-behavior\")\n+    @ConfigDescription(\"Default value for insert existing partitions behavior\")\n+    public HiveConfig setInsertExistingPartitionsBehavior(InsertExistingPartitionsBehavior insertExistingPartitionsBehavior)\n+    {\n+        this.insertExistingPartitionsBehavior = Optional.of(requireNonNull(insertExistingPartitionsBehavior, \"insertExistingPartitionsBehavior is null\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NDc4NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489344785", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-16T10:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyOTU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyOTg4Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488929883", "bodyText": "This also affects the session property", "author": "electrum", "createdAt": "2020-09-15T19:44:09Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -217,6 +217,16 @@ Property Name                                      Description\n                                                    format or the default Presto format?\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n+                                                   If ``true`` then setting\n+                                                   ``hive.insert-existing-partitions-behavior`` to ``APPEND``", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MDc0Ng==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489350746", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-16T11:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyOTg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMDI2NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488930265", "bodyText": "modifying existing partitions is not allowed", "author": "electrum", "createdAt": "2020-09-15T19:44:50Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -217,6 +217,16 @@ Property Name                                      Description\n                                                    format or the default Presto format?\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n+                                                   If ``true`` then setting\n+                                                   ``hive.insert-existing-partitions-behavior`` to ``APPEND``\n+                                                   is not allowed.\n+\n+``hive.insert-existing-partitions-behavior``       Default value for insert existing partitions behavior.       ``APPEND``\n+                                                   Possible values are\n+\n+                                                   * ``APPEND`` - appends data to existing partitions\n+                                                   * ``OVERWRITE`` - overwrites existing partitions\n+                                                   * ``ERROR``- does not allow to insert data", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTU2OA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489345568", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-16T10:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMDI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMTM4MQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488931381", "bodyText": "While many config properties are technically defaults for session properties, we don't describe them in terms of being a default value. Instead, we say what the config does (as if the session property is unmodified).\n\nWhen happens when data is inserted into an existing partition?", "author": "electrum", "createdAt": "2020-09-15T19:46:55Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -217,6 +217,16 @@ Property Name                                      Description\n                                                    format or the default Presto format?\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n+                                                   If ``true`` then setting\n+                                                   ``hive.insert-existing-partitions-behavior`` to ``APPEND``\n+                                                   is not allowed.\n+\n+``hive.insert-existing-partitions-behavior``       Default value for insert existing partitions behavior.       ``APPEND``", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0ODY0OA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489348648", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-16T10:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMzY2NQ==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488933665", "bodyText": "These arguments are in the wrong order for TestNG. actual comes first. It's easier to read if we inline this\nassertEquals(getDefaultValueInsertExistingPartitionsBehavior(connector), ERROR);\nOr use AssertJ\nassertThat(getDefaultValueInsertExistingPartitionsBehavior(connector)).isEqualTo(ERROR);", "author": "electrum", "createdAt": "2020-09-15T19:50:42Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveHadoop2Plugin.java", "diffHunk": "@@ -99,6 +103,69 @@ public void testGcsAccessTokenAndHiveCachingMutuallyExclusive()\n                 .hasMessageContaining(\"Use of GCS access token is not compatible with Hive caching\");\n     }\n \n+    @Test\n+    public void testImmutablePartitionsAndInsertOverwriteMutuallyExclusive()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        assertThatThrownBy(() -> connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.insert-existing-partitions-behavior\", \"APPEND\")\n+                        .put(\"hive.immutable-partitions\", \"true\")\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext()))\n+                .hasMessageContaining(\"Presto is configured to treat Hive partitions as immutable. insert_existing_partitions_behavior is not allowed to be set to APPEND\");\n+    }\n+\n+    @Test\n+    public void testInsertOverwriteIsSetToErrorWhenImmutablePartitionsIsTrue()\n+    {\n+        Plugin plugin = new HiveHadoop2Plugin();\n+        ConnectorFactory connectorFactory = Iterables.getOnlyElement(plugin.getConnectorFactories());\n+\n+        Connector connector = connectorFactory.create(\n+                \"test\",\n+                ImmutableMap.<String, String>builder()\n+                        .put(\"hive.immutable-partitions\", \"true\")\n+                        .put(\"hive.metastore.uri\", \"thrift://foo:1234\")\n+                        .build(),\n+                new TestingConnectorContext());\n+\n+        Object actual = getDefaultValueInsertExistingPartitionsBehavior(connector);\n+\n+        assertEquals(ERROR, actual);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MTU5Mg==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489351592", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-16T11:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzMzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzODUxMA==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r488938510", "bodyText": "This should use bean validation so that the config framework throws a proper error message. You can do this like\n@AssertTrue(message = \"insert-existing-partitions-behavior cannot be APPEND when immutable-partitions is true\")\npublic boolean isInsertExistingPartitionsBehaviorValid()\n{\n    return !immutablePartitions || !insertExistingPartitionsBehavior.equals(Optional.of(APPEND));\n}", "author": "electrum", "createdAt": "2020-09-15T19:59:38Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -980,4 +999,10 @@ public HiveConfig setDynamicFilteringProbeBlockingTimeout(Duration dynamicFilter\n         this.dynamicFilteringProbeBlockingTimeout = dynamicFilteringProbeBlockingTimeout;\n         return this;\n     }\n+\n+    @PostConstruct", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM2MjM4Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489362383", "bodyText": "thanks, used @AssertTrue", "author": "ssheikin", "createdAt": "2020-09-16T11:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzODUxMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc2NTg2Mw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489765863", "bodyText": "Missing word \"the\". Let's also expand the note\n\nThis also affects the xxx session property in the same way.\n\nApologies, I should have provided the exact text before.", "author": "electrum", "createdAt": "2020-09-16T21:30:31Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -217,6 +217,19 @@ Property Name                                      Description\n                                                    format or the default Presto format?\n \n ``hive.immutable-partitions``                      Can new data be inserted into existing partitions?           ``false``\n+                                                   If ``true`` then setting\n+                                                   ``hive.insert-existing-partitions-behavior`` to ``APPEND``\n+                                                   is not allowed.\n+                                                   This also affects ``insert_existing_partitions_behavior``", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjA0Nw==", "url": "https://github.com/trinodb/trino/pull/4999#discussion_r489786047", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-16T22:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc2NTg2Mw=="}], "type": "inlineReview"}, {"oid": "362552c65a1bdaa33f07e939442c21541969d215", "url": "https://github.com/trinodb/trino/commit/362552c65a1bdaa33f07e939442c21541969d215", "message": "Allow to configure insert into Hive partition via configuration property", "committedDate": "2020-09-16T22:20:10Z", "type": "commit"}, {"oid": "5534628e6bf621f8f04ecc008fdea5e3ca0373cd", "url": "https://github.com/trinodb/trino/commit/5534628e6bf621f8f04ecc008fdea5e3ca0373cd", "message": "Remove unnecessary variable propagation", "committedDate": "2020-09-16T22:20:10Z", "type": "commit"}, {"oid": "5534628e6bf621f8f04ecc008fdea5e3ca0373cd", "url": "https://github.com/trinodb/trino/commit/5534628e6bf621f8f04ecc008fdea5e3ca0373cd", "message": "Remove unnecessary variable propagation", "committedDate": "2020-09-16T22:20:10Z", "type": "forcePushed"}]}