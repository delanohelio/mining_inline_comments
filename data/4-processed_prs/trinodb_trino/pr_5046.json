{"pr_number": 5046, "pr_title": "Add from_unixtime_nanos operation", "pr_createdAt": "2020-09-01T14:55:05Z", "pr_url": "https://github.com/trinodb/trino/pull/5046", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMzNjc2MA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484336760", "bodyText": "Do not use undescores in method names", "author": "losipiuk", "createdAt": "2020-09-07T10:15:20Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -265,6 +269,32 @@ public void testFromUnixTimeWithTimeZone()\n         assertFunction(format(\"from_unixtime(7200, '%s')\", zoneId), TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n     }\n \n+    @Test\n+    public void testFromUnixTimeNanos_long()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMzOTYxOA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484339618", "bodyText": "It seems that you can use DateTimeTestingUtils.sqlTimestampOf to construct expected value.\nIf not, please extract the method needed to construct expected value.\nPreferably the test here would be just a series of:\nassertFunction(from_unixtime_nanos(....), TIMESTAMP_NANOS, sqlTimestampOf(......)\nassertFunction(from_unixtime_nanos(....), TIMESTAMP_NANOS, sqlTimestampOf(......)", "author": "losipiuk", "createdAt": "2020-09-07T10:20:56Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -265,6 +269,32 @@ public void testFromUnixTimeWithTimeZone()\n         assertFunction(format(\"from_unixtime(7200, '%s')\", zoneId), TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n     }\n \n+    @Test\n+    public void testFromUnixTimeNanos_long()\n+    {\n+        LocalDateTime dateTime = LocalDateTime.of(2001, 1, 22, 3, 4, 5, 123456789);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0MDU1MQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484340551", "bodyText": "use unixTimeNanos instead arg", "author": "losipiuk", "createdAt": "2020-09-07T10:22:44Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +144,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / NANOSECONDS_IN_SECOND;\n+        long nanosOfSecond = unixTimeNanos % NANOSECONDS_IN_SECOND;\n+        long picosOfSecond = 1000L * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(\"decimal(p, s)\") Slice arg)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0NjM5MA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484346390", "bodyText": "This is incorrect because it returns BigInteger representing whole \"unscaled\" value. Not just integral part.\nThat is for DECIMAL 123.456 you will get 123456.\nHere we want to look at just integral part (module the fact that we want to add 1 to it if factional part is >= 0.5)", "author": "losipiuk", "createdAt": "2020-09-07T10:34:43Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +144,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / NANOSECONDS_IN_SECOND;\n+        long nanosOfSecond = unixTimeNanos % NANOSECONDS_IN_SECOND;\n+        long picosOfSecond = 1000L * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(\"decimal(p, s)\") Slice arg)\n+    {\n+        BigInteger unixTimeNanos = Decimals.decodeUnscaledValue(arg);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0NjcyMw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484346723", "bodyText": "use PICOSECONDS_PER_NANOSECOND", "author": "losipiuk", "createdAt": "2020-09-07T10:35:24Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +144,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / NANOSECONDS_IN_SECOND;\n+        long nanosOfSecond = unixTimeNanos % NANOSECONDS_IN_SECOND;\n+        long picosOfSecond = 1000L * nanosOfSecond;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0NzMxOA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484347318", "bodyText": "Use Timestamps.PICOSECONDS_PER_NANOSECOND", "author": "losipiuk", "createdAt": "2020-09-07T10:36:39Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +144,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / NANOSECONDS_IN_SECOND;\n+        long nanosOfSecond = unixTimeNanos % NANOSECONDS_IN_SECOND;\n+        long picosOfSecond = 1000L * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(\"decimal(p, s)\") Slice arg)\n+    {\n+        BigInteger unixTimeNanos = Decimals.decodeUnscaledValue(arg);\n+        long epochSeconds = unixTimeNanos.divide(BigInteger.valueOf(NANOSECONDS_IN_SECOND)).longValue();\n+        long nanosOfSecond = unixTimeNanos.mod(BigInteger.valueOf(NANOSECONDS_IN_SECOND)).longValue();\n+        long picosOfSecond = 1000L * nanosOfSecond;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0NzQ2MQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r484347461", "bodyText": "Use Timestamps.NANOSECONDS_PER_SECOND", "author": "losipiuk", "createdAt": "2020-09-07T10:36:55Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -77,6 +81,7 @@\n     private static final int MILLISECONDS_IN_MINUTE = 60 * MILLISECONDS_IN_SECOND;\n     private static final int MILLISECONDS_IN_HOUR = 60 * MILLISECONDS_IN_MINUTE;\n     private static final int MILLISECONDS_IN_DAY = 24 * MILLISECONDS_IN_HOUR;\n+    private static final long NANOSECONDS_IN_SECOND = 1_000_000_000L;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyNjMzNg==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486226336", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;\n          \n          \n            \n                    long picosOfSecond =  nanosOfSecond * Timestamps.PICOSECONDS_PER_NANOSECOND;", "author": "losipiuk", "createdAt": "2020-09-10T10:17:30Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyODA5Nw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486228097", "bodyText": "put it below testFromUnixTime", "author": "losipiuk", "createdAt": "2020-09-10T10:20:28Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -265,6 +265,16 @@ public void testFromUnixTimeWithTimeZone()\n         assertFunction(format(\"from_unixtime(7200, '%s')\", zoneId), TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n     }\n \n+    @Test\n+    public void testFromUnixTimeNanos()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyOTEzMg==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486229132", "bodyText": "Shouldn't we round in such case? @findepi @martint ?", "author": "losipiuk", "createdAt": "2020-09-10T10:22:22Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -265,6 +265,16 @@ public void testFromUnixTimeWithTimeZone()\n         assertFunction(format(\"from_unixtime(7200, '%s')\", zoneId), TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n     }\n \n+    @Test\n+    public void testFromUnixTimeNanos()\n+    {\n+        assertFunction(\"from_unixtime_nanos(1234567890123456789)\", TIMESTAMP_NANOS, sqlTimestampOf(9, 1234567890L, 123456789));\n+        assertFunction(\"from_unixtime_nanos(1234567890000000000)\", TIMESTAMP_NANOS, sqlTimestampOf(9, 1234567890L, 0));\n+        assertFunction(\"from_unixtime_nanos(999999999)\", TIMESTAMP_NANOS, sqlTimestampOf(9, 0, 999999999));\n+        assertFunction(\"from_unixtime_nanos(DECIMAL '12345678900123456789')\", TIMESTAMP_NANOS, sqlTimestampOf(9, 12345678900L, 123456789));\n+        assertFunction(\"from_unixtime_nanos(DECIMAL '12345678900123456789.999')\", TIMESTAMP_NANOS, sqlTimestampOf(9, 12345678900L, 123456789));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMzM4OA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490623388", "bodyText": "It should either round or fail, but truncation is inconsistent with datetime semantics in the engine.", "author": "martint", "createdAt": "2020-09-17T23:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyOTEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwMzI4Mg==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492203282", "bodyText": "ok I'll change it to fail", "author": "alec-heif", "createdAt": "2020-09-21T16:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyOTEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyOTQ4MA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486229480", "bodyText": "revert", "author": "losipiuk", "createdAt": "2020-09-10T10:23:02Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -231,8 +232,7 @@ public void testFromUnixTimeWithOffset()\n         DateTime expected = new DateTime(dateTime, getDateTimeZone(getTimeZoneKeyForOffset((timeZoneHoursOffset * 60L) + timezoneMinutesOffset)));\n         assertFunction(\"from_unixtime(\" + seconds + \", \" + timeZoneHoursOffset + \", \" + timezoneMinutesOffset + \")\", TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n \n-        // test invalid minute offsets\n-        assertInvalidFunction(\"from_unixtime(0, 1, 10000)\", INVALID_FUNCTION_ARGUMENT);\n+        // test invalid minute offsets assertInvalidFunction(\"from_unixtime(0, 1, 10000)\", INVALID_FUNCTION_ARGUMENT);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMDQwOA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486230408", "bodyText": "I do not see a benefit of adding this method vs using SqlTimestamp.newInstance(precision, epochMicros, picosOfMicro) directly in test", "author": "losipiuk", "createdAt": "2020-09-10T10:24:48Z", "path": "presto-main/src/main/java/io/prestosql/testing/DateTimeTestingUtils.java", "diffHunk": "@@ -43,6 +45,13 @@ public static SqlTimestamp sqlTimestampOf(\n         return sqlTimestampOf(precision, LocalDateTime.of(year, monthOfYear, dayOfMonth, hourOfDay, minuteOfHour, secondOfMinute, millisToNanos(millisOfSecond)));\n     }\n \n+    public static SqlTimestamp sqlTimestampOf(int precision, long epochSeconds, int epochNanos)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNTgxNw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r486235817", "bodyText": "You also need a version takes short version of decimal, which is represented as long.\nOtherwise call like this one from_unixtime_nanos(DECIMAL '123456789) will fail.\nYou can group two implementation in internal static class. See https://github.com/prestosql/presto/blob/2379c52ead0ca9f50d89fd75aa25e885a81118fa/presto-main/src/main/java/io/prestosql/operator/scalar/MathFunctions.java#L140-L166 as an example", "author": "losipiuk", "createdAt": "2020-09-10T10:34:36Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@LiteralParameter(\"s\") long numScale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanosDecimal)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNDUwMA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492214500", "bodyText": "is there somewhere where the implementation details of the short version of decimal are written up? specifically i'm wondering how a non-integer SHORT decimal is represented (e.g. DECIMAL '123.456')", "author": "alec-heif", "createdAt": "2020-09-21T17:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNTgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNTAxOA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492215018", "bodyText": "The current branch works for integer SHORT decimals but since we want to now support either rounding or throwing on non-integer DECIMALS I'll now need to worry about this.", "author": "alec-heif", "createdAt": "2020-09-21T17:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNTgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMDExOQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492520119", "bodyText": "i'm wondering how a non-integer SHORT decimal is represented\n\nI am not sure if it is written up anywhere. We basically keep the digits and the sign in the value. And where the decimal dot should be put is derived from type parameters.", "author": "losipiuk", "createdAt": "2020-09-22T07:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNTgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTk4NQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490621985", "bodyText": "This needs to use floorDiv and floorMod to produce correct results when the input is negative. In particular, nanosOfSecond should never be negative", "author": "martint", "createdAt": "2020-09-17T23:47:01Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA5MDMzMQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492090331", "bodyText": "ah interesting, do we need to consider negative unix timestamps as valid? I would prefer to throw when they are encountered.", "author": "alec-heif", "createdAt": "2020-09-21T14:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNjcxNw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492226717", "bodyText": "I don't see why not.\nFrom wikipedia (https://en.wikipedia.org/wiki/Unix_time)\n\nThe Unix time number is zero at the Unix epoch, and increases by exactly 86400 per day since the epoch. Thus 2004-09-16T00:00:00Z, 12677 days after the epoch, is represented by the Unix time number 12677 \u00d7 86400 = 1095292800. This can be extended backwards from the epoch too, using negative numbers;", "author": "martint", "createdAt": "2020-09-21T17:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyOTYxMA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492229610", "bodyText": "\ud83d\udc4d ok will do", "author": "alec-heif", "createdAt": "2020-09-21T17:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMjA3Ng==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490622076", "bodyText": "Static import this constant", "author": "martint", "createdAt": "2020-09-17T23:47:23Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMjMzNg==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490622336", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static LongTimestamp fromUnixTimeNanos(@LiteralParameter(\"s\") long numScale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanosDecimal)\n          \n          \n            \n                public static LongTimestamp fromUnixTimeNanos(@LiteralParameter(\"s\") long scale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanos)", "author": "martint", "createdAt": "2020-09-17T23:48:25Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@LiteralParameter(\"s\") long numScale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanosDecimal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMjg4NQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490622885", "bodyText": "These need floorDiv and floorMod semantics, per comment above.", "author": "martint", "createdAt": "2020-09-17T23:50:26Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -139,6 +146,28 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / Timestamps.NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % Timestamps.NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = Timestamps.PICOSECONDS_PER_NANOSECOND * nanosOfSecond;\n+        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @LiteralParameters({\"p\", \"s\"})\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixTimeNanos(@LiteralParameter(\"s\") long numScale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanosDecimal)\n+    {\n+        BigInteger unixTimeNanos = new BigDecimal(Decimals.toString(unixTimeNanosDecimal, (int) numScale)).toBigInteger();\n+        long epochSeconds = unixTimeNanos.divide(BigInteger.valueOf(Timestamps.NANOSECONDS_PER_SECOND)).longValue();\n+        long nanosOfSecond = unixTimeNanos.mod(BigInteger.valueOf(Timestamps.NANOSECONDS_PER_SECOND)).longValue();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMzQ4Ng==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r490623486", "bodyText": "Add some tests with negative unix time", "author": "martint", "createdAt": "2020-09-17T23:52:38Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -265,6 +265,16 @@ public void testFromUnixTimeWithTimeZone()\n         assertFunction(format(\"from_unixtime(7200, '%s')\", zoneId), TIMESTAMP_WITH_TIME_ZONE, toTimestampWithTimeZone(expected));\n     }\n \n+    @Test\n+    public void testFromUnixTimeNanos()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMzg1Nw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492523857", "bodyText": "Add test for DECIMAL '123456789.999' it would fail now.", "author": "losipiuk", "createdAt": "2020-09-22T07:25:24Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestDateTimeFunctions.java", "diffHunk": "@@ -227,6 +227,7 @@ public void testFromUnixTimeNanos()\n         assertFunction(\"from_unixtime_nanos(1234567890123456789)\", TIMESTAMP_NANOS, SqlTimestamp.newInstance(9, 1234567890_123456L, 789000));\n         assertFunction(\"from_unixtime_nanos(1234567890000000000)\", TIMESTAMP_NANOS, SqlTimestamp.newInstance(9, 1234567890_000000L, 0));\n         assertFunction(\"from_unixtime_nanos(999999999)\", TIMESTAMP_NANOS, SqlTimestamp.newInstance(9, 999999, 999000));\n+        assertFunction(\"from_unixtime_nanos(DECIMAL '123456789')\", TIMESTAMP_NANOS, SqlTimestamp.newInstance(9, 123456, 789000));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNjIwNQ==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r492526205", "bodyText": "This code would only work for s==0. If there is decimal dot in the number we need to take that into account and basically round the value to nearest integer before proceeding with conversion to timestamp.\nYou can replicate rounding code from https://github.com/prestosql/presto/blob/2379c52ead0ca9f50d89fd75aa25e885a81118fa/presto-main/src/main/java/io/prestosql/operator/scalar/MathFunctions.java#L853-L870", "author": "losipiuk", "createdAt": "2020-09-22T07:29:54Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -148,25 +148,37 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n     }\n \n     @ScalarFunction(\"from_unixtime_nanos\")\n-    @SqlType(\"timestamp(9)\")\n-    public static LongTimestamp fromUnixTimeNanos(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n-    {\n-        long epochSeconds = unixTimeNanos / NANOSECONDS_PER_SECOND;\n-        long nanosOfSecond = unixTimeNanos % NANOSECONDS_PER_SECOND;\n-        long picosOfSecond = nanosOfSecond * PICOSECONDS_PER_NANOSECOND;\n-        return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+    public static final class FromUnixtimeNanosDecimal\n+    {\n+        private FromUnixtimeNanosDecimal() {}\n+\n+        @LiteralParameters({\"p\", \"s\"})\n+        @SqlType(\"timestamp(9)\")\n+        public static LongTimestamp fromLong(@LiteralParameter(\"s\") long scale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanos)\n+        {\n+            BigInteger unixTimeNanosInt = new BigDecimal(Decimals.toString(unixTimeNanos, (int) scale)).toBigInteger();\n+            long epochSeconds = unixTimeNanosInt.divide(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long nanosOfSecond = unixTimeNanosInt.mod(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long picosOfSecond = nanosOfSecond * PICOSECONDS_PER_NANOSECOND;\n+            return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+        }\n+\n+        @LiteralParameters({\"p\", \"s\"})\n+        @SqlType(\"timestamp(9)\")\n+        public static LongTimestamp fromShort(@SqlType(\"decimal(p, s)\") long unixTimeNanos)\n+        {\n+            long epochSeconds = unixTimeNanos / NANOSECONDS_PER_SECOND;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4ODY5Mw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r495188693", "bodyText": "Why :noindex:?", "author": "martint", "createdAt": "2020-09-25T19:26:23Z", "path": "presto-docs/src/main/sphinx/functions/datetime.rst", "diffHunk": "@@ -150,6 +150,12 @@ Date and Time Functions\n     using ``hours`` and ``minutes`` for the time zone offset. ``unixtime`` is\n     the number of seconds since ``1970-01-01 00:00:00`` in ``double`` data type.\n \n+.. function:: from_unixtime_nanos(unixtime) -> timestamp(9)\n+    :noindex:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzI1MA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r496953250", "bodyText": "I didn't think it made sense to have this as a top-level index item when from_unixtime already had one, as it seemed a bit redundant. Happy to remove this though if you think it's sufficiently different it should be a separate item!", "author": "alec-heif", "createdAt": "2020-09-29T18:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4ODY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDM3Nw==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r496960377", "bodyText": "It's a function with different name and result, so I would include it.", "author": "martint", "createdAt": "2020-09-29T18:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4ODY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5Mjc4Ng==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r495192786", "bodyText": "Use floorDiv and floorMod above to avoid having to do this manually", "author": "martint", "createdAt": "2020-09-25T19:35:30Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -145,6 +153,50 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    public static final class FromUnixtimeNanosDecimal\n+    {\n+        private FromUnixtimeNanosDecimal() {}\n+\n+        @LiteralParameters({\"p\", \"s\"})\n+        @SqlType(\"timestamp(9)\")\n+        public static LongTimestamp fromLong(@LiteralParameter(\"s\") long scale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanos)\n+        {\n+            BigInteger unixTimeNanosInt = unscaledDecimalToBigInteger(rescale(unixTimeNanos, -(int) scale));\n+            long epochSeconds = unixTimeNanosInt.divide(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long nanosOfSecond = unixTimeNanosInt.remainder(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long picosOfSecond = nanosOfSecond * PICOSECONDS_PER_NANOSECOND;\n+            if (picosOfSecond < 0) {\n+                epochSeconds -= 1;\n+                picosOfSecond += PICOSECONDS_PER_SECOND;\n+            }\n+            return DateTimes.longTimestamp(epochSeconds, picosOfSecond);\n+        }\n+\n+        @LiteralParameters({\"p\", \"s\"})\n+        @SqlType(\"timestamp(9)\")\n+        public static LongTimestamp fromShort(@LiteralParameter(\"s\") long scale, @SqlType(\"decimal(p, s)\") long unixTimeNanos)\n+        {\n+            long roundedUnixTimeNanos = MathFunctions.Round.roundShort(scale, unixTimeNanos);\n+            return fromUnixtimeNanosLong(roundedUnixTimeNanos);\n+        }\n+    }\n+\n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    @SqlType(\"timestamp(9)\")\n+    public static LongTimestamp fromUnixtimeNanosLong(@SqlType(StandardTypes.BIGINT) long unixTimeNanos)\n+    {\n+        long epochSeconds = unixTimeNanos / NANOSECONDS_PER_SECOND;\n+        long nanosOfSecond = unixTimeNanos % NANOSECONDS_PER_SECOND;\n+        long picosOfSecond = nanosOfSecond * PICOSECONDS_PER_NANOSECOND;\n+\n+        if (picosOfSecond < 0) {\n+            epochSeconds -= 1;\n+            picosOfSecond += PICOSECONDS_PER_SECOND;\n+        }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ5MTcyMA==", "url": "https://github.com/trinodb/trino/pull/5046#discussion_r495491720", "bodyText": "Add a comment to indicate that this is simulating floorMod/floorDiv due to lack of direct support in BigInteger", "author": "martint", "createdAt": "2020-09-26T20:18:17Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/DateTimeFunctions.java", "diffHunk": "@@ -145,6 +153,50 @@ public static long fromUnixTime(@SqlType(StandardTypes.DOUBLE) double unixTime,\n         return packDateTimeWithZone(Math.round(unixTime * 1000), zoneId.toStringUtf8());\n     }\n \n+    @ScalarFunction(\"from_unixtime_nanos\")\n+    public static final class FromUnixtimeNanosDecimal\n+    {\n+        private FromUnixtimeNanosDecimal() {}\n+\n+        @LiteralParameters({\"p\", \"s\"})\n+        @SqlType(\"timestamp(9)\")\n+        public static LongTimestamp fromLong(@LiteralParameter(\"s\") long scale, @SqlType(\"decimal(p, s)\") Slice unixTimeNanos)\n+        {\n+            BigInteger unixTimeNanosInt = unscaledDecimalToBigInteger(rescale(unixTimeNanos, -(int) scale));\n+            long epochSeconds = unixTimeNanosInt.divide(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long nanosOfSecond = unixTimeNanosInt.remainder(BigInteger.valueOf(NANOSECONDS_PER_SECOND)).longValue();\n+            long picosOfSecond = nanosOfSecond * PICOSECONDS_PER_NANOSECOND;\n+            if (picosOfSecond < 0) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "c5c6b7df94ce40e40c491594e43ce6378dc74a6e", "url": "https://github.com/trinodb/trino/commit/c5c6b7df94ce40e40c491594e43ce6378dc74a6e", "message": "Implement from_unixtime_nanos", "committedDate": "2020-10-01T22:40:48Z", "type": "commit"}, {"oid": "c5c6b7df94ce40e40c491594e43ce6378dc74a6e", "url": "https://github.com/trinodb/trino/commit/c5c6b7df94ce40e40c491594e43ce6378dc74a6e", "message": "Implement from_unixtime_nanos", "committedDate": "2020-10-01T22:40:48Z", "type": "forcePushed"}]}