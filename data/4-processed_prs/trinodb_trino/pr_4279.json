{"pr_number": 4279, "pr_title": "getTableDefaultLocation should not called if external_location present", "pr_createdAt": "2020-06-30T11:25:13Z", "pr_url": "https://github.com/trinodb/trino/pull/4279", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxNzMxNw==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r447617317", "bodyText": "sigh. i wish orElse had longer name, so that it would be simply more convenient to call orElseGet.\nI guess you can find many places like that in the codebase.", "author": "findepi", "createdAt": "2020-06-30T11:40:44Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveLocationService.java", "diffHunk": "@@ -55,7 +55,7 @@ public HiveLocationService(HdfsEnvironment hdfsEnvironment)\n     public LocationHandle forNewTable(SemiTransactionalHiveMetastore metastore, ConnectorSession session, String schemaName, String tableName, Optional<Path> externalLocation)\n     {\n         HdfsContext context = new HdfsContext(session, schemaName, tableName);\n-        Path targetPath = externalLocation.orElse(getTableDefaultLocation(context, metastore, hdfsEnvironment, schemaName, tableName));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYyMTAwOQ==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r447621009", "bodyText": "I'll add tests to exercise this check later - meanwhile you can ignore this PR. So true about Optional, I myself was surprised seeing this behaviour.", "author": "hashhar", "createdAt": "2020-06-30T11:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxNzMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NjI2Mg==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r456376262", "bodyText": "this fails on CI\n2020-07-11T18:47:14.9602286Z tests               | io.prestosql.tempto.query.QueryExecutionException: java.sql.SQLException: Query failed (#20200711_184714_00781_asknk): Writes to non-managed Hive tables is disabled\n\nsadly, we would need a separate environment with different hive.properties unlocking this...\nas this requires quite a few steps, and I am not sure of how much added value this actually brings,\ni would be OK taking a step back and not doing a test at all cc @kokosing @electrum\n(sorry, i didnt foreseen this earlier)\nif we want to go with a test, i can provide necessary guidance.", "author": "findepi", "createdAt": "2020-07-17T11:08:04Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestExternalHiveTable.java", "diffHunk": "@@ -46,6 +53,27 @@ public Requirement getRequirements(Configuration configuration)\n                 mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY));\n     }\n \n+    @Test\n+    public void testCreateExternalTableWithInaccessibleSchemaLocation()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzU0Nw==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r456433547", "bodyText": "I think a test would be good and can be done if does not complicate the CI too much and is as simple as adding a new pt-config.\nOr we can add a hidden session property (there's already more of those - like query_max_stages) to bypass for the test if we absolutely need a test.", "author": "hashhar", "createdAt": "2020-07-17T13:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc4OTY3OA==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r456789678", "bodyText": "Or we can add a hidden session property (there's already more of those - like query_max_stages) to bypass for the test if we absolutely need a test.\n\nI guess you figured this could be a security issue.\n\nI think a test would be good and can be done if does not complicate the CI too much and is as simple as adding a new pt-config.\n\nnot a pt config.\nrather, a new environment, similar to singlenode but allowing to create/write external tables\n(singlenode-with-writes-to-external ?)\nThen you'd add an invocation of test run to a suite 1/2/3 or 5.", "author": "findepi", "createdAt": "2020-07-18T13:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NjI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NjMwNA==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r456376304", "bodyText": "The temp dir is local in the tests' containers, so it can as well not exist at all, am i right?", "author": "findepi", "createdAt": "2020-07-17T11:08:09Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestExternalHiveTable.java", "diffHunk": "@@ -46,6 +53,27 @@ public Requirement getRequirements(Configuration configuration)\n                 mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY));\n     }\n \n+    @Test\n+    public void testCreateExternalTableWithInaccessibleSchemaLocation()\n+            throws IOException\n+    {\n+        File tempDir = createTempDir();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzODIyNg==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r456438226", "bodyText": "Hmmmm, good point, not sure if this step is even needed. I'll need to verify though.", "author": "hashhar", "createdAt": "2020-07-17T13:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NjMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkwMjI3OA==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r457902278", "bodyText": "Instead of creating new environment, can you define new catalog (like hive_with_writes_to_external) in existing environment?", "author": "kokosing", "createdAt": "2020-07-21T07:46:37Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/environment/SinglenodeWithWritesToExternal.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.env.environment;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.tests.product.launcher.docker.DockerFiles;\n+import io.prestosql.tests.product.launcher.env.Environment;\n+import io.prestosql.tests.product.launcher.env.common.AbstractEnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.common.Hadoop;\n+import io.prestosql.tests.product.launcher.env.common.Standard;\n+import io.prestosql.tests.product.launcher.env.common.TestsEnvironment;\n+\n+import javax.inject.Inject;\n+\n+import static io.prestosql.tests.product.launcher.env.common.Hadoop.CONTAINER_PRESTO_HIVE_PROPERTIES;\n+import static java.util.Objects.requireNonNull;\n+import static org.testcontainers.utility.MountableFile.forHostPath;\n+\n+@TestsEnvironment\n+public final class SinglenodeWithWritesToExternal\n+        extends AbstractEnvironmentProvider\n+{\n+    private final DockerFiles dockerFiles;\n+\n+    @Inject\n+    public SinglenodeWithWritesToExternal(DockerFiles dockerFiles, Standard standard, Hadoop hadoop)\n+    {\n+        super(ImmutableList.of(standard, hadoop));\n+        this.dockerFiles = requireNonNull(dockerFiles, \"dockerFiles is null\");\n+    }\n+\n+    @Override\n+    protected void extendEnvironment(Environment.Builder builder)\n+    {\n+        builder.configureContainer(\"presto-master\", container -> container\n+                .withCopyFileToContainer(forHostPath(dockerFiles.getDockerFilesHostPath(\"conf/environment/singlenode-with-writes-to-external/hive.properties\")), CONTAINER_PRESTO_HIVE_PROPERTIES));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzQ4Mg==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458377482", "bodyText": "Done. This simplified the tests a lot. Thanks for suggesting.", "author": "hashhar", "createdAt": "2020-07-21T20:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkwMjI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NzQzMw==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458067433", "bodyText": "redundant?", "author": "findepi", "createdAt": "2020-07-21T12:46:00Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCreateExternalTable.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.name.Named;\n+import io.prestosql.tempto.AfterTestWithContext;\n+import io.prestosql.tempto.BeforeTestWithContext;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.Requirements.compose;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.fulfillment.table.hive.tpch.TpchTableDefinitions.NATION;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.PROFILE_SPECIFIC_TESTS;\n+import static java.lang.String.format;\n+\n+public class TestHiveCreateExternalTable\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Inject\n+    @Named(\"databases.hive.warehouse_directory_path\")\n+    private String warehouseDirectory;\n+\n+    @BeforeTestWithContext\n+    public void setup()\n+            throws Exception\n+    {\n+        hdfsClient.createDirectory(warehouseDirectory + \"/TestHiveCreateExternalTable\");\n+    }\n+\n+    @AfterTestWithContext\n+    public void cleanup()\n+    {\n+        hdfsClient.delete(warehouseDirectory + \"/TestHiveCreateExternalTable\");\n+    }\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return compose(\n+                mutableTable(NATION));\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2ODAxMg==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458068012", "bodyText": "I would like to remove warehouse_directory_path.\nHere, it's not needed. You can create a directory in (HDFS's) /tmp", "author": "findepi", "createdAt": "2020-07-21T12:47:00Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCreateExternalTable.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.name.Named;\n+import io.prestosql.tempto.AfterTestWithContext;\n+import io.prestosql.tempto.BeforeTestWithContext;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.Requirements.compose;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.fulfillment.table.hive.tpch.TpchTableDefinitions.NATION;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.PROFILE_SPECIFIC_TESTS;\n+import static java.lang.String.format;\n+\n+public class TestHiveCreateExternalTable\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Inject\n+    @Named(\"databases.hive.warehouse_directory_path\")\n+    private String warehouseDirectory;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NjM0Ng==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458376346", "bodyText": "Done.", "author": "hashhar", "createdAt": "2020-07-21T20:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2ODAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTczMA==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458069730", "bodyText": "Use a shorter (not nested) path for tableLocation in the test code\nand this will let you remove setup and cleanup from here\n(even if you leave a table directory behind, it's not a problem)", "author": "findepi", "createdAt": "2020-07-21T12:49:48Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCreateExternalTable.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.name.Named;\n+import io.prestosql.tempto.AfterTestWithContext;\n+import io.prestosql.tempto.BeforeTestWithContext;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.Requirements.compose;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.fulfillment.table.hive.tpch.TpchTableDefinitions.NATION;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.PROFILE_SPECIFIC_TESTS;\n+import static java.lang.String.format;\n+\n+public class TestHiveCreateExternalTable\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Inject\n+    @Named(\"databases.hive.warehouse_directory_path\")\n+    private String warehouseDirectory;\n+\n+    @BeforeTestWithContext\n+    public void setup()\n+            throws Exception\n+    {\n+        hdfsClient.createDirectory(warehouseDirectory + \"/TestHiveCreateExternalTable\");\n+    }\n+\n+    @AfterTestWithContext\n+    public void cleanup()\n+    {\n+        hdfsClient.delete(warehouseDirectory + \"/TestHiveCreateExternalTable\");\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NjI3MQ==", "url": "https://github.com/trinodb/trino/pull/4279#discussion_r458376271", "bodyText": "Done.", "author": "hashhar", "createdAt": "2020-07-21T20:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2OTczMA=="}], "type": "inlineReview"}, {"oid": "a05e6af5899a2b7d1b501d1042cbec60f4d5eb8f", "url": "https://github.com/trinodb/trino/commit/a05e6af5899a2b7d1b501d1042cbec60f4d5eb8f", "message": "Do not call getTableDefaultLocation if external_location present in CTAS\n\nIn\nhttps://github.com/prestosql/presto/commit/66c360963e690a13b5a526060d7faac2110279ef\nCTAS was fixed to use the external_location if provided but due to the\nway Optional.orElse() works it still ended up calling\ngetTableDefaultLocation() which will throw errors if the schema location\ncannot be accessed or is missing. This can be fixed by the user\nby fixing the location defined in the schema - but Hive doesn't allow\nthat. So the other option is to not check the location defined in the\nschema until absolutely needed.\n\nFor testing a new Hive catalog is added with writes to external tables\nenabled.\n\nFixes: #4069.", "committedDate": "2020-07-22T04:14:32Z", "type": "commit"}]}