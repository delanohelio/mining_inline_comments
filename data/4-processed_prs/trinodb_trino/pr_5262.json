{"pr_number": 5262, "pr_title": "Refactor dynamic filtering configs", "pr_createdAt": "2020-09-22T13:16:57Z", "pr_url": "https://github.com/trinodb/trino/pull/5262", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5Njg2Nw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492796867", "bodyText": "let's use replicated instead of broadcast. That's how we call DFs in rest of codebase", "author": "sopel39", "createdAt": "2020-09-22T14:48:36Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxMzgzOA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492813838", "bodyText": "I used broadcast instead of replicated here because in FeatureConfig the user facing strings use broadcast (join-distribution-type=BROADCAST and join-max-broadcast-table-size)", "author": "raunaqmorarka", "createdAt": "2020-09-22T15:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5Njg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5OTQwMg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492799402", "bodyText": "change to:\ndynamic-filtering.small-replicated.max-row-count-per-driver\n\nand others similarly", "author": "sopel39", "createdAt": "2020-09-22T14:51:44Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize largeBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 10_000;\n+\n+    private int smallPartitionedMaxPerDriverRowCount = 100;\n+    private DataSize smallPartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largePartitionedMaxPerDriverRowCount = 100;\n+    private DataSize largePartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largePartitionedRangeRowLimitPerDriver = 10_000;\n+\n+    public boolean isEnableDynamicFiltering()\n+    {\n+        return enableDynamicFiltering;\n+    }\n+\n+    @Config(\"enable-dynamic-filtering\")\n+    @LegacyConfig(\"experimental.enable-dynamic-filtering\")\n+    public DynamicFilterConfig setEnableDynamicFiltering(boolean enableDynamicFiltering)\n+    {\n+        this.enableDynamicFiltering = enableDynamicFiltering;\n+        return this;\n+    }\n+\n+    public boolean isEnableLargeDynamicFilters()\n+    {\n+        return enableLargeDynamicFilters;\n+    }\n+\n+    @Config(\"enable-large-dynamic-filters\")\n+    public DynamicFilterConfig setEnableLargeDynamicFilters(boolean enableLargeDynamicFilters)\n+    {\n+        this.enableLargeDynamicFilters = enableLargeDynamicFilters;\n+        return this;\n+    }\n+\n+    @MinDuration(\"1ms\")\n+    @MaxDuration(\"10s\")\n+    @NotNull\n+    public Duration getDynamicFilteringRefreshInterval()\n+    {\n+        return dynamicFilteringRefreshInterval;\n+    }\n+\n+    @Config(\"experimental.dynamic-filtering-refresh-interval\")\n+    public DynamicFilterConfig setDynamicFilteringRefreshInterval(Duration dynamicFilteringRefreshInterval)\n+    {\n+        this.dynamicFilteringRefreshInterval = dynamicFilteringRefreshInterval;\n+        return this;\n+    }\n+\n+    public int getSmallBroadcastMaxPerDriverRowCount()\n+    {\n+        return smallBroadcastMaxPerDriverRowCount;\n+    }\n+\n+    @Config(\"dynamic-filtering.small-broadcast.max-per-driver-row-count\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyMjA2NA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493622064", "bodyText": "changed to dynamic-filtering.small-broadcast.max-distinct-values-per-driver", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5OTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwMzIwOA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492803208", "bodyText": "use io.prestosql.operator.JoinUtils#isBuildSideReplicated instead (it's used in DynamicFilterService)", "author": "sopel39", "createdAt": "2020-09-22T14:56:18Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -2144,14 +2146,17 @@ private DynamicFilterSourceOperatorFactory createDynamicFilterSourceOperatorFact\n                         return new DynamicFilterSourceOperator.Channel(filterId, type, index);\n                     })\n                     .collect(Collectors.toList());\n+            boolean isReplicatedJoin = node.getDistributionType()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwMzM2Nw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492803367", "bodyText": "use io.prestosql.operator.JoinUtils#isBuildSideReplicated instead", "author": "sopel39", "createdAt": "2020-09-22T14:56:27Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -2255,14 +2260,17 @@ public PhysicalOperation visitSemiJoin(SemiJoinNode node, LocalExecutionPlanCont\n                         ImmutableMap.of(filterId, buildSource.getTypes().get(buildChannel)),\n                         partitionCount);\n                 addSuccessCallback(filterConsumer.getDynamicFilterDomains(), context::addDynamicFilter);\n+                boolean isReplicatedJoin = node.getDistributionType()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwNDI3NQ==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r492804275", "bodyText": "keep small (replicated, repartitioned) configs together", "author": "sopel39", "createdAt": "2020-09-22T14:57:33Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,246 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5NzMzNg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493397336", "bodyText": "please change name to smallBroadcastMaxRowCountPerDriver. It's more English like and consistent with smallBroadcastRangeRowLimitPerDriver. Similar for other fields", "author": "sopel39", "createdAt": "2020-09-23T10:00:02Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyMjczMw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493622733", "bodyText": "changed to smallBroadcastMaxDistinctValuesPerDriver", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5NzMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxMjQ1Nw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493412457", "bodyText": "Please io.prestosql.testing.DistributedQueryRunner.Builder#setSingleExtraProperty instead of relying on DF defaults. Please add a comment why we need to change property in first place", "author": "sopel39", "createdAt": "2020-09-23T10:16:22Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveDynamicPartitionPruning.java", "diffHunk": "@@ -86,7 +86,7 @@ protected Session getSession()\n         return Session.builder(super.getSession())\n                 .setSystemProperty(JOIN_REORDERING_STRATEGY, NONE.name())\n                 .setSystemProperty(JOIN_DISTRIBUTION_TYPE, PARTITIONED.name()) // Avoid node local DF\n-                .setSystemProperty(DYNAMIC_FILTERING_RANGE_ROW_LIMIT_PER_DRIVER, \"100000\")\n+                .setSystemProperty(ENABLE_LARGE_DYNAMIC_FILTERS, \"true\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxODg3NA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493618874", "bodyText": "Explicitly added dynamic-filtering.large-partitioned.max-distinct-values-per-driver to query runner and added comments", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxMjQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNDM3Mw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493414373", "bodyText": "let's make it 5_000 rows and 100KB. That gives 80_000 rows (16x drivers) per DF. It's still more than most connectors can accept.", "author": "sopel39", "createdAt": "2020-09-23T10:18:50Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxPerDriverRowCount = 100;\n+    private DataSize smallPartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxPerDriverRowCount = 100;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyMzgzMg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493623832", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNDM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNTg3Mg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493415872", "bodyText": "Let's make it 500 and 10KB. Essentially 10x smaller than for broadcast", "author": "sopel39", "createdAt": "2020-09-23T10:20:19Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxPerDriverRowCount = 100;\n+    private DataSize smallPartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize largeBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 10_000;\n+    private int largePartitionedMaxPerDriverRowCount = 100;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyNDIzMg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493624232", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNTg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNjEyMQ==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493416121", "bodyText": "Let's make it 50_000.", "author": "sopel39", "createdAt": "2020-09-23T10:20:33Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxPerDriverRowCount = 100;\n+    private DataSize smallPartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize largeBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 10_000;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyNDU2Mg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493624562", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNjEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNjg2Mw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493416863", "bodyText": "Let's make it 5_000", "author": "sopel39", "createdAt": "2020-09-23T10:21:21Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize smallBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxPerDriverRowCount = 100;\n+    private DataSize smallPartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxPerDriverRowCount = 100;\n+    private DataSize largeBroadcastMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 10_000;\n+    private int largePartitionedMaxPerDriverRowCount = 100;\n+    private DataSize largePartitionedMaxPerDriverSize = DataSize.of(10, KILOBYTE);\n+    private int largePartitionedRangeRowLimitPerDriver = 10_000;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYyNDg2NQ==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493624865", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-23T14:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNjg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxODA5Ng==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493418096", "bodyText": "change name to getDynamicFilteringMaxRowCountPerDriver (and similar to others)", "author": "sopel39", "createdAt": "2020-09-23T10:22:45Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -2925,6 +2930,48 @@ private OperatorFactory createHashAggregationOperatorFactory(\n         }\n     }\n \n+    private int getDynamicFilteringMaxPerDriverRowCount(Session session, boolean isReplicatedJoin)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxODc5Mw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493418793", "bodyText": "make it infinite", "author": "sopel39", "createdAt": "2020-09-23T10:23:29Z", "path": "presto-main/src/test/java/io/prestosql/operator/BenchmarkDynamicFilterSourceOperator.java", "diffHunk": "@@ -89,9 +87,9 @@ public void setup()\n                     new PlanNodeId(\"joinNodeId\"),\n                     (tupleDomain -> {}),\n                     ImmutableList.of(new DynamicFilterSourceOperator.Channel(new DynamicFilterId(\"0\"), BIGINT, 0)),\n-                    getDynamicFilteringMaxPerDriverRowCount(TEST_SESSION),\n-                    getDynamicFilteringMaxPerDriverSize(TEST_SESSION),\n-                    getDynamicFilteringRangeRowLimitPerDriver(TEST_SESSION));\n+                    100,\n+                    DataSize.of(10, KILOBYTE),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxOTA5MA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r493419090", "bodyText": "nit: this and max range rows should be variable of benchmark", "author": "sopel39", "createdAt": "2020-09-23T10:23:47Z", "path": "presto-main/src/test/java/io/prestosql/operator/BenchmarkDynamicFilterSourceOperator.java", "diffHunk": "@@ -89,9 +87,9 @@ public void setup()\n                     new PlanNodeId(\"joinNodeId\"),\n                     (tupleDomain -> {}),\n                     ImmutableList.of(new DynamicFilterSourceOperator.Channel(new DynamicFilterId(\"0\"), BIGINT, 0)),\n-                    getDynamicFilteringMaxPerDriverRowCount(TEST_SESSION),\n-                    getDynamicFilteringMaxPerDriverSize(TEST_SESSION),\n-                    getDynamicFilteringRangeRowLimitPerDriver(TEST_SESSION));\n+                    100,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzY4Nw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494107687", "bodyText": "make it 10MB", "author": "sopel39", "createdAt": "2020-09-24T07:48:03Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallBroadcastMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallPartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxDistinctValuesPerDriver = 5_000;\n+    private DataSize largeBroadcastMaxSizePerDriver = DataSize.of(100, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 50_000;\n+    private int largePartitionedMaxDistinctValuesPerDriver = 500;\n+    private DataSize largePartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int largePartitionedRangeRowLimitPerDriver = 5_000;\n+\n+    public boolean isEnableDynamicFiltering()\n+    {\n+        return enableDynamicFiltering;\n+    }\n+\n+    @Config(\"enable-dynamic-filtering\")\n+    @LegacyConfig(\"experimental.enable-dynamic-filtering\")\n+    public DynamicFilterConfig setEnableDynamicFiltering(boolean enableDynamicFiltering)\n+    {\n+        this.enableDynamicFiltering = enableDynamicFiltering;\n+        return this;\n+    }\n+\n+    public boolean isEnableLargeDynamicFilters()\n+    {\n+        return enableLargeDynamicFilters;\n+    }\n+\n+    @Config(\"enable-large-dynamic-filters\")\n+    public DynamicFilterConfig setEnableLargeDynamicFilters(boolean enableLargeDynamicFilters)\n+    {\n+        this.enableLargeDynamicFilters = enableLargeDynamicFilters;\n+        return this;\n+    }\n+\n+    @MinDuration(\"1ms\")\n+    @MaxDuration(\"10s\")\n+    @NotNull\n+    public Duration getDynamicFilteringRefreshInterval()\n+    {\n+        return dynamicFilteringRefreshInterval;\n+    }\n+\n+    @Config(\"experimental.dynamic-filtering-refresh-interval\")\n+    public DynamicFilterConfig setDynamicFilteringRefreshInterval(Duration dynamicFilteringRefreshInterval)\n+    {\n+        this.dynamicFilteringRefreshInterval = dynamicFilteringRefreshInterval;\n+        return this;\n+    }\n+\n+    public int getSmallBroadcastMaxDistinctValuesPerDriver()\n+    {\n+        return smallBroadcastMaxDistinctValuesPerDriver;\n+    }\n+\n+    @Config(\"dynamic-filtering.small-broadcast.max-distinct-values-per-driver\")\n+    public DynamicFilterConfig setSmallBroadcastMaxDistinctValuesPerDriver(int smallBroadcastMaxDistinctValuesPerDriver)\n+    {\n+        this.smallBroadcastMaxDistinctValuesPerDriver = smallBroadcastMaxDistinctValuesPerDriver;\n+        return this;\n+    }\n+\n+    @MaxDataSize(\"1MB\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0MzQ3OA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494143478", "bodyText": "updated max annotation for large-partitioned.max-size-per-driver to 5MB, large-broadcast.max-size-per-driver to 50MB and kept it capped at 1MB for the small DF cases.", "author": "raunaqmorarka", "createdAt": "2020-09-24T08:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwODI3NA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494108274", "bodyText": "add @Min(0) here and in others", "author": "sopel39", "createdAt": "2020-09-24T07:49:07Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallBroadcastMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallPartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxDistinctValuesPerDriver = 5_000;\n+    private DataSize largeBroadcastMaxSizePerDriver = DataSize.of(100, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 50_000;\n+    private int largePartitionedMaxDistinctValuesPerDriver = 500;\n+    private DataSize largePartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int largePartitionedRangeRowLimitPerDriver = 5_000;\n+\n+    public boolean isEnableDynamicFiltering()\n+    {\n+        return enableDynamicFiltering;\n+    }\n+\n+    @Config(\"enable-dynamic-filtering\")\n+    @LegacyConfig(\"experimental.enable-dynamic-filtering\")\n+    public DynamicFilterConfig setEnableDynamicFiltering(boolean enableDynamicFiltering)\n+    {\n+        this.enableDynamicFiltering = enableDynamicFiltering;\n+        return this;\n+    }\n+\n+    public boolean isEnableLargeDynamicFilters()\n+    {\n+        return enableLargeDynamicFilters;\n+    }\n+\n+    @Config(\"enable-large-dynamic-filters\")\n+    public DynamicFilterConfig setEnableLargeDynamicFilters(boolean enableLargeDynamicFilters)\n+    {\n+        this.enableLargeDynamicFilters = enableLargeDynamicFilters;\n+        return this;\n+    }\n+\n+    @MinDuration(\"1ms\")\n+    @MaxDuration(\"10s\")\n+    @NotNull\n+    public Duration getDynamicFilteringRefreshInterval()\n+    {\n+        return dynamicFilteringRefreshInterval;\n+    }\n+\n+    @Config(\"experimental.dynamic-filtering-refresh-interval\")\n+    public DynamicFilterConfig setDynamicFilteringRefreshInterval(Duration dynamicFilteringRefreshInterval)\n+    {\n+        this.dynamicFilteringRefreshInterval = dynamicFilteringRefreshInterval;\n+        return this;\n+    }\n+\n+    public int getSmallBroadcastMaxDistinctValuesPerDriver()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0MTczMA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494141730", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-24T08:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwODI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMTU5MQ==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494111591", "bodyText": "rename to withLargeDynamicFilters", "author": "sopel39", "createdAt": "2020-09-24T07:54:30Z", "path": "presto-memory/src/test/java/io/prestosql/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -264,7 +267,7 @@ private Session withBroadcastJoinMinMax()\n     {\n         return Session.builder(this.getQueryRunner().getDefaultSession())\n                 .setSystemProperty(JOIN_DISTRIBUTION_TYPE, BROADCAST.name())\n-                .setSystemProperty(DYNAMIC_FILTERING_RANGE_ROW_LIMIT_PER_DRIVER, \"10000\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0MjA2Ng==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494142066", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-24T08:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMTU5MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5NTc5Nw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494195797", "bodyText": "Maybe call it testJoinLargeBuildSideRangeDynamicFiltering\nAlso, we are missing test case for \"too\" large build side for DFs to be collected. It would be good to restore it, but it's not critical", "author": "sopel39", "createdAt": "2020-09-24T10:09:12Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveDynamicPartitionPruning.java", "diffHunk": "@@ -166,7 +170,7 @@ public void testJoinWithNonSelectiveBuildSide()\n     }\n \n     @Test(timeOut = 30_000)\n-    public void testJoinLargeBuildSideNoDynamicFiltering()\n+    public void testJoinLargeBuildSideDynamicFiltering()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwODk5Mw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494208993", "bodyText": "agreed, I'll add the too-large-no-df test as well in a different PR", "author": "raunaqmorarka", "createdAt": "2020-09-24T10:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5NTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5NTkyNA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494195924", "bodyText": "call it testSemiJoinLargeBuildSideRangeDynamicFiltering", "author": "sopel39", "createdAt": "2020-09-24T10:09:26Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveDynamicPartitionPruning.java", "diffHunk": "@@ -298,7 +302,7 @@ public void testSemiJoinWithNonSelectiveBuildSide()\n     }\n \n     @Test(timeOut = 30_000)\n-    public void testSemiJoinLargeBuildSideNoDynamicFiltering()\n+    public void testSemiJoinLargeBuildSideDynamicFiltering()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5NzQ3Mg==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494197472", "bodyText": "let's make it 500KB (5_000 / 10)", "author": "sopel39", "createdAt": "2020-09-24T10:12:03Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,253 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallBroadcastMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallPartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxDistinctValuesPerDriver = 5_000;\n+    private DataSize largeBroadcastMaxSizePerDriver = DataSize.of(100, KILOBYTE);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5NzcwNw==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494197707", "bodyText": "let's make it 50KB (500/10)", "author": "sopel39", "createdAt": "2020-09-24T10:12:30Z", "path": "presto-main/src/main/java/io/prestosql/execution/DynamicFilterConfig.java", "diffHunk": "@@ -0,0 +1,253 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.DefunctConfig;\n+import io.airlift.configuration.LegacyConfig;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDataSize;\n+import io.airlift.units.MaxDuration;\n+import io.airlift.units.MinDuration;\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotNull;\n+\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+@DefunctConfig({\n+        \"dynamic-filtering-max-per-driver-row-count\",\n+        \"experimental.dynamic-filtering-max-per-driver-row-count\",\n+        \"dynamic-filtering-max-per-driver-size\",\n+        \"experimental.dynamic-filtering-max-per-driver-size\",\n+        \"dynamic-filtering-range-row-limit-per-driver\"\n+})\n+public class DynamicFilterConfig\n+{\n+    private boolean enableDynamicFiltering = true;\n+    private boolean enableLargeDynamicFilters;\n+    private Duration dynamicFilteringRefreshInterval = new Duration(200, MILLISECONDS);\n+\n+    private int smallBroadcastMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallBroadcastMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallBroadcastRangeRowLimitPerDriver;\n+    private int smallPartitionedMaxDistinctValuesPerDriver = 100;\n+    private DataSize smallPartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);\n+    private int smallPartitionedRangeRowLimitPerDriver;\n+\n+    private int largeBroadcastMaxDistinctValuesPerDriver = 5_000;\n+    private DataSize largeBroadcastMaxSizePerDriver = DataSize.of(100, KILOBYTE);\n+    private int largeBroadcastRangeRowLimitPerDriver = 50_000;\n+    private int largePartitionedMaxDistinctValuesPerDriver = 500;\n+    private DataSize largePartitionedMaxSizePerDriver = DataSize.of(10, KILOBYTE);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE5OTA4OA==", "url": "https://github.com/trinodb/trino/pull/5262#discussion_r494199088", "bodyText": "rename to maxDistinctValuesCount", "author": "sopel39", "createdAt": "2020-09-24T10:14:56Z", "path": "presto-main/src/test/java/io/prestosql/operator/BenchmarkDynamicFilterSourceOperator.java", "diffHunk": "@@ -79,16 +85,20 @@ public void setup()\n             executor = newCachedThreadPool(daemonThreadsNamed(\"test-executor-%s\"));\n             scheduledExecutor = newScheduledThreadPool(2, daemonThreadsNamed(\"test-scheduledExecutor-%s\"));\n \n-            pages = createInputPages(Integer.valueOf(positionsPerPage));\n+            pages = createInputPages(positionsPerPage);\n+\n+            String[] limits = collectionLimits.split(\",\", 2);\n+            int maxFilterPositionsCount = Integer.parseInt(limits[0]);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16206b99e47082c22a177224b667503c7bd77bcb", "url": "https://github.com/trinodb/trino/commit/16206b99e47082c22a177224b667503c7bd77bcb", "message": "Refactor dynamic filtering configs\n\nMoved dynamic filtering related configs to DynamicFilterConfig.\nAdded enable-large-dynamic-filters to allow collection of\nlarge dynamic filters.\nRemoved existing configs dynamic-filtering-max-per-driver-row-count,\ndynamic-filtering-max-per-driver-size,\ndynamic-filtering-range-row-limit-per-driver and their session\nproperties. These are replaced by new properties based on\njoin distribution type and value of enable_large_dynamic_filters.", "committedDate": "2020-09-24T10:28:32Z", "type": "commit"}, {"oid": "a745094cbbf4087c9d43a2a6362c5fce1fd2a54b", "url": "https://github.com/trinodb/trino/commit/a745094cbbf4087c9d43a2a6362c5fce1fd2a54b", "message": "Update BenchmarkDynamicFilterSourceOperator", "committedDate": "2020-09-24T10:28:39Z", "type": "commit"}, {"oid": "a745094cbbf4087c9d43a2a6362c5fce1fd2a54b", "url": "https://github.com/trinodb/trino/commit/a745094cbbf4087c9d43a2a6362c5fce1fd2a54b", "message": "Update BenchmarkDynamicFilterSourceOperator", "committedDate": "2020-09-24T10:28:39Z", "type": "forcePushed"}]}