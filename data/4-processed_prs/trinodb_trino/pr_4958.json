{"pr_number": 4958, "pr_title": "Improve performance of obtaining same current dynamic filter", "pr_createdAt": "2020-08-24T14:48:36Z", "pr_url": "https://github.com/trinodb/trino/pull/4958", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2Mzc1Mg==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r475863752", "bodyText": "A question about dynamicFilter.getDomains().get().size() >= completedDynamicFilters.size():\nMay it happen that a dynamic filter corresponds to more than one probe-side column?\nFor example, when the query is:\nSELECT * FROM left, right WHERE left.k1 = right.k AND left.k2 = right.k AND right.v = 0\nIn this case, is it OK to compare the size of TupleDomain<ColumnHandle> and Set<DynamicFilterId>?", "author": "rzeyde-varada", "createdAt": "2020-08-24T20:07:03Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -229,23 +229,22 @@ public boolean isComplete()\n             @Override\n             public TupleDomain<ColumnHandle> getCurrentPredicate()\n             {\n-                TupleDomain<ColumnHandle> dynamicFilter = completedDynamicFilter.get();\n-                if (dynamicFilter != null) {\n+                Set<DynamicFilterId> completedDynamicFilters = dynamicFilters.stream()\n+                        .filter(filter -> context.getDynamicFilterSummaries().containsKey(filter))\n+                        .collect(toImmutableSet());\n+\n+                TupleDomain<ColumnHandle> dynamicFilter = currentDynamicFilter.get();\n+                if (dynamicFilter.isNone() || dynamicFilter.getDomains().get().size() >= completedDynamicFilters.size()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg3MzgxNg==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r475873816", "bodyText": "In theory I think this could be the case. In practice unaliasing would prevent any multimaps. However, I don't think we should rely on that", "author": "sopel39", "createdAt": "2020-08-24T20:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2Mzc1Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "6c1995e9afdbea79185f4e6dcb4b8517c416d1dc", "url": "https://github.com/trinodb/trino/commit/6c1995e9afdbea79185f4e6dcb4b8517c416d1dc", "message": "Simplify stream", "committedDate": "2020-08-25T15:46:44Z", "type": "commit"}, {"oid": "162e19a1375dcf469714235f8de013470dc4b7fd", "url": "https://github.com/trinodb/trino/commit/162e19a1375dcf469714235f8de013470dc4b7fd", "message": "Fix access control of methods", "committedDate": "2020-08-25T15:46:44Z", "type": "commit"}, {"oid": "df5052382d213d27c1c62842f2e3dc9be9dab979", "url": "https://github.com/trinodb/trino/commit/df5052382d213d27c1c62842f2e3dc9be9dab979", "message": "Fix support for mapping of dynamic filter to multiple columns", "committedDate": "2020-08-25T15:46:44Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NjI2NA==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r477386264", "bodyText": "Asking because I am not sure if the current implementation is thread-safe:\nDo we assume that getCurrentPredicate is called from a single thread by the coordinator?", "author": "rzeyde-varada", "createdAt": "2020-08-26T15:22:51Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -229,22 +230,21 @@ public boolean isComplete()\n             @Override\n             public TupleDomain<ColumnHandle> getCurrentPredicate()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNDA4NA==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r477514084", "bodyText": "Asking because I am not sure if the current implementation is thread-safe:\n\nDo you mean updating of currentDynamicFilter? Yes, it could be that two threads call getCurrentPredicate() and both update currentDynamicFilter. However, even if currentDynamicFilter was updated with less domains in such case, in the next call it will be updated again with more completed domains. It's best effort, but we always return up-to-date domains. Same thread should never see less completed domains in subsequent getCurrentPredicate() calls.\nI will add a comment", "author": "sopel39", "createdAt": "2020-08-26T18:49:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NjI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5ODUyOA==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r480398528", "bodyText": "Is there a guarantee that there will be another call? Or is it possible for that to be the last call and \"get stuck\" with a less complete domain?", "author": "martint", "createdAt": "2020-08-31T21:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NjI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwOTUwNQ==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r480409505", "bodyText": "Is there a guarantee that there will be another call?\n\n@martint that's what io.prestosql.spi.connector.DynamicFilter#isComplete is for. Connector can check if the filter it will fetch will be final.", "author": "sopel39", "createdAt": "2020-08-31T21:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NjI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5ODYzNw==", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r477498637", "bodyText": "private", "author": "martint", "createdAt": "2020-08-26T18:21:36Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -591,4 +590,26 @@ private boolean isCompleted()\n             return completed.get();\n         }\n     }\n+\n+    private static class CurrentDynamicFilter\n+    {\n+        final int completedDynamicFiltersCount;\n+        final TupleDomain<ColumnHandle> dynamicFilter;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "6f87addd7cc8edbef6b3fed06675dfca61949cd7", "url": "https://github.com/trinodb/trino/commit/6f87addd7cc8edbef6b3fed06675dfca61949cd7", "message": "Make fields private", "committedDate": "2020-08-26T18:57:06Z", "type": "commit"}, {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9", "url": "https://github.com/trinodb/trino/commit/958e53e7debcea40bd18d66c923ba1595afe87c9", "message": "Improve performance of obtaining same current dynamic filter", "committedDate": "2020-08-26T18:57:23Z", "type": "commit"}, {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9", "url": "https://github.com/trinodb/trino/commit/958e53e7debcea40bd18d66c923ba1595afe87c9", "message": "Improve performance of obtaining same current dynamic filter", "committedDate": "2020-08-26T18:57:23Z", "type": "forcePushed"}]}