{"pr_number": 3799, "pr_title": "Use Rubix async read mode by default", "pr_createdAt": "2020-05-20T14:51:42Z", "pr_url": "https://github.com/trinodb/trino/pull/3799", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2Njg2NQ==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429166865", "bodyText": "nit: move to previous commit (ignore if disagree)", "author": "losipiuk", "createdAt": "2020-05-22T10:24:15Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -334,14 +351,22 @@ private Path getStoragePath(String path)\n     }\n \n     private long getRemoteReadsCount()\n-            throws Exception\n     {\n-        return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"RemoteReads\");\n+        try {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2ODY2Ng==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429168666", "bodyText": "typo: s/initializer/initialize/", "author": "losipiuk", "createdAt": "2020-05-22T10:28:48Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -110,9 +115,17 @@ private FileSystem getNonCachingFileSystem()\n         return environment.getFileSystem(context, cacheStoragePath);\n     }\n \n-    private RubixConfigurationInitializer initializeRubix()\n+    private void initializerCachingFileSystem(RubixConfig rubixConfig)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2OTA1Nw==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429169057", "bodyText": "// fetch data immediately in async mode", "author": "losipiuk", "createdAt": "2020-05-22T10:29:38Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -122,13 +135,16 @@ private RubixConfigurationInitializer initializeRubix()\n         }\n \n         // initialize rubix in master-only mode\n-        RubixConfig rubixConfig = new RubixConfig();\n         rubixConfig.setCacheLocation(Joiner.on(\",\").join(\n                 cacheDirectories.stream()\n                         .map(java.nio.file.Path::toString)\n                         .collect(toImmutableList())));\n         RubixConfigurationInitializer rubixConfigInitializer = new RubixConfigurationInitializer(rubixConfig);\n-        HdfsConfigurationInitializer configurationInitializer = new HdfsConfigurationInitializer(config, ImmutableSet.of());\n+        HdfsConfigurationInitializer configurationInitializer = new HdfsConfigurationInitializer(\n+                config,\n+                ImmutableSet.of(\n+                        // make Rubix to fetch data immediately in parallel mode", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MDkxNw==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429170917", "bodyText": "I am not a big fan that you are overriding the the cache key set by RubixConfigurationInitializer. I would rather prefer forcing filesystem cache flushing before each test. Is that possible?", "author": "losipiuk", "createdAt": "2020-05-22T10:33:49Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -159,6 +175,8 @@ private FileSystem getCachingFileSystem(\n                         (dynamicConfig, ignoredContext, ignoredUri) -> {\n                             // make sure that dummy cluster manager is used\n                             setPrestoClusterManager(dynamicConfig, DummyClusterManager.class.getName());\n+                            // ensure new caching FS (with newly initialized BookKeeper) is created for each test case\n+                            setCacheKey(dynamicConfig, randomUUID().toString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwNDU0Mw==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429204543", "bodyText": "Apparently it's not needed anymore. I suspect #3810 might have fixed it", "author": "sopel39", "createdAt": "2020-05-22T11:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MTY0Ng==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429171646", "bodyText": "This should be part of lambda passed to closer.register below.", "author": "losipiuk", "createdAt": "2020-05-22T10:35:28Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -169,12 +187,30 @@ private FileSystem getCachingFileSystem(\n     public void tearDown()\n             throws IOException\n     {\n+        nonCachingFileSystem.close();\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void closeRubix()\n+            throws IOException\n+    {\n+        if (cachingFileSystem == null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwNzA2NQ==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429207065", "bodyText": "Added explicit cachingInitialized field", "author": "sopel39", "createdAt": "2020-05-22T12:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MTY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MjA3OA==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429172078", "bodyText": "nit: migrating to randomData is unrelated. Would be nice to have separate commit with that. (not enforcing)", "author": "losipiuk", "createdAt": "2020-05-22T10:36:31Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -198,18 +234,22 @@ public void testCoordinatorNotJoining()\n                 .hasMessage(\"No coordinator node available\");\n     }\n \n-    @Test\n-    public void testCacheRead()\n+    @Test(dataProvider = \"readMode\")\n+    public void testCacheRead(ReadMode readMode)\n             throws Exception\n     {\n-        Path file = getStoragePath(\"some_file\");\n+        initializerCachingFileSystem(new RubixConfig().setReadMode(readMode));\n+        byte[] randomData = new byte[(int) SMALL_FILE_SIZE.toBytes()];", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwNzc5OQ==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429207799", "bodyText": "It's kind of related. getAsyncDownloadedMb is the only BookKeeper metric that is updated after fetch request is completed (so there is no race condition in test). It requires at least 1MB, so I needed to update the test.", "author": "sopel39", "createdAt": "2020-05-22T12:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3MjA3OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0MTAyNw==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429241027", "bodyText": "It does not work correctly. Note that you can get exception from getCachingFileSystem, after initializeRubix is already called.\nThen the closeRubix will not be called and cleanup will not be made. Not sure if that is big of a deal. But if we want the cleanup to happen we need to guard on individual fields which are closed/cleaned up, not on whole routine.", "author": "losipiuk", "createdAt": "2020-05-22T13:19:54Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -106,9 +114,18 @@ private FileSystem getNonCachingFileSystem()\n         return environment.getFileSystem(context, cacheStoragePath);\n     }\n \n-    private RubixConfigurationInitializer initializeRubix()\n+    private void initializeCachingFileSystem(RubixConfig rubixConfig)\n             throws IOException\n     {\n+        cachingFileSystem = getCachingFileSystem(initializeRubix(rubixConfig));\n+        cachingInitialized = true;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI1MDA4Mw==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429250083", "bodyText": "You are right. I will add explicit null checks", "author": "sopel39", "createdAt": "2020-05-22T13:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0MTAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0MjQ2OQ==", "url": "https://github.com/trinodb/trino/pull/3799#discussion_r429242469", "bodyText": "nit: you can generate format using 5 so it is obvious that returned String matches what is inserted into table.", "author": "losipiuk", "createdAt": "2020-05-22T13:22:43Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -82,6 +83,25 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    /**\n+     * Creates table with text files that are larger than 1MB\n+     */\n+    private String createTestTable(String tableName)\n+    {\n+        StringBuilder randomDataBuilder = new StringBuilder();\n+        Random random = new Random();\n+        for (int i = 0; i < 500_000; ++i) {\n+            randomDataBuilder.append(random.nextInt(10));\n+        }\n+        String randomData = randomDataBuilder.toString();\n+\n+        query(\"DROP TABLE IF EXISTS \" + tableName);\n+        // use `format` to overcome SQL query length limit\n+        query(\"CREATE TABLE \" + tableName + \" WITH (format='TEXTFILE') AS SELECT format('%1$s%1$s%1$s%1$s%1$s', '\" + randomData + \"') as col\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91211abba1761c25acb0067845d4698ae3124dbd", "url": "https://github.com/trinodb/trino/commit/91211abba1761c25acb0067845d4698ae3124dbd", "message": "Use MBean to obtain caching stats in tests", "committedDate": "2020-05-22T13:33:30Z", "type": "commit"}, {"oid": "c987e5027a924742e0c01e429b2ee5bf5360e0f4", "url": "https://github.com/trinodb/trino/commit/c987e5027a924742e0c01e429b2ee5bf5360e0f4", "message": "Use assertEventually in Rubix tests", "committedDate": "2020-05-22T13:33:30Z", "type": "commit"}, {"oid": "39ac1ef48be728f0eebc531bc2c096a0b579948a", "url": "https://github.com/trinodb/trino/commit/39ac1ef48be728f0eebc531bc2c096a0b579948a", "message": "Add Rubix read mode tests", "committedDate": "2020-05-22T13:39:14Z", "type": "commit"}, {"oid": "9f1ff5491bfe387c7fb2dde44ce7bb824dc8be4c", "url": "https://github.com/trinodb/trino/commit/9f1ff5491bfe387c7fb2dde44ce7bb824dc8be4c", "message": "Use generated table data in Rubix product test", "committedDate": "2020-05-22T13:39:14Z", "type": "commit"}, {"oid": "7af6adc9a1b573e82224a63f7209414e1d32708f", "url": "https://github.com/trinodb/trino/commit/7af6adc9a1b573e82224a63f7209414e1d32708f", "message": "Use Rubix async read mode by default", "committedDate": "2020-05-22T13:39:14Z", "type": "commit"}, {"oid": "7af6adc9a1b573e82224a63f7209414e1d32708f", "url": "https://github.com/trinodb/trino/commit/7af6adc9a1b573e82224a63f7209414e1d32708f", "message": "Use Rubix async read mode by default", "committedDate": "2020-05-22T13:39:14Z", "type": "forcePushed"}]}