{"pr_number": 4223, "pr_title": "Fix TestHiveTransactionalTable flakiness", "pr_createdAt": "2020-06-25T14:42:40Z", "pr_url": "https://github.com/trinodb/trino/pull/4223", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNzc1NA==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445627754", "bodyText": "static,\nmove below, at the end of the class", "author": "findepi", "createdAt": "2020-06-25T15:03:38Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -95,9 +97,11 @@ public void testReadFullAcid(boolean isPartitioned, BucketingType bucketingType)\n             compactTableAndWait(MAJOR, tableName, hivePartitionString, Duration.valueOf(\"5m\"));\n             assertThat(query(selectFromOnePartitionsSql)).containsExactly(row(20, 3), row(23, 1));\n         }\n-        finally {\n-            onHive().executeQuery(\"DROP TABLE \" + tableName);\n-        }\n+    }\n+\n+    private String tableName(String testName, boolean isPartitioned, BucketingType bucketingType)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyOTQwNQ==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445629405", "bodyText": "Simplify compaction logic in TestHiveTransactionalTabl\n\nWhat does this commit change?\nI would prefer for this code to be defensive, especially that it's based on assumptions and hard to test.\nE.g. if we want to assume there is no compaction, we should verify there initially is no compaction.\n(or leave as it was)\nnit: typo in cmt", "author": "findepi", "createdAt": "2020-06-25T15:05:52Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -190,26 +188,24 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n \n     private static void compactTableAndWait(CompactionMode compactMode, String tableName, String partitionString, Duration timeout)\n     {\n-        Set<String> existingCompactionsIds = getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet());\n-\n         onHive().executeQuery(format(\"ALTER TABLE %s %s COMPACT '%s'\", tableName, partitionString, compactMode.name()));\n \n-        Set<String> tableCompactionsIds = Sets.difference(getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet()),\n-                existingCompactionsIds);\n+        // Since we disabled table auto compaction we can assume that every compaction is triggered in this test", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0NjM5Ng==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445646396", "bodyText": "I'll add an assertion that there are no compactions", "author": "wendigo", "createdAt": "2020-06-25T15:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyOTQwNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0NDUzOA==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445744538", "bodyText": "contentEquals -> equals\nsame below", "author": "findepi", "createdAt": "2020-06-25T18:09:09Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -185,26 +183,26 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n \n     private static void compactTableAndWait(CompactionMode compactMode, String tableName, String partitionString, Duration timeout)\n     {\n-        Set<String> existingCompactionsIds = getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet());\n-\n         onHive().executeQuery(format(\"ALTER TABLE %s %s COMPACT '%s'\", tableName, partitionString, compactMode.name()));\n+        assertEquals(getTableCompactions(compactMode, tableName).count(), 0);\n \n-        Set<String> tableCompactionsIds = Sets.difference(getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet()),\n-                existingCompactionsIds);\n+        // Since we disabled table auto compaction and we checked that there are no compaction to the table\n+        // we can assume that every compaction from now on is triggered in this test\n+        // and all compaction should complete successfully before proceeding.\n+        assertEventually(timeout, () -> {\n+            List<Map<String, String>> allCompactions = getTableCompactions(compactMode, tableName)\n+                    .collect(toImmutableList());\n \n-        assertFalse(tableCompactionsIds.isEmpty(), \"tableCompactionsIds are empty\");\n+            long completedCompactions = allCompactions.stream()\n+                    .filter(row -> row.get(\"state\").contentEquals(\"succeeded\"))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0NTEyNg==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445745126", "bodyText": "that should not hold, as we just invoked a compaction", "author": "findepi", "createdAt": "2020-06-25T18:10:07Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -185,26 +183,26 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n \n     private static void compactTableAndWait(CompactionMode compactMode, String tableName, String partitionString, Duration timeout)\n     {\n-        Set<String> existingCompactionsIds = getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet());\n-\n         onHive().executeQuery(format(\"ALTER TABLE %s %s COMPACT '%s'\", tableName, partitionString, compactMode.name()));\n+        assertEquals(getTableCompactions(compactMode, tableName).count(), 0);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0NTM1Nw==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r445745357", "bodyText": "we should verify there is 1 (or fewer?) compaction", "author": "findepi", "createdAt": "2020-06-25T18:10:32Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -185,26 +183,26 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n \n     private static void compactTableAndWait(CompactionMode compactMode, String tableName, String partitionString, Duration timeout)\n     {\n-        Set<String> existingCompactionsIds = getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet());\n-\n         onHive().executeQuery(format(\"ALTER TABLE %s %s COMPACT '%s'\", tableName, partitionString, compactMode.name()));\n+        assertEquals(getTableCompactions(compactMode, tableName).count(), 0);\n \n-        Set<String> tableCompactionsIds = Sets.difference(getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet()),\n-                existingCompactionsIds);\n+        // Since we disabled table auto compaction and we checked that there are no compaction to the table\n+        // we can assume that every compaction from now on is triggered in this test\n+        // and all compaction should complete successfully before proceeding.\n+        assertEventually(timeout, () -> {\n+            List<Map<String, String>> allCompactions = getTableCompactions(compactMode, tableName)\n+                    .collect(toImmutableList());\n \n-        assertFalse(tableCompactionsIds.isEmpty(), \"tableCompactionsIds are empty\");\n+            long completedCompactions = allCompactions.stream()\n+                    .filter(row -> row.get(\"state\").contentEquals(\"succeeded\"))\n+                    .count();\n \n-        assertEventually(timeout, () -> {\n-            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n-                    .filter(row -> row.get(\"state\").equals(\"succeeded\"))\n-                    .map(row -> row.get(\"compactionid\"))\n-                    .collect(toUnmodifiableSet());\n+            long failedCompactions = allCompactions.stream()\n+                    .filter(row -> row.get(\"state\").contentEquals(\"failed\"))\n+                    .count();\n \n-            assertTrue(completedCompactionsIds.containsAll(tableCompactionsIds));\n+            verify(failedCompactions == 0, \"compactions failed\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwNDI1MA==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r446004250", "bodyText": "shouldn't there be just 1 row with state == SUCCEEDED.\nAnd then we can just do:\n        Map<String, String> compaction = getOnlyElement(\n                getTableCompactions(compactMode, tableName).collect(ImmutableList.toImmutableList()));\n        assertEquals(compaction.get(\"state\"), \"succeeded\");", "author": "losipiuk", "createdAt": "2020-06-26T07:02:49Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -185,26 +183,27 @@ private static String hiveTableProperties(TransactionalTableType transactionalTa\n \n     private static void compactTableAndWait(CompactionMode compactMode, String tableName, String partitionString, Duration timeout)\n     {\n-        Set<String> existingCompactionsIds = getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet());\n-\n+        assertEquals(getTableCompactions(compactMode, tableName).count(), 0);\n         onHive().executeQuery(format(\"ALTER TABLE %s %s COMPACT '%s'\", tableName, partitionString, compactMode.name()));\n \n-        Set<String> tableCompactionsIds = Sets.difference(getTableCompactions(compactMode, tableName)\n-                .map(row -> row.get(\"compactionid\"))\n-                .collect(toUnmodifiableSet()),\n-                existingCompactionsIds);\n-\n-        assertFalse(tableCompactionsIds.isEmpty(), \"tableCompactionsIds are empty\");\n-\n+        // Since we disabled table auto compaction and we checked that there are no compaction to the table\n+        // we can assume that every compaction from now on is triggered in this test\n+        // and all compaction should complete successfully before proceeding.\n         assertEventually(timeout, () -> {\n-            Set<String> completedCompactionsIds = getTableCompactions(compactMode, tableName)\n+            List<Map<String, String>> allCompactions = getTableCompactions(compactMode, tableName)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAxMzcyNg==", "url": "https://github.com/trinodb/trino/pull/4223#discussion_r446013726", "bodyText": "Yes, there should be only one row with either state succeeded or failed", "author": "wendigo", "createdAt": "2020-06-26T07:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwNDI1MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "a0f823394a89688bfa2ff37b884cc26aa254c806", "url": "https://github.com/trinodb/trino/commit/a0f823394a89688bfa2ff37b884cc26aa254c806", "message": "Generate random table name in TestHiveTransactionalTable", "committedDate": "2020-06-26T09:47:37Z", "type": "commit"}, {"oid": "f34735cc8dc57e0f0501e6eaf90352e842650c70", "url": "https://github.com/trinodb/trino/commit/f34735cc8dc57e0f0501e6eaf90352e842650c70", "message": "Simplify compaction logic in TestHiveTransactionalTabl", "committedDate": "2020-06-26T09:47:37Z", "type": "commit"}, {"oid": "f34735cc8dc57e0f0501e6eaf90352e842650c70", "url": "https://github.com/trinodb/trino/commit/f34735cc8dc57e0f0501e6eaf90352e842650c70", "message": "Simplify compaction logic in TestHiveTransactionalTabl", "committedDate": "2020-06-26T09:47:37Z", "type": "forcePushed"}]}