{"pr_number": 4141, "pr_title": "Return null columns in result to match previous behaviour", "pr_createdAt": "2020-06-22T11:59:08Z", "pr_url": "https://github.com/trinodb/trino/pull/4141", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzMTM1NA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443531354", "bodyText": "I do not know this part of code so I do not want to make final call.\nThe question which comes to my mind is: are there legitimate cases when column list is empty and we want to distinguish it from null?", "author": "losipiuk", "createdAt": "2020-06-22T12:45:07Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -90,8 +92,13 @@ public boolean isEmpty()\n         return totalRows == 0;\n     }\n \n+    @Nullable\n     public List<Column> getColumns()\n     {\n+        if (columns.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU1NTg1NQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443555855", "bodyText": "Initial query results does not contain column list at all. Previously null was returned, now it's empty array which breaks some clients (as null is part of the protocol)", "author": "wendigo", "createdAt": "2020-06-22T13:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzMTM1NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzIxOA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443597218", "bodyText": "Either revert the change here, or update data to be Optional as well", "author": "findepi", "createdAt": "2020-06-22T14:25:21Z", "path": "presto-client/src/main/java/io/prestosql/client/QueryResults.java", "diffHunk": "@@ -79,7 +80,7 @@ public QueryResults(\n             URI infoUri,\n             URI partialCancelUri,\n             URI nextUri,\n-            List<Column> columns,\n+            Optional<List<Column>> columns,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3MDM5Ng==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444070396", "bodyText": "I'll revert.", "author": "wendigo", "createdAt": "2020-06-23T08:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMDMwMQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443600301", "bodyText": "should types be treated the same? ie also become Optional?", "author": "findepi", "createdAt": "2020-06-22T14:29:14Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -82,15 +82,15 @@ private QueryResultRows(Session session, List<Type> types, List<Column> columns,\n         this.currentPage = this.pages.pollFirst();\n         this.supportsParametricDateTime = session.getClientCapabilities().contains(ClientCapabilities.PARAMETRIC_DATETIME.toString());\n \n-        verify(this.types.size() == this.columns.size(), \"columns and types sizes mismatch\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwMTA1OQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444101059", "bodyText": "Done.", "author": "wendigo", "createdAt": "2020-06-23T09:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMDMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMDg2Mw==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443600863", "bodyText": "you can this right above, so that feels redundnat", "author": "findepi", "createdAt": "2020-06-22T14:29:56Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -107,7 +107,14 @@ public long getTotalRowsCount()\n     public Optional<Long> getUpdateCount()\n     {\n         // We should have exactly single bigint value as an update count.\n-        if (totalRows != 1 || columns.size() != 1 || !columns.get(0).getType().equals(StandardTypes.BIGINT)) {\n+        if (totalRows != 1 || columns.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        verify(columns.isPresent(), \"columns are not present\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMTgyMQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443601821", "bodyText": "current implies this changes over time, while column information does not.\nyou can use columns for the local var (yes, shadowing the field)", "author": "findepi", "createdAt": "2020-06-22T14:31:15Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -107,7 +107,14 @@ public long getTotalRowsCount()\n     public Optional<Long> getUpdateCount()\n     {\n         // We should have exactly single bigint value as an update count.\n-        if (totalRows != 1 || columns.size() != 1 || !columns.get(0).getType().equals(StandardTypes.BIGINT)) {\n+        if (totalRows != 1 || columns.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        verify(columns.isPresent(), \"columns are not present\");\n+        List<Column> currentColumns = columns.get();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMjg5OQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r443602899", "bodyText": "add a ctor validation that presence of data implies presence of columns", "author": "findepi", "createdAt": "2020-06-22T14:32:29Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -150,7 +157,8 @@ public long getTotalRowsCount()\n \n     private Optional<List<Object>> getRowValues()\n     {\n-        List<Object> row = new ArrayList<>(columns.size());\n+        verify(columns.isPresent(), \"columns are not present\");\n+        List<Object> row = new ArrayList<>(columns.get().size());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2MzQ5OQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444163499", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return columns.map(columns -> columns.stream().map(ColumnAndType::getColumn).collect(toUnmodifiableList()));\n          \n          \n            \n                    return columns.map(columns -> columns.stream()\n          \n          \n            \n                    .map(ColumnAndType::getColumn)\n          \n          \n            \n                    .collect(toImmutableList()));", "author": "findepi", "createdAt": "2020-06-23T11:49:43Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -66,33 +64,27 @@\n     private int rowPosition = -1;\n     private int inPageIndex = -1;\n \n-    private QueryResultRows(Session session, List<Type> types, List<Column> columns, List<Page> pages)\n-    {\n-        this(session, types, columns, pages, null);\n-    }\n-\n-    private QueryResultRows(Session session, List<Type> types, List<Column> columns, List<Page> pages, Consumer<Throwable> exceptionConsumer)\n+    private QueryResultRows(Session session, Optional<List<ColumnAndType>> columns, List<Page> pages, Consumer<Throwable> exceptionConsumer)\n     {\n         this.session = requireNonNull(session, \"session is null\").toConnectorSession();\n-        this.types = requireNonNull(types, \"types is null\");\n         this.columns = requireNonNull(columns, \"columns is null\");\n         this.pages = new ArrayDeque<>(requireNonNull(pages, \"pages is null\"));\n         this.exceptionConsumer = Optional.ofNullable(exceptionConsumer);\n         this.totalRows = countRows(pages);\n         this.currentPage = this.pages.pollFirst();\n         this.supportsParametricDateTime = session.getClientCapabilities().contains(ClientCapabilities.PARAMETRIC_DATETIME.toString());\n \n-        verify(this.types.size() == this.columns.size(), \"columns and types sizes mismatch\");\n+        verify(totalRows == 0 || (totalRows > 0 && columns.isPresent()), \"data present without columns and types\");\n     }\n \n     public boolean isEmpty()\n     {\n         return totalRows == 0;\n     }\n \n-    public List<Column> getColumns()\n+    public Optional<List<Column>> getColumns()\n     {\n-        return columns;\n+        return columns.map(columns -> columns.stream().map(ColumnAndType::getColumn).collect(toUnmodifiableList()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2Mzg0OQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444163849", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<ColumnAndType> columns = this.columns.get();\n          \n          \n            \n                    List<ColumnAndType> columns = this.columns.orElseThrow();\n          \n      \n    \n    \n  \n\n(get() triggers an IDE warning)", "author": "findepi", "createdAt": "2020-06-23T11:50:24Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -150,10 +148,13 @@ public long getTotalRowsCount()\n \n     private Optional<List<Object>> getRowValues()\n     {\n+        // types are present if data is present\n+        List<ColumnAndType> columns = this.columns.get();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2NDg3NA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444164874", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        verify(columns.size() == types.size(), \"columns and types size mismatch\");\n          \n          \n            \n            \n          \n          \n            \n                        ImmutableList.Builder<ColumnAndType> builder = ImmutableList.builder();\n          \n          \n            \n            \n          \n          \n            \n                        for (int i = 0; i < columns.size(); i++) {\n          \n          \n            \n                            builder.add(new ColumnAndType(columns.get(i), types.get(i)));\n          \n          \n            \n                        }\n          \n          \n            \n            \n          \n          \n            \n                        return Optional.of(builder.build());\n          \n          \n            \n                        checkArgument(columns != null && types != null, \"columns and types must be present at the same time\");\n          \n          \n            \n                        checkArgument(columns.size() == types.size(), \"columns and types size mismatch\");\n          \n          \n            \n            \n          \n          \n            \n                        ImmutableList.Builder<ColumnAndType> builder = ImmutableList.builder();\n          \n          \n            \n                        for (int i = 0; i < columns.size(); i++) {\n          \n          \n            \n                            builder.add(new ColumnAndType(columns.get(i), types.get(i)));\n          \n          \n            \n                        }\n          \n          \n            \n                        return Optional.of(builder.build());", "author": "findepi", "createdAt": "2020-06-23T11:52:28Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -274,10 +270,57 @@ public QueryResultRows build()\n         {\n             return new QueryResultRows(\n                     session,\n-                    types,\n                     columns,\n                     pages.build(),\n                     exceptionConsumer);\n         }\n+\n+        private static Optional<List<ColumnAndType>> combine(List<Column> columns, List<Type> types)\n+        {\n+            if (columns == null || types == null) {\n+                return Optional.empty();\n+            }\n+\n+            verify(columns.size() == types.size(), \"columns and types size mismatch\");\n+\n+            ImmutableList.Builder<ColumnAndType> builder = ImmutableList.builder();\n+\n+            for (int i = 0; i < columns.size(); i++) {\n+                builder.add(new ColumnAndType(columns.get(i), types.get(i)));\n+            }\n+\n+            return Optional.of(builder.build());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2NTU4Mg==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444165582", "bodyText": "That's a bit unintuitive because Column also has type information (String type and ClientTypeSignature typeSignature)\ncc @electrum ?", "author": "findepi", "createdAt": "2020-06-23T11:53:47Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -274,10 +270,57 @@ public QueryResultRows build()\n         {\n             return new QueryResultRows(\n                     session,\n-                    types,\n                     columns,\n                     pages.build(),\n                     exceptionConsumer);\n         }\n+\n+        private static Optional<List<ColumnAndType>> combine(List<Column> columns, List<Type> types)\n+        {\n+            if (columns == null || types == null) {\n+                return Optional.empty();\n+            }\n+\n+            verify(columns.size() == types.size(), \"columns and types size mismatch\");\n+\n+            ImmutableList.Builder<ColumnAndType> builder = ImmutableList.builder();\n+\n+            for (int i = 0; i < columns.size(); i++) {\n+                builder.add(new ColumnAndType(columns.get(i), types.get(i)));\n+            }\n+\n+            return Optional.of(builder.build());\n+        }\n+    }\n+\n+    private static class ColumnAndType\n+    {\n+        private final Column column;\n+        private final Type type;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3MDgzNA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444170834", "bodyText": "I followed logic of previous implementation. Columns and types are collected in setQueryOutputInfo method:\nprivate synchronized void setQueryOutputInfo(QueryExecution.QueryOutputInfo outputInfo)\n    {\n        // if first callback, set column names\n        if (columns == null) {\n            List<String> columnNames = outputInfo.getColumnNames();\n            List<Type> columnTypes = outputInfo.getColumnTypes();\n            checkArgument(columnNames.size() == columnTypes.size(), \"Column names and types size mismatch\");\n\n            ImmutableList.Builder<Column> list = ImmutableList.builder();\n            for (int i = 0; i < columnNames.size(); i++) {\n                list.add(createColumn(columnNames.get(i), columnTypes.get(i)));\n            }\n            columns = list.build();\n            types = outputInfo.getColumnTypes();\n        }\n\n        for (URI outputLocation : outputInfo.getBufferLocations()) {\n            exchangeClient.addLocation(outputLocation);\n        }\n        if (outputInfo.isNoMoreBufferLocations()) {\n            exchangeClient.noMoreLocations();\n        }\n    }", "author": "wendigo", "createdAt": "2020-06-23T12:03:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2NTU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4OTIzMQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444489231", "bodyText": "I agree, but don't see a way around it since Column is a wire protocol object.", "author": "electrum", "createdAt": "2020-06-23T20:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2NTU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE2NjA2OA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444166068", "bodyText": "This is a new verification, it should be added as a separate commit.\n(when splitting, make sure to split the tests accordingly too)", "author": "findepi", "createdAt": "2020-06-23T11:54:48Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -66,33 +64,27 @@\n     private int rowPosition = -1;\n     private int inPageIndex = -1;\n \n-    private QueryResultRows(Session session, List<Type> types, List<Column> columns, List<Page> pages)\n-    {\n-        this(session, types, columns, pages, null);\n-    }\n-\n-    private QueryResultRows(Session session, List<Type> types, List<Column> columns, List<Page> pages, Consumer<Throwable> exceptionConsumer)\n+    private QueryResultRows(Session session, Optional<List<ColumnAndType>> columns, List<Page> pages, Consumer<Throwable> exceptionConsumer)\n     {\n         this.session = requireNonNull(session, \"session is null\").toConnectorSession();\n-        this.types = requireNonNull(types, \"types is null\");\n         this.columns = requireNonNull(columns, \"columns is null\");\n         this.pages = new ArrayDeque<>(requireNonNull(pages, \"pages is null\"));\n         this.exceptionConsumer = Optional.ofNullable(exceptionConsumer);\n         this.totalRows = countRows(pages);\n         this.currentPage = this.pages.pollFirst();\n         this.supportsParametricDateTime = session.getClientCapabilities().contains(ClientCapabilities.PARAMETRIC_DATETIME.toString());\n \n-        verify(this.types.size() == this.columns.size(), \"columns and types sizes mismatch\");\n+        verify(totalRows == 0 || (totalRows > 0 && columns.isPresent()), \"data present without columns and types\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4NzkxMA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444487910", "bodyText": "This shouldn't return Optional since it always returns something. It never returns empty so having it return Optional is misleading.", "author": "electrum", "createdAt": "2020-06-23T20:29:21Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -274,10 +270,54 @@ public QueryResultRows build()\n         {\n             return new QueryResultRows(\n                     session,\n-                    types,\n                     columns,\n                     pages.build(),\n                     exceptionConsumer);\n         }\n+\n+        private static Optional<List<ColumnAndType>> combine(List<Column> columns, List<Type> types)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxNDU1OQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444514559", "bodyText": "Let's verify the contents as well", "author": "electrum", "createdAt": "2020-06-23T21:18:38Z", "path": "presto-main/src/test/java/io/prestosql/server/TestServer.java", "diffHunk": "@@ -127,6 +128,27 @@ public void testInvalidSessionError()\n         assertEquals(queryError.getMessage(), expected.getMessage());\n     }\n \n+    @Test\n+    public void testFirstResponseColumns()\n+    {\n+        List<QueryResults> queryResults = postQuery(request -> request\n+                .setBodyGenerator(createStaticBodyGenerator(\"show catalogs\", UTF_8))\n+                .setHeader(PRESTO_CATALOG, \"catalog\")\n+                .setHeader(PRESTO_SCHEMA, \"schema\")\n+                .setHeader(PRESTO_PATH, \"path\"))\n+                .map(JsonResponse::getValue)\n+                .collect(toImmutableList());\n+\n+        QueryResults first = queryResults.get(0);\n+        QueryResults last = queryResults.get(queryResults.size() - 1);\n+\n+        assertNull(first.getColumns());\n+        assertEquals(first.getStats().getState(), \"QUEUED\");\n+\n+        assertNotNull(last.getColumns());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAyMDUzNw==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r445020537", "bodyText": "See comment. We should verify the contents here", "author": "electrum", "createdAt": "2020-06-24T16:28:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxNDU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxODAyNg==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444518026", "bodyText": "Use orElseThrow() for all of these get() calls as that's the new preferred method when the value presence is not previously checked (so the expected behavior of throwing is clear).", "author": "electrum", "createdAt": "2020-06-23T21:26:18Z", "path": "presto-main/src/test/java/io/prestosql/server/protocol/TestQueryResultRows.java", "diffHunk": "@@ -65,7 +66,7 @@ public void shouldReturnSingleValue()\n \n         assertThat((Iterable<? extends List<Object>>) rows).as(\"rows\").isNotEmpty();\n         assertThat(getAllValues(rows)).hasSize(1).containsOnly(ImmutableList.of(true));\n-        assertThat(rows.getColumns()).containsOnly(column);\n+        assertThat(rows.getColumns().get()).containsOnly(column);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxOTE3OA==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444519178", "bodyText": "Maybe extract a constant for this since it's shared across tests.", "author": "electrum", "createdAt": "2020-06-23T21:28:42Z", "path": "presto-main/src/test/java/io/prestosql/server/protocol/TestQueryResultRows.java", "diffHunk": "@@ -232,6 +233,59 @@ public void shouldHandleNullValues()\n                 .containsExactly(newArrayList(0, null), newArrayList(1, null), newArrayList(2, true));\n     }\n \n+    @Test\n+    public void shouldNotThrowWhenDataAndColumnsAreMissing()\n+    {\n+        QueryResultRows.empty(getSession());\n+    }\n+\n+    @Test(expectedExceptions = IllegalArgumentException.class, expectedExceptionsMessageRegExp = \"columns and types size mismatch\")\n+    public void shouldThrowWhenColumnsAndTypesSizeMismatch()\n+    {\n+        List<Column> columns = ImmutableList.of(new Column(\"_col0\", INTEGER, new ClientTypeSignature(INTEGER)));\n+        List<Type> types = ImmutableList.of(IntegerType.INTEGER, BooleanType.BOOLEAN);\n+\n+        List<Page> pages = rowPagesBuilder(types)\n+                .row(0, null)\n+                .build();\n+\n+        queryResultRowsBuilder(getSession())\n+                .addPages(pages)\n+                .withColumnsAndTypes(columns, types)\n+                .build();\n+    }\n+\n+    @Test(expectedExceptions = IllegalArgumentException.class, expectedExceptionsMessageRegExp = \"columns and types must be present at the same time\")\n+    public void shouldThrowWhenColumnsAreNull()\n+    {\n+        List<Type> types = ImmutableList.of(IntegerType.INTEGER, BooleanType.BOOLEAN);\n+\n+        List<Page> pages = rowPagesBuilder(types)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxOTc2MQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444519761", "bodyText": "We could shorten this to column now", "author": "electrum", "createdAt": "2020-06-23T21:29:56Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -178,10 +178,10 @@ else if (type instanceof TimestampWithTimeZoneType && !supportsParametricDateTim\n         return Optional.of(unmodifiableList(row));\n     }\n \n-    private void propagateException(int row, int column, ColumnAndType columnAndType, Throwable cause)\n+    private void propagateException(int row, ColumnAndType columnAndType, Throwable cause)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyMDk3NQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444520975", "bodyText": "We'd need to annotate these parameters with @Nullable as well. Instead of pushing nulls further, let's move the null checks into the caller.", "author": "electrum", "createdAt": "2020-06-23T21:32:30Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -280,6 +282,10 @@ public QueryResultRows build()\n \n         private static Optional<List<ColumnAndType>> combine(List<Column> columns, List<Type> types)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NjgzMw==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444996833", "bodyText": "Inverting an expression makes it harder to read. We can write as\nif (columns != null || types != null)", "author": "electrum", "createdAt": "2020-06-24T15:51:19Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -245,10 +246,11 @@ public Builder addPages(List<Page> page)\n             return this;\n         }\n \n-        public Builder withColumns(List<Column> columns, List<Type> types)\n+        public Builder withColumnsAndTypes(@Nullable List<Column> columns, @Nullable List<Type> types)\n         {\n-            this.columns = firstNonNull(columns, emptyList());\n-            this.types = firstNonNull(types, emptyList());\n+            if (!(columns == null && types == null)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NzM3Ng==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444997376", "bodyText": "Move this check into the caller. Otherwise we need to annotate the arguments with @Nullable", "author": "electrum", "createdAt": "2020-06-24T15:52:07Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -274,10 +275,54 @@ public QueryResultRows build()\n         {\n             return new QueryResultRows(\n                     session,\n-                    types,\n                     columns,\n                     pages.build(),\n                     exceptionConsumer);\n         }\n+\n+        private static List<ColumnAndType> combine(List<Column> columns, List<Type> types)\n+        {\n+            checkArgument(columns != null && types != null, \"columns and types must be present at the same time\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAyMjY5NQ==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r445022695", "bodyText": "I'll annotate", "author": "wendigo", "createdAt": "2020-06-24T16:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NzM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5ODAzMw==", "url": "https://github.com/trinodb/trino/pull/4141#discussion_r444998033", "bodyText": "This is getting long, please wrap the arguments for readability", "author": "electrum", "createdAt": "2020-06-24T15:53:07Z", "path": "presto-main/src/main/java/io/prestosql/server/protocol/QueryResultRows.java", "diffHunk": "@@ -180,10 +180,10 @@ else if (type instanceof TimestampWithTimeZoneType && !supportsParametricDateTim\n         return Optional.of(unmodifiableList(row));\n     }\n \n-    private void propagateException(int row, int column, ColumnAndType columnAndType, Throwable cause)\n+    private void propagateException(int row, ColumnAndType column, Throwable cause)\n     {\n         // columns and rows are 0-indexed\n-        String message = format(\"Could not serialize type '%s' value at position %d:%d\", columnAndType.getColumn().getType(), row + 1, column + 1);\n+        String message = format(\"Could not serialize column '%s' of type '%s' at position %d:%d\", column.getColumn().getName(), column.getType(), row + 1, column.getPosition() + 1);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf8947fab66d462dc691b7e79b24cdbf52a6054a", "url": "https://github.com/trinodb/trino/commit/bf8947fab66d462dc691b7e79b24cdbf52a6054a", "message": "Return null columns in result to match previous behaviour", "committedDate": "2020-06-24T16:43:15Z", "type": "commit"}, {"oid": "5bc3c831e443344cf87660caf63ac974f6aecaa3", "url": "https://github.com/trinodb/trino/commit/5bc3c831e443344cf87660caf63ac974f6aecaa3", "message": "Improve exception message on serialization error", "committedDate": "2020-06-24T16:43:15Z", "type": "commit"}, {"oid": "1914035e1e2adb650ddc810bb73a34a67b148565", "url": "https://github.com/trinodb/trino/commit/1914035e1e2adb650ddc810bb73a34a67b148565", "message": "Verify if columns and types information is present when data is", "committedDate": "2020-06-24T16:43:16Z", "type": "commit"}, {"oid": "1f0a59f3f577cf4345476c504b6b0288ff3e3ff9", "url": "https://github.com/trinodb/trino/commit/1f0a59f3f577cf4345476c504b6b0288ff3e3ff9", "message": "Extract common column types builders", "committedDate": "2020-06-24T16:43:16Z", "type": "commit"}, {"oid": "1f0a59f3f577cf4345476c504b6b0288ff3e3ff9", "url": "https://github.com/trinodb/trino/commit/1f0a59f3f577cf4345476c504b6b0288ff3e3ff9", "message": "Extract common column types builders", "committedDate": "2020-06-24T16:43:16Z", "type": "forcePushed"}]}