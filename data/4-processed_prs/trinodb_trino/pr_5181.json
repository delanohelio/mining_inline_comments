{"pr_number": 5181, "pr_title": "128 bit decimal improvements once more", "pr_createdAt": "2020-09-16T07:55:45Z", "pr_url": "https://github.com/trinodb/trino/pull/5181", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490884859", "bodyText": "This looks like a specialization of multiply(Slice left, Slice right, Slice result). Am I right?\nIf so can we somehow use specialization in the implementation of generic multiply(Slice left, Slice right, Slice result)?", "author": "kokosing", "createdAt": "2020-09-18T11:30:38Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -481,6 +495,108 @@ public static void multiply(Slice left, Slice right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, long right, Slice result)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5ODIwOA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490898208", "bodyText": "Am I right?\n\nYes you are\n\nIf so can we somehow use specialization in the implementation of generic multiply(Slice left, Slice right, Slice result)?\n\nNot really. The generic version is pretty optimized in terms of avoiding multiplying by 0. The biggest gain of this specialization is that it is not necessary to create a Slice object which is pretty costly.\nIt might make sense the other way around - generic version uses longs (or ints) and specialized version extracts those longs from slice. But this is for another occasion.", "author": "skrzypo987", "createdAt": "2020-09-18T11:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYzMjcxMA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r507632710", "bodyText": "Can we extract a method from public static void multiply(Slice left, Slice right, Slice result) which we could use in implementation of multiply(Slice left, long right, Slice result) and multiply(long left, long right, Slice result)?\nI am bit concerned of amount of complex code that was copied.", "author": "kokosing", "createdAt": "2020-10-19T10:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2MzY1OQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r507663659", "bodyText": "That can be done with many methods here. The question is how much do we want to do in this PR.\nBut let's agree on this particular method.\nI'm going to rewrite it to a common multiply(long left, long right, Slice result) method and see if this changes performance in any way.", "author": "skrzypo987", "createdAt": "2020-10-19T11:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3ODAyNQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r507678025", "bodyText": "That can be done with many methods here.\n\nCorrect, I took this one as an example. If it would work here, then it should work for others.", "author": "kokosing", "createdAt": "2020-10-19T11:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyNzQyMA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508427420", "bodyText": "If it would work here, then it should work for others\n\nWith JIT? Dream on.\nI made some tests with this approach. Results are interesting - out of 5 benchmarks 3 are the same, one is slightly faster(!) and one is terribly slower(~40%).\nI'm going to take care of that in another PR. I'll try to find a common ground between performance and code reusability.", "author": "skrzypo987", "createdAt": "2020-10-20T11:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NDg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NTQ0Nw==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490885447", "bodyText": "Do you you think it makes sense to extract refactors to separate preparatory commit before this one? That way it will be clear to see what kind of new tests case were added.", "author": "kokosing", "createdAt": "2020-09-18T11:31:38Z", "path": "presto-spi/src/test/java/io/prestosql/spi/type/TestUnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -768,4 +772,43 @@ private static Slice negate(Slice slice)\n         }\n         return ints;\n     }\n+\n+    private static boolean isShort(BigInteger value)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwMTc1Ng==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490901756", "bodyText": "I did think about it.\nHowever those test will not work without the new methods and methods should not be commited without being properly tested. Refactor is strictly for the reason of testing new methods using existing test cases.\nExactly the same goes for assertRescale in later commit", "author": "skrzypo987", "createdAt": "2020-09-18T12:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NjI3NQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490886275", "bodyText": "why not multiply(tenToScale, value)?", "author": "kokosing", "createdAt": "2020-09-18T11:32:57Z", "path": "presto-main/src/main/java/io/prestosql/type/DecimalCasts.java", "diffHunk": "@@ -223,7 +223,7 @@ public static long bigintToShortDecimal(long value, long precision, long scale,\n     public static Slice bigintToLongDecimal(long value, long precision, long scale, BigInteger tenToScale)\n     {\n         try {\n-            Slice decimal = multiply(unscaledDecimal(value), unscaledDecimal(tenToScale));\n+            Slice decimal = multiply(unscaledDecimal(tenToScale), value);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwMjE4NQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490902185", "bodyText": "tenToScale is a BigInteger", "author": "skrzypo987", "createdAt": "2020-09-18T12:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NjI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NjY0Mg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490886642", "bodyText": "refactor in separate commit?", "author": "kokosing", "createdAt": "2020-09-18T11:33:34Z", "path": "presto-spi/src/test/java/io/prestosql/spi/type/TestUnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -811,4 +811,13 @@ private static void assertMultiply(long a, long b, long result)\n     {\n         assertMultiply(a, b, BigInteger.valueOf(result));\n     }\n+\n+    private static void assertRescale(Slice decimal, int rescale, Slice expected)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwMjkzMQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r490902931", "bodyText": "same as assertMultiply", "author": "skrzypo987", "createdAt": "2020-09-18T12:04:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4NjY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1MjkyNA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491052924", "bodyText": "unscaledDecimal and others - method names should start with imperative", "author": "iirekm", "createdAt": "2020-09-18T16:12:33Z", "path": "presto-main/src/main/java/io/prestosql/type/DecimalCasts.java", "diffHunk": "@@ -339,7 +339,7 @@ public static long smallintToShortDecimal(long value, long precision, long scale\n     public static Slice smallintToLongDecimal(long value, long precision, long scale, BigInteger tenToScale)\n     {\n         try {\n-            Slice decimal = multiply(unscaledDecimal(value), unscaledDecimal(tenToScale));\n+            Slice decimal = multiply(unscaledDecimal(tenToScale), value);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NTE0OQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491285149", "bodyText": "Not changed in this PR", "author": "skrzypo987", "createdAt": "2020-09-19T06:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1MjkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjAwMw==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491056003", "bodyText": "copy and paste, somebody fixes an issue in one place, forgets another and we have a bug; generalize the methods, or if not possible (eg would hurt performance), write a script which generates this copy and paste", "author": "iirekm", "createdAt": "2020-09-18T16:18:20Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -481,6 +562,172 @@ public static void multiply(Slice left, Slice right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4MzcxMA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491283710", "bodyText": "Scripting here is too much of a change for now, however seems like idea worth researching.\nThe whole point of this change is to ungeneralize and copy paste so that performance is increased.\nSee @kokosing comment about generalizing.", "author": "skrzypo987", "createdAt": "2020-09-19T06:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjIxNg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491056216", "bodyText": "no explanation how it all works, it's very hard to decipher it from looking at code", "author": "iirekm", "createdAt": "2020-09-18T16:18:46Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -481,6 +562,172 @@ public static void multiply(Slice left, Slice right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));\n+        long l1 = toUnsignedLong(getInt(left, 1));\n+        long l2 = toUnsignedLong(getInt(left, 2));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NDk2Mw==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491284963", "bodyText": "The domain of this class is binary operations. With knowledge about it multiplication is trivial. Al the actually non-trivial methods seems clearly commented like divide-related methods.\nLet me give you an analogy - Math.sin method does not document what sin is, it assumes that if you use Math class, you probably know math on a basic/intermediate level.", "author": "skrzypo987", "createdAt": "2020-09-19T06:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NjIxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NzkzNg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491057936", "bodyText": "why not javadoc?\n\nsimilarly - copy & paste to generalize or generate", "author": "iirekm", "createdAt": "2020-09-18T16:21:53Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -239,13 +271,41 @@ else if (rescaleFactor > 0) {\n             if (rescaleFactor >= POWERS_OF_TEN.length) {\n                 throwOverflowException();\n             }\n-            multiply(decimal, POWERS_OF_TEN[rescaleFactor], result);\n+            shiftLeftBy10(decimal, rescaleFactor, result);\n         }\n         else {\n             scaleDownTruncate(decimal, -rescaleFactor, result);\n         }\n     }\n \n+    // Multiplies by 10^rescaleFactor. Only positive rescaleFactor values are allowed\n+    private static void shiftLeftBy10(Slice decimal, int rescaleFactor, Slice result)\n+    {\n+        if (rescaleFactor <= MAX_POWER_OF_TEN_INT) {\n+            multiply(decimal, (int) longTenToNth(rescaleFactor), result);\n+        }\n+        else if (rescaleFactor <= MAX_POWER_OF_TEN_LONG) {\n+            multiply(decimal, longTenToNth(rescaleFactor), result);\n+        }\n+        else {\n+            multiply(POWERS_OF_TEN[rescaleFactor], decimal, result);\n+        }\n+    }\n+\n+    // Multiplies by 10^rescaleFactor. Only positive rescaleFactor values are allowed", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NjA3MQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491286071", "bodyText": "It is a copy-paste. Javadoc is rarely used in this class.", "author": "skrzypo987", "createdAt": "2020-09-19T06:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NzkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1ODg3OA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491058878", "bodyText": "according to \"clean code\" method should not have more than 3 params", "author": "iirekm", "createdAt": "2020-09-18T16:23:32Z", "path": "presto-main/src/main/java/io/prestosql/type/DecimalOperators.java", "diffHunk": "@@ -124,13 +124,32 @@ public static Slice addLongLongLong(Slice a, Slice b, int rescale, boolean left)\n     @UsedByGeneratedCode\n     public static Slice addShortLongLong(long a, Slice b, int rescale, boolean left)\n     {\n-        return internalAddLongLongLong(unscaledDecimal(a), b, rescale, left);\n+        return addLongShortLong(b, a, rescale, !left);\n     }\n \n     @UsedByGeneratedCode\n-    public static Slice addLongShortLong(Slice a, long b, int rescale, boolean left)\n+    public static Slice addLongShortLong(Slice a, long b, int rescale, boolean rescaleLeft)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NTcwNg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491285706", "bodyText": "1.Bytecode generator thinks otherwise (UsedByGeneratedCode annotation)\n2.Not changed in this PR", "author": "skrzypo987", "createdAt": "2020-09-19T06:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1ODg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1OTc5Nw==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491059797", "bodyText": "missing blank line", "author": "iirekm", "createdAt": "2020-09-18T16:25:10Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -69,6 +69,14 @@\n      */\n     private static final int[] POWERS_OF_FIVES_INT = new int[MAX_POWER_OF_FIVE_INT + 1];\n \n+    /**\n+     * 5^27 fits in 2^31.\n+     */\n+    private static final int MAX_POWER_OF_FIVE_LONG = 27;\n+    /**", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NzEwMg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491287102", "bodyText": "Why specifically here? Sometimes there is a blank line between constants and sometimes it is not.", "author": "skrzypo987", "createdAt": "2020-09-19T06:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1OTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2MDA2OQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491060069", "bodyText": "check not null", "author": "iirekm", "createdAt": "2020-09-18T16:25:39Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -481,6 +562,172 @@ public static void multiply(Slice left, Slice right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4MjkxMw==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491282913", "bodyText": "This is a highly optimized code, checking for null for defensive purposes will harm performance.\nI plan to clean up this class in the future, e.g. clearly distinct methods that needs arg checking.", "author": "skrzypo987", "createdAt": "2020-09-19T06:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2MDA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2MDIxNg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491060216", "bodyText": "check not null", "author": "iirekm", "createdAt": "2020-09-18T16:25:56Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -574,6 +821,115 @@ public static void multiply256(Slice left, Slice right, Slice result)\n         setRawInt(result, 7, (int) z7);\n     }\n \n+    public static void multiply256(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() >= NUMBER_OF_LONGS * Long.BYTES * 2);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI4NjMwMg==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r491286302", "bodyText": "not needed", "author": "skrzypo987", "createdAt": "2020-09-19T06:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2MDIxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYzNjQwOA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r507636408", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static void shiftLeftBy5(int[] value, int shift)\n          \n          \n            \n                private static void shiftLeftBy5Desctrutive(int[] value, int shift)\n          \n      \n    \n    \n  \n\n?", "author": "kokosing", "createdAt": "2020-10-19T10:23:02Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -1441,16 +1437,16 @@ private static void divide(long dividendLow, long dividendHigh, int dividendScal\n     /**\n      * Value must be a 256-bit slice\n      */\n-    private static void shiftLeftBy5(Slice value, int shift)\n+    private static void shiftLeftBy5(int[] value, int shift)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNTU2OA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508335568", "bodyText": "static import?", "author": "sopel39", "createdAt": "2020-10-20T09:08:13Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -480,6 +494,108 @@ public static void multiply(Slice left, Slice right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));\n+        long l1 = toUnsignedLong(getInt(left, 1));\n+        long l2 = toUnsignedLong(getInt(left, 2));\n+        int l3raw = getRawInt(left, 3);\n+        boolean leftNegative = isNegative(l3raw);\n+        long l3 = toUnsignedLong(unpackUnsignedInt(l3raw));\n+\n+        boolean rightNegative = right < 0;\n+        right = Math.abs(right);\n+        long r0 = right & LOW_32_BITS;\n+        long r1 = right >>> 32;\n+\n+        // the combinations below definitely result in an overflow\n+        if (r1 != 0 && l3 != 0) {\n+            throwOverflowException();\n+        }\n+\n+        long z0 = 0;\n+        long z1 = 0;\n+        long z2 = 0;\n+        long z3 = 0;\n+\n+        if (r0 != 0) {\n+            long accumulator = r0 * l0;\n+            z0 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + l1 * r0;\n+\n+            z1 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + l2 * r0;\n+\n+            z2 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + l3 * r0;\n+\n+            z3 = accumulator & LOW_32_BITS;\n+\n+            if ((accumulator >>> 32) != 0) {\n+                throwOverflowException();\n+            }\n+        }\n+\n+        if (r1 != 0) {\n+            long accumulator = l0 * r1 + z1;\n+            z1 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + l1 * r1 + z2;\n+\n+            z2 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + l2 * r1 + z3;\n+\n+            z3 = accumulator & LOW_32_BITS;\n+\n+            if ((accumulator >>> 32) != 0) {\n+                throwOverflowException();\n+            }\n+        }\n+\n+        pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n+    }\n+\n+    public static void multiply(long left, long right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+        boolean rightNegative = right < 0;\n+        boolean leftNegative = left < 0;\n+        left = Math.abs(left);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0NDYyMA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508344620", "bodyText": "move below usage (other assertMultiply methods)", "author": "sopel39", "createdAt": "2020-10-20T09:21:20Z", "path": "presto-spi/src/test/java/io/prestosql/spi/type/TestUnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -759,4 +763,43 @@ private static Slice negate(Slice slice)\n         }\n         return ints;\n     }\n+\n+    private static boolean isShort(BigInteger value)\n+    {\n+        return value.abs().shiftRight(63).equals(BigInteger.ZERO);\n+    }\n+\n+    private static void assertMultiply(BigInteger a, BigInteger b, BigInteger result)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0NTY2NQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508345665", "bodyText": "static import?", "author": "sopel39", "createdAt": "2020-10-20T09:22:50Z", "path": "presto-main/src/main/java/io/prestosql/type/DecimalOperators.java", "diffHunk": "@@ -260,7 +260,14 @@ public static long multiplyShortShortShort(long a, long b)\n     @UsedByGeneratedCode\n     public static Slice multiplyShortShortLong(long a, long b)\n     {\n-        return multiplyLongLongLong(encodeUnscaledValue(a), encodeUnscaledValue(b));\n+        try {\n+            Slice result = UnscaledDecimal128Arithmetic.multiply(a, b);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0ODU0MQ==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508348541", "bodyText": "call it r0", "author": "sopel39", "createdAt": "2020-10-20T09:27:01Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -596,6 +688,32 @@ public static void multiply(long left, long right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(long left, int right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+        boolean rightNegative = right < 0;\n+        boolean leftNegative = left < 0;\n+        left = Math.abs(left);\n+        right = Math.abs(right);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0OTA2OA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508349068", "bodyText": "call it r0", "author": "sopel39", "createdAt": "2020-10-20T09:27:44Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -556,6 +610,44 @@ public static void multiply(Slice left, long right, Slice result)\n         pack(result, (int) z0, (int) z1, (int) z2, (int) z3, leftNegative != rightNegative);\n     }\n \n+    public static void multiply(Slice left, int right, Slice result)\n+    {\n+        checkArgument(result.length() == NUMBER_OF_LONGS * Long.BYTES);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));\n+        long l1 = toUnsignedLong(getInt(left, 1));\n+        long l2 = toUnsignedLong(getInt(left, 2));\n+        int l3raw = getRawInt(left, 3);\n+        boolean leftNegative = isNegative(l3raw);\n+        long l3 = toUnsignedLong(unpackUnsignedInt(l3raw));\n+\n+        boolean rightNegative = right < 0;\n+        right = Math.abs(right);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1MDU2OA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508350568", "bodyText": "what about negative decimal (+ add test)?", "author": "sopel39", "createdAt": "2020-10-20T09:29:56Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -210,13 +210,32 @@ else if (rescaleFactor > 0) {\n             if (rescaleFactor >= POWERS_OF_TEN.length) {\n                 throwOverflowException();\n             }\n-            multiply(decimal, POWERS_OF_TEN[rescaleFactor], result);\n+            shiftLeftBy10(decimal, rescaleFactor, result);\n         }\n         else {\n             scaleDownRoundUp(decimal, -rescaleFactor, result);\n         }\n     }\n \n+    public static Slice rescale(long decimal, int rescaleFactor)\n+    {\n+        Slice result = unscaledDecimal();\n+        if (rescaleFactor == 0) {\n+            result.setLong(0, decimal);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1NzA1OA==", "url": "https://github.com/trinodb/trino/pull/5181#discussion_r508357058", "bodyText": "call it r0", "author": "sopel39", "createdAt": "2020-10-20T09:39:48Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -807,6 +820,115 @@ public static void multiply256(Slice left, Slice right, Slice result)\n         setRawInt(result, 7, (int) z7);\n     }\n \n+    public static void multiply256(Slice left, long right, Slice result)\n+    {\n+        checkArgument(result.length() >= NUMBER_OF_LONGS * Long.BYTES * 2);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));\n+        long l1 = toUnsignedLong(getInt(left, 1));\n+        long l2 = toUnsignedLong(getInt(left, 2));\n+        long l3 = toUnsignedLong(getInt(left, 3));\n+\n+        right = Math.abs(right);\n+        long r0 = right & LOW_32_BITS;\n+        long r1 = right >>> 32;\n+\n+        long z0 = 0;\n+        long z1 = 0;\n+        long z2 = 0;\n+        long z3 = 0;\n+        long z4 = 0;\n+        long z5 = 0;\n+\n+        if (l0 != 0) {\n+            long accumulator = r0 * l0;\n+            z0 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + r1 * l0;\n+\n+            z1 = accumulator & LOW_32_BITS;\n+            z2 = accumulator >>> 32;\n+        }\n+\n+        if (l1 != 0) {\n+            long accumulator = r0 * l1 + z1;\n+            z1 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + r1 * l1 + z2;\n+\n+            z2 = accumulator & LOW_32_BITS;\n+            z3 = accumulator >>> 32;\n+        }\n+\n+        if (l2 != 0) {\n+            long accumulator = r0 * l2 + z2;\n+            z2 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + r1 * l2 + z3;\n+\n+            z3 = accumulator & LOW_32_BITS;\n+            z4 = accumulator >>> 32;\n+        }\n+\n+        if (l3 != 0) {\n+            long accumulator = r0 * l3 + z3;\n+            z3 = accumulator & LOW_32_BITS;\n+            accumulator = (accumulator >>> 32) + r1 * l3 + z4;\n+\n+            z4 = accumulator & LOW_32_BITS;\n+            z5 = accumulator >>> 32;\n+        }\n+\n+        setRawInt(result, 0, (int) z0);\n+        setRawInt(result, 1, (int) z1);\n+        setRawInt(result, 2, (int) z2);\n+        setRawInt(result, 3, (int) z3);\n+        setRawInt(result, 4, (int) z4);\n+        setRawInt(result, 5, (int) z5);\n+        setRawInt(result, 6, 0);\n+        setRawInt(result, 7, 0);\n+    }\n+\n+    public static void multiply256(Slice left, int right, Slice result)\n+    {\n+        checkArgument(result.length() >= NUMBER_OF_LONGS * Long.BYTES * 2);\n+\n+        long l0 = toUnsignedLong(getInt(left, 0));\n+        long l1 = toUnsignedLong(getInt(left, 1));\n+        long l2 = toUnsignedLong(getInt(left, 2));\n+        long l3 = toUnsignedLong(getInt(left, 3));\n+\n+        right = Math.abs(right);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5d89badf4952e7e67a9068a29c56e6a32e5a5894", "url": "https://github.com/trinodb/trino/commit/5d89badf4952e7e67a9068a29c56e6a32e5a5894", "message": "Add static imports", "committedDate": "2020-10-21T09:25:40Z", "type": "commit"}, {"oid": "616235d8babfc341390a9903dba02cbcf3fb1c7e", "url": "https://github.com/trinodb/trino/commit/616235d8babfc341390a9903dba02cbcf3fb1c7e", "message": "Optimize short decimal multiplication", "committedDate": "2020-10-21T09:25:40Z", "type": "commit"}, {"oid": "10d8a3c07f95ff4fcdef6e48c4bd0d8969da6734", "url": "https://github.com/trinodb/trino/commit/10d8a3c07f95ff4fcdef6e48c4bd0d8969da6734", "message": "Use short decimal multiplication in some decimal casts", "committedDate": "2020-10-21T09:25:40Z", "type": "commit"}, {"oid": "a5939c7456eb6e46fcef82a573f9448edebb303b", "url": "https://github.com/trinodb/trino/commit/a5939c7456eb6e46fcef82a573f9448edebb303b", "message": "Optimize decimal rescaling\n\nWhen possible, rescaling is now done using 32-bit or 64-bit decimals\ninstead of 128-bit", "committedDate": "2020-10-21T09:25:40Z", "type": "commit"}, {"oid": "1e7e1038d8aba512658aae5b2018b287994886b4", "url": "https://github.com/trinodb/trino/commit/1e7e1038d8aba512658aae5b2018b287994886b4", "message": "Optimize decimal division\n\nAdds specialized methods for 64 and 32-bit values instead of\nwrapping them to Slice.", "committedDate": "2020-10-21T09:25:40Z", "type": "commit"}, {"oid": "d103820280e5600b8affe56db5d0d89509c89cd5", "url": "https://github.com/trinodb/trino/commit/d103820280e5600b8affe56db5d0d89509c89cd5", "message": "Remove unused methods", "committedDate": "2020-10-21T09:25:41Z", "type": "commit"}, {"oid": "af1c03916ec82aa91a346fe5ee278a53949f726b", "url": "https://github.com/trinodb/trino/commit/af1c03916ec82aa91a346fe5ee278a53949f726b", "message": "Simplify 128-bit multiplication\n\nAvoids wrapping int[] array into Slice just to unwrap it.", "committedDate": "2020-10-21T09:25:41Z", "type": "commit"}, {"oid": "96500656127dc00a7f6099b29af4d5b161142fde", "url": "https://github.com/trinodb/trino/commit/96500656127dc00a7f6099b29af4d5b161142fde", "message": "Remove unnecessary bit masking operations", "committedDate": "2020-10-21T09:25:41Z", "type": "commit"}, {"oid": "9cfd46b93b7b76071fb89cb96d192aa8b57cb700", "url": "https://github.com/trinodb/trino/commit/9cfd46b93b7b76071fb89cb96d192aa8b57cb700", "message": "Update params of BenchmarkDecimalOperators\n\nAdditionally removed some warnings", "committedDate": "2020-10-21T09:25:41Z", "type": "commit"}, {"oid": "9cfd46b93b7b76071fb89cb96d192aa8b57cb700", "url": "https://github.com/trinodb/trino/commit/9cfd46b93b7b76071fb89cb96d192aa8b57cb700", "message": "Update params of BenchmarkDecimalOperators\n\nAdditionally removed some warnings", "committedDate": "2020-10-21T09:25:41Z", "type": "forcePushed"}]}