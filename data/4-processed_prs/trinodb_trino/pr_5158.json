{"pr_number": 5158, "pr_title": "Add T-digest type and functions", "pr_createdAt": "2020-09-14T16:25:43Z", "pr_url": "https://github.com/trinodb/trino/pull/5158", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2OTUzMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r492269533", "bodyText": "This should throw a proper Presto exception with INVALID_FUNCTION_ARGUMENT", "author": "martint", "createdAt": "2020-09-21T18:40:34Z", "path": "presto-main/src/main/java/io/prestosql/operator/aggregation/ApproximateLongPercentileAggregations.java", "diffHunk": "@@ -35,49 +38,52 @@\n     private ApproximateLongPercentileAggregations() {}\n \n     @InputFunction\n-    public static void input(@AggregationState DigestAndPercentileState state, @SqlType(StandardTypes.BIGINT) long value, @SqlType(StandardTypes.DOUBLE) double percentile)\n+    public static void input(@AggregationState TDigestAndPercentileState state, @SqlType(StandardTypes.BIGINT) long value, @SqlType(StandardTypes.DOUBLE) double percentile)\n     {\n-        QuantileDigest digest = state.getDigest();\n-\n-        if (digest == null) {\n-            digest = new QuantileDigest(0.01);\n-            state.setDigest(digest);\n-            state.addMemoryUsage(digest.estimatedInMemorySizeInBytes());\n-        }\n-\n-        state.addMemoryUsage(-digest.estimatedInMemorySizeInBytes());\n-        digest.add(value);\n-        state.addMemoryUsage(digest.estimatedInMemorySizeInBytes());\n-\n-        // use last percentile\n-        state.setPercentile(percentile);\n+        ApproximateDoublePercentileAggregations.input(state, toDoubleExact(value), percentile);\n     }\n \n     @InputFunction\n-    public static void weightedInput(@AggregationState DigestAndPercentileState state, @SqlType(StandardTypes.BIGINT) long value, @SqlType(StandardTypes.DOUBLE) double weight, @SqlType(StandardTypes.DOUBLE) double percentile)\n+    public static void weightedInput(@AggregationState TDigestAndPercentileState state, @SqlType(StandardTypes.BIGINT) long value, @SqlType(StandardTypes.DOUBLE) double weight, @SqlType(StandardTypes.DOUBLE) double percentile)\n     {\n-        checkWeight(weight);\n+        ApproximateDoublePercentileAggregations.weightedInput(state, toDoubleExact(value), weight, percentile);\n+    }\n \n-        QuantileDigest digest = state.getDigest();\n+    @CombineFunction\n+    public static void combine(@AggregationState TDigestAndPercentileState state, TDigestAndPercentileState otherState)\n+    {\n+        ApproximateDoublePercentileAggregations.combine(state, otherState);\n+    }\n \n-        if (digest == null) {\n-            digest = new QuantileDigest(0.01);\n-            state.setDigest(digest);\n-            state.addMemoryUsage(digest.estimatedInMemorySizeInBytes());\n+    @OutputFunction(StandardTypes.BIGINT)\n+    public static void output(@AggregationState TDigestAndPercentileState state, BlockBuilder out)\n+    {\n+        TDigest digest = state.getDigest();\n+        double percentile = state.getPercentile();\n+        if (digest == null || digest.getCount() == 0.0) {\n+            out.appendNull();\n         }\n+        else {\n+            checkState(percentile != -1.0, \"Percentile is missing\");\n+            checkCondition(0 <= percentile && percentile <= 1, INVALID_FUNCTION_ARGUMENT, \"Percentile must be between 0 and 1\");\n+            BIGINT.writeLong(out, Math.round(digest.valueAt(percentile)));\n+        }\n+    }\n \n-        state.addMemoryUsage(-digest.estimatedInMemorySizeInBytes());\n-        digest.add(value, weight);\n-        state.addMemoryUsage(digest.estimatedInMemorySizeInBytes());\n-\n-        // use last percentile\n-        state.setPercentile(percentile);\n+    private static double toDoubleExact(long value)\n+    {\n+        double doubleValue = (double) value;\n+        checkState((long) doubleValue == value, \"no exact double representation for long: %s\", value);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3MjgyNQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r492272825", "bodyText": "Throw proper Presto exception", "author": "martint", "createdAt": "2020-09-21T18:46:33Z", "path": "presto-main/src/main/java/io/prestosql/operator/aggregation/ApproximateLongPercentileArrayAggregations.java", "diffHunk": "@@ -96,35 +68,16 @@ public static void output(@AggregationState DigestAndPercentileArrayState state,\n \n         for (int i = 0; i < percentiles.size(); i++) {\n             Double percentile = percentiles.get(i);\n-            BIGINT.writeLong(blockBuilder, digest.getQuantile(percentile));\n+            BIGINT.writeLong(blockBuilder, Math.round(digest.valueAt(percentile)));\n         }\n \n         out.closeEntry();\n     }\n \n-    private static void initializePercentilesArray(@AggregationState DigestAndPercentileArrayState state, Block percentilesArrayBlock)\n+    private static double toDoubleExact(long value)\n     {\n-        if (state.getPercentiles() == null) {\n-            ImmutableList.Builder<Double> percentilesListBuilder = ImmutableList.builder();\n-\n-            for (int i = 0; i < percentilesArrayBlock.getPositionCount(); i++) {\n-                checkCondition(!percentilesArrayBlock.isNull(i), INVALID_FUNCTION_ARGUMENT, \"Percentile cannot be null\");\n-                double percentile = DOUBLE.getDouble(percentilesArrayBlock, i);\n-                checkCondition(0 <= percentile && percentile <= 1, INVALID_FUNCTION_ARGUMENT, \"Percentile must be between 0 and 1\");\n-                percentilesListBuilder.add(percentile);\n-            }\n-\n-            state.setPercentiles(percentilesListBuilder.build());\n-        }\n-    }\n-\n-    private static void initializeDigest(@AggregationState DigestAndPercentileArrayState state)\n-    {\n-        QuantileDigest digest = state.getDigest();\n-        if (digest == null) {\n-            digest = new QuantileDigest(0.01);\n-            state.setDigest(digest);\n-            state.addMemoryUsage(digest.estimatedInMemorySizeInBytes());\n-        }\n+        double doubleValue = (double) value;\n+        checkState((long) doubleValue == value, \"no exact double representation for long: %s\", value);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NjAwMA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r492276000", "bodyText": "We can use TDigest as the native type instead of serializing and deserializing. See, for instance, LongTimestampType", "author": "martint", "createdAt": "2020-09-21T18:52:24Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TDigestType.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.type;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import io.airlift.slice.Slice;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.block.BlockBuilder;\n+import io.prestosql.spi.connector.ConnectorSession;\n+\n+public class TDigestType\n+        extends AbstractVariableWidthType\n+{\n+    public static final TDigestType TDIGEST = new TDigestType();\n+\n+    @JsonCreator\n+    public TDigestType()\n+    {\n+        super(new TypeSignature(StandardTypes.TDIGEST), Slice.class);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1NTM1Mw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r496155353", "bodyText": "This may be more efficient with fastutil's indirect sorting (you should give it a try). Something like:\nint[] indexes = new int[percentiles.size()];\ndouble[] sortedPercentiles = new double[percentiles.size()];\nfor (int i = 0; i < indexes.length; i++) {\n    indexes[i] = i;\n    sortedPercentiles[i] = percentiles.get(i);\n}\n\nit.unimi.dsi.fastutil.Arrays.quickSort(0, percentiles.size(), (a, b) -> Doubles.compare(sortedPercentiles[a], sortedPercentiles[b]), (a, b) -> {\n    double tempPercentile = sortedPercentiles[a];\n    sortedPercentiles[a] = sortedPercentiles[b];\n    sortedPercentiles[b] = tempPercentile;\n\n    int tempIndex = indexes[a];\n    indexes[a] = indexes[b];\n    indexes[b] = tempIndex;\n});\n\nList<Double> valuesAtPercentiles = digest.valuesAt(Doubles.asList(sortedPercentiles));\nList<Double> result = new ArrayList<>(valuesAtPercentiles.size());\nfor (int i = 0; i < valuesAtPercentiles.size(); i++) {\n    result.add(valuesAtPercentiles.get(indexes[i]));\n}\n\nreturn result;", "author": "martint", "createdAt": "2020-09-28T18:37:05Z", "path": "presto-main/src/main/java/io/prestosql/operator/aggregation/ApproximateDoublePercentileArrayAggregations.java", "diffHunk": "@@ -96,14 +100,33 @@ public static void output(@AggregationState TDigestAndPercentileArrayState state\n \n         BlockBuilder blockBuilder = out.beginBlockEntry();\n \n-        for (int i = 0; i < percentiles.size(); i++) {\n-            Double percentile = percentiles.get(i);\n-            DOUBLE.writeDouble(blockBuilder, digest.valueAt(percentile));\n+        List<Double> valuesAtPercentiles = valuesAtPercentiles(digest, percentiles);\n+        for (double value : valuesAtPercentiles) {\n+            DOUBLE.writeDouble(blockBuilder, value);\n         }\n \n         out.closeEntry();\n     }\n \n+    public static List<Double> valuesAtPercentiles(TDigest digest, List<Double> percentiles)\n+    {\n+        if (Ordering.natural().isOrdered(percentiles)) {\n+            return digest.valuesAt(percentiles);\n+        }\n+        else {\n+            // TDigest requires that percentiles list be ordered. Sort the percentiles list and rearrange the output according to original percentile order.\n+            List<Double> sortedPercentiles = Ordering.natural().sortedCopy(percentiles);\n+            List<Double> valuesAtPercentiles = digest.valuesAt(sortedPercentiles);\n+            Map<Double, Double> percentilesToValues = new HashMap<>();\n+            for (int i = 0; i < sortedPercentiles.size(); i++) {\n+                percentilesToValues.put(sortedPercentiles.get(i), valuesAtPercentiles.get(i));\n+            }\n+            return percentiles.stream()\n+                    .map(percentilesToValues::get)\n+                    .collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzExNjg4NA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497116884", "bodyText": "Does WHERE false not work?", "author": "martint", "createdAt": "2020-09-29T22:59:49Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestTDigestFunctions.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.sql.query;\n+\n+import io.prestosql.testing.MaterializedResult;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+\n+import static java.lang.Math.round;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestTDigestFunctions\n+{\n+    private QueryAssertions assertions;\n+\n+    @BeforeClass\n+    public void init()\n+    {\n+        assertions = new QueryAssertions();\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public void teardown()\n+    {\n+        assertions.close();\n+        assertions = null;\n+    }\n+\n+    @Test\n+    public void testValueAtQuantile()\n+    {\n+        assertThat(assertions.query(\n+                \"SELECT value_at_quantile(tdigest_agg(d), 0.75e0) \" +\n+                        \"FROM (VALUES 0.1e0, 0.2e0, 0.3e0, 0.4e0) T(d)\"))\n+                .matches(\"VALUES 0.4e0\");\n+\n+        assertThat(assertions.query(\n+                \"SELECT value_at_quantile(tdigest_agg(d), 0.75e0) \" +\n+                        \"FROM (VALUES -0.1e0, -0.2e0, -0.3e0, -0.4e0) T(d)\"))\n+                .matches(\"VALUES -0.1e0\");\n+\n+        assertThat(assertions.query(\n+                \"SELECT value_at_quantile(tdigest_agg(d), 0.9e0) \" +\n+                        \"FROM (VALUES 0.1e0, 0.1e0, 0.1e0, 0.1e0, 10e0) T(d)\"))\n+                .matches(\"VALUES 10e0\");\n+    }\n+\n+    @Test\n+    public void testValuesAtQuantiles()\n+    {\n+        assertThat(assertions.query(\n+                \"SELECT values_at_quantiles(tdigest_agg(d), ARRAY[0.0001e0, 0.75e0, 0.85e0]) \" +\n+                        \"FROM (VALUES 0.1e0, 0.2e0, 0.3e0, 0.4e0) T(d)\"))\n+                .matches(\"VALUES ARRAY[0.1e0, 0.4e0, 0.4e0]\");\n+\n+        assertThat(assertions.query(\n+                \"SELECT values_at_quantiles(tdigest_agg(d), ARRAY[0.0001e0, 0.75e0, 0.85e0]) \" +\n+                        \"FROM (VALUES -0.1e0, -0.2e0, -0.3e0, -0.4e0) T(d)\"))\n+                .matches(\"VALUES ARRAY[-0.4e0, -0.1e0, -0.10]\");\n+\n+        assertThat(assertions.query(\n+                \"SELECT values_at_quantiles(tdigest_agg(d), ARRAY[0.0001e0, 0.75e0, 0.85e0]) \" +\n+                        \"FROM (VALUES 0.1e0, 0.1e0, 0.1e0, 0.1e0, 10e0) T(d)\"))\n+                .matches(\"VALUES ARRAY[0.1e0, 0.1e0, 10.0e0]\");\n+    }\n+\n+    @Test\n+    public void testEmptyArrayOfQuantiles()\n+    {\n+        assertThat(assertions.query(\n+                \"SELECT values_at_quantiles(tdigest_agg(d), ARRAY[]) \" +\n+                        \"FROM (VALUES 0.1e0, 0.2e0, 0.3e0, 0.4e0) T(d)\"))\n+                .matches(\"VALUES CAST(ARRAY[] AS array(double))\");\n+    }\n+\n+    @Test\n+    public void testEmptyTDigestInput()\n+    {\n+        assertThat(assertions.query(\n+                \"SELECT tdigest_agg(d) FROM (SELECT 1e0 WHERE 1 = 0) T(d)\"))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1MzgyMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497753823", "bodyText": "It works. I'll change to WHERE false", "author": "kasiafi", "createdAt": "2020-09-30T19:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzExNjg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzExODY5OA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497118698", "bodyText": "Why noindex?", "author": "martint", "createdAt": "2020-09-29T23:02:16Z", "path": "presto-docs/src/main/sphinx/functions/aggregate.rst", "diffHunk": "@@ -320,6 +309,11 @@ Approximate Aggregate Functions\n \n     See :doc:`qdigest`.\n \n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1Mzg3OQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497753879", "bodyText": "Otherwise docs won't build because there's another merge() function elsewhere.", "author": "kasiafi", "createdAt": "2020-09-30T19:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzExODY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzExOTU5OQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497119599", "bodyText": "Capitalize Presto", "author": "martint", "createdAt": "2020-09-29T23:03:33Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,45 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The presto type for this data structure is called ``tdigest``.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMDQxMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497120413", "bodyText": "without losing precision -> that's not accurate. Every time an element is added to a t-digest, precision is sacrificed somewhere.", "author": "martint", "createdAt": "2020-09-29T23:04:39Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,45 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The presto type for this data structure is called ``tdigest``.\n+T-digests may be merged without losing precision, and for storage", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1Mzk0Mw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497753943", "bodyText": "What do you suggest?", "author": "kasiafi", "createdAt": "2020-09-30T19:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMDQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2Njk1Mg==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497766952", "bodyText": "I'd just remove that qualifier and leave it at \"T-digests may be merged\"", "author": "martint", "createdAt": "2020-09-30T20:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMDQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMTA4NA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497121084", "bodyText": "Why :noindex: for all of these?", "author": "martint", "createdAt": "2020-09-29T23:05:34Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,45 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The presto type for this data structure is called ``tdigest``.\n+T-digests may be merged without losing precision, and for storage\n+and retrieval they may be cast to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1Mzk3OQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497753979", "bodyText": "This is weird. Apparently, I can remove one arbitrary :noindex: but it I remove two, it fails.", "author": "kasiafi", "createdAt": "2020-09-30T19:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMTUxNw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497121517", "bodyText": "We may want to clarify that this is an aggregation function.", "author": "martint", "createdAt": "2020-09-29T23:06:08Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,45 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The presto type for this data structure is called ``tdigest``.\n+T-digests may be merged without losing precision, and for storage\n+and retrieval they may be cast to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Merges all input ``tdigest``\\ s into a single ``tdigest``.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMzMwNg==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497123306", "bodyText": "T-digest", "author": "martint", "createdAt": "2020-09-29T23:08:36Z", "path": "presto-docs/src/main/sphinx/language/types.rst", "diffHunk": "@@ -361,3 +361,20 @@ can be reused.  For example, one may be interested in a daily reading of the 99t\n percentile values that are read over the course of a week.  Instead of calculating\n the past week of data with ``approx_percentile``, ``qdigest``\\ s could be stored\n daily, and quickly merged to retrieve the 99th percentile value.\n+\n+T-Digest\n+---------------\n+\n+.. _tdigest_type:\n+\n+``TDigest``\n+^^^^^^^^^^^\n+\n+A t-digest (tdigest) is a summary structure which, similarly to qdigest, captures the", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyMzk0NA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497123944", "bodyText": "Also performance and memory utilization. T-digest is more efficient to operate on that qdigest.", "author": "martint", "createdAt": "2020-09-29T23:09:34Z", "path": "presto-docs/src/main/sphinx/language/types.rst", "diffHunk": "@@ -361,3 +361,20 @@ can be reused.  For example, one may be interested in a daily reading of the 99t\n percentile values that are read over the course of a week.  Instead of calculating\n the past week of data with ``approx_percentile``, ``qdigest``\\ s could be stored\n daily, and quickly merged to retrieve the 99th percentile value.\n+\n+T-Digest\n+---------------\n+\n+.. _tdigest_type:\n+\n+``TDigest``\n+^^^^^^^^^^^\n+\n+A t-digest (tdigest) is a summary structure which, similarly to qdigest, captures the\n+approximate distribution of data for a given input set, and can be queried to retrieve\n+approximate quantile values from the distribution.  The main advantage of tdigest over", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyNDY2Mg==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497124662", "bodyText": "This is an implementation detail. We should omit it.", "author": "martint", "createdAt": "2020-09-29T23:10:28Z", "path": "presto-docs/src/main/sphinx/language/types.rst", "diffHunk": "@@ -361,3 +361,20 @@ can be reused.  For example, one may be interested in a daily reading of the 99t\n percentile values that are read over the course of a week.  Instead of calculating\n the past week of data with ``approx_percentile``, ``qdigest``\\ s could be stored\n daily, and quickly merged to retrieve the 99th percentile value.\n+\n+T-Digest\n+---------------\n+\n+.. _tdigest_type:\n+\n+``TDigest``\n+^^^^^^^^^^^\n+\n+A t-digest (tdigest) is a summary structure which, similarly to qdigest, captures the\n+approximate distribution of data for a given input set, and can be queried to retrieve\n+approximate quantile values from the distribution.  The main advantage of tdigest over\n+qdigest is its higher accuracy at high and low percentiles.\n+\n+T-digests are additive, meaning they can be merged together without losing precision.\n+\n+The :func:`approx_percentile` functions use t-digest as an underlying structure.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyNDcxMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497124713", "bodyText": "This is an implementation detail. We should omit it.", "author": "martint", "createdAt": "2020-09-29T23:10:32Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,45 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The presto type for this data structure is called ``tdigest``.\n+T-digests may be merged without losing precision, and for storage\n+and retrieval they may be cast to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given\n+    the number ``quantile`` between 0 and 1.\n+\n+.. function:: values_at_quantiles(tdigest, quantiles) -> array<double>\n+    :noindex:\n+\n+    Returns the approximate percentile values as an array given the input\n+    T-digest and array of values between 0 and 1 which\n+    represent the quantiles to return.\n+\n+.. function:: tdigest_agg(x) -> tdigest\n+\n+    Returns the ``tdigest`` which is composed of  all input values of ``x``.\n+\n+.. function:: tdigest_agg(x, w) -> tdigest\n+    :noindex:\n+\n+    Returns the ``tdigest`` which is composed of  all input values of ``x`` using\n+    the per-item weight ``w``.\n+\n+Presto implements the ``approx_percentile`` function with the T-digest", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyNjIwNQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r497126205", "bodyText": "The canonical form for array and other structural types uses parenthesis instead of <>: array(T)", "author": "martint", "createdAt": "2020-09-29T23:12:34Z", "path": "presto-docs/src/main/sphinx/functions/qdigest.rst", "diffHunk": "@@ -22,10 +22,10 @@ Functions\n \n .. function:: value_at_quantile(qdigest(T), quantile) -> T\n \n-    Returns the approximate percentile values from the quantile digest given\n+    Returns the approximate percentile value from the quantile digest given\n     the number ``quantile`` between 0 and 1.\n \n-.. function:: values_at_quantiles(qdigest(T), quantiles) -> T\n+.. function:: values_at_quantiles(qdigest(T), quantiles) -> array<T>", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NjY0OQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498466649", "bodyText": "Add a introductory sentence", "author": "mosabua", "createdAt": "2020-10-01T19:25:31Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ4NTkwMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498485903", "bodyText": "Could you please help me with that? Isn't the data structure description enough for an introduction?", "author": "kasiafi", "createdAt": "2020-10-01T20:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NjY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NzM1OA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498467358", "bodyText": "can instead of may ?", "author": "mosabua", "createdAt": "2020-10-01T19:27:05Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NzQ0NA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498467444", "bodyText": "to and from", "author": "mosabua", "createdAt": "2020-10-01T19:27:17Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2ODIwMQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498468201", "bodyText": "I think you can just say\nAggregates all inputs into a single ``tdigest``.", "author": "mosabua", "createdAt": "2020-10-01T19:28:49Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2ODQ2Ng==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498468466", "bodyText": "T-digest, given", "author": "mosabua", "createdAt": "2020-10-01T19:29:22Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2ODYyNQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498468625", "bodyText": "array, given", "author": "mosabua", "createdAt": "2020-10-01T19:29:42Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given\n+    the number ``quantile`` between 0 and 1.\n+\n+.. function:: values_at_quantiles(tdigest, quantiles) -> array<double>\n+    :noindex:\n+\n+    Returns the approximate percentile values as an array given the input", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTA5MQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498469091", "bodyText": "and an array of values between 0 and 1, which represent the quantiles to return.", "author": "mosabua", "createdAt": "2020-10-01T19:30:39Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given\n+    the number ``quantile`` between 0 and 1.\n+\n+.. function:: values_at_quantiles(tdigest, quantiles) -> array<double>\n+    :noindex:\n+\n+    Returns the approximate percentile values as an array given the input\n+    T-digest and array of values between 0 and 1 which", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTU0Mg==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498469542", "bodyText": "Composes all input values of x into a T-digest.\nAnd need to add what x is...", "author": "mosabua", "createdAt": "2020-10-01T19:31:41Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given\n+    the number ``quantile`` between 0 and 1.\n+\n+.. function:: values_at_quantiles(tdigest, quantiles) -> array<double>\n+    :noindex:\n+\n+    Returns the approximate percentile values as an array given the input\n+    T-digest and array of values between 0 and 1 which\n+    represent the quantiles to return.\n+\n+.. function:: tdigest_agg(x) -> tdigest\n+\n+    Returns the ``tdigest`` which is composed of  all input values of ``x``.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ5OTc3OA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498499778", "bodyText": "And need to add what x is...\n\nShould I say that x are numeric values? I think it's rather obvious. What else could I add here?", "author": "kasiafi", "createdAt": "2020-10-01T20:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxODIxNg==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498518216", "bodyText": "well... what kind of numeric types work? I assume all .. but then we should say that", "author": "mosabua", "createdAt": "2020-10-01T21:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTc0MA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498469740", "bodyText": "Similar to above and explain x and w", "author": "mosabua", "createdAt": "2020-10-01T19:32:09Z", "path": "presto-docs/src/main/sphinx/functions/tdigest.rst", "diffHunk": "@@ -0,0 +1,41 @@\n+=========================\n+T-Digest Functions\n+=========================\n+\n+Data Structures\n+---------------\n+\n+A T-digest is a data sketch which stores approximate percentile\n+information.  The Presto type for this data structure is called ``tdigest``.\n+T-digests may be merged, and for storage and retrieval they may be cast\n+to/from ``VARBINARY``.\n+\n+Functions\n+---------\n+\n+.. function:: merge(tdigest) -> tdigest\n+    :noindex:\n+\n+    Aggregation function. Merges all input ``tdigest``\\ s into a single ``tdigest``.\n+\n+.. function:: value_at_quantile(tdigest, quantile) -> double\n+    :noindex:\n+\n+    Returns the approximate percentile value from the T-digest given\n+    the number ``quantile`` between 0 and 1.\n+\n+.. function:: values_at_quantiles(tdigest, quantiles) -> array<double>\n+    :noindex:\n+\n+    Returns the approximate percentile values as an array given the input\n+    T-digest and array of values between 0 and 1 which\n+    represent the quantiles to return.\n+\n+.. function:: tdigest_agg(x) -> tdigest\n+\n+    Returns the ``tdigest`` which is composed of  all input values of ``x``.\n+\n+.. function:: tdigest_agg(x, w) -> tdigest\n+\n+    Returns the ``tdigest`` which is composed of  all input values of ``x`` using", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMDczMw==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498500733", "bodyText": "It says per-item weight w, so I consider w explained. I added a note that w must be >= 1.", "author": "kasiafi", "createdAt": "2020-10-01T20:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxODQ1NQ==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498518455", "bodyText": "any < restriction for w?", "author": "mosabua", "createdAt": "2020-10-01T21:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0MTI0OA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498641248", "bodyText": "No upper bound restriction.\nI added information that x and w can be of any numeric type.", "author": "kasiafi", "createdAt": "2020-10-02T06:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2OTk5OA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498469998", "bodyText": "input set. It can be queried", "author": "mosabua", "createdAt": "2020-10-01T19:32:41Z", "path": "presto-docs/src/main/sphinx/language/types.rst", "diffHunk": "@@ -361,3 +361,19 @@ can be reused.  For example, one may be interested in a daily reading of the 99t\n percentile values that are read over the course of a week.  Instead of calculating\n the past week of data with ``approx_percentile``, ``qdigest``\\ s could be stored\n daily, and quickly merged to retrieve the 99th percentile value.\n+\n+T-Digest\n+---------------\n+\n+.. _tdigest_type:\n+\n+``TDigest``\n+^^^^^^^^^^^\n+\n+A T-digest (tdigest) is a summary structure which, similarly to qdigest, captures the\n+approximate distribution of data for a given input set, and can be queried to retrieve", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTA4MA==", "url": "https://github.com/trinodb/trino/pull/5158#discussion_r498471080", "bodyText": "TDigest has the following advantages compared to QDigest:\n\n* higher performance\n* lower memory usage\n* higher accuracy and high and low percentiles", "author": "mosabua", "createdAt": "2020-10-01T19:34:59Z", "path": "presto-docs/src/main/sphinx/language/types.rst", "diffHunk": "@@ -361,3 +361,19 @@ can be reused.  For example, one may be interested in a daily reading of the 99t\n percentile values that are read over the course of a week.  Instead of calculating\n the past week of data with ``approx_percentile``, ``qdigest``\\ s could be stored\n daily, and quickly merged to retrieve the 99th percentile value.\n+\n+T-Digest\n+---------------\n+\n+.. _tdigest_type:\n+\n+``TDigest``\n+^^^^^^^^^^^\n+\n+A T-digest (tdigest) is a summary structure which, similarly to qdigest, captures the\n+approximate distribution of data for a given input set, and can be queried to retrieve\n+approximate quantile values from the distribution.  The advantages of tdigest over", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "432e11f94e73770cb94de2c0243e25d2d740f026", "url": "https://github.com/trinodb/trino/commit/432e11f94e73770cb94de2c0243e25d2d740f026", "message": "Use T-digest in approx_percentile aggregations\n\nUse T-digest instead of QuantileDigest in the implementation of\n- `approx_percentile(x, percentage)`,\n- `approx_percentile(x, weight, percentage)`.\nThis change doesn't apply to\napprox_percentile(x, weight, percentage, accuracy).", "committedDate": "2020-10-03T20:49:14Z", "type": "commit"}, {"oid": "8244702723f90faa377f8aaafb744fc2d175a0fa", "url": "https://github.com/trinodb/trino/commit/8244702723f90faa377f8aaafb744fc2d175a0fa", "message": "Use T-digest in approx_percentile array aggregations\n\nUse T-digest instead of QuantileDigest in the implementation of\n- `approx_percentile(x, percentages)`,\n- `approx_percentile(x, weight, percentages)`.", "committedDate": "2020-10-03T20:49:14Z", "type": "commit"}, {"oid": "661c0b01221226cfa638f7b84691b27a7227cd11", "url": "https://github.com/trinodb/trino/commit/661c0b01221226cfa638f7b84691b27a7227cd11", "message": "Add tdigest type and merge(tdigest) function", "committedDate": "2020-10-03T20:49:14Z", "type": "commit"}, {"oid": "ce3f47769bd877df436b4019f9233530d704c2bc", "url": "https://github.com/trinodb/trino/commit/ce3f47769bd877df436b4019f9233530d704c2bc", "message": "Add operators for casting tdigest to / from varbinary", "committedDate": "2020-10-03T20:49:14Z", "type": "commit"}, {"oid": "cd7aa82c5cec2b300012ea777714dcda88c9e74a", "url": "https://github.com/trinodb/trino/commit/cd7aa82c5cec2b300012ea777714dcda88c9e74a", "message": "Add value_at_quantile and values_at_quantiles functions for tdigest", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": "bd6018fbb348f8aa06f6171d9c5e962e0491325a", "url": "https://github.com/trinodb/trino/commit/bd6018fbb348f8aa06f6171d9c5e962e0491325a", "message": "Add tdigest_agg function", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": "29569c2f7ef145636743c7e25ade0031410aa5e1", "url": "https://github.com/trinodb/trino/commit/29569c2f7ef145636743c7e25ade0031410aa5e1", "message": "Add test for tdigest functions", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": "67129d0604069fa0ab2f73697f15efbdd9401ce0", "url": "https://github.com/trinodb/trino/commit/67129d0604069fa0ab2f73697f15efbdd9401ce0", "message": "Fix parameter names in docs for approx_percentile functions", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": "0e432c30fb5576dffe566e8fa89f13ff17ddcd56", "url": "https://github.com/trinodb/trino/commit/0e432c30fb5576dffe566e8fa89f13ff17ddcd56", "message": "Add documentation for T-digest type and functions", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": "5213495378d37fc3870ad9beb1697ae3c4e52724", "url": "https://github.com/trinodb/trino/commit/5213495378d37fc3870ad9beb1697ae3c4e52724", "message": "Fix return type in qdigest function documentation", "committedDate": "2020-10-03T20:49:15Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "53bbcb60775b631e3c5309385c23853b306264a0", "url": "https://github.com/trinodb/trino/commit/53bbcb60775b631e3c5309385c23853b306264a0", "message": "Use helper method", "committedDate": "2020-10-04T08:22:36Z", "type": "commit"}, {"oid": "53bbcb60775b631e3c5309385c23853b306264a0", "url": "https://github.com/trinodb/trino/commit/53bbcb60775b631e3c5309385c23853b306264a0", "message": "Use helper method", "committedDate": "2020-10-04T08:22:36Z", "type": "forcePushed"}]}