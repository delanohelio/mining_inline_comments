{"pr_number": 3795, "pr_title": "Increase process numbers to 1000 from 500 in Oracle test", "pr_createdAt": "2020-05-20T12:26:58Z", "pr_url": "https://github.com/trinodb/trino/pull/3795", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534702", "bodyText": "otherwise the tests end up giving a ORA-12519\n\nthis could mention the message too\n\nbut this command needs a database restart and if we restart the docker the configuration is lost.\n\nthis could be solved with a custom entry point, or a command.\nhow much would it add to the startup time?", "author": "findepi", "createdAt": "2020-05-21T09:05:38Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcwMTYxNA==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428701614", "bodyText": "@findepi The startup takes about 25 seconds. Do you mean https://www.testcontainers.org/features/commands/ and run /bin/bash /etc/init.d/oracle-xe restart?", "author": "ebyhr", "createdAt": "2020-05-21T14:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczMTM2Mg==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428731362", "bodyText": "Confirmed the parameters were set correctly.\nSQL> SHOW PARAMETERS processes;\n\nNAME\t\t\t\t     TYPE\t VALUE\n------------------------------------ ----------- ------------------------------\naq_tm_processes \t\t     integer\t 0\ndb_writer_processes\t\t     integer\t 1\ngcs_server_processes\t\t     integer\t 0\nglobal_txn_processes\t\t     integer\t 1\njob_queue_processes\t\t     integer\t 4\nlog_archive_max_processes\t     integer\t 4\nprocesses\t\t\t     integer\t 1000\nSQL>\nSQL> SHOW PARAMETERS disk_asynch_io;\n\nNAME\t\t\t\t     TYPE\t VALUE\n------------------------------------ ----------- ------------------------------\ndisk_asynch_io\t\t\t     boolean\t FALSE", "author": "ebyhr", "createdAt": "2020-05-21T15:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxODQ2MQ==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428918461", "bodyText": "bq. Do you mean https://www.testcontainers.org/features/commands/ and run /bin/bash /etc/init.d/oracle-xe restart?\nThis would work for tests, but would not be appropriate for product test environment (which we should have).", "author": "findepi", "createdAt": "2020-05-21T21:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534946", "bodyText": "if i would like to amend, or recreate the spfileXE.ora, how would i do that?", "author": "findepi", "createdAt": "2020-05-21T09:06:06Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcxMTAwMg==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428711002", "bodyText": "@findepi Steps to update the file are:\n\nReplace BindMode.READ_ONLY with BindMode.READ_WRITE at L47\nRemove or comment out L52 ~ 55 and add\n\n            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n\nRun OracleQueryRunner.main", "author": "ebyhr", "createdAt": "2020-05-21T15:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyMjg5Mw==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428722893", "bodyText": "Let me change to the above approach (restarting Oracle server inside the container).", "author": "ebyhr", "createdAt": "2020-05-21T15:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxODcxNA==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428918714", "bodyText": "Steps to update the file are:\n\nReplace BindMode.READ_ONLY with BindMode.READ_WRITE at L47\nRemove or comment out L52 ~ 55 and add\n\n            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n\nRun OracleQueryRunner.main\n\n\nThanks @ebyhr!\nis it documented somewhere?", "author": "findepi", "createdAt": "2020-05-21T21:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTIzMA==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919230", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n          \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), getUsername(), getPassword());\n          \n      \n    \n    \n  \n\n-- you didn't need super, did you?", "author": "findepi", "createdAt": "2020-05-21T21:16:39Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTUwMA==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919500", "bodyText": "Does it wait for the db to be back opertional?", "author": "findepi", "createdAt": "2020-05-21T21:17:18Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n+                Statement statement = connection.createStatement()) {\n+            // this is added to allow more processes on database, otherwise the tests end up giving\n+            // ORA-12519, TNS:no appropriate service handler found\n+            // ORA-12505, TNS:listener does not currently know of SID given in connect descriptor\n+            // to fix this we have to change the number of processes of SPFILE\n+            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n+            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n+        }\n+        catch (SQLException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        try {\n+            execInContainer(\"/bin/bash\", \"/etc/init.d/oracle-xe\", \"restart\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAxMDcyNg==", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r429010726", "bodyText": "@findepi As far as checked the script, yes. But added waitUntilContainerStarted() just in case.", "author": "ebyhr", "createdAt": "2020-05-22T02:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTUwMA=="}], "type": "inlineReview"}, {"oid": "a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "url": "https://github.com/trinodb/trino/commit/a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "message": "Increase process numbers to 1000 from 500 in Oracle test\n\nAdditionally\n- remove spfileXE.ora and set paramaters programmatically\n- remove redundant \"super.\" in TestingOracleServer", "committedDate": "2020-05-22T02:12:51Z", "type": "commit"}, {"oid": "a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "url": "https://github.com/trinodb/trino/commit/a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "message": "Increase process numbers to 1000 from 500 in Oracle test\n\nAdditionally\n- remove spfileXE.ora and set paramaters programmatically\n- remove redundant \"super.\" in TestingOracleServer", "committedDate": "2020-05-22T02:12:51Z", "type": "forcePushed"}]}