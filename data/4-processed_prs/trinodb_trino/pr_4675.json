{"pr_number": 4675, "pr_title": "Improve extraction of lazy dynamic filter", "pr_createdAt": "2020-08-03T13:54:36Z", "pr_url": "https://github.com/trinodb/trino/pull/4675", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3NDk4OQ==", "url": "https://github.com/trinodb/trino/pull/4675#discussion_r464874989", "bodyText": "Would it be possible to compute the \"non-lazy\" dynamic filters using:\nintersection(getProducedDynamicFilters(plan.getRoot()), getConsumedDynamicFilters(plan.getRoot()))\nso we'll make sure that every produced dynamic filter is handled...", "author": "rzeyde-varada", "createdAt": "2020-08-04T08:07:40Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -323,6 +319,39 @@ private synchronized void addDynamicFilters(QueryId queryId, Map<DynamicFilterId\n                         descriptor -> columnHandles.get(Symbol.from(descriptor.getInput()))));\n     }\n \n+    private static Set<DynamicFilterId> getLazyDynamicFilters(PlanFragment plan)\n+    {\n+        // lazy dynamic filters cannot be consumed by the same stage where they are produced as it would result in query deadlock\n+        return difference(getProducedDynamicFilters(plan.getRoot()), getConsumedDynamicFilters(plan.getRoot()));\n+    }\n+\n+    private static Set<DynamicFilterId> getReplicatedDynamicFilters(PlanNode planNode)\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NzMyNQ==", "url": "https://github.com/trinodb/trino/pull/4675#discussion_r464997325", "bodyText": "Would it be possible to compute the \"non-lazy\" dynamic filters using:\n\nwhat would be the difference here in practice?\nI prefer that lazy DFs are selected explicitly as they can result in deadlock", "author": "sopel39", "createdAt": "2020-08-04T11:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3NDk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAzMDQ3Ng==", "url": "https://github.com/trinodb/trino/pull/4675#discussion_r465030476", "bodyText": "I prefer that lazy DFs are selected explicitly as they can result in deadlock\n\nAgree :)", "author": "rzeyde-varada", "createdAt": "2020-08-04T12:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3NDk4OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "e07c7cc7ccb7e09298c0b3aba1452cc00df14b21", "url": "https://github.com/trinodb/trino/commit/e07c7cc7ccb7e09298c0b3aba1452cc00df14b21", "message": "Remove \"num\" from dynamic filters stat fields", "committedDate": "2020-08-20T12:57:08Z", "type": "commit"}, {"oid": "270b9bd0b74764a9af8588d43c668559d30cfdc1", "url": "https://github.com/trinodb/trino/commit/270b9bd0b74764a9af8588d43c668559d30cfdc1", "message": "Use forEach directly", "committedDate": "2020-08-20T12:57:09Z", "type": "commit"}, {"oid": "80dfc25069f9494ca16e66d60dc64ffba1b8f3c8", "url": "https://github.com/trinodb/trino/commit/80dfc25069f9494ca16e66d60dc64ffba1b8f3c8", "message": "Simplify LocalDynamicFilterConsumer", "committedDate": "2020-08-20T12:57:09Z", "type": "commit"}, {"oid": "6574ba40401bd30d6647014eba59d862809a215c", "url": "https://github.com/trinodb/trino/commit/6574ba40401bd30d6647014eba59d862809a215c", "message": "Introduce DynamicFilterService.DynamicFilterContext", "committedDate": "2020-08-20T12:57:09Z", "type": "commit"}, {"oid": "c1e2ffe68b735c05cf6d45fdb5dfaf8ccebfa58b", "url": "https://github.com/trinodb/trino/commit/c1e2ffe68b735c05cf6d45fdb5dfaf8ccebfa58b", "message": "Make sure lazy dynamic filters are blocked initally", "committedDate": "2020-08-20T12:57:09Z", "type": "commit"}, {"oid": "215225dedcfe11c38b052d74868b24f08894b077", "url": "https://github.com/trinodb/trino/commit/215225dedcfe11c38b052d74868b24f08894b077", "message": "Improve extraction of lazy dynamic filters\n\nLazy dynamic filters cannot be consumed by the same stage\nwhere they are produced (join node) as it would result in\nquery deadlock.", "committedDate": "2020-08-20T12:57:35Z", "type": "commit"}, {"oid": "fc49bb3b89bfc6f03f1c2e6b78bdb275ef9b1b24", "url": "https://github.com/trinodb/trino/commit/fc49bb3b89bfc6f03f1c2e6b78bdb275ef9b1b24", "message": "Use explicit field for lazy dynamic filter futures", "committedDate": "2020-08-20T12:57:36Z", "type": "commit"}, {"oid": "fc49bb3b89bfc6f03f1c2e6b78bdb275ef9b1b24", "url": "https://github.com/trinodb/trino/commit/fc49bb3b89bfc6f03f1c2e6b78bdb275ef9b1b24", "message": "Use explicit field for lazy dynamic filter futures", "committedDate": "2020-08-20T12:57:36Z", "type": "forcePushed"}]}