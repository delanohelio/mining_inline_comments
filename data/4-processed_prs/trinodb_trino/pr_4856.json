{"pr_number": 4856, "pr_title": "Make Iceberg smoke tests more consistent and less verbose", "pr_createdAt": "2020-08-17T03:33:05Z", "pr_url": "https://github.com/trinodb/trino/pull/4856", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2Mzk3OQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r471463979", "bodyText": "dropTable calls should be called always at the end of the tests. Currently if assertion fails the DROP will not be executed and test for another file format which uses same table name will fail on CREATE TABLE", "author": "losipiuk", "createdAt": "2020-08-17T13:04:37Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -387,177 +387,203 @@ private void testCreatePartitionedTableAs(Session session, FileFormat fileFormat\n \n //        assertEquals(partitions.size(), 3);\n \n-        assertQuery(session, \"SELECT * from test_create_partitioned_table_as\", \"SELECT orderkey, shippriority, orderstatus FROM orders\");\n+        assertQuery(\"SELECT * from test_create_partitioned_table_as\", \"SELECT orderkey, shippriority, orderstatus FROM orders\");\n \n-        dropTable(session, \"test_create_partitioned_table_as\");\n+        dropTable(\"test_create_partitioned_table_as\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyNDI2OA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r471524268", "bodyText": "Thanks for taking a look, @losipiuk!  AFAIK dropTable is always called, except as you point out in the case of an exception.  That was also true before these changes?\nAre you suggesting that all tests should be wrapped in try/finally with dropTable called in the finally block?", "author": "djsstarburst", "createdAt": "2020-08-17T14:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2Mzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NTkzNA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472045934", "bodyText": "Before changes single table was only used for single test run, right? Then not having drop is not painful. We just end up with garbage.\nNow that we have same test executed multiple times (for different file formats), failure for test in format A will result in failure at the very beginning of test for format B.\nI think try/finally is fine approach. Though extra indentation makes code a bit less readable.\nOr you can use temporary table mechanism which @kokosing  intruduces in #4849, as soon as that one gets merged.", "author": "losipiuk", "createdAt": "2020-08-18T09:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2Mzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMzkzMQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472223931", "bodyText": "I'll think about it, and consult with @electrum.  If we need to try/finally, I can hide it in a helper method that takes a runnable, e.g., withCreatedTable(tableName, runnable).", "author": "djsstarburst", "createdAt": "2020-08-18T14:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2Mzk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2NTI0MQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r471465241", "bodyText": "instead doing loop manually you can use @DataProvider\nExample: https://github.com/prestosql/presto/blob/93faf7ad9a6b95a2436d4eaa9bf567756b759c3f/presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveStorageFormats.java#L63", "author": "losipiuk", "createdAt": "2020-08-17T13:06:51Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -248,30 +247,31 @@ private void testCreatePartitionedTable(Session session, FileFormat fileFormat)\n                 \", CAST('2017-05-01 10:12:34' AS TIMESTAMP) _timestamp\" +\n                 \", CAST('2017-05-01' AS DATE) _date\";\n \n-        assertUpdate(session, \"INSERT INTO test_partitioned_table \" + select, 1);\n-        assertQuery(session, \"SELECT * from test_partitioned_table\", select);\n-        assertQuery(session, \"\" +\n-                        \"SELECT * FROM test_partitioned_table WHERE\" +\n-                        \" 'foo' = _string\" +\n-                        \" AND 456 = _integer\" +\n-                        \" AND CAST(123 AS BIGINT) = _bigint\" +\n-                        \" AND true = _boolean\" +\n-                        \" AND CAST('3.14' AS DECIMAL(3,2)) = _decimal_short\" +\n-                        \" AND CAST('12345678901234567890.0123456789' AS DECIMAL(30,10)) = _decimal_long\" +\n-                        \" AND CAST('2017-05-01 10:12:34' AS TIMESTAMP) = _timestamp\" +\n-                        \" AND CAST('2017-05-01' AS DATE) = _date\",\n-                select);\n+        assertUpdate(format(\"INSERT INTO test_partitioned_table %s\", select), 1);\n+        assertQuery(\"SELECT * FROM test_partitioned_table\", select);\n \n-        dropTable(session, \"test_partitioned_table\");\n+        String selectAgain = \"\" +\n+                \"SELECT * FROM test_partitioned_table WHERE\" +\n+                \" 'foo' = _string\" +\n+                \" AND 456 = _integer\" +\n+                \" AND CAST(123 AS BIGINT) = _bigint\" +\n+                \" AND true = _boolean\" +\n+                \" AND CAST('3.14' AS DECIMAL(3,2)) = _decimal_short\" +\n+                \" AND CAST('12345678901234567890.0123456789' AS DECIMAL(30,10)) = _decimal_long\" +\n+                \" AND CAST('2017-05-01 10:12:34' AS TIMESTAMP) = _timestamp\" +\n+                \" AND CAST('2017-05-01' AS DATE) = _date\";\n+        assertQuery(selectAgain, select);\n+\n+        dropTable(\"test_partitioned_table\");\n     }\n \n     @Test\n     public void testCreatePartitionedTableWithNestedTypes()\n     {\n-        testWithAllFileFormats(this::testCreatePartitionedTableWithNestedTypes);\n+        testWithAllFileFormats(this::testCreatePartitionedTableWithNestedTypesForFormat);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyNzY3MA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r471527670", "bodyText": "Thanks for the tip; I'll take a look.  Today, the Iceberg connector supports ORC and Parquet, and there is a PR to support AVRO.\nI now understand @DataProvider is a generic capability of TestNG, and you were pointing me at an example.  Indeed, it's the right thing, because it shows each format as a different test result.  I made the change to use @DataProvider, which eliminated a helper method per test.  A very nice cleanup!", "author": "djsstarburst", "createdAt": "2020-08-17T14:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2NTI0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzOTcyMA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472039720", "bodyText": "nit: I think name = \"allFormats\" is not needed if it matches method name.", "author": "losipiuk", "createdAt": "2020-08-18T09:21:09Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -73,8 +75,17 @@ protected QueryRunner createQueryRunner()\n         return createIcebergQueryRunner(ImmutableMap.of());\n     }\n \n-    @Test\n-    public void testShowCreateSchema()\n+    @DataProvider(name = \"allFormats\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDA2Mw==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472224063", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-08-18T14:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzOTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEzNTA3Mg==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473135072", "bodyText": "Nice, I didn't' know about that. Makes it cleaner.", "author": "electrum", "createdAt": "2020-08-19T15:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzOTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTQwNg==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472041406", "bodyText": "It seems this one should be renamed testShowCreateTable and method above should be dropped.", "author": "losipiuk", "createdAt": "2020-08-18T09:24:04Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -105,6 +121,12 @@ public void testDescribeTable()\n \n     @Override\n     public void testShowCreateTable()\n+    {\n+        testCreateTableForFormat(ORC);\n+    }\n+\n+    @Test(dataProvider = \"allFormats\")\n+    public void testCreateTableForFormat(FileFormat format)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDEzOQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472224139", "bodyText": "Unfortunately, as mentioned in the commit comments, the method above is required by TestIcebergSmoke's base class AbstractTestIntegrationSmokeTest.  AbstractTestIntegrationSmokeTest is in module presto-testing, and is connector-independent.\nAbstractTestIntegrationSmokeTest doesn't actually create any tables.  Instead, it uses the tpch tables pre-created by the IcebergQueryRunner.  We need to figure out a way to run the AbstractTestIntegrationSmokeTest methods having pre-created for both ORC and Parquet.  I'll figure out some way to do it.", "author": "djsstarburst", "createdAt": "2020-08-18T14:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzNDgyMQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472234821", "bodyText": "Unfortunately, as mentioned in the commit comments, the method above is required by TestIcebergSmoke's base class AbstractTestIntegrationSmokeTest. AbstractTestIntegrationSmokeTest is in module presto-testing, and is connector-independent.\n\nThanks for the clarification.\nSo if I understand it correctly now we are running test for SHOW CREATE TABLE once for Parquet (via testCreateTableForFormat) and twice for ORC (via testCreateTableForFormat and testShowCreateTable).\nWould code structure like this work:\n    @Override\n    @Test(enabled = false) \n    public void testShowCreateTable(){\n        // superseded with #testShowCreateTable(FileFormat)\n    }\n\n    @Test(dataProvider = \"allFormats\")\n    public void testShowCreateTable(FileFormat format) {\n       ACTUAL TEST\n    }", "author": "losipiuk", "createdAt": "2020-08-18T14:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NDc1OA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472254758", "bodyText": "That's a great idea!  Done.", "author": "djsstarburst", "createdAt": "2020-08-18T14:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTU3MA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472041570", "bodyText": "rename to testDescribeTable and drop method above?", "author": "losipiuk", "createdAt": "2020-08-18T09:24:21Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -84,9 +95,14 @@ public void testShowCreateSchema()\n                         \"\\\\)\");\n     }\n \n-    @Test\n     @Override\n     public void testDescribeTable()\n+    {\n+        testDescribeTableForFormat(ORC);\n+    }\n+\n+    @Test(dataProvider = \"allFormats\")\n+    public void testDescribeTableForFormat(FileFormat format)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY0Mg==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r472224642", "bodyText": "Both methods are needed because of AbstractTestIntegrationSmokeTest, as in the previous comment.", "author": "djsstarburst", "createdAt": "2020-08-18T14:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0MTU3MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NDg0OA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473144848", "bodyText": "Check for null", "author": "electrum", "createdAt": "2020-08-19T16:09:21Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/AbstractTestIcebergSmoke.java", "diffHunk": "@@ -57,20 +56,29 @@\n import static java.util.Locale.ENGLISH;\n import static java.util.stream.Collectors.joining;\n import static java.util.stream.IntStream.range;\n+import static org.apache.iceberg.FileFormat.ORC;\n+import static org.apache.iceberg.FileFormat.PARQUET;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.testng.Assert.assertFalse;\n import static org.testng.Assert.assertNotNull;\n \n-public class TestIcebergSmoke\n+public abstract class AbstractTestIcebergSmoke\n         extends AbstractTestIntegrationSmokeTest\n {\n     private static final Pattern WITH_CLAUSE_EXTRACTER = Pattern.compile(\".*(WITH\\\\s*\\\\([^)]*\\\\))\\\\s*$\", Pattern.DOTALL);\n \n+    private final FileFormat format;\n+\n+    public AbstractTestIcebergSmoke(FileFormat format)\n+    {\n+        this.format = format;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxNzM2MQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473317361", "bodyText": "Added.", "author": "djsstarburst", "createdAt": "2020-08-19T21:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NDg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NTY2NQ==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473145665", "bodyText": "Remove", "author": "electrum", "createdAt": "2020-08-19T16:10:39Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/AbstractTestIcebergSmoke.java", "diffHunk": "@@ -405,56 +363,56 @@ private void testCreatePartitionedTableAs(Session session, FileFormat fileFormat\n                         \"   order_status varchar\\n\" +\n                         \")\\n\" +\n                         \"WITH (\\n\" +\n-                        \"   format = '\" + fileFormat + \"',\\n\" +\n+                        \"   format = '%s',\\n\" +\n                         \"   partitioning = ARRAY['order_status','ship_priority','bucket(order_key, 9)']\\n\" +\n                         \")\",\n                 getSession().getCatalog().get(),\n                 getSession().getSchema().get(),\n-                \"test_create_partitioned_table_as\");\n+                \"test_create_partitioned_table_as\",\n+                format);\n \n         MaterializedResult actualResult = computeActual(\"SHOW CREATE TABLE test_create_partitioned_table_as\");\n         assertEquals(getOnlyElement(actualResult.getOnlyColumnAsSet()), createTableSql);\n \n //        assertEquals(partitions.size(), 3);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxNzMxMw==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473317313", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-08-19T21:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NTY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0ODgyNA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473148824", "bodyText": "We could make this\nFileFormat defaultFormat = new IcebergConfig().getFileFormat();\nreturn createIcebergQueryRunner(extraProperties, defaultFormat, true);", "author": "electrum", "createdAt": "2020-08-19T16:15:42Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/IcebergQueryRunner.java", "diffHunk": "@@ -39,10 +41,16 @@ private IcebergQueryRunner() {}\n     public static DistributedQueryRunner createIcebergQueryRunner(Map<String, String> extraProperties)\n             throws Exception\n     {\n-        return createIcebergQueryRunner(extraProperties, true);\n+        return createIcebergQueryRunner(extraProperties, ORC, true);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxNzQ5NA==", "url": "https://github.com/trinodb/trino/pull/4856#discussion_r473317494", "bodyText": "Much nicer; changed.", "author": "djsstarburst", "createdAt": "2020-08-19T21:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0ODgyNA=="}], "type": "inlineReview"}, {"oid": "20f3d59ccc88f970c470e2f313fed3b4dce42c39", "url": "https://github.com/trinodb/trino/commit/20f3d59ccc88f970c470e2f313fed3b4dce42c39", "message": "Make Iceberg smoke tests inmore consistent and less verbose\n\nThis commit makes TestIcebergSmoke more consistent and less verbose,\nand runs all tests for all storage formats:\n\no TestIcebergSmoke has been changed into an abstract class, whose\n  derived classes, TestIcebergOrcSmoke and TestIcebergParquetSmoke,\n  supply the FileFormat argument used by all the tests when creating\n  databases.  All tests are run by each of the derived classes with\n  the supplied storage format.  Moreover, the tables created when running\n  tests on behalf of the two derived types can't conflict, because\n  they are in different query runners.  This worked out very neatly.\no This commit eliminated gratuitous session arguments to testWithAllFileFormats(),\n  and to all calls to assertUpdate() and assertQuery().  The session passed\n  is the same as the default in all tests, and so passing it is just\n  pointless noise.\no This commit gets rid of per-storage format table names.  They are unnecessary\n  and make the tests less clear.\no The test conventions are now more consistent.  One small example\n  is always calling the dropTable() method rather than running DROP TABLE\n  as an update.update.\no This commit also fixes a bug in Iceberg's PrimitiveTypeBuilder which\n  caused disagreements with Parquet for nested ARRAY types.", "committedDate": "2020-08-19T20:51:36Z", "type": "commit"}, {"oid": "20f3d59ccc88f970c470e2f313fed3b4dce42c39", "url": "https://github.com/trinodb/trino/commit/20f3d59ccc88f970c470e2f313fed3b4dce42c39", "message": "Make Iceberg smoke tests inmore consistent and less verbose\n\nThis commit makes TestIcebergSmoke more consistent and less verbose,\nand runs all tests for all storage formats:\n\no TestIcebergSmoke has been changed into an abstract class, whose\n  derived classes, TestIcebergOrcSmoke and TestIcebergParquetSmoke,\n  supply the FileFormat argument used by all the tests when creating\n  databases.  All tests are run by each of the derived classes with\n  the supplied storage format.  Moreover, the tables created when running\n  tests on behalf of the two derived types can't conflict, because\n  they are in different query runners.  This worked out very neatly.\no This commit eliminated gratuitous session arguments to testWithAllFileFormats(),\n  and to all calls to assertUpdate() and assertQuery().  The session passed\n  is the same as the default in all tests, and so passing it is just\n  pointless noise.\no This commit gets rid of per-storage format table names.  They are unnecessary\n  and make the tests less clear.\no The test conventions are now more consistent.  One small example\n  is always calling the dropTable() method rather than running DROP TABLE\n  as an update.update.\no This commit also fixes a bug in Iceberg's PrimitiveTypeBuilder which\n  caused disagreements with Parquet for nested ARRAY types.", "committedDate": "2020-08-19T20:51:36Z", "type": "forcePushed"}]}