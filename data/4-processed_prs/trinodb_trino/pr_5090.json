{"pr_number": 5090, "pr_title": "Use task status version for task status long polling notifications", "pr_createdAt": "2020-09-07T12:55:07Z", "pr_url": "https://github.com/trinodb/trino/pull/5090", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc2NDczNQ==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484764735", "bodyText": "is it fine if taskStateMachine.getState(); in the next line gives a newly updated state (let's say versionNumber is set to V which corresponds to a state S1 - but before the getState call executes in the next line, the state is changed to S2 with current versionNumber as V+1?", "author": "rohangarg", "createdAt": "2020-09-08T09:03:03Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlTask.java", "diffHunk": "@@ -219,11 +230,18 @@ public TaskStatus getTaskStatus()\n         }\n     }\n \n+    private void notifyStatusChanged()\n+    {\n+        taskStatusVersion.incrementAndGet();\n+        taskStatusVersionChange.complete(null, taskNotificationExecutor);\n+    }\n+\n     private TaskStatus createTaskStatus(TaskHolder taskHolder)\n     {\n-        // Always return a new TaskStatus with a larger version number;\n-        // otherwise a client will not accept the update\n-        long versionNumber = nextTaskStatusVersion.getAndIncrement();\n+        // Obtain task status version before building actual TaskStatus object.\n+        // This way any task updates won't be lost since all updates happen\n+        // before version number is increased.\n+        long versionNumber = taskStatusVersion.get();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc3MzU2Mw==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484773563", "bodyText": "Yes. That works. It might happen that client will get newer status (task state, DF version) with older version number. In such case client will make another request and get same status again (as version number was incremented in the meantime after status change). That isn't a problem. It is important that newest version of TaskStatus will be received eventually.\nversionNumber isn't meant for consistency here, but rather for notifications.", "author": "sopel39", "createdAt": "2020-09-08T09:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc2NDczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484780587", "bodyText": "do we not want to send the notification in case the following block (L160-170) returns from the listener?\n            while (true) {\n                TaskHolder taskHolder = taskHolderReference.get();\n                if (taskHolder.isFinished()) {\n                    // another concurrent worker already set the final state\n                    return;\n                }\n                if (taskHolderReference.compareAndSet(taskHolder, new TaskHolder(createTaskInfo(taskHolder), taskHolder.getIoStats()))) {\n                    break;\n                }\n            }\n\nAlthough, I don't know if the return block is possible during runtime.", "author": "rohangarg", "createdAt": "2020-09-08T09:29:09Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlTask.java", "diffHunk": "@@ -177,6 +185,9 @@ private void initialize(Function<SqlTask, ?> onDone, CounterStat failedTasks)\n             catch (Exception e) {\n                 log.warn(e, \"Error running task cleanup callback %s\", SqlTask.this.taskId);\n             }\n+\n+            // notify that task is finished\n+            notifyStatusChanged();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NjcyNA==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484786724", "bodyText": "If\n                    // another concurrent worker already set the final state\n                    return;\n\nwas run it means that another thread set final task info. This listener is the only place where final task info is set, so another thread must have called notifyStatusChanged", "author": "sopel39", "createdAt": "2020-09-08T09:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyNDMyNQ==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484824325", "bodyText": "do you mean the listener could get called twice from separate threads? is that possible? - and if it does then the failedTasks counter computed might be wrong.", "author": "rohangarg", "createdAt": "2020-09-08T10:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMzAwOA==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484833008", "bodyText": "do you mean the listener could get called twice from separate threads? is that possible? - and if it does then the failedTasks counter computed might be wrong.\n\nThat's a good point. I don't think it can be called twice for done state. I guess author of this code wanted to make sure that compareAndSet is use in proper context regardless.", "author": "sopel39", "createdAt": "2020-09-08T11:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMzkzNA==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484833934", "bodyText": "If you look at the code it's quite old 2014 and failedTasks code was added much later. I guess the original concurrency issue might not be there anymore.", "author": "sopel39", "createdAt": "2020-09-08T11:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2MDEwMQ==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r484860101", "bodyText": "Yes, you are right. It shouldn't exist anymore.", "author": "rohangarg", "createdAt": "2020-09-08T11:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDU4Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MTY5NA==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r488161694", "bodyText": "I'm pretty sure there is a race here.  The task could finish between this check and creating the listener below, and in that case the listener may never be notified.  If you call createNewListener() before this check, I believe it will eliminate the race.  Something like:\nCompletableFuture<?> listener = taskStatusVersionChange.createNewListener();\nif (callersCurrentVersion < taskStatusVersion.get() || taskHolderReference.get().isFinished()) {\n    listener.cancel(true);\n    return immediateFuture(getTaskStatus());\n}\nreturn Futures.transform(listener, input -> getTaskStatus(), directExecutor());", "author": "dain", "createdAt": "2020-09-14T19:12:49Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlTask.java", "diffHunk": "@@ -340,32 +358,24 @@ private TaskInfo createTaskInfo(TaskHolder taskHolder)\n                 needsPlan.get());\n     }\n \n-    public ListenableFuture<TaskStatus> getTaskStatus(TaskState callersCurrentState)\n+    public ListenableFuture<TaskStatus> getTaskStatus(long callersCurrentVersion)\n     {\n-        requireNonNull(callersCurrentState, \"callersCurrentState is null\");\n-\n-        if (callersCurrentState.isDone()) {\n+        if (callersCurrentVersion < taskStatusVersion.get() || taskHolderReference.get().isFinished()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5MzQyNA==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r488193424", "bodyText": "I've put both methods and notification method in synchronized section + a comment", "author": "sopel39", "createdAt": "2020-09-14T20:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MTY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MTg3Nw==", "url": "https://github.com/trinodb/trino/pull/5090#discussion_r488161877", "bodyText": "same problem", "author": "dain", "createdAt": "2020-09-14T19:13:11Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlTask.java", "diffHunk": "@@ -340,32 +358,24 @@ private TaskInfo createTaskInfo(TaskHolder taskHolder)\n                 needsPlan.get());\n     }\n \n-    public ListenableFuture<TaskStatus> getTaskStatus(TaskState callersCurrentState)\n+    public ListenableFuture<TaskStatus> getTaskStatus(long callersCurrentVersion)\n     {\n-        requireNonNull(callersCurrentState, \"callersCurrentState is null\");\n-\n-        if (callersCurrentState.isDone()) {\n+        if (callersCurrentVersion < taskStatusVersion.get() || taskHolderReference.get().isFinished()) {\n+            // return immediately if caller has older task status version or final task info is available\n             return immediateFuture(getTaskStatus());\n         }\n \n-        ListenableFuture<TaskState> futureTaskState = taskStateMachine.getStateChange(callersCurrentState);\n-        return Futures.transform(futureTaskState, input -> getTaskStatus(), directExecutor());\n+        return Futures.transform(taskStatusVersionChange.createNewListener(), input -> getTaskStatus(), directExecutor());\n     }\n \n-    public ListenableFuture<TaskInfo> getTaskInfo(TaskState callersCurrentState)\n+    public ListenableFuture<TaskInfo> getTaskInfo(long callersCurrentVersion)\n     {\n-        requireNonNull(callersCurrentState, \"callersCurrentState is null\");\n-\n-        // If the caller's current state is already done, just return the current\n-        // state of this task as it will either be done or possibly still running\n-        // (due to a bug in the caller), since we cannot transition from a done\n-        // state.\n-        if (callersCurrentState.isDone()) {\n+        if (callersCurrentVersion < taskStatusVersion.get() || taskHolderReference.get().isFinished()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "7fc7267cb9fb1e6702a216437f9f590c50e61ef8", "url": "https://github.com/trinodb/trino/commit/7fc7267cb9fb1e6702a216437f9f590c50e61ef8", "message": "Use task status version for task status long polling notifications", "committedDate": "2020-09-15T13:40:48Z", "type": "commit"}, {"oid": "7fc7267cb9fb1e6702a216437f9f590c50e61ef8", "url": "https://github.com/trinodb/trino/commit/7fc7267cb9fb1e6702a216437f9f590c50e61ef8", "message": "Use task status version for task status long polling notifications", "committedDate": "2020-09-15T13:40:48Z", "type": "forcePushed"}]}