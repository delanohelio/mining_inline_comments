{"pr_number": 6141, "pr_title": "Fix missing dependencies due to Aggregation through Join pushdown", "pr_createdAt": "2020-11-29T16:45:48Z", "pr_url": "https://github.com/trinodb/trino/pull/6141", "timeline": [{"oid": "81eeec56ef5178ee9162f71e4a435fd31fe0d977", "url": "https://github.com/trinodb/trino/commit/81eeec56ef5178ee9162f71e4a435fd31fe0d977", "message": "Fix mask matching in AggregationMatcher\n\n    - identify aggregations with mask by `getMask().isPresent()` instead of\n    checking if the aggregation is distinct. (DISTINCT aggregations might be\n    rewritten to use mask in certain cases; the presence of mask might also\n    result from FILTER)\n    - pass String instead of Symbol to AggregationMatcher\n\n    Also, remove the old `masks` parameter from `PlanMatchPattern.aggregation()`\n    methods. It was never actually used.\n\n    Note: only sets of expected and actual mask symbols are compared.\n    Note2: AggregationMatcher constructors should be rewritten to use builder.", "committedDate": "2020-11-29T17:30:48Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ1MDQ1Mg==", "url": "https://github.com/trinodb/trino/pull/6141#discussion_r532450452", "bodyText": "static import LEFT and INNER", "author": "sopel39", "createdAt": "2020-11-30T09:23:44Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestPushAggregationThroughOuterJoin.java", "diffHunk": "@@ -122,6 +122,53 @@ public void testPushesAggregationThroughRightJoin()\n                                                 values(ImmutableMap.of(\"null_literal\", 0))))));\n     }\n \n+    @Test\n+    public void testPushesAggregationWithMask()\n+    {\n+        tester().assertThat(new PushAggregationThroughOuterJoin())\n+                .on(p -> p.aggregation(ab -> ab\n+                        .source(\n+                                p.join(\n+                                        JoinNode.Type.LEFT,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ1MDYxNw==", "url": "https://github.com/trinodb/trino/pull/6141#discussion_r532450617", "bodyText": "static import EquiJoinClause", "author": "sopel39", "createdAt": "2020-11-30T09:24:00Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestPushAggregationThroughOuterJoin.java", "diffHunk": "@@ -122,6 +122,53 @@ public void testPushesAggregationThroughRightJoin()\n                                                 values(ImmutableMap.of(\"null_literal\", 0))))));\n     }\n \n+    @Test\n+    public void testPushesAggregationWithMask()\n+    {\n+        tester().assertThat(new PushAggregationThroughOuterJoin())\n+                .on(p -> p.aggregation(ab -> ab\n+                        .source(\n+                                p.join(\n+                                        JoinNode.Type.LEFT,\n+                                        p.values(ImmutableList.of(p.symbol(\"COL1\")), ImmutableList.of(expressions(\"10\"))),\n+                                        p.values(p.symbol(\"COL2\"), p.symbol(\"MASK\")),\n+                                        ImmutableList.of(new JoinNode.EquiJoinClause(p.symbol(\"COL1\"), p.symbol(\"COL2\"))),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f65c82c04c84e73bb626c2c359bf8967d86b5845", "url": "https://github.com/trinodb/trino/commit/f65c82c04c84e73bb626c2c359bf8967d86b5845", "message": "Add static imports", "committedDate": "2020-11-30T17:49:33Z", "type": "commit"}, {"oid": "69d85fe7ffedc8d69166db5d3a8a70270dbdf1ab", "url": "https://github.com/trinodb/trino/commit/69d85fe7ffedc8d69166db5d3a8a70270dbdf1ab", "message": "Fix aggregation symbols mapping\n\nIn PushAggregationThroughOuterJoin rule, source symbols of\nAggregationNode were replaced but only aggregation function arguments\nwere remapped accordingly. Other aggregation symbols in mask, filter\nand order by were not mapped and so the resulting plan might have had\nbroken dependencies.", "committedDate": "2020-11-30T17:51:27Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "4d89cc6e811e883dcb402716b8d65fdb98eb493a", "url": "https://github.com/trinodb/trino/commit/4d89cc6e811e883dcb402716b8d65fdb98eb493a", "message": "Cast null to expected type\n\nIn PushAggregationThroughOuterJoin rule, a ValuesNode with single row of\nnulls is created. After this change, null literals are cast to expected types.\nNot casting them didn't cause issues because type was never required or checked\nwhen processing a null value.", "committedDate": "2020-11-30T19:27:50Z", "type": "commit"}, {"oid": "4d89cc6e811e883dcb402716b8d65fdb98eb493a", "url": "https://github.com/trinodb/trino/commit/4d89cc6e811e883dcb402716b8d65fdb98eb493a", "message": "Cast null to expected type\n\nIn PushAggregationThroughOuterJoin rule, a ValuesNode with single row of\nnulls is created. After this change, null literals are cast to expected types.\nNot casting them didn't cause issues because type was never required or checked\nwhen processing a null value.", "committedDate": "2020-11-30T19:27:50Z", "type": "forcePushed"}]}