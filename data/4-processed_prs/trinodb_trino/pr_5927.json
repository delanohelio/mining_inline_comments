{"pr_number": 5927, "pr_title": "Add graceful shutdown documentation.", "pr_createdAt": "2020-11-11T20:35:13Z", "pr_url": "https://github.com/trinodb/trino/pull/5927", "timeline": [{"oid": "90988b411070fee8d2d80ce54b5a4da49e670f57", "url": "https://github.com/trinodb/trino/commit/90988b411070fee8d2d80ce54b5a4da49e670f57", "message": "Add graceful shutdown documentation.", "committedDate": "2020-11-11T19:35:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMTU2Ng==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r521831566", "bodyText": "an -> can", "author": "raunaqmorarka", "createdAt": "2020-11-12T04:26:18Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,34 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you an make the call ``--insecure``, but that isn't recommended.", "originalCommit": "90988b411070fee8d2d80ce54b5a4da49e670f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2NzcwNA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r522167704", "bodyText": "Done.", "author": "johnwhumphreys", "createdAt": "2020-11-12T14:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMTU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMTg2OQ==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r521831869", "bodyText": "shut-down -> shutdown", "author": "raunaqmorarka", "createdAt": "2020-11-12T04:27:26Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,34 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you an make the call ``--insecure``, but that isn't recommended.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:\n+\n+* Have its state set to to ``SHUTTING_DOWN``.\n+* Sleep for the configured grace period (``shutdown.grace-period``) which defaults to 2 minutes.\n+    * After this the coordinator should notice the pending shut-down and stop sending tasks to the worker.", "originalCommit": "90988b411070fee8d2d80ce54b5a4da49e670f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2Nzg2Mw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r522167863", "bodyText": "Done.", "author": "johnwhumphreys", "createdAt": "2020-11-12T14:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMjExNg==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r521832116", "bodyText": "Go into SHUTTING_DOWN state", "author": "raunaqmorarka", "createdAt": "2020-11-12T04:28:26Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,34 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you an make the call ``--insecure``, but that isn't recommended.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:\n+\n+* Have its state set to to ``SHUTTING_DOWN``.", "originalCommit": "90988b411070fee8d2d80ce54b5a4da49e670f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2Nzk2NA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r522167964", "bodyText": "Done.", "author": "johnwhumphreys", "createdAt": "2020-11-12T14:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMjExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2NTcwOA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r521865708", "bodyText": "I think it's also worth adding that if System Information Rules are configured then the user in HTTP request must have read+write permissions in the system information rules.", "author": "hashhar", "createdAt": "2020-11-12T06:26:32Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,34 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or", "originalCommit": "90988b411070fee8d2d80ce54b5a4da49e670f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2ODAzOQ==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r522168039", "bodyText": "Done.", "author": "johnwhumphreys", "createdAt": "2020-11-12T14:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2NTcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2NjQ1MA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r521866450", "bodyText": "I think it'll be nice to add the log message that the workers print when the request is received successfully so that people who are trying this out can make sure it's working properly for them.\nhttps://github.com/prestosql/presto/blob/master/presto-main/src/main/java/io/prestosql/server/GracefulShutdownHandler.java#L75", "author": "hashhar", "createdAt": "2020-11-12T06:28:55Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,34 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state", "originalCommit": "90988b411070fee8d2d80ce54b5a4da49e670f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2NzI3OA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r522167278", "bodyText": "Done.", "author": "johnwhumphreys", "createdAt": "2020-11-12T14:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2NjQ1MA=="}], "type": "inlineReview"}, {"oid": "17f02afef1d0aeb65c72521cbf21d418261b9735", "url": "https://github.com/trinodb/trino/commit/17f02afef1d0aeb65c72521cbf21d418261b9735", "message": "Fixup! Correcting typos, adding logging line for shutdown, and adding sys info rule details.", "committedDate": "2020-11-12T14:53:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMDI5OQ==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524420299", "bodyText": "You can invoke the API with a HTTP PUT request:", "author": "mosabua", "createdAt": "2020-11-16T16:55:50Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMTU3Mw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524421573", "bodyText": "A successful invocation is logged with a ``Shutdown requested`` message at ``INFO`` level in the worker server log.", "author": "mosabua", "createdAt": "2020-11-16T16:57:29Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMTc2OA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524421768", "bodyText": "Keep the following aspects in mind:", "author": "mosabua", "createdAt": "2020-11-16T16:57:47Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjE3Nw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524422177", "bodyText": "..., you need to provide ..\n(remove will)", "author": "mosabua", "createdAt": "2020-11-16T16:58:21Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjQwNg==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524422406", "bodyText": "remove will", "author": "mosabua", "createdAt": "2020-11-16T16:58:39Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjg0MQ==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524422841", "bodyText": "why not system information rules ?", "author": "mosabua", "createdAt": "2020-11-16T16:59:13Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MTI2NQ==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524491265", "bodyText": "It seemed like the previous person who suggest it went out of their way to capitalize it, so I kept it that way - but I agree it isn't needed here.  Changing it, thanks! :)", "author": "johnwhumphreys", "createdAt": "2020-11-16T18:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMzQwMg==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524423402", "bodyText": "read and write permissions\nalso maybe link to the system information rules you are talking about by making the first mention a link to the relevant docs", "author": "mosabua", "createdAt": "2020-11-16T16:59:54Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have\n+  read+write permissions in the system information rules.", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMTI5Mw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524501293", "bodyText": "good idea re: link / done.", "author": "johnwhumphreys", "createdAt": "2020-11-16T18:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMzQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMzc2Mw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524423763", "bodyText": ", the worker performs the following steps:", "author": "mosabua", "createdAt": "2020-11-16T17:00:25Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have\n+  read+write permissions in the system information rules.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyNDE1MA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524424150", "bodyText": "remove (), and add command after the property name", "author": "mosabua", "createdAt": "2020-11-16T17:00:58Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have\n+  read+write permissions in the system information rules.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:\n+\n+* Go into ``SHUTTING_DOWN`` state.\n+* Sleep for the configured grace period (``shutdown.grace-period``) which defaults to 2 minutes.", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyNzg0Mw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524427843", "bodyText": "After this, the coordinator is aware of the shutdown and stops sending tasks to the worker.", "author": "mosabua", "createdAt": "2020-11-16T17:06:01Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have\n+  read+write permissions in the system information rules.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:\n+\n+* Go into ``SHUTTING_DOWN`` state.\n+* Sleep for the configured grace period (``shutdown.grace-period``) which defaults to 2 minutes.\n+    * After this, the coordinator should notice the pending shutdown and stop sending tasks to the worker.", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyODU4Nw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524428587", "bodyText": "Remove /JVM", "author": "mosabua", "createdAt": "2020-11-16T17:06:43Z", "path": "presto-docs/src/main/sphinx/admin/graceful-shutdown.rst", "diffHunk": "@@ -0,0 +1,38 @@\n+=================\n+Graceful Shutdown\n+=================\n+\n+Presto has a graceful shutdown API that can be used exclusively on workers in\n+order to ensure that they terminate without affecting running queries, given a sufficient\n+grace period.\n+\n+You can invoke the API like this:\n+\n+.. code-block:: bash\n+\n+    curl -v -X PUT -d '\"SHUTTING_DOWN\"' -H \"Content-type: application/json\" \\\n+        http://worker:8081/v1/info/state\n+\n+Assuming this works, you should see ``Shutdown requested`` appear in the log file of the worker at INFO level.\n+\n+You should keep in mind:\n+\n+* If your cluster is secure, you will need to provide a basic-authorization header, or\n+  satisfy whatever other security you have enabled.\n+* If you have HTTPS/TLS enabled, you will have to ensure the worker certificate is\n+  CA signed, or trusted by the server calling the shut down endpoint.  Otherwise,\n+  you can make the call ``--insecure``, but that isn't recommended.\n+* If System Information Rules are configured, then the user in the HTTP request must have\n+  read+write permissions in the system information rules.\n+\n+Shutdown Behavior\n+-----------------\n+\n+Once the API is called, the worker will:\n+\n+* Go into ``SHUTTING_DOWN`` state.\n+* Sleep for the configured grace period (``shutdown.grace-period``) which defaults to 2 minutes.\n+    * After this, the coordinator should notice the pending shutdown and stop sending tasks to the worker.\n+* Block until all active tasks are complete.\n+* Sleep for the grace period again in order to ensure the coordinator sees all tasks are complete.\n+* Shut down the server/JVM.", "originalCommit": "17f02afef1d0aeb65c72521cbf21d418261b9735", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyODg4NA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524428884", "bodyText": "Maybe change to\nShut down the application.", "author": "mosabua", "createdAt": "2020-11-16T17:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyODU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQzMDU3NA==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524430574", "bodyText": "Or Shut down the worker application.", "author": "mosabua", "createdAt": "2020-11-16T17:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyODU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyMjcxNw==", "url": "https://github.com/trinodb/trino/pull/5927#discussion_r524522717", "bodyText": "Going for \"Shutdown the application\" as I don't want to make it sound like there is a distinct worker app.", "author": "johnwhumphreys", "createdAt": "2020-11-16T19:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyODU4Nw=="}], "type": "inlineReview"}, {"oid": "554bd21692add938a7b696197539c167a7db8c06", "url": "https://github.com/trinodb/trino/commit/554bd21692add938a7b696197539c167a7db8c06", "message": "Fixup! Adding link to system information rules and phrasing changes.", "committedDate": "2020-11-16T19:43:24Z", "type": "commit"}, {"oid": "e203e25bfc682b01a85d99465f5ba09867e41237", "url": "https://github.com/trinodb/trino/commit/e203e25bfc682b01a85d99465f5ba09867e41237", "message": "Fixup! Changing graceful-shutdown doc to 80-char line length.", "committedDate": "2020-11-17T19:15:24Z", "type": "commit"}]}