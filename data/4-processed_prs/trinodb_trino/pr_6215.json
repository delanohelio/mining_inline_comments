{"pr_number": 6215, "pr_title": "Improve reporting of multiple SQLExceptions in JdbcPageSink#finish", "pr_createdAt": "2020-12-06T21:56:09Z", "pr_url": "https://github.com/trinodb/trino/pull/6215", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NjY2MQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537386661", "bodyText": "This is not the only place were we wrap SQLException as PrestoException. Do we need to update all places like that?", "author": "kokosing", "createdAt": "2020-12-07T10:16:56Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcPageSink.java", "diffHunk": "@@ -165,6 +165,11 @@ else if (javaType == Slice.class) {\n             throw new PrestoException(JDBC_NON_TRANSIENT_ERROR, e);\n         }\n         catch (SQLException e) {\n+            SQLException nextExc = e.getNextException();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxMDY1Mg==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537410652", "bodyText": "I think we should. So far we've only seen a SQLException chain from Redshift and hence this change was limited to this.\nIf we do want to do this everywhere then I'll need to think of a better way than copy pasting this everywhere.", "author": "hashhar", "createdAt": "2020-12-07T10:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NjY2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5MTcwMA==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537591700", "bodyText": "If we want to do this everywhere, we'll probably need to copy/paste something. I think subclassing PrestoException (JdbcPrestoException) or adding factory methods somewhere are preferable to just adding a utility method that converts chained SQLExceptions to suppressed exceptions.\n(The only way I can think of to avoid needing to make changes in a lot of places would be to add constructors accepting SQLException to PrestoException, but that seems like a very  bad idea.)", "author": "jirassimok", "createdAt": "2020-12-07T15:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NjY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzOTY5NQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537439695", "bodyText": "nextExc -> nextException", "author": "findepi", "createdAt": "2020-12-07T11:40:17Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcPageSink.java", "diffHunk": "@@ -165,6 +165,11 @@ else if (javaType == Slice.class) {\n             throw new PrestoException(JDBC_NON_TRANSIENT_ERROR, e);\n         }\n         catch (SQLException e) {\n+            SQLException nextExc = e.getNextException();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDI5Ng==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537440296", "bodyText": "be defensive here, since this code is (and will not be) well test covered:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            e.addSuppressed(nextExc);\n          \n          \n            \n                            if (e != nextExc) {\n          \n          \n            \n                                e.addSuppressed(nextExc);\n          \n          \n            \n                            }", "author": "findepi", "createdAt": "2020-12-07T11:41:23Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcPageSink.java", "diffHunk": "@@ -165,6 +165,11 @@ else if (javaType == Slice.class) {\n             throw new PrestoException(JDBC_NON_TRANSIENT_ERROR, e);\n         }\n         catch (SQLException e) {\n+            SQLException nextExc = e.getNextException();\n+            while (nextExc != null) {\n+                e.addSuppressed(nextExc);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDcyNQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537440725", "bodyText": "Also, it might be good to distinguish these:\ne.addSuppressed(new Exception(\"Next exception\", nextException));", "author": "findepi", "createdAt": "2020-12-07T11:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTEyMQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537599121", "bodyText": "A better defense would be breaking out of the loop when e == nextException. If you see the original exception again, you're in a loop. You could end up in a loop without the original, too, which would require a few more steps to check.", "author": "jirassimok", "createdAt": "2020-12-07T15:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzMjYyOQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537832629", "bodyText": "i didn't think about this. Do you have evidence loop is possible? Or just to be on the safe side?", "author": "findepi", "createdAt": "2020-12-07T21:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NTczMQ==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537845731", "bodyText": "It's technically possible (most simply, x.setNextException(x)), but it really shouldn't ever happen in a sane JDBC driver, and it doesn't seem like the sort of thing that would easy to do by accident.\nThe JDBC specification (section 8.1.2) does imply that there can't be loops by suggesting a loop much like this one for navigating chained exceptions:\n\nTo access the additional chained SQLExceptions, an application would recursively invoke getNextException until a null value is returned.\n\nFollowing from that, no check should be necessary except for a pathological JDBC driver.", "author": "jirassimok", "createdAt": "2020-12-07T21:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MDI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNTEwMA==", "url": "https://github.com/trinodb/trino/pull/6215#discussion_r537615100", "bodyText": "I'd add a comment in code noting what this is for, like \"convert chained SQLExceptions to suppressed exceptions so they are visible in the stack trace.\"", "author": "jirassimok", "createdAt": "2020-12-07T15:52:15Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcPageSink.java", "diffHunk": "@@ -165,6 +165,13 @@ else if (javaType == Slice.class) {\n             throw new PrestoException(JDBC_NON_TRANSIENT_ERROR, e);\n         }\n         catch (SQLException e) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4e0ad73c43f93741461257c9f2f884ab162e508", "url": "https://github.com/trinodb/trino/commit/d4e0ad73c43f93741461257c9f2f884ab162e508", "message": "Improve reporting of multiple SQLExceptions in JdbcPageSink#finish\n\nWhen we encounter a SQLException it can have multiple different\nexceptions (which do not have a causal relationship). Throwing just the\nfirst exception leads to omitting useful information from other\nexceptions.\n\nThis change adds each SQLException as a suppressed exception to the\noriginal SQLException before throwing so that the stack trace contains\nmore information.", "committedDate": "2020-12-08T08:19:17Z", "type": "commit"}]}