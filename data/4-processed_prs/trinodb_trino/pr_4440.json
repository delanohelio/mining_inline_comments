{"pr_number": 4440, "pr_title": "Report dynamic filtering stats in QueryStats", "pr_createdAt": "2020-07-13T23:07:49Z", "pr_url": "https://github.com/trinodb/trino/pull/4440", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MDE5MQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r454980191", "bodyText": "For the consistent naming convention, the variable name can be dynamicFiltersStats.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void setDynamicFilterStats(DynamicFiltersStats dynamicFilterStats)\n          \n          \n            \n                public void setDynamicFilterStats(DynamicFiltersStats dynamicFiltersStats)", "author": "Lewuathe", "createdAt": "2020-07-15T11:25:26Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -655,6 +660,12 @@ public void setRoutines(List<RoutineInfo> routines)\n         this.routines.set(ImmutableList.copyOf(routines));\n     }\n \n+    public void setDynamicFilterStats(DynamicFiltersStats dynamicFilterStats)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxMDU5NQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r455010595", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-07-15T12:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MDE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MDMyMQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r454980321", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    requireNonNull(dynamicFilterStats, \"dynamicFilterStats is null\");\n          \n          \n            \n                    requireNonNull(dynamicFiltersStats, \"dynamicFiltersStats is null\");", "author": "Lewuathe", "createdAt": "2020-07-15T11:25:42Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -655,6 +660,12 @@ public void setRoutines(List<RoutineInfo> routines)\n         this.routines.set(ImmutableList.copyOf(routines));\n     }\n \n+    public void setDynamicFilterStats(DynamicFiltersStats dynamicFilterStats)\n+    {\n+        requireNonNull(dynamicFilterStats, \"dynamicFilterStats is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxMDY2MQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r455010661", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-07-15T12:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MDMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4Nzg5OQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r454987899", "bodyText": "This synchronized scope may be a little broader than needed. If many queries using dynamic filtering run concurrently, this part to get the dynamic filtering stats can cause the long waiting.\nLooks like we may need to guard only dynamicFilterSummaries?", "author": "Lewuathe", "createdAt": "2020-07-15T11:41:06Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,46 @@ void registerQuery(\n         }\n     }\n \n+    public synchronized DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxMTMyMQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r455011321", "bodyText": "agreed, made changes to restrict guard to smaller scope", "author": "raunaqmorarka", "createdAt": "2020-07-15T12:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4Nzg5OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzNjQ0OA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462236448", "bodyText": "move it below routines", "author": "sopel39", "createdAt": "2020-07-29T11:44:09Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -157,6 +158,8 @@\n \n     private final WarningCollector warningCollector;\n \n+    private final AtomicReference<DynamicFiltersStats> dynamicFiltersStats = new AtomicReference<>(DynamicFiltersStats.EMPTY);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MzI1Ng==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462243256", "bodyText": "make it accept session as it's not obvious for which Connector session is required (we know it's irrelevant)", "author": "sopel39", "createdAt": "2020-07-29T11:57:28Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,54 @@ void registerQuery(\n         }\n     }\n \n+    public DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0Mzc3OA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462243778", "bodyText": "synchronization is not needed as we are not updating these data structures, change code to:\ndynamicFilterFutures = dynamicFilterSummaries.getOrDefault(queryId, ImmutableMap.of());\nnumRepartitionedFilters = queryRepartitionedDynamicFilters.getOrDefault(queryId, ImmutableSet.of()).size();\nnumReplicatedFilters = queryReplicatedDynamicFilters.get(queryId, ImmutableSet.of()).size();", "author": "sopel39", "createdAt": "2020-07-29T11:58:25Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,54 @@ void registerQuery(\n         }\n     }\n \n+    public DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)\n+    {\n+        Map<DynamicFilterId, SettableFuture<Domain>> dynamicFilterFutures;\n+        int numRepartitionedFilters;\n+        int numReplicatedFilters;\n+        synchronized (this) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1NzYxNQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462257615", "bodyText": "please add also numTotalDynamicFilters", "author": "sopel39", "createdAt": "2020-07-29T12:24:08Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -360,4 +412,130 @@ private int getNumberOfTasks()\n             return taskDynamicFilters;\n         }\n     }\n+\n+    public static class DynamicFiltersStats\n+    {\n+        public static final DynamicFiltersStats EMPTY = new DynamicFiltersStats(ImmutableList.of(), 0, 0, 0);\n+\n+        private final List<DynamicFilterDomainStats> dynamicFilterDomainStats;\n+        private final int numRepartitionedDynamicFilters;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1ODI1NA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462258254", "bodyText": "this counter is not needed. It can be computed from builder.build().size()", "author": "sopel39", "createdAt": "2020-07-29T12:25:16Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,54 @@ void registerQuery(\n         }\n     }\n \n+    public DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)\n+    {\n+        Map<DynamicFilterId, SettableFuture<Domain>> dynamicFilterFutures;\n+        int numRepartitionedFilters;\n+        int numReplicatedFilters;\n+        synchronized (this) {\n+            dynamicFilterFutures = dynamicFilterSummaries.get(queryId);\n+            if (dynamicFilterFutures == null) {\n+                // query is not registered yet\n+                return DynamicFiltersStats.EMPTY;\n+            }\n+\n+            numRepartitionedFilters = queryRepartitionedDynamicFilters.get(queryId).size();\n+            numReplicatedFilters = queryReplicatedDynamicFilters.get(queryId).size();\n+        }\n+\n+        int numDynamicFiltersCompleted = 0;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1OTY3NA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462259674", "bodyText": "toString() for DiscreteValues and AllOrNone doesn't make sense.", "author": "sopel39", "createdAt": "2020-07-29T12:27:55Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,54 @@ void registerQuery(\n         }\n     }\n \n+    public DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)\n+    {\n+        Map<DynamicFilterId, SettableFuture<Domain>> dynamicFilterFutures;\n+        int numRepartitionedFilters;\n+        int numReplicatedFilters;\n+        synchronized (this) {\n+            dynamicFilterFutures = dynamicFilterSummaries.get(queryId);\n+            if (dynamicFilterFutures == null) {\n+                // query is not registered yet\n+                return DynamicFiltersStats.EMPTY;\n+            }\n+\n+            numRepartitionedFilters = queryRepartitionedDynamicFilters.get(queryId).size();\n+            numReplicatedFilters = queryReplicatedDynamicFilters.get(queryId).size();\n+        }\n+\n+        int numDynamicFiltersCompleted = 0;\n+        ImmutableList.Builder<DynamicFilterDomainStats> builder = ImmutableList.builder();\n+        for (Map.Entry<DynamicFilterId, SettableFuture<Domain>> entry : dynamicFilterFutures.entrySet()) {\n+            DynamicFilterId dynamicFilterId = entry.getKey();\n+            SettableFuture<Domain> domainFuture = entry.getValue();\n+            if (domainFuture.isDone()) {\n+                numDynamicFiltersCompleted++;\n+                DynamicFilterDomainStats filterDomainStats = getDone(domainFuture).getValues()\n+                        .getValuesProcessor().transform(\n+                                ranges -> {\n+                                    String span;\n+                                    if (ranges.isNone()) {\n+                                        span = \"NONE\";\n+                                    }\n+                                    else {\n+                                        span = ranges.getSpan().toString(session);\n+                                    }\n+                                    return new DynamicFilterDomainStats(dynamicFilterId, span, ranges.getRangeCount());\n+                                },\n+                                discreteValues -> new DynamicFilterDomainStats(dynamicFilterId, discreteValues.toString(), discreteValues.getValuesCount()),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3MDAyMQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462270021", "bodyText": "change it into streaming approach:\ndynamicFilterFutures.stream().\n  .filter(entry -> entry.getValue().isDone())\n  .map(entry -> {\n    DynamicFilterId dynamicFilterId = entry.getKey();\n    Domain domain = getDone(entry.getValue());\n    // simplify for readability\n    String simplifiedDomain = domain.simplify(1).toString(session.toConnectorSession());\n    int rangeCount = domain.getValuesProcessor().transform(\n      ranges -> ranges.getRangeCount(),\n      discreteValues -> 0,\n      allOrNone -> 0);\n    int discreteValuesCount = domain.getValuesProcessor().transform(\n      ranges -> 0,\n      discreteValues -> discreteValues.getValuesCount(),\n      allOrNone -> 0);\n    return new DynamicFilterDomainStats(dynamicFilterId, simplifiedDomain, rangeCount, discreteValuesCount);\n  }\n  .collect(toImmutableMap());", "author": "sopel39", "createdAt": "2020-07-29T12:46:23Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -156,6 +160,54 @@ void registerQuery(\n         }\n     }\n \n+    public DynamicFiltersStats getDynamicFilteringStats(QueryId queryId, ConnectorSession session)\n+    {\n+        Map<DynamicFilterId, SettableFuture<Domain>> dynamicFilterFutures;\n+        int numRepartitionedFilters;\n+        int numReplicatedFilters;\n+        synchronized (this) {\n+            dynamicFilterFutures = dynamicFilterSummaries.get(queryId);\n+            if (dynamicFilterFutures == null) {\n+                // query is not registered yet\n+                return DynamicFiltersStats.EMPTY;\n+            }\n+\n+            numRepartitionedFilters = queryRepartitionedDynamicFilters.get(queryId).size();\n+            numReplicatedFilters = queryReplicatedDynamicFilters.get(queryId).size();\n+        }\n+\n+        int numDynamicFiltersCompleted = 0;\n+        ImmutableList.Builder<DynamicFilterDomainStats> builder = ImmutableList.builder();\n+        for (Map.Entry<DynamicFilterId, SettableFuture<Domain>> entry : dynamicFilterFutures.entrySet()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3MTU0NA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462271544", "bodyText": "instead of span and numValues, let's have:\nString simplifiedDomain;\nint rangeCount;\nint discreteValuesCount;", "author": "sopel39", "createdAt": "2020-07-29T12:48:56Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -360,4 +412,130 @@ private int getNumberOfTasks()\n             return taskDynamicFilters;\n         }\n     }\n+\n+    public static class DynamicFiltersStats\n+    {\n+        public static final DynamicFiltersStats EMPTY = new DynamicFiltersStats(ImmutableList.of(), 0, 0, 0);\n+\n+        private final List<DynamicFilterDomainStats> dynamicFilterDomainStats;\n+        private final int numRepartitionedDynamicFilters;\n+        private final int numReplicatedDynamicFilters;\n+        private final int numDynamicFiltersCompleted;\n+\n+        @JsonCreator\n+        public DynamicFiltersStats(\n+                @JsonProperty(\"dynamicFilterDomainStats\") List<DynamicFilterDomainStats> dynamicFilterDomainStats,\n+                @JsonProperty(\"numRepartitionedDynamicFilters\") int numRepartitionedDynamicFilters,\n+                @JsonProperty(\"numReplicatedDynamicFilters\") int numReplicatedDynamicFilters,\n+                @JsonProperty(\"numDynamicFiltersCompleted\") int numDynamicFiltersCompleted)\n+        {\n+            this.dynamicFilterDomainStats = dynamicFilterDomainStats;\n+            this.numRepartitionedDynamicFilters = numRepartitionedDynamicFilters;\n+            this.numReplicatedDynamicFilters = numReplicatedDynamicFilters;\n+            this.numDynamicFiltersCompleted = numDynamicFiltersCompleted;\n+        }\n+\n+        @JsonProperty\n+        public List<DynamicFilterDomainStats> getDynamicFilterDomainStats()\n+        {\n+            return dynamicFilterDomainStats;\n+        }\n+\n+        @JsonProperty\n+        public int getNumRepartitionedDynamicFilters()\n+        {\n+            return numRepartitionedDynamicFilters;\n+        }\n+\n+        @JsonProperty\n+        public int getNumReplicatedDynamicFilters()\n+        {\n+            return numReplicatedDynamicFilters;\n+        }\n+\n+        @JsonProperty\n+        public int getNumDynamicFiltersCompleted()\n+        {\n+            return numDynamicFiltersCompleted;\n+        }\n+\n+        @Override\n+        public boolean equals(Object o)\n+        {\n+            if (this == o) {\n+                return true;\n+            }\n+            if (o == null || getClass() != o.getClass()) {\n+                return false;\n+            }\n+            DynamicFiltersStats that = (DynamicFiltersStats) o;\n+            return numRepartitionedDynamicFilters == that.numRepartitionedDynamicFilters &&\n+                    numReplicatedDynamicFilters == that.numReplicatedDynamicFilters &&\n+                    numDynamicFiltersCompleted == that.numDynamicFiltersCompleted &&\n+                    Objects.equals(dynamicFilterDomainStats, that.dynamicFilterDomainStats);\n+        }\n+\n+        @Override\n+        public int hashCode()\n+        {\n+            return Objects.hash(dynamicFilterDomainStats, numRepartitionedDynamicFilters, numReplicatedDynamicFilters, numDynamicFiltersCompleted);\n+        }\n+    }\n+\n+    public static class DynamicFilterDomainStats\n+    {\n+        private final DynamicFilterId dynamicFilterId;\n+        private final String span;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3MjQ1NQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462272455", "bodyText": "undo", "author": "sopel39", "createdAt": "2020-07-29T12:50:16Z", "path": "presto-spi/src/main/java/io/prestosql/spi/predicate/SortedRangeSet.java", "diffHunk": "@@ -227,6 +227,12 @@ public Range getSpan()\n             {\n                 return SortedRangeSet.this.getSpan();\n             }\n+\n+            @Override", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3MjU5OA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r462272598", "bodyText": "undo, not needed", "author": "sopel39", "createdAt": "2020-07-29T12:50:30Z", "path": "presto-spi/src/main/java/io/prestosql/spi/predicate/Ranges.java", "diffHunk": "@@ -28,4 +28,6 @@\n      * @return Single range encompassing all of allowed the ranges\n      */\n     Range getSpan();\n+\n+    boolean isNone();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NzE0OA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472197148", "bodyText": "use final AtomicReference<DynamicFiltersStats> dynamicFiltersStatsSupplier instead.", "author": "sopel39", "createdAt": "2020-08-18T13:29:18Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -154,6 +156,7 @@\n     private final AtomicReference<Optional<Output>> output = new AtomicReference<>(Optional.empty());\n     private final AtomicReference<List<TableInfo>> referencedTables = new AtomicReference<>(ImmutableList.of());\n     private final AtomicReference<List<RoutineInfo>> routines = new AtomicReference<>(ImmutableList.of());\n+    private Supplier<DynamicFiltersStats> dynamicFiltersStatsProvider = () -> DynamicFiltersStats.EMPTY;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5ODk5Mw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472198993", "bodyText": "remote this method and inline dynamicFiltersStatsProvider.get()", "author": "sopel39", "createdAt": "2020-08-18T13:31:51Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -666,6 +671,17 @@ public void setRoutines(List<RoutineInfo> routines)\n         this.routines.set(ImmutableList.copyOf(routines));\n     }\n \n+    private synchronized DynamicFiltersStats getDynamicFiltersStats()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzExNDM1Nw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r473114357", "bodyText": "I avoided AtomicReference<Supplier<DynamicFiltersStats>> because I think there is a potential for race condition with that. Example\nIn getQueryStats, we get reference to the non-final df stats supplier, but the get on supplier isn't executed yet.\nQuery finishes, unregisterDynamicFilteringQuery is called, final df stats supplier is set and dynamicFilterService.removeQuery runs.\nNow we continue with execution of getQueryStats, we still have reference to old supplier and calling get on it will give empty stats now as the dynamic filter service has cleaned up its maps.", "author": "raunaqmorarka", "createdAt": "2020-08-19T15:24:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5ODk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NTEwOQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r473275109", "bodyText": "that makes sense, thanks", "author": "sopel39", "createdAt": "2020-08-19T19:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5ODk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5OTM0Mw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472199343", "bodyText": "you can use:\nthis.dynamicFiltersStatsProvider = requireNonNull(dynamicFiltersStats, \"dynamicFiltersStats is null\");", "author": "sopel39", "createdAt": "2020-08-18T13:32:23Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -666,6 +671,17 @@ public void setRoutines(List<RoutineInfo> routines)\n         this.routines.set(ImmutableList.copyOf(routines));\n     }\n \n+    private synchronized DynamicFiltersStats getDynamicFiltersStats()\n+    {\n+        return dynamicFiltersStatsProvider.get();\n+    }\n+\n+    public synchronized void setDynamicFiltersStatsProvider(Supplier<DynamicFiltersStats> dynamicFiltersStats)\n+    {\n+        requireNonNull(dynamicFiltersStats, \"dynamicFiltersStats is null\");\n+        this.dynamicFiltersStatsProvider = dynamicFiltersStats;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5OTQ4OQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472199489", "bodyText": "rename dynamicFiltersStats to dynamicFiltersStatsSupplier", "author": "sopel39", "createdAt": "2020-08-18T13:32:38Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -666,6 +671,17 @@ public void setRoutines(List<RoutineInfo> routines)\n         this.routines.set(ImmutableList.copyOf(routines));\n     }\n \n+    private synchronized DynamicFiltersStats getDynamicFiltersStats()\n+    {\n+        return dynamicFiltersStatsProvider.get();\n+    }\n+\n+    public synchronized void setDynamicFiltersStatsProvider(Supplier<DynamicFiltersStats> dynamicFiltersStats)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIxNjgwNw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472216807", "bodyText": "move dynamicFilterService.getDynamicFilteringStats outside of synchronized section, e.g you could pass finalDynamicFiltersStats as unregisterDynamicFilteringQuery argument", "author": "sopel39", "createdAt": "2020-08-18T13:56:47Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java", "diffHunk": "@@ -211,14 +212,21 @@ private synchronized void registerDynamicFilteringQuery()\n         }\n \n         dynamicFilterService.registerQuery(this);\n+        stateMachine.setDynamicFiltersStatsProvider(\n+                () -> dynamicFilterService.getDynamicFilteringStats(\n+                        stateMachine.getQueryId(),\n+                        stateMachine.getSession()));\n     }\n \n     private synchronized void unregisterDynamicFilteringQuery()\n     {\n         if (!isDone()) {\n             return;\n         }\n-\n+        DynamicFiltersStats finalDynamicFiltersStats = dynamicFilterService.getDynamicFilteringStats(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMzcxNA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472223714", "bodyText": "please also assert re-partitioned and replicated DF count after first getDynamicFilteringStats call", "author": "sopel39", "createdAt": "2020-08-18T14:06:15Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -93,6 +111,15 @@ public void testDynamicFilterSummaryCompletion()\n         assertEquals(summary.get(), multipleValues(INTEGER, ImmutableList.of(1L, 2L, 3L)));\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 3);\n \n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getNumDynamicFiltersCompleted(), 1);\n+        assertEquals(stats.getNumRepartitionedDynamicFilters(), 1);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNTIwOA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472225208", "bodyText": "please also assert getNumRepartitionedDynamicFilters and getNumReplicatedDynamicFilters after first getDynamicFilteringStats call", "author": "sopel39", "createdAt": "2020-08-18T14:08:25Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -247,6 +285,18 @@ public void testDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 6);\n         assertTrue(blockedFuture.isDone());\n \n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getNumDynamicFiltersCompleted(), 3);\n+        assertEquals(stats.getNumRepartitionedDynamicFilters(), 3);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNzIzNQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472227235", "bodyText": "please also add assertion before DF is completed", "author": "sopel39", "createdAt": "2020-08-18T14:11:15Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -296,12 +346,33 @@ public void testReplicatedDynamicFilter()\n                 singleValue(INTEGER, 1L))));\n         assertTrue(dynamicFilter.isComplete());\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyODE0Nw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472228147", "bodyText": "use SortedRangeSet.of(...) instead", "author": "sopel39", "createdAt": "2020-08-18T14:12:30Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -296,12 +346,33 @@ public void testReplicatedDynamicFilter()\n                 singleValue(INTEGER, 1L))));\n         assertTrue(dynamicFilter.isComplete());\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getNumTotalDynamicFilters(), 1);\n+        assertEquals(stats.getNumDynamicFiltersCompleted(), 1);\n+        assertEquals(stats.getNumReplicatedDynamicFilters(), 1);\n+        assertEquals(stats.getNumRepartitionedDynamicFilters(), 0);\n+        assertEquals(\n+                stats.getDynamicFilterDomainStats(),\n+                ImmutableList.of(new DynamicFilterDomainStats(filterId1, Domain.create(\n+                        SortedRangeSet.copyOf(INTEGER, ImmutableList.of(equal(INTEGER, 1L))),\n+                        false)\n+                        .toString(session.toConnectorSession()), 1, 0)));\n \n         // all dynamic filters have been collected, no need for more requests\n         dynamicFilterService.collectDynamicFilters();\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    private static String getExpectedDomainString(Type type, Object low, Object high)\n+    {\n+        return Domain.create(\n+                SortedRangeSet.copyOf(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyODY1Nw==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472228657", "bodyText": "undo", "author": "sopel39", "createdAt": "2020-08-18T14:13:05Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -317,8 +388,7 @@ public void testReplicatedDynamicFilter()\n \n         void addTasks(List<TaskId> taskIds)\n         {\n-            taskIds.stream()\n-                    .forEach(taskId -> stageDynamicFilters\n+            taskIds.forEach(taskId -> stageDynamicFilters", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyOTU3NA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472229574", "bodyText": "type is always INTEGER, no need to pass it as arg. You can actually change signature to:\nString getExpectedDomainString(int low, int high)", "author": "sopel39", "createdAt": "2020-08-18T14:14:18Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -296,12 +346,33 @@ public void testReplicatedDynamicFilter()\n                 singleValue(INTEGER, 1L))));\n         assertTrue(dynamicFilter.isComplete());\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getNumTotalDynamicFilters(), 1);\n+        assertEquals(stats.getNumDynamicFiltersCompleted(), 1);\n+        assertEquals(stats.getNumReplicatedDynamicFilters(), 1);\n+        assertEquals(stats.getNumRepartitionedDynamicFilters(), 0);\n+        assertEquals(\n+                stats.getDynamicFilterDomainStats(),\n+                ImmutableList.of(new DynamicFilterDomainStats(filterId1, Domain.create(\n+                        SortedRangeSet.copyOf(INTEGER, ImmutableList.of(equal(INTEGER, 1L))),\n+                        false)\n+                        .toString(session.toConnectorSession()), 1, 0)));\n \n         // all dynamic filters have been collected, no need for more requests\n         dynamicFilterService.collectDynamicFilters();\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    private static String getExpectedDomainString(Type type, Object low, Object high)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzMDUyOQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r472230529", "bodyText": "put filterId1, Domain.create args in newlines,\nuse SortedRangeSet.of instead", "author": "sopel39", "createdAt": "2020-08-18T14:15:31Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -296,12 +346,33 @@ public void testReplicatedDynamicFilter()\n                 singleValue(INTEGER, 1L))));\n         assertTrue(dynamicFilter.isComplete());\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getNumTotalDynamicFilters(), 1);\n+        assertEquals(stats.getNumDynamicFiltersCompleted(), 1);\n+        assertEquals(stats.getNumReplicatedDynamicFilters(), 1);\n+        assertEquals(stats.getNumRepartitionedDynamicFilters(), 0);\n+        assertEquals(\n+                stats.getDynamicFilterDomainStats(),\n+                ImmutableList.of(new DynamicFilterDomainStats(filterId1, Domain.create(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3OTMyNQ==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r473279325", "bodyText": "add\n@GuardedBy(\"dynamicFiltersStatsSupplierLock\")\nprivate Supplier<DynamicFiltersStats> dynamicFiltersStatsSupplier = () -> DynamicFiltersStats.EMPTY;\nprivate final Object dynamicFiltersStatsSupplierLock = new Object();\n\nand make methods:\nprivate DynamicFiltersStats getDynamicFiltersStats() {\n  synchronized(dynamicFiltersStatsSupplierLock) {\n    return dynamicFiltersStatsSupplier.get();\n  }\n}\n\npublic void setDynamicFiltersStatsSupplier(Supplier<DynamicFiltersStats> dynamicFiltersStatsSupplier)\n{\n  synchronized(dynamicFiltersStatsSupplierLock) {\n    this.dynamicFiltersStatsSupplier = requireNonNull(dynamicFiltersStatsSupplier, \"dynamicFiltersStatsSupplier is null\");\n  }\n}", "author": "sopel39", "createdAt": "2020-08-19T19:49:24Z", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -154,6 +156,7 @@\n     private final AtomicReference<Optional<Output>> output = new AtomicReference<>(Optional.empty());\n     private final AtomicReference<List<TableInfo>> referencedTables = new AtomicReference<>(ImmutableList.of());\n     private final AtomicReference<List<RoutineInfo>> routines = new AtomicReference<>(ImmutableList.of());\n+    private Supplier<DynamicFiltersStats> dynamicFiltersStatsSupplier = () -> DynamicFiltersStats.EMPTY;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4MjU2MA==", "url": "https://github.com/trinodb/trino/pull/4440#discussion_r473282560", "bodyText": "Done", "author": "raunaqmorarka", "createdAt": "2020-08-19T19:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3OTMyNQ=="}], "type": "inlineReview"}, {"oid": "28b84ce906818c080d55b649f510caf2d853a476", "url": "https://github.com/trinodb/trino/commit/28b84ce906818c080d55b649f510caf2d853a476", "message": "Report dynamic filtering stats in QueryStats", "committedDate": "2020-08-19T19:54:32Z", "type": "commit"}, {"oid": "28b84ce906818c080d55b649f510caf2d853a476", "url": "https://github.com/trinodb/trino/commit/28b84ce906818c080d55b649f510caf2d853a476", "message": "Report dynamic filtering stats in QueryStats", "committedDate": "2020-08-19T19:54:32Z", "type": "forcePushed"}]}