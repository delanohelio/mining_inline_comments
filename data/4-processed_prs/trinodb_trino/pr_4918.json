{"pr_number": 4918, "pr_title": "Pushdown domains with many ranges in Oracle connector", "pr_createdAt": "2020-08-21T14:14:37Z", "pr_url": "https://github.com/trinodb/trino/pull/4918", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5ODk3Nw==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r474798977", "bodyText": "can we remove override now?", "author": "findepi", "createdAt": "2020-08-21T16:21:49Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestOracleDistributedQueries.java", "diffHunk": "@@ -128,7 +128,7 @@ protected TestTable createTableWithDefaultColumns()\n     @Override\n     public void testLargeIn()\n     {\n-        int numberOfElements = 1000;\n+        int numberOfElements = 5000;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwODM2Nw==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r475108367", "bodyText": "yes, this was overridden only to change the number of elements..", "author": "eskabetxe", "createdAt": "2020-08-22T16:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5ODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NDc5MQ==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r475454791", "bodyText": "There is still this extra part in Oracle test which is not present in superclass:\n        String arrayValues = range(0, numberOfElements)\n                .mapToObj(i -> format(\"ARRAY[%s, %s, %s]\", i, i + 1, i + 2))\n                .collect(joining(\", \"));\n        assertQuery(\"SELECT ARRAY[0, 0, 0] in (ARRAY[0, 0, 0], \" + arrayValues + \")\", \"values true\");\n        assertQuery(\"SELECT ARRAY[0, 0, 0] in (\" + arrayValues + \")\", \"values false\");\n\nI can call out to super anyway though, even if we still want test with arrays.", "author": "losipiuk", "createdAt": "2020-08-24T09:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5ODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxODkxMw==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r475518913", "bodyText": "@losipiuk that code isnt oracle especific, that method have that code before..\nthat was removed here 0c13d16", "author": "eskabetxe", "createdAt": "2020-08-24T10:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5ODk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5OTY1MQ==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r474799651", "bodyText": "You eliminate a filter here. Do we have a predicate pushdown test for Oracle, like we have for postgres?", "author": "findepi", "createdAt": "2020-08-21T16:23:17Z", "path": "presto-oracle/src/main/java/io/prestosql/plugin/oracle/OracleClient.java", "diffHunk": "@@ -332,6 +345,19 @@ else if (precision > Decimals.MAX_PRECISION || columnSize <= 0) {\n         return Optional.empty();\n     }\n \n+    private static PredicatePushdownController.DomainPushdownResult fullPushdownIfSupported(Domain domain)\n+    {\n+        if (domain.getValues().getRanges().getRangeCount() > ORACLE_MAX_LIST_EXPRESSIONS) {\n+            // pushdown simplified domain\n+            Domain pushedDown = domain.simplify();\n+            return new PredicatePushdownController.DomainPushdownResult(pushedDown, domain);\n+        }\n+        else {\n+            // full pushdown\n+            return new PredicatePushdownController.DomainPushdownResult(domain, Domain.all(domain.getType()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0OTcwOA==", "url": "https://github.com/trinodb/trino/pull/4918#discussion_r475549708", "bodyText": "Added.", "author": "losipiuk", "createdAt": "2020-08-24T12:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5OTY1MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "f8a33e0f13ff18f68d69547d56b6186bf10e584e", "url": "https://github.com/trinodb/trino/commit/f8a33e0f13ff18f68d69547d56b6186bf10e584e", "message": "Pushdown domains with many ranges in Oracle connector\n\nIf domain has more that 1000 ranges it is simplified, before pushdown\nattempt. Without this query would fails with:\nORA-01795: maximum number of expressions in a list is 1000", "committedDate": "2020-08-24T21:14:09Z", "type": "commit"}, {"oid": "4769784dfa2371631e87eab4065629ff0e74880b", "url": "https://github.com/trinodb/trino/commit/4769784dfa2371631e87eab4065629ff0e74880b", "message": "Add Oracle pushdown tests", "committedDate": "2020-08-24T21:14:11Z", "type": "commit"}, {"oid": "4769784dfa2371631e87eab4065629ff0e74880b", "url": "https://github.com/trinodb/trino/commit/4769784dfa2371631e87eab4065629ff0e74880b", "message": "Add Oracle pushdown tests", "committedDate": "2020-08-24T21:14:11Z", "type": "forcePushed"}]}