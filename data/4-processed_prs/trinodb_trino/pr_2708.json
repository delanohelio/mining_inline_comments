{"pr_number": 2708, "pr_title": "Replace AuthenticatedIdentity with Identity", "pr_createdAt": "2020-02-02T14:24:22Z", "pr_url": "https://github.com/trinodb/trino/pull/2708", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4ODgzMg==", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374888832", "bodyText": "Use orElseGet", "author": "electrum", "createdAt": "2020-02-04T19:53:57Z", "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "diffHunk": "@@ -186,6 +171,20 @@ else if (nameParts.size() == 2) {\n         transactionId = parseTransactionId(transactionIdHeader);\n     }\n \n+    private static Identity buildSessionIdentity(Optional<Identity> authenticatedIdentity, HttpServletRequest servletRequest)\n+    {\n+        String prestoUser = trimEmptyToNull(servletRequest.getHeader(PRESTO_USER));\n+        String user = prestoUser != null ? prestoUser : authenticatedIdentity.map(Identity::getUser).orElse(null);\n+        assertRequest(user != null, \"User must be set\");\n+        return authenticatedIdentity\n+                .map(Identity::from)\n+                .map(identity -> identity.withUser(user))\n+                .orElse(Identity.forUser(user))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5MTA4Ng==", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374891086", "bodyText": "Maybe collapse these to\n.map(authenticated -> Identity.from(authenticated).withUser(user))\nSo that it's more clear what's happening compared to the \"or else\" case.", "author": "electrum", "createdAt": "2020-02-04T19:58:35Z", "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "diffHunk": "@@ -186,6 +171,20 @@ else if (nameParts.size() == 2) {\n         transactionId = parseTransactionId(transactionIdHeader);\n     }\n \n+    private static Identity buildSessionIdentity(Optional<Identity> authenticatedIdentity, HttpServletRequest servletRequest)\n+    {\n+        String prestoUser = trimEmptyToNull(servletRequest.getHeader(PRESTO_USER));\n+        String user = prestoUser != null ? prestoUser : authenticatedIdentity.map(Identity::getUser).orElse(null);\n+        assertRequest(user != null, \"User must be set\");\n+        return authenticatedIdentity\n+                .map(Identity::from)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5NzQwNA==", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374897404", "bodyText": "This would be easier to read if extract a variable for the new identity", "author": "electrum", "createdAt": "2020-02-04T20:12:18Z", "path": "presto-main/src/main/java/io/prestosql/server/security/AuthenticationFilter.java", "diffHunk": "@@ -87,7 +87,9 @@ public void doFilter(ServletRequest servletRequest, ServletResponse servletRespo\n                 response.setContentType(PLAIN_TEXT_UTF_8.toString());\n                 return;\n             }\n-            nextFilter.doFilter(withPrincipal(request, principal), response);\n+            withAuthenticatedIdentity(nextFilter, request, response, Identity.forUser(\"<internal>\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a34a88c1d3168b1947261bf2a393e5f294c4c45a", "url": "https://github.com/trinodb/trino/commit/a34a88c1d3168b1947261bf2a393e5f294c4c45a", "message": "Clean up warnings in HttpRequestSessionContext", "committedDate": "2020-02-07T12:51:35Z", "type": "commit"}, {"oid": "fe962c2ef889cf7d37bb8631bece4a70e16efd95", "url": "https://github.com/trinodb/trino/commit/fe962c2ef889cf7d37bb8631bece4a70e16efd95", "message": "Replace AuthenticatedIdentity with Identity", "committedDate": "2020-02-07T12:58:35Z", "type": "commit"}, {"oid": "fe962c2ef889cf7d37bb8631bece4a70e16efd95", "url": "https://github.com/trinodb/trino/commit/fe962c2ef889cf7d37bb8631bece4a70e16efd95", "message": "Replace AuthenticatedIdentity with Identity", "committedDate": "2020-02-07T12:58:35Z", "type": "forcePushed"}]}