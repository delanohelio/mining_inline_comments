{"pr_number": 5052, "pr_title": "Add support for ABFS OAuth 2 authentication", "pr_createdAt": "2020-09-02T02:00:09Z", "pr_url": "https://github.com/trinodb/trino/pull/5052", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzODk2NA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481938964", "bodyText": "typo in commit message", "author": "losipiuk", "createdAt": "2020-09-02T09:39:21Z", "path": "presto-hive-hadoop2/bin/common.sh", "diffHunk": "@@ -86,7 +86,7 @@ SCRIPT_DIR=\"${BASH_SOURCE%/*}\"\n INTEGRATION_TESTS_ROOT=\"${SCRIPT_DIR}/..\"\n PROJECT_ROOT=\"${INTEGRATION_TESTS_ROOT}/..\"\n DOCKER_COMPOSE_LOCATION=\"${INTEGRATION_TESTS_ROOT}/conf/docker-compose.yml\"\n-source \"${BASH_SOURCE%/*}/../../presto-product-tests/conf/product-tests-defaults.sh\"", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NDg3MA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481944870", "bodyText": "extend TestHiveAzureConfig", "author": "losipiuk", "createdAt": "2020-09-02T09:49:42Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/HiveAzureConfig.java", "diffHunk": "@@ -118,4 +121,43 @@ public HiveAzureConfig setAdlRefreshUrl(String adlRefreshUrl)\n         this.adlRefreshUrl = adlRefreshUrl;\n         return this;\n     }\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NTgxNA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481945814", "bodyText": "can you add unit test for this validation rules?", "author": "losipiuk", "createdAt": "2020-09-02T09:51:17Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/PrestoAzureConfigurationInitializer.java", "diffHunk": "@@ -68,6 +71,19 @@ public PrestoAzureConfigurationInitializer(HiveAzureConfig config)\n                     adlClientId.isPresent() && adlCredential.isPresent() && adlRefreshUrl.isPresent(),\n                     \"If any of ADL client ID, credential, and refresh URL are set, all must be set.\");\n         }\n+\n+        this.abfsOAuthClientEndpoint = dropEmpty(config.getAbfsOAuthClientEndpoint());\n+        this.abfsOAuthClientId = dropEmpty(config.getAbfsOAuthClientId());\n+        this.abfsOAuthClientSecret = dropEmpty(config.getAbfsOAuthClientSecret());\n+        if (abfsOAuthClientEndpoint.isPresent() || abfsOAuthClientSecret.isPresent() || abfsOAuthClientId.isPresent()) {\n+            checkArgument(\n+                    abfsOAuthClientEndpoint.isPresent() && abfsOAuthClientId.isPresent() && abfsOAuthClientSecret.isPresent(),\n+                    \"If any of ABFS OAuth2 Client endpoint, ID, and secret are set, all must be set.\");\n+        }\n+\n+        checkArgument(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzOTk4NA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482639984", "bodyText": "Done, but I might have overdone it.", "author": "jirassimok", "createdAt": "2020-09-03T01:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NTgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MzUzMg==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r483463532", "bodyText": ":) Nice.\nI think there you can still add test to validate for Multiple ABFS authentication methods configured: access key and OAuth2.\nJust if you want :)\nNVM - it is there in next commit.", "author": "losipiuk", "createdAt": "2020-09-04T08:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NTgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5Mjg0OQ==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482392849", "bodyText": "Do you need to exclude the new test you added (TestHiveFileSystemAbfsOAuth )?", "author": "aalbu", "createdAt": "2020-09-02T20:08:47Z", "path": "presto-hive-hadoop2/pom.xml", "diffHunk": "@@ -127,7 +127,7 @@\n                                 <exclude>**/TestHiveFileSystemS3.java</exclude>\n                                 <exclude>**/TestHiveFileSystemS3SelectPushdown.java</exclude>\n                                 <exclude>**/TestHiveFileSystemWasb.java</exclude>\n-                                <exclude>**/TestHiveFileSystemAbfs.java</exclude>\n+                                <exclude>**/TestHiveFileSystemAbfsAccessKey.java</exclude>", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NzIyNA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482397224", "bodyText": "Perhaps we could just keep a test-hive-hadoop2-abfs1 profile to run both tests.", "author": "aalbu", "createdAt": "2020-09-02T20:11:59Z", "path": "presto-hive-hadoop2/pom.xml", "diffHunk": "@@ -186,15 +186,31 @@\n             </build>\n         </profile>\n         <profile>\n-            <id>test-hive-hadoop2-abfs</id>\n+            <id>test-hive-hadoop2-abfs-access-key</id>\n             <build>\n                 <plugins>\n                     <plugin>\n                         <groupId>org.apache.maven.plugins</groupId>\n                         <artifactId>maven-surefire-plugin</artifactId>\n                         <configuration>\n                             <includes>\n-                                <include>**/TestHiveFileSystemAbfs.java</include>\n+                                <include>**/TestHiveFileSystemAbfsAccessKey.java</include>\n+                            </includes>\n+                        </configuration>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+        <profile>\n+            <id>test-hive-hadoop2-abfs-oauth</id>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYwNDE0NA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482604144", "bodyText": "We use the profiles to make the CI scripts run, so we would also need to merge those, which would be a bit trickier.\nIf we gave them completely disjoint test configuration properties, it wouldn't be too hard, but it might not look nice. On the other hand, it should let us just start the container once for both tests (we could also merge the WASB tests with them, as that is also ADLS Gen2).\nAlternatively, we could remove the non-default Maven profiles for all of the Hive storage tests except and just run the individual test classes.", "author": "jirassimok", "createdAt": "2020-09-02T23:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NzIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2NTQ5OA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r483465498", "bodyText": "How much time does it take if we have those separate. If it does not make whole build longer I would not fight for that. We can possibly do that as a followup.", "author": "losipiuk", "createdAt": "2020-09-04T08:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NzIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2OTM5OA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r483569398", "bodyText": "On the other hand, it should let us just start the container once for both tests (we could also merge the WASB tests with them, as that is also ADLS Gen2).\n\nThat's where I was going with this initially, but let's scrape that for now and stay focused.", "author": "aalbu", "createdAt": "2020-09-04T11:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NzIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQyNTE4Mg==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482425182", "bodyText": "That's kind of an unusual contract.  Why do we need an empty HiveAzureConfig as an argument?  The method could just instantiate one.", "author": "aalbu", "createdAt": "2020-09-02T20:33:13Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/AbstractTestHiveFileSystemAbfs.java", "diffHunk": "@@ -106,12 +94,13 @@ private void ensureTableExists(SchemaTableName table, String tableDirectoryName,\n         }\n     }\n \n+    /** Given an empty {@code HiveAzureConfig}, return a configured instance. */", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "url": "https://github.com/trinodb/trino/commit/feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "message": "DO NOT MERGE Show core-site.xml template & restart hive server in ABFS access key tests", "committedDate": "2020-09-09T17:27:43Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNTYyOQ==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486615629", "bodyText": "We can shorten these names to drop the redundant \"client\" part and make them more consistent with the others\nAZURE_ABFS_OAUTH_ENDPOINT\nAZURE_ABFS_OAUTH_CLIENTID\nAZURE_ABFS_OAUTH_SECRET", "author": "electrum", "createdAt": "2020-09-10T20:30:57Z", "path": ".github/workflows/ci.yml", "diffHunk": "@@ -137,6 +137,19 @@ jobs:\n             source presto-product-tests/conf/product-tests-${{ matrix.config }}.sh &&\n               presto-hive-hadoop2/bin/run_hive_abfs_access_key_tests.sh\n           fi\n+      - name: Run Hive Azure ABFS OAuth Tests\n+        if: matrix.config != 'config-empty' # Hive 1.x does not support Azure storage\n+        env:\n+          ABFS_CONTAINER: ${{ secrets.AZURE_ABFS_CONTAINER }}\n+          ABFS_ACCOUNT: ${{ secrets.AZURE_ABFS_ACCOUNT }}\n+          ABFS_OAUTH_CLIENT_ENDPOINT: ${{ secrets.AZURE_ABFS_OAUTH_CLIENT_ENDPOINT }}", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNjUyMA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486616520", "bodyText": "Add a dot after oauth since this is a separate group\nhive.azure.abfs.oauth.client-endpoint\nhive.azure.abfs.oauth.client-id\nhive.azure.abfs.oauth.client-secret", "author": "electrum", "createdAt": "2020-09-10T20:32:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/HiveAzureConfig.java", "diffHunk": "@@ -118,4 +121,43 @@ public HiveAzureConfig setAdlRefreshUrl(String adlRefreshUrl)\n         this.adlRefreshUrl = adlRefreshUrl;\n         return this;\n     }\n+\n+    @ConfigSecuritySensitive\n+    @Config(\"hive.azure.abfs.oauth-client-endpoint\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNzE5Mg==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486617192", "bodyText": "Add test. to all of these so that the names are consistent. Also, it's makes it clear these are test parameters and not system properties getting directly translated to config properties.", "author": "electrum", "createdAt": "2020-09-10T20:34:16Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveFileSystemAbfsOAuth.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import io.prestosql.plugin.hive.azure.HiveAzureConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Parameters;\n+\n+public class TestHiveFileSystemAbfsOAuth\n+        extends AbstractTestHiveFileSystemAbfs\n+{\n+    private String clientEndpoint;\n+    private String clientId;\n+    private String clientSecret;\n+\n+    @Parameters({\n+            \"hive.hadoop2.metastoreHost\",\n+            \"hive.hadoop2.metastorePort\",\n+            \"hive.hadoop2.databaseName\",\n+            \"test.hive.azure.abfs.container\",\n+            \"test.hive.azure.abfs.storage-account\",\n+            \"test.hive.azure.abfs.test-directory\",\n+            \"hive.azure.abfs.oauth-client-endpoint\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc0OTM0OA==", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486749348", "bodyText": "Here I was using the property names from HiveAzureConfig for the properties that are also present there. But I agree that the inconsistency is more confusing (and it made it harder to tell the test/configuration properties apart when renaming them all); fixed.", "author": "jirassimok", "createdAt": "2020-09-11T03:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNzE5Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "url": "https://github.com/trinodb/trino/commit/8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "message": "fixup! Add support for ABFS OAuth authentication", "committedDate": "2020-09-17T15:29:00Z", "type": "forcePushed"}, {"oid": "67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "url": "https://github.com/trinodb/trino/commit/67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "message": "Add support for ABFS OAuth authentication", "committedDate": "2020-09-17T18:22:32Z", "type": "commit"}, {"oid": "67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "url": "https://github.com/trinodb/trino/commit/67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "message": "Add support for ABFS OAuth authentication", "committedDate": "2020-09-17T18:22:32Z", "type": "forcePushed"}]}