{"pr_number": 3623, "pr_title": "Enable testColumnName in TestCassandraDistributedQueries", "pr_createdAt": "2020-05-05T02:44:50Z", "pr_url": "https://github.com/trinodb/trino/pull/3623", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg2MTg1OA==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419861858", "bodyText": "can we simply change the default here? 12 was quite big.", "author": "kokosing", "createdAt": "2020-05-05T04:50:28Z", "path": "presto-testing/src/main/java/io/prestosql/testing/sql/TestTable.java", "diffHunk": "@@ -67,8 +67,13 @@ public void close()\n     }\n \n     public static String randomTableSuffix()\n+    {\n+        return randomTableSuffix(RANDOM_SUFFIX_LENGTH);\n+    }\n+\n+    public static String randomTableSuffix(int maxLength)\n     {\n         String randomSuffix = Long.toString(abs(random.nextLong()), MAX_RADIX);\n-        return randomSuffix.substring(0, min(RANDOM_SUFFIX_LENGTH, randomSuffix.length()));\n+        return randomSuffix.substring(0, min(maxLength, randomSuffix.length()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMjE3NQ==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419932175", "bodyText": "Escaping should be done when we construct a CQL query", "author": "findepi", "createdAt": "2020-05-05T08:06:23Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -289,7 +290,7 @@ private CassandraOutputTableHandle createTable(ConnectorTableMetadata tableMetad\n         for (ColumnMetadata column : tableMetadata.getColumns()) {\n             columnNames.add(column.getName());\n             columnTypes.add(column.getType());\n-            columnExtra.add(new ExtraColumnMetadata(column.getName(), column.isHidden()));\n+            columnExtra.add(new ExtraColumnMetadata(escapeSingleQuote(column.getName()), column.isHidden()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMjU5Ng==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419932596", "bodyText": "I am concerned about escape function that doesn't quote.\nGenerally, escaping and quoting should be done at the same time, so they should be done\nat once, in one function.", "author": "findepi", "createdAt": "2020-05-05T08:07:10Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/util/CassandraCqlUtils.java", "diffHunk": "@@ -48,12 +49,12 @@ public static String validColumnName(String identifier)\n             return \"\\\"\\\"\";\n         }\n \n-        return quoteIdentifier(identifier);\n+        return quote(identifier);\n     }\n \n-    private static String quoteIdentifier(String identifier)\n+    public static String escapeSingleQuote(String identifier)\n     {\n-        return '\"' + identifier + '\"';\n+        return identifier.replace(\"'\", \"''\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMzAxMw==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419933013", "bodyText": "Please remove, as per @kokosing's https://github.com/prestosql/presto/pull/3623/files#r419861858 comment", "author": "findepi", "createdAt": "2020-05-05T08:07:56Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -94,6 +93,11 @@ protected boolean supportsArrays()\n         return true;\n     }\n \n+    protected String randomTableSuffix()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMDk2Ng==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420000966", "bodyText": "about 2^31 options, but since we generate them a lot.... can this be eg 8?\nwe can shorted the table name's base a bit maybe?", "author": "findepi", "createdAt": "2020-05-05T10:11:20Z", "path": "presto-testing/src/main/java/io/prestosql/testing/sql/TestTable.java", "diffHunk": "@@ -27,7 +27,7 @@\n         implements AutoCloseable\n {\n     private static final SecureRandom random = new SecureRandom();\n-    private static final int RANDOM_SUFFIX_LENGTH = 12;\n+    private static final int RANDOM_SUFFIX_LENGTH = 6;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAzODQwNA==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420038404", "bodyText": "Currently, only 0startingwithdigit is the problem. Let me rename to 0startwithdigit. and drop the commit to shorten.", "author": "ebyhr", "createdAt": "2020-05-05T11:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMDk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMTMyOQ==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420001329", "bodyText": "Rename id column to key in testColumnName\n\nin the commit message maybe mention that id has a special meaning in Cassandra.", "author": "findepi", "createdAt": "2020-05-05T10:12:01Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1180,7 +1180,7 @@ private void testColumnName(String columnName, boolean delimited)\n \n         try {\n             // TODO test with both CTAS *and* CREATE TABLE + INSERT, since they use different connector API methods.\n-            assertUpdate(\"CREATE TABLE \" + tableName + \"(id varchar, \" + nameInSql + \" varchar)\");\n+            assertUpdate(\"CREATE TABLE \" + tableName + \"(key varchar, \" + nameInSql + \" varchar)\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMjkwNA==", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420002904", "bodyText": "Enable testColumnName in TestCassandraDistributedQueries\n\nConsider squashing this commit with Use Metadata.quote in CassandraCqlUtils -- if this is what fixes Cassandra and makes this test pass now.", "author": "findepi", "createdAt": "2020-05-05T10:15:08Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraDistributedQueries.java", "diffHunk": "@@ -150,16 +150,6 @@ protected TestTable createTableWithDefaultColumns()\n         throw new SkipException(\"Cassandra connector does not support column default values\");\n     }\n \n-    @Override\n-    public void testColumnName(String columnName)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc4fbffe275785e136390f26a66232db6c408d95", "url": "https://github.com/trinodb/trino/commit/cc4fbffe275785e136390f26a66232db6c408d95", "message": "Rename id column to key and shorten name in testColumnName\n\nThe id column name is reserved in Cassandra connector.\nReplace 0startingwithdigit with 0startwithdigit to avoid\ncolumn name length limitation (48) in Cassandra.", "committedDate": "2020-05-05T11:31:53Z", "type": "commit"}, {"oid": "c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "url": "https://github.com/trinodb/trino/commit/c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "message": "Use Metadata.quote in CassandraCqlUtils\n\nTo use escaping logic of Metadata.quote method.\nAdditionally, escape single quotation for table comment\nand enable testColumnName in Cassandra.", "committedDate": "2020-05-05T11:32:30Z", "type": "commit"}, {"oid": "c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "url": "https://github.com/trinodb/trino/commit/c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "message": "Use Metadata.quote in CassandraCqlUtils\n\nTo use escaping logic of Metadata.quote method.\nAdditionally, escape single quotation for table comment\nand enable testColumnName in Cassandra.", "committedDate": "2020-05-05T11:32:30Z", "type": "forcePushed"}]}