{"pr_number": 2935, "pr_title": "Change the way mongo connector infers schema for nested bson docs", "pr_createdAt": "2020-02-25T09:07:45Z", "pr_url": "https://github.com/trinodb/trino/pull/2935", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxNTczNQ==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r395415735", "bodyText": "Please revert the unrelated change.", "author": "ebyhr", "createdAt": "2020-03-20T02:36:20Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -489,7 +489,8 @@ private boolean deleteTableMetadata(SchemaTableName schemaTableName)\n                 builder.add(metadata);\n             }\n             else {\n-                log.debug(\"Unable to guess field type from %s : %s\", value == null ? \"null\" : value.getClass().getName(), value);\n+                log.debug(\"Unable to guess field type from %s : %s\",\n+                        value == null ? \"null\" : value.getClass().getName(), value);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMTA4MQ==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r395421081", "bodyText": "Could you simplify this test method?\n    @Test\n    public void testGuessUnknownTypes()\n    {\n        Document document1 = new Document(\"col\", Document.parse(\"{\\\"key1\\\": \\\"value1\\\", \\\"key2\\\": null}\"));\n        client.getDatabase(\"test\").getCollection(\"tmp_guess_schema1\").insertOne(document1);\n        assertQuery(\"SHOW COLUMNS FROM test.tmp_guess_schema1\", \"SELECT 'col', 'row(key1 varchar)', '', ''\");\n        assertQuery(\"SELECT col.key1 FROM test.tmp_guess_schema1\", \"SELECT 'value1'\");\n\n        Document document2 = new Document(\"col\", new Document(\"key1\", null));\n        client.getDatabase(\"test\").getCollection(\"tmp_guess_schema2\").insertOne(document2);\n        assertQueryReturnsEmptyResult(\"SHOW COLUMNS FROM test.tmp_guess_schema2\");\n    }", "author": "ebyhr", "createdAt": "2020-03-20T03:06:24Z", "path": "presto-mongodb/src/test/java/io/prestosql/plugin/mongodb/TestMongoIntegrationSmokeTest.java", "diffHunk": "@@ -180,6 +184,26 @@ public void testTemporalArrays()\n         assertOneNotNullResult(\"SELECT col[1] FROM tmp_array8\");\n     }\n \n+    @Test\n+    public void testGuessSchema()\n+    {\n+        Document doc1 = new Document(ImmutableMap.of(\n+                \"colA\", new Document(new HashMap<String, Object>() {\n+                    {\n+                        put(\"key1\", \"value1\");\n+                        put(\"key2\", null);\n+                    }\n+                })));\n+        testInferredSchemaType(\"tmp_guess_schema1\", doc1, ImmutableMap.of(\"colA\", \"row(\\\"key1\\\" varchar)\"));\n+        Document doc2 = new Document(ImmutableMap.of(\n+                \"colA\", new Document(new HashMap<String, Object>() {\n+                    {\n+                        put(\"key1\", null);\n+                    }\n+                })));\n+        testInferredSchemaType(\"tmp_guess_schema2\", doc2, ImmutableMap.of());\n+    }\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwMDMyNQ==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r399800325", "bodyText": "It is indeed much simpler :)", "author": "msosnicki", "createdAt": "2020-03-29T13:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMTA4MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTE5MA==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r400255190", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testGuessUnknownTypes()\n          \n          \n            \n                public void testSkipUnknownTypes()", "author": "ebyhr", "createdAt": "2020-03-30T14:52:24Z", "path": "presto-mongodb/src/test/java/io/prestosql/plugin/mongodb/TestMongoIntegrationSmokeTest.java", "diffHunk": "@@ -180,6 +180,19 @@ public void testTemporalArrays()\n         assertOneNotNullResult(\"SELECT col[1] FROM tmp_array8\");\n     }\n \n+    @Test\n+    public void testGuessUnknownTypes()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MDc3Mg==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r408740772", "bodyText": "Fixed", "author": "msosnicki", "createdAt": "2020-04-15T10:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2MjE2Nw==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r400262167", "bodyText": "Logging only here looks a little weird in this method. We could put just else at the last of the  instanceof conditions if needed in the future. Could you revert some change and update like this?\n            for (String key : ((Document) value).keySet()) {\n                Optional<TypeSignature> fieldType = guessFieldType(((Document) value).get(key));\n                if (fieldType.isPresent()) {\n                    parameters.add(TypeSignatureParameter.namedTypeParameter(new NamedTypeSignature(Optional.of(new RowFieldName(key)), fieldType.get())));\n                }\n            }", "author": "ebyhr", "createdAt": "2020-03-30T15:01:18Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -549,14 +549,18 @@ else if (value instanceof Document) {\n             List<TypeSignatureParameter> parameters = new ArrayList<>();\n \n             for (String key : ((Document) value).keySet()) {\n-                Optional<TypeSignature> fieldType = guessFieldType(((Document) value).get(key));\n-                if (!fieldType.isPresent()) {\n-                    return Optional.empty();\n+                Object fieldValue = ((Document) value).get(key);\n+                Optional<TypeSignature> fieldType = guessFieldType(fieldValue);\n+                if (fieldType.isPresent()) {\n+                    parameters.add(TypeSignatureParameter.namedTypeParameter(new NamedTypeSignature(Optional.of(new RowFieldName(key)), fieldType.get())));\n                 }\n-\n-                parameters.add(TypeSignatureParameter.namedTypeParameter(new NamedTypeSignature(Optional.of(new RowFieldName(key)), fieldType.get())));\n+                else {\n+                    log.info(\"Unable to guess document field %s type from class %s with value %s\", key, fieldValue == null ? \"null\" : fieldValue.getClass().getName(), fieldValue);\n+                }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MDcwNw==", "url": "https://github.com/trinodb/trino/pull/2935#discussion_r408740707", "bodyText": "Ok, removed", "author": "msosnicki", "createdAt": "2020-04-15T10:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2MjE2Nw=="}], "type": "inlineReview"}, {"oid": "9bd87eb7bef0f5f8e66074512e21124b4ea56e18", "url": "https://github.com/trinodb/trino/commit/9bd87eb7bef0f5f8e66074512e21124b4ea56e18", "message": "Skip unknown types in nested bson in MongoDB", "committedDate": "2020-04-15T09:22:28Z", "type": "commit"}, {"oid": "9bd87eb7bef0f5f8e66074512e21124b4ea56e18", "url": "https://github.com/trinodb/trino/commit/9bd87eb7bef0f5f8e66074512e21124b4ea56e18", "message": "Skip unknown types in nested bson in MongoDB", "committedDate": "2020-04-15T09:22:28Z", "type": "forcePushed"}]}