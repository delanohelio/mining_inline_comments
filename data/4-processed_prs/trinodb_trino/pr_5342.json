{"pr_number": 5342, "pr_title": "Improve time/timestamp/timestamp with time zone handling in PostgreSQL connector", "pr_createdAt": "2020-09-29T12:03:26Z", "pr_url": "https://github.com/trinodb/trino/pull/5342", "timeline": [{"oid": "48a9f7c7f838b91b567e0a92c783d6a83b882931", "url": "https://github.com/trinodb/trino/commit/48a9f7c7f838b91b567e0a92c783d6a83b882931", "message": "Pass session to setup too", "committedDate": "2020-09-29T12:02:24Z", "type": "commit"}, {"oid": "9ca78db571ba2c78a55989bcaf6679544c820622", "url": "https://github.com/trinodb/trino/commit/9ca78db571ba2c78a55989bcaf6679544c820622", "message": "Use shortcut method", "committedDate": "2020-09-29T12:02:25Z", "type": "commit"}, {"oid": "2e8a0bf6837d0f9ce5d98b892bc45792cdd86c01", "url": "https://github.com/trinodb/trino/commit/2e8a0bf6837d0f9ce5d98b892bc45792cdd86c01", "message": "Add temporal data tests with INSERT in Presto", "committedDate": "2020-09-29T12:02:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY5Mjk2Mg==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496692962", "bodyText": "The commit message should say about timestamp with time zone\nNVM. I cant read", "author": "losipiuk", "createdAt": "2020-09-29T12:55:27Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -463,15 +463,16 @@ public WriteMapping toWriteMapping(ConnectorSession session, Type type)\n             verify(timestampType.getPrecision() > TimestampType.MAX_SHORT_PRECISION);\n             return WriteMapping.objectMapping(format(\"timestamp(%s)\", MAX_SUPPORTED_TIMESTAMP_PRECISION), longTimestampWriteFunction());\n         }\n-        if (type instanceof TimestampWithTimeZoneType && ((TimestampWithTimeZoneType) type).getPrecision() <= MAX_SUPPORTED_TIMESTAMP_PRECISION) {\n-            int precision = ((TimestampWithTimeZoneType) type).getPrecision();\n-            String postgresType = format(\"timestamptz(%d)\", precision);\n-            if (precision <= TimestampWithTimeZoneType.MAX_SHORT_PRECISION) {\n-                return WriteMapping.longMapping(postgresType, shortTimestampWithTimeZoneWriteFunction());\n-            }\n-            else {\n-                return WriteMapping.objectMapping(postgresType, longTimestampWithTimeZoneWriteFunction());\n+        if (type instanceof TimestampWithTimeZoneType) {\n+            TimestampWithTimeZoneType timestampWithTimeZoneType = (TimestampWithTimeZoneType) type;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczNjY4MA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496736680", "bodyText": "Use a constant?", "author": "aalbu", "createdAt": "2020-09-29T13:54:16Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -499,15 +515,68 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    private static ColumnMapping timeColumnMapping(int precision)\n+    {\n+        verify(precision <= 6);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzMzU5NQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496833595", "bodyText": "There is no constant to be used here. The verify guards certain assumptions within the method body, so using eg MAX_SUPPORTED_TIMESTAMP_PRECISION would not be correct.\nWill add\n// PostgreSQL limit but also assumption within this method", "author": "findepi", "createdAt": "2020-09-29T15:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczNjY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MDk3OQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496740979", "bodyText": "Why not nanosOfDay = 0 (since in Presto 24:00:00 == 00:00:00)?", "author": "aalbu", "createdAt": "2020-09-29T13:59:33Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -499,15 +515,68 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    private static ColumnMapping timeColumnMapping(int precision)\n+    {\n+        verify(precision <= 6);\n+        return ColumnMapping.longMapping(\n+                createTimeType(precision),\n+                (resultSet, columnIndex) -> {\n+                    LocalTime time = resultSet.getObject(columnIndex, LocalTime.class);\n+                    long nanosOfDay = time.toNanoOfDay();\n+                    if (nanosOfDay == NANOSECONDS_PER_DAY - 1) {\n+                        // PostgreSQL's 24:00:00 is returned as 23:59:59.999999999, regardless of column precision\n+                        nanosOfDay = NANOSECONDS_PER_DAY - LongMath.pow(10, 9 - precision);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzNTI5Ng==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496835296", "bodyText": "I am preserving existing behavior here (as documented by Add explicit test for PostgreSQL TIME 24 commit which goes before the actual change), which, i think was reviewed by @martint when he did time(p). I am open to suggestions or a change. Maybe an issue?", "author": "findepi", "createdAt": "2020-09-29T15:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MDk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyOTgzNA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497829834", "bodyText": "No, I think what you did is safer.", "author": "aalbu", "createdAt": "2020-09-30T22:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MDk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0NDU0Mw==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496744543", "bodyText": "Constant?", "author": "aalbu", "createdAt": "2020-09-29T14:04:01Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -499,15 +515,68 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    private static ColumnMapping timeColumnMapping(int precision)\n+    {\n+        verify(precision <= 6);\n+        return ColumnMapping.longMapping(\n+                createTimeType(precision),\n+                (resultSet, columnIndex) -> {\n+                    LocalTime time = resultSet.getObject(columnIndex, LocalTime.class);\n+                    long nanosOfDay = time.toNanoOfDay();\n+                    if (nanosOfDay == NANOSECONDS_PER_DAY - 1) {\n+                        // PostgreSQL's 24:00:00 is returned as 23:59:59.999999999, regardless of column precision\n+                        nanosOfDay = NANOSECONDS_PER_DAY - LongMath.pow(10, 9 - precision);\n+                    }\n+\n+                    long picosOfDay = nanosOfDay * PICOSECONDS_PER_NANOSECOND;\n+                    return round(picosOfDay, 12 - precision);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzNTg2OQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r496835869", "bodyText": "\"12\" refers to \"picos\" (a variable name on the same line), so i do not think a constant would actually improve the code here", "author": "findepi", "createdAt": "2020-09-29T15:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0NDU0Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0NzQwMA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497147400", "bodyText": "I'm confused by this. This ensures that precision is no larger than the max supported precision, but the else branch proceeds to handle timestamps with larger precision than that. Are the supported or not?", "author": "martint", "createdAt": "2020-09-29T23:42:13Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -444,9 +446,14 @@ public WriteMapping toWriteMapping(ConnectorSession session, Type type)\n         if (TIME.equals(type)) {\n             return WriteMapping.longMapping(\"time\", timeWriteFunction());\n         }\n-        if (type instanceof TimestampType && ((TimestampType) type).getPrecision() <= MAX_SUPPORTED_TIMESTAMP_PRECISION) {\n+        if (type instanceof TimestampType) {\n             TimestampType timestampType = (TimestampType) type;\n-            return WriteMapping.longMapping(format(\"timestamp(%s)\", timestampType.getPrecision()), timestampWriteFunction(timestampType));\n+            if (timestampType.getPrecision() <= MAX_SUPPORTED_TIMESTAMP_PRECISION) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1NDkyNQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497754925", "bodyText": "I will rename the const MAX_SUPPORTED_TIMESTAMP_PRECISION to POSTGRESQL_MAX_SUPPORTED_TIMESTAMP_PRECISION", "author": "findepi", "createdAt": "2020-09-30T19:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0NzQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE1Mzk5Mg==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497153992", "bodyText": "with timestamp precision higher than expressible with {@code LocalDateTime}.\n\nInaccurate comment? Most of the tests below use precisions that fit within LocalDateTime precision.", "author": "martint", "createdAt": "2020-09-29T23:51:31Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1052,6 +1058,59 @@ public void testTimestamp(boolean insertWithPresto, ZoneId sessionZone)\n         }\n     }\n \n+    /**\n+     * Additional test supplementing {@link #testTimestamp} with timestamp precision higher than expressible with {@code LocalDateTime}.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1NzU4MA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497757580", "bodyText": "reworded", "author": "findepi", "createdAt": "2020-09-30T19:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE1Mzk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2MjcyMg==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497162722", "bodyText": "Is this the value returned by PostgresSQL's JDBC driver or are we somehow changing it on the connector side?", "author": "martint", "createdAt": "2020-09-30T00:04:26Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1010,6 +1011,51 @@ public void testTime(boolean insertWithPresto, ZoneId sessionZone)\n         }\n     }\n \n+    @Test\n+    public void testTime24()\n+    {\n+        try (TestTable testTable = new TestTable(\n+                new JdbcSqlExecutor(postgreSqlServer.getJdbcUrl()),\n+                \"tpch.test_time_24\",\n+                \"(a time(0), b time(3), c time(6))\",\n+                List.of(\n+                        // \"zero\" row\n+                        \"TIME '00:00:00', TIME '00:00:00.000', TIME '00:00:00.000000'\",\n+                        // \"max\" row\n+                        \"TIME '23:59:59', TIME '23:59:59.999', TIME '23:59:59.999999'\",\n+                        // \"24\" row\n+                        \"TIME '24:00:00', TIME '24:00:00.000', TIME '24:00:00.000000'\"))) {\n+            // select\n+            assertThat(query(\"SELECT a, b, c FROM \" + testTable.getName()))\n+                    .matches(\"VALUES \" +\n+                            \"(TIME '00:00:00.000', TIME '00:00:00.000', TIME '00:00:00.000'), \" +\n+                            \"(TIME '23:59:59.000', TIME '23:59:59.999', TIME '23:59:59.999'), \" +\n+                            \"(TIME '23:59:59.999', TIME '23:59:59.999', TIME '23:59:59.999')\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2MzA0MA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497763040", "bodyText": "This is what PostgreSQL JDBC returns upon rs.getObject(column) or rs.getObject(column, LocalTime.class) call.\nFor setup\ntest=# create table test_time_24(a time(0), b time(3), c time(6));\nCREATE TABLE\ntest=# insert into test_time_24 values (TIME '00:00:00', TIME '00:00:00.000', TIME '00:00:00.000000');\nINSERT 0 1\ntest=# insert into test_time_24 values (TIME '23:59:59', TIME '23:59:59.999', TIME '23:59:59.999999');\nINSERT 0 1\ntest=# insert into test_time_24 values (TIME '24:00:00', TIME '24:00:00.000', TIME '24:00:00.000000');\nINSERT 0 1\ntest=# select * from test_time_24;\n    a     |      b       |        c\n----------+--------------+-----------------\n 00:00:00 | 00:00:00     | 00:00:00\n 23:59:59 | 23:59:59.999 | 23:59:59.999999\n 24:00:00 | 24:00:00     | 24:00:00\n(3 rows)\n\n-----------------\nrs.getObject(1) = 00:00:00\nrs.getString(1) = 00:00:00\nrs.getObject(1, LocalTime.class) = 00:00\nrs.getObject(2) = 00:00:00\nrs.getString(2) = 00:00:00\nrs.getObject(2, LocalTime.class) = 00:00\nrs.getObject(3) = 00:00:00\nrs.getString(3) = 00:00:00\nrs.getObject(3, LocalTime.class) = 00:00\n-----------------\nrs.getObject(1) = 23:59:59\nrs.getString(1) = 23:59:59\nrs.getObject(1, LocalTime.class) = 23:59:59\nrs.getObject(2) = 23:59:59\nrs.getString(2) = 23:59:59.999\nrs.getObject(2, LocalTime.class) = 23:59:59.999\nrs.getObject(3) = 23:59:59\nrs.getString(3) = 23:59:59.999999\nrs.getObject(3, LocalTime.class) = 23:59:59.999999\n-----------------\nrs.getObject(1) = 00:00:00\nrs.getString(1) = 24:00:00\nrs.getObject(1, LocalTime.class) = 23:59:59.999999999\nrs.getObject(2) = 00:00:00\nrs.getString(2) = 24:00:00\nrs.getObject(2, LocalTime.class) = 23:59:59.999999999\nrs.getObject(3) = 00:00:00\nrs.getString(3) = 24:00:00\nrs.getObject(3, LocalTime.class) = 23:59:59.999999999\n\nThus, as you see, we can tell apart 24:00:00 case using getString.\nHowever, my PR does not substantially change treatment of 24:00:00 values, so\nif you want to change treatment of those values, I'd suggest a followup issue.", "author": "findepi", "createdAt": "2020-09-30T19:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2MjcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NzgzOA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497767838", "bodyText": "No, I was just curious about the behavior. It seems very broken on PostgreSQL's part ;)", "author": "martint", "createdAt": "2020-09-30T20:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2MjcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2Mzc5OQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497163799", "bodyText": "checkArgument?", "author": "martint", "createdAt": "2020-09-30T00:05:54Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/StandardColumnMappings.java", "diffHunk": "@@ -350,36 +351,31 @@ private static Time toSqlTime(LocalTime localTime)\n         return new Time(Time.valueOf(localTime).getTime() + NANOSECONDS.toMillis(localTime.getNano()));\n     }\n \n-    public static ColumnMapping timeColumnMapping()\n+    public static ColumnMapping timeColumnMapping(TimeType timeType)\n     {\n+        verify(timeType.getPrecision() <= 9, \"Unsupported type precision: %s\", timeType);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2MzQwNA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497763404", "bodyText": "Fixed", "author": "findepi", "createdAt": "2020-09-30T19:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2Mzc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MjY2Nw==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497172667", "bodyText": "For later... we should fix this test to not use testTimestampDataProvider. Timezones don't play a role in TIME type, so we don't need to do any checks for gaps or different timezones.", "author": "martint", "createdAt": "2020-09-30T00:18:56Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -974,28 +974,35 @@ public void testEnum()\n         }\n     }\n \n+    /**\n+     * @see #testTimeCoercion\n+     */\n     @Test(dataProvider = \"testTimestampDataProvider\")\n     public void testTime(boolean insertWithPresto, ZoneId sessionZone)\n     {\n         LocalTime timeGapInJvmZone = LocalTime.of(0, 12, 34, 567_000_000);\n         checkIsGap(jvmZone, timeGapInJvmZone.atDate(EPOCH_DAY));\n \n         DataTypeTest tests = DataTypeTest.create()\n-                .addRoundTrip(timeDataType(), LocalTime.of(1, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(2, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(2, 12, 34, 1_000_000))\n-                .addRoundTrip(timeDataType(), LocalTime.of(3, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(4, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(5, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(6, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(9, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(10, 12, 34, 0))\n-                .addRoundTrip(timeDataType(), LocalTime.of(15, 12, 34, 567_000_000))\n-                .addRoundTrip(timeDataType(), LocalTime.of(23, 59, 59, 999_000_000));\n-\n-        // epoch is also a gap in JVM zone\n-        tests.addRoundTrip(timeDataType(), epoch.toLocalTime());\n-        tests.addRoundTrip(timeDataType(), timeGapInJvmZone);\n+                .addRoundTrip(timeDataType(0), LocalTime.of(1, 12, 34, 0))\n+                .addRoundTrip(timeDataType(1), LocalTime.of(2, 12, 34, 100_000_000))\n+                .addRoundTrip(timeDataType(2), LocalTime.of(2, 12, 34, 10_000_000))\n+                .addRoundTrip(timeDataType(3), LocalTime.of(2, 12, 34, 1_000_000))\n+                .addRoundTrip(timeDataType(3), LocalTime.of(3, 12, 34, 0))\n+                .addRoundTrip(timeDataType(4), LocalTime.of(4, 12, 34, 0))\n+                .addRoundTrip(timeDataType(5), LocalTime.of(5, 12, 34, 0))\n+                .addRoundTrip(timeDataType(5), LocalTime.of(6, 12, 34, 0))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(9, 12, 34, 0))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(10, 12, 34, 0))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(15, 12, 34, 567_000_000))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(23, 59, 59, 0))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(23, 59, 59, 999_000_000))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(23, 59, 59, 999_900_000))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(23, 59, 59, 999_990_000))\n+                .addRoundTrip(timeDataType(6), LocalTime.of(23, 59, 59, 999_999_000))\n+                // epoch is also a gap in JVM zone", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NDE4Mg==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497764182", "bodyText": "Yes, the do not play anymore, but i think testing with more than one session zone is still valuable from blackbox testing perspective.\n(This is why testDate loops over time zones, even though date handling never dependent on a zone)\nJust my point of view.", "author": "findepi", "createdAt": "2020-09-30T19:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MjY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2OTY3Mw==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497769673", "bodyText": "That makes the tests misleading. Just because TIME used to be sensitive to timezones, it doesn't mean that we should continue to treat them that way, just like we don't think about or test other types such as decimal, bigint, etc, that way.", "author": "martint", "createdAt": "2020-09-30T20:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MjY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4Mzc0NA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497783744", "bodyText": "You could same way argue that since we're using java.time (let's assume we do uniformly) we do not need to set non-UTC as test JVM zone -- the result does not depend on the zone. Yet, it was important in the past to test with non-UTC zone and thus it remains important even after the code is fixed, as a regression testing measures.\nSimilarly, testing date/time with session zones is reasonable from regression testing perspective.\nTesting bigint or decimal cannot be argued the same way.", "author": "findepi", "createdAt": "2020-09-30T20:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MjY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4NjA2MA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497786060", "bodyText": "If we had implemented TIMESTAMP and TIME right from the start, we would've never added these tests, just saying. Of course it makes sense for TIMESTAMP W/ TZ and TIME W/ TZ, but those are different types with different semantics.", "author": "martint", "createdAt": "2020-09-30T20:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MjY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NTQ1MA==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497175450", "bodyText": "\"instead of\". Also, are PgObject and PGobject different things? I couldn't find any class named PgObject", "author": "martint", "createdAt": "2020-09-30T00:22:56Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1011,6 +1018,86 @@ public void testTime(boolean insertWithPresto, ZoneId sessionZone)\n         }\n     }\n \n+    /**\n+     * Additional test supplementing {@link #testTime} with timestamp precision higher than expressible with {@code LocalTime}.\n+     *\n+     * @see #testTime\n+     */\n+    @Test\n+    public void testTimeCoercion()\n+            throws SQLException\n+    {\n+        testCreateTableAsAndInsertConsistency(\"TIME '00:00:00'\", \"TIME '00:00:00'\");\n+        testCreateTableAsAndInsertConsistency(\"TIME '00:00:00.000000'\", \"TIME '00:00:00.000000'\");\n+        testCreateTableAsAndInsertConsistency(\"TIME '00:00:00.123456'\", \"TIME '00:00:00.123456'\");\n+        testCreateTableAsAndInsertConsistency(\"TIME '12:34:56'\", \"TIME '12:34:56'\");\n+        testCreateTableAsAndInsertConsistency(\"TIME '12:34:56.123456'\", \"TIME '12:34:56.123456'\");\n+\n+        // Cases which require using PgObject instead if PGobject with PostgreSQL JDBC driver", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NDU3Ng==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497764576", "bodyText": "fixed", "author": "findepi", "createdAt": "2020-09-30T19:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NTQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NzE4MQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497177181", "bodyText": "This seems unrelated to supporting time(p) in postgresql", "author": "martint", "createdAt": "2020-09-30T00:25:26Z", "path": "presto-testing/src/test/java/io/prestosql/testing/datatype/TestDataType.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testing.datatype;\n+\n+import org.testng.annotations.Test;\n+\n+import java.time.LocalTime;\n+\n+import static io.prestosql.testing.datatype.DataType.timeDataType;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestDataType\n+{\n+    @Test\n+    public void testTimeDataType()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2NjMyOQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497766329", "bodyText": "it was valuable to me, as i initially forgot to add SSSSSS to the pattern. I can throw it away if you want me, but otherwise I would keep it.\n(note that \"time(p) in postgresql\" commit changes DataType.timeDataType... that can be seen frivolous, but postgres's tests were the only user of that method)", "author": "findepi", "createdAt": "2020-09-30T20:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc3MDA1Mg==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497770052", "bodyText": "Fine to keep, but move to a separate commit.", "author": "martint", "createdAt": "2020-09-30T20:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4NDUyMQ==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497784521", "bodyText": "It is in the commit which changes the impl of the feature under test. I cannot move to separate, that would not be logical separation.\nSince this seems like a tiny detail, i will choose to keep it where it is.", "author": "findepi", "createdAt": "2020-09-30T20:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4NzM3Mw==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497787373", "bodyText": "Ah, I missed that the timeDataType method was being changed in this same commit.", "author": "martint", "createdAt": "2020-09-30T20:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3ODcyNw==", "url": "https://github.com/trinodb/trino/pull/5342#discussion_r497178727", "bodyText": "Same comment as elsewhere regarding accuracy of this text.", "author": "martint", "createdAt": "2020-09-30T00:29:45Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1368,13 +1371,56 @@ public void testTimestampWithTimeZone(boolean insertWithPresto)\n         }\n     }\n \n+    /**\n+     * Additional test supplementing {@link #testTimestampWithTimeZone} with timestamp with time zone precision higher than expressible with {@code LocalDateTime}.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ff8b7034b08f2a5934816de45fa7e6cb7a3d5be", "url": "https://github.com/trinodb/trino/commit/3ff8b7034b08f2a5934816de45fa7e6cb7a3d5be", "message": "Support CTAS with timestamp(>6) in PostgreSQL", "committedDate": "2020-09-30T20:00:58Z", "type": "commit"}, {"oid": "62b78de04bd72b416bfe1dcf5f93bba81c89c996", "url": "https://github.com/trinodb/trino/commit/62b78de04bd72b416bfe1dcf5f93bba81c89c996", "message": "Add explicit test for PostgreSQL TIME 24", "committedDate": "2020-09-30T20:00:58Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "c0b20516a96cabe11903725136a6a6b54e26b67b", "url": "https://github.com/trinodb/trino/commit/c0b20516a96cabe11903725136a6a6b54e26b67b", "message": "Support time(p) in PostgreSQL", "committedDate": "2020-09-30T20:22:30Z", "type": "commit"}, {"oid": "ef7cccf8fe85fe5e900a28a1d2b6f876169e7f84", "url": "https://github.com/trinodb/trino/commit/ef7cccf8fe85fe5e900a28a1d2b6f876169e7f84", "message": "Fix rounding in long timestamptz to long timestamptz cast", "committedDate": "2020-09-30T20:22:30Z", "type": "commit"}, {"oid": "345ccb27f631561aee60d1139219a7ce1d4a1182", "url": "https://github.com/trinodb/trino/commit/345ccb27f631561aee60d1139219a7ce1d4a1182", "message": "Support CTAS with timestamp(>6) with time zone in PostgreSQL", "committedDate": "2020-09-30T20:22:31Z", "type": "commit"}, {"oid": "345ccb27f631561aee60d1139219a7ce1d4a1182", "url": "https://github.com/trinodb/trino/commit/345ccb27f631561aee60d1139219a7ce1d4a1182", "message": "Support CTAS with timestamp(>6) with time zone in PostgreSQL", "committedDate": "2020-09-30T20:22:31Z", "type": "forcePushed"}]}