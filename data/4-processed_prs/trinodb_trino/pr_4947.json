{"pr_number": 4947, "pr_title": "Allow retrying opening connection in Oracle", "pr_createdAt": "2020-08-24T10:18:06Z", "pr_url": "https://github.com/trinodb/trino/pull/4947", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NjA1OQ==", "url": "https://github.com/trinodb/trino/pull/4947#discussion_r475776059", "bodyText": "10 is overkill. Make it 3.", "author": "losipiuk", "createdAt": "2020-08-24T17:22:47Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/RetryingConnectionFactory.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc;\n+\n+import com.google.common.base.Throwables;\n+import io.prestosql.spi.PrestoException;\n+import net.jodah.failsafe.Failsafe;\n+import net.jodah.failsafe.FailsafeException;\n+import net.jodah.failsafe.RetryPolicy;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.SQLRecoverableException;\n+\n+import static java.time.temporal.ChronoUnit.MILLIS;\n+import static java.time.temporal.ChronoUnit.SECONDS;\n+import static java.util.Objects.requireNonNull;\n+\n+public class RetryingConnectionFactory\n+        implements ConnectionFactory\n+{\n+    private static final RetryPolicy<Object> RETRY_POLICY = new RetryPolicy<>()\n+            .withMaxDuration(java.time.Duration.of(30, SECONDS))\n+            .withMaxAttempts(10)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MTUxNQ==", "url": "https://github.com/trinodb/trino/pull/4947#discussion_r475781515", "bodyText": "I wanted to last it longer. Now it will retry at:\n50, 150, 250, 450, 850, 1650, 3250, 8250, 13250, 18250 (notice that there is not included time that is required do the connection open, typically it is like from 10ms to 100ms).\nFor example if there is some kind of outage waiting 18 seconds could help, while 250 millis might be too short. Anyway, it is heuristic. That way I guess is safer but without causing big user experience impact.\nWDYT?", "author": "kokosing", "createdAt": "2020-08-24T17:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NjA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4NTU4Mw==", "url": "https://github.com/trinodb/trino/pull/4947#discussion_r475785583", "bodyText": "It probably do not matter much. I would prefer to have less of those. First one immediately after failure. And next one after >=1s. If that is not easily achievable you can leave it as is, yet I am a bit afraid that having too many of those, too frequently can overwhelm database server.", "author": "losipiuk", "createdAt": "2020-08-24T17:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NjA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3MDIzMw==", "url": "https://github.com/trinodb/trino/pull/4947#discussion_r476370233", "bodyText": "Ok. I made it less frequent and there are less calls. From 10 to 5, but still it has the same time range up to 30 seconds.", "author": "kokosing", "createdAt": "2020-08-25T11:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NjA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTk5OQ==", "url": "https://github.com/trinodb/trino/pull/4947#discussion_r476375999", "bodyText": "thx", "author": "losipiuk", "createdAt": "2020-08-25T11:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NjA1OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "bee1144c462b9e75619e4a90c3cfe2c59cb74c41", "url": "https://github.com/trinodb/trino/commit/bee1144c462b9e75619e4a90c3cfe2c59cb74c41", "message": "Use DriverConnectionFactory in TestingOracleServer", "committedDate": "2020-08-25T18:46:39Z", "type": "commit"}, {"oid": "d8ea367f14012aaa09436ba436641dedf706cb26", "url": "https://github.com/trinodb/trino/commit/d8ea367f14012aaa09436ba436641dedf706cb26", "message": "Allow retrying opening connection in Oracle", "committedDate": "2020-08-25T18:46:39Z", "type": "commit"}, {"oid": "d8ea367f14012aaa09436ba436641dedf706cb26", "url": "https://github.com/trinodb/trino/commit/d8ea367f14012aaa09436ba436641dedf706cb26", "message": "Allow retrying opening connection in Oracle", "committedDate": "2020-08-25T18:46:39Z", "type": "forcePushed"}]}