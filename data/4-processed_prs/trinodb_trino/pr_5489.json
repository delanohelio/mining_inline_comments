{"pr_number": 5489, "pr_title": "Express Kerberos dependency explicitly", "pr_createdAt": "2020-10-09T09:14:40Z", "pr_url": "https://github.com/trinodb/trino/pull/5489", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMzk2OA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r502303968", "bodyText": "Kerberos -> KerberizedHadoop\n?", "author": "findepi", "createdAt": "2020-10-09T09:27:00Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/Kerberos.java", "diffHunk": "@@ -36,22 +36,26 @@\n \n     private final String hadoopBaseImage;\n     private final String hadoopImagesVersion;\n+    private final Hadoop hadoop;\n \n     @Inject\n     public Kerberos(\n             DockerFiles dockerFiles,\n             PortBinder portBinder,\n+            Hadoop hadoop,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwNzYxNg==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r502307616", "bodyText": "The problem IMO is that Kerberos is not some kind of addition to Hadoop. It is a standalone being.\nWe have 3 entities here:\n\nHadoop\nKerberos\nHadoop-Kerberos relationship\n\nKerberos can be used with other systems. If we add ranger to that we have: Hadoop, Kerberos, ranger and two relationships - ranger-kerberos and hadoop-kerberos.\nExpressing this in simple object composition is not trivial.", "author": "skrzypo987", "createdAt": "2020-10-09T09:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyODI0OQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r502328249", "bodyText": "In general yes, but in particular no.\nStandalone Hadoop would use standalone thing like https://github.com/prestosql/docker-images/tree/master/prestodev/kerberos which is not the case here. Here we are modifying Hadoop to make it kerberized, so name KerberizedHadoop is great here as there is no standalone Kerberos here yet. This even more stresses the fact that injecting Hadoop and Kerberos previously was bad.\nI see your point with entities here, and I agree with you. Best option if we would have containers A and B and the C that affects A and B to be expressed a collection  of AwithC (that depends on A and C), BwithC (that depends on B and C). Do we agree here?", "author": "kokosing", "createdAt": "2020-10-09T10:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyOTAxNg==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r502329016", "bodyText": "C was representing kerberos here. But please notice that current Kerberos does not represent standalone component, it is just a modification.", "author": "kokosing", "createdAt": "2020-10-09T10:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMzk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMzU4MA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r502333580", "bodyText": "Let's start from the beginning. This is depicting the dependency between these 2 as they are right now. We could model them in a more granular manner, but right not we should start from making dependencies like this visible and naming the abstractions properly (like KerberizedHadoop), so that they start to represent what they actually do.", "author": "s2lomon", "createdAt": "2020-10-09T10:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMzk2OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NzY0MQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518647641", "bodyText": "I don't like this. Nothing prevents the extenders to be parametrized. We pass instances everywhere. And here we are filtering based on class.", "author": "losipiuk", "createdAt": "2020-11-06T10:06:11Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentProvider.java", "diffHunk": "@@ -45,14 +46,19 @@ protected EnvironmentProvider(List<EnvironmentExtender> bases)\n                 .add(environmentConfig)\n                 .build();\n \n-        String extendersNames = extenders.stream()\n-                .map(Object::getClass)\n-                .map(Class::getSimpleName)\n-                .collect(joining(\", \"));\n-\n-        log.info(\"Building environment %s with extenders: %s\", builder.getEnvironmentName(), extendersNames);\n-\n-        extenders.forEach(extender -> extender.extendEnvironment(builder));\n+        Set<Class<? extends EnvironmentExtender>> seen = new HashSet<>();\n+        extenders.forEach(extender -> extend(extender, builder, seen));\n         return builder;\n     }\n+\n+    private void extend(EnvironmentExtender extender, Environment.Builder builder, Set<Class<? extends EnvironmentExtender>> seen)\n+    {\n+        extender.getDependencies()\n+                .forEach(dependencyExtender -> extend(dependencyExtender, builder, seen));\n+        Class<? extends EnvironmentExtender> extenderClass = extender.getClass();\n+        if (seen.add(extenderClass)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1NDg1MQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518754851", "bodyText": "\ud83d\udc4d\nI will use identity set instead and use regular objects.", "author": "kokosing", "createdAt": "2020-11-06T13:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NzY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQzOA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518649438", "bodyText": "I am not convinced we need this class method at all.\nWhy not just call hadoop.extend() in extendEnvironment.\n(possibly it was discussed alrady)...", "author": "losipiuk", "createdAt": "2020-11-06T10:09:30Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/HadoopKerberos.java", "diffHunk": "@@ -69,4 +76,10 @@ public void extendEnvironment(Environment.Builder builder)\n             container.withCopyFileToContainer(forHostPath(configDir.getPath(\"tempto-configuration.yaml\")), CONTAINER_TEMPTO_PROFILE_CONFIG);\n         });\n     }\n+\n+    @Override\n+    public List<EnvironmentExtender> getDependencies()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1NTc3NA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518755774", "bodyText": "I don't understand.\n\nI am not convinced we need this class at all.\n\nDo you mean we don't need HadoopKerberos?\nCan you please elaborate?", "author": "kokosing", "createdAt": "2020-11-06T13:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1NjU2MQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518756561", "bodyText": "I meant \"method\" not \"class\". sorry.", "author": "losipiuk", "createdAt": "2020-11-06T13:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk1NDMzOA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r518954338", "bodyText": "Why not just call hadoop.extend() in extendEnvironment.\n\nThat was the first approach. Notice that there might be other extendEnvironment that could also depend on hadoop, in such case haddop would be called multiple times.", "author": "kokosing", "createdAt": "2020-11-06T19:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE1ODA2Nw==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r519158067", "bodyText": "Why not just call hadoop.extend() in extendEnvironment.\n\nThat was the first approach. Notice that there might be other extendEnvironment that could also depend on hadoop, in such case haddop would be called multiple times.\n\nYeah - I was afraid that is the case.", "author": "losipiuk", "createdAt": "2020-11-07T09:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTQzOA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4OTYyMg==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r519689622", "bodyText": "According to\nhttps://github.com/prestosql/presto/blob/0816357bb0a6fd6681f8942b94fbc79d9f2c21a8/presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentModule.java#L52-L60\nEnvironmentExtenders are not bound as singletons. So this probably would not work. Can we somehow ensure (via test for example) proper validation for that?", "author": "losipiuk", "createdAt": "2020-11-09T10:07:16Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentProvider.java", "diffHunk": "@@ -45,14 +47,18 @@ protected EnvironmentProvider(List<EnvironmentExtender> bases)\n                 .add(environmentConfig)\n                 .build();\n \n-        String extendersNames = extenders.stream()\n-                .map(Object::getClass)\n-                .map(Class::getSimpleName)\n-                .collect(joining(\", \"));\n-\n-        log.info(\"Building environment %s with extenders: %s\", builder.getEnvironmentName(), extendersNames);\n-\n-        extenders.forEach(extender -> extender.extendEnvironment(builder));\n+        Set<EnvironmentExtender> seen = newSetFromMap(new IdentityHashMap<>());\n+        extenders.forEach(extender -> extend(extender, builder, seen));\n         return builder;\n     }\n+\n+    private void extend(EnvironmentExtender extender, Environment.Builder builder, Set<EnvironmentExtender> seen)\n+    {\n+        extender.getDependencies()\n+                .forEach(dependencyExtender -> extend(dependencyExtender, builder, seen));\n+        if (seen.add(extender)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNzE0MQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r520127141", "bodyText": "+1", "author": "kokosing", "createdAt": "2020-11-09T21:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4OTYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQzNDMxMA==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r520434310", "bodyText": "So no validataion ? :/", "author": "losipiuk", "createdAt": "2020-11-10T09:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4OTYyMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5NTk0Mw==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r520495943", "bodyText": "The sense of previous code was to log message lazy (when the environment is built, not when compose is called)", "author": "wendigo", "createdAt": "2020-11-10T11:36:19Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentProvider.java", "diffHunk": "@@ -46,20 +45,14 @@ protected EnvironmentProvider(List<EnvironmentExtender> bases)\n                 .add(environmentConfig)\n                 .build();\n \n-        compose(extenders).extendEnvironment(builder);\n-        return builder;\n-    }\n-\n-    static EnvironmentExtender compose(Iterable<EnvironmentExtender> extenders)\n-    {\n-        String extendersNames = StreamSupport.stream(extenders.spliterator(), false)\n+        String extendersNames = extenders.stream()\n                 .map(Object::getClass)\n                 .map(Class::getSimpleName)\n                 .collect(joining(\", \"));\n \n-        return builder -> {\n-            log.info(\"Building environment %s with extenders: %s\", builder.getEnvironmentName(), extendersNames);\n-            extenders.forEach(extender -> extender.extendEnvironment(builder));\n-        };\n+        log.info(\"Building environment %s with extenders: %s\", builder.getEnvironmentName(), extendersNames);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5ODcwOQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r520498709", "bodyText": "Can we document in which order extenders are applied to Environment.Builder ?\ndependencies, this or this, dependencies ?", "author": "wendigo", "createdAt": "2020-11-10T11:41:21Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/EnvironmentExtender.java", "diffHunk": "@@ -13,9 +13,17 @@\n  */\n package io.prestosql.tests.product.launcher.env.common;\n \n+import com.google.common.collect.ImmutableList;\n import io.prestosql.tests.product.launcher.env.Environment;\n \n+import java.util.List;\n+\n public interface EnvironmentExtender\n {\n     void extendEnvironment(Environment.Builder builder);\n+\n+    default List<EnvironmentExtender> getDependencies()\n+    {\n+        return ImmutableList.of();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUwODExNQ==", "url": "https://github.com/trinodb/trino/pull/5489#discussion_r520508115", "bodyText": "as javadoc?", "author": "kokosing", "createdAt": "2020-11-10T11:59:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5ODcwOQ=="}], "type": "inlineReview"}, {"oid": "55c2698924020f6752badde2492154082336af2c", "url": "https://github.com/trinodb/trino/commit/55c2698924020f6752badde2492154082336af2c", "message": "Rename Kerberos to HadoopKerberos\n\nAlso rename KerberosKms to HadoopKerberosKms.", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "7e8c266a2b598e2405e17e1df2e6136cfe34fc4e", "url": "https://github.com/trinodb/trino/commit/7e8c266a2b598e2405e17e1df2e6136cfe34fc4e", "message": "Move tempto configuration files to environment directories", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "490ccfe3a30ed40e21153edfa4032d502affb129", "url": "https://github.com/trinodb/trino/commit/490ccfe3a30ed40e21153edfa4032d502affb129", "message": "Inline compose method", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "9f225cb58b87727083675fc9419854f9a7acf8ea", "url": "https://github.com/trinodb/trino/commit/9f225cb58b87727083675fc9419854f9a7acf8ea", "message": "Bind presto-product-tests-launcher beans in SINGLETON scope", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "9c383cae9a797aa51f8ab4ba3835e858d5561b68", "url": "https://github.com/trinodb/trino/commit/9c383cae9a797aa51f8ab4ba3835e858d5561b68", "message": "Allow EnvironmentExtender to define its dependencies", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "fb29ab5f1a0b690d1ff43d63bc0304c8b0bb5aa1", "url": "https://github.com/trinodb/trino/commit/fb29ab5f1a0b690d1ff43d63bc0304c8b0bb5aa1", "message": "Express Kerberos dependency explicitly", "committedDate": "2020-11-10T13:30:25Z", "type": "commit"}, {"oid": "fb29ab5f1a0b690d1ff43d63bc0304c8b0bb5aa1", "url": "https://github.com/trinodb/trino/commit/fb29ab5f1a0b690d1ff43d63bc0304c8b0bb5aa1", "message": "Express Kerberos dependency explicitly", "committedDate": "2020-11-10T13:30:25Z", "type": "forcePushed"}]}