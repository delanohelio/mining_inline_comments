{"pr_number": 5972, "pr_title": "Expand BenchmarkBlockSerde", "pr_createdAt": "2020-11-16T15:11:39Z", "pr_url": "https://github.com/trinodb/trino/pull/5972", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MTI4NA==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r524351284", "bodyText": "Not introduced in this PR, but this should use the regular PagesSerdeFactory instead of TestingPagesSerdeFactory since the testing version produces a PagesSerde that includes extra synchronization that might be material in the benchmark results.", "author": "pettyjamesm", "createdAt": "2020-11-16T15:26:53Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -187,30 +292,20 @@ public void setup(Iterator<Page> pagesIterator)\n             dataSource = sliceOutput.slice();\n         }\n \n-        public void setup(Type type, Iterator<?> values)\n+        public <T> void setup(Type type, Iterator<T> values, BiConsumer<BlockBuilder, T> writer)\n                 throws Exception\n         {\n             pagesSerde = new TestingPagesSerdeFactory(new TestingBlockEncodingSerde(), false).createPagesSerde();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY4MjgxNg==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r524682816", "bodyText": "Curious, do you happen to know why the testing one is more synchronized?", "author": "findepi", "createdAt": "2020-11-16T22:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5OTc5MA==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r524699790", "bodyText": "I assume that it\u2019s because PagesSerDe is not thread safe and adding synchronized to the methods was deemed easier to use in multi threaded  tests.", "author": "pettyjamesm", "createdAt": "2020-11-16T22:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNDMzNw==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r525004337", "bodyText": "@pettyjamesm we don't use synchronized factory here. Synchronized factory is only used when io.prestosql.execution.buffer.TestingPagesSerdeFactory#testingPagesSerde is used. It's not used here", "author": "sopel39", "createdAt": "2020-11-17T09:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MTI4NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NzE1NQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r524967155", "bodyText": "Commit message is ambiguous. Can you please be more specific?", "author": "kokosing", "createdAt": "2020-11-17T08:27:53Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -27,7 +27,6 @@\n import io.prestosql.spi.type.Decimals;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyODgzOQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r526728839", "bodyText": "Is it better now?", "author": "skrzypo987", "createdAt": "2020-11-19T09:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NzE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2ODg1OQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r524968859", "bodyText": "Is it possible to use composition instead? So you would have single TypeBenchmarkData class to which you would inject customizations.", "author": "kokosing", "createdAt": "2020-11-17T08:30:38Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -245,44 +237,38 @@ public Slice getDataSource()\n         }\n     }\n \n-    @State(Thread)\n-    public static class LongDecimalNoNullBenchmarkData\n+    public abstract static class TypeBenchmarkData<T>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczNTU3Ng==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r526735576", "bodyText": "JMH has its requirements. I think this is as close to composition as it can get.\nI am going to think about it when merging those cases with BenchmarkColumnReaders in the following PR", "author": "skrzypo987", "createdAt": "2020-11-19T10:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2ODg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNTI1MQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r525005251", "bodyText": "These benchmarks were intentionally similar to BenchmarkColumnReaders. Could we keep them uniform? This most likely requires extraction of datagen to some external utility. However, we could then also benchmark Parquet in similar way and do head-to-head comparisons with different serde.", "author": "sopel39", "createdAt": "2020-11-17T09:27:26Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -50,6 +49,8 @@\n import java.util.List;\n import java.util.Random;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.BiConsumer;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczMDEyNw==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r526730127", "bodyText": "How about I handle that in a following PR? This looks pretty straightforward but I don't want to keep hanging for too long.", "author": "skrzypo987", "createdAt": "2020-11-19T09:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNTI1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NTQ0OA==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527565448", "bodyText": "Sure, we can do this as following PR", "author": "sopel39", "createdAt": "2020-11-20T09:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNTI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNjY2MA==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r525006660", "bodyText": "Could we extract data generation, so that new way of data gen is also used in io.prestosql.orc.BenchmarkColumnReaders (and potentially Parquet too)?", "author": "sopel39", "createdAt": "2020-11-17T09:29:29Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -384,10 +385,13 @@ public void setup()\n     public static class LongDecimalWithNullBenchmarkData\n             extends LongDecimalBenchmarkData\n     {\n+        @Param({\".01\", \".10\", \".50\", \".90\", \".99\"})", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczNzAwMg==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r526737002", "bodyText": "Those params cannot unfortunately be extracted. So every case needs to have this field.", "author": "skrzypo987", "createdAt": "2020-11-19T10:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNjY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MzAxNw==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527573017", "bodyText": "Those params cannot unfortunately be extracted. So every case needs to have this field.\n\nThese params could be part of io.prestosql.execution.buffer.BenchmarkBlockSerde.BenchmarkData (then they need to be defined once)\nio.prestosql.execution.buffer.BenchmarkBlockSerde.BenchmarkData could accept some data generator.\nThis would the composition that @kokosing mentioned.", "author": "sopel39", "createdAt": "2020-11-20T09:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNjY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5ODk0NQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527598945", "bodyText": "I am going to see if JMH will work with that.", "author": "skrzypo987", "createdAt": "2020-11-20T10:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNjY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNzc1Mg==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r525007752", "bodyText": "you can remove constructor in TestingPagesSerdeFactory too", "author": "sopel39", "createdAt": "2020-11-17T09:30:56Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -284,7 +284,7 @@ public Object deserializeLineitem(LineitemBenchmarkData data)\n         public void setup(Iterator<Page> pagesIterator)\n                 throws Exception\n         {\n-            pagesSerde = new TestingPagesSerdeFactory(new TestingBlockEncodingSerde(), false).createPagesSerde();\n+            pagesSerde = new PagesSerdeFactory(new TestingBlockEncodingSerde(), false).createPagesSerde();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NzgzNg==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527567836", "bodyText": "why not just pass null change as TypeBenchmarkData param?", "author": "sopel39", "createdAt": "2020-11-20T09:39:55Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -245,44 +237,38 @@ public Slice getDataSource()\n         }\n     }\n \n-    @State(Thread)\n-    public static class LongDecimalNoNullBenchmarkData\n+    public abstract static class TypeBenchmarkData<T>\n             extends BenchmarkData\n     {\n-        @Setup\n-        public void setup()\n-                throws Exception\n+        private final Type type;\n+        private final Function<Random, T> valueGenerator;\n+        private final BiConsumer<BlockBuilder, T> blockWriter;\n+\n+        public TypeBenchmarkData(Type type, Function<Random, T> valueGenerator, BiConsumer<BlockBuilder, T> blockWriter)\n         {\n-            setup(LONG_DECIMAL_TYPE, createValues());\n+            this.type = requireNonNull(type, \"type is null\");\n+            this.valueGenerator = requireNonNull(valueGenerator, \"valueGenerator is null\");\n+            this.blockWriter = requireNonNull(blockWriter, \"blockWriter is null\");\n         }\n \n-        private Iterator<?> createValues()\n+        protected double getNullChance()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4NzUxOQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527587519", "bodyText": "Param annotation only work with fields (I think) and fields are not available in constructor.", "author": "skrzypo987", "createdAt": "2020-11-20T10:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NzgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2OTI3Mg==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527569272", "bodyText": "Why remove these? Now every TypeBenchmarkData needs to know how to serialize values.", "author": "sopel39", "createdAt": "2020-11-20T09:42:19Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -187,30 +189,20 @@ public void setup(Iterator<Page> pagesIterator)\n             dataSource = sliceOutput.slice();\n         }\n \n-        public void setup(Type type, Iterator<?> values)\n+        public <T> void setup(Type type, Iterator<T> values, BiConsumer<BlockBuilder, T> writer)\n                 throws Exception\n         {\n             pagesSerde = new TestingPagesSerdeFactory(new TestingBlockEncodingSerde(), false).createPagesSerde();\n             PageBuilder pageBuilder = new PageBuilder(ImmutableList.of(type));\n             BlockBuilder blockBuilder = pageBuilder.getBlockBuilder(0);\n             ImmutableList.Builder<Page> pagesBuilder = ImmutableList.builder();\n             while (values.hasNext()) {\n-                Object value = values.next();\n+                T value = values.next();\n                 if (value == null) {\n                     blockBuilder.appendNull();\n                 }\n-                else if (BIGINT.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4NTc2NQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527585765", "bodyText": "Seemed more object-oriented. But I don't see any significant value here so I'll revert", "author": "skrzypo987", "createdAt": "2020-11-20T10:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2OTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTU5NQ==", "url": "https://github.com/trinodb/trino/pull/5972#discussion_r527571595", "bodyText": "also add benchmarks for Int128ArrayBlock?", "author": "sopel39", "createdAt": "2020-11-20T09:46:22Z", "path": "presto-main/src/test/java/io/prestosql/execution/buffer/BenchmarkBlockSerde.java", "diffHunk": "@@ -103,6 +109,30 @@ public Object deserializeLongDecimalWithNull(LongDecimalWithNullBenchmarkData da\n         return ImmutableList.copyOf(readPages(data.getPagesSerde(), new BasicSliceInput(data.getDataSource())));\n     }\n \n+    @Benchmark\n+    public Object serializeInt96NoNull(LongTimestampBenchmarkData data)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "616821669f0fe5aa78542bdf5e5d6f09fd20f209", "url": "https://github.com/trinodb/trino/commit/616821669f0fe5aa78542bdf5e5d6f09fd20f209", "message": "Organize benchmarks in BenchmarkBlockSerde", "committedDate": "2020-11-20T13:10:34Z", "type": "commit"}, {"oid": "d1cda862cc0d2a8ad48c349afdf171427fea16b6", "url": "https://github.com/trinodb/trino/commit/d1cda862cc0d2a8ad48c349afdf171427fea16b6", "message": "Add more types to BenchmarkBlockSerde", "committedDate": "2020-11-20T13:10:36Z", "type": "commit"}, {"oid": "bbb3c6ada766f417328dc29bc53a873614dafcba", "url": "https://github.com/trinodb/trino/commit/bbb3c6ada766f417328dc29bc53a873614dafcba", "message": "Add different null distributions to BenchmarkBlockSerde", "committedDate": "2020-11-20T13:10:36Z", "type": "commit"}, {"oid": "c1e04842a6ddead4a798b3899520df2e35b29bfc", "url": "https://github.com/trinodb/trino/commit/c1e04842a6ddead4a798b3899520df2e35b29bfc", "message": "Remove TestingPagesSerdeFactory from BenchmarkBlockSerde", "committedDate": "2020-11-20T13:10:36Z", "type": "commit"}, {"oid": "c1e04842a6ddead4a798b3899520df2e35b29bfc", "url": "https://github.com/trinodb/trino/commit/c1e04842a6ddead4a798b3899520df2e35b29bfc", "message": "Remove TestingPagesSerdeFactory from BenchmarkBlockSerde", "committedDate": "2020-11-20T13:10:36Z", "type": "forcePushed"}]}