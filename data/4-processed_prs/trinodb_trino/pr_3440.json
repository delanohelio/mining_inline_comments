{"pr_number": 3440, "pr_title": "Add SSL/TLS support for Hive Metastore", "pr_createdAt": "2020-04-15T21:19:19Z", "pr_url": "https://github.com/trinodb/trino/pull/3440", "timeline": [{"oid": "486ca9b01cbed9a3331857bd68d2fd6a27d5db39", "url": "https://github.com/trinodb/trino/commit/486ca9b01cbed9a3331857bd68d2fd6a27d5db39", "message": "Increase width of Hive Thrift metastore table", "committedDate": "2020-04-15T19:27:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MjI4NQ==", "url": "https://github.com/trinodb/trino/pull/3440#discussion_r409792285", "bodyText": "Should we replace null with new char[0] instead?\nIt appears that keymanager password cannot be null.\nCaused by: java.security.UnrecoverableKeyException: Password must not be null`\n...\n\tat io.prestosql.plugin.hive.metastore.thrift.ThriftMetastoreClientFactory.buildSslContext(ThriftMetastoreClientFactory.java:113)", "author": "dongwoo1005", "createdAt": "2020-04-16T19:19:03Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftMetastoreClientFactory.java", "diffHunk": "@@ -50,14 +68,110 @@ public ThriftMetastoreClientFactory(\n     }\n \n     @Inject\n-    public ThriftMetastoreClientFactory(ThriftMetastoreConfig config, HiveMetastoreAuthentication metastoreAuthentication, NodeManager nodeManager)\n+    public ThriftMetastoreClientFactory(\n+            ThriftMetastoreConfig config,\n+            HiveMetastoreAuthentication metastoreAuthentication,\n+            NodeManager nodeManager)\n     {\n-        this(Optional.empty(), Optional.ofNullable(config.getSocksProxy()), config.getMetastoreTimeout(), metastoreAuthentication, nodeManager.getCurrentNode().getHost());\n+        this(\n+                buildSslContext(\n+                        config.isTlsEnabled(),\n+                        Optional.ofNullable(config.getKeystorePath()),\n+                        Optional.ofNullable(config.getKeystorePassword()),\n+                        config.getTruststorePath()),\n+                Optional.ofNullable(config.getSocksProxy()),\n+                config.getMetastoreTimeout(),\n+                metastoreAuthentication,\n+                nodeManager.getCurrentNode().getHost());\n     }\n \n     public ThriftMetastoreClient create(HostAndPort address, Optional<String> delegationToken)\n             throws TTransportException\n     {\n-        return new ThriftHiveMetastoreClient(Transport.create(address, sslContext, socksProxy, timeoutMillis, metastoreAuthentication, delegationToken), hostname);\n+        return new ThriftHiveMetastoreClient(\n+                Transport.create(address, sslContext, socksProxy, timeoutMillis, metastoreAuthentication, delegationToken),\n+                hostname);\n+    }\n+\n+    private static Optional<SSLContext> buildSslContext(\n+            boolean tlsEnabled,\n+            Optional<File> keyStorePath,\n+            Optional<String> keyStorePassword,\n+            File trustStorePath)\n+    {\n+        if (!tlsEnabled) {\n+            return Optional.empty();\n+        }\n+\n+        try {\n+            // load KeyStore if configured and get KeyManagers\n+            KeyManager[] keyManagers = null;\n+            if (keyStorePath.isPresent()) {\n+                KeyStore keyStore = PemReader.loadKeyStore(keyStorePath.get(), keyStorePath.get(), keyStorePassword);\n+                validateCertificates(keyStore);\n+                KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\n+                keyManagerFactory.init(keyStore, null);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5Mjk2Ng==", "url": "https://github.com/trinodb/trino/pull/3440#discussion_r409792966", "bodyText": "Nit, how about explicitly adding an additional description that it must be provided when ssl is enabled?", "author": "dongwoo1005", "createdAt": "2020-04-16T19:20:12Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -248,39 +248,47 @@ Property Name                                      Description\n Hive Thrift Metastore Configuration Properties\n ----------------------------------------------\n \n-================================================== ============================================================ ============\n-Property Name                                      Description                                                  Default\n-================================================== ============================================================ ============\n-``hive.metastore.uri``                             The URI(s) of the Hive metastore to connect to using the\n-                                                   Thrift protocol. If multiple URIs are provided, the first\n-                                                   URI is used by default, and the rest of the URIs are\n-                                                   fallback metastores. This property is required.\n-                                                   Example: ``thrift://192.0.2.3:9083`` or\n-                                                   ``thrift://192.0.2.3:9083,thrift://192.0.2.4:9083``\n+======================================================== ============================================================ ============\n+Property Name                                            Description                                                  Default\n+======================================================== ============================================================ ============\n+``hive.metastore.uri``                                   The URI(s) of the Hive metastore to connect to using the\n+                                                         Thrift protocol. If multiple URIs are provided, the first\n+                                                         URI is used by default, and the rest of the URIs are\n+                                                         fallback metastores. This property is required.\n+                                                         Example: ``thrift://192.0.2.3:9083`` or\n+                                                         ``thrift://192.0.2.3:9083,thrift://192.0.2.4:9083``\n \n-``hive.metastore.username``                        The username Presto uses to access the Hive metastore.\n+``hive.metastore.username``                              The username Presto uses to access the Hive metastore.\n \n-``hive.metastore.authentication.type``             Hive metastore authentication type.\n-                                                   Possible values are ``NONE`` or ``KERBEROS``\n-                                                   (defaults to ``NONE``).\n+``hive.metastore.authentication.type``                   Hive metastore authentication type.\n+                                                         Possible values are ``NONE`` or ``KERBEROS``\n+                                                         (defaults to ``NONE``).\n \n-``hive.metastore.thrift.impersonation.enabled``    Enable Hive metastore end user impersonation.\n+``hive.metastore.thrift.impersonation.enabled``          Enable Hive metastore end user impersonation.\n \n-``hive.metastore.service.principal``               The Kerberos principal of the Hive metastore service.\n+``hive.metastore.thrift.client.ssl.enabled``             Use SSL when connecting to metastore.                        ``false``\n \n-``hive.metastore.client.principal``                The Kerberos principal that Presto uses when connecting\n-                                                   to the Hive metastore service.\n+``hive.metastore.thrift.client.ssl.key``                 Path to PEM private key and client certificate (key store).\n \n-``hive.metastore.client.keytab``                   Hive metastore client keytab location.\n+``hive.metastore.thrift.client.ssl.key-password``        Password for the PEM private key.\n \n-``hive.metastore-cache-ttl``                       Time to live Hive metadata cache.                            ``0s``\n+``hive.metastore.thrift.client.ssl.trust-certificate``   Path to the PEM server certificate chain (trust store).", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a170cdb7baa89a891249a57f57222d7b0acc519f", "url": "https://github.com/trinodb/trino/commit/a170cdb7baa89a891249a57f57222d7b0acc519f", "message": "Add SSL/TLS support for Hive Metastore", "committedDate": "2020-04-16T21:53:26Z", "type": "commit"}, {"oid": "a170cdb7baa89a891249a57f57222d7b0acc519f", "url": "https://github.com/trinodb/trino/commit/a170cdb7baa89a891249a57f57222d7b0acc519f", "message": "Add SSL/TLS support for Hive Metastore", "committedDate": "2020-04-16T21:53:26Z", "type": "forcePushed"}]}