{"pr_number": 6074, "pr_title": "Support writing TIMESTAMPTZ with JSON encoder", "pr_createdAt": "2020-11-24T13:02:22Z", "pr_url": "https://github.com/trinodb/trino/pull/6074", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3Nzg2NA==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r530977864", "bodyText": "preexisting, but there is no point to cover all aspects of the tested class within single test method.\nthese testTime, testTimestamp, etc above should be their own test methods.\nthen your new test cases would go to an isolated testTimestampWithTimeZone method", "author": "findepi", "createdAt": "2020-11-26T11:55:17Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestSecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -57,5 +78,12 @@ public void testSecondsDateTimeFunctions()\n         testTimestamp(sqlTimestampOf(3, 2020, 8, 18, 12, 38, 29, 0), LocalDateTime.of(2020, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n         testTimestamp(sqlTimestampOf(3, 1970, 1, 1, 0, 0, 0, 0), 0);\n         testTimestamp(sqlTimestampOf(3, 1800, 8, 18, 12, 38, 29, 0), LocalDateTime.of(1800, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3ODI1MA==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r530978250", "bodyText": "TZ -> TimeZone\nactualSeconds -> expected", "author": "findepi", "createdAt": "2020-11-26T11:55:59Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestSecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -47,6 +56,18 @@ private void testTimestamp(SqlTimestamp value, long actualSeconds)\n         assertEquals(Long.parseLong(formattedStr), actualSeconds);\n     }\n \n+    private void testTimestampWithTZ(SqlTimestampWithTimeZone value, long actualSeconds)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MDY1Ng==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r530980656", "bodyText": "that's very repetitive, but maybe that's fine... let's format this on lines:\n        testTimestampWithTZ(\n                sqlTimestampWithTimeZoneOf(3, 2020, 8, 18, 12, 38, 29, 123000000, UTC_KEY),\n                ZonedDateTime.of(2020, 8, 18, 12, 38, 29, 123000000, UTC).toEpochSecond());\n\nand remove getEpochSecondsFromDateTimeWithZone method", "author": "findepi", "createdAt": "2020-11-26T12:00:19Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestSecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -57,5 +78,12 @@ public void testSecondsDateTimeFunctions()\n         testTimestamp(sqlTimestampOf(3, 2020, 8, 18, 12, 38, 29, 0), LocalDateTime.of(2020, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n         testTimestamp(sqlTimestampOf(3, 1970, 1, 1, 0, 0, 0, 0), 0);\n         testTimestamp(sqlTimestampOf(3, 1800, 8, 18, 12, 38, 29, 0), LocalDateTime.of(1800, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n+\n+        testTimestampWithTZ(sqlTimestampWithTimeZoneOf(3, 2020, 8, 18, 12, 38, 29, 123000000, UTC_KEY), getEpochSecondsFromDateTimeWithZone(2020, 8, 18, 12, 38, 29, 123000000, UTC_KEY));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MDgzMg==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r530980832", "bodyText": "formattedStr -> formatted", "author": "findepi", "createdAt": "2020-11-26T12:00:35Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestMillisecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -49,6 +56,12 @@ private void testTimestamp(SqlTimestamp value, long actualMillis)\n         assertEquals(Long.parseLong(formattedStr), actualMillis);\n     }\n \n+    private void testTimestampWithTZ(SqlTimestampWithTimeZone value, long actualMillis)\n+    {\n+        String formattedStr = getFormatter().formatTimestampWithZone(value);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MDkwMg==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r530980902", "bodyText": "actualMillis -> expected", "author": "findepi", "createdAt": "2020-11-26T12:00:43Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestMillisecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -49,6 +56,12 @@ private void testTimestamp(SqlTimestamp value, long actualMillis)\n         assertEquals(Long.parseLong(formattedStr), actualMillis);\n     }\n \n+    private void testTimestampWithTZ(SqlTimestampWithTimeZone value, long actualMillis)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3ODAzNQ==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r531578035", "bodyText": "can you please extract test splitting as a prep commit?\n(i am aware you would need to squash&rebase the existing work piece for that)", "author": "findepi", "createdAt": "2020-11-27T12:37:06Z", "path": "presto-kafka/src/test/java/io/prestosql/plugin/kafka/encoder/json/TestSecondsJsonDateTimeFormatter.java", "diffHunk": "@@ -35,27 +38,57 @@ private JsonDateTimeFormatter getFormatter()\n         return SECONDS_SINCE_EPOCH.getFormatter(Optional.empty());\n     }\n \n-    private void testTime(SqlTime value, int precision, long actualSeconds)\n+    @Test(dataProvider = \"testTimeProvider\")\n+    public void testTime(LocalTime time)\n     {\n-        String formattedStr = getFormatter().formatTime(value, precision);\n-        assertEquals(Long.parseLong(formattedStr), actualSeconds);\n+        String formatted = getFormatter().formatTime(sqlTimeOf(3, time), 3);\n+        assertEquals(Long.parseLong(formatted), time.toSecondOfDay());\n     }\n \n-    private void testTimestamp(SqlTimestamp value, long actualSeconds)\n+    @DataProvider\n+    public Object[][] testTimeProvider()\n     {\n-        String formattedStr = getFormatter().formatTimestamp(value);\n-        assertEquals(Long.parseLong(formattedStr), actualSeconds);\n+        return new Object[][] {\n+                {LocalTime.of(15, 36, 25, 0)},\n+                {LocalTime.of(0, 0, 0, 0)},\n+                {LocalTime.of(23, 59, 59, 0)},\n+        };\n     }\n \n-    @Test\n-    public void testSecondsDateTimeFunctions()\n+    @Test(dataProvider = \"testTimestampProvider\")\n+    public void testTimestamp(LocalDateTime dateTime)\n     {\n-        testTime(sqlTimeOf(3, 15, 36, 25, 0), 3, LocalTime.of(15, 36, 25, 0).toSecondOfDay());\n-        testTime(sqlTimeOf(3, 0, 0, 0, 0), 3, 0);\n-        testTime(sqlTimeOf(3, 23, 59, 59, 0), 3, LocalTime.of(23, 59, 59, 0).toSecondOfDay());\n+        String formatted = getFormatter().formatTimestamp(sqlTimestampOf(3, dateTime));\n+        assertEquals(Long.parseLong(formatted), dateTime.toEpochSecond(UTC));\n+    }\n+\n+    @DataProvider\n+    public Object[][] testTimestampProvider()\n+    {\n+        return new Object[][] {\n+                {LocalDateTime.of(2020, 8, 18, 12, 38, 29, 0)},\n+                {LocalDateTime.of(1970, 1, 1, 0, 0, 0, 0)},\n+                {LocalDateTime.of(1800, 8, 18, 12, 38, 29, 0)},\n+        };\n+    }\n \n-        testTimestamp(sqlTimestampOf(3, 2020, 8, 18, 12, 38, 29, 0), LocalDateTime.of(2020, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n-        testTimestamp(sqlTimestampOf(3, 1970, 1, 1, 0, 0, 0, 0), 0);\n-        testTimestamp(sqlTimestampOf(3, 1800, 8, 18, 12, 38, 29, 0), LocalDateTime.of(1800, 8, 18, 12, 38, 29, 0).toEpochSecond(ZoneOffset.UTC));\n+    @Test(dataProvider = \"testTimestampWithTimeZoneProvider\")\n+    public void testTimestampWithTimeZone(ZonedDateTime zonedDateTime)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYwNjY2NQ==", "url": "https://github.com/trinodb/trino/pull/6074#discussion_r531606665", "bodyText": "Done. I'll do a follow up to clean-up some other test classes in the same module.", "author": "hashhar", "createdAt": "2020-11-27T13:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3ODAzNQ=="}], "type": "inlineReview"}, {"oid": "64e22340145bf1a0d02f2dd9ad37c693f10ea776", "url": "https://github.com/trinodb/trino/commit/64e22340145bf1a0d02f2dd9ad37c693f10ea776", "message": "Split JSON date-time formatter tests", "committedDate": "2020-11-28T06:14:30Z", "type": "commit"}, {"oid": "5d076ed074b783985fdee544c350f1cedb5d4df2", "url": "https://github.com/trinodb/trino/commit/5d076ed074b783985fdee544c350f1cedb5d4df2", "message": "Support writing TIMESTAMPTZ with JSON encoder\n\nFixes #5955.", "committedDate": "2020-11-28T06:14:30Z", "type": "commit"}]}