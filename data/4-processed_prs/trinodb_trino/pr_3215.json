{"pr_number": 3215, "pr_title": "Remove usage of String.format in HTTP client hot path", "pr_createdAt": "2020-03-23T16:41:55Z", "pr_url": "https://github.com/trinodb/trino/pull/3215", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0OTQyMA==", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396749420", "bodyText": "Padding on the right is not as good as padding on the left, eg 2nd and 17th numbers: 0x1, 0x10 will result in same token, right?", "author": "findepi", "createdAt": "2020-03-23T20:53:11Z", "path": "presto-main/src/main/java/io/prestosql/server/GenerateTraceTokenRequestFilter.java", "diffHunk": "@@ -29,22 +29,28 @@\n public class GenerateTraceTokenRequestFilter\n         implements HttpRequestFilter\n {\n+    private static final int SEQUENCE_NUMBER_HEX_LENGTH = 10;\n+\n     private final String prefix = randomUUID().toString().toLowerCase(ENGLISH).replace(\"-\", \"\");\n     private final AtomicLong sequence = new AtomicLong();\n \n     @Override\n     public Request filterRequest(Request request)\n     {\n         requireNonNull(request, \"request is null\");\n-        String newToken = createToken(sequence.getAndIncrement());\n         return fromRequest(request)\n-                .setHeader(TRACETOKEN_HEADER, newToken)\n+                .setHeader(TRACETOKEN_HEADER, createToken(sequence.getAndIncrement()))\n                 .build();\n     }\n \n     private String createToken(long value)\n     {\n-        return prefix + format(\"%010x\", value);\n+        StringBuilder builder = new StringBuilder(prefix.length() + SEQUENCE_NUMBER_HEX_LENGTH).append(prefix);\n+        String sequenceNumHex = Long.toHexString(value);\n+        for (int i = sequenceNumHex.length(); i < SEQUENCE_NUMBER_HEX_LENGTH; i++) {\n+            builder.append('0');", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1NjMwMQ==", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396756301", "bodyText": "The padding is on the left, since sequenceNumHex is appended below.", "author": "electrum", "createdAt": "2020-03-23T21:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0OTQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1Nzc3MA==", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396757770", "bodyText": "Maybe keep this as a comment\n// optimized version of this: prefix + format(\"%010x\", value)", "author": "electrum", "createdAt": "2020-03-23T21:08:26Z", "path": "presto-main/src/main/java/io/prestosql/server/GenerateTraceTokenRequestFilter.java", "diffHunk": "@@ -29,22 +29,28 @@\n public class GenerateTraceTokenRequestFilter\n         implements HttpRequestFilter\n {\n+    private static final int SEQUENCE_NUMBER_HEX_LENGTH = 10;\n+\n     private final String prefix = randomUUID().toString().toLowerCase(ENGLISH).replace(\"-\", \"\");\n     private final AtomicLong sequence = new AtomicLong();\n \n     @Override\n     public Request filterRequest(Request request)\n     {\n         requireNonNull(request, \"request is null\");\n-        String newToken = createToken(sequence.getAndIncrement());\n         return fromRequest(request)\n-                .setHeader(TRACETOKEN_HEADER, newToken)\n+                .setHeader(TRACETOKEN_HEADER, createToken(sequence.getAndIncrement()))\n                 .build();\n     }\n \n     private String createToken(long value)\n     {\n-        return prefix + format(\"%010x\", value);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgwNzEwOQ==", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396807109", "bodyText": "Added", "author": "pettyjamesm", "createdAt": "2020-03-23T22:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1Nzc3MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "92c6aa6684f367438a4b797a66455fbba52ba9c7", "url": "https://github.com/trinodb/trino/commit/92c6aa6684f367438a4b797a66455fbba52ba9c7", "message": "Remove usage of String.format in HTTP client hot path\n\nAvoids the use of String.format from the trace token request filter\nto avoid unnecessary allocations and worse performance in the http\nclient hot path. Allocation profiles showed this as representing\none percent of all worker allocations (by number of allocations,\nnot proportional to size) while queries were running. After this\nchange, it represents ~0.2%.", "committedDate": "2020-03-24T12:21:03Z", "type": "commit"}, {"oid": "92c6aa6684f367438a4b797a66455fbba52ba9c7", "url": "https://github.com/trinodb/trino/commit/92c6aa6684f367438a4b797a66455fbba52ba9c7", "message": "Remove usage of String.format in HTTP client hot path\n\nAvoids the use of String.format from the trace token request filter\nto avoid unnecessary allocations and worse performance in the http\nclient hot path. Allocation profiles showed this as representing\none percent of all worker allocations (by number of allocations,\nnot proportional to size) while queries were running. After this\nchange, it represents ~0.2%.", "committedDate": "2020-03-24T12:21:03Z", "type": "forcePushed"}]}