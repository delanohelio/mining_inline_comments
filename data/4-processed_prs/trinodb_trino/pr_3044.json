{"pr_number": 3044, "pr_title": "Add GitHub workflow for Azure tests", "pr_createdAt": "2020-03-09T21:38:39Z", "pr_url": "https://github.com/trinodb/trino/pull/3044", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "2934e88bb84b01ac0041770784ebfde5a461199a", "url": "https://github.com/trinodb/trino/commit/2934e88bb84b01ac0041770784ebfde5a461199a", "message": "Delete workflows for testing", "committedDate": "2020-03-09T23:08:01Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "7fb6ae509b0a726eee9693c219276b32b4f47131", "url": "https://github.com/trinodb/trino/commit/7fb6ae509b0a726eee9693c219276b32b4f47131", "message": "Delete workflows for testing", "committedDate": "2020-03-11T00:43:43Z", "type": "forcePushed"}, {"oid": "16be19b55ed649ee9f8023decb24e5aee022de7e", "url": "https://github.com/trinodb/trino/commit/16be19b55ed649ee9f8023decb24e5aee022de7e", "message": "Delete workflows for testing", "committedDate": "2020-03-11T01:31:01Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "8cd801b4cb448ddb37954b24ceffdca237cc8661", "url": "https://github.com/trinodb/trino/commit/8cd801b4cb448ddb37954b24ceffdca237cc8661", "message": "Add GitHub workflow for Azure tests", "committedDate": "2020-03-21T16:56:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwNTE4NA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r396305184", "bodyText": "S3 -> Azure\n\n\nyou can squash Restart hive-server2 for Azure tests commit", "author": "findepi", "createdAt": "2020-03-23T09:15:54Z", "path": "presto-hive-hadoop2/bin/run_hive_abfs_tests.sh", "diffHunk": "@@ -18,6 +18,10 @@ exec_in_hadoop_master_container sed -i \\\n     -e \"s|%ABFS_ACCOUNT%|${ABFS_ACCOUNT}|g\" \\\n     /etc/hadoop/conf/core-site.xml\n \n+# restart hive-server2 to apply S3 changes in core-site.xml", "originalCommit": "a3290155a76932227b020ba26d7f5462c0e288a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwNTU2Mg==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r396305562", "bodyText": "Why? Is your intention to run this for  config-cdh5? (upcoming; already mentioned in this file)\nAdd a comment. Maybe\n# config-empty's Hive 1.2 does not support Azure storage", "author": "findepi", "createdAt": "2020-03-23T09:16:37Z", "path": ".github/workflows/module-tests.yml", "diffHunk": "@@ -51,6 +51,17 @@ jobs:\n           if [ \"${AWS_ACCESS_KEY_ID}\" != \"\" ]; then\n             ./mvnw test -B -Dair.check.skip-all -pl presto-hive -P test-hive-glue\n           fi\n+      - name: Run Hive Azure ABFS Tests\n+        if: matrix.config != 'config-empty'", "originalCommit": "8cd801b4cb448ddb37954b24ceffdca237cc8661", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwOTIxMQ==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r396309211", "bodyText": "for s3 tests we leverage auto-delete functionality to provide test isolation\nhttps://github.com/prestosql/presto/blob/cbf0d04b766d7a90c69e8dd7bc18a48779441749/presto-hive-hadoop2/bin/run_hive_s3_tests.sh#L10\nAzure has an equivalent: https://stackoverflow.com/a/56906611/65458\n@electrum @anusudarsan can we have this enabled?\notherwise I would want this folder to be called ..._2, to ensure no conflicts in installations running previous versions of these tests, that used different set of test files (one vs four)", "author": "findepi", "createdAt": "2020-03-23T09:22:58Z", "path": "presto-hive-hadoop2/bin/run_hive_abfs_tests.sh", "diffHunk": "@@ -18,6 +18,34 @@ exec_in_hadoop_master_container sed -i \\\n     -e \"s|%ABFS_ACCOUNT%|${ABFS_ACCOUNT}|g\" \\\n     /etc/hadoop/conf/core-site.xml\n \n+# restart hive-server2 to apply S3 changes in core-site.xml\n+docker exec \"$(hadoop_master_container)\" supervisorctl restart hive-server2\n+retry check_hadoop\n+\n+# create test table\n+table_path=\"abfs://${ABFS_CONTAINER}@${ABFS_ACCOUNT}.dfs.core.windows.net/presto_test_external_fs/\"", "originalCommit": "8cd801b4cb448ddb37954b24ceffdca237cc8661", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxMDM1MA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r396310350", "bodyText": "same comment as for abfs; & applies to wasb too", "author": "findepi", "createdAt": "2020-03-23T09:24:57Z", "path": "presto-hive-hadoop2/bin/run_hive_adl_tests.sh", "diffHunk": "@@ -21,9 +21,9 @@ exec_in_hadoop_master_container sed -i \\\n     /etc/hadoop/conf/core-site.xml\n \n # create test table\n-table_path=\"adl://${ADL_NAME}.azuredatalakestore.net/presto_test_external_fs_2/\"\n+table_path=\"adl://${ADL_NAME}.azuredatalakestore.net/presto_test_external_fs/\"", "originalCommit": "8cd801b4cb448ddb37954b24ceffdca237cc8661", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxMjIyOQ==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r396312229", "bodyText": "What replaces this test?", "author": "findepi", "createdAt": "2020-03-23T09:27:58Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveAzure.java", "diffHunk": "@@ -1,62 +0,0 @@\n-/*\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package io.prestosql.plugin.hive;\n-\n-import com.google.common.collect.ImmutableSet;\n-import io.prestosql.plugin.hive.azure.HiveAzureConfig;\n-import io.prestosql.plugin.hive.azure.PrestoAzureConfigurationInitializer;\n-import org.testng.annotations.BeforeClass;\n-import org.testng.annotations.Parameters;\n-\n-import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Strings.isNullOrEmpty;\n-\n-public class TestHiveAzure", "originalCommit": "8cd801b4cb448ddb37954b24ceffdca237cc8661", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4OTI2NA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r398589264", "bodyText": "This test was never being run.", "author": "anusudarsan", "createdAt": "2020-03-26T13:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxMjIyOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5a14f7d35fd8aa0cc284fe0bf0f04303737d9ab5", "url": "https://github.com/trinodb/trino/commit/5a14f7d35fd8aa0cc284fe0bf0f04303737d9ab5", "message": "HACK only run Azure tests", "committedDate": "2020-08-28T22:37:28Z", "type": "forcePushed"}, {"oid": "6d6882fb36eb3909c58fdae7a68603b37707a20d", "url": "https://github.com/trinodb/trino/commit/6d6882fb36eb3909c58fdae7a68603b37707a20d", "message": "HACK only run Azure tests", "committedDate": "2020-08-31T18:40:15Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "7fd81ff87db3aee8f3c9b99e5d61af66842be03c", "url": "https://github.com/trinodb/trino/commit/7fd81ff87db3aee8f3c9b99e5d61af66842be03c", "message": "HACK only run Azure tests", "committedDate": "2020-09-01T00:28:33Z", "type": "forcePushed"}, {"oid": "b53a9b733c1b47ef0f7cdb86d4f111c4ee02ba8d", "url": "https://github.com/trinodb/trino/commit/b53a9b733c1b47ef0f7cdb86d4f111c4ee02ba8d", "message": "Rename S3 secret names to use uppercase", "committedDate": "2020-09-01T17:16:48Z", "type": "commit"}, {"oid": "74bc6ae3426f2d0bdcede06bd3ed8ac5a4488c7f", "url": "https://github.com/trinodb/trino/commit/74bc6ae3426f2d0bdcede06bd3ed8ac5a4488c7f", "message": "Remove unused Azure tests", "committedDate": "2020-09-01T17:16:48Z", "type": "commit"}, {"oid": "5f6fcb2568033f2c01a5bd30117c9f74ae75ce21", "url": "https://github.com/trinodb/trino/commit/5f6fcb2568033f2c01a5bd30117c9f74ae75ce21", "message": "Only run CI on push to master", "committedDate": "2020-09-01T17:16:48Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2NA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r481351764", "bodyText": "Why hash and cut the UUID? Using the full UUID doesn't make it any easier or harder to read, and it's not so many characters that it should cause problems.\nI'd suggest a slightly more verbose name, in case someone needs to find a particular test at any point, something like \"test-$(date +%Y-%m-%dT%H.%M.%S)-id-$(uuidgen)\".", "author": "jirassimok", "createdAt": "2020-09-01T18:38:09Z", "path": "presto-hive-hadoop2/bin/run_hive_abfs_tests.sh", "diffHunk": "@@ -8,7 +8,11 @@ test -v ABFS_CONTAINER\n test -v ABFS_ACCOUNT\n test -v ABFS_ACCESS_KEY\n \n-start_docker_containers\n+cleanup_hadoop_docker_containers\n+start_hadoop_docker_containers\n+\n+test_directory=\"$(date '+%Y%m%d-%H%M%S')-$(uuidgen | sha1sum | cut -b 1-6)\"", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3MjcwNA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r481372704", "bodyText": "This came from @findepi in e364b6b for S3. I'm inclined to agree, except for adding dots in the name.", "author": "electrum", "createdAt": "2020-09-01T19:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4ODkzNw==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r481388937", "bodyText": "The sha1sum part might be an attempt to normalize the output case as uuidgen on macOS is uppercase but Linux is lowercase.", "author": "electrum", "createdAt": "2020-09-01T19:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxMTIxMw==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r481411213", "bodyText": "The case shouldn't matter, because it's still only generated once (in any case, that's what tr '[:upper:]' '[:lower:]' is for).\nI wasn't sure about the dots, either; dashes work just as well.", "author": "jirassimok", "createdAt": "2020-09-01T20:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ5MzY4NA==", "url": "https://github.com/trinodb/trino/pull/3044#discussion_r482493684", "bodyText": "This came from @findepi in e364b6b for S3\n\nsha1sum is necessary if we want to cut (uuid's prefix is not random).\ncut can be used because this is only for collision ties (we have date/time as well), so full uuid is enterpreisely redundant", "author": "findepi", "createdAt": "2020-09-02T21:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2NA=="}], "type": "inlineReview"}, {"oid": "a8251b47ea230378e9059f1fdbe977f7b161cb70", "url": "https://github.com/trinodb/trino/commit/a8251b47ea230378e9059f1fdbe977f7b161cb70", "message": "Add GitHub workflow for Azure tests", "committedDate": "2020-09-01T19:46:10Z", "type": "commit"}, {"oid": "a8251b47ea230378e9059f1fdbe977f7b161cb70", "url": "https://github.com/trinodb/trino/commit/a8251b47ea230378e9059f1fdbe977f7b161cb70", "message": "Add GitHub workflow for Azure tests", "committedDate": "2020-09-01T19:46:10Z", "type": "forcePushed"}]}