{"pr_number": 4748, "pr_title": "Refactor HiveMetastore API and Implementations", "pr_createdAt": "2020-08-08T01:27:16Z", "pr_url": "https://github.com/trinodb/trino/pull/4748", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MjcxMg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r472392712", "bodyText": "Move to io.prestosql.plugin.hive.util package", "author": "electrum", "createdAt": "2020-08-18T18:19:08Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/spi/block/BlockJsonSerde.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.spi.block;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1MjQzMw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474952433", "bodyText": "done", "author": "rash67", "createdAt": "2020-08-21T20:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MjcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NDY2Nw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r472394667", "bodyText": "We shouldn't bind RecordingHiveMetastore here unconditionally.\nThere are three duplicated bindings for RecordingHiveMetastore in ThriftMetastoreModule and GlueMetastoreModule. Existing duplicated code:\nbinder.bind(HiveMetastore.class)\n        .annotatedWith(ForCachingHiveMetastore.class)\n        .to(RecordingHiveMetastore.class)\n        .in(Scopes.SINGLETON);\nbinder.bind(RecordingHiveMetastore.class).in(Scopes.SINGLETON);\nnewExporter(binder).export(RecordingHiveMetastore.class).withGeneratedName();\nCreate a RecordingHiveMetastoreModule and move that plus this code into the new module. Then install the module in those metastore modules.", "author": "electrum", "createdAt": "2020-08-18T18:22:31Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveModule.java", "diffHunk": "@@ -124,6 +128,11 @@ public void configure(Binder binder)\n \n         jsonBinder(binder).addDeserializerBinding(Type.class).to(TypeDeserializer.class);\n \n+        binder.bind(HiveBlockEncodingSerde.class).in(Scopes.SINGLETON);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MjEzMA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474792130", "bodyText": "relevant?", "author": "findepi", "createdAt": "2020-08-21T16:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NDY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3MDIyOA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474870228", "bodyText": "We now need additional code when binding RecordingHiveMetastore, so it makes sense to extract the module for it.", "author": "electrum", "createdAt": "2020-08-21T18:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2NDYyNg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r472464626", "bodyText": "Nit: the \"else\" are redundant since the above \"if\" returns\nif (...) {\n    return ...;\n}\nif (...) {\n    return ...;\n}", "author": "electrum", "createdAt": "2020-08-18T20:21:44Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames\n+     * @param partitionKeysFilter\n+     * @param assumeCanonicalPartitionKeys allow conversion of\n+     * @return the Domain for each partition key to either the wildcard or an equals check.\n+     * TupleDomain.none() or any column's Domain.isNone() -> Optional.empty()\n+     */\n+    public static Optional<List<String>> partitionKeyFilterToStringList(List<String> columnNames, TupleDomain<String> partitionKeysFilter, boolean assumeCanonicalPartitionKeys)\n+    {\n+        if (isPartitionKeyFilterFalse(partitionKeysFilter)) {\n+            return Optional.empty();\n+        }\n+\n+        checkArgument(partitionKeysFilter.getDomains().isPresent());\n+\n+        Map<String, Domain> domainMap = partitionKeysFilter.getDomains().orElse(ImmutableMap.of());\n+        List<String> partitionList = columnNames.stream().map(cn -> domainToString(domainMap.get(cn), assumeCanonicalPartitionKeys, HIVE_PARTITION_VALUE_WILDCARD)).collect(toImmutableList());\n+        return Optional.of(partitionList);\n+    }\n+\n+    /**\n+     * @param domain - domain expression for the column. null => TupleDomain.all()\n+     * @param assumeCanonicalPartitionKeys\n+     * @param partitionWildcardString wildcard\n+     * @return string for scalar values\n+     */\n+    public static String domainToString(Domain domain, boolean assumeCanonicalPartitionKeys, String partitionWildcardString)\n+    {\n+        if (domain != null && domain.isNullableSingleValue()) {\n+            return sqlScalarToString(domain.getType(), domain.getNullableSingleValue(), assumeCanonicalPartitionKeys, partitionWildcardString);\n+        }\n+        else { // null or not a single value\n+            return partitionWildcardString;\n+        }\n+    }\n+\n+    /**\n+     * @param type\n+     * @param value\n+     * @param assumeCanonicalPartitionKeys\n+     * @param partitionWildcardString\n+     * @return value converted a string format. Returns\n+     */\n+    public static String sqlScalarToString(Type type, Object value, boolean assumeCanonicalPartitionKeys, String partitionWildcardString)\n+    {\n+        if (value == null) {\n+            return HIVE_DEFAULT_DYNAMIC_PARTITION;\n+        }\n+        else if (type instanceof CharType) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2NTYwNQ==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r472465605", "bodyText": "Make sure to remove later", "author": "electrum", "createdAt": "2020-08-18T20:22:48Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/HiveQueryRunner.java", "diffHunk": "@@ -297,5 +296,21 @@ public static void main(String[] args)\n         Thread.sleep(10);\n         log.info(\"======== SERVER STARTED ========\");\n         log.info(\"\\n====\\n%s\\n====\", queryRunner.getCoordinator().getBaseUrl());\n+\n+        Session session = createSession(Optional.empty());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1MzEwNA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474953104", "bodyText": "oh shoot, yes, done", "author": "rash67", "createdAt": "2020-08-21T20:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2NTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5MTI3NA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474191274", "bodyText": "It looks like this method signature didn't change, so keep the original formatting for the arguments.", "author": "electrum", "createdAt": "2020-08-20T18:34:56Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePartitionManager.java", "diffHunk": "@@ -266,70 +241,17 @@ public static boolean partitionMatches(List<HiveColumnHandle> partitionColumns,\n         return true;\n     }\n \n-    private List<String> getFilteredPartitionNames(SemiTransactionalHiveMetastore metastore, HiveIdentity identity, SchemaTableName tableName, List<HiveColumnHandle> partitionKeys, TupleDomain<ColumnHandle> effectivePredicate)\n+    private List<String> getFilteredPartitionNames(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NTgyNQ==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474195825", "bodyText": "This seems to be missing something. Maybe remove all the @param and just explain what the method does.", "author": "electrum", "createdAt": "2020-08-20T18:43:01Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames\n+     * @param partitionKeysFilter\n+     * @param assumeCanonicalPartitionKeys allow conversion of", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NTk3Mw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474195973", "bodyText": "We avoid having empty/useless documentation for obvious parameters.", "author": "electrum", "createdAt": "2020-08-20T18:43:15Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3NDQ2Ng==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474874466", "bodyText": "my mistake, i left this half-finished", "author": "rash67", "createdAt": "2020-08-21T19:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NjQyMg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474196422", "bodyText": "Nit: wrap stream operations\nList x = stream()\n        .map(...)\n        .collect(...);", "author": "electrum", "createdAt": "2020-08-20T18:44:06Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames\n+     * @param partitionKeysFilter\n+     * @param assumeCanonicalPartitionKeys allow conversion of\n+     * @return the Domain for each partition key to either the wildcard or an equals check.\n+     * TupleDomain.none() or any column's Domain.isNone() -> Optional.empty()\n+     */\n+    public static Optional<List<String>> partitionKeyFilterToStringList(List<String> columnNames, TupleDomain<String> partitionKeysFilter, boolean assumeCanonicalPartitionKeys)\n+    {\n+        if (isPartitionKeyFilterFalse(partitionKeysFilter)) {\n+            return Optional.empty();\n+        }\n+\n+        checkArgument(partitionKeysFilter.getDomains().isPresent());\n+\n+        Map<String, Domain> domainMap = partitionKeysFilter.getDomains().orElse(ImmutableMap.of());\n+        List<String> partitionList = columnNames.stream().map(cn -> domainToString(domainMap.get(cn), assumeCanonicalPartitionKeys, HIVE_PARTITION_VALUE_WILDCARD)).collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3Njg0OA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474876848", "bodyText": "will do. i'll check my other uses of stream()", "author": "rash67", "createdAt": "2020-08-21T19:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NjQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NjkyNQ==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474196925", "bodyText": "Nit: else is redundant", "author": "electrum", "createdAt": "2020-08-20T18:44:58Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames\n+     * @param partitionKeysFilter\n+     * @param assumeCanonicalPartitionKeys allow conversion of\n+     * @return the Domain for each partition key to either the wildcard or an equals check.\n+     * TupleDomain.none() or any column's Domain.isNone() -> Optional.empty()\n+     */\n+    public static Optional<List<String>> partitionKeyFilterToStringList(List<String> columnNames, TupleDomain<String> partitionKeysFilter, boolean assumeCanonicalPartitionKeys)\n+    {\n+        if (isPartitionKeyFilterFalse(partitionKeysFilter)) {\n+            return Optional.empty();\n+        }\n+\n+        checkArgument(partitionKeysFilter.getDomains().isPresent());\n+\n+        Map<String, Domain> domainMap = partitionKeysFilter.getDomains().orElse(ImmutableMap.of());\n+        List<String> partitionList = columnNames.stream().map(cn -> domainToString(domainMap.get(cn), assumeCanonicalPartitionKeys, HIVE_PARTITION_VALUE_WILDCARD)).collect(toImmutableList());\n+        return Optional.of(partitionList);\n+    }\n+\n+    /**\n+     * @param domain - domain expression for the column. null => TupleDomain.all()\n+     * @param assumeCanonicalPartitionKeys\n+     * @param partitionWildcardString wildcard\n+     * @return string for scalar values\n+     */\n+    public static String domainToString(Domain domain, boolean assumeCanonicalPartitionKeys, String partitionWildcardString)\n+    {\n+        if (domain != null && domain.isNullableSingleValue()) {\n+            return sqlScalarToString(domain.getType(), domain.getNullableSingleValue(), assumeCanonicalPartitionKeys, partitionWildcardString);\n+        }\n+        else { // null or not a single value", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5OTQwNg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474199406", "bodyText": "Are we trying to preserve order? Does that matter?", "author": "electrum", "createdAt": "2020-08-20T18:49:36Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -290,4 +321,118 @@ public static PrincipalPrivileges buildInitialPrivilegeSet(String tableOwner)\n                         .build(),\n                 ImmutableMultimap.of());\n     }\n+\n+    public static boolean isPartitionKeyFilterFalse(TupleDomain<String> partitionKeysFilter)\n+    {\n+        return partitionKeysFilter.isNone() || partitionKeysFilter.getDomains().get().values().stream().anyMatch(Domain::isNone);\n+    }\n+\n+    /**\n+     * @param columnNames\n+     * @param partitionKeysFilter\n+     * @param assumeCanonicalPartitionKeys allow conversion of\n+     * @return the Domain for each partition key to either the wildcard or an equals check.\n+     * TupleDomain.none() or any column's Domain.isNone() -> Optional.empty()\n+     */\n+    public static Optional<List<String>> partitionKeyFilterToStringList(List<String> columnNames, TupleDomain<String> partitionKeysFilter, boolean assumeCanonicalPartitionKeys)\n+    {\n+        if (isPartitionKeyFilterFalse(partitionKeysFilter)) {\n+            return Optional.empty();\n+        }\n+\n+        checkArgument(partitionKeysFilter.getDomains().isPresent());\n+\n+        Map<String, Domain> domainMap = partitionKeysFilter.getDomains().orElse(ImmutableMap.of());\n+        List<String> partitionList = columnNames.stream().map(cn -> domainToString(domainMap.get(cn), assumeCanonicalPartitionKeys, HIVE_PARTITION_VALUE_WILDCARD)).collect(toImmutableList());\n+        return Optional.of(partitionList);\n+    }\n+\n+    /**\n+     * @param domain - domain expression for the column. null => TupleDomain.all()\n+     * @param assumeCanonicalPartitionKeys\n+     * @param partitionWildcardString wildcard\n+     * @return string for scalar values\n+     */\n+    public static String domainToString(Domain domain, boolean assumeCanonicalPartitionKeys, String partitionWildcardString)\n+    {\n+        if (domain != null && domain.isNullableSingleValue()) {\n+            return sqlScalarToString(domain.getType(), domain.getNullableSingleValue(), assumeCanonicalPartitionKeys, partitionWildcardString);\n+        }\n+        else { // null or not a single value\n+            return partitionWildcardString;\n+        }\n+    }\n+\n+    /**\n+     * @param type\n+     * @param value\n+     * @param assumeCanonicalPartitionKeys\n+     * @param partitionWildcardString\n+     * @return value converted a string format. Returns\n+     */\n+    public static String sqlScalarToString(Type type, Object value, boolean assumeCanonicalPartitionKeys, String partitionWildcardString)\n+    {\n+        if (value == null) {\n+            return HIVE_DEFAULT_DYNAMIC_PARTITION;\n+        }\n+        else if (type instanceof CharType) {\n+            Slice slice = (Slice) value;\n+            return padSpaces(slice, (CharType) type).toStringUtf8();\n+        }\n+        else if (type instanceof VarcharType) {\n+            Slice slice = (Slice) value;\n+            return slice.toStringUtf8();\n+        }\n+        else if (!assumeCanonicalPartitionKeys) {\n+            return partitionWildcardString;\n+        }\n+        else if (type instanceof DecimalType && !((DecimalType) type).isShort()) {\n+            Slice slice = (Slice) value;\n+            return Decimals.toString(slice, ((DecimalType) type).getScale());\n+        }\n+        else if (type instanceof DecimalType && ((DecimalType) type).isShort()) {\n+            return Decimals.toString((long) value, ((DecimalType) type).getScale());\n+        }\n+        else if (type instanceof DateType) {\n+            DateTimeFormatter dateTimeFormatter = ISODateTimeFormat.date().withZoneUTC();\n+            return dateTimeFormatter.print(TimeUnit.DAYS.toMillis((long) value));\n+        }\n+        else if (type instanceof TimestampType) {\n+            // we don't have time zone info, so just add a wildcard\n+            return partitionWildcardString;\n+        }\n+        else if (type instanceof TinyintType\n+                || type instanceof SmallintType\n+                || type instanceof IntegerType\n+                || type instanceof BigintType\n+                || type instanceof DoubleType\n+                || type instanceof RealType\n+                || type instanceof BooleanType) {\n+            return value.toString();\n+        }\n+        else {\n+            throw new PrestoException(NOT_SUPPORTED, format(\"Unsupported partition key type: %s\", type.getDisplayName()));\n+        }\n+    }\n+\n+    /**\n+     * This method creates a TupleDomain for each partitionKey specified\n+     *\n+     * @return filtered version of relevant Domains in effectivePredicate.\n+     */\n+    public static TupleDomain<String> computePartitionKeyFilter(List<HiveColumnHandle> partitionKeys, TupleDomain<ColumnHandle> effectivePredicate)\n+    {\n+        checkArgument(effectivePredicate.getDomains().isPresent());\n+\n+        Map<String, Domain> domains = new LinkedHashMap<>();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MDg5Nw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474940897", "bodyText": "i don't think this matters any more since I realized any column that was all() would be missing and any conversion of the TupleDomain would have an ordered list of the columns\nthis is a relic from when I assumed I could iterate on the underlying String -> Domain map and needed to produce my value list in order", "author": "rash67", "createdAt": "2020-08-21T20:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5OTQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwMTAzNA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474201034", "bodyText": "No need for requireNonNull since the . access will throw NPE anyway", "author": "electrum", "createdAt": "2020-08-20T18:52:42Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/alluxio/AlluxioHiveMetastore.java", "diffHunk": "@@ -66,12 +69,14 @@\n public class AlluxioHiveMetastore\n         implements HiveMetastore\n {\n+    private final boolean assumeCanonicalPartitionKeys;\n     private TableMasterClient client;\n \n     @Inject\n-    public AlluxioHiveMetastore(TableMasterClient client)\n+    public AlluxioHiveMetastore(TableMasterClient client, AlluxioHiveMetastoreConfig metastoreConfig)\n     {\n         this.client = requireNonNull(client);\n+        this.assumeCanonicalPartitionKeys = requireNonNull(metastoreConfig).isAssumeCanonicalPartitionKeys();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MjUyMA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474942520", "bodyText": "ah good point", "author": "rash67", "createdAt": "2020-08-21T20:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwMTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MjczMA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474362730", "bodyText": "We shouldn't need the assumeCanonicalPartitionKeys config or filtering here at all, as filtering by the metastore is best effort. This isn't being pushed down, so we can let the caller do it.", "author": "electrum", "createdAt": "2020-08-21T01:47:56Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -990,11 +994,24 @@ private boolean isValidPartition(Table table, String partitionName)\n     }\n \n     @Override\n-    public synchronized Optional<List<String>> getPartitionNamesByParts(HiveIdentity identity, String databaseName, String tableName, List<String> parts)\n+    public Optional<List<String>> getPartitionNamesByFilter(\n+            HiveIdentity identity,\n+            String databaseName,\n+            String tableName,\n+            List<String> columnNames,\n+            TupleDomain<String> partitionKeysFilter)\n     {\n-        // todo this should be more efficient by selectively walking the directory tree\n-        return getPartitionNames(identity, databaseName, tableName).map(partitionNames -> partitionNames.stream()\n-                .filter(partitionName -> partitionMatches(partitionName, parts))\n+        if (partitionKeysFilter.isNone()) {\n+            return Optional.of(ImmutableList.of());\n+        }\n+        Optional<List<String>> parts = partitionKeyFilterToStringList(columnNames, partitionKeysFilter, assumeCanonicalPartitionKeys);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0OTExNg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474949116", "bodyText": "I'm not sure I follow. previously, this information was indeed used by the caller to generate a List<String> parts that included the information. it would be a \"regression\" in the sense the caller would get a larger list.\nare you saying just pass false and let the caller deal with it to avoid having this config for AlluxioHiveMetastore ?\nthe Glue and Thrift impls will still need it", "author": "rash67", "createdAt": "2020-08-21T20:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MjczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDQyNw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r475020427", "bodyText": "talked on slack and i get this, i've made the change", "author": "rash67", "createdAt": "2020-08-22T00:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MjczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI3MzU1NA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r475273554", "bodyText": "isn't assumeCanonicalPartitionKeys applicable to some metastores and not the others  -- eg depending whether the call is over string representation or interpreted values?\nfor example it may turn out to be HMS- (and file-?) metastore specific?", "author": "findepi", "createdAt": "2020-08-23T22:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MjczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MzU5Mw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474363593", "bodyText": "Should we drop the getPartitionNames() method from the ThriftMetastore interface? Then this can be a straight delegation.", "author": "electrum", "createdAt": "2020-08-21T01:51:23Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/BridgingHiveMetastore.java", "diffHunk": "@@ -319,15 +321,22 @@ private void alterTable(HiveIdentity identity, String databaseName, String table\n     }\n \n     @Override\n-    public Optional<List<String>> getPartitionNames(HiveIdentity identity, String databaseName, String tableName)\n+    public Optional<List<String>> getPartitionNamesByFilter(\n+            HiveIdentity identity,\n+            String databaseName,\n+            String tableName,\n+            List<String> columnNames,\n+            TupleDomain<String> partitionKeysFilter)\n     {\n-        return delegate.getPartitionNames(identity, databaseName, tableName);\n-    }\n+        if (partitionKeysFilter.isNone()) {\n+            return Optional.of(ImmutableList.of());\n+        }\n \n-    @Override\n-    public Optional<List<String>> getPartitionNamesByParts(HiveIdentity identity, String databaseName, String tableName, List<String> parts)\n-    {\n-        return delegate.getPartitionNamesByParts(identity, databaseName, tableName, parts);\n+        if (partitionKeysFilter.isAll()) {\n+            return delegate.getPartitionNames(identity, databaseName, tableName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1MDQwOA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474950408", "bodyText": "I thought about this, but I didn't know what to pass to thrift to say \"all\". This should, in theory, be just TupleDomain.all(), but i hit some snags\ni can look at it again", "author": "rash67", "createdAt": "2020-08-21T20:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MzU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDUxNw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r475020517", "bodyText": "I made this change and I'm waiting for a new CI (pushed right now) to run to verify that my translation of TupleDomain.all() to a list of \"\" works. it should as this was the previous behavior.", "author": "rash67", "createdAt": "2020-08-22T00:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MzU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MzQ0Mg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r475153442", "bodyText": "I removed this and what happens is that once it's down to the thrift API, it seems like any value for a partitionKey in the 'parts' api that is \"\" (our wildcard value) gets removed. the parts api then fails when the list is empty\nwe might be able to solve this when we translate it to an expression, but for now, i think i need to restore the previous special case", "author": "rash67", "createdAt": "2020-08-23T00:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MzU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5Mjc4Mw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474792783", "bodyText": "\"this\" means what here?", "author": "findepi", "createdAt": "2020-08-21T16:09:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/SemiTransactionalHiveMetastore.java", "diffHunk": "@@ -635,34 +652,17 @@ public synchronized void truncateUnpartitionedTable(ConnectorSession session, St\n         }\n         // add newly-added partitions to the results from underlying metastore\n         if (!partitionActionsOfTable.isEmpty()) {\n-            List<String> columnNames = table.get().getPartitionColumns().stream().map(Column::getName).collect(Collectors.toList());\n+            // the top of the function guards against TupleDomain.none() so this cannot be empty", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MTQ5NA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r474941494", "bodyText": "removing this comment, holdover from when this still did filtering. it referred to the columnNames\nI'll remove the comment", "author": "rash67", "createdAt": "2020-08-21T20:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5Mjc4Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY4ODQzMw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477688433", "bodyText": "Remove blank line before Javadoc", "author": "electrum", "createdAt": "2020-08-26T23:39:35Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/HiveMetastore.java", "diffHunk": "@@ -85,9 +86,18 @@\n \n     Optional<Partition> getPartition(HiveIdentity identity, Table table, List<String> partitionValues);\n \n-    Optional<List<String>> getPartitionNames(HiveIdentity identity, String databaseName, String tableName);\n+    /**\n+     * return a list of partition names where partitionKeysFilter is used as a hint to each implementation.\n+     *\n+     * @param databaseName the name of the database\n+     * @param tableName the name of the table\n+     * @param columnNames the list of partition column names\n+     * @param partitionKeysFilter map of filters (Domain) for each partition column\n+     * @return optionally, a list of strings where each entry is in the form of {key}={value}\n+     * @see TupleDomain\n+     */\n ", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY4OTc0OA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477689748", "bodyText": "We can remove all this client side filtering here since it's only a hint. So I think the whole method can be\nreturn ProtoUtils.toPartitionInfoList(\n        client.readTable(databaseName, tableName, Constraint.getDefaultInstance()));", "author": "electrum", "createdAt": "2020-08-26T23:40:25Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/alluxio/AlluxioHiveMetastore.java", "diffHunk": "@@ -335,23 +338,22 @@ public void dropColumn(HiveIdentity identity, String databaseName, String tableN\n     }\n \n     @Override\n-    public Optional<List<String>> getPartitionNames(HiveIdentity identity, String databaseName, String tableName)\n+    public Optional<List<String>> getPartitionNamesByFilter(\n+            HiveIdentity identity,\n+            String databaseName,\n+            String tableName,\n+            List<String> columnNames,\n+            TupleDomain<String> partitionKeysFilter)\n     {\n-        throw new PrestoException(NOT_SUPPORTED, \"getPartitionNames\");\n-    }\n+        if (partitionKeysFilter.isNone()) {\n+            return Optional.of(Collections.emptyList());\n+        }\n+        Optional<List<String>> optionalParts = partitionKeyFilterToStringList(columnNames, partitionKeysFilter, false);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcwNzY4MA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477707680", "bodyText": "got it. it looks like I need a mapping of PartitionInfo::getPartitionName as well", "author": "rash67", "createdAt": "2020-08-26T23:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY4OTc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5MTU1Nw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477691557", "bodyText": "The config is not needed", "author": "electrum", "createdAt": "2020-08-26T23:41:39Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/alluxio/AlluxioHiveMetastore.java", "diffHunk": "@@ -69,7 +72,7 @@\n     private TableMasterClient client;\n \n     @Inject\n-    public AlluxioHiveMetastore(TableMasterClient client)\n+    public AlluxioHiveMetastore(TableMasterClient client, AlluxioHiveMetastoreConfig metastoreConfig)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5MjAwNg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477692006", "bodyText": "Move to io.prestosql.plugin.hive.util package", "author": "electrum", "createdAt": "2020-08-26T23:41:57Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/spi/block/HiveBlockEncodingSerde.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.spi.block;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5MjQwMw==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477692403", "bodyText": "Remove the second sentence as it doesn't really fit here", "author": "electrum", "createdAt": "2020-08-26T23:42:15Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/spi/block/HiveBlockEncodingSerde.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.spi.block;\n+\n+import io.airlift.slice.SliceInput;\n+import io.airlift.slice.SliceOutput;\n+import io.prestosql.spi.block.ArrayBlockEncoding;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.block.BlockEncoding;\n+import io.prestosql.spi.block.BlockEncodingSerde;\n+import io.prestosql.spi.block.ByteArrayBlockEncoding;\n+import io.prestosql.spi.block.DictionaryBlockEncoding;\n+import io.prestosql.spi.block.Int128ArrayBlockEncoding;\n+import io.prestosql.spi.block.IntArrayBlockEncoding;\n+import io.prestosql.spi.block.LazyBlockEncoding;\n+import io.prestosql.spi.block.LongArrayBlockEncoding;\n+import io.prestosql.spi.block.RowBlockEncoding;\n+import io.prestosql.spi.block.RunLengthBlockEncoding;\n+import io.prestosql.spi.block.ShortArrayBlockEncoding;\n+import io.prestosql.spi.block.SingleRowBlockEncoding;\n+import io.prestosql.spi.block.VariableWidthBlockEncoding;\n+\n+import javax.inject.Inject;\n+\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+// This class is exactly the same as BlockEncodingManager. They are in SPI and don't have access to InternalBlockEncodingSerde.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcwOTg5Mg==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477709892", "bodyText": "i thought i did these, will update", "author": "rash67", "createdAt": "2020-08-26T23:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5MjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5Mzc0OQ==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477693749", "bodyText": "Remove the printing. Probably add an assertion or remove the entire test method.", "author": "electrum", "createdAt": "2020-08-26T23:43:12Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/TestMetastoreUtil.java", "diffHunk": "@@ -153,4 +156,12 @@ public void testHiveSchemaPartition()\n         Properties actual = MetastoreUtil.getHiveSchema(ThriftMetastoreUtil.fromMetastoreApiPartition(TEST_PARTITION_WITH_UNSUPPORTED_FIELDS), ThriftMetastoreUtil.fromMetastoreApiTable(TEST_TABLE_WITH_UNSUPPORTED_FIELDS, TEST_SCHEMA));\n         assertEquals(actual, expected);\n     }\n+\n+    @Test\n+    public void testTupleDomainToString()\n+            throws Exception\n+    {\n+        Optional<List<String>> ds = MetastoreUtil.partitionKeyFilterToStringList(Arrays.asList(\"ds1\", \"ds2\", \"ds3\"), TupleDomain.all(), false);\n+        System.err.println(ds.get());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcxMDIxMA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r477710210", "bodyText": "oops again, yea i'll assert or remove it", "author": "rash67", "createdAt": "2020-08-26T23:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY5Mzc0OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "43843b2499bfe6d6245df51efd4bf82f54db424e", "url": "https://github.com/trinodb/trino/commit/43843b2499bfe6d6245df51efd4bf82f54db424e", "message": "Refactor HiveMetastore API and Implementations\n\nThis commit changes the HiveMetastore API to remove methods to methods\ngetPartionNames() and getPartitionNamesByParts() and replace with\ngetPartitionNamesByFilter(). Each implementation is updated as well as\nall callsites. The previous behavior is maintained as far as\ntranslation of any non-equal Domain values to the wildcard value.\nA subsequent commit will implement translation of a Domain into a\nproper Glue expression for the GlueHiveMetastore GetPartitions API in\nthe Glue Data Catalog.", "committedDate": "2020-08-27T01:22:21Z", "type": "commit"}, {"oid": "43843b2499bfe6d6245df51efd4bf82f54db424e", "url": "https://github.com/trinodb/trino/commit/43843b2499bfe6d6245df51efd4bf82f54db424e", "message": "Refactor HiveMetastore API and Implementations\n\nThis commit changes the HiveMetastore API to remove methods to methods\ngetPartionNames() and getPartitionNamesByParts() and replace with\ngetPartitionNamesByFilter(). Each implementation is updated as well as\nall callsites. The previous behavior is maintained as far as\ntranslation of any non-equal Domain values to the wildcard value.\nA subsequent commit will implement translation of a Domain into a\nproper Glue expression for the GlueHiveMetastore GetPartitions API in\nthe Glue Data Catalog.", "committedDate": "2020-08-27T01:22:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3Nzg4OA==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r507677888", "bodyText": "the \"getPartitionNamesByParts\", stats.getGetPartitionNamesByParts()... above should be renamed too.", "author": "findepi", "createdAt": "2020-10-19T11:39:26Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftHiveMetastore.java", "diffHunk": "@@ -1141,39 +1146,31 @@ public void alterTable(HiveIdentity identity, String databaseName, String tableN\n     }\n \n     @Override\n-    public Optional<List<String>> getPartitionNames(HiveIdentity identity, String databaseName, String tableName)\n+    public Optional<List<String>> getPartitionNamesByFilter(HiveIdentity identity, String databaseName, String tableName, List<String> columnNames, TupleDomain<String> partitionKeysFilter)\n     {\n-        try {\n-            return retry()\n-                    .stopOn(NoSuchObjectException.class)\n-                    .stopOnIllegalExceptions()\n-                    .run(\"getPartitionNames\", stats.getGetPartitionNames().wrap(() -> {\n-                        try (ThriftMetastoreClient client = createMetastoreClient(identity)) {\n-                            return Optional.of(client.getPartitionNames(databaseName, tableName));\n-                        }\n-                    }));\n-        }\n-        catch (NoSuchObjectException e) {\n-            return Optional.empty();\n-        }\n-        catch (TException e) {\n-            throw new PrestoException(HIVE_METASTORE_ERROR, e);\n-        }\n-        catch (Exception e) {\n-            throw propagate(e);\n+        Optional<List<String>> parts = partitionKeyFilterToStringList(columnNames, partitionKeysFilter, assumeCanonicalPartitionKeys);\n+        Preconditions.checkArgument(!columnNames.isEmpty() || partitionKeysFilter.isAll(), \"must pass in all columnNames or the filter must be all\");\n+        if (parts.isEmpty()) {\n+            return Optional.of(ImmutableList.of());\n         }\n-    }\n \n-    @Override\n-    public Optional<List<String>> getPartitionNamesByParts(HiveIdentity identity, String databaseName, String tableName, List<String> parts)\n-    {\n         try {\n+            if (partitionKeysFilter.isAll()) {\n+                return retry()\n+                        .stopOn(NoSuchObjectException.class)\n+                        .stopOnIllegalExceptions()\n+                        .run(\"getPartitionNames\", stats.getGetPartitionNames().wrap(() -> {\n+                            try (ThriftMetastoreClient client = createMetastoreClient(identity)) {\n+                                return Optional.of(client.getPartitionNames(databaseName, tableName));\n+                            }\n+                        }));\n+            }\n             return retry()\n                     .stopOn(NoSuchObjectException.class)\n                     .stopOnIllegalExceptions()\n                     .run(\"getPartitionNamesByParts\", stats.getGetPartitionNamesByParts().wrap(() -> {\n                         try (ThriftMetastoreClient client = createMetastoreClient(identity)) {\n-                            return Optional.of(client.getPartitionNamesFiltered(databaseName, tableName, parts));\n+                            return Optional.of(client.getPartitionNamesFiltered(databaseName, tableName, parts.get()));", "originalCommit": "43843b2499bfe6d6245df51efd4bf82f54db424e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3ODM5OQ==", "url": "https://github.com/trinodb/trino/pull/4748#discussion_r507678399", "bodyText": "nvrm, i see this is pre-existing... still worth updating", "author": "findepi", "createdAt": "2020-10-19T11:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3Nzg4OA=="}], "type": "inlineReview"}]}