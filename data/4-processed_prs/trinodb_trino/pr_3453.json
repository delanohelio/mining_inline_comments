{"pr_number": 3453, "pr_title": "Support case insensitive identifiers in MongoDB", "pr_createdAt": "2020-04-16T11:56:39Z", "pr_url": "https://github.com/trinodb/trino/pull/3453", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MjYyMw==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r418942623", "bodyText": "Please extract refactoring (\"Make table wider\") to a preparatory commit", "author": "findepi", "createdAt": "2020-05-02T10:40:59Z", "path": "presto-docs/src/main/sphinx/connector/mongodb.rst", "diffHunk": "@@ -34,24 +34,25 @@ Configuration Properties\n \n The following configuration properties are available:\n \n-===================================== ==============================================================\n-Property Name                         Description\n-===================================== ==============================================================\n-``mongodb.seeds``                     List of all MongoDB servers\n-``mongodb.schema-collection``         A collection which contains schema information\n-``mongodb.credentials``               List of credentials\n-``mongodb.min-connections-per-host``  The minimum size of the connection pool per host\n-``mongodb.connections-per-host``      The maximum size of the connection pool per host\n-``mongodb.max-wait-time``             The maximum wait time\n-``mongodb.connection-timeout``        The socket connect timeout\n-``mongodb.socket-timeout``            The socket timeout\n-``mongodb.socket-keep-alive``         Whether keep-alive is enabled on each socket\n-``mongodb.ssl.enabled``               Use TLS/SSL for connections to mongod/mongos\n-``mongodb.read-preference``           The read preference\n-``mongodb.write-concern``             The write concern\n-``mongodb.required-replica-set``      The required replica set name\n-``mongodb.cursor-batch-size``         The number of elements to return in a batch\n-===================================== ==============================================================\n+========================================== ==============================================================\n+Property Name                              Description\n+========================================== ==============================================================\n+``mongodb.seeds``                          List of all MongoDB servers", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0Mjc1Nw==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r418942757", "bodyText": "How expensive is this? how often is it called during planing of a query?\n(in JDBC we have caching for this, so question, if we need one here)", "author": "findepi", "createdAt": "2020-05-02T10:42:35Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -606,6 +611,32 @@ else if (value instanceof Document) {\n         return Optional.ofNullable(typeSignature);\n     }\n \n+    private String toRemoteSchemaName(String schemaName)\n+    {\n+        if (!caseInsensitiveNameMatching) {\n+            return schemaName;\n+        }\n+        for (String remoteSchemaName : client.listDatabaseNames()) {\n+            if (schemaName.equals(remoteSchemaName.toLowerCase(ENGLISH))) {\n+                return remoteSchemaName;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAyOTEwNQ==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419029105", "bodyText": "The first attempt is 3 times and subsequent attempts are only once.\nFinding the last schema takes:\n\n~70 msec / 1,000 schemas\n~700 msec / 10,000 schemas", "author": "ebyhr", "createdAt": "2020-05-03T01:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0Mjc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0Mjg0Mw==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r418942843", "bodyText": "How expensive is this? how often is it called during planing of a query?\n(in JDBC we have caching for this, so question, if we need one here)", "author": "findepi", "createdAt": "2020-05-02T10:43:33Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -606,6 +611,32 @@ else if (value instanceof Document) {\n         return Optional.ofNullable(typeSignature);\n     }\n \n+    private String toRemoteSchemaName(String schemaName)\n+    {\n+        if (!caseInsensitiveNameMatching) {\n+            return schemaName;\n+        }\n+        for (String remoteSchemaName : client.listDatabaseNames()) {\n+            if (schemaName.equals(remoteSchemaName.toLowerCase(ENGLISH))) {\n+                return remoteSchemaName;\n+            }\n+        }\n+        return schemaName;\n+    }\n+\n+    private String toRemoteTableName(String schemaName, String tableName)\n+    {\n+        if (!caseInsensitiveNameMatching) {\n+            return tableName;\n+        }\n+        for (String remoteTableName : client.getDatabase(schemaName).listCollectionNames()) {\n+            if (tableName.equals(remoteTableName.toLowerCase(ENGLISH))) {\n+                return remoteTableName;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAyOTEwOA==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419029108", "bodyText": "The first attempt is 3 times and subsequent attempts are only once.\nFinding the last table takes:\n\n~30 msec / 1,000 tables\n~300 msec / 10,000 tables", "author": "ebyhr", "createdAt": "2020-05-03T01:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0Mjg0Mw=="}], "type": "inlineReview"}, {"oid": "09675b90fc81be835b0ee0369c25ad8326069232", "url": "https://github.com/trinodb/trino/commit/09675b90fc81be835b0ee0369c25ad8326069232", "message": "Make table wider in MongoDB document", "committedDate": "2020-05-02T14:34:53Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419329801", "bodyText": "ImmutableList.copyOf is redundant", "author": "findepi", "createdAt": "2020-05-04T10:00:37Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -141,15 +144,18 @@ public void shutdown()\n \n     public List<String> getAllSchemas()\n     {\n-        return ImmutableList.copyOf(client.listDatabaseNames());\n+        return ImmutableList.copyOf(client.listDatabaseNames()).stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0NzYzNg==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419447636", "bodyText": "client.listDatabaseNames() returns MongoIterable<String> (\u2260List<String>).", "author": "ebyhr", "createdAt": "2020-05-04T13:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUwMDQ5NQ==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419500495", "bodyText": "you have ImmutableList.copyOf and collect(toImmutableList())", "author": "findepi", "createdAt": "2020-05-04T14:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzNzk3Mw==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419837973", "bodyText": "Replaced with toList(). Please let me know if my understanding is wrong.", "author": "ebyhr", "createdAt": "2020-05-05T02:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNTc0OA==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r471325748", "bodyText": "Was this change saved? I still see collect(toImmutableList())", "author": "sajjoseph", "createdAt": "2020-08-17T08:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyODczNA==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r471328734", "bodyText": "@sajjoseph Though I'm not sure about the intention of your question, collect(toImmutableList()) is the expected code. There was conversation on Slack.", "author": "ebyhr", "createdAt": "2020-08-17T08:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM2Mzk2OA==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r471363968", "bodyText": "Thanks @ebyhr . I am referring to your comment earlier where you said that you replaced with toList(). I don't see that change.", "author": "sajjoseph", "createdAt": "2020-08-17T09:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyOTgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzMDkxNQ==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419330915", "bodyText": "add\nverify(schemaName.equals(schemaName.toLowerCase(ENGLISH)), \"schemaName not in lower-case: %s\", schemaName);\n\nat the top of the method", "author": "findepi", "createdAt": "2020-05-04T10:02:57Z", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoSession.java", "diffHunk": "@@ -606,6 +611,32 @@ else if (value instanceof Document) {\n         return Optional.ofNullable(typeSignature);\n     }\n \n+    private String toRemoteSchemaName(String schemaName)\n+    {\n+        if (!caseInsensitiveNameMatching) {\n+            return schemaName;\n+        }\n+        for (String remoteSchemaName : client.listDatabaseNames()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzMTA2Mg==", "url": "https://github.com/trinodb/trino/pull/3453#discussion_r419331062", "bodyText": "same in the table mapping method", "author": "findepi", "createdAt": "2020-05-04T10:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzMDkxNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "b0cd70ae37f8836c15296232721744c055f34535", "url": "https://github.com/trinodb/trino/commit/b0cd70ae37f8836c15296232721744c055f34535", "message": "Support case insensitive identifiers in MongoDB", "committedDate": "2020-05-05T09:18:52Z", "type": "commit"}, {"oid": "b0cd70ae37f8836c15296232721744c055f34535", "url": "https://github.com/trinodb/trino/commit/b0cd70ae37f8836c15296232721744c055f34535", "message": "Support case insensitive identifiers in MongoDB", "committedDate": "2020-05-05T09:18:52Z", "type": "forcePushed"}]}