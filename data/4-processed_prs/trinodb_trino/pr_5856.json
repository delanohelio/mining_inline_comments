{"pr_number": 5856, "pr_title": "Add data compression property to SQL Server tables", "pr_createdAt": "2020-11-06T12:55:12Z", "pr_url": "https://github.com/trinodb/trino/pull/5856", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0NzAzNg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r518747036", "bodyText": "The overridable method should get TableMetadata.\nWe should assume the table properties are translated into single contigyous string", "author": "findepi", "createdAt": "2020-11-06T13:22:19Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -492,9 +492,9 @@ protected JdbcOutputTableHandle createTable(ConnectorSession session, ConnectorT\n         }\n     }\n \n-    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns)\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, String tableProperties)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0NzA1NA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r518747054", "bodyText": "remove", "author": "findepi", "createdAt": "2020-11-06T13:22:22Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -509,6 +509,11 @@ protected String getColumnDefinitionSql(ConnectorSession session, ColumnMetadata\n         return sb.toString();\n     }\n \n+    protected String getTableProperties(ConnectorTableMetadata tableMetadata)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxNjA3Ng==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r521916076", "bodyText": "copyright", "author": "kokosing", "createdAt": "2020-11-12T08:21:03Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/DataCompression.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package io.prestosql.plugin.sqlserver;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r521918597", "bodyText": "How about verifying if all partitions have this enabled. If so you can set it to true, if all have disabled then false, otherwise you can return null. Do you think this is expensive to query sys.partitions?", "author": "kokosing", "createdAt": "2020-11-12T08:23:20Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +324,27 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_\" + randomTableSuffix();\n+        assertUpdate(format(\"CREATE TABLE %s (a BIGINT, b BIGINT) WITH (DATA_COMPRESSION = '%s')\", tableName, dataCompression));\n+        // Compression can be applied per partition so we might not be able to capture them in `SHOW CREATE TABLE`.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAwNjA4MA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522006080", "bodyText": "SQL Server connector is not aware of underlying partitioning. Why do we care in this case?", "author": "findepi", "createdAt": "2020-11-12T10:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAxMzUxMA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522013510", "bodyText": "I am thinking from Presto perspective, there is a table property that can be set via CREATE TABLE but SHOW CREATE TABLE is not returning it. Looks strange.", "author": "kokosing", "createdAt": "2020-11-12T10:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzMjM0MQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522032341", "bodyText": "i agree with this.\nbtw\nwhat will happen if a new partition is added on sql server side?\nwill it implicitly copy compression attribute from some other partiiton?\notherwise, the \"table property\" can appear \"unset\"...", "author": "findepi", "createdAt": "2020-11-12T11:22:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwMzI5Mg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522103292", "bodyText": "I think it will refer to the compression type specified when creating a table", "author": "Praveen2112", "createdAt": "2020-11-12T13:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0OTExMA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522349110", "bodyText": "what will happen if a new partition is added on sql server side?\n\nWe should not care as long querying sys.partitions is a source of truth.", "author": "kokosing", "createdAt": "2020-11-12T19:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3OTk2Mw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522379963", "bodyText": "I think it will refer to the compression type specified when creating a table\n\nwhere is it stored on sql server side?", "author": "findepi", "createdAt": "2020-11-12T19:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MjA2Mg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522382062", "bodyText": "Can you add an explicit test for SHOW CREATE TABLE output?", "author": "findepi", "createdAt": "2020-11-12T19:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxODU5Nw=="}], "type": "inlineReview"}, {"oid": "ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "url": "https://github.com/trinodb/trino/commit/ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "message": "Add data compression property to SQL Server tables", "committedDate": "2020-11-12T10:46:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MDk2Nw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522380967", "bodyText": "testWithDataCompression -> testCreateWithDataCompression", "author": "findepi", "createdAt": "2020-11-12T19:52:30Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +324,27 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testWithDataCompression(DataCompression dataCompression)", "originalCommit": "ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MDk4OA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522380988", "bodyText": "test_create_ -> test_create_with_compression", "author": "findepi", "createdAt": "2020-11-12T19:52:31Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +324,27 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_\" + randomTableSuffix();", "originalCommit": "ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MTM1NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522381355", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertUpdate(format(\"CREATE TABLE %s (a BIGINT, b BIGINT) WITH (DATA_COMPRESSION = '%s')\", tableName, dataCompression));\n          \n          \n            \n                    assertUpdate(format(\"CREATE TABLE %s (a bigint, b bigint) WITH (DATA_COMPRESSION = '%s')\", tableName, dataCompression));", "author": "findepi", "createdAt": "2020-11-12T19:53:14Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +324,27 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_\" + randomTableSuffix();\n+        assertUpdate(format(\"CREATE TABLE %s (a BIGINT, b BIGINT) WITH (DATA_COMPRESSION = '%s')\", tableName, dataCompression));", "originalCommit": "ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MTQ3NA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r522381474", "bodyText": "drop the table too", "author": "findepi", "createdAt": "2020-11-12T19:53:29Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +324,27 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_\" + randomTableSuffix();\n+        assertUpdate(format(\"CREATE TABLE %s (a BIGINT, b BIGINT) WITH (DATA_COMPRESSION = '%s')\", tableName, dataCompression));\n+        // Compression can be applied per partition so we might not be able to capture them in `SHOW CREATE TABLE`.\n+        assertQuery(\n+                format(\"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id WHERE t.name = '%s'\", tableName),\n+                format(\"VALUES '%s'\", dataCompression));\n+    }", "originalCommit": "ccf44c35f439ffa2c0d1a9d58ce67b0fa63b633c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3MjkyMQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524172921", "bodyText": "add\ncheckArgument(tableMetadata.getProperties().isEmpty(), \"Unsupported table properties: %s\", tableMetadata.getProperties());", "author": "findepi", "createdAt": "2020-11-16T11:45:23Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -492,7 +492,7 @@ protected JdbcOutputTableHandle createTable(ConnectorSession session, ConnectorT\n         }\n     }\n \n-    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns)\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns,  ConnectorTableMetadata tableMetadata)", "originalCommit": "5203622f3b35d818be7e72f3e795cb8e6e34a8b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3OTU4NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524179585", "bodyText": "This is correct because currently SQL Server does not seem to support enabling table compression by default for a schema or database. However, they can add in the future.\nTherefore today NONE is a good default, but can become a wrong choice without a code change on our part.\nLet's replace NONE with UNSET (or DEFAULT). Then do not add WITH (DATA_COMPRESSION clause when compression is the UNSET.\ncc @kokosing", "author": "findepi", "createdAt": "2020-11-16T11:51:28Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -233,6 +240,32 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\"CREATE TABLE %s (%s) WITH (DATA_COMPRESSION = %s)\", quoted(remoteTableName), join(\", \", columns), getDataCompression(tableMetadata.getProperties()));", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyOTgzMg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524229832", "bodyText": "Correct me if I am wrong, NONE means no compression.\n\nLet's replace NONE with UNSET (or DEFAULT). Then do not add WITH (DATA_COMPRESSION clause when compression is the UNSET.\n\nLet's implement UNSET by not setting property value, so let's make it nullable and when it is null we should just use sql server system default behaviour.", "author": "kokosing", "createdAt": "2020-11-16T12:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3OTU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMDY2MA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524230660", "bodyText": "But when we run SHOW CREATE TABLE for any table from SQLServer we won't be able to capture the UNSET/DEFAULT rather we get only NONE. How can we handle in that situation ?", "author": "Praveen2112", "createdAt": "2020-11-16T12:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3OTU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4MjkzOQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524182939", "bodyText": "This is not safe. Should SQL Server add new compression mode (say, \"BLOCK\"), we don't want to fail the method here. I'd rather return no property.\nalso, is there a test ensuring SHOW CREATE TABLE doesn't return unnecessary data_compression property for all tables now?", "author": "findepi", "createdAt": "2020-11-16T11:54:32Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -233,6 +240,32 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\"CREATE TABLE %s (%s) WITH (DATA_COMPRESSION = %s)\", quoted(remoteTableName), join(\", \", columns), getDataCompression(tableMetadata.getProperties()));\n+    }\n+\n+    @Override\n+    public Map<String, Object> getTableProperties(JdbcIdentity identity, JdbcTableHandle tableHandle)\n+    {\n+        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+\n+        try (Connection connection = connectionFactory.openConnection(identity);\n+                PreparedStatement statement = connection.prepareStatement(\"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id WHERE p.partition_number = 1 AND t.name = ?\")) {\n+            statement.setString(1, tableHandle.getRemoteTableName().getTableName());\n+            try (ResultSet resultSet = statement.executeQuery()) {\n+                if (resultSet.next()) {\n+                    builder.put(DATA_COMPRESSION, DataCompression.valueOf(resultSet.getString(1)));", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyNjkxNw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524226917", "bodyText": "is there a test ensuring SHOW CREATE TABLE doesn't return unnecessary data_compression property for all tables now\n\nThat property will now be added. I think we should skip it when it is value is unknown (null), when it differs among paritions.", "author": "kokosing", "createdAt": "2020-11-16T12:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4MjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4MzkwOA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524183908", "bodyText": "what if we get two rows? validate & fail in such a case, this means our query is wrong\nverify(!resultSet.next(), \"Unexpected second result row\");", "author": "findepi", "createdAt": "2020-11-16T11:55:26Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -233,6 +240,32 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\"CREATE TABLE %s (%s) WITH (DATA_COMPRESSION = %s)\", quoted(remoteTableName), join(\", \", columns), getDataCompression(tableMetadata.getProperties()));\n+    }\n+\n+    @Override\n+    public Map<String, Object> getTableProperties(JdbcIdentity identity, JdbcTableHandle tableHandle)\n+    {\n+        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+\n+        try (Connection connection = connectionFactory.openConnection(identity);\n+                PreparedStatement statement = connection.prepareStatement(\"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id WHERE p.partition_number = 1 AND t.name = ?\")) {\n+            statement.setString(1, tableHandle.getRemoteTableName().getTableName());\n+            try (ResultSet resultSet = statement.executeQuery()) {\n+                if (resultSet.next()) {", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NTI1Nw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524185257", "bodyText": "As you explained to me offline, the SQL Server treats table with single partition as an unpartitioned table.\nIs there a guarantee that the only partition will have partition_number=1?\nAlso, in case of a partitioned table, we should not return compression info from the first partition.", "author": "findepi", "createdAt": "2020-11-16T11:56:42Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -233,6 +240,32 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\"CREATE TABLE %s (%s) WITH (DATA_COMPRESSION = %s)\", quoted(remoteTableName), join(\", \", columns), getDataCompression(tableMetadata.getProperties()));\n+    }\n+\n+    @Override\n+    public Map<String, Object> getTableProperties(JdbcIdentity identity, JdbcTableHandle tableHandle)\n+    {\n+        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+\n+        try (Connection connection = connectionFactory.openConnection(identity);\n+                PreparedStatement statement = connection.prepareStatement(\"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id WHERE p.partition_number = 1 AND t.name = ?\")) {", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjk5NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524232995", "bodyText": "From their documentation it looks like they set partition_number as 1 for non-partitioned tables.\nRef : https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-partitions-transact-sql?view=sql-server-ver15", "author": "Praveen2112", "createdAt": "2020-11-16T12:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MDExNw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524270117", "bodyText": "This answers the first question.", "author": "findepi", "createdAt": "2020-11-16T13:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NTI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMDgwMg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544120802", "bodyText": "From their docs it looks like 1 is used only for non-partitioned tables", "author": "Praveen2112", "createdAt": "2020-12-16T08:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NjU5OQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524186599", "bodyText": "Wonder why we need to specify the default twice -- above and here.", "author": "findepi", "createdAt": "2020-11-16T11:57:56Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerTableProperties.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.sqlserver;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.plugin.jdbc.TablePropertiesProvider;\n+import io.prestosql.spi.session.PropertyMetadata;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static io.prestosql.plugin.sqlserver.DataCompression.NONE;\n+import static io.prestosql.spi.session.PropertyMetadata.enumProperty;\n+\n+public class SqlServerTableProperties\n+        implements TablePropertiesProvider\n+{\n+    public static final String DATA_COMPRESSION = \"data_compression\";\n+\n+    private final List<PropertyMetadata<?>> tableProperties = ImmutableList.of(\n+            enumProperty(\n+                    DATA_COMPRESSION,\n+                    \"DataCompression type for table\",\n+                    DataCompression.class,\n+                    NONE,\n+                    false));\n+\n+    @Override\n+    public List<PropertyMetadata<?>> getTableProperties()\n+    {\n+        return tableProperties;\n+    }\n+\n+    public static DataCompression getDataCompression(Map<String, Object> tableProperties)\n+    {\n+        return (DataCompression) tableProperties.getOrDefault(DATA_COMPRESSION, NONE);", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4NzM4MQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524187381", "bodyText": "nit: i'd put this below the test method, but up to you", "author": "findepi", "createdAt": "2020-11-16T11:58:43Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +323,36 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyMjI0Mw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524222243", "bodyText": "you might want to replace multiple subsequent white characters in to a single space, then value of createQuery would be easier to maintain.", "author": "kokosing", "createdAt": "2020-11-16T12:31:50Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -317,6 +323,36 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testCreateWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_with_compression_\" + randomTableSuffix();\n+        String createQuery = format(\"CREATE TABLE sqlserver.dbo.%s (\\n\" +\n+                        \"   a bigint,\\n\" +\n+                        \"   b bigint\\n\" +\n+                        \")\\n\" +\n+                        \"WITH (\\n\" +\n+                        \"   data_compression = '%s'\\n\" +\n+                        \")\",\n+                tableName,\n+                dataCompression);\n+        assertUpdate(createQuery);\n+\n+        assertEquals(getQueryRunner().execute(\"SHOW CREATE TABLE \" + tableName).getOnlyValue(), createQuery);", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyNTg2NA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524225864", "bodyText": "jdbi3?", "author": "kokosing", "createdAt": "2020-11-16T12:35:16Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -233,6 +240,32 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\"CREATE TABLE %s (%s) WITH (DATA_COMPRESSION = %s)\", quoted(remoteTableName), join(\", \", columns), getDataCompression(tableMetadata.getProperties()));\n+    }\n+\n+    @Override\n+    public Map<String, Object> getTableProperties(JdbcIdentity identity, JdbcTableHandle tableHandle)\n+    {\n+        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+\n+        try (Connection connection = connectionFactory.openConnection(identity);\n+                PreparedStatement statement = connection.prepareStatement(\"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id WHERE p.partition_number = 1 AND t.name = ?\")) {\n+            statement.setString(1, tableHandle.getRemoteTableName().getTableName());\n+            try (ResultSet resultSet = statement.executeQuery()) {", "originalCommit": "a430d9bb73177f942294f8bbce7adfeedb0978c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0MjU5NA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524242594", "bodyText": "But for using JDBI we might need inject a ConnectionProvider but for fetching a connection we need to JdbcIdentity", "author": "Praveen2112", "createdAt": "2020-11-16T12:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyNTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MDgxMA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r524270810", "bodyText": "i didn't quite get it. Anyway, you can attach jdbi to an existing connector.", "author": "findepi", "createdAt": "2020-11-16T13:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyNTg2NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzMjUzMQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544132531", "bodyText": "this is not needed. It is only needed you would place ; at the end.", "author": "kokosing", "createdAt": "2020-12-16T09:13:39Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/DataCompression.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.sqlserver;\n+\n+public enum DataCompression\n+{\n+    NONE,\n+    ROW,\n+    PAGE,\n+    /**/", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzNDAyOQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544134029", "bodyText": "I would love to see a test where data_compression = null. Where table is created remotely (outside of Presto) and its partitions have different compressions. Is that doable?", "author": "kokosing", "createdAt": "2020-12-16T09:16:00Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -340,6 +346,57 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @Test\n+    @Override\n+    public void testShowCreateTable()\n+    {\n+        assertThat((String) computeActual(\"SHOW CREATE TABLE orders\").getOnlyValue())\n+                .matches(\"CREATE TABLE \\\\w+\\\\.\\\\w+\\\\.orders \\\\Q(\\n\" +\n+                        \"   orderkey bigint,\\n\" +\n+                        \"   custkey bigint,\\n\" +\n+                        \"   orderstatus varchar(1),\\n\" +\n+                        \"   totalprice double,\\n\" +\n+                        \"   orderdate date,\\n\" +\n+                        \"   orderpriority varchar(15),\\n\" +\n+                        \"   clerk varchar(15),\\n\" +\n+                        \"   shippriority integer,\\n\" +\n+                        \"   comment varchar(79)\\n\" +\n+                        \")\\n\" +\n+                        \"WITH (\\n\" +\n+                        \"   data_compression = 'NONE'\\n\" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzNzM1OQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544137359", "bodyText": "what about other partitions? What they have different data_compression_desc? I would do SELECT DISTINCT data_compression_desc and in case there is 0 or more than 1 row I would return Optional.empty()", "author": "kokosing", "createdAt": "2020-12-16T09:20:58Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -387,4 +420,27 @@ public void setNull(PreparedStatement statement, int index)\n             }\n         };\n     }\n+\n+    private static class DataCompressionDao\n+    {\n+        private final Handle handle;\n+\n+        private DataCompressionDao(Handle handle)\n+        {\n+            this.handle = requireNonNull(handle, \"handle is null\");\n+        }\n+\n+        Optional<DataCompression> getDataCompression(JdbcTableHandle table)\n+        {\n+            return handle.createQuery(\"\" +\n+                    \"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                    \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name \" +\n+                    \"AND p.partition_number = 1\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzOTAxMg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544139012", "bodyText": "does getIfPresent supports - replacement with _ or does it compare it case insensitively?  No change request.", "author": "kokosing", "createdAt": "2020-12-16T09:23:23Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -387,4 +420,27 @@ public void setNull(PreparedStatement statement, int index)\n             }\n         };\n     }\n+\n+    private static class DataCompressionDao\n+    {\n+        private final Handle handle;\n+\n+        private DataCompressionDao(Handle handle)\n+        {\n+            this.handle = requireNonNull(handle, \"handle is null\");\n+        }\n+\n+        Optional<DataCompression> getDataCompression(JdbcTableHandle table)\n+        {\n+            return handle.createQuery(\"\" +\n+                    \"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                    \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name \" +\n+                    \"AND p.partition_number = 1\")\n+                    .bind(\"schema\", table.getSchemaName())\n+                    .bind(\"table_name\", table.getTableName())\n+                    .mapTo(String.class)\n+                    .findOne()\n+                    .flatMap(dataCompression -> Enums.getIfPresent(DataCompression.class, dataCompression).toJavaUtil());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzOTQ0OA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544139448", "bodyText": "Shouldn't you return Optional here?", "author": "kokosing", "createdAt": "2020-12-16T09:24:00Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerTableProperties.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.sqlserver;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.plugin.jdbc.TablePropertiesProvider;\n+import io.prestosql.spi.session.PropertyMetadata;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static io.prestosql.plugin.sqlserver.DataCompression.NONE;\n+import static io.prestosql.spi.session.PropertyMetadata.enumProperty;\n+\n+public class SqlServerTableProperties\n+        implements TablePropertiesProvider\n+{\n+    public static final String DATA_COMPRESSION = \"data_compression\";\n+\n+    private final List<PropertyMetadata<?>> tableProperties = ImmutableList.of(\n+            enumProperty(\n+                    DATA_COMPRESSION,\n+                    \"DataCompression type for table\",\n+                    DataCompression.class,\n+                    NONE,\n+                    false));\n+\n+    @Override\n+    public List<PropertyMetadata<?>> getTableProperties()\n+    {\n+        return tableProperties;\n+    }\n+\n+    public static DataCompression getDataCompression(Map<String, Object> tableProperties)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE2MDE0Mw==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544160143", "bodyText": "We passed a default value to enumProperty so it should be non-null I guess", "author": "Praveen2112", "createdAt": "2020-12-16T09:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzOTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE2Mzc1MA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544163750", "bodyText": "So I guess default should be null (unknown, don't care (default when you create a table)).\nWe should return NONE if we known that all table partitions are not compressed.", "author": "kokosing", "createdAt": "2020-12-16T09:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzOTQ0OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxMjUxMg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544712512", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        dataCompressionDao.getDataCompression(tableHandle)\n          \n          \n            \n                 return dataCompressionDao.getDataCompression(tableHandle)\n          \n          \n            \n                 .<Map<String, Object>>map(dataCompression -> ImmutableMap.of(DATA_COMPRESSION, dataCompression))\n          \n          \n            \n                .orElseGet(ImmutableMap::of);", "author": "ssheikin", "createdAt": "2020-12-17T00:06:21Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -349,6 +359,35 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    protected String createTableSql(RemoteTableName remoteTableName, List<String> columns, ConnectorTableMetadata tableMetadata)\n+    {\n+        return format(\n+                \"CREATE TABLE %s (%s) %s\",\n+                quoted(remoteTableName),\n+                join(\", \", columns),\n+                getDataCompression(tableMetadata.getProperties())\n+                        .map(dataCompression -> format(\"WITH (DATA_COMPRESSION = %s)\", dataCompression))\n+                        .orElse(\"\"));\n+    }\n+\n+    @Override\n+    public Map<String, Object> getTableProperties(ConnectorSession session, JdbcTableHandle tableHandle)\n+    {\n+        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+\n+        try (Connection connection = connectionFactory.openConnection(session);\n+                Handle handle = Jdbi.open(connection)) {\n+            DataCompressionDao dataCompressionDao = new DataCompressionDao(handle);\n+            dataCompressionDao.getDataCompression(tableHandle)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNDI5NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544714295", "bodyText": "Could you please consider different name for this method?\n\nusually get is a lightweight one.\ncurrently it repeats the class name.\n\nMaybe take or takeFor?", "author": "ssheikin", "createdAt": "2020-12-17T00:10:52Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -387,4 +426,28 @@ public void setNull(PreparedStatement statement, int index)\n             }\n         };\n     }\n+\n+    private static class DataCompressionDao\n+    {\n+        private final Handle handle;\n+\n+        private DataCompressionDao(Handle handle)\n+        {\n+            this.handle = requireNonNull(handle, \"handle is null\");\n+        }\n+\n+        Optional<DataCompression> getDataCompression(JdbcTableHandle table)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0MzU0Mg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544943542", "bodyText": "I like current name. I don't like suffixes in method like For, it adds no value but makes method longer. It is obvious that method will return a value for given parameters.", "author": "kokosing", "createdAt": "2020-12-17T09:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NjI5NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544946295", "bodyText": "Actually I think DataCompressionDao class is not needed, all you need is getDataCompression method.", "author": "kokosing", "createdAt": "2020-12-17T09:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk1Njg5OA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544956898", "bodyText": "I'm fine with prefix get as long as it's clearly stated that it's dao, and it is.\nWith shorter name for method (maybe just get(JdbcTableHandle table)) I like this class. If the name left as is static method is enough.", "author": "ssheikin", "createdAt": "2020-12-17T09:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNDI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNjMzMA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544716330", "bodyText": "Could you please make this query more vertical than horizontal or share your thoughts why is it so onliner?\nMaybe FROM and INNER JOIN from new line?", "author": "ssheikin", "createdAt": "2020-12-17T00:16:20Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -387,4 +426,28 @@ public void setNull(PreparedStatement statement, int index)\n             }\n         };\n     }\n+\n+    private static class DataCompressionDao\n+    {\n+        private final Handle handle;\n+\n+        private DataCompressionDao(Handle handle)\n+        {\n+            this.handle = requireNonNull(handle, \"handle is null\");\n+        }\n+\n+        Optional<DataCompression> getDataCompression(JdbcTableHandle table)\n+        {\n+            return handle.createQuery(\"\" +\n+                    \"SELECT data_compression_desc FROM sys.partitions p INNER JOIN sys.tables t ON p.object_id = t.object_id \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTg3Mg==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544721872", "bodyText": "separate commit?", "author": "ssheikin", "createdAt": "2020-12-17T00:30:48Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -340,6 +346,77 @@ public void testNativeMultipleInClauses()\n         sqlServer.execute(\"SELECT count(*) FROM dbo.orders WHERE \" + longInClauses);\n     }\n \n+    @Test\n+    @Override\n+    public void testShowCreateTable()\n+    {\n+        assertThat((String) computeActual(\"SHOW CREATE TABLE orders\").getOnlyValue())\n+                .matches(\"CREATE TABLE \\\\w+\\\\.\\\\w+\\\\.orders \\\\Q(\\n\" +\n+                        \"   orderkey bigint,\\n\" +\n+                        \"   custkey bigint,\\n\" +\n+                        \"   orderstatus varchar(1),\\n\" +\n+                        \"   totalprice double,\\n\" +\n+                        \"   orderdate date,\\n\" +\n+                        \"   orderpriority varchar(15),\\n\" +\n+                        \"   clerk varchar(15),\\n\" +\n+                        \"   shippriority integer,\\n\" +\n+                        \"   comment varchar(79)\\n\" +\n+                        \")\\n\" +\n+                        \"WITH (\\n\" +\n+                        \"   data_compression = 'NONE'\\n\" +\n+                        \")\");\n+    }\n+\n+    @Test(dataProvider = \"dataCompression\")\n+    public void testCreateWithDataCompression(DataCompression dataCompression)\n+    {\n+        String tableName = \"test_create_with_compression_\" + randomTableSuffix();\n+        String createQuery = format(\"CREATE TABLE sqlserver.dbo.%s (\\n\" +\n+                        \"   a bigint,\\n\" +\n+                        \"   b bigint\\n\" +\n+                        \")\\n\" +\n+                        \"WITH (\\n\" +\n+                        \"   data_compression = '%s'\\n\" +\n+                        \")\",\n+                tableName,\n+                dataCompression);\n+        assertUpdate(createQuery);\n+\n+        assertEquals(getQueryRunner().execute(\"SHOW CREATE TABLE \" + tableName).getOnlyValue(), createQuery);\n+\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @DataProvider\n+    public Object[][] dataCompression()\n+    {\n+        return new Object[][] {\n+                {NONE},\n+                {ROW},\n+                {PAGE}\n+        };\n+    }\n+\n+    @Test\n+    public void testShowCreateForPartitionedTables()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NzA4NQ==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544947085", "bodyText": "This test was to ensure that it doesn't show data_compression for partitioned tables. Have updated the method name", "author": "Praveen2112", "createdAt": "2020-12-17T09:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTg3Mg=="}], "type": "inlineReview"}, {"oid": "0fb63209c8797965c35cd3ca27a7ef5e60fcf4ae", "url": "https://github.com/trinodb/trino/commit/0fb63209c8797965c35cd3ca27a7ef5e60fcf4ae", "message": "Allow JDBC connector to set table property", "committedDate": "2020-12-17T09:22:43Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NTgzOA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544945838", "bodyText": "What if query returns more than one record, is it going to throw?", "author": "kokosing", "createdAt": "2020-12-17T09:39:47Z", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -387,4 +424,29 @@ public void setNull(PreparedStatement statement, int index)\n             }\n         };\n     }\n+\n+    private static class DataCompressionDao\n+    {\n+        private final Handle handle;\n+\n+        private DataCompressionDao(Handle handle)\n+        {\n+            this.handle = requireNonNull(handle, \"handle is null\");\n+        }\n+\n+        Optional<DataCompression> getDataCompression(JdbcTableHandle table)\n+        {\n+            return handle.createQuery(\"\" +\n+                    \"SELECT data_compression_desc FROM sys.partitions p \" +\n+                    \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                    \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n+                    \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n+                    \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                    .bind(\"schema\", table.getSchemaName())\n+                    .bind(\"table_name\", table.getTableName())\n+                    .mapTo(String.class)\n+                    .findOne()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0ODIyMA==", "url": "https://github.com/trinodb/trino/pull/5856#discussion_r544948220", "bodyText": "Yes !! If it return 0 value it returns Optional#empty if more than 1 row it throws an exception", "author": "Praveen2112", "createdAt": "2020-12-17T09:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0NTgzOA=="}], "type": "inlineReview"}, {"oid": "3ac9eabbfac47a061afc6716f864ce912fe6130f", "url": "https://github.com/trinodb/trino/commit/3ac9eabbfac47a061afc6716f864ce912fe6130f", "message": "Add data compression property to SQL Server tables", "committedDate": "2020-12-17T09:52:52Z", "type": "commit"}, {"oid": "3ac9eabbfac47a061afc6716f864ce912fe6130f", "url": "https://github.com/trinodb/trino/commit/3ac9eabbfac47a061afc6716f864ce912fe6130f", "message": "Add data compression property to SQL Server tables", "committedDate": "2020-12-17T09:52:52Z", "type": "forcePushed"}]}