{"pr_number": 5086, "pr_title": "Improve message Access Denied: insufficient view owner privileges", "pr_createdAt": "2020-09-07T08:13:50Z", "pr_url": "https://github.com/trinodb/trino/pull/5086", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5MzY1Mw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484293653", "bodyText": "this seems generic and not specific to columns only. Are column names available (accessible) to query user?", "author": "sopel39", "createdAt": "2020-09-07T09:01:36Z", "path": "presto-spi/src/main/java/io/prestosql/spi/security/AccessDeniedException.java", "diffHunk": "@@ -321,6 +326,11 @@ public static void denyCreateViewWithSelect(String sourceName, ConnectorIdentity\n         throw new AccessDeniedException(format(\"View owner '%s' cannot create view that selects from %s%s\", identity.getUser(), sourceName, formatExtraInfo(extraInfo)));\n     }\n \n+    public static void denySelectFromColumns(AccessDeniedException e)\n+    {\n+        throw new AccessDeniedException(\"View owner does not have sufficient privileges\", e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2NjQ1OA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484566458", "bodyText": "Thank you, renamed.", "author": "ssheikin", "createdAt": "2020-09-07T21:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5MzY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYyMzg3Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r488623872", "bodyText": "I'm not sure about column names. Visibility of column names are out of scope of this pr.", "author": "ssheikin", "createdAt": "2020-09-15T12:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5MzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzIyOQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484543229", "bodyText": "Improve view Access Denied messages, can you please describe what was improved?", "author": "kokosing", "createdAt": "2020-09-07T18:40:59Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -14,13 +14,15 @@\n package io.prestosql.security;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2NzkzNA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484567934", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-07T21:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzM2Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484543362", "bodyText": "This commit is very simple, and this constructor so far is not used (the usage above does not count), so I would squash these two commits.", "author": "kokosing", "createdAt": "2020-09-07T18:41:43Z", "path": "presto-spi/src/main/java/io/prestosql/spi/security/AccessDeniedException.java", "diffHunk": "@@ -28,7 +28,12 @@\n {\n     public AccessDeniedException(String message)\n     {\n-        super(PERMISSION_DENIED, \"Access Denied: \" + message);\n+        this(message, null);\n+    }\n+\n+    public AccessDeniedException(String message, Throwable throwable)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2Nzk0MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484567941", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-07T21:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzM2Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NTk0Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484665942", "bodyText": "Use AssertJ instead of something custom", "author": "electrum", "createdAt": "2020-09-08T05:54:10Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -295,6 +312,9 @@ protected void assertAccessDenied(\n             }\n             catch (RuntimeException e) {\n                 assertExceptionMessage(sql, e, \".*Access Denied: \" + exceptionsMessageRegExp);\n+                if (exceptionsCauseMessageRegExp != null) {\n+                    assertCauseExceptionMessage(sql, e, \".*Access Denied: \" + exceptionsCauseMessageRegExp);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NzU4Ng==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484787586", "bodyText": "Sure! I thought it is not used in this class for some reason.", "author": "ssheikin", "createdAt": "2020-09-08T09:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NTk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NjI1Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484666257", "bodyText": "We should fix the callers instead of catching and rethrowing here", "author": "electrum", "createdAt": "2020-09-08T05:55:01Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -42,7 +44,12 @@ public void checkCanSelectFromColumns(SecurityContext context, QualifiedObjectNa\n         // In SQL, views are special in that they execute with permissions of the owner.\n         // This means that the owner of the view is effectively granting permissions to the user running the query,\n         // and thus must have the equivalent of the SQL standard \"GRANT ... WITH GRANT OPTION\".\n-        delegate.checkCanCreateViewWithSelectFromColumns(context, tableName, columnNames);\n+        try {\n+            delegate.checkCanCreateViewWithSelectFromColumns(context, tableName, columnNames);\n+        }\n+        catch (AccessDeniedException e) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MzI0Ng==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r484843246", "bodyText": "@electrum In this case we clearly state that it's OWNER(delegate) who lacks privileges and it's possible to find why he lacks these privileges (as stacktrace is preserved).\nOtherwise functionality of AccessControlManager#checkCanCreateViewWithSelectFromColumns has to be duplicated (at least partially, e.g. AccessControlManager#checkCanAccessCatalog) to state that it is not current user, but view owner lacks privileges (at least to access catalog). Such duplication will produce a lot of code which does absolutely the same stuff.", "author": "ssheikin", "createdAt": "2020-09-08T11:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzOTc3Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r486639772", "bodyText": "Maybe I'm not understanding the goal of this PR. Can you update the description to explain what \"improve\" means?", "author": "electrum", "createdAt": "2020-09-10T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMjM2NQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r487712365", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-14T07:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NjI1Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MDUwMQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r486670501", "bodyText": "I don't think this public method makes sense here, as it's only usage is inside ViewAccessControl. The other methods are intended for use by any access control implementation. Instead, we can do this inline in ViewAccessControl.", "author": "electrum", "createdAt": "2020-09-10T22:34:02Z", "path": "presto-spi/src/main/java/io/prestosql/spi/security/AccessDeniedException.java", "diffHunk": "@@ -321,6 +326,11 @@ public static void denyCreateViewWithSelect(String sourceName, ConnectorIdentity\n         throw new AccessDeniedException(format(\"View owner '%s' cannot create view that selects from %s%s\", identity.getUser(), sourceName, formatExtraInfo(extraInfo)));\n     }\n \n+    public static void denyAccessToViewBecauseOwnerLacksPrivileges(AccessDeniedException e)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU3MTcyNA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r488571724", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-15T10:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MDUwMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2NTc3MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489265771", "bodyText": "This:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new PrestoException(PERMISSION_DENIED, \"Access Denied: View owner does not have sufficient privileges\", e);\n          \n          \n            \n                        throw new PrestoException(PERMISSION_DENIED, \"Access Denied: View owner does not have sufficient privileges: \" + e.getMessage(), e);\n          \n      \n    \n    \n  \n\nwould be more useful & more actionable.", "author": "findepi", "createdAt": "2020-09-16T08:40:12Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +78,14 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private void executeAsViewOwner(Consumer<AccessControl> consumer)\n+    {\n+        try {\n+            consumer.accept(delegate);\n+        }\n+        catch (AccessDeniedException e) {\n+            throw new PrestoException(PERMISSION_DENIED, \"Access Denied: View owner does not have sufficient privileges\", e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NTU4MA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489395580", "bodyText": "@findepi Could you please note in what case it will be more useful and what additional value it brings?\nI think it is not and as the same information is stored in the rethrown exception e and stores in stacktrace.", "author": "ssheikin", "createdAt": "2020-09-16T12:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2NTc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4Mzc2Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489783762", "bodyText": "updated.", "author": "ssheikin", "createdAt": "2020-09-16T22:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2NTc3MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489786618", "bodyText": "This could take Runnable since the caller already has the delegate. Then this method can be static.", "author": "electrum", "createdAt": "2020-09-16T22:22:12Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +78,14 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private void executeAsViewOwner(Consumer<AccessControl> consumer)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAwMDEyNg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490000126", "bodyText": "I considered Runnable as well, however I did not find good method name.\nexecuteAsViewOwner(() -> delegate.checkCanCreateViewWithSelectFromColumns(context, tableName, columnNames));\ndoes not sound good, because it does not execute something as owner it just wraps it to owner error.\nwrapWithOwnerException(() -> delegate.checkCanCreateViewWithSelectFromColumns(context, tableName, columnNames)); is not good because you can write whatever you want within runnable and it will be just wraped with exception. No relation between delegate(view owner) and exception at all.\nexecuteAsViewOwner(owner -> owner.checkCanCreateViewWithSelectFromColumns(context, tableName, columnNames)); I feel that this code somehow obliges me to utilize owner parameter. Once I use it - I have an exception related to this parameter.\nDespite this version is a little bit longer I prefer it, unless you have better suggestion.", "author": "ssheikin", "createdAt": "2020-09-17T06:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAyNDIwMA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490024200", "bodyText": "I considered Runnable as well, however I did not find good method name.\n\nLet's call it wrapAccessDeniedException", "author": "kokosing", "createdAt": "2020-09-17T07:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDQxOQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490034419", "bodyText": "I still don't like it, but 2:1. Renamed.", "author": "ssheikin", "createdAt": "2020-09-17T07:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzOTM4NQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490039385", "bodyText": "@electrum why do you prefer static over non static methods?", "author": "ssheikin", "createdAt": "2020-09-17T07:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0MjExOA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490042118", "bodyText": "static method is just a function while method is a method ;)\n\nFunction does not requires polymorphism and it is much easier for compiler and runtime.\nIt is much easier to maintain that, one can easily extract this function out of this class and reuse it somewhere.\nIt is more readable, reader knows that this function won't modify or even access the object state.", "author": "kokosing", "createdAt": "2020-09-17T07:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NjYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4Njg1Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489786857", "bodyText": "This will result in a repeated \"Access Denied\" in the message:\n\nAccess Denied: View owner does not have sufficient privileges: Access Denied: View owner 'xxx' cannot create view that selects from yyy\n\nWe should strip that off, since we know the original message always has it.", "author": "electrum", "createdAt": "2020-09-16T22:22:52Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +78,14 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private void executeAsViewOwner(Consumer<AccessControl> consumer)\n+    {\n+        try {\n+            consumer.accept(delegate);\n+        }\n+        catch (AccessDeniedException e) {\n+            throw new PrestoException(PERMISSION_DENIED, \"Access Denied: View owner does not have sufficient privileges: \" + e.getMessage(), e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxOTIzMQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490019231", "bodyText": "Done", "author": "ssheikin", "createdAt": "2020-09-17T07:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4Njg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0OTI0Mw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490049243", "bodyText": "does the exception message contain \"Access Denied\" i once now?", "author": "findepi", "createdAt": "2020-09-17T08:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4Njg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4Nzk1Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490087952", "bodyText": "Yes.", "author": "ssheikin", "createdAt": "2020-09-17T09:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4Njg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NzI2MA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489787260", "bodyText": "Either wrap all arguments or none", "author": "electrum", "createdAt": "2020-09-16T22:24:03Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -293,10 +293,26 @@ protected void assertAccessDenied(@Language(\"SQL\") String sql, @Language(\"RegExp\n         assertAccessDenied(getSession(), sql, exceptionsMessageRegExp, deniedPrivileges);\n     }\n \n+    protected void assertAccessDenied(@Language(\"SQL\") String sql, @Language(\"RegExp\") String exceptionsMessageRegExp, @Language(\"RegExp\") String exceptionsCauseMessageRegExp,\n+            TestingPrivilege... deniedPrivileges)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAwMjMxNQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490002315", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T06:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NzI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4ODM2OQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r489788369", "bodyText": "No need to use string format for simple concatenation\nString query = \"Query: \" + sql;", "author": "electrum", "createdAt": "2020-09-16T22:27:01Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -306,7 +322,11 @@ protected void assertAccessDenied(\n                 fail(\"Expected \" + AccessDeniedException.class.getSimpleName());\n             }\n             catch (RuntimeException e) {\n-                assertExceptionMessage(sql, e, \".*Access Denied: \" + exceptionsMessageRegExp);\n+                String query = format(\"Query: %s\", sql);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAxOTg3NA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490019874", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T07:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4ODM2OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAyNDEyMA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490024120", "bodyText": "Please throw io.prestosql.spi.security.AccessDeniedException", "author": "kokosing", "createdAt": "2020-09-17T07:19:34Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +78,14 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private void executeAsViewOwner(Consumer<AccessControl> consumer)\n+    {\n+        try {\n+            consumer.accept(delegate);\n+        }\n+        catch (AccessDeniedException e) {\n+            throw new PrestoException(PERMISSION_DENIED, \"View owner does not have sufficient privileges: \" + e.getMessage(), e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzMDgxMA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490030810", "bodyText": "I think that AccessDeniedException\nwill be inconsistent with this conversation: #5086 (comment)\nand relates a little bit to #5086 (comment)", "author": "ssheikin", "createdAt": "2020-09-17T07:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAyNDEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDQ1Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490034457", "bodyText": "Thanks", "author": "kokosing", "createdAt": "2020-09-17T07:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAyNDEyMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzODY2Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490038662", "bodyText": "static", "author": "kokosing", "createdAt": "2020-09-17T07:45:37Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +78,14 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private void wrapAccessDeniedException(Runnable runnable)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0MTU1Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490041557", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T07:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzODY2Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0NTEyOQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490045129", "bodyText": "i'd suggest decoupling running query with verifying the exception using\norg.assertj.core.api.Assertions#assertThatThrownBy(org.assertj.core.api.ThrowableAssert.ThrowingCallable)\na helper like io.prestosql.testing.assertions.PrestoExceptionAssert#assertPrestoExceptionThrownBy can be useful", "author": "findepi", "createdAt": "2020-09-17T07:56:39Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -294,9 +293,28 @@ protected void assertAccessDenied(@Language(\"SQL\") String sql, @Language(\"RegExp\n     }\n \n     protected void assertAccessDenied(\n+            @Language(\"SQL\") String sql,\n+            @Language(\"RegExp\") String exceptionsMessageRegExp,\n+            @Language(\"RegExp\") String exceptionsCauseMessageRegExp,\n+            TestingPrivilege... deniedPrivileges)\n+    {\n+        assertAccessDenied(getSession(), sql, \".*\" + exceptionsMessageRegExp + \": Access Denied: \" + exceptionsCauseMessageRegExp, \".*Access Denied: \" + exceptionsCauseMessageRegExp, deniedPrivileges);\n+    }\n+\n+    protected void assertAccessDenied(\n+            Session session,\n+            @Language(\"SQL\") String sql,\n+            @Language(\"RegExp\") String exceptionsMessageRegExp,\n+            TestingPrivilege... deniedPrivileges)\n+    {\n+        assertAccessDenied(getSession(), sql, \".*Access Denied: \" + exceptionsMessageRegExp, null, deniedPrivileges);\n+    }\n+\n+    private void assertAccessDenied(\n             Session session,\n             @Language(\"SQL\") String sql,\n             @Language(\"RegExp\") String exceptionsMessageRegExp,\n+            @Language(\"RegExp\") String exceptionsCauseMessageRegExp,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4NjA4OA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490286088", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T14:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0NTEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0NTM5NA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490045394", "bodyText": "can we match the full exception message here, not just a aubstring?\n(the actual message has : ... after \"privileges\")\nthis would also make sure @electrum is happy about \"Access Denied\" being or not being repeated within the message", "author": "findepi", "createdAt": "2020-09-17T07:57:02Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1062,6 +1062,7 @@ public void testViewColumnAccessControl()\n         // verify selecting from a view over a table requires the view owner to have special view creation privileges for the table\n         assertAccessDenied(\n                 \"SELECT * FROM \" + columnAccessViewName,\n+                \"View owner does not have sufficient privileges\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA1Mjk0MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490052941", "bodyText": "actually I already had such version d2e7d1a\nit requires adding : Access Denied:  somewhere within the error message which is not intuitive and error prone.\nIf you prefer this way I'll remove Access Denied text concatenation from internals of assertAccessDenied methods and add it to every text message during invocation of these methods. At least it will not be misleading.", "author": "ssheikin", "createdAt": "2020-09-17T08:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0NTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2NDg3Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490264872", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T13:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0NTM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0ODg0MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490048841", "bodyText": "Please do not use .* at the begin and end of error message regexp. We need be sure if there is nothing extra here.\nSee:\n           throw new PrestoException(PERMISSION_DENIED, \"View owner does not have sufficient privileges: \" + e.getMessage(), e);\n\nThere is a suffix added that you didn't verify. Please fix this.", "author": "kokosing", "createdAt": "2020-09-17T08:02:49Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -294,9 +293,28 @@ protected void assertAccessDenied(@Language(\"SQL\") String sql, @Language(\"RegExp\n     }\n \n     protected void assertAccessDenied(\n+            @Language(\"SQL\") String sql,\n+            @Language(\"RegExp\") String exceptionsMessageRegExp,\n+            @Language(\"RegExp\") String exceptionsCauseMessageRegExp,\n+            TestingPrivilege... deniedPrivileges)\n+    {\n+        assertAccessDenied(getSession(), sql, \".*\" + exceptionsMessageRegExp + \": Access Denied: \" + exceptionsCauseMessageRegExp, \".*Access Denied: \" + exceptionsCauseMessageRegExp, deniedPrivileges);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA1MDMwOQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490050309", "bodyText": "I shouldn't be that strict. Maybe .* at the beginning might be needed, but not at the end.", "author": "kokosing", "createdAt": "2020-09-17T08:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0ODg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA1MTEwMQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490051101", "bodyText": "It's better not to use .* at all. If there is a spercific part that's variable and cannot be matched (eg table name), using \\w+ is better.", "author": "findepi", "createdAt": "2020-09-17T08:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0ODg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2NDY1OQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490264659", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-17T13:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0ODg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0OTgzMw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490049833", "bodyText": "Actually we do not care about the cause, as this is not printed to the user. Please undo these changes.", "author": "kokosing", "createdAt": "2020-09-17T08:04:32Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -306,7 +324,11 @@ protected void assertAccessDenied(\n                 fail(\"Expected \" + AccessDeniedException.class.getSimpleName());\n             }\n             catch (RuntimeException e) {\n-                assertExceptionMessage(sql, e, \".*Access Denied: \" + exceptionsMessageRegExp);\n+                String query = \"Query: \" + sql;\n+                assertThat(e).as(query).hasMessageMatching(exceptionsMessageRegExp);\n+                if (exceptionsCauseMessageRegExp != null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2NTQ2Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490265462", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-17T13:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA0OTgzMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490878495", "bodyText": "The full error message is:\nAccess Denied: View owner does not have sufficient privileges: Access Denied: View owner 'test_view_access_owner' cannot create view that selects from \\\\w+.\\\\w+.orders\\\n\nThere are two issues here.\n\nAccess Denied:  is unnecessarly doubled\nerror message is long and detailed (but on the hand it could be useful to understand why just happened). How about raising only Access Denied: View owner does not have sufficient privileges without the second part? @electrum @findepi thoughts?", "author": "kokosing", "createdAt": "2020-09-18T11:18:48Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1060,9 +1060,9 @@ public void testViewColumnAccessControl()\n                 privilege(\"orders\", CREATE_VIEW_WITH_SELECT_COLUMNS));\n \n         // verify selecting from a view over a table requires the view owner to have special view creation privileges for the table\n-        assertAccessDenied(\n+        assertWrappedAccessDenied(\n                 \"SELECT * FROM \" + columnAccessViewName,\n-                \"View owner 'test_view_access_owner' cannot create view that selects from .*.orders.*\",\n+                \"View owner does not have sufficient privileges: Access Denied: View owner 'test_view_access_owner' cannot create view that selects from \\\\w+.\\\\w+.orders\\\\w*\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxMzUzNQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490913535", "bodyText": "assertWrappedAccessDenied checks the full message (\"View owner does not have sufficient privileges: Access Denied: View owner 'test_view_access_owner' cannot create view that selects from \\w+.\\w+.orders\\w*\")\n\nalready resolved here #5086 (comment)", "author": "ssheikin", "createdAt": "2020-09-18T12:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE4MzA3NA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r491183074", "bodyText": "Oh... I get it now.\n\nI am not sure if it is nice looking error message:\nView owner does not have sufficient privileges: Access Denied: View owner 'test_view_access_owner' cannot create view \nvs\n Access Denied: View owner does not have sufficient privileges: View owner 'test_view_access_owner' cannot create view\nvs\nAccess Denied: View owner does not have sufficient privileges\nI vote for the last one. If one wants more details then in CLI can use --debug in web ui can see the stack trace in web ui.", "author": "kokosing", "createdAt": "2020-09-18T20:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjI5MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r491462291", "bodyText": "The example is... well, an example, right?\nThe second part can be many different things, so it may be less or more \"boring\".\nMy point is -- I don't want to be faced with \"Access Denied: View owner does not have sufficient privileges\" (period) error message and be asked by the user \"ok, so what do i need to change?\". It user's query is a big one, it may take a while until you learn which view, which view owner, and what permission they are missing.", "author": "findepi", "createdAt": "2020-09-19T14:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2MzU2MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r493263561", "bodyText": "Ok, let it be Access Denied: View owner does not have sufficient privileges: View owner 'test_view_access_owner' cannot create view.", "author": "kokosing", "createdAt": "2020-09-23T07:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI2MjU4Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r494262587", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-24T12:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTA4Mg==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490879082", "bodyText": "Why assertAccessDenied is not enough? Why do you care it is wrapped? To me it is implementation detail on which test should not rely on.", "author": "kokosing", "createdAt": "2020-09-18T11:20:08Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1060,9 +1060,9 @@ public void testViewColumnAccessControl()\n                 privilege(\"orders\", CREATE_VIEW_WITH_SELECT_COLUMNS));\n \n         // verify selecting from a view over a table requires the view owner to have special view creation privileges for the table\n-        assertAccessDenied(\n+        assertWrappedAccessDenied(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxNDk5Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490914997", "bodyText": "assertWrappedAccessDenied checks the full message.\nassertAccessDenied cannot be reused because it adds \".*Access Denied: \" at the beginning", "author": "ssheikin", "createdAt": "2020-09-18T12:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2NDY5Nw==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r493264697", "bodyText": "assertAccessDenied cannot be reused because it adds \".*Access Denied: \" at the beginning\n\nAnd that is the point. Access Denied:  should be placed at the beginning", "author": "kokosing", "createdAt": "2020-09-23T07:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI2MjQwOA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r494262408", "bodyText": "done.", "author": "ssheikin", "createdAt": "2020-09-24T12:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTc4NQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490879785", "bodyText": "This refactor is nice, but it has nothing to do with the commit. Please extract it to separate commit.", "author": "kokosing", "createdAt": "2020-09-18T11:21:35Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -299,19 +301,19 @@ protected void assertAccessDenied(\n             @Language(\"RegExp\") String exceptionsMessageRegExp,\n             TestingPrivilege... deniedPrivileges)\n     {\n-        executeExclusively(() -> {\n-            try {\n-                queryRunner.getAccessControl().deny(deniedPrivileges);\n-                queryRunner.execute(session, sql);\n-                fail(\"Expected \" + AccessDeniedException.class.getSimpleName());\n-            }\n-            catch (RuntimeException e) {\n-                assertExceptionMessage(sql, e, \".*Access Denied: \" + exceptionsMessageRegExp);\n-            }\n-            finally {\n-                queryRunner.getAccessControl().reset();\n-            }\n-        });\n+        assertException(session, sql, \".*Access Denied: \" + exceptionsMessageRegExp, deniedPrivileges);\n+    }\n+\n+    protected void assertWrappedAccessDenied(@Language(\"SQL\") String sql, @Language(\"RegExp\") String exceptionsMessageRegExp, TestingPrivilege... deniedPrivileges)\n+    {\n+        assertException(getSession(), sql, exceptionsMessageRegExp, deniedPrivileges);\n+    }\n+\n+    private void assertException(Session session, @Language(\"SQL\") String sql, @Language(\"RegExp\") String exceptionsMessageRegExp, TestingPrivilege[] deniedPrivileges)\n+    {\n+        assertThatThrownBy(() -> executeExclusively(session, sql, deniedPrivileges))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk1ODc4NQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r490958785", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-18T13:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3OTc4NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "9e03d752aea95aff37d303b4c40a981e03649ad6", "url": "https://github.com/trinodb/trino/commit/9e03d752aea95aff37d303b4c40a981e03649ad6", "message": "Improve Access Denied message: insufficient view owner privileges\n\nIf a user A creates a view and user B wants to access the view and\nthen user A loses access to the original data\nthen B should not be able to access data in the view.\nIf B gets and access denied,\nthey are told whether it's because they don't have access to the view\nor if the view creator doesn't have access to the underlying data.", "committedDate": "2020-09-19T12:14:23Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNDQ5OQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r495824499", "bodyText": "Please also add verify(e.getMessage().startsWith(prefix))", "author": "kokosing", "createdAt": "2020-09-28T09:58:40Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +77,16 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private static void wrapAccessDeniedException(Runnable runnable)\n+    {\n+        try {\n+            runnable.run();\n+        }\n+        catch (AccessDeniedException e) {\n+            String prefix = AccessDeniedException.PREFIX;\n+            String msg = e.getMessage().substring(prefix.length());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzODYyMA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r495838620", "bodyText": "done", "author": "ssheikin", "createdAt": "2020-09-28T10:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNDQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNDY1MQ==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r495824651", "bodyText": "nit: I would inline it (up to you, no change request)", "author": "kokosing", "createdAt": "2020-09-28T09:58:56Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -74,4 +77,16 @@ public void checkCanGrantExecuteFunctionPrivilege(SecurityContext context, Strin\n     {\n         return delegate.getColumnMasks(context, tableName, columnName, type);\n     }\n+\n+    private static void wrapAccessDeniedException(Runnable runnable)\n+    {\n+        try {\n+            runnable.run();\n+        }\n+        catch (AccessDeniedException e) {\n+            String prefix = AccessDeniedException.PREFIX;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzMzk3NA==", "url": "https://github.com/trinodb/trino/pull/5086#discussion_r495833974", "bodyText": "I've considered this as well, but I see two points against it:\n\nit will be used in several places, so no 'link' between these usages.\nAccessDeniedException.PREFIX is too long. Once static imported - it's not explicit what does PREFIX mean.\n\nWill left it as is.", "author": "ssheikin", "createdAt": "2020-09-28T10:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNDY1MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "501cb716d16b729ef1b3703edbff4ab6cb55a20a", "url": "https://github.com/trinodb/trino/commit/501cb716d16b729ef1b3703edbff4ab6cb55a20a", "message": "Refactor Access Denied Exception testing", "committedDate": "2020-09-30T07:34:46Z", "type": "commit"}, {"oid": "b0e70d8712b6cd3355aebec502b2afba6a5f626b", "url": "https://github.com/trinodb/trino/commit/b0e70d8712b6cd3355aebec502b2afba6a5f626b", "message": "Improve Access Denied message: insufficient view owner privileges\n\nIf a user A creates a view and user B wants to access the view and\nthen user A loses access to the original data\nthen B should not be able to access data in the view.\nIf B gets and access denied,\nthey are told whether it's because they don't have access to the view\nor if the view creator doesn't have access to the underlying data.", "committedDate": "2020-09-30T07:34:46Z", "type": "commit"}, {"oid": "b0e70d8712b6cd3355aebec502b2afba6a5f626b", "url": "https://github.com/trinodb/trino/commit/b0e70d8712b6cd3355aebec502b2afba6a5f626b", "message": "Improve Access Denied message: insufficient view owner privileges\n\nIf a user A creates a view and user B wants to access the view and\nthen user A loses access to the original data\nthen B should not be able to access data in the view.\nIf B gets and access denied,\nthey are told whether it's because they don't have access to the view\nor if the view creator doesn't have access to the underlying data.", "committedDate": "2020-09-30T07:34:46Z", "type": "forcePushed"}]}