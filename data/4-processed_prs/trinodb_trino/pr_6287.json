{"pr_number": 6287, "pr_title": "Support metadata DELETE in JDBC connectors", "pr_createdAt": "2020-12-10T14:54:06Z", "pr_url": "https://github.com/trinodb/trino/pull/6287", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r542464243", "bodyText": "What is additionalPredicate? Is it somehow connected with limit? If not, why don't you need it in delete?", "author": "ssheikin", "createdAt": "2020-12-14T15:16:55Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -102,7 +102,7 @@ public PreparedStatement buildSql(\n \n         List<TypeAndValue> accumulator = new ArrayList<>();\n \n-        List<String> clauses = toConjuncts(client, session, connection, tupleDomain, accumulator);\n+        List<String> clauses = toConjuncts(session, connection, tupleDomain, accumulator);\n         if (additionalPredicate.isPresent()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE5Njc1Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543196757", "bodyText": "It is not. Connector when creates a splits then it can use additionalPredicate so it can run JDBC queries in parallel. One split where key_column % 2 = 0 and other when key_column % 2 = 1 where you have 2 splits.", "author": "kokosing", "createdAt": "2020-12-15T09:49:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3MTQ5OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543271498", "bodyText": "In this case you cannot delete something which does not exist (or can because it could somehow exist?), and it safe not to provide additionalPredicate for delete. However consider situation if you can not match indexes in underlying systems which had been created with such additionalPredicate conditions.", "author": "ssheikin", "createdAt": "2020-12-15T11:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5MzY4NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543293684", "bodyText": "This code is not executed for delete. buildSql is called only for SELECT. DELETE is using buildDeleteSql there is no additionalPredicate", "author": "kokosing", "createdAt": "2020-12-15T12:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQwOTEyOQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543409129", "bodyText": "Yeah, I meant exactly that place (I started this discussion here because there is no additionalPredicate in code you added for DELETE).\nLet me please clarify my comment.\nImagine situation when you have some data (key_column, year, name) in table A.\nAnd there are 2 splits: key_column % 2 = 0 and other when key_column % 2 = 1.\nUsually user executes selects on A: select name from A where year = <year> which translates to two with splits:\nselect name from A where key_column % 2 = 0 and year = <year>\nselect name from A where key_column % 2 = 1 and year = <year>\n\nTo optimize these queries downstream system has CREATE INDEX a_idx ON a (key_column, year)\nIf you don't propagate additionalPredicate to DELETE this could end up with a_idx is not used for DELETE.\nCould you please check if such scenario is covered?", "author": "ssheikin", "createdAt": "2020-12-15T14:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU2MTY3Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r558561673", "bodyText": "If you don't propagate additionalPredicate to DELETE this could end up with a_idx is not used for DELETE.\n\nI don't care about it. It does not have to be well performant.\nNotice that for this metadata delete there are no splits generated, hence there is no additional predicate nor even actual query execution in Presto. It all happens during the \"planning\".", "author": "kokosing", "createdAt": "2021-01-15T19:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTIzODUxMg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559238512", "bodyText": "additionalPredicate is not about performance, but about correctness.\nanyway, this is split's attribute, and no splits are involved at this point yet, afaict", "author": "findepi", "createdAt": "2021-01-17T21:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MzA3MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r542473070", "bodyText": "Seems like magic constant. Is it used somewhere? Maybe tests are needed?", "author": "ssheikin", "createdAt": "2020-12-14T15:27:25Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -458,6 +462,39 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        return new JdbcColumnHandle(\n+                \"$update_row_id\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTUyNjA1Ng==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559526056", "bodyText": "It is used, see the comment above.", "author": "kokosing", "createdAt": "2021-01-18T12:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MzA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3NTQ3Ng==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r542475476", "bodyText": "Can it be not null when beginDelete throws an exception?", "author": "ssheikin", "createdAt": "2020-12-14T15:30:26Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -458,6 +462,39 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        return new JdbcColumnHandle(\n+                \"$update_row_id\",\n+                new JdbcTypeHandle(Types.BIGINT, Optional.of(\"bigint\"), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty()),\n+                BIGINT);\n+    }\n+\n+    @Override\n+    public ConnectorTableHandle beginDelete(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        throw new PrestoException(NOT_SUPPORTED, \"Not supported delete\");\n+    }\n+\n+    @Override\n+    public boolean supportsMetadataDelete(ConnectorSession session, ConnectorTableHandle tableHandle, ConnectorTableLayoutHandle tableLayoutHandle)\n+    {\n+        return true;\n+    }\n+\n+    @Override\n+    public Optional<ConnectorTableHandle> applyDelete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        return Optional.of(handle);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTUzNjM3OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559536378", "bodyText": "beginDelete is not called if this can be done by metadata delete (applyDelete)", "author": "kokosing", "createdAt": "2021-01-18T12:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3NTQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4MTY3OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r542481679", "bodyText": "if supportsDelete=true why this test never assertQuerySucceeds(\"DELETE FROM \"?\nCould you please add such scenario? The same is for other connectors.", "author": "ssheikin", "createdAt": "2020-12-14T15:37:51Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -85,5 +82,15 @@ protected TestTable createTableWithDefaultColumns()\n                         \"col_required2 BIGINT NOT NULL)\");\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5MzkzMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543293930", "bodyText": "Added a comment below, which should answer your question", "author": "kokosing", "createdAt": "2020-12-15T12:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4MTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM2NjQyMg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543366422", "bodyText": "// PostgreSql connector currently does not support row-by-row delete\n\nThanks for comment.\nSo if supportsDelete=true and connector currently does not support row-by-row delete I'd expect that this connector supports some other type of delete. I see you added testDeleteWithSimplePredicate and testDeleteEntireTable. Maybe it worth to rename this method to something like testDeleteRowByRow?", "author": "ssheikin", "createdAt": "2020-12-15T14:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4MTY3OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NTAxNA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543355014", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");\n          \n          \n            \n                    // SqlServer connector currently does not support row-by-row delete\n          \n          \n            \n                    assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");", "author": "ssheikin", "createdAt": "2020-12-15T13:48:47Z", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerDistributedQueries.java", "diffHunk": "@@ -116,5 +111,15 @@ protected TestTable createTableWithDefaultColumns()\n         return Optional.of(dataMappingTestSetup);\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NTgxMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r543355813", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");\n          \n          \n            \n                    // Oracle connector currently does not support row-by-row delete\n          \n          \n            \n                    assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");", "author": "ssheikin", "createdAt": "2020-12-15T13:49:52Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/BaseTestOracleDistributedQueries.java", "diffHunk": "@@ -328,5 +322,15 @@ public void testInsertWithCoercion()\n         return Optional.empty();\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"Not supported delete\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzE2MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283160", "bodyText": "int executeUpdate -> int updatedCount or something", "author": "findepi", "createdAt": "2020-12-19T21:08:54Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -977,6 +978,22 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        JdbcTableHandle tableHandle = (JdbcTableHandle) handle;\n+        try (Connection connection = connectionFactory.openConnection(session);\n+                PreparedStatement preparedStatement = queryBuilder.buildDeleteSql(session, connection, tableHandle.getRemoteTableName(), tableHandle.getConstraint())) {\n+            int executeUpdate = preparedStatement.executeUpdate();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzQzMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283430", "bodyText": "This looks like common code which could be unified. Thoughts?", "author": "findepi", "createdAt": "2020-12-19T21:12:50Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -121,6 +121,36 @@ public PreparedStatement buildSql(\n         log.debug(\"Preparing query: %s\", query);\n         PreparedStatement statement = client.getPreparedStatement(connection, query);\n \n+        applyParameters(session, connection, accumulator, statement);\n+\n+        return statement;\n+    }\n+\n+    public PreparedStatement buildDeleteSql(\n+            ConnectorSession session,\n+            Connection connection,\n+            RemoteTableName remoteTableName,\n+            TupleDomain<ColumnHandle> tupleDomain)\n+            throws SQLException\n+    {\n+        String sql = \"DELETE FROM \" + getRelation(remoteTableName);\n+\n+        List<TypeAndValue> accumulator = new ArrayList<>();\n+\n+        List<String> clauses = toConjuncts(session, connection, tupleDomain, accumulator);\n+        if (!clauses.isEmpty()) {\n+            sql += \" WHERE \" + Joiner.on(\" AND \").join(clauses);\n+        }\n+\n+        log.debug(\"Preparing query: %s\", sql);\n+        PreparedStatement statement = client.getPreparedStatement(connection, sql);\n+        applyParameters(session, connection, accumulator, statement);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTUyOTAyOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559529028", "bodyText": "I thought that I have already unified this by extracting applyParameters method. Do you have any idea what else could be done here?", "author": "kokosing", "createdAt": "2021-01-18T12:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzU0MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283541", "bodyText": "It does (for ORC ACID tables)", "author": "findepi", "createdAt": "2020-12-19T21:13:51Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveDistributedQueries.java", "diffHunk": "@@ -58,6 +59,22 @@ public void testDelete()\n         // Hive connector currently does not support row-by-row delete\n     }\n \n+    @Override\n+    public void testDeleteEntireTable()\n+    {\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Override\n+    public void testDeleteWithSimplePredicate()\n+    {\n+        // Hive connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTUyOTYzMg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559529632", "bodyText": "This is copied from testDelete() from above.", "author": "kokosing", "createdAt": "2021-01-18T12:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzU2NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283564", "bodyText": "revert", "author": "findepi", "createdAt": "2020-12-19T21:14:05Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergDistributed.java", "diffHunk": "@@ -69,6 +89,7 @@ public void testInsertWithCoercion()\n         // Iceberg does not support parameterized varchar\n     }\n \n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4Mzc3MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283771", "bodyText": "The only difference is the commit is missing. Why?", "author": "findepi", "createdAt": "2020-12-19T21:16:17Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -457,6 +460,20 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4Mzg5Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283897", "bodyText": "The only difference is the commit is missing. Why?", "author": "findepi", "createdAt": "2020-12-19T21:17:31Z", "path": "presto-oracle/src/main/java/io/prestosql/plugin/oracle/OracleClient.java", "diffHunk": "@@ -237,6 +240,20 @@ public void createSchema(ConnectorSession session, String schemaName)\n         throw new PrestoException(NOT_SUPPORTED, \"This connector does not support creating schemas\");\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTU0NzM5Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559547397", "bodyText": "It was falling that one cannot call commit when autocommit=true. Now I set autocommit explicitly so I can remove explicit commit.", "author": "kokosing", "createdAt": "2021-01-18T12:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4Mzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4Mzk4MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546283981", "bodyText": "Why?\n\nadd a test with an equality condition on a bigint column -- should work\nadd a test with a range condition on a bigint column -- should work\nadd a test with an equality condition on a varchar column -- should not work, since filter is not fully removed on Presto side", "author": "findepi", "createdAt": "2020-12-19T21:18:27Z", "path": "presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestMySqlDistributedQueries.java", "diffHunk": "@@ -156,5 +152,16 @@ protected boolean isColumnNameRejected(Exception exception, String columnName, b\n         return Optional.of(dataMappingTestSetup);\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // Mysql connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTU0MTQ0Ng==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559541446", "bodyText": "I added io.trino.testing.AbstractTestDistributedQueries#testDeleteWithSimplePredicate that is executed for mysql and covers very simple predicate pushdown.\nNotice that I added here predicate with random. I don't want to hardcode what is supported and what extend. Delete is supported if predicate pushdown is supported. Predicate pushdown support is changing over time, so such test would need to be updated frequently.", "author": "kokosing", "createdAt": "2021-01-18T12:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4Mzk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDA1MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284050", "bodyText": "Why is this overridden?", "author": "findepi", "createdAt": "2020-12-19T21:19:01Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/BaseTestOracleDistributedQueries.java", "diffHunk": "@@ -328,5 +322,15 @@ public void testInsertWithCoercion()\n         return Optional.empty();\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTU0NjE0Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559546147", "bodyText": "It will have to be overriden for all JDBC connectors, test testDelete requires delete row by row which JDBC connector won't have for a while.\nMaybe I could add supportsRowByRowDelete()? (I don't like it)", "author": "kokosing", "createdAt": "2021-01-18T12:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDEwMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284103", "bodyText": "Why this is overridden? Also, this is overridden twice for oracle", "author": "findepi", "createdAt": "2020-12-19T21:19:29Z", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestOracleDistributedQueries.java", "diffHunk": "@@ -58,6 +58,17 @@ public void testCommentColumn()\n         assertThat((String) computeActual(\"SHOW CREATE TABLE \" + tableName).getOnlyValue()).doesNotContain(\"COMMENT 'new comment'\");\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDEyNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284127", "bodyText": "unused?", "author": "findepi", "createdAt": "2020-12-19T21:19:46Z", "path": "presto-phoenix/src/main/java/io/prestosql/plugin/phoenix/PhoenixMetadata.java", "diffHunk": "@@ -64,7 +65,7 @@\n     private final PhoenixClient phoenixClient;\n \n     @Inject\n-    public PhoenixMetadata(PhoenixClient phoenixClient, JdbcMetadataConfig metadataConfig)\n+    public PhoenixMetadata(PhoenixClient phoenixClient, ConnectionFactory connectionFactory, JdbcMetadataConfig metadataConfig)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDMyNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284326", "bodyText": "I am not getting this. If row-by-row is not supported for any of the connectors, then i do not understand why io.prestosql.plugin.jdbc.QueryBuilder#buildDeleteSql does tuple domain -> WHERE conversion", "author": "findepi", "createdAt": "2020-12-19T21:21:35Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -85,5 +81,16 @@ protected TestTable createTableWithDefaultColumns()\n                         \"col_required2 BIGINT NOT NULL)\");\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // PostgreSql connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTU1NjQ4Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r559556483", "bodyText": "tuple domain is not used to delete row-by-row, by rather to remove by predicate. By row-by-row I mean to delete query execution in Trino where we collect ids of rows to be deleted and then we remove them (beginDelete and finishDelete methods).", "author": "kokosing", "createdAt": "2021-01-18T13:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDM0Mg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284342", "bodyText": "skip exception", "author": "findepi", "createdAt": "2020-12-19T21:21:48Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -634,17 +634,52 @@ public void testInsertArray()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testUnsupportedDelete()\n     {\n-        // delete half the table, then delete the rest\n+        if (supportsDelete()) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDQyOQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284429", "bodyText": "testDeleteWithSimplePredicate -> testDeleteWithBigintEquality\n+ add a test for varchar equality. Ideally one that would show incorrect query results when the condition is applied case insensitively.", "author": "findepi", "createdAt": "2020-12-19T21:22:49Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -634,17 +634,52 @@ public void testInsertArray()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testUnsupportedDelete()\n     {\n-        // delete half the table, then delete the rest\n+        if (supportsDelete()) {\n+            return;\n+        }\n+\n         String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n \n+    @Test\n+    public void testDeleteEntireTable()\n+    {\n+        if (!supportsDelete()) {\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName, 15000);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithSimplePredicate()\n+    {\n         if (!supportsDelete()) {\n-            assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n-            assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n-            assertUpdate(\"DROP TABLE \" + tableName);\n             return;\n         }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE orderkey = 1\", 1);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDQzNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284436", "bodyText": "skip exception", "author": "findepi", "createdAt": "2020-12-19T21:23:00Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -634,17 +634,52 @@ public void testInsertArray()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testUnsupportedDelete()\n     {\n-        // delete half the table, then delete the rest\n+        if (supportsDelete()) {\n+            return;\n+        }\n+\n         String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n \n+    @Test\n+    public void testDeleteEntireTable()\n+    {\n+        if (!supportsDelete()) {\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName, 15000);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithSimplePredicate()\n+    {\n         if (!supportsDelete()) {\n-            assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n-            assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n-            assertUpdate(\"DROP TABLE \" + tableName);\n             return;\n         }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE orderkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 15000 - 1\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDelete()\n+    {\n+        if (!supportsDelete()) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDQ3NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284474", "bodyText": "skip exception", "author": "findepi", "createdAt": "2020-12-19T21:23:14Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -634,17 +634,52 @@ public void testInsertArray()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testUnsupportedDelete()\n     {\n-        // delete half the table, then delete the rest\n+        if (supportsDelete()) {\n+            return;\n+        }\n+\n         String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n \n+    @Test\n+    public void testDeleteEntireTable()\n+    {\n+        if (!supportsDelete()) {\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName, 15000);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithSimplePredicate()\n+    {\n         if (!supportsDelete()) {\n-            assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n-            assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n-            assertUpdate(\"DROP TABLE \" + tableName);\n             return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDQ4Mg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284482", "bodyText": "skip exception", "author": "findepi", "createdAt": "2020-12-19T21:23:21Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -634,17 +634,52 @@ public void testInsertArray()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testUnsupportedDelete()\n     {\n-        // delete half the table, then delete the rest\n+        if (supportsDelete()) {\n+            return;\n+        }\n+\n         String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName, \"This connector does not support updates or deletes\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n \n+    @Test\n+    public void testDeleteEntireTable()\n+    {\n+        if (!supportsDelete()) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4NDYzOQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r546284639", "bodyText": "make sure the table handle does not have any unexpected attributes, like grouping sets or synthetic columns.", "author": "findepi", "createdAt": "2020-12-19T21:24:55Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -977,6 +978,22 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        JdbcTableHandle tableHandle = (JdbcTableHandle) handle;\n+        try (Connection connection = connectionFactory.openConnection(session);\n+                PreparedStatement preparedStatement = queryBuilder.buildDeleteSql(session, connection, tableHandle.getRemoteTableName(), tableHandle.getConstraint())) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0NzMyOQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560947329", "bodyText": "isn't it default for JDBC?", "author": "findepi", "createdAt": "2021-01-20T13:09:46Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -979,6 +980,22 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        JdbcTableHandle tableHandle = (JdbcTableHandle) handle;\n+        checkArgument(tableHandle.getGroupingSets().isEmpty() && tableHandle.getLimit().isEmpty(), \"Unable to delete from synthetic table: %s\", tableHandle);\n+        try (Connection connection = connectionFactory.openConnection(session);\n+                PreparedStatement preparedStatement = queryBuilder.buildDeleteSql(session, connection, tableHandle.getRemoteTableName(), tableHandle.getConstraint())) {\n+            connection.setAutoCommit(true);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDUzMDM2OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564530368", "bodyText": "It looks it is not.", "author": "kokosing", "createdAt": "2021-01-26T13:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0NzMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxMjI1Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564612257", "bodyText": "I think we have to separate openConnection to two methods: openReadOnlyConnection(readonly=true, autocommit=false) and openConnectionForWrite(readonly=false, autocommit=true). But not in this PR.", "author": "ssheikin", "createdAt": "2021-01-26T15:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0NzMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTQxOTMwOQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629419309", "bodyText": "isn't it default for JDBC?\n\n\nIt looks it is not.\n\nit actually is, but Phoenix and ClickHouse have it wrong. Addressed in #7875", "author": "findepi", "createdAt": "2021-05-10T14:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0NzMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0ODE5NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560948194", "bodyText": "DeleteEntireTable -> DeleteAllRows", "author": "findepi", "createdAt": "2021-01-20T13:11:13Z", "path": "plugin/trino-hive/src/test/java/io/trino/plugin/hive/TestHiveDistributedQueries.java", "diffHunk": "@@ -58,6 +59,28 @@ public void testDelete()\n         // Hive connector supports row-by-row delete only for ACID tables\n     }\n \n+    @Override\n+    public void testDeleteEntireTable()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0ODY3MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560948671", "bodyText": "Can this test set up an ACID table?\ni guess file metastore is not supported for ACID, right? cc @djsstarburst", "author": "findepi", "createdAt": "2021-01-20T13:12:03Z", "path": "plugin/trino-hive/src/test/java/io/trino/plugin/hive/TestHiveDistributedQueries.java", "diffHunk": "@@ -58,6 +59,28 @@ public void testDelete()\n         // Hive connector supports row-by-row delete only for ACID tables\n     }\n \n+    @Override\n+    public void testDeleteEntireTable()\n+    {\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", 15000);\n+        assertUpdate(\"DELETE FROM \" + tableName);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"SELECT 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Override\n+    public void testDeleteWithBigintEquality()\n+    {\n+        // Hive connector supports row-by-row delete only for ACID tables or when entire partition is deleted", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk5NzUwMQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560997501", "bodyText": "Sadly, that is correct @findepi", "author": "djsstarburst", "createdAt": "2021-01-20T14:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0ODY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0OTE4MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560949181", "bodyText": "PostgreSql -> PostgreSQL\nbut, why is that? didn't you add support for it?", "author": "findepi", "createdAt": "2021-01-20T13:12:58Z", "path": "plugin/trino-postgresql/src/test/java/io/trino/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -85,5 +81,16 @@ protected TestTable createTableWithDefaultColumns()\n                         \"col_required2 BIGINT NOT NULL)\");\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // PostgreSql connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0OTI3Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560949273", "bodyText": "SqlServer -> SQL Server", "author": "findepi", "createdAt": "2021-01-20T13:13:07Z", "path": "plugin/trino-sqlserver/src/test/java/io/trino/plugin/sqlserver/TestSqlServerDistributedQueries.java", "diffHunk": "@@ -116,5 +111,16 @@ protected TestTable createTableWithDefaultColumns()\n         return Optional.of(dataMappingTestSetup);\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // SqlServer connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk1MDI1NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560950254", "bodyText": "Mysql -> MySQL", "author": "findepi", "createdAt": "2021-01-20T13:14:49Z", "path": "plugin/trino-mysql/src/test/java/io/trino/plugin/mysql/TestMySqlDistributedQueries.java", "diffHunk": "@@ -150,5 +146,16 @@ protected boolean isColumnNameRejected(Exception exception, String columnName, b\n         return Optional.of(dataMappingTestSetup);\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // Mysql connector currently does not support row-by-row delete", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk1MDUxOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560950518", "bodyText": "i'd expect varchar-based delete to be special, since MySQL connector doesn't enforce varchar predicates (case sensitiviness). Why is it not special?", "author": "findepi", "createdAt": "2021-01-20T13:15:14Z", "path": "plugin/trino-mysql/src/test/java/io/trino/plugin/mysql/TestMySqlDistributedQueries.java", "diffHunk": "@@ -150,5 +146,16 @@ protected boolean isColumnNameRejected(Exception exception, String columnName, b\n         return Optional.of(dataMappingTestSetup);\n     }\n \n+    @Test\n+    @Override\n+    public void testDelete()\n+    {\n+        // Mysql connector currently does not support row-by-row delete\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders WITH NO DATA\", 0);\n+        assertQueryFails(\"DELETE FROM \" + tableName + \" WHERE random(orderkey) =  0\", \"Not supported delete\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk4Mzg1Mg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r560983852", "bodyText": "This method is not needed, since base class method ConnectorMetadata.beginDelete() raises the same exception.", "author": "djsstarburst", "createdAt": "2021-01-20T14:05:33Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -457,6 +461,40 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        // This column is not actually used, but Presto engine requires this during analysis\n+        return new JdbcColumnHandle(\n+                \"$update_row_id\",\n+                new JdbcTypeHandle(Types.BIGINT, Optional.of(\"bigint\"), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty()),\n+                BIGINT);\n+    }\n+\n+    @Override\n+    public ConnectorTableHandle beginDelete(ConnectorSession session, ConnectorTableHandle tableHandle)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzIzNzk4OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r593237988", "bodyText": "I use it to raise different error message.", "author": "kokosing", "createdAt": "2021-03-12T15:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk4Mzg1Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDU0MDA5OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564540099", "bodyText": "is this comment still actual? If yes, it's hard to find where it belongs.", "author": "ssheikin", "createdAt": "2021-01-26T14:13:33Z", "path": "plugin/trino-sqlserver/src/main/java/io/trino/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -248,7 +252,11 @@ protected void copyTableSchema(Connection connection, String catalogName, String\n \n             case Types.VARCHAR:\n             case Types.NVARCHAR:\n-                return Optional.of(defaultVarcharColumnMapping(typeHandle.getRequiredColumnSize()));\n+                int varcharLength = typeHandle.getRequiredColumnSize();\n+                VarcharType varcharType = (varcharLength <= VarcharType.MAX_LENGTH) ? createVarcharType(varcharLength) : createUnboundedVarcharType();\n+                // Remote database can be case insensitive.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDU0MTA2MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564541061", "bodyText": "static import", "author": "ssheikin", "createdAt": "2021-01-26T14:14:51Z", "path": "plugin/trino-sqlserver/src/main/java/io/trino/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -248,7 +252,11 @@ protected void copyTableSchema(Connection connection, String catalogName, String\n \n             case Types.VARCHAR:\n             case Types.NVARCHAR:\n-                return Optional.of(defaultVarcharColumnMapping(typeHandle.getRequiredColumnSize()));\n+                int varcharLength = typeHandle.getRequiredColumnSize();\n+                VarcharType varcharType = (varcharLength <= VarcharType.MAX_LENGTH) ? createVarcharType(varcharLength) : createUnboundedVarcharType();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDU0MTE5Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564541197", "bodyText": "consider static import", "author": "ssheikin", "createdAt": "2021-01-26T14:15:02Z", "path": "plugin/trino-sqlserver/src/main/java/io/trino/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -248,7 +252,11 @@ protected void copyTableSchema(Connection connection, String catalogName, String\n \n             case Types.VARCHAR:\n             case Types.NVARCHAR:\n-                return Optional.of(defaultVarcharColumnMapping(typeHandle.getRequiredColumnSize()));\n+                int varcharLength = typeHandle.getRequiredColumnSize();\n+                VarcharType varcharType = (varcharLength <= VarcharType.MAX_LENGTH) ? createVarcharType(varcharLength) : createUnboundedVarcharType();\n+                // Remote database can be case insensitive.\n+                PredicatePushdownController predicatePushdownController = PUSHDOWN_AND_KEEP;\n+                return Optional.of(ColumnMapping.sliceMapping(varcharType, varcharReadFunction(varcharType), varcharWriteFunction(), predicatePushdownController));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDU0OTA5Mg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564549092", "bodyText": "Is this branch dead?", "author": "ssheikin", "createdAt": "2021-01-26T14:24:59Z", "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergDistributed.java", "diffHunk": "@@ -57,6 +58,31 @@ public void testDelete()\n         // TODO (https://github.com/trinodb/trino/pull/4639#issuecomment-700737583)\n     }\n \n+    @Override\n+    public void testDeleteAllTable()\n+    {\n+        if (!supportsDelete()) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc1MTgwMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r564751803", "bodyText": "why is this invalidation needed?", "author": "ssheikin", "createdAt": "2021-01-26T18:52:31Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -388,6 +390,14 @@ public String quoted(RemoteTableName remoteTableName)\n         return delegate.getTableScanRedirection(session, tableHandle);\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        OptionalLong updateCount = delegate.delete(session, handle);\n+        invalidateTableCaches(((JdbcTableHandle) handle).getSchemaTableName());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA0MTcxMg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r565041712", "bodyText": "I guess we might need to drop only the metadata/statistics if it exists. Other cache related to table meta need not be invalidated.", "author": "Praveen2112", "createdAt": "2021-01-27T05:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc1MTgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjMyOTIzMQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r582329231", "bodyText": "We already do it this way for insert. So this is coherent.", "author": "kokosing", "createdAt": "2021-02-24T21:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc1MTgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODkyMjQ0NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r588922444", "bodyText": "We invalidate table statistics with this.", "author": "kokosing", "createdAt": "2021-03-06T19:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc1MTgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA0MTg2NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r565041864", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // This column is not actually used, but Presto engine requires this during analysis\n          \n          \n            \n                    // This column is not actually used, but Trino engine requires this during analysis", "author": "Praveen2112", "createdAt": "2021-01-27T05:41:39Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -460,6 +463,34 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        // This column is not actually used, but Presto engine requires this during analysis", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA0NTkxNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r565045916", "bodyText": "Can we add a check before casting it to JdbcNamedRelationHandle ?", "author": "Praveen2112", "createdAt": "2021-01-27T05:54:26Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -143,6 +143,23 @@ else if (baseRelation instanceof JdbcQueryRelationHandle) {\n         return new PreparedQuery(sql, accumulator.build());\n     }\n \n+    public PreparedQuery prepareDelete(\n+            ConnectorSession session,\n+            Connection connection,\n+            JdbcRelationHandle baseRelation,\n+            TupleDomain<ColumnHandle> tupleDomain)\n+    {\n+        String sql = \"DELETE FROM \" + getRelation(((JdbcNamedRelationHandle) baseRelation).getRemoteTableName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA0NjE2MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r565046160", "bodyText": "Can we extract it for both SELECT and DELETE ?", "author": "Praveen2112", "createdAt": "2021-01-27T05:55:10Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -143,6 +143,23 @@ else if (baseRelation instanceof JdbcQueryRelationHandle) {\n         return new PreparedQuery(sql, accumulator.build());\n     }\n \n+    public PreparedQuery prepareDelete(\n+            ConnectorSession session,\n+            Connection connection,\n+            JdbcRelationHandle baseRelation,\n+            TupleDomain<ColumnHandle> tupleDomain)\n+    {\n+        String sql = \"DELETE FROM \" + getRelation(((JdbcNamedRelationHandle) baseRelation).getRemoteTableName());\n+\n+        ImmutableList.Builder<QueryParameter> accumulator = ImmutableList.builder();\n+\n+        List<String> clauses = toConjuncts(session, connection, tupleDomain, accumulator::add);\n+        if (!clauses.isEmpty()) {\n+            sql += \" WHERE \" + Joiner.on(\" AND \").join(clauses);\n+        }\n+        return new PreparedQuery(sql, accumulator.build());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjMzMDkzNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r582330937", "bodyText": "I don't think it is useful.", "author": "kokosing", "createdAt": "2021-02-24T21:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA0NjE2MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2NTI3NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r582365274", "bodyText": "Sorry, this method got renamed when support for SQL UPDATE was merged.  The new name of the method you were thinking of is getDeleteRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle).\nHowever, for metadata delete, I don't believe either method will ever be called, so I think it can/should be omitted until row-by-row DELETE is supported in the JDBC connector.", "author": "djsstarburst", "createdAt": "2021-02-24T22:56:00Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -454,6 +457,34 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle, List<ColumnHandle> updatedColumns)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjYzMTYyNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r582631626", "bodyText": "Thanks, will try to remove this method then.", "author": "kokosing", "createdAt": "2021-02-25T08:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjM2NTI3NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTA2MTg0Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r599061843", "bodyText": "will it return null if try fails?", "author": "ssheikin", "createdAt": "2021-03-22T20:45:19Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1091,6 +1093,27 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, ConnectorTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        JdbcTableHandle tableHandle = (JdbcTableHandle) handle;\n+        checkArgument(tableHandle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", tableHandle);\n+        try (Connection connection = connectionFactory.openConnection(session)) {\n+            connection.setAutoCommit(false);\n+            PreparedQuery preparedQuery = queryBuilder.prepareDelete(session, connection, tableHandle.getRequiredNamedRelation(), tableHandle.getConstraint());\n+            OptionalLong update;\n+            try (PreparedStatement preparedStatement = queryBuilder.prepareStatement(session, connection, preparedQuery)) {\n+                update = OptionalLong.of(preparedStatement.executeUpdate());\n+            }\n+            connection.commit();\n+            return update;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTA4MTc4NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r599081785", "bodyText": "No. You won't get here as exception would be thrown.", "author": "kokosing", "createdAt": "2021-03-22T21:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTA2MTg0Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDEyMjQ0NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620122444", "bodyText": "please make this statement the first one in the method.", "author": "ssheikin", "createdAt": "2021-04-26T09:23:34Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1114,6 +1115,26 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDEyNzI3MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620127270", "bodyText": "why is this dependency needed?", "author": "ssheikin", "createdAt": "2021-04-26T09:29:55Z", "path": "plugin/trino-druid/pom.xml", "diffHunk": "@@ -98,6 +98,13 @@\n         </dependency>\n \n         <!-- for testing -->\n+        <dependency>\n+            <groupId>io.trino</groupId>\n+            <artifactId>trino-base-jdbc</artifactId>\n+            <type>test-jar</type>\n+            <scope>test</scope>\n+        </dependency>\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTIyNTYxMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629225613", "bodyText": "Because druid tests are using BaseJdbcConnectorTest", "author": "kokosing", "createdAt": "2021-05-10T09:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDEyNzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1MzEzMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629253130", "bodyText": "Doesn't seem to belong to Invalidate only table statistics on insert commit", "author": "findepi", "createdAt": "2021-05-10T10:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDEyNzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE0MTkwNQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620141905", "bodyText": "If connectionFactory preserves state of connections it manages connection.setAutoCommit(false); could be too invasive. Please make sure that state of each new connection obtained by subsequent openConnection invocations is not affected. Maybe it worth to reset this property back in finally block?", "author": "ssheikin", "createdAt": "2021-04-26T09:49:04Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1114,6 +1115,26 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);\n+        try (Connection connection = connectionFactory.openConnection(session)) {\n+            connection.setAutoCommit(false);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTIyNzg5OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629227899", "bodyText": "It is a responsiblity connectionFactory to provide \"fresh\" connection. Also we are already doing this for insert.", "author": "kokosing", "createdAt": "2021-05-10T09:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE0MTkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE0NDAyOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620144028", "bodyText": "Seems this suggestion can be implemented: b8152a2#r565041864", "author": "ssheikin", "createdAt": "2021-04-26T09:51:48Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -658,6 +662,40 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getDeleteRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        // This column is not actually used, but Presto engine requires this during analysis", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE0ODUyMQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620148521", "bodyText": "please add assertQueryFails test for\n\nAndLower", "author": "ssheikin", "createdAt": "2021-04-26T09:57:48Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -648,4 +662,74 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name = 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', null\", 3);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col = 'A'\", 1);\n+        assertQuery(\"SELECT * FROM \" + tableName, \"VALUES 'a', null\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharInequality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name != 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', 'b', null\", 4);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col != 'A'\", 2);\n+        assertQuery(\"SELECT * FROM \" + tableName, \"VALUES 'A', null\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharGreaterAndLower()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name > 'ALBANIA'\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE1NjU3OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620156579", "bodyText": ", 0);\n\nIt tests that A < a but does not test delete.", "author": "ssheikin", "createdAt": "2021-04-26T10:08:44Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -648,4 +662,74 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name = 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', null\", 3);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col = 'A'\", 1);\n+        assertQuery(\"SELECT * FROM \" + tableName, \"VALUES 'a', null\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharInequality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name != 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', 'b', null\", 4);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col != 'A'\", 2);\n+        assertQuery(\"SELECT * FROM \" + tableName, \"VALUES 'A', null\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharGreaterAndLower()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name > 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', 'b', null\", 4);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col < 'A'\", 0);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTIzMDM2NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629230365", "bodyText": "this is an empty delete. Below there is non empty.", "author": "kokosing", "createdAt": "2021-05-10T10:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTIzOTEzMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629239133", "bodyText": "It's not possible to distinguish empty delete from non implemented delete.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col < 'A'\", 0);\n          \n          \n            \n                    assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col < 'a'\", 1);", "author": "ssheikin", "createdAt": "2021-05-10T10:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI0MTUyMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629241520", "bodyText": "It is. Non implemented will raise an error. While empty delete was executed in remote data source and it didn't remove anything.", "author": "kokosing", "createdAt": "2021-05-10T10:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE1NjU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE2MjcwOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620162708", "bodyText": "isn't col != 'A' Inequality belong to SUPPORTS_ROW_LEVEL_DELETE ?", "author": "ssheikin", "createdAt": "2021-04-26T10:17:33Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -648,4 +662,74 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name = 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', null\", 3);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col = 'A'\", 1);\n+        assertQuery(\"SELECT * FROM \" + tableName, \"VALUES 'a', null\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharInequality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name != 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', 'b', null\", 4);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col != 'A'\", 2);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE2NDE4NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620164184", "bodyText": "Could you please briefly describe relation between them as comment in code?", "author": "ssheikin", "createdAt": "2021-04-26T10:19:38Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/TestingConnectorBehavior.java", "diffHunk": "@@ -54,6 +54,7 @@\n \n     SUPPORTS_DELETE(false),\n     SUPPORTS_ROW_LEVEL_DELETE(SUPPORTS_DELETE),\n+    SUPPORTS_METADATA_DELETE(SUPPORTS_DELETE),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE2ODQ5OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r620168499", "bodyText": "isn't col = 'A' equality belong to SUPPORTS_ROW_LEVEL_DELETE ?\nThis could be metadata condition for some kind of Skip Indexes (e.g. https://github.com/citusdata/cstore_fdw#using-skip-indexes) but i'm not sure this is a SUPPORTS_METADATA_DELETE by default.", "author": "ssheikin", "createdAt": "2021-04-26T10:26:01Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -648,4 +662,74 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name = 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \"(col) AS VALUES 'a', 'A', null\", 3);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE col = 'A'\", 1);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTIyODk3OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629228978", "bodyText": "No. Discussed this offline.\nSUPPORTS_METADATA_DELETE is a Trino codebase concept, where no actual Trino statement is executed and the entire statement is handled by interactions with ConnectorMetadata on coordinator.", "author": "kokosing", "createdAt": "2021-05-10T09:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDE2ODQ5OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1MjE2Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629252167", "bodyText": "you can use onDataChanged here", "author": "findepi", "createdAt": "2021-05-10T10:37:30Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -289,7 +289,7 @@ public JdbcOutputTableHandle beginInsertTable(ConnectorSession session, JdbcTabl\n     public void finishInsertTable(ConnectorSession session, JdbcOutputTableHandle handle)\n     {\n         delegate.finishInsertTable(session, handle);\n-        invalidateTableCaches(new SchemaTableName(handle.getSchemaName(), handle.getTableName()));\n+        invalidateTableStatistics(new SchemaTableName(handle.getSchemaName(), handle.getTableName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1Mjg2OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629252868", "bodyText": "onDataChanged should use the new method too.", "author": "findepi", "createdAt": "2021-05-10T10:38:49Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -462,6 +462,11 @@ private void invalidateTableCaches(SchemaTableName schemaTableName)\n         invalidateColumnsCache(schemaTableName);\n         invalidateCache(tableHandleCache, key -> key.tableName.equals(schemaTableName));\n         invalidateCache(tableNamesCache, key -> key.schemaName.equals(Optional.of(schemaTableName.getSchemaName())));\n+        invalidateTableStatistics(schemaTableName);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1MzE1Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629253153", "bodyText": "Doesn't seem to belong to Invalidate only table statistics on insert commit", "author": "findepi", "createdAt": "2021-05-10T10:39:21Z", "path": "plugin/trino-druid/src/test/java/io/trino/plugin/druid/BaseDruidConnectorTest.java", "diffHunk": "@@ -40,7 +40,7 @@\n import static org.assertj.core.api.Assertions.assertThat;\n \n public abstract class BaseDruidConnectorTest\n-        extends BaseConnectorTest\n+        extends BaseJdbcConnectorTest", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3OTE3NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629279175", "bodyText": "Can this be extracted into preparatory commit?", "author": "findepi", "createdAt": "2021-05-10T11:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1MzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1Mzg4MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629253880", "bodyText": "This is not the right condition. For example, you cannot delete when there is a LIMIT or TopN applied onto JdbcTableHandle as well.", "author": "findepi", "createdAt": "2021-05-10T10:40:40Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1114,6 +1115,26 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjQwMzIzMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r642403233", "bodyText": "This is a bit pointless as DELETE does not support LIMIT.", "author": "kokosing", "createdAt": "2021-05-31T10:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1Mzg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1MTMzMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657851333", "bodyText": "it does not, but this code should not require understanding SQL to reason about it's correctness.\nIt takes a JdbcTableHandle so it should validate JdbcTableHandle shape", "author": "findepi", "createdAt": "2021-06-24T11:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1Mzg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1NDY2MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629254661", "bodyText": "it's useless, since we're making exactly one statement within this connection.\nalso, #7875", "author": "findepi", "createdAt": "2021-05-10T10:41:58Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1114,6 +1115,26 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        try (Connection connection = connectionFactory.openConnection(session)) {\n+            connection.setAutoCommit(false);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTQyMDQ2OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629420469", "bodyText": "Actually, please have a verify(connection.getAutoCommit(), as some drivers are not following spec.", "author": "findepi", "createdAt": "2021-05-10T14:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1NDY2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjQwMjE4Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r642402187", "bodyText": "This was written in a way you want. And it was failing for certain connectors. Now I don't remember the exact problem. Will do it suggested way and try to capture differences in connectors.", "author": "kokosing", "createdAt": "2021-05-31T10:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI1NDY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDMwNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629270307", "bodyText": "just return ... once you remove commit below", "author": "findepi", "createdAt": "2021-05-10T11:10:13Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -1114,6 +1115,26 @@ public String quoted(RemoteTableName remoteTableName)\n         return emptyMap();\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);\n+        QueryBuilder queryBuilder = new QueryBuilder(this);\n+        try (Connection connection = connectionFactory.openConnection(session)) {\n+            connection.setAutoCommit(false);\n+            PreparedQuery preparedQuery = queryBuilder.prepareDelete(session, connection, handle.getRequiredNamedRelation(), handle.getConstraint());\n+            OptionalLong update;\n+            try (PreparedStatement preparedStatement = queryBuilder.prepareStatement(session, connection, preparedQuery)) {\n+                update = OptionalLong.of(preparedStatement.executeUpdate());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDQ0OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629270449", "bodyText": "onDataChange", "author": "findepi", "createdAt": "2021-05-10T11:10:27Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -435,6 +436,14 @@ public String quoted(RemoteTableName remoteTableName)\n         return delegate.getTableScanRedirection(session, tableHandle);\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        OptionalLong deletedRowsCount = delegate.delete(session, handle);\n+        invalidateTableStatistics(handle.getRequiredNamedRelation().getSchemaTableName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDY5Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629270693", "bodyText": "Drop the change, see other comments", "author": "findepi", "createdAt": "2021-05-10T11:10:51Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -497,6 +497,7 @@ CacheStats getStatisticsCacheStats()\n         cache.invalidateAll(cacheKeys);\n     }\n \n+    @SuppressWarnings(\"unused\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjQwMDIxOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r642400218", "bodyText": "I cannot, as the other method is using SchemaTableName and this is using JdbcTableHandle.\nUsing always version with SchemaTableName is suboptimal when data change event does not affect entire table.\nI think that onDataChanged is too ambitious. It does not fit well with parameter JdbcTableHandle as it does not invalidate data for entire table like one could expect when data is changed. Unless \"data\" term also refers to \"metadata\"? I think the easiest is to rename it is to invalidateTableStatistics and do not pretend it is anything more than that.\nWDYT?", "author": "kokosing", "createdAt": "2021-05-31T10:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDkwMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629270900", "bodyText": "Trino;\nmaybe\n// The column is used for row-level delete, which is not supported, but it's required during analysis anyway.", "author": "findepi", "createdAt": "2021-05-10T11:11:09Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/DefaultJdbcMetadata.java", "diffHunk": "@@ -658,6 +662,40 @@ public boolean supportsMissingColumnsOnInsert()\n         return Optional.empty();\n     }\n \n+    @Override\n+    public ColumnHandle getDeleteRowIdColumnHandle(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        // This column is not actually used, but Presto engine requires this during analysis", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjQwNjIwMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r642406203", "bodyText": "Thanks.", "author": "kokosing", "createdAt": "2021-05-31T11:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MDkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MjA1NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629272055", "bodyText": "revert", "author": "findepi", "createdAt": "2021-05-10T11:13:13Z", "path": "plugin/trino-base-jdbc/src/main/java/io/trino/plugin/jdbc/JdbcTableHandle.java", "diffHunk": "@@ -100,6 +100,7 @@ public JdbcTableHandle(\n \n     /**\n      * @deprecated Use {@code asPlainTable().getSchemaTableName()} instead, but see those methods for more information, as this is not a drop-in replacement.\n+     * @return", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MzkzMA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629273930", "bodyText": "Why no SUPPORTS_DELETE, SUPPORTS_CREATE_VIEW as in BaseJdbcConnectorTest?\nDoes it indicate haps in the smoke test?", "author": "findepi", "createdAt": "2021-05-10T11:16:28Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorSmokeTest.java", "diffHunk": "@@ -14,6 +14,20 @@\n package io.trino.plugin.jdbc;\n \n import io.trino.testing.BaseConnectorSmokeTest;\n+import io.trino.testing.TestingConnectorBehavior;\n \n public abstract class BaseJdbcConnectorSmokeTest\n-        extends BaseConnectorSmokeTest {}\n+        extends BaseConnectorSmokeTest\n+{\n+    @Override\n+    protected boolean hasBehavior(TestingConnectorBehavior connectorBehavior)\n+    {\n+        switch (connectorBehavior) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjQyNTY4MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r642425680", "bodyText": "The question should be: Why SUPPORTS_DELETE, SUPPORTS_CREATE_VIEW is in BaseJdbcConnectorTest given that it is set to defaults?", "author": "kokosing", "createdAt": "2021-05-31T11:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3MzkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NDM3NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629274375", "bodyText": "Don't skip the test. Instead, add proper conditions to the test (based on the declared hasBehavior)", "author": "findepi", "createdAt": "2021-05-10T11:17:17Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -125,6 +130,15 @@ protected TestTable createTableWithUnsupportedColumn()\n \n     // TODO move common tests from connector-specific classes here\n \n+    @Override\n+    public void testDelete()\n+    {\n+        // This test is covered by BaseConnectorTest.\n+        // testDelete is very broad test that tests all kinds of delete operation,\n+        // it assumes that either connector supports delete fully or not at all.\n+        throw new SkipException(\"This connector supports metadata delete only\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NDYzOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629274638", "bodyText": "is it related?", "author": "findepi", "createdAt": "2021-05-10T11:17:51Z", "path": "plugin/trino-clickhouse/src/test/java/io/trino/plugin/clickhouse/TestClickHouseConnectorTest.java", "diffHunk": "@@ -70,6 +70,9 @@ protected boolean hasBehavior(TestingConnectorBehavior connectorBehavior)\n             case SUPPORTS_ARRAY:\n                 return false;\n \n+            case SUPPORTS_TOPN_PUSHDOWN:\n+                return false;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NDY4MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629274681", "bodyText": "Document why", "author": "findepi", "createdAt": "2021-05-10T11:17:57Z", "path": "plugin/trino-clickhouse/src/main/java/io/trino/plugin/clickhouse/ClickHouseClient.java", "diffHunk": "@@ -266,6 +267,12 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        throw new TrinoException(NOT_SUPPORTED, \"This connector does not support deletes\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NDc1OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629274758", "bodyText": "Document why", "author": "findepi", "createdAt": "2021-05-10T11:18:06Z", "path": "plugin/trino-druid/src/main/java/io/trino/plugin/druid/DruidJdbcClient.java", "diffHunk": "@@ -221,6 +222,12 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        throw new TrinoException(NOT_SUPPORTED, \"This connector does not support deletes\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NjQ5Ng==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629276496", "bodyText": "Sadly, this is a wrong name. It's hive-ism. \"metadata delete\" doesn't make any sense for JDBC connectors and that's not what implemented.\nWhat we're looking for here is \"delete delegation\" (or \"delete 'pushdown'\", but i think delegation is a better term).\n(Fortunately, there is nothing in testing connector behavior that requires us to reuse naming from SPI, and we already leverage that.)", "author": "findepi", "createdAt": "2021-05-10T11:21:19Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/TestingConnectorBehavior.java", "diffHunk": "@@ -54,6 +54,8 @@\n \n     SUPPORTS_DELETE(false),\n     SUPPORTS_ROW_LEVEL_DELETE(SUPPORTS_DELETE),\n+    // See io.trino.spi.connector.ConnectorMetadata.supportsMetadataDelete\n+    SUPPORTS_METADATA_DELETE(SUPPORTS_DELETE),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NzIwNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629277206", "bodyText": "You cannot expect this. The connector may and up doing row-level delete.", "author": "findepi", "createdAt": "2021-05-10T11:22:22Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorTest.java", "diffHunk": "@@ -577,4 +579,37 @@ public void testRenameTableAcrossSchema()\n         assertFalse(getQueryRunner().tableExists(getSession(), tableName));\n         assertFalse(getQueryRunner().tableExists(getSession(), renamedTable));\n     }\n+\n+    @Test\n+    public void testDeleteAllTable()\n+    {\n+        if (!hasBehavior(SUPPORTS_METADATA_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region\", \"This connector does not support deletes\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3NzYxNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629277617", "bodyText": "Please bring this back. This check was verifying whether ! hasBehavior(SUPPORTS_DELETE)  is declared correctly.", "author": "findepi", "createdAt": "2021-05-10T11:23:11Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorSmokeTest.java", "diffHunk": "@@ -165,26 +164,24 @@ public void testInsert()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testRowLevelDelete()\n     {\n-        if (!hasBehavior(SUPPORTS_DELETE)) {\n-            assertQueryFails(\"DELETE FROM region\", \"This connector does not support deletes\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI3ODQ1MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r629278450", "bodyText": "i'd suggest reverting this change.\nhasBehavior should allow us to drive the reusable test without need to split it up.\nthe need to split up the test indicates that testing behaviors are not defined/plugged ideally yet", "author": "findepi", "createdAt": "2021-05-10T11:24:43Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorSmokeTest.java", "diffHunk": "@@ -165,26 +164,24 @@ public void testInsert()\n     }\n \n     @Test\n-    public void testDelete()\n+    public void testRowLevelDelete()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg0OTQ3Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657849473", "bodyText": "specify actual expected rows.", "author": "findepi", "createdAt": "2021-06-24T11:07:36Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorSmokeTest.java", "diffHunk": "@@ -183,9 +183,10 @@ public void testDelete()\n         assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n \n         assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 2\", 1);\n-        assertThat(query(\"SELECT regionkey FROM \" + tableName))\n-                .skippingTypesCheck()\n-                .matches(\"VALUES 0, 1, 3, 4\");\n+        assertThat(query(\"SELECT * FROM \" + tableName + \" WHERE regionkey = 2\"))\n+                .returnsRowsCount(0);\n+        assertThat(query(\"SELECT * FROM \" + tableName))\n+                .returnsRowsCount(4);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1ODA2NQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657858065", "bodyText": "actaully -- revert the change here", "author": "findepi", "createdAt": "2021-06-24T11:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg0OTQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg0OTg5Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657849893", "bodyText": "i think this method is not necessary -- at least not in this PR, since the only two usages should be better served with returnsEmptyResult and exact result check respectively.", "author": "findepi", "createdAt": "2021-06-24T11:08:20Z", "path": "core/trino-main/src/test/java/io/trino/sql/query/QueryAssertions.java", "diffHunk": "@@ -385,9 +385,14 @@ private static void assertTypes(MaterializedResult actual, List<Type> expectedTy\n         }\n \n         public QueryAssert returnsEmptyResult()\n+        {\n+            return returnsRowsCount(0);\n+        }\n+\n+        public QueryAssert returnsRowsCount(int expected)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1MzAxMQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657853011", "bodyText": "revert", "author": "findepi", "createdAt": "2021-06-24T11:13:28Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1034,7 +1049,7 @@ private void assertConditionallyOrderedPushedDown(\n \n     private boolean expectJoinPushdown(String operator)\n     {\n-        if (\"IS NOT DISTINCT FROM\".equals(operator)) {\n+        if (\"IS NOT DISTINCT FROM\" .equals(operator)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1MzA2MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657853060", "bodyText": "revert", "author": "findepi", "createdAt": "2021-06-24T11:13:32Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1054,7 +1069,7 @@ private boolean expectJoinPushdown(String operator)\n \n     private boolean expectVarcharJoinPushdown(String operator)\n     {\n-        if (\"IS NOT DISTINCT FROM\".equals(operator)) {\n+        if (\"IS NOT DISTINCT FROM\" .equals(operator)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NDI4MQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657854281", "bodyText": "the expected message should be exact, since it's about a well defined case where predicate is not subsumed.\nif (!hasBehavior(SUPPORTS_DELETE)) {\n // handled in other test\n // OR assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n return;\n}\nif (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n  ... this assertion, but with exact expected message ...\n}", "author": "findepi", "createdAt": "2021-06-24T11:15:27Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1161,118 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testMetadataDeleteWithVarcharEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE) || !hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE name = 'ALBANIA'\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NDczNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657854737", "bodyText": "assert exact rows, eg with regionkey, name projection", "author": "findepi", "createdAt": "2021-06-24T11:16:06Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1161,118 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testMetadataDeleteWithBigintEquality()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 4\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NjI5OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657856298", "bodyText": "any link to an issue we could include here?", "author": "findepi", "createdAt": "2021-06-24T11:18:39Z", "path": "plugin/trino-druid/src/main/java/io/trino/plugin/druid/DruidJdbcClient.java", "diffHunk": "@@ -222,6 +223,13 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        // DELETE statement is not yet support in Druid (Avatica JDBC)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NzAzNw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657857037", "bodyText": "redundant, because we did not disable autocommit\nsince this is the only different between this & super, remove override", "author": "findepi", "createdAt": "2021-06-24T11:19:48Z", "path": "plugin/trino-postgresql/src/main/java/io/trino/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -748,6 +751,25 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n         return true;\n     }\n \n+    @Override\n+    public OptionalLong delete(ConnectorSession session, JdbcTableHandle handle)\n+    {\n+        checkArgument(handle.isNamedRelation(), \"Unable to delete from synthetic table: %s\", handle);\n+        checkArgument(handle.getLimit().isEmpty(), \"Unable to delete when limit is set: %s\", handle);\n+        try (Connection connection = connectionFactory.openConnection(session)) {\n+            QueryBuilder queryBuilder = new QueryBuilder(this);\n+            PreparedQuery preparedQuery = queryBuilder.prepareDelete(session, connection, handle.getRequiredNamedRelation(), handle.getConstraint());\n+            try (PreparedStatement preparedStatement = queryBuilder.prepareStatement(session, connection, preparedQuery)) {\n+                int affectedRowsCount = preparedStatement.executeUpdate();\n+                connection.commit();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY2ODE3OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r658668178", "bodyText": "I will add a comment, it is required. Otherwise PSQL does not commit the delete.", "author": "kokosing", "createdAt": "2021-06-25T10:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NzAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1NzUyMQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657857521", "bodyText": "is it only reorg of test cases?\nmove to separate commit", "author": "findepi", "createdAt": "2021-06-24T11:20:37Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -616,19 +616,8 @@ public void testDelete()\n         }\n \n         String tableName = \"test_delete_\" + randomTableSuffix();\n-        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", \"SELECT count(*) FROM orders\");\n-\n-        // delete half the table, then delete the rest\n-        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE orderkey % 2 = 0\", \"SELECT count(*) FROM orders WHERE orderkey % 2 = 0\");\n-        assertQuery(\"SELECT * FROM \" + tableName, \"SELECT * FROM orders WHERE orderkey % 2 <> 0\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1ODUzNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657858536", "bodyText": "Let's make it exact (without |), i hope it is possible", "author": "findepi", "createdAt": "2021-06-24T11:22:14Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorTest.java", "diffHunk": "@@ -725,4 +726,42 @@ public void testRenameTableAcrossSchema()\n         assertFalse(getQueryRunner().tableExists(getSession(), tableName));\n         assertFalse(getQueryRunner().tableExists(getSession(), renamedTable));\n     }\n+\n+    @Test\n+    public void testDeleteAllTable()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region\", \"This connector does not support deletes\");\n+            return;\n+        }\n+\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM nation\", 25);\n+        // not using assertUpdate as some connectors provide update count and some not\n+        getQueryRunner().execute(\"DELETE FROM \" + tableName);\n+        assertQuery(\"SELECT count(*) FROM \" + tableName, \"VALUES 0\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testRowLevelDelete()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        if (!hasBehavior(SUPPORTS_ROW_LEVEL_DELETE)) {\n+            assertQueryFails(\n+                    \"DELETE FROM nation WHERE nationkey = 2\",\n+                    \"(.*[Dd]elet(e|ing).*(not |un)supported.*)\" +\n+                            \"|(This connector does not support deletes)\" +\n+                            \"|(Unsupported delete)\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzg1ODg1OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r657858858", "bodyText": "move out new tests / test refactor to a commit separate from JDBC delete", "author": "findepi", "createdAt": "2021-06-24T11:22:46Z", "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/AbstractTestIcebergConnectorTest.java", "diffHunk": "@@ -141,6 +141,54 @@ public void testDelete()\n                 .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n     }\n \n+    @Override\n+    public void testDeleteWithComplexPredicate()\n+    {\n+        // Deletes are covered with testMetadata*Delete test methods\n+        assertThatThrownBy(super::testDeleteWithComplexPredicate)\n+                .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSemiJoin()\n+    {\n+        // Deletes are covered with testMetadata*Delete test methods\n+        assertThatThrownBy(super::testDeleteWithSemiJoin)\n+                .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSubquery()\n+    {\n+        // Deletes are covered with testMetadata*Delete test methods\n+        assertThatThrownBy(super::testDeleteWithSubquery)\n+                .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithVarcharPredicate()\n+    {\n+        // Deletes are covered with testMetadata*Delete test methods\n+        assertThatThrownBy(super::testDeleteWithVarcharPredicate)\n+                .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n+    }\n+\n+    @Override\n+    public void testDeleteAllTable()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgxMDYwNA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r659810604", "bodyText": "Outdated comments?\nmaybe just remove them?", "author": "ssheikin", "createdAt": "2021-06-28T13:56:59Z", "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/AbstractTestIcebergConnectorTest.java", "diffHunk": "@@ -141,6 +141,46 @@ public void testDelete()\n                 .hasStackTraceContaining(\"This connector only supports delete where one or more partitions are deleted entirely\");\n     }\n \n+    @Override\n+    public void testDeleteWithComplexPredicate()\n+    {\n+        // Deletes are covered with testMetadata*Delete test methods", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDM3OTk5Mg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660379992", "bodyText": "No. It is copied from other not supported test for deletes. Delete in Iceberg is special.", "author": "kokosing", "createdAt": "2021-06-29T08:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgxMDYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDQzMzA1OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660433058", "bodyText": "I see only testMetadataDelete (without star) in codebase and in this pr.", "author": "ssheikin", "createdAt": "2021-06-29T09:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgxMDYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgxMjI2Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r659812263", "bodyText": "testDeleteWithSubquery -> testDeleteWithVarcharPredicate", "author": "ssheikin", "createdAt": "2021-06-28T13:58:50Z", "path": "plugin/trino-hive/src/test/java/io/trino/plugin/hive/TestHiveConnectorTest.java", "diffHunk": "@@ -222,6 +222,41 @@ public void testDelete()\n                 .hasStackTraceContaining(\"Deletes must match whole partitions for non-transactional tables\");\n     }\n \n+    @Override\n+    public void testDeleteWithComplexPredicate()\n+    {\n+        assertThatThrownBy(super::testDeleteWithComplexPredicate)\n+                .hasStackTraceContaining(\"Deletes must match whole partitions for non-transactional tables\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSemiJoin()\n+    {\n+        assertThatThrownBy(super::testDeleteWithSemiJoin)\n+                .hasStackTraceContaining(\"Deletes must match whole partitions for non-transactional tables\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSubquery()\n+    {\n+        assertThatThrownBy(super::testDeleteWithSubquery)\n+                .hasStackTraceContaining(\"Deletes must match whole partitions for non-transactional tables\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithVarcharPredicate()\n+    {\n+        assertThatThrownBy(super::testDeleteWithSubquery)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgzMzU5OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r659833599", "bodyText": "I know we already discussed it before, but I'm still not convinced to a check where the result is compared with 0.\nUp to you.", "author": "ssheikin", "createdAt": "2021-06-28T14:23:31Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1162,121 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testDeleteWithBigintEqualityPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\n+                \"SELECT regionkey, name FROM \" + tableName,\n+                \"VALUES \"\n+                        + \"(0, 'AFRICA'),\"\n+                        + \"(2, 'ASIA'),\"\n+                        + \"(3, 'EUROPE'),\"\n+                        + \"(4, 'MIDDLE EAST')\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharEqualityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'a', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharInequalityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'A', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharGreaterAndLowerPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"'b'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", \"Unsupported delete\");\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col > 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", 0);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgzNzg3OA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r659837878", "bodyText": "unnecessary comment", "author": "ssheikin", "createdAt": "2021-06-28T14:28:24Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1162,121 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testDeleteWithBigintEqualityPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\n+                \"SELECT regionkey, name FROM \" + tableName,\n+                \"VALUES \"\n+                        + \"(0, 'AFRICA'),\"\n+                        + \"(2, 'ASIA'),\"\n+                        + \"(3, 'EUROPE'),\"\n+                        + \"(4, 'MIDDLE EAST')\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharEqualityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'a', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharInequalityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'A', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharGreaterAndLowerPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"'b'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", \"Unsupported delete\");\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col > 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", 0);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'a', 'A', 'b', null\");\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col > 'A'\", 2);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'A', null\");\n+        }\n+    }\n+\n+    @Override\n+    public void testDeleteWithComplexPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithComplexPredicate())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSubquery()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithSubquery())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSemiJoin()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithSemiJoin())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithVarcharPredicate()\n+    {\n+        // testMetadataDeleteWithVarcharEquality", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4851774f0069616d3f960ed6e7852bf43d25fc84", "url": "https://github.com/trinodb/trino/commit/4851774f0069616d3f960ed6e7852bf43d25fc84", "message": "Extract complex delete tests to separate test methods\n\nSome connector might have partial support for DELETE statement.", "committedDate": "2021-06-29T07:59:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDM4MzM1Mw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660383353", "bodyText": "Can we add support for correlated sub query ... So that we could ensure it works for corelated joins too.", "author": "Praveen2112", "createdAt": "2021-06-29T08:11:50Z", "path": "testing/trino-testing/src/main/java/io/trino/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -675,8 +696,26 @@ public void testDelete()\n \n         assertUpdate(\"DROP TABLE \" + tableName);\n \n-        // delete with multiple SemiJoin\n+        // delete using a scalar and EXISTS subquery\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM orders\", \"SELECT count(*) FROM orders\");\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE orderkey = (SELECT orderkey FROM orders ORDER BY orderkey LIMIT 1)\", 1);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE orderkey = (SELECT orderkey FROM orders WHERE false)\", 0);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDM4NjYyOA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660386628", "bodyText": "It is out of the scope of this PR. Surely it won't be supported for jdbc connectors.", "author": "kokosing", "createdAt": "2021-06-29T08:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDM4MzM1Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDQyOTYzMg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660429632", "bodyText": "Where does testMetadataDeleteWithVarcharEquality live?", "author": "ssheikin", "createdAt": "2021-06-29T09:11:21Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1162,120 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testDeleteWithBigintEqualityPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        String tableName = \"test_delete_\" + randomTableSuffix();\n+        assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT * FROM region\", 5);\n+        assertUpdate(\"DELETE FROM \" + tableName + \" WHERE regionkey = 1\", 1);\n+        assertQuery(\n+                \"SELECT regionkey, name FROM \" + tableName,\n+                \"VALUES \"\n+                        + \"(0, 'AFRICA'),\"\n+                        + \"(2, 'ASIA'),\"\n+                        + \"(3, 'EUROPE'),\"\n+                        + \"(4, 'MIDDLE EAST')\");\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharEqualityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_EQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col = 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'a', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharInequalityPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'a'\", \"'A'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col != 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'A', null\");\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteWithVarcharGreaterAndLowerPredicate()\n+    {\n+        try (TestTable table = new TestTable(getQueryRunner()::execute, \"test_delete\", \"(col varchar(1))\", ImmutableList.of(\"'0'\", \"'a'\", \"'A'\", \"'b'\", \"null\"))) {\n+            if (!hasBehavior(SUPPORTS_DELETE)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName(), \"This connector does not support deletes\");\n+                return;\n+            }\n+            if (!hasBehavior(SUPPORTS_PREDICATE_PUSHDOWN_WITH_VARCHAR_INEQUALITY)) {\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", \"Unsupported delete\");\n+                assertQueryFails(\"DELETE FROM \" + table.getName() + \" WHERE col > 'A'\", \"Unsupported delete\");\n+                return;\n+            }\n+\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col < 'A'\", 1);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'a', 'A', 'b', null\");\n+            assertUpdate(\"DELETE FROM \" + table.getName() + \" WHERE col > 'A'\", 2);\n+            assertQuery(\"SELECT * FROM \" + table.getName(), \"VALUES 'A', null\");\n+        }\n+    }\n+\n+    @Override\n+    public void testDeleteWithComplexPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithComplexPredicate())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSubquery()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithSubquery())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithSemiJoin()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM nation\", \"This connector does not support deletes\");\n+            return;\n+        }\n+        assertThatThrownBy(() -> super.testDeleteWithSemiJoin())\n+                .hasStackTraceContaining(\"TrinoException: Unsupported delete\");\n+    }\n+\n+    @Override\n+    public void testDeleteWithVarcharPredicate()\n+    {\n+        throw new SkipException(\"This is implemented by testMetadataDeleteWithVarcharEquality\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDQ0OTkxMw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r660449913", "bodyText": "It should be testDeleteWithVarcharEqualityPredicate", "author": "kokosing", "createdAt": "2021-06-29T09:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDQyOTYzMg=="}], "type": "inlineReview"}, {"oid": "2d9a11362385b1b8624c0efaa1ca252a82a4113c", "url": "https://github.com/trinodb/trino/commit/2d9a11362385b1b8624c0efaa1ca252a82a4113c", "message": "Support metadata DELETE in JDBC connectors", "committedDate": "2021-06-29T09:41:37Z", "type": "commit"}, {"oid": "2d9a11362385b1b8624c0efaa1ca252a82a4113c", "url": "https://github.com/trinodb/trino/commit/2d9a11362385b1b8624c0efaa1ca252a82a4113c", "message": "Support metadata DELETE in JDBC connectors", "committedDate": "2021-06-29T09:41:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MDUyNg==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r663860526", "bodyText": "@kokosing In case of connectors where the test infra is shared this can lead to test data being deleted.\nOr is the assumption that if the hasBehavior is implemented correctly it shouldn't matter since the actual test performs deletions against copies of tables?", "author": "hashhar", "createdAt": "2021-07-05T11:33:55Z", "path": "plugin/trino-base-jdbc/src/test/java/io/trino/plugin/jdbc/BaseJdbcConnectorTest.java", "diffHunk": "@@ -1146,4 +1162,120 @@ protected TestView createSleepingView(Duration minimalSleepDuration)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    @Test\n+    public void testDeleteWithBigintEqualityPredicate()\n+    {\n+        if (!hasBehavior(SUPPORTS_DELETE)) {\n+            assertQueryFails(\"DELETE FROM region WHERE regionkey = 1\", \"This connector does not support deletes\");", "originalCommit": "2d9a11362385b1b8624c0efaa1ca252a82a4113c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MTA0OQ==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r663861049", "bodyText": "I'm submitting a PR to change this to follow the approach in testDeleteWithVarcharEqualityPredicate where an explicit TestTable is created for the negative test case.", "author": "hashhar", "createdAt": "2021-07-05T11:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MDUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg4ODA2Nw==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r663888067", "bodyText": "Thanks!", "author": "kokosing", "createdAt": "2021-07-05T12:20:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MDUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODAwODE0NA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r668008144", "bodyText": "@hashhar if you're concerned about that, there are other cases like that in tests, where negative test cases are \"dangerous\".\n(i was not concerned as much as you are ...)", "author": "findepi", "createdAt": "2021-07-12T14:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MDUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2ODAzMTg0MA==", "url": "https://github.com/trinodb/trino/pull/6287#discussion_r668031840", "bodyText": "eg \n  \n    \n      trino/testing/trino-testing/src/main/java/io/trino/testing/BaseConnectorTest.java\n    \n    \n         Line 700\n      in\n      96be8f2\n    \n    \n    \n    \n\n        \n          \n           assertQueryFails(\"ALTER TABLE nation RENAME TO other_schema.yyyy\", \"This connector does not support renaming tables across schemas\");", "author": "findepi", "createdAt": "2021-07-12T15:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mzg2MDUyNg=="}], "type": "inlineReview"}]}