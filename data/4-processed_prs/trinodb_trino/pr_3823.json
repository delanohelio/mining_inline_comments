{"pr_number": 3823, "pr_title": "Fix Rubix flaky tests", "pr_createdAt": "2020-05-22T14:59:44Z", "pr_url": "https://github.com/trinodb/trino/pull/3823", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNDQ4NQ==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429414485", "bodyText": "I would rather add some logic to probe for port to see if it can be bound. Not just blindly iterate forward. We can run into some other port which is already open on the machine.\nAlso I want to understand what is the reason for the ports to remain open after previous tests complete. Maybe we can fix the root cause.", "author": "losipiuk", "createdAt": "2020-05-22T19:12:58Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -134,6 +137,12 @@ private RubixConfigurationInitializer initializeRubix(RubixConfig rubixConfig)\n \n         // initialize rubix in master-only mode\n         rubixConfig.setStartServerOnCoordinator(true);\n+\n+        // use different rubix ports for each test to prevent nondeterministic bind errors\n+        rubixConfig.setBookKeeperServerPort(DEFAULT_BOOKKEEPER_SERVER_PORT + cachingFileSystemCounter);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzODg1OQ==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429438859", "bodyText": "added waiting for Rubix servers to stop", "author": "sopel39", "createdAt": "2020-05-22T20:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNDQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNDkxMA==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429414910", "bodyText": "There might be IO operations caused by data preparations before tests start.\nInstead of this, i would rather work on the test to be more resilient.\nMaybe you can wait before the test start for any async IOs to complete? (there could be JMX counter with current async IOs)\nor maybe you can change the assertions in the test?", "author": "findepi", "createdAt": "2020-05-22T19:13:58Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -32,6 +32,9 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n import static org.testng.Assert.assertEquals;\n \n+// make sure dedicated Rubix tests are executed first so that JMX counters are all set to 0\n+// and no pending async read is in progress\n+@Test(priority = -1)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzOTUyMw==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429439523", "bodyText": "Made that test to run exclusively.\n\nThere might be IO operations caused by data preparations before tests start.\n\nInserts don't affect cache.\n\nInstead of this, i would rather work on the test to be more resilient.\n\nBelieve me. I tried. Rubix doesn't provide strict consistency for JMX counters in async read mode.\n\nMaybe you can wait before the test start for any async IOs to complete? (there could be JMX counter with current async IOs\n\nThere is such counter, but it's not reliable. You would still have to sleep.", "author": "sopel39", "createdAt": "2020-05-22T20:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNDkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNTU1MA==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429415550", "bodyText": "The test class is executed single threaded, so previously allocated ports should be free to take.\nIf this is not the case, this means that resource cleanup is ineffective, or async. It shouldn't be.", "author": "findepi", "createdAt": "2020-05-22T19:15:45Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -134,6 +137,12 @@ private RubixConfigurationInitializer initializeRubix(RubixConfig rubixConfig)\n \n         // initialize rubix in master-only mode\n         rubixConfig.setStartServerOnCoordinator(true);\n+\n+        // use different rubix ports for each test to prevent nondeterministic bind errors\n+        rubixConfig.setBookKeeperServerPort(DEFAULT_BOOKKEEPER_SERVER_PORT + cachingFileSystemCounter);\n+        rubixConfig.setDataTransferServerPort(DEFAULT_DATA_TRANSFER_SERVER_PORT + cachingFileSystemCounter);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ0MDc2Ng==", "url": "https://github.com/trinodb/trino/pull/3823#discussion_r429440766", "bodyText": "The test class is executed single threaded, so previously allocated ports should be free to take.\n\nTests is single-threaded, but Rubix servers are not. Added waiting for Rubix server to stop on shutdown", "author": "sopel39", "createdAt": "2020-05-22T20:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNTU1MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "31469b4f49a7d3ef031bec802ceba5751bf051d2", "url": "https://github.com/trinodb/trino/commit/31469b4f49a7d3ef031bec802ceba5751bf051d2", "message": "Make TestHiveCaching#testReadFromTable more resilient", "committedDate": "2020-05-22T22:11:13Z", "type": "commit"}, {"oid": "31469b4f49a7d3ef031bec802ceba5751bf051d2", "url": "https://github.com/trinodb/trino/commit/31469b4f49a7d3ef031bec802ceba5751bf051d2", "message": "Make TestHiveCaching#testReadFromTable more resilient", "committedDate": "2020-05-22T22:11:13Z", "type": "forcePushed"}]}