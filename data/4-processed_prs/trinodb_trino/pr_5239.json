{"pr_number": 5239, "pr_title": "Close postgres test resources in order", "pr_createdAt": "2020-09-21T12:03:55Z", "pr_url": "https://github.com/trinodb/trino/pull/5239", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNjE3Mg==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492516172", "bodyText": "Regarding commit message:\nBefore this change query runner was closed before testing PSQL server.\nThat led to situation that there was a time where query runner was up\nand running but without a dependant service.\n\nI think you meant:\nBefore this change testing PSQL server was closed before query runner", "author": "losipiuk", "createdAt": "2020-09-22T07:09:27Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "diffHunk": "@@ -17,7 +17,6 @@\n import com.google.common.collect.ImmutableSet;\n import io.prestosql.testing.AbstractTestQueryFramework;\n import io.prestosql.testing.QueryRunner;\n-import org.testng.annotations.AfterClass;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNzAzOQ==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492517039", "bodyText": "rename to registerForClosing", "author": "losipiuk", "createdAt": "2020-09-22T07:11:12Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -459,4 +464,10 @@ protected OperatorStats searchScanFilterAndProjectOperatorStats(QueryId queryId,\n                 .filter(summary -> nodeId.equals(summary.getPlanNodeId()) && summary.getOperatorType().equals(\"ScanFilterAndProjectOperator\"))\n                 .collect(MoreCollectors.onlyElement());\n     }\n+\n+    @CanIgnoreReturnValue\n+    protected final <T extends Closeable> T registerResource(T resource)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMzY2Nw==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492523667", "bodyText": "registerResource is misleading, as you're registering a callback\n(the declaration looks legit, but the call site like this looks weird)", "author": "findepi", "createdAt": "2020-09-22T07:25:02Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -33,6 +32,10 @@ protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n         postgreSqlServer = new TestingPostgreSqlServer();\n+        registerResource(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMjEyNA==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492532124", "bodyText": "I was thinking also about closeAfterClass? WDYT?", "author": "kokosing", "createdAt": "2020-09-22T07:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMzY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNDMyMA==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492524320", "bodyText": "That led to situation that there was a time where query runner was up\nand running but without a dependant service.\n\nWas it a problem?", "author": "findepi", "createdAt": "2020-09-22T07:26:15Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -44,12 +47,6 @@ protected QueryRunner createQueryRunner()\n                 TpchTable.getTables());\n     }\n \n-    @AfterClass(alwaysRun = true)\n-    public final void destroy()\n-    {\n-        postgreSqlServer.close();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMTk2MA==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492531960", "bodyText": "It is not a problem Postgres testing, it does not manifest itself anyhow. It is a generic problem with resources in ATQF, and Postgres tests are just example.", "author": "kokosing", "createdAt": "2020-09-22T07:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNDMyMA=="}], "type": "inlineReview"}, {"oid": "9ff3b217b9931d42d4cc78a3d835150ed02cc07d", "url": "https://github.com/trinodb/trino/commit/9ff3b217b9931d42d4cc78a3d835150ed02cc07d", "message": "Remove extra this", "committedDate": "2020-09-22T07:55:51Z", "type": "commit"}, {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "url": "https://github.com/trinodb/trino/commit/e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "message": "Close Postgres test resources in order\n\nBefore this change testing Postgres server was closed before the query runner.\nThat led to the situation where query runner was up\nand running but without a dependant service.\n\nIn case of Postgres testing this was not causing any issue as query runner\nwas not used during that time, but this reveals a generic tests infra\nissue that may affect other tests.", "committedDate": "2020-09-22T07:55:51Z", "type": "commit"}, {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "url": "https://github.com/trinodb/trino/commit/e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "message": "Close Postgres test resources in order\n\nBefore this change testing Postgres server was closed before the query runner.\nThat led to the situation where query runner was up\nand running but without a dependant service.\n\nIn case of Postgres testing this was not causing any issue as query runner\nwas not used during that time, but this reveals a generic tests infra\nissue that may affect other tests.", "committedDate": "2020-09-22T07:55:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3Mzk0NA==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492573944", "bodyText": "when good order is now maintained,... = null is excessive, it doesn't help much (or even at all) now, but hurts readability a lot, postgreSqlServer = closeAfterClass(new ...) is enough", "author": "iirekm", "createdAt": "2020-09-22T08:51:57Z", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "diffHunk": "@@ -41,20 +40,18 @@\n     protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n-        this.postgreSqlServer = new TestingPostgreSqlServer();\n+        postgreSqlServer = new TestingPostgreSqlServer();\n+        closeAfterClass(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "originalCommit": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NjgyNQ==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492586825", "bodyText": "It hurts readability, but it is sanity check. So it is impossible to access postgreSqlServer in not usable state. Alternatively we could mantain state in TestingPostgreSqlServer to know that is CREATED or STARTED or CLOSED but this is even worse.", "author": "kokosing", "createdAt": "2020-09-22T09:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3Mzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NDcwOA==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492574708", "bodyText": "for better readabillity afterClassClose, or something alike, because we also have after-method 'close' in many tests", "author": "iirekm", "createdAt": "2020-09-22T08:53:12Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -100,8 +104,9 @@ protected abstract QueryRunner createQueryRunner()\n \n     @AfterClass(alwaysRun = true)\n     public void close()\n+            throws IOException", "originalCommit": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NzI1Mw==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492587253", "bodyText": "Let me avoid doing refactors in this pull requests.", "author": "kokosing", "createdAt": "2020-09-22T09:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NDcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzE5Mw==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492577193", "bodyText": "nit: use Closer from starburst-presto", "author": "iirekm", "createdAt": "2020-09-22T08:57:07Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();", "originalCommit": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4ODE1NQ==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492588155", "bodyText": "Let me handle that in separate pr.", "author": "kokosing", "createdAt": "2020-09-22T09:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzQ3MQ==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492577471", "bodyText": "beforeClass or something alike to not confuse z before-method initializations", "author": "iirekm", "createdAt": "2020-09-22T08:57:32Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();\n     private io.prestosql.sql.query.QueryAssertions queryAssertions;\n \n     @BeforeClass\n     public void init()", "originalCommit": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NzI4Mw==", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492587283", "bodyText": "Let me avoid doing refactors in this pull requests.", "author": "kokosing", "createdAt": "2020-09-22T09:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzQ3MQ=="}], "type": "inlineReview"}]}