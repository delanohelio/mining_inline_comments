{"pr_number": 6213, "pr_title": "Improve split generation for symlinked tables", "pr_createdAt": "2020-12-05T19:59:17Z", "pr_url": "https://github.com/trinodb/trino/pull/6213", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzODA0MA==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537838040", "bodyText": "The canonical way is HiveStorageFormat.values()", "author": "electrum", "createdAt": "2020-12-07T21:15:32Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -308,11 +309,14 @@ private static void configureCompressionCodecs(JobConf jobConf)\n \n             Class<? extends InputFormat<?, ?>> inputFormatClass = getInputFormatClass(jobConf, inputFormatName);\n             if (symlinkTarget && inputFormatClass == SymlinkTextInputFormat.class) {\n-                // Symlink targets are assumed to be TEXTFILE unless serde indicates otherwise.\n-                inputFormatClass = TextInputFormat.class;\n-                if (isDeserializerClass(schema, AvroSerDe.class)) {\n-                    inputFormatClass = AvroContainerInputFormat.class;\n+                String serDe = getDeserializerClassName(schema);\n+                for (HiveStorageFormat format : EnumSet.allOf(HiveStorageFormat.class)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzOTA5OA==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537839098", "bodyText": "No need to qualify method call", "author": "electrum", "createdAt": "2020-12-07T21:17:12Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -308,11 +309,14 @@ private static void configureCompressionCodecs(JobConf jobConf)\n \n             Class<? extends InputFormat<?, ?>> inputFormatClass = getInputFormatClass(jobConf, inputFormatName);\n             if (symlinkTarget && inputFormatClass == SymlinkTextInputFormat.class) {\n-                // Symlink targets are assumed to be TEXTFILE unless serde indicates otherwise.\n-                inputFormatClass = TextInputFormat.class;\n-                if (isDeserializerClass(schema, AvroSerDe.class)) {\n-                    inputFormatClass = AvroContainerInputFormat.class;\n+                String serDe = getDeserializerClassName(schema);\n+                for (HiveStorageFormat format : EnumSet.allOf(HiveStorageFormat.class)) {\n+                    if (serDe.equals(format.getSerDe())) {\n+                        inputFormatClass = HiveUtil.getInputFormatClass(jobConf, format.getInputFormat());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0MzA2Ng==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537843066", "bodyText": "INVALID_TABLE_PROPERTY is for when the user is creating a table in Presto and specifies an invalid table property. We have HIVE_UNSUPPORTED_FORMAT which seems to exactly match this error case. Also, it's better to put the variable part of the error message at the end, so that the fixed part of the message is more searchable.\nHow about\nthrow new PrestoException(HIVE_UNSUPPORTED_FORMAT, \"Unknown SerDe for SymlinkTextInputFormat: \" + serDe);", "author": "electrum", "createdAt": "2020-12-07T21:23:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -308,11 +309,14 @@ private static void configureCompressionCodecs(JobConf jobConf)\n \n             Class<? extends InputFormat<?, ?>> inputFormatClass = getInputFormatClass(jobConf, inputFormatName);\n             if (symlinkTarget && inputFormatClass == SymlinkTextInputFormat.class) {\n-                // Symlink targets are assumed to be TEXTFILE unless serde indicates otherwise.\n-                inputFormatClass = TextInputFormat.class;\n-                if (isDeserializerClass(schema, AvroSerDe.class)) {\n-                    inputFormatClass = AvroContainerInputFormat.class;\n+                String serDe = getDeserializerClassName(schema);\n+                for (HiveStorageFormat format : EnumSet.allOf(HiveStorageFormat.class)) {\n+                    if (serDe.equals(format.getSerDe())) {\n+                        inputFormatClass = HiveUtil.getInputFormatClass(jobConf, format.getInputFormat());\n+                        return ReflectionUtils.newInstance(inputFormatClass, jobConf);\n+                    }\n                 }\n+                throw new PrestoException(INVALID_TABLE_PROPERTY, format(\"No corresponding InputFormat for SerDe %s for SymlinkTextInputFormat table\", serDe));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NDI5NQ==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537844295", "bodyText": "We could use AVRO.getInputFormat() to match the above AVRO.getSerDe()", "author": "electrum", "createdAt": "2020-12-07T21:25:58Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -769,7 +769,7 @@ public void testBuildManifestFileIterator()\n                 files,\n                 directoryLister);\n         Optional<Iterator<InternalHiveSplit>> splitIterator = backgroundHiveSplitLoader.buildManifestFileIterator(\n-                configuration,\n+                new AvroContainerInputFormat(),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3Njk5MQ==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r538176991", "bodyText": "AVRO.getInputFormat() returns string while we need instance here", "author": "sopel39", "createdAt": "2020-12-08T09:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NDI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NDMzNw==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537844337", "bodyText": "Same here", "author": "electrum", "createdAt": "2020-12-07T21:26:01Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -808,7 +807,7 @@ public void testBuildManifestFileIteratorNestedDirectory()\n                 files,\n                 directoryLister);\n         Optional<Iterator<InternalHiveSplit>> splitIterator = backgroundHiveSplitLoader.buildManifestFileIterator(\n-                configuration,\n+                new AvroContainerInputFormat(),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NTU2OA==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537845568", "bodyText": "PARQUET.getInputFormat()", "author": "electrum", "createdAt": "2020-12-07T21:28:05Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/util/TestHiveUtil.java", "diffHunk": "@@ -75,6 +83,29 @@ public void testToPartitionValues()\n         assertToPartitionValues(\"pk=__HIVE_DEFAULT_PARTITION__\");\n     }\n \n+    @Test\n+    public void testGetInputFormat()\n+    {\n+        Configuration configuration = new Configuration(false);\n+\n+        Properties avroSymlinkSchema = new Properties();\n+        avroSymlinkSchema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        avroSymlinkSchema.setProperty(SERIALIZATION_LIB, AVRO.getSerDe());\n+        assertTrue(getInputFormat(configuration, avroSymlinkSchema, false) instanceof SymlinkTextInputFormat);\n+        assertTrue(getInputFormat(configuration, avroSymlinkSchema, true) instanceof AvroContainerInputFormat);\n+\n+        Properties parquetSymlinkSchema = new Properties();\n+        parquetSymlinkSchema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        parquetSymlinkSchema.setProperty(SERIALIZATION_LIB, PARQUET.getSerDe());\n+        assertTrue(getInputFormat(configuration, parquetSymlinkSchema, false) instanceof SymlinkTextInputFormat);\n+        assertTrue(getInputFormat(configuration, parquetSymlinkSchema, true) instanceof MapredParquetInputFormat);\n+\n+        Properties parquetSchema = new Properties();\n+        parquetSchema.setProperty(FILE_INPUT_FORMAT, MapredParquetInputFormat.class.getName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NjI3Nw==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537846277", "bodyText": "Use assertInstanceOf() since it provides a better error message. In general, assertTrue() should not be used with a predicate -- try to express the predicate using an assertion method or AssertJ.", "author": "electrum", "createdAt": "2020-12-07T21:29:21Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/util/TestHiveUtil.java", "diffHunk": "@@ -75,6 +83,29 @@ public void testToPartitionValues()\n         assertToPartitionValues(\"pk=__HIVE_DEFAULT_PARTITION__\");\n     }\n \n+    @Test\n+    public void testGetInputFormat()\n+    {\n+        Configuration configuration = new Configuration(false);\n+\n+        Properties avroSymlinkSchema = new Properties();\n+        avroSymlinkSchema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        avroSymlinkSchema.setProperty(SERIALIZATION_LIB, AVRO.getSerDe());\n+        assertTrue(getInputFormat(configuration, avroSymlinkSchema, false) instanceof SymlinkTextInputFormat);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NzU5Ng==", "url": "https://github.com/trinodb/trino/pull/6213#discussion_r537847596", "bodyText": "Add a test for the legacy Parquet handling\nProperties legacyParquetSchema = new Properties();\nparquetSchema.setProperty(FILE_INPUT_FORMAT, \"parquet.hive.MapredParquetInputFormat\");\nassertInstanceOf(getInputFormat(configuration, legacyParquetSchema, false), MapredParquetInputFormat.class);\nassertInstanceOf(getInputFormat(configuration, legacyParquetSchema, true), MapredParquetInputFormat.class);", "author": "electrum", "createdAt": "2020-12-07T21:31:40Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/util/TestHiveUtil.java", "diffHunk": "@@ -75,6 +83,29 @@ public void testToPartitionValues()\n         assertToPartitionValues(\"pk=__HIVE_DEFAULT_PARTITION__\");\n     }\n \n+    @Test\n+    public void testGetInputFormat()\n+    {\n+        Configuration configuration = new Configuration(false);\n+\n+        Properties avroSymlinkSchema = new Properties();\n+        avroSymlinkSchema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        avroSymlinkSchema.setProperty(SERIALIZATION_LIB, AVRO.getSerDe());\n+        assertTrue(getInputFormat(configuration, avroSymlinkSchema, false) instanceof SymlinkTextInputFormat);\n+        assertTrue(getInputFormat(configuration, avroSymlinkSchema, true) instanceof AvroContainerInputFormat);\n+\n+        Properties parquetSymlinkSchema = new Properties();\n+        parquetSymlinkSchema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        parquetSymlinkSchema.setProperty(SERIALIZATION_LIB, PARQUET.getSerDe());\n+        assertTrue(getInputFormat(configuration, parquetSymlinkSchema, false) instanceof SymlinkTextInputFormat);\n+        assertTrue(getInputFormat(configuration, parquetSymlinkSchema, true) instanceof MapredParquetInputFormat);\n+\n+        Properties parquetSchema = new Properties();\n+        parquetSchema.setProperty(FILE_INPUT_FORMAT, MapredParquetInputFormat.class.getName());\n+        assertTrue(getInputFormat(configuration, parquetSchema, false) instanceof MapredParquetInputFormat);\n+        assertTrue(getInputFormat(configuration, parquetSchema, true) instanceof MapredParquetInputFormat);\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3756d9d4a321713b3040a6bd68b801235554f88d", "url": "https://github.com/trinodb/trino/commit/3756d9d4a321713b3040a6bd68b801235554f88d", "message": "Improve split generation for symlinked tables\n\nPreviously text or avro input format was assumed as\nsymlink target format. This prevented generation of\nmultiple splits per file. This change makes split\nenumeration to use actual symlink target format.", "committedDate": "2020-12-08T09:43:47Z", "type": "commit"}, {"oid": "3756d9d4a321713b3040a6bd68b801235554f88d", "url": "https://github.com/trinodb/trino/commit/3756d9d4a321713b3040a6bd68b801235554f88d", "message": "Improve split generation for symlinked tables\n\nPreviously text or avro input format was assumed as\nsymlink target format. This prevented generation of\nmultiple splits per file. This change makes split\nenumeration to use actual symlink target format.", "committedDate": "2020-12-08T09:43:47Z", "type": "forcePushed"}]}