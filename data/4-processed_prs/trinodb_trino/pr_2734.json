{"pr_number": 2734, "pr_title": "Remove getTable call from updatePartitionStatistics", "pr_createdAt": "2020-02-05T09:08:27Z", "pr_url": "https://github.com/trinodb/trino/pull/2734", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNzM1Ng==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r375137356", "bodyText": "use HiveMetastoreClousure here", "author": "sopel39", "createdAt": "2020-02-05T09:17:33Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "diffHunk": "@@ -97,6 +99,8 @@ private void doDropStats(ConnectorSession session, String schema, String table,\n                 .filter(HiveColumnHandle::isPartitionKey)\n                 .map(HiveColumnHandle::getName)\n                 .collect(toImmutableList());\n+        Table tableMetadata = metastore.getTable(new HiveIdentity(session.getIdentity()), schema, table)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376970164", "bodyText": "the methods here are either not implement (throw) or implemented.", "author": "findepi", "createdAt": "2020-02-10T10:12:37Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -218,7 +218,8 @@ public void deleteTableColumnStatistics(String databaseName, String tableName, S\n     @Override\n     public void setPartitionColumnStatistics(String databaseName, String tableName, String partitionName, List<ColumnStatisticsObj> statistics)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NDI2OA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376974268", "bodyText": "@sopel39 @electrum what about replacing MockThriftMetastoreClient with InMemoryThriftMetastore (+ access counting wrapper) in TestCachingHiveMetastore?", "author": "findepi", "createdAt": "2020-02-10T10:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3OTQ5Mg==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376979492", "bodyText": "Yes, I thought of doing that as well - but chose this instead since the alter/set-stats operation was not being used anywhere as of now. there are some no-ops around roles as well in MockThriftMetastoreClient", "author": "rohangarg", "createdAt": "2020-02-10T10:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MzMxMw==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377593313", "bodyText": "@sopel39 @electrum what about replacing MockThriftMetastoreClient with InMemoryThriftMetastore (+ access counting wrapper) in TestCachingHiveMetastore?\n\nIt seems like a good idea. I don't think MockThriftMetastoreClient correctly mocks thrift metastore. I would say this could be a follow up PR though.", "author": "sopel39", "createdAt": "2020-02-11T12:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE5OQ==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376970199", "bodyText": "as above", "author": "findepi", "createdAt": "2020-02-10T10:12:42Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -346,7 +347,8 @@ public boolean dropPartition(String databaseName, String tableName, List<String>\n     @Override\n     public void alterPartition(String databaseName, String tableName, Partition partition)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjM1OQ==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377592359", "bodyText": "just make metastore field a HiveMetastoreClosure", "author": "sopel39", "createdAt": "2020-02-11T12:00:48Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "diffHunk": "@@ -97,6 +97,7 @@ private void doDropStats(ConnectorSession session, String schema, String table,\n                 .filter(HiveColumnHandle::isPartitionKey)\n                 .map(HiveColumnHandle::getName)\n                 .collect(toImmutableList());\n+        HiveMetastoreClosure hiveMetastore = new HiveMetastoreClosure(metastore);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377592804", "bodyText": "add a commit that adds this test as a first commit.\nThen you will be able to show improvement with Remove getTable ... commit", "author": "sopel39", "createdAt": "2020-02-11T12:01:56Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg2NDA4NA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377864084", "bodyText": "I ran the test without the removal of getTable call, it did 5 calls to the metastore. The new one does 4 calls. The test failed with the following error :\njava.lang.AssertionError: expected [5] but found [6] Expected :5 Actual   :6", "author": "rohangarg", "createdAt": "2020-02-11T19:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1MTUyNg==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378751526", "bodyText": "Please make Test CachingHiveMetastore update partition statistics  commit to be before than Remove getTable call from updatePartitionStatistics commit", "author": "sopel39", "createdAt": "2020-02-13T09:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1MzEwMA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378753100", "bodyText": "The test commit is before the removal commit in my git log. I think github shows commit in chronology of time + I did a rebase of test commit due to some conflicts. So, github is showing the test commit later. will rewrite the removal commit as well for consistency.", "author": "rohangarg", "createdAt": "2020-02-13T09:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc2NTIzNQ==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378765235", "bodyText": "So could you write the test in such way that it shows an improvement in removal commit? Maybe do two update calls?", "author": "sopel39", "createdAt": "2020-02-13T10:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MDUxNA==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378790514", "bodyText": "I have added the test commit first along with the expected number of calls in that to be 5 (without the removal change). In the removal commit, I've updated the test to expect 4 calls (changing the test) - so that it shows improvement over the earlier test. Does that suffice?", "author": "rohangarg", "createdAt": "2020-02-13T10:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMTAzMQ==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378811031", "bodyText": "I would expect that 1c45b21 shows reduced access count in testUpdatePartitionStatistics", "author": "sopel39", "createdAt": "2020-02-13T11:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMzY4Mg==", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378813682", "bodyText": "test reduced count - shows the reduced access count in testUpdatePartitionStatistics in the 1c45b21 commit.", "author": "rohangarg", "createdAt": "2020-02-13T11:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "b635cddcfb1323fe5178dd2b0da53861b7537c65", "url": "https://github.com/trinodb/trino/commit/b635cddcfb1323fe5178dd2b0da53861b7537c65", "message": "Test CachingHiveMetastore update partition statistics", "committedDate": "2020-02-13T10:18:23Z", "type": "commit"}, {"oid": "1c45b21dcacbcb9b37d9aa4643f214c4dda42b6b", "url": "https://github.com/trinodb/trino/commit/1c45b21dcacbcb9b37d9aa4643f214c4dda42b6b", "message": "Remove getTable call from updatePartitionStatistics", "committedDate": "2020-02-13T10:52:43Z", "type": "commit"}, {"oid": "1c45b21dcacbcb9b37d9aa4643f214c4dda42b6b", "url": "https://github.com/trinodb/trino/commit/1c45b21dcacbcb9b37d9aa4643f214c4dda42b6b", "message": "Remove getTable call from updatePartitionStatistics", "committedDate": "2020-02-13T10:52:43Z", "type": "forcePushed"}]}