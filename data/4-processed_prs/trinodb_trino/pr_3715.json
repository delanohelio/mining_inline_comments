{"pr_number": 3715, "pr_title": "Add grouped_execution to kudu connector", "pr_createdAt": "2020-05-13T09:00:26Z", "pr_url": "https://github.com/trinodb/trino/pull/3715", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3NjgxNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437276815", "bodyText": "Can we make it as OptionalInt so tables which doesn't have bucketing can pass it as empty ?", "author": "Praveen2112", "createdAt": "2020-06-09T09:36:22Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduTableHandle.java", "diffHunk": "@@ -35,29 +35,33 @@\n     private final TupleDomain<ColumnHandle> constraint;\n     private final Optional<List<ColumnHandle>> desiredColumns;\n     private final boolean isDeleteHandle;\n+    private final int bucketCount;\n \n     @JsonCreator\n     public KuduTableHandle(\n             @JsonProperty(\"schemaTableName\") SchemaTableName schemaTableName,\n             @JsonProperty(\"constraint\") TupleDomain<ColumnHandle> constraint,\n             @JsonProperty(\"desiredColumns\") Optional<List<ColumnHandle>> desiredColumns,\n-            @JsonProperty(\"isDeleteHandle\") boolean isDeleteHandle)\n+            @JsonProperty(\"isDeleteHandle\") boolean isDeleteHandle,\n+            @JsonProperty(\"bucketCount\") int bucketCount)\n     {\n-        this(schemaTableName, null, constraint, desiredColumns, isDeleteHandle);\n+        this(schemaTableName, null, constraint, desiredColumns, isDeleteHandle, bucketCount);\n     }\n \n     public KuduTableHandle(\n             SchemaTableName schemaTableName,\n             KuduTable table,\n             TupleDomain<ColumnHandle> constraint,\n             Optional<List<ColumnHandle>> desiredColumns,\n-            boolean isDeleteHandle)\n+            boolean isDeleteHandle,\n+            int bucketCount)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3NzIyNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437277226", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.bucketCount = bucketCount;\n          \n          \n            \n                    this.bucketCount = requireNonNull(bucketCount, \"bucketCount is empty\");", "author": "Praveen2112", "createdAt": "2020-06-09T09:37:00Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduTableHandle.java", "diffHunk": "@@ -35,29 +35,33 @@\n     private final TupleDomain<ColumnHandle> constraint;\n     private final Optional<List<ColumnHandle>> desiredColumns;\n     private final boolean isDeleteHandle;\n+    private final int bucketCount;\n \n     @JsonCreator\n     public KuduTableHandle(\n             @JsonProperty(\"schemaTableName\") SchemaTableName schemaTableName,\n             @JsonProperty(\"constraint\") TupleDomain<ColumnHandle> constraint,\n             @JsonProperty(\"desiredColumns\") Optional<List<ColumnHandle>> desiredColumns,\n-            @JsonProperty(\"isDeleteHandle\") boolean isDeleteHandle)\n+            @JsonProperty(\"isDeleteHandle\") boolean isDeleteHandle,\n+            @JsonProperty(\"bucketCount\") int bucketCount)\n     {\n-        this(schemaTableName, null, constraint, desiredColumns, isDeleteHandle);\n+        this(schemaTableName, null, constraint, desiredColumns, isDeleteHandle, bucketCount);\n     }\n \n     public KuduTableHandle(\n             SchemaTableName schemaTableName,\n             KuduTable table,\n             TupleDomain<ColumnHandle> constraint,\n             Optional<List<ColumnHandle>> desiredColumns,\n-            boolean isDeleteHandle)\n+            boolean isDeleteHandle,\n+            int bucketCount)\n     {\n         this.schemaTableName = requireNonNull(schemaTableName, \"schemaTableName is null\");\n         this.table = table;\n         this.constraint = requireNonNull(constraint, \"constraint is null\");\n         this.desiredColumns = requireNonNull(desiredColumns, \"desiredColumns is null\");\n         this.isDeleteHandle = isDeleteHandle;\n+        this.bucketCount = bucketCount;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5NTA2OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437295068", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.splitMap = new ConcurrentHashMap<>();\n          \n          \n            \n                    splits.forEach(split ->\n          \n          \n            \n                            splitMap.put(split.getBucketNumber(), split));\n          \n          \n            \n                    this.splitMap = requireNonNull(splits, \"splits are null\").stream()\n          \n          \n            \n                            .collect(toImmutableMap(KuduSplit::getBucketNumber, identity()));", "author": "Praveen2112", "createdAt": "2020-06-09T10:07:14Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = new ConcurrentHashMap<>();\n+        splits.forEach(split ->\n+                splitMap.put(split.getBucketNumber(), split));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5NTcxNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437295717", "bodyText": "Instead of removing the bucket, can we have a counter which gets incremented so that it would be helpful in isFInished ?", "author": "Praveen2112", "createdAt": "2020-06-09T10:08:19Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = new ConcurrentHashMap<>();\n+        splits.forEach(split ->\n+                splitMap.put(split.getBucketNumber(), split));\n+    }\n+\n+    @Override\n+    public CompletableFuture<ConnectorSplitBatch> getNextBatch(ConnectorPartitionHandle partitionHandle, int maxSize)\n+    {\n+        KuduPartitionHandle kuduPartitionHandle = (KuduPartitionHandle) partitionHandle;\n+        KuduSplit kuduSplit = splitMap.remove(kuduPartitionHandle.getBucket());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MzMwMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437843301", "bodyText": "Yes, I agree with you!  :)", "author": "Crossoverrr", "createdAt": "2020-06-10T03:45:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5NTcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTcwMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437299700", "bodyText": "Can you please correct the indentation ?", "author": "Praveen2112", "createdAt": "2020-06-09T10:15:39Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplit.java", "diffHunk": "@@ -29,15 +29,18 @@\n     private final KuduTableHandle tableHandle;\n     private final int primaryKeyColumnCount;\n     private final byte[] serializedScanToken;\n+    private final int bucketNumber;\n \n     @JsonCreator\n     public KuduSplit(@JsonProperty(\"tableHandle\") KuduTableHandle tableHandle,\n             @JsonProperty(\"primaryKeyColumnCount\") int primaryKeyColumnCount,\n-            @JsonProperty(\"serializedScanToken\") byte[] serializedScanToken)\n+            @JsonProperty(\"serializedScanToken\") byte[] serializedScanToken,\n+                     @JsonProperty(\"bucketNumber\") int bucketNumber)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTk1Ng==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437299956", "bodyText": "check if the number is not negative ?", "author": "Praveen2112", "createdAt": "2020-06-09T10:16:03Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplit.java", "diffHunk": "@@ -29,15 +29,18 @@\n     private final KuduTableHandle tableHandle;\n     private final int primaryKeyColumnCount;\n     private final byte[] serializedScanToken;\n+    private final int bucketNumber;\n \n     @JsonCreator\n     public KuduSplit(@JsonProperty(\"tableHandle\") KuduTableHandle tableHandle,\n             @JsonProperty(\"primaryKeyColumnCount\") int primaryKeyColumnCount,\n-            @JsonProperty(\"serializedScanToken\") byte[] serializedScanToken)\n+            @JsonProperty(\"serializedScanToken\") byte[] serializedScanToken,\n+                     @JsonProperty(\"bucketNumber\") int bucketNumber)\n     {\n         this.tableHandle = requireNonNull(tableHandle, \"tableHandle is null\");\n         this.primaryKeyColumnCount = primaryKeyColumnCount;\n         this.serializedScanToken = requireNonNull(serializedScanToken, \"serializedScanToken is null\");\n+        this.bucketNumber = bucketNumber;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MjI3MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437842271", "bodyText": "I agree with you! The bucketNumber is created in a fori loop, so It will not be negative right now, but if some day people create a KuduSplit using this constructor, it will be necessary to do the check!", "author": "Crossoverrr", "createdAt": "2020-06-10T03:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMDE3MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437300171", "bodyText": "Inline this line", "author": "Praveen2112", "createdAt": "2020-06-09T10:16:26Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSessionProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.session.PropertyMetadata;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+\n+import static io.prestosql.spi.session.PropertyMetadata.booleanProperty;\n+\n+public final class KuduSessionProperties\n+{\n+    private static final String KUDU_GROUPED_EXECUTION_ENABLED = \"grouped_execution\";\n+\n+    private final List<PropertyMetadata<?>> sessionProperties;\n+\n+    @Inject\n+    public KuduSessionProperties(\n+            KuduClientConfig kuduConfig)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMDgyNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437300826", "bodyText": "rnn checks for the the fields", "author": "Praveen2112", "createdAt": "2020-06-09T10:17:45Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.log.Logger;\n+import io.prestosql.spi.connector.ColumnHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private static final Logger log = Logger.get(KuduPartitioningHandle.class);\n+\n+    private final String table;\n+    private final int bucketCount;\n+    private final String schema;\n+    private final List<ColumnHandle> bucketColumnIds;\n+\n+    @JsonCreator\n+    public KuduPartitioningHandle(\n+            @JsonProperty(\"schema\") String schema,\n+            @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"bucketCount\") int bucketCount,\n+            @JsonProperty(\"bucketColumnIds\") List<ColumnHandle> bucketColumnIds)\n+    {\n+        this.schema = schema;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMTM4OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437301389", "bodyText": "Why not bucketIds?", "author": "Praveen2112", "createdAt": "2020-06-09T10:18:46Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.log.Logger;\n+import io.prestosql.spi.connector.ColumnHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private static final Logger log = Logger.get(KuduPartitioningHandle.class);\n+\n+    private final String table;\n+    private final int bucketCount;\n+    private final String schema;\n+    private final List<ColumnHandle> bucketColumnIds;\n+\n+    @JsonCreator\n+    public KuduPartitioningHandle(\n+            @JsonProperty(\"schema\") String schema,\n+            @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"bucketCount\") int bucketCount,\n+            @JsonProperty(\"bucketColumnIds\") List<ColumnHandle> bucketColumnIds)\n+    {\n+        this.schema = schema;\n+        this.table = table;\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIds = bucketColumnIds;\n+    }\n+\n+    @JsonProperty\n+    public String getSchema()\n+    {\n+        return schema;\n+    }\n+\n+    @JsonProperty\n+    public String getTable()\n+    {\n+        return table;\n+    }\n+\n+    @JsonProperty\n+    public int getBucketCount()\n+    {\n+        return bucketCount;\n+    }\n+\n+    @JsonProperty\n+    public List<ColumnHandle> getBucketColumnIds()\n+    {\n+        return bucketColumnIds;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return format(\"schema=%s, table=%s, buckets=%d\", schema, table, bucketCount);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        KuduPartitioningHandle that = (KuduPartitioningHandle) o;\n+        return bucketCount == that.bucketCount;\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return Objects.hash(bucketCount, schema, table /*, hiveTypes*/);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMTU3MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437301570", "bodyText": "We can check the schemaName and tableName right ?", "author": "Praveen2112", "createdAt": "2020-06-09T10:19:09Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.log.Logger;\n+import io.prestosql.spi.connector.ColumnHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private static final Logger log = Logger.get(KuduPartitioningHandle.class);\n+\n+    private final String table;\n+    private final int bucketCount;\n+    private final String schema;\n+    private final List<ColumnHandle> bucketColumnIds;\n+\n+    @JsonCreator\n+    public KuduPartitioningHandle(\n+            @JsonProperty(\"schema\") String schema,\n+            @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"bucketCount\") int bucketCount,\n+            @JsonProperty(\"bucketColumnIds\") List<ColumnHandle> bucketColumnIds)\n+    {\n+        this.schema = schema;\n+        this.table = table;\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIds = bucketColumnIds;\n+    }\n+\n+    @JsonProperty\n+    public String getSchema()\n+    {\n+        return schema;\n+    }\n+\n+    @JsonProperty\n+    public String getTable()\n+    {\n+        return table;\n+    }\n+\n+    @JsonProperty\n+    public int getBucketCount()\n+    {\n+        return bucketCount;\n+    }\n+\n+    @JsonProperty\n+    public List<ColumnHandle> getBucketColumnIds()\n+    {\n+        return bucketColumnIds;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return format(\"schema=%s, table=%s, buckets=%d\", schema, table, bucketCount);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        KuduPartitioningHandle that = (KuduPartitioningHandle) o;\n+        return bucketCount == that.bucketCount;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0NDM1NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437844355", "bodyText": "Sorry we cannot check schemaName or tableName, because in join operation, presto will call this KuduPartitioningHandle#equals method to check if these two tables can do join, so if we add name check here, join query will not be able to execute in GROUPED_EXECUTION mode.  :(", "author": "Crossoverrr", "createdAt": "2020-06-10T03:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMTU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDA1MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437304051", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bind(ConnectorNodePartitioningProvider.class).to(KuduNodePartitioningProvider.class).in(Scopes.SINGLETON);\n          \n          \n            \n                    bind(ConnectorNodePartitioningProvider.class).annotatedWith(ForClassLoaderSafe.class).to(KuduNodePartitioningProvider.class).in(Scopes.SINGLETON);\n          \n          \n            \n                    bind(ConnectorNodePartitioningProvider.class).to(ClassLoaderSafeNodePartitioningProvider.class).in(Scopes.SINGLETON);\n          \n      \n    \n    \n  \n\nThis ensures that we can directly Inject KuduConnector", "author": "Praveen2112", "createdAt": "2020-06-09T10:23:47Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduModule.java", "diffHunk": "@@ -50,14 +51,16 @@ protected void configure()\n     {\n         bind(TypeManager.class).toInstance(typeManager);\n \n-        bind(KuduConnector.class).in(Scopes.SINGLETON);\n+        bind(KuduSessionProperties.class).in(Scopes.SINGLETON);\n+\n         bind(KuduMetadata.class).in(Scopes.SINGLETON);\n         bind(KuduTableProperties.class).in(Scopes.SINGLETON);\n         bind(ConnectorSplitManager.class).to(KuduSplitManager.class).in(Scopes.SINGLETON);\n         bind(ConnectorPageSourceProvider.class).to(KuduPageSourceProvider.class)\n                 .in(Scopes.SINGLETON);\n         bind(ConnectorPageSinkProvider.class).to(KuduPageSinkProvider.class).in(Scopes.SINGLETON);\n         bind(KuduHandleResolver.class).in(Scopes.SINGLETON);\n+        bind(ConnectorNodePartitioningProvider.class).to(KuduNodePartitioningProvider.class).in(Scopes.SINGLETON);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437304991", "bodyText": "we can inject ClassLoaderSafeNodePartitioningProvider directly so we can directly get Connector instance usiing injector.getInstance", "author": "Praveen2112", "createdAt": "2020-06-09T10:25:29Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduConnectorFactory.java", "diffHunk": "@@ -59,6 +70,25 @@ public Connector create(String catalogName, Map<String, String> config, Connecto\n                 .setRequiredConfigurationProperties(config)\n                 .initialize();\n \n-        return injector.getInstance(KuduConnector.class);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3ODA5Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437878097", "bodyText": "After I modified as your suggestion it shows errors like the picture, can you help me with that? @Praveen2112  I have checked the code in hive and iceberg, they just new a Connector in ConnectorFactory#create()", "author": "Crossoverrr", "createdAt": "2020-06-10T06:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3ODQ4OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437878489", "bodyText": "Explicit bindings are required and java.lang.ClassLoader is not explicitly bound.\nwhile locating java.lang.ClassLoader\nfor the 2nd parameter of io.prestosql.plugin.base.classloader.ClassLoaderSafeNodePartitioningProvider.(ClassLoaderSafeNodePartitioningProvider.java:42)\nat io.prestosql.plugin.kudu.KuduModule.configure(KuduModule.java:67)\n\n\nExplicit bindings are required and java.util.List<io.prestosql.spi.session.PropertyMetadata> is not explicitly bound.\n  while locating java.util.List>\nfor the 9th parameter of io.prestosql.plugin.kudu.KuduConnector.(KuduConnector.java:64)\nat io.prestosql.plugin.kudu.KuduModule.configure(KuduModule.java:58)", "author": "Crossoverrr", "createdAt": "2020-06-10T06:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NTUwNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437885505", "bodyText": "For injecting the classloader we can use this snippet\n                binder -> {\n                    binder.bind(ClassLoader.class).toInstance(KafkaConnectorFactory.class.getClassLoader());\n                    binder.bind(TypeManager.class).toInstance(context.getTypeManager());\n                    binder.bind(NodeManager.class).toInstance(context.getNodeManager());\n                });\n\nand adding this module in the bootstrap Ref : We can check KafkaConnectorFactory\nAnd instead of passing List<PropertyMetdata> we can inject KuduSessionProperties and use KuduSessionProperties#getSessionProperties inside the KuduConnector", "author": "Praveen2112", "createdAt": "2020-06-10T06:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkwOTM5Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437909393", "bodyText": "@Praveen2112 the first problem was fixed, thank you!\nthe second problem, I have removed the KuduConnector#getSessionProperties method, and keep the inject in KuduModule#configure(), after that presto can started successfully, but when I use the session property kudu.grouped_execution, it show error below:\nNo session properties found for catalog: kudu", "author": "Crossoverrr", "createdAt": "2020-06-10T07:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzMzgzOA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r437933838", "bodyText": "I think I have understood your suggestion about the 2nd problem, KuduConnector.sessionProperties should be type of KuduSessionProperties, not a List< PropertyMetdata >. Then the second problem is resolved!\nThank you! @Praveen2112   :)", "author": "Crossoverrr", "createdAt": "2020-06-10T07:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyOTk0OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439729948", "bodyText": "Instead of maintaining KuduSessionProperties can we maintain List<PropertyMetadata<?>> sessionProperties", "author": "Praveen2112", "createdAt": "2020-06-13T10:53:11Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduConnector.java", "diffHunk": "@@ -45,6 +46,8 @@\n     private final KuduTableProperties tableProperties;\n     private final ConnectorPageSinkProvider pageSinkProvider;\n     private final Set<Procedure> procedures;\n+    private final ConnectorNodePartitioningProvider nodePartitioningProvider;\n+    private final KuduSessionProperties sessionProperties;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkxODE0NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439918145", "bodyText": "Agree with you, I have changed my code according to CassandraConnector.  :)", "author": "Crossoverrr", "createdAt": "2020-06-15T03:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyOTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3MTU3MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439971571", "bodyText": "A few minor changes. How do we handle for multi level hash based partitioning ? If we partition tables on based on two hash partition, how can we handle them ?\n\nI think we can check KuduBucketFunction#getBucket, in this method we judge which bucket one record belongs to by all its bucket columns(see param bucketChannelTypes of method getBucketId). So I think it won't be a problem when we handling multi level hash based partitioning.   :)", "author": "Crossoverrr", "createdAt": "2020-06-15T07:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyOTk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczMDA0Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439730047", "bodyText": "Can we move this to a new line ?", "author": "Praveen2112", "createdAt": "2020-06-13T10:55:15Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(ConnectorTransactionHandle transactionHandle,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczMjU5NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439732595", "bodyText": "Can we import PartitionSchema.HashBucketSchema directly", "author": "Praveen2112", "createdAt": "2020-06-13T11:40:40Z", "path": "presto-kudu/src/main/java/org/apache/kudu/client/KeyEncoderAccessor.java", "diffHunk": "@@ -41,4 +41,17 @@ public static PartialRow decodeRangePartitionKey(Schema schema, PartitionSchema\n     {\n         return KeyEncoder.decodeRangePartitionKey(schema, partitionSchema, key);\n     }\n+\n+    /**\n+     * Returns the bucket of the row for the given hash bucket schema. All columns\n+     * in the hash bucket schema must be set in the row.\n+     *\n+     * @param row the row containing hash schema columns\n+     * @param hashSchema the hash schema\n+     * @return the hash bucket of the row\n+     */\n+    public static int getHashBucket(PartialRow row, PartitionSchema.HashBucketSchema hashSchema)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczMjg3Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439732873", "bodyText": "Do we need this KuduTable variable ? In all its usages it is passed as null", "author": "Praveen2112", "createdAt": "2020-06-13T11:45:40Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +203,26 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            OptionalInt bucketCount = getTableBucketCount(schemaTableName, null);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false, bucketCount);\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName, KuduTable table)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNDM5MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439734390", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ImmutableList<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)\n          \n          \n            \n                private List<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)", "author": "Praveen2112", "createdAt": "2020-06-13T12:09:49Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -347,6 +370,21 @@ public ConnectorOutputTableHandle beginCreateTable(\n         return Optional.empty();\n     }\n \n+    private boolean isTableSupportGroupedExecution(KuduTable kuduTable)\n+    {\n+        return !kuduTable.getPartitionSchema().getHashBucketSchemas().isEmpty();\n+    }\n+\n+    private ImmutableList<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNDQzNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439734437", "bodyText": "Can we write each arguments in a new line ?", "author": "Praveen2112", "createdAt": "2020-06-13T12:10:19Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -357,7 +395,8 @@ public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, Connect\n     public ConnectorTableHandle beginDelete(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new KuduTableHandle(handle.getSchemaTableName(), handle.getConstraint(), handle.getDesiredColumns(), true);\n+        return new KuduTableHandle(handle.getSchemaTableName(), handle.getConstraint(), handle.getDesiredColumns(), true,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNDU0MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439734540", "bodyText": "Import PartitionSchema.HashBucketSchema", "author": "Praveen2112", "createdAt": "2020-06-13T12:12:02Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final KuduTable kuduTable;\n+\n+    private final PartitionSchema.HashBucketSchema hashBucketSchema;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNjYzNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439736635", "bodyText": "Maybe Iterables.getFirst", "author": "Praveen2112", "createdAt": "2020-06-13T12:45:51Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final KuduTable kuduTable;\n+\n+    private final PartitionSchema.HashBucketSchema hashBucketSchema;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketChannelTypes = bucketChannelTypes;\n+\n+        this.kuduTable = kuduTable;\n+\n+        PartitionSchema partitionSchema = this.kuduTable.getPartitionSchema();\n+        List<PartitionSchema.HashBucketSchema> hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.hashBucketSchema = hashBucketSchemas.get(0);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNzYxMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439737613", "bodyText": "Can we move it to a new line ?", "author": "Praveen2112", "createdAt": "2020-06-13T13:00:33Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientSession.java", "diffHunk": "@@ -596,11 +598,11 @@ private KuduPredicate createComparisonPredicate(ColumnSchema columnSchema, KuduP\n     }\n \n     private KuduSplit toKuduSplit(KuduTableHandle tableHandle, KuduScanToken token,\n-            int primaryKeyColumnCount)\n+            int primaryKeyColumnCount, int bucketNumber)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNzgyMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439737820", "bodyText": "Can we inline bucketCount ?", "author": "Praveen2112", "createdAt": "2020-06-13T13:03:53Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +203,26 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            OptionalInt bucketCount = getTableBucketCount(schemaTableName, null);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false, bucketCount);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczODE1NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439738154", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ImmutableList.Builder<ColumnHandle> bucketColumns = ImmutableList.builder();\n          \n          \n            \n                    if (!targetColumns.isEmpty()) {\n          \n          \n            \n                        targetColumns.forEach(bucketColumnIndex ->\n          \n          \n            \n                                bucketColumns.add(columnMap.get(schema.getColumnByIndex(bucketColumnIndex).getName())));\n          \n          \n            \n                    }\n          \n          \n            \n                    return bucketColumns.build();\n          \n          \n            \n                    return targetColumns.stream()\n          \n          \n            \n                            .map(columnIndex -> columnMap.get(schema.getColumnByIndex(columnIndex).getName()))\n          \n          \n            \n                            .collect(toImmutableList());", "author": "Praveen2112", "createdAt": "2020-06-13T13:07:42Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -347,6 +370,21 @@ public ConnectorOutputTableHandle beginCreateTable(\n         return Optional.empty();\n     }\n \n+    private boolean isTableSupportGroupedExecution(KuduTable kuduTable)\n+    {\n+        return !kuduTable.getPartitionSchema().getHashBucketSchemas().isEmpty();\n+    }\n+\n+    private ImmutableList<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)\n+    {\n+        ImmutableList.Builder<ColumnHandle> bucketColumns = ImmutableList.builder();\n+        if (!targetColumns.isEmpty()) {\n+            targetColumns.forEach(bucketColumnIndex ->\n+                    bucketColumns.add(columnMap.get(schema.getColumnByIndex(bucketColumnIndex).getName())));\n+        }\n+        return bucketColumns.build();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczODIzNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439738235", "bodyText": "ImmutableSet.copyOf", "author": "Praveen2112", "createdAt": "2020-06-13T13:08:56Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +414,41 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {\n+            Map<String, ColumnHandle> columnMap = getColumnHandles(session, handle);\n+            List<PartitionSchema.HashBucketSchema> hashBucketSchemas = kuduTable.getPartitionSchema().getHashBucketSchemas();\n+            List<Integer> bucketColumnIds = hashBucketSchemas.get(0).getColumnIds();\n+            List<ColumnHandle> bucketColumns = getSpecifyColumns(kuduTable.getSchema(), bucketColumnIds, columnMap);\n+            tablePartitioning = Optional.of(new ConnectorTablePartitioning(\n+                new KuduPartitioningHandle(\n+                    handle.getSchemaTableName().getSchemaName(),\n+                    handle.getSchemaTableName().getTableName(),\n+                    handle.getBucketCount().getAsInt(),\n+                    bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),\n+                bucketColumns));\n+            partitioningColumns = Optional.of(new HashSet<>(bucketColumns));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczODUwMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r439738503", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ).collect(Collectors.toList());\n          \n          \n            \n                        ).collect(toImmutableList());", "author": "Praveen2112", "createdAt": "2020-06-13T13:13:27Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +414,41 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {\n+            Map<String, ColumnHandle> columnMap = getColumnHandles(session, handle);\n+            List<PartitionSchema.HashBucketSchema> hashBucketSchemas = kuduTable.getPartitionSchema().getHashBucketSchemas();\n+            List<Integer> bucketColumnIds = hashBucketSchemas.get(0).getColumnIds();\n+            List<ColumnHandle> bucketColumns = getSpecifyColumns(kuduTable.getSchema(), bucketColumnIds, columnMap);\n+            tablePartitioning = Optional.of(new ConnectorTablePartitioning(\n+                new KuduPartitioningHandle(\n+                    handle.getSchemaTableName().getSchemaName(),\n+                    handle.getSchemaTableName().getTableName(),\n+                    handle.getBucketCount().getAsInt(),\n+                    bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),\n+                bucketColumns));\n+            partitioningColumns = Optional.of(new HashSet<>(bucketColumns));\n+\n+            List<Integer> rangeColumnIds = kuduTable.getPartitionSchema().getRangeSchema().getColumnIds();\n+            List<ColumnHandle> rangeColumns = getSpecifyColumns(kuduTable.getSchema(), rangeColumnIds, columnMap);\n+            localProperties = rangeColumns.stream().map(columnHandle ->\n+                new SortingProperty<>(columnHandle, SortOrder.ASC_NULLS_LAST)\n+            ).collect(Collectors.toList());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzMjE0Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r446632142", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    requireNonNull(sessionProperties, \"KuduSessionProperties is null\");\n          \n          \n            \n                    this.sessionProperties = requireNonNull(sessionProperties.getSessionProperties(), \"sessionProperties is null\");\n          \n          \n            \n                    this.sessionProperties = requireNonNull(sessionProperties, \"KuduSessionProperties is null\").getSessionProperties();", "author": "Praveen2112", "createdAt": "2020-06-28T10:27:17Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduConnector.java", "diffHunk": "@@ -63,6 +68,9 @@ public KuduConnector(\n         this.tableProperties = requireNonNull(tableProperties, \"tableProperties is null\");\n         this.pageSinkProvider = requireNonNull(pageSinkProvider, \"pageSinkProvider is null\");\n         this.procedures = ImmutableSet.copyOf(requireNonNull(procedures, \"procedures is null\"));\n+        this.nodePartitioningProvider = requireNonNull(nodePartitioningProvider, \"nodePartitioningProvider is null\");\n+        requireNonNull(sessionProperties, \"KuduSessionProperties is null\");\n+        this.sessionProperties = requireNonNull(sessionProperties.getSessionProperties(), \"sessionProperties is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3MTY2Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447371667", "bodyText": "I will do as your suggest, but I wander will it show an NullPointerExeption if we remove requireNonNull of sessionProperties ?", "author": "Crossoverrr", "createdAt": "2020-06-30T02:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzMjE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NDgzNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447044837", "bodyText": "How about using a AtomicCounter ?", "author": "Praveen2112", "createdAt": "2020-06-29T15:09:24Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+    private int fetchedBucketCount;\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = requireNonNull(splits, \"splits are null\").stream()\n+                .collect(toImmutableMap(KuduSplit::getBucketNumber, identity()));\n+    }\n+\n+    @Override\n+    public CompletableFuture<ConnectorSplitBatch> getNextBatch(ConnectorPartitionHandle partitionHandle, int maxSize)\n+    {\n+        KuduPartitionHandle kuduPartitionHandle = (KuduPartitionHandle) partitionHandle;\n+        KuduSplit kuduSplit = splitMap.get(kuduPartitionHandle.getBucket());\n+        fetchedBucketCount += 1;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3MjA5OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447372098", "bodyText": "Could I use AtomicInteger here?", "author": "Crossoverrr", "createdAt": "2020-06-30T02:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NDgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NjI4Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447046287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return this.fetchedBucketCount >= splitMap.size();\n          \n          \n            \n                    return this.fetchedBucketCount == splitMap.size();", "author": "Praveen2112", "createdAt": "2020-06-29T15:11:27Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+    private int fetchedBucketCount;\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = requireNonNull(splits, \"splits are null\").stream()\n+                .collect(toImmutableMap(KuduSplit::getBucketNumber, identity()));\n+    }\n+\n+    @Override\n+    public CompletableFuture<ConnectorSplitBatch> getNextBatch(ConnectorPartitionHandle partitionHandle, int maxSize)\n+    {\n+        KuduPartitionHandle kuduPartitionHandle = (KuduPartitionHandle) partitionHandle;\n+        KuduSplit kuduSplit = splitMap.get(kuduPartitionHandle.getBucket());\n+        fetchedBucketCount += 1;\n+        return completedFuture(new ConnectorSplitBatch(kuduSplit == null ? ImmutableList.of() : ImmutableList.of(kuduSplit), true));\n+    }\n+\n+    @Override\n+    public void close()\n+    {\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return this.fetchedBucketCount >= splitMap.size();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0ODk1MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447048951", "bodyText": "Can we rearrange in the same was as that of constructor ?", "author": "Praveen2112", "createdAt": "2020-06-29T15:15:11Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private final String table;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2Mjg2MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447062860", "bodyText": "can we move it to previous line ?", "author": "Praveen2112", "createdAt": "2020-06-29T15:34:26Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientSession.java", "diffHunk": "@@ -595,12 +597,12 @@ private KuduPredicate createComparisonPredicate(ColumnSchema columnSchema, KuduP\n                 + columnSchema.getName() + \": \" + javaValue + \"(\" + javaValue.getClass() + \")\");\n     }\n \n-    private KuduSplit toKuduSplit(KuduTableHandle tableHandle, KuduScanToken token,\n-            int primaryKeyColumnCount)\n+    private KuduSplit toKuduSplit(KuduTableHandle tableHandle, KuduScanToken token, int primaryKeyColumnCount,\n+            int bucketNumber)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NTQyMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447075423", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        int bucketCount = -1;\n          \n          \n            \n                        // if bucketSchemas.size > 1, it means this table is a multiLevel-partitioning table.\n          \n          \n            \n                        for (HashBucketSchema hashBucketSchema : bucketSchemas) {\n          \n          \n            \n                            bucketCount = bucketCount <= 0 ? hashBucketSchema.getNumBuckets() : bucketCount * hashBucketSchema.getNumBuckets();\n          \n          \n            \n                        }\n          \n          \n            \n                        return OptionalInt.of(bucketCount);\n          \n          \n            \n                        return OptionalInt.of(bucketSchemas.stream()\n          \n          \n            \n                                .mapToInt(HashBucketSchema::getNumBuckets)\n          \n          \n            \n                                .reduce(1, Math::multiplyExact));", "author": "Praveen2112", "createdAt": "2020-06-29T15:52:16Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +203,29 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false,\n+                    getTableBucketCount(schemaTableName));\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName)\n+    {\n+        KuduTable table = clientSession.openTable(schemaTableName);\n+        List<HashBucketSchema> bucketSchemas = table.getPartitionSchema().getHashBucketSchemas();\n+        if (bucketSchemas != null && !bucketSchemas.isEmpty()) {\n+            int bucketCount = -1;\n+            // if bucketSchemas.size > 1, it means this table is a multiLevel-partitioning table.\n+            for (HashBucketSchema hashBucketSchema : bucketSchemas) {\n+                bucketCount = bucketCount <= 0 ? hashBucketSchema.getNumBuckets() : bucketCount * hashBucketSchema.getNumBuckets();\n+            }\n+            return OptionalInt.of(bucketCount);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3NjAzOQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447376039", "bodyText": "Learned!  :)", "author": "Crossoverrr", "createdAt": "2020-06-30T02:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NTQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NzU2Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447077562", "bodyText": "This might be a bit clear right ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return targetColumns.stream()\n          \n          \n            \n                        .map(columnIndex -> columnMap.get(schema.getColumnByIndex(columnIndex).getName()))\n          \n          \n            \n                        .collect(toImmutableList());\n          \n          \n            \n                    return targetColumns.stream()\n          \n          \n            \n                            .map(schema::getColumnByIndex)\n          \n          \n            \n                            .map(ColumnSchema::getName)\n          \n          \n            \n                            .map(columnMap::get)\n          \n          \n            \n                        .collect(toImmutableList());", "author": "Praveen2112", "createdAt": "2020-06-29T15:55:26Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -347,6 +373,18 @@ public ConnectorOutputTableHandle beginCreateTable(\n         return Optional.empty();\n     }\n \n+    private boolean isTableSupportGroupedExecution(KuduTable kuduTable)\n+    {\n+        return !kuduTable.getPartitionSchema().getHashBucketSchemas().isEmpty();\n+    }\n+\n+    private List<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)\n+    {\n+        return targetColumns.stream()\n+            .map(columnIndex -> columnMap.get(schema.getColumnByIndex(columnIndex).getName()))\n+            .collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3ODE0Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447078147", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            getTableBucketCount(handle.getSchemaTableName()));\n          \n          \n            \n                            handle.getBucketCount());", "author": "Praveen2112", "createdAt": "2020-06-29T15:56:14Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -357,7 +395,12 @@ public ColumnHandle getUpdateRowIdColumnHandle(ConnectorSession session, Connect\n     public ConnectorTableHandle beginDelete(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new KuduTableHandle(handle.getSchemaTableName(), handle.getConstraint(), handle.getDesiredColumns(), true);\n+        return new KuduTableHandle(\n+                handle.getSchemaTableName(),\n+                handle.getConstraint(),\n+                handle.getDesiredColumns(),\n+                true,\n+                getTableBucketCount(handle.getSchemaTableName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5Mjc2Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447092767", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            getTableBucketCount(handle.getSchemaTableName()));\n          \n          \n            \n                            handle.getBucketCount();", "author": "Praveen2112", "createdAt": "2020-06-29T16:18:12Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -394,7 +478,8 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 handle.getTable(clientSession),\n                 newDomain,\n                 handle.getDesiredColumns(),\n-                handle.isDeleteHandle());\n+                handle.isDeleteHandle(),\n+                getTableBucketCount(handle.getSchemaTableName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5MjkwNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447092906", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            getTableBucketCount(handle.getSchemaTableName()));\n          \n          \n            \n                            handle.getBucketCount());", "author": "Praveen2112", "createdAt": "2020-06-29T16:18:24Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -450,7 +535,8 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 handle.getTable(clientSession),\n                 handle.getConstraint(),\n                 Optional.of(desiredColumns.build()),\n-                handle.isDeleteHandle());\n+                handle.isDeleteHandle(),\n+                getTableBucketCount(handle.getSchemaTableName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NDU5OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447094598", "bodyText": "Can we move each argument to a new line ?", "author": "Praveen2112", "createdAt": "2020-06-29T16:20:50Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();\n+        return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());\n+    }\n+\n+    @Override\n+    public ConnectorBucketNodeMap getBucketNodeMap(ConnectorTransactionHandle transactionHandle,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3Nzg4NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447377884", "bodyText": "Ok, will do!", "author": "Crossoverrr", "createdAt": "2020-06-30T02:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NDU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NDc3Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447094772", "bodyText": "ditto", "author": "Praveen2112", "createdAt": "2020-06-29T16:21:05Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();\n+        return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());\n+    }\n+\n+    @Override\n+    public ConnectorBucketNodeMap getBucketNodeMap(ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return createBucketNodeMap(handle.getBucketCount());\n+    }\n+\n+    @Override\n+    public ToIntFunction<ConnectorSplit> getSplitBucketFunction(ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        return value -> ((KuduSplit) value).getBucketNumber();\n+    }\n+\n+    @Override\n+    public BucketFunction getBucketFunction(ConnectorTransactionHandle transactionHandle,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NDc3Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447094773", "bodyText": "ditto", "author": "Praveen2112", "createdAt": "2020-06-29T16:21:05Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();\n+        return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());\n+    }\n+\n+    @Override\n+    public ConnectorBucketNodeMap getBucketNodeMap(ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return createBucketNodeMap(handle.getBucketCount());\n+    }\n+\n+    @Override\n+    public ToIntFunction<ConnectorSplit> getSplitBucketFunction(ConnectorTransactionHandle transactionHandle,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3ODA1MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447378051", "bodyText": "Got it!", "author": "Crossoverrr", "createdAt": "2020-06-30T02:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NDc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5OTYwNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447099604", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.bucketColumnIdIndexes = bucketColumnIdIndexes;\n          \n          \n            \n                    this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));", "author": "Praveen2112", "createdAt": "2020-06-29T16:28:38Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = bucketColumnIdIndexes;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMDAxOQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447100019", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.bucketChannelTypes = bucketChannelTypes;\n          \n          \n            \n                    this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));", "author": "Praveen2112", "createdAt": "2020-06-29T16:29:21Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = bucketColumnIdIndexes;\n+        this.bucketChannelTypes = bucketChannelTypes;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTA2MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447101060", "bodyText": "Do we need this check on groupedExecution here ?", "author": "Praveen2112", "createdAt": "2020-06-29T16:30:53Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +418,48 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4MjcwNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447382705", "bodyText": "If we remove the check it will use grouped_execution strategy always once one/two table satisfied the condition of grouped_execution. So I suggest we keep this parameter as a switch.   :)", "author": "Crossoverrr", "createdAt": "2020-06-30T03:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTU2MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447101560", "bodyText": "Isn't it redundant ?", "author": "Praveen2112", "createdAt": "2020-06-29T16:31:47Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +418,48 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4MzYzNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447383635", "bodyText": "You are right, bucketCount will not be empty once PartitionSchema.getHashBucketSchemas is present.", "author": "Crossoverrr", "createdAt": "2020-06-30T03:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMjU4MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447102580", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),\n          \n          \n            \n                                bucketColumns.stream()\n          \n          \n            \n                                        .map(KuduColumnHandle.class::cast)\n          \n          \n            \n                                        .map(KuduColumnHandle::getType)\n          \n          \n            \n                                        .collect(toImmutableList()))", "author": "Praveen2112", "createdAt": "2020-06-29T16:33:24Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +418,48 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {\n+            Map<String, ColumnHandle> columnMap = getColumnHandles(session, handle);\n+            List<Integer> bucketColumnIds = getBucketColumnIds(kuduTable);\n+            List<ColumnHandle> bucketColumns = getSpecifyColumns(kuduTable.getSchema(), bucketColumnIds, columnMap);\n+            tablePartitioning = Optional.of(new ConnectorTablePartitioning(\n+                new KuduPartitioningHandle(\n+                    handle.getSchemaTableName().getSchemaName(),\n+                    handle.getSchemaTableName().getTableName(),\n+                    handle.getBucketCount().getAsInt(),\n+                    bucketColumnIds,\n+                    bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMzA1NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447103054", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        localProperties = rangeColumns.stream().map(columnHandle ->\n          \n          \n            \n                            new SortingProperty<>(columnHandle, SortOrder.ASC_NULLS_LAST)\n          \n          \n            \n                        ).collect(toImmutableList());\n          \n          \n            \n                        localProperties = rangeColumns.stream()\n          \n          \n            \n                                .map(columnHandle -> new SortingProperty<>(columnHandle, SortOrder.ASC_NULLS_LAST))\n          \n          \n            \n                                .collect(toImmutableList());", "author": "Praveen2112", "createdAt": "2020-06-29T16:34:15Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +418,48 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {\n+            Map<String, ColumnHandle> columnMap = getColumnHandles(session, handle);\n+            List<Integer> bucketColumnIds = getBucketColumnIds(kuduTable);\n+            List<ColumnHandle> bucketColumns = getSpecifyColumns(kuduTable.getSchema(), bucketColumnIds, columnMap);\n+            tablePartitioning = Optional.of(new ConnectorTablePartitioning(\n+                new KuduPartitioningHandle(\n+                    handle.getSchemaTableName().getSchemaName(),\n+                    handle.getSchemaTableName().getTableName(),\n+                    handle.getBucketCount().getAsInt(),\n+                    bucketColumnIds,\n+                    bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),\n+                bucketColumns));\n+            partitioningColumns = Optional.of(ImmutableSet.copyOf(bucketColumns));\n+\n+            List<Integer> rangeColumnIds = kuduTable.getPartitionSchema().getRangeSchema().getColumnIds();\n+            List<ColumnHandle> rangeColumns = getSpecifyColumns(kuduTable.getSchema(), rangeColumnIds, columnMap);\n+            localProperties = rangeColumns.stream().map(columnHandle ->\n+                new SortingProperty<>(columnHandle, SortOrder.ASC_NULLS_LAST)\n+            ).collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzExMjMyNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447112327", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return hashBucketSchemas.stream().map(HashBucketSchema::getColumnIds)\n          \n          \n            \n                            .flatMap(List<Integer>::stream).collect(toImmutableList());\n          \n          \n            \n                    return hashBucketSchemas.stream()\n          \n          \n            \n                            .map(HashBucketSchema::getColumnIds)\n          \n          \n            \n                            .flatMap(List<Integer>::stream)\n          \n          \n            \n                            .collect(toImmutableList());", "author": "Praveen2112", "createdAt": "2020-06-29T16:49:26Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -375,7 +418,48 @@ public boolean usesLegacyTableLayouts()\n     public ConnectorTableProperties getTableProperties(ConnectorSession session, ConnectorTableHandle table)\n     {\n         KuduTableHandle handle = (KuduTableHandle) table;\n-        return new ConnectorTableProperties(handle.getConstraint(), Optional.empty(), Optional.empty(), Optional.empty(), ImmutableList.of());\n+        KuduTable kuduTable = handle.getTable(clientSession);\n+\n+        Optional<ConnectorTablePartitioning> tablePartitioning = Optional.empty();\n+        Optional<Set<ColumnHandle>> partitioningColumns = Optional.empty();\n+        List<LocalProperty<ColumnHandle>> localProperties = ImmutableList.of();\n+\n+        if (isKuduGroupedExecutionEnabled(session)\n+                && isTableSupportGroupedExecution(kuduTable)\n+                && handle.getBucketCount().isPresent()) {\n+            Map<String, ColumnHandle> columnMap = getColumnHandles(session, handle);\n+            List<Integer> bucketColumnIds = getBucketColumnIds(kuduTable);\n+            List<ColumnHandle> bucketColumns = getSpecifyColumns(kuduTable.getSchema(), bucketColumnIds, columnMap);\n+            tablePartitioning = Optional.of(new ConnectorTablePartitioning(\n+                new KuduPartitioningHandle(\n+                    handle.getSchemaTableName().getSchemaName(),\n+                    handle.getSchemaTableName().getTableName(),\n+                    handle.getBucketCount().getAsInt(),\n+                    bucketColumnIds,\n+                    bucketColumns.stream().map(KuduColumnHandle.class::cast).map(KuduColumnHandle::getType).collect(Collectors.toList())),\n+                bucketColumns));\n+            partitioningColumns = Optional.of(ImmutableSet.copyOf(bucketColumns));\n+\n+            List<Integer> rangeColumnIds = kuduTable.getPartitionSchema().getRangeSchema().getColumnIds();\n+            List<ColumnHandle> rangeColumns = getSpecifyColumns(kuduTable.getSchema(), rangeColumnIds, columnMap);\n+            localProperties = rangeColumns.stream().map(columnHandle ->\n+                new SortingProperty<>(columnHandle, SortOrder.ASC_NULLS_LAST)\n+            ).collect(toImmutableList());\n+        }\n+\n+        return new ConnectorTableProperties(\n+                handle.getConstraint(),\n+                tablePartitioning,\n+                partitioningColumns,\n+                Optional.empty(),\n+                localProperties);\n+    }\n+\n+    private List<Integer> getBucketColumnIds(KuduTable kuduTable)\n+    {\n+        List<HashBucketSchema> hashBucketSchemas = kuduTable.getPartitionSchema().getHashBucketSchemas();\n+        return hashBucketSchemas.stream().map(HashBucketSchema::getColumnIds)\n+                .flatMap(List<Integer>::stream).collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzExMzg0OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447113849", "bodyText": "We need to populate only the row for bucketed columns right ?", "author": "Praveen2112", "createdAt": "2020-06-29T16:51:52Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = bucketColumnIdIndexes;\n+        this.bucketChannelTypes = bucketChannelTypes;\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4ODkwMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447388901", "bodyText": "Here page is generated by presto contains only bucketed columns. As you can see in the pic, table has 5 columns, and page only have 3 partition channels.", "author": "Crossoverrr", "createdAt": "2020-06-30T03:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzExMzg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4OTc1Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r447389757", "bodyText": "", "author": "Crossoverrr", "createdAt": "2020-06-30T03:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzExMzg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MTA3OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450661078", "bodyText": "checkArgument(bucketColumnIdIndexes.size() == bucketChannelTypes.size()) ?\ncheckArgument(bucketCount == bucketColumnIdIndexes.size())? If so do you need bucketCount at all?", "author": "kokosing", "createdAt": "2020-07-07T07:23:44Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMTQzNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450721436", "bodyText": "Yes, I will remove useless argument bucketCount.  :)", "author": "Crossoverrr", "createdAt": "2020-07-07T09:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MTI4Ng==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450661286", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final List<Integer> bucketColumnIdIndexes;\n          \n          \n            \n                private final List<Integer> bucketChannels;\n          \n      \n    \n    \n  \n\n?", "author": "kokosing", "createdAt": "2020-07-07T07:24:07Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMjI4MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450722281", "bodyText": "Yes, sure!", "author": "Crossoverrr", "createdAt": "2020-07-07T09:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MTI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MjUyMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450662523", "bodyText": "why do you pass field bucketChannelTypes to a method? This field is already accessible there.", "author": "kokosing", "createdAt": "2020-07-07T07:26:46Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMjk3Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450722972", "bodyText": "Yes, I will follow!", "author": "Crossoverrr", "createdAt": "2020-07-07T09:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MjUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MzIxNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450663217", "bodyText": "checkArgument(types.size() == page. getChannelCount())", "author": "kokosing", "createdAt": "2020-07-07T07:28:10Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMzYwOA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450723608", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-07T09:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MzIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MzgyMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450663820", "bodyText": "Please extract this loop to separate method then:\n        List<Integer> bucketIds = this.hashBucketSchemas.stream()\n                      .map(this::yourNewFancyMethod)\n                      .collect(...);\n\nRename i to channel", "author": "kokosing", "createdAt": "2020-07-07T07:29:20Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0NjQ0OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451246448", "bodyText": "Agree!", "author": "Crossoverrr", "createdAt": "2020-07-08T02:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2MzgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2NTU3OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450665579", "bodyText": "How about TINYINT and SMALLINT?", "author": "kokosing", "createdAt": "2020-07-07T07:32:57Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {\n+                Block block = page.getBlock(i);\n+                Type type = types.get(i);\n+                if (type.equals(BOOLEAN)) {\n+                    partialRow.addBoolean(this.bucketColumnIdIndexes.get(i), BOOLEAN.getBoolean(block, position));\n+                }\n+                else if (type.equals(BIGINT) || type.equals(INTEGER)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2NjYwNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450666604", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new UnsupportedOperationException(\"Computation of Kudu bucket hashCode is not supported for type: \" + type);\n          \n          \n            \n                                throw new UnsupportedOperationException(\"Grouped execution is not supported for type: \" + type);", "author": "kokosing", "createdAt": "2020-07-07T07:34:53Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {\n+                Block block = page.getBlock(i);\n+                Type type = types.get(i);\n+                if (type.equals(BOOLEAN)) {\n+                    partialRow.addBoolean(this.bucketColumnIdIndexes.get(i), BOOLEAN.getBoolean(block, position));\n+                }\n+                else if (type.equals(BIGINT) || type.equals(INTEGER)) {\n+                    partialRow.addLong(this.bucketColumnIdIndexes.get(i), type.getLong(block, position));\n+                }\n+                else if (type.equals(DOUBLE)) {\n+                    partialRow.addDouble(this.bucketColumnIdIndexes.get(i), type.getDouble(block, position));\n+                }\n+                else if (type.equals(VARCHAR)) {\n+                    partialRow.addString(this.bucketColumnIdIndexes.get(i), type.getSlice(block, position).toStringUtf8());\n+                }\n+                else {\n+                    throw new UnsupportedOperationException(\"Computation of Kudu bucket hashCode is not supported for type: \" + type);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2ODAwMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450668003", "bodyText": "Extract variable for this.bucketColumnIdIndexes.get(i)", "author": "kokosing", "createdAt": "2020-07-07T07:37:32Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {\n+                Block block = page.getBlock(i);\n+                Type type = types.get(i);\n+                if (type.equals(BOOLEAN)) {\n+                    partialRow.addBoolean(this.bucketColumnIdIndexes.get(i), BOOLEAN.getBoolean(block, position));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNTYxMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451435613", "bodyText": "agree", "author": "Crossoverrr", "createdAt": "2020-07-08T10:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2ODAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDA3MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450670071", "bodyText": "Why not to use java.util.Arrays#hashCode(java.lang.Object[]) instead of calculating hash on your own?", "author": "kokosing", "createdAt": "2020-07-07T07:41:33Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIdIndexes;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(int bucketCount, List<Integer> bucketColumnIdIndexes, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIdIndexes = ImmutableList.copyOf(requireNonNull(bucketColumnIdIndexes));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(bucketChannelTypes, page, position);\n+    }\n+\n+    private int getBucketId(List<Type> types, Page page, int position)\n+    {\n+        PartialRow partialRow = new PartialRow(schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream().map(hashBucketSchema -> {\n+            for (int i = 0; i < page.getChannelCount(); i++) {\n+                Block block = page.getBlock(i);\n+                Type type = types.get(i);\n+                if (type.equals(BOOLEAN)) {\n+                    partialRow.addBoolean(this.bucketColumnIdIndexes.get(i), BOOLEAN.getBoolean(block, position));\n+                }\n+                else if (type.equals(BIGINT) || type.equals(INTEGER)) {\n+                    partialRow.addLong(this.bucketColumnIdIndexes.get(i), type.getLong(block, position));\n+                }\n+                else if (type.equals(DOUBLE)) {\n+                    partialRow.addDouble(this.bucketColumnIdIndexes.get(i), type.getDouble(block, position));\n+                }\n+                else if (type.equals(VARCHAR)) {\n+                    partialRow.addString(this.bucketColumnIdIndexes.get(i), type.getSlice(block, position).toStringUtf8());\n+                }\n+                else {\n+                    throw new UnsupportedOperationException(\"Computation of Kudu bucket hashCode is not supported for type: \" + type);\n+                }\n+            }\n+            return KeyEncoderAccessor.getHashBucket(partialRow, hashBucketSchema);\n+        }).collect(toImmutableList());\n+\n+        int bucketId = 0;\n+        for (int i = 0; i < bucketIds.size(); i++) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczNzU5MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450737591", "bodyText": "Sorry, I have to explain this, I am not calculating hash code here, these codes are calculating the index of bucket number(bucketId) in multilevel-partitioning (or singlelevel-partitioning).", "author": "Crossoverrr", "createdAt": "2020-07-07T09:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0MDE2NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450740165", "bodyText": "", "author": "Crossoverrr", "createdAt": "2020-07-07T09:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDY4NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450670685", "bodyText": "kudu.grouped-execution.enabled?\nLet's have it disabled by default, instead of naming this experimental.", "author": "kokosing", "createdAt": "2020-07-07T07:42:43Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientConfig.java", "diffHunk": "@@ -138,4 +139,15 @@ public KuduClientConfig setSchemaEmulationEnabled(boolean enabled)\n         this.schemaEmulationEnabled = enabled;\n         return this;\n     }\n+\n+    @Config(\"experimental.grouped_execution\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0MjY4NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450742684", "bodyText": "Yes, it's disabled by default!  :)", "author": "Crossoverrr", "createdAt": "2020-07-07T09:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDgyMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450670820", "bodyText": "you have missing return this;", "author": "kokosing", "createdAt": "2020-07-07T07:42:59Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientConfig.java", "diffHunk": "@@ -138,4 +139,15 @@ public KuduClientConfig setSchemaEmulationEnabled(boolean enabled)\n         this.schemaEmulationEnabled = enabled;\n         return this;\n     }\n+\n+    @Config(\"experimental.grouped_execution\")\n+    public void setGroupedExecutionEnabled(boolean groupedExecutionEnabled)\n+    {\n+        this.groupedExecutionEnabled = groupedExecutionEnabled;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0NDUzNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450744534", "bodyText": "Sure I will add return this;   :)\nJust curious why we have to do this, a coding rule or something Presto needed?", "author": "Crossoverrr", "createdAt": "2020-07-07T09:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MTg2NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450671865", "bodyText": "why do we have bucket numbers in generic split? Shouldn't this be only available when grouped execution is enabled?", "author": "kokosing", "createdAt": "2020-07-07T07:45:07Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientSession.java", "diffHunk": "@@ -203,9 +203,11 @@ public Schema getTableSchema(KuduTableHandle tableHandle)\n         builder.setProjectedColumnIndexes(columnIndexes);\n \n         List<KuduScanToken> tokens = builder.build();\n-        return tokens.stream()\n-                .map(token -> toKuduSplit(tableHandle, token, primaryKeyColumnCount))\n-                .collect(toImmutableList());\n+        ImmutableList.Builder<KuduSplit> tokenBuilder = ImmutableList.builder();\n+        for (int bucketNumber = 0; bucketNumber < tokens.size(); bucketNumber++) {\n+            tokenBuilder.add(toKuduSplit(tableHandle, tokens.get(bucketNumber), primaryKeyColumnCount, bucketNumber));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0ODUyNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450748525", "bodyText": "Sorry, this is a naming error, I will change it to tokenId. When grouped_execution is disabled, tokens will be created according to the constraint of SQL. TabletIds usually.", "author": "Crossoverrr", "createdAt": "2020-07-07T09:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MjIyNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450672226", "bodyText": "either all arguments are in separate line or none.", "author": "kokosing", "createdAt": "2020-07-07T07:45:51Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +207,45 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false,\n+                    getTableBucketCount(schemaTableName));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0OTc2Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450749767", "bodyText": "Yes, I agree!", "author": "Crossoverrr", "createdAt": "2020-07-07T09:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MjIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MzYyNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450673626", "bodyText": "Please narrow the exception type that catch?", "author": "kokosing", "createdAt": "2020-07-07T07:48:39Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +207,45 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false,\n+                    getTableBucketCount(schemaTableName));\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName)\n+    {\n+        KuduTable table = clientSession.openTable(schemaTableName);\n+        return OptionalInt.of(getHashPartitionCount(table) * getRangePartitionCount(table));\n+    }\n+\n+    private int getHashPartitionCount(KuduTable table)\n+    {\n+        int hashBucketCount = 1;\n+        List<HashBucketSchema> bucketSchemas = table.getPartitionSchema().getHashBucketSchemas();\n+        if (bucketSchemas != null && !bucketSchemas.isEmpty()) {\n+            hashBucketCount = bucketSchemas.stream()\n+                    .mapToInt(HashBucketSchema::getNumBuckets)\n+                    .reduce(1, Math::multiplyExact);\n+        }\n+        return hashBucketCount;\n+    }\n+\n+    private int getRangePartitionCount(KuduTable table)\n+    {\n+        int rangePartitionCount = 1;\n+        try {\n+            List<Partition> rangePartitions = table.getRangePartitions(999);\n+            rangePartitionCount = rangePartitions.size() > 0 ? rangePartitions.size() : 1;\n+        }\n+        catch (Exception e) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1NDQ3NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450754475", "bodyText": "I have checked the api, table.getRangePartitions(999); will throw an Exception in method KuduScanToken#build().", "author": "Crossoverrr", "createdAt": "2020-07-07T10:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MzYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MzcxNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450673714", "bodyText": "Shouldn't we fail instead?", "author": "kokosing", "createdAt": "2020-07-07T07:48:51Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +207,45 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false,\n+                    getTableBucketCount(schemaTableName));\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName)\n+    {\n+        KuduTable table = clientSession.openTable(schemaTableName);\n+        return OptionalInt.of(getHashPartitionCount(table) * getRangePartitionCount(table));\n+    }\n+\n+    private int getHashPartitionCount(KuduTable table)\n+    {\n+        int hashBucketCount = 1;\n+        List<HashBucketSchema> bucketSchemas = table.getPartitionSchema().getHashBucketSchemas();\n+        if (bucketSchemas != null && !bucketSchemas.isEmpty()) {\n+            hashBucketCount = bucketSchemas.stream()\n+                    .mapToInt(HashBucketSchema::getNumBuckets)\n+                    .reduce(1, Math::multiplyExact);\n+        }\n+        return hashBucketCount;\n+    }\n+\n+    private int getRangePartitionCount(KuduTable table)\n+    {\n+        int rangePartitionCount = 1;\n+        try {\n+            List<Partition> rangePartitions = table.getRangePartitions(999);\n+            rangePartitionCount = rangePartitions.size() > 0 ? rangePartitions.size() : 1;\n+        }\n+        catch (Exception e) {\n+            log.error(e, e.getMessage());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1NjA4Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450756082", "bodyText": "Well, what should I do to fail a job here?  :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MzcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDQ5Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450674493", "bodyText": "Please move this method to KuduTable, so you can kuduTable.supportGroupedExecution()", "author": "kokosing", "createdAt": "2020-07-07T07:50:19Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -347,6 +393,20 @@ public ConnectorOutputTableHandle beginCreateTable(\n         return Optional.empty();\n     }\n \n+    private boolean isTableSupportGroupedExecution(KuduTable kuduTable)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1ODg0Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450758843", "bodyText": "Well, KuduTable is a class in third dependency kudu-client.jar, I don't know how to do this. May I just keep it?   :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMzM4OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452033389", "bodyText": "sounds good. Then make it just static", "author": "kokosing", "createdAt": "2020-07-09T07:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NTExNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450675116", "bodyText": "please move this method under the usage", "author": "kokosing", "createdAt": "2020-07-07T07:51:28Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -347,6 +393,20 @@ public ConnectorOutputTableHandle beginCreateTable(\n         return Optional.empty();\n     }\n \n+    private boolean isTableSupportGroupedExecution(KuduTable kuduTable)\n+    {\n+        return !kuduTable.getPartitionSchema().getHashBucketSchemas().isEmpty();\n+    }\n+\n+    private List<ColumnHandle> getSpecifyColumns(Schema schema, List<Integer> targetColumns, Map<String, ColumnHandle> columnMap)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1OTQ5OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450759499", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-07T10:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NTExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzQ5NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450677495", "bodyText": "why not to simply pass handle to KuduBucketFunction constructor?", "author": "kokosing", "createdAt": "2020-07-07T07:56:01Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();\n+        return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());\n+    }\n+\n+    @Override\n+    public ConnectorBucketNodeMap getBucketNodeMap(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return createBucketNodeMap(handle.getBucketCount());\n+    }\n+\n+    @Override\n+    public ToIntFunction<ConnectorSplit> getSplitBucketFunction(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        return value -> ((KuduSplit) value).getBucketNumber();\n+    }\n+\n+    @Override\n+    public BucketFunction getBucketFunction(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle,\n+            List<Type> partitionChannelTypes,\n+            int bucketCount)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return new KuduBucketFunction(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2MTA3MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450761070", "bodyText": "KuduPartitioningHandle has some heavy attributes which are not used in KuduBucketFunction, so I didn't pass the whole handle to KuduBucketFunction. Of course I will do it If you insist.   :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzgwMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450677800", "bodyText": "why not toStringHelper?", "author": "kokosing", "createdAt": "2020-07-07T07:56:36Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private final String schema;\n+    private final String table;\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIndexes;\n+    private final List<Type> bucketColumnTypes;\n+\n+    @JsonCreator\n+    public KuduPartitioningHandle(\n+            @JsonProperty(\"schema\") String schema,\n+            @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"bucketCount\") int bucketCount,\n+            @JsonProperty(\"bucketColumnIndexes\") List<Integer> bucketColumnIndexes,\n+            @JsonProperty(\"bucketColumnTypes\") List<Type> bucketColumnTypes)\n+    {\n+        this.schema = requireNonNull(schema, \"schema is null\");\n+        this.table = table;\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIndexes = bucketColumnIndexes;\n+        this.bucketColumnTypes = requireNonNull(bucketColumnTypes, \"bucketColumnTypes is null\");\n+    }\n+\n+    @JsonProperty\n+    public String getSchema()\n+    {\n+        return schema;\n+    }\n+\n+    @JsonProperty\n+    public String getTable()\n+    {\n+        return table;\n+    }\n+\n+    @JsonProperty\n+    public int getBucketCount()\n+    {\n+        return bucketCount;\n+    }\n+\n+    @JsonProperty\n+    public List<Type> getBucketColumnTypes()\n+    {\n+        return bucketColumnTypes;\n+    }\n+\n+    @JsonProperty\n+    public List<Integer> getBucketColumnIndexes()\n+    {\n+        return bucketColumnIndexes;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return format(\"schema=%s, table=%s, buckets=%d\", schema, table, bucketCount);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2NjE4MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450766180", "bodyText": "will do!", "author": "Crossoverrr", "createdAt": "2020-07-07T10:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzkwNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450677904", "bodyText": "do you need to equals and hashCode at all here?", "author": "kokosing", "createdAt": "2020-07-07T07:56:49Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitioningHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduPartitioningHandle\n+        implements ConnectorPartitioningHandle\n+{\n+    private final String schema;\n+    private final String table;\n+    private final int bucketCount;\n+    private final List<Integer> bucketColumnIndexes;\n+    private final List<Type> bucketColumnTypes;\n+\n+    @JsonCreator\n+    public KuduPartitioningHandle(\n+            @JsonProperty(\"schema\") String schema,\n+            @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"bucketCount\") int bucketCount,\n+            @JsonProperty(\"bucketColumnIndexes\") List<Integer> bucketColumnIndexes,\n+            @JsonProperty(\"bucketColumnTypes\") List<Type> bucketColumnTypes)\n+    {\n+        this.schema = requireNonNull(schema, \"schema is null\");\n+        this.table = table;\n+        this.bucketCount = bucketCount;\n+        this.bucketColumnIndexes = bucketColumnIndexes;\n+        this.bucketColumnTypes = requireNonNull(bucketColumnTypes, \"bucketColumnTypes is null\");\n+    }\n+\n+    @JsonProperty\n+    public String getSchema()\n+    {\n+        return schema;\n+    }\n+\n+    @JsonProperty\n+    public String getTable()\n+    {\n+        return table;\n+    }\n+\n+    @JsonProperty\n+    public int getBucketCount()\n+    {\n+        return bucketCount;\n+    }\n+\n+    @JsonProperty\n+    public List<Type> getBucketColumnTypes()\n+    {\n+        return bucketColumnTypes;\n+    }\n+\n+    @JsonProperty\n+    public List<Integer> getBucketColumnIndexes()\n+    {\n+        return bucketColumnIndexes;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return format(\"schema=%s, table=%s, buckets=%d\", schema, table, bucketCount);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2NjA1MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450766050", "bodyText": "I'm not sure about this, I checked HivePartitioningHandle it do has equals and hashCode. So I suggest we keep these, hahaha", "author": "Crossoverrr", "createdAt": "2020-07-07T10:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NzkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3ODU3NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450678574", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Experimental: Kudu: Enable kudu connector grouped_execution.\",\n          \n          \n            \n                            \"Enable grouped execution\",", "author": "kokosing", "createdAt": "2020-07-07T07:57:55Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSessionProperties.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.session.PropertyMetadata;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+\n+import static io.prestosql.spi.session.PropertyMetadata.booleanProperty;\n+\n+public final class KuduSessionProperties\n+{\n+    private static final String KUDU_GROUPED_EXECUTION_ENABLED = \"grouped_execution\";\n+\n+    private final List<PropertyMetadata<?>> sessionProperties;\n+\n+    @Inject\n+    public KuduSessionProperties(KuduClientConfig kuduConfig)\n+    {\n+        sessionProperties = ImmutableList.<PropertyMetadata<?>>builder()\n+            .add(booleanProperty(\n+                KUDU_GROUPED_EXECUTION_ENABLED,\n+                \"Experimental: Kudu: Enable kudu connector grouped_execution.\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzI1MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451253251", "bodyText": "ok!", "author": "Crossoverrr", "createdAt": "2020-07-08T02:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3ODU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3ODkzMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450678933", "bodyText": "final", "author": "kokosing", "createdAt": "2020-07-07T07:58:35Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+    private AtomicInteger fetchedBucketCount = new AtomicInteger();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3OTU2Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450679562", "bodyText": "splitMap -> groupedSplits", "author": "kokosing", "createdAt": "2020-07-07T07:59:50Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2NzE1NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450767155", "bodyText": "Will do!", "author": "Crossoverrr", "createdAt": "2020-07-07T10:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3OTU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3OTc0Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450679743", "bodyText": "KuduBucketedSplitSource?", "author": "kokosing", "createdAt": "2020-07-07T08:00:10Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2ODU2MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450768561", "bodyText": "Will do!", "author": "Crossoverrr", "createdAt": "2020-07-07T10:34:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3OTc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MDg3NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450680874", "bodyText": "why kuduSplit can be null?", "author": "kokosing", "createdAt": "2020-07-07T08:02:16Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+    private AtomicInteger fetchedBucketCount = new AtomicInteger();\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = requireNonNull(splits, \"splits are null\").stream()\n+                .collect(toImmutableMap(KuduSplit::getBucketNumber, identity()));\n+    }\n+\n+    @Override\n+    public CompletableFuture<ConnectorSplitBatch> getNextBatch(ConnectorPartitionHandle partitionHandle, int maxSize)\n+    {\n+        KuduPartitionHandle kuduPartitionHandle = (KuduPartitionHandle) partitionHandle;\n+        KuduSplit kuduSplit = splitMap.get(kuduPartitionHandle.getBucket());\n+        fetchedBucketCount.incrementAndGet();\n+        return completedFuture(new ConnectorSplitBatch(kuduSplit == null ? ImmutableList.of() : ImmutableList.of(kuduSplit), true));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2OTczNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450769735", "bodyText": "It will not be null, just in case it is null.", "author": "Crossoverrr", "createdAt": "2020-07-07T10:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MDg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MTMwMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450681301", "bodyText": "the best would be to remove entries from splitMap. Notice that this code is vulnerable, in case you are asked for the bucket you might return same split twice and say in isFinished that you finished even if not all splits were procesed.", "author": "kokosing", "createdAt": "2020-07-07T08:03:06Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduSplitSource.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorSplitSource;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static java.util.function.Function.identity;\n+\n+public class KuduSplitSource\n+        implements ConnectorSplitSource\n+{\n+    private final Map<Integer, KuduSplit> splitMap;\n+    private AtomicInteger fetchedBucketCount = new AtomicInteger();\n+\n+    KuduSplitSource(List<KuduSplit> splits)\n+    {\n+        this.splitMap = requireNonNull(splits, \"splits are null\").stream()\n+                .collect(toImmutableMap(KuduSplit::getBucketNumber, identity()));\n+    }\n+\n+    @Override\n+    public CompletableFuture<ConnectorSplitBatch> getNextBatch(ConnectorPartitionHandle partitionHandle, int maxSize)\n+    {\n+        KuduPartitionHandle kuduPartitionHandle = (KuduPartitionHandle) partitionHandle;\n+        KuduSplit kuduSplit = splitMap.get(kuduPartitionHandle.getBucket());\n+        fetchedBucketCount.incrementAndGet();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDIzOQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450770239", "bodyText": "Ok, I will do the change!", "author": "Crossoverrr", "createdAt": "2020-07-07T10:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MTMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MjA2NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450682064", "bodyText": "It is not system property, but catalog property", "author": "kokosing", "createdAt": "2020-07-07T08:04:39Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    public static final String KUDU_GROUPED_EXECUTION = \"kudu.grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        return createKuduQueryRunner(kuduServer, \"test_grouped_execution\");\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyNzI2MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451327261", "bodyText": "Session.builder(getSession()).setCatalogSessionProperty(SCHEMA_KUDU, KUDU_GROUPED_EXECUTION, \"true\")\nsomething like this, right?", "author": "Crossoverrr", "createdAt": "2020-07-08T07:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MjA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5MjIwMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451392200", "bodyText": "Did it!", "author": "Crossoverrr", "createdAt": "2020-07-08T09:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MjA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MzM5MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450683391", "bodyText": "It would be the best to make it a default session in kudu query runner you are using here. I mean it would be best to pass this session to createKuduQueryRunner", "author": "kokosing", "createdAt": "2020-07-07T08:07:10Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    public static final String KUDU_GROUPED_EXECUTION = \"kudu.grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        return createKuduQueryRunner(kuduServer, \"test_grouped_execution\");\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MDMzMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451340331", "bodyText": "Agree!", "author": "Crossoverrr", "createdAt": "2020-07-08T07:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MzM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5MTk5MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r451391991", "bodyText": "agree!", "author": "Crossoverrr", "createdAt": "2020-07-08T08:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MzM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MzgxMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450683811", "bodyText": "How did you verify grouped execution actually worked? This assertion will pass disregarding if it is enabled or not.", "author": "kokosing", "createdAt": "2020-07-07T08:07:56Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    public static final String KUDU_GROUPED_EXECUTION = \"kudu.grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        return createKuduQueryRunner(kuduServer, \"test_grouped_execution\");\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t1 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr1 INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t2 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr2 decimal(10, 6)\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t1 VALUES (0, 0, 0), (0, 1, 0), (1, 1, 1)\", 3);\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t2 VALUES (0, 0, 0), (1, 1, 1), (1, 2, 1)\", 3);\n+        assertQuery(groupedExecutionSessionProperties, \"SELECT t1.* FROM test_grouped_execution_t1 t1 join test_grouped_execution_t2 t2 on t1.key1=t2.key1 WHERE t1.attr1=0\", \"SELECT * FROM (VALUES (0, 0, 0), (0, 1, 0))\", assertRemoteExchangesCount(1));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NTg4MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450775881", "bodyText": "Well, if grouped execution worked, assertRemoteExchangesCount will assert 1, or it will be > 1. This is verified.   :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4MzgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4NDM5Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450684397", "bodyText": "What this assertion proves? Why you expect certain number of exchange stages?", "author": "kokosing", "createdAt": "2020-07-07T08:09:06Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    public static final String KUDU_GROUPED_EXECUTION = \"kudu.grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        return createKuduQueryRunner(kuduServer, \"test_grouped_execution\");\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t1 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr1 INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t2 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr2 decimal(10, 6)\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t1 VALUES (0, 0, 0), (0, 1, 0), (1, 1, 1)\", 3);\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t2 VALUES (0, 0, 0), (1, 1, 1), (1, 2, 1)\", 3);\n+        assertQuery(groupedExecutionSessionProperties, \"SELECT t1.* FROM test_grouped_execution_t1 t1 join test_grouped_execution_t2 t2 on t1.key1=t2.key1 WHERE t1.attr1=0\", \"SELECT * FROM (VALUES (0, 0, 0), (0, 1, 0))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t1\");\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t2\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionGroupBy()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution VALUES (0, 0, 0), (0, 1, 1), (1, 0, 1)\", 3);\n+        assertQuery(groupedExecutionSessionProperties, \"SELECT key1, COUNT(1) FROM test_grouped_execution GROUP BY key1\", \"SELECT * FROM (VALUES (0, 2), (1, 1))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelPartitioning()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_mtlvl (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1', 'key2'],\" +\n+                \" partition_by_hash_buckets = 2,\" +\n+                \" partition_by_second_hash_columns = ARRAY['key3'],\" +\n+                \" partition_by_second_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_mtlvl VALUES (0, 0, 0, 0, 0), (0, 0, 0, 1, 1), (1, 1, 1, 0, 0), (1, 1, 1, 1, 1)\", 4);\n+        assertQuery(groupedExecutionSessionProperties, \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_mtlvl GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 2), (1, 1, 1, 2))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_mtlvl\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelCombinedPartitioning()\n+    {\n+        Session groupedExecutionSessionProperties = Session.builder(getSession())\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setSystemProperty(KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+\n+        assertUpdate(\"CREATE TABLE test_grouped_execution_hash_range (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \"  partition_by_hash_columns = ARRAY['key1'],\" +\n+                \"  partition_by_hash_buckets = 2,\" +\n+                \"  partition_by_second_hash_columns = ARRAY['key2'],\" +\n+                \"  partition_by_second_hash_buckets = 3,\" +\n+                \"  partition_by_range_columns = ARRAY['key3'],\" +\n+                \"  range_partitions = '[{\\\"lower\\\": null, \\\"upper\\\": \\\"4\\\"}, {\\\"lower\\\": \\\"4\\\", \\\"upper\\\": \\\"9\\\"}, {\\\"lower\\\": \\\"9\\\", \\\"upper\\\": null}]'\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_hash_range VALUES (0, 0, 0, 0, 0), (0, 0, 9, 0, 9), (0, 0, 9, 1, 0), (1, 1, 0, 0, 1), (1, 1, 9, 0, 2)\", 5);\n+        assertQuery(groupedExecutionSessionProperties, \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_hash_range GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 1), (0, 0, 9, 2), (1, 1, 0, 1), (1, 1, 9, 1))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_hash_range\");\n+    }\n+\n+    private Consumer<Plan> assertRemoteExchangesCount(int expectedRemoteExchangesCount)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NjczMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450776731", "bodyText": "If grouped_execution worked, there will be only one remoteExchange in group by and join operation, or there will be bigger than 1.  :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4NDM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4NTA1NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450685054", "bodyText": "can we reuse io.prestosql.plugin.kudu.AbstractKuduIntegrationSmokeTest?", "author": "kokosing", "createdAt": "2020-07-07T08:10:20Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3ODIxNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r450778217", "bodyText": "In my opinion, grouped_execution is different than other functions, it's special, so I just create a new one, may I keep this change?  :)", "author": "Crossoverrr", "createdAt": "2020-07-07T10:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4NTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMDUyMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452020523", "bodyText": "inline partitionSchema", "author": "kokosing", "createdAt": "2020-07-09T07:33:25Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NzMwNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452057307", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMDUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMDg5MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452020890", "bodyText": "please inline this method", "author": "kokosing", "createdAt": "2020-07-09T07:34:11Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(page, position);\n+    }\n+\n+    private int getBucketId(Page page, int position)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NzE2OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452057169", "bodyText": "Agree!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMDg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjQ2MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452022460", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        bucketId = bucketId + dimensionBucket;\n          \n          \n            \n                        bucketId += dimensionBucket;", "author": "kokosing", "createdAt": "2020-07-09T07:37:01Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(page, position);\n+    }\n+\n+    private int getBucketId(Page page, int position)\n+    {\n+        checkArgument(this.bucketChannelTypes.size() == page.getChannelCount());\n+        PartialRow partialRow = new PartialRow(this.schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream()\n+                .map(hashBucketSchema -> this.calculateSchemaLevelBucketId(page, partialRow, hashBucketSchema, position))\n+                .collect(toImmutableList());\n+\n+        int bucketId = 0;\n+        for (int i = 0; i < bucketIds.size(); i++) {\n+            int dimensionBucket = 1;\n+            for (int j = 0; j < i; j++) {\n+                dimensionBucket = dimensionBucket * this.hashBucketSchemas.get(j).getNumBuckets();\n+            }\n+            dimensionBucket = dimensionBucket * bucketIds.get(i);\n+            bucketId = bucketId + dimensionBucket;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NzM1Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452057357", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjU4NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452022585", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        dimensionBucket = dimensionBucket * bucketIds.get(i);\n          \n          \n            \n                        dimensionBucket *= bucketIds.get(i);", "author": "kokosing", "createdAt": "2020-07-09T07:37:14Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(page, position);\n+    }\n+\n+    private int getBucketId(Page page, int position)\n+    {\n+        checkArgument(this.bucketChannelTypes.size() == page.getChannelCount());\n+        PartialRow partialRow = new PartialRow(this.schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream()\n+                .map(hashBucketSchema -> this.calculateSchemaLevelBucketId(page, partialRow, hashBucketSchema, position))\n+                .collect(toImmutableList());\n+\n+        int bucketId = 0;\n+        for (int i = 0; i < bucketIds.size(); i++) {\n+            int dimensionBucket = 1;\n+            for (int j = 0; j < i; j++) {\n+                dimensionBucket = dimensionBucket * this.hashBucketSchemas.get(j).getNumBuckets();\n+            }\n+            dimensionBucket = dimensionBucket * bucketIds.get(i);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NzQ1MA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452057450", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjc2Nw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452022767", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            dimensionBucket = dimensionBucket * this.hashBucketSchemas.get(j).getNumBuckets();\n          \n          \n            \n                            dimensionBucket *=  hashBucketSchemas.get(j).getNumBuckets();", "author": "kokosing", "createdAt": "2020-07-09T07:37:34Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(page, position);\n+    }\n+\n+    private int getBucketId(Page page, int position)\n+    {\n+        checkArgument(this.bucketChannelTypes.size() == page.getChannelCount());\n+        PartialRow partialRow = new PartialRow(this.schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream()\n+                .map(hashBucketSchema -> this.calculateSchemaLevelBucketId(page, partialRow, hashBucketSchema, position))\n+                .collect(toImmutableList());\n+\n+        int bucketId = 0;\n+        for (int i = 0; i < bucketIds.size(); i++) {\n+            int dimensionBucket = 1;\n+            for (int j = 0; j < i; j++) {\n+                dimensionBucket = dimensionBucket * this.hashBucketSchemas.get(j).getNumBuckets();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1ODI4MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452058281", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMjc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyODYzNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452028637", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .add(\"bucketChannels\", Arrays.toString(bucketChannels.toArray()))\n          \n          \n            \n                            .add(\"bucketChannels\", bucketChannels)", "author": "kokosing", "createdAt": "2020-07-09T07:48:36Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduBucketFunction.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Shorts;\n+import com.google.common.primitives.SignedBytes;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.type.Type;\n+import org.apache.kudu.Schema;\n+import org.apache.kudu.client.KeyEncoderAccessor;\n+import org.apache.kudu.client.KuduTable;\n+import org.apache.kudu.client.PartialRow;\n+import org.apache.kudu.client.PartitionSchema;\n+import org.apache.kudu.client.PartitionSchema.HashBucketSchema;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static java.lang.Math.toIntExact;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduBucketFunction\n+        implements BucketFunction\n+{\n+    private final List<Integer> bucketChannels;\n+    private final List<Type> bucketChannelTypes;\n+\n+    private final List<HashBucketSchema> hashBucketSchemas;\n+    private final Schema schema;\n+\n+    KuduBucketFunction(List<Integer> bucketChannels, List<Type> bucketChannelTypes, KuduTable kuduTable)\n+    {\n+        this.bucketChannels = ImmutableList.copyOf(requireNonNull(bucketChannels));\n+        this.bucketChannelTypes = ImmutableList.copyOf(requireNonNull(bucketChannelTypes));\n+        checkArgument(bucketChannels.size() == bucketChannelTypes.size());\n+\n+        PartitionSchema partitionSchema = kuduTable.getPartitionSchema();\n+        this.hashBucketSchemas = partitionSchema.getHashBucketSchemas();\n+        this.schema = kuduTable.getSchema();\n+    }\n+\n+    @Override\n+    public int getBucket(Page page, int position)\n+    {\n+        return getBucketId(page, position);\n+    }\n+\n+    private int getBucketId(Page page, int position)\n+    {\n+        checkArgument(this.bucketChannelTypes.size() == page.getChannelCount());\n+        PartialRow partialRow = new PartialRow(this.schema);\n+        List<Integer> bucketIds = this.hashBucketSchemas.stream()\n+                .map(hashBucketSchema -> this.calculateSchemaLevelBucketId(page, partialRow, hashBucketSchema, position))\n+                .collect(toImmutableList());\n+\n+        int bucketId = 0;\n+        for (int i = 0; i < bucketIds.size(); i++) {\n+            int dimensionBucket = 1;\n+            for (int j = 0; j < i; j++) {\n+                dimensionBucket = dimensionBucket * this.hashBucketSchemas.get(j).getNumBuckets();\n+            }\n+            dimensionBucket = dimensionBucket * bucketIds.get(i);\n+            bucketId = bucketId + dimensionBucket;\n+        }\n+        return bucketId;\n+    }\n+\n+    private int calculateSchemaLevelBucketId(Page page, PartialRow partialRow, HashBucketSchema hashBucketSchema, int position)\n+    {\n+        for (int channel = 0; channel < page.getChannelCount(); channel++) {\n+            Block block = page.getBlock(channel);\n+            Type type = this.bucketChannelTypes.get(channel);\n+            Integer bucketChannel = this.bucketChannels.get(channel);\n+            if (BOOLEAN.equals(type)) {\n+                partialRow.addBoolean(bucketChannel, BOOLEAN.getBoolean(block, position));\n+            }\n+            else if (BIGINT.equals(type)) {\n+                partialRow.addLong(bucketChannel, type.getLong(block, position));\n+            }\n+            else if (INTEGER.equals(type)) {\n+                partialRow.addInt(bucketChannel, toIntExact(type.getLong(block, position)));\n+            }\n+            else if (SMALLINT.equals(type)) {\n+                partialRow.addShort(bucketChannel, Shorts.checkedCast(type.getLong(block, position)));\n+            }\n+            else if (TINYINT.equals(type)) {\n+                partialRow.addByte(bucketChannel, SignedBytes.checkedCast(type.getLong(block, position)));\n+            }\n+            else if (DOUBLE.equals(type)) {\n+                partialRow.addDouble(bucketChannel, type.getDouble(block, position));\n+            }\n+            else if (VARCHAR.equals(type)) {\n+                partialRow.addString(bucketChannel, type.getSlice(block, position).toStringUtf8());\n+            }\n+            else {\n+                throw new UnsupportedOperationException(\"Grouped execution is not supported for type: \" + type);\n+            }\n+        }\n+        return KeyEncoderAccessor.getHashBucket(partialRow, hashBucketSchema);\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return toStringHelper(this)\n+                .add(\"bucketChannels\", Arrays.toString(bucketChannels.toArray()))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1ODk1NQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452058955", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyODYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyOTU5Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452029592", "bodyText": "why tokenId becomes a bucket number?", "author": "kokosing", "createdAt": "2020-07-09T07:50:26Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduClientSession.java", "diffHunk": "@@ -203,9 +203,11 @@ public Schema getTableSchema(KuduTableHandle tableHandle)\n         builder.setProjectedColumnIndexes(columnIndexes);\n \n         List<KuduScanToken> tokens = builder.build();\n-        return tokens.stream()\n-                .map(token -> toKuduSplit(tableHandle, token, primaryKeyColumnCount))\n-                .collect(toImmutableList());\n+        ImmutableList.Builder<KuduSplit> tokenBuilder = ImmutableList.builder();\n+        for (int tokenId = 0; tokenId < tokens.size(); tokenId++) {\n+            tokenBuilder.add(toKuduSplit(tableHandle, tokens.get(tokenId), primaryKeyColumnCount, tokenId));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NjQ2MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452066461", "bodyText": "Let me explain, in both grouped_execution and ungrouped_execution mode, tokens are all the same, it is created according to sql constraint and are tablets basically, just in grouped_execution tokens has another meaning as bucketId(bucket number).   :)", "author": "Crossoverrr", "createdAt": "2020-07-09T08:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyOTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyOTkwMA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452029900", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            binder ->\n          \n          \n            \n                                binder.bind(ClassLoader.class).toInstance(KuduConnectorFactory.class.getClassLoader()));\n          \n          \n            \n                            binder -> binder.bind(ClassLoader.class).toInstance(KuduConnectorFactory.class.getClassLoader()));", "author": "kokosing", "createdAt": "2020-07-09T07:50:59Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduConnectorFactory.java", "diffHunk": "@@ -51,7 +51,9 @@ public Connector create(String catalogName, Map<String, String> config, Connecto\n \n         Bootstrap app = new Bootstrap(\n                 new JsonModule(),\n-                new KuduModule(context.getTypeManager()));\n+                new KuduModule(context.getTypeManager()),\n+                binder ->\n+                    binder.bind(ClassLoader.class).toInstance(KuduConnectorFactory.class.getClassLoader()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1OTgxNA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452059814", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyOTkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMjIzNQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452032235", "bodyText": "I think you should not call that method to frequently as it might do communication round-trip with Kudu service. Why not to pass KuduTable as argument instead of SchemaTableName", "author": "kokosing", "createdAt": "2020-07-09T07:55:09Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +204,44 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false, getTableBucketCount(schemaTableName));\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName)\n+    {\n+        KuduTable table = clientSession.openTable(schemaTableName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2MTQ2OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452061469", "bodyText": "Absolutely right!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMjIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMjk4NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452032984", "bodyText": "what is this magic number 999?", "author": "kokosing", "createdAt": "2020-07-09T07:56:30Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -193,13 +204,44 @@ public KuduTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         try {\n             KuduTable table = clientSession.openTable(schemaTableName);\n-            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false);\n+            return new KuduTableHandle(schemaTableName, table, TupleDomain.all(), Optional.empty(), false, getTableBucketCount(schemaTableName));\n         }\n         catch (NotFoundException e) {\n             return null;\n         }\n     }\n \n+    private OptionalInt getTableBucketCount(SchemaTableName schemaTableName)\n+    {\n+        KuduTable table = clientSession.openTable(schemaTableName);\n+        return OptionalInt.of(getHashPartitionCount(table) * getRangePartitionCount(table));\n+    }\n+\n+    private int getHashPartitionCount(KuduTable table)\n+    {\n+        int hashBucketCount = 1;\n+        List<HashBucketSchema> bucketSchemas = table.getPartitionSchema().getHashBucketSchemas();\n+        if (bucketSchemas != null && !bucketSchemas.isEmpty()) {\n+            hashBucketCount = bucketSchemas.stream()\n+                    .mapToInt(HashBucketSchema::getNumBuckets)\n+                    .reduce(1, Math::multiplyExact);\n+        }\n+        return hashBucketCount;\n+    }\n+\n+    private int getRangePartitionCount(KuduTable table)\n+    {\n+        int rangePartitionCount;\n+        try {\n+            List<Partition> rangePartitions = table.getRangePartitions(999);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NzMyNg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452067326", "bodyText": "I think 1 second is enough to wait, so should I create a constant in class KuduMetadata?  :)", "author": "Crossoverrr", "createdAt": "2020-07-09T08:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMjk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjE0OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r454256148", "bodyText": "What happens if it is not enough to wait?", "author": "kokosing", "createdAt": "2020-07-14T10:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMjk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMzgxMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452033813", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());\n          \n          \n            \n                    return IntStream.range(0, bucketCount)\n          \n          \n            \n                            .mapToObj(KuduPartitionHandle::new)\n          \n          \n            \n                            .collect(toImmutableList());", "author": "kokosing", "createdAt": "2020-07-09T07:57:55Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();\n+        return IntStream.range(0, bucketCount).mapToObj(KuduPartitionHandle::new).collect(toImmutableList());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2ODk5Mw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452068993", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMzgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMzk3NA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452033974", "bodyText": "inline bucketCount", "author": "kokosing", "createdAt": "2020-07-09T07:58:12Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        int bucketCount = handle.getBucketCount();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2OTA2MQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452069061", "bodyText": "OK!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzMzk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0MTIyMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452041221", "bodyText": "display bucket", "author": "kokosing", "createdAt": "2020-07-09T08:11:19Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduPartitionHandle.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+\n+import java.util.Objects;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+\n+public class KuduPartitionHandle\n+        extends ConnectorPartitionHandle\n+{\n+    private final int bucket;\n+\n+    public KuduPartitionHandle(int bucket)\n+    {\n+        this.bucket = bucket;\n+    }\n+\n+    public int getBucket()\n+    {\n+        return bucket;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        KuduPartitionHandle that = (KuduPartitionHandle) o;\n+        return bucket == that.bucket;\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return Objects.hash(bucket);\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return toStringHelper(this)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2OTUxNw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452069517", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T08:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0MTIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0MjY0OA==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452042648", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertQuery(getSession(), \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_hash_range GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 1), (0, 0, 9, 2), (1, 1, 0, 1), (1, 1, 9, 1))\", assertRemoteExchangesCount(1));\n          \n          \n            \n                    assertQuery(\n          \n          \n            \n                        getSession(), \n          \n          \n            \n                        \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_hash_range GROUP BY key1, key2, key3\", \n          \n          \n            \n                        \"VALUES (0, 0, 0, 1), (0, 0, 9, 2), (1, 1, 0, 1), (1, 1, 9, 1)\", \n          \n          \n            \n                        assertRemoteExchangesCount(1));\n          \n      \n    \n    \n  \n\nApply same comment to all other tests", "author": "kokosing", "createdAt": "2020-07-09T08:13:46Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createSession;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    private static final String SCHEMA_KUDU = \"kudu\";\n+    private static final String KUDU_GROUPED_EXECUTION = \"grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        Session groupedExecutionSessionProperties = Session.builder(createSession(\"test_grouped_execution\"))\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setCatalogSessionProperty(SCHEMA_KUDU, KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+        return createKuduQueryRunner(kuduServer, groupedExecutionSessionProperties);\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t1 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr1 INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t2 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr2 decimal(10, 6)\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t1 VALUES (0, 0, 0), (0, 1, 0), (1, 1, 1)\", 3);\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t2 VALUES (0, 0, 0), (1, 1, 1), (1, 2, 1)\", 3);\n+        assertQuery(getSession(), \"SELECT t1.* FROM test_grouped_execution_t1 t1 join test_grouped_execution_t2 t2 on t1.key1=t2.key1 WHERE t1.attr1=0\", \"SELECT * FROM (VALUES (0, 0, 0), (0, 1, 0))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t1\");\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t2\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionGroupBy()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution VALUES (0, 0, 0), (0, 1, 1), (1, 0, 1)\", 3);\n+        assertQuery(getSession(), \"SELECT key1, COUNT(1) FROM test_grouped_execution GROUP BY key1\", \"SELECT * FROM (VALUES (0, 2), (1, 1))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_mtlvl (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1', 'key2'],\" +\n+                \" partition_by_hash_buckets = 2,\" +\n+                \" partition_by_second_hash_columns = ARRAY['key3'],\" +\n+                \" partition_by_second_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_mtlvl VALUES (0, 0, 0, 0, 0), (0, 0, 0, 1, 1), (1, 1, 1, 0, 0), (1, 1, 1, 1, 1)\", 4);\n+        assertQuery(getSession(), \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_mtlvl GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 2), (1, 1, 1, 2))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_mtlvl\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelCombinedPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE test_grouped_execution_hash_range (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \"  partition_by_hash_columns = ARRAY['key1'],\" +\n+                \"  partition_by_hash_buckets = 2,\" +\n+                \"  partition_by_second_hash_columns = ARRAY['key2'],\" +\n+                \"  partition_by_second_hash_buckets = 3,\" +\n+                \"  partition_by_range_columns = ARRAY['key3'],\" +\n+                \"  range_partitions = '[{\\\"lower\\\": null, \\\"upper\\\": \\\"4\\\"}, {\\\"lower\\\": \\\"4\\\", \\\"upper\\\": \\\"9\\\"}, {\\\"lower\\\": \\\"9\\\", \\\"upper\\\": null}]'\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_hash_range VALUES (0, 0, 0, 0, 0), (0, 0, 9, 0, 9), (0, 0, 9, 1, 0), (1, 1, 0, 0, 1), (1, 1, 9, 0, 2)\", 5);\n+        assertQuery(getSession(), \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_hash_range GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 1), (0, 0, 9, 2), (1, 1, 0, 1), (1, 1, 9, 1))\", assertRemoteExchangesCount(1));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3MjI0Mg==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452072242", "bodyText": "Did it!", "author": "Crossoverrr", "createdAt": "2020-07-09T09:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0MjY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0NDAyMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452044021", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"Expected [\\n%s\\n] remote exchanges but found [\\n%s\\n] remote exchanges. Actual plan is [\\n\\n%s\\n]\",\n          \n          \n            \n                                    \"Expected %s remote exchanges but found %s. Actual plan is:\\n%s]\",", "author": "kokosing", "createdAt": "2020-07-09T08:16:11Z", "path": "presto-kudu/src/test/java/io/prestosql/plugin/kudu/TestKuduIntegrationGroupedExecution.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.Session;\n+import io.prestosql.cost.StatsAndCosts;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.sql.planner.Plan;\n+import io.prestosql.sql.planner.plan.ExchangeNode;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.QueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.function.Consumer;\n+\n+import static io.prestosql.SystemSessionProperties.COLOCATED_JOIN;\n+import static io.prestosql.SystemSessionProperties.CONCURRENT_LIFESPANS_PER_NODE;\n+import static io.prestosql.SystemSessionProperties.DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION;\n+import static io.prestosql.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static io.prestosql.SystemSessionProperties.GROUPED_EXECUTION;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createKuduQueryRunner;\n+import static io.prestosql.plugin.kudu.KuduQueryRunnerFactory.createSession;\n+import static io.prestosql.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+import static io.prestosql.sql.planner.planprinter.PlanPrinter.textLogicalPlan;\n+import static java.lang.String.format;\n+\n+public class TestKuduIntegrationGroupedExecution\n+        extends AbstractTestQueryFramework\n+{\n+    private static final String SCHEMA_KUDU = \"kudu\";\n+    private static final String KUDU_GROUPED_EXECUTION = \"grouped_execution\";\n+    private TestingKuduServer kuduServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        kuduServer = new TestingKuduServer();\n+        Session groupedExecutionSessionProperties = Session.builder(createSession(\"test_grouped_execution\"))\n+                .setSystemProperty(COLOCATED_JOIN, \"true\")\n+                .setSystemProperty(GROUPED_EXECUTION, \"true\")\n+                .setSystemProperty(CONCURRENT_LIFESPANS_PER_NODE, \"1\")\n+                .setSystemProperty(DYNAMIC_SCHEDULE_FOR_GROUPED_EXECUTION, \"false\")\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"false\")\n+                .setCatalogSessionProperty(SCHEMA_KUDU, KUDU_GROUPED_EXECUTION, \"true\")\n+                .build();\n+        return createKuduQueryRunner(kuduServer, groupedExecutionSessionProperties);\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        kuduServer.close();\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionJoin()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t1 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr1 INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_t2 (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr2 decimal(10, 6)\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t1 VALUES (0, 0, 0), (0, 1, 0), (1, 1, 1)\", 3);\n+        assertUpdate(\"INSERT INTO test_grouped_execution_t2 VALUES (0, 0, 0), (1, 1, 1), (1, 2, 1)\", 3);\n+        assertQuery(getSession(), \"SELECT t1.* FROM test_grouped_execution_t1 t1 join test_grouped_execution_t2 t2 on t1.key1=t2.key1 WHERE t1.attr1=0\", \"SELECT * FROM (VALUES (0, 0, 0), (0, 1, 0))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t1\");\n+        assertUpdate(\"DROP TABLE test_grouped_execution_t2\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionGroupBy()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution (\" +\n+                \"key1 INT WITH (primary_key=true), \" +\n+                \"key2 INT WITH (primary_key=true), \" +\n+                \"attr INT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1'], \" +\n+                \" partition_by_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution VALUES (0, 0, 0), (0, 1, 1), (1, 0, 1)\", 3);\n+        assertQuery(getSession(), \"SELECT key1, COUNT(1) FROM test_grouped_execution GROUP BY key1\", \"SELECT * FROM (VALUES (0, 2), (1, 1))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE IF NOT EXISTS test_grouped_execution_mtlvl (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \" partition_by_hash_columns = ARRAY['key1', 'key2'],\" +\n+                \" partition_by_hash_buckets = 2,\" +\n+                \" partition_by_second_hash_columns = ARRAY['key3'],\" +\n+                \" partition_by_second_hash_buckets = 2\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_mtlvl VALUES (0, 0, 0, 0, 0), (0, 0, 0, 1, 1), (1, 1, 1, 0, 0), (1, 1, 1, 1, 1)\", 4);\n+        assertQuery(getSession(), \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_mtlvl GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 2), (1, 1, 1, 2))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_mtlvl\");\n+    }\n+\n+    @Test\n+    public void testGroupedExecutionMultiLevelCombinedPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE test_grouped_execution_hash_range (\" +\n+                \"key1 BIGINT WITH (primary_key=true),\" +\n+                \"key2 BIGINT WITH (primary_key=true),\" +\n+                \"key3 BIGINT WITH (primary_key=true),\" +\n+                \"key4 BIGINT WITH (primary_key=true),\" +\n+                \"attr1 BIGINT\" +\n+                \") WITH (\" +\n+                \"  partition_by_hash_columns = ARRAY['key1'],\" +\n+                \"  partition_by_hash_buckets = 2,\" +\n+                \"  partition_by_second_hash_columns = ARRAY['key2'],\" +\n+                \"  partition_by_second_hash_buckets = 3,\" +\n+                \"  partition_by_range_columns = ARRAY['key3'],\" +\n+                \"  range_partitions = '[{\\\"lower\\\": null, \\\"upper\\\": \\\"4\\\"}, {\\\"lower\\\": \\\"4\\\", \\\"upper\\\": \\\"9\\\"}, {\\\"lower\\\": \\\"9\\\", \\\"upper\\\": null}]'\" +\n+                \")\");\n+\n+        assertUpdate(\"INSERT INTO test_grouped_execution_hash_range VALUES (0, 0, 0, 0, 0), (0, 0, 9, 0, 9), (0, 0, 9, 1, 0), (1, 1, 0, 0, 1), (1, 1, 9, 0, 2)\", 5);\n+        assertQuery(getSession(), \"SELECT key1, key2, key3, COUNT(1) FROM test_grouped_execution_hash_range GROUP BY key1, key2, key3\", \"SELECT * FROM (VALUES (0, 0, 0, 1), (0, 0, 9, 2), (1, 1, 0, 1), (1, 1, 9, 1))\", assertRemoteExchangesCount(1));\n+\n+        assertUpdate(\"DROP TABLE test_grouped_execution_hash_range\");\n+    }\n+\n+    private Consumer<Plan> assertRemoteExchangesCount(int expectedRemoteExchangesCount)\n+    {\n+        return plan -> {\n+            int actualRemoteExchangesCount = searchFrom(plan.getRoot())\n+                    .where(node -> node instanceof ExchangeNode && ((ExchangeNode) node).getScope() == ExchangeNode.Scope.REMOTE)\n+                    .findAll()\n+                    .size();\n+            if (actualRemoteExchangesCount != expectedRemoteExchangesCount) {\n+                Session session = getSession();\n+                Metadata metadata = ((DistributedQueryRunner) getQueryRunner()).getCoordinator().getMetadata();\n+                String formattedPlan = textLogicalPlan(plan.getRoot(), plan.getTypes(), metadata, StatsAndCosts.empty(), session, 0, false);\n+                throw new AssertionError(format(\n+                        \"Expected [\\n%s\\n] remote exchanges but found [\\n%s\\n] remote exchanges. Actual plan is [\\n\\n%s\\n]\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA4MjkwMw==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r452082903", "bodyText": "Sure!", "author": "Crossoverrr", "createdAt": "2020-07-09T09:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0NDAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxODA1OQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r453618059", "bodyText": "Please change commit message:\nAdd grouped_execution to kudu connector\n\n<Here please add more details>", "author": "kokosing", "createdAt": "2020-07-13T12:37:44Z", "path": "presto-kudu/pom.xml", "diffHunk": "@@ -17,6 +17,11 @@\n     </properties>", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ddbec5dde4346310c6d233413634fe0269e0b2c", "url": "https://github.com/trinodb/trino/commit/0ddbec5dde4346310c6d233413634fe0269e0b2c", "message": "Add grouped_execution to kudu connector\n\nWhen the input tables are already partitioned on the join key or aggregation key, make Presto could process a subset (group) of the partitions of the data at a time.", "committedDate": "2020-07-16T03:32:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDcxMjIzOQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r584712239", "bodyText": "Any reason bucketCount gets ignored here?", "author": "findepi", "createdAt": "2021-03-01T13:31:14Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduNodePartitioningProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.kudu;\n+\n+import io.prestosql.spi.connector.BucketFunction;\n+import io.prestosql.spi.connector.ConnectorBucketNodeMap;\n+import io.prestosql.spi.connector.ConnectorNodePartitioningProvider;\n+import io.prestosql.spi.connector.ConnectorPartitionHandle;\n+import io.prestosql.spi.connector.ConnectorPartitioningHandle;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorSplit;\n+import io.prestosql.spi.connector.ConnectorTransactionHandle;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.type.Type;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.connector.ConnectorBucketNodeMap.createBucketNodeMap;\n+import static java.util.Objects.requireNonNull;\n+\n+public class KuduNodePartitioningProvider\n+        implements ConnectorNodePartitioningProvider\n+{\n+    private final KuduClientSession clientSession;\n+\n+    @Inject\n+    public KuduNodePartitioningProvider(KuduClientSession clientSession)\n+    {\n+        this.clientSession = requireNonNull(clientSession, \"clientSession is null\");\n+    }\n+\n+    @Override\n+    public List<ConnectorPartitionHandle> listPartitionHandles(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return IntStream.range(0, handle.getBucketCount())\n+                .mapToObj(KuduPartitionHandle::new)\n+                .collect(toImmutableList());\n+    }\n+\n+    @Override\n+    public ConnectorBucketNodeMap getBucketNodeMap(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        KuduPartitioningHandle handle = (KuduPartitioningHandle) partitioningHandle;\n+        return createBucketNodeMap(handle.getBucketCount());\n+    }\n+\n+    @Override\n+    public ToIntFunction<ConnectorSplit> getSplitBucketFunction(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle)\n+    {\n+        return value -> ((KuduSplit) value).getBucketNumber();\n+    }\n+\n+    @Override\n+    public BucketFunction getBucketFunction(\n+            ConnectorTransactionHandle transactionHandle,\n+            ConnectorSession session,\n+            ConnectorPartitioningHandle partitioningHandle,\n+            List<Type> partitionChannelTypes,\n+            int bucketCount)", "originalCommit": "0ddbec5dde4346310c6d233413634fe0269e0b2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMzNDQwMQ==", "url": "https://github.com/trinodb/trino/pull/3715#discussion_r587334401", "bodyText": "Well, bucketCount means the total count of bucket, and I can get more informations about bucket schema in attribute KuduBucketFunction#hashBucketSchemas, so I didn't use this param.   :)", "author": "Crossoverrr", "createdAt": "2021-03-04T10:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDcxMjIzOQ=="}], "type": "inlineReview"}]}