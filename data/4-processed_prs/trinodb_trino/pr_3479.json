{"pr_number": 3479, "pr_title": "Fix stats collection for JDBC based connector", "pr_createdAt": "2020-04-19T14:15:35Z", "pr_url": "https://github.com/trinodb/trino/pull/3479", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzNzg0NA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r410937844", "bodyText": "What was wrong?", "author": "kokosing", "createdAt": "2020-04-19T16:11:43Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcDiagnosticModule.java", "diffHunk": "@@ -58,21 +58,19 @@ public void configure(Binder binder)\n     @StatsCollecting\n     public JdbcClient createJdbcClientWithStats(@ForBaseJdbc JdbcClient client)\n     {\n-        StatisticsAwareJdbcClient statisticsAwareJdbcClient = new StatisticsAwareJdbcClient(client);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzOTI4MA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r410939280", "bodyText": "It looks like StatisticsAwareJdbcClient#getStats is not exposed in JMX so the actual stats are not exposed\nBefore\n   Column    |  Type   | Extra | Comment\n-------------+---------+-------+---------\n node        | varchar |       |\n object_name | varchar |       |\n\nAfter\n                         Column                          |  Type   | Extra | Comment\n---------------------------------------------------------+---------+-------+---------\n abortreadconnection.failures.fifteenminute.count        | double  |       |\n abortreadconnection.failures.fifteenminute.rate         | double  |       |\n abortreadconnection.failures.fiveminute.count           | double  |       |", "author": "Praveen2112", "createdAt": "2020-04-19T16:19:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzNzg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEwNTUxOA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411105518", "bodyText": "Can you please add a test for that?\nOr even better it would be to add a trap for things like that. Do you exact reasaon why stats were not exposed? Like not allowing to use newExporter when bean does not expose method with @Managed?", "author": "kokosing", "createdAt": "2020-04-20T05:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzNzg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEzMTUyMg==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411131522", "bodyText": "It didn't work because the StatisticsAwareJdbcClient instance was not a bean (never exposed at guice DI level) and so it could not get exported.", "author": "findepi", "createdAt": "2020-04-20T06:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzNzg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4NTAyNg==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411185026", "bodyText": "Stats do not get exposed automatically, we expose them using newExporter(..).... This code was called but StatisticsAwareJdbcClient was wrapped so annotated methods with @Managed were not accessible. It would be nice to have something to prevent such bugs.", "author": "kokosing", "createdAt": "2020-04-20T08:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDkzNzg0NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODQ0Mw==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411338443", "bodyText": "Why?", "author": "kokosing", "createdAt": "2020-04-20T12:31:20Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestingH2JdbcModule.java", "diffHunk": "@@ -26,7 +26,7 @@\n \n import static java.lang.String.format;\n \n-class TestingH2JdbcModule\n+public class TestingH2JdbcModule", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTkyMA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411355920", "bodyText": "Previously it was package protected so we cant access in our JmxTest or we have to move JmxTest to a different package", "author": "Praveen2112", "createdAt": "2020-04-20T12:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM2NzQ5MA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411367490", "bodyText": "Please move JmxTest to different package. I don't think we need separate package for single test, do we? Otherwise please squash commits.", "author": "kokosing", "createdAt": "2020-04-20T13:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODY1Mw==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411338653", "bodyText": "just throws Exception?", "author": "kokosing", "createdAt": "2020-04-20T12:31:41Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/jmx/TestJmxStats.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.jmx;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.plugin.jdbc.JdbcPlugin;\n+import io.prestosql.plugin.jdbc.TestingH2JdbcModule;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.testing.TestingConnectorContext;\n+import org.assertj.core.util.Arrays;\n+import org.testng.annotations.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.IntrospectionException;\n+import javax.management.MBeanInfo;\n+import javax.management.MBeanServer;\n+import javax.management.MalformedObjectNameException;\n+import javax.management.ObjectName;\n+import javax.management.ReflectionException;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static java.lang.String.format;\n+import static java.lang.management.ManagementFactory.getPlatformMBeanServer;\n+import static org.testng.Assert.assertFalse;\n+\n+public class TestJmxStats\n+{\n+    @Test\n+    public void testJmxStatsExposure()\n+            throws MalformedObjectNameException, IntrospectionException, InstanceNotFoundException, ReflectionException", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTk4MQ==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411355981", "bodyText": "Modified", "author": "Praveen2112", "createdAt": "2020-04-20T12:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODgzMw==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411338833", "bodyText": "Please remove this for", "author": "kokosing", "createdAt": "2020-04-20T12:31:58Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/jmx/TestJmxStats.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.jmx;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.plugin.jdbc.JdbcPlugin;\n+import io.prestosql.plugin.jdbc.TestingH2JdbcModule;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.testing.TestingConnectorContext;\n+import org.assertj.core.util.Arrays;\n+import org.testng.annotations.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.IntrospectionException;\n+import javax.management.MBeanInfo;\n+import javax.management.MBeanServer;\n+import javax.management.MalformedObjectNameException;\n+import javax.management.ObjectName;\n+import javax.management.ReflectionException;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static java.lang.String.format;\n+import static java.lang.management.ManagementFactory.getPlatformMBeanServer;\n+import static org.testng.Assert.assertFalse;\n+\n+public class TestJmxStats\n+{\n+    @Test\n+    public void testJmxStatsExposure()\n+            throws MalformedObjectNameException, IntrospectionException, InstanceNotFoundException, ReflectionException\n+    {\n+        Plugin plugin = new JdbcPlugin(\"base-jdbc\", new TestingH2JdbcModule());\n+        ConnectorFactory factory = getOnlyElement(plugin.getConnectorFactories());\n+        factory.create(\"test\", ImmutableMap.of(\"connection-url\", \"jdbc\"), new TestingConnectorContext());\n+        MBeanServer mbeanServer = getPlatformMBeanServer();\n+        for (String domainName : mbeanServer.getDomains()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NjExMg==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411356112", "bodyText": "Removed it", "author": "Praveen2112", "createdAt": "2020-04-20T12:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzOTIzMw==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411339233", "bodyText": "static import", "author": "kokosing", "createdAt": "2020-04-20T12:32:37Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/jmx/TestJmxStats.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.jmx;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.plugin.jdbc.JdbcPlugin;\n+import io.prestosql.plugin.jdbc.TestingH2JdbcModule;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.testing.TestingConnectorContext;\n+import org.assertj.core.util.Arrays;\n+import org.testng.annotations.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.IntrospectionException;\n+import javax.management.MBeanInfo;\n+import javax.management.MBeanServer;\n+import javax.management.MalformedObjectNameException;\n+import javax.management.ObjectName;\n+import javax.management.ReflectionException;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static java.lang.String.format;\n+import static java.lang.management.ManagementFactory.getPlatformMBeanServer;\n+import static org.testng.Assert.assertFalse;\n+\n+public class TestJmxStats\n+{\n+    @Test\n+    public void testJmxStatsExposure()\n+            throws MalformedObjectNameException, IntrospectionException, InstanceNotFoundException, ReflectionException\n+    {\n+        Plugin plugin = new JdbcPlugin(\"base-jdbc\", new TestingH2JdbcModule());\n+        ConnectorFactory factory = getOnlyElement(plugin.getConnectorFactories());\n+        factory.create(\"test\", ImmutableMap.of(\"connection-url\", \"jdbc\"), new TestingConnectorContext());\n+        MBeanServer mbeanServer = getPlatformMBeanServer();\n+        for (String domainName : mbeanServer.getDomains()) {\n+            System.out.println(domainName);\n+        }\n+        for (ObjectName objectName : mbeanServer.queryNames(new ObjectName(\"io.prestosql.plugin.jdbc:*\"), null)) {\n+            MBeanInfo mbeanInfo = mbeanServer.getMBeanInfo(objectName);\n+            assertFalse(Arrays.isNullOrEmpty(mbeanInfo.getAttributes()), format(\"Object %s doesn't expose JMX stats\", objectName.getCanonicalName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzOTU5Nw==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411339597", "bodyText": "Is this test failing without changes in presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcDiagnosticModule.java?", "author": "kokosing", "createdAt": "2020-04-20T12:33:15Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/jmx/TestJmxStats.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.jmx;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.plugin.jdbc.JdbcPlugin;\n+import io.prestosql.plugin.jdbc.TestingH2JdbcModule;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.testing.TestingConnectorContext;\n+import org.assertj.core.util.Arrays;\n+import org.testng.annotations.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.IntrospectionException;\n+import javax.management.MBeanInfo;\n+import javax.management.MBeanServer;\n+import javax.management.MalformedObjectNameException;\n+import javax.management.ObjectName;\n+import javax.management.ReflectionException;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static java.lang.String.format;\n+import static java.lang.management.ManagementFactory.getPlatformMBeanServer;\n+import static org.testng.Assert.assertFalse;\n+\n+public class TestJmxStats\n+{\n+    @Test", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NjI1MQ==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411356251", "bodyText": "Yes", "author": "Praveen2112", "createdAt": "2020-04-20T12:59:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzOTU5Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM2ODU4OA==", "url": "https://github.com/trinodb/trino/pull/3479#discussion_r411368588", "bodyText": "Please make sure that mbeanServer.queryNames(new ObjectName(\"io.prestosql.plugin.jdbc:*\") does not return empty list. Also please verify that few that we care of are there (jdbc client and coonnection factory)", "author": "kokosing", "createdAt": "2020-04-20T13:17:13Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/jmx/TestJmxStats.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.jmx;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.plugin.jdbc.JdbcPlugin;\n+import io.prestosql.plugin.jdbc.TestingH2JdbcModule;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.testing.TestingConnectorContext;\n+import org.testng.annotations.Test;\n+\n+import javax.management.MBeanInfo;\n+import javax.management.MBeanServer;\n+import javax.management.ObjectName;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static java.lang.String.format;\n+import static java.lang.management.ManagementFactory.getPlatformMBeanServer;\n+import static org.assertj.core.util.Arrays.isNullOrEmpty;\n+import static org.testng.Assert.assertFalse;\n+\n+public class TestJmxStats\n+{\n+    @Test\n+    public void testJmxStatsExposure()\n+            throws Exception\n+    {\n+        Plugin plugin = new JdbcPlugin(\"base-jdbc\", new TestingH2JdbcModule());\n+        ConnectorFactory factory = getOnlyElement(plugin.getConnectorFactories());\n+        factory.create(\"test\", ImmutableMap.of(\"connection-url\", \"jdbc\"), new TestingConnectorContext());\n+        MBeanServer mbeanServer = getPlatformMBeanServer();\n+        for (ObjectName objectName : mbeanServer.queryNames(new ObjectName(\"io.prestosql.plugin.jdbc:*\"), null)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "507c64cd605b9c1ccd69395fa69e1ce925be6ec9", "url": "https://github.com/trinodb/trino/commit/507c64cd605b9c1ccd69395fa69e1ce925be6ec9", "message": "Expose JdbcClient invocation statistics in JMX", "committedDate": "2020-04-28T09:37:05Z", "type": "commit"}, {"oid": "507c64cd605b9c1ccd69395fa69e1ce925be6ec9", "url": "https://github.com/trinodb/trino/commit/507c64cd605b9c1ccd69395fa69e1ce925be6ec9", "message": "Expose JdbcClient invocation statistics in JMX", "committedDate": "2020-04-28T09:37:05Z", "type": "forcePushed"}]}