{"pr_number": 5636, "pr_title": "Enforce hive.translate-hive-views propertry", "pr_createdAt": "2020-10-21T17:52:38Z", "pr_url": "https://github.com/trinodb/trino/pull/5636", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMjY5Ng==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509532696", "bodyText": "Can we please have some test for that?", "author": "kokosing", "createdAt": "2020-10-21T18:05:18Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -1856,6 +1856,10 @@ public void dropView(ConnectorSession session, SchemaTableName viewName)\n         return metastore.getTable(new HiveIdentity(session), viewName.getSchemaName(), viewName.getTableName())\n                 .filter(ViewReaderUtil::canDecodeView)\n                 .map(view -> {\n+                    if (!translateHiveViews && !isPrestoView(view)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwODIwMw==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509608203", "bodyText": "@kokosing since this is not a session property, I think it's currently hard to test in the product tests without adding a separate config file. But I'm not sure a different configuration is worth the overhead in product test framework.\nDo you have a suggestion on it? or should we add a session property instead?", "author": "phd3", "createdAt": "2020-10-21T19:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMjY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3MzY3MQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509673671", "bodyText": "Do we need product tests for that? If we could test it \"unit\" tests then it would be nice. I guess it might be possible to enhance file based metastore for that. WDYT?", "author": "kokosing", "createdAt": "2020-10-21T20:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMjY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg1NzIxNw==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509857217", "bodyText": "@kokosing added a test in AbstractTestHive, the test seems a bit hacky, since we need to create a table through the client (non-presto code path). But I think it should work for our purpose.", "author": "phd3", "createdAt": "2020-10-22T03:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMjY5Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk0NjQzNw==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509946437", "bodyText": "It would be nice add a test where changing config property would actually return a view here.\nWe have product tests for that, so if adding a test here is problematic then maybe a comment would be enough.", "author": "kokosing", "createdAt": "2020-10-22T07:43:06Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2556,6 +2557,38 @@ public void testViewCreation()\n         }\n     }\n \n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        String tableName = \"test_hive_view\";\n+        ConnectorSession session = newSession();\n+        Table table = Table.builder()\n+                .setDatabaseName(database)\n+                .setTableName(tableName)\n+                .setOwner(session.getUser())\n+                // Create a view without using PRESTO_VIEW_FLAG\n+                .setTableType(TableType.VIRTUAL_VIEW.name())\n+                .setDataColumns(ImmutableList.of(new Column(\"dummy\", HIVE_STRING, Optional.empty())))\n+                .setPartitionColumns(ImmutableList.of())\n+                .setViewOriginalText(Optional.of(\"SELECT 'a'\"))\n+                .withStorage(storage -> storage.setStorageFormat(VIEW_STORAGE_FORMAT)\n+                        .setLocation(\"\")\n+                        .build())\n+                .build();\n+\n+        metastoreClient.createTable(new HiveIdentity(session), table, testingPrincipalPrivilege(session));\n+\n+        try (Transaction transaction = newTransaction()) {\n+            ConnectorMetadata metadata = transaction.getMetadata();\n+            assertThatThrownBy(() -> metadata.getView(session, new SchemaTableName(database, tableName)))\n+                    .isInstanceOf(HiveViewNotSupportedException.class)\n+                    .hasMessageContaining(\"Hive views are not supported\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTY4OA==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510491688", "bodyText": "We shouldn't need any view specific logic in the metastore, as the metastore's job is to simply store/retrieve the table metadata. This specific check seems to be a sanity check that the file metastore doesn't contain a Hive view, but that should be impossible since the code is only used by Presto.", "author": "electrum", "createdAt": "2020-10-22T22:22:47Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -314,7 +316,15 @@ else if (table.getTableType().equals(EXTERNAL_TABLE.name())) {\n     @Override\n     public synchronized Optional<Table> getTable(HiveIdentity identity, String databaseName, String tableName)\n     {\n-        return getTable(databaseName, tableName);\n+        Optional<Table> optionalTable = getTable(databaseName, tableName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMTM3OQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510501379", "bodyText": "got it, agreed. ThriftHiveMetastore::getAllViews also involves usage of view specific config, may be we can move it out too in future.", "author": "phd3", "createdAt": "2020-10-22T22:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyNTMwOQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510525309", "bodyText": "You're right, it's always had logic to do filtering based on presto_view flag, but I forgot that it also has special logic based on whether or not we're translating Hive views. In that case, maybe it is required to add more logic to ThriftHiveMetastore. Though FileHiveMetastore doesn't have any today, so I'd need to be more convinced for that one.", "author": "electrum", "createdAt": "2020-10-23T00:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MjA0Mw==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510492043", "bodyText": "Similar to the other comment, this check should be done in HiveMetadata where the translation occurs.", "author": "electrum", "createdAt": "2020-10-22T22:23:53Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftHiveMetastore.java", "diffHunk": "@@ -343,6 +343,14 @@ public ThriftMetastoreStats getStats()\n                     .stopOnIllegalExceptions()\n                     .run(\"getTable\", stats.getGetTable().wrap(() -> {\n                         Table table = getTableFromMetastore(identity, databaseName, tableName);\n+\n+                        // Check if hive view is supported\n+                        if (!translateHiveViews", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NDM3OA==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510494378", "bodyText": "We shouldn't need to create a new Hive view here, as these tests already create presto_test_view (referenced by the view field in this class). It should be enough to call\nmetadata.getView(session, view);", "author": "electrum", "createdAt": "2020-10-22T22:30:08Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2556,6 +2557,40 @@ public void testViewCreation()\n         }\n     }\n \n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        String tableName = \"test_hive_view\";\n+        ConnectorSession session = newSession();\n+        Table table = Table.builder()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzNTA0OQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510535049", "bodyText": "as per @mosabua 's comment: #5623 (comment)", "author": "phd3", "createdAt": "2020-10-23T00:41:30Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -306,6 +306,8 @@ Property Name                                      Description\n ``hive.temporary-staging-directory-path``          Controls the location of temporary staging directory that    ``/tmp/${USER}``\n                                                    is used for write operations. The ``${USER}`` placeholder\n                                                    can be used to use a different location for each user.\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU1MzA4OQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510553089", "bodyText": "thx. looks good.", "author": "mosabua", "createdAt": "2020-10-23T02:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzNTA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkwODUwMA==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510908500", "bodyText": "Please capitalize Hive", "author": "electrum", "createdAt": "2020-10-23T14:06:16Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -306,6 +306,8 @@ Property Name                                      Description\n ``hive.temporary-staging-directory-path``          Controls the location of temporary staging directory that    ``/tmp/${USER}``\n                                                    is used for write operations. The ``${USER}`` placeholder\n                                                    can be used to use a different location for each user.\n+\n+``hive.translate-hive-views``                      Enable translation for hive views. (experimental)            ``false``", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxMTU2MQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510911561", "bodyText": "currently not possible ...\n\nthis is not true, it is possible (#5636 (comment))\nat most, we decided not to do this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // TODO: combine this with tests for successful translation in TestHiveViews product test, it is\n          \n          \n            \n                        // currently not possible because translation is not controlled by a session property\n          \n          \n            \n                        // TODO: combine this with tests for successful translation in TestHiveViews product test", "author": "findepi", "createdAt": "2020-10-23T14:10:55Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHive.java", "diffHunk": "@@ -80,4 +81,17 @@ public void testHideDeltaLakeTables()\n \n         throw new SkipException(\"not supported\");\n     }\n+\n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        try (Transaction transaction = newTransaction()) {\n+            assertThatThrownBy(() -> transaction.getMetadata().getView(newSession(), view))\n+                    .isInstanceOf(HiveViewNotSupportedException.class)\n+                    .hasMessageContaining(\"Hive views are not supported\");\n+\n+            // TODO: combine this with tests for successful translation in TestHiveViews product test, it is\n+            // currently not possible because translation is not controlled by a session property", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxNjc5NQ==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510916795", "bodyText": "@findepi does this looks better?\n// TODO: combine this with tests for successful view translation (currently in TestHiveViews product test)", "author": "phd3", "createdAt": "2020-10-23T14:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxMTU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxNzgwNw==", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510917807", "bodyText": "nice, thanks", "author": "findepi", "createdAt": "2020-10-23T14:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxMTU2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "7be6a0f7c12044bb7d74d6ed41faa143c3538214", "url": "https://github.com/trinodb/trino/commit/7be6a0f7c12044bb7d74d6ed41faa143c3538214", "message": "Enforce hive.translate-hive-views propertry", "committedDate": "2020-10-23T14:21:28Z", "type": "commit"}, {"oid": "20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "url": "https://github.com/trinodb/trino/commit/20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "message": "Add documentation for hive.translate-hive-views", "committedDate": "2020-10-23T14:22:34Z", "type": "commit"}, {"oid": "20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "url": "https://github.com/trinodb/trino/commit/20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "message": "Add documentation for hive.translate-hive-views", "committedDate": "2020-10-23T14:22:34Z", "type": "forcePushed"}]}