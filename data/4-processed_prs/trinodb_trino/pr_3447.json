{"pr_number": 3447, "pr_title": "Support composite publish_address in Elasticsearch", "pr_createdAt": "2020-04-16T07:18:04Z", "pr_url": "https://github.com/trinodb/trino/pull/3447", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDExMQ==", "url": "https://github.com/trinodb/trino/pull/3447#discussion_r410740111", "bodyText": "the ^ and $ are redundant", "author": "findepi", "createdAt": "2020-04-18T19:24:39Z", "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -108,6 +111,8 @@\n     private static final JsonCodec<NodesResponse> NODES_RESPONSE_CODEC = jsonCodec(NodesResponse.class);\n     private static final ObjectMapper OBJECT_MAPPER = new ObjectMapperProvider().get();\n \n+    private static final Pattern ADDRESS_PATTERN = Pattern.compile(\"^((?<cname>[^/]+)/)?(?<ip>.+):(?<port>\\\\d+)$\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDI3MA==", "url": "https://github.com/trinodb/trino/pull/3447#discussion_r410740270", "bodyText": "previously if the address was eg <ip> (no port), it would still be accepted\ni understand this is conscious not to accept it (perhaps impossible), but could be good to mention in cmt msg, or even splits commits into\n\nvalidate address pattern\nadd support for hostname/", "author": "findepi", "createdAt": "2020-04-18T19:26:22Z", "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -657,6 +665,26 @@ public TimeStat getNextPageStats()\n         return handler.process(body);\n     }\n \n+    @VisibleForTesting\n+    static Optional<String> extractAddress(String address)\n+    {\n+        Matcher matcher = ADDRESS_PATTERN.matcher(address);\n+\n+        if (!matcher.matches()) {\n+            return Optional.empty();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc4OTc3Ng==", "url": "https://github.com/trinodb/trino/pull/3447#discussion_r410789776", "bodyText": "Correct. It was accepted but it never happened in practice, as ES doesn't produce that kind of value.\nI'll add a comment in the commit message. I think splitting it is overkill, as I'd be just adding a commit and erase its effect on the next one.", "author": "martint", "createdAt": "2020-04-19T01:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDI3MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "e69fa6bd72e63d1019fb59a3121170b41c889403", "url": "https://github.com/trinodb/trino/commit/e69fa6bd72e63d1019fb59a3121170b41c889403", "message": "Support composite publish_address in Elasticsearch\n\nStarting with version 7.x, the publish_address field can contain\naddresses of the following form:\n\n    cname/ip:port\n    ip:port\n\nIf the CNAME is present, the connector will now use the CNAME and port.\nOtherwise, it will use the IP and port.\n\nThis change also validates that the address matches one of the above formats.", "committedDate": "2020-04-20T19:31:44Z", "type": "commit"}, {"oid": "e69fa6bd72e63d1019fb59a3121170b41c889403", "url": "https://github.com/trinodb/trino/commit/e69fa6bd72e63d1019fb59a3121170b41c889403", "message": "Support composite publish_address in Elasticsearch\n\nStarting with version 7.x, the publish_address field can contain\naddresses of the following form:\n\n    cname/ip:port\n    ip:port\n\nIf the CNAME is present, the connector will now use the CNAME and port.\nOtherwise, it will use the IP and port.\n\nThis change also validates that the address matches one of the above formats.", "committedDate": "2020-04-20T19:31:44Z", "type": "forcePushed"}]}