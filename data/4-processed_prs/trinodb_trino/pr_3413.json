{"pr_number": 3413, "pr_title": "Optimize TupleDomain.columnWiseUnion during dynamic filtering partition collection", "pr_createdAt": "2020-04-11T11:07:28Z", "pr_url": "https://github.com/trinodb/trino/pull/3413", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NzM3Mw==", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407747373", "bodyText": "This verify can never fail as there is no way to enter this if block multiple times.", "author": "martint", "createdAt": "2020-04-13T22:03:15Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -72,21 +73,21 @@ public LocalDynamicFilter(Multimap<String, Symbol> probeSymbols, Map<String, Int\n \n         this.resultFuture = SettableFuture.create();\n \n-        this.result = TupleDomain.none();\n-        this.partitionsLeft = partitionCount;\n+        this.partitionCount = partitionCount;\n+        this.partitions = new ArrayList<>(partitionCount);\n     }\n \n     private synchronized void addPartition(TupleDomain<String> tupleDomain)\n     {\n         // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        partitionsLeft -= 1;\n-        verify(partitionsLeft >= 0);\n+        verify(partitions.size() < partitionCount);\n         // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n         // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        result = TupleDomain.columnWiseUnion(result, tupleDomain);\n-        if (partitionsLeft == 0) {\n+        partitions.add(tupleDomain);\n+        if (partitions.size() == partitionCount) {\n+            Map<Symbol, Domain> result = convertTupleDomain(TupleDomain.columnWiseUnion(partitions));\n             // No more partitions are left to be processed.\n-            verify(resultFuture.set(convertTupleDomain(result)), \"dynamic filter result is provided more than once\");\n+            verify(resultFuture.set(result), \"dynamic filter result is provided more than once\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg3MjEzOQ==", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407872139", "bodyText": "Thanks, fixed in d7f7cdd.", "author": "rzeyde-varada", "createdAt": "2020-04-14T05:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NzM3Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MTQ4Mg==", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407981482", "bodyText": "make this final", "author": "sopel39", "createdAt": "2020-04-14T09:06:52Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -57,11 +58,11 @@\n \n     private final SettableFuture<Map<Symbol, Domain>> resultFuture;\n \n-    // The resulting predicate for local dynamic filtering.\n-    private TupleDomain<String> result;\n+    // Number of build-side partitions to be collected.\n+    private final int partitionCount;\n \n-    // Number of partitions left to be processed.\n-    private int partitionsLeft;\n+    // The resulting predicates from each build-side partition.\n+    private List<TupleDomain<String>> partitions;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MzUxMQ==", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r408193511", "bodyText": "Thanks, fixed in 5895edc.", "author": "rzeyde-varada", "createdAt": "2020-04-14T14:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MTQ4Mg=="}], "type": "inlineReview"}, {"oid": "5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "url": "https://github.com/trinodb/trino/commit/5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "message": "Optimize TupleDomain#columnWiseUnion during dynamic filtering collection", "committedDate": "2020-04-14T14:43:49Z", "type": "commit"}, {"oid": "5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "url": "https://github.com/trinodb/trino/commit/5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "message": "Optimize TupleDomain#columnWiseUnion during dynamic filtering collection", "committedDate": "2020-04-14T14:43:49Z", "type": "forcePushed"}]}