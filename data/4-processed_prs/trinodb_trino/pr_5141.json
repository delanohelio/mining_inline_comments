{"pr_number": 5141, "pr_title": "Cleanup join distribution code", "pr_createdAt": "2020-09-11T15:32:09Z", "pr_url": "https://github.com/trinodb/trino/pull/5141", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzMxNg==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488517316", "bodyText": "these are utilities, move them below where they are used", "author": "findepi", "createdAt": "2020-09-15T09:22:02Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/DetermineJoinDistributionType.java", "diffHunk": "@@ -91,22 +98,87 @@ public static boolean canReplicate(JoinNode joinNode, Context context)\n         return buildSideSizeInBytes <= joinMaxBroadcastTableSize.toBytes();\n     }\n \n+    public static double getSourceTablesSizeInBytes(PlanNode node, Context context)\n+    {\n+        return getSourceTablesSizeInBytes(node, context.getLookup(), context.getStatsProvider(), context.getSymbolAllocator().getTypes());\n+    }\n+\n+    @VisibleForTesting\n+    static double getSourceTablesSizeInBytes(PlanNode node, Lookup lookup, StatsProvider statsProvider, TypeProvider typeProvider)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0NTYzMw==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488645633", "bodyText": "this is below other utility methods. Let's create another PR/commit to move them", "author": "sopel39", "createdAt": "2020-09-15T12:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI5MTE5OQ==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r489291199", "bodyText": "The is one uitility above this one (canReplicate) and more utilities below, so i am not quite convinced. Up to you", "author": "findepi", "createdAt": "2020-09-16T09:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMDI3Ng==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488520276", "bodyText": "containsReplicatedJoin seems straighforward, based on addJoinsWithDifferentDistributions -- there is no cost decision yet.\ni am concerned we exit too early here.\nWould it be sufficient to add this to if (possibleJoinNodes.stream().anyMatch(result -> result.getCost().hasUnknownComponents()) || possibleJoinNodes.isEmpty()) branch below?", "author": "findepi", "createdAt": "2020-09-15T09:26:37Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/DetermineJoinDistributionType.java", "diffHunk": "@@ -91,22 +98,87 @@ public static boolean canReplicate(JoinNode joinNode, Context context)\n         return buildSideSizeInBytes <= joinMaxBroadcastTableSize.toBytes();\n     }\n \n+    public static double getSourceTablesSizeInBytes(PlanNode node, Context context)\n+    {\n+        return getSourceTablesSizeInBytes(node, context.getLookup(), context.getStatsProvider(), context.getSymbolAllocator().getTypes());\n+    }\n+\n+    @VisibleForTesting\n+    static double getSourceTablesSizeInBytes(PlanNode node, Lookup lookup, StatsProvider statsProvider, TypeProvider typeProvider)\n+    {\n+        boolean hasExpandingNodes = PlanNodeSearcher.searchFrom(node, lookup)\n+                .where(isInstanceOfAny(JoinNode.class))\n+                .matches();\n+        if (hasExpandingNodes) {\n+            return Double.NaN;\n+        }\n+\n+        List<PlanNode> sourceNodes = PlanNodeSearcher.searchFrom(node, lookup)\n+                .where(isInstanceOfAny(TableScanNode.class, ValuesNode.class))\n+                .findAll();\n+\n+        return sourceNodes.stream()\n+                .mapToDouble(sourceNode -> statsProvider.getStats(sourceNode).getOutputSizeInBytes(sourceNode.getOutputSymbols(), typeProvider))\n+                .sum();\n+    }\n+\n     private PlanNode getCostBasedJoin(JoinNode joinNode, Context context)\n     {\n         List<PlanNodeWithCost> possibleJoinNodes = new ArrayList<>();\n \n         addJoinsWithDifferentDistributions(joinNode, possibleJoinNodes, context);\n         addJoinsWithDifferentDistributions(joinNode.flipChildren(), possibleJoinNodes, context);\n+        boolean containsReplicatedJoin = possibleJoinNodes.stream()\n+                .map(PlanNodeWithCost::getPlanNode)\n+                .map(JoinNode.class::cast)\n+                .anyMatch(node -> node.getDistributionType().equals(Optional.of(REPLICATED)));\n+\n+        JoinNode sizedBasedJoin = getSizeBasedJoin(joinNode, context);\n+        if (!containsReplicatedJoin && sizedBasedJoin.getDistributionType().equals(Optional.of(REPLICATED))) {\n+            // choose replicated size based join if stats calculator would skip replicated join altogether\n+            // (because of inaccurate or missing intermediate plan node stats)\n+            return sizedBasedJoin;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0MTg5NA==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488641894", "bodyText": "Would it be sufficient to add this to if (possibleJoinNodes.stream().anyMatch(result -> result.getCost().hasUnknownComponents()) || possibleJoinNodes.isEmpty()) branch below?\n\nIn such case CBO might not take replicated join into account at all (due to inaccurate stats since we know source tables are small) and would choose partitioned join. This if is to prevent such case and choose replicated instead.", "author": "sopel39", "createdAt": "2020-09-15T12:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMDkwOA==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488520908", "bodyText": "Add a test when one side eg UNION or UNION ALL of something", "author": "findepi", "createdAt": "2020-09-15T09:27:34Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/DetermineJoinDistributionType.java", "diffHunk": "@@ -91,22 +98,87 @@ public static boolean canReplicate(JoinNode joinNode, Context context)\n         return buildSideSizeInBytes <= joinMaxBroadcastTableSize.toBytes();\n     }\n \n+    public static double getSourceTablesSizeInBytes(PlanNode node, Context context)\n+    {\n+        return getSourceTablesSizeInBytes(node, context.getLookup(), context.getStatsProvider(), context.getSymbolAllocator().getTypes());\n+    }\n+\n+    @VisibleForTesting\n+    static double getSourceTablesSizeInBytes(PlanNode node, Lookup lookup, StatsProvider statsProvider, TypeProvider typeProvider)\n+    {\n+        boolean hasExpandingNodes = PlanNodeSearcher.searchFrom(node, lookup)\n+                .where(isInstanceOfAny(JoinNode.class))\n+                .matches();\n+        if (hasExpandingNodes) {\n+            return Double.NaN;\n+        }\n+\n+        List<PlanNode> sourceNodes = PlanNodeSearcher.searchFrom(node, lookup)\n+                .where(isInstanceOfAny(TableScanNode.class, ValuesNode.class))\n+                .findAll();\n+\n+        return sourceNodes.stream()\n+                .mapToDouble(sourceNode -> statsProvider.getStats(sourceNode).getOutputSizeInBytes(sourceNode.getOutputSymbols(), typeProvider))\n+                .sum();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYzOTA1NA==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488639054", "bodyText": "There is such test, see TestDetermineJoinDistributionType#testGetSourceTablesSizeInBytes", "author": "sopel39", "createdAt": "2020-09-15T12:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMDkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMTU1OQ==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488521559", "bodyText": "Add \"integration\" test to TestLogicalPlanner as well.", "author": "findepi", "createdAt": "2020-09-15T09:28:32Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestDetermineJoinDistributionType.java", "diffHunk": "@@ -643,6 +655,185 @@ public void testReplicatesWhenNotRestricted()\n                         values(ImmutableMap.of(\"B1\", 0))));\n     }\n \n+    @Test\n+    public void testReplicatesWhenSourceIsSmall()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMTgxMQ==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488521811", "bodyText": "is there such a constant?", "author": "findepi", "createdAt": "2020-09-15T09:28:57Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestDetermineJoinDistributionType.java", "diffHunk": "@@ -643,6 +655,185 @@ public void testReplicatesWhenNotRestricted()\n                         values(ImmutableMap.of(\"B1\", 0))));\n     }\n \n+    @Test\n+    public void testReplicatesWhenSourceIsSmall()\n+    {\n+        VarcharType symbolType = createUnboundedVarcharType(); // variable width so that average row size is respected\n+        int aRows = 10_000;\n+        int bRows = 10;\n+\n+        // output size exceeds AUTOMATIC_RESTRICTED limit", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0NjQ4Ng==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r488646486", "bodyText": "no there isn't, but AUTOMATIC_RESTRICTED is used in other tests too. Let's make this cleanup a follow-up PR.", "author": "sopel39", "createdAt": "2020-09-15T13:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyMTgxMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MTE5Mg==", "url": "https://github.com/trinodb/trino/pull/5141#discussion_r489691192", "bodyText": "what will happen if we add stats for that schema?\n(using \"sf42.5\".orders could buy you a bit more of safety)", "author": "findepi", "createdAt": "2020-09-16T19:14:06Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1473,11 +1474,71 @@ public void testGroupingSetsWithDefaultValue()\n                                                                                 tableScan(\"orders\"))))))))));\n     }\n \n+    @Test\n+    public void testSizeBasedJoin()\n+    {\n+        // both local.sf100000.nation and local.sf100000.orders don't provide stats, therefore no reordering happens\n+        assertDistributedPlan(\"SELECT custkey FROM local.sf100000.nation, local.sf100000.orders WHERE nation.nationkey = orders.custkey\",\n+                automaticJoinDistribution(),\n+                output(\n+                        anyTree(\n+                                join(INNER, ImmutableList.of(equiJoinClause(\"NATIONKEY\", \"CUSTKEY\")),\n+                                        anyTree(\n+                                                tableScan(\"nation\", ImmutableMap.of(\"NATIONKEY\", \"nationkey\"))),\n+                                        anyTree(\n+                                                tableScan(\"orders\", ImmutableMap.of(\"CUSTKEY\", \"custkey\")))))));\n+\n+        // values node provides stats\n+        assertDistributedPlan(\"SELECT custkey FROM (VALUES CAST(1 AS BIGINT), CAST(2 AS BIGINT)) t(a), local.sf100000.orders WHERE t.a = orders.custkey\",\n+                automaticJoinDistribution(),\n+                output(\n+                        anyTree(\n+                                join(INNER, ImmutableList.of(equiJoinClause(\"CUSTKEY\", \"T_A\")), Optional.empty(), Optional.of(REPLICATED),\n+                                        anyTree(\n+                                                tableScan(\"orders\", ImmutableMap.of(\"CUSTKEY\", \"custkey\"))),\n+                                        anyTree(\n+                                                values(\"T_A\"))))));\n+    }\n+\n+    @Test\n+    public void testSizeBasedSemiJoin()\n+    {\n+        // both local.sf100000.nation and local.sf100000.orders don't provide stats, therefore no reordering happens", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f788ff13b5f6e9d0c34d329fac6b1ddc40c7b6b5", "url": "https://github.com/trinodb/trino/commit/f788ff13b5f6e9d0c34d329fac6b1ddc40c7b6b5", "message": "Choose join side with small tables as build side\n\nChoose join side with small tables as build (and\nreplicated if possible) side when CBO fails to\ndetermine join distribution type.", "committedDate": "2020-09-17T10:38:43Z", "type": "commit"}, {"oid": "f788ff13b5f6e9d0c34d329fac6b1ddc40c7b6b5", "url": "https://github.com/trinodb/trino/commit/f788ff13b5f6e9d0c34d329fac6b1ddc40c7b6b5", "message": "Choose join side with small tables as build side\n\nChoose join side with small tables as build (and\nreplicated if possible) side when CBO fails to\ndetermine join distribution type.", "committedDate": "2020-09-17T10:38:43Z", "type": "forcePushed"}]}