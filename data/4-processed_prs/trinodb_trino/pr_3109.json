{"pr_number": 3109, "pr_title": "Support arbitrary query in SHOW STATS", "pr_createdAt": "2020-03-16T13:26:20Z", "pr_url": "https://github.com/trinodb/trino/pull/3109", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0NjkxNw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r394246917", "bodyText": "unused?\notherwise fmt", "author": "findepi", "createdAt": "2020-03-18T10:32:25Z", "path": "presto-main/src/main/java/io/prestosql/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -147,7 +148,7 @@ public Statement rewrite(\n             List<Expression> parameters,\n             Map<NodeRef<Parameter>, Expression> parameterLookup,\n             AccessControl accessControl,\n-            WarningCollector warningCollector)\n+            WarningCollector warningCollector, StatsCalculator statsCalculator)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgwMDk3NQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r479800975", "bodyText": "Now it matches io.prestosql.cost.SymbolStatsEstimate#ZERO", "author": "kokosing", "createdAt": "2020-08-30T18:27:18Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -74,10 +73,10 @@ public void testShowStats()\n \n         assertQuery(\"SHOW STATS FOR (SELECT * FROM nation_partitioned WHERE regionkey IS NULL)\",\n                 \"SELECT * FROM (VALUES \" +\n-                        \"   ('regionkey', null, 0.0, 0.0, null, null, null), \" +\n-                        \"   ('nationkey', null, 0.0, 0.0, null, null, null), \" +\n-                        \"   ('name', 0.0, 0.0, 0.0, null, null, null), \" +\n-                        \"   ('comment', 0.0, 0.0, 0.0, null, null, null), \" +\n+                        \"   ('regionkey', 0.0, 0.0, 1.0, null, null, null), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDE3Nw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r524964177", "bodyText": "Original error message was more accurate", "author": "losipiuk", "createdAt": "2020-11-17T08:22:58Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -1807,15 +1807,15 @@ public void testAccessControl()\n         assertAccessAllowed(\"SHOW STATS FOR lineitem\", privilege(\"orders\", SELECT_COLUMN));\n         assertAccessAllowed(\"SHOW STATS FOR (SELECT * FROM lineitem)\");\n         assertAccessAllowed(\"SHOW STATS FOR (SELECT * FROM lineitem)\", privilege(\"orders\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT * FROM nation)\", \"Cannot show stats for columns \\\\[nationkey, regionkey, name, comment\\\\] in table or view .*.nation\", privilege(\"nation\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT nationkey FROM nation)\", \"Cannot show stats for columns \\\\[nationkey\\\\] in table or view .*.nation\", privilege(\"nation\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT nationkey FROM nation)\", \"Cannot show stats for columns \\\\[nationkey\\\\] in table or view .*.nation\", privilege(\"nation.nationkey\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT *, nationkey FROM nation)\", \"Cannot show stats for columns \\\\[nationkey, regionkey, name, comment\\\\] in table or view .*.nation\", privilege(\"nation.nationkey\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT *, * FROM nation)\", \"Cannot show stats for columns \\\\[nationkey, regionkey, name, comment\\\\] in table or view .*.nation\", privilege(\"nation.nationkey\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT linenumber, orderkey FROM lineitem)\", \"Cannot show stats for columns \\\\[linenumber, orderkey\\\\] in table or view .*.lineitem.*\", privilege(\"lineitem\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT linenumber, orderkey, quantity FROM lineitem)\", \"Cannot show stats for columns \\\\[linenumber, orderkey, quantity\\\\] in table or view .*.lineitem.*\", privilege(\"lineitem.linenumber\", SELECT_COLUMN), privilege(\"lineitem.orderkey\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT nationkey FROM nation)\", \"Cannot show stats for columns \\\\[nationkey\\\\] in table or view .*.nation.*\", privilege(\"nation\", SELECT_COLUMN));\n-        assertAccessDenied(\"SHOW STATS FOR (SELECT * FROM nation)\", \"Cannot show stats for columns \\\\[nationkey, regionkey, name, comment\\\\] in table or view .*.nation.*\", privilege(\"nation\", SELECT_COLUMN));\n+        assertAccessDenied(\"SHOW STATS FOR (SELECT * FROM nation)\", \"Cannot select from columns \\\\[nationkey, regionkey, name, comment\\\\] in table or view .*.nation\", privilege(\"nation\", SELECT_COLUMN));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NzQ3Nw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r525057477", "bodyText": "Yes, the original was a wrapping one, that goes to the same bucket as: #5379 (comment)\nShould I extract that change to separate commit?", "author": "kokosing", "createdAt": "2020-11-17T10:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2MzEzNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r528563136", "bodyText": "Naa - if that is the way to go I do not care about extracting as separate commit.", "author": "losipiuk", "createdAt": "2020-11-23T09:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIzNDExMA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r532234110", "bodyText": "i raised similar problem over here #3109 (comment).\nI am not convinced by the linked comment.\nEspecially for case SHOW STATS FOR table_name it seems a bit weird to throw \"Cannot select from columns ...\".", "author": "findepi", "createdAt": "2020-11-29T16:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI1MTgzNw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r532251837", "bodyText": "This is like CALL create_empty_partitions(...) that throws \"Cannot insert into...\".\nIt is not about being not allowed to call CALL create_empty_partitions() or SHOW STATS FOR x but not being able to create new partition (and so doing an insert) or not being able to see table data (and so doing a select). So this is more detailed. Also it is more actionable, as now you know that you need to GRANT INSERT or GRANT SELECT, while there is no GRANT CALL or GRANT SHOW STATS.\nSurely this is one way of thinking. I was thinking differently here: #5379 (comment). Since after few iterations #5379 changed, I decided to change this pull request into the same direction to be coherent.", "author": "kokosing", "createdAt": "2020-11-29T19:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDE3Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5NzEwNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r528597106", "bodyText": "columnSizeForFormat is left unused", "author": "findepi", "createdAt": "2020-11-23T10:19:27Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/AbstractTestIcebergSmoke.java", "diffHunk": "@@ -1021,7 +1021,7 @@ public void testBasicTableStatistics()\n         MaterializedResult result = computeActual(\"SHOW STATS FOR \" + tableName);\n         MaterializedResult expectedStatistics =\n                 resultBuilder(getSession(), VARCHAR, DOUBLE, DOUBLE, DOUBLE, DOUBLE, VARCHAR, VARCHAR)\n-                        .row(\"col\", columnSizeForFormat(96.0), null, 0.0, null, \"-10.0\", \"100.0\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5NzcyMw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r528597723", "bodyText": "It's weird that Analyzer needs a stats calculator. In any case, why not provide a NOOP here?", "author": "findepi", "createdAt": "2020-11-23T10:20:24Z", "path": "presto-main/src/main/java/io/prestosql/execution/CreateMaterializedViewTask.java", "diffHunk": "@@ -86,7 +89,7 @@ public String explain(CreateMaterializedView statement, List<Expression> paramet\n \n         String sql = getFormattedSql(statement.getQuery(), sqlParser);\n \n-        Analysis analysis = new Analyzer(session, metadata, sqlParser, groupProvider, accessControl, Optional.empty(), parameters, parameterLookup, stateMachine.getWarningCollector())\n+        Analysis analysis = new Analyzer(session, metadata, sqlParser, groupProvider, accessControl, Optional.empty(), parameters, parameterLookup, stateMachine.getWarningCollector(), statsCalculator)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5ODIxMg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r528598212", "bodyText": "rnn\nmore importantly though -- it's counter intuitive why Analyzer needs stats calculator. It seems analysis result doesn't depend on stats (the plan does). I see this is needed to pass to ShowStatsRewrite. Maybe we can inject it there at creation?", "author": "findepi", "createdAt": "2020-11-23T10:21:16Z", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analyzer.java", "diffHunk": "@@ -72,6 +75,7 @@ public Analyzer(\n         this.parameters = parameters;\n         this.parameterLookup = parameterLookup;\n         this.warningCollector = requireNonNull(warningCollector, \"warningCollector is null\");\n+        this.statsCalculator = statsCalculator;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzNzYxMw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r529537613", "bodyText": "Analyzer is created on demand, most of it dependencies are session bound. Only statsCalculator is bound in guice. I can do what you suggest, but then I would need to pass StatementRewrite as parameter of Analyzer constructor. I can also extract AnalyzerFactory. Both options sounds to me like an overkill. WDYT?", "author": "kokosing", "createdAt": "2020-11-24T13:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5ODIxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNDI3OA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r529934278", "bodyText": "right. nvrm", "author": "findepi", "createdAt": "2020-11-24T22:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU5ODIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMTUzNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r528601536", "bodyText": "getRelation creates artificial query (simpleQuery(selectList(new AllColumns()), node.getRelation())), which we here analyze and plan. This can lead to eg AccessDeniedException referencing ... things user did not write. Previously we would post-process this with rewriteAccessDeniedException. Why is this not needed anymore?", "author": "findepi", "createdAt": "2020-11-23T10:26:57Z", "path": "presto-main/src/main/java/io/prestosql/sql/rewrite/ShowStatsRewrite.java", "diffHunk": "@@ -109,80 +94,44 @@ public Statement rewrite(\n             Map<NodeRef<Parameter>, Expression> parameterLookup,\n             GroupProvider groupProvider,\n             AccessControl accessControl,\n-            WarningCollector warningCollector)\n+            WarningCollector warningCollector,\n+            StatsCalculator statsCalculator)\n     {\n-        return (Statement) new Visitor(metadata, session, parameters, queryExplainer, accessControl, warningCollector).process(node, null);\n+        return (Statement) new Visitor(session, parameters, queryExplainer, warningCollector, statsCalculator).process(node, null);\n     }\n \n     private static class Visitor\n             extends AstVisitor<Node, Void>\n     {\n-        private final Metadata metadata;\n         private final Session session;\n         private final List<Expression> parameters;\n         private final Optional<QueryExplainer> queryExplainer;\n-        private final AccessControl accessControl;\n         private final WarningCollector warningCollector;\n+        private final StatsCalculator statsCalculator;\n \n-        private Visitor(Metadata metadata, Session session, List<Expression> parameters, Optional<QueryExplainer> queryExplainer, AccessControl accessControl, WarningCollector warningCollector)\n+        private Visitor(Session session, List<Expression> parameters, Optional<QueryExplainer> queryExplainer, WarningCollector warningCollector, StatsCalculator statsCalculator)\n         {\n-            this.metadata = requireNonNull(metadata, \"metadata is null\");\n             this.session = requireNonNull(session, \"session is null\");\n             this.parameters = requireNonNull(parameters, \"parameters is null\");\n             this.queryExplainer = requireNonNull(queryExplainer, \"queryExplainer is null\");\n-            this.accessControl = requireNonNull(accessControl, \"accessControl is null\");\n             this.warningCollector = requireNonNull(warningCollector, \"warningCollector is null\");\n+            this.statsCalculator = requireNonNull(statsCalculator, \"statsCalculator is null\");\n         }\n \n         @Override\n         protected Node visitShowStats(ShowStats node, Void context)\n         {\n             checkState(queryExplainer.isPresent(), \"Query explainer must be provided for SHOW STATS SELECT\");\n \n-            Query query = getRelationQuery(node);\n+            Query query = getRelation(node);\n             QuerySpecification specification = (QuerySpecification) query.getQueryBody();\n-\n-            Plan plan;\n-\n-            try {\n-                plan = queryExplainer.get().getLogicalPlan(session, query(specification), parameters, warningCollector);\n-            }\n-            catch (AccessDeniedException e) {\n-                throw rewriteAccessDeniedException(e);\n-            }\n-\n-            Table table = getTable(node, specification);\n-            QualifiedObjectName tableName = createQualifiedObjectName(session, node, table.getName());\n-            TableHandle tableHandle = metadata.getTableHandle(session, tableName)\n-                    .orElseThrow(() -> semanticException(TABLE_NOT_FOUND, node, \"Table '%s' not found\", table.getName()));\n-            TableMetadata tableMetadata = metadata.getTableMetadata(session, tableHandle);\n-            Map<String, ColumnHandle> columnHandles = metadata.getColumnHandles(session, tableHandle);\n-            Set<String> columnNames = extractStatsColumns(tableMetadata, specification.getSelect().getSelectItems());\n-\n-            try {\n-                accessControl.checkCanSelectFromColumns(session.toSecurityContext(), tableName, columnNames);\n-            }\n-            catch (AccessDeniedException e) {\n-                throw rewriteAccessDeniedException(e);\n-            }\n-\n-            for (String columnName : columnNames) {\n-                ColumnMetadata column = tableMetadata.getColumn(columnName);\n-                if (!accessControl.getColumnMasks(session.toSecurityContext(), tableName, columnName, column.getType()).isEmpty()) {\n-                    throw new PrestoException(NOT_SUPPORTED, \"SHOW STATS for table with column masking is not supported: \" + columnName);\n-                }\n-            }\n-            if (!accessControl.getRowFilters(session.toSecurityContext(), tableName).isEmpty()) {\n-                // SHOW STATS could reveal min, max value which would be otherwise filtered out; or could reveal statistical properties of the data, like row count\n-                throw new PrestoException(NOT_SUPPORTED, \"SHOW STATS is not supported for a table with row filtering\");\n-            }\n-\n-            validateShowStatsSubquery(node, query, specification, plan);\n-\n-            return rewriteShowStats(table, tableHandle, tableMetadata, columnNames, columnHandles, getConstraint(plan));\n+            Plan plan = queryExplainer.get().getLogicalPlan(session, query(specification), parameters, warningCollector);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIxOTY1Ng==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r531219656", "bodyText": "@findepi Please see #3109 (comment)", "author": "kokosing", "createdAt": "2020-11-26T20:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMTUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIzNDI0Ng==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r532234246", "bodyText": "Thanks, let's talk about messages in #3109 (comment)\neven if message is perfect, we should make sure we don't let some artificial node location to go through. But perhaps you do not create any artificial node locations, so this isn't a problem?", "author": "findepi", "createdAt": "2020-11-29T16:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMTUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI1MDg4OQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r532250889", "bodyText": "artificial node location\n\nArtificial nodes do not get any location, so it should not be a problem.", "author": "kokosing", "createdAt": "2020-11-29T18:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMTUzNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNzQ2Mg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r535507462", "bodyText": "Why there is a change here?", "author": "findepi", "createdAt": "2020-12-03T19:10:39Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -5877,21 +5877,21 @@ public void testCollectColumnStatisticsOnCreateTable()\n                         \"('c_bigint', null, 2.0E0, 0.5E0, null, '1', '2'), \" +\n                         \"('c_double', null, 2.0E0, 0.5E0, null, '2.3', '3.3'), \" +\n                         \"('c_timestamp', null, 2.0E0, 0.5E0, null, null, null), \" +\n-                        \"('c_varchar', 8.0E0, 2.0E0, 0.5E0, null, null, null), \" +\n-                        \"('c_varbinary', 8.0E0, null, 0.5E0, null, null, null), \" +\n+                        \"('c_varchar', 16.0E0, 2.0E0, 0.5E0, null, null, null), \" +\n+                        \"('c_varbinary', 16.0E0, null, 0.5E0, null, null, null), \" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3MzQ3OQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r535573479", "bodyText": "I don't know. I guess it is related to stats normalization.", "author": "kokosing", "createdAt": "2020-12-03T20:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3MzYyNw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r535573627", "bodyText": "Will check it.", "author": "kokosing", "createdAt": "2020-12-03T20:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2NDU2OA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r537564568", "bodyText": "I investigated this. It was because I haven't used non null values fraction when counting column data size. Fixed. Thanks!", "author": "kokosing", "createdAt": "2020-12-07T14:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNzQ2Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNTQ2Mw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r537835463", "bodyText": "there is a bunch of redudant changes: 0e0 -> 0\nthere are also some meaningful changes:\n\n0e0 -> 1\nnull -> 0\n\nideally let's avoid unnnecessary changes within the \"logic change\" commit\nmore importantly -- why the meaningful changes?", "author": "findepi", "createdAt": "2020-12-07T21:11:07Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -5885,13 +5885,13 @@ public void testCollectColumnStatisticsOnCreateTable()\n         // non existing partition\n         assertQuery(format(\"SHOW STATS FOR (SELECT * FROM %s WHERE p_varchar = 'p3')\", tableName),\n                 \"SELECT * FROM VALUES \" +\n-                        \"('c_boolean', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_bigint', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_double', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_timestamp', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_varchar', 0E0, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_varbinary', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('p_varchar', 0E0, 0E0, 0E0, null, null, null), \" +\n+                        \"('c_boolean', 0, 0, 1, null, null, null), \" +\n+                        \"('c_bigint', 0, 0, 1, null, null, null), \" +\n+                        \"('c_double', 0, 0, 1, null, null, null), \" +\n+                        \"('c_timestamp', 0, 0, 1, null, null, null), \" +\n+                        \"('c_varchar', 0, 0, 1, null, null, null), \" +\n+                        \"('c_varbinary', 0, 0, 1, null, null, null), \" +\n+                        \"('p_varchar', 0, 0, 1, null, null, null), \" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NjE4Mg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r537846182", "bodyText": "I am going to extract redundant changes to separate commit.\nMeaningful changes are after stats normalization, when there is no rows, then we also know how much nulls, ndv or data size is there.", "author": "kokosing", "createdAt": "2020-12-07T21:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEzNTAwMw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r538135003", "bodyText": "WRT meaningful changes. Notice it is not the only thing. For example when min and max are equal, then ndv will be equal to 1.", "author": "kokosing", "createdAt": "2020-12-08T08:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNTQ2Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1ODYwNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r539658606", "bodyText": "You changed semantics here.\nIt used to be array of doubles, now it's array of decimal(2,1)\nSame in some other places.\nCan we drop this commit in order to expedite the merge of the important part of this PR?", "author": "findepi", "createdAt": "2020-12-09T21:24:19Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -3376,12 +3376,12 @@ private void testRowsWithNulls(Session session, HiveStorageFormat format)\n     public void testComplex()\n     {\n         assertUpdate(\"CREATE TABLE tmp_complex1 AS SELECT \" +\n-                        \"ARRAY [MAP(ARRAY['a', 'b'], ARRAY[2.0E0, 4.0E0]), MAP(ARRAY['c', 'd'], ARRAY[12.0E0, 14.0E0])] AS a\",\n+                        \"ARRAY [MAP(ARRAY['a', 'b'], ARRAY[2, 4.0]), MAP(ARRAY['c', 'd'], ARRAY[12, 14.0])] AS a\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyODE1Mg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540128152", "bodyText": "I dropped this commit. Thanks", "author": "kokosing", "createdAt": "2020-12-10T12:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1ODYwNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyNTEwNw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540825107", "bodyText": "Please add a comment to the cmt message than now null fraction is normalized to 1 for tables with row count 0, regardless of what the stats returned by the connector.\nSame for data size being normalized to 0 for all-null columns (regardless of table row count).\nThis may help in the future, when someone questions why the expected values changed in this commit.", "author": "findepi", "createdAt": "2020-12-11T09:54:39Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -5885,14 +5885,14 @@ public void testCollectColumnStatisticsOnCreateTable()\n         // non existing partition\n         assertQuery(format(\"SHOW STATS FOR (SELECT * FROM %s WHERE p_varchar = 'p3')\", tableName),\n                 \"SELECT * FROM VALUES \" +\n-                        \"('c_boolean', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_bigint', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_double', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_timestamp', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_varchar', 0E0, 0E0, 0E0, null, null, null), \" +\n-                        \"('c_varbinary', null, 0E0, 0E0, null, null, null), \" +\n-                        \"('p_varchar', 0E0, 0E0, 0E0, null, null, null), \" +\n-                        \"(null, null, null, null, 0E0, null, null)\");\n+                        \"('c_boolean', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('c_bigint', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('c_double', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('c_timestamp', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('c_varchar', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('c_varbinary', 0.0, 0.0, 1.0, null, null, null), \" +\n+                        \"('p_varchar', 0.0, 0.0, 1.0, null, null, null), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyNjgyOA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540826828", "bodyText": "regionkey is twice here, same below in *, * case\nplease add a note in cmt message about this change too", "author": "findepi", "createdAt": "2020-12-11T09:57:19Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -158,14 +166,19 @@ public void testShowStats()\n                         \"   ('nationkey', null, 5.0, 0.0, null, 0, 24), \" +\n                         \"   ('name', 177.0, 5.0, 0.0, null, null, null), \" +\n                         \"   ('comment', 1857.0, 5.0, 0.0, null, null, null), \" +\n+                        \"   ('regionkey', null, 5.0, 0.0, null, 0, 4), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyNzU3OA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540827578", "bodyText": "Maybe add\n// The two regionkey columns come from two different tables", "author": "findepi", "createdAt": "2020-12-11T09:58:23Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -181,28 +194,59 @@ public void testShowStats()\n     }\n \n     @Test\n-    public void testShowStatsWithoutFromFails()\n+    public void testShowStatsWithoutFrom()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1)\", \".*There must be exactly one table in query passed to SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1.0, 0.0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 1.0, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithMultipleFromFails()\n+    public void testShowStatsWithMultipleFrom()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT * FROM nation_partitioned, region)\", \".*There must be exactly one table in query passed to SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT * FROM nation_partitioned, region)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 0, 24), \" +\n+                        \"   ('name',      850, 5, 0, null, null, null), \" +\n+                        \"   ('comment',   9285, 5, 0, null, null, null), \" +\n+                        \"   ('regionkey', null, 5, 0, null, 0, 4), \" +\n+                        \"   ('regionkey', null, 5, 0, null, 0, 4), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyOTU2Mg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540829562", "bodyText": "Maybe add more than 1, so that the effect on min/max is more apparent.", "author": "findepi", "createdAt": "2020-12-11T10:01:36Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyOTY1NA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540829654", "bodyText": "Also, give expression an alias, so that you we do not have to update the tests when implicit column alias changes from _col0 to something else.\nThere needs to be a test with implicit column names, but let's have one dedicated test case for that.\n(same in other places)", "author": "findepi", "createdAt": "2020-12-11T10:01:44Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyOTk5OQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540829999", "bodyText": "We should know the row count since it's NDV(orderkey), which is known.\nIs it unknown because of partial aggregations?\nPlease file an issue to further improve this.", "author": "findepi", "createdAt": "2020-12-11T10:02:13Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithGroupByFails()\n+    public void testShowStatsWithGroupBy()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk4NzgxMQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r541987811", "bodyText": "#6323", "author": "kokosing", "createdAt": "2020-12-13T19:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyOTk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzMDgyNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540830826", "bodyText": "Add a test with\nSELECT DISTINCT regionkey FROM nation\n\nsince NDV(regionkey) is known, the row count should be known.\nI think it won't work yet (the same way as the GROUP BY case above), so\nthis will be a todo", "author": "findepi", "createdAt": "2020-12-11T10:03:32Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithGroupByFails()\n+    public void testShowStatsWithGroupBy()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithHavingFails()\n+    public void testShowStatsWithHaving()\n     {\n-        assertQueryFails(\n+        assertQuery(\n                 \"SHOW STATS FOR (SELECT count(nationkey) FROM nation_partitioned GROUP BY regionkey HAVING regionkey > 0)\",\n-                \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectDistinctFails()\n+    public void testShowStatsWithSelectDistinct()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\", \".*DISTINCT is not supported by SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzMTU0Mw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540831543", "bodyText": "row count should be 1, since this is a global agg\nthis may be useful for \"helper\" tables used with max to pull some information used in oiher places in a query\nplease add a todo", "author": "findepi", "createdAt": "2020-12-11T10:04:46Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithGroupByFails()\n+    public void testShowStatsWithGroupBy()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithHavingFails()\n+    public void testShowStatsWithHaving()\n     {\n-        assertQueryFails(\n+        assertQuery(\n                 \"SHOW STATS FOR (SELECT count(nationkey) FROM nation_partitioned GROUP BY regionkey HAVING regionkey > 0)\",\n-                \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectDistinctFails()\n+    public void testShowStatsWithSelectDistinct()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\", \".*DISTINCT is not supported by SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('orderkey', null, null, null, null, null, null), \" +\n+                        \"   ('custkey', null, null, null, null, null, null), \" +\n+                        \"   ('orderstatus', null, null, null, null, null, null), \" +\n+                        \"   ('totalprice', null, null, null, null, null, null), \" +\n+                        \"   ('orderdate', null, null, null, null, null, null), \" +\n+                        \"   ('orderpriority', null, null, null, null, null, null), \" +\n+                        \"   ('clerk', null, null, null, null, null, null), \" +\n+                        \"   ('shippriority', null, null, null, null, null, null), \" +\n+                        \"   ('comment', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectFunctionCallFails()\n+    public void testShowStatsWithSelectFunctionCall()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n-        assertQueryFails(\"SHOW STATS FOR (SELECT count(*) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, 15000, null, null))\");\n+        assertQuery(\"SHOW STATS FOR (SELECT count(*) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzMjE0MA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540832140", "bodyText": "How do you know this filter has not been pushed down?\nPlease capture explanation for the filters used here in a code comment", "author": "findepi", "createdAt": "2020-12-11T10:05:42Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithGroupByFails()\n+    public void testShowStatsWithGroupBy()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithHavingFails()\n+    public void testShowStatsWithHaving()\n     {\n-        assertQueryFails(\n+        assertQuery(\n                 \"SHOW STATS FOR (SELECT count(nationkey) FROM nation_partitioned GROUP BY regionkey HAVING regionkey > 0)\",\n-                \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectDistinctFails()\n+    public void testShowStatsWithSelectDistinct()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\", \".*DISTINCT is not supported by SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('orderkey', null, null, null, null, null, null), \" +\n+                        \"   ('custkey', null, null, null, null, null, null), \" +\n+                        \"   ('orderstatus', null, null, null, null, null, null), \" +\n+                        \"   ('totalprice', null, null, null, null, null, null), \" +\n+                        \"   ('orderdate', null, null, null, null, null, null), \" +\n+                        \"   ('orderpriority', null, null, null, null, null, null), \" +\n+                        \"   ('clerk', null, null, null, null, null, null), \" +\n+                        \"   ('shippriority', null, null, null, null, null, null), \" +\n+                        \"   ('comment', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectFunctionCallFails()\n+    public void testShowStatsWithSelectFunctionCall()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n-        assertQueryFails(\"SHOW STATS FOR (SELECT count(*) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, 15000, null, null))\");\n+        assertQuery(\"SHOW STATS FOR (SELECT count(*) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n+    }\n+\n+    @Test\n+    public void testShowStatsWithNonPushDownFilter()\n+    {\n+        assertQuery(\"SHOW STATS FOR (SELECT * FROM nation_partitioned WHERE regionkey + 100 < 200)\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk4ODYzMQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r541988631", "bodyText": "Actually, I do not care how big part of predicate was pushed down. I will rename the test to testShowStatsWithPredicate", "author": "kokosing", "createdAt": "2020-12-13T19:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzMjE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzMjI2MQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540832261", "bodyText": "Push -> Pushed", "author": "findepi", "createdAt": "2020-12-11T10:05:56Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestShowStats.java", "diffHunk": "@@ -212,62 +256,145 @@ public void testShowStatsForNonExistingColumnFails()\n     }\n \n     @Test\n-    public void testShowStatsForNonColumnQueryFails()\n+    public void testShowStatsForNonColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, 1, 1), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForAliasedColumnQueryFails()\n+    public void testShowStatsForAliasedColumnQuery()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\", \".*Column aliasing is not supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey, name, name AS name2 FROM nation_partitioned WHERE regionkey > 0 and regionkey < 4)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('nationkey', null, 5, 0, null, 1, 24), \" +\n+                        \"   ('name', 109, 5, 0, null, null, null), \" +\n+                        \"   ('name2', 109, 5, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 15, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForNonIdentifierColumnFails()\n+    public void testShowStatsForNonIdentifierColumn()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT CONCAT('some', 'value') FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 1, 0, null, null, null), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsForColumnExpressionFails()\n+    public void testShowStatsForColumnExpression()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT nationkey + 1 FROM nation_partitioned)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, 5, 0, null, 1, 25), \" +\n+                        \"   (null, null, null, null, 25, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithGroupByFails()\n+    public void testShowStatsWithGroupBy()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT avg(totalprice) FROM orders GROUP BY orderkey)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithHavingFails()\n+    public void testShowStatsWithHaving()\n     {\n-        assertQueryFails(\n+        assertQuery(\n                 \"SHOW STATS FOR (SELECT count(nationkey) FROM nation_partitioned GROUP BY regionkey HAVING regionkey > 0)\",\n-                \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectDistinctFails()\n+    public void testShowStatsWithSelectDistinct()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\", \".*DISTINCT is not supported by SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT DISTINCT * FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('orderkey', null, null, null, null, null, null), \" +\n+                        \"   ('custkey', null, null, null, null, null, null), \" +\n+                        \"   ('orderstatus', null, null, null, null, null, null), \" +\n+                        \"   ('totalprice', null, null, null, null, null, null), \" +\n+                        \"   ('orderdate', null, null, null, null, null, null), \" +\n+                        \"   ('orderpriority', null, null, null, null, null, null), \" +\n+                        \"   ('clerk', null, null, null, null, null, null), \" +\n+                        \"   ('shippriority', null, null, null, null, null, null), \" +\n+                        \"   ('comment', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n     }\n \n     @Test\n-    public void testShowStatsWithSelectFunctionCallFails()\n+    public void testShowStatsWithSelectFunctionCall()\n     {\n-        assertQueryFails(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n-        assertQueryFails(\"SHOW STATS FOR (SELECT count(*) FROM orders)\", \".*Only table columns names are supported in SHOW STATS SELECT clause\");\n+        assertQuery(\"SHOW STATS FOR (SELECT sin(orderkey) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, 15000, null, null))\");\n+        assertQuery(\"SHOW STATS FOR (SELECT count(*) FROM orders)\",\n+                \"SELECT * FROM (VALUES \" +\n+                        \"   ('_col0', null, null, null, null, null, null), \" +\n+                        \"   (null, null, null, null, null, null, null))\");\n+    }\n+\n+    @Test\n+    public void testShowStatsWithNonPushDownFilter()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzNTE3OQ==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540835179", "bodyText": "This should be more contextual.\nnull makes sense\n\nfor min being -inf\nfor max being +inf\nfor row count, NDV, null fraction, data size being nan\n\nbut we probably should not output dull null eg when\n\nrow count is +inf\n\nplease maybe add a todo note?\nsame in toStringLiteral(Type type, double value) above", "author": "findepi", "createdAt": "2020-12-11T10:10:30Z", "path": "presto-main/src/main/java/io/prestosql/sql/rewrite/ShowStatsRewrite.java", "diffHunk": "@@ -414,4 +225,12 @@ private static Expression toStringLiteral(Type type, double value)\n             throw new IllegalArgumentException(\"Unexpected type: \" + type);\n         }\n     }\n+\n+    private static Expression toDoubleLiteral(double value)\n+    {\n+        if (!isFinite(value)) {\n+            return NULL_DOUBLE;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5MjI1MA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r541992250", "bodyText": "It is not used for min and max. I don't see a big difference between NaN and null from user perspective.\n\nsame in toStringLiteral(Type type, double value) above\n\ntoStringLiteral is used only for min and max where -inf and +inf is represented differently for different types.\n\nplease maybe add a todo note?\n\nI don't fully understand you here, so let me skip that.", "author": "kokosing", "createdAt": "2020-12-13T19:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzNTE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5NzEyNg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r542197126", "bodyText": "I don't see a big difference between NaN and null from user perspective.\n\nI do not see either. There can be a difference between +inf and null.", "author": "findepi", "createdAt": "2020-12-14T08:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzNTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzNjQ2NA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540836464", "bodyText": "It would improve readability if you extracted this to   method\nString statsRow(String columnName, double datasize,....) \n\nalso,\n\ncast(1 AS double) can be expressed shortly with 1e0\nuppercase CAST and NULL", "author": "findepi", "createdAt": "2020-12-11T10:12:35Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestColumnMask.java", "diffHunk": "@@ -455,10 +455,22 @@ public void testShowStats()\n                 USER,\n                 new ViewExpression(USER, Optional.of(CATALOG), Optional.of(\"tiny\"), \"7\"));\n \n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT orderkey FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n+        assertThat(assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n+                .matches(\"VALUES \" +\n+                        \"(cast('orderkey' AS varchar), cast(null AS double), cast(1 AS double), cast(0 AS double), cast(null AS double), cast('7' AS varchar), cast('7' AS varchar)),\" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5NjA3Mg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r541996072", "bodyText": "I simplified it differently. Case fixed.", "author": "kokosing", "createdAt": "2020-12-13T20:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzNjQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzODA4Mw==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r540838083", "bodyText": "Nice.\nplease mention this normalization in a commit message as well", "author": "findepi", "createdAt": "2020-12-11T10:15:00Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTableStatistics.java", "diffHunk": "@@ -120,7 +120,7 @@ public Requirement getRequirements(Configuration configuration)\n                 row(\"c_tinyint\", null, 2.0, 0.0, null, \"121\", \"127\"),\n                 row(\"c_smallint\", null, 2.0, 0.0, null, \"32761\", \"32767\"),\n                 row(\"c_int\", null, 2.0, 0.0, null, \"2147483641\", \"2147483647\"),\n-                row(\"c_bigint\", null, 2.0, 0.0, null, \"9223372036854775807\", \"9223372036854775807\"),\n+                row(\"c_bigint\", null, 1.0, 0.0, null, \"9223372036854775807\", \"9223372036854775807\"),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5Nzc1OA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r542197758", "bodyText": "CAST(1 AS double) -> 1e0", "author": "findepi", "createdAt": "2020-12-14T08:33:25Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestColumnMask.java", "diffHunk": "@@ -455,14 +455,19 @@ public void testShowStats()\n                 USER,\n                 new ViewExpression(USER, Optional.of(CATALOG), Optional.of(\"tiny\"), \"7\"));\n \n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT orderkey FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n+        assertThat(assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n+                .containsAll(\"VALUES \" +\n+                        \"(CAST('orderkey' AS varchar), CAST(NULL AS double), CAST(1 AS double), 0e1, NULL, '7', '7'),\" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5NzgxMg==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r542197812", "bodyText": "CAST(1 AS double)\ni still think a statsRow formatting function could be useful, but it looks good enough", "author": "findepi", "createdAt": "2020-12-14T08:33:33Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestColumnMask.java", "diffHunk": "@@ -455,14 +455,19 @@ public void testShowStats()\n                 USER,\n                 new ViewExpression(USER, Optional.of(CATALOG), Optional.of(\"tiny\"), \"7\"));\n \n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT orderkey FROM orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS for table with column masking is not supported: orderkey\");\n+        assertThat(assertions.query(\"SHOW STATS FOR (SELECT * FROM orders)\"))\n+                .containsAll(\"VALUES \" +\n+                        \"(CAST('orderkey' AS varchar), CAST(NULL AS double), CAST(1 AS double), 0e1, NULL, '7', '7'),\" +\n+                        \"(CAST('clerk' AS varchar), 15e3, 1e3, 0e1, NULL, CAST(NULL AS varchar), CAST(NULL AS varchar)),\" +\n+                        \"(NULL, NULL, NULL, NULL, 15e3, NULL, NULL)\");\n+        assertThat(assertions.query(\"SHOW STATS FOR (SELECT orderkey FROM orders)\"))\n+                .matches(\"VALUES \" +\n+                        \"(CAST('orderkey' AS varchar), CAST(NULL AS double), CAST(1 AS double), 0e1, NULL, CAST('7' AS varchar), CAST('7' AS varchar)),\" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5ODQzNA==", "url": "https://github.com/trinodb/trino/pull/3109#discussion_r542198434", "bodyText": "CAST(1 AS double)", "author": "findepi", "createdAt": "2020-12-14T08:34:33Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestRowFilter.java", "diffHunk": "@@ -366,7 +366,11 @@ public void testShowStats()\n                 USER,\n                 new ViewExpression(RUN_AS_USER, Optional.of(CATALOG), Optional.of(\"tiny\"), \"orderkey = 0\"));\n \n-        assertThatThrownBy(() -> assertions.query(\"SHOW STATS FOR (SELECT * FROM tiny.orders)\"))\n-                .hasMessageMatching(\"\\\\QSHOW STATS is not supported for a table with row filtering\");\n+        assertThat(assertions.query(\"SHOW STATS FOR (SELECT * FROM tiny.orders)\"))\n+                .containsAll(\n+                        \"VALUES \" +\n+                                \"(CAST('orderkey' AS varchar), 0e1, 0e1, CAST(1 AS double), CAST(NULL AS double), CAST(NULL AS varchar), CAST(NULL AS varchar)),\" +\n+                                \"(CAST('custkey' AS varchar), 0e1, 0e1, CAST(1 AS double), CAST(NULL AS double), CAST(NULL AS varchar), CAST(NULL AS varchar)),\" +", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0deba09aeed98be6f4bad57015321877d3f6ece", "url": "https://github.com/trinodb/trino/commit/b0deba09aeed98be6f4bad57015321877d3f6ece", "message": "Use single node Presto in TestShowStats", "committedDate": "2020-12-14T14:39:08Z", "type": "commit"}, {"oid": "3c5b5b053affa6cf093e7f4cbca0bb26d9bfb380", "url": "https://github.com/trinodb/trino/commit/3c5b5b053affa6cf093e7f4cbca0bb26d9bfb380", "message": "Support arbitrary query in SHOW STATS\n\nNow:\n - null fraction is normalized to 1 for tables with row count 0,\n regardless of what the stats returned by the connector.\n - all relation columns are listed in statistics, even if duplicated.", "committedDate": "2020-12-14T14:39:08Z", "type": "commit"}, {"oid": "a030b90ee66665e6af518cdb9076db663bd7905a", "url": "https://github.com/trinodb/trino/commit/a030b90ee66665e6af518cdb9076db663bd7905a", "message": "Test code cleanup\n\n- Use capital letters for SQL keywords\n- Simplify expected queries\n- Put each argument into separate line", "committedDate": "2020-12-14T14:39:08Z", "type": "commit"}, {"oid": "a030b90ee66665e6af518cdb9076db663bd7905a", "url": "https://github.com/trinodb/trino/commit/a030b90ee66665e6af518cdb9076db663bd7905a", "message": "Test code cleanup\n\n- Use capital letters for SQL keywords\n- Simplify expected queries\n- Put each argument into separate line", "committedDate": "2020-12-14T14:39:08Z", "type": "forcePushed"}]}