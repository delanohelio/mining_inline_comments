{"pr_number": 4946, "pr_title": "Propagate 'all' domain explicitly", "pr_createdAt": "2020-08-24T09:59:47Z", "pr_url": "https://github.com/trinodb/trino/pull/4946", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r475510101", "bodyText": "If you want to assume each DynamicFilterId has an entry in the Map, you would need to change the return result.getDomains().get() below too. However, it seems to be like having inexplicit assumptions in the data model, which are not necessary. Can we handle this in eg in io.prestosql.operator.TaskContext#collectDynamicTupleDomain instead?", "author": "findepi", "createdAt": "2020-08-24T10:38:36Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilterConsumer.java", "diffHunk": "@@ -144,6 +144,11 @@ private void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n             return buildChannels.keySet().stream()\n                     .collect(toImmutableMap(identity(), filterId -> Domain.none(filterBuildTypes.get(filterId))));\n         }\n+        if (result.isAll()) {\n+            // Set `all` domain explicitly for dynamic filters so that it can be waited for\n+            return buildChannels.keySet().stream()\n+                    .collect(toImmutableMap(identity(), filterId -> Domain.all(filterBuildTypes.get(filterId))));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMjExOA==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r475512118", "bodyText": "If you want to assume each DynamicFilterId has an entry in the Map, you would need to change the return result.getDomains().get() below too. However, it seems to be like having inexplicit assumptions in the data model, which are not necessary.\n\nWhat do you mean by you would need to change the return result.getDomains().get() below too. The only special cases for TupleDomain are all and none. For other cases there is an explicit mapping between filter id and domain.\n\nCan we handle this in eg in io.prestosql.operator.TaskContext#collectDynamicTupleDomain instead?\n\nTaskContext doesn't know what DFs there are.", "author": "sopel39", "createdAt": "2020-08-24T10:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3OTUzMA==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r475579530", "bodyText": "I've added assertion so that all expected DFs are present during result.getDomains().get() call", "author": "sopel39", "createdAt": "2020-08-24T12:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4OTMwMw==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r475589303", "bodyText": "The TupleDomain's map does not contain any Domain.all entries.\nSo TupleDomain.all (empty map) does not need to be treated as a special case.", "author": "findepi", "createdAt": "2020-08-24T13:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU5OTAwNA==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r475599004", "bodyText": "So TupleDomain.all (empty map) does not need to be treated as a special case.\n\nIt does. Let's suppose there is listener for DF1. It might happen that build side is too large and TupleDomain.all() is reported. In that case we need to explicitly set DF1 domain to all. Otherwise listener won't know that DF is available.", "author": "sopel39", "createdAt": "2020-08-24T13:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1OTUxMw==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r476459513", "bodyText": "@findepi I've updated the code. Indeed, Domain.all would be removed from TupleDomain. I've added support for that case along with test. However, in practice this wasn't happening because DynamicFilterSourceOperator did not return partial result.", "author": "sopel39", "createdAt": "2020-08-25T13:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMDEwMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5NTA1MQ==", "url": "https://github.com/trinodb/trino/pull/4946#discussion_r476495051", "bodyText": "maybe isntead of Sets.difference, use .putIfAbsent?\ni think would be more readable", "author": "findepi", "createdAt": "2020-08-25T14:30:53Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilterConsumer.java", "diffHunk": "@@ -144,7 +145,13 @@ private void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n             return buildChannels.keySet().stream()\n                     .collect(toImmutableMap(identity(), filterId -> Domain.none(filterBuildTypes.get(filterId))));\n         }\n-        return result.getDomains().get();\n+\n+        ImmutableMap.Builder<DynamicFilterId, Domain> domains = ImmutableMap.builder();\n+        domains.putAll(result.getDomains().get());\n+        // Add `all` domain explicitly for dynamic filters to notify dynamic filter listeners\n+        Sets.difference(buildChannels.keySet(), result.getDomains().get().keySet())\n+                .forEach(filterId -> domains.put(filterId, Domain.all(filterBuildTypes.get(filterId))));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a5ecc278e254d355266ba2b55afeb3942a08871f", "url": "https://github.com/trinodb/trino/commit/a5ecc278e254d355266ba2b55afeb3942a08871f", "message": "Propagate 'all' domain explicitly", "committedDate": "2020-08-25T14:43:03Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "78a6567b31869f2830ef16289c8828618d94ba3a", "url": "https://github.com/trinodb/trino/commit/78a6567b31869f2830ef16289c8828618d94ba3a", "message": "Use throws Exception instead of multiple exceptions", "committedDate": "2020-08-25T18:49:23Z", "type": "commit"}, {"oid": "78a6567b31869f2830ef16289c8828618d94ba3a", "url": "https://github.com/trinodb/trino/commit/78a6567b31869f2830ef16289c8828618d94ba3a", "message": "Use throws Exception instead of multiple exceptions", "committedDate": "2020-08-25T18:49:23Z", "type": "forcePushed"}]}