{"pr_number": 2984, "pr_title": "Use reentrant executor in CachingHiveMetastoreModule", "pr_createdAt": "2020-03-02T15:24:53Z", "pr_url": "https://github.com/trinodb/trino/pull/2984", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2MDc5NQ==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386460795", "bodyText": "+ finally cleanup", "author": "findepi", "createdAt": "2020-03-02T15:27:19Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantExecutor.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantExecutor\n+        implements Executor\n+{\n+    private final ThreadLocal<Boolean> executorThreadMarkers = ThreadLocal.withInitial(() -> false);\n+    private final Executor delegate;\n+\n+    public ReentrantExecutor(Executor delegate)\n+    {\n+        this.delegate = requireNonNull(delegate, \"delegate is null\");\n+    }\n+\n+    @Override\n+    public void execute(Runnable task)\n+    {\n+        if (executorThreadMarkers.get()) {\n+            task.run();\n+        }\n+\n+        delegate.execute(() -> {\n+            executorThreadMarkers.set(true);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2MDgyMA==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386460820", "bodyText": "Previously the call would run on a separate thread. Now it runs on the stack.\nIt would be better to extended BoundedExecutor, or alternatively, share the underlying executor and delegate to that.", "author": "findepi", "createdAt": "2020-03-02T15:27:21Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantExecutor.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantExecutor\n+        implements Executor\n+{\n+    private final ThreadLocal<Boolean> executorThreadMarkers = ThreadLocal.withInitial(() -> false);\n+    private final Executor delegate;\n+\n+    public ReentrantExecutor(Executor delegate)\n+    {\n+        this.delegate = requireNonNull(delegate, \"delegate is null\");\n+    }\n+\n+    @Override\n+    public void execute(Runnable task)\n+    {\n+        if (executorThreadMarkers.get()) {\n+            task.run();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2MjQzOA==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386462438", "bodyText": "then the class would be ReentrantBoundedExecutor", "author": "findepi", "createdAt": "2020-03-02T15:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2MDgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2MTk4Ng==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386461986", "bodyText": "It's tri-state effectively (true, false, but could be unset).\nYou can make it two-state by using Object MARKER and only set, remove methods.", "author": "findepi", "createdAt": "2020-03-02T15:29:05Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantExecutor.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantExecutor\n+        implements Executor\n+{\n+    private final ThreadLocal<Boolean> executorThreadMarkers = ThreadLocal.withInitial(() -> false);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg3MjM4NQ==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386872385", "bodyText": "Remove the else block.\nIf you really want reset state, use no initial value (and Object, not Boolean).\nIf you want to use Boolean, then initial value is appropriate and you shouldn't reset false to unset.", "author": "findepi", "createdAt": "2020-03-03T08:51:01Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantBoundedExecutor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import io.airlift.concurrent.BoundedExecutor;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantBoundedExecutor\n+        implements Executor\n+{\n+    private final ThreadLocal<Boolean> executorThreadMarkers = ThreadLocal.withInitial(() -> false);\n+    private final Executor boundedExecutor;\n+    private final Executor coreExecutor;\n+\n+    public ReentrantBoundedExecutor(Executor coreExecutor, int maxThreads)\n+    {\n+        this.boundedExecutor = new BoundedExecutor(requireNonNull(coreExecutor, \"coreExecutor is null\"), maxThreads);\n+        this.coreExecutor = coreExecutor;\n+    }\n+\n+    @Override\n+    public void execute(Runnable task)\n+    {\n+        if (executorThreadMarkers.get()) {\n+            coreExecutor.execute(task);\n+        }\n+        else {\n+            // remove the initial marker value initialized by java.lang.ThreadLocal.get\n+            executorThreadMarkers.remove();\n+        }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg3MjU0MQ==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386872541", "bodyText": "Add a javadoc", "author": "findepi", "createdAt": "2020-03-03T08:51:19Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantBoundedExecutor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import io.airlift.concurrent.BoundedExecutor;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantBoundedExecutor", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg3Mjc5NA==", "url": "https://github.com/trinodb/trino/pull/2984#discussion_r386872794", "bodyText": "Consider adding a comment here", "author": "findepi", "createdAt": "2020-03-03T08:51:46Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/ReentrantBoundedExecutor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import io.airlift.concurrent.BoundedExecutor;\n+\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ReentrantBoundedExecutor\n+        implements Executor\n+{\n+    private final ThreadLocal<Boolean> executorThreadMarkers = ThreadLocal.withInitial(() -> false);\n+    private final Executor boundedExecutor;\n+    private final Executor coreExecutor;\n+\n+    public ReentrantBoundedExecutor(Executor coreExecutor, int maxThreads)\n+    {\n+        this.boundedExecutor = new BoundedExecutor(requireNonNull(coreExecutor, \"coreExecutor is null\"), maxThreads);\n+        this.coreExecutor = coreExecutor;\n+    }\n+\n+    @Override\n+    public void execute(Runnable task)\n+    {\n+        if (executorThreadMarkers.get()) {\n+            coreExecutor.execute(task);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15aeff0315ff7bc564d299f6d11762a8b3bf5b86", "url": "https://github.com/trinodb/trino/commit/15aeff0315ff7bc564d299f6d11762a8b3bf5b86", "message": "Use reentrant executor in CachingHiveMetastoreModule\n\nLoading of cache entry in CachingHiveMetastoreModule\nmight trigger loading of another cache entry for different\nobject type. In case there are no empty executor slots,\nsuch operation would deadlock. Therefore, a reentrant\nexecutor needs to be used that would trigger loading\naction directly if it is triggered from executor thread\ncontext.", "committedDate": "2020-03-03T12:40:23Z", "type": "commit"}, {"oid": "15aeff0315ff7bc564d299f6d11762a8b3bf5b86", "url": "https://github.com/trinodb/trino/commit/15aeff0315ff7bc564d299f6d11762a8b3bf5b86", "message": "Use reentrant executor in CachingHiveMetastoreModule\n\nLoading of cache entry in CachingHiveMetastoreModule\nmight trigger loading of another cache entry for different\nobject type. In case there are no empty executor slots,\nsuch operation would deadlock. Therefore, a reentrant\nexecutor needs to be used that would trigger loading\naction directly if it is triggered from executor thread\ncontext.", "committedDate": "2020-03-03T12:40:23Z", "type": "forcePushed"}]}