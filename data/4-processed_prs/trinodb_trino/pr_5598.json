{"pr_number": 5598, "pr_title": "Use Accumulo in Docker for unit tests", "pr_createdAt": "2020-10-19T13:52:53Z", "pr_url": "https://github.com/trinodb/trino/pull/5598", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxOTQ4Mw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507819483", "bodyText": "set a version\n(@kokosing do we publish latest at all?)", "author": "findepi", "createdAt": "2020-10-19T14:54:29Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -171,58 +171,29 @@ public static Connector getAccumuloConnector()\n         }\n \n         try {\n-            MiniAccumuloCluster accumulo = createMiniAccumuloCluster();\n-            Instance instance = new ZooKeeperInstance(accumulo.getInstanceName(), accumulo.getZooKeepers());\n-            connector = instance.getConnector(MAC_USER, new PasswordToken(MAC_PASSWORD));\n-            LOG.info(\"Connection to MAC instance %s at %s established, user %s password %s\", accumulo.getInstanceName(), accumulo.getZooKeepers(), MAC_USER, MAC_PASSWORD);\n+            FixedHostPortGenericContainer<?> accumuloContainer = new FixedHostPortGenericContainer<>(\"prestodev/accumulo:latest\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1NjcyNQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507956725", "bodyText": "trinodb/docker-images#74 will need released and then I will push up a version and that should get the CI to pass. AFAIK latest versions are not published.", "author": "adamjshook", "createdAt": "2020-10-19T18:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxOTQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2OTM3Ng==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507969376", "bodyText": "It looks like we do: https://hub.docker.com/layers/prestodev/hdp2.6-hive-kerberized/latest/images/sha256-5831557495ff24f1619325c0a847552a6871376f1b65473664d86ef54a67bc8e?context=explore\n@adamjshook you might want to to publish this image to some custom repository to just to see if everything works and then I will do the release so we can update the image here. WDYT?", "author": "kokosing", "createdAt": "2020-10-19T18:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxOTQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3NTkxMw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507975913", "bodyText": "@kokosing Sure, I'm good with that \ud83d\udc4d", "author": "adamjshook", "createdAt": "2020-10-19T18:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxOTQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxOTkyOA==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507819928", "bodyText": "Hopefully redundant. testcontainers' Ryuk's responsibiliy.", "author": "findepi", "createdAt": "2020-10-19T14:55:02Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -171,58 +171,29 @@ public static Connector getAccumuloConnector()\n         }\n \n         try {\n-            MiniAccumuloCluster accumulo = createMiniAccumuloCluster();\n-            Instance instance = new ZooKeeperInstance(accumulo.getInstanceName(), accumulo.getZooKeepers());\n-            connector = instance.getConnector(MAC_USER, new PasswordToken(MAC_PASSWORD));\n-            LOG.info(\"Connection to MAC instance %s at %s established, user %s password %s\", accumulo.getInstanceName(), accumulo.getZooKeepers(), MAC_USER, MAC_PASSWORD);\n+            FixedHostPortGenericContainer<?> accumuloContainer = new FixedHostPortGenericContainer<>(\"prestodev/accumulo:latest\");\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_MASTER_PORT, ACCUMULO_MASTER_PORT);\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_TSERVER_PORT, ACCUMULO_TSERVER_PORT);\n+            accumuloContainer.withFixedExposedPort(ZOOKEEPER_PORT, ZOOKEEPER_PORT);\n+            accumuloContainer.waitingFor(Wait.forHealthcheck().withStartupTimeout(Duration.ofMinutes(10)));\n+            accumuloContainer.start();\n+\n+            // Add shutdown hook to stop Docker container\n+            Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+                LOG.info(\"Shutting down Accumulo\");\n+                accumuloContainer.stop();\n+            }));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MDIyOA==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507970228", "bodyText": "Do we still need a singleton? It would be nice to have it as regular closeable resource instead.", "author": "kokosing", "createdAt": "2020-10-19T18:22:50Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -159,8 +159,8 @@ public static Session createSession()\n     }\n \n     /**\n-     * Gets the AccumuloConnector singleton, starting the MiniAccumuloCluster on initialization.\n-     * This singleton instance is required so all test cases access the same MiniAccumuloCluster.\n+     * Gets the AccumuloConnector singleton, starting the Accumulo Docker container on initialization.\n+     * This singleton instance is required so all test cases access the same Accumulo", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3NzU0Nw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507977547", "bodyText": "No, not needed. I can create a TestingAccumuloServer and refactor the tests to use it to be more similar to how the other connectors work.", "author": "adamjshook", "createdAt": "2020-10-19T18:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MDIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4NjEzMA==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r508586130", "bodyText": "Turns out it is needed after all due to the fixed ports, multiple containers try to spawn at the same time and it fails. If I try a lock approach so only one container runs at a time, one of the test framework classes (distributed/integration smoke test) inexplicable fail because they are unable to connect to Accumulo once a new container is spawned.\nI suggest with stick with the Singleton -- I'll still refactor into a TestingAccumuloServer for cleanliness.", "author": "adamjshook", "createdAt": "2020-10-20T15:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MDIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MDcyNQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507970725", "bodyText": "just RuntimeException, it is test code", "author": "kokosing", "createdAt": "2020-10-19T18:23:39Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -171,58 +171,29 @@ public static Connector getAccumuloConnector()\n         }\n \n         try {\n-            MiniAccumuloCluster accumulo = createMiniAccumuloCluster();\n-            Instance instance = new ZooKeeperInstance(accumulo.getInstanceName(), accumulo.getZooKeepers());\n-            connector = instance.getConnector(MAC_USER, new PasswordToken(MAC_PASSWORD));\n-            LOG.info(\"Connection to MAC instance %s at %s established, user %s password %s\", accumulo.getInstanceName(), accumulo.getZooKeepers(), MAC_USER, MAC_PASSWORD);\n+            FixedHostPortGenericContainer<?> accumuloContainer = new FixedHostPortGenericContainer<>(\"prestodev/accumulo:latest\");\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_MASTER_PORT, ACCUMULO_MASTER_PORT);\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_TSERVER_PORT, ACCUMULO_TSERVER_PORT);\n+            accumuloContainer.withFixedExposedPort(ZOOKEEPER_PORT, ZOOKEEPER_PORT);\n+            accumuloContainer.waitingFor(Wait.forHealthcheck().withStartupTimeout(Duration.ofMinutes(10)));\n+            accumuloContainer.start();\n+\n+            // Add shutdown hook to stop Docker container\n+            Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+                LOG.info(\"Shutting down Accumulo\");\n+                accumuloContainer.stop();\n+            }));\n+\n+            Instance instance = new ZooKeeperInstance(ACCUMULO_INSTANCE, ACCUMULO_ZOOKEEPERS);\n+            connector = instance.getConnector(ACCUMULO_USER, new PasswordToken(ACCUMULO_PASSWORD));\n+            LOG.info(\"Connection to Accumulo instance %s at %s established, user %s password %s\", ACCUMULO_INSTANCE, ACCUMULO_ZOOKEEPERS, ACCUMULO_USER, ACCUMULO_PASSWORD);\n             return connector;\n         }\n-        catch (AccumuloException | AccumuloSecurityException | InterruptedException | IOException e) {\n+        catch (AccumuloException | AccumuloSecurityException e) {\n             throw new PrestoException(UNEXPECTED_ACCUMULO_ERROR, \"Failed to get connector to Accumulo\", e);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MTEwNw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507971107", "bodyText": "do we need to use fixed ports? It would be nice to have them random.", "author": "kokosing", "createdAt": "2020-10-19T18:24:19Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -171,58 +171,29 @@ public static Connector getAccumuloConnector()\n         }\n \n         try {\n-            MiniAccumuloCluster accumulo = createMiniAccumuloCluster();\n-            Instance instance = new ZooKeeperInstance(accumulo.getInstanceName(), accumulo.getZooKeepers());\n-            connector = instance.getConnector(MAC_USER, new PasswordToken(MAC_PASSWORD));\n-            LOG.info(\"Connection to MAC instance %s at %s established, user %s password %s\", accumulo.getInstanceName(), accumulo.getZooKeepers(), MAC_USER, MAC_PASSWORD);\n+            FixedHostPortGenericContainer<?> accumuloContainer = new FixedHostPortGenericContainer<>(\"prestodev/accumulo:latest\");\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_MASTER_PORT, ACCUMULO_MASTER_PORT);\n+            accumuloContainer.withFixedExposedPort(ACCUMULO_TSERVER_PORT, ACCUMULO_TSERVER_PORT);\n+            accumuloContainer.withFixedExposedPort(ZOOKEEPER_PORT, ZOOKEEPER_PORT);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3OTc3Nw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r507979777", "bodyText": "ZooKeeper doesn't need to be fixed -- I'll change that to random. But Accumulo needs to be fixed.  Clients discover the services from ZooKeeper and the ip:port that is advertised is the internal port that they are bound to.", "author": "adamjshook", "createdAt": "2020-10-19T18:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MTEwNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyMTU4NQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r508921585", "bodyText": "Remove version since this is the same in the root POM", "author": "electrum", "createdAt": "2020-10-21T00:37:35Z", "path": "presto-accumulo/pom.xml", "diffHunk": "@@ -349,7 +274,13 @@\n         <dependency>\n             <groupId>org.jetbrains</groupId>\n             <artifactId>annotations</artifactId>\n-            <version>13.0</version>\n+            <version>19.0.0</version>", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyMTY5OQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r508921699", "bodyText": "Nit: no need to wrap here", "author": "electrum", "createdAt": "2020-10-21T00:38:01Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/AccumuloQueryRunner.java", "diffHunk": "@@ -22,49 +22,31 @@\n import io.prestosql.plugin.accumulo.conf.AccumuloConfig;\n import io.prestosql.plugin.accumulo.serializers.LexicoderRowSerializer;\n import io.prestosql.plugin.tpch.TpchPlugin;\n-import io.prestosql.spi.PrestoException;\n import io.prestosql.testing.DistributedQueryRunner;\n import io.prestosql.testing.QueryRunner;\n import io.prestosql.tpch.TpchTable;\n-import org.apache.accumulo.core.client.AccumuloException;\n-import org.apache.accumulo.core.client.AccumuloSecurityException;\n-import org.apache.accumulo.core.client.Connector;\n-import org.apache.accumulo.core.client.Instance;\n-import org.apache.accumulo.core.client.ZooKeeperInstance;\n-import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n-import org.apache.accumulo.minicluster.MiniAccumuloCluster;\n-import org.apache.commons.io.FileUtils;\n import org.apache.hadoop.io.Text;\n import org.intellij.lang.annotations.Language;\n \n-import java.io.File;\n-import java.io.IOException;\n-import java.nio.file.Files;\n import java.util.Map;\n \n import static io.airlift.units.Duration.nanosSince;\n-import static io.prestosql.plugin.accumulo.AccumuloErrorCode.MINI_ACCUMULO;\n-import static io.prestosql.plugin.accumulo.AccumuloErrorCode.UNEXPECTED_ACCUMULO_ERROR;\n-import static io.prestosql.plugin.accumulo.MiniAccumuloConfigUtil.setConfigClassPath;\n import static io.prestosql.plugin.tpch.TpchMetadata.TINY_SCHEMA_NAME;\n import static io.prestosql.spi.type.BigintType.BIGINT;\n import static io.prestosql.testing.TestingSession.testSessionBuilder;\n import static java.lang.String.format;\n import static java.util.concurrent.TimeUnit.SECONDS;\n-import static org.apache.accumulo.minicluster.MemoryUnit.MEGABYTE;\n \n public final class AccumuloQueryRunner\n {\n     private static final Logger LOG = Logger.get(AccumuloQueryRunner.class);\n-    private static final String MAC_PASSWORD = \"secret\";\n-    private static final String MAC_USER = \"root\";\n \n     private static boolean tpchLoaded;\n-    private static Connector connector = getAccumuloConnector();\n \n     private AccumuloQueryRunner() {}\n \n-    public static synchronized DistributedQueryRunner createAccumuloQueryRunner(Map<String, String> extraProperties)\n+    public static synchronized DistributedQueryRunner createAccumuloQueryRunner(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyMzg4OQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r508923889", "bodyText": "Using a singleton for now is fine as a transition from the old way, but we should move to a model where the Accumulo cluster is managed by AccumuloQueryRunner, the same way we do for other testing services. Shutting down resources immediately is useful since the CI machines can be resource constrained, and using a non-singleton allows things like testing multiple versions, testing with different config, etc.\nAdd a TODO here to make this not a singleton.", "author": "electrum", "createdAt": "2020-10-21T00:45:51Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/TestingAccumuloServer.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.accumulo;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.Connector;\n+import org.apache.accumulo.core.client.ZooKeeperInstance;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+\n+import java.time.Duration;\n+\n+import static java.lang.String.format;\n+\n+public class TestingAccumuloServer\n+{\n+    private static final int ACCUMULO_MASTER_PORT = 9999;\n+    private static final int ACCUMULO_TSERVER_PORT = 9997;\n+    private static final int ZOOKEEPER_PORT = 2181;\n+\n+    private static final TestingAccumuloServer instance = new TestingAccumuloServer();\n+\n+    private final FixedHostPortGenericContainer<?> accumuloContainer;\n+\n+    public static TestingAccumuloServer getInstance()\n+    {\n+        return instance;\n+    }\n+\n+    private TestingAccumuloServer()\n+    {\n+        // TODO Change to a prestodev/accumulo container once released\n+        accumuloContainer = new FixedHostPortGenericContainer<>(\"datacatessen/accumulo:1\");\n+        accumuloContainer.withFixedExposedPort(ACCUMULO_MASTER_PORT, ACCUMULO_MASTER_PORT);\n+        accumuloContainer.withFixedExposedPort(ACCUMULO_TSERVER_PORT, ACCUMULO_TSERVER_PORT);\n+        accumuloContainer.withExposedPorts(ZOOKEEPER_PORT);\n+        accumuloContainer.waitingFor(Wait.forHealthcheck().withStartupTimeout(Duration.ofMinutes(10)));\n+\n+        // No need for an explicit stop since this server is a singleton", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1NDY3Nw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r518154677", "bodyText": "but we should move to a model where the Accumulo cluster is managed by AccumuloQueryRunner,\n\nLet's create a github issue for this and add TODO comment (with link to the issue to the code).", "author": "kokosing", "createdAt": "2020-11-05T15:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyMzg4OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1MjMzMw==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r517252333", "bodyText": "we still need to close https://github.com/prestosql/docker-images/pull/74", "author": "kokosing", "createdAt": "2020-11-04T10:43:11Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/TestingAccumuloServer.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.accumulo;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.Connector;\n+import org.apache.accumulo.core.client.ZooKeeperInstance;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+\n+import java.time.Duration;\n+\n+import static java.lang.String.format;\n+\n+// TODO Change this class to not be a singleton\n+public class TestingAccumuloServer\n+{\n+    private static final int ACCUMULO_MASTER_PORT = 9999;\n+    private static final int ACCUMULO_TSERVER_PORT = 9997;\n+    private static final int ZOOKEEPER_PORT = 2181;\n+\n+    private static final TestingAccumuloServer instance = new TestingAccumuloServer();\n+\n+    private final FixedHostPortGenericContainer<?> accumuloContainer;\n+\n+    public static TestingAccumuloServer getInstance()\n+    {\n+        return instance;\n+    }\n+\n+    private TestingAccumuloServer()\n+    {\n+        // TODO Change to a prestodev/accumulo container once released\n+        accumuloContainer = new FixedHostPortGenericContainer<>(\"datacatessen/accumulo:1\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MzgzMg==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r517973832", "bodyText": "It is released, pleased update to prestodev/accumulo:35", "author": "kokosing", "createdAt": "2020-11-05T11:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1MjMzMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1MzQ5MQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r518153491", "bodyText": "Please remove the comment", "author": "kokosing", "createdAt": "2020-11-05T15:45:53Z", "path": "presto-accumulo/src/test/java/io/prestosql/plugin/accumulo/TestingAccumuloServer.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.accumulo;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.Connector;\n+import org.apache.accumulo.core.client.ZooKeeperInstance;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+\n+import java.time.Duration;\n+\n+import static java.lang.String.format;\n+\n+// TODO Change this class to not be a singleton\n+public class TestingAccumuloServer\n+{\n+    private static final int ACCUMULO_MASTER_PORT = 9999;\n+    private static final int ACCUMULO_TSERVER_PORT = 9997;\n+    private static final int ZOOKEEPER_PORT = 2181;\n+\n+    private static final TestingAccumuloServer instance = new TestingAccumuloServer();\n+\n+    private final FixedHostPortGenericContainer<?> accumuloContainer;\n+\n+    public static TestingAccumuloServer getInstance()\n+    {\n+        return instance;\n+    }\n+\n+    private TestingAccumuloServer()\n+    {\n+        // TODO Change to a prestodev/accumulo container once released", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE2NzcyOQ==", "url": "https://github.com/trinodb/trino/pull/5598#discussion_r518167729", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f", "author": "adamjshook", "createdAt": "2020-11-05T16:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1MzQ5MQ=="}], "type": "inlineReview"}, {"oid": "f7a847122be04e77c702de4616c0e6741acb8a00", "url": "https://github.com/trinodb/trino/commit/f7a847122be04e77c702de4616c0e6741acb8a00", "message": "Use Accumulo in Docker for unit tests", "committedDate": "2020-11-05T16:24:02Z", "type": "commit"}, {"oid": "f7a847122be04e77c702de4616c0e6741acb8a00", "url": "https://github.com/trinodb/trino/commit/f7a847122be04e77c702de4616c0e6741acb8a00", "message": "Use Accumulo in Docker for unit tests", "committedDate": "2020-11-05T16:24:02Z", "type": "forcePushed"}]}