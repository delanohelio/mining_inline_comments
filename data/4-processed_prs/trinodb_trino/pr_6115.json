{"pr_number": 6115, "pr_title": "Gather plan node auxiliary statistics separately", "pr_createdAt": "2020-11-26T22:52:31Z", "pr_url": "https://github.com/trinodb/trino/pull/6115", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "3ef4ecb54551c44e0fb7382b669e9af71ca810d0", "url": "https://github.com/trinodb/trino/commit/3ef4ecb54551c44e0fb7382b669e9af71ca810d0", "message": "Make OperatorHashCollisionsStats self-contained", "committedDate": "2020-11-27T11:08:42Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "559db648c90e38e95d30e6e4ef1ae7b22b929268", "url": "https://github.com/trinodb/trino/commit/559db648c90e38e95d30e6e4ef1ae7b22b929268", "message": "Move assertExplainAnalyze to AbstractTestQueryFramework", "committedDate": "2020-11-27T11:53:26Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjA3NQ==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531566075", "bodyText": "I think this method should be @Deprecated because it's not much better than\ncomputeActual(\"EXPLAIN ANALYZE \" + query); // ensure does not fail\n\nyet, it pretends it is does something useful", "author": "findepi", "createdAt": "2020-11-27T12:11:05Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -321,6 +323,16 @@ protected void assertTableColumnNames(String tableName, String... columnNames)\n         assertEquals(actual, expected);\n     }\n \n+    protected void assertExplainAnalyze(@Language(\"SQL\") String query)", "originalCommit": "559db648c90e38e95d30e6e4ef1ae7b22b929268", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NjYxMw==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531586613", "bodyText": "It does some very basic matching.\nI have extended this method to support extra expected matches.", "author": "sopel39", "createdAt": "2020-11-27T12:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYwOTU5OQ==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531609599", "bodyText": "i do not think this is the right direction. I'd expect the test to do assertThat() and do validation as found fit in this particular case", "author": "findepi", "createdAt": "2020-11-27T13:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyMDE5OA==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531620198", "bodyText": "I'm pretty sure you would end up with similar helper method that would cut boilerplate", "author": "sopel39", "createdAt": "2020-11-27T14:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIzMDE1MQ==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r532230151", "bodyText": "#6139", "author": "findepi", "createdAt": "2020-11-29T16:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2Njc2NA==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531566764", "bodyText": "Can you please verify some selected parts of the output?\nLike the thing you mentioned in \"Advanced join stats are back\" comment\n#6115 (comment)", "author": "findepi", "createdAt": "2020-11-27T12:12:35Z", "path": "presto-tests/src/test/java/io/prestosql/tests/AbstractTestEngineOnlyQueries.java", "diffHunk": "@@ -4158,6 +4159,14 @@ public void testExplainSetSessionWithUsing()\n                         \"Parameters: [7]\");\n     }\n \n+    @Test\n+    public void testExplainAnalyze()\n+    {\n+        assertExplainAnalyze(\n+                noJoinReordering(BROADCAST),\n+                \"EXPLAIN ANALYZE SELECT * FROM (SELECT nationkey, regionkey FROM nation GROUP BY nationkey, regionkey) a, nation b WHERE a.regionkey = b.regionkey\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NzQ2Ng==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531567466", "bodyText": "as assertExplainAnalyze(String) brings very little benefit, let's not add an overload to it.\ninstead, in the actual test, just call computeActual and run assertThat on the returned String\n(and computeActual already accepts a session)", "author": "findepi", "createdAt": "2020-11-27T12:14:05Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -325,7 +325,12 @@ protected void assertTableColumnNames(String tableName, String... columnNames)\n \n     protected void assertExplainAnalyze(@Language(\"SQL\") String query)\n     {\n-        String value = (String) computeActual(query).getOnlyValue();\n+        assertExplainAnalyze(getSession(), query);\n+    }\n+\n+    protected void assertExplainAnalyze(Session session, @Language(\"SQL\") String query)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NjkwMw==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531586903", "bodyText": "I have extended this method to support expected matches", "author": "sopel39", "createdAt": "2020-11-27T12:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NzQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2ODMwMA==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531568300", "bodyText": "Where can this be a case? Shouldn't we attempt to do a merge?", "author": "findepi", "createdAt": "2020-11-27T12:15:42Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/planprinter/TextRenderer.java", "diffHunk": "@@ -163,28 +153,34 @@ private void printDistributions(StringBuilder output, PlanNodeStats stats)\n             output.append(translatedOperatorType);\n             output.append(format(Locale.US, \"Input avg.: %s rows, Input std.dev.: %s%%\\n\",\n                     formatDouble(inputAverage), formatDouble(100.0d * inputStdDevs.get(operator) / inputAverage)));\n+        }\n+    }\n \n-            double hashCollisionsAverage = hashCollisionsAverages.getOrDefault(operator, 0.0d);\n-            double expectedHashCollisionsAverage = expectedHashCollisionsAverages.getOrDefault(operator, 0.0d);\n-            if (hashCollisionsAverage != 0.0d) {\n-                double hashCollisionsStdDevRatio = hashCollisionsStdDevs.get(operator) / hashCollisionsAverage;\n-\n-                if (!translatedOperatorType.isEmpty()) {\n-                    output.append(indentString(2));\n-                }\n-\n-                if (expectedHashCollisionsAverage != 0.0d) {\n-                    double hashCollisionsRatio = hashCollisionsAverage / expectedHashCollisionsAverage;\n-                    output.append(format(Locale.US, \"Collisions avg.: %s (%s%% est.), Collisions std.dev.: %s%%\",\n-                            formatDouble(hashCollisionsAverage), formatDouble(hashCollisionsRatio * 100.0d), formatDouble(hashCollisionsStdDevRatio * 100.0d)));\n-                }\n-                else {\n-                    output.append(format(Locale.US, \"Collisions avg.: %s, Collisions std.dev.: %s%%\",\n-                            formatDouble(hashCollisionsAverage), formatDouble(hashCollisionsStdDevRatio * 100.0d)));\n-                }\n-\n-                output.append(\"\\n\");\n-            }\n+    private void printCollisions(StringBuilder output, PlanNodeStats stats)\n+    {\n+        if (!(stats instanceof HashCollisionPlanNodeStats)) {\n+            return;\n+        }\n+\n+        HashCollisionPlanNodeStats collisionStats = (HashCollisionPlanNodeStats) stats;\n+        if (collisionStats.getOperatorHashCollisionsAverages().keySet().size() != 1) {\n+            // no support for multiple operators that produced collision stats for same plan node", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NzU2MA==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531587560", "bodyText": "I don't think this can be the case. I've changed this to assertion.\nThere is no plan node that translates into two operators producing hash collision stats.\nTho operators that produce hash collision stats are HashAggregationOperator/HashBuilderOperator, but they are not produced from same plan node id.", "author": "sopel39", "createdAt": "2020-11-27T12:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2ODMwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYwOTk0NQ==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531609945", "bodyText": "if this can't be the case, why not verify() here?", "author": "findepi", "createdAt": "2020-11-27T13:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2ODMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2ODc2OQ==", "url": "https://github.com/trinodb/trino/pull/6115#discussion_r531568769", "bodyText": "Maybe add a test with EXPLAIN ANALYZE over JOIN, and over AGG,\nverifying \"Collisions\" is in the output ?", "author": "findepi", "createdAt": "2020-11-27T12:16:42Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/planprinter/TextRenderer.java", "diffHunk": "@@ -132,6 +131,7 @@ private String printStats(PlanRepresentation plan, NodeRepresentation node)\n         output.append(format(\", Output: %s (%s)\\n\", formatPositions(nodeStats.getPlanNodeOutputPositions()), nodeStats.getPlanNodeOutputDataSize().toString()));\n \n         printDistributions(output, nodeStats);\n+        printCollisions(output, nodeStats);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1760f1c28340221a9b5619c74891a2372d15ef4", "url": "https://github.com/trinodb/trino/commit/a1760f1c28340221a9b5619c74891a2372d15ef4", "message": "Gather plan node auxiliary statistics separately\n\nGather auxiliary statistics from all operators\ncreated for a given plan node. Previously, auxiliary\nstats were only collected for input and output operators\nfor a given plan node. However, because creation of DynamicFilterSourceOperator\n(input operator for join plan node) is conditional for some task\nHashCollisionPlanNodeStats might be lost.", "committedDate": "2020-11-27T13:39:41Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "9536d74748e538f91e101fa04865ec0052548f6b", "url": "https://github.com/trinodb/trino/commit/9536d74748e538f91e101fa04865ec0052548f6b", "message": "Fix collisions reporting for joins\n\nCollision stats were not correctly reported previously\nfor join operators. Now they are reported like:\n\n Fragment 1 [HASH]\n    CPU: 154.12ms, Scheduled: 339.28ms, Input: 100 rows (9.33kB); per task: avg.: 33.33 std.dev.: 0.47, Output: 125 rows (13.67kB)\n    Output layout: [nationkey, regionkey, nationkey_0, name_1, comment_3]\n    Output partitioning: SINGLE []\n    Stage Execution Strategy: UNGROUPED_EXECUTION\n    InnerJoin[(\"regionkey\" = \"regionkey_2\")][$hashvalue_7, $hashvalue_8]\n    \u2502   Layout: [nationkey:bigint, regionkey:bigint, nationkey_0:bigint, name_1:varchar(25), comment_3:varchar(152)]\n    \u2502   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}\n    \u2502   CPU: 90.00ms (40.36%), Scheduled: 194.00ms (35.79%), Output: 125 rows (13.67kB)\n    \u2502   Left (probe) Input avg.: 2.08 rows, Input std.dev.: 86.44%\n    \u2502   Right (build) Input avg.: 6.25 rows, Input std.dev.: 87.18%\n    \u2502   Collisions avg.: 5.64 (100.00% est.), Collisions std.dev.: 0.00%\n    \u2502   Distribution: REPLICATED\n    \u2502   dynamicFilterAssignments = {regionkey_2 -> #df_385}\n\nAggregation collision stats are reported like:\n\n    \u2502  \u2514\u2500 Aggregate(FINAL)[nationkey, regionkey][$hashvalue]\n    \u2502     \u2502   Layout: [nationkey:bigint, regionkey:bigint, $hashvalue:bigint]\n    \u2502     \u2502   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}\n    \u2502     \u2502   CPU: 26.00ms (11.66%), Scheduled: 57.00ms (10.52%), Output: 25 rows (675B)\n    \u2502     \u2502   Input avg.: 2.08 rows, Input std.dev.: 86.44%\n    \u2502     \u2502   Collisions avg.: 0.00 (100.00% est.), Collisions std.dev.: 0.00%", "committedDate": "2020-11-27T20:53:35Z", "type": "commit"}, {"oid": "9536d74748e538f91e101fa04865ec0052548f6b", "url": "https://github.com/trinodb/trino/commit/9536d74748e538f91e101fa04865ec0052548f6b", "message": "Fix collisions reporting for joins\n\nCollision stats were not correctly reported previously\nfor join operators. Now they are reported like:\n\n Fragment 1 [HASH]\n    CPU: 154.12ms, Scheduled: 339.28ms, Input: 100 rows (9.33kB); per task: avg.: 33.33 std.dev.: 0.47, Output: 125 rows (13.67kB)\n    Output layout: [nationkey, regionkey, nationkey_0, name_1, comment_3]\n    Output partitioning: SINGLE []\n    Stage Execution Strategy: UNGROUPED_EXECUTION\n    InnerJoin[(\"regionkey\" = \"regionkey_2\")][$hashvalue_7, $hashvalue_8]\n    \u2502   Layout: [nationkey:bigint, regionkey:bigint, nationkey_0:bigint, name_1:varchar(25), comment_3:varchar(152)]\n    \u2502   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}\n    \u2502   CPU: 90.00ms (40.36%), Scheduled: 194.00ms (35.79%), Output: 125 rows (13.67kB)\n    \u2502   Left (probe) Input avg.: 2.08 rows, Input std.dev.: 86.44%\n    \u2502   Right (build) Input avg.: 6.25 rows, Input std.dev.: 87.18%\n    \u2502   Collisions avg.: 5.64 (100.00% est.), Collisions std.dev.: 0.00%\n    \u2502   Distribution: REPLICATED\n    \u2502   dynamicFilterAssignments = {regionkey_2 -> #df_385}\n\nAggregation collision stats are reported like:\n\n    \u2502  \u2514\u2500 Aggregate(FINAL)[nationkey, regionkey][$hashvalue]\n    \u2502     \u2502   Layout: [nationkey:bigint, regionkey:bigint, $hashvalue:bigint]\n    \u2502     \u2502   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}\n    \u2502     \u2502   CPU: 26.00ms (11.66%), Scheduled: 57.00ms (10.52%), Output: 25 rows (675B)\n    \u2502     \u2502   Input avg.: 2.08 rows, Input std.dev.: 86.44%\n    \u2502     \u2502   Collisions avg.: 0.00 (100.00% est.), Collisions std.dev.: 0.00%", "committedDate": "2020-11-27T20:53:35Z", "type": "forcePushed"}]}