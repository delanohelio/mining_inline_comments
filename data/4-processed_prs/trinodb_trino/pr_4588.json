{"pr_number": 4588, "pr_title": "Change ROW representation on the client to avoid fake row field names", "pr_createdAt": "2020-07-26T20:16:21Z", "pr_url": "https://github.com/trinodb/trino/pull/4588", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5MjI0MA==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r460692240", "bodyText": "copyright", "author": "kokosing", "createdAt": "2020-07-27T07:20:04Z", "path": "presto-client/src/main/java/io/prestosql/client/RowField.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package io.prestosql.client;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5MjQ5Mw==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r460692493", "bodyText": "do you need to add product tests for cli for that?", "author": "kokosing", "createdAt": "2020-07-27T07:20:40Z", "path": "presto-cli/src/main/java/io/prestosql/cli/AlignedTablePrinter.java", "diffHunk": "@@ -18,6 +18,7 @@\n import com.google.common.collect.ImmutableList;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI1MTg3OQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r532251879", "bodyText": "do you need to add product tests for cli for that?\n\ni do not feel this is necessary, why?", "author": "findepi", "createdAt": "2020-11-29T19:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5MjQ5Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5NjM4Mg==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r472096382", "bodyText": "nit: @Nullable?", "author": "losipiuk", "createdAt": "2020-08-18T11:06:25Z", "path": "presto-client/src/main/java/io/prestosql/client/RowField.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.client;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class RowField\n+{\n+    private final int ordinal;\n+    private final Optional<String> name;\n+    private final Object value;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5ODI3NQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r472098275", "bodyText": "Do we need that?", "author": "losipiuk", "createdAt": "2020-08-18T11:10:17Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSet.java", "diffHunk": "@@ -315,27 +316,38 @@ public void testRow()\n     {\n         // named row\n         checkRepresentation(\"CAST(ROW(42, 'Presto') AS ROW(a_bigint bigint, a_varchar varchar(17)))\", Types.JAVA_OBJECT, (rs, column) -> {\n-            assertEquals(rs.getObject(column), ImmutableMap.of(\"a_bigint\", 42L, \"a_varchar\", \"Presto\"));\n-            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"a_bigint\", 42L, \"a_varchar\", \"Presto\"));\n+            assertEquals(rs.getObject(column), Row.builder()\n+                    .addField(\"a_bigint\", 42L)\n+                    .addField(\"a_varchar\", \"Presto\")\n+                    .build());\n+            // TODO assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"a_bigint\", 42L, \"a_varchar\", \"Presto\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI3NDg2Nw==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r475274867", "bodyText": "May be convenient.", "author": "findepi", "createdAt": "2020-08-23T22:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5ODI3NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MjcxOA==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530562718", "bodyText": "rnn not needed (done by copyOf)", "author": "losipiuk", "createdAt": "2020-11-25T18:11:44Z", "path": "presto-client/src/main/java/io/prestosql/client/Row.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.client;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.stream.Collectors.joining;\n+\n+public final class Row\n+{\n+    private final List<RowField> fields;\n+\n+    private Row(List<RowField> fields)\n+    {\n+        this.fields = ImmutableList.copyOf(requireNonNull(fields, \"fields is null\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0MTE2OQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530641169", "bodyText": "i have a nicer message, as i say what param is null (here there is only one, but you i do not want to change this line, if i add annother one)", "author": "findepi", "createdAt": "2020-11-25T21:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MjcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzMDc0OQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530930749", "bodyText": "True. I put a comment here mostly because we typically not do rnn if there is copyOf already.", "author": "losipiuk", "createdAt": "2020-11-26T10:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MjcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MjY3Mw==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530982673", "bodyText": "I think this depends on \"we\" :)", "author": "findepi", "createdAt": "2020-11-26T12:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MjcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2NzIxNQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530567215", "bodyText": "extract commit?", "author": "losipiuk", "createdAt": "2020-11-25T18:20:37Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -1654,17 +1743,23 @@ public void updateNClob(String columnLabel, Reader reader)\n         }\n         Object object = getObject(columnIndex);\n         if (object == null || type.isInstance(object)) {\n-            //noinspection unchecked\n-            return (T) object;\n+            return type.cast(object);\n+        }\n+        try {\n+            T converted = TYPE_CONVERSIONS.convert(object, type);\n+            verify(converted != null, \"Conversion cannot return null for non-null input, as this breask wasNull()\");\n+            return converted;\n+        }\n+        catch (NoConversionRegisteredException e) {\n+            throw new SQLException(format(\"Cannot convert an instance of %s to %s\", object.getClass(), type));\n         }\n-        throw new SQLException(format(\"Cannot convert an instance of %s to %s\", object.getClass(), type));\n     }\n \n     @Override\n     public <T> T getObject(String columnLabel, Class<T> type)\n             throws SQLException\n     {\n-        throw new SQLFeatureNotSupportedException(\"getObject\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0ODMzMg==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530648332", "bodyText": "i didn't separate it because i did not see a clean separation, as the getObject(Class) is pointless without other changes. i can still try to do it, if you want", "author": "findepi", "createdAt": "2020-11-25T21:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2NzIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2NzQ1NQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530567455", "bodyText": "first mapping is kinda unrelated. Extract commit?", "author": "losipiuk", "createdAt": "2020-11-25T18:21:10Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -118,6 +125,23 @@\n     // Since January 1, 1900 UTC is still December 31, 1899 in other zones, we are adding a 1 year margin.\n     private static final long START_OF_MODERN_ERA = new LocalDate(1901, 1, 1).toDateTimeAtStartOfDay(UTC).getMillis();\n \n+    private static final TypeConversions TYPE_CONVERSIONS =\n+            TypeConversions.builder()\n+                    .add(PrestoArray.class, List.class, array -> asList((Object[]) array.getArray()))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2OTQwNg==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530569406", "bodyText": "any guards using getTestedPrestoServerVersion needed?", "author": "losipiuk", "createdAt": "2020-11-25T18:25:23Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -541,6 +547,28 @@ public void testArray()\n     {\n         try (ConnectedStatement connectedStatement = newStatement()) {\n             checkRepresentation(connectedStatement.getStatement(), \"ARRAY[1, 2]\", Types.ARRAY, (rs, column) -> assertEquals(rs.getArray(column).getArray(), new int[] {1, 2}));\n+\n+            // array of map", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0ODY0Nw==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530648647", "bodyText": "no, as this is client-side change only", "author": "findepi", "createdAt": "2020-11-25T21:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2OTQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530571481", "bodyText": "I do not fully get this test class. How does it relate to TestJdbcResultSetCompatibilityOldServer?", "author": "losipiuk", "createdAt": "2020-11-25T18:29:30Z", "path": "presto-test-jdbc-compatibility-old-driver/src/test/java/io/prestosql/TestJdbcCompatibility.java", "diffHunk": "@@ -330,7 +330,7 @@ public void testSelectRow()\n     {\n         String query = \"SELECT CAST(ROW(1, 2e0) AS ROW(x BIGINT, y DOUBLE))\";\n         checkRepresentation(query, JAVA_OBJECT, (rs, column) -> {\n-            Map<String, Object> values = (Map<String, Object>) rs.getObject(column);\n+            Map<String, Object> values = getRowAsMap(rs, column);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0OTAwNw==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530649007", "bodyText": "TestJdbcCompatibility tests all driver (using the old version of tests) against current server\nTestJdbcResultSetCompatibilityOldServer tests current driver against old server", "author": "findepi", "createdAt": "2020-11-25T21:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2Nzk3Mg==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530667972", "bodyText": "Yeah - I meant TestJdbcResultSetCompatibilityOldDriver which also tests current server vs old driver", "author": "losipiuk", "createdAt": "2020-11-25T22:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2ODUxNQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530668515", "bodyText": "Actually what you wrote about TestJdbcCompatibilty, is claimed to be done by TJRSCOD.\nQuoting javadoc on that from TestJdbcCompatibility:\n * {@link TestJdbcResultSetCompatibilityOldDriver} in that regard is responsible for testing forward compatibility\n * as it's using old test code and old JDBC client against current server implementation.", "author": "losipiuk", "createdAt": "2020-11-25T22:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2OTUwNQ==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530669505", "bodyText": "I am not sure i understand... do you want me to do a change here?", "author": "findepi", "createdAt": "2020-11-25T22:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkyOTI5NA==", "url": "https://github.com/trinodb/trino/pull/4588#discussion_r530929294", "bodyText": "No. Just thinking loudly.", "author": "losipiuk", "createdAt": "2020-11-26T10:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MTQ4MQ=="}], "type": "inlineReview"}, {"oid": "36a166194d4002d69789d66576e5369cbf5fe8b5", "url": "https://github.com/trinodb/trino/commit/36a166194d4002d69789d66576e5369cbf5fe8b5", "message": "Support getting array as List from ResultSet", "committedDate": "2020-11-25T21:37:13Z", "type": "commit"}, {"oid": "8a1474a06d8fb6d6c86991d969cf48421c57ac2e", "url": "https://github.com/trinodb/trino/commit/8a1474a06d8fb6d6c86991d969cf48421c57ac2e", "message": "Convert array to object representation recursively\n\nBy itself this change does nothing, but prepares the structure for\nnecessary conversions in the future. See TODO comments in the code.", "committedDate": "2020-11-25T21:46:40Z", "type": "commit"}, {"oid": "e9d5e85e754cdfe27f7e77a77284e0048e23b67b", "url": "https://github.com/trinodb/trino/commit/e9d5e85e754cdfe27f7e77a77284e0048e23b67b", "message": "Change representation of ROW on the client side\n\nThis allows for representing both named and unnamed rows without having\nto assign artificial field names.", "committedDate": "2020-11-25T21:47:30Z", "type": "commit"}, {"oid": "e9d5e85e754cdfe27f7e77a77284e0048e23b67b", "url": "https://github.com/trinodb/trino/commit/e9d5e85e754cdfe27f7e77a77284e0048e23b67b", "message": "Change representation of ROW on the client side\n\nThis allows for representing both named and unnamed rows without having\nto assign artificial field names.", "committedDate": "2020-11-25T21:47:30Z", "type": "forcePushed"}, {"oid": "9fe8c256d26a7aa185f71286e5011687eef57362", "url": "https://github.com/trinodb/trino/commit/9fe8c256d26a7aa185f71286e5011687eef57362", "message": "empty", "committedDate": "2020-11-26T12:04:37Z", "type": "commit"}]}