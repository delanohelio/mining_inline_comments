{"pr_number": 3820, "pr_title": "Don't start Rubix server by default on coordinator", "pr_createdAt": "2020-05-22T11:15:30Z", "pr_url": "https://github.com/trinodb/trino/pull/3820", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MDEyNw==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429190127", "bodyText": "This means that we no longer need cache directory on coordinator if this property is set to false.\nCan you please update documentation accordingly?", "author": "losipiuk", "createdAt": "2020-05-22T11:21:34Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixConfig.java", "diffHunk": "@@ -59,6 +59,7 @@ public static ReadMode fromString(String value)\n     private String cacheLocation;\n     private int bookKeeperServerPort = CacheConfig.DEFAULT_BOOKKEEPER_SERVER_PORT;\n     private int dataTransferServerPort = CacheConfig.DEFAULT_DATA_TRANSFER_SERVER_PORT;\n+    private boolean startServerOnCoordinator;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5NDIwNw==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429194207", "bodyText": "Cache directories are still validated in setupServer, so it's still required to have cache directory on coordinator", "author": "sopel39", "createdAt": "2020-05-22T11:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MDEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MjA2Ng==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429192066", "bodyText": "The commit message is misleading. We are still startin up rubix server on coordinator to get statistics from workers.\nPlease be more specific.", "author": "losipiuk", "createdAt": "2020-05-22T11:26:20Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixInitializer.java", "diffHunk": "@@ -143,6 +153,28 @@ private void waitForCoordinator()\n     }\n \n     private void startRubix()\n+    {\n+        Configuration configuration = getRubixConfiguration();\n+\n+        MetricRegistry metricRegistry = new MetricRegistry();\n+        bookKeeperServer = new BookKeeperServer();\n+        BookKeeper bookKeeper = bookKeeperServer.startServer(configuration, metricRegistry);\n+        LocalDataTransferServer.startServer(configuration, metricRegistry, bookKeeper);\n+\n+        CachingFileSystem.setLocalBookKeeper(bookKeeper, \"catalog=\" + catalogName);\n+        log.info(\"Rubix initialized successfully\");\n+        rubixConfigurationInitializer.initializationDone();\n+    }\n+\n+    private void setupRubixMetrics()\n+    {\n+        Configuration configuration = getRubixConfiguration();\n+        bookKeeperServer = new BookKeeperServer();\n+        bookKeeperServer.setupServer(configuration, new MetricRegistry());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5NDQyMw==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429194423", "bodyText": "We don't start servers themselves. We just setup them and have metrics registered.", "author": "sopel39", "createdAt": "2020-05-22T11:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MzAzNA==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429193034", "bodyText": "I think it will be more readable if this was called from startRubix. Technically it is also starting of rubix services. We just start a subset of those on coordinator.", "author": "losipiuk", "createdAt": "2020-05-22T11:28:47Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixInitializer.java", "diffHunk": "@@ -104,6 +108,12 @@ public RubixInitializer(\n     @PostConstruct\n     public void initializeRubix()\n     {\n+        if (nodeManager.getCurrentNode().isCoordinator() && !startServerOnCoordinator) {\n+            // setup JMX metrics on master (instead of starting server) so that JMX connector can be used\n+            setupRubixMetrics();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5NDk0MQ==", "url": "https://github.com/trinodb/trino/pull/3820#discussion_r429194941", "bodyText": "I think it will be more readable if this was called from startRubix\n\nWe don't start server (no sockets are opened), we just set it up and register metrics.", "author": "sopel39", "createdAt": "2020-05-22T11:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5MzAzNA=="}], "type": "inlineReview"}, {"oid": "a846c6b0250afacdeeea294f8a1c1b28db4270c2", "url": "https://github.com/trinodb/trino/commit/a846c6b0250afacdeeea294f8a1c1b28db4270c2", "message": "Don't start Rubix server by default on coordinator\n\nIn real deployments Rubix on coordinator is not\npart of caching node pool. This pollutes coordinator\nlog with Rubix error messages whenever coordinator reads\na file (e.g ACID version file). This commit disables\ncaching on coordinator by default. Caching on coordinator\ncan still be enabled via feature toggle for development\npurpose.", "committedDate": "2020-05-22T11:42:00Z", "type": "commit"}, {"oid": "a846c6b0250afacdeeea294f8a1c1b28db4270c2", "url": "https://github.com/trinodb/trino/commit/a846c6b0250afacdeeea294f8a1c1b28db4270c2", "message": "Don't start Rubix server by default on coordinator\n\nIn real deployments Rubix on coordinator is not\npart of caching node pool. This pollutes coordinator\nlog with Rubix error messages whenever coordinator reads\na file (e.g ACID version file). This commit disables\ncaching on coordinator by default. Caching on coordinator\ncan still be enabled via feature toggle for development\npurpose.", "committedDate": "2020-05-22T11:42:00Z", "type": "forcePushed"}]}