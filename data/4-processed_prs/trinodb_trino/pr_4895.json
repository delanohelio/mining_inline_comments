{"pr_number": 4895, "pr_title": "Define product tests suites as code", "pr_createdAt": "2020-08-20T14:46:34Z", "pr_url": "https://github.com/trinodb/trino/pull/4895", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODIyNQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474058225", "bodyText": "use job or run consistently", "author": "losipiuk", "createdAt": "2020-08-20T15:10:37Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -0,0 +1,183 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.airlift.log.Logger;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentFactory;\n+import io.prestosql.tests.product.launcher.env.EnvironmentModule;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import static io.airlift.units.Duration.nanosSince;\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.System.exit;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"run\", description = \"run suite tests\")\n+public class SuiteRun\n+        implements Runnable\n+{\n+    private static final Logger log = Logger.get(SuiteRun.class);\n+\n+    private final Module additionalEnvironments;\n+    private final Module additionalSuites;\n+\n+    @Inject\n+    public SuiteRun.SuiteRunOptions suiteRunOptions = new SuiteRun.SuiteRunOptions();\n+\n+    @Inject\n+    public EnvironmentOptions environmentOptions = new EnvironmentOptions();\n+\n+    public SuiteRun(Extensions extensions)\n+    {\n+        this.additionalEnvironments = requireNonNull(extensions, \"extensions is null\").getAdditionalEnvironments();\n+        this.additionalSuites = requireNonNull(extensions, \"extensions is null\").getAdditionalSuites();\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+        runCommand(\n+                ImmutableList.<Module>builder()\n+                        .add(new LauncherModule())\n+                        .add(new SuiteModule(additionalSuites))\n+                        .add(new EnvironmentModule(additionalEnvironments))\n+                        .add(suiteRunOptions.toModule())\n+                        .add(environmentOptions.toModule())\n+                        .build(),\n+                SuiteRun.Execution.class);\n+    }\n+\n+    public static class SuiteRunOptions\n+    {\n+        @Option(name = \"--suite\", title = \"suite\", description = \"the name of the suite to run\", required = true)\n+        public String suite;\n+\n+        @Option(name = \"--suite-config\", title = \"suite-config\", description = \"the name of the suite config to use\")\n+        public String config = \"config-empty\";\n+\n+        public Module toModule()\n+        {\n+            return binder -> binder.bind(SuiteRun.SuiteRunOptions.class).toInstance(this);\n+        }\n+    }\n+\n+    public static class Execution\n+            implements Runnable\n+    {\n+        private final SuiteRunOptions suiteRunOptions;\n+        private final EnvironmentOptions environmentOptions;\n+        private final PathResolver pathResolver;\n+        private final SuiteFactory suiteFactory;\n+        private final EnvironmentFactory environmentFactory;\n+\n+        @Inject\n+        public Execution(SuiteRunOptions suiteRunOptions, EnvironmentOptions environmentOptions, PathResolver pathResolver, SuiteFactory suiteFactory, EnvironmentFactory environmentFactory)\n+        {\n+            this.suiteRunOptions = requireNonNull(suiteRunOptions, \"suiteRunOptions is null\");\n+            this.environmentOptions = requireNonNull(environmentOptions, \"environmentOptions is null\");\n+            this.pathResolver = requireNonNull(pathResolver, \"pathResolver is null\");\n+            this.suiteFactory = requireNonNull(suiteFactory, \"suiteFactory is null\");\n+            this.environmentFactory = requireNonNull(environmentFactory, \"environmentFactory is null\");\n+        }\n+\n+        @Override\n+        public void run()\n+        {\n+            Suite suite = suiteFactory.getSuite(suiteRunOptions.suite);\n+            SuiteConfig suiteConfig = suiteFactory.getSuiteConfig(suiteRunOptions.config);\n+\n+            log.info(\"Starting suite '%s' with config '%s' and jobs: \", suite.getSuiteName(), suiteConfig);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2NTg0Nw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474065847", "bodyText": "Good catch.", "author": "wendigo", "createdAt": "2020-08-20T15:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1OTAzNw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474059037", "bodyText": "Create EnvironmentOptions.copyOf method and use here", "author": "losipiuk", "createdAt": "2020-08-20T15:11:50Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -0,0 +1,183 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.airlift.log.Logger;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentFactory;\n+import io.prestosql.tests.product.launcher.env.EnvironmentModule;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import static io.airlift.units.Duration.nanosSince;\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.System.exit;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"run\", description = \"run suite tests\")\n+public class SuiteRun\n+        implements Runnable\n+{\n+    private static final Logger log = Logger.get(SuiteRun.class);\n+\n+    private final Module additionalEnvironments;\n+    private final Module additionalSuites;\n+\n+    @Inject\n+    public SuiteRun.SuiteRunOptions suiteRunOptions = new SuiteRun.SuiteRunOptions();\n+\n+    @Inject\n+    public EnvironmentOptions environmentOptions = new EnvironmentOptions();\n+\n+    public SuiteRun(Extensions extensions)\n+    {\n+        this.additionalEnvironments = requireNonNull(extensions, \"extensions is null\").getAdditionalEnvironments();\n+        this.additionalSuites = requireNonNull(extensions, \"extensions is null\").getAdditionalSuites();\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+        runCommand(\n+                ImmutableList.<Module>builder()\n+                        .add(new LauncherModule())\n+                        .add(new SuiteModule(additionalSuites))\n+                        .add(new EnvironmentModule(additionalEnvironments))\n+                        .add(suiteRunOptions.toModule())\n+                        .add(environmentOptions.toModule())\n+                        .build(),\n+                SuiteRun.Execution.class);\n+    }\n+\n+    public static class SuiteRunOptions\n+    {\n+        @Option(name = \"--suite\", title = \"suite\", description = \"the name of the suite to run\", required = true)\n+        public String suite;\n+\n+        @Option(name = \"--suite-config\", title = \"suite-config\", description = \"the name of the suite config to use\")\n+        public String config = \"config-empty\";\n+\n+        public Module toModule()\n+        {\n+            return binder -> binder.bind(SuiteRun.SuiteRunOptions.class).toInstance(this);\n+        }\n+    }\n+\n+    public static class Execution\n+            implements Runnable\n+    {\n+        private final SuiteRunOptions suiteRunOptions;\n+        private final EnvironmentOptions environmentOptions;\n+        private final PathResolver pathResolver;\n+        private final SuiteFactory suiteFactory;\n+        private final EnvironmentFactory environmentFactory;\n+\n+        @Inject\n+        public Execution(SuiteRunOptions suiteRunOptions, EnvironmentOptions environmentOptions, PathResolver pathResolver, SuiteFactory suiteFactory, EnvironmentFactory environmentFactory)\n+        {\n+            this.suiteRunOptions = requireNonNull(suiteRunOptions, \"suiteRunOptions is null\");\n+            this.environmentOptions = requireNonNull(environmentOptions, \"environmentOptions is null\");\n+            this.pathResolver = requireNonNull(pathResolver, \"pathResolver is null\");\n+            this.suiteFactory = requireNonNull(suiteFactory, \"suiteFactory is null\");\n+            this.environmentFactory = requireNonNull(environmentFactory, \"environmentFactory is null\");\n+        }\n+\n+        @Override\n+        public void run()\n+        {\n+            Suite suite = suiteFactory.getSuite(suiteRunOptions.suite);\n+            SuiteConfig suiteConfig = suiteFactory.getSuiteConfig(suiteRunOptions.config);\n+\n+            log.info(\"Starting suite '%s' with config '%s' and jobs: \", suite.getSuiteName(), suiteConfig);\n+\n+            suite.getTestRuns().forEach(job ->\n+                    log.info(\" * environment '%s': groups: %s, excluded groups: %s, tests: %s, excluded tests: %s\",\n+                            job.getEnvironmentName(), job.getGroups(), job.getExcludedGroups(), job.getTests(), job.getExcludedTests()));\n+\n+            int exitCode = 0;\n+\n+            long suiteStartTime = System.nanoTime();\n+            ImmutableList.Builder<SuiteTestRun> failedTestRuns = ImmutableList.builder();\n+\n+            for (SuiteTestRun testRun : suite.getTestRuns()) {\n+                long startTime = System.nanoTime();\n+\n+                try {\n+                    log.info(\"Starting test run %s with config %s\", testRun, suiteConfig);\n+                    tryRunSuiteJob(testRun, suiteConfig);\n+                }\n+                catch (Exception e) {\n+                    failedTestRuns.add(testRun);\n+                    log.error(\"Failed to execute test run %s\", testRun, e);\n+                    exitCode = 1;\n+                }\n+                finally {\n+                    log.info(\"Executing test run %s took %s, elapsed %s since suite started\", testRun, nanosSince(startTime), nanosSince(suiteStartTime));\n+                }\n+            }\n+\n+            if (exitCode > 0) {\n+                log.error(\"Suite failed in %s, failing test runs: %s\", nanosSince(suiteStartTime), failedTestRuns.build());\n+            }\n+            else {\n+                log.error(\"Suite succeded in %s\", nanosSince(suiteStartTime));\n+            }\n+\n+            exit(exitCode);\n+        }\n+\n+        public void tryRunSuiteJob(SuiteTestRun suiteTestRun, SuiteConfig suiteConfig)\n+        {\n+            new TestRun.Execution(environmentFactory, pathResolver, createEnvironmentOptions(environmentOptions, suiteConfig), createTestRunOptions(suiteTestRun, suiteConfig)).run();\n+        }\n+\n+        private EnvironmentOptions createEnvironmentOptions(EnvironmentOptions environmentOptions, SuiteConfig suiteConfig)\n+        {\n+            EnvironmentOptions copy = new EnvironmentOptions();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1OTk3OA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474059978", "bodyText": "drop the comments like this one eventually.", "author": "losipiuk", "createdAt": "2020-08-20T15:13:20Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteConfig.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+\n+public abstract class SuiteConfig\n+{\n+    private static final String DEFAULT_DOCKER_IMAGES_VERSION = \"30\";\n+    private static final String DEFAULT_HADOOP_BASE_IMAGE = \"prestodev/hdp2.6-hive\";\n+\n+    /**\n+     * export HADOOP_BASE_IMAGE=\"${HADOOP_BASE_IMAGE:-prestodev/hdp2.6-hive}\"\n+     */\n+    public Optional<String> getHadoopBaseImage()\n+    {\n+        return Optional.of(DEFAULT_HADOOP_BASE_IMAGE);\n+    }\n+\n+    public List<String> getExcludedGroups()\n+    {\n+        return ImmutableList.of();\n+    }\n+\n+    /**", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2NDE4MA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474064180", "bodyText": "I've kept it here for review to be simpler. I can drop them in a separate commit.", "author": "wendigo", "createdAt": "2020-08-20T15:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1OTk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2ODY3MA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474068670", "bodyText": "Do you expect someone to actually read through all the definitions ? ;)", "author": "losipiuk", "createdAt": "2020-08-20T15:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1OTk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2MjE0Mw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474062143", "bodyText": "Why do we need additionalSuites.\nCan't we just do\nMapBinder<String, Suite> suites = newMapBinder(binder, String.class, Suite.class);\nsuites.addBinding(...)\n\nin some other module if we need to extend the list?", "author": "losipiuk", "createdAt": "2020-08-20T15:16:24Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteModule.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.MapBinder;\n+\n+import static com.google.inject.multibindings.MapBinder.newMapBinder;\n+import static io.prestosql.tests.product.launcher.suite.Suites.nameForConfigClass;\n+import static io.prestosql.tests.product.launcher.suite.Suites.nameForSuiteClass;\n+import static java.util.Objects.requireNonNull;\n+\n+public final class SuiteModule\n+        implements Module\n+{\n+    public static final String BASE_SUITES_PACKAGE = \"io.prestosql.tests.product.launcher.suite\";\n+    private final Module additionalSuites;\n+\n+    public SuiteModule(Module additionalSuites)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMzgzMg==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474603832", "bodyText": "Do we need translation from suite definition to tempto options?\nI think in the suite definition we could instead:\ntestOnEnvironment(SinglenodeHiveImpersonation.class)\n        .withGroups(\"storage_formats\", \"hdfs_impersonation\")\n        .build(),\n\ndo something lower-level:\ntestOnEnvironment(SinglenodeHiveImpersonation.class)\n        .withTemptoOptions(\"-g\", \"storage_formats,hdfs_impersonation\")\n        .build(),\n\n\nthe semantic DSL is nice (so we have - on this)\nsimplicity is nice (we have + on this)\nit will allow to easily print proper test run command when suite fails (no translation here needed!)\nno change required in this class when tempto gains new options\n\nWDYT?", "author": "findepi", "createdAt": "2020-08-21T10:07:33Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteTestRun.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Splitter;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import io.prestosql.tests.product.launcher.env.EnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.Environments;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SuiteTestRun\n+{\n+    private static final String SKIP_TEST_ARGUMENT = \"DISTRO_SKIP_TEST\";\n+    private static final String SKIP_GROUP_ARGUMENT = \"DISTRO_SKIP_GROUP\";\n+\n+    private static final String TEMPTO_TEST_ARG = \"-t\";\n+    private static final String TEMPTO_GROUP_ARG = \"-g\";\n+    private static final String TEMPTO_EXCLUDE_GROUP_ARG = \"-x\";\n+    private static final String TEMPTO_EXCLUDE_TEST_ARG = \"-t\";\n+\n+    private final Class<? extends EnvironmentProvider> environment;\n+    private final List<String> groups;\n+    private final List<String> excludedGroups;\n+    private final List<String> excludedTests;\n+    private final List<String> tests;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjY0OQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474782649", "bodyText": "@findepi that has one disadvantage. Some of the suite configurations define excluded groups / tests that we need to merge with test run exclusions.\nActually I've added printing test run command with parameters for convenience \ud83d\udc4d", "author": "wendigo", "createdAt": "2020-08-21T15:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4MTkyNA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476281924", "bodyText": "and suite describe to list all test runs with corresponding configuration", "author": "wendigo", "createdAt": "2020-08-25T08:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwNjE5MA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r474606190", "bodyText": "The config-empty was called \"empty\" because it did not provide any configs, calling into defaults embedded in test run.\nAs we go more object way, we should rename it to ConfigDefault?\nMaybe we merged SuiteConfig and ConfigDefault into one class (\"ConfigDefault\" acting as a cofig and base class for config as well -- so that defaults are defaults always)", "author": "findepi", "createdAt": "2020-08-21T10:12:36Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/configs/ConfigEmpty.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite.configs;\n+\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+\n+public class ConfigEmpty", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTYzNw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r475451637", "bodyText": "both test and exclude?", "author": "losipiuk", "createdAt": "2020-08-24T09:13:40Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteTestRun.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Splitter;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import io.prestosql.tests.product.launcher.env.EnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.Environments;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SuiteTestRun\n+{\n+    private static final String SKIP_TEST_ARGUMENT = \"DISTRO_SKIP_TEST\";\n+    private static final String SKIP_GROUP_ARGUMENT = \"DISTRO_SKIP_GROUP\";\n+\n+    private static final String TEMPTO_TEST_ARG = \"-t\";\n+    private static final String TEMPTO_GROUP_ARG = \"-g\";\n+    private static final String TEMPTO_EXCLUDE_GROUP_ARG = \"-x\";\n+    private static final String TEMPTO_EXCLUDE_TEST_ARG = \"-t\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NDI2OQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r475754269", "bodyText": "woah, good catch \ud83d\udc4d", "author": "wendigo", "createdAt": "2020-08-24T16:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTYzNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1NDI1Mg==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476254252", "bodyText": "Squash with first commit?", "author": "losipiuk", "createdAt": "2020-08-25T08:02:07Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteDescribe.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import java.io.FileDescriptor;\n+import java.io.FileOutputStream;\n+import java.io.PrintStream;\n+import java.io.UnsupportedEncodingException;\n+import java.nio.charset.Charset;\n+\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"describe\", description = \"describe tests suite\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5NTA4MQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476295081", "bodyText": "Sure.", "author": "wendigo", "createdAt": "2020-08-25T09:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1NDI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1ODcxNQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476258715", "bodyText": "could you extract a few methods here to it is not indented such deeply?\nAlso we could have some simple unit test for that.", "author": "losipiuk", "createdAt": "2020-08-25T08:07:55Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/OptionsPrinter.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.airline.Arguments;\n+import io.airlift.airline.Option;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.List;\n+\n+import static java.lang.String.format;\n+\n+public final class OptionsPrinter\n+{\n+    private OptionsPrinter() {}\n+\n+    public static String toString(Object... objects)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5NTM1OQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476295359", "bodyText": "Sure. I'll add unit for that.", "author": "wendigo", "createdAt": "2020-08-25T09:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1ODcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3NjI5OQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476276299", "bodyText": "It is not obvious to me what drives the distinction whether we use Logger or PrintStream to generate output for caller.", "author": "losipiuk", "createdAt": "2020-08-25T08:36:22Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.airlift.log.Logger;\n+import io.airlift.units.Duration;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentFactory;\n+import io.prestosql.tests.product.launcher.env.EnvironmentModule;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import java.io.File;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static io.airlift.units.Duration.nanosSince;\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.System.exit;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"run\", description = \"run suite tests\")\n+public class SuiteRun\n+        implements Runnable\n+{\n+    private static final Logger log = Logger.get(SuiteRun.class);\n+\n+    private final Module additionalEnvironments;\n+    private final Module additionalSuites;\n+\n+    @Inject\n+    public SuiteRun.SuiteRunOptions suiteRunOptions = new SuiteRun.SuiteRunOptions();\n+\n+    @Inject\n+    public EnvironmentOptions environmentOptions = new EnvironmentOptions();\n+\n+    public SuiteRun(Extensions extensions)\n+    {\n+        this.additionalEnvironments = requireNonNull(extensions, \"extensions is null\").getAdditionalEnvironments();\n+        this.additionalSuites = requireNonNull(extensions, \"extensions is null\").getAdditionalSuites();\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+        Module suiteModule = new SuiteModule(additionalSuites);\n+        SuiteConfig config = getSuiteConfig(suiteModule, suiteRunOptions.config);\n+\n+        runCommand(\n+                ImmutableList.<Module>builder()\n+                        .add(new LauncherModule())\n+                        .add(suiteModule)\n+                        .add(new EnvironmentModule(additionalEnvironments))\n+                        .add(suiteRunOptions.toModule())\n+                        .add(environmentOptions.forSuiteConfig(config).toModule())\n+                        .build(),\n+                SuiteRun.Execution.class);\n+    }\n+\n+    private static SuiteConfig getSuiteConfig(Module suiteModule, String configName)\n+    {\n+        Injector injector = Guice.createInjector(suiteModule);\n+        SuiteFactory instance = injector.getInstance(SuiteFactory.class);\n+        return instance.getSuiteConfig(configName);\n+    }\n+\n+    public static class SuiteRunOptions\n+    {\n+        @Option(name = \"--suite\", title = \"suite\", description = \"the name of the suite to run\", required = true)\n+        public String suite;\n+\n+        @Option(name = \"--suite-config\", title = \"suite-config\", description = \"the name of the suite config to use\")\n+        public String config = \"config-default\";\n+\n+        @Option(name = \"--test-jar\", title = \"test jar\", description = \"path to test jar\")\n+        public File testJar = new File(\"presto-product-tests/target/presto-product-tests-${project.version}-executable.jar\");\n+\n+        public Module toModule()\n+        {\n+            return binder -> binder.bind(SuiteRun.SuiteRunOptions.class).toInstance(this);\n+        }\n+    }\n+\n+    public static class Execution\n+            implements Runnable\n+    {\n+        private final SuiteRunOptions suiteRunOptions;\n+        private final EnvironmentOptions environmentOptions;\n+        private final PathResolver pathResolver;\n+        private final SuiteFactory suiteFactory;\n+        private final EnvironmentFactory environmentFactory;\n+\n+        @Inject\n+        public Execution(SuiteRunOptions suiteRunOptions, EnvironmentOptions environmentOptions, PathResolver pathResolver, SuiteFactory suiteFactory, EnvironmentFactory environmentFactory)\n+        {\n+            this.suiteRunOptions = requireNonNull(suiteRunOptions, \"suiteRunOptions is null\");\n+            this.environmentOptions = requireNonNull(environmentOptions, \"environmentOptions is null\");\n+            this.pathResolver = requireNonNull(pathResolver, \"pathResolver is null\");\n+            this.suiteFactory = requireNonNull(suiteFactory, \"suiteFactory is null\");\n+            this.environmentFactory = requireNonNull(environmentFactory, \"environmentFactory is null\");\n+        }\n+\n+        @Override\n+        public void run()\n+        {\n+            Suite suite = suiteFactory.getSuite(suiteRunOptions.suite);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5NTk3MA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476295970", "bodyText": "Lack of logger's logger name and date - it makes copying content much easier (no need to remove prefix)", "author": "wendigo", "createdAt": "2020-08-25T09:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3NjI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3Njk1MQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476276951", "bodyText": "typo: succeeded", "author": "losipiuk", "createdAt": "2020-08-25T08:37:26Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.airlift.log.Logger;\n+import io.airlift.units.Duration;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentFactory;\n+import io.prestosql.tests.product.launcher.env.EnvironmentModule;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import java.io.File;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static io.airlift.units.Duration.nanosSince;\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.System.exit;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"run\", description = \"run suite tests\")\n+public class SuiteRun\n+        implements Runnable\n+{\n+    private static final Logger log = Logger.get(SuiteRun.class);\n+\n+    private final Module additionalEnvironments;\n+    private final Module additionalSuites;\n+\n+    @Inject\n+    public SuiteRun.SuiteRunOptions suiteRunOptions = new SuiteRun.SuiteRunOptions();\n+\n+    @Inject\n+    public EnvironmentOptions environmentOptions = new EnvironmentOptions();\n+\n+    public SuiteRun(Extensions extensions)\n+    {\n+        this.additionalEnvironments = requireNonNull(extensions, \"extensions is null\").getAdditionalEnvironments();\n+        this.additionalSuites = requireNonNull(extensions, \"extensions is null\").getAdditionalSuites();\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+        Module suiteModule = new SuiteModule(additionalSuites);\n+        SuiteConfig config = getSuiteConfig(suiteModule, suiteRunOptions.config);\n+\n+        runCommand(\n+                ImmutableList.<Module>builder()\n+                        .add(new LauncherModule())\n+                        .add(suiteModule)\n+                        .add(new EnvironmentModule(additionalEnvironments))\n+                        .add(suiteRunOptions.toModule())\n+                        .add(environmentOptions.forSuiteConfig(config).toModule())\n+                        .build(),\n+                SuiteRun.Execution.class);\n+    }\n+\n+    private static SuiteConfig getSuiteConfig(Module suiteModule, String configName)\n+    {\n+        Injector injector = Guice.createInjector(suiteModule);\n+        SuiteFactory instance = injector.getInstance(SuiteFactory.class);\n+        return instance.getSuiteConfig(configName);\n+    }\n+\n+    public static class SuiteRunOptions\n+    {\n+        @Option(name = \"--suite\", title = \"suite\", description = \"the name of the suite to run\", required = true)\n+        public String suite;\n+\n+        @Option(name = \"--suite-config\", title = \"suite-config\", description = \"the name of the suite config to use\")\n+        public String config = \"config-default\";\n+\n+        @Option(name = \"--test-jar\", title = \"test jar\", description = \"path to test jar\")\n+        public File testJar = new File(\"presto-product-tests/target/presto-product-tests-${project.version}-executable.jar\");\n+\n+        public Module toModule()\n+        {\n+            return binder -> binder.bind(SuiteRun.SuiteRunOptions.class).toInstance(this);\n+        }\n+    }\n+\n+    public static class Execution\n+            implements Runnable\n+    {\n+        private final SuiteRunOptions suiteRunOptions;\n+        private final EnvironmentOptions environmentOptions;\n+        private final PathResolver pathResolver;\n+        private final SuiteFactory suiteFactory;\n+        private final EnvironmentFactory environmentFactory;\n+\n+        @Inject\n+        public Execution(SuiteRunOptions suiteRunOptions, EnvironmentOptions environmentOptions, PathResolver pathResolver, SuiteFactory suiteFactory, EnvironmentFactory environmentFactory)\n+        {\n+            this.suiteRunOptions = requireNonNull(suiteRunOptions, \"suiteRunOptions is null\");\n+            this.environmentOptions = requireNonNull(environmentOptions, \"environmentOptions is null\");\n+            this.pathResolver = requireNonNull(pathResolver, \"pathResolver is null\");\n+            this.suiteFactory = requireNonNull(suiteFactory, \"suiteFactory is null\");\n+            this.environmentFactory = requireNonNull(environmentFactory, \"environmentFactory is null\");\n+        }\n+\n+        @Override\n+        public void run()\n+        {\n+            Suite suite = suiteFactory.getSuite(suiteRunOptions.suite);\n+            SuiteConfig suiteConfig = suiteFactory.getSuiteConfig(suiteRunOptions.config);\n+            List<SuiteTestRun> suiteTestRuns = suite.getTestRuns(suiteConfig);\n+\n+            log.info(\"Starting suite '%s' with config '%s' and test runs: \", suite.getSuiteName(), suiteConfig.getConfigName());\n+            suiteTestRuns.forEach(job ->\n+                    log.info(\" * environment '%s': groups: %s, excluded groups: %s, tests: %s, excluded tests: %s\",\n+                            job.getEnvironmentName(), job.getGroups(), job.getExcludedGroups(), job.getTests(), job.getExcludedTests()));\n+\n+            long suiteStartTime = System.nanoTime();\n+            ImmutableList.Builder<TestRunResult> results = ImmutableList.builder();\n+\n+            for (SuiteTestRun testRun : suiteTestRuns) {\n+                results.add(executeSuiteTestRun(testRun, suiteConfig));\n+            }\n+\n+            List<TestRunResult> testRunsResults = results.build();\n+            boolean allSuccessful = testRunsResults.stream()\n+                    .allMatch(TestRunResult::isSuccessful);\n+\n+            if (allSuccessful) {\n+                log.info(\"Suite succeded in %s\", nanosSince(suiteStartTime));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3ODIwMA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476278200", "bodyText": "Also please log time in something nicer than nanoseconds. Like (1h 10m 12.343s)", "author": "losipiuk", "createdAt": "2020-08-25T08:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3Njk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5OTExMw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476299113", "bodyText": "Actually it's airlift Duration's nanosSince method which returns Duration which in turn has nice toString() implementation. So nanos are not displayed here \ud83d\udc4d\ud83c\udffb", "author": "wendigo", "createdAt": "2020-08-25T09:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3Njk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3OTMyOA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476279328", "bodyText": "Handle InterruptedException", "author": "losipiuk", "createdAt": "2020-08-25T08:41:02Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/SuiteRun.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.airlift.airline.Command;\n+import io.airlift.airline.Option;\n+import io.airlift.log.Logger;\n+import io.airlift.units.Duration;\n+import io.prestosql.tests.product.launcher.Extensions;\n+import io.prestosql.tests.product.launcher.LauncherModule;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.env.EnvironmentFactory;\n+import io.prestosql.tests.product.launcher.env.EnvironmentModule;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+import io.prestosql.tests.product.launcher.suite.Suite;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n+import io.prestosql.tests.product.launcher.suite.SuiteFactory;\n+import io.prestosql.tests.product.launcher.suite.SuiteModule;\n+import io.prestosql.tests.product.launcher.suite.SuiteTestRun;\n+\n+import javax.inject.Inject;\n+\n+import java.io.File;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static io.airlift.units.Duration.nanosSince;\n+import static io.prestosql.tests.product.launcher.cli.Commands.runCommand;\n+import static java.lang.System.exit;\n+import static java.util.Objects.requireNonNull;\n+\n+@Command(name = \"run\", description = \"run suite tests\")\n+public class SuiteRun\n+        implements Runnable\n+{\n+    private static final Logger log = Logger.get(SuiteRun.class);\n+\n+    private final Module additionalEnvironments;\n+    private final Module additionalSuites;\n+\n+    @Inject\n+    public SuiteRun.SuiteRunOptions suiteRunOptions = new SuiteRun.SuiteRunOptions();\n+\n+    @Inject\n+    public EnvironmentOptions environmentOptions = new EnvironmentOptions();\n+\n+    public SuiteRun(Extensions extensions)\n+    {\n+        this.additionalEnvironments = requireNonNull(extensions, \"extensions is null\").getAdditionalEnvironments();\n+        this.additionalSuites = requireNonNull(extensions, \"extensions is null\").getAdditionalSuites();\n+    }\n+\n+    @Override\n+    public void run()\n+    {\n+        Module suiteModule = new SuiteModule(additionalSuites);\n+        SuiteConfig config = getSuiteConfig(suiteModule, suiteRunOptions.config);\n+\n+        runCommand(\n+                ImmutableList.<Module>builder()\n+                        .add(new LauncherModule())\n+                        .add(suiteModule)\n+                        .add(new EnvironmentModule(additionalEnvironments))\n+                        .add(suiteRunOptions.toModule())\n+                        .add(environmentOptions.forSuiteConfig(config).toModule())\n+                        .build(),\n+                SuiteRun.Execution.class);\n+    }\n+\n+    private static SuiteConfig getSuiteConfig(Module suiteModule, String configName)\n+    {\n+        Injector injector = Guice.createInjector(suiteModule);\n+        SuiteFactory instance = injector.getInstance(SuiteFactory.class);\n+        return instance.getSuiteConfig(configName);\n+    }\n+\n+    public static class SuiteRunOptions\n+    {\n+        @Option(name = \"--suite\", title = \"suite\", description = \"the name of the suite to run\", required = true)\n+        public String suite;\n+\n+        @Option(name = \"--suite-config\", title = \"suite-config\", description = \"the name of the suite config to use\")\n+        public String config = \"config-default\";\n+\n+        @Option(name = \"--test-jar\", title = \"test jar\", description = \"path to test jar\")\n+        public File testJar = new File(\"presto-product-tests/target/presto-product-tests-${project.version}-executable.jar\");\n+\n+        public Module toModule()\n+        {\n+            return binder -> binder.bind(SuiteRun.SuiteRunOptions.class).toInstance(this);\n+        }\n+    }\n+\n+    public static class Execution\n+            implements Runnable\n+    {\n+        private final SuiteRunOptions suiteRunOptions;\n+        private final EnvironmentOptions environmentOptions;\n+        private final PathResolver pathResolver;\n+        private final SuiteFactory suiteFactory;\n+        private final EnvironmentFactory environmentFactory;\n+\n+        @Inject\n+        public Execution(SuiteRunOptions suiteRunOptions, EnvironmentOptions environmentOptions, PathResolver pathResolver, SuiteFactory suiteFactory, EnvironmentFactory environmentFactory)\n+        {\n+            this.suiteRunOptions = requireNonNull(suiteRunOptions, \"suiteRunOptions is null\");\n+            this.environmentOptions = requireNonNull(environmentOptions, \"environmentOptions is null\");\n+            this.pathResolver = requireNonNull(pathResolver, \"pathResolver is null\");\n+            this.suiteFactory = requireNonNull(suiteFactory, \"suiteFactory is null\");\n+            this.environmentFactory = requireNonNull(environmentFactory, \"environmentFactory is null\");\n+        }\n+\n+        @Override\n+        public void run()\n+        {\n+            Suite suite = suiteFactory.getSuite(suiteRunOptions.suite);\n+            SuiteConfig suiteConfig = suiteFactory.getSuiteConfig(suiteRunOptions.config);\n+            List<SuiteTestRun> suiteTestRuns = suite.getTestRuns(suiteConfig);\n+\n+            log.info(\"Starting suite '%s' with config '%s' and test runs: \", suite.getSuiteName(), suiteConfig.getConfigName());\n+            suiteTestRuns.forEach(job ->\n+                    log.info(\" * environment '%s': groups: %s, excluded groups: %s, tests: %s, excluded tests: %s\",\n+                            job.getEnvironmentName(), job.getGroups(), job.getExcludedGroups(), job.getTests(), job.getExcludedTests()));\n+\n+            long suiteStartTime = System.nanoTime();\n+            ImmutableList.Builder<TestRunResult> results = ImmutableList.builder();\n+\n+            for (SuiteTestRun testRun : suiteTestRuns) {\n+                results.add(executeSuiteTestRun(testRun, suiteConfig));\n+            }\n+\n+            List<TestRunResult> testRunsResults = results.build();\n+            boolean allSuccessful = testRunsResults.stream()\n+                    .allMatch(TestRunResult::isSuccessful);\n+\n+            if (allSuccessful) {\n+                log.info(\"Suite succeded in %s\", nanosSince(suiteStartTime));\n+                printTestRunsSummary(testRunsResults);\n+                exit(0);\n+            }\n+\n+            log.error(\"Suite failed in %s:\", nanosSince(suiteStartTime));\n+            printTestRunsSummary(testRunsResults);\n+            exit(1);\n+        }\n+\n+        private static void printTestRunsSummary(List<TestRunResult> results)\n+        {\n+            long failedRuns = results.stream()\n+                    .filter(TestRunResult::hasFailed)\n+                    .count();\n+\n+            log.info(\"Test runs summary (%d passed, %d failed): \", results.size() - failedRuns, failedRuns);\n+            results.forEach(result -> log.info(\" * '%s' %s in %s\", result.getSuiteRun(), result.isSuccessful() ? \"PASSED\" : \"FAILED\", result.getDuration()));\n+        }\n+\n+        public TestRunResult executeSuiteTestRun(SuiteTestRun suiteTestRun, SuiteConfig suiteConfig)\n+        {\n+            log.info(\"Starting test run %s with config %s\", suiteTestRun, suiteConfig);\n+            long startTime = System.nanoTime();\n+\n+            Throwable t = null;\n+            try {\n+                TestRun.TestRunOptions testRunOptions = createTestRunOptions(suiteTestRun, suiteConfig);\n+                log.info(\"Execute this test run using:\\npresto-product-tests-launcher/bin/run-launcher test run %s\", OptionsPrinter.toString(environmentOptions, testRunOptions));\n+                new TestRun.Execution(environmentFactory, pathResolver, environmentOptions, testRunOptions).run();\n+            }\n+            catch (Exception e) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4MTI1OQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476281259", "bodyText": "When I see copyOf I expect it to be static factory method taking argument.\nAlternatively you may rename the method to getCopy() or just copy() but I prefere static factory.", "author": "losipiuk", "createdAt": "2020-08-25T08:44:08Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentOptions.java", "diffHunk": "@@ -47,13 +50,43 @@\n     @Option(name = \"--debug\", description = \"open Java debug ports\")\n     public boolean debug;\n \n+    @Option(name = \"--hadoop-init-script\", description = \"Hadoop init script\")\n+    public String hadoopInitScript = \"\";\n+\n     public Module toModule()\n     {\n         return binder -> {\n             binder.bind(EnvironmentOptions.class).toInstance(this);\n         };\n     }\n \n+    public EnvironmentOptions copyOf()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4MTcyNg==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476281726", "bodyText": "applySuiteConfig?\nOr another flavour of static copyOf taking two EnvironmentOptions source, SuiteConfig suiteConfig", "author": "losipiuk", "createdAt": "2020-08-25T08:44:52Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentOptions.java", "diffHunk": "@@ -47,13 +50,43 @@\n     @Option(name = \"--debug\", description = \"open Java debug ports\")\n     public boolean debug;\n \n+    @Option(name = \"--hadoop-init-script\", description = \"Hadoop init script\")\n+    public String hadoopInitScript = \"\";\n+\n     public Module toModule()\n     {\n         return binder -> {\n             binder.bind(EnvironmentOptions.class).toInstance(this);\n         };\n     }\n \n+    public EnvironmentOptions copyOf()\n+    {\n+        EnvironmentOptions copy = new EnvironmentOptions();\n+        copy.hadoopBaseImage = hadoopBaseImage;\n+        copy.imagesVersion = imagesVersion;\n+        copy.hadoopImagesVersion = hadoopImagesVersion;\n+        copy.temptoEnvironmentConfigFile = temptoEnvironmentConfigFile;\n+        copy.serverPackage = serverPackage;\n+        copy.withoutPrestoMaster = withoutPrestoMaster;\n+        copy.bindPorts = bindPorts;\n+        copy.debug = debug;\n+        return copy;\n+    }\n+\n+    public EnvironmentOptions forSuiteConfig(SuiteConfig suiteConfig)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4MzgxMw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476283813", "bodyText": "make ordering of constants, fields, arguments, getters, usages in toString, equals, hashCode, consistent", "author": "losipiuk", "createdAt": "2020-08-25T08:48:06Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteTestRun.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Splitter;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import io.prestosql.tests.product.launcher.env.EnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.Environments;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SuiteTestRun\n+{\n+    private static final String SKIP_TEST_ARGUMENT = \"DISTRO_SKIP_TEST\";\n+    private static final String SKIP_GROUP_ARGUMENT = \"DISTRO_SKIP_GROUP\";\n+\n+    private static final String TEMPTO_TEST_ARG = \"-t\";", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4NDcyNg==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476284726", "bodyText": "splitValueFromEnv", "author": "losipiuk", "createdAt": "2020-08-25T08:49:26Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteTestRun.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Splitter;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import io.prestosql.tests.product.launcher.env.EnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.Environments;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SuiteTestRun\n+{\n+    private static final String SKIP_TEST_ARGUMENT = \"DISTRO_SKIP_TEST\";\n+    private static final String SKIP_GROUP_ARGUMENT = \"DISTRO_SKIP_GROUP\";\n+\n+    private static final String TEMPTO_TEST_ARG = \"-t\";\n+    private static final String TEMPTO_GROUP_ARG = \"-g\";\n+    private static final String TEMPTO_EXCLUDE_GROUP_ARG = \"-x\";\n+    private static final String TEMPTO_EXCLUDE_TEST_ARG = \"-e\";\n+\n+    private final Class<? extends EnvironmentProvider> environment;\n+    private final List<String> groups;\n+    private final List<String> excludedGroups;\n+    private final List<String> excludedTests;\n+    private final List<String> tests;\n+\n+    public SuiteTestRun(Class<? extends EnvironmentProvider> environment, List<String> groups, List<String> excludedGroups, List<String> tests, List<String> excludedTests)\n+    {\n+        this.environment = requireNonNull(environment, \"environment is null\");\n+        this.groups = requireNonNull(groups, \"groups is null\");\n+        this.excludedGroups = requireNonNull(excludedGroups, \"excludedGroups is null\");\n+        this.excludedTests = requireNonNull(excludedTests, \"excludedTests is null\");\n+        this.tests = requireNonNull(tests, \"tests is null\");\n+    }\n+\n+    public Class<? extends EnvironmentProvider> getEnvironment()\n+    {\n+        return environment;\n+    }\n+\n+    public String getEnvironmentName()\n+    {\n+        return Environments.nameForClass(environment);\n+    }\n+\n+    public List<String> getGroups()\n+    {\n+        return groups;\n+    }\n+\n+    public List<String> getExcludedGroups()\n+    {\n+        return ImmutableList.<String>builder()\n+                .addAll(excludedGroups)\n+                .addAll(getSplittedEnvKey(SKIP_GROUP_ARGUMENT))\n+                .build();\n+    }\n+\n+    public List<String> getExcludedTests()\n+    {\n+        return ImmutableList.<String>builder()\n+                .addAll(excludedTests)\n+                .addAll(getSplittedEnvKey(SKIP_TEST_ARGUMENT))\n+                .build();\n+    }\n+\n+    public List<String> getTests()\n+    {\n+        return tests;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return toStringHelper(this)\n+                .add(\"environment\", Environments.nameForClass(environment))\n+                .add(\"groups\", getGroups())\n+                .add(\"excludedGroups\", getExcludedGroups())\n+                .add(\"tests\", getTests())\n+                .add(\"excludedTests\", getExcludedTests())\n+                .toString();\n+    }\n+\n+    public List<String> getTemptoRunArguments(SuiteConfig suiteConfig)\n+    {\n+        ImmutableList.Builder<String> arguments = ImmutableList.builder();\n+        Joiner joiner = Joiner.on(\",\");\n+\n+        if (!groups.isEmpty()) {\n+            arguments.add(TEMPTO_GROUP_ARG, joiner.join(groups));\n+        }\n+\n+        Iterable<String> excludedGroups = Iterables.concat(getExcludedGroups(), suiteConfig.getExcludedGroups());\n+        if (!Iterables.isEmpty(excludedGroups)) {\n+            arguments.add(TEMPTO_EXCLUDE_GROUP_ARG, joiner.join(excludedGroups));\n+        }\n+\n+        if (!tests.isEmpty()) {\n+            arguments.add(TEMPTO_TEST_ARG, joiner.join(tests));\n+        }\n+\n+        Iterable<String> excludedTests = Iterables.concat(getExcludedTests(), suiteConfig.getExcludedTests());\n+        if (!Iterables.isEmpty(excludedTests)) {\n+            arguments.add(TEMPTO_EXCLUDE_TEST_ARG, joiner.join(excludedTests));\n+        }\n+\n+        return arguments.build();\n+    }\n+\n+    public static Builder testOnEnvironment(Class<? extends EnvironmentProvider> environment)\n+    {\n+        return new Builder(environment);\n+    }\n+\n+    public static class Builder\n+    {\n+        private Class<? extends EnvironmentProvider> environment;\n+        private List<String> groups = ImmutableList.of();\n+        private List<String> excludedGroups = ImmutableList.of();\n+        private List<String> excludedTests = ImmutableList.of();\n+        private List<String> tests = ImmutableList.of();\n+\n+        private Builder(Class<? extends EnvironmentProvider> environment)\n+        {\n+            this.environment = requireNonNull(environment, \"environment is null\");\n+        }\n+\n+        public Builder withGroups(String... groups)\n+        {\n+            this.groups = ImmutableList.copyOf(groups);\n+            return this;\n+        }\n+\n+        public Builder withExcludedGroups(String... groups)\n+        {\n+            this.excludedGroups = ImmutableList.copyOf(groups);\n+            return this;\n+        }\n+\n+        public Builder withTests(String... tests)\n+        {\n+            this.tests = ImmutableList.copyOf(tests);\n+            return this;\n+        }\n+\n+        public Builder withExcludedTests(String... tests)\n+        {\n+            this.excludedTests = ImmutableList.copyOf(tests);\n+            return this;\n+        }\n+\n+        public SuiteTestRun build()\n+        {\n+            return new SuiteTestRun(environment, groups, excludedGroups, tests, excludedTests);\n+        }\n+    }\n+\n+    private static List<String> getSplittedEnvKey(String key)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI4NjQ1Ng==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476286456", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Splitter.on(',').splitToList(value);\n          \n          \n            \n                    return Splitter.on(',').trimResults().omitEmptyStrings().splitToList(value);", "author": "losipiuk", "createdAt": "2020-08-25T08:52:09Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/suite/SuiteTestRun.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.suite;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Splitter;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import io.prestosql.tests.product.launcher.env.EnvironmentProvider;\n+import io.prestosql.tests.product.launcher.env.Environments;\n+\n+import java.util.List;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SuiteTestRun\n+{\n+    private static final String SKIP_TEST_ARGUMENT = \"DISTRO_SKIP_TEST\";\n+    private static final String SKIP_GROUP_ARGUMENT = \"DISTRO_SKIP_GROUP\";\n+\n+    private static final String TEMPTO_TEST_ARG = \"-t\";\n+    private static final String TEMPTO_GROUP_ARG = \"-g\";\n+    private static final String TEMPTO_EXCLUDE_GROUP_ARG = \"-x\";\n+    private static final String TEMPTO_EXCLUDE_TEST_ARG = \"-e\";\n+\n+    private final Class<? extends EnvironmentProvider> environment;\n+    private final List<String> groups;\n+    private final List<String> excludedGroups;\n+    private final List<String> excludedTests;\n+    private final List<String> tests;\n+\n+    public SuiteTestRun(Class<? extends EnvironmentProvider> environment, List<String> groups, List<String> excludedGroups, List<String> tests, List<String> excludedTests)\n+    {\n+        this.environment = requireNonNull(environment, \"environment is null\");\n+        this.groups = requireNonNull(groups, \"groups is null\");\n+        this.excludedGroups = requireNonNull(excludedGroups, \"excludedGroups is null\");\n+        this.excludedTests = requireNonNull(excludedTests, \"excludedTests is null\");\n+        this.tests = requireNonNull(tests, \"tests is null\");\n+    }\n+\n+    public Class<? extends EnvironmentProvider> getEnvironment()\n+    {\n+        return environment;\n+    }\n+\n+    public String getEnvironmentName()\n+    {\n+        return Environments.nameForClass(environment);\n+    }\n+\n+    public List<String> getGroups()\n+    {\n+        return groups;\n+    }\n+\n+    public List<String> getExcludedGroups()\n+    {\n+        return ImmutableList.<String>builder()\n+                .addAll(excludedGroups)\n+                .addAll(getSplittedEnvKey(SKIP_GROUP_ARGUMENT))\n+                .build();\n+    }\n+\n+    public List<String> getExcludedTests()\n+    {\n+        return ImmutableList.<String>builder()\n+                .addAll(excludedTests)\n+                .addAll(getSplittedEnvKey(SKIP_TEST_ARGUMENT))\n+                .build();\n+    }\n+\n+    public List<String> getTests()\n+    {\n+        return tests;\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return toStringHelper(this)\n+                .add(\"environment\", Environments.nameForClass(environment))\n+                .add(\"groups\", getGroups())\n+                .add(\"excludedGroups\", getExcludedGroups())\n+                .add(\"tests\", getTests())\n+                .add(\"excludedTests\", getExcludedTests())\n+                .toString();\n+    }\n+\n+    public List<String> getTemptoRunArguments(SuiteConfig suiteConfig)\n+    {\n+        ImmutableList.Builder<String> arguments = ImmutableList.builder();\n+        Joiner joiner = Joiner.on(\",\");\n+\n+        if (!groups.isEmpty()) {\n+            arguments.add(TEMPTO_GROUP_ARG, joiner.join(groups));\n+        }\n+\n+        Iterable<String> excludedGroups = Iterables.concat(getExcludedGroups(), suiteConfig.getExcludedGroups());\n+        if (!Iterables.isEmpty(excludedGroups)) {\n+            arguments.add(TEMPTO_EXCLUDE_GROUP_ARG, joiner.join(excludedGroups));\n+        }\n+\n+        if (!tests.isEmpty()) {\n+            arguments.add(TEMPTO_TEST_ARG, joiner.join(tests));\n+        }\n+\n+        Iterable<String> excludedTests = Iterables.concat(getExcludedTests(), suiteConfig.getExcludedTests());\n+        if (!Iterables.isEmpty(excludedTests)) {\n+            arguments.add(TEMPTO_EXCLUDE_TEST_ARG, joiner.join(excludedTests));\n+        }\n+\n+        return arguments.build();\n+    }\n+\n+    public static Builder testOnEnvironment(Class<? extends EnvironmentProvider> environment)\n+    {\n+        return new Builder(environment);\n+    }\n+\n+    public static class Builder\n+    {\n+        private Class<? extends EnvironmentProvider> environment;\n+        private List<String> groups = ImmutableList.of();\n+        private List<String> excludedGroups = ImmutableList.of();\n+        private List<String> excludedTests = ImmutableList.of();\n+        private List<String> tests = ImmutableList.of();\n+\n+        private Builder(Class<? extends EnvironmentProvider> environment)\n+        {\n+            this.environment = requireNonNull(environment, \"environment is null\");\n+        }\n+\n+        public Builder withGroups(String... groups)\n+        {\n+            this.groups = ImmutableList.copyOf(groups);\n+            return this;\n+        }\n+\n+        public Builder withExcludedGroups(String... groups)\n+        {\n+            this.excludedGroups = ImmutableList.copyOf(groups);\n+            return this;\n+        }\n+\n+        public Builder withTests(String... tests)\n+        {\n+            this.tests = ImmutableList.copyOf(tests);\n+            return this;\n+        }\n+\n+        public Builder withExcludedTests(String... tests)\n+        {\n+            this.excludedTests = ImmutableList.copyOf(tests);\n+            return this;\n+        }\n+\n+        public SuiteTestRun build()\n+        {\n+            return new SuiteTestRun(environment, groups, excludedGroups, tests, excludedTests);\n+        }\n+    }\n+\n+    private static List<String> getSplittedEnvKey(String key)\n+    {\n+        String value = System.getenv(key);\n+\n+        if (Strings.isNullOrEmpty(value)) {\n+            return ImmutableList.of();\n+        }\n+\n+        return Splitter.on(',').splitToList(value);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5Mjk1OA==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476292958", "bodyText": "why do we need those getters after this change? Can't we just use constants?", "author": "losipiuk", "createdAt": "2020-08-25T09:01:31Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentDefaults.java", "diffHunk": "@@ -13,8 +13,6 @@\n  */\n package io.prestosql.tests.product.launcher.env;\n \n-import static java.lang.System.getenv;\n-\n public class EnvironmentDefaults\n {\n     public static final String DOCKER_IMAGES_VERSION = \"31\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwOTY0Nw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476309647", "bodyText": "Good point. Removing.", "author": "wendigo", "createdAt": "2020-08-25T09:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5Mjk1OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NDQyMQ==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476354421", "bodyText": "why so?", "author": "losipiuk", "createdAt": "2020-08-25T10:46:21Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentOptions.java", "diffHunk": "@@ -15,25 +15,28 @@\n \n import com.google.inject.Module;\n import io.airlift.airline.Option;\n+import io.prestosql.tests.product.launcher.PathResolver;\n+import io.prestosql.tests.product.launcher.suite.SuiteConfig;\n \n import java.io.File;\n import java.util.Locale;\n \n import static com.google.common.base.MoreObjects.firstNonNull;\n import static java.util.Objects.requireNonNull;\n \n-public final class EnvironmentOptions", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NzU3Mg==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476357572", "bodyText": "Sneaked through the trenches. Sorry :)", "author": "wendigo", "createdAt": "2020-08-25T10:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NDQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NDY5Nw==", "url": "https://github.com/trinodb/trino/pull/4895#discussion_r476354697", "bodyText": "drop this one", "author": "losipiuk", "createdAt": "2020-08-25T10:46:57Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/OptionsPrinter.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.cli;\n+\n+import com.google.common.base.Joiner;\n+import io.airlift.airline.Arguments;\n+import io.airlift.airline.Option;\n+\n+import java.lang.reflect.Field;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import static java.lang.reflect.Modifier.isPublic;\n+import static java.lang.reflect.Modifier.isStatic;\n+import static java.util.Arrays.stream;\n+import static java.util.stream.Collectors.toList;\n+\n+public final class OptionsPrinter\n+{\n+    private static final Joiner JOINER = Joiner.on(\" \\\\\\n\")\n+            .skipNulls();\n+\n+    private OptionsPrinter() {}\n+\n+    public static String format(Object... objects)\n+    {\n+        List<String> arguments = stream(objects)\n+                .map(OptionsPrinter::extractArguments)\n+                .flatMap(Collection::stream)\n+                .collect(toList());\n+\n+        return JOINER.join(arguments);\n+    }\n+\n+    public static String format(Object object)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc0be89b671b40f607e8f3896add74836fa80506", "url": "https://github.com/trinodb/trino/commit/fc0be89b671b40f607e8f3896add74836fa80506", "message": "Product tests suite definitions as code", "committedDate": "2020-08-25T11:06:22Z", "type": "commit"}, {"oid": "e20c1cc0c31e3cef76081235cab655026cde8c42", "url": "https://github.com/trinodb/trino/commit/e20c1cc0c31e3cef76081235cab655026cde8c42", "message": "Remove product tests scripts", "committedDate": "2020-08-25T11:06:22Z", "type": "commit"}, {"oid": "3c290da60018da1416f48ef03691d29975e22243", "url": "https://github.com/trinodb/trino/commit/3c290da60018da1416f48ef03691d29975e22243", "message": "Change reports dir to contain suite, config and environment name", "committedDate": "2020-08-25T11:07:03Z", "type": "commit"}, {"oid": "9e5f04c178d1e2c50790f2e270703d05476a5fd1", "url": "https://github.com/trinodb/trino/commit/9e5f04c178d1e2c50790f2e270703d05476a5fd1", "message": "Remove passing of environment settings using ENV", "committedDate": "2020-08-25T11:07:03Z", "type": "commit"}, {"oid": "10d9cd0f26c5cc75989778b9140bc38891016c2e", "url": "https://github.com/trinodb/trino/commit/10d9cd0f26c5cc75989778b9140bc38891016c2e", "message": "Debug failed environments", "committedDate": "2020-08-25T11:07:03Z", "type": "commit"}, {"oid": "10d9cd0f26c5cc75989778b9140bc38891016c2e", "url": "https://github.com/trinodb/trino/commit/10d9cd0f26c5cc75989778b9140bc38891016c2e", "message": "Debug failed environments", "committedDate": "2020-08-25T11:07:03Z", "type": "forcePushed"}]}