{"pr_number": 4424, "pr_title": "Change Iceberg to use the new ParquetFileWriter", "pr_createdAt": "2020-07-11T04:44:24Z", "pr_url": "https://github.com/trinodb/trino/pull/4424", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0MzMzMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r456043332", "bodyText": "Rename test databases to prevent name collisions\n\n-> Rename test tables ...", "author": "findepi", "createdAt": "2020-07-16T19:59:48Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveCreateExternalTable.java", "diffHunk": "@@ -54,22 +54,22 @@ public void testCreateExternalTableWithData()\n         File tableLocation = new File(tempDir, \"data\");\n \n         @Language(\"SQL\") String createTableSql = format(\"\" +\n-                        \"CREATE TABLE test_create_external \" +\n+                        \"CREATE TABLE test_create_external_with_data \" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkzNTY5NA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r456935694", "bodyText": "Doh, good point - - It was the tables that were renamed.\nI just rebased this PR on tip master, since there were conflicts and removed the commit that renamed the tables.  If the Hive test failures recur, I'll submit a separate PR with the renames.", "author": "djsstarburst", "createdAt": "2020-07-19T17:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0MzMzMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxNzU1NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457617555", "bodyText": "Keep this private. See comment on the usage below.", "author": "electrum", "createdAt": "2020-07-20T18:44:21Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/parquet/ParquetFileWriterFactory.java", "diffHunk": "@@ -136,7 +141,7 @@ public ParquetFileWriterFactory(\n         }\n     }\n \n-    private static CompressionCodecName getCompression(JobConf configuration)\n+    public static CompressionCodecName getCompression(JobConf configuration)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjA0MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732040", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-20T22:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxNzU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxODczNA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457618734", "bodyText": "These properties are for the Hive writer. Remove this and inline the code below to directly create the column names and types. We don't need to go to/from Hive properties.", "author": "electrum", "createdAt": "2020-07-20T18:46:28Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjA2MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732060", "bodyText": "Removed.  Much nicer!", "author": "djsstarburst", "createdAt": "2020-07-20T22:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxODczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxOTA2NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457619065", "bodyText": "This is not needed, as it's for the Hive writer.\njobConf is now only needed for the hdfsEnvironment.getFileSystem() call.", "author": "electrum", "createdAt": "2020-07-20T18:47:06Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();\n         properties.setProperty(IOConstants.COLUMNS, columns.stream()\n                 .map(IcebergColumnHandle::getName)\n                 .collect(joining(\",\")));\n+\n         properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n                 .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n                 .collect(joining(\":\")));\n \n         setParquetSchema(jobConf, convert(icebergSchema, \"table\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjExNg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732116", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-07-20T22:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxOTA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxOTQ4MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457619480", "bodyText": "Also not needed. Replace below with\nCompressionCodecName compressionCodecName = getCompressionCodec(session).getParquetCompressionCodec()\nAnd probably just inline that into the new IcebergParquetFileWriter() call", "author": "electrum", "createdAt": "2020-07-20T18:47:50Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();\n         properties.setProperty(IOConstants.COLUMNS, columns.stream()\n                 .map(IcebergColumnHandle::getName)\n                 .collect(joining(\",\")));\n+\n         properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n                 .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n                 .collect(joining(\":\")));\n \n         setParquetSchema(jobConf, convert(icebergSchema, \"table\"));\n         jobConf.set(ParquetOutputFormat.COMPRESSION, getCompressionCodec(session).getParquetCompressionCodec().name());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjE0Mg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732142", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-20T22:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxOTQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0MTU1NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457641555", "bodyText": "This should be IcebergSessionProperties (we can static import the methods). Looks like the properties were added, but not the static methods, so we'll need to add those there.", "author": "electrum", "createdAt": "2020-07-20T19:28:42Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjE3MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732171", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-20T22:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0MTU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0MzAwMQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457643001", "bodyText": "Now that we have a writer for both formats, we could move the code from IcebergPageSink.getMetrics() here and make getMetrics() return just Metrics (non-optional).\nLater, we'll replace it with code to return statistics directly from the writer, rather than reading them again from the written file.", "author": "electrum", "createdAt": "2020-07-20T19:31:30Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -226,4 +277,34 @@ private IcebergFileWriter createOrcWriter(\n             throw new PrestoException(ICEBERG_WRITER_OPEN_ERROR, \"Error creating ORC file\", e);\n         }\n     }\n+\n+    public static class IcebergParquetFileWriter\n+            extends ParquetFileWriter implements IcebergFileWriter\n+    {\n+        public IcebergParquetFileWriter(\n+                OutputStream outputStream,\n+                Callable<Void> rollbackAction,\n+                List<Type> fileColumnTypes,\n+                MessageType messageType,\n+                Map<List<String>, Type> primitiveTypes,\n+                ParquetWriterOptions parquetWriterOptions,\n+                int[] fileInputColumnIndexes,\n+                CompressionCodecName compressionCodecName)\n+        {\n+            super(outputStream,\n+                    rollbackAction,\n+                    fileColumnTypes,\n+                    messageType,\n+                    primitiveTypes,\n+                    parquetWriterOptions,\n+                    fileInputColumnIndexes,\n+                    compressionCodecName);\n+        }\n+\n+        @Override\n+        public Optional<Metrics> getMetrics()\n+        {\n+            return Optional.empty();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDU4MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790580", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0MzAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1ODAzOQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457658039", "bodyText": "Let's make this a top level class to mirror IcebergOrcFileWriter", "author": "electrum", "createdAt": "2020-07-20T20:00:07Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -226,4 +277,34 @@ private IcebergFileWriter createOrcWriter(\n             throw new PrestoException(ICEBERG_WRITER_OPEN_ERROR, \"Error creating ORC file\", e);\n         }\n     }\n+\n+    public static class IcebergParquetFileWriter", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDYwMw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790603", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1ODAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1ODE2NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457658165", "bodyText": "Formatting: implements on separate line", "author": "electrum", "createdAt": "2020-07-20T20:00:21Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -226,4 +277,34 @@ private IcebergFileWriter createOrcWriter(\n             throw new PrestoException(ICEBERG_WRITER_OPEN_ERROR, \"Error creating ORC file\", e);\n         }\n     }\n+\n+    public static class IcebergParquetFileWriter\n+            extends ParquetFileWriter implements IcebergFileWriter", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDYxNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790615", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1ODE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MDQ2MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457670460", "bodyText": "ICEBERG_WRITER_OPEN_ERROR", "author": "electrum", "createdAt": "2020-07-20T20:24:40Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();\n         properties.setProperty(IOConstants.COLUMNS, columns.stream()\n                 .map(IcebergColumnHandle::getName)\n                 .collect(joining(\",\")));\n+\n         properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n                 .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n                 .collect(joining(\":\")));\n \n         setParquetSchema(jobConf, convert(icebergSchema, \"table\"));\n         jobConf.set(ParquetOutputFormat.COMPRESSION, getCompressionCodec(session).getParquetCompressionCodec().name());\n \n-        return new IcebergRecordFileWriter(\n-                outputPath,\n-                columns.stream()\n-                        .map(IcebergColumnHandle::getName)\n-                        .collect(toImmutableList()),\n-                fromHiveStorageFormat(HiveStorageFormat.PARQUET),\n-                properties,\n-                HiveStorageFormat.PARQUET.getEstimatedWriterSystemMemoryUsage(),\n-                jobConf,\n-                typeManager,\n-                session);\n+        StorageFormat storageFormat = fromHiveStorageFormat(HiveStorageFormat.PARQUET);\n+        checkArgument(MapredParquetOutputFormat.class.getName().equals(storageFormat.getOutputFormat()), \"The storage format shoud be Parquet, but is not\");\n+\n+        CompressionCodecName compressionCodecName = getCompression(jobConf);\n+\n+        List<String> fileColumnNames = getColumnNames(properties);\n+        List<Type> fileColumnTypes = getColumnTypes(properties).stream()\n+                .map(hiveType -> hiveType.getType(typeManager))\n+                .collect(toList());\n+\n+        List<String> inputColumnNames = columns.stream()\n+                .map(IcebergColumnHandle::getName)\n+                .collect(Collectors.toList());\n+\n+        int[] fileInputColumnIndexes = fileColumnNames.stream()\n+                .mapToInt(inputColumnNames::indexOf)\n+                .toArray();\n+\n+        try {\n+            FileSystem fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), outputPath, jobConf);\n+\n+            Callable<Void> rollbackAction = () -> {\n+                fileSystem.delete(outputPath, false);\n+                return null;\n+            };\n+\n+            ParquetSchemaConverter schemaConverter = new ParquetSchemaConverter(fileColumnTypes, fileColumnNames, IcebergParquetPrimitiveTypeConverter.INSTANCE);\n+\n+            return new IcebergParquetFileWriter(\n+                    fileSystem.create(outputPath),\n+                    rollbackAction,\n+                    fileColumnTypes,\n+                    convert(icebergSchema, \"table\"),\n+                    schemaConverter.getPrimitiveTypes(),\n+                    parquetWriterOptions,\n+                    fileInputColumnIndexes,\n+                    compressionCodecName);\n+        }\n+        catch (IOException e) {\n+            throw new PrestoException(HIVE_WRITER_OPEN_ERROR, \"Error creating Parquet file\", e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDYyMw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790623", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MDQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTcyOA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457671728", "bodyText": "We shouldn't need both inputColumnNames and fileColumnNames as these should be identical.", "author": "electrum", "createdAt": "2020-07-20T20:26:57Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();\n         properties.setProperty(IOConstants.COLUMNS, columns.stream()\n                 .map(IcebergColumnHandle::getName)\n                 .collect(joining(\",\")));\n+\n         properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n                 .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n                 .collect(joining(\":\")));\n \n         setParquetSchema(jobConf, convert(icebergSchema, \"table\"));\n         jobConf.set(ParquetOutputFormat.COMPRESSION, getCompressionCodec(session).getParquetCompressionCodec().name());\n \n-        return new IcebergRecordFileWriter(\n-                outputPath,\n-                columns.stream()\n-                        .map(IcebergColumnHandle::getName)\n-                        .collect(toImmutableList()),\n-                fromHiveStorageFormat(HiveStorageFormat.PARQUET),\n-                properties,\n-                HiveStorageFormat.PARQUET.getEstimatedWriterSystemMemoryUsage(),\n-                jobConf,\n-                typeManager,\n-                session);\n+        StorageFormat storageFormat = fromHiveStorageFormat(HiveStorageFormat.PARQUET);\n+        checkArgument(MapredParquetOutputFormat.class.getName().equals(storageFormat.getOutputFormat()), \"The storage format shoud be Parquet, but is not\");\n+\n+        CompressionCodecName compressionCodecName = getCompression(jobConf);\n+\n+        List<String> fileColumnNames = getColumnNames(properties);\n+        List<Type> fileColumnTypes = getColumnTypes(properties).stream()\n+                .map(hiveType -> hiveType.getType(typeManager))\n+                .collect(toList());\n+\n+        List<String> inputColumnNames = columns.stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDYzNg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790636", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MjkwMA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457672900", "bodyText": "We can replace this with\nIntStream.range(0, fileColumnNames.size()).toArray()\nSame as ORC writer", "author": "electrum", "createdAt": "2020-07-20T20:29:22Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +148,64 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n+        ParquetWriterOptions parquetWriterOptions = ParquetWriterOptions.builder()\n+                .setMaxPageSize(HiveSessionProperties.getParquetWriterPageSize(session))\n+                .setMaxBlockSize(HiveSessionProperties.getParquetWriterBlockSize(session))\n+                .build();\n+\n         Properties properties = new Properties();\n         properties.setProperty(IOConstants.COLUMNS, columns.stream()\n                 .map(IcebergColumnHandle::getName)\n                 .collect(joining(\",\")));\n+\n         properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n                 .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n                 .collect(joining(\":\")));\n \n         setParquetSchema(jobConf, convert(icebergSchema, \"table\"));\n         jobConf.set(ParquetOutputFormat.COMPRESSION, getCompressionCodec(session).getParquetCompressionCodec().name());\n \n-        return new IcebergRecordFileWriter(\n-                outputPath,\n-                columns.stream()\n-                        .map(IcebergColumnHandle::getName)\n-                        .collect(toImmutableList()),\n-                fromHiveStorageFormat(HiveStorageFormat.PARQUET),\n-                properties,\n-                HiveStorageFormat.PARQUET.getEstimatedWriterSystemMemoryUsage(),\n-                jobConf,\n-                typeManager,\n-                session);\n+        StorageFormat storageFormat = fromHiveStorageFormat(HiveStorageFormat.PARQUET);\n+        checkArgument(MapredParquetOutputFormat.class.getName().equals(storageFormat.getOutputFormat()), \"The storage format shoud be Parquet, but is not\");\n+\n+        CompressionCodecName compressionCodecName = getCompression(jobConf);\n+\n+        List<String> fileColumnNames = getColumnNames(properties);\n+        List<Type> fileColumnTypes = getColumnTypes(properties).stream()\n+                .map(hiveType -> hiveType.getType(typeManager))\n+                .collect(toList());\n+\n+        List<String> inputColumnNames = columns.stream()\n+                .map(IcebergColumnHandle::getName)\n+                .collect(Collectors.toList());\n+\n+        int[] fileInputColumnIndexes = fileColumnNames.stream()\n+                .mapToInt(inputColumnNames::indexOf)\n+                .toArray();\n+\n+        try {\n+            FileSystem fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), outputPath, jobConf);\n+\n+            Callable<Void> rollbackAction = () -> {\n+                fileSystem.delete(outputPath, false);\n+                return null;\n+            };\n+\n+            ParquetSchemaConverter schemaConverter = new ParquetSchemaConverter(fileColumnTypes, fileColumnNames, IcebergParquetPrimitiveTypeConverter.INSTANCE);\n+\n+            return new IcebergParquetFileWriter(\n+                    fileSystem.create(outputPath),\n+                    rollbackAction,\n+                    fileColumnTypes,\n+                    convert(icebergSchema, \"table\"),\n+                    schemaConverter.getPrimitiveTypes(),\n+                    parquetWriterOptions,\n+                    fileInputColumnIndexes,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDY0NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790645", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MjkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTQ5Mg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457675492", "bodyText": "Import PrimitiveTypeName directly for readability", "author": "electrum", "createdAt": "2020-07-20T20:34:36Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3OTk3Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457679976", "bodyText": "Use Types.optional() instead of primitive() everywhere", "author": "electrum", "createdAt": "2020-07-20T20:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDY1Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790656", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTc1Nw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457675757", "bodyText": "Move above so it's next to the other integer types", "author": "electrum", "createdAt": "2020-07-20T20:35:03Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                    .as(dateType())\n+                    .named(name);\n+        }\n+        if (BIGINT.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDY2NA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790664", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTg5MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457675891", "bodyText": "Move these to be after integer types", "author": "electrum", "createdAt": "2020-07-20T20:35:18Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                    .as(dateType())\n+                    .named(name);\n+        }\n+        if (BIGINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(intType(64, true))\n+                    .named(name);\n+        }\n+        if (TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timestampType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (TIME.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timeType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (DOUBLE.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDY4MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790681", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NTg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjAxMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457676012", "bodyText": "Static import REAL", "author": "electrum", "createdAt": "2020-07-20T20:35:30Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                    .as(dateType())\n+                    .named(name);\n+        }\n+        if (BIGINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(intType(64, true))\n+                    .named(name);\n+        }\n+        if (TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timestampType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (TIME.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timeType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDcwNA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790704", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjMzOQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457676339", "bodyText": "No need for format here since it's just a concat to the end\nthrow new PrestoException(NOT_SUPPORTED, \"Unsupported primitive type: \" + type);", "author": "electrum", "createdAt": "2020-07-20T20:36:14Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                    .as(dateType())\n+                    .named(name);\n+        }\n+        if (BIGINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(intType(64, true))\n+                    .named(name);\n+        }\n+        if (TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timestampType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (TIME.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timeType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.FLOAT, OPTIONAL).named(name);\n+        }\n+        if (type instanceof VarcharType || type instanceof CharType || type instanceof VarbinaryType) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BINARY, OPTIONAL).named(name);\n+        }\n+        throw new PrestoException(NOT_SUPPORTED, format(\"Unsupported primitive type: %s\", type));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDcyNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790725", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjgyMw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457676823", "bodyText": "Should these be as(intType(..., true)) with 8/16/32?", "author": "electrum", "createdAt": "2020-07-20T20:37:09Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDczNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790735", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3NjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3ODAxNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457678015", "bodyText": "char and varchar should have stringType() logical type", "author": "electrum", "createdAt": "2020-07-20T20:39:24Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                    .as(dateType())\n+                    .named(name);\n+        }\n+        if (BIGINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(intType(64, true))\n+                    .named(name);\n+        }\n+        if (TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timestampType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (TIME.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL)\n+                    .as(timeType(false, LogicalTypeAnnotation.TimeUnit.MICROS))\n+                    .named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.FLOAT, OPTIONAL).named(name);\n+        }\n+        if (type instanceof VarcharType || type instanceof CharType || type instanceof VarbinaryType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDc1MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790750", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3ODAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3OTI3OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457679279", "bodyText": "I think we could split out the name part. This would make the code a bit simpler and enforce that we always set a name.\npublic Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n{\n    return primitive(type).named(name);\n}\n\nprivate PrimitiveBuilder<PrimitiveType> primitive(io.prestosql.spi.type.Type type) { ... }", "author": "electrum", "createdAt": "2020-07-20T20:41:58Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDc2MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790761", "bodyText": "Changed, and a very nice cleanup!", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3OTI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDI0NA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457680244", "bodyText": "Use decimalType here", "author": "electrum", "createdAt": "2020-07-20T20:43:50Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(decimalRequiredBytes(((DecimalType) type).getPrecision()))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDc3Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790776", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDM0NA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457680344", "bodyText": "The \"else\" is redundant", "author": "electrum", "createdAt": "2020-07-20T20:44:00Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()))\n+                        .named(name);\n+            }\n+            else if (decimalType.isShort()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MTg3OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457681879", "bodyText": "Maybe use getPrecision() <= 18 here since that matches the Iceberg spec. We aren't using ShortDecimalType here, so at this point the fact that isShort() == 18 is somewhat of a coincidence.", "author": "electrum", "createdAt": "2020-07-20T20:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDc5NA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790794", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTA1OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457685059", "bodyText": "We like to write empty methods like\nprivate IcebergParquetPrimitiveTypeConverter() {}", "author": "electrum", "createdAt": "2020-07-20T20:53:16Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDgxMQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790811", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTg0MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457685840", "bodyText": "Use optional() instead of primitive()", "author": "electrum", "createdAt": "2020-07-20T20:54:44Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDgzNA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790834", "bodyText": "This and the other comment on HiveParquetPrimitiveTypeConverter were superseded by using the Hive intrinsic schema converter.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTk0OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457685949", "bodyText": "I'd use <= 18 for readability", "author": "electrum", "createdAt": "2020-07-20T20:54:56Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else if (decimalType.isShort()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDg0OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790849", "bodyText": "Superseded.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NjEwMQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457686101", "bodyText": "OriginalType is deprecated, switch to LogicalTypeAnnotation", "author": "electrum", "createdAt": "2020-07-20T20:55:13Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDg2NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790865", "bodyText": "Superseded.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NjEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NjE5MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457686191", "bodyText": "Put named() on next line for these", "author": "electrum", "createdAt": "2020-07-20T20:55:22Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NjU0Mw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457686543", "bodyText": "Static import", "author": "electrum", "createdAt": "2020-07-20T20:56:02Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(PRECISION_TO_BYTE_COUNT[decimalType.getPrecision() - 1])\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32).as(OriginalType.DATE).named(name);\n+        }\n+        if (BIGINT.equals(type) || TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL).named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4Nzc3MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457687771", "bodyText": "Like Iceberg, based on my reading of org.apache.hadoop.hive.ql.io.parquet.convert.HiveSchemaConverter, the char and varchar types should use as(stringType())", "author": "electrum", "createdAt": "2020-07-20T20:58:22Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(PRECISION_TO_BYTE_COUNT[decimalType.getPrecision() - 1])\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32).as(OriginalType.DATE).named(name);\n+        }\n+        if (BIGINT.equals(type) || TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL).named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.FLOAT, OPTIONAL).named(name);\n+        }\n+        if (type instanceof VarcharType || type instanceof CharType || type instanceof VarbinaryType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDg4Mg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790882", "bodyText": "Superseded.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4Nzc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4OTkwOQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457689909", "bodyText": "Same as Iceberg, these and bigint should have as(intType(..., true))", "author": "electrum", "createdAt": "2020-07-20T21:02:24Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MDg5MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457790891", "bodyText": "Superseded.", "author": "djsstarburst", "createdAt": "2020-07-21T01:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4OTkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDMxNw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457690317", "bodyText": "Add a comment\n// this should match org.apache.hadoop.hive.ql.io.parquet.convert.HiveSchemaConverter", "author": "electrum", "createdAt": "2020-07-20T21:03:16Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjIwOQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732209", "bodyText": "Added.", "author": "djsstarburst", "createdAt": "2020-07-20T22:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDQ4Mw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457690483", "bodyText": "private HiveParquetPrimitiveTypeConverter() {}", "author": "electrum", "createdAt": "2020-07-20T21:03:38Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjI0Nw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732247", "bodyText": "Good to know about that exception to the opening brace newline convention!", "author": "djsstarburst", "createdAt": "2020-07-20T22:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDcwMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457690702", "bodyText": "throw new PrestoException(NOT_SUPPORTED, \"Unsupported primitive type: \" + type);", "author": "electrum", "createdAt": "2020-07-20T21:04:05Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer;\n+\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter()\n+    {\n+    }\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BOOLEAN, OPTIONAL).named(name);\n+        }\n+        if (INTEGER.equals(type) || SMALLINT.equals(type) || TINYINT.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT32, OPTIONAL).named(name);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT32)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else if (decimalType.isShort()) {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.INT64)\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+            else {\n+                return Types.optional(PrimitiveType.PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                        .length(PRECISION_TO_BYTE_COUNT[decimalType.getPrecision() - 1])\n+                        .as(OriginalType.DECIMAL)\n+                        .precision(decimalType.getPrecision())\n+                        .scale(decimalType.getScale()).named(name);\n+            }\n+        }\n+        if (DATE.equals(type)) {\n+            return Types.optional(PrimitiveType.PrimitiveTypeName.INT32).as(OriginalType.DATE).named(name);\n+        }\n+        if (BIGINT.equals(type) || TIMESTAMP.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.INT64, OPTIONAL).named(name);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.DOUBLE, OPTIONAL).named(name);\n+        }\n+        if (RealType.REAL.equals(type)) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.FLOAT, OPTIONAL).named(name);\n+        }\n+        if (type instanceof VarcharType || type instanceof CharType || type instanceof VarbinaryType) {\n+            return Types.primitive(PrimitiveType.PrimitiveTypeName.BINARY, OPTIONAL).named(name);\n+        }\n+        throw new PrestoException(NOT_SUPPORTED, format(\"Unsupported primitive type: %s\", type));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjMwMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732302", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-20T22:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDk1Mg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457690952", "bodyText": "this.primitiveTypeConverter = requireNonNull(primitiveTypeConverter, \"primitiveTypeConverter is null\");", "author": "electrum", "createdAt": "2020-07-20T21:04:38Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/ParquetSchemaConverter.java", "diffHunk": "@@ -14,53 +14,42 @@\n package io.prestosql.parquet.writer;\n \n import com.google.common.collect.ImmutableList;\n-import io.prestosql.spi.PrestoException;\n import io.prestosql.spi.type.ArrayType;\n-import io.prestosql.spi.type.CharType;\n-import io.prestosql.spi.type.DecimalType;\n import io.prestosql.spi.type.MapType;\n-import io.prestosql.spi.type.RealType;\n import io.prestosql.spi.type.RowType;\n import io.prestosql.spi.type.Type;\n-import io.prestosql.spi.type.VarbinaryType;\n-import io.prestosql.spi.type.VarcharType;\n import org.apache.parquet.schema.GroupType;\n import org.apache.parquet.schema.MessageType;\n-import org.apache.parquet.schema.OriginalType;\n-import org.apache.parquet.schema.PrimitiveType;\n import org.apache.parquet.schema.Types;\n \n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n-import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n-import static io.prestosql.spi.type.BigintType.BIGINT;\n-import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n-import static io.prestosql.spi.type.DateType.DATE;\n-import static io.prestosql.spi.type.DoubleType.DOUBLE;\n-import static io.prestosql.spi.type.IntegerType.INTEGER;\n-import static io.prestosql.spi.type.SmallintType.SMALLINT;\n import static io.prestosql.spi.type.StandardTypes.ARRAY;\n import static io.prestosql.spi.type.StandardTypes.MAP;\n import static io.prestosql.spi.type.StandardTypes.ROW;\n-import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n-import static io.prestosql.spi.type.TinyintType.TINYINT;\n-import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n import static org.apache.parquet.Preconditions.checkArgument;\n import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n \n public class ParquetSchemaConverter\n {\n-    private Map<List<String>, Type> primitiveTypes = new HashMap<>();\n+    private final PrimitiveTypeConverter primitiveTypeConverter;\n+    private final Map<List<String>, Type> primitiveTypes = new HashMap<>();\n     private final MessageType messageType;\n \n     public ParquetSchemaConverter(List<Type> types, List<String> columnNames)\n+    {\n+        this(types, columnNames, HiveParquetPrimitiveTypeConverter.INSTANCE);\n+    }\n+\n+    public ParquetSchemaConverter(List<Type> types, List<String> columnNames, PrimitiveTypeConverter primitiveTypeConverter)\n     {\n         requireNonNull(types, \"types is null\");\n         requireNonNull(columnNames, \"columnNames is null\");\n         checkArgument(types.size() == columnNames.size(), \"types size not equals to columnNames size\");\n+        this.primitiveTypeConverter = primitiveTypeConverter;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjMzNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732335", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-07-20T22:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MDk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MTUzMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457691532", "bodyText": "It's better if presto-parquet doesn't have Hive specific logic. Remove this constructor variant, then you can move HiveParquetPrimitiveTypeConverter to the presto-hive module.", "author": "electrum", "createdAt": "2020-07-20T21:05:47Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/ParquetSchemaConverter.java", "diffHunk": "@@ -14,53 +14,42 @@\n package io.prestosql.parquet.writer;\n \n import com.google.common.collect.ImmutableList;\n-import io.prestosql.spi.PrestoException;\n import io.prestosql.spi.type.ArrayType;\n-import io.prestosql.spi.type.CharType;\n-import io.prestosql.spi.type.DecimalType;\n import io.prestosql.spi.type.MapType;\n-import io.prestosql.spi.type.RealType;\n import io.prestosql.spi.type.RowType;\n import io.prestosql.spi.type.Type;\n-import io.prestosql.spi.type.VarbinaryType;\n-import io.prestosql.spi.type.VarcharType;\n import org.apache.parquet.schema.GroupType;\n import org.apache.parquet.schema.MessageType;\n-import org.apache.parquet.schema.OriginalType;\n-import org.apache.parquet.schema.PrimitiveType;\n import org.apache.parquet.schema.Types;\n \n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n-import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n-import static io.prestosql.spi.type.BigintType.BIGINT;\n-import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n-import static io.prestosql.spi.type.DateType.DATE;\n-import static io.prestosql.spi.type.DoubleType.DOUBLE;\n-import static io.prestosql.spi.type.IntegerType.INTEGER;\n-import static io.prestosql.spi.type.SmallintType.SMALLINT;\n import static io.prestosql.spi.type.StandardTypes.ARRAY;\n import static io.prestosql.spi.type.StandardTypes.MAP;\n import static io.prestosql.spi.type.StandardTypes.ROW;\n-import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n-import static io.prestosql.spi.type.TinyintType.TINYINT;\n-import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n import static org.apache.parquet.Preconditions.checkArgument;\n import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n \n public class ParquetSchemaConverter\n {\n-    private Map<List<String>, Type> primitiveTypes = new HashMap<>();\n+    private final PrimitiveTypeConverter primitiveTypeConverter;\n+    private final Map<List<String>, Type> primitiveTypes = new HashMap<>();\n     private final MessageType messageType;\n \n     public ParquetSchemaConverter(List<Type> types, List<String> columnNames)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMjM2Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457732366", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-20T22:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MTUzMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczODM1OA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457738358", "bodyText": "I think we can use the Hive code directly here:\nTypeInfo hiveType = new HiveTypeTranslator().translate(type);\nMessageType messageType = HiveSchemaConverter.convert(List.of(name), List.of(hiveType));\nreturn messageType.getType(0);", "author": "electrum", "createdAt": "2020-07-20T22:58:58Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+import org.apache.parquet.schema.Types;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe.PRECISION_TO_BYTE_COUNT;\n+import static org.apache.parquet.schema.Type.Repetition.OPTIONAL;\n+\n+// this should match org.apache.hadoop.hive.ql.io.parquet.convert.HiveSchemaConverter\n+public class HiveParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final HiveParquetPrimitiveTypeConverter INSTANCE = new HiveParquetPrimitiveTypeConverter();\n+\n+    private HiveParquetPrimitiveTypeConverter() {}\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        if (BOOLEAN.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyMjQ5OA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457822498", "bodyText": "Changed, and it's nice to see the class melt away!", "author": "djsstarburst", "createdAt": "2020-07-21T04:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczODM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczODQ2Nw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457738467", "bodyText": "These two lines are not needed", "author": "electrum", "createdAt": "2020-07-20T22:59:20Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +139,52 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n-        Properties properties = new Properties();\n-        properties.setProperty(IOConstants.COLUMNS, columns.stream()\n+        StorageFormat storageFormat = fromHiveStorageFormat(HiveStorageFormat.PARQUET);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyMjUxOQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r457822519", "bodyText": "Removed", "author": "djsstarburst", "createdAt": "2020-07-21T04:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczODQ2Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMjIyMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458222222", "bodyText": "The TIMESTAMP constant uses the default precision 3, milliseconds. You probably want to check the precision of the timestamp type. https://github.com/prestosql/presto/blob/master/presto-spi/src/main/java/io/prestosql/spi/type/TimestampType.java#L66", "author": "alexjo2144", "createdAt": "2020-07-21T16:16:47Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetPrimitiveTypeConverter.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.PrimitiveTypeConverter;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.type.CharType;\n+import io.prestosql.spi.type.DecimalType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import org.apache.parquet.schema.LogicalTypeAnnotation;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.apache.parquet.schema.Type;\n+\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.BigintType.BIGINT;\n+import static io.prestosql.spi.type.BooleanType.BOOLEAN;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.spi.type.RealType.REAL;\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP;\n+import static io.prestosql.spi.type.TinyintType.TINYINT;\n+import static org.apache.iceberg.types.TypeUtil.decimalRequiredBytes;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.dateType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.decimalType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.intType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.stringType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timeType;\n+import static org.apache.parquet.schema.LogicalTypeAnnotation.timestampType;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName;\n+import static org.apache.parquet.schema.Types.PrimitiveBuilder;\n+import static org.apache.parquet.schema.Types.optional;\n+\n+public class IcebergParquetPrimitiveTypeConverter\n+        implements PrimitiveTypeConverter\n+{\n+    public static final IcebergParquetPrimitiveTypeConverter INSTANCE = new IcebergParquetPrimitiveTypeConverter();\n+\n+    private IcebergParquetPrimitiveTypeConverter() {}\n+\n+    @Override\n+    public Type getPrimitiveType(io.prestosql.spi.type.Type type, String name)\n+    {\n+        return primitive(type).named(name);\n+    }\n+\n+    private PrimitiveBuilder<PrimitiveType> primitive(io.prestosql.spi.type.Type type)\n+    {\n+        if (BOOLEAN.equals(type)) {\n+            return optional(PrimitiveTypeName.BOOLEAN);\n+        }\n+        if (BIGINT.equals(type)) {\n+            return optional(PrimitiveTypeName.INT64)\n+                    .as(intType(64, true));\n+        }\n+        if (INTEGER.equals(type)) {\n+            return optional(PrimitiveTypeName.INT32)\n+                    .as(intType(32, true));\n+        }\n+        if (SMALLINT.equals(type)) {\n+            return optional(PrimitiveTypeName.INT32)\n+                    .as(intType(16, true));\n+        }\n+        if (TINYINT.equals(type)) {\n+            return optional(PrimitiveTypeName.INT32)\n+                    .as(intType(8, true));\n+        }\n+        if (REAL.equals(type)) {\n+            return optional(PrimitiveTypeName.FLOAT);\n+        }\n+        if (DOUBLE.equals(type)) {\n+            return optional(PrimitiveTypeName.DOUBLE);\n+        }\n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            if (decimalType.getPrecision() <= 9) {\n+                return optional(PrimitiveTypeName.INT32)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()));\n+            }\n+            if (decimalType.getPrecision() <= 18) {\n+                return optional(PrimitiveTypeName.INT64)\n+                        .as(decimalType(decimalType.getScale(), decimalType.getPrecision()));\n+            }\n+            return optional(PrimitiveTypeName.FIXED_LEN_BYTE_ARRAY)\n+                    .length(decimalRequiredBytes(decimalType.getPrecision()))\n+                    .as(decimalType(decimalType.getScale(), decimalType.getPrecision()));\n+        }\n+        if (DATE.equals(type)) {\n+            return optional(PrimitiveTypeName.INT32)\n+                    .as(dateType());\n+        }\n+        if (TIMESTAMP.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3ODgzNQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458378835", "bodyText": "This morning @electrum and I decided that introducing the PrimitiveTypeConverter was the wrong approach.  We realized all we really needed to create a ParquetFileWriter was Map<List<String>, Type> of the names of primitive type columns and their Presto types, and the MessageType created by ParquetSchemaUtil.convert().\nSo the code above no longer exists, but thanks for the pointer.", "author": "djsstarburst", "createdAt": "2020-07-21T20:49:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMjIyMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NDgyMQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458384821", "bodyText": "We can remove the columns argument from the method since it's no longer used.", "author": "electrum", "createdAt": "2020-07-21T21:00:38Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +126,43 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n-        Properties properties = new Properties();\n-        properties.setProperty(IOConstants.COLUMNS, columns.stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODYxMA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408610", "bodyText": "Removed, along with a couple of places in IcebergPageSink on the way here.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NDgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NDk0OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458384949", "bodyText": "Let's inline this, to match the ORC code", "author": "electrum", "createdAt": "2020-07-21T21:00:52Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergFileWriterFactory.java", "diffHunk": "@@ -133,28 +126,43 @@ private IcebergFileWriter createParquetWriter(\n             JobConf jobConf,\n             ConnectorSession session)\n     {\n-        Properties properties = new Properties();\n-        properties.setProperty(IOConstants.COLUMNS, columns.stream()\n-                .map(IcebergColumnHandle::getName)\n-                .collect(joining(\",\")));\n-        properties.setProperty(IOConstants.COLUMNS_TYPES, columns.stream()\n-                .map(column -> toHiveType(column.getType()).getHiveTypeName().toString())\n-                .collect(joining(\":\")));\n-\n-        setParquetSchema(jobConf, convert(icebergSchema, \"table\"));\n-        jobConf.set(ParquetOutputFormat.COMPRESSION, getCompressionCodec(session).getParquetCompressionCodec().name());\n-\n-        return new IcebergRecordFileWriter(\n-                outputPath,\n-                columns.stream()\n-                        .map(IcebergColumnHandle::getName)\n-                        .collect(toImmutableList()),\n-                fromHiveStorageFormat(HiveStorageFormat.PARQUET),\n-                properties,\n-                HiveStorageFormat.PARQUET.getEstimatedWriterSystemMemoryUsage(),\n-                jobConf,\n-                typeManager,\n-                session);\n+        List<String> fileColumnNames = icebergSchema.columns().stream()\n+                .map(Types.NestedField::name)\n+                .collect(toImmutableList());\n+        List<Type> fileColumnTypes = icebergSchema.columns().stream()\n+                .map(column -> toPrestoType(column.type(), typeManager))\n+                .collect(toImmutableList());\n+\n+        int[] fileInputColumnIndexes = IntStream.range(0, fileColumnNames.size()).toArray();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODYzNw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408637", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NDk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NjE5OA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458386198", "bodyText": "This entire getMetrics() method is no longer needed. (and should be removed since we're reading the metrics twice for Parquet)", "author": "electrum", "createdAt": "2020-07-21T21:03:20Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSink.java", "diffHunk": "@@ -328,8 +327,7 @@ private Metrics getMetrics(WriteContext writeContext)\n             case PARQUET:\n                 return ParquetUtil.fileMetrics(HadoopInputFile.fromPath(writeContext.getPath(), jobConf), MetricsConfig.getDefault());\n             case ORC:\n-                return writeContext.getWriter().getMetrics()\n-                        .orElseThrow(() -> new VerifyException(\"Iceberg ORC file writers should return Iceberg metrics\"));\n+                return writeContext.getWriter().getMetrics();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODY3MQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408671", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NjE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4Njg3Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458386876", "bodyText": "Use requireNonNull for both assignments", "author": "electrum", "createdAt": "2020-07-21T21:04:38Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergParquetFileWriter.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import io.prestosql.parquet.writer.ParquetWriterOptions;\n+import io.prestosql.plugin.hive.parquet.ParquetFileWriter;\n+import io.prestosql.spi.type.Type;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.mapred.JobConf;\n+import org.apache.iceberg.Metrics;\n+import org.apache.iceberg.MetricsConfig;\n+import org.apache.iceberg.hadoop.HadoopInputFile;\n+import org.apache.iceberg.parquet.ParquetUtil;\n+import org.apache.parquet.hadoop.metadata.CompressionCodecName;\n+import org.apache.parquet.schema.MessageType;\n+\n+import java.io.OutputStream;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+\n+public class IcebergParquetFileWriter\n+        extends ParquetFileWriter\n+        implements IcebergFileWriter\n+{\n+    private final Path outputPath;\n+    private final JobConf jobConf;\n+\n+    public IcebergParquetFileWriter(\n+            OutputStream outputStream,\n+            Callable<Void> rollbackAction,\n+            List<Type> fileColumnTypes,\n+            MessageType messageType,\n+            Map<List<String>, Type> primitiveTypes,\n+            ParquetWriterOptions parquetWriterOptions,\n+            int[] fileInputColumnIndexes,\n+            CompressionCodecName compressionCodecName,\n+            Path outputPath,\n+            JobConf jobConf)\n+    {\n+        super(outputStream,\n+                rollbackAction,\n+                fileColumnTypes,\n+                messageType,\n+                primitiveTypes,\n+                parquetWriterOptions,\n+                fileInputColumnIndexes,\n+                compressionCodecName);\n+        this.outputPath = outputPath;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODcwOA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408708", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4Njg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4Nzc0MA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458387740", "bodyText": "This class is now unused and can be deleted", "author": "electrum", "createdAt": "2020-07-21T21:06:18Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergRecordFileWriter.java", "diffHunk": "@@ -21,15 +21,20 @@\n import org.apache.hadoop.fs.Path;\n import org.apache.hadoop.mapred.JobConf;\n import org.apache.iceberg.Metrics;\n+import org.apache.iceberg.MetricsConfig;\n+import org.apache.iceberg.hadoop.HadoopInputFile;\n+import org.apache.iceberg.parquet.ParquetUtil;\n \n import java.util.List;\n-import java.util.Optional;\n import java.util.Properties;\n \n public class IcebergRecordFileWriter", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODczMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408732", "bodyText": "That's nice!  Deleted.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4Nzc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4ODIzNg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458388236", "bodyText": "Maybe wrap .configure() here", "author": "electrum", "createdAt": "2020-07-21T21:07:19Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PartitionData.java", "diffHunk": "@@ -34,7 +35,7 @@\n {\n     private static final String PARTITION_VALUES_FIELD = \"partitionValues\";\n     private static final JsonFactory FACTORY = new JsonFactory();\n-    private static final ObjectMapper MAPPER = new ObjectMapper(FACTORY);\n+    private static final ObjectMapper MAPPER = new ObjectMapper(FACTORY).configure(DeserializationFeature.USE_BIG_DECIMAL_FOR_FLOATS, true);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODc2NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408765", "bodyText": "Raptly wrapped.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4ODIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4ODY1Mw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458388653", "bodyText": "Let's put this in the util package (we should move more things there)", "author": "electrum", "createdAt": "2020-07-21T21:08:06Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PrimitiveTypeMapBuilder.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODc5NQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408795", "bodyText": "Moved.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4ODY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4OTIxOA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458389218", "bodyText": "Make this private", "author": "electrum", "createdAt": "2020-07-21T21:09:19Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PrimitiveTypeMapBuilder.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.MapType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static io.prestosql.spi.type.StandardTypes.ARRAY;\n+import static io.prestosql.spi.type.StandardTypes.MAP;\n+import static io.prestosql.spi.type.StandardTypes.ROW;\n+\n+public class PrimitiveTypeMapBuilder\n+{\n+    private final ImmutableMap.Builder<List<String>, Type> builder = ImmutableMap.builder();\n+\n+    private PrimitiveTypeMapBuilder() {}\n+\n+    public static Map<List<String>, Type> makeTypeMap(List<Type> types, List<String> columnNames)\n+    {\n+        return new PrimitiveTypeMapBuilder().buildTypeMap(types, columnNames);\n+    }\n+\n+    public Map<List<String>, Type> buildTypeMap(List<Type> types, List<String> columnNames)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODgzOA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408838", "bodyText": "Privatized", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4OTIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MTMyMg==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458391322", "bodyText": "Static import checkArgument", "author": "electrum", "createdAt": "2020-07-21T21:13:27Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PrimitiveTypeMapBuilder.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.MapType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static io.prestosql.spi.type.StandardTypes.ARRAY;\n+import static io.prestosql.spi.type.StandardTypes.MAP;\n+import static io.prestosql.spi.type.StandardTypes.ROW;\n+\n+public class PrimitiveTypeMapBuilder\n+{\n+    private final ImmutableMap.Builder<List<String>, Type> builder = ImmutableMap.builder();\n+\n+    private PrimitiveTypeMapBuilder() {}\n+\n+    public static Map<List<String>, Type> makeTypeMap(List<Type> types, List<String> columnNames)\n+    {\n+        return new PrimitiveTypeMapBuilder().buildTypeMap(types, columnNames);\n+    }\n+\n+    public Map<List<String>, Type> buildTypeMap(List<Type> types, List<String> columnNames)\n+    {\n+        for (int i = 0; i < types.size(); i++) {\n+            visitType(types.get(i), columnNames.get(i), ImmutableList.of());\n+        }\n+        return builder.build();\n+    }\n+\n+    private void visitType(Type type, String name, List<String> parent)\n+    {\n+        if (ROW.equals(type.getTypeSignature().getBase())) {\n+            visitRowType((RowType) type, name, parent);\n+        }\n+        else if (MAP.equals(type.getTypeSignature().getBase())) {\n+            visitMapType((MapType) type, name, parent);\n+        }\n+        else if (ARRAY.equals(type.getTypeSignature().getBase())) {\n+            visitArrayType((ArrayType) type, name, parent);\n+        }\n+        else {\n+            builder.put(ImmutableList.<String>builder().addAll(parent).add(name).build(), type);\n+        }\n+    }\n+\n+    private void visitArrayType(ArrayType type, String name, List<String> parent)\n+    {\n+        parent = ImmutableList.<String>builder().addAll(parent).add(name).add(\"array\").build();\n+        visitType(type.getElementType(), \"array\", parent);\n+    }\n+\n+    private void visitMapType(MapType type, String name, List<String> parent)\n+    {\n+        parent = ImmutableList.<String>builder().addAll(parent).add(name).add(\"map\").build();\n+        visitType(type.getKeyType(), \"key\", parent);\n+        visitType(type.getValueType(), \"value\", parent);\n+    }\n+\n+    private void visitRowType(RowType type, String name, List<String> parent)\n+    {\n+        parent = ImmutableList.<String>builder().addAll(parent).add(name).build();\n+        for (RowType.Field field : type.getFields()) {\n+            com.google.common.base.Preconditions.checkArgument(field.getName().isPresent(), \"field in struct type doesn't have name\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODkwMQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408901", "bodyText": "Changed.  I have to remember to check code that I cut and paste, because the original might not be conformant.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MTU4OQ==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458391589", "bodyText": "requireNonNull", "author": "electrum", "createdAt": "2020-07-21T21:13:56Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/ParquetWriter.java", "diffHunk": "@@ -78,28 +77,23 @@\n \n     public ParquetWriter(\n             OutputStream outputStream,\n-            List<String> columnNames,\n-            List<Type> types,\n+            MessageType messageType,\n+            Map<List<String>, Type> primitiveTypes,\n             ParquetWriterOptions writerOption,\n             CompressionCodecName compressionCodecName)\n     {\n         this.outputStream = new OutputStreamSliceOutput(requireNonNull(outputStream, \"outputstream is null\"));\n-        this.names = ImmutableList.copyOf(requireNonNull(columnNames, \"columnNames is null\"));\n-        this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n         this.writerOption = requireNonNull(writerOption, \"writerOption is null\");\n         requireNonNull(compressionCodecName, \"compressionCodecName is null\");\n \n-        checkArgument(types.size() == columnNames.size(), \"type size %s is not equal to name size %s\", types.size(), columnNames.size());\n-\n-        ParquetSchemaConverter parquetSchemaConverter = new ParquetSchemaConverter(types, columnNames);\n-        this.messageType = parquetSchemaConverter.getMessageType();\n+        this.messageType = messageType;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwODk0Ng==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458408946", "bodyText": "Required.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MjA3OA==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458392078", "bodyText": "Move this above, after the other integer types", "author": "electrum", "createdAt": "2020-07-21T21:14:50Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/ParquetWriters.java", "diffHunk": "@@ -165,9 +166,12 @@ private static PrimitiveValueWriter getValueWriter(ValuesWriter valuesWriter, io\n         if (DATE.equals(type)) {\n             return new DateValueWriter(valuesWriter, parquetType);\n         }\n-        if (BIGINT.equals(type) || TIMESTAMP.equals(type)) {\n+        if (BIGINT.equals(type)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwOTAxNw==", "url": "https://github.com/trinodb/trino/pull/4424#discussion_r458409017", "bodyText": "Moved.", "author": "djsstarburst", "createdAt": "2020-07-21T21:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MjA3OA=="}], "type": "inlineReview"}, {"oid": "81db7fecf583e2a0d35e8d7dac04542fc64bfbc5", "url": "https://github.com/trinodb/trino/commit/81db7fecf583e2a0d35e8d7dac04542fc64bfbc5", "message": "Change Iceberg to use ParquetFileWriter\n\nThis commit changes the Iceberg connector to use the new\nParquetFileWriter, and fixes bugs in handling of decimal and\ntimestamp columns for both Orc and Parquet.\n\nThis commit removes DomainConverter and the test\nTestDomainConverter, superseded by fixes and conversions\nin ExpressionConverter, MessageTypeConverter and\nnew class TimestampValueWriter.\n\nThis commit adds new TestIcebergSmoke tests for decimal\nand timestamp, and fixes the existing tests.  With this\ncommit, all TestIcebergSmoke tests pass.", "committedDate": "2020-07-21T21:48:24Z", "type": "commit"}, {"oid": "81db7fecf583e2a0d35e8d7dac04542fc64bfbc5", "url": "https://github.com/trinodb/trino/commit/81db7fecf583e2a0d35e8d7dac04542fc64bfbc5", "message": "Change Iceberg to use ParquetFileWriter\n\nThis commit changes the Iceberg connector to use the new\nParquetFileWriter, and fixes bugs in handling of decimal and\ntimestamp columns for both Orc and Parquet.\n\nThis commit removes DomainConverter and the test\nTestDomainConverter, superseded by fixes and conversions\nin ExpressionConverter, MessageTypeConverter and\nnew class TimestampValueWriter.\n\nThis commit adds new TestIcebergSmoke tests for decimal\nand timestamp, and fixes the existing tests.  With this\ncommit, all TestIcebergSmoke tests pass.", "committedDate": "2020-07-21T21:48:24Z", "type": "forcePushed"}]}