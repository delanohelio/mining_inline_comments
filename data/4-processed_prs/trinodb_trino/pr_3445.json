{"pr_number": 3445, "pr_title": "Pushdown dereferences in ORC Reader", "pr_createdAt": "2020-04-16T00:43:23Z", "pr_url": "https://github.com/trinodb/trino/pull/3445", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY1Mjg0MA==", "url": "https://github.com/trinodb/trino/pull/3445#discussion_r411652840", "bodyText": "Why do we need this branch? If I'm reading things correctly, readLayout.getFieldLayout(fieldName) already does the check internally and knows to return fullyProjectedLayout().", "author": "martint", "createdAt": "2020-04-20T20:00:20Z", "path": "presto-orc/src/main/java/io/prestosql/orc/reader/StructColumnReader.java", "diffHunk": "@@ -96,8 +98,17 @@\n             fieldNames.add(fieldName);\n \n             OrcColumn fieldStream = nestedColumns.get(fieldName);\n+\n             if (fieldStream != null) {\n-                structFields.put(fieldName, createColumnReader(field.getType(), fieldStream, systemMemoryContext, blockFactory));\n+                if (readLayout.isFullyProjected()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyMDg5NA==", "url": "https://github.com/trinodb/trino/pull/3445#discussion_r411820894", "bodyText": "Good catch! you're totally right. Earlier I was split on whether,\nwhen ProjectedLayout::fieldLayouts is empty\n(1) have getFieldLayout return a fullyProjectedLayout OR\n(2) throw an exception, since we may not want to return fullyProjectedLayout for any random field name.\n(i.e. invoking getFieldLayout(z) for a fully projected layout of a, where a has only two fields x and y.)\nBut since we only use this method after the fieldStream != null check, I think (1) should be okay.\nRemoved the check and the isFullyProjected method.", "author": "phd3", "createdAt": "2020-04-21T02:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY1Mjg0MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "71306218bb55be80535d67c41ffa5672ae3d9ad5", "url": "https://github.com/trinodb/trino/commit/71306218bb55be80535d67c41ffa5672ae3d9ad5", "message": "Add test for dereferences on data containing null rows", "committedDate": "2020-04-22T18:28:32Z", "type": "commit"}, {"oid": "cfc6df17179c17e1877fe886c0bee82f34a74b82", "url": "https://github.com/trinodb/trino/commit/cfc6df17179c17e1877fe886c0bee82f34a74b82", "message": "Pushdown dereference projections in ORC reader", "committedDate": "2020-04-22T18:28:32Z", "type": "commit"}, {"oid": "83b3d5221f1a2f25fdb4d548affe0ad580b992d5", "url": "https://github.com/trinodb/trino/commit/83b3d5221f1a2f25fdb4d548affe0ad580b992d5", "message": "Implement predicate pushdown for nested columns in ORC reader", "committedDate": "2020-04-22T18:28:32Z", "type": "commit"}, {"oid": "83b3d5221f1a2f25fdb4d548affe0ad580b992d5", "url": "https://github.com/trinodb/trino/commit/83b3d5221f1a2f25fdb4d548affe0ad580b992d5", "message": "Implement predicate pushdown for nested columns in ORC reader", "committedDate": "2020-04-22T18:28:32Z", "type": "forcePushed"}]}