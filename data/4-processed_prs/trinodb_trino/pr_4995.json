{"pr_number": 4995, "pr_title": "Create temporary tables in mysql without key constraints", "pr_createdAt": "2020-08-27T05:01:13Z", "pr_url": "https://github.com/trinodb/trino/pull/4995", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478200547", "bodyText": "If we change to CTAS from the current implementation, it breaks the existing behavior when GTID mode is on. We need to look for other approach (e.g. Use CREATE TABLE LIKE only when GTID mode is on or just adding cofiguration).", "author": "ebyhr", "createdAt": "2020-08-27T07:02:56Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMTk4NQ==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478231985", "bodyText": "do we have tests for this? or not possible? (sorry, dont remember)\n(sadly, all checks paassd... )", "author": "findepi", "createdAt": "2020-08-27T08:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMjcxMQ==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478232711", "bodyText": "I see, CTAS not working in GTID mode. I found this issue  #2251", "author": "ssquan", "createdAt": "2020-08-27T08:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMzg5OA==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478233898", "bodyText": "do we have tests for this? or not possible? (sorry, dont remember)\n(sadly, all checks paassd... )\n\n@ebyhr just file an issue to add tests in GTID mode :) #4997", "author": "ssquan", "createdAt": "2020-08-27T08:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyODU0Ng==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480128546", "bodyText": "Move this method to after jsonColumnMapping method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGTIDMode(Connection connection)\n          \n          \n            \n                private boolean isGtidMode(Connection connection)", "author": "ebyhr", "createdAt": "2020-08-31T13:24:31Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMzIwNg==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480133206", "bodyText": "We can make this line try-with-resources and please upper case for keywords.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n          \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\");", "author": "ebyhr", "createdAt": "2020-08-31T13:32:24Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzc5MA==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480137790", "bodyText": "ON_PERMISSIVE is also possible value.", "author": "ebyhr", "createdAt": "2020-08-31T13:40:01Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n+            if (resultSet.next()) {\n+                return resultSet.getString(\"Value\").equalsIgnoreCase(\"ON\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzMTE1Mw==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r481831153", "bodyText": "I use a not OFF mode check here to consider OFF_PERMISSIVE \u3001ON__PERMISSIVE and ON modes at the same time. Mysql may use GTID-based replication in OFF_PERMISSIVE mode according to MySQL dev doc", "author": "ssquan", "createdAt": "2020-09-02T07:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzc5MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY1NzUzMQ==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r481657531", "bodyText": "You don't need to split into 2 try.", "author": "ebyhr", "createdAt": "2020-09-02T04:22:23Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,22 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            try (ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\")) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2ODY2NA==", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r487368664", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGtidMode(Connection connection)\n          \n          \n            \n                private static boolean isGtidMode(Connection connection)", "author": "ebyhr", "createdAt": "2020-09-12T05:00:15Z", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,21 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "c03d00528a3660768a421e81d99c23491a059a27", "url": "https://github.com/trinodb/trino/commit/c03d00528a3660768a421e81d99c23491a059a27", "message": "Do not copy constraint for temporary table on non-GTID MySQL", "committedDate": "2020-09-14T07:20:40Z", "type": "commit"}, {"oid": "c03d00528a3660768a421e81d99c23491a059a27", "url": "https://github.com/trinodb/trino/commit/c03d00528a3660768a421e81d99c23491a059a27", "message": "Do not copy constraint for temporary table on non-GTID MySQL", "committedDate": "2020-09-14T07:20:40Z", "type": "forcePushed"}]}