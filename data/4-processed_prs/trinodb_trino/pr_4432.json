{"pr_number": 4432, "pr_title": "Fallback to FileInputStream if PemReader fails to read certificates", "pr_createdAt": "2020-07-13T09:50:34Z", "pr_url": "https://github.com/trinodb/trino/pull/4432", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYwOTgzNQ==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r453609835", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ConfigDescription(\"Path to the PEM trust store\")\n          \n          \n            \n                @ConfigDescription(\"Password for the trust store\")", "author": "Lewuathe", "createdAt": "2020-07-13T12:22:13Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftMetastoreConfig.java", "diffHunk": "@@ -265,6 +266,19 @@ public ThriftMetastoreConfig setTruststorePath(File truststorePath)\n         return this;\n     }\n \n+    public String getTruststorePassword()\n+    {\n+        return trustStorePassword;\n+    }\n+\n+    @Config(\"hive.metastore.thrift.client.ssl.trust-certificate-password\")\n+    @ConfigDescription(\"Path to the PEM trust store\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxMjU2Mg==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r453612562", "bodyText": "Is it meaningful to ignore the GeneralSecurityException? For example, trying the same password would fail again if the keyStorePassword is wrong.\nIs it possible to catch only the exception which gives us another chance to read the key store directly? Or it should at least show some warning or error message if the exception happens.", "author": "Lewuathe", "createdAt": "2020-07-13T12:27:25Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/DefaultThriftMetastoreClientFactory.java", "diffHunk": "@@ -120,16 +124,27 @@ private TTransport createTransport(HostAndPort address, Optional<String> delegat\n         try {\n             // load KeyStore if configured and get KeyManagers\n             KeyManager[] keyManagers = null;\n+            KeyStore keyStore = null;\n+            char[] keyManagerPassword = new char[0];\n             if (keyStorePath.isPresent()) {\n-                KeyStore keyStore = PemReader.loadKeyStore(keyStorePath.get(), keyStorePath.get(), keyStorePassword);\n+                try {\n+                    keyStore = PemReader.loadKeyStore(keyStorePath.get(), keyStorePath.get(), keyStorePassword);\n+                }\n+                catch (IOException | GeneralSecurityException ignored) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0ODIxNw==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r453748217", "bodyText": "Couldn't find a particular exception which should tell us to read the key store directly. Added warning log.", "author": "yashaswaj", "createdAt": "2020-07-13T15:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxMjU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxNDE5Ng==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r453614196", "bodyText": "As well as the key store load, we can show the warning or error message here to notify the detail of GeneralSecurityException instead of ignoring.", "author": "Lewuathe", "createdAt": "2020-07-13T12:30:29Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/DefaultThriftMetastoreClientFactory.java", "diffHunk": "@@ -151,16 +166,27 @@ private TTransport createTransport(HostAndPort address, Optional<String> delegat\n         }\n     }\n \n-    private static KeyStore loadTrustStore(File trustStorePath)\n+    private static KeyStore loadTrustStore(File trustStorePath, Optional<String> trustStorePassword)\n             throws IOException, GeneralSecurityException\n     {\n-        List<X509Certificate> certificateChain = PemReader.readCertificateChain(trustStorePath);\n-\n         KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n-        trustStore.load(null, null);\n-        for (X509Certificate certificate : certificateChain) {\n-            X500Principal principal = certificate.getSubjectX500Principal();\n-            trustStore.setCertificateEntry(principal.getName(), certificate);\n+        try {\n+            // attempt to read the trust store as a PEM file\n+            List<X509Certificate> certificateChain = PemReader.readCertificateChain(trustStorePath);\n+            if (!certificateChain.isEmpty()) {\n+                trustStore.load(null, null);\n+                for (X509Certificate certificate : certificateChain) {\n+                    X500Principal principal = certificate.getSubjectX500Principal();\n+                    trustStore.setCertificateEntry(principal.getName(), certificate);\n+                }\n+                return trustStore;\n+            }\n+        }\n+        catch (IOException | GeneralSecurityException ignored) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0ODI4MQ==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r453748281", "bodyText": "Added warning log.", "author": "yashaswaj", "createdAt": "2020-07-13T15:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYxNDE5Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNTE3OQ==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r464115179", "bodyText": "trust store above is two words but one word here", "author": "dain", "createdAt": "2020-08-02T19:35:24Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -310,13 +310,15 @@ Property Name                                                 Description\n \n ``hive.metastore.thrift.client.ssl.enabled``                  Use SSL when connecting to metastore.                        ``false``\n \n-``hive.metastore.thrift.client.ssl.key``                      Path to PEM private key and client certificate (key store).\n+``hive.metastore.thrift.client.ssl.key``                      Path to private key and client certificate (key store).\n \n-``hive.metastore.thrift.client.ssl.key-password``             Password for the PEM private key.\n+``hive.metastore.thrift.client.ssl.key-password``             Password for the private key.\n \n-``hive.metastore.thrift.client.ssl.trust-certificate``        Path to the PEM server certificate chain (trust store).\n+``hive.metastore.thrift.client.ssl.trust-certificate``        Path to the server certificate chain (trust store).\n                                                               Required when SSL is enabled.\n \n+``hive.metastore.thrift.client.ssl.trust-certificate-password`` Password for the truststore", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNjQxOQ==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r464116419", "bodyText": "I don't think we need a warning as this is expected if the file is a key store. I would just drop the message entirely.", "author": "dain", "createdAt": "2020-08-02T19:48:01Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/DefaultThriftMetastoreClientFactory.java", "diffHunk": "@@ -120,16 +126,28 @@ private TTransport createTransport(HostAndPort address, Optional<String> delegat\n         try {\n             // load KeyStore if configured and get KeyManagers\n             KeyManager[] keyManagers = null;\n+            KeyStore keyStore = null;\n+            char[] keyManagerPassword = new char[0];\n             if (keyStorePath.isPresent()) {\n-                KeyStore keyStore = PemReader.loadKeyStore(keyStorePath.get(), keyStorePath.get(), keyStorePassword);\n+                try {\n+                    keyStore = PemReader.loadKeyStore(keyStorePath.get(), keyStorePath.get(), keyStorePassword);\n+                }\n+                catch (IOException | GeneralSecurityException e) {\n+                    log.warn(e, \"Failed reading keystore as PEM file\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNzE2MA==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r464117160", "bodyText": "Same here", "author": "dain", "createdAt": "2020-08-02T19:55:13Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/DefaultThriftMetastoreClientFactory.java", "diffHunk": "@@ -151,16 +169,28 @@ private TTransport createTransport(HostAndPort address, Optional<String> delegat\n         }\n     }\n \n-    private static KeyStore loadTrustStore(File trustStorePath)\n+    private static KeyStore loadTrustStore(File trustStorePath, Optional<String> trustStorePassword)\n             throws IOException, GeneralSecurityException\n     {\n-        List<X509Certificate> certificateChain = PemReader.readCertificateChain(trustStorePath);\n-\n         KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n-        trustStore.load(null, null);\n-        for (X509Certificate certificate : certificateChain) {\n-            X500Principal principal = certificate.getSubjectX500Principal();\n-            trustStore.setCertificateEntry(principal.getName(), certificate);\n+        try {\n+            // attempt to read the trust store as a PEM file\n+            List<X509Certificate> certificateChain = PemReader.readCertificateChain(trustStorePath);\n+            if (!certificateChain.isEmpty()) {\n+                trustStore.load(null, null);\n+                for (X509Certificate certificate : certificateChain) {\n+                    X500Principal principal = certificate.getSubjectX500Principal();\n+                    trustStore.setCertificateEntry(principal.getName(), certificate);\n+                }\n+                return trustStore;\n+            }\n+        }\n+        catch (IOException | GeneralSecurityException e) {\n+            log.warn(e, \"Failed reading Truststore as PEM file\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMzU4Mg==", "url": "https://github.com/trinodb/trino/pull/4432#discussion_r464523582", "bodyText": "The log field is no longer used", "author": "dain", "createdAt": "2020-08-03T16:28:26Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/DefaultThriftMetastoreClientFactory.java", "diffHunk": "@@ -49,6 +52,7 @@\n public class DefaultThriftMetastoreClientFactory\n         implements ThriftMetastoreClientFactory\n {\n+    private static final Logger log = Logger.get(DefaultThriftMetastoreClientFactory.class);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7fe75851a92572e2183faa4d7a98abfcc7a8d2a", "url": "https://github.com/trinodb/trino/commit/f7fe75851a92572e2183faa4d7a98abfcc7a8d2a", "message": "Fallback to FileInputStream if PemReader fails to read certificates", "committedDate": "2020-08-03T17:00:12Z", "type": "commit"}, {"oid": "f7fe75851a92572e2183faa4d7a98abfcc7a8d2a", "url": "https://github.com/trinodb/trino/commit/f7fe75851a92572e2183faa4d7a98abfcc7a8d2a", "message": "Fallback to FileInputStream if PemReader fails to read certificates", "committedDate": "2020-08-03T17:00:12Z", "type": "forcePushed"}]}