{"pr_number": 5430, "pr_title": "Hide Delta Lake tables", "pr_createdAt": "2020-10-06T12:52:52Z", "pr_url": "https://github.com/trinodb/trino/pull/5430", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyNTI2Nw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500325267", "bodyText": "as you are here. Should catalogDirectory be a File, and be annotated with@FileExists?", "author": "losipiuk", "createdAt": "2020-10-06T14:20:32Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastoreConfig.java", "diffHunk": "@@ -32,9 +32,10 @@ public String getCatalogDirectory()\n \n     @Config(\"hive.metastore.catalog.dir\")\n     @ConfigDescription(\"Hive file-based metastore catalog directory\")\n-    public void setCatalogDirectory(String catalogDirectory)\n+    public FileHiveMetastoreConfig setCatalogDirectory(String catalogDirectory)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2ODMxOA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500368318", "bodyText": "Will extract separate PR for the cleanup (#5435) and fix it there", "author": "findepi", "createdAt": "2020-10-06T15:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyNTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MDIwMQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500370201", "bodyText": "catalogDirectory can be HDFS location, so won't do", "author": "findepi", "createdAt": "2020-10-06T15:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyNTI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1MDU1OQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500450559", "bodyText": "It could probably be URI or org.apache.hadoop.fs.Path. But I agree that's a separate cleanup", "author": "electrum", "createdAt": "2020-10-06T16:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyNTI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzMTUzNA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500331534", "bodyText": "assertion on assertion....\nMaybe nicer approach would be to have bool supportsDeltaLakeTablesHiding() in AbstractTestHive and override it in subclasses accordingly.", "author": "losipiuk", "createdAt": "2020-10-06T14:26:45Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHive.java", "diffHunk": "@@ -65,4 +66,18 @@ public void testGetPartitionSplitsTableOfflinePartition()\n \n         super.testGetPartitionSplitsTableOfflinePartition();\n     }\n+\n+    @Override\n+    public void testHideDeltaLakeTables()\n+    {\n+        assertThatThrownBy(super::testHideDeltaLakeTables)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2NzA3Mw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500367073", "bodyText": "https://prestosql.slack.com/archives/CP1MUNEUX/p1588690413495700", "author": "findepi", "createdAt": "2020-10-06T15:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzMTUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNTc3MQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500335771", "bodyText": "Add validation that if hive.hide-delta-tables is true then Glue metastore is in use.\nI wanted to suggest a snippet like below but it does not work as we do not have metastore type in HiveConfig. You will figure sth out :p\n    @AssertTrue(message = \"hive.hide-delta-tables works only with Glue metastore\")\n    public boolean isDeltaLakeHidingCompatibleWithMetastoreType()\n    {\n        return !hideDeltaLakeTables || hiveMetastoreIsGlue\n    }", "author": "losipiuk", "createdAt": "2020-10-06T14:31:04Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -672,6 +673,19 @@ public HiveConfig setTranslateHiveViews(boolean translateHiveViews)\n         return this;\n     }\n \n+    public boolean isHideDeltaLakeTables()\n+    {\n+        return hideDeltaLakeTables;\n+    }\n+\n+    @Config(\"hive.hide-delta-tables\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM0MjI4Mg==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500342282", "bodyText": "Oh I see you added validation to metastore code.", "author": "losipiuk", "createdAt": "2020-10-06T14:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNTc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2ODg3MQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500368871", "bodyText": "Yes, I want this to be covered by thrift too. Otherwise I'd add this to Glue...Config only", "author": "findepi", "createdAt": "2020-10-06T15:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM0MTk5Mw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500341993", "bodyText": "finish sentence", "author": "losipiuk", "createdAt": "2020-10-06T14:37:43Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/alluxio/AlluxioHiveMetastore.java", "diffHunk": "@@ -75,6 +76,7 @@ public AlluxioHiveMetastore(TableMasterClient client, HiveConfig hiveConfig)\n     {\n         this.client = requireNonNull(client);\n         requireNonNull(hiveConfig, \"hiveConfig is null\");\n+        checkArgument(!hiveConfig.isHideDeltaLakeTables(), \"Hiding delta tables is not supported by\"); // TODO", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM0ODQ0OQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500348449", "bodyText": "static import.\nThough I personally would prefer not using Predicate.not at all and just extend the lambda, and use !", "author": "losipiuk", "createdAt": "2020-10-06T14:44:15Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -411,18 +416,11 @@ public synchronized void updatePartitionStatistics(HiveIdentity identity, Table\n     @Override\n     public synchronized List<String> getAllTables(String databaseName)\n     {\n-        requireNonNull(databaseName, \"databaseName is null\");\n-\n-        Optional<Database> database = getDatabase(databaseName);\n-        if (database.isEmpty()) {\n-            return ImmutableList.of();\n-        }\n-\n-        Path databaseMetadataDirectory = getDatabaseMetadataDirectory(databaseName);\n-        List<String> tables = getChildSchemaDirectories(databaseMetadataDirectory).stream()\n-                .map(Path::getName)\n+        return listAllTables(databaseName).stream()\n+                .filter(hideDeltaLakeTables\n+                        ? Predicate.not(ImmutableSet.copyOf(getTablesWithParameter(databaseName, SPARK_TABLE_PROVIDER_KEY, DELTA_LAKE_PROVIDER))::contains)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTE1NA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500371154", "bodyText": "static import what?\n\nThough I personally would prefer not using Predicate.not at all and just extend the lambda, and use !\n\nthe not is necessary to make ImmutableSet.copyOf(....) computed once", "author": "findepi", "createdAt": "2020-10-06T15:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM0ODQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDQxNQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500350415", "bodyText": "why do we need it here if metastore implementation already does filtering out?", "author": "losipiuk", "createdAt": "2020-10-06T14:46:19Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -748,15 +757,19 @@ public TableStatistics getTableStatistics(ConnectorSession session, ConnectorTab\n         if (!filterSchema(tableName.getSchemaName())) {\n             return ImmutableList.of();\n         }\n+\n+        Optional<Table> optionalTable;\n         try {\n-            if (metastore.getTable(new HiveIdentity(session), tableName.getSchemaName(), tableName.getTableName()).isEmpty()) {\n-                return ImmutableList.of();\n-            }\n+            optionalTable = metastore.getTable(new HiveIdentity(session), tableName.getSchemaName(), tableName.getTableName());\n         }\n         catch (HiveViewNotSupportedException e) {\n             // exists, would be returned by listTables from schema\n+            return ImmutableList.of(tableName);\n         }\n-        return ImmutableList.of(tableName);\n+        return optionalTable\n+                .filter(table -> !hideDeltaLakeTables || !isDeltaLakeTable(table))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjgwNA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500372804", "bodyText": "Because table listing does not happen in the information_schema.columns flow, when schema_name and table_name are predicated to a constant. This is covered by\n// list all columns in a table\nassertThat(metadata.listTableColumns(session, new SchemaTablePrefix(tableName.getSchemaName(), tableName.getTableName())).keySet())\n        .doesNotContain(tableName);\n\nassertion in the test code", "author": "findepi", "createdAt": "2020-10-06T15:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NzI4NA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500457284", "bodyText": "This is going to make listing very slow. We want to do this best effort in the metstore for listing tables. For columns, we can filter out in listTableColumns which is already fetching table metadata.", "author": "electrum", "createdAt": "2020-10-06T17:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwMzM4Nw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500503387", "bodyText": "@electrum  This does not pull any additional data during listing.\nNote that normal listing case is handled directly in the metastore code. Here, we short-circuit to avoid metastore call, so we need to apply filtering.", "author": "findepi", "createdAt": "2020-10-06T18:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxNTAxOQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501315019", "bodyText": "Ah, I see that this is a special case for listing a single table.", "author": "electrum", "createdAt": "2020-10-07T21:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDQxNQ=="}], "type": "inlineReview"}, {"oid": "7f4e4baee4fc7475112264365b0c066bd975fb84", "url": "https://github.com/trinodb/trino/commit/7f4e4baee4fc7475112264365b0c066bd975fb84", "message": "Hide Delta Lake tables\n\nHive connector cannot read from Delta Lake tables and some users prefer\nnot to see such tables at all.", "committedDate": "2020-10-06T15:33:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1MzAzNQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500453035", "bodyText": "This looks like the wrong binding", "author": "electrum", "createdAt": "2020-10-06T16:56:27Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileMetastoreModule.java", "diffHunk": "@@ -28,6 +29,7 @@\n     @Override\n     public void configure(Binder binder)\n     {\n+        configBinder(binder).bindConfig(HiveConfig.class);", "originalCommit": "c4eaa5907ef008061e5b211a65483258ceefa41c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NDc5Ng==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500454796", "bodyText": "MetastoreConfig is the wrong class to use. Today, it configures which metastore type to use. This information would not be useful to metastore implementations. The new config you want should be in a different config class. (perhaps MetastoreConfig should be renamed to MetastoreTypeConfig so you can use the MetastoreConfig name)", "author": "electrum", "createdAt": "2020-10-06T16:59:13Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveAlluxioMetastore.java", "diffHunk": "@@ -16,6 +16,7 @@\n import alluxio.client.table.TableMasterClient;\n import alluxio.conf.PropertyKey;\n import io.prestosql.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.prestosql.plugin.hive.metastore.MetastoreConfig;", "originalCommit": "c4eaa5907ef008061e5b211a65483258ceefa41c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MjY3Ng==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500462676", "bodyText": "This variable doesn't seem necessary", "author": "electrum", "createdAt": "2020-10-06T17:11:57Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -442,6 +440,21 @@ public synchronized void updatePartitionStatistics(HiveIdentity identity, Table\n                 .collect(toImmutableList());\n     }\n \n+    private synchronized List<String> listAllTables(String databaseName)\n+    {\n+        requireNonNull(databaseName, \"databaseName is null\");\n+\n+        Optional<Database> database = getDatabase(databaseName);\n+        if (database.isEmpty()) {\n+            return ImmutableList.of();\n+        }\n+\n+        Path databaseMetadataDirectory = getDatabaseMetadataDirectory(databaseName);", "originalCommit": "7f4e4baee4fc7475112264365b0c066bd975fb84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg1Njc0Ng==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500856746", "bodyText": "i split out extract method as a separate commti", "author": "findepi", "createdAt": "2020-10-07T09:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MjY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NDcyOQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500464729", "bodyText": "Do we even support File Hive metastore for Delta Lake?", "author": "electrum", "createdAt": "2020-10-06T17:15:18Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -411,18 +416,11 @@ public synchronized void updatePartitionStatistics(HiveIdentity identity, Table\n     @Override\n     public synchronized List<String> getAllTables(String databaseName)\n     {\n-        requireNonNull(databaseName, \"databaseName is null\");\n-\n-        Optional<Database> database = getDatabase(databaseName);\n-        if (database.isEmpty()) {\n-            return ImmutableList.of();\n-        }\n-\n-        Path databaseMetadataDirectory = getDatabaseMetadataDirectory(databaseName);\n-        List<String> tables = getChildSchemaDirectories(databaseMetadataDirectory).stream()\n-                .map(Path::getName)\n+        return listAllTables(databaseName).stream()", "originalCommit": "7f4e4baee4fc7475112264365b0c066bd975fb84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg1ODMwNQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500858305", "bodyText": "Not sure what this question is about?", "author": "findepi", "createdAt": "2020-10-07T09:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NDcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NTc5Nw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500465797", "bodyText": "While we're changing this\n.map(Table::getName)\n.forEach(tableNames::add);", "author": "electrum", "createdAt": "2020-10-06T17:16:59Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -406,7 +410,11 @@ public void updatePartitionStatistics(HiveIdentity identity, Table table, String\n                             .withCatalogId(catalogId)\n                             .withDatabaseName(databaseName)\n                             .withNextToken(nextToken));\n-                    result.getTableList().forEach(table -> tableNames.add(table.getName()));\n+                    result.getTableList().stream()\n+                            .filter(hideDeltaLakeTables\n+                                    ? table -> !table.getParameters().getOrDefault(SPARK_TABLE_PROVIDER_KEY, \"\").equalsIgnoreCase(DELTA_LAKE_PROVIDER)\n+                                    : table -> true)\n+                            .forEach(table -> tableNames.add(table.getName()));", "originalCommit": "7f4e4baee4fc7475112264365b0c066bd975fb84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NzM5Mg==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500467392", "bodyText": "Delta Lake", "author": "electrum", "createdAt": "2020-10-06T17:19:36Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftHiveMetastore.java", "diffHunk": "@@ -227,6 +227,7 @@ public ThriftHiveMetastore(\n         requireNonNull(hiveConfig, \"hiveConfig is null\");\n         this.translateHiveViews = hiveConfig.isTranslateHiveViews();\n         requireNonNull(metastoreConfig, \"metastoreConfig is null\");\n+        checkArgument(!metastoreConfig.isHideDeltaLakeTables(), \"Hiding delta tables is not supported\"); // TODO", "originalCommit": "7f4e4baee4fc7475112264365b0c066bd975fb84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODE4MA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500468180", "bodyText": "Do we want to add this here? It means users could set it directly", "author": "electrum", "createdAt": "2020-10-06T17:20:55Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveTableProperties.java", "diffHunk": "@@ -153,6 +155,7 @@ public HiveTableProperties(\n                 stringProperty(TEXTFILE_FIELD_SEPARATOR, \"TEXTFILE field separator character\", null, false),\n                 stringProperty(TEXTFILE_FIELD_SEPARATOR_ESCAPE, \"TEXTFILE field separator escape character\", null, false),\n                 stringProperty(NULL_FORMAT_PROPERTY, \"Serialization format for NULL value\", null, false),\n+                stringProperty(SPARK_TABLE_PROVIDER, \"Internal Hive connector property\", null, true),", "originalCommit": "7f4e4baee4fc7475112264365b0c066bd975fb84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNDI3MQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r500504271", "bodyText": "I am aware. It's hidden. I see no other way to test this. Please advise.", "author": "findepi", "createdAt": "2020-10-06T18:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxNjQ1OQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501316459", "bodyText": "I thought I commented on the test code, but looks like that got lost. The test can use getMetastoreClient() to call the metastore directly to create the table, rather than going through ConnectorMetadata. This means we don't need to add the table property.", "author": "electrum", "createdAt": "2020-10-07T21:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxNTg2Ng==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501615866", "bodyText": "Done", "author": "findepi", "createdAt": "2020-10-08T10:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODE4MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMzMxMw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501313313", "bodyText": "This can be inline\nreturn getChildSchemaDirectories(getDatabaseMetadataDirectory(databaseName)).stream()\n        .map(Path::getName)\n        .collect(toImmutableList());", "author": "electrum", "createdAt": "2020-10-07T21:13:11Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -439,6 +429,23 @@ public synchronized void updatePartitionStatistics(HiveIdentity identity, Table\n                 .collect(toImmutableList());\n     }\n \n+    @GuardedBy(\"this\")\n+    private List<String> listAllTables(String databaseName)\n+    {\n+        requireNonNull(databaseName, \"databaseName is null\");\n+\n+        Optional<Database> database = getDatabase(databaseName);\n+        if (database.isEmpty()) {\n+            return ImmutableList.of();\n+        }\n+\n+        Path databaseMetadataDirectory = getDatabaseMetadataDirectory(databaseName);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwMzg0OA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501603848", "bodyText": "This is existing code and i prefer not to improve it this time.", "author": "findepi", "createdAt": "2020-10-08T10:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMzMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMzY0NQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501313645", "bodyText": "This check isn't needed, as we pass is straight to getDatabase() which already does the check.", "author": "electrum", "createdAt": "2020-10-07T21:13:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -439,6 +429,23 @@ public synchronized void updatePartitionStatistics(HiveIdentity identity, Table\n                 .collect(toImmutableList());\n     }\n \n+    @GuardedBy(\"this\")\n+    private List<String> listAllTables(String databaseName)\n+    {\n+        requireNonNull(databaseName, \"databaseName is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwMzkyNA==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501603924", "bodyText": "This is existing code and i prefer not to improve it this time.", "author": "findepi", "createdAt": "2020-10-08T10:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMzY0NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NzQ5OQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501847499", "bodyText": "This could be done inline, no need for the variable\nreturn metastore.getTable(...)\n    .filter(...)", "author": "electrum", "createdAt": "2020-10-08T16:18:48Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -748,15 +751,19 @@ public TableStatistics getTableStatistics(ConnectorSession session, ConnectorTab\n         if (!filterSchema(tableName.getSchemaName())) {\n             return ImmutableList.of();\n         }\n+\n+        Optional<Table> optionalTable;\n         try {\n-            if (metastore.getTable(new HiveIdentity(session), tableName.getSchemaName(), tableName.getTableName()).isEmpty()) {\n-                return ImmutableList.of();\n-            }\n+            optionalTable = metastore.getTable(new HiveIdentity(session), tableName.getSchemaName(), tableName.getTableName());\n         }\n         catch (HiveViewNotSupportedException e) {\n             // exists, would be returned by listTables from schema\n+            return ImmutableList.of(tableName);\n         }\n-        return ImmutableList.of(tableName);\n+        return optionalTable", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3Njg5NQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501876895", "bodyText": "I wanted the catch(HiveViewNotSupportedException to cover as little as required", "author": "findepi", "createdAt": "2020-10-08T17:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0NzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0ODU5OQ==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501848599", "bodyText": "Let's be explicit and call this hive.hide-delta-lake-tables", "author": "electrum", "createdAt": "2020-10-08T16:20:25Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreConfig.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+\n+public class MetastoreConfig\n+{\n+    private boolean hideDeltaLakeTables;\n+\n+    public boolean isHideDeltaLakeTables()\n+    {\n+        return hideDeltaLakeTables;\n+    }\n+\n+    @Config(\"hive.hide-delta-tables\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NzIyNw==", "url": "https://github.com/trinodb/trino/pull/5430#discussion_r501877227", "bodyText": "good catch", "author": "findepi", "createdAt": "2020-10-08T17:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg0ODU5OQ=="}], "type": "inlineReview"}, {"oid": "4c6b63c31573462a839fcf53fa627d1bea06c815", "url": "https://github.com/trinodb/trino/commit/4c6b63c31573462a839fcf53fa627d1bea06c815", "message": "Extract method", "committedDate": "2020-10-08T17:05:23Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "1f4681b46ebeb0867c0523ab3ef6910d459c0e82", "url": "https://github.com/trinodb/trino/commit/1f4681b46ebeb0867c0523ab3ef6910d459c0e82", "message": "Hide Delta Lake tables\n\nHive connector cannot read from Delta Lake tables and some users prefer\nnot to see such tables at all.", "committedDate": "2020-10-08T21:16:18Z", "type": "commit"}, {"oid": "1f4681b46ebeb0867c0523ab3ef6910d459c0e82", "url": "https://github.com/trinodb/trino/commit/1f4681b46ebeb0867c0523ab3ef6910d459c0e82", "message": "Hide Delta Lake tables\n\nHive connector cannot read from Delta Lake tables and some users prefer\nnot to see such tables at all.", "committedDate": "2020-10-08T21:16:18Z", "type": "forcePushed"}]}