{"pr_number": 3686, "pr_title": "Add Remote exchange forcefully if aggregation has empty grouping set", "pr_createdAt": "2020-05-09T17:47:53Z", "pr_url": "https://github.com/trinodb/trino/pull/3686", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422553897", "bodyText": "should this be applied when child.getProperties().isNodePartitionedOn(partitioningRequirement) && node.hasEmptyGroupingSet()?", "author": "findepi", "createdAt": "2020-05-09T22:25:51Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1NTA5OA==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422555098", "bodyText": "Yes, it has to be applied unconditionally. In the sample query, the subquery is partitioned in a compatible way and it prevents the partial from being pushed down beyond the exchange, which causes the failure.", "author": "martint", "createdAt": "2020-05-09T22:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNDU1Mw==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422604553", "bodyText": "if it is already repartitioned in the compatible way, maybe we don't need a partial?", "author": "findepi", "createdAt": "2020-05-10T07:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNDkxNQ==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422604915", "bodyText": "Partials and remote exchanges are required when default aggregation is present. Each partial aggregation produces default value and such rows are then aggregated in final exchange so that only single default value is outputted", "author": "sopel39", "createdAt": "2020-05-10T07:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNTIzMg==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422605232", "bodyText": "Makes sense, thanks for explanation. Maybe let's capture this as a code comment.", "author": "findepi", "createdAt": "2020-05-10T07:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MTcyMQ==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425141721", "bodyText": "each arg in newline", "author": "sopel39", "createdAt": "2020-05-14T13:36:14Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1377,6 +1377,25 @@ public void testRemoveRedundantRightJoin()\n                         values(ImmutableList.of(\"regionkey\"))));\n     }\n \n+    @Test\n+    public void testGroupingSetsWithDefaultValue()\n+    {\n+        assertDistributedPlan(\"SELECT orderkey, COUNT(DISTINCT k) FROM (SELECT orderkey, 1 k FROM orders) GROUP BY GROUPING SETS ((), orderkey)\",\n+                output(\n+                        anyTree(\n+                                aggregation(\n+                                        ImmutableMap.of(\"final_count\", functionCall(\"count\", ImmutableList.of(\"partial_count\"))),\n+                                        FINAL,\n+                                        exchange(LOCAL, REPARTITION,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NTg2Nw==", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425445867", "bodyText": "this should go to AbstractTestAggregations", "author": "sopel39", "createdAt": "2020-05-14T21:38:01Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -1924,4 +1924,12 @@ public void testSubqueriesWithDisjunction()\n                         \"LIMIT 2\",\n                 \"VALUES true, null\");\n     }\n+\n+    @Test\n+    public void testGroupingSetsWithDefaultValue() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5436a047f012b287e38660164fbebffad60f7a5e", "url": "https://github.com/trinodb/trino/commit/5436a047f012b287e38660164fbebffad60f7a5e", "message": "Add Remote exchange forcefully if aggregation has empty grouping set", "committedDate": "2020-05-15T09:25:02Z", "type": "commit"}, {"oid": "5436a047f012b287e38660164fbebffad60f7a5e", "url": "https://github.com/trinodb/trino/commit/5436a047f012b287e38660164fbebffad60f7a5e", "message": "Add Remote exchange forcefully if aggregation has empty grouping set", "committedDate": "2020-05-15T09:25:02Z", "type": "forcePushed"}]}