{"pr_number": 3922, "pr_title": "Make split scheduling cache aware", "pr_createdAt": "2020-06-04T15:38:52Z", "pr_url": "https://github.com/trinodb/trino/pull/3922", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwNjI2Mg==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435406262", "bodyText": "Add a comment on what this does and why 5 is important.", "author": "dain", "createdAt": "2020-06-04T16:54:03Z", "path": "presto-main/src/main/java/io/prestosql/execution/scheduler/UniformNodeSelector.java", "diffHunk": "@@ -262,7 +262,7 @@ private void equateDistribution(Multimap<InternalNode, Split> assignment, NodeAs\n             InternalNode maxNode = maxNodes.poll();\n             InternalNode minNode = minNodes.poll();\n \n-            if (assignmentStats.getTotalSplitCount(maxNode) - assignmentStats.getTotalSplitCount(minNode) <= 1) {\n+            if (assignmentStats.getTotalSplitCount(maxNode) - assignmentStats.getTotalSplitCount(minNode) <= 5) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMTQ0NQ==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435421445", "bodyText": "+1 . 5 looks very much like a magic number. Why not 7?", "author": "losipiuk", "createdAt": "2020-06-04T17:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwNjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3NTM1Mg==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435875352", "bodyText": "I've added explanation in commit message plus comment in code.", "author": "sopel39", "createdAt": "2020-06-05T12:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwNjI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxODY0OQ==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435418649", "bodyText": "noop statement drop.", "author": "losipiuk", "createdAt": "2020-06-04T17:14:42Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestNodeScheduler.java", "diffHunk": "@@ -601,10 +607,69 @@ public void testEquateDistribution()\n         Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n         assertEquals(assignment.size(), 20);\n         assertEquals(assignment.keySet().size(), 4);\n-        assertEquals(assignment.get(node1).size(), 5);\n-        assertEquals(assignment.get(node2).size(), 5);\n-        assertEquals(assignment.get(node3).size(), 5);\n-        assertEquals(assignment.get(node4).size(), 5);\n+        assertEquals(assignment.get(node1).size(), 8);\n+        assertEquals(assignment.get(node2).size(), 4);\n+        assertEquals(assignment.get(node3).size(), 4);\n+        assertEquals(assignment.get(node4).size(), 4);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] equateDistributionTestParameters()\n+    {\n+        return new Object[][] {\n+                {5, 10, 0.00},\n+                {5, 20, 0.05},\n+                {10, 50, 0.00},\n+                {10, 100, 0.04},\n+                {10, 200, 0.085},\n+                {50, 550, 0.040},\n+                {50, 600, 0.042},\n+                {50, 700, 0.040},\n+                {100, 550, 0.031},\n+                {100, 600, 0.049},\n+                {100, 1000, 0.034},\n+                {100, 1500, 0.04}};\n+    }\n+\n+    @Test(dataProvider = \"equateDistributionTestParameters\")\n+    public void testEquateDistributionConsistentHashing(int numberOfNodes, int numberOfSplits, double misassignedSplitsRatio)\n+    {\n+        ImmutableList.Builder<InternalNode> nodesBuilder = ImmutableList.builder();\n+        for (int i = 0; i < numberOfNodes; ++i) {\n+            InternalNode node = new InternalNode(\"node\" + i, URI.create(\"http://10.0.0.1:\" + (i + 10)), NodeVersion.UNKNOWN, false);\n+            nodesBuilder.add(node);\n+            nodeManager.addNode(CONNECTOR_ID, node);\n+        }\n+        List<InternalNode> nodes = nodesBuilder.build();\n+\n+        Set<Split> splits = new LinkedHashSet<>();\n+        Random random = new Random(0);\n+        ImmutableSetMultimap.Builder<InternalNode, Split> originalAssignmentBuilder = ImmutableSetMultimap.builder();\n+        // assign splits randomly according to consistent hashing\n+        for (int i = 0; i < numberOfSplits; i++) {\n+            InternalNode node = nodes.get(Hashing.consistentHash(random.nextInt(), nodes.size()));\n+            Split split = new Split(CONNECTOR_ID, new TestSplitLocal(node.getHostAndPort()), Lifespan.taskWide());\n+            splits.add(split);\n+            originalAssignmentBuilder.put(node, split);\n+        }\n+\n+        Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n+\n+        Multimap<Split, InternalNode> originalNodeAssignment = originalAssignmentBuilder.build().inverse();\n+        Multimap<Split, InternalNode> nodeAssignment = ImmutableSetMultimap.copyOf(assignment).inverse();\n+\n+        int miassignedSplits = 0;\n+        for (Split split : splits) {\n+            if (nodeAssignment.get(split).isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMDAwMA==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435420000", "bodyText": "move this line just above\n Multimap<Split, InternalNode> nodeAssignment = ImmutableSetMultimap.copyOf(assignment).inverse();", "author": "losipiuk", "createdAt": "2020-06-04T17:17:06Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestNodeScheduler.java", "diffHunk": "@@ -601,10 +607,69 @@ public void testEquateDistribution()\n         Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n         assertEquals(assignment.size(), 20);\n         assertEquals(assignment.keySet().size(), 4);\n-        assertEquals(assignment.get(node1).size(), 5);\n-        assertEquals(assignment.get(node2).size(), 5);\n-        assertEquals(assignment.get(node3).size(), 5);\n-        assertEquals(assignment.get(node4).size(), 5);\n+        assertEquals(assignment.get(node1).size(), 8);\n+        assertEquals(assignment.get(node2).size(), 4);\n+        assertEquals(assignment.get(node3).size(), 4);\n+        assertEquals(assignment.get(node4).size(), 4);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] equateDistributionTestParameters()\n+    {\n+        return new Object[][] {\n+                {5, 10, 0.00},\n+                {5, 20, 0.05},\n+                {10, 50, 0.00},\n+                {10, 100, 0.04},\n+                {10, 200, 0.085},\n+                {50, 550, 0.040},\n+                {50, 600, 0.042},\n+                {50, 700, 0.040},\n+                {100, 550, 0.031},\n+                {100, 600, 0.049},\n+                {100, 1000, 0.034},\n+                {100, 1500, 0.04}};\n+    }\n+\n+    @Test(dataProvider = \"equateDistributionTestParameters\")\n+    public void testEquateDistributionConsistentHashing(int numberOfNodes, int numberOfSplits, double misassignedSplitsRatio)\n+    {\n+        ImmutableList.Builder<InternalNode> nodesBuilder = ImmutableList.builder();\n+        for (int i = 0; i < numberOfNodes; ++i) {\n+            InternalNode node = new InternalNode(\"node\" + i, URI.create(\"http://10.0.0.1:\" + (i + 10)), NodeVersion.UNKNOWN, false);\n+            nodesBuilder.add(node);\n+            nodeManager.addNode(CONNECTOR_ID, node);\n+        }\n+        List<InternalNode> nodes = nodesBuilder.build();\n+\n+        Set<Split> splits = new LinkedHashSet<>();\n+        Random random = new Random(0);\n+        ImmutableSetMultimap.Builder<InternalNode, Split> originalAssignmentBuilder = ImmutableSetMultimap.builder();\n+        // assign splits randomly according to consistent hashing\n+        for (int i = 0; i < numberOfSplits; i++) {\n+            InternalNode node = nodes.get(Hashing.consistentHash(random.nextInt(), nodes.size()));\n+            Split split = new Split(CONNECTOR_ID, new TestSplitLocal(node.getHostAndPort()), Lifespan.taskWide());\n+            splits.add(split);\n+            originalAssignmentBuilder.put(node, split);\n+        }\n+\n+        Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMDM2Mw==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435420363", "bodyText": "typo misassignedSplits", "author": "losipiuk", "createdAt": "2020-06-04T17:17:43Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestNodeScheduler.java", "diffHunk": "@@ -601,10 +607,69 @@ public void testEquateDistribution()\n         Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n         assertEquals(assignment.size(), 20);\n         assertEquals(assignment.keySet().size(), 4);\n-        assertEquals(assignment.get(node1).size(), 5);\n-        assertEquals(assignment.get(node2).size(), 5);\n-        assertEquals(assignment.get(node3).size(), 5);\n-        assertEquals(assignment.get(node4).size(), 5);\n+        assertEquals(assignment.get(node1).size(), 8);\n+        assertEquals(assignment.get(node2).size(), 4);\n+        assertEquals(assignment.get(node3).size(), 4);\n+        assertEquals(assignment.get(node4).size(), 4);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] equateDistributionTestParameters()\n+    {\n+        return new Object[][] {\n+                {5, 10, 0.00},\n+                {5, 20, 0.05},\n+                {10, 50, 0.00},\n+                {10, 100, 0.04},\n+                {10, 200, 0.085},\n+                {50, 550, 0.040},\n+                {50, 600, 0.042},\n+                {50, 700, 0.040},\n+                {100, 550, 0.031},\n+                {100, 600, 0.049},\n+                {100, 1000, 0.034},\n+                {100, 1500, 0.04}};\n+    }\n+\n+    @Test(dataProvider = \"equateDistributionTestParameters\")\n+    public void testEquateDistributionConsistentHashing(int numberOfNodes, int numberOfSplits, double misassignedSplitsRatio)\n+    {\n+        ImmutableList.Builder<InternalNode> nodesBuilder = ImmutableList.builder();\n+        for (int i = 0; i < numberOfNodes; ++i) {\n+            InternalNode node = new InternalNode(\"node\" + i, URI.create(\"http://10.0.0.1:\" + (i + 10)), NodeVersion.UNKNOWN, false);\n+            nodesBuilder.add(node);\n+            nodeManager.addNode(CONNECTOR_ID, node);\n+        }\n+        List<InternalNode> nodes = nodesBuilder.build();\n+\n+        Set<Split> splits = new LinkedHashSet<>();\n+        Random random = new Random(0);\n+        ImmutableSetMultimap.Builder<InternalNode, Split> originalAssignmentBuilder = ImmutableSetMultimap.builder();\n+        // assign splits randomly according to consistent hashing\n+        for (int i = 0; i < numberOfSplits; i++) {\n+            InternalNode node = nodes.get(Hashing.consistentHash(random.nextInt(), nodes.size()));\n+            Split split = new Split(CONNECTOR_ID, new TestSplitLocal(node.getHostAndPort()), Lifespan.taskWide());\n+            splits.add(split);\n+            originalAssignmentBuilder.put(node, split);\n+        }\n+\n+        Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n+\n+        Multimap<Split, InternalNode> originalNodeAssignment = originalAssignmentBuilder.build().inverse();\n+        Multimap<Split, InternalNode> nodeAssignment = ImmutableSetMultimap.copyOf(assignment).inverse();\n+\n+        int miassignedSplits = 0;\n+        for (Split split : splits) {\n+            if (nodeAssignment.get(split).isEmpty()) {\n+                int l = 0;\n+            }\n+\n+            if (!getOnlyElement(originalNodeAssignment.get(split)).equals(getOnlyElement(nodeAssignment.get(split)))) {\n+                miassignedSplits++;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMTI4Mw==", "url": "https://github.com/trinodb/trino/pull/3922#discussion_r435421283", "bodyText": "how did you come up with the numbers?", "author": "losipiuk", "createdAt": "2020-06-04T17:19:15Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestNodeScheduler.java", "diffHunk": "@@ -601,10 +607,69 @@ public void testEquateDistribution()\n         Multimap<InternalNode, Split> assignment = nodeSelector.computeAssignments(splits, ImmutableList.copyOf(taskMap.values())).getAssignments();\n         assertEquals(assignment.size(), 20);\n         assertEquals(assignment.keySet().size(), 4);\n-        assertEquals(assignment.get(node1).size(), 5);\n-        assertEquals(assignment.get(node2).size(), 5);\n-        assertEquals(assignment.get(node3).size(), 5);\n-        assertEquals(assignment.get(node4).size(), 5);\n+        assertEquals(assignment.get(node1).size(), 8);\n+        assertEquals(assignment.get(node2).size(), 4);\n+        assertEquals(assignment.get(node3).size(), 4);\n+        assertEquals(assignment.get(node4).size(), 4);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] equateDistributionTestParameters()\n+    {\n+        return new Object[][] {\n+                {5, 10, 0.00},", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e977dc9266acb1616a7f4a7f3bcbd76a42cda36", "url": "https://github.com/trinodb/trino/commit/0e977dc9266acb1616a7f4a7f3bcbd76a42cda36", "message": "Make split scheduling Hive cache aware", "committedDate": "2020-06-05T12:31:58Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "ac9375f14aa7411b9583efd4ac87351c12b768f1", "url": "https://github.com/trinodb/trino/commit/ac9375f14aa7411b9583efd4ac87351c12b768f1", "message": "Allow some degreee of non-uniformity in equateDistribution\n\nThe difference of 5 between node with maximum and minimum\nsplits is a tradeoff between ratio of misassigned splits\nand assignment uniformity. Using larger numbers doesn't\nreduce the number of misassigned splits greatly (in absolute values).\n\nBelow are tests results for different acceptable splits differences:\nmax - min <= 1\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.1\n5\t\t20\t\t0.25\n10\t\t50\t\t0.12\n10\t\t100\t\t0.11\n10\t\t200\t\t0.085\n50\t\t550\t\t0.110\n50\t\t600\t\t0.111\n50\t\t700\t\t0.102\n100\t\t550\t\t0.121\n100\t\t600\t\t0.163\n100\t\t1000\t\t0.107\n100\t\t1500\t\t0.091\n\nmax - min <= 2\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.15\n10\t\t50\t\t0.04\n10\t\t100\t\t0.07\n10\t\t200\t\t0.085\n50\t\t550\t\t0.07\n50\t\t600\t\t0.075\n50\t\t700\t\t0.068\n100\t\t550\t\t0.116\n100\t\t600\t\t0.093\n100\t\t1000\t\t0.068\n100\t\t1500\t\t0.062\n\nmax - min <= 3\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.1\n10\t\t50\t\t0.02\n10\t\t100\t\t0.07\n10\t\t200\t\t0.085\n50\t\t550\t\t0.065\n50\t\t600\t\t0.073\n50\t\t700\t\t0.067\n100\t\t550\t\t0.061\n100\t\t600\t\t0.093\n100\t\t1000\t\t0.063\n100\t\t1500\t\t0.059\n\nmax - min <= 4\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.1\n10\t\t50\t\t0.0\n10\t\t100\t\t0.04\n10\t\t200\t\t0.085\n50\t\t550\t\t0.043\n50\t\t600\t\t0.046\n50\t\t700\t\t0.047\n100\t\t550\t\t0.06\n100\t\t600\t\t0.051\n100\t\t1000\t\t0.042\n100\t\t1500\t\t0.04\n\nmax - min <= 5\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.05\n10\t\t50\t\t0.0\n10\t\t100\t\t0.04\n10\t\t200\t\t0.085\n50\t\t550\t\t0.036\n50\t\t600\t\t0.041\n50\t\t700\t\t0.04\n100\t\t550\t\t0.03\n100\t\t600\t\t0.048\n100\t\t1000\t\t0.034\n100\t\t1500\t\t0.037\n\nmax - min <= 6\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.0\n10\t\t50\t\t0.0\n10\t\t100\t\t0.02\n10\t\t200\t\t0.085\n50\t\t550\t\t0.023\n50\t\t600\t\t0.028\n50\t\t700\t\t0.031\n100\t\t550\t\t0.029\n100\t\t600\t\t0.025\n100\t\t1000\t\t0.025\n100\t\t1500\t\t0.027\n\nmax - min <= 7\n\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.0\n10\t\t50\t\t0.0\n10\t\t100\t\t0.01\n10\t\t200\t\t0.085\n50\t\t550\t\t0.018\n50\t\t600\t\t0.018\n50\t\t700\t\t0.022\n100\t\t550\t\t0.012\n100\t\t600\t\t0.021\n100\t\t1000\t\t0.015\n100\t\t1500\t\t0.022\n\nmax - min <= 8\nnodes\t\tsplits\t\tratio\n5\t\t10\t\t0.0\n5\t\t20\t\t0.0\n10\t\t50\t\t0.0\n10\t\t100\t\t0.0\n10\t\t200\t\t0.085\n50\t\t550\t\t0.014\n50\t\t600\t\t0.016\n50\t\t700\t\t0.02\n100\t\t550\t\t0.009\n100\t\t600\t\t0.011\n100\t\t1000\t\t0.013\n100\t\t1500\t\t0.018", "committedDate": "2020-06-08T13:14:31Z", "type": "commit"}, {"oid": "83edddc5cc68c5e3ff316949735dd66d40f426b8", "url": "https://github.com/trinodb/trino/commit/83edddc5cc68c5e3ff316949735dd66d40f426b8", "message": "Update Rubix to 0.3.11", "committedDate": "2020-06-08T13:14:32Z", "type": "commit"}, {"oid": "9af5849a7c3e60499bf6da5f7c6c4179f91a24d5", "url": "https://github.com/trinodb/trino/commit/9af5849a7c3e60499bf6da5f7c6c4179f91a24d5", "message": "Remove PrestoClusterManager", "committedDate": "2020-06-08T13:14:32Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "283f9441474dd20bad41d365b5a501fc01c2fabc", "url": "https://github.com/trinodb/trino/commit/283f9441474dd20bad41d365b5a501fc01c2fabc", "message": "Make split scheduling Hive cache aware", "committedDate": "2020-06-08T19:30:58Z", "type": "commit"}, {"oid": "283f9441474dd20bad41d365b5a501fc01c2fabc", "url": "https://github.com/trinodb/trino/commit/283f9441474dd20bad41d365b5a501fc01c2fabc", "message": "Make split scheduling Hive cache aware", "committedDate": "2020-06-08T19:30:58Z", "type": "forcePushed"}]}