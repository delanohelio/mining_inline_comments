{"pr_number": 4458, "pr_title": "Expose CachingHiveMetastore metrics via JMX", "pr_createdAt": "2020-07-15T15:28:20Z", "pr_url": "https://github.com/trinodb/trino/pull/4458", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMjc5OQ==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455612799", "bodyText": "please move it above to other compile scope airlift dependencies", "author": "kokosing", "createdAt": "2020-07-16T08:25:10Z", "path": "presto-hive/pom.xml", "diffHunk": "@@ -351,6 +351,10 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.airlift</groupId>\n+            <artifactId>jmx</artifactId>\n+        </dependency>", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455613041", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n          \n          \n            \n                    cacheBuilder.recordStats();\n          \n          \n            \n                    cacheBuilder = cacheBuilder.maximumSize(maximumSize)\n          \n          \n            \n                        .recordStats();", "author": "kokosing", "createdAt": "2020-07-16T08:25:30Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -949,6 +951,7 @@ public boolean isImpersonationEnabled()\n             cacheBuilder = cacheBuilder.refreshAfterWrite(refreshMillis.getAsLong(), MILLISECONDS);\n         }\n         cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n+        cacheBuilder.recordStats();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzIxMg==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455613212", "bodyText": "Does it have influence on performance?", "author": "kokosing", "createdAt": "2020-07-16T08:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5Mjg4Ng==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455992886", "bodyText": "Does it have influence on performance?\n\nCachingHiveMetastore used during query planning to get information about tables/partitions/etc. recordStats() pattern is used in ExpressionCompiler, JoinCompiler, other *Compilterclasses which called much more often  then CachingHiveMetastore (there more expressions that tables in each query). As a result I don't expect material performance impact.\nAlso, number of events should be close to number of events produced by ThriftHiveMetastore when no caching is used that already exposed via JMX.\nStill trying to figure out how to run benchmarking and coverage for these class.", "author": "kosinsky", "createdAt": "2020-07-16T18:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk1NTExOA==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r456955118", "bodyText": "Still trying to figure out how to run benchmarking and coverage for these class.\n\nI don't think we need automated tests for that. It is ok.", "author": "kokosing", "createdAt": "2020-07-19T21:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYyMDYxNQ==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r457620615", "bodyText": "please only records stats for caching metastore between transactions. Do not enable it for transactional caching metastore (the one which is created per each transaction).", "author": "kokosing", "createdAt": "2020-07-20T18:50:02Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -948,7 +950,8 @@ public boolean isImpersonationEnabled()\n         if (refreshMillis.isPresent() && (expiresAfterWriteMillis.isEmpty() || expiresAfterWriteMillis.getAsLong() > refreshMillis.getAsLong())) {\n             cacheBuilder = cacheBuilder.refreshAfterWrite(refreshMillis.getAsLong(), MILLISECONDS);\n         }\n-        cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n+        cacheBuilder = cacheBuilder.maximumSize(maximumSize)\n+            .recordStats();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MjY0Mg==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r465952642", "bodyText": "Done. I'm not using recordStats() when cache created via memoizeMetastore that used in transactions", "author": "kosinsky", "createdAt": "2020-08-05T19:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYyMDYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIyMzgyOA==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r466223828", "bodyText": "Please define an enum. That way it will be much more readable when you pass STATS_RECORDING_ENABLED (or StatsRecording.ENABLED) instead of true.", "author": "kokosing", "createdAt": "2020-08-06T08:09:16Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -132,7 +134,8 @@ public static HiveMetastore cachingHiveMetastore(HiveMetastore delegate, Executo\n                         .map(Duration::toMillis)\n                         .map(OptionalLong::of)\n                         .orElseGet(OptionalLong::empty),\n-                maximumSize);\n+                maximumSize,\n+                true);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUxNjQ1Ng==", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r466516456", "bodyText": "Done", "author": "kosinsky", "createdAt": "2020-08-06T15:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIyMzgyOA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "url": "https://github.com/trinodb/trino/commit/8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "message": "Expose CachingHiveMetastore metrics via JMX", "committedDate": "2020-08-06T18:59:41Z", "type": "commit"}, {"oid": "8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "url": "https://github.com/trinodb/trino/commit/8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "message": "Expose CachingHiveMetastore metrics via JMX", "committedDate": "2020-08-06T18:59:41Z", "type": "forcePushed"}]}