{"pr_number": 4228, "pr_title": "Fix potential dynamic filters leak", "pr_createdAt": "2020-06-25T19:39:22Z", "pr_url": "https://github.com/trinodb/trino/pull/4228", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1OTYzNA==", "url": "https://github.com/trinodb/trino/pull/4228#discussion_r446259634", "bodyText": "Why do this before distributed planning?  In the old code this was performed after starting, which is a few lines down in this file.", "author": "dain", "createdAt": "2020-06-26T15:38:57Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java", "diffHunk": "@@ -352,6 +365,7 @@ public void start()\n                 }\n \n                 PlanRoot plan = planQuery();\n+                registerDynamicFilteringQuery();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQxNDkxMg==", "url": "https://github.com/trinodb/trino/pull/4228#discussion_r446414912", "bodyText": "DynamicFilterService needs plan to extract DF, so query registration has to happen after planning.\ndynamic filter suppliers are created in planDistribution just line below.\n\nRegistering query here removes the need to support query has not been registered yet case in DynamicFilterService, which simplifies #4224.\nI will add comment to code", "author": "sopel39", "createdAt": "2020-06-26T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1OTYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDIwNw==", "url": "https://github.com/trinodb/trino/pull/4228#discussion_r446260207", "bodyText": "Can we do this without the condition on isEnableDynamicFiltering?  If so, I would just for safety.", "author": "dain", "createdAt": "2020-06-26T15:40:00Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java", "diffHunk": "@@ -211,6 +199,31 @@ else if (state.isDone()) {\n         }\n     }\n \n+    private synchronized void registerDynamicFilteringQuery()\n+    {\n+        if (!isEnableDynamicFiltering(stateMachine.getSession())) {\n+            return;\n+        }\n+\n+        if (isDone()) {\n+            // query already finished\n+            return;\n+        }\n+\n+        dynamicFilterService.registerQuery(this);\n+    }\n+\n+    private synchronized void unregisterDynamicFilteringQuery()\n+    {\n+        if (!isEnableDynamicFiltering(stateMachine.getSession())) {\n+            return;\n+        }\n+\n+        if (isDone()) {\n+            dynamicFilterService.removeQuery(stateMachine.getQueryId());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDQ0Nw==", "url": "https://github.com/trinodb/trino/pull/4228#discussion_r446260447", "bodyText": "Maybe merge these conditions", "author": "dain", "createdAt": "2020-06-26T15:40:26Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java", "diffHunk": "@@ -211,6 +199,31 @@ else if (state.isDone()) {\n         }\n     }\n \n+    private synchronized void registerDynamicFilteringQuery()\n+    {\n+        if (!isEnableDynamicFiltering(stateMachine.getSession())) {\n+            return;\n+        }\n+\n+        if (isDone()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQxMzc0Mw==", "url": "https://github.com/trinodb/trino/pull/4228#discussion_r446413743", "bodyText": "I prefer to leave comment here as it's not obvious why we check this condition here. I've improved comment.", "author": "sopel39", "createdAt": "2020-06-26T21:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDQ0Nw=="}], "type": "inlineReview"}, {"oid": "a8f8b550fb8bbc568f31d6afe6b917eb563aee11", "url": "https://github.com/trinodb/trino/commit/a8f8b550fb8bbc568f31d6afe6b917eb563aee11", "message": "Fix potential dynamic filters leak\n\nQuery was registered to DynamicFilterService\nvia query state machine event listener. However,\nsuch notifications could potentially be executed\nout of order. Therfore query could have been registered\nafter it has finished. This commit makes sure\nthat query won't be registered to DynamicFilterService\nonce its done and that registration/deregistration\nare executed in parallel.", "committedDate": "2020-06-26T21:23:01Z", "type": "commit"}, {"oid": "a8f8b550fb8bbc568f31d6afe6b917eb563aee11", "url": "https://github.com/trinodb/trino/commit/a8f8b550fb8bbc568f31d6afe6b917eb563aee11", "message": "Fix potential dynamic filters leak\n\nQuery was registered to DynamicFilterService\nvia query state machine event listener. However,\nsuch notifications could potentially be executed\nout of order. Therfore query could have been registered\nafter it has finished. This commit makes sure\nthat query won't be registered to DynamicFilterService\nonce its done and that registration/deregistration\nare executed in parallel.", "committedDate": "2020-06-26T21:23:01Z", "type": "forcePushed"}]}