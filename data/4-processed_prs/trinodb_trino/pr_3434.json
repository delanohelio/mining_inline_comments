{"pr_number": 3434, "pr_title": "Allow using temporary staging path for writing sorted files", "pr_createdAt": "2020-04-14T23:09:26Z", "pr_url": "https://github.com/trinodb/trino/pull/3434", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcxNzI0MQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r460717241", "bodyText": "If we could generate a path based on this property then we can use it for both fileSystem and when creating SortedFileWriter ?\nsortedWritingTempPath.map(Path::new).orElse(path)", "author": "Praveen2112", "createdAt": "2020-07-27T08:09:34Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -497,7 +500,12 @@ else if (insertExistingPartitionsBehavior == InsertExistingPartitionsBehavior.ER\n         if (!sortedBy.isEmpty()) {\n             FileSystem fileSystem;\n             try {\n-                fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), path, conf);\n+                if (sortedWritingTempPath.isPresent()) {\n+                    fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), new Path(sortedWritingTempPath.get()), conf);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1MjM3OQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r461352379", "bodyText": "Done", "author": "raunaqmorarka", "createdAt": "2020-07-28T06:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcxNzI0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNDg0NQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r464934845", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            configuration.set(FS_DEFAULT_NAME_KEY, \"file:///\");\n          \n          \n            \n                            configuration.set(FS_DEFAULT_NAME_KEY, FS_DEFAULT_NAME_DEFAULT);", "author": "Praveen2112", "createdAt": "2020-08-04T09:50:53Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -496,8 +500,14 @@ else if (insertExistingPartitionsBehavior == InsertExistingPartitionsBehavior.ER\n \n         if (!sortedBy.isEmpty()) {\n             FileSystem fileSystem;\n+            Path tempFilePath = sortedWritingTempPath\n+                    .map(tempPath -> new Path(tempPath, \".tmp-sort.\" + path.getParent().getName() + \".\" + path.getName()))\n+                    .orElse(new Path(path.getParent(), \".tmp-sort.\" + path.getName()));\n             try {\n-                fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), path, conf);\n+                Configuration configuration = new Configuration(conf);\n+                // Explicitly set the default FS to local file system to avoid getting HDFS when sortedWritingTempPath specifies no scheme\n+                configuration.set(FS_DEFAULT_NAME_KEY, \"file:///\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1MTYxNw==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466851617", "bodyText": "I avoided using FS_DEFAULT_NAME_DEFAULT because I'm not sure whether it's guaranteed to be file:/// in future. Though it's unlikely this will change, it's also not clear from the name FS_DEFAULT_NAME_DEFAULT that is local FS uri", "author": "raunaqmorarka", "createdAt": "2020-08-07T06:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNDg0NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5NzgwNQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466197805", "bodyText": "Commit tittle is too long. It wraps in github.", "author": "kokosing", "createdAt": "2020-08-06T07:23:04Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,14 @@ Property Name                                      Description\n ", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0OTc5Ng==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466849796", "bodyText": "made it shorter", "author": "raunaqmorarka", "createdAt": "2020-08-07T06:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5NzgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466198371", "bodyText": "Why not to use hive.temporary-staging-directory-path?", "author": "kokosing", "createdAt": "2020-08-06T07:23:59Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,14 @@ Property Name                                      Description\n \n ``hive.file-status-cache-expire-time``             How long a cached directory listing should be considered     ``1m``\n                                                    valid.\n+\n+``hive.sorted-writing-temp-path``                  Directory used for temporary files while writing bucketed", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIwOTUxMg==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466209512", "bodyText": "We could use it, though we would need to introduce a boolean toggle hive.sorted-writing-temporary-staging-enabled  or would we tie it to existing flag hive.temporary-staging-directory-enabled ?\nhive.temporary-staging-directory-enabled is enabled by default and hive.temporary-staging-directory-path is also set to /tmp/presto-${USER} by default.", "author": "raunaqmorarka", "createdAt": "2020-08-06T07:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIyNzMxOA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466227318", "bodyText": "or would we tie it to existing flag hive.temporary-staging-directory-enabled ?\n\nThat would my preference. Why would you like to have it separate?\n\nhive.temporary-staging-directory-enabled is enabled by default and hive.temporary-staging-directory-path is also set to /tmp/presto-${USER} by default.\n\nIt sounds like a good default value for bucketed tables as well.", "author": "kokosing", "createdAt": "2020-08-06T08:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3OTE1Mg==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466479152", "bodyText": "I think enabling it would at least double the storage requirements from the current requirement for staging S3 writes. So having a separate on/off toggle would be good. I'll make the change to use the same directory location though, I don't see any issue with that.\nI'm inclined to enable the toggle by default but it risks failures in some cases https://prestosql.slack.com/archives/CGB0QHWSW/p1576613895090800?thread_ts=1576180076.157800&cid=CGB0QHWSW", "author": "raunaqmorarka", "createdAt": "2020-08-06T15:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1MDc1MA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466850750", "bodyText": "Made changes to add hive.sorted-writing-temp-staging-path-enabled, it's disabled by default and the path used is hive.temporary-staging-directory-path when the flag is enabled.", "author": "raunaqmorarka", "createdAt": "2020-08-07T06:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg3MDc0MQ==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466870741", "bodyText": "I think enabling it would at least double the storage requirements from the current requirement for staging S3 writes.\n\nThat highly depends on use case. I am under the impression that not many people are doing writes to sorted bucketed tables, otherwise we would get more complains. If I am correct, then most people won't notice a change. On the other hand you you are using sorted tables much frequently than other tables then it also does not matter.\nMy point is that having two configuration toggles for very similar things makes it more complicated to maintain the Presto installation.  Maybe we should use single toggle for both cases and fallback if we hit some problem? WDYT?\n@electrum Do you have any thoughts for that?", "author": "kokosing", "createdAt": "2020-08-07T07:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAzMjQ5Mw==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r467032493", "bodyText": "I'm ok to enable hive.sorted-writing-temp-staging-path-enabled by default but I think there may still be a case to retain a separate flag as the 2 flags are not exactly the same thing. Disabling hive.sorted-writing-temp-staging-path-enabled results in the existing behavior of using target path for staging sorted writes instead of a local path. But disabling hive.temporary-staging-directory-enabled results in direct writes to target path with no staging.\nI'm concerned that if we have a common flag and if someone wants to disable staging of sorted writes on local path, then they would also be forced to use direct writes for non-sorted table cases.\nIf there is agreement that this is not big a deal, I'm ok to use just one flag as well.", "author": "raunaqmorarka", "createdAt": "2020-08-07T13:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MTE5MA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r470951190", "bodyText": "I've made changes to reuse hive.temporary-staging-directory-enabled and removed hive.sorted-writing-temp-staging-path-enabled now", "author": "raunaqmorarka", "createdAt": "2020-08-15T07:50:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ2OTcyMA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r470469720", "bodyText": "Could you also add docs for hive.temporary-staging-directory-path and hive.temporary-staging-directory-enabled with session properties? It is a pity that you refer to something that does not exists. Possibly that should be done in separate commit.", "author": "kokosing", "createdAt": "2020-08-14T07:57:33Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,16 @@ Property Name                                      Description\n \n ``hive.file-status-cache-expire-time``             How long a cached directory listing should be considered     ``1m``\n                                                    valid.\n+\n+``hive.sorted-writing-temp-staging-path-enabled``  Use ``hive.temporary-staging-directory-path`` for temporary  false", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0OTc2Mg==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r470949762", "bodyText": "Added documentation for hive.temporary-staging-directory-path and hive.temporary-staging-directory-enabled config properties. I wasn't sure where the session properties should be documented, there doesn't seem to a separate column or convention for it in current doc.", "author": "raunaqmorarka", "createdAt": "2020-08-15T07:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ2OTcyMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "df0c056eec3a4279665b27ce3b189bb46312cda6", "url": "https://github.com/trinodb/trino/commit/df0c056eec3a4279665b27ce3b189bb46312cda6", "message": "Allow using temporary staging path for writing sorted files", "committedDate": "2020-08-16T07:00:04Z", "type": "commit"}, {"oid": "414846c0bdae2c43b6f992ef72dd166f00efbd5a", "url": "https://github.com/trinodb/trino/commit/414846c0bdae2c43b6f992ef72dd166f00efbd5a", "message": "Document hive temporary staging directory configs", "committedDate": "2020-08-16T07:00:05Z", "type": "commit"}, {"oid": "414846c0bdae2c43b6f992ef72dd166f00efbd5a", "url": "https://github.com/trinodb/trino/commit/414846c0bdae2c43b6f992ef72dd166f00efbd5a", "message": "Document hive temporary staging directory configs", "committedDate": "2020-08-16T07:00:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMjQ3OA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r471412478", "bodyText": "don't you need to use io.prestosql.plugin.hive.util.HiveWriteUtils#createTemporaryPath?", "author": "kokosing", "createdAt": "2020-08-17T11:21:58Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2335,9 +2337,17 @@ private void doTestBucketSortedTables(SchemaTableName table)\n                 sink.appendPage(builder.build().toPage());\n             }\n \n-            // verify we have enough temporary files per bucket to require multiple passes\n-            Path stagingPathRoot = getStagingPathRoot(outputHandle);\n             HdfsContext context = new HdfsContext(session, table.getSchemaName(), table.getTableName());\n+            // verify we have enough temporary files per bucket to require multiple passes\n+            Path stagingPathRoot;\n+            if (isTemporaryStagingDirectoryEnabled(session)) {\n+                stagingPathRoot = new Path(getTemporaryStagingDirectoryPath(session)", "originalCommit": "df0c056eec3a4279665b27ce3b189bb46312cda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1NzA5MA==", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r471457090", "bodyText": "metadata.beginCreateTable (a few lines above) calls locationService.forNewTable, this has a call to createTemporaryPath. Here we are just setting up the right path for listing staged files for verification.", "author": "raunaqmorarka", "createdAt": "2020-08-17T12:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMjQ3OA=="}], "type": "inlineReview"}]}