{"pr_number": 3196, "pr_title": "Add null check for HashStrategy of CustomObjects", "pr_createdAt": "2020-03-22T15:32:04Z", "pr_url": "https://github.com/trinodb/trino/pull/3196", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyOTg0Nw==", "url": "https://github.com/trinodb/trino/pull/3196#discussion_r396129847", "bodyText": "These tests are ineffective, at least for decimal(38), since it is converted to bigint during planning, which I verified by looking at the explain plan. I'm not sure why it happens for decimal(38) but not decimal(18).\nLet's remove these and replace with direct tests for InCodeGenerator, as we don't need to run such expensive tests against every connector. The primary purpose of this test is to very end-to-end against the engine and connectors for large sets. (if we only care about InCodeGenerator, we just need a list of at least 33 elements)", "author": "electrum", "createdAt": "2020-03-22T19:11:32Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -2188,6 +2188,10 @@ public void testLargeIn()\n                 .collect(joining(\", \"));\n         assertQuery(\"SELECT orderkey FROM orders WHERE orderkey IN (\" + longValues + \")\");\n         assertQuery(\"SELECT orderkey FROM orders WHERE orderkey NOT IN (\" + longValues + \")\");\n+        assertQuery(\"SELECT orderkey FROM orders WHERE CAST(orderkey AS DECIMAL(38)) IN (\" + longValues + \")\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2NjM4MA==", "url": "https://github.com/trinodb/trino/pull/3196#discussion_r401766380", "bodyText": "Split this into two checks for isShortDecimal and isLongDecimal, then we can validate the type is correct for each one.", "author": "electrum", "createdAt": "2020-04-01T16:56:50Z", "path": "presto-spi/src/main/java/io/prestosql/spi/connector/InMemoryRecordSet.java", "diffHunk": "@@ -243,6 +244,10 @@ else if (type instanceof RowType) {\n                     checkArgument(value instanceof Block,\n                             \"Expected value %d to be an instance of Block, but is a %s\", i, value.getClass().getSimpleName());\n                 }\n+                else if (type instanceof DecimalType) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3ODM3Mg==", "url": "https://github.com/trinodb/trino/pull/3196#discussion_r401778372", "bodyText": "Nit: these could be outside the try/catch", "author": "electrum", "createdAt": "2020-04-01T17:15:10Z", "path": "presto-main/src/main/java/io/prestosql/util/FastutilSetHelper.java", "diffHunk": "@@ -190,6 +190,9 @@ private ObjectStrategy(Metadata metadata, Type type)\n         public int hashCode(Object value)\n         {\n             try {\n+                if (value == null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgxOTMwMA==", "url": "https://github.com/trinodb/trino/pull/3196#discussion_r401819300", "bodyText": "I think this can also be 2000, 7000", "author": "electrum", "createdAt": "2020-04-01T18:23:37Z", "path": "presto-main/src/test/java/io/prestosql/sql/gen/TestExpressionCompiler.java", "diffHunk": "@@ -1321,6 +1321,18 @@ public void testHugeIn()\n         assertExecute(\"bound_timestamp_with_timezone in (\" + timestampValues + \")\", BOOLEAN, true);\n         assertExecute(\"bound_timestamp_with_timezone in (TIMESTAMP '1970-01-01 01:01:00.0+02:00')\", BOOLEAN, false);\n \n+        String shortDecimalValues = range(2000, 7000)\n+                .mapToObj(value -> format(\"decimal '%s'\", value))\n+                .collect(joining(\", \"));\n+        assertExecute(\"bound_short_decimal in (1234, \" + shortDecimalValues + \")\", BOOLEAN, true);\n+        assertExecute(\"bound_short_decimal in (\" + shortDecimalValues + \")\", BOOLEAN, false);\n+\n+        String longDecimalValues = range(2000, 3000)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "59c3f6db58a881fb3c951e8fa81ecfb9553db1c8", "url": "https://github.com/trinodb/trino/commit/59c3f6db58a881fb3c951e8fa81ecfb9553db1c8", "message": "Add support for reading decimal in InMemoryRecordSet", "committedDate": "2020-04-04T03:36:58Z", "type": "commit"}, {"oid": "34d2efb9e4c1b421aff391a09fc2238c0ae919ae", "url": "https://github.com/trinodb/trino/commit/34d2efb9e4c1b421aff391a09fc2238c0ae919ae", "message": "Add null check for HashStrategy of CustomObjects", "committedDate": "2020-04-04T03:36:59Z", "type": "commit"}, {"oid": "34d2efb9e4c1b421aff391a09fc2238c0ae919ae", "url": "https://github.com/trinodb/trino/commit/34d2efb9e4c1b421aff391a09fc2238c0ae919ae", "message": "Add null check for HashStrategy of CustomObjects", "committedDate": "2020-04-04T03:36:59Z", "type": "forcePushed"}]}