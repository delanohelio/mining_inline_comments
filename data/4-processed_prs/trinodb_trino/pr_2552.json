{"pr_number": 2552, "pr_title": "Fix delegation call in ViewAccessControl", "pr_createdAt": "2020-01-20T05:37:41Z", "pr_url": "https://github.com/trinodb/trino/pull/2552", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3NTg5OA==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r368775898", "bodyText": "The sentence is truncated. It should be\n\nand thus must have the equivalent of the SQL standard \"GRANT ... WITH GRANT OPTION\".", "author": "electrum", "createdAt": "2020-01-21T01:27:09Z", "path": "presto-main/src/main/java/io/prestosql/security/ViewAccessControl.java", "diffHunk": "@@ -32,6 +32,10 @@ public ViewAccessControl(AccessControl delegate)\n     @Override\n     public void checkCanSelectFromColumns(SecurityContext context, QualifiedObjectName tableName, Set<String> columnNames)\n     {\n+        // This is intentional and matches the SQL standard for view security.\n+        // In SQL, views are special in that they execute with permissions of the owner.\n+        // This means that the owner of the view is effectively granting permissions to the user running the query,\n+        // and thus must have the equivalent of the SQL standard.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3NjU0NA==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r368776544", "bodyText": "I think this would be easier to read with shorter variable names. Also, introduce a variable\nClass<?> forwardingClass = forwardingInstance.getClass();\nMethod forwardingMethod = forwardingClass.getMethod(method.getName().method.getParameterTypes());\nreturn forwardingClass == forwardingMethod.getDeclaringClass();", "author": "electrum", "createdAt": "2020-01-21T01:30:58Z", "path": "presto-spi/src/test/java/io/prestosql/spi/testing/InterfaceTestUtils.java", "diffHunk": "@@ -64,11 +64,22 @@ private InterfaceTestUtils() {}\n                     }));\n \n             try {\n+                if (!defines(forwardingInstance, actualMethod)) {\n+                    continue;\n+                }\n+\n                 actualMethod.invoke(forwardingInstance, actualArguments);\n             }\n             catch (Exception e) {\n                 throw new RuntimeException(format(\"Invocation of %s has failed\", actualMethod), e);\n             }\n         }\n     }\n+\n+    private static boolean defines(Object forwardingInstance, Method actualMethod)\n+            throws Exception\n+    {\n+        Class<?> forwardingInstanceClass = forwardingInstance.getClass();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e770e4724872a4c5e79224601df0b21bafc3d269", "url": "https://github.com/trinodb/trino/commit/e770e4724872a4c5e79224601df0b21bafc3d269", "message": "Do not verify methods that are not overridden", "committedDate": "2020-01-21T16:53:08Z", "type": "commit"}, {"oid": "c1e424a782f250c6a0ef12220b78313f0556fd9f", "url": "https://github.com/trinodb/trino/commit/c1e424a782f250c6a0ef12220b78313f0556fd9f", "message": "Add a comment to ViewAccessControl", "committedDate": "2020-01-21T16:53:08Z", "type": "commit"}, {"oid": "c1e424a782f250c6a0ef12220b78313f0556fd9f", "url": "https://github.com/trinodb/trino/commit/c1e424a782f250c6a0ef12220b78313f0556fd9f", "message": "Add a comment to ViewAccessControl", "committedDate": "2020-01-21T16:53:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370095208", "bodyText": "What is this needed for?", "author": "findepi", "createdAt": "2020-01-23T12:42:46Z", "path": "presto-spi/src/test/java/io/prestosql/spi/testing/InterfaceTestUtils.java", "diffHunk": "@@ -64,11 +64,23 @@ private InterfaceTestUtils() {}\n                     }));\n \n             try {\n+                if (!defines(forwardingInstance, actualMethod)) {\n+                    continue;", "originalCommit": "e770e4724872a4c5e79224601df0b21bafc3d269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEyNTk4Mw==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370125983", "bodyText": "When forwarding class does not implement all methods.", "author": "kokosing", "createdAt": "2020-01-23T13:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3NTEzNw==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370175137", "bodyText": "i removed the check and apparently all tests passed\nwhy a forwarding class would want to forward part of the methods only?\nisn't the point of a forwarding class to be complete, including interface's default methods?", "author": "findepi", "createdAt": "2020-01-23T15:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NDE1Mw==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370184153", "bodyText": "i removed the check and apparently all tests passed\n\nThat is correct.\n\nwhy a forwarding class would want to forward part of the methods only?\n\nI don't know. That depends on context of forwarding class. Notice that we check if a forwarding method call in separate assertion to assertion that check if all methods are implemented.\nHence I find these two properties independent.\nTypically Forwarding class forward all methods, but it might be not always the case.", "author": "kokosing", "createdAt": "2020-01-23T15:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MDkzNA==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370190934", "bodyText": "Typically Forwarding class forward all methods, but it might be not always the case.\n\nthen it's not a true forwarding class. it's dangerous  beast, especially when combined with default interface methods than we use often,\nas you may end up calling eg old deprecated overload even if the target impls the new overload\nlet me remove this if", "author": "findepi", "createdAt": "2020-01-23T15:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1MTM2NA==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370551364", "bodyText": "But you have the other assertion to check if all methods are implemented. Running two assertions make sure that you have true forwarding class. I don't like you the fact this assertion might depend on  passing other assertion.", "author": "kokosing", "createdAt": "2020-01-24T09:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYwODI5OQ==", "url": "https://github.com/trinodb/trino/pull/2552#discussion_r370608299", "bodyText": "#2618", "author": "findepi", "createdAt": "2020-01-24T12:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTIwOA=="}], "type": "inlineReview"}]}