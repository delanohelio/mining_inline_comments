{"pr_number": 3248, "pr_title": "Add logging in SqlFormatterUtil", "pr_createdAt": "2020-03-26T16:16:30Z", "pr_url": "https://github.com/trinodb/trino/pull/3248", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwNDAyOA==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398704028", "bodyText": "Remove space before newline and after tab. Single tab should be sufficient:\nlog.debug(\"Formatted query does not parse:\\n\\tstatement: [%s]\\n\\tformatted: [%s]\", statement, sql);\nI'm also thinking we don't need brackets around the statement, since it will be of the form Query{...} produced by ToStringBuilder:\nlog.debug(\"Formatted query does not parse:\\n\\tstatement: %s\\n\\tformatted: [%s]\", statement, sql);", "author": "electrum", "createdAt": "2020-03-26T16:18:47Z", "path": "presto-main/src/main/java/io/prestosql/sql/SqlFormatterUtil.java", "diffHunk": "@@ -37,9 +40,11 @@ public static String getFormattedSql(Statement statement, SqlParser sqlParser)\n             parsed = sqlParser.createStatement(sql, parsingOptions);\n         }\n         catch (ParsingException e) {\n-            throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Formatted query does not parse: \" + statement);\n+            log.debug(\"Formatted query does not parse: \\n\\t\\t statement: [%s] \\n\\t\\t formatted: [%s]\", statement, sql);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMzE2Nw==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398713167", "bodyText": "Remove space before newline and after tab.\n\ni kept it for readability (i know in final output it's not needed, but shouldn't hurt)\n\nSingle tab should be sufficient:\n\nat lines are intended with a tab, that's why i used two tabs\n\nI'm also thinking we don't need brackets around the statement,\n\nright", "author": "findepi", "createdAt": "2020-03-26T16:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwNDAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMDkxOA==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398730918", "bodyText": "It bugs me from a readability standpoint, since I read it thinking about how the final output looks like. But I understand your point.\n\nat lines are intended with a tab, that's why i used two tabs\n\nAh, makes sense.", "author": "electrum", "createdAt": "2020-03-26T16:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwNDAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMjQ0MA==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398712440", "bodyText": "Since statement is likely huge, it might be better to attach, which also gives us a place to put the SQL:\nPrestoException error = new PrestoException(GENERIC_INTERNAL_ERROR, \"Formatted query does not parse\", e);\nerror.addSuppressed(new RuntimeException(\"Statement: \" + statement));\nerror.addSuppressed(new RuntimeException(format(\"Formatted: [%s]\", sql)));\nthrow error;", "author": "electrum", "createdAt": "2020-03-26T16:28:53Z", "path": "presto-main/src/main/java/io/prestosql/sql/SqlFormatterUtil.java", "diffHunk": "@@ -37,9 +40,11 @@ public static String getFormattedSql(Statement statement, SqlParser sqlParser)\n             parsed = sqlParser.createStatement(sql, parsingOptions);\n         }\n         catch (ParsingException e) {\n-            throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Formatted query does not parse: \" + statement);\n+            log.debug(\"Formatted query does not parse: \\n\\t\\t statement: [%s] \\n\\t\\t formatted: [%s]\", statement, sql);\n+            throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Formatted query does not parse: \" + statement, e);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxNDI1Mw==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398714253", "bodyText": "nice, i can do that\nnote that sql will contain many newlines anyway (same for statement to string), which will affect any fmting we do\n(i don't want to reprocess the sql to add indents though)", "author": "findepi", "createdAt": "2020-03-26T16:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMjc0MQ==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398732741", "bodyText": "I now realize that if we include all the information in the exception, we shouldn't log, since that violates the no log-and-throw principal. (i.e. all the info is available in the query failure, just like for any other failure)", "author": "electrum", "createdAt": "2020-03-26T16:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkwNDMyMw==", "url": "https://github.com/trinodb/trino/pull/3248#discussion_r398904323", "bodyText": "that's why i removed logging", "author": "findepi", "createdAt": "2020-03-26T21:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMjQ0MA=="}], "type": "inlineReview"}, {"oid": "118ef0d118e07524a0c6760bc3f7db6d8a2c883a", "url": "https://github.com/trinodb/trino/commit/118ef0d118e07524a0c6760bc3f7db6d8a2c883a", "message": "Report formatted SQL when does not parse", "committedDate": "2020-03-27T06:48:03Z", "type": "commit"}, {"oid": "118ef0d118e07524a0c6760bc3f7db6d8a2c883a", "url": "https://github.com/trinodb/trino/commit/118ef0d118e07524a0c6760bc3f7db6d8a2c883a", "message": "Report formatted SQL when does not parse", "committedDate": "2020-03-27T06:48:03Z", "type": "forcePushed"}]}