{"pr_number": 4736, "pr_title": "Possibility to lowercase/uppercase matched user name", "pr_createdAt": "2020-08-07T14:07:20Z", "pr_url": "https://github.com/trinodb/trino/pull/4736", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDIzNw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467364237", "bodyText": "Case? Like class.", "author": "kokosing", "createdAt": "2020-08-08T05:19:47Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)\n+        {\n+            this.transformation = requireNonNull(transformation, \"transformation is null\");\n+        }\n+\n+        public final String transform(String value)\n+        {\n+            return transformation.apply(value);\n+        }\n+    }\n+\n     public static final class Rule\n     {\n         private final Pattern pattern;\n         private final String user;\n         private final boolean allow;\n+        private final Case kase;\n \n         public Rule(String pattern)\n         {\n-            this(pattern, \"$1\", true);\n+            this(pattern, \"$1\", true, Case.KEEP);\n         }\n \n         @JsonCreator\n         public Rule(\n                 @JsonProperty(\"pattern\") String pattern,\n                 @JsonProperty(\"user\") Optional<String> user,\n-                @JsonProperty(\"allow\") Optional<Boolean> allow)\n+                @JsonProperty(\"allow\") Optional<Boolean> allow,\n+                @JsonProperty(\"case\") Optional<Case> kase)\n         {\n             this(pattern,\n                     requireNonNull(user, \"user is null\").orElse(\"$1\"),\n-                    requireNonNull(allow, \"allow is null\").orElse(TRUE));\n+                    requireNonNull(allow, \"allow is null\").orElse(TRUE),\n+                    requireNonNull(kase, \"kase is null\").orElse(Case.KEEP));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3MjYyNg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467372626", "bodyText": "parameter name is kase because case is a keyword. The thing commonly used in other projects is something like _case or case_ but here checkstyle disallows it, so changing spelling is second commonly used thing (like class -> klass or clazz)", "author": "iirekm", "createdAt": "2020-08-08T07:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NjE5Mw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467496193", "bodyText": "uh... sorry auto correction fix caze to case. I wanted to say:\ncaze? like clazz? kase looks like a typo to me. Also I am under impression that it is more common in languages that z sounds closer to s than k to c.\nI don't have strong preference. Up to you.", "author": "kokosing", "createdAt": "2020-08-08T19:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczNDg4OA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467734888", "bodyText": "Instead of fighting with this, wouldn't be better to add regexp like (case|switch|if|while|...)_ in checkstyle rules?\nOr at least use //CHECKSTYLE:OFF for such variable declarations.", "author": "iirekm", "createdAt": "2020-08-10T07:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTc4Mw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467791783", "bodyText": "I am not sure about this regexp. Please open such pull request and we could continue the discussion there. How about applying: https://github.com/prestosql/presto/pull/4736/files#r467496420?", "author": "kokosing", "createdAt": "2020-08-10T09:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDQwMw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467364403", "bodyText": "Use require non null", "author": "kokosing", "createdAt": "2020-08-08T05:21:11Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)\n+        {\n+            this.transformation = requireNonNull(transformation, \"transformation is null\");\n+        }\n+\n+        public final String transform(String value)\n+        {\n+            return transformation.apply(value);\n+        }\n+    }\n+\n     public static final class Rule\n     {\n         private final Pattern pattern;\n         private final String user;\n         private final boolean allow;\n+        private final Case kase;\n \n         public Rule(String pattern)\n         {\n-            this(pattern, \"$1\", true);\n+            this(pattern, \"$1\", true, Case.KEEP);\n         }\n \n         @JsonCreator\n         public Rule(\n                 @JsonProperty(\"pattern\") String pattern,\n                 @JsonProperty(\"user\") Optional<String> user,\n-                @JsonProperty(\"allow\") Optional<Boolean> allow)\n+                @JsonProperty(\"allow\") Optional<Boolean> allow,\n+                @JsonProperty(\"case\") Optional<Case> kase)\n         {\n             this(pattern,\n                     requireNonNull(user, \"user is null\").orElse(\"$1\"),\n-                    requireNonNull(allow, \"allow is null\").orElse(TRUE));\n+                    requireNonNull(allow, \"allow is null\").orElse(TRUE),\n+                    requireNonNull(kase, \"kase is null\").orElse(Case.KEEP));\n         }\n \n-        public Rule(String pattern, String user, boolean allow)\n+        public Rule(String pattern, String user, boolean allow, Case kase)\n         {\n             this.pattern = Pattern.compile(requireNonNull(pattern, \"pattern is null\"));\n             this.user = requireNonNull(user, \"user is null\");\n             this.allow = allow;\n+            this.kase = kase;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3MzA5OA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467373098", "bodyText": "I forgot\nBut anyway, isn't this code too defensive? Using requireNotNull everywhere adds a lot of noise to code. Only 4 lines (field declarations) in this class are meaningful, the rest is ugly boilerplate code!\nIt's enough to use @NotNull annotation, IntelliJ recognizes it, and can be configured to produce compile error when you try to to pass a nullable value to @NotNull parameter.\nAnother alternative: use immutables.org annotation processor. It can generate all this mess automatically, eg recognizes @NotNull annotation and generates appropriate requireNonNull from it.", "author": "iirekm", "createdAt": "2020-08-08T07:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NjAzNg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467496036", "bodyText": "@NotNul\n\nThis is also a boilreplate. In general most variables are non null. So I would prefer to configure compiler to fail if @Nullable is missing. Is it possible.\nAlso this is a discussion about project convention which way out of the scope of this pull request.", "author": "kokosing", "createdAt": "2020-08-08T19:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczNTc4Mg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467735782", "bodyText": "yes, this is a topic for another discussion, but whatever, with @Nullable or @NotNull + some autogenerated code is better than what we have now (tons of boilerplate code + every possible convention of creating classes)", "author": "iirekm", "createdAt": "2020-08-10T07:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDUzMw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467364533", "bodyText": "Static import", "author": "kokosing", "createdAt": "2020-08-08T05:22:38Z", "path": "presto-main/src/test/java/io/prestosql/server/security/TestUserMapping.java", "diffHunk": "@@ -70,29 +70,29 @@ public void testSimplePatternRule()\n     public void testReplacePatternRule()\n             throws Exception\n     {\n-        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"$1 ^ $1\", true)));\n+        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"$1 ^ $1\", true, UserMapping.Case.KEEP)));\n         assertEquals(userMapping.mapUser(\"test@example.com\"), \"test ^ test\");\n         assertThrows(UserMappingException.class, () -> userMapping.mapUser(\"no at sign\"));\n \n-        UserMapping emptyMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"  \", true)));\n+        UserMapping emptyMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"  \", true, UserMapping.Case.KEEP)));\n         assertThrows(UserMappingException.class, () -> emptyMapping.mapUser(\"test@example.com\"));\n     }\n \n     @Test\n     public void testNotAllowedRule()\n     {\n-        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"$1\", false)));\n+        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"$1\", false, UserMapping.Case.KEEP)));\n         assertThrows(UserMappingException.class, () -> userMapping.mapUser(\"test@example.com\"));\n \n-        UserMapping emptyMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"\", false)));\n+        UserMapping emptyMapping = new UserMapping(ImmutableList.of(new Rule(\"(.*?)@.*\", \"\", false, UserMapping.Case.KEEP)));\n         assertThrows(UserMappingException.class, () -> emptyMapping.mapUser(\"test@example.com\"));\n     }\n \n     @Test\n     public void testMultipleRule()\n             throws Exception\n     {\n-        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"test@example.com\", \"\", false), new Rule(\"(.*?)@example.com\")));\n+        UserMapping userMapping = new UserMapping(ImmutableList.of(new Rule(\"test@example.com\", \"\", false, UserMapping.Case.KEEP), new Rule(\"(.*?)@example.com\")));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3MjQ3Mg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467372472", "bodyText": "can't somebody configure checkstyle / sonar / intellij rules for that, once and for all? This is what intellij does by default after typing KEEP", "author": "iirekm", "createdAt": "2020-08-08T07:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NTg3OQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467495879", "bodyText": "It is hard to have a rule for a class that you have just added. Also I would prefer to not have such rule for Case class as in this context it is clear what it is, but in other it might not be.", "author": "kokosing", "createdAt": "2020-08-08T19:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczNjkzNQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467736935", "bodyText": "it should be possible even with checkstyle: just block things like ([A-Za-z0-9_]+\\\\.)+[A-Z0-9_]+", "author": "iirekm", "createdAt": "2020-08-10T07:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDU2OQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467364569", "bodyText": "We also need to update documentation", "author": "kokosing", "createdAt": "2020-08-08T05:23:18Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3MjEyNg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467372126", "bodyText": "where is it?", "author": "iirekm", "createdAt": "2020-08-08T07:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NTc0OQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467495749", "bodyText": "https://github.com/prestosql/presto/blob/master/presto-docs/src/main/sphinx/security/user-mapping.rst", "author": "kokosing", "createdAt": "2020-08-08T19:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2NDU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NjQyMA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467496420", "bodyText": "Alternatively, capitalization", "author": "martint", "createdAt": "2020-08-08T19:27:06Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)\n+        {\n+            this.transformation = requireNonNull(transformation, \"transformation is null\");\n+        }\n+\n+        public final String transform(String value)\n+        {\n+            return transformation.apply(value);\n+        }\n+    }\n+\n     public static final class Rule\n     {\n         private final Pattern pattern;\n         private final String user;\n         private final boolean allow;\n+        private final Case kase;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2ODMxMQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r467768311", "bodyText": "Or userCase, since this applies to the username.", "author": "electrum", "createdAt": "2020-08-10T08:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4NTkzMw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r471385933", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-17T10:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5NjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxMDA1Ng==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r469910056", "bodyText": "Please extract this to separate commit and add a test for that.", "author": "kokosing", "createdAt": "2020-08-13T12:21:39Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/util/JsonUtils.java", "diffHunk": "@@ -42,7 +43,8 @@ private JsonUtils() {}\n         try {\n             byte[] json = Files.readAllBytes(path);\n             ObjectMapper mapper = new ObjectMapperProvider().get()\n-                    .enable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n+                    .enable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)\n+                    .enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_ENUMS);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM5NDY0NA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r471394644", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-17T10:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxMDA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyNTg0OA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r470725848", "bodyText": "Let's call the variables userCase everywhere instead of using a misspelling. (the JSON property name can stay as case)", "author": "electrum", "createdAt": "2020-08-14T16:22:57Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)\n+        {\n+            this.transformation = requireNonNull(transformation, \"transformation is null\");\n+        }\n+\n+        public final String transform(String value)\n+        {\n+            return transformation.apply(value);\n+        }\n+    }\n+\n     public static final class Rule\n     {\n         private final Pattern pattern;\n         private final String user;\n         private final boolean allow;\n+        private final Case kase;\n \n         public Rule(String pattern)\n         {\n-            this(pattern, \"$1\", true);\n+            this(pattern, \"$1\", true, Case.KEEP);\n         }\n \n         @JsonCreator\n         public Rule(\n                 @JsonProperty(\"pattern\") String pattern,\n                 @JsonProperty(\"user\") Optional<String> user,\n-                @JsonProperty(\"allow\") Optional<Boolean> allow)\n+                @JsonProperty(\"allow\") Optional<Boolean> allow,\n+                @JsonProperty(\"case\") Optional<Case> kase)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4NjQ5MQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r471386491", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-17T10:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyNTg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyNjg0MA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r470726840", "bodyText": "No need for this here, unless we think we will be adding more later. The purpose of this construct is to have cleaner diffs when adding future items (as the previously last item won't be disturbed).", "author": "electrum", "createdAt": "2020-08-14T16:24:52Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyOTE2Nw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r470729167", "bodyText": "No need for final, since enums are sealed", "author": "electrum", "createdAt": "2020-08-14T16:29:40Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)\n+        {\n+            this.transformation = requireNonNull(transformation, \"transformation is null\");\n+        }\n+\n+        public final String transform(String value)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyOTgwNg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r470729806", "bodyText": "Consider the simpler (albeit slightly longer) pattern of implementing a method (the IDE folds it nicely)\nenum Case\n{\n    KEEP {\n        @Override\n        public String transform(String value)\n        {\n            return value;\n        }\n    },\n    LOWER {\n        @Override\n        public String transform(String value)\n        {\n            return value.toLowerCase(Locale.ENGLISH);\n        }\n    },\n    UPPER {\n        @Override\n        public String transform(String value)\n        {\n            return value.toLowerCase(Locale.ENGLISH);\n        }\n    };\n\n    public abstract String transform(String value);\n}", "author": "electrum", "createdAt": "2020-08-14T16:30:53Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,57 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP(Function.identity()),\n+        LOWER(value -> value.toLowerCase(Locale.ENGLISH)),\n+        UPPER(value -> value.toUpperCase(Locale.ENGLISH)),\n+        /**/;\n+\n+        private final Function<String, String> transformation;\n+\n+        Case(Function<String, String> transformation)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4NTc1OQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r471385759", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-17T10:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyOTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczOTc1Nw==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r470739757", "bodyText": "Thanks for documenting this. Some comments:\n\nList items need to be indented two spaces. The extra indentation causes it to be treated as a quoted block.\nUse * for list items to be consistent with the other list items (above).\nThe \"default value\" text below is hard to see, since it's not aligned with the list. We can make it part of the first list item.\ne.g. means \"for example\" and thus should have a comma afterwards\nThe lower/upper items are long enough to wrap in the default HTML rendering, which makes them harder to read. We can shorten them a bit so that they don't wrap.\n\nHere's the result of the above changes:\n* ``case`` (optional): one of:\n\n  * ``keep`` - keep matched user name as is (default behavior)\n  * ``lower`` - lowercase matched user name, e.g., ``Admin`` or ``ADMIN`` will become ``admin``\n  * ``upper`` - uppercase matched user name, e.g., ``admin`` or ``Admin`` will become ``ADMIN``\n\nRendered HTML:", "author": "electrum", "createdAt": "2020-08-14T16:50:43Z", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -41,6 +41,13 @@ following fields:\n * ``user`` (optional): replacement string to substitute against pattern.\n   The default value is ``$1``.\n * ``allow`` (optional): boolean indicating if the authentication should be allowed.\n+* ``case`` (optional): one of:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4NTMwOA==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r471385308", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-17T10:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczOTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1ODYwMg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r474458602", "bodyText": "nice syntax, I haven't used enums that way.", "author": "kokosing", "createdAt": "2020-08-21T07:15:56Z", "path": "presto-main/src/main/java/io/prestosql/server/security/UserMapping.java", "diffHunk": "@@ -84,33 +86,64 @@ public UserMappingRules(\n         }\n     }\n \n+    enum Case\n+    {\n+        KEEP {\n+            @Override\n+            public String transform(String value)\n+            {\n+                return value;\n+            }\n+        },\n+        LOWER {\n+            @Override\n+            public String transform(String value)\n+            {\n+                return value.toLowerCase(ENGLISH);\n+            }\n+        },\n+        UPPER {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1OTM1NQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r474459355", "bodyText": "Please extract this to separate commit.", "author": "kokosing", "createdAt": "2020-08-21T07:16:53Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/util/JsonUtils.java", "diffHunk": "@@ -41,12 +43,20 @@ private JsonUtils() {}\n \n         try {\n             byte[] json = Files.readAllBytes(path);\n-            ObjectMapper mapper = new ObjectMapperProvider().get()\n-                    .enable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n-            return mapper.readValue(json, javaType);\n+            return parseJson(json, javaType);\n         }\n         catch (IOException e) {\n             throw new IllegalArgumentException(format(\"Invalid JSON file '%s' for '%s'\", path, javaType), e);\n         }\n     }\n+\n+    @VisibleForTesting\n+    static <T> T parseJson(byte[] jsonBytes, Class<T> javaType)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1OTU0Mg==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r474459542", "bodyText": "please also test mixed and upper case.", "author": "kokosing", "createdAt": "2020-08-21T07:17:10Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/util/TestJsonUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.base.util;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+\n+import static io.prestosql.plugin.base.util.JsonUtils.parseJson;\n+import static io.prestosql.plugin.base.util.TestJsonUtils.TestEnum.OPTION_A;\n+import static java.nio.charset.StandardCharsets.US_ASCII;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestJsonUtils\n+{\n+    enum TestEnum\n+    {\n+        OPTION_A,\n+        OPTION_B\n+    }\n+\n+    public static class TestObject\n+    {\n+        @JsonProperty\n+        private TestEnum testEnum;\n+    }\n+\n+    @Test\n+    public void testLowercaseEnum()\n+            throws IOException\n+    {\n+        TestObject parsed = parseJson(\"{\\\"testEnum\\\": \\\"option_a\\\"}\".getBytes(US_ASCII), TestObject.class);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUwNjkzOQ==", "url": "https://github.com/trinodb/trino/pull/4736#discussion_r475506939", "bodyText": "you told that we should support only lower case\nuppercase/mixed case would also work (there's no switch in Jackson to enable only lowercase, there's only ACCEPT_CASE_INSENSITIVE_ENUMS), but I would say it should stay undocumented, untested and unsupported, if somebody uses it and some day it stops working, it's their fault", "author": "iirekm", "createdAt": "2020-08-24T10:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1OTU0Mg=="}], "type": "inlineReview"}, {"oid": "2e3e83005dc54a8a644869e56d6caae48125ab60", "url": "https://github.com/trinodb/trino/commit/2e3e83005dc54a8a644869e56d6caae48125ab60", "message": "Configure Jackson to parse enums from lowercase strings", "committedDate": "2020-08-31T10:24:40Z", "type": "commit"}, {"oid": "f6e1632ac129ea8c82f23125506e17a3a89244c8", "url": "https://github.com/trinodb/trino/commit/f6e1632ac129ea8c82f23125506e17a3a89244c8", "message": "Possibility to lowercase/uppercase matched user name", "committedDate": "2020-08-31T10:24:40Z", "type": "commit"}]}