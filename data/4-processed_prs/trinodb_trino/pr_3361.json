{"pr_number": 3361, "pr_title": "Implement applyProjection for JDBC connectors", "pr_createdAt": "2020-04-06T23:09:11Z", "pr_url": "https://github.com/trinodb/trino/pull/3361", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4MzcyNw==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404483727", "bodyText": "Wrapping the Assignment arguments would make this easier to read. Maybe also static import it.", "author": "electrum", "createdAt": "2020-04-07T01:28:29Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -107,12 +111,45 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n                 handle.getCatalogName(),\n                 handle.getSchemaName(),\n                 handle.getTableName(),\n+                handle.getColumns(),\n                 newDomain,\n                 handle.getLimit());\n \n         return Optional.of(new ConstraintApplicationResult<>(handle, constraint.getSummary()));\n     }\n \n+    @Override\n+    public Optional<ProjectionApplicationResult<ConnectorTableHandle>> applyProjection(\n+            ConnectorSession session,\n+            ConnectorTableHandle table,\n+            List<ConnectorExpression> projections,\n+            Map<String, ColumnHandle> assignments)\n+    {\n+        JdbcTableHandle handle = (JdbcTableHandle) table;\n+\n+        List<JdbcColumnHandle> newColumns = assignments.values().stream()\n+                .map(JdbcColumnHandle.class::cast)\n+                .collect(Collectors.toList());\n+\n+        if (handle.getColumns().isPresent() && containSameElements(newColumns, handle.getColumns().get())) {\n+            return Optional.empty();\n+        }\n+\n+        return Optional.of(new ProjectionApplicationResult<>(\n+                new JdbcTableHandle(\n+                        handle.getSchemaTableName(),\n+                        handle.getCatalogName(),\n+                        handle.getSchemaName(),\n+                        handle.getTableName(),\n+                        Optional.of(newColumns),\n+                        handle.getConstraint(),\n+                        handle.getLimit()),\n+                projections,\n+                assignments.entrySet().stream()\n+                        .map(assignment -> new ProjectionApplicationResult.Assignment(assignment.getKey(), assignment.getValue(), ((JdbcColumnHandle) assignment.getValue()).getColumnType()))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4NDY5Nw==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404484697", "bodyText": "This will print like\ncolumns=Optional.empty\n\nor\ncolumns=Optional[[orderkey:bigint:bigint],...]\n\nIt would look nicer to skip when not present\ncolumns.ifPresent(value -> builder.append(\" columns=\").append(value));\nThis is the rendering of the table in explain plans, so we want it to look good.", "author": "electrum", "createdAt": "2020-04-07T01:32:00Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcTableHandle.java", "diffHunk": "@@ -125,6 +137,7 @@ public String toString()\n         StringBuilder builder = new StringBuilder();\n         builder.append(schemaTableName).append(\" \");\n         Joiner.on(\".\").skipNulls().appendTo(builder, catalogName, schemaName, tableName);\n+        builder.append(\" columns=\").append(columns);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1Njg0OQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404556849", "bodyText": "How will SELECT * work for such a table?\nDo we have a test for this?\n(IIRC i added the check here to prevent obscure errors later on, but this may be outdated.)", "author": "findepi", "createdAt": "2020-04-07T06:08:32Z", "path": "presto-main/src/main/java/io/prestosql/metadata/MetadataManager.java", "diffHunk": "@@ -480,9 +480,6 @@ public TableMetadata getTableMetadata(Session session, TableHandle tableHandle)\n         CatalogName catalogName = tableHandle.getCatalogName();\n         ConnectorMetadata metadata = getMetadata(session, catalogName);\n         ConnectorTableMetadata tableMetadata = metadata.getTableMetadata(session.toConnectorSession(catalogName), tableHandle.getConnectorHandle());\n-        if (tableMetadata.getColumns().isEmpty()) {\n-            throw new PrestoException(NOT_SUPPORTED, \"Table has no columns: \" + tableHandle);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1NzM2NQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404557365", "bodyText": "ImmutableList", "author": "findepi", "createdAt": "2020-04-07T06:10:08Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -107,12 +112,48 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n                 handle.getCatalogName(),\n                 handle.getSchemaName(),\n                 handle.getTableName(),\n+                handle.getColumns(),\n                 newDomain,\n                 handle.getLimit());\n \n         return Optional.of(new ConstraintApplicationResult<>(handle, constraint.getSummary()));\n     }\n \n+    @Override\n+    public Optional<ProjectionApplicationResult<ConnectorTableHandle>> applyProjection(\n+            ConnectorSession session,\n+            ConnectorTableHandle table,\n+            List<ConnectorExpression> projections,\n+            Map<String, ColumnHandle> assignments)\n+    {\n+        JdbcTableHandle handle = (JdbcTableHandle) table;\n+\n+        List<JdbcColumnHandle> newColumns = assignments.values().stream()\n+                .map(JdbcColumnHandle.class::cast)\n+                .collect(Collectors.toList());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4ODgxOA==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404588818", "bodyText": "io.prestosql.util.MoreLists#mappedCopy (requires move to plugin toolkit)", "author": "kokosing", "createdAt": "2020-04-07T07:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1NzM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4NjE1Ng==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404886156", "bodyText": "io.prestosql.util.MoreLists#mappedCopy (requires move to plugin toolkit)\n\nThat's overkill for such a simple usage.", "author": "martint", "createdAt": "2020-04-07T15:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1NzM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1ODA2Mw==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404558063", "bodyText": "rnn columns", "author": "findepi", "createdAt": "2020-04-07T06:12:03Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcTableHandle.java", "diffHunk": "@@ -51,13 +55,15 @@ public JdbcTableHandle(\n             @JsonProperty(\"catalogName\") @Nullable String catalogName,\n             @JsonProperty(\"schemaName\") @Nullable String schemaName,\n             @JsonProperty(\"tableName\") String tableName,\n+            @JsonProperty(\"columns\") Optional<List<JdbcColumnHandle>> columns,\n             @JsonProperty(\"constraint\") TupleDomain<ColumnHandle> constraint,\n             @JsonProperty(\"limit\") OptionalLong limit)\n     {\n         this.schemaTableName = requireNonNull(schemaTableName, \"schemaTableName is null\");\n         this.catalogName = catalogName;\n         this.schemaName = schemaName;\n         this.tableName = requireNonNull(tableName, \"tableName is null\");\n+        this.columns = columns.map(ImmutableList::copyOf);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2NDI0NQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404564245", "bodyText": "It\u2019s unnecessary. The call to copy the list will fail eagerly with an NPE anyway. There\u2019s no danger of holding on to an invalid value that will later cause the program to fail - this is the actual goal of validating arguments eagerly.", "author": "martint", "createdAt": "2020-04-07T06:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1ODA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMDE2NA==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404610164", "bodyText": "yes, but it would fail with NPE without clear message, so we still prefer rnn", "author": "findepi", "createdAt": "2020-04-07T07:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1ODA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4OTMyNA==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404889324", "bodyText": "You can look at the stacktrace to see it (since you're going to be debugging anyway). The original motivation for adding these when we started using them in the early years of airlift was what I described above, but ok. One day when we move to Java 14+ we can get rid of all these usages.", "author": "martint", "createdAt": "2020-04-07T15:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1ODA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMDk2OQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404610969", "bodyText": "add verification in io.prestosql.plugin.jdbc.BaseJdbcClient#buildSql that table handle's columns are same as the one passed explicitly", "author": "findepi", "createdAt": "2020-04-07T07:58:03Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcTableHandle.java", "diffHunk": "@@ -88,6 +94,12 @@ public String getTableName()\n         return tableName;\n     }\n \n+    @JsonProperty\n+    public Optional<List<JdbcColumnHandle>> getColumns()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxMDk0MA==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r404910940", "bodyText": "I added it to JdbcRecordsetProvider", "author": "martint", "createdAt": "2020-04-07T15:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMDk2OQ=="}], "type": "inlineReview"}, {"oid": "af3ffcc1188b87ab14725c413bdb1ff175d29407", "url": "https://github.com/trinodb/trino/commit/af3ffcc1188b87ab14725c413bdb1ff175d29407", "message": "Allow table metadata with no columns\n\nSince the introduction of the applyXXX methods, a TableScan\nrepresents a subquery, not just a raw table. It is possible that\nsuch a subquery might have no columns due to a projection being\napplied by the optimizer.", "committedDate": "2020-04-07T14:56:08Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MDMzOQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r405080339", "bodyText": "what about the order?", "author": "kokosing", "createdAt": "2020-04-07T20:07:47Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcRecordSetProvider.java", "diffHunk": "@@ -45,6 +47,13 @@ public RecordSet getRecordSet(ConnectorTransactionHandle transaction, ConnectorS\n         JdbcSplit jdbcSplit = (JdbcSplit) split;\n         JdbcTableHandle jdbcTable = (JdbcTableHandle) table;\n \n+        // In the current API, the columns (and order) needed by the engine are provided via an argument to this method. Make sure that\n+        // any columns that were recorded in the table handle match the requested set.\n+        // If no columns are recorded, it means that applyProjection never got called (e.g., in the case all columns are being used) and all\n+        // table columns should be returned. TODO: this is something that should be addressed once the getRecordSet API is revamped\n+        jdbcTable.getColumns()\n+                .ifPresent(tableColumns -> verify(ImmutableSet.copyOf(columns).equals(ImmutableSet.copyOf(tableColumns))));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDYyOQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r405084629", "bodyText": "Yes, good catch. I didn't recall if we made any guarantees, but the LocalExecutionPlanner respects the order of the output symbols of the TableScan. I'll update to check that, too.", "author": "martint", "createdAt": "2020-04-07T20:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MDMzOQ=="}], "type": "inlineReview"}, {"oid": "6e3f08e5b858920b65e1bdf726cf73f193d33fcb", "url": "https://github.com/trinodb/trino/commit/6e3f08e5b858920b65e1bdf726cf73f193d33fcb", "message": "Implement applyProjection for JDBC connectors", "committedDate": "2020-04-07T20:16:01Z", "type": "commit"}, {"oid": "6e3f08e5b858920b65e1bdf726cf73f193d33fcb", "url": "https://github.com/trinodb/trino/commit/6e3f08e5b858920b65e1bdf726cf73f193d33fcb", "message": "Implement applyProjection for JDBC connectors", "committedDate": "2020-04-07T20:16:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExMjk3Ng==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r405112976", "bodyText": "What about order here?", "author": "kokosing", "createdAt": "2020-04-07T21:06:29Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -322,4 +363,9 @@ public void dropSchema(ConnectorSession session, String schemaName)\n     {\n         jdbcClient.dropSchema(JdbcIdentity.from(session), schemaName);\n     }\n+\n+    private static boolean containSameElements(Iterable<? extends ColumnHandle> first, Iterable<? extends ColumnHandle> second)\n+    {\n+        return ImmutableSet.copyOf(first).equals(ImmutableSet.copyOf(second));", "originalCommit": "6e3f08e5b858920b65e1bdf726cf73f193d33fcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzODQ0MQ==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r405138441", "bodyText": "I can change it, but it doesn't really matter here. There's not much benefit in accepting a pushdown if it only changes the order of the fields (other than eliminating an almost-free projection from the plan)", "author": "martint", "createdAt": "2020-04-07T21:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExMjk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDA0Nw==", "url": "https://github.com/trinodb/trino/pull/3361#discussion_r405144047", "bodyText": "Actually, we have to keep it like this for now. There's something going on in PushProjectionsIntoTableScan that's not preserving the order as it extracts the expressions to project. As a result, the plan never converges. I'll look into it separately and change this later when it's fixed.", "author": "martint", "createdAt": "2020-04-07T22:12:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExMjk3Ng=="}], "type": "inlineReview"}]}