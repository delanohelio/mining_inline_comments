{"pr_number": 3354, "pr_title": "Do not bind ports in product tests on CI", "pr_createdAt": "2020-04-06T11:07:33Z", "pr_url": "https://github.com/trinodb/trino/pull/3354", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwOTAxMg==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404009012", "bodyText": "let's this default behaviour. When needed for manual tests, user could configure launcher on their own.\nAlso let's not use env variable for that, but regular cli parameter.", "author": "kokosing", "createdAt": "2020-04-06T11:09:12Z", "path": ".github/workflows/product-tests.yml", "diffHunk": "@@ -57,5 +57,6 @@ jobs:\n           rm -rf ~/.m2/repository\n       - name: Product Tests\n         run: |\n+          export PTL_BIND_PORTS=false", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMjI2MA==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404012260", "bodyText": "i want env up to expose ports by default and i didn't find a better way to achieve this", "author": "findepi", "createdAt": "2020-04-06T11:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwOTAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwOTU4NQ==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404009585", "bodyText": "make it false on default. Also I would remove PTL_BIND_PORTS env variable, I don't see a need it for right now.", "author": "kokosing", "createdAt": "2020-04-06T11:10:21Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentOptions.java", "diffHunk": "@@ -32,6 +36,9 @@\n     @Option(name = \"--without-presto\", title = \"without Presto\", description = \"do not start presto-master\")\n     public boolean withoutPrestoMaster;\n \n+    @Option(name = \"--bind\", description = \"bind ports on localhost\")\n+    public boolean bindPorts = toBoolean(firstNonNull(System.getenv(\"PTL_BIND_PORTS\"), \"true\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMjM1OQ==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404012359", "bodyText": "replied #3354 (comment)", "author": "findepi", "createdAt": "2020-04-06T11:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwOTU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMDY5OA==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404010698", "bodyText": "Add logging that ports are not going to be exposed to host. Also please mention what user needs to do to expose them.", "author": "kokosing", "createdAt": "2020-04-06T11:12:39Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/testcontainers/PortBinder.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.testcontainers;\n+\n+import io.prestosql.tests.product.launcher.env.DockerContainer;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+\n+import javax.inject.Inject;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class PortBinder\n+{\n+    private final boolean bindPorts;\n+\n+    @Inject\n+    public PortBinder(EnvironmentOptions environmentOptions)\n+    {\n+        this.bindPorts = requireNonNull(environmentOptions, \"environmentOptions is null\").bindPorts;\n+    }\n+\n+    public void exposePort(DockerContainer container, int port)\n+    {\n+        if (!bindPorts) {\n+            return;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMDc1MQ==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404010751", "bodyText": "HostPortBinder?", "author": "kokosing", "createdAt": "2020-04-06T11:12:47Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/testcontainers/PortBinder.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.testcontainers;\n+\n+import io.prestosql.tests.product.launcher.env.DockerContainer;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+\n+import javax.inject.Inject;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class PortBinder", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMjcwOQ==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404012709", "bodyText": "i think it's OK as is.. especially that host is not variable part (as name could be taken as implying)", "author": "findepi", "createdAt": "2020-04-06T11:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxMDc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzNzg4Nw==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404037887", "bodyText": "How can we be sure that we have not exposed ports directly using TestcontainersUtil ?", "author": "wendigo", "createdAt": "2020-04-06T12:04:16Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/testcontainers/PortBinder.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.testcontainers;\n+\n+import io.prestosql.tests.product.launcher.env.DockerContainer;\n+import io.prestosql.tests.product.launcher.env.EnvironmentOptions;\n+\n+import javax.inject.Inject;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class PortBinder\n+{\n+    private final boolean bindPorts;\n+\n+    @Inject\n+    public PortBinder(EnvironmentOptions environmentOptions)\n+    {\n+        this.bindPorts = requireNonNull(environmentOptions, \"environmentOptions is null\").bindPorts;\n+    }\n+\n+    public void exposePort(DockerContainer container, int port)\n+    {\n+        if (!bindPorts) {\n+            return;\n+        }\n+\n+        TestcontainersUtil.exposePort(container, port);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4OTAwOQ==", "url": "https://github.com/trinodb/trino/pull/3354#discussion_r404389009", "bodyText": "we cannot.\nin fact, we expose (debug) ports directly when --debug\nideas for improvement?", "author": "findepi", "createdAt": "2020-04-06T21:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzNzg4Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5af68093b0418ee4e43ad4a83c490bd41feeb8b6", "url": "https://github.com/trinodb/trino/commit/5af68093b0418ee4e43ad4a83c490bd41feeb8b6", "message": "Expose ports conditionally", "committedDate": "2020-04-09T08:39:06Z", "type": "commit"}, {"oid": "c94bc9939fe42835ad36f23273c0b4f6c3a176c8", "url": "https://github.com/trinodb/trino/commit/c94bc9939fe42835ad36f23273c0b4f6c3a176c8", "message": "Do not bind ports in product tests on CI", "committedDate": "2020-04-09T08:39:06Z", "type": "commit"}, {"oid": "c94bc9939fe42835ad36f23273c0b4f6c3a176c8", "url": "https://github.com/trinodb/trino/commit/c94bc9939fe42835ad36f23273c0b4f6c3a176c8", "message": "Do not bind ports in product tests on CI", "committedDate": "2020-04-09T08:39:06Z", "type": "forcePushed"}]}