{"pr_number": 4540, "pr_title": "Avoid checking isSplittable for files smaller than the split max size", "pr_createdAt": "2020-07-22T18:35:43Z", "pr_url": "https://github.com/trinodb/trino/pull/4540", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODc1Mg==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008752", "bodyText": "Wrap here for readability\nsplittable = splittable &&\n        status.getLen() >= minimumSplittableSizeInBytes &&\n        isSplittable(inputFormat, fileSystem, status.getPath());", "author": "electrum", "createdAt": "2020-07-22T18:47:46Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -98,7 +103,7 @@ public String getPartitionName()\n \n     public Optional<InternalHiveSplit> createInternalHiveSplit(LocatedFileStatus status, OptionalInt bucketNumber, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n-        splittable = splittable && isSplittable(inputFormat, fileSystem, status.getPath());\n+        splittable = splittable && status.getLen() >= minimumSplittableSizeInBytes && isSplittable(inputFormat, fileSystem, status.getPath());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjUxOA==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459012518", "bodyText": "Sure, done.", "author": "pettyjamesm", "createdAt": "2020-07-22T18:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008897", "bodyText": "These should be getMaxInitialSplitSize(), otherwise we won't split files that are between the initial size and max size (default in the 32MB to 64MB range).", "author": "electrum", "createdAt": "2020-07-22T18:48:00Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjM1MA==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459012350", "bodyText": "I can see the argument either way here actually. It's true that this would bypass the initial split size logic, but when splits are smaller than 64MB do we really want to spend time trying to split them into parts or do we want to bias towards avoiding the isSplittable check?\nI've been leaning towards this iteration, especially since there will only be a difference for the first X splits generated but I could be convinced to go the other way on it.", "author": "pettyjamesm", "createdAt": "2020-07-22T18:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMDUzMw==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459030533", "bodyText": "The initial split size is about increasing parallelism for small tables, so I would say we do what that.", "author": "dain", "createdAt": "2020-07-22T19:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MDM2MA==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459060360", "bodyText": "It's worth noting that this interacts with the behavior change in #4485. When producing initial splits from files between maxInitialSplitSize and maxSplitSize (32MB and 64MB respectively by default):\n\nIf we choose max initial split size as the threshold, those will yield initial splits in the range of 16-32MB because they will be considered splitable and then split into equal portions.\nIf we choose max split size as the threshold, files those will yield a single split between 32-64MB past which point this difference is not especially material because standard split generation logic holds.", "author": "pettyjamesm", "createdAt": "2020-07-22T20:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4OTg4NA==", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459589884", "bodyText": "After some offline discussion, I'm in the camp now where I think that max initial split size is the right trade off here. Since the code already reflects that, this is ready for re-review.", "author": "pettyjamesm", "createdAt": "2020-07-23T16:51:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "url": "https://github.com/trinodb/trino/commit/ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "message": "Avoid checking isSplittable for files smaller than initial split size\n\nFor some input formats, the isSplittable check is non-trivial and can\nadd a significant amount of time to split generation when handling a\nlarge number of very small files. This change allows files smaller\nthan the max initial split size to avoid that check and considers them\nunsplittable instead.", "committedDate": "2020-07-22T20:14:09Z", "type": "commit"}, {"oid": "ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "url": "https://github.com/trinodb/trino/commit/ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "message": "Avoid checking isSplittable for files smaller than initial split size\n\nFor some input formats, the isSplittable check is non-trivial and can\nadd a significant amount of time to split generation when handling a\nlarge number of very small files. This change allows files smaller\nthan the max initial split size to avoid that check and considers them\nunsplittable instead.", "committedDate": "2020-07-22T20:14:09Z", "type": "forcePushed"}]}