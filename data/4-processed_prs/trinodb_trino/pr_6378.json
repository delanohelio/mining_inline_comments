{"pr_number": 6378, "pr_title": "Decrease the number of access control checks in StatementAnalyzer", "pr_createdAt": "2020-12-18T14:54:12Z", "pr_url": "https://github.com/trinodb/trino/pull/6378", "timeline": [{"oid": "148fb0281b74b44373e6ce1547d8260d18377c76", "url": "https://github.com/trinodb/trino/commit/148fb0281b74b44373e6ce1547d8260d18377c76", "message": "Decrease the number of access control checks in StatementAnalyzer\n\nCheck column for visibility after the column mask is checked.\nThis reduces the number of access control checks to the state\nprior to 6a47dfa92cd41069741306973f455e48a48252db while preserving\nthe behavior introduced there.", "committedDate": "2020-12-18T14:53:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwOTc0OQ==", "url": "https://github.com/trinodb/trino/pull/6378#discussion_r546109749", "bodyText": "field.getName().orElseThrow() can be extracted to a variable", "author": "ssheikin", "createdAt": "2020-12-18T21:56:47Z", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1278,19 +1278,16 @@ private void analyzeFiltersAndMasks(Table table, QualifiedObjectName name, Optio\n                     .withRelationType(RelationId.anonymous(), new RelationType(fields))\n                     .build();\n \n-            Set<String> allColumns = fields.stream()\n-                    .flatMap(field -> field.getName().stream())\n-                    .collect(toImmutableSet());\n-\n-            Set<String> visibleColumns = filterColumns(name, allColumns);\n-\n             ImmutableMap.Builder<Field, List<ViewExpression>> columnMasks = ImmutableMap.builder();\n             for (Field field : fields) {\n-                if (field.getName().isPresent() && visibleColumns.contains(field.getName().orElseThrow())) {\n+                if (field.getName().isPresent()) {\n                     List<ViewExpression> masks = accessControl.getColumnMasks(session.toSecurityContext(), name, field.getName().get(), field.getType());\n-                    columnMasks.put(field, masks);\n \n-                    masks.forEach(mask -> analyzeColumnMask(session.getIdentity().getUser(), table, name, field, accessControlScope, mask));\n+                    if (!masks.isEmpty() && checkCanSelectFromColumn(name, field.getName().orElseThrow())) {", "originalCommit": "148fb0281b74b44373e6ce1547d8260d18377c76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}