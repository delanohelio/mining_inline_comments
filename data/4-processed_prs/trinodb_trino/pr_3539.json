{"pr_number": 3539, "pr_title": "Fix mask/filters behavior when mixed with views", "pr_createdAt": "2020-04-24T15:35:10Z", "pr_url": "https://github.com/trinodb/trino/pull/3539", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzQ5MQ==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414797491", "bodyText": "Why exactly?\nThis is just short-circuiting for speed?\nI am concerned this may reduce robustness of the code below (eg should initializePlanBuilder(plan) have possibility of failing, it would not fail, because masks are rare).\nif this stays, this should be likewise applied in the addRowFilters", "author": "findepi", "createdAt": "2020-04-24T19:01:16Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/RelationPlanner.java", "diffHunk": "@@ -196,11 +201,15 @@ private RelationPlan addRowFilters(Table node, RelationPlan plan)\n \n     private RelationPlan addColumnMasks(Table table, RelationPlan plan)\n     {\n+        Map<String, List<Expression>> columnMasks = analysis.getColumnMasks(table);\n+\n+        if (columnMasks.isEmpty()) {\n+            return plan;\n+        }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNTM1MA==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414805350", "bodyText": "For WITH clauses, there will be a call to addColumnMasks with a map that will be empty (column masks don't apply to WITH clauses, only tables and views). The code below tries to walk over the list of fields from that relation, which is expected to have names as it's supposed to originate from a view or table. In the case of a WITH clause, names may be missing, causing a failure.\nFor row filters it doesn't matter, as they don't refer to columns by name.\nI debated going this route or making the loop below skip fields that don't have a name. There's no case where there can be column masks and some fields not have a name, so it felt unnecessary. I would also likely be a bug if that happened, and the current approach will fail with the expected error if it happens.\nI can add a comment to clarify, as it's evidently not obvious why it's there.", "author": "martint", "createdAt": "2020-04-24T19:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNjk3Nw==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414816977", "bodyText": "That deserves a code comment.\nHowever, can we explicitly exclude CTEs from this code?", "author": "findepi", "createdAt": "2020-04-24T19:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMDcyMA==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414820720", "bodyText": "That's hard. At this point of the process there's no difference between a view and a CTE -- they are all just \"named queries\".", "author": "martint", "createdAt": "2020-04-24T19:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMTczMA==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414821730", "bodyText": "Then a comment.", "author": "findepi", "createdAt": "2020-04-24T19:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5OTAzOA==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414799038", "bodyText": "This block is for Views and CTEs.\nWe shouldn't try to apply masks/filters on CTEs.\nThis works probably because we do columnMasks.getOrDefault in io.prestosql.sql.analyzer.Analysis#getColumnMasks, but this can also mask (no pun intended) bugs.", "author": "findepi", "createdAt": "2020-04-24T19:04:05Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/RelationPlanner.java", "diffHunk": "@@ -148,34 +148,39 @@ protected RelationPlan visitTable(Table node, Void context)\n         Query namedQuery = analysis.getNamedQuery(node);\n         Scope scope = analysis.getScope(node);\n \n+        RelationPlan plan;\n         if (namedQuery != null) {\n             RelationPlan subPlan = process(namedQuery, null);\n \n             // Add implicit coercions if view query produces types that don't match the declared output types\n             // of the view (e.g., if the underlying tables referenced by the view changed)\n             Type[] types = scope.getRelationType().getAllFields().stream().map(Field::getType).toArray(Type[]::new);\n             RelationPlan withCoercions = addCoercions(subPlan, types);\n-            return new RelationPlan(withCoercions.getRoot(), scope, withCoercions.getFieldMappings());\n+\n+            plan = new RelationPlan(withCoercions.getRoot(), scope, withCoercions.getFieldMappings());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNjUyOQ==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414806529", "bodyText": "We shouldn't try to apply masks/filters on CTEs.\n\nWe don't. In that case, the Table node will have no column masks associated with it.", "author": "martint", "createdAt": "2020-04-24T19:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5OTAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxNjE0OQ==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414816149", "bodyText": "That's my understanding.", "author": "findepi", "createdAt": "2020-04-24T19:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5OTAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMDY1OQ==", "url": "https://github.com/trinodb/trino/pull/3539#discussion_r414800659", "bodyText": ":)", "author": "findepi", "createdAt": "2020-04-24T19:07:01Z", "path": "presto-main/src/test/java/io/prestosql/sql/query/TestRowFilter.java", "diffHunk": "@@ -189,6 +189,16 @@ public void testView()\n \n             assertions.assertQuery(session, \"SELECT count(*) FROM mock.default.nation_view\", \"VALUES BIGINT '25'\");\n         });\n+\n+        // filter on the view\n+        assertions.executeExclusively(() -> {\n+            accessControl.reset();\n+            accessControl.rowFilter(\n+                    new QualifiedObjectName(MOCK_CATALOG, \"default\", \"nation_view\"),\n+                    USER,\n+                    new ViewExpression(USER, Optional.of(CATALOG), Optional.of(\"tiny\"), \"nationkey = 1\"));\n+            assertions.assertQuery(\"SELECT name FROM mock.default.nation_view\", \"VALUES CAST('ARGENTINA' AS VARCHAR(25))\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84429d84d8fd75d686aa63d0223885c793089395", "url": "https://github.com/trinodb/trino/commit/84429d84d8fd75d686aa63d0223885c793089395", "message": "Apply filters and masks for tables referenced by views", "committedDate": "2020-04-24T23:31:47Z", "type": "commit"}, {"oid": "6721cfad45d47a663c805c496eb40e648a8a1710", "url": "https://github.com/trinodb/trino/commit/6721cfad45d47a663c805c496eb40e648a8a1710", "message": "Apply filters and masks for view object\n\nThe planner for Table node was bailing out early if the table reference\ncorresponded to a view or named query without attaching any masks or\nfilters that may have been resolved.", "committedDate": "2020-04-24T23:31:47Z", "type": "commit"}, {"oid": "6721cfad45d47a663c805c496eb40e648a8a1710", "url": "https://github.com/trinodb/trino/commit/6721cfad45d47a663c805c496eb40e648a8a1710", "message": "Apply filters and masks for view object\n\nThe planner for Table node was bailing out early if the table reference\ncorresponded to a view or named query without attaching any masks or\nfilters that may have been resolved.", "committedDate": "2020-04-24T23:31:47Z", "type": "forcePushed"}]}