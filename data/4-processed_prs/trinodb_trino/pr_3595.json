{"pr_number": 3595, "pr_title": "Reduce RPM size using symlinks", "pr_createdAt": "2020-05-01T05:43:44Z", "pr_url": "https://github.com/trinodb/trino/pull/3595", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418478668", "bodyText": "Can we use content checksum here?\njar name = artifact + id, without group, so it's not unique\nand this would also prevent potential surprises like #2470", "author": "findepi", "createdAt": "2020-05-01T09:35:22Z", "path": "presto-server-rpm/src/main/script/symlink.groovy", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import java.nio.file.Files\n+import java.nio.file.LinkOption\n+import java.nio.file.Path\n+import java.nio.file.Paths\n+\n+Path root = Paths.get(properties['root'])\n+Path shared = root.resolve('shared')\n+\n+Files.createDirectory(shared)\n+\n+List<String> files = new FileNameFinder().getFileNames(root.toString(), '**/*.jar')\n+\n+for (file in files) {\n+    Path source = Paths.get(file)\n+    Path target = shared.resolve(source.getFileName())", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODg0NjU4OQ==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418846589", "bodyText": "I considered that, but the current hardlink handling in provisio only uses the name, so it doesn't buy us anything at this point. If we implement that in provisio, this should change, too.", "author": "electrum", "createdAt": "2020-05-02T02:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODg0NzUxNQ==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418847515", "bodyText": "I'll add a comment to this effect here.", "author": "electrum", "createdAt": "2020-05-02T02:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MjU2NA==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418942564", "bodyText": "I understand, but this is something we should address, so why not do right thing for RPM from the start?\nI don't think it's difficult or expensive to do.", "author": "findepi", "createdAt": "2020-05-02T10:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5MDc5Mw==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418990793", "bodyText": "You're right, it's easy to do. I added a check that the files are the same.", "author": "electrum", "createdAt": "2020-05-02T18:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NTc3Mg==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418995772", "bodyText": "Thanks", "author": "findepi", "createdAt": "2020-05-02T19:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3ODY2OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NjEyNw==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418996127", "bodyText": "isSameFile is about paths, not content, so i would expect this fails... but it apparently doesn't.\nWhat am i missing?", "author": "findepi", "createdAt": "2020-05-02T19:11:55Z", "path": "presto-server-rpm/src/main/script/symlink.groovy", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import java.nio.file.Files\n+import java.nio.file.LinkOption\n+import java.nio.file.Path\n+import java.nio.file.Paths\n+\n+Path root = Paths.get(properties['root'])\n+Path shared = root.resolve('shared')\n+\n+Files.createDirectory(shared)\n+\n+List<String> files = new FileNameFinder().getFileNames(root.toString(), '**/*.jar')\n+\n+for (file in files) {\n+    Path source = Paths.get(file)\n+    Path target = shared.resolve(source.getFileName())\n+    if (!Files.exists(target, LinkOption.NOFOLLOW_LINKS)) {\n+        Files.move(source, target)\n+    }\n+    else if (!Files.isSameFile(source, target)) {\n+        throw new RuntimeException(\"Not same file: $source <> $target\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5Nzc1Ng==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r418997756", "bodyText": "It's checking that the paths reference the same file, meaning they are the same device and inode (i.e. hard links to the same file).", "author": "electrum", "createdAt": "2020-05-02T19:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NjEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwOTY2NA==", "url": "https://github.com/trinodb/trino/pull/3595#discussion_r419009664", "bodyText": "is it build on the hard-linked directory? please add a comment", "author": "findepi", "createdAt": "2020-05-02T21:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NjEyNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "41046f7c175fc36576c4064efb14d10c98a3eff8", "url": "https://github.com/trinodb/trino/commit/41046f7c175fc36576c4064efb14d10c98a3eff8", "message": "Reduce RPM size using symlinks", "committedDate": "2020-05-05T00:08:57Z", "type": "commit"}, {"oid": "41046f7c175fc36576c4064efb14d10c98a3eff8", "url": "https://github.com/trinodb/trino/commit/41046f7c175fc36576c4064efb14d10c98a3eff8", "message": "Reduce RPM size using symlinks", "committedDate": "2020-05-05T00:08:57Z", "type": "forcePushed"}]}