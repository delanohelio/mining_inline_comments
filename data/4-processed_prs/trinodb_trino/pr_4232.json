{"pr_number": 4232, "pr_title": "Fix Iceberg ORC DECIMAL types", "pr_createdAt": "2020-06-25T21:38:55Z", "pr_url": "https://github.com/trinodb/trino/pull/4232", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjU0Mg==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446246542", "bodyText": "Remove?", "author": "electrum", "createdAt": "2020-06-26T15:15:42Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -255,9 +268,12 @@ private void testPartitionedTableWithNullValues(Session session, FileFormat file\n                 \", null _real\" +\n                 \", null _double\" +\n                 \", null _boolean\" +\n-//                \", CAST('3.14' AS DECIMAL(3,2)) _decimal_short\" +\n-//                \", CAST('12345678901234567890.0123456789' AS DECIMAL(30,10)) _decimal_long\" +\n-//                \", CAST('2017-05-01 10:12:34' AS TIMESTAMP) _timestamp\" +\n+                returnSqlIfFormatSupportsDecimalsAndTimestamps(fileFormat, \", null _decimal_short\" +\n+                        \", null _decimal_long\" +\n+                        \", null _timestamp\") +\n+//                formatSupportsDecimalsAndTimestamps(fileFormat, \", CAST('3.14' AS DECIMAL(3,2)) _decimal_short\" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTEzNQ==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446365135", "bodyText": "Done", "author": "djsstarburst", "createdAt": "2020-06-26T19:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjgzNQ==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446246835", "bodyText": "There's already a isShortDecimal method", "author": "electrum", "createdAt": "2020-06-26T15:16:11Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/Decimals.java", "diffHunk": "@@ -326,4 +326,9 @@ private static void checkArgument(boolean condition)\n             throw new IllegalArgumentException();\n         }\n     }\n+\n+    public static boolean isShortDecimalType(DecimalType decimalType)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTE2Nw==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446365167", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-06-26T19:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NjgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NzAzMA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446247030", "bodyText": "Nit: \"else\" is redundant", "author": "electrum", "createdAt": "2020-06-26T15:16:30Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -175,6 +179,19 @@ private static Object getValue(Type type, Marker marker, ConnectorSession sessio\n             return ((Slice) marker.getValue()).getBytes();\n         }\n \n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            Object value = marker.getValue();\n+            if (Decimals.isShortDecimalType(decimalType)) {\n+                checkArgument(value instanceof Long, \"A short decimal should be represented by a long value but was \" + value);\n+                return value;\n+            }\n+            else {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTE4OA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446365188", "bodyText": "Removed", "author": "djsstarburst", "createdAt": "2020-06-26T19:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NzAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0OTEwMw==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446249103", "bodyText": "checkArgument takes string format so use %s instead of concatenation. Also, we should print the class since it might not be obvious from the toString()\ncheckArgument(value instanceof Slice, \"A long decimal should be represented by a Slice value but was %s\", value.getClass().getName());", "author": "electrum", "createdAt": "2020-06-26T15:20:21Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -175,6 +179,19 @@ private static Object getValue(Type type, Marker marker, ConnectorSession sessio\n             return ((Slice) marker.getValue()).getBytes();\n         }\n \n+        if (type instanceof DecimalType) {\n+            DecimalType decimalType = (DecimalType) type;\n+            Object value = marker.getValue();\n+            if (Decimals.isShortDecimalType(decimalType)) {\n+                checkArgument(value instanceof Long, \"A short decimal should be represented by a long value but was \" + value);\n+                return value;\n+            }\n+            else {\n+                checkArgument(value instanceof Slice, \"A long decimal should be represented by a Slice value but was \" + value);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NTIyOA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446365228", "bodyText": "Fixed.", "author": "djsstarburst", "createdAt": "2020-06-26T19:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0OTEwMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTQyNw==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446449427", "bodyText": "Preconditions only support %s for formatting.\nNote that in general, %s is preferred, since it works for all types. Use the others like %02d when you need special type-specific formatting.", "author": "electrum", "createdAt": "2020-06-26T23:21:32Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -101,15 +102,34 @@ public void testShowCreateTable()\n     @Test\n     public void testDecimal()\n     {\n-        assertUpdate(\"CREATE TABLE test_decimal_short (x decimal(3,2))\");\n-        assertQueryFails(\"INSERT INTO test_decimal_short VALUES (decimal '3.14')\", \"Writing to columns of type decimal not yet supported\");\n-//        assertQuery(\"SELECT * FROM test_decimal_short\", \"SELECT CAST('3.14' AS DECIMAL(3,2))\");\n-        dropTable(getSession(), \"test_decimal_short\");\n-\n-        assertUpdate(\"CREATE TABLE test_decimal_long (x decimal(25,2))\");\n-        assertQueryFails(\"INSERT INTO test_decimal_long VALUES (decimal '3.14')\", \"Writing to columns of type decimal not yet supported\");\n-//        assertQuery(\"SELECT * FROM test_decimal_long\", \"SELECT CAST('3.14' AS DECIMAL(25,2))\");\n-        dropTable(getSession(), \"test_decimal_long\");\n+        for (int precision = 1; precision <= 38; precision++) {\n+            testDecimalWithPrecisionAndScale(precision, precision - 1);\n+        }\n+\n+        for (int scale = 1; scale < 37; scale++) {\n+            testDecimalWithPrecisionAndScale(38, scale);\n+        }\n+\n+        for (int scale = 1; scale < 17; scale++) {\n+            testDecimalWithPrecisionAndScale(18, scale);\n+        }\n+    }\n+\n+    private void testDecimalWithPrecisionAndScale(int precision, int scale)\n+    {\n+        checkArgument(precision >= 1 && precision <= 38, \"Decimal precision must be between 1 and 38 inclusive, but was %d\", precision);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTc4NQ==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446449785", "bodyText": "We could shorten these messages by putting the values inline\n\"Decimal precision (%s) must be between 1 and 38 inclusive\"\n\"Decimal scale (%s) must be less than the precision (%s) and non-negative\"", "author": "electrum", "createdAt": "2020-06-26T23:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MTg4MQ==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446461881", "bodyText": "Good idea; done.", "author": "djsstarburst", "createdAt": "2020-06-27T00:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTQyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTU4NA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446449584", "bodyText": "No need to wrap here", "author": "electrum", "createdAt": "2020-06-26T23:22:23Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -101,15 +102,34 @@ public void testShowCreateTable()\n     @Test\n     public void testDecimal()\n     {\n-        assertUpdate(\"CREATE TABLE test_decimal_short (x decimal(3,2))\");\n-        assertQueryFails(\"INSERT INTO test_decimal_short VALUES (decimal '3.14')\", \"Writing to columns of type decimal not yet supported\");\n-//        assertQuery(\"SELECT * FROM test_decimal_short\", \"SELECT CAST('3.14' AS DECIMAL(3,2))\");\n-        dropTable(getSession(), \"test_decimal_short\");\n-\n-        assertUpdate(\"CREATE TABLE test_decimal_long (x decimal(25,2))\");\n-        assertQueryFails(\"INSERT INTO test_decimal_long VALUES (decimal '3.14')\", \"Writing to columns of type decimal not yet supported\");\n-//        assertQuery(\"SELECT * FROM test_decimal_long\", \"SELECT CAST('3.14' AS DECIMAL(25,2))\");\n-        dropTable(getSession(), \"test_decimal_long\");\n+        for (int precision = 1; precision <= 38; precision++) {\n+            testDecimalWithPrecisionAndScale(precision, precision - 1);\n+        }\n+\n+        for (int scale = 1; scale < 37; scale++) {\n+            testDecimalWithPrecisionAndScale(38, scale);\n+        }\n+\n+        for (int scale = 1; scale < 17; scale++) {\n+            testDecimalWithPrecisionAndScale(18, scale);\n+        }\n+    }\n+\n+    private void testDecimalWithPrecisionAndScale(int precision, int scale)\n+    {\n+        checkArgument(precision >= 1 && precision <= 38, \"Decimal precision must be between 1 and 38 inclusive, but was %d\", precision);\n+        checkArgument(scale < precision && scale >= 0, \"Decimal scale must be less than the precision and non-negative, but was %d with precision %d\",\n+                scale, precision);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MTg3OA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446461878", "bodyText": "Fixed.", "author": "djsstarburst", "createdAt": "2020-06-27T00:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MDQ5MQ==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446450491", "bodyText": "We often use the trick of \"\" + to format multi-line strings so that the arguments line up:\nreturnSqlIfFormatSupportsDecimalsAndTimestamps(fileFormat, \"\" +\n        \", _decimal_short DECIMAL(3,2)\" +\n        \", _decimal_long DECIMAL(30,10)\" +\n        \", _timestamp TIMESTAMP\") +\nThis works with the code style and IntelliJ formatter rules.", "author": "electrum", "createdAt": "2020-06-26T23:26:56Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -139,9 +159,9 @@ private void testCreatePartitionedTable(Session session, FileFormat fileFormat)\n                 \", _real REAL\" +\n                 \", _double DOUBLE\" +\n                 \", _boolean BOOLEAN\" +\n-//                \", _decimal_short DECIMAL(3,2)\" +\n-//                \", _decimal_long DECIMAL(30,10)\" +\n-//                \", _timestamp TIMESTAMP\" +\n+                returnSqlIfFormatSupportsDecimalsAndTimestamps(fileFormat, \", _decimal_short DECIMAL(3,2)\" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MTg2NA==", "url": "https://github.com/trinodb/trino/pull/4232#discussion_r446461864", "bodyText": "That's much neater; changed in all calls to the method.", "author": "djsstarburst", "createdAt": "2020-06-27T00:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MDQ5MQ=="}], "type": "inlineReview"}, {"oid": "1c6aca686f440265a1d38bc06cb0f2c11f762df8", "url": "https://github.com/trinodb/trino/commit/1c6aca686f440265a1d38bc06cb0f2c11f762df8", "message": "Fix Iceberg ORC DECIMAL types\n\nThis commit enables DECIMAL types in Iceberg ORC, and\nfixes a couple of bugs in conversion from SPI DecimalType\nto BigDecimal used by Iceberg ORC.  It adds a unit test\nthat ensures that all legal DECIMAL precisions are correctly\nencoded.  It also adds machinery that allows the partitioned\ntable unit tests to run with DECIMAL and TIMESTAMP columns\nfor FileFormat.ORC, and runs the same tests without DECIMAL\nand TIMESTAMP for FileFormat.PARQUET, where they are not\nyet supported.", "committedDate": "2020-06-27T00:36:58Z", "type": "commit"}, {"oid": "1c6aca686f440265a1d38bc06cb0f2c11f762df8", "url": "https://github.com/trinodb/trino/commit/1c6aca686f440265a1d38bc06cb0f2c11f762df8", "message": "Fix Iceberg ORC DECIMAL types\n\nThis commit enables DECIMAL types in Iceberg ORC, and\nfixes a couple of bugs in conversion from SPI DecimalType\nto BigDecimal used by Iceberg ORC.  It adds a unit test\nthat ensures that all legal DECIMAL precisions are correctly\nencoded.  It also adds machinery that allows the partitioned\ntable unit tests to run with DECIMAL and TIMESTAMP columns\nfor FileFormat.ORC, and runs the same tests without DECIMAL\nand TIMESTAMP for FileFormat.PARQUET, where they are not\nyet supported.", "committedDate": "2020-06-27T00:36:58Z", "type": "forcePushed"}]}