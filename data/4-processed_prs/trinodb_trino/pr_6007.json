{"pr_number": 6007, "pr_title": "Allow predicate pushdown after aggregation pushdown", "pr_createdAt": "2020-11-18T20:05:54Z", "pr_url": "https://github.com/trinodb/trino/pull/6007", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5NjE4Mw==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r526896183", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (constraint.getSummary().getDomains().isEmpty()) {\n          \n          \n            \n                        if (constraint.getSummary().isNone()) {", "author": "findepi", "createdAt": "2020-11-19T13:43:17Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -114,9 +114,19 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n         JdbcTableHandle handle = (JdbcTableHandle) table;\n \n         if (handle.getGroupingSets().isPresent()) {\n-            // handle's aggregations are applied after constraint, so we cannot apply filter if aggregates is already set\n-            // TODO (https://github.com/prestosql/presto/issues/4112) allow filter pushdown after aggregation pushdown\n-            return Optional.empty();\n+            if (constraint.getSummary().getDomains().isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5NjQ4MQ==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r526896481", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<ColumnHandle, Domain> domains = constraint.getSummary().getDomains().get();\n          \n          \n            \n                        Map<ColumnHandle, Domain> domains = constraint.getSummary().getDomains().orElseThrow();", "author": "findepi", "createdAt": "2020-11-19T13:43:41Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -114,9 +114,19 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n         JdbcTableHandle handle = (JdbcTableHandle) table;\n \n         if (handle.getGroupingSets().isPresent()) {\n-            // handle's aggregations are applied after constraint, so we cannot apply filter if aggregates is already set\n-            // TODO (https://github.com/prestosql/presto/issues/4112) allow filter pushdown after aggregation pushdown\n-            return Optional.empty();\n+            if (constraint.getSummary().getDomains().isEmpty()) {\n+                return Optional.empty();\n+            }\n+\n+            Map<ColumnHandle, Domain> domains = constraint.getSummary().getDomains().get();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMTU2Mw==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r526901563", "bodyText": "i think we can pushdown if all the constraint columns are fully contained by every grouping set.\nit's not testable right now, since the SPI supoports grouping set pushdown, but the engine actually does not yet\ni propose\nSet<ColumnHandle> constraintColumns = constraint.getSummary().getDomains().orElseThrow().keySet();\nList<List<JdbcColumnHandle>> groupingSets = handle.getGroupingSets().get();\nverify(!groupingSets.isEmpty());\nboolean canPushDown = groupingSets.stream()\n        .allMatch(groupingSet -> isContainedBy(constraintColumns, groupingSet));\n\nprivate static boolean isContainedBy(Set<ColumnHandle> searchedFor, List<JdbcColumnHandle> container)\n    {\n        if (searchedFor.size() < 3) {\n            return container.containsAll(searchedFor);\n        }\n        return ImmutableSet.copyOf(container).containsAll(searchedFor);\n    }\n\n(we can also consider the method overkill and just do the defensive version inline)", "author": "findepi", "createdAt": "2020-11-19T13:50:59Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -114,9 +114,19 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n         JdbcTableHandle handle = (JdbcTableHandle) table;\n \n         if (handle.getGroupingSets().isPresent()) {\n-            // handle's aggregations are applied after constraint, so we cannot apply filter if aggregates is already set\n-            // TODO (https://github.com/prestosql/presto/issues/4112) allow filter pushdown after aggregation pushdown\n-            return Optional.empty();\n+            if (constraint.getSummary().getDomains().isEmpty()) {\n+                return Optional.empty();\n+            }\n+\n+            Map<ColumnHandle, Domain> domains = constraint.getSummary().getDomains().get();\n+            List<List<JdbcColumnHandle>> groupingSets = handle.getGroupingSets().get();\n+\n+            boolean canPushDown = domains.keySet().stream().allMatch(predicateColumn ->\n+                    groupingSets.stream().allMatch(group -> group.contains(predicateColumn)));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NzcyMg==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r527177722", "bodyText": "If I'm reading this correctly the conditions are the same. Right? Every constraint column must be in every group set.\nWhat's the motivation for the defensive version, with the copy?", "author": "alexjo2144", "createdAt": "2020-11-19T20:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMTU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzNzE1Mg==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r527237152", "bodyText": "What's the motivation for the defensive version, with the copy?\n\navoid O(m*n) when long group by (m) and many predicated column (n)\n\nIf I'm reading this correctly the conditions are the same.\n\ncorrect. i read the initial code incorrectly though", "author": "findepi", "createdAt": "2020-11-19T22:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzODU2MA==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r527238560", "bodyText": "Add a case with two grouping sets (a, b) and (a) and predicate on column (b) only. No predicate pushdown should occur", "author": "findepi", "createdAt": "2020-11-19T22:14:48Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestJdbcMetadata.java", "diffHunk": "@@ -232,4 +246,84 @@ public void testDropTableTable()\n             assertEquals(e.getErrorCode(), NOT_FOUND.toErrorCode());\n         }\n     }\n+\n+    @Test\n+    public void testApplyFilterAfterAggregationPushdown()\n+    {\n+        ConnectorSession session = TestingConnectorSession.builder()\n+                .setPropertyMetadata(new JdbcMetadataSessionProperties(new JdbcMetadataConfig().setAggregationPushdownEnabled(true)).getSessionProperties())\n+                .build();\n+        ColumnHandle groupByColumn = metadata.getColumnHandles(session, tableHandle).get(\"text\");\n+        ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n+        ConnectorTableHandle aggregatedTable = applyCountAggregation(session, baseTableHandle, groupByColumn);\n+\n+        Domain domain = Domain.singleValue(VARCHAR, utf8Slice(\"one\"));\n+        JdbcTableHandle tableHandleWithFilter = applyConstraint(session, aggregatedTable, new Constraint(TupleDomain.withColumnDomains(ImmutableMap.of(groupByColumn, domain))));\n+\n+        assertEquals(tableHandleWithFilter.getConstraint().getDomains(), Optional.of(ImmutableMap.of(groupByColumn, domain)));\n+    }\n+\n+    @Test\n+    public void testCombineFiltersWithAggregationPushdown()\n+    {\n+        ConnectorSession session = TestingConnectorSession.builder()\n+                .setPropertyMetadata(new JdbcMetadataSessionProperties(new JdbcMetadataConfig().setAggregationPushdownEnabled(true)).getSessionProperties())\n+                .build();\n+        ColumnHandle groupByColumn = metadata.getColumnHandles(session, tableHandle).get(\"text\");\n+        ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n+\n+        Domain firstDomain = Domain.multipleValues(VARCHAR, ImmutableList.of(utf8Slice(\"one\"), utf8Slice(\"two\")));\n+        JdbcTableHandle filterResult = applyConstraint(session, baseTableHandle, new Constraint(TupleDomain.withColumnDomains(ImmutableMap.of(groupByColumn, firstDomain))));\n+\n+        ConnectorTableHandle aggregatedTable = applyCountAggregation(session, filterResult, groupByColumn);\n+\n+        Domain secondDomain = Domain.multipleValues(VARCHAR, ImmutableList.of(utf8Slice(\"one\"), utf8Slice(\"three\")));\n+        JdbcTableHandle tableHandleWithFilter = applyConstraint(session, aggregatedTable, new Constraint(TupleDomain.withColumnDomains(ImmutableMap.of(groupByColumn, secondDomain))));\n+        assertEquals(\n+                tableHandleWithFilter.getConstraint().getDomains(),\n+                Optional.of(ImmutableMap.of(groupByColumn, Domain.singleValue(VARCHAR, utf8Slice(\"one\")))));\n+    }\n+\n+    @Test\n+    public void testNonGroupKeyPredicatePushdown()\n+    {\n+        ConnectorSession session = TestingConnectorSession.builder()\n+                .setPropertyMetadata(new JdbcMetadataSessionProperties(new JdbcMetadataConfig().setAggregationPushdownEnabled(true)).getSessionProperties())\n+                .build();\n+        Map<String, ColumnHandle> columnHandles = metadata.getColumnHandles(session, tableHandle);\n+        ColumnHandle groupByColumn = columnHandles.get(\"text\");\n+        ColumnHandle nonGroupByColumn = columnHandles.get(\"value\");\n+\n+        ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n+        ConnectorTableHandle aggregatedTable = applyCountAggregation(session, baseTableHandle, groupByColumn);\n+\n+        Domain domain = Domain.singleValue(BIGINT, 123L);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwNzYzMQ==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r527807631", "bodyText": "I had to set supportsGroupingSets to true in TestingH2JdbcClient to add that case, might break some other tests?\nEdit: Seems fine", "author": "alexjo2144", "createdAt": "2020-11-20T16:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzODU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjEyMA==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r528246120", "bodyText": "Edit: Seems fine\n\nsurprising to me, will take a look", "author": "findepi", "createdAt": "2020-11-21T21:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzODU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjU5MA==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r528246590", "bodyText": "i think i was adding the flag because h2 did not support GROUPING SETS; OTOH tests currently cannot exploit this fact, as engine doesn't push grouping sets yet.\nYet, h2 version did not change, so it may be h2 still doesn't support this.\nMaybe instead of changing the return type of supportsGroupingSets, just use a \"mock\" jdbc client in the TestJdbcMetadata test?\nBy \"mock\" i mean a ForwardingJdbcClient delegating to database.getJdbcClient(), but overriding supportsGroupingSets?\nThis way you'd avoid making a false statement in the io.prestosql.plugin.jdbc.TestingH2JdbcClient#supportsGroupingSets", "author": "findepi", "createdAt": "2020-11-21T21:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzODU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgxOTE5Ng==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r528819196", "bodyText": "Sounds good. Updated.", "author": "alexjo2144", "createdAt": "2020-11-23T16:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzODU2MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjA3OQ==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r528246079", "bodyText": "remove the overrride, as the default is (and will be) true.", "author": "findepi", "createdAt": "2020-11-21T21:42:12Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestingH2JdbcClient.java", "diffHunk": "@@ -37,7 +37,7 @@ public TestingH2JdbcClient(BaseJdbcConfig config, ConnectionFactory connectionFa\n     @Override\n     public boolean supportsGroupingSets()\n     {\n-        return false;\n+        return true;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjU5Nw==", "url": "https://github.com/trinodb/trino/pull/6007#discussion_r528246597", "bodyText": "see however #6007 (comment)", "author": "findepi", "createdAt": "2020-11-21T21:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjA3OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "fce761c34c11e70b231e232c4619279f1952a33a", "url": "https://github.com/trinodb/trino/commit/fce761c34c11e70b231e232c4619279f1952a33a", "message": "Allow predicate pushdown after aggregation pushdown\n\nPredicates pushed down after aggregations must be on group by keys", "committedDate": "2020-11-24T20:52:21Z", "type": "commit"}, {"oid": "fce761c34c11e70b231e232c4619279f1952a33a", "url": "https://github.com/trinodb/trino/commit/fce761c34c11e70b231e232c4619279f1952a33a", "message": "Allow predicate pushdown after aggregation pushdown\n\nPredicates pushed down after aggregations must be on group by keys", "committedDate": "2020-11-24T20:52:21Z", "type": "forcePushed"}]}