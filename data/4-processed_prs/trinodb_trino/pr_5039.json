{"pr_number": 5039, "pr_title": "Cleanup file access control", "pr_createdAt": "2020-09-01T04:22:12Z", "pr_url": "https://github.com/trinodb/trino/pull/5039", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0NzgzMg==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r481047832", "bodyText": "why this is better? I would undo this change. It is more clear to use domain objects like schema name here instead of toString() representation (which is not intuitive that it is designed for UX message)", "author": "kokosing", "createdAt": "2020-09-01T10:48:27Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -384,15 +384,15 @@ public void checkCanCreateSchema(SystemSecurityContext context, CatalogSchemaNam\n     public void checkCanDropSchema(SystemSecurityContext context, CatalogSchemaName schema)\n     {\n         if (!isSchemaOwner(context, schema)) {\n-            denyDropSchema(schema.getSchemaName());\n+            denyDropSchema(schema.toString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1NjA2OA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r481456068", "bodyText": "The default method in the super class do this, so this is consistent with other system level items.  I actually would like the connector access control to give absolute names, but they don't really have that information easily.\nBTW, I would guess these are written this way because this code was copied from the connector level file access control.", "author": "dain", "createdAt": "2020-09-01T22:00:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0NzgzMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NzcwNw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r481977707", "bodyText": "you need to also check if user has any access to the schema", "author": "kokosing", "createdAt": "2020-09-02T10:50:01Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedAccessControl.java", "diffHunk": "@@ -169,7 +170,9 @@ public void checkCanShowTables(ConnectorSecurityContext context, String schemaNa\n     @Override\n     public Set<SchemaTableName> filterTables(ConnectorSecurityContext context, Set<SchemaTableName> tableNames)\n     {\n-        return tableNames;\n+        return tableNames.stream()\n+                .filter(tableName -> checkAnyTablePermission(context, tableName))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1ODk5OA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r482258998", "bodyText": "checkAnyTablePermission checks catalog access internally.  FWIU there is no schema access rule, and only a schema owner rule.", "author": "dain", "createdAt": "2020-09-02T17:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU4NjE2MA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r482586160", "bodyText": "I understand now.  I changed this to be isSchemaOwner() || checkAnyTablePermission(), so schema owners can see all the table names.", "author": "dain", "createdAt": "2020-09-02T23:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NzcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3Nzg3NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r481977875", "bodyText": "you need to also check if user has any full access to the schema or catalog", "author": "kokosing", "createdAt": "2020-09-02T10:50:17Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -485,11 +485,9 @@ public void checkCanShowTables(SystemSecurityContext context, CatalogSchemaName\n     @Override\n     public Set<SchemaTableName> filterTables(SystemSecurityContext context, String catalogName, Set<SchemaTableName> tableNames)\n     {\n-        if (!canAccessCatalog(context.getIdentity(), catalogName, READ_ONLY)) {\n-            return ImmutableSet.of();\n-        }\n-\n-        return tableNames;\n+        return tableNames.stream()\n+                .filter(tableName -> checkAnyTablePermission(context, new CatalogSchemaTableName(catalogName, tableName)))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1OTgyOA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r482259828", "bodyText": "checkAnyTablePermission checks catalog access internally.  FWIU there is no schema access rule, and only a schema owner rule.", "author": "dain", "createdAt": "2020-09-02T17:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3Nzg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU4NjM3Ng==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r482586376", "bodyText": "I understand now.  I changed this to be isSchemaOwner() || checkAnyTablePermission(), so schema owners can see all the table names.", "author": "dain", "createdAt": "2020-09-02T23:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3Nzg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4MDIxNg==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r481980216", "bodyText": "I would remove it from here and possibly rename it to CatalogAccessRulePattern. Then basing on CatalogAccessRulePattern and SchemaAccessRulePattern I would build CatalogSchemaAccessControlRule. No setters and partially build objects.", "author": "kokosing", "createdAt": "2020-09-02T10:54:38Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/CatalogSchemaAccessControlRule.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.base.security;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import io.prestosql.spi.connector.CatalogSchemaName;\n+\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CatalogSchemaAccessControlRule\n+{\n+    private final Optional<Pattern> catalogRegex;\n+    private SchemaAccessControlRule schemaAccessControlRule;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk2MjY3NA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r489962674", "bodyText": "I changed the constructor to just explicitly have arguments of the nested type.  Hopefully we can simplify this later, but it works for now.", "author": "dain", "createdAt": "2020-09-17T04:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4MDIxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5e2da1abd05f27e81a87985f5959b0b653e6da71", "url": "https://github.com/trinodb/trino/commit/5e2da1abd05f27e81a87985f5959b0b653e6da71", "message": "Add catalog regex to schema and table rules in file system access control", "committedDate": "2020-09-03T00:50:07Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyOTk5NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490329995", "bodyText": "Is this a breaking change or do you have code to pull in the old name as well?", "author": "mosabua", "createdAt": "2020-09-17T15:10:10Z", "path": "presto-docs/src/main/sphinx/admin/session-property-managers.rst", "diffHunk": "@@ -69,20 +69,20 @@ These requirements can be expressed with the following rules:\n     [\n       {\n         \"group\": \"global.*\",\n-        \"sessionProperties\": {\n+        \"session_properties\": {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1OTI5Nw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r491059297", "bodyText": "The old name is still supported via @JsonAlias.", "author": "dain", "createdAt": "2020-09-18T16:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyOTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA5NjMyNQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r491096325", "bodyText": "Great .. not sure if we need to even add this as a note to the release notes then.", "author": "mosabua", "createdAt": "2020-09-18T17:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyOTk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTEyNg==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490625126", "bodyText": "catalogs. They do not ..", "author": "mosabua", "createdAt": "2020-09-17T23:58:43Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTI0NA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490625244", "bodyText": "maybe new paragraph", "author": "mosabua", "createdAt": "2020-09-17T23:59:08Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.\n+The table and schema rules are used to specify who can can create, drop, alter, select, insert,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3Mzc4OQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r493973789", "bodyText": "I like this as an introductory summary paragraph that describe what the rules do at a high level so having these here make sense to me.", "author": "dain", "createdAt": "2020-09-24T00:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxMTg4NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494011885", "bodyText": "Yes .. just add an empty line to break up this large paragraph into two.. but still leave it here..", "author": "mosabua", "createdAt": "2020-09-24T03:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTM2OQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490625369", "bodyText": "do we want to omit views ?", "author": "mosabua", "createdAt": "2020-09-17T23:59:39Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.\n+The table and schema rules are used to specify who can can create, drop, alter, select, insert,\n+delete, etc. for schemas, tables and views.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNTQ0Nw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490625447", "bodyText": "matching rule, read from", "author": "mosabua", "createdAt": "2020-09-17T23:59:54Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.\n+The table and schema rules are used to specify who can can create, drop, alter, select, insert,\n+delete, etc. for schemas, tables and views.\n+\n+For each rule set, permission is based on the first matching rule read from top to bottom.  If", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNjA3Nw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490626077", "bodyText": "maybe have an actual section header Visibility ?", "author": "mosabua", "createdAt": "2020-09-18T00:02:12Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.\n+The table and schema rules are used to specify who can can create, drop, alter, select, insert,\n+delete, etc. for schemas, tables and views.\n+\n+For each rule set, permission is based on the first matching rule read from top to bottom.  If\n+no rule matches, access is denied. If no rules are provided at all, then access is granted.\n+\n+The following table summarizes the permissions required for each SQL command:\n+\n+==================================== ========== ======= ==================== ===================================================\n+SQL Command                          Catalog    Schema  Table                Note\n+==================================== ========== ======= ==================== ===================================================\n+SHOW CATALOGS                                                                Always allowed\n+SHOW SCHEMAS                         read-only  any*    any*                 Allowed if catalog is :ref:`visible<visibility>`\n+SHOW TABLES                          read-only  any*    any*                 Allowed if schema :ref:`visible<visibility>`\n+CREATE SCHEMA                        read-only  owner\n+DROP SCHEMA                          all        owner\n+SHOW CREATE SCHEMA                   all        owner\n+ALTER SCHEMA ... RENAME TO           all        owner*                       Ownership is required on both old and new schemas\n+ALTER SCHEMA ... SET AUTHORIZATION   all        owner\n+CREATE TABLE                         all                owner\n+DROP TABLE                           all                owner\n+ALTER TABLE ... RENAME TO            all                owner*               Ownership is required on both old and new tables\n+CREATE VIEW                          all                owner\n+DROP VIEW                            all                owner\n+ALTER VIEW ... RENAME TO             all                owner*               Ownership is required on both old and new views\n+COMMENT ON TABLE                     all                owner\n+COMMENT ON COLUMN                    all                owner\n+ALTER TABLE ... ADD COLUMN           all                owner\n+ALTER TABLE ... DROP COLUMN          all                owner\n+ALTER TABLE ... RENAME COLUMN        all                owner\n+SHOW COLUMNS                         all                any\n+SELECT FROM table                    read-only          select\n+SELECT FROM view                     read-only          select, grant_select\n+INSERT INTO                          all                insert\n+DELETE FROM                          all                delete\n+==================================== ========== ======= ==================== ===================================================\n+\n+.. _visibility:\n+\n+For a catalog, schema, or table to be visible in a ``SHOW`` command, the user must have", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3NzEzNQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r493977135", "bodyText": "I was thinking the section headers would be reserved for the rules sections, but a header seems ok to me", "author": "dain", "createdAt": "2020-09-24T00:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNjA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNzcxNQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490627715", "bodyText": "two spaces before The..", "author": "mosabua", "createdAt": "2020-09-18T00:08:25Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -34,13 +34,64 @@ Presto restart. The refresh period is specified in the ``etc/access-control.prop\n \n    security.refresh-period=1s\n \n+Catalog, Schema, and Table Access\n+---------------------------------\n+\n+Access to catalogs, schemas, tables, and views is controlled by the catalog, schema, and table\n+rules.  The catalog rules are course grained rules used to restrict all access or write\n+access to catalogs, but does not explicitly grant any specific schema or table permissions.\n+The table and schema rules are used to specify who can can create, drop, alter, select, insert,\n+delete, etc. for schemas, tables and views.\n+\n+For each rule set, permission is based on the first matching rule read from top to bottom.  If\n+no rule matches, access is denied. If no rules are provided at all, then access is granted.\n+\n+The following table summarizes the permissions required for each SQL command:\n+\n+==================================== ========== ======= ==================== ===================================================\n+SQL Command                          Catalog    Schema  Table                Note\n+==================================== ========== ======= ==================== ===================================================\n+SHOW CATALOGS                                                                Always allowed\n+SHOW SCHEMAS                         read-only  any*    any*                 Allowed if catalog is :ref:`visible<visibility>`\n+SHOW TABLES                          read-only  any*    any*                 Allowed if schema :ref:`visible<visibility>`\n+CREATE SCHEMA                        read-only  owner\n+DROP SCHEMA                          all        owner\n+SHOW CREATE SCHEMA                   all        owner\n+ALTER SCHEMA ... RENAME TO           all        owner*                       Ownership is required on both old and new schemas\n+ALTER SCHEMA ... SET AUTHORIZATION   all        owner\n+CREATE TABLE                         all                owner\n+DROP TABLE                           all                owner\n+ALTER TABLE ... RENAME TO            all                owner*               Ownership is required on both old and new tables\n+CREATE VIEW                          all                owner\n+DROP VIEW                            all                owner\n+ALTER VIEW ... RENAME TO             all                owner*               Ownership is required on both old and new views\n+COMMENT ON TABLE                     all                owner\n+COMMENT ON COLUMN                    all                owner\n+ALTER TABLE ... ADD COLUMN           all                owner\n+ALTER TABLE ... DROP COLUMN          all                owner\n+ALTER TABLE ... RENAME COLUMN        all                owner\n+SHOW COLUMNS                         all                any\n+SELECT FROM table                    read-only          select\n+SELECT FROM view                     read-only          select, grant_select\n+INSERT INTO                          all                insert\n+DELETE FROM                          all                delete\n+==================================== ========== ======= ==================== ===================================================\n+\n+.. _visibility:\n+\n+For a catalog, schema, or table to be visible in a ``SHOW`` command, the user must have\n+at least one permission on the item or any nested item.  The nested items do not", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMDU5NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r490630595", "bodyText": "rule, read", "author": "mosabua", "createdAt": "2020-09-18T00:17:52Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -191,13 +230,44 @@ The example below defines the following table access policy:\n           \"privileges\": []\n         },\n         {\n+          \"catalog\": \"default\",\n           \"schema\": \"default\",\n           \"table\": \".*\",\n           \"privileges\": [\"SELECT\"]\n         }\n       ]\n     }\n \n+.. _session_property_rules:\n+\n+Session Property Rules\n+----------------------\n+\n+These rules control the ability of a user to set system and catalog session properties. The\n+user is granted or denied access, based on the first matching rule read from top to bottom.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzM5NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494107395", "bodyText": "Why is that needed? We decided that when there is no rules then it is allow-all.", "author": "kokosing", "createdAt": "2020-09-24T07:47:35Z", "path": "presto-plugin-toolkit/src/test/resources/file-based-system-no-access.json", "diffHunk": "@@ -1,4 +1,9 @@\n {\n+  \"catalogs\": [\n+    {\n+      \"allow\": true\n+    }\n+  ],", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwOTc3NA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494109774", "bodyText": "Please add some testing", "author": "kokosing", "createdAt": "2020-09-24T07:51:38Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedSystemAccessControl.java", "diffHunk": "@@ -474,11 +474,10 @@ public void checkCanShowTables(SystemSecurityContext context, CatalogSchemaName\n     @Override\n     public Set<SchemaTableName> filterTables(SystemSecurityContext context, String catalogName, Set<SchemaTableName> tableNames)\n     {\n-        if (!canAccessCatalog(context, catalogName, READ_ONLY)) {\n-            return ImmutableSet.of();\n-        }\n-\n-        return tableNames;\n+        return tableNames.stream()\n+                .filter(tableName -> isSchemaOwner(context, new CatalogSchemaName(catalogName, tableName.getSchemaName())) ||\n+                        checkAnyTablePermission(context, new CatalogSchemaTableName(catalogName, tableName)))\n+                .collect(toImmutableSet());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMwNzA2NQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r497307065", "bodyText": "I think this one is important. Otherwise we can regress without any notice.", "author": "kokosing", "createdAt": "2020-09-30T07:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwOTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMDE1Nw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494110157", "bodyText": "Please add some testing where new could see the new behavior working", "author": "kokosing", "createdAt": "2020-09-24T07:52:11Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/FileBasedAccessControl.java", "diffHunk": "@@ -169,7 +170,9 @@ public void checkCanShowTables(ConnectorSecurityContext context, String schemaNa\n     @Override\n     public Set<SchemaTableName> filterTables(ConnectorSecurityContext context, Set<SchemaTableName> tableNames)\n     {\n-        return tableNames;\n+        return tableNames.stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMwNzAxOQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r497307019", "bodyText": "I think this one is important. Otherwise we can regress without any notice.", "author": "kokosing", "createdAt": "2020-09-30T07:45:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMDE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMzc3NA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494113774", "bodyText": "There is slight difference between having \"catalogs\": [] and not having this at all. Former suggests that user care about catalog checking, but haven't yet defined any rules (possibly a mistake) and so deny-all, the latter suggests that user don't care about checking the catalog rules and so allow-all).\nIn other words Optional<List<Rule>> when empty allow-all, when present but list empty deny-all.\nWDYT?", "author": "kokosing", "createdAt": "2020-09-24T07:57:52Z", "path": "presto-docs/src/main/sphinx/security/file-system-access-control.rst", "diffHunk": "@@ -127,11 +127,6 @@ ownership of any schema, you can use the following rules:\n .. code-block:: json\n \n     {\n-      \"catalogs\": [\n-        {\n-          \"allow\": true\n-        }\n-      ],", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1ODUxMg==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r496358512", "bodyText": "Yes this is how most of the rules today treat these today.  An empty array will always result in \"no rule matched\", so deny.  For no rules provided, the default is typically allow, but there are exceptions.  For every rule set the docs clearly note what happens.\nIn the later commits, I normalize catalog, schema, and table rules to this.  Instead of using Optionals for these in the code, I replace Optional.empty() with an allow rule, and the other is just an empty list so they get denied.", "author": "dain", "createdAt": "2020-09-29T03:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExMzc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExNDM1Mw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494114353", "bodyText": "test filtering methods", "author": "kokosing", "createdAt": "2020-09-24T07:58:49Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedAccessControl.java", "diffHunk": "@@ -43,6 +43,32 @@\n     private static final ConnectorSecurityContext BOB = user(\"bob\", ImmutableSet.of(\"staff\"));\n     private static final ConnectorSecurityContext CHARLIE = user(\"charlie\", ImmutableSet.of(\"guests\"));\n     private static final ConnectorSecurityContext JOE = user(\"joe\", ImmutableSet.of());\n+    private static final ConnectorSecurityContext UNKNOWN = user(\"unknown\", ImmutableSet.of());\n+\n+    @Test\n+    public void testEmptyFile()\n+    {\n+        ConnectorAccessControl accessControl = createAccessControl(\"empty.json\");\n+\n+        accessControl.checkCanCreateSchema(UNKNOWN, \"unknown\");\n+        accessControl.checkCanDropSchema(UNKNOWN, \"unknown\");\n+        accessControl.checkCanRenameSchema(UNKNOWN, \"unknown\", \"new_unknown\");\n+        accessControl.checkCanSetSchemaAuthorization(UNKNOWN, \"unknown\", new PrestoPrincipal(PrincipalType.ROLE, \"some_role\"));\n+        accessControl.checkCanShowCreateSchema(UNKNOWN, \"unknown\");\n+\n+        accessControl.checkCanSelectFromColumns(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"), ImmutableSet.of());\n+        accessControl.checkCanShowColumns(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"));\n+        accessControl.checkCanInsertIntoTable(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"));\n+        accessControl.checkCanDeleteFromTable(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"));\n+\n+        accessControl.checkCanCreateTable(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"));\n+        accessControl.checkCanDropTable(UNKNOWN, new SchemaTableName(\"unknown\", \"unknown\"));\n+        accessControl.checkCanRenameTable(UNKNOWN,\n+                new SchemaTableName(\"unknown\", \"unknown\"),\n+                new SchemaTableName(\"unknown\", \"new_unknown\"));\n+\n+        accessControl.checkCanSetCatalogSessionProperty(UNKNOWN, \"anything\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMxMTAxNA==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r497311014", "bodyText": "That should be easy to add. Just verify that no catalog, schema, table or columns were filtered.", "author": "kokosing", "createdAt": "2020-09-30T07:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExNDM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExNzYzMg==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r494117632", "bodyText": "The thing that we load external file and run tests on it make tests very difficult to follow. Especially when file is reused between tests.\nBest would be to have some kind of ddl to create file based system access control with few rules and then test them.", "author": "kokosing", "createdAt": "2020-09-24T08:04:23Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -564,17 +565,66 @@ public void testSchemaOperations()\n     }\n \n     @Test\n-    public void testCatalogOperations()\n-    {\n-        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"catalog.json\");\n-\n-        assertEquals(accessControl.filterCatalogs(new SystemSecurityContext(admin, queryId), allCatalogs), allCatalogs);\n-        Set<String> aliceCatalogs = ImmutableSet.of(\"open-to-all\", \"alice-catalog\", \"all-allowed\");\n-        assertEquals(accessControl.filterCatalogs(new SystemSecurityContext(alice, queryId), allCatalogs), aliceCatalogs);\n-        Set<String> bobCatalogs = ImmutableSet.of(\"open-to-all\", \"all-allowed\");\n-        assertEquals(accessControl.filterCatalogs(new SystemSecurityContext(bob, queryId), allCatalogs), bobCatalogs);\n-        Set<String> nonAsciiUserCatalogs = ImmutableSet.of(\"open-to-all\", \"all-allowed\", \"\\u0200\\u0200\\u0200\");\n-        assertEquals(accessControl.filterCatalogs(new SystemSecurityContext(nonAsciiUser, queryId), allCatalogs), nonAsciiUserCatalogs);\n+    public void testFilterCatalogs()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-visibility.json\");\n+        Set<String> allCatalogs = ImmutableSet.of(\n+                \"alice-catalog\",\n+                \"bob-catalog\",\n+                \"specific-catalog\",\n+                \"secret\",\n+                \"hidden\",\n+                \"open-to-all\",\n+                \"blocked-catalog\",\n+                \"unknown\");\n+\n+        assertEquals(accessControl.filterCatalogs(ADMIN, allCatalogs), Sets.difference(allCatalogs, ImmutableSet.of(\"blocked-catalog\")));\n+        Set<String> aliceCatalogs = ImmutableSet.of(\"specific-catalog\", \"alice-catalog\");\n+        assertEquals(accessControl.filterCatalogs(ALICE, allCatalogs), aliceCatalogs);\n+        Set<String> bobCatalogs = ImmutableSet.of(\"specific-catalog\", \"alice-catalog\", \"bob-catalog\");\n+        assertEquals(accessControl.filterCatalogs(BOB, allCatalogs), bobCatalogs);\n+        Set<String> charlieCatalogs = ImmutableSet.of(\"specific-catalog\");\n+        assertEquals(accessControl.filterCatalogs(CHARLIE, allCatalogs), charlieCatalogs);\n+    }\n+\n+    @Test\n+    public void testSchemaRulesForCheckCanShowSchemas()\n+    {\n+        SystemAccessControl accessControl = newFileBasedSystemAccessControl(\"file-based-system-access-visibility.json\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMxMzUzOQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r497313539", "bodyText": "let's skip this for now.", "author": "kokosing", "createdAt": "2020-09-30T07:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExNzYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMwMzYzOQ==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r497303639", "bodyText": "What about newUser (new_user)?", "author": "kokosing", "createdAt": "2020-09-30T07:39:40Z", "path": "presto-plugin-toolkit/src/main/java/io/prestosql/plugin/base/security/ImpersonationRule.java", "diffHunk": "@@ -32,7 +33,7 @@\n \n     @JsonCreator\n     public ImpersonationRule(\n-            @JsonProperty(\"originalUser\") Pattern originalUserPattern,\n+            @JsonProperty(\"original_user\") @JsonAlias(\"originalUser\") Pattern originalUserPattern,\n             @JsonProperty(\"newUser\") Pattern newUserPattern,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwMzk2Nw==", "url": "https://github.com/trinodb/trino/pull/5039#discussion_r500603967", "bodyText": "Good catch.  Fixed.", "author": "dain", "createdAt": "2020-10-06T21:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMwMzYzOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "334fc3db0563c4a5136d7e7becc18f2a75d37175", "url": "https://github.com/trinodb/trino/commit/334fc3db0563c4a5136d7e7becc18f2a75d37175", "message": "Simplify FileBasedAccessControl", "committedDate": "2020-10-07T00:27:13Z", "type": "commit"}, {"oid": "6611817d256fcfee5ca18ca3ce116cb791082126", "url": "https://github.com/trinodb/trino/commit/6611817d256fcfee5ca18ca3ce116cb791082126", "message": "Fix warnings in FileBasedSystemAccessControl", "committedDate": "2020-10-07T00:27:14Z", "type": "commit"}, {"oid": "e10a04bf7f9ef8fd2d943d832201625995eda35c", "url": "https://github.com/trinodb/trino/commit/e10a04bf7f9ef8fd2d943d832201625995eda35c", "message": "Change catalog check to match other checks\n\nPlace check catalog method near other checks", "committedDate": "2020-10-07T00:27:16Z", "type": "commit"}, {"oid": "06b1afc633d082baf6c9dce1e8301467f57c1d5e", "url": "https://github.com/trinodb/trino/commit/06b1afc633d082baf6c9dce1e8301467f57c1d5e", "message": "Simplify catalog checks in FileBasedSystemAccessControl", "committedDate": "2020-10-07T00:27:17Z", "type": "commit"}, {"oid": "9e4dc78d28f0769c20d6fcac2d801eff1c1c5ccb", "url": "https://github.com/trinodb/trino/commit/9e4dc78d28f0769c20d6fcac2d801eff1c1c5ccb", "message": "Simplify query checks in FileBasedSystemAccessControl", "committedDate": "2020-10-07T00:27:18Z", "type": "commit"}, {"oid": "4f846b2ed7c0672df94fa2f12adb96a1100b4edb", "url": "https://github.com/trinodb/trino/commit/4f846b2ed7c0672df94fa2f12adb96a1100b4edb", "message": "Clean up exception messages in FileBasedSystemAccessControl", "committedDate": "2020-10-07T00:27:19Z", "type": "commit"}, {"oid": "1c65efa3e8e44735a003dc3b16c33d858fd7b40e", "url": "https://github.com/trinodb/trino/commit/1c65efa3e8e44735a003dc3b16c33d858fd7b40e", "message": "Change file access control to consistently use snake case\n\nOld camel case names are still supported", "committedDate": "2020-10-07T00:27:20Z", "type": "commit"}, {"oid": "162f3fe54148d1405d62c50848555328a7b4b8e6", "url": "https://github.com/trinodb/trino/commit/162f3fe54148d1405d62c50848555328a7b4b8e6", "message": "Fix file access control for table create and rename checks\n\nChanged file based access control to check for table ownership to create,\nrename, or drop tables or views.", "committedDate": "2020-10-07T00:27:21Z", "type": "commit"}, {"oid": "a5a032592a078f39856ff60a6b7767748be48498", "url": "https://github.com/trinodb/trino/commit/a5a032592a078f39856ff60a6b7767748be48498", "message": "Fix system file create schema check", "committedDate": "2020-10-07T00:27:23Z", "type": "commit"}, {"oid": "78f61cddf7de42ca3f3612aed0ce6c752c0350f3", "url": "https://github.com/trinodb/trino/commit/78f61cddf7de42ca3f3612aed0ce6c752c0350f3", "message": "Add missing table checks in file system access control", "committedDate": "2020-10-07T00:27:24Z", "type": "commit"}, {"oid": "4b830656899e53dfbf0f9711fab0522587317d44", "url": "https://github.com/trinodb/trino/commit/4b830656899e53dfbf0f9711fab0522587317d44", "message": "Filter tables in file access control\n\nOnly show tables the user has permissions on", "committedDate": "2020-10-07T00:27:25Z", "type": "commit"}, {"oid": "cf812baa7bea31082fc83a6ce77aaf570f124853", "url": "https://github.com/trinodb/trino/commit/cf812baa7bea31082fc83a6ce77aaf570f124853", "message": "Add catalog regex to schema and table rules in file system access control", "committedDate": "2020-10-07T00:27:26Z", "type": "commit"}, {"oid": "41aa1f97b1f921bb9df2908d680923e570d0921b", "url": "https://github.com/trinodb/trino/commit/41aa1f97b1f921bb9df2908d680923e570d0921b", "message": "Allow all catalog access by default in file-based access control\n\nIf no catalog rules are defined, allow all catalog access", "committedDate": "2020-10-07T00:27:27Z", "type": "commit"}, {"oid": "a65adc6bb04df6b6ab2004063391bc55dea9d592", "url": "https://github.com/trinodb/trino/commit/a65adc6bb04df6b6ab2004063391bc55dea9d592", "message": "Simplify table and schema rules in file system access control\n\nTable and schema default to allow if there are no rules defined, so replace\nOptional empty with an allow allow rule", "committedDate": "2020-10-07T00:27:28Z", "type": "commit"}, {"oid": "4c24f4f2601707e6277e99c17b0149d5974f0dd2", "url": "https://github.com/trinodb/trino/commit/4c24f4f2601707e6277e99c17b0149d5974f0dd2", "message": "Change catalog file access default to allow for no rules\n\nSystem access control defaults to allow if no rules are defined for table,\nschema, and session property", "committedDate": "2020-10-07T00:27:30Z", "type": "commit"}, {"oid": "6039d26cae11443ba262dc58113eee7d57ee8ef6", "url": "https://github.com/trinodb/trino/commit/6039d26cae11443ba262dc58113eee7d57ee8ef6", "message": "Only show catalog if user has schema or table permissions", "committedDate": "2020-10-07T00:27:31Z", "type": "commit"}, {"oid": "a94a92117245d93aad71d21c88d82410f12688f9", "url": "https://github.com/trinodb/trino/commit/a94a92117245d93aad71d21c88d82410f12688f9", "message": "Only show schema if user is schema owner or has table permissions", "committedDate": "2020-10-07T00:27:32Z", "type": "commit"}, {"oid": "7cc4a2be6300e282b6977ece40e8126a172cbe84", "url": "https://github.com/trinodb/trino/commit/7cc4a2be6300e282b6977ece40e8126a172cbe84", "message": "Deny grant and revoke for catalog file access control\n\nCatalog file access control is static and not used in combination with other\naccess control systems, so grant and revoke are denied.", "committedDate": "2020-10-07T00:27:33Z", "type": "commit"}, {"oid": "b8da3ddf99ce669fcd322cfb89420cd05b794578", "url": "https://github.com/trinodb/trino/commit/b8da3ddf99ce669fcd322cfb89420cd05b794578", "message": "Add session property rules to system file access control", "committedDate": "2020-10-07T00:27:34Z", "type": "commit"}, {"oid": "a4bc95a76441879613a991f056b1a717f653ba85", "url": "https://github.com/trinodb/trino/commit/a4bc95a76441879613a991f056b1a717f653ba85", "message": "Improve system file based access documentation", "committedDate": "2020-10-07T00:27:35Z", "type": "commit"}, {"oid": "a4bc95a76441879613a991f056b1a717f653ba85", "url": "https://github.com/trinodb/trino/commit/a4bc95a76441879613a991f056b1a717f653ba85", "message": "Improve system file based access documentation", "committedDate": "2020-10-07T00:27:35Z", "type": "forcePushed"}]}