{"pr_number": 6219, "pr_title": "Ensure query-created event is called before query-completed event", "pr_createdAt": "2020-12-07T10:21:48Z", "pr_url": "https://github.com/trinodb/trino/pull/6219", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMzcwNw==", "url": "https://github.com/trinodb/trino/pull/6219#discussion_r537403707", "bodyText": "That's not exactly true, is it? Actually, i think before this PR, there seemed to be no possibility for out of order on create/complete events.\nI think the more important bit is that this must be here so that query-created is fired before analysis, which may invoke plugins.", "author": "findepi", "createdAt": "2020-12-07T10:42:21Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "diffHunk": "@@ -109,6 +110,14 @@ public DispatchQuery createDispatchQuery(\n                 warningCollector,\n                 StatementUtils.getQueryType(preparedQuery.getStatement().getClass()));\n \n+        // It is important that `queryCreatedEvent` is called here. Moving it past the `executor.submit` below\n+        // can result in delivering query-completed event before query-created event.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwODEzOA==", "url": "https://github.com/trinodb/trino/pull/6219#discussion_r537408138", "bodyText": "I think the more important bit is that this must be here so that query-created is fired before analysis, which may invoke plugins.\n\n:+1\nAnd also query-completed should be called after any interaction with plugins.", "author": "kokosing", "createdAt": "2020-12-07T10:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyMjUwNg==", "url": "https://github.com/trinodb/trino/pull/6219#discussion_r537422506", "bodyText": "That's not exactly true, is it? Actually, i think before this PR, there seemed to be no possibility for out of order on create/complete events\n\nYeah. It was not possible; because of queryMonitor nature explained before. I will change the first part of comment", "author": "losipiuk", "createdAt": "2020-12-07T11:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyNjc5Nw==", "url": "https://github.com/trinodb/trino/pull/6219#discussion_r537426797", "bodyText": "And also query-completed should be called after any interaction with plugins\n\nThis call spot has nothing to do with that", "author": "losipiuk", "createdAt": "2020-12-07T11:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyNjkwMQ==", "url": "https://github.com/trinodb/trino/pull/6219#discussion_r537426901", "bodyText": "@findepi @kokosing do you like the phasing more?", "author": "losipiuk", "createdAt": "2020-12-07T11:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQwMzcwNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "81105c0afcd42c58569a6b69beb3d2c8faa7ee1f", "url": "https://github.com/trinodb/trino/commit/81105c0afcd42c58569a6b69beb3d2c8faa7ee1f", "message": "Ensure query-created event is called before query-completed event", "committedDate": "2020-12-07T11:41:30Z", "type": "commit"}, {"oid": "81105c0afcd42c58569a6b69beb3d2c8faa7ee1f", "url": "https://github.com/trinodb/trino/commit/81105c0afcd42c58569a6b69beb3d2c8faa7ee1f", "message": "Ensure query-created event is called before query-completed event", "committedDate": "2020-12-07T11:41:30Z", "type": "forcePushed"}]}