{"pr_number": 3614, "pr_title": "Improve predicate push into RowNumberNode", "pr_createdAt": "2020-05-04T16:40:08Z", "pr_url": "https://github.com/trinodb/trino/pull/3614", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3OTQwNA==", "url": "https://github.com/trinodb/trino/pull/3614#discussion_r423979404", "bodyText": "Make commit message more explicit: \"Verify arguments to RowNumberNode constructor\"", "author": "martint", "createdAt": "2020-05-12T19:27:10Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/plan/RowNumberNode.java", "diffHunk": "@@ -63,6 +63,7 @@ public RowNumberNode(\n         checkArgument(!orderSensitive || partitionBy.isEmpty(), \"unexpected partitioning in order sensitive node\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5MzU1Nw==", "url": "https://github.com/trinodb/trino/pull/3614#discussion_r423993557", "bodyText": "I'm not sure I understand why this line changed. Can you explain?", "author": "martint", "createdAt": "2020-05-12T19:52:14Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/WindowFilterPushDown.java", "diffHunk": "@@ -169,8 +171,11 @@ public PlanNode visitFilter(FilterNode node, RewriteContext<Void> context)\n                 OptionalInt upperBound = extractUpperBound(tupleDomain, rowNumberSymbol);\n \n                 if (upperBound.isPresent()) {\n+                    if (upperBound.getAsInt() <= 0) {\n+                        return new ValuesNode(node.getId(), node.getOutputSymbols(), ImmutableList.of());\n+                    }\n                     source = mergeLimit(((RowNumberNode) source), upperBound.getAsInt());\n-                    return rewriteFilterSource(node, source, rowNumberSymbol, upperBound.getAsInt());\n+                    return rewriteFilterSource(node, source, rowNumberSymbol, ((RowNumberNode) source).getMaxRowCountPerPartition().get());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM0OTIzMQ==", "url": "https://github.com/trinodb/trino/pull/3614#discussion_r424349231", "bodyText": "After mergeLimit(), the source's maxRowCountPerPartition is either equal to upperBound or lower (the latter happens in the case when the source was already limited with a lower limit).\nSo, I decided to pass to rewriteFilterSource() the actual limit value of the source, which may be lower than upperBound. Consequently, the possibly lower bound value is tested against the original filter predicate, which improves the chance that we consider the predicate satisfied.\nExample:\n- Filter (row_num < 5 AND row_num BETWEEN 20 AND 30)\n    - RowNumberNode (maxRowCountPerPartition == 3)\n\n\nwe get upperBound = 30, and then call mergeLimit(30) on RowNumberNode, which is ineffective, as the current limit is lower (3).\nNext, we call allRowNumberValuesInDomain() to check if the established range for row_num symbol lies within the domain defined by Filter predicate.\nI we pass 30, as before the change, we get false.\nIf we pass the actual value 3, we get true and can consider the predicate satisfied, and the Filter redundant.", "author": "kasiafi", "createdAt": "2020-05-13T10:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5MzU1Nw=="}], "type": "inlineReview"}, {"oid": "0142fcd53f5e91c7ce043caeaa7121f560a83cb9", "url": "https://github.com/trinodb/trino/commit/0142fcd53f5e91c7ce043caeaa7121f560a83cb9", "message": "Verify arguments to RowNumberNode constructor", "committedDate": "2020-05-13T18:25:33Z", "type": "commit"}, {"oid": "4ef26dd200cfeadf4a2c0c543279a05ccd8399fc", "url": "https://github.com/trinodb/trino/commit/4ef26dd200cfeadf4a2c0c543279a05ccd8399fc", "message": "Improve Filter predicate push into RowNumber\n\nChanges WindowFilterPushdown when processing FilterNode on top of:\n- RowNumberNode,\n- WindowNode transformed into TopNRowNumberNode.\n\nchange 1. When extracting the upper bound for row number symbol from Filter predicate,\nalso non-positive values are extracted (previously only positive values were considered).\nNow, if the upper bound for row number symbol is 0 or negative, the plan is replaced\nwith empty values.\n\nchange 2. After adding limit to RowNumberNode / TopNRowNumberNode, the newly established\nrange for row number symbol is compared with the Filter predicate. Previously, equality\ncheck was performed. Filter predicate was considered satisfied only if it defined a range\nthat was lower-unbounded, upper-closed on the exact maxRowCount value (e.g. \"row_number <= 5\").\nNow it is checked that the range for row number symbol is _contained_ in the range defined\nby the Filter predicate. This allows to determine that the predicate is satisfied in more cases\ne.g. maxRowCountPerPartition = 5 satisfies predicate \"row_number > -3 AND row_number < 10\".\nAs a result, filter is simplified or even removed from the plan.", "committedDate": "2020-05-13T18:26:00Z", "type": "commit"}, {"oid": "4ef26dd200cfeadf4a2c0c543279a05ccd8399fc", "url": "https://github.com/trinodb/trino/commit/4ef26dd200cfeadf4a2c0c543279a05ccd8399fc", "message": "Improve Filter predicate push into RowNumber\n\nChanges WindowFilterPushdown when processing FilterNode on top of:\n- RowNumberNode,\n- WindowNode transformed into TopNRowNumberNode.\n\nchange 1. When extracting the upper bound for row number symbol from Filter predicate,\nalso non-positive values are extracted (previously only positive values were considered).\nNow, if the upper bound for row number symbol is 0 or negative, the plan is replaced\nwith empty values.\n\nchange 2. After adding limit to RowNumberNode / TopNRowNumberNode, the newly established\nrange for row number symbol is compared with the Filter predicate. Previously, equality\ncheck was performed. Filter predicate was considered satisfied only if it defined a range\nthat was lower-unbounded, upper-closed on the exact maxRowCount value (e.g. \"row_number <= 5\").\nNow it is checked that the range for row number symbol is _contained_ in the range defined\nby the Filter predicate. This allows to determine that the predicate is satisfied in more cases\ne.g. maxRowCountPerPartition = 5 satisfies predicate \"row_number > -3 AND row_number < 10\".\nAs a result, filter is simplified or even removed from the plan.", "committedDate": "2020-05-13T18:26:00Z", "type": "forcePushed"}]}