{"pr_number": 3239, "pr_title": "Add support for Glue endpoint URL", "pr_createdAt": "2020-03-25T14:37:34Z", "pr_url": "https://github.com/trinodb/trino/pull/3239", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDQxNA==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399250414", "bodyText": "add versioned dependency to main pom.xml (including exclusions). Therefore you won't need to specify version here", "author": "sopel39", "createdAt": "2020-03-27T13:07:54Z", "path": "presto-hive/pom.xml", "diffHunk": "@@ -328,6 +328,20 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.httpcomponents</groupId>\n+            <artifactId>httpclient</artifactId>\n+            <version>4.5.10</version>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0NjgzMQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399346831", "bodyText": "Done", "author": "ppalucha", "createdAt": "2020-03-27T15:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NTE5NA==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399495194", "bodyText": "Easier said than done... This library (and some of it's dependencies, such as httpcore) is pulled in different projects in Presto in different versions, usually as a dependency for some other library. I ended up in situation when code compiles, but tests fails. I'll leave explicit version here...", "author": "ppalucha", "createdAt": "2020-03-27T19:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDk0OQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399250949", "bodyText": "move below usage (below createAsyncGlueClient method)", "author": "sopel39", "createdAt": "2020-03-27T13:08:47Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -177,13 +184,34 @@ public GlueHiveMetastore(\n         this.columnStatisticsProvider = requireNonNull(columnStatisticsProvider, \"columnStatisticsProvider is null\");\n     }\n \n+    private static void disableSSLHostnameVerification(ApacheHttpClientConfig httpClientConfig)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0NjkzNA==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399346934", "bodyText": "Done", "author": "ppalucha", "createdAt": "2020-03-27T15:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTU2NQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399499565", "bodyText": "Done", "author": "ppalucha", "createdAt": "2020-03-27T19:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MDk0OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTUzNg==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399499536", "bodyText": "Why not the latest, 4.5.12?", "author": "electrum", "createdAt": "2020-03-27T19:40:31Z", "path": "presto-hive/pom.xml", "diffHunk": "@@ -328,6 +328,20 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.httpcomponents</groupId>\n+            <artifactId>httpclient</artifactId>\n+            <version>4.5.10</version>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NzAxNA==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399547014", "bodyText": "Fixed", "author": "ppalucha", "createdAt": "2020-03-27T21:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTU3Nw==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399499577", "bodyText": "Remove extra blank line", "author": "electrum", "createdAt": "2020-03-27T19:40:37Z", "path": "presto-hive/pom.xml", "diffHunk": "@@ -328,6 +328,20 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.httpcomponents</groupId>\n+            <artifactId>httpclient</artifactId>\n+            <version>4.5.10</version>\n+            <scope>compile</scope>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>commons-logging</groupId>\n+                    <artifactId>commons-logging</artifactId>\n+                </exclusion>\n+            </exclusions>\n+        </dependency>\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NzA2MQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399547061", "bodyText": "Fixed", "author": "ppalucha", "createdAt": "2020-03-27T21:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTYzMQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399499631", "bodyText": "Remove, as this is the default scope", "author": "electrum", "createdAt": "2020-03-27T19:40:44Z", "path": "presto-hive/pom.xml", "diffHunk": "@@ -328,6 +328,20 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.httpcomponents</groupId>\n+            <artifactId>httpclient</artifactId>\n+            <version>4.5.10</version>\n+            <scope>compile</scope>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NzIzNQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399547235", "bodyText": "Fixed", "author": "ppalucha", "createdAt": "2020-03-27T21:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5OTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNDYxNA==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399504614", "bodyText": "I don't understand this. The AWS documentation doesn't mention anything about this: https://docs.aws.amazon.com/glue/latest/dg/vpc-endpoint.html\nThe SDK Javadoc for com.amazonaws.sdk.disableCertChecking says\n\nDisable validation of server certificates when using the HTTPS protocol. This should ONLY be used to do quick smoke tests against endpoints which don't yet have valid certificates; it should NEVER be used in production.\n\nAs a general security practice, we don't add code to Presto to allow users to defeat security mechanisms.\nIf this actually is needed, please provide specific AWS documentation about why. And in that case, it needs to be a separate configuration property, not tied to setting the endpoint URL.", "author": "electrum", "createdAt": "2020-03-27T19:51:33Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -180,10 +187,19 @@ public GlueHiveMetastore(\n     private static AWSGlueAsync createAsyncGlueClient(GlueHiveMetastoreConfig config)\n     {\n         ClientConfiguration clientConfig = new ClientConfiguration().withMaxConnections(config.getMaxGlueConnections());\n+        if (config.getGlueEndpointUrl().isPresent()) {\n+            checkArgument(config.getGlueRegion().isPresent(), \"Glue region must be set when Glue endpoint URL is set\");\n+            // Certificate host name validation fails if we are connecting with VPC endpoint host name", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxNjIwMQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399516201", "bodyText": "I don't understand this. The AWS documentation doesn't mention anything about this: https://docs.aws.amazon.com/glue/latest/dg/vpc-endpoint.html\nThe SDK Javadoc for com.amazonaws.sdk.disableCertChecking says\n\nDisable validation of server certificates when using the HTTPS protocol. This should ONLY be used to do quick smoke tests against endpoints which don't yet have valid certificates; it should NEVER be used in production.\n\n\nWe are not setting com.amazonaws.sdk.disableCertChecking. We disable host name validation only for Glue client and only if we're using endpoint.\n\nIf this actually is needed, please provide specific AWS documentation about why. And in that case, it needs to be a separate configuration property, not tied to setting the endpoint URL.\n\nI want it to be tied to endpoint and not as a general setting (for the reason you stated).\nThe Glue service provides certificate for it's public name (e.g. glue.us-east-2.amazonaws.com). VPC endpoints have its own DNS names, specific for user/vpc. Connecting to such endpoint will fail with standard host name verifier.\nOther possible options:\n\nWe could not provide this functionality at all and require enabling Private DNS on AWS vpc endpoint. But this requires some specific settings on VPC that we may not want to impose on users.\nWe could enable it only if required because user cannot enable Private DNS (adding configuration property).\nWe could create more strict hostname verifier, which actually verifies that we connect to region-specific glue service.\nWe can combine 2 and 3...", "author": "ppalucha", "createdAt": "2020-03-27T20:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNDYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MjM0Mg==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r399542342", "bodyText": "BTW - the same behaviour is using e.g. aws-cli:\n# aws --endpoint-url https://vpce-03284955d8f8f36ae-hug1rabn.glue.us-east-2.vpce.amazonaws.com/   glue get-databases --region us-east-2\n\nSSL validation failed for https://vpce-03284955d8f8f36ae-hug1rabn.glue.us-east-2.vpce.amazonaws.com/ (\"hostname 'vpce-03284955d8f8f36ae-hug1rabn.glue.us-east-2.vpce.amazonaws.com' doesn't match 'glue.us-east-2.amazonaws.com'\",)", "author": "ppalucha", "createdAt": "2020-03-27T21:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNDYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTUyNzQ3NQ==", "url": "https://github.com/trinodb/trino/pull/3239#discussion_r401527475", "bodyText": "Removed SSL disable code, we will use proxy instead.", "author": "ppalucha", "createdAt": "2020-04-01T10:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNDYxNA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "aef53ffae0c5abea34ce4cb28c1959f3257bedef", "url": "https://github.com/trinodb/trino/commit/aef53ffae0c5abea34ce4cb28c1959f3257bedef", "message": "Add support for Glue endpoint URL", "committedDate": "2020-04-01T10:52:00Z", "type": "commit"}, {"oid": "aef53ffae0c5abea34ce4cb28c1959f3257bedef", "url": "https://github.com/trinodb/trino/commit/aef53ffae0c5abea34ce4cb28c1959f3257bedef", "message": "Add support for Glue endpoint URL", "committedDate": "2020-04-01T10:52:00Z", "type": "forcePushed"}]}