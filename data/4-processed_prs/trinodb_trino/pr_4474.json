{"pr_number": 4474, "pr_title": "Add test environment with hive.hdfs.data-transfer-protection=privacy", "pr_createdAt": "2020-07-16T14:26:26Z", "pr_url": "https://github.com/trinodb/trino/pull/4474", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzOTIwOQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456239209", "bodyText": "Why TestGrantRevoke at all?", "author": "findepi", "createdAt": "2020-07-17T06:13:50Z", "path": "presto-product-tests/bin/product-tests-suite-3.sh", "diffHunk": "@@ -22,5 +22,12 @@ presto-product-tests-launcher/bin/run-launcher test run \\\n     -- -g storage_formats,cli,hdfs_impersonation,authorization -x iceberg,\"${DISTRO_SKIP_GROUP}\" -e \"${DISTRO_SKIP_TEST}\" \\\n     || suite_exit_code=1\n \n+# run very selective set of tests on singlenode-kerberos-hdfs-impersonation-with-data-protection so we do not add\n+# a lot to runtime\n+presto-product-tests-launcher/bin/run-launcher test run \\\n+    --environment singlenode-kerberos-hdfs-impersonation-with-data-protection \\\n+    -- -t TestHiveStorageFormats.testOrcTableCreatedInPresto,TestGrantRevoke.testGrantRevoke -x \"${DISTRO_SKIP_GROUP}\" -e \"${DISTRO_SKIP_TEST}\" \\", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0NDY2MQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456244661", "bodyText": "Not a good answer here. I think we can skip that. I left it here as representant of authentication group, but I agree this is not really relevant to data-transfer-protection. I will add one or two more which actually read data to make probability that those will be excluded via DISTRO_SKIP* variables.", "author": "losipiuk", "createdAt": "2020-07-17T06:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzOTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzOTUyMQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456239521", "bodyText": "That's a good thinking, but I do not think it needs to be put in a comment. It's seems obvious why you picked few tests. Unless you want to also explain why these particular tests.", "author": "findepi", "createdAt": "2020-07-17T06:14:50Z", "path": "presto-product-tests/bin/product-tests-suite-3.sh", "diffHunk": "@@ -22,5 +22,12 @@ presto-product-tests-launcher/bin/run-launcher test run \\\n     -- -g storage_formats,cli,hdfs_impersonation,authorization -x iceberg,\"${DISTRO_SKIP_GROUP}\" -e \"${DISTRO_SKIP_TEST}\" \\\n     || suite_exit_code=1\n \n+# run very selective set of tests on singlenode-kerberos-hdfs-impersonation-with-data-protection so we do not add\n+# a lot to runtime", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzOTg3MA==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456239870", "bodyText": "I guess iceberg catalog is not used in the test.", "author": "findepi", "createdAt": "2020-07-17T06:15:51Z", "path": "presto-product-tests-launcher/src/main/resources/docker/presto-product-tests/conf/environment/singlenode-kerberos-hdfs-impersonation-with-data-protection/iceberg.properties", "diffHunk": "@@ -0,0 +1,15 @@\n+connector.name=iceberg", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0NTU0OQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456245549", "bodyText": "Dropped", "author": "losipiuk", "createdAt": "2020-07-17T06:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzOTg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MDIzOQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456240239", "bodyText": "a TODO not to require hive-data-protection.xml?\n(also you may want to follow *-site.xml convention, as in hive-default-fs-site.xml)", "author": "findepi", "createdAt": "2020-07-17T06:17:02Z", "path": "presto-product-tests-launcher/src/main/resources/docker/presto-product-tests/conf/environment/singlenode-kerberos-hdfs-impersonation-with-data-protection/hive.properties", "diffHunk": "@@ -0,0 +1,19 @@\n+connector.name=hive-hadoop2\n+hive.metastore.uri=thrift://hadoop-master:9083\n+hive.config.resources=/docker/presto-product-tests/conf/presto/etc/hive-default-fs-site.xml,/docker/presto-product-tests/conf/presto/etc/hive-data-protection.xml", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0NzQxMQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456247411", "bodyText": "a TODO not to require hive-data-protection.xml?\n\nNot sure it is worth it. It looks like we should map the two properties which we have in .xml 1-1 to Presto properties. It can be done, but I am not 100% those are commonly use enough to justify that. I actually have code for one of those, already, but I shelved it to discuss if we really want it.", "author": "losipiuk", "createdAt": "2020-07-17T06:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MDIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0Nzk3OA==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456247978", "bodyText": "Fair", "author": "findepi", "createdAt": "2020-07-17T06:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MDIzOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "7f2b17efbf56b2420ff0475e33f18d0c290f4c80", "url": "https://github.com/trinodb/trino/commit/7f2b17efbf56b2420ff0475e33f18d0c290f4c80", "message": "Run subset of product tests against env with data protection", "committedDate": "2020-07-17T08:16:36Z", "type": "commit"}, {"oid": "7f2b17efbf56b2420ff0475e33f18d0c290f4c80", "url": "https://github.com/trinodb/trino/commit/7f2b17efbf56b2420ff0475e33f18d0c290f4c80", "message": "Run subset of product tests against env with data protection", "committedDate": "2020-07-17T08:16:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzMTk3NQ==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456331975", "bodyText": "How does this environment is different to singlenode-kerberos-hdfs-impersonation-with-wire-encryption", "author": "kokosing", "createdAt": "2020-07-17T09:32:45Z", "path": "presto-product-tests/bin/product-tests-suite-3.sh", "diffHunk": "@@ -22,5 +22,11 @@ presto-product-tests-launcher/bin/run-launcher test run \\\n     -- -g storage_formats,cli,hdfs_impersonation,authorization -x iceberg,\"${DISTRO_SKIP_GROUP}\" -e \"${DISTRO_SKIP_TEST}\" \\\n     || suite_exit_code=1\n \n+# Smoke run af a few tests in environment with dfs.data.transfer.protection=true. Arbitrary tests which access HDFS data were chosen.\n+presto-product-tests-launcher/bin/run-launcher test run \\\n+    --environment singlenode-kerberos-hdfs-impersonation-with-data-protection \\", "originalCommit": "7f2b17efbf56b2420ff0475e33f18d0c290f4c80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzMzUyNA==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456333524", "bodyText": "When it comes to hadoop config:\n    <property>\n        <name>dfs.data.transfer.protection</name>\n        <value>privacy</value>\n    </property>\n\ninstead of\n    <property>\n        <name>dfs.encrypt.data.transfer</name>\n        <value>true</value>\n    </property>", "author": "losipiuk", "createdAt": "2020-07-17T09:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzMTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MjQ2Ng==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456352466", "bodyText": "I wish I could know that from reading the code...", "author": "kokosing", "createdAt": "2020-07-17T10:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzMTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MjUwMg==", "url": "https://github.com/trinodb/trino/pull/4474#discussion_r456352502", "bodyText": "Thanks!", "author": "kokosing", "createdAt": "2020-07-17T10:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzMTk3NQ=="}], "type": "inlineReview"}]}