{"pr_number": 5220, "pr_title": "Reduce size of serialized Range (and TupleDomain)", "pr_createdAt": "2020-09-18T19:47:46Z", "pr_url": "https://github.com/trinodb/trino/pull/5220", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2Mjc4Mw==", "url": "https://github.com/trinodb/trino/pull/5220#discussion_r491462783", "bodyText": "If we were doing this on ValueSet level, we wouldn't need to store the type for every value", "author": "findepi", "createdAt": "2020-09-19T14:56:58Z", "path": "presto-main/src/main/java/io/prestosql/server/RangeJsonSerde.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.predicate.Marker;\n+import io.prestosql.spi.predicate.Range;\n+import io.prestosql.spi.type.Type;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static io.prestosql.spi.predicate.Marker.Bound.EXACTLY;\n+\n+public class RangeJsonSerde\n+{\n+    private RangeJsonSerde() {}\n+\n+    public static class Serializer\n+            extends JsonSerializer<Range>\n+    {\n+        @Override\n+        public void serialize(Range range, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)\n+                throws IOException\n+        {\n+            jsonGenerator.writeNumber(range.isSingleValue() ? 1 : 0);\n+            if (range.isSingleValue()) {\n+                serializerProvider.findValueSerializer(Type.class).serialize(range.getType(), jsonGenerator, serializerProvider);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3MDcyNQ==", "url": "https://github.com/trinodb/trino/pull/5220#discussion_r491970725", "bodyText": "It's a good extension for follow-up PR", "author": "sopel39", "createdAt": "2020-09-21T11:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2Mjc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MzE4Mg==", "url": "https://github.com/trinodb/trino/pull/5220#discussion_r491463182", "bodyText": "We should add a test in TestRangeJsonSerde verifying the Range class has exactly this two fields.\notherwise one can add a new optional field to Range, not knowing the dedicated serialization existss\nthe serialization test will still be passing, while it will be no longer correct", "author": "findepi", "createdAt": "2020-09-19T15:01:22Z", "path": "presto-main/src/main/java/io/prestosql/server/RangeJsonSerde.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.predicate.Marker;\n+import io.prestosql.spi.predicate.Range;\n+import io.prestosql.spi.type.Type;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static io.prestosql.spi.predicate.Marker.Bound.EXACTLY;\n+\n+public class RangeJsonSerde\n+{\n+    private RangeJsonSerde() {}\n+\n+    public static class Serializer\n+            extends JsonSerializer<Range>\n+    {\n+        @Override\n+        public void serialize(Range range, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)\n+                throws IOException\n+        {\n+            jsonGenerator.writeNumber(range.isSingleValue() ? 1 : 0);\n+            if (range.isSingleValue()) {\n+                serializerProvider.findValueSerializer(Type.class).serialize(range.getType(), jsonGenerator, serializerProvider);\n+                serializerProvider.findValueSerializer(Block.class).serialize(range.getLow().getValueBlock().get(), jsonGenerator, serializerProvider);\n+                return;\n+            }\n+\n+            JsonSerializer<Object> markerSerializer = serializerProvider.findValueSerializer(Marker.class);\n+            markerSerializer.serialize(range.getLow(), jsonGenerator, serializerProvider);\n+            markerSerializer.serialize(range.getHigh(), jsonGenerator, serializerProvider);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwMzc5Ng==", "url": "https://github.com/trinodb/trino/pull/5220#discussion_r491903796", "bodyText": "Same applies to Marker class. As if (range.isSingleValue()) { branch essentially also provides specific serialiser for Marker objects (at least some subclass of those)", "author": "losipiuk", "createdAt": "2020-09-21T09:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MzE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3NTAwNg==", "url": "https://github.com/trinodb/trino/pull/5220#discussion_r491975006", "bodyText": "I've added another test case with unbounded range.\nTests do round robin serialization, but also construct objects using new Range, new Marker so any changes to these objects should cause compilation to fail", "author": "sopel39", "createdAt": "2020-09-21T11:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MzE4Mg=="}], "type": "inlineReview"}, {"oid": "b5cc626445663c166bf30ba582bdefbfc9148b78", "url": "https://github.com/trinodb/trino/commit/b5cc626445663c166bf30ba582bdefbfc9148b78", "message": "Reduce size of serialized Range (and TupleDomain)", "committedDate": "2020-09-21T11:42:52Z", "type": "commit"}, {"oid": "b5cc626445663c166bf30ba582bdefbfc9148b78", "url": "https://github.com/trinodb/trino/commit/b5cc626445663c166bf30ba582bdefbfc9148b78", "message": "Reduce size of serialized Range (and TupleDomain)", "committedDate": "2020-09-21T11:42:52Z", "type": "forcePushed"}]}