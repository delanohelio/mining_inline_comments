{"pr_number": 6152, "pr_title": "Test TIMESTAMP WITH TIME ZONE calendar compatibility", "pr_createdAt": "2020-11-30T12:48:43Z", "pr_url": "https://github.com/trinodb/trino/pull/6152", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MjM4NQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r533642385", "bodyText": "I think splitting expressions into 2 arguments (prestoExpression, referenceExpressions) would make this more intuitive.", "author": "aalbu", "createdAt": "2020-12-01T18:47:43Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSetTimezone.java", "diffHunk": "@@ -248,15 +249,23 @@ private void assertParameter(Object expectedValue, Optional<String> sessionTimez\n     private void checkRepresentation(String expression, JDBCType type, Optional<String> sessionTimezoneId, ResultAssertion assertion)\n             throws Exception\n     {\n+        checkRepresentation(nCopies(referenceDrivers.size() + 1, expression), type, sessionTimezoneId, assertion);\n+    }\n+\n+    private void checkRepresentation(List<String> expressions, JDBCType type, Optional<String> sessionTimezoneId, ResultAssertion assertion)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5MzEzNg==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535893136", "bodyText": "Done", "author": "findepi", "createdAt": "2020-12-04T07:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MjM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0Mjg3OA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r533642878", "bodyText": "Nit: Wrong expression list size?", "author": "aalbu", "createdAt": "2020-12-01T18:48:35Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSetTimezone.java", "diffHunk": "@@ -248,15 +249,23 @@ private void assertParameter(Object expectedValue, Optional<String> sessionTimez\n     private void checkRepresentation(String expression, JDBCType type, Optional<String> sessionTimezoneId, ResultAssertion assertion)\n             throws Exception\n     {\n+        checkRepresentation(nCopies(referenceDrivers.size() + 1, expression), type, sessionTimezoneId, assertion);\n+    }\n+\n+    private void checkRepresentation(List<String> expressions, JDBCType type, Optional<String> sessionTimezoneId, ResultAssertion assertion)\n+            throws Exception\n+    {\n+        verify(expressions.size() == referenceDrivers.size() + 1, \"Wrong expressions list\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5MzgzOA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535893838", "bodyText": "Done", "author": "findepi", "createdAt": "2020-12-04T07:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0Mjg3OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzMzM4Ng==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535933386", "bodyText": "I do not find comment here usefult given two lines above.", "author": "losipiuk", "createdAt": "2020-12-04T08:50:53Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -492,7 +493,9 @@ public void testTimestampWithTimeZone()\n     {\n         try (ConnectedStatement connectedStatement = newStatement()) {\n             checkRepresentation(connectedStatement.getStatement(), \"TIMESTAMP '2018-02-13 13:14:15.227 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n-                assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 6, 14, 15, 227_000_000))); // TODO this should represent TIMESTAMP '2018-02-13 13:14:15.227 Europe/Warsaw'\n+                ZonedDateTime zonedDateTime = ZonedDateTime.of(2018, 2, 13, 13, 14, 15, 227_000_000, ZoneId.of(\"Europe/Warsaw\"));\n+                Timestamp timestampForPointInTime = Timestamp.from(zonedDateTime.toInstant());\n+                assertEquals(rs.getObject(column), timestampForPointInTime); // TODO this should represent TIMESTAMP '2018-02-13 13:14:15.227 Europe/Warsaw'", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNTU0MQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535935541", "bodyText": "This TODO comment will be removed in #307\nIt is here today, so that\n\ni can exercise this code path\nwithout implying the expected result has my blessing as to whether it is correct", "author": "findepi", "createdAt": "2020-12-04T08:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzMzM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNDM2OQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535934369", "bodyText": "ditto here and below.", "author": "losipiuk", "createdAt": "2020-12-04T08:52:21Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -501,52 +504,61 @@ public void testTimestampWithTimeZone()\n                         .hasMessage(serverSupportsVariablePrecisionTimestampWithTimeZone()\n                                 ? \"Expected column to be a time type but is timestamp with time zone(3)\" // TODO (https://github.com/prestosql/presto/issues/5317) placement of precision parameter\n                                 : \"Expected column to be a time type but is timestamp with time zone\");\n-                assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 6, 14, 15, 227_000_000))); // TODO this should fail, or represent TIMESTAMP '2018-02-13 13:14:15.227'\n+                assertEquals(rs.getTimestamp(column), timestampForPointInTime);\n             });\n \n             // second fraction in nanoseconds overflowing to next second, minute, hour, day, month, year\n             if (serverSupportsVariablePrecisionTimestampWithTimeZone()) {\n                 checkRepresentation(connectedStatement.getStatement(), \"TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n-                    assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2019, 12, 31, 17, 0, 0, 0)));  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\n+                    ZonedDateTime zonedDateTime = ZonedDateTime.of(2020, 1, 1, 0, 0, 0, 0, ZoneId.of(\"Europe/Warsaw\"));\n+                    Timestamp timestampForPointInTime = Timestamp.from(zonedDateTime.toInstant());\n+                    assertEquals(rs.getObject(column), timestampForPointInTime);  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNTUxMA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535935510", "bodyText": "Oh - here it actually makes sense, due to long fractional part.", "author": "losipiuk", "createdAt": "2020-12-04T08:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNDM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1ODIxNA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535958214", "bodyText": "It's more about time zone actually.", "author": "findepi", "createdAt": "2020-12-04T09:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNDM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODMzNQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535938335", "bodyText": "Why comment here references Europe/Warsaw", "author": "losipiuk", "createdAt": "2020-12-04T08:58:03Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -501,52 +504,61 @@ public void testTimestampWithTimeZone()\n                         .hasMessage(serverSupportsVariablePrecisionTimestampWithTimeZone()\n                                 ? \"Expected column to be a time type but is timestamp with time zone(3)\" // TODO (https://github.com/prestosql/presto/issues/5317) placement of precision parameter\n                                 : \"Expected column to be a time type but is timestamp with time zone\");\n-                assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 6, 14, 15, 227_000_000))); // TODO this should fail, or represent TIMESTAMP '2018-02-13 13:14:15.227'\n+                assertEquals(rs.getTimestamp(column), timestampForPointInTime);\n             });\n \n             // second fraction in nanoseconds overflowing to next second, minute, hour, day, month, year\n             if (serverSupportsVariablePrecisionTimestampWithTimeZone()) {\n                 checkRepresentation(connectedStatement.getStatement(), \"TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n-                    assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2019, 12, 31, 17, 0, 0, 0)));  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\n+                    ZonedDateTime zonedDateTime = ZonedDateTime.of(2020, 1, 1, 0, 0, 0, 0, ZoneId.of(\"Europe/Warsaw\"));\n+                    Timestamp timestampForPointInTime = Timestamp.from(zonedDateTime.toInstant());\n+                    assertEquals(rs.getObject(column), timestampForPointInTime);  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\n                     assertThatThrownBy(() -> rs.getDate(column))\n                             .isInstanceOf(SQLException.class)\n                             .hasMessage(\"Expected value to be a date but is: 2019-12-31 23:59:59.999999999999 Europe/Warsaw\");\n                     assertThatThrownBy(() -> rs.getTime(column))\n                             .isInstanceOf(IllegalArgumentException.class) // TODO (https://github.com/prestosql/presto/issues/5315) SQLException\n                             .hasMessage(\"Expected column to be a time type but is timestamp with time zone(12)\"); // TODO (https://github.com/prestosql/presto/issues/5317) placement of precision parameter\n-                    assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2019, 12, 31, 17, 0, 0, 0)));\n+                    assertEquals(rs.getTimestamp(column), timestampForPointInTime);\n                 });\n \n+                ZoneId jvmZone = ZoneId.systemDefault();\n                 checkRepresentation(\n                         connectedStatement.getStatement(),\n-                        format(\"TIMESTAMP '2019-12-31 23:59:59.999999999999 %s'\", ZoneId.systemDefault().getId()),\n+                        format(\"TIMESTAMP '2019-12-31 23:59:59.999999999999 %s'\", jvmZone.getId()),\n                         Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */,\n                         (rs, column) -> {\n-                            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2020, 1, 1, 0, 0, 0, 0)));  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'\n+                            ZonedDateTime zonedDateTime = ZonedDateTime.of(2020, 1, 1, 0, 0, 0, 0, jvmZone);\n+                            Timestamp timestampForPointInTime = Timestamp.from(zonedDateTime.toInstant());\n+                            assertEquals(rs.getObject(column), timestampForPointInTime);  // TODO this should represent TIMESTAMP TIMESTAMP '2019-12-31 23:59:59.999999999999 Europe/Warsaw'", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0ODMyNA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535948324", "bodyText": "because its a copy", "author": "findepi", "createdAt": "2020-12-04T09:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1Nzg5OQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535957899", "bodyText": "fixed", "author": "findepi", "createdAt": "2020-12-04T09:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NDk0Ng==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535944946", "bodyText": "Why not TIMESTAMP_WITH_TIMEZONE? Todo?", "author": "losipiuk", "createdAt": "2020-12-04T09:09:03Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSetTimezone.java", "diffHunk": "@@ -172,6 +175,75 @@ public void testTimestamp(Optional<String> sessionTimezoneId)\n         });\n     }\n \n+    @Test(dataProvider = \"timeZoneIds\")\n+    public void testTimestampWithTimeZone(Optional<String> sessionTimezoneId)\n+            throws Exception\n+    {\n+        checkRepresentation(\n+                \"TIMESTAMP '1970-01-01 00:00:00.000 +00:00'\", // Presto\n+                ImmutableList.of(\n+                        \"TIMESTAMP WITH TIME ZONE '1970-01-01 00:00:00.000 +00:00'\", // PostgreSQL\n+                        \"from_tz(TIMESTAMP '1970-01-01 00:00:00.000', '+00:00')\"), // Oracle\n+                TIMESTAMP,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1Nzk3NA==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r535957974", "bodyText": "fixed", "author": "findepi", "createdAt": "2020-12-04T09:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NDk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NzIyNw==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r536047227", "bodyText": "With this there is another question. Should it still work with TIMESTAMP passed here. If so, should we have test coverage?", "author": "losipiuk", "createdAt": "2020-12-04T11:56:31Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSetTimezone.java", "diffHunk": "@@ -184,7 +185,7 @@ public void testTimestampWithTimeZone(Optional<String> sessionTimezoneId)\n                 ImmutableList.of(\n                         \"TIMESTAMP WITH TIME ZONE '1970-01-01 00:00:00.000 +00:00'\", // PostgreSQL\n                         \"from_tz(TIMESTAMP '1970-01-01 00:00:00.000', '+00:00')\"), // Oracle\n-                TIMESTAMP,\n+                TIMESTAMP_WITH_TIMEZONE,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzcxOQ==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r536057719", "bodyText": "It's just test's internal control flag to select which reference drivers to test against.\nWhether TIMESTAMP or TIMESTAMP_WITH_TIMEZONE -- both PostgreSQL and Oracle are selected for comparison.\nIt has no further meaning.", "author": "findepi", "createdAt": "2020-12-04T12:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NzIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2MzU0Mg==", "url": "https://github.com/trinodb/trino/pull/6152#discussion_r536063542", "bodyText": "#6207", "author": "findepi", "createdAt": "2020-12-04T12:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0NzIyNw=="}], "type": "inlineReview"}, {"oid": "f2200b68117a35503df00a7885b93085301839d7", "url": "https://github.com/trinodb/trino/commit/f2200b68117a35503df00a7885b93085301839d7", "message": "Rephrase TIMESTAMP TZ ResultSet tests in point-in-time semantics", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "a7ee3314eb748cd12d8070d3ff1fd0f1caea6c89", "url": "https://github.com/trinodb/trino/commit/a7ee3314eb748cd12d8070d3ff1fd0f1caea6c89", "message": "Fix formatting", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "4daa57c47bdce16456f2b17c876ecbf069cabff8", "url": "https://github.com/trinodb/trino/commit/4daa57c47bdce16456f2b17c876ecbf069cabff8", "message": "Prepare tested data once", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "e2f8a75123932c19ea33c00aeff1b550728314f7", "url": "https://github.com/trinodb/trino/commit/e2f8a75123932c19ea33c00aeff1b550728314f7", "message": "Improve error reporting when one of test cases fails", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "7ca182922087e05446a77d3e9f099d3fbbf88cfc", "url": "https://github.com/trinodb/trino/commit/7ca182922087e05446a77d3e9f099d3fbbf88cfc", "message": "Test with implicit session zone in TestJdbcResultSetTimezone too", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "2f169d188b8c9b58aa87f1b35f555f7175feaf96", "url": "https://github.com/trinodb/trino/commit/2f169d188b8c9b58aa87f1b35f555f7175feaf96", "message": "Allow different literals for compared databases", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "f20acbc51b568d81fdab8b22689fd7cefb914b67", "url": "https://github.com/trinodb/trino/commit/f20acbc51b568d81fdab8b22689fd7cefb914b67", "message": "Test TIMESTAMP WITH TIME ZONE calendar compatibility", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "6d60366fff919556151087a9fe0d32063a9188dc", "url": "https://github.com/trinodb/trino/commit/6d60366fff919556151087a9fe0d32063a9188dc", "message": "Declare support by default in test reference driver\n\nThis ensures reference driver is used by default, unless it opts out.", "committedDate": "2020-12-04T12:27:29Z", "type": "commit"}, {"oid": "6d60366fff919556151087a9fe0d32063a9188dc", "url": "https://github.com/trinodb/trino/commit/6d60366fff919556151087a9fe0d32063a9188dc", "message": "Declare support by default in test reference driver\n\nThis ensures reference driver is used by default, unless it opts out.", "committedDate": "2020-12-04T12:27:29Z", "type": "forcePushed"}]}