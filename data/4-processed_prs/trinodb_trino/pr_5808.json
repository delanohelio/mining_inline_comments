{"pr_number": 5808, "pr_title": "Upgrade coral to resolve catalog correctly for underlying tables", "pr_createdAt": "2020-11-04T01:01:09Z", "pr_url": "https://github.com/trinodb/trino/pull/5808", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4MzQ5NA==", "url": "https://github.com/trinodb/trino/pull/5808#discussion_r517183494", "bodyText": "we need to use something else that hive catalog name here.", "author": "kokosing", "createdAt": "2020-11-04T08:52:34Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -101,10 +103,15 @@ public void testShowCreateView()\n     {\n         onHive().executeQuery(\"DROP VIEW IF EXISTS hive_show_view\");\n \n-        onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT * FROM nation\");\n+        onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT n_nationkey FROM nation\");\n \n-        // view SQL depends on Hive distribution\n-        assertThat(query(\"SHOW CREATE VIEW hive_show_view\")).hasRowsCount(1);\n+        QueryResult result = query(\"SHOW CREATE VIEW hive_show_view\");\n+\n+        assertThat(result).hasRowsCount(1);\n+        String actualSql = (String) result.row(0).get(0);\n+        assertEquals(\n+                actualSql.replaceAll(\"\\n\", \" \").replaceAll(\"\\\\s+\", \" \"),\n+                \"CREATE VIEW hive.default.hive_show_view AS SELECT \\\"n_nationkey\\\" FROM \\\"default\\\".\\\"nation\\\"\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMzMjQ5OQ==", "url": "https://github.com/trinodb/trino/pull/5808#discussion_r517332499", "bodyText": "In product tests we have few hive catalogs mapped to same metastore.\nSo you can access the Hive view from two of them within single test.", "author": "findepi", "createdAt": "2020-11-04T13:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4MzQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMzMzIyOA==", "url": "https://github.com/trinodb/trino/pull/5808#discussion_r517333228", "bodyText": "what was wrong about *?\ncan we test both cases, with * and with explicit column(s)?\n(nation table has few columns, it doesn't hurt to enumerate all of them)", "author": "findepi", "createdAt": "2020-11-04T13:14:17Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -101,10 +103,15 @@ public void testShowCreateView()\n     {\n         onHive().executeQuery(\"DROP VIEW IF EXISTS hive_show_view\");\n \n-        onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT * FROM nation\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMzMzU2NQ==", "url": "https://github.com/trinodb/trino/pull/5808#discussion_r517333565", "bodyText": "keeping actualSql intact is OK.\nalso, if we used to output nicely formatted result and in the future we stop doing that, i would like the test to tell me so.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            actualSql.replaceAll(\"\\n\", \" \").replaceAll(\"\\\\s+\", \" \"),\n          \n          \n            \n                            actualSql,", "author": "findepi", "createdAt": "2020-11-04T13:14:54Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -101,10 +103,15 @@ public void testShowCreateView()\n     {\n         onHive().executeQuery(\"DROP VIEW IF EXISTS hive_show_view\");\n \n-        onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT * FROM nation\");\n+        onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT n_nationkey FROM nation\");\n \n-        // view SQL depends on Hive distribution\n-        assertThat(query(\"SHOW CREATE VIEW hive_show_view\")).hasRowsCount(1);\n+        QueryResult result = query(\"SHOW CREATE VIEW hive_show_view\");\n+\n+        assertThat(result).hasRowsCount(1);\n+        String actualSql = (String) result.row(0).get(0);\n+        assertEquals(\n+                actualSql.replaceAll(\"\\n\", \" \").replaceAll(\"\\\\s+\", \" \"),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5MDY1Ng==", "url": "https://github.com/trinodb/trino/pull/5808#discussion_r517490656", "bodyText": "Might be worth calling out in the comment that the hive_with_external_writes catalog points to the same HMS instance", "author": "alexjo2144", "createdAt": "2020-11-04T16:55:58Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -100,11 +103,26 @@ public void testExistingView()\n     public void testShowCreateView()\n     {\n         onHive().executeQuery(\"DROP VIEW IF EXISTS hive_show_view\");\n-\n         onHive().executeQuery(\"CREATE VIEW hive_show_view AS SELECT * FROM nation\");\n \n-        // view SQL depends on Hive distribution\n-        assertThat(query(\"SHOW CREATE VIEW hive_show_view\")).hasRowsCount(1);\n+        String showCreateViewSql = \"SHOW CREATE VIEW %s.default.hive_show_view\";\n+        String expectedResult = \"CREATE VIEW %s.default.hive_show_view AS\\n\" +\n+                \"SELECT\\n\" +\n+                \"  \\\"n_nationkey\\\"\\n\" +\n+                \", \\\"n_name\\\"\\n\" +\n+                \", \\\"n_regionkey\\\"\\n\" +\n+                \", \\\"n_comment\\\"\\n\" +\n+                \"FROM\\n\" +\n+                \"  \\\"default\\\".\\\"nation\\\"\";\n+\n+        QueryResult actualResult = query(format(showCreateViewSql, \"hive\"));\n+        assertThat(actualResult).hasRowsCount(1);\n+        assertEquals((String) actualResult.row(0).get(0), format(expectedResult, \"hive\"));\n+\n+        // Validate the translated view sql for a catalog name other than \"hive\"\n+        actualResult = query(format(showCreateViewSql, \"hive_with_external_writes\"));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "a69db62ee7b0812eb312ffc8879f529eb4ebbb9f", "url": "https://github.com/trinodb/trino/commit/a69db62ee7b0812eb312ffc8879f529eb4ebbb9f", "message": "Upgrade coral to resolve catalog correctly for underlying tables\n\nWith the new version, coral does not prepend a catalog name to\nthe tables referenced in the views. Presto resolves them to\nthe view's catalog during analysis.", "committedDate": "2020-11-05T00:36:55Z", "type": "commit"}, {"oid": "a69db62ee7b0812eb312ffc8879f529eb4ebbb9f", "url": "https://github.com/trinodb/trino/commit/a69db62ee7b0812eb312ffc8879f529eb4ebbb9f", "message": "Upgrade coral to resolve catalog correctly for underlying tables\n\nWith the new version, coral does not prepend a catalog name to\nthe tables referenced in the views. Presto resolves them to\nthe view's catalog during analysis.", "committedDate": "2020-11-05T00:36:55Z", "type": "forcePushed"}]}