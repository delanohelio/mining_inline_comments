{"pr_number": 3375, "pr_title": "Add overwrite insert for Hive connector", "pr_createdAt": "2020-04-07T19:48:02Z", "pr_url": "https://github.com/trinodb/trino/pull/3375", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzcxOQ==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405073719", "bodyText": "OVERWRITE should be a string, so:\n    SET SESSION hdfs.insert_existing_partitions_behavior = 'OVERWRITE'", "author": "martint", "createdAt": "2020-04-07T19:55:58Z", "path": "presto-docs/src/main/sphinx/migration/from-hive.rst", "diffHunk": "@@ -132,3 +132,15 @@ Presto query::\n \n     date_diff('day', startdate, enddate)\n \n+Overwriting data on insert\n+--------------------------\n+\n+By default, ``INSERT`` queries are not allowed to overwrite existing data. You\n+can use the catalog session property ``insert_existing_partitions_behavior`` to\n+allow overwrites. Prepend the name of the catalog using the Hive connector,\n+e.g.g ``hdfs``, and set the property in the session before you run the insert\n+query::\n+\n+    SET SESSION hdfs.insert_existing_partitions_behavior = OVERWRITE", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3Nzk0OA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405077948", "bodyText": "Fixed", "author": "mosabua", "createdAt": "2020-04-07T20:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzgyOQ==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405073829", "bodyText": "Extra .g", "author": "martint", "createdAt": "2020-04-07T19:56:08Z", "path": "presto-docs/src/main/sphinx/migration/from-hive.rst", "diffHunk": "@@ -132,3 +132,15 @@ Presto query::\n \n     date_diff('day', startdate, enddate)\n \n+Overwriting data on insert\n+--------------------------\n+\n+By default, ``INSERT`` queries are not allowed to overwrite existing data. You\n+can use the catalog session property ``insert_existing_partitions_behavior`` to\n+allow overwrites. Prepend the name of the catalog using the Hive connector,\n+e.g.g ``hdfs``, and set the property in the session before you run the insert", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NDIxNA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405074214", "bodyText": "Why is hdfs used as an example name instead of hive?", "author": "martint", "createdAt": "2020-04-07T19:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NzI1Nw==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405077257", "bodyText": "imho it is misleading to use the name of the connector for the catalog name .. so I avoid that confusion whenever possible ..", "author": "mosabua", "createdAt": "2020-04-07T20:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3ODkwMg==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405078902", "bodyText": "Agreed. But hdfs is also a little misleading as it's too tied to the underlying technology and may make people think this is for hdfs only.", "author": "martint", "createdAt": "2020-04-07T20:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405075679", "bodyText": "There's another mode that's allowed: APPEND. We may want to document that, too, here or as a separate change.", "author": "martint", "createdAt": "2020-04-07T19:59:12Z", "path": "presto-docs/src/main/sphinx/migration/from-hive.rst", "diffHunk": "@@ -132,3 +132,15 @@ Presto query::\n \n     date_diff('day', startdate, enddate)\n \n+Overwriting data on insert\n+--------------------------\n+\n+By default, ``INSERT`` queries are not allowed to overwrite existing data. You\n+can use the catalog session property ``insert_existing_partitions_behavior`` to\n+allow overwrites. Prepend the name of the catalog using the Hive connector,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NzkyNg==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405077926", "bodyText": "Also, I think that the overwrite mode support is not available for s3 backed tables - since there is no concept of stage-and-move to target directory. We could also add that in the documentation.", "author": "rohangarg", "createdAt": "2020-04-07T20:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3ODY0Mg==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405078642", "bodyText": "I would like to link to the docs for that session property but still looking for a place to put that and then link to it. Do you think I should document it all here (ERROR as default, APPEND..) ?", "author": "mosabua", "createdAt": "2020-04-07T20:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3OTQwMg==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405079402", "bodyText": "Good to know .. I can add all that .. but probably not here in the migration docs but somewhere in the hive connector docs ... but where? Should I start a separate section about inserting data ? Or session properties? or add it to an existing section..", "author": "mosabua", "createdAt": "2020-04-07T20:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MjA0Ng==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405082046", "bodyText": "Yeah, it makes sense to add it to the Hive connector docs. We don't have a section with the list of session properties, so maybe a dedicate section about insert behavior would be way to go. @electrum, do you have any thoughts?", "author": "martint", "createdAt": "2020-04-07T20:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDU4MA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r405084580", "bodyText": "If I add it as insert behaviour section to the hive docs the migration section can be shorter and mostly point there.", "author": "mosabua", "createdAt": "2020-04-07T20:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEwNzA0MA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r416107040", "bodyText": "Can you please chime in here @electrum to decide what direction we should take this.", "author": "mosabua", "createdAt": "2020-04-27T19:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDc4Ng==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r417510786", "bodyText": "equivalent to hive insert overwrite", "author": "mosabua", "createdAt": "2020-04-29T18:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMTE0MA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r417511140", "bodyText": "We should mention this is equivalent to Hive's INSERT OVERWRITE syntax (documented at https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML)", "author": "electrum", "createdAt": "2020-04-29T18:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIzMjI4OA==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r420232288", "bodyText": "Added as agreed.", "author": "mosabua", "createdAt": "2020-05-05T16:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NTY3OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2MDUxNg==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r421760516", "bodyText": "Missing \"to\" after \"equivalent\"", "author": "electrum", "createdAt": "2020-05-07T20:02:12Z", "path": "presto-docs/src/main/sphinx/migration/from-hive.rst", "diffHunk": "@@ -132,3 +132,17 @@ Presto query::\n \n     date_diff('day', startdate, enddate)\n \n+Overwriting data on insert\n+--------------------------\n+\n+By default, ``INSERT`` queries are not allowed to overwrite existing data. You\n+can use the catalog session property ``insert_existing_partitions_behavior`` to\n+allow overwrites. Prepend the name of the catalog using the Hive connector, for\n+example ``hdfs``, and set the property in the session before you run the insert\n+query::\n+\n+    SET SESSION hdfs.insert_existing_partitions_behavior = 'OVERWRITE';\n+    INSERT INTO hdfs.schema.table ...\n+\n+The resulting behavior is equivalent using `INSERT OVERWRITE", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2NjUyNQ==", "url": "https://github.com/trinodb/trino/pull/3375#discussion_r421766525", "bodyText": "Fixed", "author": "mosabua", "createdAt": "2020-05-07T20:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2MDUxNg=="}], "type": "inlineReview"}, {"oid": "8b5740fc01f04e2c53da71c273525dca48fa89eb", "url": "https://github.com/trinodb/trino/commit/8b5740fc01f04e2c53da71c273525dca48fa89eb", "message": "Add overwrite insert for Hive connector", "committedDate": "2020-05-07T20:13:49Z", "type": "commit"}, {"oid": "8b5740fc01f04e2c53da71c273525dca48fa89eb", "url": "https://github.com/trinodb/trino/commit/8b5740fc01f04e2c53da71c273525dca48fa89eb", "message": "Add overwrite insert for Hive connector", "committedDate": "2020-05-07T20:13:49Z", "type": "forcePushed"}]}