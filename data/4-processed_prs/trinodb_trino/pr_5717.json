{"pr_number": 5717, "pr_title": "Add ALTER TABLE SET AUTHORIZATION", "pr_createdAt": "2020-10-28T08:46:46Z", "pr_url": "https://github.com/trinodb/trino/pull/5717", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4NTM3OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513285379", "bodyText": "invalidateTable, please add a test to TestCachingHiveMetastore", "author": "kokosing", "createdAt": "2020-10-28T09:13:58Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -493,6 +493,18 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         }\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)\n+    {\n+        identity = updateIdentity(identity);\n+        try {\n+            delegate.setTableOwner(identity, databaseName, tableName, principal);\n+        }\n+        finally {\n+            invalidateDatabase(databaseName);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4OTA5Nw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513289097", "bodyText": "Is this a Hive behavior? What about being an owner of a schema that contains that table, would that allow to change the owner of table?", "author": "kokosing", "createdAt": "2020-10-28T09:19:48Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/security/SqlStandardAccessControl.java", "diffHunk": "@@ -263,6 +264,14 @@ public void checkCanRenameColumn(ConnectorSecurityContext context, SchemaTableNa\n         }\n     }\n \n+    @Override\n+    public void checkCanSetTableAuthorization(ConnectorSecurityContext context, SchemaTableName tableName, PrestoPrincipal principal)\n+    {\n+        if (!isTableOwner(context, tableName)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MjQ1OA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513342458", "bodyText": "The ALTER TABLE SET AUTHORIZATION syntax is not a part of SQL and not a part of Hive. The only way to change table's owner is via metastore", "author": "skrzypo987", "createdAt": "2020-10-28T10:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4OTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1OTYyNQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513359625", "bodyText": "@dain @electrum What do you think about this?", "author": "kokosing", "createdAt": "2020-10-28T11:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4OTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMzg3Nw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515033877", "bodyText": "I thought about it, and I think it is ok.", "author": "kokosing", "createdAt": "2020-10-30T11:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4OTA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDA5Mg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513290092", "bodyText": "Why do you need principal?", "author": "kokosing", "createdAt": "2020-10-28T09:21:19Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,42 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").withPrincipal(getSession().getIdentity().getPrincipal()).build())", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0NDkzNw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513344937", "bodyText": "Wrong copy paste I guess", "author": "skrzypo987", "createdAt": "2020-10-28T10:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDI3MA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513290270", "bodyText": "separate test?", "author": "kokosing", "createdAt": "2020-10-28T09:21:38Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,42 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        Session bob = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"bob\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_table_authorization\");\n+        assertUpdate(admin, \"CREATE ROLE admin\");\n+\n+        assertUpdate(admin, \"CREATE TABLE test_table_authorization.foo (col int)\");\n+        assertUpdate(admin, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\");\n+        assertQueryFails(bob,\n+                \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\",\n+                \"Access Denied: Cannot set authorization for table test_table_authorization.foo to USER alice\");\n+        assertUpdate(alice, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION bob\");\n+\n+        // TODO Will succeed after https://github.com/prestosql/presto/issues/5706\n+        assertQueryFails(bob, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION ROLE admin\", \"Setting table owner type as a role is not supported\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MTEwMg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513291102", "bodyText": "assertAccessDenied? Then you don't need two users.\nPlease put bob to separate line", "author": "kokosing", "createdAt": "2020-10-28T09:22:58Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,42 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        Session bob = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"bob\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_table_authorization\");\n+        assertUpdate(admin, \"CREATE ROLE admin\");\n+\n+        assertUpdate(admin, \"CREATE TABLE test_table_authorization.foo (col int)\");\n+        assertUpdate(admin, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\");\n+        assertQueryFails(bob,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MzA0OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513293049", "bodyText": "Now it would be nice to have SHOW CREATE TABLE to return information who is the owner. Then we could use it for tests.\nActually, having CREATE TABLE (...) WITH AUTHORIZATION 'bob' would be a good feature. No need to do two calls CREATE and ALTER. Same for SCHEMA. Let's capture this as github issue, for further discussion.", "author": "kokosing", "createdAt": "2020-10-28T09:25:55Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,42 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        Session bob = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"bob\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_table_authorization\");\n+        assertUpdate(admin, \"CREATE ROLE admin\");\n+\n+        assertUpdate(admin, \"CREATE TABLE test_table_authorization.foo (col int)\");\n+        assertUpdate(admin, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\");\n+        assertQueryFails(bob,\n+                \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\",\n+                \"Access Denied: Cannot set authorization for table test_table_authorization.foo to USER alice\");\n+        assertUpdate(alice, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION bob\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MjA3Nw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513352077", "bodyText": "This is the next thing to do. Captured as #5722", "author": "skrzypo987", "createdAt": "2020-10-28T10:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MzA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5Mzg3OA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513293878", "bodyText": "Why alice is allowed, but bob not?", "author": "kokosing", "createdAt": "2020-10-28T09:27:12Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,42 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        Session bob = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"bob\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_table_authorization\");\n+        assertUpdate(admin, \"CREATE ROLE admin\");\n+\n+        assertUpdate(admin, \"CREATE TABLE test_table_authorization.foo (col int)\");\n+        assertUpdate(admin, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\");\n+        assertQueryFails(bob,\n+                \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\",\n+                \"Access Denied: Cannot set authorization for table test_table_authorization.foo to USER alice\");\n+        assertUpdate(alice, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION bob\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MjUxOQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513352519", "bodyText": "alice has been granted ownership earlier. But I will rewrite that test anyway", "author": "skrzypo987", "createdAt": "2020-10-28T10:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5Mzg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5NDcyMg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513294722", "bodyText": "check it before table existance", "author": "kokosing", "createdAt": "2020-10-28T09:28:33Z", "path": "presto-main/src/main/java/io/prestosql/execution/SetTableAuthorizationTask.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.util.concurrent.ListenableFuture;\n+import io.prestosql.Session;\n+import io.prestosql.connector.CatalogName;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.metadata.QualifiedObjectName;\n+import io.prestosql.security.AccessControl;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.security.PrestoPrincipal;\n+import io.prestosql.spi.security.PrincipalType;\n+import io.prestosql.sql.tree.Expression;\n+import io.prestosql.sql.tree.SetTableAuthorization;\n+import io.prestosql.transaction.TransactionManager;\n+\n+import java.util.List;\n+\n+import static com.google.common.util.concurrent.Futures.immediateFuture;\n+import static io.prestosql.metadata.MetadataUtil.createPrincipal;\n+import static io.prestosql.metadata.MetadataUtil.createQualifiedObjectName;\n+import static io.prestosql.spi.StandardErrorCode.NOT_FOUND;\n+import static io.prestosql.spi.StandardErrorCode.ROLE_NOT_FOUND;\n+import static io.prestosql.spi.StandardErrorCode.TABLE_NOT_FOUND;\n+import static io.prestosql.sql.analyzer.SemanticExceptions.semanticException;\n+\n+public class SetTableAuthorizationTask\n+        implements DataDefinitionTask<SetTableAuthorization>\n+{\n+    @Override\n+    public String getName()\n+    {\n+        return \"SET TABLE AUTHORIZATION\";\n+    }\n+\n+    @Override\n+    public ListenableFuture<?> execute(SetTableAuthorization statement, TransactionManager transactionManager, Metadata metadata, AccessControl accessControl, QueryStateMachine stateMachine, List<Expression> parameters)\n+    {\n+        Session session = stateMachine.getSession();\n+        QualifiedObjectName tableName = createQualifiedObjectName(session, statement, statement.getSource());\n+        metadata.getTableHandle(session, tableName)\n+                .orElseThrow(() -> semanticException(TABLE_NOT_FOUND, statement, \"Table '%s' does not exist\", tableName));\n+\n+        CatalogName catalogName = metadata.getCatalogHandle(session, tableName.getCatalogName())\n+                .orElseThrow(() -> new PrestoException(NOT_FOUND, \"Catalog does not exist: \" + tableName.getCatalogName()));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5NTQ5NQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513295495", "bodyText": "Set the authorization (owner) of specified table's user/role", "author": "kokosing", "createdAt": "2020-10-28T09:29:40Z", "path": "presto-main/src/main/java/io/prestosql/metadata/Metadata.java", "diffHunk": "@@ -199,6 +200,11 @@\n      */\n     void addColumn(Session session, TableHandle tableHandle, ColumnMetadata column);\n \n+    /**\n+     * Set the specified table's user/role.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5NzE1OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513297159", "bodyText": "@martint Can you please double check the syntax?", "author": "kokosing", "createdAt": "2020-10-28T09:32:12Z", "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -64,6 +64,7 @@ statement\n         DROP COLUMN (IF EXISTS)? column=qualifiedName                  #dropColumn\n     | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n         ADD COLUMN (IF NOT EXISTS)? column=columnDefinition            #addColumn\n+    | ALTER TABLE tableName=qualifiedName SET AUTHORIZATION principal  #setTableAuthorization", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5ODU0Mw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r513298543", "bodyText": "Please add test to io.prestosql.sql.parser.TestSqlParser", "author": "kokosing", "createdAt": "2020-10-28T09:34:18Z", "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -64,6 +64,7 @@ statement\n         DROP COLUMN (IF EXISTS)? column=qualifiedName                  #dropColumn\n     | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n         ADD COLUMN (IF NOT EXISTS)? column=columnDefinition            #addColumn\n+    | ALTER TABLE tableName=qualifiedName SET AUTHORIZATION principal  #setTableAuthorization", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyOTg2OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515029869", "bodyText": "Allow everyone with role public to drop and alter table ``people``::\nNot everyone might have role public. I guess it is a case in Hive, but it might not be somewhere else.", "author": "kokosing", "createdAt": "2020-10-30T11:25:03Z", "path": "presto-docs/src/main/sphinx/sql/alter-table.rst", "diffHunk": "@@ -60,6 +61,14 @@ Rename column ``id`` to ``user_id`` in the ``users`` table if table ``users`` an\n \n     ALTER TABLE IF EXISTS users RENAME column IF EXISTS id to user_id;\n \n+Change owner of table ``people`` to user ``alice``::\n+\n+    ALTER TABLE people SET AUTHORIZATION alice\n+\n+Allow everyone to drop and alter table ``people``::", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMDY0NA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515030644", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:26:28Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/HiveMetastore.java", "diffHunk": "@@ -66,6 +66,8 @@\n \n     void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePrincipal principal);\n \n+    void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMDc1NA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515030754", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:26:42Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/RecordingHiveMetastore.java", "diffHunk": "@@ -308,6 +308,13 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         delegate.setDatabaseOwner(identity, databaseName, principal);\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMDg1Ng==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515030856", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:26:51Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/SemiTransactionalHiveMetastore.java", "diffHunk": "@@ -360,6 +360,11 @@ public synchronized void setDatabaseOwner(HiveIdentity identity, String source,\n         setExclusive((delegate, hdfsEnvironment) -> delegate.setDatabaseOwner(identity, source, principal));\n     }\n \n+    public synchronized void setTableOwner(HiveIdentity identity, String schema, String table, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMDkxMQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515030911", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:26:57Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/alluxio/AlluxioHiveMetastore.java", "diffHunk": "@@ -277,6 +277,12 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         throw new PrestoException(NOT_SUPPORTED, \"setDatabaseOwner\");\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTQwMw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515031403", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:27:54Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -493,6 +493,18 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         }\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTU0Nw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515031547", "bodyText": "please move it under all table methods", "author": "kokosing", "createdAt": "2020-10-30T11:28:12Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -238,6 +238,23 @@ public synchronized void setDatabaseOwner(HiveIdentity identity, String database\n         writeSchemaFile(\"database\", databaseMetadataDirectory, databaseCodec, new DatabaseMetadata(newDatabase), true);\n     }\n \n+    @Override\n+    public synchronized void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTc1NA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515031754", "bodyText": "How can we have a test for that?", "author": "kokosing", "createdAt": "2020-10-30T11:28:35Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -536,6 +536,33 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         throw new PrestoException(NOT_SUPPORTED, \"setting the database owner is not supported by Glue\");\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NzY2OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515087669", "bodyText": "I made one in AbstractHiveTest. We'll see if it passes the CI", "author": "skrzypo987", "createdAt": "2020-10-30T13:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjQ3OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515952479", "bodyText": "Nope, does not work.", "author": "skrzypo987", "createdAt": "2020-11-02T12:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMTkwMg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515031902", "bodyText": "same, move below table methods, please do the same for other methods as well.", "author": "kokosing", "createdAt": "2020-10-30T11:28:53Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/BridgingHiveMetastore.java", "diffHunk": "@@ -198,6 +199,24 @@ public void setDatabaseOwner(HiveIdentity identity, String databaseName, HivePri\n         delegate.alterDatabase(identity, databaseName, toMetastoreApiDatabase(newDatabase));\n     }\n \n+    @Override\n+    public void setTableOwner(HiveIdentity identity, String databaseName, String tableName, HivePrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzMzczOQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515033739", "bodyText": "Please add a product tests for that (as we don't have unit tests for sql-standard yet).", "author": "kokosing", "createdAt": "2020-10-30T11:32:17Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/security/SqlStandardAccessControl.java", "diffHunk": "@@ -263,6 +264,14 @@ public void checkCanRenameColumn(ConnectorSecurityContext context, SchemaTableNa\n         }\n     }\n \n+    @Override\n+    public void checkCanSetTableAuthorization(ConnectorSecurityContext context, SchemaTableName tableName, PrestoPrincipal principal)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNDgwOQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515034809", "bodyText": "Can you please enable it, move TODO to the test body, that way we will test that it fails the way it should", "author": "kokosing", "createdAt": "2020-10-30T11:34:23Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -771,6 +771,63 @@ public void testSchemaAuthorization()\n         assertUpdate(admin, \"DROP ROLE admin\");\n     }\n \n+    @Test\n+    public void testTableAuthorization()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"hive\").withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\"))).build())\n+                .build();\n+\n+        Session alice = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setIdentity(Identity.forUser(\"alice\").build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_table_authorization\");\n+        assertUpdate(admin, \"CREATE TABLE test_table_authorization.foo (col int)\");\n+\n+        assertAccessDenied(\n+                alice,\n+                \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\",\n+                \"Cannot set authorization for table test_table_authorization.foo to USER alice\");\n+        assertUpdate(admin, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION alice\");\n+        assertUpdate(alice, \"ALTER TABLE test_table_authorization.foo SET AUTHORIZATION admin\");\n+\n+        assertUpdate(admin, \"DROP TABLE test_table_authorization.foo\");\n+        assertUpdate(admin, \"DROP SCHEMA test_table_authorization\");\n+    }\n+\n+    // TODO https://github.com/prestosql/presto/issues/5706\n+    @Test(enabled = false)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjI3Mg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515036272", "bodyText": "s/qux/testing_user\ns/foo.bar.baz/tesing_catalog.testing_schema.testing_table", "author": "kokosing", "createdAt": "2020-10-30T11:37:08Z", "path": "presto-parser/src/test/java/io/prestosql/sql/parser/TestSqlParser.java", "diffHunk": "@@ -1626,6 +1630,20 @@ public void testDropColumn()\n         assertStatement(\"ALTER TABLE IF EXISTS foo.t DROP COLUMN IF EXISTS c\", new DropColumn(QualifiedName.of(\"foo\", \"t\"), identifier(\"c\"), true, true));\n     }\n \n+    @Test\n+    public void testAlterTableSetAuthorization()\n+    {\n+        assertStatement(\n+                \"ALTER TABLE foo.bar.baz SET AUTHORIZATION qux\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NzYyNg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r515087626", "bodyText": "The whole class is filled with foos and bars. Using something else here will be inconsistent.", "author": "skrzypo987", "createdAt": "2020-10-30T13:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc1NTY0OQ==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r516755649", "bodyText": "maybe it's better to not add to this foo.bar.baz habbit then?", "author": "s2lomon", "createdAt": "2020-11-03T15:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE5NzMyNw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r517197327", "bodyText": "I highly disagree. Holding a bad (in your opinion) convention is better than breaking it.", "author": "skrzypo987", "createdAt": "2020-11-04T09:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjI3Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "e99df2ab74dbc774e56baccf86f753d01b523099", "url": "https://github.com/trinodb/trino/commit/e99df2ab74dbc774e56baccf86f753d01b523099", "message": "Extract variable", "committedDate": "2020-10-30T13:16:06Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc1ODYyMw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r516758623", "bodyText": "I wonder whether it wouldn't be better to have 3 tests here... with proper names of the test cases that they are checking.", "author": "s2lomon", "createdAt": "2020-11-03T15:35:44Z", "path": "presto-plugin-toolkit/src/test/java/io/prestosql/plugin/base/security/TestFileBasedSystemAccessControl.java", "diffHunk": "@@ -487,6 +488,19 @@ public void testTableRulesForCheckCanRenameColumn()\n         assertAccessDenied(() -> accessControl.checkCanRenameColumn(BOB, new CatalogSchemaTableName(\"some-catalog\", \"bobschema\", \"bobtable\")), RENAME_COLUMNS_ACCESS_DENIED_MESSAGE);\n     }\n \n+    @Test\n+    public void testTableRulesForCheckCanSetTableAuthorization()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIwMTMyOA==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r517201328", "bodyText": "The test is made according to how the class is written.\ntestTableRules means we are testing multiple rules. Is it TDD or any other testing acronym compliant - probably not. Just like the whole Presto", "author": "skrzypo987", "createdAt": "2020-11-04T09:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc1ODYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc1OTgyMg==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r516759822", "bodyText": "I'm not sure I understand the case of this test. Maybe a better name would make it clearer? What kind of scenario is it?", "author": "s2lomon", "createdAt": "2020-11-03T15:37:19Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSqlStandardAccessControlChecks.java", "diffHunk": "@@ -212,6 +212,15 @@ public void testAccessControlSelectWithCaseSensitiveUserName()\n         assertThat(caseSensitiveUserNameExecutor.executeQuery(format(\"SELECT * FROM %s\", viewName))).hasNoRows();\n     }\n \n+    @Test(groups = {AUTHORIZATION, PROFILE_SPECIFIC_TESTS})\n+    public void testAccessControlSetTableAuthorization()\n+    {\n+        assertThat(() -> bobExecutor.executeQuery(format(\"ALTER TABLE %s SET AUTHORIZATION bob\", tableName)))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIwMzc5Mw==", "url": "https://github.com/trinodb/trino/pull/5717#discussion_r517203793", "bodyText": "It's a simple smoke test of whether only an owner can set table authorization.\nIt checks the checkCanSetTableAuthorization method in SqlStandardAccessControl.\nAgain this is compliant with the rest of this class as of naming.", "author": "skrzypo987", "createdAt": "2020-11-04T09:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc1OTgyMg=="}], "type": "inlineReview"}, {"oid": "b0986ae8c9ec5f8e5fadea8a6aecdd0541418426", "url": "https://github.com/trinodb/trino/commit/b0986ae8c9ec5f8e5fadea8a6aecdd0541418426", "message": "Add support for ALTER TABLE SET AUTHORIZATION", "committedDate": "2020-11-04T10:32:53Z", "type": "commit"}, {"oid": "b0986ae8c9ec5f8e5fadea8a6aecdd0541418426", "url": "https://github.com/trinodb/trino/commit/b0986ae8c9ec5f8e5fadea8a6aecdd0541418426", "message": "Add support for ALTER TABLE SET AUTHORIZATION", "committedDate": "2020-11-04T10:32:53Z", "type": "forcePushed"}]}