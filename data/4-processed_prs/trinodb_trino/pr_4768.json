{"pr_number": 4768, "pr_title": "Add missing invalidate calls to CachingHiveMetastore + Fix REVOKE in FileHiveMetastore", "pr_createdAt": "2020-08-10T15:00:44Z", "pr_url": "https://github.com/trinodb/trino/pull/4768", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjQ2NA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468202464", "bodyText": "CachingHiveMetastore didn't work correctly with GRANT/REVOKE\n\nInstead of saying what was broken, please describe how it got improved. I would say:\nRespect GRANT and REVOKE CachingHiveMetastore", "author": "kokosing", "createdAt": "2020-08-10T21:42:23Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1MzcyMQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468353721", "bodyText": "will split into 3 commits a moment before merge, doing this on every fix is clumsy", "author": "iirekm", "createdAt": "2020-08-11T06:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEwOTYxNw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472109617", "bodyText": "splitted into 2 commits", "author": "iirekm", "createdAt": "2020-08-18T11:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjczNA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468202734", "bodyText": "extend io.prestosql.testing.AbstractTestQueryFramework", "author": "kokosing", "createdAt": "2020-08-10T21:43:09Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1Mzk2Nw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468353967", "bodyText": "I don't need any functionality from this base class\nalso as we discussed internally, reusing test code via inheritance does more harm than good", "author": "iirekm", "createdAt": "2020-08-11T06:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5MjcyNA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471492724", "bodyText": "Just FYI there is io.prestosql.sql.query.QueryAssertions", "author": "kokosing", "createdAt": "2020-08-17T13:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEwNTEwMA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472105100", "bodyText": "I just need to know if query passes or fails in this test, so no assertion utility class is needed for me, just regular method calls", "author": "iirekm", "createdAt": "2020-08-18T11:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjg3OA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468202878", "bodyText": "AfterMethod(alwaysRun =true)", "author": "kokosing", "createdAt": "2020-08-10T21:43:31Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", Map.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1NTM5MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468355390", "bodyText": "forgot\nthis is another reason why JUnit 5 is better, their @After method don't have such distinctions", "author": "iirekm", "createdAt": "2020-08-11T06:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMjg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzM1Nw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468203357", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n          \n          \n            \n                        .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n          \n          \n            \n                private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n          \n          \n            \n                        .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n          \n          \n            \n                        .build());", "author": "kokosing", "createdAt": "2020-08-10T21:44:39Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzU2MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468203561", "bodyText": "ImmutableMap", "author": "kokosing", "createdAt": "2020-08-10T21:45:02Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", Map.of(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzk3OQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468203979", "bodyText": "Please fix file based metastore in separate commit", "author": "kokosing", "createdAt": "2020-08-10T21:46:06Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -1054,9 +1056,11 @@ public synchronized void grantTablePrivileges(String databaseName, String tableN\n     public synchronized void revokeTablePrivileges(String databaseName, String tableName, String tableOwner, HivePrincipal grantee, Set<HivePrivilegeInfo> privileges)\n     {\n         Set<HivePrivilegeInfo> currentPrivileges = listTablePrivileges(databaseName, tableName, tableOwner, Optional.of(grantee));\n-        currentPrivileges.removeAll(privileges);\n+        Set<HivePrivilegeInfo> privilegesToRemove = privileges.stream()\n+                .map(p -> new HivePrivilegeInfo(p.getHivePrivilege(), p.isGrantOption(), p.getGrantor(), grantee))\n+                .collect(toUnmodifiableSet());\n \n-        setTablePrivileges(grantee, databaseName, tableName, currentPrivileges);\n+        setTablePrivileges(grantee, databaseName, tableName, Sets.difference(currentPrivileges, privilegesToRemove));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1MzQzMQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468353431", "bodyText": "will split into 3 commits a moment before merge, doing this on every fix is clumsy", "author": "iirekm", "createdAt": "2020-08-11T06:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5MTc0Mw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471491743", "bodyText": "will split into 3 commits a moment before merge\n\nA person who merge and so accepts the code has to see the code in a form it is going to be merged.\nAnyway, I think it could stay as it is now. Single commit is not perfect here, but it is good enough.", "author": "kokosing", "createdAt": "2020-08-17T13:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExOTgxNg==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472119816", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMzk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDM0OQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468204349", "bodyText": "This does not look like related to GRANT/REVOKE. Please extract this as separate commit.", "author": "kokosing", "createdAt": "2020-08-10T21:47:00Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -250,6 +250,7 @@ public void flushCache()\n         tableStatisticsCache.invalidateAll();\n         partitionStatisticsCache.invalidateAll();\n         rolesCache.invalidateAll();\n+        roleGrantsCache.invalidateAll();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1MzYwNw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468353607", "bodyText": "will split into 3 commits a moment before merge, doing this on every fix is clumsy", "author": "iirekm", "createdAt": "2020-08-11T06:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1ODE4NQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468358185", "bodyText": "And what about: grantedPrincipalsCache (my bad), and grantedPrincipalsCache?", "author": "lhofhansl", "createdAt": "2020-08-11T06:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3NTMwMQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r469075301", "bodyText": "in fact 4 caches weren't cleaned here :-(\nI added cleaning in a loop to solve this once and for all", "author": "iirekm", "createdAt": "2020-08-12T07:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468204461", "bodyText": "what about grant and revoke for roles?", "author": "kokosing", "createdAt": "2020-08-10T21:47:15Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -888,6 +890,7 @@ public void revokeTablePrivileges(String databaseName, String tableName, String\n         }\n         finally {\n             tablePrivilegesCache.invalidate(new UserTableKey(Optional.of(grantee), databaseName, tableName, tableOwner));\n+            tablePrivilegesCache.invalidate(new UserTableKey(Optional.empty(), databaseName, tableName, tableOwner));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1MzU0NA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468353544", "bodyText": "works, see the test", "author": "iirekm", "createdAt": "2020-08-11T06:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1OTg0MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468359841", "bodyText": "This seems to be the crux of the change. It would be cool @iirekm, if that could be explained in the description - so we do not have guess from the code what the goal is :)", "author": "lhofhansl", "createdAt": "2020-08-11T06:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2MzE0NQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468363145", "bodyText": "what you mean by \"explained in description\" - a comment?\nthe reason of this strange bahavior is that sometimes cache.get is called Optional.of(grantee), sometimes with Optional.empty(), for me this is a bigger issue for another task to simplify and refactory this code", "author": "iirekm", "createdAt": "2020-08-11T06:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyNjUxMw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r469026513", "bodyText": "Thanks.\nI meant to update the description of this PR with what you just said. But this comment explains it too.\nStrange, though, what does a get without a specific grantee even mean?", "author": "lhofhansl", "createdAt": "2020-08-12T06:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ4ODIyMQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471488221", "bodyText": "listTablePrivileges is called with Optional.empty() for principal when we want to access all privileges. It is set when when we want to access specific user privileges.\nI think adding a comment to code could be nice here.", "author": "kokosing", "createdAt": "2020-08-17T13:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExOTY5Ng==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472119696", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNDQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNTYwNg==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468205606", "bodyText": "It is strange that you GRANT something that is created in test (line 112).", "author": "kokosing", "createdAt": "2020-08-10T21:49:54Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", Map.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();\n+    }\n+\n+    static Session getTestSession(Identity identity)\n+    {\n+        return testSessionBuilder()\n+                .setCatalog(CATALOG)\n+                .setSchema(SCHEMA)\n+                .setIdentity(identity)\n+                .build();\n+    }\n+\n+    @Test\n+    public void testCacheRefreshOnGrantAndRevoke()\n+    {\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+        queryRunner.execute(\"GRANT SELECT ON test TO \" + ALICE_NAME);\n+        queryRunner.execute(ALICE, \"SELECT * FROM test\");\n+        queryRunner.execute(\"REVOKE SELECT ON test FROM \" + ALICE_NAME);\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+    }\n+\n+    @DataProvider\n+    private Object[][] testCacheRefreshOnRoleGrantAndRevokeParams()\n+    {\n+        String grantSelectStatement = \"GRANT SELECT ON test TO ROLE test_role\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExNTAzNA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472115034", "bodyText": "test table is created in @BeforeMethod, so it's quite reasonable\nalso I wouldn't be surprised if an implementation of \"GRANT\" would rely not on particular object but on object name, in that case it could even work before creating table", "author": "iirekm", "createdAt": "2020-08-18T11:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNTYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNjAxOA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468206018", "bodyText": "I would test GRANT table privileges and GRANT role independently. Now it is not known what caused cache to flush. We need to make sure that cache is flushed properly for any of these.", "author": "kokosing", "createdAt": "2020-08-10T21:50:44Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", Map.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();\n+    }\n+\n+    static Session getTestSession(Identity identity)\n+    {\n+        return testSessionBuilder()\n+                .setCatalog(CATALOG)\n+                .setSchema(SCHEMA)\n+                .setIdentity(identity)\n+                .build();\n+    }\n+\n+    @Test\n+    public void testCacheRefreshOnGrantAndRevoke()\n+    {\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+        queryRunner.execute(\"GRANT SELECT ON test TO \" + ALICE_NAME);\n+        queryRunner.execute(ALICE, \"SELECT * FROM test\");\n+        queryRunner.execute(\"REVOKE SELECT ON test FROM \" + ALICE_NAME);\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+    }\n+\n+    @DataProvider\n+    private Object[][] testCacheRefreshOnRoleGrantAndRevokeParams()\n+    {\n+        String grantSelectStatement = \"GRANT SELECT ON test TO ROLE test_role\";\n+        String grantRoleStatement = \"GRANT test_role TO \" + ALICE_NAME;\n+        List<List<String>> grantRoleStatements = ImmutableList.of(\n+                ImmutableList.of(grantSelectStatement, grantRoleStatement),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1ODIwMQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468358201", "bodyText": "why independently? those two steps are necessary for user to get privileges, they must be together; and for GRANT SELEC ON ... to user is separate test", "author": "iirekm", "createdAt": "2020-08-11T06:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNjAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNjE0Mw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468206143", "bodyText": "Let's define data provider under the usage.", "author": "kokosing", "createdAt": "2020-08-10T21:51:02Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(new Identity.Builder(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\"))).build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", Map.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();\n+    }\n+\n+    static Session getTestSession(Identity identity)\n+    {\n+        return testSessionBuilder()\n+                .setCatalog(CATALOG)\n+                .setSchema(SCHEMA)\n+                .setIdentity(identity)\n+                .build();\n+    }\n+\n+    @Test\n+    public void testCacheRefreshOnGrantAndRevoke()\n+    {\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+        queryRunner.execute(\"GRANT SELECT ON test TO \" + ALICE_NAME);\n+        queryRunner.execute(ALICE, \"SELECT * FROM test\");\n+        queryRunner.execute(\"REVOKE SELECT ON test FROM \" + ALICE_NAME);\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+    }\n+\n+    @DataProvider", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjk0MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468626940", "bodyText": "I don\u2019t see why we need to duplicate the list of caches just to invalidate them. The old code seems fine. This change is unrelated to fixing grant/revoke, so please make a separate PR and we can discuss it independently.", "author": "electrum", "createdAt": "2020-08-11T14:30:43Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -218,38 +230,33 @@ public PartitionStatistics load(WithIdentity<HivePartitionName> key)\n                         return loadPartitionsByNames(partitionNames);\n                     }\n                 }, executor));\n+        caches.add(partitionCache);\n \n         tablePrivilegesCache = newCacheBuilder(expiresAfterWriteMillis, refreshMills, maximumSize, statsRecording)\n                 .build(asyncReloading(CacheLoader.from(key -> loadTablePrivileges(key.getDatabase(), key.getTable(), key.getOwner(), key.getPrincipal())), executor));\n+        caches.add(tablePrivilegesCache);\n \n         rolesCache = newCacheBuilder(expiresAfterWriteMillis, refreshMills, maximumSize, statsRecording)\n                 .build(asyncReloading(CacheLoader.from(this::loadRoles), executor));\n+        caches.add(rolesCache);\n \n         roleGrantsCache = newCacheBuilder(expiresAfterWriteMillis, refreshMills, maximumSize, statsRecording)\n                 .build(asyncReloading(CacheLoader.from(this::loadRoleGrants), executor));\n+        caches.add(roleGrantsCache);\n \n         grantedPrincipalsCache = newCacheBuilder(expiresAfterWriteMillis, refreshMills, maximumSize, statsRecording)\n                 .build(asyncReloading(CacheLoader.from(this::loadPrincipals), executor));\n+        caches.add(grantedPrincipalsCache);\n \n         configValuesCache = newCacheBuilder(expiresAfterWriteMillis, refreshMills, maximumSize, statsRecording)\n                 .build(asyncReloading(CacheLoader.from(this::loadConfigValue), executor));\n+        caches.add(configValuesCache);\n     }\n \n     @Managed\n     public void flushCache()\n     {\n-        databaseNamesCache.invalidateAll();\n-        tableNamesCache.invalidateAll();\n-        viewNamesCache.invalidateAll();\n-        partitionNamesCache.invalidateAll();\n-        databaseCache.invalidateAll();\n-        tableCache.invalidateAll();\n-        partitionCache.invalidateAll();\n-        partitionFilterCache.invalidateAll();\n-        tablePrivilegesCache.invalidateAll();\n-        tableStatisticsCache.invalidateAll();\n-        partitionStatisticsCache.invalidateAll();\n-        rolesCache.invalidateAll();\n+        caches.forEach(Cache::invalidateAll);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyOTE4Nw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r468629187", "bodyText": "The old code was buggy, 4 caches weren't cleaned, so I added this to prevent such things in the future. Now the title of this pr will be different.", "author": "iirekm", "createdAt": "2020-08-11T14:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ4NTI0OA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471485248", "bodyText": "now it is buggy in different way. Still someone might forget to add a cache to caches. Please undo the refactor or please make a separate PR and we can discuss it", "author": "kokosing", "createdAt": "2020-08-17T13:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ4Mjk0OA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471482948", "bodyText": "static import,\ncloser for single usage is an overkill to me.", "author": "kokosing", "createdAt": "2020-08-17T13:36:09Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMTE4Mw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472111183", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ4Mjk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5MDQxMg==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471490412", "bodyText": "Commit message:\nAdd missing cache invalidate calls to CachingHiveMetastore is implementation detail, however the more important aspect is user visiable behavior change. Also please do not use - in commit message title.\nI would write:\nInvalidate Hive metastore cache on GRANT/REVOKE\n\n- Add missing cache invalidate calls to CachingHiveMetastore\n- Fix REVOKE in FileHiveMetastore", "author": "kokosing", "createdAt": "2020-08-17T13:47:41Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEwOTU2OA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472109568", "bodyText": "splitted into 2 commits", "author": "iirekm", "createdAt": "2020-08-18T11:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5MDQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDM1NQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471494355", "bodyText": "Use io.prestosql.plugin.hive.HiveQueryRunner#builder then you don't have to play with metastore directory.", "author": "kokosing", "createdAt": "2020-08-17T13:53:37Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMDMxNA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472110314", "bodyText": "my setup is completely different from the offering of this builder, code reuse in this case makes no sense", "author": "iirekm", "createdAt": "2020-08-18T11:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDUxNw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471494517", "bodyText": "you need to close query runner here.", "author": "kokosing", "createdAt": "2020-08-17T13:53:51Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", ImmutableMap.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMzA5OA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472113098", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDg1MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471494850", "bodyText": "private static", "author": "kokosing", "createdAt": "2020-08-17T13:54:24Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", ImmutableMap.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();\n+    }\n+\n+    static Session getTestSession(Identity identity)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMzI1MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472113250", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDg5MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471494891", "bodyText": "public", "author": "kokosing", "createdAt": "2020-08-17T13:54:29Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", ImmutableMap.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    void cleanUp()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMjkzMw==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472112933", "bodyText": "added for convention, it matters on JUnit, but it doesn't matter in testng", "author": "iirekm", "createdAt": "2020-08-18T11:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NTI3MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r471495271", "bodyText": "com.google.common.collect.Sets#cartesianProduct(java.util.Set<? extends B>...)?", "author": "kokosing", "createdAt": "2020-08-17T13:55:03Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.io.Closer;\n+import com.google.common.io.Files;\n+import com.google.common.io.MoreFiles;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer\n+@Test(singleThreaded = true)\n+public class TestCachingHiveMetastoreWithQueryRunner\n+{\n+    private static final String CATALOG = \"test\";\n+    private static final String SCHEMA = \"test\";\n+    private static final Session ADMIN = getTestSession(Identity.forUser(\"admin\")\n+            .withRole(CATALOG, new SelectedRole(ROLE, Optional.of(\"admin\")))\n+            .build());\n+    private static final String ALICE_NAME = \"alice\";\n+    private static final Session ALICE = getTestSession(new Identity.Builder(ALICE_NAME).build());\n+\n+    private DistributedQueryRunner queryRunner;\n+    private final Closer closer = Closer.create();\n+\n+    @BeforeMethod\n+    public void createQueryRunner()\n+            throws Exception\n+    {\n+        queryRunner = DistributedQueryRunner\n+                .builder(ADMIN)\n+                .setNodeCount(1)\n+                .build();\n+        queryRunner.installPlugin(new HiveHadoop2Plugin());\n+        File tmp = Files.createTempDir();\n+        closer.register(() -> MoreFiles.deleteRecursively(tmp.toPath(), ALLOW_INSECURE));\n+        queryRunner.createCatalog(CATALOG, \"hive-hadoop2\", ImmutableMap.of(\n+                \"hive.metastore\", \"file\",\n+                \"hive.metastore.catalog.dir\", tmp.toURI().toString(),\n+                \"hive.security\", \"sql-standard\",\n+                \"hive.metastore-cache-ttl\", \"60m\",\n+                \"hive.metastore-refresh-interval\", \"10m\"));\n+        queryRunner.execute(ADMIN, \"CREATE SCHEMA \" + SCHEMA);\n+        queryRunner.execute(\"CREATE TABLE test (test INT)\");\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    void cleanUp()\n+            throws IOException\n+    {\n+        closer.close();\n+    }\n+\n+    static Session getTestSession(Identity identity)\n+    {\n+        return testSessionBuilder()\n+                .setCatalog(CATALOG)\n+                .setSchema(SCHEMA)\n+                .setIdentity(identity)\n+                .build();\n+    }\n+\n+    @Test\n+    public void testCacheRefreshOnGrantAndRevoke()\n+    {\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+        queryRunner.execute(\"GRANT SELECT ON test TO \" + ALICE_NAME);\n+        queryRunner.execute(ALICE, \"SELECT * FROM test\");\n+        queryRunner.execute(\"REVOKE SELECT ON test FROM \" + ALICE_NAME);\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+    }\n+\n+    @Test(dataProvider = \"testCacheRefreshOnRoleGrantAndRevokeParams\")\n+    public void testCacheRefreshOnRoleGrantAndRevoke(List<String> grantRoleStatements, String revokeRoleStatement)\n+    {\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+        queryRunner.execute(\"CREATE ROLE test_role\");\n+        grantRoleStatements.forEach(queryRunner::execute);\n+        queryRunner.execute(ALICE, \"SELECT * FROM test\");\n+        queryRunner.execute(revokeRoleStatement);\n+        assertThatThrownBy(() -> queryRunner.execute(ALICE, \"SELECT * FROM test\"))\n+                .hasMessageContaining(\"Access Denied\");\n+    }\n+\n+    @DataProvider\n+    private Object[][] testCacheRefreshOnRoleGrantAndRevokeParams()\n+    {\n+        String grantSelectStatement = \"GRANT SELECT ON test TO ROLE test_role\";\n+        String grantRoleStatement = \"GRANT test_role TO \" + ALICE_NAME;\n+        List<List<String>> grantRoleStatements = ImmutableList.of(\n+                ImmutableList.of(grantSelectStatement, grantRoleStatement),\n+                ImmutableList.of(grantRoleStatement, grantSelectStatement));\n+        List<String> revokeRoleStatements = ImmutableList.of(\n+                \"DROP ROLE test_role\",\n+                \"REVOKE SELECT ON test FROM ROLE test_role\",\n+                \"REVOKE test_role FROM \" + ALICE_NAME);\n+        return grantRoleStatements.stream()\n+                .flatMap(arg1 -> revokeRoleStatements.stream().map(arg2 -> new Object[] {arg1, arg2}))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExNzI5MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472117290", "bodyText": "done", "author": "iirekm", "createdAt": "2020-08-18T11:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ5NTI3MQ=="}], "type": "inlineReview"}, {"oid": "21ed14d6e9a4254db0aa6d26e3a1e13c93fae009", "url": "https://github.com/trinodb/trino/commit/21ed14d6e9a4254db0aa6d26e3a1e13c93fae009", "message": "Fix REVOKE in FileHiveMetastore", "committedDate": "2020-08-18T11:31:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEyODU5MA==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472128590", "bodyText": "This is no longer needed", "author": "kokosing", "createdAt": "2020-08-18T12:08:47Z", "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastoreWithQueryRunner.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.metastore.cache;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.Session;\n+import io.prestosql.plugin.hive.HiveHadoop2Plugin;\n+import io.prestosql.spi.security.Identity;\n+import io.prestosql.spi.security.SelectedRole;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.google.common.collect.Lists.cartesianProduct;\n+import static com.google.common.io.Files.createTempDir;\n+import static com.google.common.io.MoreFiles.deleteRecursively;\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static io.prestosql.spi.security.SelectedRole.Type.ROLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@SuppressWarnings(\"UnstableApiUsage\")   // for Closer", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2NTQ2MQ==", "url": "https://github.com/trinodb/trino/pull/4768#discussion_r472265461", "bodyText": "needed - other @Beta stuff from Guava used", "author": "iirekm", "createdAt": "2020-08-18T15:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEyODU5MA=="}], "type": "inlineReview"}, {"oid": "c9d453bf8af3cd848aab53ededaeca4f5779447b", "url": "https://github.com/trinodb/trino/commit/c9d453bf8af3cd848aab53ededaeca4f5779447b", "message": "Respect GRANT and REVOKE in CachingHiveMetastore", "committedDate": "2020-08-18T15:02:04Z", "type": "commit"}]}