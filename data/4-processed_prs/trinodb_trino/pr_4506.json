{"pr_number": 4506, "pr_title": "Improve timezone normalization", "pr_createdAt": "2020-07-20T23:36:21Z", "pr_url": "https://github.com/trinodb/trino/pull/4506", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTQxNQ==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457861415", "bodyText": "Does it matter we are calculating zoneId.toLowerCase(ENGLISH) twice now?", "author": "findepi", "createdAt": "2020-07-21T06:17:59Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {\n+                    // It must be something like GMT7, or Etc/UTC4, which are invalid\n+                    return zoneId;\n+                }\n+\n+                int colon = lowerCased.indexOf(':', offset);\n+                int hour;\n+                int minute = 0;\n+                if (colon != -1) {\n+                    hour = Integer.parseInt(lowerCased, offset, colon, 10);\n+                    minute = Integer.parseInt(lowerCased, colon + 1, lowerCased.length(), 10);\n+                }\n+                else if (lowerCased.length() - offset <= 3) {\n+                    // +H or +HH\n+                    hour = Integer.parseInt(lowerCased, offset, lowerCased.length(), 10);\n+                }\n+                else {\n+                    // let the JDK handle it below\n+                    break;\n+                }\n+\n+                if (hour == 0 && minute == 0) {\n+                    return \"utc\";\n+                }\n+\n+                if (prefix.equals(\"etc/gmt\")) {\n+                    hour = -hour;\n+                }\n \n-        // In some zones systems, these will start with UTC, GMT or UT.\n-        int length = zoneId.length();\n-        boolean startsWithEtcGmt = false;\n-        if (length > 3 && (zoneId.startsWith(\"utc\") || zoneId.startsWith(\"gmt\"))) {\n-            if (startsWithEtc && zoneId.startsWith(\"gmt\")) {\n-                startsWithEtcGmt = true;\n+                return formatZoneOffset(hour, minute);\n             }\n-            zoneId = zoneId.substring(3);\n-            length = zoneId.length();\n-        }\n-        else if (length > 2 && zoneId.startsWith(\"ut\")) {\n-            zoneId = zoneId.substring(2);\n-            length = zoneId.length();\n         }\n \n-        // (+/-)00:00 is UTC\n-        if (\"+00:00\".equals(zoneId) || \"-00:00\".equals(zoneId)) {\n-            return \"utc\";\n+        // Normalize using JDK rules. In particular, normalize forms such as +0735, +7, +073521\n+        try {\n+            zoneId = ZoneId.of(zoneId).getId();\n         }\n-\n-        // if zoneId matches XXX:XX, it is likely +HH:mm, so just return it\n-        // since only offset time zones will contain a `:` character\n-        if (length == 6 && zoneId.charAt(3) == ':') {\n+        catch (Exception e) {\n             return zoneId;\n         }\n \n-        //\n-        // Rewrite (+/-)H[H] to (+/-)HH:00\n-        //\n-        if (length != 2 && length != 3) {\n-            return originalZoneId;\n+        if (isUtcEquivalentName(zoneId)) {\n+            return \"utc\";\n         }\n \n-        // zone must start with a plus or minus sign\n-        char signChar = zoneId.charAt(0);\n-        if (signChar != '+' && signChar != '-') {\n-            return originalZoneId;\n-        }\n-        if (startsWithEtcGmt) {\n-            // Flip sign for Etc/GMT(+/-)H[H]\n-            signChar = signChar == '-' ? '+' : '-';\n-        }\n+        return zoneId;\n+    }\n \n-        // extract the tens and ones characters for the hour\n-        char hourTens;\n-        char hourOnes;\n-        if (length == 2) {\n-            hourTens = '0';\n-            hourOnes = zoneId.charAt(1);\n-        }\n-        else {\n-            hourTens = zoneId.charAt(1);\n-            hourOnes = zoneId.charAt(2);\n-        }\n+    private static String formatZoneOffset(int hour, int minute)\n+    {\n+        StringBuilder builder = new StringBuilder();\n+\n+        builder.append(hour >= 0 ? '+' : '-');\n \n-        // do we have a valid hours offset time zone?\n-        if (!isDigit(hourTens) || !isDigit(hourOnes)) {\n-            return originalZoneId;\n+        hour = abs(hour);\n+        if (hour < 10) {\n+            builder.append('0');\n         }\n+        builder.append(hour);\n+        builder.append(':');\n \n-        // is this offset 0 (e.g., UTC)?\n-        if (hourTens == '0' && hourOnes == '0') {\n-            return \"utc\";\n+        if (minute < 10) {\n+            builder.append('0');\n         }\n+        builder.append(minute);\n \n-        return \"\" + signChar + hourTens + hourOnes + \":00\";\n+        return builder.toString();\n     }\n \n     private static boolean isUtcEquivalentName(String zoneId)\n     {\n-        return zoneId.equals(\"utc\") ||\n-                zoneId.equals(\"z\") ||\n-                zoneId.equals(\"ut\") ||\n-                zoneId.equals(\"uct\") ||\n-                zoneId.equals(\"gmt\") ||\n-                zoneId.equals(\"gmt0\") ||\n-                zoneId.equals(\"greenwich\") ||\n-                zoneId.equals(\"universal\") ||\n-                zoneId.equals(\"zulu\");\n+        return UTC_EQUIVALENTS.contains(zoneId.toLowerCase(ENGLISH));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg3MTE0Nw==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457871147", "bodyText": "Not really. I have another PR in progress to remove the case insensitivity. We don't support it, anyway.", "author": "martint", "createdAt": "2020-07-21T06:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTc2Mw==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457861763", "bodyText": "index out of bound ?", "author": "findepi", "createdAt": "2020-07-21T06:19:00Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MjA5MQ==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457862091", "bodyText": "Include a note in the comment why you return instead of throwing for something deemed invalid.", "author": "findepi", "createdAt": "2020-07-21T06:19:51Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {\n+                    // It must be something like GMT7, or Etc/UTC4, which are invalid\n+                    return zoneId;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MjgzMg==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457862832", "bodyText": "What if part before the colon is empty or not digits (GMT+:10 or GMT+a:10)\nSame for part after the colon?\nShould this all be wrapped in catch (Exception e) { return zoneId; }?", "author": "findepi", "createdAt": "2020-07-21T06:21:48Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {\n+                    // It must be something like GMT7, or Etc/UTC4, which are invalid\n+                    return zoneId;\n+                }\n+\n+                int colon = lowerCased.indexOf(':', offset);\n+                int hour;\n+                int minute = 0;\n+                if (colon != -1) {\n+                    hour = Integer.parseInt(lowerCased, offset, colon, 10);\n+                    minute = Integer.parseInt(lowerCased, colon + 1, lowerCased.length(), 10);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MzY5Mg==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457863692", "bodyText": "6 capacity, if you care about performance\n(format otherwise)", "author": "findepi", "createdAt": "2020-07-21T06:24:16Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {\n+                    // It must be something like GMT7, or Etc/UTC4, which are invalid\n+                    return zoneId;\n+                }\n+\n+                int colon = lowerCased.indexOf(':', offset);\n+                int hour;\n+                int minute = 0;\n+                if (colon != -1) {\n+                    hour = Integer.parseInt(lowerCased, offset, colon, 10);\n+                    minute = Integer.parseInt(lowerCased, colon + 1, lowerCased.length(), 10);\n+                }\n+                else if (lowerCased.length() - offset <= 3) {\n+                    // +H or +HH\n+                    hour = Integer.parseInt(lowerCased, offset, lowerCased.length(), 10);\n+                }\n+                else {\n+                    // let the JDK handle it below\n+                    break;\n+                }\n+\n+                if (hour == 0 && minute == 0) {\n+                    return \"utc\";\n+                }\n+\n+                if (prefix.equals(\"etc/gmt\")) {\n+                    hour = -hour;\n+                }\n \n-        // In some zones systems, these will start with UTC, GMT or UT.\n-        int length = zoneId.length();\n-        boolean startsWithEtcGmt = false;\n-        if (length > 3 && (zoneId.startsWith(\"utc\") || zoneId.startsWith(\"gmt\"))) {\n-            if (startsWithEtc && zoneId.startsWith(\"gmt\")) {\n-                startsWithEtcGmt = true;\n+                return formatZoneOffset(hour, minute);\n             }\n-            zoneId = zoneId.substring(3);\n-            length = zoneId.length();\n-        }\n-        else if (length > 2 && zoneId.startsWith(\"ut\")) {\n-            zoneId = zoneId.substring(2);\n-            length = zoneId.length();\n         }\n \n-        // (+/-)00:00 is UTC\n-        if (\"+00:00\".equals(zoneId) || \"-00:00\".equals(zoneId)) {\n-            return \"utc\";\n+        // Normalize using JDK rules. In particular, normalize forms such as +0735, +7, +073521\n+        try {\n+            zoneId = ZoneId.of(zoneId).getId();\n         }\n-\n-        // if zoneId matches XXX:XX, it is likely +HH:mm, so just return it\n-        // since only offset time zones will contain a `:` character\n-        if (length == 6 && zoneId.charAt(3) == ':') {\n+        catch (Exception e) {\n             return zoneId;\n         }\n \n-        //\n-        // Rewrite (+/-)H[H] to (+/-)HH:00\n-        //\n-        if (length != 2 && length != 3) {\n-            return originalZoneId;\n+        if (isUtcEquivalentName(zoneId)) {\n+            return \"utc\";\n         }\n \n-        // zone must start with a plus or minus sign\n-        char signChar = zoneId.charAt(0);\n-        if (signChar != '+' && signChar != '-') {\n-            return originalZoneId;\n-        }\n-        if (startsWithEtcGmt) {\n-            // Flip sign for Etc/GMT(+/-)H[H]\n-            signChar = signChar == '-' ? '+' : '-';\n-        }\n+        return zoneId;\n+    }\n \n-        // extract the tens and ones characters for the hour\n-        char hourTens;\n-        char hourOnes;\n-        if (length == 2) {\n-            hourTens = '0';\n-            hourOnes = zoneId.charAt(1);\n-        }\n-        else {\n-            hourTens = zoneId.charAt(1);\n-            hourOnes = zoneId.charAt(2);\n-        }\n+    private static String formatZoneOffset(int hour, int minute)\n+    {\n+        StringBuilder builder = new StringBuilder();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg3MTgwMw==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457871803", "bodyText": "format is much slower. Default StringBuilder capacity is 16, so performance-wise, setting it to 6 doesn't matter.", "author": "martint", "createdAt": "2020-07-21T06:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MzY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2NDI1Mw==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457864253", "bodyText": "Do you have a test for +073521 case?\n(what does it mean actually?)", "author": "findepi", "createdAt": "2020-07-21T06:25:46Z", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TimeZoneKey.java", "diffHunk": "@@ -210,102 +251,89 @@ public static boolean isUtcZoneId(String zoneId)\n         return normalizeZoneId(zoneId).equals(\"utc\");\n     }\n \n-    private static String normalizeZoneId(String originalZoneId)\n+    private static String normalizeZoneId(String zoneId)\n     {\n-        String zoneId = originalZoneId.toLowerCase(ENGLISH);\n-\n-        boolean startsWithEtc = zoneId.startsWith(\"etc/\");\n-        if (startsWithEtc) {\n-            zoneId = zoneId.substring(4);\n-        }\n-\n         if (isUtcEquivalentName(zoneId)) {\n             return \"utc\";\n         }\n \n-        //\n-        // Normalize fixed offset time zones.\n-        //\n+        // The JDK doesn't understand legacy timezones such as Etc/GMT+00:00, GMT-7\n+        String lowerCased = zoneId.toLowerCase(ENGLISH);\n+        for (String prefix : UTC_OFFSET_PREFIXES) {\n+            if (lowerCased.startsWith(prefix)) {\n+                int offset = prefix.length();\n+                if (lowerCased.charAt(offset) != '+' && lowerCased.charAt(offset) != '-') {\n+                    // It must be something like GMT7, or Etc/UTC4, which are invalid\n+                    return zoneId;\n+                }\n+\n+                int colon = lowerCased.indexOf(':', offset);\n+                int hour;\n+                int minute = 0;\n+                if (colon != -1) {\n+                    hour = Integer.parseInt(lowerCased, offset, colon, 10);\n+                    minute = Integer.parseInt(lowerCased, colon + 1, lowerCased.length(), 10);\n+                }\n+                else if (lowerCased.length() - offset <= 3) {\n+                    // +H or +HH\n+                    hour = Integer.parseInt(lowerCased, offset, lowerCased.length(), 10);\n+                }\n+                else {\n+                    // let the JDK handle it below\n+                    break;\n+                }\n+\n+                if (hour == 0 && minute == 0) {\n+                    return \"utc\";\n+                }\n+\n+                if (prefix.equals(\"etc/gmt\")) {\n+                    hour = -hour;\n+                }\n \n-        // In some zones systems, these will start with UTC, GMT or UT.\n-        int length = zoneId.length();\n-        boolean startsWithEtcGmt = false;\n-        if (length > 3 && (zoneId.startsWith(\"utc\") || zoneId.startsWith(\"gmt\"))) {\n-            if (startsWithEtc && zoneId.startsWith(\"gmt\")) {\n-                startsWithEtcGmt = true;\n+                return formatZoneOffset(hour, minute);\n             }\n-            zoneId = zoneId.substring(3);\n-            length = zoneId.length();\n-        }\n-        else if (length > 2 && zoneId.startsWith(\"ut\")) {\n-            zoneId = zoneId.substring(2);\n-            length = zoneId.length();\n         }\n \n-        // (+/-)00:00 is UTC\n-        if (\"+00:00\".equals(zoneId) || \"-00:00\".equals(zoneId)) {\n-            return \"utc\";\n+        // Normalize using JDK rules. In particular, normalize forms such as +0735, +7, +073521", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg3MjM0NA==", "url": "https://github.com/trinodb/trino/pull/4506#discussion_r457872344", "bodyText": "We don't, because we don't support them in Presto. The comment is there for completeness. +073521 is +07:35:21 (i.e., an offset with non-zero seconds)", "author": "martint", "createdAt": "2020-07-21T06:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2NDI1Mw=="}], "type": "inlineReview"}, {"oid": "0b854ae433c414018fbb2ef7bd1fccc635dceb59", "url": "https://github.com/trinodb/trino/commit/0b854ae433c414018fbb2ef7bd1fccc635dceb59", "message": "Improve timezone normalization\n\nPatterns such as +0735 or GMT+07:35 were not being handled properly.\nThis change also simplifies the control flow of the method and\nmakes it easier to read.", "committedDate": "2020-07-21T06:50:18Z", "type": "commit"}, {"oid": "0b854ae433c414018fbb2ef7bd1fccc635dceb59", "url": "https://github.com/trinodb/trino/commit/0b854ae433c414018fbb2ef7bd1fccc635dceb59", "message": "Improve timezone normalization\n\nPatterns such as +0735 or GMT+07:35 were not being handled properly.\nThis change also simplifies the control flow of the method and\nmakes it easier to read.", "committedDate": "2020-07-21T06:50:18Z", "type": "forcePushed"}]}