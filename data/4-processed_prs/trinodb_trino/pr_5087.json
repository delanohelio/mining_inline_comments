{"pr_number": 5087, "pr_title": "Fix compiler error for lambda parameter with non-letter", "pr_createdAt": "2020-09-07T08:28:27Z", "pr_url": "https://github.com/trinodb/trino/pull/5087", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3NDU2Mg==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r484274562", "bodyText": "I realize \"lambda_\" + argumentPosition is enough from generated code perspective.\nI retained argument name in case there is any need to debug the generated code.", "author": "findepi", "createdAt": "2020-09-07T08:29:31Z", "path": "presto-main/src/main/java/io/prestosql/sql/gen/LambdaBytecodeGenerator.java", "diffHunk": "@@ -142,6 +142,14 @@ public static CompiledLambda preGenerateLambdaExpression(\n                 lambdaExpression);\n     }\n \n+    /**\n+     * Parameter name for the generated method.\n+     */\n+    private static String parameterName(int argumentPosition, String lambdaArgumentName)\n+    {\n+        return \"lambda_\" + argumentPosition + \"_\" + lambdaArgumentName.replaceAll(\"[^a-zA-Z_]\", \"\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc2NzYzMw==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r484767633", "bodyText": "@Praveen2112 was there a similar escaping somewhere already? I think you did one, but I can't remember where was it.", "author": "sopel39", "createdAt": "2020-09-08T09:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc3OTM2OA==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r484779368", "bodyText": "Yes !! It was in scalar function .. #2081", "author": "Praveen2112", "createdAt": "2020-09-08T09:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNjg4MA==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r484816880", "bodyText": "Thanks, updated", "author": "findepi", "createdAt": "2020-09-08T10:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3NDU2Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1Njc0MQ==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r484656741", "bodyText": "The current approach in the PR makes sense, considering that the construction of the class definition shouldn't make any assumptions about the symbols, and do this sanitization before creating parameter names.\nAnother place to do this sanitization could be SymbolAllocator#newSymbol. As a side-effect, it  may improve plan readability (a minor benefit though). For example, if we truncate the string while \"sanitizing\" the symbols for the issue mentioned in #5088, the explain plan would display the truncated symbol. Thoughts?", "author": "phd3", "createdAt": "2020-09-08T05:24:16Z", "path": "presto-main/src/main/java/io/prestosql/sql/gen/LambdaBytecodeGenerator.java", "diffHunk": "@@ -142,6 +142,14 @@ public static CompiledLambda preGenerateLambdaExpression(\n                 lambdaExpression);\n     }\n \n+    /**\n+     * Parameter name for the generated method.\n+     */\n+    private static String parameterName(int argumentPosition, String lambdaArgumentName)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5NzE1NQ==", "url": "https://github.com/trinodb/trino/pull/5087#discussion_r485397155", "bodyText": "Another place to do this sanitization could be SymbolAllocator#newSymbol.\n\nI thought about that. IMO the change here does not preclude change in SymbolAllocator.\nAnd the change in SymbolAllocator does not make the change here obsolete:\ncompiler code should make as few assumptions about planner as possible.\nIt would feel wrong if planner had to consider Java class format constraints.\nFor  #5088, as you pointed out, there are other benefits from keeping symbols short.\nPlan readability, but also guard against any potential perf penalties\n(at least in theory, a potential DOS attack vector).", "author": "findepi", "createdAt": "2020-09-09T07:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1Njc0MQ=="}], "type": "inlineReview"}, {"oid": "d2c7bfac371b85d2687310cc6924a7e8ebf95452", "url": "https://github.com/trinodb/trino/commit/d2c7bfac371b85d2687310cc6924a7e8ebf95452", "message": "Remove bogus braces from regex\n\nAlthough the unqualified name in JVM apparently _can_ contain braces `(`\nor `)`, the intention was to remove them, retaining only letters,\ndigits, underscore and dollar sign.", "committedDate": "2020-09-09T07:31:18Z", "type": "commit"}, {"oid": "5fb4ac0eaa95b49232217fea542492b74ba1894e", "url": "https://github.com/trinodb/trino/commit/5fb4ac0eaa95b49232217fea542492b74ba1894e", "message": "Remove redundant constructor", "committedDate": "2020-09-09T07:31:19Z", "type": "commit"}, {"oid": "11b4e3af3f478b88a7e48be09c48c913816da5e3", "url": "https://github.com/trinodb/trino/commit/11b4e3af3f478b88a7e48be09c48c913816da5e3", "message": "Fix indentation", "committedDate": "2020-09-09T07:31:19Z", "type": "commit"}, {"oid": "3c2347187686f0b9e1e2be0cf483bf40191adc31", "url": "https://github.com/trinodb/trino/commit/3c2347187686f0b9e1e2be0cf483bf40191adc31", "message": "Fix compiler error for lambda parameter with non-letter\n\nFix a generated code error when lambda parameter contains a character\nthat is not part of a valid Java identifier.", "committedDate": "2020-09-09T07:31:19Z", "type": "commit"}, {"oid": "3c2347187686f0b9e1e2be0cf483bf40191adc31", "url": "https://github.com/trinodb/trino/commit/3c2347187686f0b9e1e2be0cf483bf40191adc31", "message": "Fix compiler error for lambda parameter with non-letter\n\nFix a generated code error when lambda parameter contains a character\nthat is not part of a valid Java identifier.", "committedDate": "2020-09-09T07:31:19Z", "type": "forcePushed"}]}