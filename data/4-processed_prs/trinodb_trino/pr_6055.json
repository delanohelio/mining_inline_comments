{"pr_number": 6055, "pr_title": "Tests for block encodings", "pr_createdAt": "2020-11-23T13:38:47Z", "pr_url": "https://github.com/trinodb/trino/pull/6055", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyOTUxMg==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528729512", "bodyText": "make this array of T", "author": "sopel39", "createdAt": "2020-11-23T14:11:23Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.block;\n+\n+import io.airlift.slice.DynamicSliceOutput;\n+import io.prestosql.spi.type.Type;\n+\n+import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n+\n+public abstract class BaseBlockEncodingTest<T>\n+{\n+    private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n+\n+    protected abstract Type getType();\n+\n+    protected abstract void write(BlockBuilder blockBuilder, T value);\n+\n+    protected final void roundTrip(Object... values)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczNjI2NQ==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528736265", "bodyText": "Tried it, but I cannot make new T[] that way (testRandomData)\nAnd then thought about List instead of array. But both ImmutableList.of and List.of does not accept nulls.\nSo this solutions seems the least bad", "author": "skrzypo987", "createdAt": "2020-11-23T14:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyOTUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMDY4NA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528730684", "bodyText": "this was specifically testing null at beginning and end as it requires special treatment in optimized block encoding", "author": "sopel39", "createdAt": "2020-11-23T14:13:03Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestLongArrayBlockEncoding.java", "diffHunk": "@@ -14,29 +14,24 @@\n package io.prestosql.spi.block;\n \n import io.prestosql.spi.type.Type;\n-import org.testng.annotations.Test;\n+\n+import java.util.Random;\n \n import static io.prestosql.spi.type.BigintType.BIGINT;\n \n public class TestLongArrayBlockEncoding\n         extends BaseBlockEncodingTest<Long>\n {\n-    @Test\n-    public void testRoundTripNoNull()\n-    {\n-        roundTrip(1L, 2L, 3L, 4L);\n-    }\n-\n-    @Test\n-    public void testRoundTripWithNull()\n+    @Override\n+    protected void write(BlockBuilder blockBuilder, Long value)\n     {\n-        roundTrip(null, null, 1L, null, 3L, null, null);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczNzA0Ng==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528737046", "bodyText": "I'll add a test case for that then.", "author": "skrzypo987", "createdAt": "2020-11-23T14:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMDY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMzI1Mg==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528733252", "bodyText": "Do we expect this randomized test to find any issues? Do we need all these size combinations? It seems that few purposefully designed cases are enough.", "author": "sopel39", "createdAt": "2020-11-23T14:16:50Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -15,17 +15,80 @@\n \n import io.airlift.slice.DynamicSliceOutput;\n import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n \n import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n \n public abstract class BaseBlockEncodingTest<T>\n {\n+    private static final int[] RANDOM_BLOCK_SIZES = {2, 4, 8, 9, 16, 17, 32, 33, 64, 65, 1000, 1000000};\n+\n+    private final Random random = new Random(32167);\n     private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n \n     protected abstract Type getType();\n \n     protected abstract void write(BlockBuilder blockBuilder, T value);\n \n+    protected abstract T randomValue(Random random);\n+\n+    @Test\n+    public void testEmpty()\n+    {\n+        roundTrip();\n+    }\n+\n+    @Test\n+    public void testSingleNull()\n+    {\n+        roundTrip((T) null);\n+    }\n+\n+    @Test\n+    public void testSingleValue()\n+    {\n+        roundTrip(randomValue(random));\n+    }\n+\n+    @Test(dataProvider = \"testRandomDataDataProvider\")\n+    public void testRandomData(int size, BlockFill fill)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczNDc2NQ==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528734765", "bodyText": "One of the advantages of those tests is that they are not expensive at all. Running hundreds of them will take less than a second.\nI expect any actual case to be treated as a separate test", "author": "skrzypo987", "createdAt": "2020-11-23T14:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMzI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc0NjUzOA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528746538", "bodyText": "We need to make tests to be single threaded, otherwise we might hit some issues with reproducing GHA tests execution flakiness.\nMaybe use rangom that is bound to method execution life cycle, not a field of the class", "author": "kokosing", "createdAt": "2020-11-23T14:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMzI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1NTc3Ng==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528755776", "bodyText": "These tests are super fast. There is no harm in running them single-threaded. I will add the annotation\nMaking random method-bound is not trivial here.", "author": "skrzypo987", "createdAt": "2020-11-23T14:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODczMzI1Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc0NzEyNw==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528747127", "bodyText": "composition?", "author": "kokosing", "createdAt": "2020-11-23T14:36:11Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestLongArrayBlockEncoding.java", "diffHunk": "@@ -13,48 +13,35 @@\n  */\n package io.prestosql.spi.block;\n \n-import io.airlift.slice.DynamicSliceOutput;\n+import io.prestosql.spi.type.Type;\n import org.testng.annotations.Test;\n \n-import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n import static io.prestosql.spi.type.BigintType.BIGINT;\n \n public class TestLongArrayBlockEncoding\n+        extends BaseBlockEncodingTest<Long>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1MTA3OA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r528751078", "bodyText": "What do you mean? What is wrong with inheritance here? And how would you like this composition to be implemented?", "author": "skrzypo987", "createdAt": "2020-11-23T14:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc0NzEyNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MDkzMg==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r530250932", "bodyText": "is (T) redundant here?", "author": "sopel39", "createdAt": "2020-11-25T10:06:03Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -15,19 +15,87 @@\n \n import io.airlift.slice.DynamicSliceOutput;\n import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n+\n import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n \n @Test(singleThreaded = true)\n public abstract class BaseBlockEncodingTest<T>\n {\n+    private static final int[] RANDOM_BLOCK_SIZES = {2, 4, 8, 9, 16, 17, 32, 33, 64, 65, 1000, 1000000};\n+\n+    private final Random random = new Random(32167);\n     private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n \n     protected abstract Type getType();\n \n     protected abstract void write(BlockBuilder blockBuilder, T value);\n \n+    protected abstract T randomValue(Random random);\n+\n+    @Test\n+    public void testEmpty()\n+    {\n+        roundTrip();\n+    }\n+\n+    @Test\n+    public void testSingleNull()\n+    {\n+        roundTrip((T) null);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMzQ0NA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r530423444", "bodyText": "This method has varargs. Only null here will be ambiguous  - don't know whether it's an array with a single null value or an actual null.", "author": "skrzypo987", "createdAt": "2020-11-25T14:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MDkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MTcyNw==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r530251727", "bodyText": "these annotations don't work in abstract classes in TestNG: cbeust/testng#144", "author": "sopel39", "createdAt": "2020-11-25T10:07:13Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -15,19 +15,87 @@\n \n import io.airlift.slice.DynamicSliceOutput;\n import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n+\n import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n \n @Test(singleThreaded = true)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMjU4Ng==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r530422586", "bodyText": "And that is why I prefer JUnit - separate instance for every test.\nAdded a dedicated random in every test. Better than 7 @Test(singleThreaded = true) annotations.", "author": "skrzypo987", "createdAt": "2020-11-25T14:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NTc1Ng==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r531575756", "bodyText": "remove this annotation here then", "author": "sopel39", "createdAt": "2020-11-27T12:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MTcyNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NjE3MA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r531576170", "bodyText": "extract this to getRandom method", "author": "sopel39", "createdAt": "2020-11-27T12:32:54Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -15,19 +15,88 @@\n \n import io.airlift.slice.DynamicSliceOutput;\n import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n+\n import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n \n-@Test(singleThreaded = true)\n public abstract class BaseBlockEncodingTest<T>\n {\n+    private static final int[] RANDOM_BLOCK_SIZES = {2, 4, 8, 9, 16, 17, 32, 33, 64, 65, 1000, 1000000};\n+    private static final int RANDOM_SEED = 32167;\n+\n     private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n \n     protected abstract Type getType();\n \n     protected abstract void write(BlockBuilder blockBuilder, T value);\n \n+    protected abstract T randomValue(Random random);\n+\n+    @Test\n+    public void testEmpty()\n+    {\n+        roundTrip();\n+    }\n+\n+    @Test\n+    public void testSingleNull()\n+    {\n+        roundTrip((T) null);\n+    }\n+\n+    @Test\n+    public void testSingleValue()\n+    {\n+        roundTrip(randomValue(new Random(RANDOM_SEED)));\n+    }\n+\n+    @Test\n+    public void testNullAtTheBeginningAndEnd()\n+    {\n+        Random random = new Random(32167);\n+        roundTrip(null, null, randomValue(random), null, randomValue(random), null, null);\n+    }\n+\n+    @Test(dataProvider = \"testRandomDataDataProvider\")\n+    public void testRandomData(int size, BlockFill fill)\n+    {\n+        Random random = new Random(32167);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyNDE2Ng==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r531624166", "bodyText": "Add a test with 0-length strings\nAdd a test with multibyte UTF\nAdd a test with 0 byte", "author": "sopel39", "createdAt": "2020-11-27T14:11:46Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestVariableWidthBlockEncoding.java", "diffHunk": "@@ -13,29 +13,34 @@\n  */\n package io.prestosql.spi.block;\n \n-import io.airlift.slice.DynamicSliceOutput;\n-import org.testng.annotations.Test;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.Random;\n \n-import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n import static io.prestosql.spi.type.VarcharType.VARCHAR;\n \n public class TestVariableWidthBlockEncoding\n+        extends BaseBlockEncodingTest<String>\n {\n-    private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n+    @Override\n+    protected Type getType()\n+    {\n+        return VARCHAR;\n+    }\n \n-    @Test\n-    public void testRoundTrip()\n+    @Override\n+    protected void write(BlockBuilder blockBuilder, String value)\n     {\n-        BlockBuilder expectedBlockBuilder = VARCHAR.createBlockBuilder(null, 4);\n-        VARCHAR.writeString(expectedBlockBuilder, \"alice\");\n-        VARCHAR.writeString(expectedBlockBuilder, \"bob\");\n-        VARCHAR.writeString(expectedBlockBuilder, \"charlie\");\n-        VARCHAR.writeString(expectedBlockBuilder, \"dave\");\n-        Block expectedBlock = expectedBlockBuilder.build();\n+        VARCHAR.writeString(blockBuilder, value);\n+    }\n \n-        DynamicSliceOutput sliceOutput = new DynamicSliceOutput(1024);\n-        blockEncodingSerde.writeBlock(sliceOutput, expectedBlock);\n-        Block actualBlock = blockEncodingSerde.readBlock(sliceOutput.slice().getInput());\n-        assertBlockEquals(VARCHAR, actualBlock, expectedBlock);\n+    @Override\n+    protected String randomValue(Random random)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY1OTQ5NA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r531659494", "bodyText": "done", "author": "skrzypo987", "createdAt": "2020-11-27T15:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyNDE2Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ3OTQ4MA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532479480", "bodyText": "remove?", "author": "sopel39", "createdAt": "2020-11-30T10:09:00Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.block;\n+\n+import io.airlift.slice.DynamicSliceOutput;\n+import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n+\n+import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n+\n+public abstract class BaseBlockEncodingTest<T>\n+{\n+    private static final int[] RANDOM_BLOCK_SIZES = {2, 4, 8, 9, 16, 17, 32, 33, 64, 65, 1000, 1000000};\n+\n+    private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n+\n+    protected abstract Type getType();\n+\n+    protected abstract void write(BlockBuilder blockBuilder, T value);\n+\n+    protected abstract T randomValue(Random random);\n+\n+    protected abstract T emptyValue(Random random);\n+\n+    @Test\n+    public void testEmpty()\n+    {\n+        roundTrip();\n+    }\n+\n+    @Test\n+    public void testSingleNull()\n+    {\n+        roundTrip((T) null);\n+    }\n+\n+    @Test\n+    public void testSingleValue()\n+    {\n+        roundTrip(randomValue(getRandom()));\n+    }\n+\n+    @Test\n+    void testEmptyValue()\n+    {\n+        roundTrip(emptyValue(getRandom()));\n+    }\n+\n+    @Test\n+    public void testNullAtTheBeginningAndEnd()\n+    {\n+        Random random = getRandom();\n+        roundTrip(null, null, randomValue(random), null, randomValue(random), null, null);\n+    }\n+\n+    @Test(dataProvider = \"testRandomDataDataProvider\")\n+    public void testRandomData(int size, BlockFill fill)\n+    {\n+        Random random = getRandom();\n+        Object[] values = new Object[size];\n+        for (int i = 0; i < size; i++) {\n+            switch (fill) {\n+                case ONLY_NULLS:\n+                    values[i] = null;\n+                    break;\n+                case ONLY_VALUES:\n+                    values[i] = randomValue(random);\n+                    break;\n+                case MIXED:\n+                    if (random.nextBoolean()) {\n+                        values[i] = null;\n+                    }\n+                    else {\n+                        values[i] = randomValue(random);\n+                    }\n+                    break;\n+            }\n+        }\n+\n+        roundTrip(values);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testRandomDataDataProvider()\n+    {\n+        return Arrays.stream(BlockFill.values())\n+                .flatMap(fill -> IntStream.of(RANDOM_BLOCK_SIZES).mapToObj(size -> new Object[] {size, fill}))\n+                .toArray(Object[][]::new);\n+    }\n+\n+    protected final void roundTrip(Object... values)\n+    {\n+        BlockBuilder expectedBlockBuilder = createBlockBuilder(values.length);\n+\n+        for (Object value : values) {\n+            if (value == null) {\n+                expectedBlockBuilder.appendNull();\n+            }\n+            else {\n+                //noinspection unchecked\n+                write(expectedBlockBuilder, (T) value);\n+            }\n+        }\n+\n+        Block expectedBlock = expectedBlockBuilder.build();\n+        DynamicSliceOutput sliceOutput = new DynamicSliceOutput(1024);\n+        blockEncodingSerde.writeBlock(sliceOutput, expectedBlock);\n+        Block actualBlock = blockEncodingSerde.readBlock(sliceOutput.slice().getInput());\n+        assertBlockEquals(getType(), actualBlock, expectedBlock);\n+    }\n+\n+    private BlockBuilder createBlockBuilder(int length)\n+    {\n+        return getType().createBlockBuilder(null, length);\n+    }\n+\n+    private static Random getRandom()\n+    {\n+        return new Random(32167);\n+    }\n+\n+    private enum BlockFill\n+    {\n+        ONLY_NULLS,\n+        ONLY_VALUES,\n+        MIXED,\n+        /**/", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ3OTgxOQ==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532479819", "bodyText": "what is an empty value? Do we need this?", "author": "sopel39", "createdAt": "2020-11-30T10:09:30Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/BaseBlockEncodingTest.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.block;\n+\n+import io.airlift.slice.DynamicSliceOutput;\n+import io.prestosql.spi.type.Type;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Arrays;\n+import java.util.Random;\n+import java.util.stream.IntStream;\n+\n+import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n+\n+public abstract class BaseBlockEncodingTest<T>\n+{\n+    private static final int[] RANDOM_BLOCK_SIZES = {2, 4, 8, 9, 16, 17, 32, 33, 64, 65, 1000, 1000000};\n+\n+    private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n+\n+    protected abstract Type getType();\n+\n+    protected abstract void write(BlockBuilder blockBuilder, T value);\n+\n+    protected abstract T randomValue(Random random);\n+\n+    protected abstract T emptyValue(Random random);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MDA2MA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532480060", "bodyText": "remove?", "author": "sopel39", "createdAt": "2020-11-30T10:09:53Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestShortArrayBlockEncoding.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.block;\n+\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.Random;\n+\n+import static io.prestosql.spi.type.SmallintType.SMALLINT;\n+\n+public class TestShortArrayBlockEncoding\n+        extends BaseBlockEncodingTest<Short>\n+{\n+    @Override\n+    protected void write(BlockBuilder blockBuilder, Short value)\n+    {\n+        blockBuilder.writeShort(value);\n+    }\n+\n+    @Override\n+    protected Short randomValue(Random random)\n+    {\n+        return (short) random.nextInt(0xFFFF);\n+    }\n+\n+    @Override\n+    protected Short emptyValue(Random random)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MDE1Nw==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532480157", "bodyText": "remove?", "author": "sopel39", "createdAt": "2020-11-30T10:10:02Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestInt96ArrayBlockEncoding.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.block;\n+\n+import io.prestosql.spi.type.LongTimestamp;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.Random;\n+\n+import static io.prestosql.spi.type.TimestampType.TIMESTAMP_PICOS;\n+import static io.prestosql.spi.type.Timestamps.PICOSECONDS_PER_MICROSECOND;\n+\n+public class TestInt96ArrayBlockEncoding\n+        extends BaseBlockEncodingTest<LongTimestamp>\n+{\n+    @Override\n+    protected void write(BlockBuilder blockBuilder, LongTimestamp value)\n+    {\n+        TIMESTAMP_PICOS.writeObject(blockBuilder, value);\n+    }\n+\n+    @Override\n+    protected LongTimestamp randomValue(Random random)\n+    {\n+        return new LongTimestamp(random.nextLong(), random.nextInt(PICOSECONDS_PER_MICROSECOND));\n+    }\n+\n+    @Override\n+    protected LongTimestamp emptyValue(Random random)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU5NjY2MA==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532596660", "bodyText": "nit: orders of methods should match order in BaseBlockEncodingTest", "author": "sopel39", "createdAt": "2020-11-30T13:29:45Z", "path": "presto-spi/src/test/java/io/prestosql/spi/block/TestLongArrayBlockEncoding.java", "diffHunk": "@@ -13,48 +13,30 @@\n  */\n package io.prestosql.spi.block;\n \n-import io.airlift.slice.DynamicSliceOutput;\n-import org.testng.annotations.Test;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.Random;\n \n-import static io.prestosql.spi.block.BlockTestUtils.assertBlockEquals;\n import static io.prestosql.spi.type.BigintType.BIGINT;\n \n public class TestLongArrayBlockEncoding\n+        extends BaseBlockEncodingTest<Long>\n {\n-    private final BlockEncodingSerde blockEncodingSerde = new TestingBlockEncodingSerde();\n-\n-    @Test\n-    public void testRoundTripNoNull()\n+    @Override\n+    protected void write(BlockBuilder blockBuilder, Long value)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMDgzOQ==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532600839", "bodyText": "I'll try to fix that before the automation kicks in", "author": "skrzypo987", "createdAt": "2020-11-30T13:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU5NjY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzY2Nw==", "url": "https://github.com/trinodb/trino/pull/6055#discussion_r532603667", "bodyText": "done", "author": "skrzypo987", "createdAt": "2020-11-30T13:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU5NjY2MA=="}], "type": "inlineReview"}, {"oid": "12364018cc7e0ab34327274cfbfa66699a2e309f", "url": "https://github.com/trinodb/trino/commit/12364018cc7e0ab34327274cfbfa66699a2e309f", "message": "Generify TestLongArrayBlockEncoding", "committedDate": "2020-11-30T13:37:50Z", "type": "commit"}, {"oid": "dd6d42fdc5205e8fce6807772931b435a75aa6bb", "url": "https://github.com/trinodb/trino/commit/dd6d42fdc5205e8fce6807772931b435a75aa6bb", "message": "Add more types to BaseBlockEncodingTest", "committedDate": "2020-11-30T13:37:52Z", "type": "commit"}, {"oid": "dd6d42fdc5205e8fce6807772931b435a75aa6bb", "url": "https://github.com/trinodb/trino/commit/dd6d42fdc5205e8fce6807772931b435a75aa6bb", "message": "Add more types to BaseBlockEncodingTest", "committedDate": "2020-11-30T13:37:52Z", "type": "forcePushed"}]}