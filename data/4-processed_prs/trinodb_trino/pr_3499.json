{"pr_number": 3499, "pr_title": "Allow INSERT statement for Cassandra table having hidden id column", "pr_createdAt": "2020-04-21T15:06:07Z", "pr_url": "https://github.com/trinodb/trino/pull/3499", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxMzYwNg==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412813606", "bodyText": "Can you please name this test in a way that captures what is the functionality tested here. IMO testInsertToTableWithHiddenId would be better name.", "author": "losipiuk", "createdAt": "2020-04-22T09:15:07Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraIntegrationSmokeTest.java", "diffHunk": "@@ -165,6 +165,16 @@ public void testSelect()\n         assertSelect(TABLE_ALL_TYPES_PARTITION_KEY, false);\n     }\n \n+    @Test\n+    public void testCreateTable()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxNTE3NQ==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412815175", "bodyText": "\"id\" literal appears in couple of places already. Can you please extract constant for that.", "author": "losipiuk", "createdAt": "2020-04-22T09:17:14Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -335,19 +335,32 @@ public ConnectorInsertTableHandle beginInsert(ConnectorSession session, Connecto\n \n         SchemaTableName schemaTableName = new SchemaTableName(table.getSchemaName(), table.getTableName());\n         List<CassandraColumnHandle> columns = cassandraSession.getTable(schemaTableName).getColumns();\n-        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).collect(Collectors.toList());\n-        List<Type> columnTypes = columns.stream().map(CassandraColumnHandle::getType).collect(Collectors.toList());\n+        List<String> columnNames = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getName)\n+                .collect(Collectors.toList());\n+        List<Type> columnTypes = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getType)\n+                .collect(Collectors.toList());\n+        boolean generateUuid = columns.stream().anyMatch(CassandraMetadata::isHiddenIdColumn);\n \n         return new CassandraInsertTableHandle(\n                 table.getSchemaName(),\n                 table.getTableName(),\n                 columnNames,\n-                columnTypes);\n+                columnTypes,\n+                generateUuid);\n     }\n \n     @Override\n     public Optional<ConnectorOutputMetadata> finishInsert(ConnectorSession session, ConnectorInsertTableHandle insertHandle, Collection<Slice> fragments, Collection<ComputedStatistics> computedStatistics)\n     {\n         return Optional.empty();\n     }\n+\n+    private static boolean isHiddenIdColumn(CassandraColumnHandle columnHandle)\n+    {\n+        return columnHandle.isHidden() && \"id\".equals(columnHandle.getName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxNjM3MQ==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412816371", "bodyText": "Not sure what is proper casing according to code-style but CassandraPageSing uses generateUUID. Can you please unify?", "author": "losipiuk", "createdAt": "2020-04-22T09:18:57Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraPageSinkProvider.java", "diffHunk": "@@ -67,6 +67,6 @@ public ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHa\n                 handle.getTableName(),\n                 handle.getColumnNames(),\n                 handle.getColumnTypes(),\n-                false);\n+                handle.isGenerateUuid());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNDI0Ng==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r413004246", "bodyText": "Unified to generateUuid as we have several Uuid~ classes.", "author": "ebyhr", "createdAt": "2020-04-22T13:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxNjM3MQ=="}], "type": "inlineReview"}, {"oid": "d80a498b33c45b27a1c7a6ae36847d18aaba9073", "url": "https://github.com/trinodb/trino/commit/d80a498b33c45b27a1c7a6ae36847d18aaba9073", "message": "Rename variable name and extract id column name in Cassandra", "committedDate": "2020-04-22T13:49:32Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0ODYxNQ==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r419148615", "bodyText": "Can there be more than one?", "author": "findepi", "createdAt": "2020-05-03T19:32:24Z", "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -336,19 +336,32 @@ public ConnectorInsertTableHandle beginInsert(ConnectorSession session, Connecto\n \n         SchemaTableName schemaTableName = new SchemaTableName(table.getSchemaName(), table.getTableName());\n         List<CassandraColumnHandle> columns = cassandraSession.getTable(schemaTableName).getColumns();\n-        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).collect(Collectors.toList());\n-        List<Type> columnTypes = columns.stream().map(CassandraColumnHandle::getType).collect(Collectors.toList());\n+        List<String> columnNames = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getName)\n+                .collect(Collectors.toList());\n+        List<Type> columnTypes = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getType)\n+                .collect(Collectors.toList());\n+        boolean generateUuid = columns.stream().anyMatch(CassandraMetadata::isHiddenIdColumn);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NDY0Nw==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r419274647", "bodyText": "I suppose it's always one.", "author": "ebyhr", "createdAt": "2020-05-04T08:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0ODYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyMzE3NQ==", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r419323175", "bodyText": "I guess (and it should), so the code here is too flexible\nmaybe\nboolean generateUuid = columns.stream()\n  .filter(CassandraMetadata::isHiddenIdColumn))\n .collect(toOptional()) // must be at most one\n .isPresent();", "author": "findepi", "createdAt": "2020-05-04T09:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0ODYxNQ=="}], "type": "inlineReview"}, {"oid": "9664f48170539fd9b10de87397b921db07353491", "url": "https://github.com/trinodb/trino/commit/9664f48170539fd9b10de87397b921db07353491", "message": "Allow INSERT statement for Cassandra table having hidden id column", "committedDate": "2020-05-04T13:33:48Z", "type": "commit"}, {"oid": "9664f48170539fd9b10de87397b921db07353491", "url": "https://github.com/trinodb/trino/commit/9664f48170539fd9b10de87397b921db07353491", "message": "Allow INSERT statement for Cassandra table having hidden id column", "committedDate": "2020-05-04T13:33:48Z", "type": "forcePushed"}]}