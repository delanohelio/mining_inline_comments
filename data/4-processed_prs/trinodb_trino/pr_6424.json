{"pr_number": 6424, "pr_title": "Add test coverage for querying views referencing Hive tables with timestamp columns", "pr_createdAt": "2020-12-22T14:42:34Z", "pr_url": "https://github.com/trinodb/trino/pull/6424", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547324362", "bodyText": "Are this not relevant? Most of it?", "author": "findepi", "createdAt": "2020-12-22T14:58:14Z", "path": "presto-product-tests-launcher/src/main/resources/docker/presto-product-tests/common/hadoop/hive_timestamp_nanos.properties", "diffHunk": "@@ -0,0 +1,16 @@\n+connector.name=hive-hadoop2\n+hive.metastore.uri=thrift://hadoop-master:9083\n+hive.config.resources=/docker/presto-product-tests/conf/presto/etc/hive-default-fs-site.xml\n+hive.allow-add-column=true\n+hive.allow-drop-column=true\n+hive.allow-rename-column=true\n+hive.allow-comment-table=true\n+hive.allow-comment-column=true\n+hive.allow-drop-table=true\n+hive.allow-rename-table=true\n+hive.allow-register-partition-procedure=true\n+hive.metastore-cache-ttl=0s\n+hive.fs.cache.max-size=10\n+hive.max-partitions-per-scan=100", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNjAyMQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547336021", "bodyText": "I guess. I took the defautl file and added last line.", "author": "losipiuk", "createdAt": "2020-12-22T15:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0MTYzMg==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547341632", "bodyText": "i figured.\nthe default hive.properties is not all-defaults, because we made it accommodate  all the many different tests we want to run on it\nyour new catalog can have -- and IMO should have -- as little configuration as possible", "author": "findepi", "createdAt": "2020-12-22T15:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM4MTgzOA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547381838", "bodyText": "I changed that. The catalog is now defined in test class.", "author": "losipiuk", "createdAt": "2020-12-22T16:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0MDYzMw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547540633", "bodyText": "I changed that. The catalog is now defined in test class.\n\nit is still here, right?\n(that's OK, i just don't understand)", "author": "findepi", "createdAt": "2020-12-22T22:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg3MzMwMA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547873300", "bodyText": "It was meant to be reply to #6424 (comment). Sorry.", "author": "losipiuk", "createdAt": "2020-12-23T09:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg3MzU1Mg==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547873552", "bodyText": "As for this one, I will get rid of as many properties as I can.", "author": "losipiuk", "createdAt": "2020-12-23T09:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg3NDg5Mw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547874893", "bodyText": "connector.name=hive-hadoop2\nhive.metastore.uri=thrift://hadoop-master:9083\nhive.config.resources=/docker/presto-product-tests/conf/presto/etc/hive-default-fs-site.xml\nhive.allow-drop-table=true\nhive.metastore-cache-ttl=0s\nhive.translate-hive-views=true\nhive.timestamp-precision=NANOSECONDS\n\nseems a safe subset", "author": "losipiuk", "createdAt": "2020-12-23T09:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNDM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNTEwMQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547325101", "bodyText": "\"not set\" \"UNSET\" -- choose one\nBTW we could explicitly reset session property here with RESET SESSION\nhttps://prestosql.io/docs/current/sql/reset-session.html", "author": "findepi", "createdAt": "2020-12-22T14:59:32Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set UNSET", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNjM0Mg==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547336342", "bodyText": "Good Idea. I did not know the syntax.", "author": "losipiuk", "createdAt": "2020-12-22T15:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNTEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNTkxOA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547325918", "bodyText": "as -> AS\nVARCHAR -> varchar\n(we tend to write SQL keywords in uppercase and identifiers in lowercase)", "author": "findepi", "createdAt": "2020-12-22T15:01:01Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set UNSET\n+        assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNzk3MA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547327970", "bodyText": "#6295 is worded as an enhancement (\"support this with that\"), but the failure looks more like a bug. Maybe we do not need to create separate bug issue, but would be worth adding a comment in this issue, sth like \"Currently this fails: \u00abstacktrace\u00bb\"", "author": "findepi", "createdAt": "2020-12-22T15:04:39Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set UNSET\n+        assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n+                () -> assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123456789\"))\n+        ).hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0ODA5OA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547348098", "bodyText": "#6295 (comment)", "author": "losipiuk", "createdAt": "2020-12-22T15:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyNzk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyOTA5Ng==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547329096", "bodyText": "link to #6295 ?", "author": "findepi", "createdAt": "2020-12-22T15:06:35Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set UNSET\n+        assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyOTk1OA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547329958", "bodyText": "include both \"actual\" and \"expect\" in this message.\nor, change to plan not-nested asssertion and use the actual wrong value in assertion, and put the expected value in a TODO comment", "author": "findepi", "createdAt": "2020-12-22T15:08:11Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set UNSET\n+        assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n+                () -> assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123456789\"))\n+        ).hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");\n+\n+        setSessionProperty(\"hive.timestamp_precision\", \"'MILLISECONDS'\");\n+        setSessionProperty(\"hive_timestamp_nanos.timestamp_precision\", \"'MILLISECONDS'\");\n+        assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n+                () -> assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"))\n+        ).hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");\n+\n+        setSessionProperty(\"hive.timestamp_precision\", \"'NANOSECONDS'\");\n+        setSessionProperty(\"hive_timestamp_nanos.timestamp_precision\", \"'NANOSECONDS'\");\n+        assertThatThrownBy(\n+                // TODO timestamp_precision has no effect on Hive views\n+                () -> assertThat(query(\"SELECT CAST(ts as VARCHAR) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123456789\"))\n+        ).hasMessageContaining(\"0 - actual:   1990-01-02 12:13:14.123|\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MTAzOA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547351038", "bodyText": "Actually I like this one more. I would rather assert for what it feels should happen and only wrap it in temporary assertThatThrownBy.\nAs for putting 1990-01-02 12:13:14.123456789 in expected message it does not give us much. There is only one row expected anyway. And we will just make test definition longer by adding that. Do you insist?", "author": "losipiuk", "createdAt": "2020-12-22T15:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyOTk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM4NDMzMw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547384333", "bodyText": "NVM. Changed.", "author": "losipiuk", "createdAt": "2020-12-22T16:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyOTk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547331943", "bodyText": "Is the behavior exactly the same for both legacy and non-legacy?", "author": "findepi", "createdAt": "2020-12-22T15:11:44Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViewsLegacy.java", "diffHunk": "@@ -241,6 +243,40 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0ODkzMw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547348933", "bodyText": "Yes. From what I have seen.", "author": "losipiuk", "createdAt": "2020-12-22T15:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzODY2NA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547538664", "bodyText": "can we have a common test code for them then? would it make sense?", "author": "findepi", "createdAt": "2020-12-22T22:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg4MDIwMQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547880201", "bodyText": "I would rather not, not a huge benefit imo. TestHiveViewsLegacy is not here to stay for a long time. For that reason, I originally decided to not tangle it with Coral test and just have a copy.", "author": "losipiuk", "createdAt": "2020-12-23T10:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMzMTgxOA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r549331818", "bodyText": "TestHiveViewsLegacy is not here to stay for a long time.\n\nI hope too, but the list in #5606 is only growing so far, so it seems fair to assume the legacy mode isn't going away any time soon.", "author": "findepi", "createdAt": "2020-12-28T12:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ4NDg2MQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r549484861", "bodyText": "I will consider extracting common superclass as a followup.", "author": "losipiuk", "createdAt": "2020-12-28T20:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMzA1Mg==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547333052", "bodyText": "Is the bucketed catalog guaranteed to always exist?\nMaybe, instead, apply the necessary setup within the test where you need this?", "author": "findepi", "createdAt": "2020-12-22T15:13:45Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/HiveQueryRunner.java", "diffHunk": "@@ -226,7 +226,9 @@ private static Session createSession(Optional<SelectedRole> role)\n     {\n         return testSessionBuilder()\n                 .setIdentity(Identity.forUser(\"hive\")\n-                        .withRoles(role.map(selectedRole -> ImmutableMap.of(\"hive\", selectedRole))\n+                        .withRoles(role.map(selectedRole -> ImmutableMap.of(\n+                                HIVE_CATALOG, selectedRole,\n+                                HIVE_BUCKETED_CATALOG, selectedRole))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MjEwMA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547352100", "bodyText": "It is defined here. So I think it should exist always. I can move this to test, but I do not see feel it is better. The proposed change seem like a decent default to me.", "author": "losipiuk", "createdAt": "2020-12-22T15:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzMzA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNDU3Mw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547334573", "bodyText": "good catch;\nthere is a  problem though that this is not actually \"hive connector's name\" (the latter being hive-hadoop2). It's TestingHiveConnectorFactory's name.\nyou can inline the constant avoiding the naming problem", "author": "findepi", "createdAt": "2020-12-22T15:16:19Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/HiveQueryRunner.java", "diffHunk": "@@ -177,8 +178,8 @@ public DistributedQueryRunner build()\n                         .put(\"hive.storage-format\", \"TEXTFILE\") // so that there's no minimum split size for the file\n                         .put(\"hive.compression-codec\", \"NONE\") // so that the file is splittable\n                         .build();\n-                queryRunner.createCatalog(HIVE_CATALOG, HIVE_CATALOG, hiveProperties);\n-                queryRunner.createCatalog(HIVE_BUCKETED_CATALOG, HIVE_CATALOG, hiveBucketedProperties);\n+                queryRunner.createCatalog(HIVE_CATALOG, HIVE_CONNECTOR_NAME, hiveProperties);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTIzMQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547335231", "bodyText": "It would be better to create this catalog only in these tests where it's used.", "author": "findepi", "createdAt": "2020-12-22T15:17:31Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/HiveQueryRunner.java", "diffHunk": "@@ -178,8 +179,14 @@ public DistributedQueryRunner build()\n                         .put(\"hive.storage-format\", \"TEXTFILE\") // so that there's no minimum split size for the file\n                         .put(\"hive.compression-codec\", \"NONE\") // so that the file is splittable\n                         .build();\n+\n+                Map<String, String> hiveTimestampNanosProperties = ImmutableMap.<String, String>builder()\n+                        .putAll(hiveProperties)\n+                        .put(\"hive.timestamp-precision\", \"NANOSECONDS\")\n+                        .build();\n                 queryRunner.createCatalog(HIVE_CATALOG, HIVE_CONNECTOR_NAME, hiveProperties);\n                 queryRunner.createCatalog(HIVE_BUCKETED_CATALOG, HIVE_CONNECTOR_NAME, hiveBucketedProperties);\n+                queryRunner.createCatalog(HIVE_TIMESTAMP_NANOS_CATALOG, HIVE_CONNECTOR_NAME, hiveTimestampNanosProperties);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1NTE0MA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547355140", "bodyText": "I do not have access to common properties in the tests, and would need to clone those. Are you worried about extra test runtime it implies?", "author": "losipiuk", "createdAt": "2020-12-22T15:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUzOTMzMw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547539333", "bodyText": "I am concerned about two things\n\nstartup time\nwe always test with two, now three, catalogs, so we cannot be sure a single catalog works on its own\n\nfeel free to disregard", "author": "findepi", "createdAt": "2020-12-22T22:33:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTM2Mw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547335363", "bodyText": "100 -> 1", "author": "findepi", "createdAt": "2020-12-22T15:17:47Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTQzMw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547335433", "bodyText": "{ next line", "author": "findepi", "createdAt": "2020-12-22T15:17:56Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTc3NA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547335774", "bodyText": "hiveTableName -> tableName\nselect_from_presto_view_hive_table_timestamps_table_ -> table_with_timestamp ?", "author": "findepi", "createdAt": "2020-12-22T15:18:35Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1NzA4Ng==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547357086", "bodyText": "I used ts_hive_table_", "author": "losipiuk", "createdAt": "2020-12-22T15:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNjg4Ng==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547336886", "bodyText": "getSession -> defaultSession (decared below)", "author": "findepi", "createdAt": "2020-12-22T15:20:34Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzAzNA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547337034", "bodyText": "defaultSession -> defaultSession\n(& below)", "author": "findepi", "createdAt": "2020-12-22T15:20:51Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzUyNQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547337525", "bodyText": "select_from_presto_view_hive_table_timestamps_default_view_ -> presto_view_ts_default ?", "author": "findepi", "createdAt": "2020-12-22T15:21:49Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .build();\n+        Session nanosSessions = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .build();\n+\n+        // Presto view created with config property set to MILLIS and session property not set\n+        String prestoViewNameDefault = \"select_from_presto_view_hive_table_timestamps_default_view_\" + randomTableSuffix();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzODM2Nw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547338367", "bodyText": "if you use assertThat(query(...))  you become free of H2 and then you can use TIMESTAMP literals in the expected query. This would avoid need for CAST AS varchar) altogether.\n(here we don't have JDBC, and we have more trust implicit trust in our internal APIs; all engine timestamp tests depend on them anyway)", "author": "findepi", "createdAt": "2020-12-22T15:23:30Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .build();\n+        Session nanosSessions = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .build();\n+\n+        // Presto view created with config property set to MILLIS and session property not set\n+        String prestoViewNameDefault = \"select_from_presto_view_hive_table_timestamps_default_view_\" + randomTableSuffix();\n+        assertUpdate(defaultSession, \"CREATE VIEW \" + prestoViewNameDefault + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM2MDQ5NQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547360495", "bodyText": "Like that?\nassertThat(query(defaultSession, \"SELECT ts FROM \" + prestoViewNameDefault)).matches(\"VALUES TIMESTAMP '1990-01-02 12:13:14.123'\");", "author": "losipiuk", "createdAt": "2020-12-22T16:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzODM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzODU1Mw==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547338553", "bodyText": "nit: no space after arrow (did checkstyle catch this?)", "author": "findepi", "createdAt": "2020-12-22T15:23:48Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .build();\n+        Session nanosSessions = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .build();\n+\n+        // Presto view created with config property set to MILLIS and session property not set\n+        String prestoViewNameDefault = \"select_from_presto_view_hive_table_timestamps_default_view_\" + randomTableSuffix();\n+        assertUpdate(defaultSession, \"CREATE VIEW \" + prestoViewNameDefault + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () ->assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM2NjMxMA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547366310", "bodyText": "Yeah - checkstyle fails on that one", "author": "losipiuk", "createdAt": "2020-12-22T16:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzODU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzODcwMA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547338700", "bodyText": "link to an issue", "author": "findepi", "createdAt": "2020-12-22T15:24:03Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .build();\n+        Session nanosSessions = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .build();\n+\n+        // Presto view created with config property set to MILLIS and session property not set\n+        String prestoViewNameDefault = \"select_from_presto_view_hive_table_timestamps_default_view_\" + randomTableSuffix();\n+        assertUpdate(defaultSession, \"CREATE VIEW \" + prestoViewNameDefault + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () ->assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        assertQuery(millisSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+        assertQuery(millisSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(nanosSessions, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(nanosSessions, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        // Presto view created with config property set to MILLIS and session property set to NANOS\n+        String prestoViewNameNanos = \"select_from_presto_view_hive_table_timestamps_millis_view_\" + randomTableSuffix();\n+        assertUpdate(nanosSessions, \"CREATE VIEW \" + prestoViewNameNanos + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameNanos, \"VALUES ('1990-01-02 12:13:14.123')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123000000]\");\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzOTM2NQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547339365", "bodyText": "Quote both expected and actual within hasMessageContaining\nor, use the actual wrong value in assertion and put the correct value in a TODO comment", "author": "findepi", "createdAt": "2020-12-22T15:25:08Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7549,6 +7549,80 @@ public void testSelectFromViewWithoutDefaultCatalogAndSchema()\n         assertQuery(sessionNoCatalog, \"SELECT count(*) FROM hive.tpch.\" + viewName, \"VALUES 1\");\n     }\n \n+    @Test(invocationCount = 100)\n+    public void testSelectFromPrestoViewReferencingHiveTableWithTimestamps() {\n+        // Hive views tests covered in TestHiveViews.testTimestampHiveView and TestHiveViesLegacy.testTimestampHiveView\n+        String hiveTableName = \"select_from_presto_view_hive_table_timestamps_table_\" + randomTableSuffix();\n+        assertUpdate(\n+                withTimestampPrecision(getSession(), HiveTimestampPrecision.NANOSECONDS),\n+                \"CREATE TABLE \" + hiveTableName + \" AS SELECT TIMESTAMP '1990-01-02 12:13:14.123456789' ts\",\n+                1);\n+\n+        Session defaultSession = getSession();\n+        Session millisSession = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"MILLISECONDS\")\n+                .build();\n+        Session nanosSessions = Session.builder(getSession())\n+                .setCatalogSessionProperty(\"hive\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .setCatalogSessionProperty(\"hive_timestamp_nanos\", \"timestamp_precision\", \"NANOSECONDS\")\n+                .build();\n+\n+        // Presto view created with config property set to MILLIS and session property not set\n+        String prestoViewNameDefault = \"select_from_presto_view_hive_table_timestamps_default_view_\" + randomTableSuffix();\n+        assertUpdate(defaultSession, \"CREATE VIEW \" + prestoViewNameDefault + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () ->assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        assertQuery(millisSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+        assertQuery(millisSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123')\");\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(nanosSessions, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(nanosSessions, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameDefault, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123]\");\n+\n+        // Presto view created with config property set to MILLIS and session property set to NANOS\n+        String prestoViewNameNanos = \"select_from_presto_view_hive_table_timestamps_millis_view_\" + randomTableSuffix();\n+        assertUpdate(nanosSessions, \"CREATE VIEW \" + prestoViewNameNanos + \" AS SELECT *  FROM \" + hiveTableName);\n+\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () -> assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM \" + prestoViewNameNanos, \"VALUES ('1990-01-02 12:13:14.123')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123000000]\");\n+        assertThatThrownBy(\n+                // TODO Presto view schema is fixed on creation\n+                () ->assertQuery(defaultSession, \"SELECT CAST(ts as VARCHAR) FROM hive_timestamp_nanos.tpch.\" + prestoViewNameNanos, \"VALUES ('1990-01-02 12:13:14.123456789')\")\n+        ).hasMessageContaining(\"Actual rows (up to 100 of 1 extra rows shown, 1 rows in total):\\n    [1990-01-02 12:13:14.123000000]\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM2NDAwNQ==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547364005", "bodyText": "Same question as above", "author": "losipiuk", "createdAt": "2020-12-22T16:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzOTM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM3Nzg2NA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547377864", "bodyText": "Migrated to \"correct value in TODO\". After migration to assertThat and getting rid fo varchar the assertion started complaining about type mismatch, not value mismatch, which was not informative enough.", "author": "losipiuk", "createdAt": "2020-12-22T16:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzOTM2NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0MDE4OA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547540188", "bodyText": "i guess code style (& checkstyle) expects ) to be on prev line", "author": "findepi", "createdAt": "2020-12-22T22:36:15Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveViews.java", "diffHunk": "@@ -295,6 +297,45 @@ public void testSelectFromHiveViewWithoutDefaultCatalogAndSchema()\n                 .containsExactly(row(1L));\n     }\n \n+    @Test\n+    public void testTimestampHiveView()\n+    {\n+        onHive().executeQuery(\"DROP TABLE IF EXISTS timestamp_hive_table\");\n+        onHive().executeQuery(\"CREATE TABLE timestamp_hive_table AS SELECT cast('1990-01-02 12:13:14.123456789' AS timestamp) ts\");\n+        onHive().executeQuery(\"DROP VIEW IF EXISTS timestamp_hive_view\");\n+        onHive().executeQuery(\"CREATE VIEW timestamp_hive_view AS SELECT * FROM timestamp_hive_table\");\n+\n+        // timestamp_precision not set\n+        unsetSessionProperty(\"hive.timestamp_precision\");\n+        unsetSessionProperty(\"hive_timestamp_nanos.timestamp_precision\");\n+\n+        assertThat(query(\"SELECT CAST(ts AS varchar) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO(https://github.com/prestosql/presto/issues/6295) it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n+                () -> assertThat(query(\"SELECT CAST(ts AS varchar) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123456789\"))\n+        ).hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");\n+\n+        setSessionProperty(\"hive.timestamp_precision\", \"'MILLISECONDS'\");\n+        setSessionProperty(\"hive_timestamp_nanos.timestamp_precision\", \"'MILLISECONDS'\");\n+\n+        assertThat(query(\"SELECT CAST(ts AS varchar) FROM timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"));\n+        assertThatThrownBy(\n+                // TODO(https://github.com/prestosql/presto/issues/6295) it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n+                () -> assertThat(query(\"SELECT CAST(ts AS varchar) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123\"))\n+        ).hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg4MjQyNA==", "url": "https://github.com/trinodb/trino/pull/6424#discussion_r547882424", "bodyText": "Acually no (at least for checkstyle).\nAs for the codestyle:\n        assertThatThrownBy(\n                // TODO(https://github.com/prestosql/presto/issues/6295) it is not possible to query Hive view with timestamps if hive.timestamp-precision=NANOSECONDS\n                () -> assertThat(query(\"SELECT CAST(ts AS varchar) FROM hive_timestamp_nanos.default.timestamp_hive_view\")).containsExactly(row(\"1990-01-02 12:13:14.123456789\")))\n                .hasMessageContaining(\"timestamp(9) projected from query view at position 0 cannot be coerced to column [ts] of type timestamp(3) stored in view definition\");\n\nlooks terrible IMO", "author": "losipiuk", "createdAt": "2020-12-23T10:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0MDE4OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "877594a9564ba15563c591efa3b1ba6270b4d946", "url": "https://github.com/trinodb/trino/commit/877594a9564ba15563c591efa3b1ba6270b4d946", "message": "Add hive_timestamp_nanos catalog to product tests", "committedDate": "2021-01-04T11:44:17Z", "type": "commit"}, {"oid": "9c9fa488b3d70b3c107fd0717a8ffac92977c589", "url": "https://github.com/trinodb/trino/commit/9c9fa488b3d70b3c107fd0717a8ffac92977c589", "message": "Extract method", "committedDate": "2021-01-04T11:58:49Z", "type": "commit"}, {"oid": "a9700be8c2338e947bed992bccf7b50b99ab6ced", "url": "https://github.com/trinodb/trino/commit/a9700be8c2338e947bed992bccf7b50b99ab6ced", "message": "Add tests for querying Hive views with timestamps", "committedDate": "2021-01-04T11:59:20Z", "type": "commit"}, {"oid": "e1c2edce17504a1f226d31b7ada949ab72bc8403", "url": "https://github.com/trinodb/trino/commit/e1c2edce17504a1f226d31b7ada949ab72bc8403", "message": "Select role for all catalogs", "committedDate": "2021-01-04T11:59:45Z", "type": "commit"}, {"oid": "f1598777851d975d89356cde5d2f6030a95471c7", "url": "https://github.com/trinodb/trino/commit/f1598777851d975d89356cde5d2f6030a95471c7", "message": "Drop improper contant use", "committedDate": "2021-01-04T12:00:13Z", "type": "commit"}, {"oid": "ec85bf063198ce5c4d3124a8a750630962f11c1b", "url": "https://github.com/trinodb/trino/commit/ec85bf063198ce5c4d3124a8a750630962f11c1b", "message": "Add test for querying Presto view referencing Hive table with timestamps", "committedDate": "2021-01-04T12:00:38Z", "type": "commit"}, {"oid": "ec85bf063198ce5c4d3124a8a750630962f11c1b", "url": "https://github.com/trinodb/trino/commit/ec85bf063198ce5c4d3124a8a750630962f11c1b", "message": "Add test for querying Presto view referencing Hive table with timestamps", "committedDate": "2021-01-04T12:00:38Z", "type": "forcePushed"}, {"oid": "8e5014f717783354a8e3c9af0777311acefda53b", "url": "https://github.com/trinodb/trino/commit/8e5014f717783354a8e3c9af0777311acefda53b", "message": "empty", "committedDate": "2021-01-04T16:10:57Z", "type": "commit"}]}