{"pr_number": 3617, "pr_title": "Change Hive $file_modified_time column to timestamp with timezone type", "pr_createdAt": "2020-05-04T20:02:30Z", "pr_url": "https://github.com/trinodb/trino/pull/3617", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0NzE3MA==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419947170", "bodyText": "I originally said UTC to answer \"but which zone?\" (timestamp with time zone requires some zone, but we have just point in time), but the zone doesn't really matter.\nWe could keep it simpler and leave this code piece intact.", "author": "findepi", "createdAt": "2020-05-05T08:34:24Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -211,7 +213,11 @@ else if (type.equals(DATE)) {\n                     prefilledValue = datePartitionKey(columnValue, name);\n                 }\n                 else if (type.equals(TIMESTAMP) || type.equals(TIMESTAMP_WITH_TIME_ZONE)) {\n-                    prefilledValue = timestampPartitionKey(columnValue, hiveStorageTimeZone, name, type.equals(TIMESTAMP_WITH_TIME_ZONE));\n+                    DateTimeZone zone = hiveStorageTimeZone;\n+                    if (isFileModifiedTimeColumnHandle(column)) {\n+                        zone = UTC;\n+                    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0ODU3Nw==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419948577", "bodyText": "Add\n// TODO introduce HiveType.HIVE_TIMESTAMP_WITH_TIME_ZONE\n\n-- we cannot add this type here before we upgrade to Hive 3.1, but we should eventually clean this up", "author": "findepi", "createdAt": "2020-05-05T08:36:57Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveColumnHandle.java", "diffHunk": "@@ -58,8 +59,8 @@\n \n     public static final int FILE_MODIFIED_TIME_COLUMN_INDEX = -14;\n     public static final String FILE_MODIFIED_TIME_COLUMN_NAME = \"$file_modified_time\";\n-    public static final HiveType FILE_MODIFIED_TIME_TYPE = HIVE_LONG;\n-    public static final Type FILE_MODIFIED_TIME_TYPE_SIGNATURE = BIGINT;\n+    public static final HiveType FILE_MODIFIED_TIME_TYPE = HiveType.HIVE_TIMESTAMP;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0ODc2Nw==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419948767", "bodyText": "ZonedDateTime -> Instant\n(file modification times are points in time, zoneless)", "author": "findepi", "createdAt": "2020-05-05T08:37:17Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -3812,17 +3813,17 @@ public void testFileModifiedTimeHiddenColumn()\n         assertEquals(getPartitions(\"test_file_modified_time\").size(), 3);\n \n         MaterializedResult results = computeActual(format(\"SELECT *, \\\"%s\\\" FROM test_file_modified_time\", FILE_MODIFIED_TIME_COLUMN_NAME));\n-        Map<Integer, Long> fileModifiedTimeMap = new HashMap<>();\n+        Map<Integer, ZonedDateTime> fileModifiedTimeMap = new HashMap<>();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI0MDg4NQ==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r420240885", "bodyText": "@findepi, I removed the fixed zone in UTC time, but had add a change to pass the hive storage zone through to here. Otherwise the time was printed in UTC but was tagged with the hiveStorageTimeZone.", "author": "alexjo2144", "createdAt": "2020-05-05T16:26:30Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -988,7 +995,7 @@ public static String getPrefilledColumnValue(HiveColumnHandle columnHandle, Hive\n             return String.valueOf(fileSize);\n         }\n         if (isFileModifiedTimeColumnHandle(columnHandle)) {\n-            return String.valueOf(fileModifiedTime);\n+            return HIVE_TIMESTAMP_PARSER.withZone(hiveStorageTimeZone).print(fileModifiedTime);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NzAyNg==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r420347026", "bodyText": "What is the value being formatted here?\nsth like\n2020-05-05T21:15:22.579\n\nor with zone\n2020-05-05T19:15:22.595Z\n\n?\nIf you format with zone, you shouldn't need hiveStorageTimeZone param\ncan you try this?", "author": "findepi", "createdAt": "2020-05-05T19:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI0MDg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MzUyNg==", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r420363526", "bodyText": "The Hive timestamp format is like the first one, without a zone. https://github.com/prestosql/presto/blob/master/presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java#L205\nThe page source is hardcoded to use this parser (without zone in the format) for all TIMESTAMP_WITH_TIME_ZONE columns including these pre-filled values. It gets around that by specifying the time zone as hiveStorageTimeZone https://github.com/prestosql/presto/blob/master/presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java#L368", "author": "alexjo2144", "createdAt": "2020-05-05T19:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI0MDg4NQ=="}], "type": "inlineReview"}, {"oid": "68eb27c27e6ba5598c81d528e1280981a0efe457", "url": "https://github.com/trinodb/trino/commit/68eb27c27e6ba5598c81d528e1280981a0efe457", "message": "Change Hive $file_modified_time column to timestamp with timezone type", "committedDate": "2020-05-05T18:18:56Z", "type": "commit"}, {"oid": "68eb27c27e6ba5598c81d528e1280981a0efe457", "url": "https://github.com/trinodb/trino/commit/68eb27c27e6ba5598c81d528e1280981a0efe457", "message": "Change Hive $file_modified_time column to timestamp with timezone type", "committedDate": "2020-05-05T18:18:56Z", "type": "forcePushed"}]}