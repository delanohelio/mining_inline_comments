{"pr_number": 5698, "pr_title": "Push complex expression filters into Glue metastore", "pr_createdAt": "2020-10-26T19:31:29Z", "pr_url": "https://github.com/trinodb/trino/pull/5698", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwMzk3NA==", "url": "https://github.com/trinodb/trino/pull/5698#discussion_r512303974", "bodyText": "What's the issue? Add some details to the commit message and a test.", "author": "martint", "createdAt": "2020-10-26T22:21:24Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/MetastoreUtil.java", "diffHunk": "@@ -441,7 +441,7 @@ else if (type instanceof TinyintType\n         for (HiveColumnHandle partitionKey : partitionKeys) {\n             String name = partitionKey.getName();\n             Domain domain = effectivePredicate.getDomains().get().get(partitionKey);\n-            if (domain != null && domain.isNullableSingleValue()) {\n+            if (domain != null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMDI2Mw==", "url": "https://github.com/trinodb/trino/pull/5698#discussion_r512320263", "bodyText": "I'll update the description and add a test for this method. There's no good way to test this end to end, as it's basically a side effect (the metastore returns the result regardless as the filter is just a hint).", "author": "electrum", "createdAt": "2020-10-26T23:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwMzk3NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMDQ0NA==", "url": "https://github.com/trinodb/trino/pull/5698#discussion_r512330444", "bodyText": "Indentation", "author": "martint", "createdAt": "2020-10-26T23:33:13Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/TestMetastoreUtil.java", "diffHunk": "@@ -153,4 +167,34 @@ public void testHiveSchemaPartition()\n         Properties actual = MetastoreUtil.getHiveSchema(ThriftMetastoreUtil.fromMetastoreApiPartition(TEST_PARTITION_WITH_UNSUPPORTED_FIELDS), ThriftMetastoreUtil.fromMetastoreApiTable(TEST_TABLE_WITH_UNSUPPORTED_FIELDS, TEST_SCHEMA));\n         assertEquals(actual, expected);\n     }\n+\n+    @Test\n+    public void testComputePartitionKeyFilter()\n+    {\n+        HiveColumnHandle dsColumn = partitionColumn(\"ds\");\n+        HiveColumnHandle typeColumn = partitionColumn(\"type\");\n+        List<HiveColumnHandle> partitionKeys = ImmutableList.of(dsColumn, typeColumn);\n+\n+        Domain dsDomain = Domain.create(ValueSet.ofRanges(Range.lessThan(VARCHAR, utf8Slice(\"2018-05-06\"))), false);\n+        Domain typeDomain = Domain.create(ValueSet.of(VARCHAR, utf8Slice(\"fruit\")), false);\n+\n+        TupleDomain<HiveColumnHandle> tupleDomain = TupleDomain.withColumnDomains(ImmutableMap.<HiveColumnHandle, Domain>builder()\n+                .put(bucketColumnHandle(), Domain.create(ValueSet.of(INTEGER, 123L), false))\n+                .put(dsColumn, dsDomain)\n+                .put(typeColumn, typeDomain)\n+                .build());\n+\n+        TupleDomain<String> filter = computePartitionKeyFilter(partitionKeys, tupleDomain);\n+        assertThat(filter.getDomains())\n+                .as(\"output contains only the partition keys\")\n+                .contains(ImmutableMap.<String, Domain>builder()\n+                .put(\"ds\", dsDomain)\n+                .put(\"type\", typeDomain)\n+                .build());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ba28c52ec7c17b34007f80c7e67ba987f3049d5", "url": "https://github.com/trinodb/trino/commit/0ba28c52ec7c17b34007f80c7e67ba987f3049d5", "message": "Push complex expression filters into Glue metastore\n\nPreviously, only single value equality filters were pushed down.", "committedDate": "2020-10-26T23:55:39Z", "type": "commit"}, {"oid": "0ba28c52ec7c17b34007f80c7e67ba987f3049d5", "url": "https://github.com/trinodb/trino/commit/0ba28c52ec7c17b34007f80c7e67ba987f3049d5", "message": "Push complex expression filters into Glue metastore\n\nPreviously, only single value equality filters were pushed down.", "committedDate": "2020-10-26T23:55:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ3MDk0Mw==", "url": "https://github.com/trinodb/trino/pull/5698#discussion_r512470943", "bodyText": "There are many layers between query and metastore communication and we already had regressions more than once. Can we also have an end-to-end test with Glue metastore showing the functionality works as intended?\nThis could go into TestHiveGlueMetastore to use real Glue. We probably should add GlueMetastoreStats metric to account for size of responses being pulled from the service.", "author": "findepi", "createdAt": "2020-10-27T07:41:09Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/TestMetastoreUtil.java", "diffHunk": "@@ -153,4 +167,34 @@ public void testHiveSchemaPartition()\n         Properties actual = MetastoreUtil.getHiveSchema(ThriftMetastoreUtil.fromMetastoreApiPartition(TEST_PARTITION_WITH_UNSUPPORTED_FIELDS), ThriftMetastoreUtil.fromMetastoreApiTable(TEST_TABLE_WITH_UNSUPPORTED_FIELDS, TEST_SCHEMA));\n         assertEquals(actual, expected);\n     }\n+\n+    @Test\n+    public void testComputePartitionKeyFilter()", "originalCommit": "0ba28c52ec7c17b34007f80c7e67ba987f3049d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3MDQxMA==", "url": "https://github.com/trinodb/trino/pull/5698#discussion_r512870410", "bodyText": "TestHiveGlueMetastore is doing low level tests of the metastore calls, so it wouldn't help with this issue. I filed #5709 to add product tests that work end-to-end.", "author": "electrum", "createdAt": "2020-10-27T17:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ3MDk0Mw=="}], "type": "inlineReview"}]}