{"pr_number": 5099, "pr_title": "Make DynamicFilter future resilient to cancel", "pr_createdAt": "2020-09-08T08:56:24Z", "pr_url": "https://github.com/trinodb/trino/pull/5099", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDkxNA==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484780914", "bodyText": "remove, we don't need to assert these in every test", "author": "sopel39", "createdAt": "2020-09-08T09:29:38Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -434,6 +435,75 @@ public void testReplicatedDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        DynamicFilterService dynamicFilterService = new DynamicFilterService(new FeaturesConfig());\n+        DynamicFilterId filterId = new DynamicFilterId(\"df\");\n+        Expression df1 = expression(\"DF_SYMBOL1\");\n+        QueryId queryId = new QueryId(\"query\");\n+        StageId stageId = new StageId(queryId, 0);\n+        List<TaskId> taskIds = ImmutableList.of(new TaskId(stageId, 0), new TaskId(stageId, 1));\n+\n+        TestDynamicFiltersStageSupplier dynamicFiltersStageSupplier = new TestDynamicFiltersStageSupplier(RUNNING);\n+        dynamicFiltersStageSupplier.addTasks(taskIds);\n+        dynamicFilterService.registerQuery(queryId, dynamicFiltersStageSupplier, ImmutableSet.of(filterId), ImmutableSet.of(filterId), ImmutableSet.of());\n+        ColumnHandle column = new TestingColumnHandle(\"probeColumnA\");\n+        DynamicFilter dynamicFilter = dynamicFilterService.createDynamicFilter(\n+                queryId,\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, df1)),\n+                ImmutableMap.of(\n+                        Symbol.from(df1), column));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        // assert initial dynamic filtering stats", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0MDk1MQ==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484940951", "bodyText": "removed", "author": "raunaqmorarka", "createdAt": "2020-09-08T13:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MDkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MTQ5NQ==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484781495", "bodyText": "remove, we don't need to test these in every test case", "author": "sopel39", "createdAt": "2020-09-08T09:30:33Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -434,6 +435,75 @@ public void testReplicatedDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        DynamicFilterService dynamicFilterService = new DynamicFilterService(new FeaturesConfig());\n+        DynamicFilterId filterId = new DynamicFilterId(\"df\");\n+        Expression df1 = expression(\"DF_SYMBOL1\");\n+        QueryId queryId = new QueryId(\"query\");\n+        StageId stageId = new StageId(queryId, 0);\n+        List<TaskId> taskIds = ImmutableList.of(new TaskId(stageId, 0), new TaskId(stageId, 1));\n+\n+        TestDynamicFiltersStageSupplier dynamicFiltersStageSupplier = new TestDynamicFiltersStageSupplier(RUNNING);\n+        dynamicFiltersStageSupplier.addTasks(taskIds);\n+        dynamicFilterService.registerQuery(queryId, dynamicFiltersStageSupplier, ImmutableSet.of(filterId), ImmutableSet.of(filterId), ImmutableSet.of());\n+        ColumnHandle column = new TestingColumnHandle(\"probeColumnA\");\n+        DynamicFilter dynamicFilter = dynamicFilterService.createDynamicFilter(\n+                queryId,\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, df1)),\n+                ImmutableMap.of(\n+                        Symbol.from(df1), column));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        // assert initial dynamic filtering stats\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getTotalDynamicFilters(), 1);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+        assertEquals(stats.getLazyDynamicFilters(), 1);\n+        assertEquals(stats.getReplicatedDynamicFilters(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 0),\n+                singleValue(INTEGER, 1L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MTgwNQ==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484781805", "bodyText": "remove, we don't need to test these in every test case", "author": "sopel39", "createdAt": "2020-09-08T09:31:00Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -434,6 +435,75 @@ public void testReplicatedDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        DynamicFilterService dynamicFilterService = new DynamicFilterService(new FeaturesConfig());\n+        DynamicFilterId filterId = new DynamicFilterId(\"df\");\n+        Expression df1 = expression(\"DF_SYMBOL1\");\n+        QueryId queryId = new QueryId(\"query\");\n+        StageId stageId = new StageId(queryId, 0);\n+        List<TaskId> taskIds = ImmutableList.of(new TaskId(stageId, 0), new TaskId(stageId, 1));\n+\n+        TestDynamicFiltersStageSupplier dynamicFiltersStageSupplier = new TestDynamicFiltersStageSupplier(RUNNING);\n+        dynamicFiltersStageSupplier.addTasks(taskIds);\n+        dynamicFilterService.registerQuery(queryId, dynamicFiltersStageSupplier, ImmutableSet.of(filterId), ImmutableSet.of(filterId), ImmutableSet.of());\n+        ColumnHandle column = new TestingColumnHandle(\"probeColumnA\");\n+        DynamicFilter dynamicFilter = dynamicFilterService.createDynamicFilter(\n+                queryId,\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, df1)),\n+                ImmutableMap.of(\n+                        Symbol.from(df1), column));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        // assert initial dynamic filtering stats\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getTotalDynamicFilters(), 1);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+        assertEquals(stats.getLazyDynamicFilters(), 1);\n+        assertEquals(stats.getReplicatedDynamicFilters(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 0),\n+                singleValue(INTEGER, 1L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+\n+        // DynamicFilter future cancellation should not affect DynamicFilterService\n+        CompletableFuture<?> isBlocked = dynamicFilter.isBlocked();\n+        assertFalse(isBlocked.isDone());\n+        assertFalse(isBlocked.cancel(false));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MjYzMQ==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484782631", "bodyText": "use cancelled isBlocked instead of new future", "author": "sopel39", "createdAt": "2020-09-08T09:32:25Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -434,6 +435,75 @@ public void testReplicatedDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        DynamicFilterService dynamicFilterService = new DynamicFilterService(new FeaturesConfig());\n+        DynamicFilterId filterId = new DynamicFilterId(\"df\");\n+        Expression df1 = expression(\"DF_SYMBOL1\");\n+        QueryId queryId = new QueryId(\"query\");\n+        StageId stageId = new StageId(queryId, 0);\n+        List<TaskId> taskIds = ImmutableList.of(new TaskId(stageId, 0), new TaskId(stageId, 1));\n+\n+        TestDynamicFiltersStageSupplier dynamicFiltersStageSupplier = new TestDynamicFiltersStageSupplier(RUNNING);\n+        dynamicFiltersStageSupplier.addTasks(taskIds);\n+        dynamicFilterService.registerQuery(queryId, dynamicFiltersStageSupplier, ImmutableSet.of(filterId), ImmutableSet.of(filterId), ImmutableSet.of());\n+        ColumnHandle column = new TestingColumnHandle(\"probeColumnA\");\n+        DynamicFilter dynamicFilter = dynamicFilterService.createDynamicFilter(\n+                queryId,\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, df1)),\n+                ImmutableMap.of(\n+                        Symbol.from(df1), column));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        // assert initial dynamic filtering stats\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getTotalDynamicFilters(), 1);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+        assertEquals(stats.getLazyDynamicFilters(), 1);\n+        assertEquals(stats.getReplicatedDynamicFilters(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 0),\n+                singleValue(INTEGER, 1L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+\n+        // DynamicFilter future cancellation should not affect DynamicFilterService\n+        CompletableFuture<?> isBlocked = dynamicFilter.isBlocked();\n+        assertFalse(isBlocked.isDone());\n+        assertFalse(isBlocked.cancel(false));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 1),\n+                singleValue(INTEGER, 2L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertTrue(dynamicFilter.isBlocked().isDone());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0MTQzNg==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484941436", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-08T13:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MjYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4MjkxMg==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484782912", "bodyText": "remove, we don't need to test these in every test case", "author": "sopel39", "createdAt": "2020-09-08T09:32:52Z", "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -434,6 +435,75 @@ public void testReplicatedDynamicFilter()\n         assertEquals(dynamicFiltersStageSupplier.getRequestCount(), 1);\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        DynamicFilterService dynamicFilterService = new DynamicFilterService(new FeaturesConfig());\n+        DynamicFilterId filterId = new DynamicFilterId(\"df\");\n+        Expression df1 = expression(\"DF_SYMBOL1\");\n+        QueryId queryId = new QueryId(\"query\");\n+        StageId stageId = new StageId(queryId, 0);\n+        List<TaskId> taskIds = ImmutableList.of(new TaskId(stageId, 0), new TaskId(stageId, 1));\n+\n+        TestDynamicFiltersStageSupplier dynamicFiltersStageSupplier = new TestDynamicFiltersStageSupplier(RUNNING);\n+        dynamicFiltersStageSupplier.addTasks(taskIds);\n+        dynamicFilterService.registerQuery(queryId, dynamicFiltersStageSupplier, ImmutableSet.of(filterId), ImmutableSet.of(filterId), ImmutableSet.of());\n+        ColumnHandle column = new TestingColumnHandle(\"probeColumnA\");\n+        DynamicFilter dynamicFilter = dynamicFilterService.createDynamicFilter(\n+                queryId,\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, df1)),\n+                ImmutableMap.of(\n+                        Symbol.from(df1), column));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        // assert initial dynamic filtering stats\n+        DynamicFiltersStats stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getTotalDynamicFilters(), 1);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+        assertEquals(stats.getLazyDynamicFilters(), 1);\n+        assertEquals(stats.getReplicatedDynamicFilters(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 0),\n+                singleValue(INTEGER, 1L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.all());\n+\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+\n+        // DynamicFilter future cancellation should not affect DynamicFilterService\n+        CompletableFuture<?> isBlocked = dynamicFilter.isBlocked();\n+        assertFalse(isBlocked.isDone());\n+        assertFalse(isBlocked.cancel(false));\n+        assertFalse(dynamicFilter.isBlocked().isDone());\n+        assertFalse(dynamicFilter.isComplete());\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);\n+        assertEquals(stats.getDynamicFiltersCompleted(), 0);\n+\n+        dynamicFiltersStageSupplier.storeSummary(\n+                filterId,\n+                new TaskId(stageId, 1),\n+                singleValue(INTEGER, 2L));\n+        dynamicFilterService.collectDynamicFilters();\n+        assertTrue(dynamicFilter.isBlocked().isDone());\n+        assertTrue(dynamicFilter.isComplete());\n+        assertEquals(dynamicFilter.getCurrentPredicate(), TupleDomain.withColumnDomains(\n+                ImmutableMap.of(column, multipleValues(INTEGER, ImmutableList.of(1L, 2L)))));\n+\n+        stats = dynamicFilterService.getDynamicFilteringStats(queryId, session);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4Mzc3Ng==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484783776", "bodyText": "use cancelled isBlocked future for assertion instead of new future", "author": "sopel39", "createdAt": "2020-09-08T09:34:12Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLocalDynamicFiltersCollector.java", "diffHunk": "@@ -63,6 +63,38 @@ public void testSingle()\n         assertEquals(filter.getCurrentPredicate(), TupleDomain.withColumnDomains(ImmutableMap.of(column, domain)));\n     }\n \n+    @Test\n+    public void testDynamicFilterCancellation()\n+    {\n+        LocalDynamicFiltersCollector collector = new LocalDynamicFiltersCollector();\n+        DynamicFilterId filterId = new DynamicFilterId(\"filter\");\n+        collector.register(ImmutableSet.of(filterId));\n+\n+        Symbol symbol = new Symbol(\"symbol\");\n+        ColumnHandle column = new TestingColumnHandle(\"column\");\n+        DynamicFilter filter = collector.createDynamicFilter(\n+                ImmutableList.of(new DynamicFilters.Descriptor(filterId, symbol.toSymbolReference())),\n+                ImmutableMap.of(symbol, column));\n+\n+        // Filter is blocked and not completed.\n+        CompletableFuture<?> isBlocked = filter.isBlocked();\n+        assertFalse(filter.isComplete());\n+        assertFalse(isBlocked.isDone());\n+        assertEquals(filter.getCurrentPredicate(), TupleDomain.all());\n+        // DynamicFilter future cancellation should not affect LocalDynamicFiltersCollector\n+        assertFalse(isBlocked.cancel(false));\n+        assertFalse(filter.isBlocked().isDone());\n+        assertFalse(filter.isComplete());\n+\n+        Domain domain = Domain.singleValue(BIGINT, 7L);\n+        collector.collectDynamicFilterDomains(ImmutableMap.of(filterId, domain));\n+\n+        // Unblocked and completed.\n+        assertTrue(filter.isComplete());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0MDY1NA==", "url": "https://github.com/trinodb/trino/pull/5099#discussion_r484940654", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-09-08T13:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4Mzc3Ng=="}], "type": "inlineReview"}, {"oid": "adf09886585285b113971e8dfaf075b3ff1335bf", "url": "https://github.com/trinodb/trino/commit/adf09886585285b113971e8dfaf075b3ff1335bf", "message": "Make DynamicFilter future resilient to cancel\n\nCancelling CompletableFuture returned by DynamicFilter#isBlocked\nshould not affect dynamic filter collection. If cancellation of\na future from a consumer of DynamicFilter is allowed to propgate\ninto DynamicFilterService or LocalDynamicFiltersCollector,\nthen it will prevent the completion of collection of that\ndynamic filter and it's usage by other consumers.", "committedDate": "2020-09-08T13:35:56Z", "type": "commit"}, {"oid": "adf09886585285b113971e8dfaf075b3ff1335bf", "url": "https://github.com/trinodb/trino/commit/adf09886585285b113971e8dfaf075b3ff1335bf", "message": "Make DynamicFilter future resilient to cancel\n\nCancelling CompletableFuture returned by DynamicFilter#isBlocked\nshould not affect dynamic filter collection. If cancellation of\na future from a consumer of DynamicFilter is allowed to propgate\ninto DynamicFilterService or LocalDynamicFiltersCollector,\nthen it will prevent the completion of collection of that\ndynamic filter and it's usage by other consumers.", "committedDate": "2020-09-08T13:35:56Z", "type": "forcePushed"}]}