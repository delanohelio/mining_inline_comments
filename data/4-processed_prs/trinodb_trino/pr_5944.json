{"pr_number": 5944, "pr_title": "Improvements to TestEventListener", "pr_createdAt": "2020-11-12T18:18:06Z", "pr_url": "https://github.com/trinodb/trino/pull/5944", "timeline": [{"oid": "b70c20a2e76f018ca42023cdcce00e92727353e3", "url": "https://github.com/trinodb/trino/commit/b70c20a2e76f018ca42023cdcce00e92727353e3", "message": "Switch actual/expected in assertion", "committedDate": "2020-11-12T17:48:01Z", "type": "commit"}, {"oid": "dd5b12100ca4d6500ec11285de5be5d24f734ffc", "url": "https://github.com/trinodb/trino/commit/dd5b12100ca4d6500ec11285de5be5d24f734ffc", "message": "Rename EventsBuilder to EventsCollector", "committedDate": "2020-11-12T17:48:01Z", "type": "commit"}, {"oid": "d47113d2d949f32f70d2932b0b2bc393137f1bce", "url": "https://github.com/trinodb/trino/commit/d47113d2d949f32f70d2932b0b2bc393137f1bce", "message": "Rename parameter", "committedDate": "2020-11-12T17:48:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzNzQ0OA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522437448", "bodyText": "perhaps it's even better when the exception is asserted in the calling code, as if using org.assertj.core.api.Assertions.catchThrowable + Assertions.assertThat", "author": "findepi", "createdAt": "2020-11-12T21:28:58Z", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsAwaitingQueries.java", "diffHunk": "@@ -43,7 +43,13 @@ MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int num\n         return runQueryAndWaitForEvents(sql, numEventsExpected, session, Optional.empty());\n     }\n \n-    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, Optional<String> expectedExceptionRegEx)\n+    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, String expectedExceptionRegEx)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk1NTE1MQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522955151", "bodyText": "Possibly. PTAL at current shape and we can make it a followup.", "author": "losipiuk", "createdAt": "2020-11-13T13:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzNzQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzODI4Nw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522438287", "bodyText": "Add simplifying override\n\n\noverride -> overload ?\nwhy one is  private and anotehr package private?", "author": "findepi", "createdAt": "2020-11-12T21:30:33Z", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsAwaitingQueries.java", "diffHunk": "@@ -43,7 +43,13 @@ MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int num\n         return runQueryAndWaitForEvents(sql, numEventsExpected, session, Optional.empty());\n     }\n \n-    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, Optional<String> expectedExceptionRegEx)\n+    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, String expectedExceptionRegEx)\n+            throws Exception\n+    {\n+        return runQueryAndWaitForEvents(sql, numEventsExpected, session, Optional.of(expectedExceptionRegEx));\n+    }\n+\n+    private MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, Optional<String> expectedExceptionRegEx)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk1NDg5MA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522954890", "bodyText": "gone", "author": "losipiuk", "createdAt": "2020-11-13T13:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzODI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzODg4NQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522438885", "bodyText": "sadly even more overloads. Maybe the simplifying one was not a good idea after all?", "author": "findepi", "createdAt": "2020-11-12T21:31:43Z", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsAwaitingQueries.java", "diffHunk": "@@ -40,19 +42,31 @@\n     MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session)\n             throws Exception\n     {\n-        return runQueryAndWaitForEvents(sql, numEventsExpected, session, Optional.empty());\n+        return runQueryAndWaitForEvents(sql, numEventsExpected, event -> true, session, Optional.empty());\n     }\n \n     MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, String expectedExceptionRegEx)\n             throws Exception\n     {\n-        return runQueryAndWaitForEvents(sql, numEventsExpected, session, Optional.of(expectedExceptionRegEx));\n+        return runQueryAndWaitForEvents(sql, numEventsExpected, event -> true, session, Optional.of(expectedExceptionRegEx));\n     }\n \n-    private MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Session session, Optional<String> expectedExceptionRegEx)\n+    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Predicate<QueryMetadata> queryFilter, Session session)\n             throws Exception\n     {\n-        eventsCollector.reset(numEventsExpected);\n+        return runQueryAndWaitForEvents(sql, numEventsExpected, queryFilter, session, Optional.empty());\n+    }\n+\n+    MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected, Predicate<QueryMetadata> queryFilter, Session session, String expectedExceptionRegEx)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkzMDM4NA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522930384", "bodyText": "I will drop it.", "author": "losipiuk", "createdAt": "2020-11-13T12:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzODg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzOTE2Nw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522439167", "bodyText": "rnn", "author": "findepi", "createdAt": "2020-11-12T21:32:17Z", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsCollector.java", "diffHunk": "@@ -38,20 +37,20 @@\n \n     public EventsCollector()\n     {\n-        this(alwaysTrue());\n+        reset(0);\n     }\n \n-    public EventsCollector(Predicate<QueryMetadata> queryFilter)\n+    public synchronized void reset(int numEvents)\n     {\n-        this.queryFilter = requireNonNull(queryFilter, \"filter is null\");\n-        reset(0);\n+        reset(0, queryMetadata -> true);\n     }\n \n-    public synchronized void reset(int numEvents)\n+    public synchronized void reset(int numEvents, Predicate<QueryMetadata> queryFilter)\n     {\n         queryCreatedEvents = ImmutableList.builder();\n         queryCompletedEvents = ImmutableList.builder();\n         splitCompletedEvents = ImmutableList.builder();\n+        this.queryFilter = queryFilter;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDA2MQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522440061", "bodyText": "You can do this fluently still\n.setSplitCompletedFilter(event -> !ignoreSplits)\n.build();", "author": "findepi", "createdAt": "2020-11-12T21:34:12Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -254,12 +260,15 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, Str\n         assertEquals(expectedFailure, failureInfo.getFailureMessage().orElse(null));\n     }\n \n-    private EventFilters buildEventFilters()\n+    private EventFilters buildEventFilters(boolean ignoreSplits)\n     {\n-        return EventFilters.builder()\n+        EventFilters.Builder builder = EventFilters.builder()\n                 .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .build();\n+                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER));\n+        if (ignoreSplits) {\n+            builder.setSplitCompletedFilter(event -> false);\n+        }\n+        return builder.build();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNzg0MA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523237840", "bodyText": "this is applied, but in the next commit, should be here, in Filter out split events from testAbortedWhileWaitingForResources", "author": "findepi", "createdAt": "2020-11-13T21:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDQ2OA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522440468", "bodyText": "GHA clock is not reliable. #5608\ncan we have marker per test instead?", "author": "findepi", "createdAt": "2020-11-12T21:34:59Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -262,12 +263,16 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n \n     private EventFilters buildEventFilters(boolean ignoreSplits)\n     {\n+        Instant now = Instant.now();\n         EventFilters.Builder builder = EventFilters.builder()\n-                .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER));\n+                .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER) && !event.getCreateTime().isBefore(now))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NzAzNw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522497037", "bodyText": "Good idea. I like it much more that the clock.", "author": "losipiuk", "createdAt": "2020-11-12T23:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk1NTMzNQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r522955335", "bodyText": "Did not get that pretty :/", "author": "losipiuk", "createdAt": "2020-11-13T13:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDQ2OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODgyMw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523238823", "bodyText": "recoreded -> recorded", "author": "findepi", "createdAt": "2020-11-13T21:21:41Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -189,17 +191,20 @@ public void testKilledWhileWaitingForResources()\n                     .build();\n             String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n \n+            // preconfigure event collector filtering so helper queries are not recoreded", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTA5Mw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523239093", "bodyText": "unused", "author": "findepi", "createdAt": "2020-11-13T21:22:18Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -260,14 +281,19 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n         assertEquals(expectedFailure, failureInfo.getFailureMessage().orElse(null));\n     }\n \n-    private EventFilters buildEventFilters(boolean ignoreSplits)\n+    private EventFilters buildEventFilters(String queryMarker, boolean ignoreSplits)\n     {\n+        Instant now = Instant.now();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTQ1OQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523239459", "bodyText": "why not event.getMetadata().getQuery().contains(queryMarker) ?", "author": "findepi", "createdAt": "2020-11-13T21:23:08Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -260,14 +281,19 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n         assertEquals(expectedFailure, failureInfo.getFailureMessage().orElse(null));\n     }\n \n-    private EventFilters buildEventFilters(boolean ignoreSplits)\n+    private EventFilters buildEventFilters(String queryMarker, boolean ignoreSplits)\n     {\n+        Instant now = Instant.now();\n         EventFilters.Builder builder = EventFilters.builder()\n-                .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER));\n-        if (ignoreSplits) {\n-            builder.setSplitCompletedFilter(event -> false);\n-        }\n+                .setQueryCreatedFilter(event -> {\n+                    boolean queryOk = event.getMetadata().getQuery().contains(queryMarker);\n+                    if (!queryOk) {\n+                        ignoredQueries.add(event.getMetadata().getQueryId());\n+                    }\n+                    return queryOk;\n+                })\n+                .setQueryCompletedFilter(event -> !ignoredQueries.contains(event.getMetadata().getQueryId()))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA4MTA1OA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524081058", "bodyText": "With ignored queries recording mechanism in place it felt natural to only look at the marker for \"create\" event. If we can get rid of that mechanism (ignoring splits events) then I will get back to using marker.", "author": "losipiuk", "createdAt": "2020-11-16T10:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTg3OQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523239879", "bodyText": "typo", "author": "findepi", "createdAt": "2020-11-13T21:24:00Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -248,10 +253,26 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n         queries.runQueryAndWaitForEvents(\n                 sql,\n                 2,\n-                buildEventFilters(ignoreSplits),\n+                buildEventFilters(sql, ignoreSplits), // we use whole sql as query marker\n                 session,\n                 Optional.of(expectedFailure));\n \n+        assertComptedEventFailure(sql, expectedFailure);\n+    }\n+\n+    private void assertFailedQueryNoReset(Session session, @Language(\"SQL\") String sql, String expectedFailure)\n+            throws Exception\n+    {\n+        queries.runQueryAndWaitForEventsNoReset(\n+                sql,\n+                session,\n+                Optional.of(expectedFailure));\n+\n+        assertComptedEventFailure(sql, expectedFailure);\n+    }\n+\n+    private void assertComptedEventFailure(@Language(\"SQL\") String sql, String expectedFailure)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDcxNQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523240715", "bodyText": "split evens complicate things because you need ignoredQueries... but in fact, it seems no-one here is testing them. Am i missing something? we could just always ignore them and adjusted number of awaited events in assertFailedQuery. We would reiterate when we add actual tests for these events", "author": "findepi", "createdAt": "2020-11-13T21:25:51Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -260,14 +281,19 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n         assertEquals(expectedFailure, failureInfo.getFailureMessage().orElse(null));\n     }\n \n-    private EventFilters buildEventFilters(boolean ignoreSplits)\n+    private EventFilters buildEventFilters(String queryMarker, boolean ignoreSplits)\n     {\n+        Instant now = Instant.now();\n         EventFilters.Builder builder = EventFilters.builder()\n-                .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER));\n-        if (ignoreSplits) {\n-            builder.setSplitCompletedFilter(event -> false);\n-        }\n+                .setQueryCreatedFilter(event -> {\n+                    boolean queryOk = event.getMetadata().getQuery().contains(queryMarker);\n+                    if (!queryOk) {\n+                        ignoredQueries.add(event.getMetadata().getQueryId());\n+                    }\n+                    return queryOk;\n+                })\n+                .setQueryCompletedFilter(event -> !ignoredQueries.contains(event.getMetadata().getQueryId()))\n+                .setSplitCompletedFilter(event -> !ignoreSplits && !ignoredQueries.contains(event.getQueryId()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5ODY3Nw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524098677", "bodyText": "Oh - good point. I was not thinking about it. Maybe we do not care about those. But on the other hand we do validate if they are sent (to some extend) via event-count assertionts. Do you think it would be ok to just ignore those?\nI think it would be nice to add a separate test to just test split events then.\n....\nBut it will open the problem with races again.", "author": "losipiuk", "createdAt": "2020-11-16T10:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MTI0Nw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523241247", "bodyText": "Instead of global state which is harder to reason about, declare AtomicReference<String> queryId as a private variable within buildEventFilters method. QueryCreatedFilter would set it and SplitCompletedFilter would use it.", "author": "findepi", "createdAt": "2020-11-13T21:27:05Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -260,14 +281,19 @@ private void assertFailedQuery(Session session, @Language(\"SQL\") String sql, boo\n         assertEquals(expectedFailure, failureInfo.getFailureMessage().orElse(null));\n     }\n \n-    private EventFilters buildEventFilters(boolean ignoreSplits)\n+    private EventFilters buildEventFilters(String queryMarker, boolean ignoreSplits)\n     {\n+        Instant now = Instant.now();\n         EventFilters.Builder builder = EventFilters.builder()\n-                .setQueryCreatedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER))\n-                .setQueryCompletedFilter(event -> !event.getMetadata().getQuery().contains(IGNORE_EVENT_MARKER));\n-        if (ignoreSplits) {\n-            builder.setSplitCompletedFilter(event -> false);\n-        }\n+                .setQueryCreatedFilter(event -> {\n+                    boolean queryOk = event.getMetadata().getQuery().contains(queryMarker);\n+                    if (!queryOk) {\n+                        ignoredQueries.add(event.getMetadata().getQueryId());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MTU5OQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r523241599", "bodyText": "i do not understand this comment. what would happen if we remove this code line?", "author": "findepi", "createdAt": "2020-11-13T21:27:59Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -189,17 +191,20 @@ public void testKilledWhileWaitingForResources()\n                     .build();\n             String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n \n+            // preconfigure event collector filtering so helper queries are not recoreded\n+            generatedEvents.reset(2, buildEventFilters(sql, true));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA4OTczOA==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524089738", "bodyText": "If we did not setup filtering in generatedEvents here we would register events coming from queries run as part of executorService.submit.", "author": "losipiuk", "createdAt": "2020-11-16T10:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MTU5OQ=="}], "type": "inlineReview"}, {"oid": "4d01635fa4fd9bd50451604ffacf3ae8710a6e91", "url": "https://github.com/trinodb/trino/commit/4d01635fa4fd9bd50451604ffacf3ae8710a6e91", "message": "Add per-event filtering to EventsCollector", "committedDate": "2020-11-16T12:25:27Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NDk5Mg==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524274992", "bodyText": "move test helper below tests", "author": "findepi", "createdAt": "2020-11-16T13:41:58Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListenerWithSplits.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.prestosql.Session;\n+import io.prestosql.connector.MockConnectorFactory;\n+import io.prestosql.execution.TestEventListenerPlugin.TestingEventListenerPlugin;\n+import io.prestosql.plugin.resourcegroups.ResourceGroupManagerPlugin;\n+import io.prestosql.plugin.tpch.TpchPlugin;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.eventlistener.QueryCompletedEvent;\n+import io.prestosql.spi.eventlistener.QueryCreatedEvent;\n+import io.prestosql.spi.eventlistener.QueryStatistics;\n+import io.prestosql.spi.eventlistener.SplitCompletedEvent;\n+import io.prestosql.spi.resourcegroups.QueryType;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.MaterializedResult;\n+import io.prestosql.testing.QueryRunner;\n+import org.intellij.lang.annotations.Language;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static io.prestosql.execution.TestQueues.createResourceGroupId;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.stream.Collectors.toSet;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test(singleThreaded = true)\n+public class TestEventListenerWithSplits\n+        extends AbstractTestQueryFramework\n+{\n+    private static final int SPLITS_PER_NODE = 3;\n+    private final EventsCollector generatedEvents = new EventsCollector();\n+    private EventsAwaitingQueries queries;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setSystemProperty(\"task_concurrency\", \"1\")\n+                .setCatalog(\"tpch\")\n+                .setSchema(\"tiny\")\n+                .setClientInfo(\"{\\\"clientVersion\\\":\\\"testVersion\\\"}\")\n+                .build();\n+\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).setNodeCount(1).build();\n+        queryRunner.installPlugin(new TpchPlugin());\n+        queryRunner.installPlugin(new TestingEventListenerPlugin(generatedEvents));\n+        queryRunner.installPlugin(new ResourceGroupManagerPlugin());\n+        queryRunner.createCatalog(\"tpch\", \"tpch\", ImmutableMap.of(\"tpch.splits-per-node\", Integer.toString(SPLITS_PER_NODE)));\n+        queryRunner.installPlugin(new Plugin()\n+        {\n+            @Override\n+            public Iterable<ConnectorFactory> getConnectorFactories()\n+            {\n+                MockConnectorFactory connectorFactory = MockConnectorFactory.builder()\n+                        .withListTables((session, s) -> ImmutableList.of(new SchemaTableName(\"default\", \"test_table\")))\n+                        .withApplyProjection((session, handle, projections, assignments) -> {\n+                            throw new RuntimeException(\"Throw from apply projection\");\n+                        })\n+                        .build();\n+                return ImmutableList.of(connectorFactory);\n+            }\n+        });\n+        queryRunner.createCatalog(\"mock\", \"mock\", ImmutableMap.of());\n+        queryRunner.getCoordinator().getResourceGroupManager().get()\n+                .setConfigurationManager(\"file\", ImmutableMap.of(\"resource-groups.config-file\", getResourceFilePath(\"resource_groups_config_simple.json\")));\n+\n+        queries = new EventsAwaitingQueries(generatedEvents, queryRunner);\n+\n+        return queryRunner;\n+    }\n+\n+    private String getResourceFilePath(String fileName)\n+    {\n+        return this.getClass().getClassLoader().getResource(fileName).getPath();\n+    }\n+\n+    private MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NTI4MQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524275281", "bodyText": "\"test SplitsFor Constant query\" ?", "author": "findepi", "createdAt": "2020-11-16T13:42:23Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListenerWithSplits.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.prestosql.Session;\n+import io.prestosql.connector.MockConnectorFactory;\n+import io.prestosql.execution.TestEventListenerPlugin.TestingEventListenerPlugin;\n+import io.prestosql.plugin.resourcegroups.ResourceGroupManagerPlugin;\n+import io.prestosql.plugin.tpch.TpchPlugin;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.connector.ConnectorFactory;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import io.prestosql.spi.eventlistener.QueryCompletedEvent;\n+import io.prestosql.spi.eventlistener.QueryCreatedEvent;\n+import io.prestosql.spi.eventlistener.QueryStatistics;\n+import io.prestosql.spi.eventlistener.SplitCompletedEvent;\n+import io.prestosql.spi.resourcegroups.QueryType;\n+import io.prestosql.testing.AbstractTestQueryFramework;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import io.prestosql.testing.MaterializedResult;\n+import io.prestosql.testing.QueryRunner;\n+import org.intellij.lang.annotations.Language;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static io.prestosql.execution.TestQueues.createResourceGroupId;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.stream.Collectors.toSet;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test(singleThreaded = true)\n+public class TestEventListenerWithSplits\n+        extends AbstractTestQueryFramework\n+{\n+    private static final int SPLITS_PER_NODE = 3;\n+    private final EventsCollector generatedEvents = new EventsCollector();\n+    private EventsAwaitingQueries queries;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setSystemProperty(\"task_concurrency\", \"1\")\n+                .setCatalog(\"tpch\")\n+                .setSchema(\"tiny\")\n+                .setClientInfo(\"{\\\"clientVersion\\\":\\\"testVersion\\\"}\")\n+                .build();\n+\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).setNodeCount(1).build();\n+        queryRunner.installPlugin(new TpchPlugin());\n+        queryRunner.installPlugin(new TestingEventListenerPlugin(generatedEvents));\n+        queryRunner.installPlugin(new ResourceGroupManagerPlugin());\n+        queryRunner.createCatalog(\"tpch\", \"tpch\", ImmutableMap.of(\"tpch.splits-per-node\", Integer.toString(SPLITS_PER_NODE)));\n+        queryRunner.installPlugin(new Plugin()\n+        {\n+            @Override\n+            public Iterable<ConnectorFactory> getConnectorFactories()\n+            {\n+                MockConnectorFactory connectorFactory = MockConnectorFactory.builder()\n+                        .withListTables((session, s) -> ImmutableList.of(new SchemaTableName(\"default\", \"test_table\")))\n+                        .withApplyProjection((session, handle, projections, assignments) -> {\n+                            throw new RuntimeException(\"Throw from apply projection\");\n+                        })\n+                        .build();\n+                return ImmutableList.of(connectorFactory);\n+            }\n+        });\n+        queryRunner.createCatalog(\"mock\", \"mock\", ImmutableMap.of());\n+        queryRunner.getCoordinator().getResourceGroupManager().get()\n+                .setConfigurationManager(\"file\", ImmutableMap.of(\"resource-groups.config-file\", getResourceFilePath(\"resource_groups_config_simple.json\")));\n+\n+        queries = new EventsAwaitingQueries(generatedEvents, queryRunner);\n+\n+        return queryRunner;\n+    }\n+\n+    private String getResourceFilePath(String fileName)\n+    {\n+        return this.getClass().getClassLoader().getResource(fileName).getPath();\n+    }\n+\n+    private MaterializedResult runQueryAndWaitForEvents(@Language(\"SQL\") String sql, int numEventsExpected)\n+            throws Exception\n+    {\n+        return queries.runQueryAndWaitForEvents(sql, numEventsExpected, getSession());\n+    }\n+\n+    @Test\n+    public void testSplitsForNormalQuery()\n+            throws Exception\n+    {\n+        // We expect the following events\n+        // QueryCreated: 1, QueryCompleted: 1, Splits: SPLITS_PER_NODE (leaf splits) + LocalExchange[SINGLE] split + Aggregation/Output split\n+        int expectedEvents = 1 + 1 + SPLITS_PER_NODE + 1 + 1;\n+        runQueryAndWaitForEvents(\"SELECT sum(linenumber) FROM lineitem\", expectedEvents);\n+\n+        QueryCreatedEvent queryCreatedEvent = getOnlyElement(generatedEvents.getQueryCreatedEvents());\n+        assertEquals(queryCreatedEvent.getContext().getServerVersion(), \"testversion\");\n+        assertEquals(queryCreatedEvent.getContext().getServerAddress(), \"127.0.0.1\");\n+        assertEquals(queryCreatedEvent.getContext().getEnvironment(), \"testing\");\n+        assertEquals(queryCreatedEvent.getContext().getClientInfo().get(), \"{\\\"clientVersion\\\":\\\"testVersion\\\"}\");\n+        assertEquals(queryCreatedEvent.getMetadata().getQuery(), \"SELECT sum(linenumber) FROM lineitem\");\n+        assertFalse(queryCreatedEvent.getMetadata().getPreparedQuery().isPresent());\n+\n+        QueryCompletedEvent queryCompletedEvent = getOnlyElement(generatedEvents.getQueryCompletedEvents());\n+        assertTrue(queryCompletedEvent.getContext().getResourceGroupId().isPresent());\n+        assertEquals(queryCompletedEvent.getContext().getResourceGroupId().get(), createResourceGroupId(\"global\", \"user-user\"));\n+        assertEquals(queryCompletedEvent.getIoMetadata().getOutput(), Optional.empty());\n+        assertEquals(queryCompletedEvent.getIoMetadata().getInputs().size(), 1);\n+        assertEquals(queryCompletedEvent.getContext().getClientInfo().get(), \"{\\\"clientVersion\\\":\\\"testVersion\\\"}\");\n+        assertEquals(getOnlyElement(queryCompletedEvent.getIoMetadata().getInputs()).getCatalogName(), \"tpch\");\n+        assertEquals(queryCreatedEvent.getMetadata().getQueryId(), queryCompletedEvent.getMetadata().getQueryId());\n+        assertFalse(queryCompletedEvent.getMetadata().getPreparedQuery().isPresent());\n+        assertEquals(queryCompletedEvent.getStatistics().getCompletedSplits(), SPLITS_PER_NODE + 2);\n+\n+        List<SplitCompletedEvent> splitCompletedEvents = generatedEvents.getSplitCompletedEvents();\n+        assertEquals(splitCompletedEvents.size(), SPLITS_PER_NODE + 2); // leaf splits + aggregation split\n+\n+        // All splits must have the same query ID\n+        Set<String> actual = splitCompletedEvents.stream()\n+                .map(SplitCompletedEvent::getQueryId)\n+                .collect(toSet());\n+        assertEquals(actual, ImmutableSet.of(queryCompletedEvent.getMetadata().getQueryId()));\n+\n+        // Sum of row count processed by all leaf stages is equal to the number of rows in the table\n+        long actualCompletedPositions = splitCompletedEvents.stream()\n+                .filter(e -> !e.getStageId().endsWith(\".0\"))    // filter out the root stage\n+                .mapToLong(e -> e.getStatistics().getCompletedPositions())\n+                .sum();\n+\n+        MaterializedResult result = runQueryAndWaitForEvents(\"SELECT count(*) FROM lineitem\", expectedEvents);\n+        long expectedCompletedPositions = (long) result.getMaterializedRows().get(0).getField(0);\n+        assertEquals(actualCompletedPositions, expectedCompletedPositions);\n+\n+        QueryStatistics statistics = queryCompletedEvent.getStatistics();\n+        // Aggregation can have memory pool usage\n+        assertTrue(statistics.getPeakUserMemoryBytes() >= 0);\n+        assertTrue(statistics.getPeakTaskUserMemory() >= 0);\n+        assertTrue(statistics.getPeakTaskTotalMemory() >= 0);\n+        assertTrue(statistics.getCumulativeMemory() >= 0);\n+\n+        // Not a write query\n+        assertEquals(statistics.getWrittenBytes(), 0);\n+        assertEquals(statistics.getWrittenRows(), 0);\n+        assertEquals(statistics.getStageGcStatistics().size(), 2);\n+\n+        // Deterministic statistics\n+        assertEquals(statistics.getPhysicalInputBytes(), 0);\n+        assertEquals(statistics.getPhysicalInputRows(), expectedCompletedPositions);\n+        assertEquals(statistics.getInternalNetworkBytes(), 369);\n+        assertEquals(statistics.getInternalNetworkRows(), 3);\n+        assertEquals(statistics.getTotalBytes(), 0);\n+        assertEquals(statistics.getOutputBytes(), 9);\n+        assertEquals(statistics.getOutputRows(), 1);\n+        assertTrue(statistics.isComplete());\n+\n+        // Check only the presence because they are non-deterministic.\n+        assertTrue(statistics.getResourceWaitingTime().isPresent());\n+        assertTrue(statistics.getAnalysisTime().isPresent());\n+        assertTrue(statistics.getPlanningTime().isPresent());\n+        assertTrue(statistics.getExecutionTime().isPresent());\n+        assertTrue(statistics.getPlanNodeStatsAndCosts().isPresent());\n+        assertTrue(statistics.getCpuTime().getSeconds() >= 0);\n+        assertTrue(statistics.getWallTime().getSeconds() >= 0);\n+        assertTrue(statistics.getCpuTimeDistribution().size() > 0);\n+        assertTrue(statistics.getOperatorSummaries().size() > 0);\n+    }\n+\n+    @Test\n+    public void testConstantQuery()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NTcwMw==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524275703", "bodyText": "why Ignore SplitCompleted events in TestEventListenerBasic changes the method to non-static?", "author": "findepi", "createdAt": "2020-11-16T13:43:03Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListenerBasic.java", "diffHunk": "@@ -107,11 +104,12 @@ protected QueryRunner createQueryRunner()\n         return queryRunner;\n     }\n \n-    private static EventFilters buildEventFilters()\n+    private EventFilters buildEventFilters()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4NDc2NQ==", "url": "https://github.com/trinodb/trino/pull/5944#discussion_r524284765", "bodyText": "conflic resolution glitch.", "author": "losipiuk", "createdAt": "2020-11-16T13:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NTcwMw=="}], "type": "inlineReview"}, {"oid": "bd2010231223eedd07ccb7524248680d010df4f8", "url": "https://github.com/trinodb/trino/commit/bd2010231223eedd07ccb7524248680d010df4f8", "message": "Split TestEventListener test class", "committedDate": "2020-11-16T13:59:24Z", "type": "commit"}, {"oid": "4f944d5b8d97c4e1023c9fd2af0f779265c8f667", "url": "https://github.com/trinodb/trino/commit/4f944d5b8d97c4e1023c9fd2af0f779265c8f667", "message": "Ignore SplitCompleted events in TestEventListenerBasic", "committedDate": "2020-11-16T13:59:25Z", "type": "commit"}, {"oid": "4f944d5b8d97c4e1023c9fd2af0f779265c8f667", "url": "https://github.com/trinodb/trino/commit/4f944d5b8d97c4e1023c9fd2af0f779265c8f667", "message": "Ignore SplitCompleted events in TestEventListenerBasic", "committedDate": "2020-11-16T13:59:25Z", "type": "forcePushed"}]}