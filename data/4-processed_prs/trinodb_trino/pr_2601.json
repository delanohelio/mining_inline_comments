{"pr_number": 2601, "pr_title": "Add support for money type in PostgreSQL connector", "pr_createdAt": "2020-01-23T22:02:51Z", "pr_url": "https://github.com/trinodb/trino/pull/2601", "timeline": [{"oid": "97a6a0476f20bd8b7ab04760634137b532bc94ba", "url": "https://github.com/trinodb/trino/commit/97a6a0476f20bd8b7ab04760634137b532bc94ba", "message": "Remove unused field", "committedDate": "2020-01-23T21:56:31Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5MjA0MQ==", "url": "https://github.com/trinodb/trino/pull/2601#discussion_r370692041", "bodyText": "Did you consider the following funciton? (It might be misleading though)\ntypedVarcharWriteFunction(\"money\"),", "author": "ebyhr", "createdAt": "2020-01-24T15:27:25Z", "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -661,6 +663,35 @@ private static SliceWriteFunction typedVarcharWriteFunction(String jdbcTypeName)\n         };\n     }\n \n+    private static ColumnMapping moneyColumnMapping()\n+    {\n+        // Money mapping can be improved when PostgreSQL gains explicit money type support.\n+        // See https://github.com/pgjdbc/pgjdbc/issues/425 for more information.\n+        return ColumnMapping.sliceMapping(\n+                VARCHAR,\n+                new SliceReadFunction()\n+                {\n+                    @Override\n+                    public boolean isNull(ResultSet resultSet, int columnIndex)\n+                            throws SQLException\n+                    {\n+                        // In PostgreSQL JDBC, money is mapped as double.\n+                        // .getObject() calls .getDouble and it fails to parse the money value.\n+                        resultSet.getString(columnIndex);\n+                        return resultSet.wasNull();\n+                    }\n+\n+                    @Override\n+                    public Slice readSlice(ResultSet resultSet, int columnIndex)\n+                            throws SQLException\n+                    {\n+                        return utf8Slice(resultSet.getString(columnIndex));\n+                    }\n+                },\n+                (statement, index, value) -> { throw new PrestoException(NOT_SUPPORTED, \"Money type is not supported for INSERT\"); },", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkzOTM3OQ==", "url": "https://github.com/trinodb/trino/pull/2601#discussion_r370939379", "bodyText": "No, i didn't, thanks for point this out.\nI don't fully understand the rules of the money type in pg.\nI sympathize a bit with pgjdbc/pgjdbc#425 (comment) .\nI'd prefer to understand the type better before unlocking writing.\nAlso, current mapping money \u2192 varchar isn't really suitable for writing.\nMapping to decimal(.., 2) sounds like a better idea, but this is much harder to implement the reading.\nPostgres returns a String like $10,000.42 and I'd need to parse it. OK, but what do i do if it returns \u00a510,000.42?\nThat's why i mapped it to varchar, without any interpretation on our side.", "author": "findepi", "createdAt": "2020-01-25T15:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5MjA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk0MDA4NQ==", "url": "https://github.com/trinodb/trino/pull/2601#discussion_r370940085", "bodyText": "I added some comment in the code.", "author": "findepi", "createdAt": "2020-01-25T15:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5MjA0MQ=="}], "type": "inlineReview"}, {"oid": "27503945b07ec6e8e47252a40303a6a5486db7b4", "url": "https://github.com/trinodb/trino/commit/27503945b07ec6e8e47252a40303a6a5486db7b4", "message": "Add support for money type in PostgreSQL\n\nPreviously, money values were mapped as double and reading would fail\nfor values great or equal to one thousand.", "committedDate": "2020-01-25T15:43:46Z", "type": "commit"}, {"oid": "27503945b07ec6e8e47252a40303a6a5486db7b4", "url": "https://github.com/trinodb/trino/commit/27503945b07ec6e8e47252a40303a6a5486db7b4", "message": "Add support for money type in PostgreSQL\n\nPreviously, money values were mapped as double and reading would fail\nfor values great or equal to one thousand.", "committedDate": "2020-01-25T15:43:46Z", "type": "forcePushed"}]}