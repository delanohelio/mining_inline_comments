{"pr_number": 3990, "pr_title": "Reduce idle CPU consumption in the resource group manager.", "pr_createdAt": "2020-06-10T16:17:17Z", "pr_url": "https://github.com/trinodb/trino/pull/3990", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDQxNQ==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440554415", "bodyText": "Note that these are not needed. query1a.complete() will automatically trigger finding and running the next query.", "author": "lhofhansl", "createdAt": "2020-06-16T02:44:51Z", "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -113,29 +112,26 @@ public void testFairEligibility()\n         assertEquals(query3a.getState(), QUEUED);\n \n         query1a.complete();\n-        root.updateGroupsAndProcessQueuedQueries();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDY5NA==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440554694", "bodyText": "No op to allow the test fine-grained control when to trigger the next query.", "author": "lhofhansl", "createdAt": "2020-06-16T02:45:42Z", "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -618,7 +609,13 @@ public void testRecursiveCpuUsageUpdate()\n     @Test(timeOut = 10_000)\n     public void testMemoryUpdateRecursively()\n     {\n-        RootInternalResourceGroup root = new RootInternalResourceGroup(\"root\", (group, export) -> {}, directExecutor());\n+        InternalResourceGroup root = new InternalResourceGroup(\"root\", (group, export) -> {}, directExecutor()) {\n+            @Override\n+            protected void triggerProcessQueuedQueries()\n+            {\n+                // NO OP", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDc1MA==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964750", "bodyText": "This should be in a comment in the code, not just in the PR.", "author": "raghavsethi", "createdAt": "2020-06-16T15:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDAzNw==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964037", "bodyText": "I think initial time here could still be small (1 seems fine). Might improve server time-to-first-query and has no cost.", "author": "raghavsethi", "createdAt": "2020-06-16T15:57:52Z", "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroupManager.java", "diffHunk": "@@ -183,7 +182,7 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 100, 100, TimeUnit.MILLISECONDS);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDg3NQ==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964875", "bodyText": "Same for the others.", "author": "raghavsethi", "createdAt": "2020-06-16T15:59:04Z", "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -756,7 +753,13 @@ public void testPriorityScheduling()\n     @Test(timeOut = 10_000)\n     public void testWeightedScheduling()\n     {\n-        RootInternalResourceGroup root = new RootInternalResourceGroup(\"root\", (group, export) -> {}, directExecutor());\n+        InternalResourceGroup root = new InternalResourceGroup(\"root\", (group, export) -> {}, directExecutor()) {\n+            @Override\n+            protected void triggerProcessQueuedQueries()\n+            {\n+                // NO OP", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NjA2Mg==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440966062", "bodyText": "Is this only for testing? If so, consider making this public, marking @VisibleForTesting, and removing this comment.", "author": "raghavsethi", "createdAt": "2020-06-16T16:00:38Z", "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroup.java", "diffHunk": "@@ -669,6 +674,32 @@ private void startInBackground(ManagedQueryExecution query)\n         }\n     }\n \n+    public void updateGroupsAndProcessQueuedQueries()\n+    {\n+        synchronized (root) {\n+            updateResourceUsageAndGetDelta();\n+\n+            while (internalStartNext()) {\n+                // start all the queries we can\n+            }\n+        }\n+    }\n+\n+    public void generateCpuQuota(long elapsedSeconds)\n+    {\n+        synchronized (root) {\n+            if (elapsedSeconds > 0) {\n+                internalGenerateCpuQuota(elapsedSeconds);\n+            }\n+        }\n+    }\n+\n+    // indirection for testing\n+    protected void triggerProcessQueuedQueries()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NzAwNA==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440967004", "bodyText": "Minor nit:\n// start as many queries as possible\nwhile (internalStartNext());", "author": "raghavsethi", "createdAt": "2020-06-16T16:02:02Z", "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroup.java", "diffHunk": "@@ -669,6 +674,32 @@ private void startInBackground(ManagedQueryExecution query)\n         }\n     }\n \n+    public void updateGroupsAndProcessQueuedQueries()\n+    {\n+        synchronized (root) {\n+            updateResourceUsageAndGetDelta();\n+\n+            while (internalStartNext()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NDE1Mg==", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r441094152", "bodyText": "Agreed. But checkStyle won't let me. :)\nI also copied it that way from RootInternalResourceGroup.", "author": "lhofhansl", "createdAt": "2020-06-16T19:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NzAwNA=="}], "type": "inlineReview"}, {"oid": "7ac782ae6f5de508a261e038615f8cfb9f202072", "url": "https://github.com/trinodb/trino/commit/7ac782ae6f5de508a261e038615f8cfb9f202072", "message": "Change resource groups to start waiting queries on query completion.\n\nPreviously, InternalResourceGroupManager woke up periodically to calculate CPU\nquotas and to unblock queries waiting to be run. Now, waiting queries are\nstarted on query completion. This change also decreases the CPU calculation\nfrequency from 1ms to 100ms, reducing idle CPU consumption.", "committedDate": "2020-06-16T19:45:20Z", "type": "commit"}]}