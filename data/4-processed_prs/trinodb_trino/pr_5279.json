{"pr_number": 5279, "pr_title": "Fix listing of tables when schema is not provided for Sheets connector", "pr_createdAt": "2020-09-23T17:13:22Z", "pr_url": "https://github.com/trinodb/trino/pull/5279", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4MzcxNg==", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r494383716", "bodyText": "would we be able to run io.prestosql.testing.AbstractTestIntegrationSmokeTest#testSelectInformationSchemaTables and testSelectInformationSchemaColumns for Google Sheets?", "author": "findepi", "createdAt": "2020-09-24T14:51:32Z", "path": "presto-google-sheets/src/test/java/io/prestosql/plugin/google/sheets/TestGoogleSheets.java", "diffHunk": "@@ -62,6 +62,8 @@ public void testListTable()\n     {\n         assertQuery(\"show tables\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");\n         assertQueryReturnsEmptyResult(\"SHOW TABLES IN gsheets.information_schema LIKE 'number_text'\");\n+        assertQuery(\"select table_name from gsheets.information_schema.tables WHERE table_schema <> 'information_schema'\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");\n+        assertQuery(\"select table_name from gsheets.information_schema.tables WHERE table_schema <> 'information_schema' LIMIT 1000\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzMzczMw==", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r495933733", "bodyText": "Once we add support for writes in sheets connector we will be able to run these tests. Or if we could push the tpch data into the sheets which is specified in the test then we could run these tests.", "author": "Praveen2112", "createdAt": "2020-09-28T13:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4MzcxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MDc0Mw==", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r502970743", "bodyText": "should we change code for SHEETS_TABLE_LOAD_ERROR to 3 to keep it sequential? (or do we need to maintain backwards compatibility for clients potentially using that code?)", "author": "phd3", "createdAt": "2020-10-11T21:55:11Z", "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsErrorCode.java", "diffHunk": "@@ -27,7 +27,6 @@\n     SHEETS_BAD_CREDENTIALS_ERROR(0, EXTERNAL),\n     SHEETS_METASTORE_ERROR(1, EXTERNAL),\n     SHEETS_UNKNOWN_TABLE_ERROR(2, USER_ERROR),\n-    SHEETS_UNKNOWN_SCHEMA_ERROR(3, USER_ERROR),\n     SHEETS_TABLE_LOAD_ERROR(4, INTERNAL_ERROR);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxNTQ2OQ==", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r503015469", "bodyText": "my understanding is that currently the only \"default\" schema is supported (apart from information schema). The \"sheetsClient\" doesn't seem to understand the concept of a \"schema\", but it is being repeatedly invoked in a loop iterating over schema objects. So there's kind of an assumption that SCHEMAS has size=1.\nI feel we could make the logic more explicit by:\n\neither making sheetsClient#getTableNames aware of schema names\nor having SheetsMetadata#listTables method explicitly check that \"default\" is the desired schema, before invoking sheetsClient#getTableNames().\n\nThoughts?", "author": "phd3", "createdAt": "2020-10-12T03:04:33Z", "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsMetadata.java", "diffHunk": "@@ -136,16 +133,15 @@ public ConnectorTableMetadata getTableMetadata(ConnectorSession session, Connect\n     @Override\n     public List<SchemaTableName> listTables(ConnectorSession session, Optional<String> schemaName)\n     {\n-        if (schemaName.isEmpty()) {\n-            throw new PrestoException(SHEETS_UNKNOWN_SCHEMA_ERROR, \"Schema not present - \" + schemaName);\n-        }\n-        if (schemaName.get().equalsIgnoreCase(\"information_schema\")) {\n-            return ImmutableList.of();\n+        ImmutableList.Builder<SchemaTableName> builder = ImmutableList.builder();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2MDY2Nw==", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r508760667", "bodyText": "Minor suggestion: using  one of the SCHEMAS or listSchemaNames() uniformly in the two lines might be easier to read.", "author": "phd3", "createdAt": "2020-10-20T18:46:03Z", "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsMetadata.java", "diffHunk": "@@ -136,16 +135,15 @@ public ConnectorTableMetadata getTableMetadata(ConnectorSession session, Connect\n     @Override\n     public List<SchemaTableName> listTables(ConnectorSession session, Optional<String> schemaName)\n     {\n-        if (schemaName.isEmpty()) {\n-            throw new PrestoException(SHEETS_UNKNOWN_SCHEMA_ERROR, \"Schema not present - \" + schemaName);\n-        }\n-        if (schemaName.get().equalsIgnoreCase(\"information_schema\")) {\n+        String schema = schemaName.orElse(getOnlyElement(SCHEMAS));\n+\n+        if (schema.equalsIgnoreCase(\"information_schema\") || !listSchemaNames().contains(schema)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96e549a0bc7558b5e0fb023bbb367534a0af23c9", "url": "https://github.com/trinodb/trino/commit/96e549a0bc7558b5e0fb023bbb367534a0af23c9", "message": "Fix listing of tables when schema is not provided", "committedDate": "2020-10-21T12:43:06Z", "type": "commit"}, {"oid": "96e549a0bc7558b5e0fb023bbb367534a0af23c9", "url": "https://github.com/trinodb/trino/commit/96e549a0bc7558b5e0fb023bbb367534a0af23c9", "message": "Fix listing of tables when schema is not provided", "committedDate": "2020-10-21T12:43:06Z", "type": "forcePushed"}]}