{"pr_number": 2685, "pr_title": "Fix LocalDynamicFiltersCollector#getPredicate for multiple co-located joins", "pr_createdAt": "2020-01-30T18:48:01Z", "pr_url": "https://github.com/trinodb/trino/pull/2685", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMjU3Mg==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373822572", "bodyText": "nit: consider renaming scanAssignments to probeSymbols (since \"assignments\" term is usually used for Assignments instances, IIUC).", "author": "rzeyde-varada", "createdAt": "2020-02-02T06:24:14Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +32,32 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Map<Symbol, Domain> dynamicFilterDomainsResult = new HashMap<>();\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Collection<Symbol> scanAssignments)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyMTkwMg==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373921902", "bodyText": "yes, should have been probeSymbols, renamed it now", "author": "raunaqmorarka", "createdAt": "2020-02-03T04:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMjU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMjc2Ng==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373822766", "bodyText": "nit: consider using Map#merge() here, e.g.:\ndynamicFilterDomains.merge(entry.getKey(), entry.getValue(), Domain::intersect);", "author": "rzeyde-varada", "createdAt": "2020-02-02T06:27:59Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +32,32 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Map<Symbol, Domain> dynamicFilterDomainsResult = new HashMap<>();\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Collection<Symbol> scanAssignments)\n     {\n-        return predicate;\n+        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+        for (Symbol symbol : scanAssignments) {\n+            Domain domain = dynamicFilterDomainsResult.get(symbol);\n+            if (domain != null) {\n+                builder.put(symbol, domain);\n+            }\n+        }\n+        return TupleDomain.withColumnDomains(builder.build());\n     }\n \n-    public synchronized void intersect(TupleDomain<Symbol> predicate)\n+    // Domains for different subset of dynamic filters maybe requested by different table scans,\n+    // therefore we record and intersect Domain of each dynamic filter separately instead of in a combined TupleDomain\n+    public synchronized void intersect(Map<Symbol, Domain> dynamicFilterDomains)\n     {\n-        this.predicate = this.predicate.intersect(predicate);\n+        for (Map.Entry<Symbol, Domain> entry : dynamicFilterDomains.entrySet()) {\n+            Domain intersectionDomain = dynamicFilterDomainsResult.get(entry.getKey());\n+            if (intersectionDomain == null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyMTk3OQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373921979", "bodyText": "done, thanks", "author": "raunaqmorarka", "createdAt": "2020-02-03T04:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMjc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMzY2MQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373823661", "bodyText": "nit: consider using Map#getOrDefault here.", "author": "rzeyde-varada", "createdAt": "2020-02-02T06:46:17Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -82,29 +89,43 @@ private synchronized void addPartition(TupleDomain<String> tupleDomain)\n         result = TupleDomain.columnWiseUnion(result, tupleDomain);\n         if (partitionsLeft == 0) {\n             // No more partitions are left to be processed.\n-            verify(resultFuture.set(convertTupleDomain(result)), \"dynamic filter result is provided more than once\");\n+            verify(resultFuture.set(toDomainMap(result)), \"dynamic filter result is provided more than once\");\n         }\n     }\n \n-    private TupleDomain<Symbol> convertTupleDomain(TupleDomain<String> result)\n+    // We convert TupleDomain to Map<dynamic filter, Domain> with Domain.all/none stored explicitly\n+    // so that LocalDynamicFiltersCollector can correctly report Domains for any subset of dynamic filters\n+    private Map<Symbol, Domain> toDomainMap(TupleDomain<String> result)\n     {\n+        // Convert the predicate to use probe symbols (instead of dynamic filter IDs).\n+        // Note that in case of a probe-side union, a single dynamic filter may match multiple probe symbols.\n         if (result.isNone()) {\n-            return TupleDomain.none();\n+            ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+            for (Map.Entry<String, Type> entry : filterTypes.entrySet()) {\n+                // Store all matching symbols for each build channel index.\n+                for (Symbol probeSymbol : probeSymbols.get(entry.getKey())) {\n+                    builder.put(probeSymbol, Domain.none(entry.getValue()));\n+                }\n+            }\n+            return builder.build();\n         }\n-        // Convert the predicate to use probe symbols (instead dynamic filter IDs).\n-        // Note that in case of a probe-side union, a single dynamic filter may match multiple probe symbols.\n+\n         ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n-        for (Map.Entry<String, Domain> entry : result.getDomains().get().entrySet()) {\n-            Domain domain = entry.getValue();\n+        Map<String, Domain> domains = result.getDomains().get();\n+        for (Map.Entry<String, Type> entry : filterTypes.entrySet()) {\n+            Domain domain = domains.get(entry.getKey());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyMjAyOQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r373922029", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-03T04:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyMzY2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA2MzgyOQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374063829", "bodyText": "commit message is too long", "author": "sopel39", "createdAt": "2020-02-03T11:59:22Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -21,6 +21,7 @@\n import io.airlift.log.Logger;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2ODgzOQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374168839", "bodyText": "shortened it", "author": "raunaqmorarka", "createdAt": "2020-02-03T15:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA2MzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3ODM3MA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374078370", "bodyText": "Make probeSymbols a Set to explicitly avoid duplicates", "author": "sopel39", "createdAt": "2020-02-03T12:36:59Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +32,26 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Map<Symbol, Domain> dynamicFilterDomainsResult = new HashMap<>();\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Collection<Symbol> probeSymbols)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2ODcwMQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374168701", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-03T15:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3ODM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3OTcwMA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374079700", "bodyText": "LocalDynamicFilter is created per join node. Therefore TupleDomain should be fine here (empty domain means join filters everything)", "author": "sopel39", "createdAt": "2020-02-03T12:40:26Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -52,20 +53,26 @@\n     // Mapping from dynamic filter ID to its build channel indices.\n     private final Map<String, Integer> buildChannels;\n \n-    private final SettableFuture<TupleDomain<Symbol>> resultFuture;\n+    // Mapping from dynamic filter ID to its build channel type.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2OTA4OA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374169088", "bodyText": "Simplified to make changes only in LocalDynamicFiltersCollector", "author": "raunaqmorarka", "createdAt": "2020-02-03T15:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA3OTcwMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2ODQ0Mg==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374568442", "bodyText": "let's rename this method to addDynamicFilter ane make it accept Map<Symbol, Domain>\nMake io.prestosql.sql.planner.LocalDynamicFilter#getResultFuture return Map<Symbol, Domain>, but make conversion from TupleDomain<String> to Map<Symbol, Domain> in io.prestosql.sql.planner.LocalDynamicFilter#convertTupleDomain", "author": "sopel39", "createdAt": "2020-02-04T09:48:32Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +33,37 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Optional<Map<Symbol, Domain>> dynamicFilterDomainsResult = Optional.of(new HashMap<>());\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Set<Symbol> probeSymbols)\n     {\n-        return predicate;\n+        if (!dynamicFilterDomainsResult.isPresent()) {\n+            return TupleDomain.none();\n+        }\n+        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+        Map<Symbol, Domain> domains = dynamicFilterDomainsResult.get();\n+        for (Symbol symbol : probeSymbols) {\n+            Domain domain = domains.get(symbol);\n+            if (domain != null) {\n+                builder.put(symbol, domain);\n+            }\n+        }\n+        return TupleDomain.withColumnDomains(builder.build());\n     }\n \n+    // Domains for different subset of dynamic filters maybe requested by different table scans,\n+    // therefore we record and intersect Domain of each dynamic filter separately instead of in a combined TupleDomain\n     public synchronized void intersect(TupleDomain<Symbol> predicate)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxOTg2MA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374819860", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-04T17:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2ODQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2ODc5NQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374568795", "bodyText": "you shouldn't set entire map to empty. It might contain predicates for other joins", "author": "sopel39", "createdAt": "2020-02-04T09:49:11Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +33,37 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Optional<Map<Symbol, Domain>> dynamicFilterDomainsResult = Optional.of(new HashMap<>());\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Set<Symbol> probeSymbols)\n     {\n-        return predicate;\n+        if (!dynamicFilterDomainsResult.isPresent()) {\n+            return TupleDomain.none();\n+        }\n+        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+        Map<Symbol, Domain> domains = dynamicFilterDomainsResult.get();\n+        for (Symbol symbol : probeSymbols) {\n+            Domain domain = domains.get(symbol);\n+            if (domain != null) {\n+                builder.put(symbol, domain);\n+            }\n+        }\n+        return TupleDomain.withColumnDomains(builder.build());\n     }\n \n+    // Domains for different subset of dynamic filters maybe requested by different table scans,\n+    // therefore we record and intersect Domain of each dynamic filter separately instead of in a combined TupleDomain\n     public synchronized void intersect(TupleDomain<Symbol> predicate)\n     {\n-        this.predicate = this.predicate.intersect(predicate);\n+        if (predicate.isNone()) {\n+            dynamicFilterDomainsResult = Optional.empty();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3MDM1MA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374570350", "bodyText": "I would rename this method to be more explicit, e.g\ngetDynamicFilter", "author": "sopel39", "createdAt": "2020-02-04T09:51:58Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +33,37 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Optional<Map<Symbol, Domain>> dynamicFilterDomainsResult = Optional.of(new HashMap<>());\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Set<Symbol> probeSymbols)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3MzE4NQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374573185", "bodyText": "comment for the future\nTBH: now I think LocalDynamicFilter has too big responsibility. It should produce TupleDomain<String> (where string is filter id) instead of TupleDomain<Symbol>.\nEach table scan should translate String -> Symbol itself.", "author": "sopel39", "createdAt": "2020-02-04T09:57:20Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -13,11 +13,18 @@\n  */\n package io.prestosql.sql.planner;\n \n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.predicate.Domain;\n import io.prestosql.spi.predicate.TupleDomain;\n \n import javax.annotation.concurrent.GuardedBy;\n import javax.annotation.concurrent.ThreadSafe;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n @ThreadSafe\n class LocalDynamicFiltersCollector", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3NzA3OQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374577079", "bodyText": "Don't need optional here, use empty map initially.", "author": "sopel39", "createdAt": "2020-02-04T10:04:49Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +33,37 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Optional<Map<Symbol, Domain>> dynamicFilterDomainsResult = Optional.of(new HashMap<>());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4MDU1MA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r374580550", "bodyText": "remove this comment (I don't think it will be relevant)", "author": "sopel39", "createdAt": "2020-02-04T10:11:36Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +33,37 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Optional<Map<Symbol, Domain>> dynamicFilterDomainsResult = Optional.of(new HashMap<>());\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getPredicate(Set<Symbol> probeSymbols)\n     {\n-        return predicate;\n+        if (!dynamicFilterDomainsResult.isPresent()) {\n+            return TupleDomain.none();\n+        }\n+        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+        Map<Symbol, Domain> domains = dynamicFilterDomainsResult.get();\n+        for (Symbol symbol : probeSymbols) {\n+            Domain domain = domains.get(symbol);\n+            if (domain != null) {\n+                builder.put(symbol, domain);\n+            }\n+        }\n+        return TupleDomain.withColumnDomains(builder.build());\n     }\n \n+    // Domains for different subset of dynamic filters maybe requested by different table scans,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MjYxMg==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375142612", "bodyText": "you could use stream here:\nbuildChannels.keySet().stream()\n  .flatMap(filterId -> probeSymbols.get(filderId).stream())\n  .collect(toImmutableMap(probeSymbol -> probeSymbol, omain.none(types.get(probeSymbol)));", "author": "sopel39", "createdAt": "2020-02-05T09:27:49Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -86,10 +89,17 @@ private synchronized void addPartition(TupleDomain<String> tupleDomain)\n         }\n     }\n \n-    private TupleDomain<Symbol> convertTupleDomain(TupleDomain<String> result)\n+    private Map<Symbol, Domain> convertTupleDomain(TupleDomain<String> result)\n     {\n         if (result.isNone()) {\n-            return TupleDomain.none();\n+            ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNzEyNw==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375217127", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MjYxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0Mjg1NA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375142854", "bodyText": "use stream here also.", "author": "sopel39", "createdAt": "2020-02-05T09:28:16Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -86,10 +89,17 @@ private synchronized void addPartition(TupleDomain<String> tupleDomain)\n         }\n     }\n \n-    private TupleDomain<Symbol> convertTupleDomain(TupleDomain<String> result)\n+    private Map<Symbol, Domain> convertTupleDomain(TupleDomain<String> result)\n     {\n         if (result.isNone()) {\n-            return TupleDomain.none();\n+            ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n+            for (String filterId : buildChannels.keySet()) {\n+                // Store all matching symbols for each build channel index.\n+                for (Symbol probeSymbol : probeSymbols.get(filterId)) {\n+                    builder.put(probeSymbol, Domain.none(types.get(probeSymbol)));\n+                }\n+            }\n+            return builder.build();\n         }\n         // Convert the predicate to use probe symbols (instead dynamic filter IDs).\n         // Note that in case of a probe-side union, a single dynamic filter may match multiple probe symbols.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNjU0Ng==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375216546", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0Mjg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzgyMQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375143821", "bodyText": "you could add a similar comment:\none of the join build symbols has no non-null values, therefore no symbols can match predicate", "author": "sopel39", "createdAt": "2020-02-05T09:30:14Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -86,10 +89,17 @@ private synchronized void addPartition(TupleDomain<String> tupleDomain)\n         }\n     }\n \n-    private TupleDomain<Symbol> convertTupleDomain(TupleDomain<String> result)\n+    private Map<Symbol, Domain> convertTupleDomain(TupleDomain<String> result)\n     {\n         if (result.isNone()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNjQxMw==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375216413", "bodyText": "added", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0Mzk4Ng==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375143986", "bodyText": "use streams here", "author": "sopel39", "createdAt": "2020-02-05T09:30:36Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFiltersCollector.java", "diffHunk": "@@ -26,20 +32,24 @@\n      * (e.g. in case of co-located joins).\n      */\n     @GuardedBy(\"this\")\n-    private TupleDomain<Symbol> predicate;\n-\n-    public LocalDynamicFiltersCollector()\n-    {\n-        this.predicate = TupleDomain.all();\n-    }\n+    private Map<Symbol, Domain> dynamicFilterDomainsResult = new HashMap<>();\n \n-    public synchronized TupleDomain<Symbol> getPredicate()\n+    public synchronized TupleDomain<Symbol> getDynamicFilter(Set<Symbol> probeSymbols)\n     {\n-        return predicate;\n+        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNjk0MA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375216940", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0Mzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NTkzOQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375145939", "bodyText": "Please also make sure that adding none domain for particular symbol doesn't affect other symbols (set them to none domain too)", "author": "sopel39", "createdAt": "2020-02-05T09:34:27Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLocalDynamicFiltersCollector.java", "diffHunk": "@@ -29,25 +33,64 @@\n     public void testCollector()\n     {\n         Symbol symbol = new Symbol(\"symbol\");\n+        Set<Symbol> probeSymbols = ImmutableSet.of(symbol);\n \n         LocalDynamicFiltersCollector collector = new LocalDynamicFiltersCollector();\n-        assertEquals(collector.getPredicate(), TupleDomain.all());\n+        assertEquals(collector.getDynamicFilter(probeSymbols), TupleDomain.all());\n \n-        collector.intersect(TupleDomain.all());\n-        assertEquals(collector.getPredicate(), TupleDomain.all());\n+        collector.addDynamicFilter(ImmutableMap.of());\n+        assertEquals(collector.getDynamicFilter(probeSymbols), TupleDomain.all());\n \n-        collector.intersect(tupleDomain(symbol, 1L, 2L));\n-        assertEquals(collector.getPredicate(), tupleDomain(symbol, 1L, 2L));\n+        collector.addDynamicFilter(toDomainMap(symbol, 1L, 2L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols), tupleDomain(symbol, 1L, 2L));\n \n-        collector.intersect(tupleDomain(symbol, 2L, 3L));\n-        assertEquals(collector.getPredicate(), tupleDomain(symbol, 2L));\n+        collector.addDynamicFilter(toDomainMap(symbol, 2L, 3L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols), tupleDomain(symbol, 2L));\n \n-        collector.intersect(tupleDomain(symbol, 0L));\n-        assertEquals(collector.getPredicate(), TupleDomain.none());\n+        collector.addDynamicFilter(toDomainMap(symbol, 0L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols), TupleDomain.none());\n+    }\n+\n+    @Test\n+    public void testCollectorMultipleScans()\n+    {\n+        Symbol symbol1 = new Symbol(\"symbol1\");\n+        Symbol symbol2 = new Symbol(\"symbol2\");\n+        Set<Symbol> probeSymbols1 = ImmutableSet.of(symbol1);\n+        Set<Symbol> probeSymbols2 = ImmutableSet.of(symbol2);\n+\n+        LocalDynamicFiltersCollector collector = new LocalDynamicFiltersCollector();\n+        assertEquals(collector.getDynamicFilter(probeSymbols1), TupleDomain.all());\n+        assertEquals(collector.getDynamicFilter(probeSymbols2), TupleDomain.all());\n+\n+        collector.addDynamicFilter(toDomainMap(symbol1, 1L, 2L));\n+        collector.addDynamicFilter(toDomainMap(symbol2, 2L, 3L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols1), tupleDomain(symbol1, 1L, 2L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols2), tupleDomain(symbol2, 2L, 3L));\n+        assertEquals(collector.getDynamicFilter(\n+                ImmutableSet.of(symbol1, symbol2)),\n+                TupleDomain.withColumnDomains(ImmutableMap.of(\n+                        symbol1, Domain.multipleValues(BIGINT, ImmutableList.of(1L, 2L)),\n+                        symbol2, Domain.multipleValues(BIGINT, ImmutableList.of(2L, 3L)))));\n+\n+        collector.addDynamicFilter(toDomainMap(symbol1, 0L));\n+        assertEquals(collector.getDynamicFilter(probeSymbols1), TupleDomain.none());\n+        assertEquals(collector.getDynamicFilter(probeSymbols2), tupleDomain(symbol2, 2L, 3L));\n+        assertEquals(collector.getDynamicFilter(ImmutableSet.of(symbol1, symbol2)), TupleDomain.none());\n+\n+        collector.addDynamicFilter(ImmutableMap.of(symbol2, Domain.none(BIGINT)));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNzQxMA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375217410", "bodyText": "Added another test case TestLocalDynamicFiltersCollector#testCollectorMultipleScansNone", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NTkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NzA2MQ==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375147061", "bodyText": "change it to consumer.accept(TupleDomain.none())", "author": "sopel39", "createdAt": "2020-02-05T09:36:41Z", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLocalDynamicFilter.java", "diffHunk": "@@ -128,17 +132,18 @@ public void testNone()\n         LocalDynamicFilter filter = new LocalDynamicFilter(\n                 ImmutableMultimap.of(\"123\", new Symbol(\"a\")),\n                 ImmutableMap.of(\"123\", 0),\n+                TypeProvider.copyOf(ImmutableMap.of(new Symbol(\"a\"), INTEGER)),\n                 1);\n         assertEquals(filter.getBuildChannels(), ImmutableMap.of(\"123\", 0));\n         Consumer<TupleDomain<String>> consumer = filter.getTupleDomainConsumer();\n-        ListenableFuture<TupleDomain<Symbol>> result = filter.getResultFuture();\n+        ListenableFuture<Map<Symbol, Domain>> result = filter.getResultFuture();\n \n         assertFalse(result.isDone());\n         consumer.accept(TupleDomain.withColumnDomains(ImmutableMap.of(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNjgzNw==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375216837", "bodyText": "done", "author": "raunaqmorarka", "createdAt": "2020-02-05T12:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0NzA2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcyNDkwMg==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375724902", "bodyText": "I think loop was better here, please revert. Sorry", "author": "sopel39", "createdAt": "2020-02-06T09:31:56Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -86,25 +90,23 @@ private synchronized void addPartition(TupleDomain<String> tupleDomain)\n         }\n     }\n \n-    private TupleDomain<Symbol> convertTupleDomain(TupleDomain<String> result)\n+    private Map<Symbol, Domain> convertTupleDomain(TupleDomain<String> result)\n     {\n         if (result.isNone()) {\n-            return TupleDomain.none();\n+            // One of the join build symbols has no non-null values, therefore no symbols can match predicate\n+            return buildChannels.keySet().stream()\n+                    .flatMap(filterId -> probeSymbols.get(filterId).stream())\n+                    .collect(toImmutableMap(identity(), probeSymbol -> Domain.none(types.get(probeSymbol))));\n         }\n         // Convert the predicate to use probe symbols (instead dynamic filter IDs).\n         // Note that in case of a probe-side union, a single dynamic filter may match multiple probe symbols.\n-        ImmutableMap.Builder<Symbol, Domain> builder = ImmutableMap.builder();\n-        for (Map.Entry<String, Domain> entry : result.getDomains().get().entrySet()) {\n-            Domain domain = entry.getValue();\n-            // Store all matching symbols for each build channel index.\n-            for (Symbol probeSymbol : probeSymbols.get(entry.getKey())) {\n-                builder.put(probeSymbol, domain);\n-            }\n-        }\n-        return TupleDomain.withColumnDomains(builder.build());\n+        return result.getDomains().get().entrySet().stream()\n+                .flatMap(entry -> probeSymbols.get(entry.getKey()).stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc1NTAwMA==", "url": "https://github.com/trinodb/trino/pull/2685#discussion_r375755000", "bodyText": "np, reverted", "author": "raunaqmorarka", "createdAt": "2020-02-06T10:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcyNDkwMg=="}], "type": "inlineReview"}, {"oid": "edf7fbf59523a7570c7ddb279abbd5dd23729f7f", "url": "https://github.com/trinodb/trino/commit/edf7fbf59523a7570c7ddb279abbd5dd23729f7f", "message": "Fix LocalDynamicFiltersCollector#getPredicate for multiple co-located joins", "committedDate": "2020-02-06T10:29:35Z", "type": "commit"}, {"oid": "edf7fbf59523a7570c7ddb279abbd5dd23729f7f", "url": "https://github.com/trinodb/trino/commit/edf7fbf59523a7570c7ddb279abbd5dd23729f7f", "message": "Fix LocalDynamicFiltersCollector#getPredicate for multiple co-located joins", "committedDate": "2020-02-06T10:29:35Z", "type": "forcePushed"}]}