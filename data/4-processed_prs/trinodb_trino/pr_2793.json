{"pr_number": 2793, "pr_title": "enable dynamic filtering by default", "pr_createdAt": "2020-02-11T13:09:19Z", "pr_url": "https://github.com/trinodb/trino/pull/2793", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxMTQxOQ==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r381511419", "bodyText": "Since we are using a new instance of StatsRecordingPlanOptimizer for the 3 places where PredicatePushDown rule is applied, it looks like this will reset the stats each time for this rule (Check OptimizerStatsRecorder#register). Is that ok ? I think we would want to know the combined time taken of PredicatePushDown rule in all the invocations or record them all separately.", "author": "raunaqmorarka", "createdAt": "2020-02-19T19:59:05Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -405,7 +403,7 @@ public PlanOptimizers(\n                 new CheckSubqueryNodesAreRewritten(),\n                 new StatsRecordingPlanOptimizer(\n                         optimizerStats,\n-                        new PredicatePushDown(metadata, typeAnalyzer, false)),\n+                        new StatsRecordingPlanOptimizer(optimizerStats, new PredicatePushDown(metadata, typeAnalyzer, false, false))),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0MDQwMQ==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382940401", "bodyText": "I will report to same optimizerStats every time, so it accumulates stats for PredicatePushDown", "author": "sopel39", "createdAt": "2020-02-22T20:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxMTQxOQ=="}], "type": "inlineReview"}, {"oid": "61d4609a49d270c64805db9e903d5a9887d0c6ef", "url": "https://github.com/trinodb/trino/commit/61d4609a49d270c64805db9e903d5a9887d0c6ef", "message": "Fix removal of dynamic filters within join filter condition", "committedDate": "2020-02-22T20:36:26Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0Mzc1OQ==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382943759", "bodyText": "Typo in commit message: \"Prediacate\"", "author": "martint", "createdAt": "2020-02-22T21:44:32Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -279,8 +279,6 @@ public PlanOptimizers(\n                         .add(new RemoveTrivialFilters())", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0Mzk4MA==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382943980", "bodyText": "Hmm... this is going to have to change once we move PredicatePushdown to the iterative optimizer, as it will be interleaved with all other rules.", "author": "martint", "createdAt": "2020-02-22T21:48:18Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -407,7 +405,7 @@ public PlanOptimizers(\n                 new CheckSubqueryNodesAreRewritten(),\n                 new StatsRecordingPlanOptimizer(\n                         optimizerStats,\n-                        new PredicatePushDown(metadata, typeAnalyzer, false)),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM0NzYxMA==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r386347610", "bodyText": "Yup. I think in this case it might be relatively easy to remove this dependency, so that dynamic filters don't change existing plans. I just didn't want to dig into this particular issue", "author": "sopel39", "createdAt": "2020-03-02T11:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0Mzk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0NDA5NA==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382944094", "bodyText": "Can you add some details to the commit message explaining the motivation? I..e, what about grouped execution makes it incompatible with dynamic filters?", "author": "martint", "createdAt": "2020-02-22T21:50:11Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -2042,7 +2042,7 @@ private PhysicalOperation createLookupJoin(\n             ImmutableList.Builder<OperatorFactory> factoriesBuilder = new ImmutableList.Builder<>();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0NDY1MQ==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382944651", "bodyText": "Can you add some details to the commit message explaining the motivation?", "author": "martint", "createdAt": "2020-02-22T21:59:16Z", "path": "presto-main/src/main/java/io/prestosql/split/PageSourceManager.java", "diffHunk": "@@ -13,15 +13,13 @@\n  */", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0NDY3NQ==", "url": "https://github.com/trinodb/trino/pull/2793#discussion_r382944675", "bodyText": "Same here, can you add a comment in the commit message explaining the motivation?", "author": "martint", "createdAt": "2020-02-22T21:59:49Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSourceProvider.java", "diffHunk": "@@ -117,7 +117,7 @@ public ConnectorPageSource createPageSource(ConnectorTransactionHandle transacti\n                 hiveSplit.getFileSize(),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63ddf227e74bdcf9f330b4c99e0efc1e8d3ee120", "url": "https://github.com/trinodb/trino/commit/63ddf227e74bdcf9f330b4c99e0efc1e8d3ee120", "message": "Pushdown dynamic filters after reorder joins\n\nPredicate pushdown pushes dynamic filters down\nthe plan. At the end of planning, dynamic filters\nare removed from places where they are not valid (e.g build side,\nnested predicates). Because of this reorder joins should\noperate on plan that doesn't have dynamic filters as it might\ncause stats and cost misestimates.", "committedDate": "2020-03-02T11:47:46Z", "type": "commit"}, {"oid": "147e9f7ef728a8666edffd8af841d4e8351fa21d", "url": "https://github.com/trinodb/trino/commit/147e9f7ef728a8666edffd8af841d4e8351fa21d", "message": "Remove redundant isEnableDynamicFiltering check\n\nWhen isEnableDynamicFiltering is disabled, then\ndynamic filters won't be added by planner.", "committedDate": "2020-03-02T11:47:55Z", "type": "commit"}, {"oid": "86808348d2af56f18b701700e41e4f927d30bbc7", "url": "https://github.com/trinodb/trino/commit/86808348d2af56f18b701700e41e4f927d30bbc7", "message": "Restore table scan printing of dynamic filters", "committedDate": "2020-03-02T11:47:55Z", "type": "commit"}, {"oid": "6782d7e0bbea34d6b89512a9391254fcf5a8e156", "url": "https://github.com/trinodb/trino/commit/6782d7e0bbea34d6b89512a9391254fcf5a8e156", "message": "Add check that dynamic filtering is not enabled with grouped execution\n\nDynamic filtering assumes that join build side is evaulated fixed\n(task_concurrency) amount of times. This constraint is not satisfied\nwhen grouped execution is enabled.", "committedDate": "2020-03-02T11:53:09Z", "type": "commit"}, {"oid": "26f118ad2d06760d3a2148f4e181ef517f2e7922", "url": "https://github.com/trinodb/trino/commit/26f118ad2d06760d3a2148f4e181ef517f2e7922", "message": "Don't match dynamic filters in FilterMatcher", "committedDate": "2020-03-02T11:54:09Z", "type": "commit"}, {"oid": "cfae1a017f5f8a146e1311d8315b731dffafffac", "url": "https://github.com/trinodb/trino/commit/cfae1a017f5f8a146e1311d8315b731dffafffac", "message": "Remove obsolete TODO", "committedDate": "2020-03-02T11:54:09Z", "type": "commit"}, {"oid": "324058168d9950bb12234fe2f62a53008bf6640f", "url": "https://github.com/trinodb/trino/commit/324058168d9950bb12234fe2f62a53008bf6640f", "message": "Add support for dynamic filter to TableScanOperator", "committedDate": "2020-03-02T11:54:10Z", "type": "commit"}, {"oid": "341ec2fa3be7915d45bde9b555d0808ff12a4ad8", "url": "https://github.com/trinodb/trino/commit/341ec2fa3be7915d45bde9b555d0808ff12a4ad8", "message": "Use updatable page source when dynamic filter constraint is empty\n\nDynamic filter might filter data source entirely. In such case\nDELETE operation might fail if data source is not of UpdatablePageSource\ntype.", "committedDate": "2020-03-02T11:54:10Z", "type": "commit"}, {"oid": "8e869790404bd4693e4e95c2546e6aefd787b879", "url": "https://github.com/trinodb/trino/commit/8e869790404bd4693e4e95c2546e6aefd787b879", "message": "Simplify dynamic filter before passing it to HivePageSourceFactory\n\nDynamic filter tuple domains might be relatively large and expensive\nto evaluate. They must be simplified so that dynamic filters do not incur\nadditional CPU cost if they are not filtering much.", "committedDate": "2020-03-02T11:54:10Z", "type": "commit"}, {"oid": "3541ae2d7923097997a1daf28f867e8111f1cde5", "url": "https://github.com/trinodb/trino/commit/3541ae2d7923097997a1daf28f867e8111f1cde5", "message": "Enable dynamic filtering by default", "committedDate": "2020-03-02T11:54:10Z", "type": "commit"}, {"oid": "3541ae2d7923097997a1daf28f867e8111f1cde5", "url": "https://github.com/trinodb/trino/commit/3541ae2d7923097997a1daf28f867e8111f1cde5", "message": "Enable dynamic filtering by default", "committedDate": "2020-03-02T11:54:10Z", "type": "forcePushed"}]}