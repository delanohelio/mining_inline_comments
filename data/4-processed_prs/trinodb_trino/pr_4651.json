{"pr_number": 4651, "pr_title": "Add IF EXISTS and IF NOT EXISTS checks to ALTER TABLE", "pr_createdAt": "2020-07-31T08:09:02Z", "pr_url": "https://github.com/trinodb/trino/pull/4651", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyMjI2NA==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463522264", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    RENAME COLUMN (IF EXISTS)? from=identifier TO to=identifier                 #renameColumn\n          \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    DROP COLUMN (IF EXISTS)? column=qualifiedName                               #dropColumn\n          \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    ADD COLUMN (IF NOT EXISTS)? column=columnDefinition                             #addColumn\n          \n          \n            \n                | ANALYZE qualifiedName (WITH properties)?                         #analyze\n          \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    RENAME COLUMN (IF EXISTS)? from=identifier TO to=identifier    #renameColumn\n          \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    DROP COLUMN (IF EXISTS)? column=qualifiedName                  #dropColumn\n          \n          \n            \n                | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n          \n          \n            \n                    ADD COLUMN (IF NOT EXISTS)? column=columnDefinition            #addColumn\n          \n          \n            \n                | ANALYZE qualifiedName (WITH properties)?                         #analyze", "author": "kokosing", "createdAt": "2020-07-31T10:03:25Z", "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -55,15 +55,15 @@ statement\n     | DROP TABLE (IF EXISTS)? qualifiedName                            #dropTable\n     | INSERT INTO qualifiedName columnAliases? query                   #insertInto\n     | DELETE FROM qualifiedName (WHERE booleanExpression)?             #delete\n-    | ALTER TABLE from=qualifiedName RENAME TO to=qualifiedName        #renameTable\n+    | ALTER TABLE (IF EXISTS)? from=qualifiedName RENAME TO to=qualifiedName        #renameTable\n     | COMMENT ON TABLE qualifiedName IS (string | NULL)                #commentTable\n     | COMMENT ON COLUMN qualifiedName IS (string | NULL)               #commentColumn\n-    | ALTER TABLE tableName=qualifiedName\n-        RENAME COLUMN from=identifier TO to=identifier                 #renameColumn\n-    | ALTER TABLE tableName=qualifiedName\n-        DROP COLUMN column=qualifiedName                               #dropColumn\n-    | ALTER TABLE tableName=qualifiedName\n-        ADD COLUMN column=columnDefinition                             #addColumn\n+    | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n+        RENAME COLUMN (IF EXISTS)? from=identifier TO to=identifier                 #renameColumn\n+    | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n+        DROP COLUMN (IF EXISTS)? column=qualifiedName                               #dropColumn\n+    | ALTER TABLE (IF EXISTS)? tableName=qualifiedName\n+        ADD COLUMN (IF NOT EXISTS)? column=columnDefinition                             #addColumn\n     | ANALYZE qualifiedName (WITH properties)?                         #analyze", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyMjY3NA==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463522674", "bodyText": "tableExists here and in other statement classes", "author": "kokosing", "createdAt": "2020-07-31T10:04:21Z", "path": "presto-parser/src/main/java/io/prestosql/sql/tree/AddColumn.java", "diffHunk": "@@ -27,22 +27,26 @@\n {\n     private final QualifiedName name;\n     private final ColumnDefinition column;\n+    private final boolean tableNameExists;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI1MjkwMw==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465252903", "bodyText": "fixed thanks!", "author": "leetcode-1533", "createdAt": "2020-08-04T18:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyMjY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyMjcxMg==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463522712", "bodyText": "columnNotExists here and in other statement classes\nIn other words Name is not misleading and should not be used in these variable names", "author": "kokosing", "createdAt": "2020-07-31T10:04:27Z", "path": "presto-parser/src/main/java/io/prestosql/sql/tree/AddColumn.java", "diffHunk": "@@ -27,22 +27,26 @@\n {\n     private final QualifiedName name;\n     private final ColumnDefinition column;\n+    private final boolean tableNameExists;\n+    private final boolean columnNameNotExists;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI0ODkwNg==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465248906", "bodyText": "fixed, thanks!", "author": "leetcode-1533", "createdAt": "2020-08-04T18:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyMjcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNDY3Nw==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463524677", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN x TO y\");\n          \n          \n            \n                    assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN IF EXISTS columnNotExists TO y\");\n          \n          \n            \n                    assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN x TO before_y\");\n          \n          \n            \n                    assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN IF EXISTS before_y TO y\");\n          \n          \n            \n                    assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN IF EXISTS columnNotExists TO y\");", "author": "kokosing", "createdAt": "2020-07-31T10:09:13Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -375,6 +379,7 @@ public void testRenameColumn()\n         assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT 'some value' x\", 1);\n \n         assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN x TO y\");\n+        assertUpdate(\"ALTER TABLE \" + tableName + \" RENAME COLUMN IF EXISTS columnNotExists TO y\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNDk3Mg==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463524972", "bodyText": "Add test where actually column is dropped when IF EXISTS is used.", "author": "kokosing", "createdAt": "2020-07-31T10:09:55Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -395,9 +404,17 @@ public void testDropColumn()\n         assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT 123 x, 111 a\", 1);\n \n         assertUpdate(\"ALTER TABLE \" + tableName + \" DROP COLUMN x\");\n+        assertUpdate(\"ALTER TABLE \" + tableName + \" DROP COLUMN IF EXISTS notExistColumn\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2NTU3OQ==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465265579", "bodyText": "fixed thanks!", "author": "leetcode-1533", "createdAt": "2020-08-04T19:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNDk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3MDU4NQ==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465270585", "bodyText": "updated for other test case as well.", "author": "leetcode-1533", "createdAt": "2020-08-04T19:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNDk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNTIzMw==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r463525233", "bodyText": "call this assertUpdate(...) twice", "author": "kokosing", "createdAt": "2020-07-31T10:10:26Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -407,6 +424,7 @@ public void testAddColumn()\n         assertUpdate(\"CREATE TABLE \" + tableName + \" AS SELECT CAST('first' AS varchar) x\", 1);\n \n         assertQueryFails(\"ALTER TABLE \" + tableName + \" ADD COLUMN x bigint\", \".* Column 'x' already exists\");\n+        assertUpdate(\"ALTER TABLE \" + tableName + \" ADD COLUMN IF NOT EXISTS x bigint\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3MTIyMQ==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465271221", "bodyText": "updated. For knowledge purpose, can you tell me why should we call \"assertUpdate(\"ALTER TABLE \" + tableName + \" ADD COLUMN IF NOT EXISTS x bigint\");\" twice?", "author": "leetcode-1533", "createdAt": "2020-08-04T19:14:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNTIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY1NDE4NA==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r465654184", "bodyText": "Oh my bad. My point was to run it twice so once it creates a column and then it skips column creation (suppress the error0. But here column x already exists. So to make it work here we need to use different column name than x.\nAlso it would be better to use something else than x something that would express the test case. Maybe x -> testing_add_column_if_not_exists?", "author": "kokosing", "createdAt": "2020-08-05T11:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNTIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUxNTQ4MA==", "url": "https://github.com/trinodb/trino/pull/4651#discussion_r466515480", "bodyText": "updated! Already add a statement to test can add column even with \"if exists\" statement, so made a duplicate of which.", "author": "leetcode-1533", "createdAt": "2020-08-06T15:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUyNTIzMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "645b3d60ec80e884f800b841cefadd7f631df8e1", "url": "https://github.com/trinodb/trino/commit/645b3d60ec80e884f800b841cefadd7f631df8e1", "message": "Add IF EXISTS and IF NOT EXISTS checks to ALTER TABLE", "committedDate": "2020-08-06T20:02:24Z", "type": "commit"}, {"oid": "645b3d60ec80e884f800b841cefadd7f631df8e1", "url": "https://github.com/trinodb/trino/commit/645b3d60ec80e884f800b841cefadd7f631df8e1", "message": "Add IF EXISTS and IF NOT EXISTS checks to ALTER TABLE", "committedDate": "2020-08-06T20:02:24Z", "type": "forcePushed"}]}