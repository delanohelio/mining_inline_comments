{"pr_number": 5066, "pr_title": "Adding ulimits guidance to deployment doc", "pr_createdAt": "2020-09-03T16:13:01Z", "pr_url": "https://github.com/trinodb/trino/pull/5066", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MDc3NA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483160774", "bodyText": "See if you can avoid ending the sentence in a preposition", "author": "electrum", "createdAt": "2020-09-03T18:03:02Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,26 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that the Presto process runs as. Currently, ", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4MTg1OA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483181858", "bodyText": "adequate ulimits for the user that runs the Presto process", "author": "dain", "createdAt": "2020-09-03T18:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MDc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MDg4Nw==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483160887", "bodyText": "Capitalize Linux", "author": "electrum", "createdAt": "2020-09-03T18:03:14Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,26 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that the Presto process runs as. Currently, \n+  Presto requires a minimum of 4096 open file descriptors, and strongly \n+  recommends at least 8192 when it runs. Many modern linux systems built to ", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MTI0Mg==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483161242", "bodyText": "I believe this requirement can be higher -- IIRC we've needed 100k at times. @dain do you remember?", "author": "electrum", "createdAt": "2020-09-03T18:04:00Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,26 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that the Presto process runs as. Currently, \n+  Presto requires a minimum of 4096 open file descriptors, and strongly \n+  recommends at least 8192 when it runs. Many modern linux systems built to \n+  host large applications such as Presto are expected to support much larger \n+  values, on the order of 32k open files descriptors and above, to ensure that", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4MjM1Mg==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483182352", "bodyText": "Ya... I have no idea why the default in linux isn't like 256k, unless you are on a low end cell phone", "author": "dain", "createdAt": "2020-09-03T18:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNDAwNw==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483234007", "bodyText": "I've run into issues with 64K once or twice. 100K is generally safe.", "author": "willmostly", "createdAt": "2020-09-03T20:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNzE4Mw==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483237183", "bodyText": "Maybe we should add a note that the required number of file descriptors scales with the (number of machines)**2 and the workload, unless that is too much detail.", "author": "willmostly", "createdAt": "2020-09-03T20:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MTI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MTA2OQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483271069", "bodyText": "Should I just remove the extremely low requirements and leave it at strongly suggesting 128k/256k for the nofile limits, and show that in the code block? Do the nproc lints need to scale with the nofile limits?\nShould the limits checked in the code be that low? Do they support a performant system?", "author": "m57lyra", "createdAt": "2020-09-03T21:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjA0OA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483162048", "bodyText": "It should be clear that this is an example if Presto is running as the presto user. Also, this may be Linux distribution specific and depend on how Presto is run. For example, in Kubernetes, the limits are likely set in an entirely different way.\n@jvanzyl any suggestions here?", "author": "electrum", "createdAt": "2020-09-03T18:05:31Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,26 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that the Presto process runs as. Currently, \n+  Presto requires a minimum of 4096 open file descriptors, and strongly \n+  recommends at least 8192 when it runs. Many modern linux systems built to \n+  host large applications such as Presto are expected to support much larger \n+  values, on the order of 32k open files descriptors and above, to ensure that\n+  these limits are never hit. These limits are set in ", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNTI4NQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483235285", "bodyText": "Standard EKS now has high ulimits (issue 206), but modifying them is difficult. In an AWS Fargate EKS cluster, they are set to 1024 and cannot be modified.", "author": "willmostly", "createdAt": "2020-09-03T20:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI4MzU2MA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483283560", "bodyText": "@electrum - was this concern addressed by the Note?", "author": "m57lyra", "createdAt": "2020-09-03T22:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjI0OA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483162248", "bodyText": "Capitalize Presto so it's clear we are saying \"the user Presto runs as\" and not the presto user.", "author": "electrum", "createdAt": "2020-09-03T18:05:53Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,26 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that the Presto process runs as. Currently, \n+  Presto requires a minimum of 4096 open file descriptors, and strongly \n+  recommends at least 8192 when it runs. Many modern linux systems built to \n+  host large applications such as Presto are expected to support much larger \n+  values, on the order of 32k open files descriptors and above, to ensure that\n+  these limits are never hit. These limits are set in \n+  ``/etc/security/limits.conf``:\n+\n+.. code-block:: none\n+\n+  presto soft nofile 32768\n+  presto hard nofile 65536\n+  presto soft nproc 32768\n+  presto hard nproc 65536\n+\n+.. note::\n+\n+  The root user will often have different ulimits set than do other users.\n+  If you see error messages regarding the number of open files, please be \n+  sure that you are changing the values for the presto user and not root.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MTc5MA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r483271790", "bodyText": "changed to \"please be sure that you are changing the values for the Presto user and not root.\"", "author": "m57lyra", "createdAt": "2020-09-03T21:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjI0OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwMzM3MQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r486603371", "bodyText": "We can remove the \"when it runs\". I also think it's strange to say \"Presto recommends\" since it's software. we are the ones recommending.\nDo we need to mention both 4096 and 8192? Seems better to just give a single recommended minimum to avoid confusion.", "author": "electrum", "createdAt": "2020-09-10T20:07:02Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,30 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits \n+  may depend on the specific Linux distribution you are using. Currently,\n+  Presto requires a minimum of 4096 open file descriptors, and strongly\n+  recommends at least 8192 when it runs. However, the number of open file", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNDYwNQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r486604605", "bodyText": "number of machines^2 is hard to read (normally there would be a space between operators, or it would be a single word). Also, it's not clear what workload means. I think we could simplify this\n\nas roughly as the square of the machine count, times some factor depending on the workload", "author": "electrum", "createdAt": "2020-09-10T20:09:37Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,30 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits \n+  may depend on the specific Linux distribution you are using. Currently,\n+  Presto requires a minimum of 4096 open file descriptors, and strongly\n+  recommends at least 8192 when it runs. However, the number of open file\n+  descriptors needed for a particular Presto instance scales with the number\n+  of machines in the cluster as roughly ``number of machines^2 * workload``.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTc3MA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r486605770", "bodyText": "This seems needlessly verbose, and is confusing. We mention 32k here, then show completely different numbers below. Also, it's not clear why we would set a soft limit different than the hard limit. I think it's better to simply tell people exactly what to put.\n\nWe recommend using a much higher limit, which can typically be set in /etc/security/limits.conf:", "author": "electrum", "createdAt": "2020-09-10T20:11:58Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,30 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits \n+  may depend on the specific Linux distribution you are using. Currently,\n+  Presto requires a minimum of 4096 open file descriptors, and strongly\n+  recommends at least 8192 when it runs. However, the number of open file\n+  descriptors needed for a particular Presto instance scales with the number\n+  of machines in the cluster as roughly ``number of machines^2 * workload``.\n+  Many modern Linux systems built to host large applications such as Presto", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NjM3OA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r487266378", "bodyText": "The soft and hard limits were suggested by Kamil in the slack thread.", "author": "m57lyra", "createdAt": "2020-09-11T20:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MDg3NA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r487350874", "bodyText": "I understands, but having a hard limit different from the soft limit doesn't make sense for our use case. The soft limit is enforced as the limit, but it can be increased up to the hard limit.", "author": "electrum", "createdAt": "2020-09-12T01:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI0MTU2MQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r488241561", "bodyText": "Hi @electrum - Understood. Gathering comments, it looks like the preference is to leave nproc out of the example altogether, and only have a single line that we suggest to add to the limits.conf file. I gather from the above that the line should be the nofile hard limit. Is that correct? What I am not clear on is if there is a consensus among the engineering leads as to what that limit should be. Could you provide what you believe should be the example ulimits entry(ies) with the agreed upon values? Thank you!", "author": "m57lyra", "createdAt": "2020-09-14T21:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNTg5Nw==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r486605897", "bodyText": "Code blocks and note content needs to be indented", "author": "electrum", "createdAt": "2020-09-10T20:12:14Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,30 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits \n+  may depend on the specific Linux distribution you are using. Currently,\n+  Presto requires a minimum of 4096 open file descriptors, and strongly\n+  recommends at least 8192 when it runs. However, the number of open file\n+  descriptors needed for a particular Presto instance scales with the number\n+  of machines in the cluster as roughly ``number of machines^2 * workload``.\n+  Many modern Linux systems built to host large applications such as Presto\n+  are expected to support much larger values, on the order of 32k open files\n+  descriptors and above, to ensure that these limits are never hit. These \n+  limits are set in ``/etc/security/limits.conf``:\n+\n+.. code-block:: none", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNjU0MA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r486606540", "bodyText": "We can simplify\n\nThe root user will often have different ulimits than other users. Please be sure you are setting the ulimits for the user the Presto process runs as.", "author": "electrum", "createdAt": "2020-09-10T20:13:35Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,30 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits \n+  may depend on the specific Linux distribution you are using. Currently,\n+  Presto requires a minimum of 4096 open file descriptors, and strongly\n+  recommends at least 8192 when it runs. However, the number of open file\n+  descriptors needed for a particular Presto instance scales with the number\n+  of machines in the cluster as roughly ``number of machines^2 * workload``.\n+  Many modern Linux systems built to host large applications such as Presto\n+  are expected to support much larger values, on the order of 32k open files\n+  descriptors and above, to ensure that these limits are never hit. These \n+  limits are set in ``/etc/security/limits.conf``:\n+\n+.. code-block:: none\n+\n+  presto soft nofile 131072\n+  presto hard nofile 262144\n+  presto soft nproc 131072\n+  presto hard nproc 262144\n+\n+.. note::\n+\n+  The root user will often have different ulimits set than do other users.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2OTkyOQ==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r488169929", "bodyText": "user often has different ulimits ..", "author": "mosabua", "createdAt": "2020-09-14T19:28:25Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,25 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits\n+  may depend on the specific Linux distribution you are using. The number\n+  of open file descriptors needed for a particular Presto instance scales\n+  as roughly the number of machines in the cluster, times some factor \n+  depending on the workload. We recommend the following limits, which can \n+  typically be set in ``/etc/security/limits.conf``:\n+\n+.. code-block:: none\n+\n+    presto soft nofile 131072\n+    presto hard nofile 262144\n+    presto soft nproc 131072\n+    presto hard nproc 262144\n+\n+.. note::\n+\n+    The ``root`` user will often have different ulimits than other users. Be", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ0NTEyMA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r490445120", "bodyText": "Let's remove this note. The ulimit part is already long, and we don't want to further distract from the rest of the installation instructions. The above example shows the presto user, so I think it's sufficient.", "author": "electrum", "createdAt": "2020-09-17T17:45:37Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,25 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits\n+  may depend on the specific Linux distribution you are using. The number\n+  of open file descriptors needed for a particular Presto instance scales\n+  as roughly the number of machines in the cluster, times some factor \n+  depending on the workload. We recommend the following limits, which can \n+  typically be set in ``/etc/security/limits.conf``:\n+\n+.. code-block:: none\n+\n+    presto soft nofile 131072\n+    presto hard nofile 262144\n+    presto soft nproc 131072\n+    presto hard nproc 262144\n+\n+.. note::", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ0NTMyNA==", "url": "https://github.com/trinodb/trino/pull/5066#discussion_r490445324", "bodyText": "Make the soft and hard limits the same. I don't see a reason to make them different.", "author": "electrum", "createdAt": "2020-09-17T17:45:58Z", "path": "presto-docs/src/main/sphinx/installation/deployment.rst", "diffHunk": "@@ -10,6 +10,25 @@ Linux Operating System\n \n * 64-bit required\n * newer release preferred, especially when running on containers\n+* adequate ulimits for the user that runs the Presto process. These limits\n+  may depend on the specific Linux distribution you are using. The number\n+  of open file descriptors needed for a particular Presto instance scales\n+  as roughly the number of machines in the cluster, times some factor \n+  depending on the workload. We recommend the following limits, which can \n+  typically be set in ``/etc/security/limits.conf``:\n+\n+.. code-block:: none\n+\n+    presto soft nofile 131072", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c94663ed94421cb4c6b7199204035418c873a255", "url": "https://github.com/trinodb/trino/commit/c94663ed94421cb4c6b7199204035418c873a255", "message": "Adding ulimits guidance to deployment doc", "committedDate": "2020-09-18T04:45:38Z", "type": "commit"}, {"oid": "c94663ed94421cb4c6b7199204035418c873a255", "url": "https://github.com/trinodb/trino/commit/c94663ed94421cb4c6b7199204035418c873a255", "message": "Adding ulimits guidance to deployment doc", "committedDate": "2020-09-18T04:45:38Z", "type": "forcePushed"}]}