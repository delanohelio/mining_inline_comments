{"pr_number": 3432, "pr_title": "Use fixed pattern in a rule", "pr_createdAt": "2020-04-14T22:32:47Z", "pr_url": "https://github.com/trinodb/trino/pull/3432", "timeline": [{"oid": "1c6d5639afdaad6e8ce25ba6dd8cc38668f6ae7b", "url": "https://github.com/trinodb/trino/commit/1c6d5639afdaad6e8ce25ba6dd8cc38668f6ae7b", "message": "Fix CorrelatedJoin naming in PlanPrinter", "committedDate": "2020-04-14T14:22:24Z", "type": "commit"}, {"oid": "9755bdbad53d914e18e40cf41d91dd811e76cefe", "url": "https://github.com/trinodb/trino/commit/9755bdbad53d914e18e40cf41d91dd811e76cefe", "message": "Minor refactor in correlated Aggregation rewriter", "committedDate": "2020-04-14T15:47:46Z", "type": "commit"}, {"oid": "be2a97e38d2512eacdfec993a2550a2ff9ee749e", "url": "https://github.com/trinodb/trino/commit/be2a97e38d2512eacdfec993a2550a2ff9ee749e", "message": "Fix source property in CorrelatedJoin pattern\n\nresolve the child node to skip GroupReference", "committedDate": "2020-04-14T17:22:56Z", "type": "commit"}, {"oid": "206ac9839916abffbc30462bc4c4cfa941a7577a", "url": "https://github.com/trinodb/trino/commit/206ac9839916abffbc30462bc4c4cfa941a7577a", "message": "Add rule to remove redundant EnforceSingleRowNodes", "committedDate": "2020-04-14T22:29:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4NTE3OQ==", "url": "https://github.com/trinodb/trino/pull/3432#discussion_r408485179", "bodyText": "Annotate with @VisibleForTesting", "author": "martint", "createdAt": "2020-04-14T23:02:01Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java", "diffHunk": "@@ -66,55 +75,124 @@\n  * Note that only conjunction predicates in FilterNode are supported\n  */\n public class TransformCorrelatedScalarAggregationToJoin\n-        implements Rule<CorrelatedJoinNode>\n {\n-    private static final Pattern<CorrelatedJoinNode> PATTERN = correlatedJoin()\n-            .with(nonEmpty(correlation()))\n-            .with(filter().equalTo(TRUE_LITERAL)); // todo non-trivial join filter: adding filter/project on top of aggregation\n-\n-    @Override\n-    public Pattern<CorrelatedJoinNode> getPattern()\n-    {\n-        return PATTERN;\n-    }\n-\n     private final Metadata metadata;\n \n     public TransformCorrelatedScalarAggregationToJoin(Metadata metadata)\n     {\n         this.metadata = requireNonNull(metadata, \"metadata is null\");\n     }\n \n-    @Override\n-    public Result apply(CorrelatedJoinNode correlatedJoinNode, Captures captures, Context context)\n+    public Set<Rule<?>> rules()\n+    {\n+        return ImmutableSet.of(\n+                new TransformCorrelatedScalarAggregationToJoin.TransformCorrelatedScalarAggregationWithProjection(metadata),\n+                new TransformCorrelatedScalarAggregationToJoin.TransformCorrelatedScalarAggregationWithoutProjection(metadata));\n+    }\n+\n+    static final class TransformCorrelatedScalarAggregationWithProjection", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4NjMwNg==", "url": "https://github.com/trinodb/trino/pull/3432#discussion_r408486306", "bodyText": "Annotate with @VisibleForTesting", "author": "martint", "createdAt": "2020-04-14T23:05:13Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/TransformCorrelatedScalarAggregationToJoin.java", "diffHunk": "@@ -66,55 +75,124 @@\n  * Note that only conjunction predicates in FilterNode are supported\n  */\n public class TransformCorrelatedScalarAggregationToJoin\n-        implements Rule<CorrelatedJoinNode>\n {\n-    private static final Pattern<CorrelatedJoinNode> PATTERN = correlatedJoin()\n-            .with(nonEmpty(correlation()))\n-            .with(filter().equalTo(TRUE_LITERAL)); // todo non-trivial join filter: adding filter/project on top of aggregation\n-\n-    @Override\n-    public Pattern<CorrelatedJoinNode> getPattern()\n-    {\n-        return PATTERN;\n-    }\n-\n     private final Metadata metadata;\n \n     public TransformCorrelatedScalarAggregationToJoin(Metadata metadata)\n     {\n         this.metadata = requireNonNull(metadata, \"metadata is null\");\n     }\n \n-    @Override\n-    public Result apply(CorrelatedJoinNode correlatedJoinNode, Captures captures, Context context)\n+    public Set<Rule<?>> rules()\n+    {\n+        return ImmutableSet.of(\n+                new TransformCorrelatedScalarAggregationToJoin.TransformCorrelatedScalarAggregationWithProjection(metadata),\n+                new TransformCorrelatedScalarAggregationToJoin.TransformCorrelatedScalarAggregationWithoutProjection(metadata));\n+    }\n+\n+    static final class TransformCorrelatedScalarAggregationWithProjection\n+            implements Rule<CorrelatedJoinNode>\n     {\n-        PlanNode subquery = correlatedJoinNode.getSubquery();\n+        private static final Capture<ProjectNode> PROJECTION = newCapture();\n+        private static final Capture<AggregationNode> AGGREGATION = newCapture();\n+\n+        private static final Pattern<CorrelatedJoinNode> PATTERN = correlatedJoin()\n+                .with(nonEmpty(correlation()))\n+                .with(filter().equalTo(TRUE_LITERAL))\n+                .with(subquery().matching(project()\n+                        .capturedAs(PROJECTION)\n+                        .with(source().matching(aggregation()\n+                                .with(empty(groupingColumns()))\n+                                .capturedAs(AGGREGATION)))));\n+\n+        private final Metadata metadata;\n \n-        if (!isScalar(subquery, context.getLookup())) {\n-            return Result.empty();\n+        TransformCorrelatedScalarAggregationWithProjection(Metadata metadata)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "2fbb55233656197ba42be9c093e257490beb7eb9", "url": "https://github.com/trinodb/trino/commit/2fbb55233656197ba42be9c093e257490beb7eb9", "message": "Use fixed pattern in a rule\n\nSplits the TransformCorrelatedScalarAggregationToJoin Optimizer rule\ninto a set of two rules with fixed patterns instead of using\nPlanNodeSearcher inside the rule.\nAfter this change, the only patterns supported by the rules are:\n\n- CorrelatedJoin\n    - Input\n    - global Aggregation\n\nand\n\n- CorrelatedJoin\n    - Input\n    - Project\n\t- global Aggregation\n\nPreviously, the rule supported also cases were\n1. there were multiple Projections above the Aggregation.\n   This case was handled incorrectly.\n2. there were EnforceSingleRowNodes in the subquery\n   above the Aggregation. This functionality is restored\n   by adding a rule to remove redundant EnforceSingleRowNodes.", "committedDate": "2020-04-15T16:40:59Z", "type": "commit"}, {"oid": "2fbb55233656197ba42be9c093e257490beb7eb9", "url": "https://github.com/trinodb/trino/commit/2fbb55233656197ba42be9c093e257490beb7eb9", "message": "Use fixed pattern in a rule\n\nSplits the TransformCorrelatedScalarAggregationToJoin Optimizer rule\ninto a set of two rules with fixed patterns instead of using\nPlanNodeSearcher inside the rule.\nAfter this change, the only patterns supported by the rules are:\n\n- CorrelatedJoin\n    - Input\n    - global Aggregation\n\nand\n\n- CorrelatedJoin\n    - Input\n    - Project\n\t- global Aggregation\n\nPreviously, the rule supported also cases were\n1. there were multiple Projections above the Aggregation.\n   This case was handled incorrectly.\n2. there were EnforceSingleRowNodes in the subquery\n   above the Aggregation. This functionality is restored\n   by adding a rule to remove redundant EnforceSingleRowNodes.", "committedDate": "2020-04-15T16:40:59Z", "type": "forcePushed"}]}