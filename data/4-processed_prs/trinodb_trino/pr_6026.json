{"pr_number": 6026, "pr_title": "Add helper method for getting decimal digits from JdbcTypeHandle", "pr_createdAt": "2020-11-20T09:01:45Z", "pr_url": "https://github.com/trinodb/trino/pull/6026", "timeline": [{"oid": "a45a45e901438a4dec31bcc40755da610ce6e011", "url": "https://github.com/trinodb/trino/commit/a45a45e901438a4dec31bcc40755da610ce6e011", "message": "Add helper method for getting decimal digits from JdbcTypeHandle", "committedDate": "2020-11-20T09:00:56Z", "type": "commit"}, {"oid": "d3ff5c94942bdbf84104f3a0628971bc733667c2", "url": "https://github.com/trinodb/trino/commit/d3ff5c94942bdbf84104f3a0628971bc733667c2", "message": "Fix formatting", "committedDate": "2020-11-20T09:01:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NTQ2MQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r527765461", "bodyText": "There should be a comment about why long and short decimal use different rounding.", "author": "jirassimok", "createdAt": "2020-11-20T15:24:58Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/StandardColumnMappings.java", "diffHunk": "@@ -170,15 +170,22 @@ public static ColumnMapping decimalColumnMapping(DecimalType decimalType, Roundi\n         if (decimalType.isShort()) {\n             return ColumnMapping.longMapping(\n                     decimalType,\n-                    (resultSet, columnIndex) -> encodeShortScaledValue(resultSet.getBigDecimal(columnIndex), scale),\n+                    shortDecimalReadFunction(decimalType, UNNECESSARY),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NjgzNQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528246835", "bodyText": "Yes, and actually i also wondered why. It's preexisting and i maintained this.\nThis was introduced in #2088, so maybe @guyco33 or @kokosing can suggest the comment wording to be added here", "author": "findepi", "createdAt": "2020-11-21T21:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MzE5OQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528253199", "bodyText": "added // TODO why roundingMode is not used here, but it is used for long decimal only? comment for now, but of course this is not ideal", "author": "findepi", "createdAt": "2020-11-21T22:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI5ODk0Ng==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528298946", "bodyText": "I found that mapping to short decimal doesn't need rounding, since its max precision (less then 18) always fit and unspecified decimal (special to Postgres) is mapped to long decimal", "author": "guyco33", "createdAt": "2020-11-22T08:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0NTQ3NQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528545475", "bodyText": "replaced with a check", "author": "findepi", "createdAt": "2020-11-23T08:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NTQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NjA0MQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r527766041", "bodyText": "Maybe there should be an overload with only the type argument and UNNECESSARY rounding (and for longDecimalReadFunction)?", "author": "jirassimok", "createdAt": "2020-11-20T15:25:44Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/StandardColumnMappings.java", "diffHunk": "@@ -170,15 +170,22 @@ public static ColumnMapping decimalColumnMapping(DecimalType decimalType, Roundi\n         if (decimalType.isShort()) {\n             return ColumnMapping.longMapping(\n                     decimalType,\n-                    (resultSet, columnIndex) -> encodeShortScaledValue(resultSet.getBigDecimal(columnIndex), scale),\n+                    shortDecimalReadFunction(decimalType, UNNECESSARY),\n                     shortDecimalWriteFunction(decimalType));\n         }\n         return ColumnMapping.sliceMapping(\n                 decimalType,\n-                (resultSet, columnIndex) -> encodeScaledValue(resultSet.getBigDecimal(columnIndex).setScale(scale, roundingMode)),\n+                longDecimalReadFunction(decimalType, roundingMode),\n                 longDecimalWriteFunction(decimalType));\n     }\n \n+    public static LongReadFunction shortDecimalReadFunction(DecimalType decimalType, RoundingMode roundingMode)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NzM2MQ==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528247361", "bodyText": "Good idea, added", "author": "findepi", "createdAt": "2020-11-21T21:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2NjA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MTcyMg==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528251722", "bodyText": "this TODO will not drive any actions. If you want to make it actionable create an issue for that; tag in comment; and assign suspected owner.", "author": "losipiuk", "createdAt": "2020-11-21T22:41:11Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/StandardColumnMappings.java", "diffHunk": "@@ -163,14 +163,20 @@ public static DoubleWriteFunction doubleWriteFunction()\n         return PreparedStatement::setDouble;\n     }\n \n+    public static ColumnMapping decimalColumnMapping(DecimalType decimalType)\n+    {\n+        return decimalColumnMapping(decimalType, UNNECESSARY);\n+    }\n+\n     public static ColumnMapping decimalColumnMapping(DecimalType decimalType, RoundingMode roundingMode)\n     {\n         // JDBC driver can return BigDecimal with lower scale than column's scale when there are trailing zeroes\n         int scale = decimalType.getScale();\n         if (decimalType.isShort()) {\n             return ColumnMapping.longMapping(\n                     decimalType,\n-                    shortDecimalReadFunction(decimalType, UNNECESSARY),\n+                    // TODO why roundingMode is not used here, but it is used for long decimal only?", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MzE0OA==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528253148", "bodyText": "@losipiuk  let's continue above -- #6026 (comment)", "author": "findepi", "createdAt": "2020-11-21T22:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MTcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MzYyMg==", "url": "https://github.com/trinodb/trino/pull/6026#discussion_r528253622", "bodyText": "Yeah sure. My point was just that, if we merge this one, without conclusion, the TODO will likely be forgotten.", "author": "losipiuk", "createdAt": "2020-11-21T23:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1MTcyMg=="}], "type": "inlineReview"}, {"oid": "15299c0a0b5abf9300f139fa4174dd445e243786", "url": "https://github.com/trinodb/trino/commit/15299c0a0b5abf9300f139fa4174dd445e243786", "message": "Extract decimal read functions", "committedDate": "2020-11-21T22:58:53Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "bfa009b025700669544eea7e990b664865c421fd", "url": "https://github.com/trinodb/trino/commit/bfa009b025700669544eea7e990b664865c421fd", "message": "Add decimal mappings factory methods without rounding mode", "committedDate": "2020-11-23T08:51:40Z", "type": "commit"}, {"oid": "bfa009b025700669544eea7e990b664865c421fd", "url": "https://github.com/trinodb/trino/commit/bfa009b025700669544eea7e990b664865c421fd", "message": "Add decimal mappings factory methods without rounding mode", "committedDate": "2020-11-23T08:51:40Z", "type": "forcePushed"}]}