{"pr_number": 4858, "pr_title": "Allow to restart flaky tests", "pr_createdAt": "2020-08-17T13:09:05Z", "pr_url": "https://github.com/trinodb/trino/pull/4858", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2NzgyMg==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r471467822", "bodyText": "\ud83d\ude31", "author": "kokosing", "createdAt": "2020-08-17T13:11:35Z", "path": "presto-main/pom.xml", "diffHunk": "@@ -56,6 +56,12 @@\n             <artifactId>presto-spi</artifactId>\n         </dependency>\n \n+        <dependency>\n+            <!-- transitive test dependency -->", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NTM5OQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472045399", "bodyText": "can we use presto-testing for this?", "author": "findepi", "createdAt": "2020-08-18T09:30:46Z", "path": "pom.xml", "diffHunk": "@@ -142,6 +142,7 @@\n         <module>presto-testing</module>\n         <module>presto-testing-kafka</module>\n         <module>presto-testing-server-launcher</module>\n+        <module>presto-testng-services</module>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExODMxMg==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472118312", "bodyText": "No, I do not want to use presto-testing(white box testing)  in product tests (black box testing).\nBTW product tests already depends on presto-main which is bad.\n#4871", "author": "kokosing", "createdAt": "2020-08-18T11:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NTM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NzM5MA==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472047390", "bodyText": "typo", "author": "findepi", "createdAt": "2020-08-18T09:34:20Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -32,29 +34,34 @@\n     @Override\n     public void onBeforeClass(ITestClass testClass)\n     {\n-        Method[] publicMethods = testClass.getRealClass().getMethods();\n-\n-        List<Method> unannotatedMethods = Arrays.stream(publicMethods)\n-                .filter(method -> method.getDeclaringClass() != Object.class)\n-                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n-                .filter(method -> !method.isBridge())\n-                .filter(method -> !isTestMethod(method))\n-                .collect(toImmutableList());\n-\n-        if (!unannotatedMethods.isEmpty()) {\n+        Class<?> realClass = testClass.getRealClass();\n+        List<Method> unnatedTestMethods = findUnannotatedTestMethods(realClass);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODAwMg==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048002", "bodyText": "equals, or is prefix", "author": "findepi", "createdAt": "2020-08-18T09:35:19Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)\n+    {\n+        return Stream.of(method.getDeclaringClass().getInterfaces())\n+                .filter(ReportUnannotatedMethods::isTemptoClass)\n+                .map(Class::getMethods)\n+                .flatMap(Stream::of)\n+                .anyMatch(actualMethod -> hasSameNameAndParameters(method, actualMethod));\n+    }\n+\n+    private static boolean hasSameNameAndParameters(Method first, Method second)\n+    {\n+        if (!first.getName().equals(second.getName())) {\n+            return false;\n+        }\n+\n+        if (first.getParameterTypes().length != second.getParameterTypes().length) {\n+            return false;\n+        }\n+\n+        for (int i = 0; i < first.getParameterTypes().length; i++) {\n+            if (!first.getParameterTypes()[i].getName().equals(second.getParameterTypes()[i].getName())) {\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private static boolean isTemptoClass(Class<?> aClass)\n+    {\n+        return \"io.prestosql.tempto\".equals(aClass.getPackage().getName());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzNjQ5OQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472136499", "bodyText": "I think all tempto spi is in this package.", "author": "kokosing", "createdAt": "2020-08-18T12:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODQ2Ng==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048466", "bodyText": "is this kind of quadratic?", "author": "findepi", "createdAt": "2020-08-18T09:36:03Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -32,29 +34,34 @@\n     @Override\n     public void onBeforeClass(ITestClass testClass)\n     {\n-        Method[] publicMethods = testClass.getRealClass().getMethods();\n-\n-        List<Method> unannotatedMethods = Arrays.stream(publicMethods)\n-                .filter(method -> method.getDeclaringClass() != Object.class)\n-                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n-                .filter(method -> !method.isBridge())\n-                .filter(method -> !isTestMethod(method))\n-                .collect(toImmutableList());\n-\n-        if (!unannotatedMethods.isEmpty()) {\n+        Class<?> realClass = testClass.getRealClass();\n+        List<Method> unnatedTestMethods = findUnannotatedTestMethods(realClass);\n+        if (!unnatedTestMethods.isEmpty()) {\n             // TestNG may or may not propagate listener's exception as test execution exception.\n             // Therefore, instead of throwing, we terminate the JVM.\n             System.err.println(format(\n                     \"FATAL: Test class %s has methods which are public but not explicitly annotated. Are they missing @Test?%s\",\n-                    testClass.getRealClass().getName(),\n-                    unannotatedMethods.stream()\n+                    realClass.getName(),\n+                    unnatedTestMethods.stream()\n                             .map(Method::toString)\n                             .collect(joining(\"\\n\\t\\t\", \"\\n\\t\\t\", \"\"))));\n             System.err.println(\"JVM will be terminated\");\n             System.exit(1);\n         }\n     }\n \n+    @VisibleForTesting\n+    static List<Method> findUnannotatedTestMethods(Class<?> realClass)\n+    {\n+        return Arrays.stream(realClass.getMethods())\n+                .filter(method -> method.getDeclaringClass() != Object.class)\n+                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n+                .filter(method -> !method.isBridge())\n+                .filter(method -> !isTestMethod(method))\n+                .filter(method -> !isSpiMethod(method))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzMzgyMw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472133823", "bodyText": "Maybe I could use some caching here to not verify same methods multiple times, but I don't think it is a real problem here anyway.", "author": "kokosing", "createdAt": "2020-08-18T12:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODUzOQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048539", "bodyText": "spi -> temptoSpi", "author": "findepi", "createdAt": "2020-08-18T09:36:11Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODcxMg==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048712", "bodyText": "hasSameNameAndParameters -> overrides ?", "author": "findepi", "createdAt": "2020-08-18T09:36:30Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)\n+    {\n+        return Stream.of(method.getDeclaringClass().getInterfaces())\n+                .filter(ReportUnannotatedMethods::isTemptoClass)\n+                .map(Class::getMethods)\n+                .flatMap(Stream::of)\n+                .anyMatch(actualMethod -> hasSameNameAndParameters(method, actualMethod));\n+    }\n+\n+    private static boolean hasSameNameAndParameters(Method first, Method second)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0OTQyNw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472049427", "bodyText": "Can we apply FlakyTestRetryAnalyzer twice, on class and method level?\nwhat does it do on the class level?", "author": "findepi", "createdAt": "2020-08-18T09:37:39Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/RetryAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+\n+public class RetryAnnotationTransformer\n+        implements IAnnotationTransformer\n+{\n+    private static final Logger log = Logger.get(RetryAnnotationTransformer.class);\n+\n+    @Override\n+    public void transform(ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod)\n+    {\n+        if (testClass != null) {\n+            log.debug(\"Instrumenting class %s with %s.\", testClass.getSimpleName(), FlakyTestRetryAnalyzer.class.getSimpleName());\n+            annotation.setRetryAnalyzer(FlakyTestRetryAnalyzer.class);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1MzQxNg==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472153416", "bodyText": "Can we apply FlakyTestRetryAnalyzer twice, on class and method level?\n\nWe already did that.\n\nwhat does it do on the class level?\n\nI guess it might want to enable retrying for test methods? (However I know that testng is ready to surprise me here) Anyway @Flaky can be only set for methods so I removed instrumenting class.", "author": "kokosing", "createdAt": "2020-08-18T12:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0OTQyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MDEwMQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472050101", "bodyText": "Does this work for parameterized methods (dataprovider)?\nmaybe we could explicitly detect & reject this?", "author": "findepi", "createdAt": "2020-08-18T09:38:48Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        synchronized (this) {\n+            String name = getName(result.getMethod());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MDM3Ng==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472050376", "bodyText": "Add a comment whether the class name is defining class (eg abstract base), or actual class (the test class)", "author": "findepi", "createdAt": "2020-08-18T09:39:17Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        synchronized (this) {\n+            String name = getName(result.getMethod());\n+            retryCount = retryCounter.getOrDefault(name, 0L);\n+            retryCount++;\n+            if (retryCount > ALLOWED_RETRIES_COUNT) {\n+                return false;\n+            }\n+            retryCounter.put(name, retryCount);\n+        }\n+        log.warn(\n+                result.getThrowable(),\n+                \"Test %s::%s attempt %s failed, retrying...,\",\n+                result.getTestClass().getName(),\n+                result.getMethod().getMethodName(),\n+                retryCount);\n+        return true;\n+    }\n+\n+    private static boolean isTestRetryable(ITestResult result)\n+    {\n+        Method method = result.getMethod().getConstructorOrMethod().getMethod();\n+        if (method == null) {\n+            return false;\n+        }\n+        return method.getAnnotation(Flaky.class) != null;\n+    }\n+\n+    public static String getName(ITestNGMethod method)\n+    {\n+        return format(\"%s::%s\", method.getTestClass().getName(), method.getMethodName());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MTEzNQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472051135", "bodyText": "I'd (ab)use @Deprecated here\n/**\n * @deprecated Use of this is strongly discouraged\n */\n@Deprecated\n\nso that every use of this annotation visually stands out and calls for a fix", "author": "findepi", "createdAt": "2020-08-18T09:40:41Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/Flaky.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+@Retention(RUNTIME)\n+@Target(METHOD)\n+public @interface Flaky", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4OTc0MA==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472489740", "bodyText": "It's unsupported, isn't it?", "author": "lukasz-walkiewicz", "createdAt": "2020-08-18T20:59:29Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveStorageFormats.java", "diffHunk": "@@ -157,6 +158,7 @@ public void testCreateTableAs(StorageFormat storageFormat)\n     }\n \n     @Test(dataProvider = \"storage_formats\", groups = STORAGE_FORMATS)\n+    @Flaky(issue = \"https://github.com/prestosql/presto/issues/2390\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk0MzU5Ng==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472943596", "bodyText": "It is supported and most of the time the test is passing.", "author": "kokosing", "createdAt": "2020-08-19T11:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4OTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1NDI1NQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r473054255", "bodyText": "Fixed", "author": "kokosing", "createdAt": "2020-08-19T14:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4OTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5MzcxOQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472493719", "bodyText": "I would prefer having public methods before private ones. You can see what class can do pretty easily without going into implementation details. No change requested.", "author": "lukasz-walkiewicz", "createdAt": "2020-08-18T21:07:49Z", "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        ITestNGMethod method = result.getMethod();\n+        synchronized (this) {\n+            String name = getName(method);\n+            retryCount = retryCounter.getOrDefault(name, 0L);\n+            retryCount++;\n+            if (retryCount > ALLOWED_RETRIES_COUNT) {\n+                return false;\n+            }\n+            retryCounter.put(name, retryCount);\n+        }\n+        log.warn(\n+                result.getThrowable(),\n+                \"Test %s::%s attempt %s failed, retrying...,\",\n+                result.getTestClass().getName(),\n+                method.getMethodName(),\n+                retryCount);\n+        return true;\n+    }\n+\n+    private static boolean isTestRetryable(ITestResult result)\n+    {\n+        Method method = result.getMethod().getConstructorOrMethod().getMethod();\n+        if (method == null) {\n+            return false;\n+        }\n+        if (method.getParameterTypes().length != 0) {\n+            throw new UnsupportedOperationException(\"@Flaky annotation is not yet supported for parametric tests\");\n+        }\n+        return method.getAnnotation(Flaky.class) != null;\n+    }\n+\n+    public static String getName(ITestNGMethod method)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzOTQwOA==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472939408", "bodyText": "This one should not be public.", "author": "kokosing", "createdAt": "2020-08-19T10:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5MzcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTM5Nw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472499397", "bodyText": "I suspect it's hard to write this kind of test but there's no check for the maximum retries count, ie. you do not check what's going to happen when the test fails 3 times.", "author": "lukasz-walkiewicz", "createdAt": "2020-08-18T21:19:34Z", "path": "presto-testng-services/src/test/java/io/prestosql/testng/services/TestFlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.testng.services.FlakyTestRetryAnalyzer.ALLOWED_RETRIES_COUNT;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestFlakyTestRetryAnalyzer", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk0MjY4MQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472942681", "bodyText": "It is hard:\nI tried with:\n    @Flaky\n    @Test(expectedExceptions = AssertionError.class, expectedExceptionsMessageRegExp = \"3\")\n    public void testAlwaysFailingRetrying()\n    {\n        testAlwaysFailingRetryingCount++;\n        fail(\"\" + testAlwaysFailingRetryingCount);\n    }\n\nBut such test just passes so it does not trigger the retrying so it is the same as testRetrying.", "author": "kokosing", "createdAt": "2020-08-19T10:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472500203", "bodyText": "Yeah... not the best name.", "author": "lukasz-walkiewicz", "createdAt": "2020-08-18T21:21:14Z", "path": "presto-testng-services/src/test/java/io/prestosql/testng/services/TestReportUnannotatedMethods.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.Requirements;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import org.testng.annotations.Test;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestReportUnannotatedMethods\n+{\n+    private final ReportUnannotatedMethods instance = new ReportUnannotatedMethods();\n+\n+    @Test\n+    public void testTest()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMTUxMw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472501513", "bodyText": "Actually, the whole class could use less \"test*\" words.", "author": "lukasz-walkiewicz", "createdAt": "2020-08-18T21:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzODU0Mw==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472938543", "bodyText": "Why? The problem is that it noun and verb. This test tests the test. Notice that TestingTest has a method annotated with @Test. While other test cases are different.\nWhat do you suggest?", "author": "kokosing", "createdAt": "2020-08-19T10:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4OTYxNQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r473689615", "bodyText": "Actually, the whole class could use less \"test*\" words.\n\nin fact, it's legacy from JUnit 3 era, when Java didn't have annotations and method name stood for @Test; new code shouldn't use such convention\nthere are many, many more test naming problems in Presto, subject for huuuge refactoring some day:\n\nTestXxxx (attribute + object in wrong order) - the standard way of naming this pretty everywhere is XxxxTest / XxxxSpec, etc (natural order: attributive + subject)\nTestingXxxx (gerund + object - too ambiguous) - the standard way of naming this is TestXxxx / MockXxxx / StubXxxx / TestXxxxService / TestXxxxUtil etc (natural order: attribute + object)\ntestSomethingVeryVeryVeryLongWhenSomethingLong - hard to read, camel case is terrible for more descriptive test names; better break Java conventions and allow something_very_very_long_when_something_long (for this reason languages like Kotlin or Groovy allow even spaces and most special chars in identifiers!)", "author": "iirekm", "createdAt": "2020-08-20T07:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzNDk0OQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r473834949", "bodyText": "Actually, the whole class could use less \"test*\" words.\n\nin fact, it's legacy from JUnit 3 era, when Java didn't have annotations and method name stood for @Test; new code shouldn't use such convention\n\nIntellij's \u2318O does not let my find test classes by name, unless they have something in their name\nsimilarily, in a test class with tests  helper methods (normal thing), \u2318F12 does not let me find test methods my name, unless they have something in their name\n-- the naming convention is for us, developers, even more than testng, surefile or whatever", "author": "findepi", "createdAt": "2020-08-20T09:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1MTc4NA==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r473851784", "bodyText": "You need to find by method names probably only because some test classes are huuuge here.\nIf all test classes were small (this is another refactoring needed in some places), you didn't have to find by method names, and class name pattern like *Test is enough.", "author": "iirekm", "createdAt": "2020-08-20T10:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MzQzMA==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r473943430", "bodyText": "If all test classes were small\n\nThen we would use \"find class by name\"", "author": "kokosing", "createdAt": "2020-08-20T12:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "59c9e0eb809773fb65be38736795c7c4854f2216", "url": "https://github.com/trinodb/trino/commit/59c9e0eb809773fb65be38736795c7c4854f2216", "message": "Limit the method visibility", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "3010f308835b9402f0d320afb8c60198d23a2859", "url": "https://github.com/trinodb/trino/commit/3010f308835b9402f0d320afb8c60198d23a2859", "message": "Extract presto-testng-services module", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "00eec020c5785fcf9f3b59336bf882dd715fadb8", "url": "https://github.com/trinodb/trino/commit/00eec020c5785fcf9f3b59336bf882dd715fadb8", "message": "Do not report tempto methods as missing @Test", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "1f90150534b58f7134fc5c95cebeb66b2d42525f", "url": "https://github.com/trinodb/trino/commit/1f90150534b58f7134fc5c95cebeb66b2d42525f", "message": "Do not verify tempto convention test class names", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "e7fc106898977fc448eaa0c8798b2a476a907936", "url": "https://github.com/trinodb/trino/commit/e7fc106898977fc448eaa0c8798b2a476a907936", "message": "Introduce testng FlakyTestRetryAnalyzer", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582", "url": "https://github.com/trinodb/trino/commit/33d6683e702a1cd76217d16e28f7930c165c8582", "message": "Mark flaky Hive product tests", "committedDate": "2020-08-19T19:53:48Z", "type": "commit"}, {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582", "url": "https://github.com/trinodb/trino/commit/33d6683e702a1cd76217d16e28f7930c165c8582", "message": "Mark flaky Hive product tests", "committedDate": "2020-08-19T19:53:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1OTc4OQ==", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r475459789", "bodyText": "FYI A different test method is tagged than originally reported n #4927\nwill follow-up", "author": "findepi", "createdAt": "2020-08-24T09:25:16Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -86,6 +87,7 @@ public void testReadFullAcidPartitionedBucketed()\n     }\n \n     @Test(groups = HIVE_TRANSACTIONAL, timeOut = TEST_TIMEOUT)\n+    @Flaky(issue = \"https://github.com/prestosql/presto/issues/4857\")", "originalCommit": "33d6683e702a1cd76217d16e28f7930c165c8582", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}