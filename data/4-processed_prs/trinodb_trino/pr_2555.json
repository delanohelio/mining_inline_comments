{"pr_number": 2555, "pr_title": "Allow to skip absent Hive partition", "pr_createdAt": "2020-01-20T12:07:14Z", "pr_url": "https://github.com/trinodb/trino/pull/2555", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzNjA4NA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368536084", "bodyText": "Allow to skip empty Hive partition\n\nPlease update the commit message as well", "author": "findepi", "createdAt": "2020-01-20T13:02:46Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -146,6 +146,8 @@ Property Name                                      Description\n                                                    ignored. This is equivalent to the", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzNjQ0Nw==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368536447", "bodyText": "revert", "author": "findepi", "createdAt": "2020-01-20T13:03:39Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -160,7 +161,9 @@ public BackgroundHiveSplitLoader(\n             Executor executor,\n             int loaderConcurrency,\n             boolean recursiveDirWalkerEnabled,\n+            boolean ignoreAbsentPartitions,\n             Optional<ValidWriteIdList> validWriteIds)\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzNzA3OQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368537079", "bodyText": "try add this consistently in: fields, ctor params, ctor assignments\ni know the existing code is a bit messy from this point of view, but eg keep the new filed always right after recursiveDirWalkerEnabled", "author": "findepi", "createdAt": "2020-01-20T13:05:16Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -122,6 +122,7 @@\n     private final DirectoryLister directoryLister;\n     private final int loaderConcurrency;\n     private final boolean recursiveDirWalkerEnabled;\n+    private final boolean ignoreAbsentPartitions;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368550035", "bodyText": "unnecessary change?", "author": "findepi", "createdAt": "2020-01-20T13:35:21Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -130,8 +147,13 @@ private FileStatusIterator(Table table, Path path, FileSystem fileSystem, Direct\n         {\n             this.path = path;\n             this.namenodeStats = namenodeStats;\n+            this.fileStatusIterator = list(table, path, fileSystem, directoryLister);\n+        }\n+\n+        private RemoteIterator<LocatedFileStatus> list(Table table, Path path, FileSystem fileSystem, DirectoryLister directoryLister)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NzUyNA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368557524", "bodyText": "Please elaborate. Method is used in the ctor of FileStatusIterator", "author": "wendigo", "createdAt": "2020-01-20T13:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2MTM4MA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368561380", "bodyText": "Yes, the commit extracts the method while it was \"inline\" in the ctor.\nIt seems like a redundant unrelated change, so please inline it back (unless i am missing something)", "author": "findepi", "createdAt": "2020-01-20T13:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2NDAyNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368564025", "bodyText": "From my perspective it improves readability - I can inline back (revert) this change if it's unnecessary", "author": "wendigo", "createdAt": "2020-01-20T14:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYzNzI2MQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368637261", "bodyText": "OTOH it's a refactor, so would belong to a separate commit.\n(I think it's redundant, so i'd prefer to inline, but no strong feeling about this.)", "author": "findepi", "createdAt": "2020-01-20T16:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwOTI4Mw==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368709283", "bodyText": "Let's keep this code as-is for now, since this refactoring is not related to the PR (we aren't extracting the method to call it from multiple places).", "author": "electrum", "createdAt": "2020-01-20T20:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDQyOQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368550429", "bodyText": "It used to use Collections.emptyIterator(), now it uses emptyIterator.\nThis looks like a non intentional change, please revert.", "author": "findepi", "createdAt": "2020-01-20T13:36:17Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -51,23 +52,26 @@\n     private final DirectoryLister directoryLister;\n     private final NamenodeStats namenodeStats;\n     private final NestedDirectoryPolicy nestedDirectoryPolicy;\n+    private final boolean ignoreAbsentPartitions;\n \n-    private Iterator<LocatedFileStatus> remoteIterator = Collections.emptyIterator();\n+    private Iterator<LocatedFileStatus> remoteIterator = emptyIterator();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MDYyMw==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368550623", "bodyText": "It looks redundant over Collections.emptyIterator. Please remove", "author": "findepi", "createdAt": "2020-01-20T13:36:42Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -168,6 +190,24 @@ private PrestoException processException(IOException exception)\n             }\n             return new PrestoException(HIVE_FILESYSTEM_ERROR, \"Failed to list directory: \" + path, exception);\n         }\n+\n+        private static RemoteIterator<LocatedFileStatus> emptyIterator()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MTQ2Nw==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368551467", "bodyText": "please add a message to assertFalse/True, otherwise the raised exc msg will be little hard to use", "author": "findepi", "createdAt": "2020-01-20T13:38:34Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestIgnoreAbsentPartition.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.PROFILE_SPECIFIC_TESTS;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIgnoreAbsentPartition\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    /**\n+     * This test requires hive.ignore-absent-partitions=true\n+     */\n+    @Test(groups = PROFILE_SPECIFIC_TESTS)\n+    public void testIgnoreAbsentPartitions()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+        assertFalse(hdfsClient.exist(partitionPath));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+        assertTrue(hdfsClient.exist(partitionPath));\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1MTU4OA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368551588", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                /*\n          \n      \n    \n    \n  \n\nbecause the comment is not a javadoc comment", "author": "findepi", "createdAt": "2020-01-20T13:38:51Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestIgnoreAbsentPartition.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.PROFILE_SPECIFIC_TESTS;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIgnoreAbsentPartition\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    /**", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwODM5OA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368708398", "bodyText": "Ignore partitions when the location does not exist rather than failing the query. This skips data that may be expected to be part of the table.", "author": "electrum", "createdAt": "2020-01-20T20:01:23Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -146,6 +146,8 @@ Property Name                                      Description\n                                                    ignored. This is equivalent to the\n                                                    ``hive.mapred.supports.subdirectories`` property in Hive.\n \n+``hive.ignore-absent-partitions``                  Enable ignoring partition location which does not exist.     ``false``", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwODcyNg==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368708726", "bodyText": "Getters should come before setters", "author": "electrum", "createdAt": "2020-01-20T20:02:29Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -255,6 +256,18 @@ public boolean getRecursiveDirWalkerEnabled()\n         return recursiveDirWalkerEnabled;\n     }\n \n+    @Config(\"hive.ignore-absent-partitions\")\n+    public HiveConfig setIgnoreAbsentPartitions(boolean ignoreAbsentPartitions)\n+    {\n+        this.ignoreAbsentPartitions = ignoreAbsentPartitions;\n+        return this;\n+    }\n+\n+    public boolean isIgnoreAbsentPartitions()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwOTQxNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368709415", "bodyText": "Formatting", "author": "electrum", "createdAt": "2020-01-20T20:05:15Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -547,6 +549,7 @@ private static BackgroundHiveSplitLoader backgroundHiveSplitLoader(List<LocatedF\n                 EXECUTOR,\n                 2,\n                 false,\n+false,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMDE4Mg==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368710182", "bodyText": "Add a comment above\n# not dependent on Hadoop version\n\nOtherwise, it might seem related to the previous comment", "author": "electrum", "createdAt": "2020-01-20T20:08:33Z", "path": "presto-product-tests/bin/product-tests-suite-6-non-generic.sh", "diffHunk": "@@ -47,5 +47,10 @@ presto-product-tests/bin/run_on_docker.sh \\\n     -g kafka \\\n     || suite_exit_code=1\n \n+presto-product-tests/bin/run_on_docker.sh \\", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3NzExNg==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368777116", "bodyText": "Sorry, one more change. Let's clarify this as \"file system location\"", "author": "electrum", "createdAt": "2020-01-21T01:34:26Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -146,6 +146,10 @@ Property Name                                      Description\n                                                    ignored. This is equivalent to the\n                                                    ``hive.mapred.supports.subdirectories`` property in Hive.\n \n+``hive.ignore-absent-partitions``                  Ignore partitions when the location does not exist rather    ``false``", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3NzMxMg==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368777312", "bodyText": "Revert this formatting change", "author": "electrum", "createdAt": "2020-01-21T01:35:44Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -130,10 +146,10 @@ private FileStatusIterator(Table table, Path path, FileSystem fileSystem, Direct\n         {\n             this.path = path;\n             this.namenodeStats = namenodeStats;\n+\n             try {\n                 this.fileStatusIterator = directoryLister.list(fileSystem, table, path);\n-            }\n-            catch (IOException e) {\n+            } catch(IOException e) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3NzQ0OA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368777448", "bodyText": "Move to after recursiveDirWalkerEnabled", "author": "electrum", "createdAt": "2020-01-21T01:36:22Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -173,6 +175,7 @@ public BackgroundHiveSplitLoader(\n         this.recursiveDirWalkerEnabled = recursiveDirWalkerEnabled;\n         this.executor = executor;\n         this.partitions = new ConcurrentLazyQueue<>(partitions);\n+        this.ignoreAbsentPartitions = ignoreAbsentPartitions;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3Nzc4NQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368777785", "bodyText": "Nit: static import the method since the name is self-descriptive and thus the Collections prefix doesn't provide any value", "author": "electrum", "createdAt": "2020-01-21T01:38:31Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -108,10 +111,23 @@ protected LocatedFileStatus computeNext()\n     private Iterator<LocatedFileStatus> getLocatedFileStatusRemoteIterator(Path path)\n     {\n         try (TimeStat.BlockTimer ignored = namenodeStats.getListLocatedStatus().time()) {\n+            if (ignoreAbsentPartitions && !exists(path)) {\n+                return Collections.emptyIterator();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MDE3NQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368940175", "bodyText": "nit, please feel free to ignore:\n\nline \"This skips data that may be expected to be part of the table\" does not seem to be adding more context.", "author": "ankitdixit", "createdAt": "2020-01-21T11:09:34Z", "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -146,6 +146,10 @@ Property Name                                      Description\n                                                    ignored. This is equivalent to the\n                                                    ``hive.mapred.supports.subdirectories`` property in Hive.\n \n+``hive.ignore-absent-partitions``                  Ignore partitions when the file system location does not     ``false``\n+                                                   exist rather than failing the query. This skips data that", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk1MTc3Ng==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r368951776", "bodyText": "@ankitdixit it's exactly as @electrum requested :)", "author": "wendigo", "createdAt": "2020-01-21T11:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MDE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3NTYzNw==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369475637", "bodyText": "revert", "author": "findepi", "createdAt": "2020-01-22T10:20:26Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveFileIterator.java", "diffHunk": "@@ -130,6 +146,7 @@ private FileStatusIterator(Table table, Path path, FileSystem fileSystem, Direct\n         {\n             this.path = path;\n             this.namenodeStats = namenodeStats;\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3NjAzNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369476035", "bodyText": "remove WithSessionProperties part because it doesn't add more information", "author": "findepi", "createdAt": "2020-01-22T10:21:10Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3NjI3NQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369476275", "bodyText": "i'd static import the isIgnoreAbsentPartitions method and inline the variable", "author": "findepi", "createdAt": "2020-01-22T10:21:38Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -207,6 +207,8 @@ public ConnectorSplitSource getSplits(\n \n         Iterable<HivePartitionMetadata> hivePartitions = getPartitionMetadata(session, metastore, table, tableName, partitions, bucketHandle.map(HiveBucketHandle::toTableBucketProperty));\n \n+        boolean ignoreAbsentPartitions = !hiveTable.getPartitionColumns().isEmpty() && HiveSessionProperties.isIgnoreAbsentPartitions(session);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3NzQ3Ng==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369477476", "bodyText": "remove IF NOT EXISTS\nif you want the test to be repeatable (even if fails), add \"DROP TABLE \" + tableName before the CREATE.\nThis ensures this is our test table, with expected data & schema, not something else.", "author": "findepi", "createdAt": "2020-01-22T10:24:11Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", tableNameInDatabase));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", partitionPath));\n+        assertThat(() -> query(\"SELECT count(*) FROM \" + tableNameInDatabase)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+    }\n+\n+    @Test\n+    public void testShouldThrowErrorOnUnpartitionedTableMissingData()\n+    {\n+        String tableName = \"unpartitioned_absent_table_data\";\n+        String tablePath = \"/user/hive/warehouse/\" + tableName;\n+\n+        assertThat(query(format(\"CREATE TABLE IF NOT EXISTS %s (col INT)\", tableName))).containsOnly(row(0));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3ODQwNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369478405", "bodyText": "just VALUES 1, 2, 3 would do the same\nyou can combine this with create:\nCREATE TABLE unpartitioned_absent_table_data AS VALUES 1, 2, 3", "author": "findepi", "createdAt": "2020-01-22T10:25:58Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", tableNameInDatabase));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", partitionPath));\n+        assertThat(() -> query(\"SELECT count(*) FROM \" + tableNameInDatabase)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+    }\n+\n+    @Test\n+    public void testShouldThrowErrorOnUnpartitionedTableMissingData()\n+    {\n+        String tableName = \"unpartitioned_absent_table_data\";\n+        String tablePath = \"/user/hive/warehouse/\" + tableName;\n+\n+        assertThat(query(format(\"CREATE TABLE IF NOT EXISTS %s (col INT)\", tableName))).containsOnly(row(0));\n+        assertThat(query(format(\"INSERT INTO %s (col) VALUES (1), (2), (3)\", tableName))).containsOnly(row(3));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3OTIxNQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369479215", "bodyText": "Since the table is not partitioned, the message should say \"Table location\".\nBut i understand that's pre-existing, let's not change this now.", "author": "findepi", "createdAt": "2020-01-22T10:27:34Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", tableNameInDatabase));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", partitionPath));\n+        assertThat(() -> query(\"SELECT count(*) FROM \" + tableNameInDatabase)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+    }\n+\n+    @Test\n+    public void testShouldThrowErrorOnUnpartitionedTableMissingData()\n+    {\n+        String tableName = \"unpartitioned_absent_table_data\";\n+        String tablePath = \"/user/hive/warehouse/\" + tableName;\n+\n+        assertThat(query(format(\"CREATE TABLE IF NOT EXISTS %s (col INT)\", tableName))).containsOnly(row(0));\n+        assertThat(query(format(\"INSERT INTO %s (col) VALUES (1), (2), (3)\", tableName))).containsOnly(row(3));\n+        assertThat(query(\"SELECT COUNT(1) FROM \" + tableName)).containsOnly(row(3));\n+\n+        assertTrue(hdfsClient.exist(tablePath));\n+        hdfsClient.delete(tablePath);\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        assertThat(() -> query(\"SELECT COUNT(1) FROM \" + tableName)).failsWithMessage(\"Partition location does not exist\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4MDA3MQ==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369480071", "bodyText": "Here & above, per our conventions:\n\nlowercase count (uppercase keywords from the grammar, generally lowercase everything else)\ncount(*) is \"more typical\" than count(1)", "author": "findepi", "createdAt": "2020-01-22T10:29:06Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", tableNameInDatabase));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", partitionPath));\n+        assertThat(() -> query(\"SELECT count(*) FROM \" + tableNameInDatabase)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+    }\n+\n+    @Test\n+    public void testShouldThrowErrorOnUnpartitionedTableMissingData()\n+    {\n+        String tableName = \"unpartitioned_absent_table_data\";\n+        String tablePath = \"/user/hive/warehouse/\" + tableName;\n+\n+        assertThat(query(format(\"CREATE TABLE IF NOT EXISTS %s (col INT)\", tableName))).containsOnly(row(0));\n+        assertThat(query(format(\"INSERT INTO %s (col) VALUES (1), (2), (3)\", tableName))).containsOnly(row(3));\n+        assertThat(query(\"SELECT COUNT(1) FROM \" + tableName)).containsOnly(row(3));\n+\n+        assertTrue(hdfsClient.exist(tablePath));\n+        hdfsClient.delete(tablePath);\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        assertThat(() -> query(\"SELECT COUNT(1) FROM \" + tableName)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(() -> query(\"SELECT COUNT(1) FROM \" + tableName)).failsWithMessage(\"Partition location does not exist\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4MDM1OA==", "url": "https://github.com/trinodb/trino/pull/2555#discussion_r369480358", "bodyText": "remove IF EXISTS, as it must exist at this point\nyou don't need to assert here. It's just cleanup, not part of the test.", "author": "findepi", "createdAt": "2020-01-22T10:29:38Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveIgnoreAbsentPartitions.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.hive;\n+\n+import com.google.inject.Inject;\n+import io.prestosql.tempto.ProductTest;\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import io.prestosql.tempto.fulfillment.table.MutableTablesState;\n+import io.prestosql.tempto.hadoop.hdfs.HdfsClient;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.Row.row;\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.fulfillment.table.MutableTableRequirement.State.LOADED;\n+import static io.prestosql.tempto.fulfillment.table.TableRequirements.mutableTable;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.hive.HiveTableDefinitions.NATION_PARTITIONED_BY_BIGINT_REGIONKEY;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestHiveIgnoreAbsentPartitions\n+        extends ProductTest\n+        implements RequirementsProvider\n+{\n+    @Inject\n+    private MutableTablesState tablesState;\n+\n+    @Inject\n+    private HdfsClient hdfsClient;\n+\n+    @Override\n+    public Requirement getRequirements(Configuration configuration)\n+    {\n+        return mutableTable(NATION_PARTITIONED_BY_BIGINT_REGIONKEY, \"test_table\", LOADED);\n+    }\n+\n+    @Test\n+    public void testIgnoreAbsentPartitionsWithSessionProperties()\n+    {\n+        String tableNameInDatabase = tablesState.get(\"test_table\").getNameInDatabase();\n+        String partitionPath = format(\"/user/hive/warehouse/%s/p_regionkey=9999\", tableNameInDatabase);\n+\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", tableNameInDatabase));\n+        query(format(\"CALL hive.system.create_empty_partition('default', '%s', array['p_regionkey'], array['9999'])\", tableNameInDatabase));\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        hdfsClient.delete(partitionPath);\n+        assertFalse(hdfsClient.exist(partitionPath), format(\"Expected partition %s to not exist\", partitionPath));\n+        assertThat(() -> query(\"SELECT count(*) FROM \" + tableNameInDatabase)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(query(\"SELECT count(*) FROM \" + tableNameInDatabase)).containsOnly(row(15));\n+    }\n+\n+    @Test\n+    public void testShouldThrowErrorOnUnpartitionedTableMissingData()\n+    {\n+        String tableName = \"unpartitioned_absent_table_data\";\n+        String tablePath = \"/user/hive/warehouse/\" + tableName;\n+\n+        assertThat(query(format(\"CREATE TABLE IF NOT EXISTS %s (col INT)\", tableName))).containsOnly(row(0));\n+        assertThat(query(format(\"INSERT INTO %s (col) VALUES (1), (2), (3)\", tableName))).containsOnly(row(3));\n+        assertThat(query(\"SELECT COUNT(1) FROM \" + tableName)).containsOnly(row(3));\n+\n+        assertTrue(hdfsClient.exist(tablePath));\n+        hdfsClient.delete(tablePath);\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = false\");\n+        assertThat(() -> query(\"SELECT COUNT(1) FROM \" + tableName)).failsWithMessage(\"Partition location does not exist\");\n+\n+        query(\"SET SESSION hive.ignore_absent_partitions = true\");\n+        assertThat(() -> query(\"SELECT COUNT(1) FROM \" + tableName)).failsWithMessage(\"Partition location does not exist\");\n+\n+        assertThat(query(\"DROP TABLE IF EXISTS \" + tableName));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "846cbdef958e3ca852eea7a86e30057f9aa56084", "url": "https://github.com/trinodb/trino/commit/846cbdef958e3ca852eea7a86e30057f9aa56084", "message": "Allow to skip absent Hive partition", "committedDate": "2020-01-24T09:57:17Z", "type": "commit"}, {"oid": "846cbdef958e3ca852eea7a86e30057f9aa56084", "url": "https://github.com/trinodb/trino/commit/846cbdef958e3ca852eea7a86e30057f9aa56084", "message": "Allow to skip absent Hive partition", "committedDate": "2020-01-24T09:57:17Z", "type": "forcePushed"}]}