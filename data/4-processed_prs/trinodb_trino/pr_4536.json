{"pr_number": 4536, "pr_title": "Support the TIME type in the Iceberg connector", "pr_createdAt": "2020-07-22T14:27:03Z", "pr_url": "https://github.com/trinodb/trino/pull/4536", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDIzNA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471144234", "bodyText": "Use roundDiv(marker.getValue(), PICOSECONDS_PER_MICROSECOND) from io.prestosql.spi.type.Timestamps so that it works correctly with negative epoch values and does rounding (which is the expected Presto behavior when going to a lower precision time value).", "author": "electrum", "createdAt": "2020-08-16T18:35:13Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -181,6 +183,10 @@ private static Object getIcebergLiteralValue(Type type, Marker marker)\n             return toIntExact(((Long) marker.getValue()));\n         }\n \n+        if (type instanceof TimeType) {\n+            return ((long) marker.getValue()) / PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MTQ5OQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471571499", "bodyText": "TIME type doesn't use epoch (it's just picoseconds since midnight), and its values cannot be negative, so this is unnecessary.", "author": "martint", "createdAt": "2020-08-17T15:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NTQwOQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471645409", "bodyText": "Left as it is.", "author": "djsstarburst", "createdAt": "2020-08-17T17:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMzUxOA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471723518", "bodyText": "We still need rounding, right?", "author": "electrum", "createdAt": "2020-08-17T19:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxMzI1Mw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471813253", "bodyText": "@electrum, I should assume the question is directed at @martint, right?", "author": "djsstarburst", "createdAt": "2020-08-17T22:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDQzMg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471144432", "bodyText": "roundDiv", "author": "electrum", "createdAt": "2020-08-16T18:37:15Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSink.java", "diffHunk": "@@ -361,6 +363,9 @@ public static Object getIcebergValue(Block block, int position, Type type)\n         if (type instanceof DoubleType) {\n             return type.getDouble(block, position);\n         }\n+        if (type instanceof TimeType) {\n+            return type.getLong(block, position) / PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NTQ4NQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471645485", "bodyText": "Based on @martint's previous comment, left as it is.", "author": "djsstarburst", "createdAt": "2020-08-17T17:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDY2MA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471144660", "bodyText": "I like to introduce a method for these types of switch expressions, since it looks cleaner than assign+break:\nswitch (type.typeId()) {\n    case FIXED:\n    case BINARY:\n        return ...;\n    case TIME:\n        return ...;\n}\nIn Java 14, we will be able to do\nString partitionValue = switch (type.typeId()) {\n    case FIXED, BINARY -> ... ;\n    case TIME -> ... ;\n}", "author": "electrum", "createdAt": "2020-08-16T18:39:42Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergSplitSource.java", "diffHunk": "@@ -126,12 +124,18 @@ private ConnectorSplit toIcebergSplit(FileScanTask task)\n             }\n             else {\n                 String partitionValue;\n-                if (type.typeId() == FIXED || type.typeId() == BINARY) {\n-                    // this is safe because Iceberg PartitionData directly wraps the byte array\n-                    partitionValue = new String(((ByteBuffer) value).array(), UTF_8);\n-                }\n-                else {\n-                    partitionValue = value.toString();\n+                switch (type.typeId()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NTg1OA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471645858", "bodyText": "Done, and much nicer.  Since in String.valueOf((Long) value), the cast to Long is redundant, the former TIME case is correctly handled by the default case, as pointed out by Intellij.", "author": "djsstarburst", "createdAt": "2020-08-17T17:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDg5OQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471144899", "bodyText": "Static import", "author": "electrum", "createdAt": "2020-08-16T18:42:16Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PartitionTable.java", "diffHunk": "@@ -300,6 +301,9 @@ private static Object convert(Object value, Type type)\n             }\n             return utcMillis;\n         }\n+        if (type instanceof Types.TimeType) {\n+            return ((Long) value) * Timestamps.PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NTk5NQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471645995", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-08-17T17:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NDg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NTI3Mw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471545273", "bodyText": "Name the class TimeMicrosValueWriter and check the logical type outside, then we don't need to specialize inside the writer code.", "author": "electrum", "createdAt": "2020-08-17T15:09:26Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/valuewriter/TimeValueWriter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer.valuewriter;\n+\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.type.Timestamps;\n+import io.prestosql.spi.type.Type;\n+import org.apache.parquet.column.values.ValuesWriter;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class TimeValueWriter\n+        extends PrimitiveValueWriter\n+{\n+    private final Type type;\n+    private final boolean scaleValue;\n+\n+    public TimeValueWriter(ValuesWriter valuesWriter, Type type, PrimitiveType parquetType)\n+    {\n+        super(parquetType, valuesWriter);\n+        this.type = requireNonNull(type, \"type is null\");\n+        this.scaleValue = parquetType.isPrimitive() && parquetType.getOriginalType() == OriginalType.TIME_MICROS;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NjU4Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471646586", "bodyText": "Done.  It's great to remove that grotty check in the writer!", "author": "djsstarburst", "createdAt": "2020-08-17T17:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NTI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NTMzMw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471545333", "bodyText": "roundDiv", "author": "electrum", "createdAt": "2020-08-17T15:09:33Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/valuewriter/TimeValueWriter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer.valuewriter;\n+\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.type.Timestamps;\n+import io.prestosql.spi.type.Type;\n+import org.apache.parquet.column.values.ValuesWriter;\n+import org.apache.parquet.schema.OriginalType;\n+import org.apache.parquet.schema.PrimitiveType;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class TimeValueWriter\n+        extends PrimitiveValueWriter\n+{\n+    private final Type type;\n+    private final boolean scaleValue;\n+\n+    public TimeValueWriter(ValuesWriter valuesWriter, Type type, PrimitiveType parquetType)\n+    {\n+        super(parquetType, valuesWriter);\n+        this.type = requireNonNull(type, \"type is null\");\n+        this.scaleValue = parquetType.isPrimitive() && parquetType.getOriginalType() == OriginalType.TIME_MICROS;\n+    }\n+\n+    @Override\n+    public void write(Block block)\n+    {\n+        for (int i = 0; i < block.getPositionCount(); i++) {\n+            if (!block.isNull(i)) {\n+                long value = type.getLong(block, i);\n+                long scaledValue = scaleValue ? value / Timestamps.PICOSECONDS_PER_MICROSECOND : value;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NjcxNQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471646715", "bodyText": "Per @martint's comment, left as is.", "author": "djsstarburst", "createdAt": "2020-08-17T17:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NTMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDAwMQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471550001", "bodyText": "roundDiv", "author": "electrum", "createdAt": "2020-08-17T15:16:32Z", "path": "presto-orc/src/main/java/io/prestosql/orc/writer/TimeColumnWriter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.orc.writer;\n+\n+import io.prestosql.orc.metadata.CompressionKind;\n+import io.prestosql.orc.metadata.OrcColumnId;\n+import io.prestosql.orc.metadata.statistics.LongValueStatisticsBuilder;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.function.Supplier;\n+\n+import static io.prestosql.spi.type.Timestamps.PICOSECONDS_PER_MICROSECOND;\n+\n+public class TimeColumnWriter\n+        extends LongColumnWriter\n+{\n+    public TimeColumnWriter(\n+            OrcColumnId columnId,\n+            Type type,\n+            CompressionKind compression,\n+            int bufferSize,\n+            Supplier<LongValueStatisticsBuilder> statisticsBuilderSupplier)\n+    {\n+        super(columnId, type, compression, bufferSize, statisticsBuilderSupplier);\n+    }\n+\n+    @Override\n+    protected long transformValue(long value)\n+    {\n+        return value / PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NjgyNw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471646827", "bodyText": "Per @martint's comment, left as is.", "author": "djsstarburst", "createdAt": "2020-08-17T17:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2OTk5MA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471569990", "bodyText": "Can use *=", "author": "electrum", "createdAt": "2020-08-17T15:45:43Z", "path": "presto-orc/src/main/java/io/prestosql/orc/reader/TimeColumnReader.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.orc.reader;\n+\n+import io.prestosql.memory.context.LocalMemoryContext;\n+import io.prestosql.orc.OrcColumn;\n+import io.prestosql.orc.OrcCorruptionException;\n+import io.prestosql.spi.type.Type;\n+\n+import static io.prestosql.spi.type.Timestamps.PICOSECONDS_PER_MICROSECOND;\n+\n+public class TimeColumnReader\n+        extends LongColumnReader\n+{\n+    public TimeColumnReader(Type type, OrcColumn column, LocalMemoryContext systemMemoryContext)\n+            throws OrcCorruptionException\n+    {\n+        super(type, column, systemMemoryContext);\n+    }\n+\n+    @Override\n+    protected void maybeTransformValues(long[] values, int nextBatchSize)\n+    {\n+        for (int i = 0; i < nextBatchSize; i++) {\n+            values[i] = values[i] * PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NjkzMw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471646933", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-08-17T17:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2OTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDQ1Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471570456", "bodyText": "checkArgument(orcType == LONG, \"wrong ORC type for time type: %s\", orcType);", "author": "electrum", "createdAt": "2020-08-17T15:46:24Z", "path": "presto-orc/src/main/java/io/prestosql/orc/writer/ColumnWriters.java", "diffHunk": "@@ -47,6 +48,9 @@ public static ColumnWriter createColumnWriter(\n             Supplier<BloomFilterBuilder> bloomFilterBuilder)\n     {\n         requireNonNull(type, \"type is null\");\n+        if (type instanceof TimeType) {\n+            return new TimeColumnWriter(columnId, type, compression, bufferSize, () -> new IntegerStatisticsBuilder(bloomFilterBuilder.get()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0NzA1Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471647056", "bodyText": "Added.", "author": "djsstarburst", "createdAt": "2020-08-17T17:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDQ1Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMzkxMg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471723912", "bodyText": "Add a comment that this is for Iceberg", "author": "electrum", "createdAt": "2020-08-17T19:20:08Z", "path": "presto-orc/src/main/java/io/prestosql/orc/writer/ColumnWriters.java", "diffHunk": "@@ -48,6 +51,10 @@ public static ColumnWriter createColumnWriter(\n     {\n         requireNonNull(type, \"type is null\");\n         OrcType orcType = orcTypes.get(columnId);\n+        if (type instanceof TimeType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1NzY0Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471757646", "bodyText": "Added.", "author": "djsstarburst", "createdAt": "2020-08-17T20:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMzkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNDQwNA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471724404", "bodyText": "Comment that this is for Iceberg", "author": "electrum", "createdAt": "2020-08-17T19:21:06Z", "path": "presto-orc/src/main/java/io/prestosql/orc/TupleDomainOrcPredicate.java", "diffHunk": "@@ -189,6 +191,9 @@ public static Domain getDomain(Type type, long rowCount, ColumnStatistics column\n \n         boolean hasNullValue = columnStatistics.getNumberOfValues() != rowCount;\n \n+        if (type instanceof TimeType && columnStatistics.getIntegerStatistics() != null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1NzYyNw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471757627", "bodyText": "Added.", "author": "djsstarburst", "createdAt": "2020-08-17T20:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNTEyNg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471725126", "bodyText": "I think you accidentally removed the case for TIME", "author": "electrum", "createdAt": "2020-08-17T19:22:43Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergSplitSource.java", "diffHunk": "@@ -125,18 +123,22 @@ private ConnectorSplit toIcebergSplit(FileScanTask task)\n                 partitionKeys.put(id, null);\n             }\n             else {\n-                String partitionValue;\n-                if (type.typeId() == FIXED || type.typeId() == BINARY) {\n-                    // this is safe because Iceberg PartitionData directly wraps the byte array\n-                    partitionValue = new String(((ByteBuffer) value).array(), UTF_8);\n-                }\n-                else {\n-                    partitionValue = value.toString();\n-                }\n-                partitionKeys.put(id, partitionValue);\n+                partitionKeys.put(id, partitionValueFromType(type, value));\n             }\n         });\n \n         return Collections.unmodifiableMap(partitionKeys);\n     }\n+\n+    private static String partitionValueFromType(Type type, Object value)\n+    {\n+        switch (type.typeId()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1NzYxNA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471757614", "bodyText": "Since in String.valueOf((Long) value), the cast to Long is redundant, the former TIME case is correctly handled by the default case, as pointed out by Intellij.\n\nNo; as mentioned in this PR comment above, the default case suffices", "author": "djsstarburst", "createdAt": "2020-08-17T20:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNTEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNjY2NA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471726664", "bodyText": "This should only allow time(6). We should probably add a TIME_MICROS constant for createTimeType(6) like I did in the timestamps PR. Then add another check\nif (type instanceof TimestampType) {\n    throw new PrestoException(NOT_SUPPORTED, format(\"Time precision (%s) not supported for Iceberg. Use \\\"time(6)\\\" instead.\", ((TimeType) type).getPrecision()));\n}", "author": "electrum", "createdAt": "2020-08-17T19:25:47Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/TypeConverter.java", "diffHunk": "@@ -176,6 +177,9 @@ public static Type toPrestoType(org.apache.iceberg.types.Type type, TypeManager\n         if (type instanceof MapType) {\n             return fromMap((MapType) type);\n         }\n+        if (type instanceof TimeType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4NjMwMQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r472286301", "bodyText": "Done.", "author": "djsstarburst", "createdAt": "2020-08-18T15:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNjY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczMDQ0Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r471730446", "bodyText": "I realized why this is problematic. In the ORC code, which is generic, we making a huge assumption that the time type is written as a long with microsecond encoding. We should be able to do this in a safe way by checking the iceberg.long-type = TIME attribute from OrcColumn. The code would still have this ugly Iceberg specific logic, but it would be safe if we introduce other usages of TimeType in the future.", "author": "electrum", "createdAt": "2020-08-17T19:34:02Z", "path": "presto-orc/src/main/java/io/prestosql/orc/reader/ColumnReaders.java", "diffHunk": "@@ -32,6 +33,9 @@ public static ColumnReader createColumnReader(\n             OrcBlockFactory blockFactory)\n             throws OrcCorruptionException\n     {\n+        if (type instanceof TimeType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4NTg5NQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r472285895", "bodyText": "I made this change and force-pushed.", "author": "djsstarburst", "createdAt": "2020-08-18T15:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczMDQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NDg5MA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473174890", "bodyText": "Verify three things:\n\ntype.precision == 6\ncolumn.getColumnType() == LONG\n\"LONG\".equals(column.getAttributes(\"iceberg.long-type\"))", "author": "electrum", "createdAt": "2020-08-19T16:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczMDQ0Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTgxNg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r472279816", "bodyText": "Name this extractTime since it's not specific to hours", "author": "electrum", "createdAt": "2020-08-18T15:21:53Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PartitionTransforms.java", "diffHunk": "@@ -253,6 +257,27 @@ private static Block extractTimestamp(Block block, LongUnaryOperator function)\n         return builder.build();\n     }\n \n+    private static Block hoursFromTime(Block block)\n+    {\n+        return extractHoursFromTime(block, HOURS_DURATION::getValueAsLong);\n+    }\n+\n+    private static Block extractHoursFromTime(Block block, LongUnaryOperator function)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NDAzNg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473074036", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-08-19T14:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTgxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1MjA2Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473152066", "bodyText": "It looks like this didn't require any changes, so we can leave it as-is", "author": "electrum", "createdAt": "2020-08-19T16:20:06Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergSplitSource.java", "diffHunk": "@@ -125,18 +123,22 @@ private ConnectorSplit toIcebergSplit(FileScanTask task)\n                 partitionKeys.put(id, null);\n             }\n             else {\n-                String partitionValue;\n-                if (type.typeId() == FIXED || type.typeId() == BINARY) {\n-                    // this is safe because Iceberg PartitionData directly wraps the byte array\n-                    partitionValue = new String(((ByteBuffer) value).array(), UTF_8);\n-                }\n-                else {\n-                    partitionValue = value.toString();\n-                }\n-                partitionKeys.put(id, partitionValue);\n+                partitionKeys.put(id, partitionValueFromType(type, value));\n             }\n         });\n \n         return Collections.unmodifiableMap(partitionKeys);\n     }\n+\n+    private static String partitionValueFromType(Type type, Object value)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NjIwNw==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473166207", "bodyText": "Change reverted.", "author": "djsstarburst", "createdAt": "2020-08-19T16:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1MjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1MjQ4Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473152486", "bodyText": "TIME_MICROS", "author": "electrum", "createdAt": "2020-08-19T16:20:32Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -181,6 +183,10 @@ private static Object getIcebergLiteralValue(Type type, Marker marker)\n             return toIntExact(((Long) marker.getValue()));\n         }\n \n+        if (type instanceof TimeType) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NjI5NQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473166295", "bodyText": "Changed.", "author": "djsstarburst", "createdAt": "2020-08-19T16:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1MjQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1ODA5MA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473158090", "bodyText": "Can collapse to previous cases", "author": "electrum", "createdAt": "2020-08-19T16:25:35Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/PartitionData.java", "diffHunk": "@@ -134,6 +134,8 @@ public static Object getValue(JsonNode partitionValue, Type type)\n             case LONG:\n             case TIMESTAMP:\n                 return partitionValue.asLong();\n+            case TIME:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2ODY2NQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473168665", "bodyText": "Collapsed.", "author": "djsstarburst", "createdAt": "2020-08-19T16:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1ODA5MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NDU5OQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473164599", "bodyText": "Flip equals() so it's consistent with the others", "author": "electrum", "createdAt": "2020-08-19T16:31:43Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/TypeConverter.java", "diffHunk": "@@ -261,6 +270,9 @@ private static TypeInfo toHiveTypeInfo(Type type)\n         if (DATE.equals(type)) {\n             return HIVE_DATE.getTypeInfo();\n         }\n+        if (type.equals(TIME_MICROS)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2ODYyNA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473168624", "bodyText": "Flipped.", "author": "djsstarburst", "createdAt": "2020-08-19T16:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NDU5OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NTg1OQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473165859", "bodyText": "No need to lowercase format", "author": "electrum", "createdAt": "2020-08-19T16:32:58Z", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -144,6 +145,35 @@ private void testDecimalWithPrecisionAndScale(Session session, FileFormat format\n         dropTable(session, tableName);\n     }\n \n+    @Test\n+    public void testTime()\n+    {\n+        testWithAllFileFormats((session, format) -> testTimeForFormat(session, format, false));\n+    }\n+\n+    @Test\n+    public void testPartitionedByTime()\n+    {\n+        testWithAllFileFormats((session, format) -> testTimeForFormat(session, format, true));\n+    }\n+\n+    private void testTimeForFormat(Session session, FileFormat format, boolean partitioned)\n+    {\n+        String tableName = format(\"test_%s%s_time\", partitioned ? \"partitioned_\" : \"\", format.name().toLowerCase(ENGLISH));\n+        String partitioning = partitioned ? \", partitioning = ARRAY['x']\" : \"\";\n+        assertUpdate(session, format(\"CREATE TABLE %s (x TIME, y BIGINT) WITH (format = '%s'%s)\", tableName, format.name().toLowerCase(ENGLISH), partitioning));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NTMwNg==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473175306", "bodyText": "Removed.", "author": "djsstarburst", "createdAt": "2020-08-19T16:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NTg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2ODQ3MA==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473168470", "bodyText": "No need to wrap here, especially for simple delegation", "author": "electrum", "createdAt": "2020-08-19T16:35:26Z", "path": "presto-orc/src/main/java/io/prestosql/orc/writer/TimeColumnWriter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.orc.writer;\n+\n+import io.prestosql.orc.metadata.CompressionKind;\n+import io.prestosql.orc.metadata.OrcColumnId;\n+import io.prestosql.orc.metadata.statistics.LongValueStatisticsBuilder;\n+import io.prestosql.spi.type.Type;\n+\n+import java.util.function.Supplier;\n+\n+import static io.prestosql.spi.type.Timestamps.PICOSECONDS_PER_MICROSECOND;\n+\n+public class TimeColumnWriter\n+        extends LongColumnWriter\n+{\n+    public TimeColumnWriter(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NTM1Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473175356", "bodyText": "Unwrapped.", "author": "djsstarburst", "createdAt": "2020-08-19T16:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2ODQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2OTU4Ng==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473169586", "bodyText": "Static import\nWe could inline this above\nlong value = type.getLong(block, i) / PICOSECONDS_PER_MICROSECOND;", "author": "electrum", "createdAt": "2020-08-19T16:37:08Z", "path": "presto-parquet/src/main/java/io/prestosql/parquet/writer/valuewriter/TimeMicrosValueWriter.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.parquet.writer.valuewriter;\n+\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.type.Timestamps;\n+import io.prestosql.spi.type.Type;\n+import org.apache.parquet.column.values.ValuesWriter;\n+import org.apache.parquet.schema.PrimitiveType;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class TimeMicrosValueWriter\n+        extends PrimitiveValueWriter\n+{\n+    private final Type type;\n+\n+    public TimeMicrosValueWriter(ValuesWriter valuesWriter, Type type, PrimitiveType parquetType)\n+    {\n+        super(parquetType, valuesWriter);\n+        this.type = requireNonNull(type, \"type is null\");\n+    }\n+\n+    @Override\n+    public void write(Block block)\n+    {\n+        for (int i = 0; i < block.getPositionCount(); i++) {\n+            if (!block.isNull(i)) {\n+                long value = type.getLong(block, i);\n+                long scaledValue = value / Timestamps.PICOSECONDS_PER_MICROSECOND;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjU2OQ==", "url": "https://github.com/trinodb/trino/pull/4536#discussion_r473186569", "bodyText": "Inlined.", "author": "djsstarburst", "createdAt": "2020-08-19T17:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2OTU4Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "ee62fcbd70dda5d05ad99f11d214834bcfb29ff8", "url": "https://github.com/trinodb/trino/commit/ee62fcbd70dda5d05ad99f11d214834bcfb29ff8", "message": "Support the TIME type in the Iceberg connector\n\nThis commit adds support for the TIME type in the Iceberg\nconnector.  The TIME type is stored as microsecond time since\nmidnight UTC in Parquet and ORC, so it occupies an int64.\n\nThe main change was adding Parquet and ORC column readers and writers\nfor TIME that convert between Presto engine picosecond time\nand Iceberg connector native microsecond time.\n\nThis commit incorporates a change from @electrum that added\na few time constants to the Timestamps class.", "committedDate": "2020-08-20T04:13:51Z", "type": "commit"}, {"oid": "ee62fcbd70dda5d05ad99f11d214834bcfb29ff8", "url": "https://github.com/trinodb/trino/commit/ee62fcbd70dda5d05ad99f11d214834bcfb29ff8", "message": "Support the TIME type in the Iceberg connector\n\nThis commit adds support for the TIME type in the Iceberg\nconnector.  The TIME type is stored as microsecond time since\nmidnight UTC in Parquet and ORC, so it occupies an int64.\n\nThe main change was adding Parquet and ORC column readers and writers\nfor TIME that convert between Presto engine picosecond time\nand Iceberg connector native microsecond time.\n\nThis commit incorporates a change from @electrum that added\na few time constants to the Timestamps class.", "committedDate": "2020-08-20T04:13:51Z", "type": "forcePushed"}]}