{"pr_number": 3601, "pr_title": "Quote column name in Phoenix CREATE TABLE statement", "pr_createdAt": "2020-05-03T04:27:55Z", "pr_url": "https://github.com/trinodb/trino/pull/3601", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0OTMzNQ==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r419149335", "bodyText": "That's incorrect error message. We didn't ask to create a column of type quote.\nThis is because getEscapedArgument doesn't support escaping \" within the name.\nIf Phoenix does not support this, we need to filter this out on our side.\nThen, the correct way to exclude this test case would be like here\nhttps://github.com/prestosql/presto/blob/329a48592ecb6c628712ef3648f2e8da7eb33d38/presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestMySqlDistributedQueries.java#L123-L127", "author": "findepi", "createdAt": "2020-05-03T19:37:40Z", "path": "presto-phoenix/src/test/java/io/prestosql/plugin/phoenix/TestPhoenixDistributedQueries.java", "diffHunk": "@@ -136,8 +137,13 @@ public void testCreateSchema()\n     @Override\n     public void testColumnName(String columnName)\n     {\n-        // TODO (https://github.com/prestosql/presto/issues/3466) Phoenix generally lacks quoting in underlying queries\n-        throw new SkipException(\"TODO\");\n+        if (columnName.equals(\"a\\\"quote\")) {\n+            assertThatThrownBy(() -> super.testColumnName(columnName))\n+                    .hasMessageContaining(\"Illegal data. Unsupported sql type: QUOTE\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4NjM2MQ==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r420086361", "bodyText": "@findepi Replaced with isColumnNameRejected. As far as I confirmed, we cannot use double-quotation for column name.", "author": "ebyhr", "createdAt": "2020-05-05T12:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0OTMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5NzE2NA==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r420097164", "bodyText": "@ebyhr thanks!\nplease make sure the column name is cleanly rejected at some point, so that user knows this is illegal column name, not something else.\neg io.prestosql.plugin.mysql.TestMySqlDistributedQueries#isColumnNameRejected verifies the actual exception message contains \"Incorrect column name\"", "author": "findepi", "createdAt": "2020-05-05T13:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0OTMzNQ=="}], "type": "inlineReview"}, {"oid": "acd1cfa40465b9a34f434e822bc0249722d6915c", "url": "https://github.com/trinodb/trino/commit/acd1cfa40465b9a34f434e822bc0249722d6915c", "message": "Quote column name in Phoenix CREATE TABLE statement\n\nAdditionally, enable testColumnName test in Phoenix.", "committedDate": "2020-05-05T12:36:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2OTgxMQ==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r447069811", "bodyText": "@vincentpoon should we go thru toMetadataCasing here before calling getEscapedArgument?", "author": "findepi", "createdAt": "2020-06-29T15:43:56Z", "path": "presto-phoenix/src/main/java/io/prestosql/plugin/phoenix/PhoenixMetadata.java", "diffHunk": "@@ -351,7 +351,7 @@ private JdbcOutputTableHandle createTable(ConnectorSession session, ConnectorTab\n                     typeStatement += \" not null\";\n                     pkNames.add(columnName);\n                 }\n-                columnList.add(format(\"%s %s\", columnName, typeStatement));\n+                columnList.add(format(\"%s %s\", getEscapedArgument(columnName), typeStatement));", "originalCommit": "acd1cfa40465b9a34f434e822bc0249722d6915c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3NzQzOA==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r447177438", "bodyText": "Hmm this code doesn't look right to me (I think it was from another PR I based my original one off of).  Firstly, connection.getMetaData().storesUpperCaseIdentifiers() would always return true, so the method toMetadataCasing isn't really needed.\nPhoenix uppercases identifiers if they aren't quoted.\nIf they are quoted, then it's case sensitive.\nIs there a way for us to tell in Presto whether the user quoted the identifier or not?  Because it seems we should base the uppercase decision off that.", "author": "vincentpoon", "createdAt": "2020-06-29T18:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2OTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0MjU4NQ==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r447242585", "bodyText": "Is there a way for us to tell in Presto whether the user quoted the identifier or not? Because it seems we should base the uppercase decision off that.\n\nnot yet,  working on that -- #17", "author": "findepi", "createdAt": "2020-06-29T20:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2OTgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3Mjg2MA==", "url": "https://github.com/trinodb/trino/pull/3601#discussion_r447072860", "bodyText": "Leave some TODO comment still.\nCurrently the \" in column name leads to SQL injection.\nUse of a\"quote column should produce a reasonable exception message like \"Invalid column name\" or \"Column name cannot contain a quotation sign\".  Then, here you should verify the actual exception message.", "author": "findepi", "createdAt": "2020-06-29T15:48:27Z", "path": "presto-phoenix/src/test/java/io/prestosql/plugin/phoenix/TestPhoenixDistributedQueries.java", "diffHunk": "@@ -134,10 +134,9 @@ public void testCreateSchema()\n     }\n \n     @Override\n-    public void testColumnName(String columnName)\n+    protected boolean isColumnNameRejected(Exception exception, String columnName, boolean delimited)\n     {\n-        // TODO (https://github.com/prestosql/presto/issues/3466) Phoenix generally lacks quoting in underlying queries\n-        throw new SkipException(\"TODO\");\n+        return columnName.equals(\"a\\\"quote\");", "originalCommit": "acd1cfa40465b9a34f434e822bc0249722d6915c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf8c7e5ee566554703eda2cd768b966233287df1", "url": "https://github.com/trinodb/trino/commit/cf8c7e5ee566554703eda2cd768b966233287df1", "message": "Quote column name in Phoenix CREATE TABLE statement\n\nAdditionally, enable testColumnName test in Phoenix.", "committedDate": "2020-10-04T15:46:36Z", "type": "commit"}, {"oid": "cf8c7e5ee566554703eda2cd768b966233287df1", "url": "https://github.com/trinodb/trino/commit/cf8c7e5ee566554703eda2cd768b966233287df1", "message": "Quote column name in Phoenix CREATE TABLE statement\n\nAdditionally, enable testColumnName test in Phoenix.", "committedDate": "2020-10-04T15:46:36Z", "type": "forcePushed"}]}