{"pr_number": 3437, "pr_title": "Allow reading ORC files which do not have row-group information", "pr_createdAt": "2020-04-15T08:11:49Z", "pr_url": "https://github.com/trinodb/trino/pull/3437", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjI3OQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408686279", "bodyText": "Why use a Future here?", "author": "findepi", "createdAt": "2020-04-15T08:56:21Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -59,14 +66,28 @@ public void testReadFullAcid(boolean isPartitioned, BucketingType bucketingType)\n             // test filtering\n             assertThat(query(\"SELECT col, fcol FROM \" + tableName + \" WHERE fcol = 1 ORDER BY col\")).containsOnly(row(21, 1));\n \n+            // test compacted data read\n+            onHive().executeQuery(\n+                    \"INSERT INTO TABLE \" + tableName + hivePartitionString + \" VALUES (20, 3)\");\n+            ExecutorService executor = Executors.newSingleThreadExecutor();\n+            try {\n+                Future result = executor.submit(() ->\n+                        onHive().executeQuery(\"alter table \" + tableName + \" \" + hivePartitionString + \" compact 'minor' and wait\"));\n+                result.get(5, TimeUnit.MINUTES);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMjQ2OQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408702469", "bodyText": "To have an option to timeout. If hive is configured with no compactor threads, then this query will never return.", "author": "shubhamtagra", "createdAt": "2020-04-15T09:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc2NDk0MQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408764941", "bodyText": "we usually use @Test(timeout= for  this", "author": "findepi", "createdAt": "2020-04-15T11:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg2MzcyMw==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r412863723", "bodyText": "used timeout", "author": "shubhamtagra", "createdAt": "2020-04-22T10:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408686741", "bodyText": "upper case SQL keywords (and 'minor' too)", "author": "findepi", "createdAt": "2020-04-15T08:57:03Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -59,14 +66,28 @@ public void testReadFullAcid(boolean isPartitioned, BucketingType bucketingType)\n             // test filtering\n             assertThat(query(\"SELECT col, fcol FROM \" + tableName + \" WHERE fcol = 1 ORDER BY col\")).containsOnly(row(21, 1));\n \n+            // test compacted data read\n+            onHive().executeQuery(\n+                    \"INSERT INTO TABLE \" + tableName + hivePartitionString + \" VALUES (20, 3)\");\n+            ExecutorService executor = Executors.newSingleThreadExecutor();\n+            try {\n+                Future result = executor.submit(() ->\n+                        onHive().executeQuery(\"alter table \" + tableName + \" \" + hivePartitionString + \" compact 'minor' and wait\"));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjgzOQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408686839", "bodyText": "should we test with MAJOR compaction too?", "author": "findepi", "createdAt": "2020-04-15T08:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMzAzNA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408703034", "bodyText": "will do.\nI didnt add major compaction tests as they were not in the context of this fix. Should I add them in the same commit or a separate one?", "author": "shubhamtagra", "createdAt": "2020-04-15T09:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc2NTI2NQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408765265", "bodyText": "can be in one", "author": "findepi", "createdAt": "2020-04-15T11:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc2NjAxMA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r408766010", "bodyText": "i would consider adding an additional enum parameter to test methods like\nenum Compaction { NONE, MINOR, MAJOR }\n\nso that the test code remains shorter, not \"an epic story\" testing various cases one by one", "author": "findepi", "createdAt": "2020-04-15T11:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM3MjQ3Mg==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409372472", "bodyText": "That would increase the number of tests three times and each of these tests is time taking so overall increase in test suite runtime will be considerable. Is that okay @findepi ?", "author": "shubhamtagra", "createdAt": "2020-04-16T08:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MzQwMQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409493401", "bodyText": "Thanks for raising this up. How many seconds will this add?", "author": "findepi", "createdAt": "2020-04-16T11:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4MzM2OQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409683369", "bodyText": "In current PR runs (https://github.com/prestosql/presto/pull/3437/checks?check_run_id=588238426), 16 tests of testReadFullAcid took 8minutes. It would almost triple.", "author": "shubhamtagra", "createdAt": "2020-04-16T16:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg2NDMyMA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r412864320", "bodyText": "Handled casing but left out Compaction as new test parameter, instead added major and minor compaction tests in method", "author": "shubhamtagra", "createdAt": "2020-04-22T10:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Njc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAwNzQ0Nw==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409007447", "bodyText": "The extra parentheses are not needed.  Also I would flip the && and do the > 0 first", "author": "dain", "createdAt": "2020-04-15T17:20:35Z", "path": "presto-orc/src/main/java/io/prestosql/orc/StripeReader.java", "diffHunk": "@@ -133,7 +133,7 @@ public Stripe readStripe(StripeInformation stripe, AggregatedMemoryContext syste\n \n         // handle stripes with more than one row group\n         boolean invalidCheckPoint = false;\n-        if (stripe.getNumberOfRows() > rowsInRowGroup) {\n+        if ((stripe.getNumberOfRows() > rowsInRowGroup) && rowsInRowGroup > 0) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAwOTY5NQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409009695", "bodyText": "There are two other uses of rowsInRowGroup in this file, in the createRowGroups and selectRowGroups methods, which are only called from this if block.  Add checkState calls to both of those methods, so it is clear they should not be used in this case.", "author": "dain", "createdAt": "2020-04-15T17:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAwNzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxMDUzNA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r409010534", "bodyText": "Consider making rowsInRowGroup as OptionalInt, so it is super clear to future maintainers that this value may not be provided.", "author": "dain", "createdAt": "2020-04-15T17:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAwNzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg2NDcyMw==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r412864723", "bodyText": "Done. Handled all three comments.", "author": "shubhamtagra", "createdAt": "2020-04-22T10:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAwNzQ0Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMjQ1MA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417002450", "bodyText": "Maybe do this instead:\nint rowsInRowGroup = this.rowsInRowGroup.orElseThrow(() -> new IllegalStateException(\"Cannot create row groups if row group info is missing\"))\nThen the code below doesn't need to change.", "author": "dain", "createdAt": "2020-04-29T00:23:50Z", "path": "presto-orc/src/main/java/io/prestosql/orc/StripeReader.java", "diffHunk": "@@ -332,12 +333,13 @@ private InputStreamSources createDictionaryStreamSources(Map<StreamId, Stream> s\n             ColumnMetadata<ColumnEncoding> encodings)\n             throws InvalidCheckpointException\n     {\n+        checkState(rowsInRowGroup.isPresent(), \"Cannot create row groups if row group info is missing\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1OTE2Nw==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417059167", "bodyText": "Done", "author": "shubhamtagra", "createdAt": "2020-04-29T04:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMjQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMjQ5NA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417002494", "bodyText": "Same here", "author": "dain", "createdAt": "2020-04-29T00:23:57Z", "path": "presto-orc/src/main/java/io/prestosql/orc/StripeReader.java", "diffHunk": "@@ -438,13 +440,15 @@ static boolean isIndexStream(Stream stream)\n \n     private Set<Integer> selectRowGroups(StripeInformation stripe, Map<StreamId, List<RowGroupIndex>> columnIndexes)\n     {\n+        checkState(rowsInRowGroup.isPresent(), \"Cannot create row groups if row group info is missing\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1OTE4Ng==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417059186", "bodyText": "done", "author": "shubhamtagra", "createdAt": "2020-04-29T04:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMjQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwNDUzMA==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417004530", "bodyText": "Change the argument type instead. That will make it clear in the metadata reader that there is something special about zero.  Then lets verify the value in the optional is at least 1. Something like:\nrowsInRowGroup.ifPresent(value -> checkArgument(value > 0, \"rowsInRowGroup must be at least 1\"));", "author": "dain", "createdAt": "2020-04-29T00:30:02Z", "path": "presto-orc/src/main/java/io/prestosql/orc/metadata/Footer.java", "diffHunk": "@@ -45,7 +46,7 @@ public Footer(\n             Map<String, Slice> userMetadata)\n     {\n         this.numberOfRows = numberOfRows;\n-        this.rowsInRowGroup = rowsInRowGroup;\n+        this.rowsInRowGroup = rowsInRowGroup == 0 ? OptionalInt.empty() : OptionalInt.of(rowsInRowGroup);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1OTI3MQ==", "url": "https://github.com/trinodb/trino/pull/3437#discussion_r417059271", "bodyText": "done", "author": "shubhamtagra", "createdAt": "2020-04-29T04:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwNDUzMA=="}], "type": "inlineReview"}, {"oid": "e8b8107702a8615c805687a263eac2671840c246", "url": "https://github.com/trinodb/trino/commit/e8b8107702a8615c805687a263eac2671840c246", "message": "Allow reading ORC files which do not have row-group information", "committedDate": "2020-04-29T04:21:20Z", "type": "commit"}, {"oid": "e8b8107702a8615c805687a263eac2671840c246", "url": "https://github.com/trinodb/trino/commit/e8b8107702a8615c805687a263eac2671840c246", "message": "Allow reading ORC files which do not have row-group information", "committedDate": "2020-04-29T04:21:20Z", "type": "forcePushed"}]}