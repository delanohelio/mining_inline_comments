{"pr_number": 5143, "pr_title": "Product tests improvements", "pr_createdAt": "2020-09-11T17:00:02Z", "pr_url": "https://github.com/trinodb/trino/pull/5143", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIwOTAxNg==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487209016", "bodyText": "private?", "author": "losipiuk", "createdAt": "2020-09-11T18:11:04Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -173,6 +261,16 @@ public Builder removeContainer(String name)\n         }\n \n         public Environment build()\n+        {\n+            return build(Optional.empty());\n+        }\n+\n+        public Environment build(EnvironmentListener listener)\n+        {\n+            return build(Optional.of(listener));\n+        }\n+\n+        protected Environment build(Optional<EnvironmentListener> listener)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIwOTI5OA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487209298", "bodyText": "nit: I would drop \"on\" prefix from the methods.", "author": "losipiuk", "createdAt": "2020-09-11T18:11:39Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.product.launcher.env;\n+\n+import com.github.dockerjava.api.command.InspectContainerResponse;\n+import io.airlift.log.Logger;\n+\n+import java.util.List;\n+\n+public interface EnvironmentListener", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODAyOA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487218028", "bodyText": "this can be moved to commit which introduced compose", "author": "losipiuk", "createdAt": "2020-09-11T18:29:22Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -54,56 +56,56 @@ default void onContainerStopped(DockerContainer container, InspectContainerRespo\n     {\n     }\n \n-    static EnvironmentListener compose(List<EnvironmentListener> listeners)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODYyMA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487218620", "bodyText": "make logBaseDir non-empty and instead do not create listener in code flow when now you create it with Optional.empty()", "author": "losipiuk", "createdAt": "2020-09-11T18:30:32Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -161,4 +163,24 @@ public void onContainerStopped(DockerContainer container, InspectContainerRespon\n             }\n         };\n     }\n+\n+    static EnvironmentListener logCopyingListener(Optional<Path> logBaseDir)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMzc5OA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487233798", "bodyText": "I think it will make code less readable", "author": "wendigo", "createdAt": "2020-09-11T19:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI0MTM5NA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487241394", "bodyText": "But more proper imo. You can create some external helper tooling to construct proper listener set. Logging listener should not allow empty log pth", "author": "losipiuk", "createdAt": "2020-09-11T19:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MzgzOQ==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487283839", "bodyText": "Fixed.", "author": "wendigo", "createdAt": "2020-09-11T20:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODY4Mw==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487218683", "bodyText": "why do we need this one?", "author": "losipiuk", "createdAt": "2020-09-11T18:30:41Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -161,4 +163,24 @@ public void onContainerStopped(DockerContainer container, InspectContainerRespon\n             }\n         };\n     }\n+\n+    static EnvironmentListener logCopyingListener(Optional<Path> logBaseDir)\n+    {\n+        if (logBaseDir.isEmpty()) {\n+            return noop();\n+        }\n+\n+        return new EnvironmentListener() {\n+            @Override\n+            public void onContainerStopping(DockerContainer container, InspectContainerResponse response)\n+            {\n+                container.copyLogsToHostPath(logBaseDir.get());\n+            }\n+        };\n+    }\n+\n+    static EnvironmentListener noop()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyOTA4OA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487229088", "bodyText": "if (logBaseDir.isEmpty()) {\n            return noop();\n }", "author": "wendigo", "createdAt": "2020-09-11T18:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxODY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMDk2NA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487220964", "bodyText": "I think it is fine to leave if it works", "author": "losipiuk", "createdAt": "2020-09-11T18:35:43Z", "path": ".github/workflows/ci.yml", "diffHunk": "@@ -298,5 +298,5 @@ jobs:\n           rm -rf ~/.m2/repository\n       - name: Product Tests\n         run: |\n-          presto-product-tests-launcher/bin/run-launcher suite run --suite ${{ matrix.suite }} --config ${{ matrix.config }} --no-bind\n+          presto-product-tests-launcher/bin/run-launcher suite run --suite ${{ matrix.suite }} --config ${{ matrix.config }} --no-bind --logs-dir logs/", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMzMxMg==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487233312", "bodyText": "\ud83d\udc4d\ud83c\udffb", "author": "wendigo", "createdAt": "2020-09-11T19:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMDk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzM2OQ==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487377369", "bodyText": "Change commit name", "author": "losipiuk", "createdAt": "2020-09-12T06:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMDk2NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzI2MQ==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487377261", "bodyText": "This should be in different commit", "author": "losipiuk", "createdAt": "2020-09-12T06:47:42Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -155,26 +153,70 @@ private void copyFileToContainer(String containerPath, Runnable copy)\n         log.info(\"Copied files into %s %s in %.1f s\", this, containerPath, stopwatch.elapsed(MILLISECONDS) / 1000.);\n     }\n \n-    // Mounting a non-existing file results in docker creating a directory. This is often not the desired effect. Fail fast instead.\n-    private static void verifyHostPath(String hostPath)\n+    public void clearDependencies()\n     {\n-        if (!Files.exists(Paths.get(hostPath))) {\n-            throw new IllegalArgumentException(\"Host path does not exist: \" + hostPath);\n+        dependencies.clear();\n+    }\n+\n+    public void copyLogsToHostPath(Path hostPath)\n+    {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQyOTcwNw==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487429707", "bodyText": "Done.", "author": "wendigo", "createdAt": "2020-09-12T17:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NzE3MA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487677170", "bodyText": "Well - I meant whole migration from exposeLogsInHOstPath to log copying. Currently it is part of Add DockerContainer logical name.", "author": "losipiuk", "createdAt": "2020-09-14T06:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzY0Ng==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487377646", "bodyText": "Can we print to stout also in write mode", "author": "losipiuk", "createdAt": "2020-09-12T06:52:35Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -280,20 +293,24 @@ public Environment build(EnvironmentListener listener)\n \n         private Environment build(Optional<EnvironmentListener> listener)\n         {\n-            // write directly to System.out, bypassing logging & io.airlift.log.Logging#rewireStdStreams\n-            PrintStream out;\n-            try {\n-                //noinspection resource\n-                out = new PrintStream(new FileOutputStream(FileDescriptor.out), true, Charset.defaultCharset().name());\n-            }\n-            catch (UnsupportedEncodingException e) {\n-                throw new RuntimeException(e);\n+            switch (outputMode) {\n+                case DISCARD:\n+                    log.warn(\"Containers logs are not printed to stdout\");\n+                    setContainerOutputConsumer(this::discardContainerLogs);\n+                    break;\n+\n+                case PRINT:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4ODg4NA==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487388884", "bodyText": "I've added PRINT_WRITE mode \ud83d\udc4d\ud83c\udffb", "author": "wendigo", "createdAt": "2020-09-12T09:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzczOQ==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487377739", "bodyText": "Separate commit?", "author": "losipiuk", "createdAt": "2020-09-12T06:53:49Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -304,7 +321,57 @@ private Environment build(Optional<EnvironmentListener> listener)\n                         });\n             });\n \n-            return new Environment(name, containers, listener);\n+            return new Environment(name, startupRetries, containers, listener);\n+        }\n+\n+        private Consumer<OutputFrame> writeContainerLogs(DockerContainer container, Path path)\n+        {\n+            Path containerLogFile = path.resolve(container.getLogicalName() + \"/container.log\");\n+            log.info(\"Writing container %s logs to %s\", container, containerLogFile);\n+\n+            try {\n+                ensurePathExists(containerLogFile.getParent());\n+                return new PrintingLogConsumer(new PrintStream(containerLogFile.toFile()), \"\");\n+            }\n+            catch (FileNotFoundException e) {\n+                throw new UncheckedIOException(e);\n+            }\n+        }\n+\n+        private Consumer<OutputFrame> printContainerLogs(DockerContainer container)\n+        {\n+            try {\n+                // write directly to System.out, bypassing logging & io.airlift.log.Logging#rewireStdStreams\n+                //noinspection resource\n+                PrintStream out = new PrintStream(new FileOutputStream(FileDescriptor.out), true, Charset.defaultCharset().name());\n+                return new PrintingLogConsumer(out, format(\"%-20s| \", container.getLogicalName()));\n+            }\n+            catch (UnsupportedEncodingException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        private Consumer<OutputFrame> discardContainerLogs(DockerContainer container)\n+        {\n+            // Discard log frames\n+            return outputFrame -> {};\n+        }\n+\n+        private void setContainerOutputConsumer(Function<DockerContainer, Consumer<OutputFrame>> consumer)\n+        {\n+            configureContainers(container -> container.withLogConsumer(consumer.apply(container)));\n+        }\n+\n+        public Builder setStartupRetries(int startupRetries)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM5OTc4NQ==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487399785", "bodyText": "Done", "author": "wendigo", "createdAt": "2020-09-12T11:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3NzczOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTY4Mg==", "url": "https://github.com/trinodb/trino/pull/5143#discussion_r487675682", "bodyText": "unrelated to commit", "author": "losipiuk", "createdAt": "2020-09-14T06:23:08Z", "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -73,7 +75,7 @@ public void environmentStarted(Environment environment)\n             @Override\n             public void environmentStopping(Environment environment)\n             {\n-                Arrays.stream(listeners).forEach(listener -> listener.environmentStarted(environment));\n+                Arrays.stream(listeners).forEach(listener -> listener.environmentStopping(environment));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b35b9495d6dfd41f8db2f364eb32df29419e9241", "url": "https://github.com/trinodb/trino/commit/b35b9495d6dfd41f8db2f364eb32df29419e9241", "message": "Improve product tests environment startup", "committedDate": "2020-09-14T09:13:45Z", "type": "commit"}, {"oid": "5f9827d2b317fbe5b042e53f165d276959a9297b", "url": "https://github.com/trinodb/trino/commit/5f9827d2b317fbe5b042e53f165d276959a9297b", "message": "Make EnvironmentDefaults class final", "committedDate": "2020-09-14T09:13:49Z", "type": "commit"}, {"oid": "2debaec7cbe48c16f97934c47376d62e7252d166", "url": "https://github.com/trinodb/trino/commit/2debaec7cbe48c16f97934c47376d62e7252d166", "message": "Add DockerContainer logical name", "committedDate": "2020-09-14T09:21:17Z", "type": "commit"}, {"oid": "d922e881cb1e27ea0ce273580dcf3bef6b7a82aa", "url": "https://github.com/trinodb/trino/commit/d922e881cb1e27ea0ce273580dcf3bef6b7a82aa", "message": "List and copy log files from running container", "committedDate": "2020-09-14T09:33:19Z", "type": "commit"}, {"oid": "a412fe74b2ca75cfdb5ac1d4fb510cb8b355b033", "url": "https://github.com/trinodb/trino/commit/a412fe74b2ca75cfdb5ac1d4fb510cb8b355b033", "message": "Print container stats on container shutdown", "committedDate": "2020-09-14T09:34:00Z", "type": "commit"}, {"oid": "bec0d9761532970f8200fd9a3018e51525634899", "url": "https://github.com/trinodb/trino/commit/bec0d9761532970f8200fd9a3018e51525634899", "message": "Make launcher commands callable", "committedDate": "2020-09-14T09:34:01Z", "type": "commit"}, {"oid": "82f6ed29c5240d1534a4b0f8d662acdf350a5e98", "url": "https://github.com/trinodb/trino/commit/82f6ed29c5240d1534a4b0f8d662acdf350a5e98", "message": "Configure launcher bin location", "committedDate": "2020-09-14T09:34:01Z", "type": "commit"}, {"oid": "7afa90a17b8b9fb8ad706bfc05ca4ec8519e740b", "url": "https://github.com/trinodb/trino/commit/7afa90a17b8b9fb8ad706bfc05ca4ec8519e740b", "message": "Drop environment configuration comments", "committedDate": "2020-09-14T09:34:02Z", "type": "commit"}, {"oid": "85f1cb64c5e2b6adb8b0fbe3ce5acea8ea62be40", "url": "https://github.com/trinodb/trino/commit/85f1cb64c5e2b6adb8b0fbe3ce5acea8ea62be40", "message": "Removeme: copy logs from containers", "committedDate": "2020-09-14T09:34:02Z", "type": "commit"}, {"oid": "f4d9a115adf2e6001d814ba5bf6d6d480dc9b21c", "url": "https://github.com/trinodb/trino/commit/f4d9a115adf2e6001d814ba5bf6d6d480dc9b21c", "message": "Fix suite describe command printing", "committedDate": "2020-09-14T09:34:02Z", "type": "commit"}, {"oid": "05bed984aed44efc2d917687b5c76da0f86fe554", "url": "https://github.com/trinodb/trino/commit/05bed984aed44efc2d917687b5c76da0f86fe554", "message": "Add container output handling modes", "committedDate": "2020-09-14T09:34:02Z", "type": "commit"}, {"oid": "37f5d81270cc1155e49fa0954e9341e686c29f16", "url": "https://github.com/trinodb/trino/commit/37f5d81270cc1155e49fa0954e9341e686c29f16", "message": "Refactor logCopyingListener initialization", "committedDate": "2020-09-14T09:34:33Z", "type": "commit"}, {"oid": "6abf06a0db0172f252c6e6131a026e1dfeed88f5", "url": "https://github.com/trinodb/trino/commit/6abf06a0db0172f252c6e6131a026e1dfeed88f5", "message": "Remove redundant pruneEnvironment call", "committedDate": "2020-09-14T09:34:35Z", "type": "commit"}, {"oid": "ed151e8bcf9d11611c40e8f5ece22997318a302a", "url": "https://github.com/trinodb/trino/commit/ed151e8bcf9d11611c40e8f5ece22997318a302a", "message": "Pass startup retries to environment builder", "committedDate": "2020-09-14T09:34:35Z", "type": "commit"}, {"oid": "ed151e8bcf9d11611c40e8f5ece22997318a302a", "url": "https://github.com/trinodb/trino/commit/ed151e8bcf9d11611c40e8f5ece22997318a302a", "message": "Pass startup retries to environment builder", "committedDate": "2020-09-14T09:34:35Z", "type": "forcePushed"}]}