{"pr_number": 5815, "pr_title": "Ensure QueryManager is called for queries which fail during dispatching ", "pr_createdAt": "2020-11-04T12:03:24Z", "pr_url": "https://github.com/trinodb/trino/pull/5815", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517297775", "bodyText": "Use enum instead", "author": "kokosing", "createdAt": "2020-11-04T12:07:51Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -22,7 +22,7 @@\n {\n     void recordHeartbeat();\n \n-    ListenableFuture<?> getDispatchedFuture();\n+    ListenableFuture<Boolean> getDispatchedFuture();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNTI0Ng==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517305246", "bodyText": "i think boolean is ok, but don't feel strongly.", "author": "findepi", "createdAt": "2020-11-04T12:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNTYyOA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517305628", "bodyText": "Add a javadoc explaining what the future's  payload means", "author": "findepi", "createdAt": "2020-11-04T12:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUxNDYyNQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517514625", "bodyText": "I changed to enum\n    enum DispatchStatus {\n        FAILED, DISPATCHED\n    }", "author": "losipiuk", "createdAt": "2020-11-04T17:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5ODU2Mg==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517298562", "bodyText": "Can you please add test to io.prestosql.connector.system.TestKillQuery. You can use MockConnector to block it on metadata calls so query will remain in waiting for resources state.", "author": "kokosing", "createdAt": "2020-11-04T12:09:24Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n import com.google.common.util.concurrent.AbstractFuture;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMjA4OA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518012088", "bodyText": "@kokosing added.\nIt required some refactoring to TestEventListeners (separate commits)", "author": "losipiuk", "createdAt": "2020-11-05T12:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5ODU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjA1Mg==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517306052", "bodyText": "it's weird to declared \"success\" in the finally block, regardless of the above.\nI think it would be better to .set(true) after querySubmitter.accept( returns cleanly and .set(false) in the finally.", "author": "findepi", "createdAt": "2020-11-04T12:24:17Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -138,7 +138,7 @@ private void startExecution(QueryExecution queryExecution)\n                     throw t;\n                 }\n                 finally {\n-                    submitted.set(null);\n+                    submitted.set(true);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwNzY5Mw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517507693", "bodyText": "Makes sense", "author": "losipiuk", "createdAt": "2020-11-04T17:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjgzOQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517306839", "bodyText": "Remove.\nInstead, please add a test that would fail if this code is reinserted here.", "author": "findepi", "createdAt": "2020-11-04T12:25:30Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "diffHunk": "@@ -124,7 +123,7 @@ public DispatchQuery createDispatchQuery(\n             }\n             catch (Throwable e) {\n                 stateMachine.transitionToFailed(e);\n-                queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(e));\n+                // queryMonitor.queryImmediateFailureEvent will be called by state change listenere registered in DispatchManager.queryCreated", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwODQ2NQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517508465", "bodyText": "I will try. May be hard", "author": "losipiuk", "createdAt": "2020-11-04T17:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjgzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzQ3Nw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517307477", "bodyText": "can it be ! done just yet?\nis here a race condition which may result in double notification?", "author": "findepi", "createdAt": "2020-11-04T12:26:42Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || !getUnchecked(dispatchQuery.getDispatchedFuture())) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2MzM1NA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517463354", "bodyText": "I did not want to depend on listener execution order.\nSpecifically with:\nhttps://github.com/prestosql/presto/blob/bca1470858a7255e7e5e469e9bc019bea311f402/presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java#L88-L93\nWhich actually change the state of dispatchQuery.getDispatchedFuture.\nTechnically maybe this listener I add here could be merged with one I reference ...", "author": "losipiuk", "createdAt": "2020-11-04T16:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzc4Nw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517307787", "bodyText": "getUnchecked -> MoreFutures#getDone", "author": "findepi", "createdAt": "2020-11-04T12:27:16Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || !getUnchecked(dispatchQuery.getDispatchedFuture())) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxMDIxNw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517910217", "bodyText": "{ next line?", "author": "findepi", "createdAt": "2020-11-05T09:33:35Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -20,9 +20,13 @@\n public interface DispatchQuery\n         extends TrackedQuery, ManagedQueryExecution\n {\n+    enum DispatchStatus {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyNzExNw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517927117", "bodyText": "successfully", "author": "findepi", "createdAt": "2020-11-05T09:59:40Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyNzM1MQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517927351", "bodyText": "true -> ..", "author": "findepi", "createdAt": "2020-11-05T10:00:02Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {\n+                    queryMonitor.queryImmediateFailureEvent(dispatchQuery.getBasicQueryInfo(), dispatchQuery.getFullQueryInfo().getFailureInfo());\n+                }\n+                // if dispatchQuery.getDispatchedFuture() == true then query termination will be handled by listener registered in SqlQueryManager.createQuery", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517928530", "bodyText": "i'm concerned about !dispatchQuery.getDispatchedFuture().isDone() part. This may result in double delivery of the event.\nWe could perhaps have the queryMonitor.queryImmediateFailureEvent run as a completion callback on the dispatchQuery.getDispatchedFuture() future?", "author": "findepi", "createdAt": "2020-11-05T10:01:48Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk1MzU0NQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517953545", "bodyText": "Let me see. I think it can be done.", "author": "losipiuk", "createdAt": "2020-11-05T10:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MjY1Ng==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517962656", "bodyText": "With code like this:\n        // capture failures which happen before query is successfully dispatched.\n        addSuccessCallback(dispatchQuery.getDispatchedFuture(),\n                dispatchStatus -> {\n                    if (dispatchStatus == DispatchQuery.DispatchStatus.FAILED) {\n                        queryMonitor.queryImmediateFailureEvent(dispatchQuery.getBasicQueryInfo(), dispatchQuery.getFullQueryInfo().getFailureInfo());\n                    }\n                });\nit seems to work fine.\nI will read code some more to see if I see some issues with it.", "author": "losipiuk", "createdAt": "2020-11-05T10:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDU3MA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517964570", "bodyText": "@findepi I guess we should not use the same-thread-executor here, right? So with this change I would need to provide extra executor do DispatchManager. Does it still make sense to you?", "author": "losipiuk", "createdAt": "2020-11-05T10:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MDIwOA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517970208", "bodyText": "I can also leave original callback on state change, and change the if to:\nif (dispatchQuery.getDispatchedFuture().isDone() && getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {\n\nThis captures  the intent more, but depends on the fact that listeners are called in registration order. That listner which finalizes disaptchedFuture would be called before this one.\nGiven fact that listeners are called asynchronously in separate threads I think this is not the thing we can assume.\nIt feels to me that you proposal with listener on getDispatchedFuture completion is most bullet proof.", "author": "losipiuk", "createdAt": "2020-11-05T11:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzOTA4NQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517939085", "bodyText": "don't use static import for DispatchStatus. QueryState seems to be more commonly used.", "author": "kokosing", "createdAt": "2020-11-05T10:18:41Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -104,9 +104,9 @@ public Session getSession()\n     }\n \n     @Override\n-    public ListenableFuture<?> getDispatchedFuture()\n+    public ListenableFuture<DispatchStatus> getDispatchedFuture()\n     {\n-        return immediateFuture(null);\n+        return immediateFuture(FAILED);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0OTU2NA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517949564", "bodyText": "You can import both. But I can use fully qualified for DispatchStatus if you prefer", "author": "losipiuk", "createdAt": "2020-11-05T10:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzOTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0MTQwMg==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517941402", "bodyText": "nice", "author": "kokosing", "createdAt": "2020-11-05T10:22:12Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -160,8 +160,35 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(session)\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NDQ4MA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517974480", "bodyText": "Thank you :) This was the second attempt. I first tried to do testing without QueryRunner, setting up everything manually. And I failed miserably :)", "author": "losipiuk", "createdAt": "2020-11-05T11:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0MTQwMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4ODMyNA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518788324", "bodyText": "or dispatchExecutor?", "author": "findepi", "createdAt": "2020-11-06T14:32:44Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -72,7 +72,7 @@\n \n     private final int maxQueryLength;\n \n-    private final Executor queryExecutor;\n+    private final Executor executor;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTAyOQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518789029", "bodyText": "please update (DistributedQueryRunner) getQueryRunner() places to use the new method", "author": "findepi", "createdAt": "2020-11-06T14:33:51Z", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -411,6 +411,13 @@ protected final QueryRunner getQueryRunner()\n         return queryRunner;\n     }\n \n+    protected final DistributedQueryRunner getDistributedQueryRunner()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTU4MA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518791580", "bodyText": "part of the setup (construction) is done in initialize and part is done now in ctor.\nlet's merge the two.\nlet's rename initialize to reset and let's call reset(0) in the ctor, so that newly created object is usable", "author": "findepi", "createdAt": "2020-11-06T14:37:45Z", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsBuilder.java", "diffHunk": "@@ -16,20 +16,36 @@\n import com.google.common.collect.ImmutableList;\n import io.prestosql.spi.eventlistener.QueryCompletedEvent;\n import io.prestosql.spi.eventlistener.QueryCreatedEvent;\n+import io.prestosql.spi.eventlistener.QueryMetadata;\n import io.prestosql.spi.eventlistener.SplitCompletedEvent;\n \n import java.util.List;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Predicate;\n+\n+import static com.google.common.base.Predicates.alwaysTrue;\n+import static java.util.Objects.requireNonNull;\n \n class EventsBuilder\n {\n+    private final Predicate<QueryMetadata> queryFilter;\n     private ImmutableList.Builder<QueryCreatedEvent> queryCreatedEvents;\n     private ImmutableList.Builder<QueryCompletedEvent> queryCompletedEvents;\n     private ImmutableList.Builder<SplitCompletedEvent> splitCompletedEvents;\n \n     private CountDownLatch eventsLatch;\n \n+    public EventsBuilder()\n+    {\n+        this(alwaysTrue());\n+    }\n+\n+    public EventsBuilder(Predicate<QueryMetadata> queryFilter)\n+    {\n+        this.queryFilter = requireNonNull(queryFilter, \"filter is null\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTg5OA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518791898", "bodyText": "should not be prt of \"Add query filtering logic to EventsBuilder\" commit", "author": "findepi", "createdAt": "2020-11-06T14:38:17Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -58,6 +58,7 @@\n         extends AbstractTestQueryFramework\n {\n     private static final int SPLITS_PER_NODE = 3;\n+    private static final String IGNORE_EVENT_MARKER = \"-- ignore_generated_event\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0NjkwMw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518846903", "bodyText": "I put it in test for now. Only one tests uses it.\nIn EventBuilder you can provide any predicate which can assess metadata, not necessarily look for substring in query.", "author": "losipiuk", "createdAt": "2020-11-06T16:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MzY2OA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518793668", "bodyText": "[UUID.] randomUUID().toString().replace(\"-\", \"\")", "author": "findepi", "createdAt": "2020-11-06T14:41:02Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0OTM5MA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518849390", "bodyText": "I also updated same code in TestKillQuery", "author": "losipiuk", "createdAt": "2020-11-06T16:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MzY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTQ3Mw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795473", "bodyText": "Assertion is in async code, so it becomes less obvious the test effectively asserts what's supposed to do (it does, today).\nI think it would be more readable to move query cancellation to async code,\nand have query submittion and assertion in the main test thread.", "author": "findepi", "createdAt": "2020-11-06T14:43:51Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1MTEyNg==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518851126", "bodyText": "Sure. It makes it a bit harder to read though. As code does not match natural ordering.", "author": "losipiuk", "createdAt": "2020-11-06T16:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTUyNg==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795526", "bodyText": "add a timeout", "author": "findepi", "createdAt": "2020-11-06T14:43:56Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTcyMw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795723", "bodyText": "don't sleep at first, should the query be already there", "author": "findepi", "createdAt": "2020-11-06T14:44:16Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjQwMQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518796401", "bodyText": "we should use PREPARE and EXECUTE instead of sql injection....\nignore now", "author": "findepi", "createdAt": "2020-11-06T14:45:15Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",\n+                            queryPattern,\n+                            IGNORE_EVENT_MARKER))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NjUyOA==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518856528", "bodyText": "ignoring. Happy to learn more.", "author": "losipiuk", "createdAt": "2020-11-06T16:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjY3MQ==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518796671", "bodyText": "i think abstaining from format would yield to more readable code, since % interfere", "author": "findepi", "createdAt": "2020-11-06T14:45:41Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NzEwMw==", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518797103", "bodyText": "move this above utility methoids (findQueryId)", "author": "findepi", "createdAt": "2020-11-06T14:46:21Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",\n+                            queryPattern,\n+                            IGNORE_EVENT_MARKER))\n+                    .getOnlyColumn()\n+                    .map(String.class::cast)\n+                    .collect(toOptional());\n+        }\n+        return queryIdValue;\n+    }\n+\n+    @Test\n+    public void testWithInvalidExecutionPolicy()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "ba2bb426c7e7f35c7d9344ecc4415c6d7faf5920", "url": "https://github.com/trinodb/trino/commit/ba2bb426c7e7f35c7d9344ecc4415c6d7faf5920", "message": "Return if dispatch was successful via getDispatchedFuture", "committedDate": "2020-11-09T07:16:58Z", "type": "commit"}, {"oid": "76f694e8ec97b3858d43590355bb8c4006932c7b", "url": "https://github.com/trinodb/trino/commit/76f694e8ec97b3858d43590355bb8c4006932c7b", "message": "Rename field", "committedDate": "2020-11-09T07:16:58Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "33200208f97c4d2307cda11895c2c2a5a7de7784", "url": "https://github.com/trinodb/trino/commit/33200208f97c4d2307cda11895c2c2a5a7de7784", "message": "Add getDistributedQueryRunner method", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "ee3805e5f8a8f5df1aaa15b7f0d563a2ca87bbed", "url": "https://github.com/trinodb/trino/commit/ee3805e5f8a8f5df1aaa15b7f0d563a2ca87bbed", "message": "Make TestEventListener extend AbstractTestQueryFramework", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "8ab8610b9edb631f9e118c766b9a43ec5d790634", "url": "https://github.com/trinodb/trino/commit/8ab8610b9edb631f9e118c766b9a43ec5d790634", "message": "Add query filtering logic to EventsBuilder", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "c4c8f4a8727f6799e4db996ea08673e105c3ba66", "url": "https://github.com/trinodb/trino/commit/c4c8f4a8727f6799e4db996ea08673e105c3ba66", "message": "Rename method and ensure proper post-construction initialization", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "03cf05b717ec5e21f72b4f6cf9edea403d7e309e", "url": "https://github.com/trinodb/trino/commit/03cf05b717ec5e21f72b4f6cf9edea403d7e309e", "message": "Use randomUUID as test table suffix", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "498d9eae317bbd8b060601c11428417b5b4da752", "url": "https://github.com/trinodb/trino/commit/498d9eae317bbd8b060601c11428417b5b4da752", "message": "Ensure QueryManager is called for queries which fail during dispatching\n\nWithout the change call to QueryManager.queryImmediateFailureEvent could\nbe lost for some queries which were already past initial part of\ndispatching phase but not yet started execution.\nExamples are:\n - queries killed from WebUI while waiting for resources\n - queries abandoned while waiting for resources", "committedDate": "2020-11-09T09:48:30Z", "type": "commit"}, {"oid": "498d9eae317bbd8b060601c11428417b5b4da752", "url": "https://github.com/trinodb/trino/commit/498d9eae317bbd8b060601c11428417b5b4da752", "message": "Ensure QueryManager is called for queries which fail during dispatching\n\nWithout the change call to QueryManager.queryImmediateFailureEvent could\nbe lost for some queries which were already past initial part of\ndispatching phase but not yet started execution.\nExamples are:\n - queries killed from WebUI while waiting for resources\n - queries abandoned while waiting for resources", "committedDate": "2020-11-09T09:48:30Z", "type": "forcePushed"}, {"oid": "9158cc9cf5cfcd5a08144da25e15738ce42b089f", "url": "https://github.com/trinodb/trino/commit/9158cc9cf5cfcd5a08144da25e15738ce42b089f", "message": "empty commit", "committedDate": "2020-11-09T12:17:09Z", "type": "commit"}]}