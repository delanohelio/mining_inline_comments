{"pr_number": 6232, "pr_title": "Allow returning custom metrics from ConnectorPageSource", "pr_createdAt": "2020-12-07T19:58:01Z", "pr_url": "https://github.com/trinodb/trino/pull/6232", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDA1OA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539240058", "bodyText": "this object should be immutable", "author": "sopel39", "createdAt": "2020-12-09T11:47:44Z", "path": "presto-main/src/main/java/io/prestosql/operator/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.operator;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzM5OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r540287399", "bodyText": "Fixed.", "author": "rzeyde-varada", "createdAt": "2020-12-10T15:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDE1NA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539240154", "bodyText": "this should return new object", "author": "sopel39", "createdAt": "2020-12-09T11:47:52Z", "path": "presto-main/src/main/java/io/prestosql/operator/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.operator;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    private Map<String, Long> metrics;\n+\n+    public CustomMetrics()\n+    {\n+        metrics = new HashMap<>();\n+    }\n+\n+    public synchronized void set(Map<String, Long> metrics)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQ4NQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r540287485", "bodyText": "Refactored.", "author": "rzeyde-varada", "createdAt": "2020-12-10T16:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MjE5Mw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539242193", "bodyText": "ImmutableMap.of()", "author": "sopel39", "createdAt": "2020-12-09T11:51:07Z", "path": "presto-main/src/main/java/io/prestosql/operator/ScanFilterAndProjectOperator.java", "diffHunk": "@@ -76,6 +77,7 @@\n     private long physicalBytes;\n     private long readTimeNanos;\n     private long dynamicFilterSplitsProcessed;\n+    private Map<String, Long> customMetrics = Map.of();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MjY3OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539242679", "bodyText": "use correct javadoc formatting", "author": "sopel39", "createdAt": "2020-12-09T11:51:50Z", "path": "presto-main/src/main/java/io/prestosql/operator/OperatorContext.java", "diffHunk": "@@ -218,6 +220,14 @@ public void recordDynamicFilterSplitProcessed(long dynamicFilterSplits)\n         dynamicFilterSplitsProcessed.getAndAdd(dynamicFilterSplits);\n     }\n \n+    /** Overwrites the metrics with the latest one.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzU5MQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r540287591", "bodyText": "Fixed.", "author": "rzeyde-varada", "createdAt": "2020-12-10T16:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MjY3OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625352711", "bodyText": "This seems unnecessary. There's a more flexible implementation in airlift that doesn't require knowing the buckets and boundaries in advance: https://github.com/airlift/airlift/blob/master/stats/src/main/java/io/airlift/stats/TDigest.java", "author": "martint", "createdAt": "2021-05-03T20:38:18Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Histogram.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Arrays;\n+\n+public class Histogram", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzM1OTAxNQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r627359015", "bodyText": "IIUC, adding airlift's stats to trino-spi seems to require adding even more dependencies to the SPI - e.g. guava (which is currently is used only for tests). However, after adding guava as a provided dependency [1] I got the following errors when building trino-tpch:\n$ ./mvnw install -Dmaven.gitcommitid.skip=true -DskipTests -pl plugin/trino-tpch -am \n...\n[ERROR] Failed to execute goal io.trino:trino-maven-plugin:10:check-spi-dependencies (default-check-spi-dependencies) on project trino-tpch: \n[ERROR] \n[ERROR] Trino plugin dependency org.hdrhistogram:HdrHistogram must not have scope 'provided'. It is not part of the SPI and will not be available at runtime.\n\nSince org.hdrhistogram is an airlift stats dependency [2], I tried to add the following fixes to trino-tpch [3], but it seems that I didn't specified the dependency correctly :(\nI would appreciate if you could please help me to find the correct way of adding the TDigest to trino-spi...\n[1] rzeyde-varada@5b80288\n[2] https://github.com/airlift/airlift/blob/1e50fbd21c43ea355b7415af6a39ca7ad42c1daa/stats/pom.xml#L20\n[3] rzeyde-varada@d1228f3", "author": "rzeyde-varada", "createdAt": "2021-05-06T12:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMDMyODM2NQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r630328365", "bodyText": "That's a good point. We don't want to add extra dependencies to the SPI. There are a couple of options:\n\nKeep what you have here -- although, I dislike having complex behaviors in the SPI. It should mostly be an \"interface\".\nFigure out a way to make these metrics \"interfaces\" and leave the implementation to a connector or toolkit that connectors can use.", "author": "martint", "createdAt": "2021-05-11T16:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzA2MjQ5MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r633062490", "bodyText": "Thanks!\nI think that I will move the implementation into a toolkit.", "author": "rzeyde-varada", "createdAt": "2021-05-16T08:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTIwNjgwNw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635206807", "bodyText": "Done in b50d473.", "author": "rzeyde-varada", "createdAt": "2021-05-19T12:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MzAxMw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625353013", "bodyText": "This should just be called \"Count\"", "author": "martint", "createdAt": "2021-05-03T20:38:49Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MzA3OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625353079", "bodyText": "use primitive long", "author": "martint", "createdAt": "2021-05-03T20:38:57Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue\n+        implements Metric\n+{\n+    private final Long value;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2MDcwMw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625360703", "bodyText": "I would just call this Metrics, since it should evolve to tracking all metrics exposed by operators", "author": "martint", "createdAt": "2021-05-03T20:52:30Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2MjU0Nw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625362547", "bodyText": "Use Map<String, Metric> for the variable declaration", "author": "martint", "createdAt": "2021-05-03T20:55:50Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    public static final CustomMetrics EMPTY = new CustomMetrics();\n+\n+    private final Map<String, Metric> map;\n+\n+    public CustomMetrics(Map<String, Metric>... maps)\n+    {\n+        this(Arrays.asList(maps));\n+    }\n+\n+    public CustomMetrics(Iterable<Map<String, Metric>> maps)\n+    {\n+        HashMap<String, Metric> aggregation = new HashMap();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2NDA4Mg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625364082", "bodyText": "This should be called getConnectorMetrics(). In the future, we'll likely want to expose operator-specific metrics, which should be namespaced separately from those exposed by the connector.", "author": "martint", "createdAt": "2021-05-03T20:58:42Z", "path": "core/trino-main/src/main/java/io/trino/operator/ScanFilterAndProjectOperator.java", "diffHunk": "@@ -157,6 +159,12 @@ public long getDynamicFilterSplitsProcessed()\n         return dynamicFilterSplitsProcessed;\n     }\n \n+    @Override\n+    public CustomMetrics getCustomMetrics()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM3MTI0Mw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625371243", "bodyText": "Call this getMetrics().\nAlso, it needs to document the semantics of the returned metrics -- i.e., they are a new snapshot of the metrics, metrics need to be immutable, etc.", "author": "martint", "createdAt": "2021-05-03T21:12:09Z", "path": "core/trino-spi/src/main/java/io/trino/spi/connector/ConnectorPageSource.java", "diffHunk": "@@ -70,4 +72,9 @@ void close()\n     {\n         return NOT_BLOCKED;\n     }\n+\n+    default Map<String, Metric> getCustomMetrics()", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM3MjA4NQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625372085", "bodyText": "What's the use case for taking multiple maps?", "author": "martint", "createdAt": "2021-05-03T21:13:39Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    public static final CustomMetrics EMPTY = new CustomMetrics();\n+\n+    private final Map<String, Metric> map;\n+\n+    public CustomMetrics(Map<String, Metric>... maps)\n+    {\n+        this(Arrays.asList(maps));\n+    }\n+\n+    public CustomMetrics(Iterable<Map<String, Metric>> maps)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzI1OTE5OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r627259199", "bodyText": "I am using it to merge multiple custom metrics at OperatorStats#add, but it's probably not a good choice for a c-tor - so I have renamed it into a static method Metrics#merge: b4f3406#diff-de6c1298bb6eabc28a83bbb6305b6de4f2900681b3dfab627a0d541e2e50230aR34", "author": "rzeyde-varada", "createdAt": "2021-05-06T09:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM3MjA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM4MzM0NQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625383345", "bodyText": "Take a look at io.trino.util.Mergeable and implementations of that. We may want to do something similar. Or move Mergeable to the SPI for use in these.", "author": "martint", "createdAt": "2021-05-03T21:35:50Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue\n+        implements Metric\n+{\n+    private final Long value;\n+\n+    @JsonCreator\n+    public LongSumValue(long value)\n+    {\n+        this.value = value;\n+    }\n+\n+    @JsonProperty(\"value\")\n+    public long getValue()\n+    {\n+        return value;\n+    }\n+\n+    @Override\n+    public Metric merge(Metric other)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzI2MTMyNA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r627261324", "bodyText": "Sounds good - I have moved Mergeable to trino-spi at ad3f94a and refactored the merging code following the implementation at OperatorStats#mergeInfo.", "author": "rzeyde-varada", "createdAt": "2021-05-06T09:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM4MzM0NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "url": "https://github.com/trinodb/trino/commit/d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "message": "Allow exposing custom metrics from the connector", "committedDate": "2021-05-06T11:24:22Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwMzM4MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635303380", "bodyText": "I don't see equals overridden for Metrics, is this meant to be a ref comparison only ? Might be clearer to use != in that case", "author": "raunaqmorarka", "createdAt": "2021-05-19T14:34:41Z", "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -228,6 +232,11 @@ private void updateOperatorStats()\n             operatorContext.recordDynamicFilterSplitProcessed(currentDynamicFilterSplitsProcessed - previousDynamicFilterSplitsProcessed);\n             previousDynamicFilterSplitsProcessed = currentDynamicFilterSplitsProcessed;\n         }\n+\n+        if (!currentMetrics.equals(previousMetrics)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTA3MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501070", "bodyText": "Thanks, fixed to use !=.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwMzM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwNjkwMw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635306903", "bodyText": "new HashMap<>()", "author": "raunaqmorarka", "createdAt": "2021-05-19T14:38:20Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)\n+    {\n+        Map<String, Metric> merged = new HashMap();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTIwMQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501201", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwNjkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxMTkxOA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635311918", "bodyText": "maps.forEach(map ->\n                map.forEach((key, value) ->\n                        merged.merge(key, value, Metrics::mergeInternal)));", "author": "raunaqmorarka", "createdAt": "2021-05-19T14:43:33Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)\n+    {\n+        Map<String, Metric> merged = new HashMap();\n+        maps.forEach(map -> map\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> merged.merge(\n+                        entry.getKey(),\n+                        entry.getValue(),\n+                        (left, right) -> mergeInternal(left, right))));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTIxNA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501214", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxMTkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTMzNg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635319336", "bodyText": "Why do we have Metric interface ?\nIt seems it must implement Mergeable to be usable.\nCould we just use Mergeable or have Metric extend Mergeable ?", "author": "raunaqmorarka", "createdAt": "2021-05-19T14:51:15Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTI4MQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501281", "bodyText": "Good point - changed Metric to extend Mergeable.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTQ5OA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635319498", "bodyText": "map -> metrics", "author": "raunaqmorarka", "createdAt": "2021-05-19T14:51:26Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTI5MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501290", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMzOTgzNg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635339836", "bodyText": "requireNonNull", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:13:15Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -169,6 +176,7 @@ public OperatorStats(\n         this.outputPositions = outputPositions;\n \n         this.dynamicFilterSplitsProcessed = dynamicFilterSplitsProcessed;\n+        this.customMetrics = customMetrics;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTMwOQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501309", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMzOTgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM0NjY3MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635346670", "bodyText": "Can we make it\nMap<String, Metric> merge(Iterable<Map<String, Metric>> metrics)\nor\nMetrics merge(Iterable<Metrics> metrics) ?\nLooks inconsistent to use the wrapper class sometimes and the Map directly in other places", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:20:54Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTQxOA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501418", "bodyText": "Good point - changed to use Metrics instead of Map.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM0NjY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1MDM1Mg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635350352", "bodyText": "null handling shouldn't be needed", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:24:55Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -332,6 +340,16 @@ public long getDynamicFilterSplitsProcessed()\n         return dynamicFilterSplitsProcessed;\n     }\n \n+    @JsonInclude(JsonInclude.Include.NON_EMPTY)\n+    @JsonProperty\n+    public Map<String, Metric> getCustomMetrics()\n+    {\n+        if (customMetrics == null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1MTk4MQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635351981", "bodyText": "Could we use Metrics instead of Map<String, Metric> ?\nOr if we just want to use maybe Map<String, Metric> directly, we can consider getting rid of Metrics wrapper and put the merge method in some utils class.", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:26:56Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -115,6 +121,7 @@ public OperatorStats(\n             @JsonProperty(\"outputPositions\") long outputPositions,\n \n             @JsonProperty(\"dynamicFilterSplitsProcessed\") long dynamicFilterSplitsProcessed,\n+            @JsonProperty(\"customMetrics\") Map<String, Metric> customMetrics,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTUwOQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501509", "bodyText": "Sounds good, changed to use Metrics instead of Map.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1MTk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTA5Mw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635359093", "bodyText": "new AtomicReference<>", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:34:47Z", "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorPipelineSourceOperator.java", "diffHunk": "@@ -675,6 +681,7 @@ public void close()\n         final AtomicLong outputPositions = new AtomicLong();\n \n         final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+        final AtomicReference<Metrics> customMetrics = new AtomicReference(Metrics.EMPTY);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTUyNw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501527", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTQwNQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635359405", "bodyText": "new AtomicReference<>", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:35:10Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorContext.java", "diffHunk": "@@ -82,6 +83,7 @@\n     private final CounterStat outputPositions = new CounterStat();\n \n     private final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+    private final AtomicReference<Metrics> customMetrics = new AtomicReference(Metrics.EMPTY);  // this is not incremental, but gets overwritten by the latest value.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTU5MQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501591", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM2NTgxMg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635365812", "bodyText": "Do we need a list ?\nCould we merge the maps one at a time like the other metrics here ?", "author": "raunaqmorarka", "createdAt": "2021-05-19T15:42:14Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -451,6 +469,8 @@ public OperatorStats add(Iterable<OperatorStats> operators)\n         long outputPositions = this.outputPositions;\n \n         long dynamicFilterSplitsProcessed = this.dynamicFilterSplitsProcessed;\n+        ImmutableList.Builder<Map<String, Metric>> metricsMaps = ImmutableList.builder();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUwMTcyOQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637501729", "bodyText": "Sounds good, changed to merge the metrics on at a time.", "author": "rzeyde-varada", "createdAt": "2021-05-23T07:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM2NTgxMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjI1Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637516256", "bodyText": "We could make this cleaner by doing something like below\nassertThat(metrics.get(\"rows\")).isEqualTo(count(2000));        \nassertThat(metrics.get(\"opened\")).isEqualTo(metrics.get(\"closed\"));\nassertThat(metrics.get(\"closed\")).isGreaterThan(count(0));", "author": "raunaqmorarka", "createdAt": "2021-05-23T09:25:21Z", "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -99,6 +104,52 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgxODk3Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637818976", "bodyText": "Fixed the first two, but the last one still requires comparing the underlying count (since Metric is not Comparable) IIUC.", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjQxMA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637516410", "bodyText": "Could we use method reference instead ?", "author": "raunaqmorarka", "createdAt": "2021-05-23T09:27:16Z", "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -99,6 +104,52 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);\n+    }\n+\n+    @Test\n+    public void testCustomMetricsScanOnly()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);\n+    }\n+\n+    private Map<String, Metric> collectCustomMetrics(String sql)\n+    {\n+        DistributedQueryRunner runner = (DistributedQueryRunner) getQueryRunner();\n+        ResultWithQueryId<MaterializedResult> result = runner.executeWithQueryId(getSession(), sql);\n+        return runner\n+                .getCoordinator()\n+                .getQueryManager()\n+                .getFullQueryInfo(result.getQueryId())\n+                .getQueryStats()\n+                .getOperatorSummaries()\n+                .stream()\n+                .map(s -> s.getMetrics())", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgxOTI1MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637819250", "bodyText": "Good catch, thanks!", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxODExMA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637518110", "bodyText": "Using assertThat would be preferable", "author": "raunaqmorarka", "createdAt": "2021-05-23T09:41:03Z", "path": "lib/trino-plugin-toolkit/src/test/java/io/trino/plugin/base/metrics/TestMetrics.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.plugin.base.metrics;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.airlift.stats.TDigest;\n+import io.trino.spi.metrics.Metrics;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgyNDAzNw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637824037", "bodyText": "Fixed.", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxODExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyMTM4Nw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637521387", "bodyText": "Since we only give two metrics as input, it might be better to simplify this method to just take 2 metrics as input.\nOr you could even make this class implement Mergeable<Metrics> interface.", "author": "raunaqmorarka", "createdAt": "2021-05-23T10:08:50Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = Map.copyOf(requireNonNull(metrics, \"metrics is null\"));\n+    }\n+\n+    public static Metrics merge(Metrics... metrics)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgxOTc0MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637819740", "bodyText": "Made Metrics mergeable.", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyMTM4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNDk4Nw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637524987", "bodyText": "I think one disadvantage of working with Metrics wrapper is that it would result in the underlying map getting copied many times here.\nIt might be more efficient to work directly with the underlying Map for merging here\nE.g.\nMap<> metricsAccumulator = this.getMetrics().getMetrics()\n...\nfor (OperatorStats operator : operators) {\n....\n    operator.getMetrics().forEach((key, value) -> metricsAccumulator.merge(key, value, (m1, m2) -> m1.mergeWith(m2))));\n....\n}\nMetrics merged = new Metrics(metricsAccumulator);", "author": "raunaqmorarka", "createdAt": "2021-05-23T10:38:58Z", "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -498,6 +509,7 @@ public OperatorStats add(Iterable<OperatorStats> operators)\n             outputPositions += operator.getOutputPositions();\n \n             dynamicFilterSplitsProcessed += operator.getDynamicFilterSplitsProcessed();\n+            metrics = Metrics.merge(metrics, operator.getMetrics());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgyMDM0Nw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637820347", "bodyText": "Sounds good - created an helper Metrics.Accumulator class (similar to the \"builder\" pattern).", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNDk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNTcxNw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637525717", "bodyText": "Would it be better to collect sourceOperator.getConnectorMetrics() before sourceOperator.close() as sourceOperator could decide to clear its metrics to release resources on close ?", "author": "raunaqmorarka", "createdAt": "2021-05-23T10:45:24Z", "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -175,6 +177,7 @@ public void close()\n             throws Exception\n     {\n         sourceOperator.close();\n+        operatorContext.setLatestMetrics(sourceOperator.getConnectorMetrics());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzgxNzc2NA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637817764", "bodyText": "Sounds good - moved the collection before closing the operator.", "author": "rzeyde-varada", "createdAt": "2021-05-24T09:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNTcxNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0MjE2OA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644242168", "bodyText": "Is this for connector metrics? If so, call it connectorMetrics. Otherwise, just call it metrics.", "author": "martint", "createdAt": "2021-06-02T18:57:00Z", "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorPipelineSourceOperator.java", "diffHunk": "@@ -675,6 +681,7 @@ public void close()\n         final AtomicLong outputPositions = new AtomicLong();\n \n         final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+        final AtomicReference<Metrics> customMetrics = new AtomicReference<>(Metrics.EMPTY);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjgwNTUyNw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r646805527", "bodyText": "Renamed to connectorMetrics.", "author": "rzeyde-varada", "createdAt": "2021-06-07T17:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0MjE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NTMyNg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644245326", "bodyText": "This method seems unnecessary. It's used only once and it's fairly trivial. Just inline it where it's used.", "author": "martint", "createdAt": "2021-06-02T19:02:07Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");\n+    }\n+\n+    @JsonProperty(\"metrics\")\n+    public Map<String, Metric> getMetrics()\n+    {\n+        return metrics;\n+    }\n+\n+    @Override\n+    public Metrics mergeWith(Metrics other)\n+    {\n+        return accumulator().add(this).add(other).get();\n+    }\n+\n+    public static Accumulator accumulator()\n+    {\n+        return new Accumulator();\n+    }\n+\n+    public static class Accumulator\n+    {\n+        private final Map<String, Metric> merged = new HashMap<>();\n+\n+        private Accumulator()\n+        {\n+        }\n+\n+        public Accumulator add(Metrics metrics)\n+        {\n+            metrics.getMetrics().forEach((key, value) ->\n+                    merged.merge(key, value, Accumulator::mergeInternal));\n+            return this;\n+        }\n+\n+        public Metrics get()\n+        {\n+            return new Metrics(merged);\n+        }\n+\n+        private static Metric mergeInternal(Metric left, Metric right)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjgwNTYyOA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r646805628", "bodyText": "Sounds good - done.", "author": "rzeyde-varada", "createdAt": "2021-06-07T17:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NTMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NzQyOQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644247429", "bodyText": "This class is holding on to the map provided by the caller. That can cause potential problems down the road if the map is modified (especially in a non-thread-safe manner). Do Map.copyOf(...)", "author": "martint", "createdAt": "2021-06-02T19:05:33Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjgwNTcxNg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r646805716", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-06-07T17:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NzQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MTQ0Mw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644251443", "bodyText": "Use @JsonValue so that it doesn't introduce an artificial nested JSON object.", "author": "martint", "createdAt": "2021-06-02T19:12:22Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");\n+    }\n+\n+    @JsonProperty(\"metrics\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjgwNTg0NA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r646805844", "bodyText": "Thanks, fixed.", "author": "rzeyde-varada", "createdAt": "2021-06-07T17:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MTQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MzAxMw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644253013", "bodyText": "TDigest is not json-serializable.", "author": "martint", "createdAt": "2021-06-02T19:14:50Z", "path": "lib/trino-plugin-toolkit/src/main/java/io/trino/plugin/base/metrics/Histogram.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.plugin.base.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.stats.TDigest;\n+import io.trino.spi.metrics.Metric;\n+\n+public class Histogram\n+        implements Metric<Histogram>\n+{\n+    private final TDigest digest;\n+\n+    @JsonCreator\n+    public Histogram(TDigest digest)\n+    {\n+        this.digest = digest;\n+    }\n+\n+    @JsonProperty(\"digest\")\n+    public TDigest getDigest()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjgwNjk5OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r646806999", "bodyText": "Oops, you're right - added a custom converter to serialize/deserialize TDigest (using base64).", "author": "rzeyde-varada", "createdAt": "2021-06-07T17:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MzAxMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY0ODYxNA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654648614", "bodyText": "Why not set it unconditionally?", "author": "martint", "createdAt": "2021-06-18T19:51:41Z", "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -228,6 +232,11 @@ private void updateOperatorStats()\n             operatorContext.recordDynamicFilterSplitProcessed(currentDynamicFilterSplitsProcessed - previousDynamicFilterSplitsProcessed);\n             previousDynamicFilterSplitsProcessed = currentDynamicFilterSplitsProcessed;\n         }\n+\n+        if (currentMetrics != previousMetrics) {\n+            operatorContext.setLatestMetrics(currentMetrics);\n+            previousMetrics = currentMetrics;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDk3NTU0Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654975546", "bodyText": "It can be done, but I thought to optimize for the case where currentMetrics == Metrics.EMPTY (which currently happens for all connectors that don't implement ConnectorPageSource#getMetrics).", "author": "rzeyde-varada", "createdAt": "2021-06-20T19:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY0ODYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjQzMDY1Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r662430656", "bodyText": "setLatestMetrics just sets a field. There's no processing involved, so I don't think this optimization really optimizes much. We can add it in the future if we observe that being an actual problem.", "author": "martint", "createdAt": "2021-07-01T16:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY0ODYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MDg4Mg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654650882", "bodyText": "Why double?", "author": "martint", "createdAt": "2021-06-18T19:57:09Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Count.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Count\n+{\n+    double getTotal();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDk3NjQ2Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654976466", "bodyText": "In case a connector would like to aggregate a floating-point metric, returning double should work both for integer and floating-point metrics.\nShould I change it to long?", "author": "rzeyde-varada", "createdAt": "2021-06-20T19:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MDg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjQzNDExMQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r662434111", "bodyText": "I think that would be a different type of metric, though. Let's change it to long. We can reconsider in the future if we find an actual use case for it.", "author": "martint", "createdAt": "2021-07-01T16:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MDg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTM1MA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654651350", "bodyText": "Did you try making Count and Histogram extend from Metric?", "author": "martint", "createdAt": "2021-06-18T19:58:17Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Count.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Count", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDk3NTk4Ng==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654975986", "bodyText": "Good point, thanks!\nFixed in 749ef4f.", "author": "rzeyde-varada", "createdAt": "2021-06-20T19:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTQyMw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654651423", "bodyText": "Why double?", "author": "martint", "createdAt": "2021-06-18T19:58:28Z", "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Distribution.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Distribution\n+{\n+    double getTotal();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDk3NTg2Nw==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654975867", "bodyText": "Because TDigest#getCount and QuantileDigest#getCount return double - so I thought to use the same type here.", "author": "rzeyde-varada", "createdAt": "2021-06-20T19:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjQzMzM5OQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r662433399", "bodyText": "That's because TDigest and QDigest are designed to support exponential decay, which results in fractional weights over time. I don't think we need that here.", "author": "martint", "createdAt": "2021-07-01T16:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTQyMw=="}], "type": "inlineReview"}, {"oid": "e6682337acfec795aa69b92c7b5df552e4329d85", "url": "https://github.com/trinodb/trino/commit/e6682337acfec795aa69b92c7b5df552e4329d85", "message": "Move Mergeable interface to SPI", "committedDate": "2021-06-27T11:26:49Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "568eed4bbf8327070d798a8dbef07161e02c1827", "url": "https://github.com/trinodb/trino/commit/568eed4bbf8327070d798a8dbef07161e02c1827", "message": "Allow exposing custom metrics from the connector", "committedDate": "2021-07-01T19:35:31Z", "type": "commit"}, {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "url": "https://github.com/trinodb/trino/commit/7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "message": "Implement Count and Histogram metrics in trino-plugin-toolkit\n\nAlso, add an integration test to TestMemorySmoke", "committedDate": "2021-07-01T19:35:31Z", "type": "commit"}, {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "url": "https://github.com/trinodb/trino/commit/7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "message": "Implement Count and Histogram metrics in trino-plugin-toolkit\n\nAlso, add an integration test to TestMemorySmoke", "committedDate": "2021-07-01T19:35:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE3NTAzMQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r678175031", "bodyText": "Would it be possible to avoid using raw types here?", "author": "findepi", "createdAt": "2021-07-28T10:27:32Z", "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -107,6 +113,40 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");", "originalCommit": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODU2MzkzMg==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r678563932", "bodyText": "Sounds good - do you mean returning a Metrics object from collectCustomMetrics() (instead of a Map)?\nIf so, I think it can be fixed by master...rzeyde-varada:fixup-metrics-test.", "author": "rzeyde-varada", "createdAt": "2021-07-28T18:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE3NTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODk0NzUxMA==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r678947510", "bodyText": "I don't know this code, so cannot suggest something.\nJust my IDE warns me that Metric is a generic class, but here it's used without <...>.\nmaybe Metric<?> would do for now", "author": "findepi", "createdAt": "2021-07-29T08:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE3NTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTIxODE1NQ==", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r679218155", "bodyText": "Opened #8707.", "author": "rzeyde-varada", "createdAt": "2021-07-29T14:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE3NTAzMQ=="}], "type": "inlineReview"}]}