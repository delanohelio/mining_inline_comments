{"pr_number": 5769, "pr_title": "Implement getRow for AbstractPrestoResultSet", "pr_createdAt": "2020-11-01T06:14:29Z", "pr_url": "https://github.com/trinodb/trino/pull/5769", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwMjQ4Nw==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515602487", "bodyText": "Let's use assertThatThrownBy instead of expectedExceptions and make sure the message as well.\n            assertThatThrownBy(rs::getRow)\n                    .isInstanceOf(SQLException.class)\n                    .hasMessage(\"ResultSet is closed\");", "author": "ebyhr", "createdAt": "2020-11-01T10:13:14Z", "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -751,6 +751,34 @@ public void testGetStatement()\n         }\n     }\n \n+    @Test\n+    public void testGetRow()\n+            throws Exception\n+    {\n+        try (ConnectedStatement connectedStatement = newStatement()) {\n+            try (ResultSet rs = connectedStatement.getStatement().executeQuery(\"SELECT * FROM (VALUES (1), (2), (3))\")) {\n+                assertEquals(rs.getRow(), 0);\n+                int currentRow = 0;\n+                while (rs.next()) {\n+                    currentRow++;\n+                    assertEquals(rs.getRow(), currentRow);\n+                }\n+                assertEquals(rs.getRow(), 0);\n+            }\n+        }\n+    }\n+\n+    @Test(expectedExceptions = SQLException.class)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwMzIzMw==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515603233", "bodyText": "There is a utility method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (isClosed()) {\n          \n          \n            \n                        throw new SQLException(\"Result set is closed\");\n          \n          \n            \n                    }\n          \n          \n            \n                    checkOpen();", "author": "ebyhr", "createdAt": "2020-11-01T10:20:30Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -684,7 +687,11 @@ public boolean last()\n     public int getRow()\n             throws SQLException\n     {\n-        throw new SQLFeatureNotSupportedException(\"getRow\");\n+        if (isClosed()) {\n+            throw new SQLException(\"Result set is closed\");\n+        }\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwMzM5NQ==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515603395", "bodyText": "Could you move to after AtomicReference<List<Object>> row? These variables related each other.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected int currentRow; // Index into 'rows' of our current row (1-based)\n          \n          \n            \n                private final AtomicInteger currentRow = new AtomicInteger(); // Index into 'rows' of our current row (1-based)", "author": "ebyhr", "createdAt": "2020-11-01T10:22:01Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -126,6 +126,7 @@\n     private final AtomicBoolean wasNull = new AtomicBoolean();\n     protected final AtomicBoolean closed = new AtomicBoolean();\n     private final Optional<Statement> statement;\n+    protected int currentRow; // Index into 'rows' of our current row (1-based)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMDY5Mw==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515620693", "bodyText": "i know it's preexisting, but i don't know why we use atomics for ResultSet state.\nDoes RS need to be thread safe? @electrum?\neven then, using synchronized + @GuardedBy could yield to simpler code.\n(no change requested here within this PR)", "author": "findepi", "createdAt": "2020-11-01T13:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwMzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515621026", "bodyText": "What should be the expected behavior after reading 2^31 rows?", "author": "findepi", "createdAt": "2020-11-01T13:14:49Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -148,9 +149,11 @@ public boolean next()\n         try {\n             if (!results.hasNext()) {\n                 row.set(null);\n+                currentRow = 0;\n                 return false;\n             }\n             row.set(results.next());\n+            currentRow++;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyNTg2Nw==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515625867", "bodyText": "@findepi  As far as I checked quickly (not tested) other JDBC drivers, they will just overflow. Probably, we need to define the expected behavior by ourselves (e.g. Throw SQLException in getRow when currentRow > integer max).\nPostgreSQL: https://github.com/pgjdbc/pgjdbc/blob/c80add9975d88a134319374cf5dd4adec864f432/pgjdbc/src/main/java/org/postgresql/jdbc/PgResultSet.java#L741\nMySQL: https://github.com/mysql/mysql-connector-j/blob/d64b664fa93e81296a377de031b8123a67e6def2/src/main/user-impl/java/com/mysql/cj/jdbc/result/ResultSetImpl.java#L1560\nSQLServer: https://github.com/microsoft/mssql-jdbc/blob/606e722fbee129a4fd0de89423f5a934207522b0/src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResultSet.java#L1494", "author": "ebyhr", "createdAt": "2020-11-01T14:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY3OTEwMA==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r515679100", "bodyText": "Thanks! So should I detect the overflow and define the expected behavior? If so, probably I should throw exception for that case. It seems like I can only throw SQLException but per the spec, this exception is threw only when if a database access error occurs or this method is called on a closed result set.", "author": "jasonyanwenl", "createdAt": "2020-11-01T22:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNTQ2OA==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r516105468", "bodyText": "Hi, @findepi @ebyhr, may I ask if there is any suggestion on this? Thanks!", "author": "jasonyanwenl", "createdAt": "2020-11-02T16:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MzM5Mg==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r516943392", "bodyText": "Given that this is unspecified behavior in the JDBC spec, and that none of the common JDBC implementations seem to handle this, my guess is that this is not too big a deal either way. If we want to be really pedantic about this, it would probably be just slightly safer to just throw a SQLException in this case because a negative row number returned is not a valid row number. Given that JDBC does not permit more than Integer.MAX_VALUE rows to be returned in one shot, you could argue this is a DB access error.", "author": "erichwang", "createdAt": "2020-11-03T20:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTQ0MQ==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r516945441", "bodyText": "Thanks for your suggestion! That makes sense to me.", "author": "jasonyanwenl", "createdAt": "2020-11-03T20:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3MjE5Ng==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r516972196", "bodyText": "Note that we cannot throw upon increment (this would break anyone reading more than 2B rows, which is possible today, if you're patient enough).\nFor this, we can keep the counter as a long (AtomicInteger->AtomicLong) and verify the value is within [0, Integer.MAX_VAULUE] within getRow() method.\n(long counter won't overflow in practice)", "author": "findepi", "createdAt": "2020-11-03T21:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMjMwNg==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517012306", "bodyText": "@findepi  OK, so do you mean we allow it overflow during increment (e.g. when calling next). However, when getRow is called, we need to do overflow verification and throw exception if it is overflow?", "author": "jasonyanwenl", "createdAt": "2020-11-03T23:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMjg3MA==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517022870", "bodyText": "@jasonyanwenl, he means to use a long for the internal row counter so that it doesn't actually overflow, but just to throw the exception if someone tries to fetch the the current row that can't be squeezed into the JDBC API int return value.", "author": "erichwang", "createdAt": "2020-11-03T23:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzODY1Mg==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517038652", "bodyText": "OK. Got it!", "author": "jasonyanwenl", "createdAt": "2020-11-04T00:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2NTI4Ng==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517465286", "bodyText": "@jasonyanwenl at first there seems to be no much difference between int and long.\nin practise however, it will take you thousands years to overflow long even if you increase the counter at 1M/s pace.", "author": "findepi", "createdAt": "2020-11-04T16:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYyMTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NzQxMA==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517297410", "bodyText": "Integer.MAX_VALUE should be allowed. Could you update like this? PrestoStatement#getMaxRows is similar method.\n    @Override\n    public int getRow()\n            throws SQLException\n    {\n        checkOpen();\n\n        long rowNumber = currentRowNumber.get();\n        if (rowNumber < 0 || rowNumber > Integer.MAX_VALUE) {\n            throw new SQLException(\"Rows exceed limit of 2147483647\");\n        }\n        return (int) rowNumber;\n    }", "author": "ebyhr", "createdAt": "2020-11-04T12:07:06Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -684,7 +688,15 @@ public boolean last()\n     public int getRow()\n             throws SQLException\n     {\n-        throw new SQLFeatureNotSupportedException(\"getRow\");\n+        checkOpen();\n+\n+        long localCurrentRowNumber = currentRowNumber.get();\n+\n+        if (localCurrentRowNumber < 0 || localCurrentRowNumber >= Integer.MAX_VALUE) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc0MTYxOQ==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517741619", "bodyText": "Sure! Thanks!", "author": "jasonyanwenl", "createdAt": "2020-11-05T02:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NzQxMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxNzM3Nw==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r517917377", "bodyText": "\"Max rows\" looks incorrect. Could you change to \"Rows exceed ...\" or \"Current row exceed ...\"?", "author": "ebyhr", "createdAt": "2020-11-05T09:44:56Z", "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -684,7 +688,14 @@ public boolean last()\n     public int getRow()\n             throws SQLException\n     {\n-        throw new SQLFeatureNotSupportedException(\"getRow\");\n+        checkOpen();\n+\n+        long rowNumber = currentRowNumber.get();\n+        if (rowNumber < 0 || rowNumber > Integer.MAX_VALUE) {\n+            throw new SQLException(\"Max rows exceeds limit of 2147483647\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA5NzM1MA==", "url": "https://github.com/trinodb/trino/pull/5769#discussion_r518097350", "bodyText": "Oh, yeah. Sorry for this.", "author": "jasonyanwenl", "createdAt": "2020-11-05T14:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxNzM3Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "088972ffdcfb24e22a4eb87cb90fa0eff4a2bc76", "url": "https://github.com/trinodb/trino/commit/088972ffdcfb24e22a4eb87cb90fa0eff4a2bc76", "message": "Implement getRow for AbstractPrestoResultSet", "committedDate": "2020-11-05T14:47:54Z", "type": "commit"}, {"oid": "088972ffdcfb24e22a4eb87cb90fa0eff4a2bc76", "url": "https://github.com/trinodb/trino/commit/088972ffdcfb24e22a4eb87cb90fa0eff4a2bc76", "message": "Implement getRow for AbstractPrestoResultSet", "committedDate": "2020-11-05T14:47:54Z", "type": "forcePushed"}]}