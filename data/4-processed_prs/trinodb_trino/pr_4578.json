{"pr_number": 4578, "pr_title": "A couple fixes related to complex data types in Iceberg connector", "pr_createdAt": "2020-07-25T13:49:12Z", "pr_url": "https://github.com/trinodb/trino/pull/4578", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMjc1Mg==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r460432752", "bodyText": "Have you considered making TypeConverter an object that stores the index? That should be simpler than passing it through static methods with recursive invocations. Something like\nTypeConverter converter = new TypeConverter();\nfor (ColumnMetadata column : columns) {\n    Type type = converter.toIcebergType(column.getType());\n    int index = converter.getIndex();\n    ...\n}\nWe'd probably want to split up the class into PrestoTypeConverter and IcebergTypeConverter as a precursor commit, since toPrestoType can stay static.", "author": "electrum", "createdAt": "2020-07-25T18:46:21Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -539,14 +539,16 @@ private ConnectorTableMetadata getTableMetadata(ConnectorSession session, Schema\n     private static Schema toIcebergSchema(List<ColumnMetadata> columns)\n     {\n         List<NestedField> icebergColumns = new ArrayList<>();\n+        int index = 1;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMDY0Mg==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r461220642", "bodyText": "I made these changes as you suggested. Turns out there is another commit that is not yet pushed upstream that requires this fix. So, I am going to abandon this particular commit and upload a new one when the other commit is pushed upstream (soon).", "author": "anjalinorwood", "createdAt": "2020-07-27T23:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMjc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzE4MQ==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r460433181", "bodyText": "Can you add these tests to TestIcebergSmoke? Product tests should only be used if absolutely necessary, since they are harder to run (you can't run them in the IDE or easily debug them).", "author": "electrum", "createdAt": "2020-07-25T18:51:34Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/iceberg/TestCreateTable.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.iceberg;\n+\n+import io.airlift.log.Logger;\n+import io.prestosql.tempto.AfterTestWithContext;\n+import io.prestosql.tempto.BeforeTestWithContext;\n+import io.prestosql.tempto.ProductTest;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.CREATE_TABLE;\n+\n+public class TestCreateTable", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTI1MA==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r461221250", "bodyText": "Yes, moved the tests to TestIcebergSmoke.\nI was able to run product tests in IDE similar to how I run smoke, but I agree that smoke tests is a better place for these.", "author": "anjalinorwood", "createdAt": "2020-07-27T23:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzIyMw==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r460433223", "bodyText": "We shouldn't catch exceptions like this in tests, as we want any such exception to fail the test.", "author": "electrum", "createdAt": "2020-07-25T18:52:07Z", "path": "presto-product-tests/src/main/java/io/prestosql/tests/iceberg/TestCreateTable.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.tests.iceberg;\n+\n+import io.airlift.log.Logger;\n+import io.prestosql.tempto.AfterTestWithContext;\n+import io.prestosql.tempto.BeforeTestWithContext;\n+import io.prestosql.tempto.ProductTest;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.tempto.assertions.QueryAssert.assertThat;\n+import static io.prestosql.tempto.query.QueryExecutor.query;\n+import static io.prestosql.tests.TestGroups.CREATE_TABLE;\n+\n+public class TestCreateTable\n+        extends ProductTest\n+{\n+    private static final String ICEBERG_TABLE_NAME1 = \"iceberg.ice_tables.nested_types\";\n+    private static final String ICEBERG_TABLE_NAME2 = \"iceberg.ice_tables.nested_types2\";\n+    private static final String ICEBERG_TABLE_SCHEMA = \"iceberg.ice_tables\";\n+\n+    @BeforeTestWithContext\n+    public void createObjects()\n+    {\n+        // Drop Iceberg tables and schema\n+        try {\n+            query(\"DROP TABLE IF EXISTS \" + ICEBERG_TABLE_NAME1);\n+            query(\"DROP TABLE IF EXISTS \" + ICEBERG_TABLE_NAME2);\n+        }\n+        catch (Exception e) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTMyMA==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r461221320", "bodyText": "Got it.", "author": "anjalinorwood", "createdAt": "2020-07-27T23:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzMyOA==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r460433328", "bodyText": "Can you add a test to TestIcebergSmoke that creates a table with a row type, inserts a null into one of the row fields, then reads it?", "author": "electrum", "createdAt": "2020-07-25T18:53:30Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/TypeConverter.java", "diffHunk": "@@ -199,7 +199,7 @@ private static PrestoToIcebergReturnDataType fromRow(RowType type, int index)\n             String name = field.getName().orElseThrow(() ->\n                     new PrestoException(NOT_SUPPORTED, \"Row type field does not have a name: \" + type.getDisplayName()));\n             PrestoToIcebergReturnDataType returnType = toIcebergType(field.getType(), index);\n-            fields.add(Types.NestedField.required(index, name, returnType.getType()));\n+            fields.add(Types.NestedField.optional(index, name, returnType.getType()));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTM4OQ==", "url": "https://github.com/trinodb/trino/pull/4578#discussion_r461221389", "bodyText": "Yes.", "author": "anjalinorwood", "createdAt": "2020-07-27T23:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQzMzMyOA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "56626a47cd0a70a0f9aa8b5a5e1fd57368cc8718", "url": "https://github.com/trinodb/trino/commit/56626a47cd0a70a0f9aa8b5a5e1fd57368cc8718", "message": "Mark the fields of ROW Type optional for Iceberg schema\n\nCurrently the fields of ROW type in Iceberg schema are marked as 'required'.\nIn reality, if the fields are optional, the writer may write a null value for\nthose fields. In such a case, the parquet file can not be read by parquet\nreader or Presto. Since Presto doesn't have a way to specify required/optional\ndesignation for ROW fields, this commit marks the fields as 'optional'.", "committedDate": "2020-07-30T20:22:20Z", "type": "forcePushed"}, {"oid": "3791282b81c51230ff9bad95a9c59797e5aa237b", "url": "https://github.com/trinodb/trino/commit/3791282b81c51230ff9bad95a9c59797e5aa237b", "message": "Mark the fields of ROW Type optional for Iceberg schema\n\nCurrently the fields of ROW type in Iceberg schema are marked as 'required'.\nIn reality, if the fields are optional, the writer may write a null value for\nthose fields. In such a case, the parquet file can not be read by parquet\nreader or Presto. Since Presto doesn't have a way to specify required/optional\ndesignation for ROW fields, this commit marks the fields as 'optional'.", "committedDate": "2020-07-30T20:33:49Z", "type": "commit"}, {"oid": "3791282b81c51230ff9bad95a9c59797e5aa237b", "url": "https://github.com/trinodb/trino/commit/3791282b81c51230ff9bad95a9c59797e5aa237b", "message": "Mark the fields of ROW Type optional for Iceberg schema\n\nCurrently the fields of ROW type in Iceberg schema are marked as 'required'.\nIn reality, if the fields are optional, the writer may write a null value for\nthose fields. In such a case, the parquet file can not be read by parquet\nreader or Presto. Since Presto doesn't have a way to specify required/optional\ndesignation for ROW fields, this commit marks the fields as 'optional'.", "committedDate": "2020-07-30T20:33:49Z", "type": "forcePushed"}]}