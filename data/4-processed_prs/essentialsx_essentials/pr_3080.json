{"pr_number": 3080, "pr_title": "Added a command to /eco that allows users to take percentages from pl\u2026", "pr_createdAt": "2020-03-21T20:21:53Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3080", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1NTYzOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r403855639", "bodyText": "Noooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooope\nBegone with your magic numbers!!!!\nMake this an enum or refactor out - prefer the second to the first but \ud83e\udd37\u200d\u2642\ufe0f", "author": "Ichbinjoe", "createdAt": "2020-04-06T06:29:41Z", "path": "Essentials/src/com/earth2me/essentials/User.java", "diffHunk": "@@ -220,7 +220,34 @@ public void takeMoney(final BigDecimal value, final CommandSource initiator, Use\n             initiator.sendMessage(tl(\"takenFromOthersAccount\", NumberUtil.displayCurrency(value, ess), this.getDisplayName(), NumberUtil.displayCurrency(getMoney(), ess)));\n         }\n     }\n-\n+    public void percentHandler(final BigDecimal percent, final CommandSource initiator, UserBalanceUpdateEvent.Cause cause, int cmd) {\n+        String message = \"PercentGivenTo\";\n+        if (percent.signum() == 0) {\n+            return;\n+        }\n+        BigDecimal value = getMoney().multiply(percent.divide(new BigDecimal(\"100.0\")));\n+        try {\n+            switch (cmd) {", "originalCommit": "0c2f47680d17c7d0fda35688919b222e815f9c67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1NjE4NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r403856184", "bodyText": "This is not sane - this will pass 5%3, and will then throw an exception because it can't parse the number.... which is then sent back to the user as 'NotEnoughArgumentsException'.", "author": "Ichbinjoe", "createdAt": "2020-04-06T06:31:14Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -35,7 +36,13 @@ public void run(final Server server, final CommandSource sender, final String co\n \n         try {\n             cmd = Commandeco.EcoCommands.valueOf(args[0].toUpperCase(Locale.ENGLISH));\n-            amount = (cmd == Commandeco.EcoCommands.RESET) ? startingBalance : new BigDecimal(args[2].replaceAll(\"[^0-9\\\\.]\", \"\"));\n+            if (args[2].contains(\"%\") && !(cmd == Commandeco.EcoCommands.RESET)) {\n+                isPercent = true;\n+                amount = new BigDecimal(args[2].substring(0,args[2].length()-1)); ", "originalCommit": "0c2f47680d17c7d0fda35688919b222e815f9c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkyMjU5Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r403922596", "bodyText": "Oof alright alright, fair. That is pretty bonkers now that you mention it. I'll check if the last character is '%' rather than if the entire string contains one.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (args[2].contains(\"%\") && !(cmd == Commandeco.EcoCommands.RESET)) {\n          \n          \n            \n                            isPercent = true;\n          \n          \n            \n                            amount = new BigDecimal(args[2].substring(0,args[2].length()-1)); \n          \n          \n            \n            if (args[2].endsWith(\"%\") && (cmd != Commandeco.EcoCommands.RESET))", "author": "CrashCringle12", "createdAt": "2020-04-06T08:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1NjE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1Njc0NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r403856745", "bodyText": "Please refactor into something along the lines of 'giveMoneyPercent' instead of using these magic values and a switch.", "author": "Ichbinjoe", "createdAt": "2020-04-06T06:32:51Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -55,13 +62,15 @@ public void run(final Server server, final CommandSource sender, final String co\n     protected void updatePlayer(final Server server, final CommandSource sender, final User player, final String[] args) throws NotEnoughArgumentsException, ChargeException, MaxMoneyException {\n         switch (cmd) {\n             case GIVE:\n-                player.giveMoney(amount, sender, UserBalanceUpdateEvent.Cause.COMMAND_ECO);\n+                if (isPercent)\n+                    player.percentHandler(amount, sender, UserBalanceUpdateEvent.Cause.COMMAND_ECO, 0);", "originalCommit": "0c2f47680d17c7d0fda35688919b222e815f9c67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1NzI1Nw==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r403857257", "bodyText": "This implementation doesn't line up with the implementation below... I get its non-congruent with the above two methods but this way makes it look like the messages are missing.", "author": "Ichbinjoe", "createdAt": "2020-04-06T06:34:13Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -91,10 +104,14 @@ private void set(BigDecimal amount, final User player, final CommandSource sende\n         BigDecimal maxBalance = ess.getSettings().getMaxMoney();\n         boolean underMinimum = (amount.compareTo(minBalance) < 0);\n         boolean aboveMax = (amount.compareTo(maxBalance) > 0);\n-        player.setMoney(underMinimum ? minBalance : aboveMax ? maxBalance : amount, UserBalanceUpdateEvent.Cause.COMMAND_ECO);\n-        player.sendMessage(tl(\"setBal\", NumberUtil.displayCurrency(player.getMoney(), ess)));\n-        if (sender != null) {\n-            sender.sendMessage(tl(\"setBalOthers\", player.getDisplayName(), NumberUtil.displayCurrency(player.getMoney(), ess)));\n+        if (isPercent) {\n+            player.percentHandler(amount, sender, UserBalanceUpdateEvent.Cause.COMMAND_ECO, 2);", "originalCommit": "0c2f47680d17c7d0fda35688919b222e815f9c67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDA2OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594068", "bodyText": "Try to avoid unnecessary formatting changes, as this results in a dirty diff.", "author": "pop4959", "createdAt": "2020-04-07T07:29:09Z", "path": "Essentials/src/com/earth2me/essentials/User.java", "diffHunk": "@@ -220,7 +220,7 @@ public void takeMoney(final BigDecimal value, final CommandSource initiator, Use\n             initiator.sendMessage(tl(\"takenFromOthersAccount\", NumberUtil.displayCurrency(value, ess), this.getDisplayName(), NumberUtil.displayCurrency(getMoney(), ess)));\n         }\n     }\n-\n+    ", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDE1NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594155", "bodyText": "=", "author": "pop4959", "createdAt": "2020-04-07T07:29:20Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -35,7 +36,9 @@ public void run(final Server server, final CommandSource sender, final String co\n \n         try {\n             cmd = Commandeco.EcoCommands.valueOf(args[0].toUpperCase(Locale.ENGLISH));\n+            isPercent = (args[2].endsWith(\"%\"));\n             amount = (cmd == Commandeco.EcoCommands.RESET) ? startingBalance : new BigDecimal(args[2].replaceAll(\"[^0-9\\\\.]\", \"\"));\n+            ", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDE5OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594198", "bodyText": "=", "author": "pop4959", "createdAt": "2020-04-07T07:29:24Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -61,7 +67,7 @@ protected void updatePlayer(final Server server, final CommandSource sender, fin\n             case TAKE:\n                 take(amount, player, sender);\n                 break;\n-\n+                ", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDIxOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594219", "bodyText": "=", "author": "pop4959", "createdAt": "2020-04-07T07:29:28Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -73,7 +79,7 @@ private void take(BigDecimal amount, final User player, final CommandSource send\n         BigDecimal money = player.getMoney();\n         BigDecimal minBalance = ess.getSettings().getMinMoney();\n         if (money.subtract(amount).compareTo(minBalance) >= 0) {\n-            player.takeMoney(amount, sender, UserBalanceUpdateEvent.Cause.COMMAND_ECO);\n+                player.takeMoney(amount, sender, UserBalanceUpdateEvent.Cause.COMMAND_ECO);", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDM3OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594379", "bodyText": "= (all of this under this line)", "author": "pop4959", "createdAt": "2020-04-07T07:29:45Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -91,12 +97,12 @@ private void set(BigDecimal amount, final User player, final CommandSource sende\n         BigDecimal maxBalance = ess.getSettings().getMaxMoney();\n         boolean underMinimum = (amount.compareTo(minBalance) < 0);\n         boolean aboveMax = (amount.compareTo(maxBalance) > 0);\n-        player.setMoney(underMinimum ? minBalance : aboveMax ? maxBalance : amount, UserBalanceUpdateEvent.Cause.COMMAND_ECO);\n-        player.sendMessage(tl(\"setBal\", NumberUtil.displayCurrency(player.getMoney(), ess)));\n-        if (sender != null) {\n-            sender.sendMessage(tl(\"setBalOthers\", player.getDisplayName(), NumberUtil.displayCurrency(player.getMoney(), ess)));\n+            player.setMoney(underMinimum ? minBalance : aboveMax ? maxBalance : amount, UserBalanceUpdateEvent.Cause.COMMAND_ECO);", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5NDgzMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r404594830", "bodyText": "This isn't relevant to this PR. If there is an issue with this message, please open another PR.", "author": "pop4959", "createdAt": "2020-04-07T07:30:30Z", "path": "Essentials/src/messages.properties", "diffHunk": "@@ -379,7 +379,7 @@ onlyPlayerSkulls=\\u00a74You can only set the owner of player skulls (\\u00a7c397\\\n onlySunStorm=\\u00a74/weather only supports sun/storm.\n openingDisposal=\\u00a76Opening disposal menu...\n orderBalances=\\u00a76Ordering balances of\\u00a7c {0} \\u00a76users, please wait...\n-oversizedMute=\ufffd4You may not mute a player for this period of time.\n+oversizedMute=\\u00a74You may not mute a player for this period of time.", "originalCommit": "eb82758185435698e2356a25d0a8b9e209448b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "url": "https://github.com/EssentialsX/Essentials/commit/aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "message": "Removed unnecessary formatting", "committedDate": "2020-04-07T18:36:05Z", "type": "commit"}, {"oid": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "url": "https://github.com/EssentialsX/Essentials/commit/aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "message": "Removed unnecessary formatting", "committedDate": "2020-04-07T18:36:05Z", "type": "forcePushed"}, {"oid": "fb135994967aaae1e1707f326008ba5469306d34", "url": "https://github.com/EssentialsX/Essentials/commit/fb135994967aaae1e1707f326008ba5469306d34", "message": "Merge branch '2.x' of https://github.com/EssentialsX/Essentials into 2.x", "committedDate": "2020-04-27T17:11:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNjUwNw==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r417706507", "bodyText": "This should be 4 spaces to remain consistent with the code formatting in this file.", "author": "pop4959", "createdAt": "2020-04-30T01:34:14Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -20,7 +20,7 @@\n public class Commandeco extends EssentialsLoopCommand {\n     Commandeco.EcoCommands cmd;\n     BigDecimal amount;\n-\n+\tboolean isPercent;", "originalCommit": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODMzMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r419938331", "bodyText": "Gotcha", "author": "CrashCringle12", "createdAt": "2020-05-05T08:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNjUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNjk4Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r417706982", "bodyText": "Don't need parentheses here.", "author": "pop4959", "createdAt": "2020-04-30T01:36:12Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -35,6 +35,7 @@ public void run(final Server server, final CommandSource sender, final String co\n \n         try {\n             cmd = Commandeco.EcoCommands.valueOf(args[0].toUpperCase(Locale.ENGLISH));\n+            isPercent = (args[2].endsWith(\"%\"));", "originalCommit": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwODI4NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r417708285", "bodyText": "Forgot, there should also be a space between the if and ( here. By the way, using CTRL+ALT+L in IntelliJ will auto format the file for you, in standard formatting (which is what is used here).", "author": "pop4959", "createdAt": "2020-04-30T01:41:11Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -53,6 +54,9 @@ public void run(final Server server, final CommandSource sender, final String co\n \n     @Override\n     protected void updatePlayer(final Server server, final CommandSource sender, final User player, final String[] args) throws NotEnoughArgumentsException, ChargeException, MaxMoneyException {\n+        if(isPercent && cmd != EcoCommands.RESET) {", "originalCommit": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAyMDg0NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3080#discussion_r419020844", "bodyText": "This can be optimized quite a bit.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        amount = player.getMoney().multiply(amount.divide(new BigDecimal(\"100.0\")));\n          \n          \n            \n                        amount = player.getMoney().multiply(amount).scaleByPowerOfTen(-2);\n          \n      \n    \n    \n  \n\nThis abuses how BigDecimals & Integers work to get around a division.", "author": "Ichbinjoe", "createdAt": "2020-05-02T23:26:02Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandeco.java", "diffHunk": "@@ -53,6 +54,9 @@ public void run(final Server server, final CommandSource sender, final String co\n \n     @Override\n     protected void updatePlayer(final Server server, final CommandSource sender, final User player, final String[] args) throws NotEnoughArgumentsException, ChargeException, MaxMoneyException {\n+        if(isPercent && cmd != EcoCommands.RESET) {\n+            amount = player.getMoney().multiply(amount.divide(new BigDecimal(\"100.0\")));", "originalCommit": "aaf1e23a702dec5ac2ee55c24b01baecc7ce9d18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab9b1c6708472917f8505a67e444aa273a9ccb6e", "url": "https://github.com/EssentialsX/Essentials/commit/ab9b1c6708472917f8505a67e444aa273a9ccb6e", "message": "Merge branch '2.x' of https://github.com/EssentialsX/Essentials into 2.x", "committedDate": "2020-05-05T08:16:14Z", "type": "commit"}, {"oid": "4b3cb89ced5babf9983ae550c8021f229efe650b", "url": "https://github.com/EssentialsX/Essentials/commit/4b3cb89ced5babf9983ae550c8021f229efe650b", "message": "Fixed spacing around isPercent, removed unnecessary parenthesis, optimized conversion", "committedDate": "2020-05-05T08:17:28Z", "type": "commit"}]}