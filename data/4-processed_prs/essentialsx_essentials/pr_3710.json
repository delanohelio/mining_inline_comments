{"pr_number": 3710, "pr_title": "Rework Mail System", "pr_createdAt": "2020-10-05T05:18:15Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3710", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1MTE1Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r499351153", "bodyText": "No space before ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);\n          \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean() ? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "author": "l1ttleO", "createdAt": "2020-10-05T05:23:14Z", "path": "Essentials/src/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    @Deprecated\n+    public void sendLegacyMail(IUser user, String message) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"legacy\", true);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    public String getMailLine(JsonObject mail) {\n+        String message = mail.get(\"message\").getAsString();\n+        if (mail.has(\"legacy\")) {\n+            return tl(\"mailMessage\", message);\n+        }\n+        return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "originalCommit": "28aaec3edf025cb7db4624cbe9a89dcf948c5697", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1NDMzNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r499354335", "bodyText": "working on merge conflicts along with new style constraints give me a few", "author": "JRoy", "createdAt": "2020-10-05T05:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1MTE1Mw=="}], "type": "inlineReview"}, {"oid": "86c39144e3eedf25516bf379686456f6b7a54975", "url": "https://github.com/EssentialsX/Essentials/commit/86c39144e3eedf25516bf379686456f6b7a54975", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "committedDate": "2020-11-25T21:45:42Z", "type": "forcePushed"}, {"oid": "fe1fef9fd08bdead56977065ceeb09584cdd2130", "url": "https://github.com/EssentialsX/Essentials/commit/fe1fef9fd08bdead56977065ceeb09584cdd2130", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "committedDate": "2020-11-25T21:46:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE2OTgxMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563169811", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "author": "mdcfe", "createdAt": "2021-01-23T16:13:47Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Console.java", "diffHunk": "@@ -46,6 +48,11 @@ public String getName() {\n         return Console.NAME;\n     }\n \n+    @Override\n+    public UUID getUuid() {", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA4OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170088", "bodyText": "Gson should not be a part of the API.", "author": "mdcfe", "createdAt": "2021-01-23T16:16:19Z", "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA5Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170093", "bodyText": "Ditto", "author": "mdcfe", "createdAt": "2021-01-23T16:16:24Z", "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();\n+\n+    int getMailAmount();\n+\n+    void setMailArray(JsonArray mailArray);", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDY3OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170678", "bodyText": "I'd prefer we avoid IMessageRecipient - it's part of a messaging abstraction that was never actually implemented and should probably be phased out. I'd rather we just use IUser, or if absolutely necessary, add our own MailRecipient interface (not sure what the benefit is when all message recipients will be users though).", "author": "mdcfe", "createdAt": "2021-01-23T16:21:48Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzMwODY0Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563308642", "bodyText": "not sure what the benefit is when all message recipients will be users though\n\nConsole, while they cannot receive mail, can still send it, So IUser isn't acceptable here. I'll convert this to a custom interface tho", "author": "JRoy", "createdAt": "2021-01-24T15:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDkwOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170909", "bodyText": "Would much prefer we used a plain/immutable MailMessage/Mail.Message class for individual mails' data. This would let us object map + expose a much nicer mails API. Also, I'm not a huge fan of shoving JSON inside a string in another YAML file; may want to consider storing mails in a mails.json or something similar instead.", "author": "mdcfe", "createdAt": "2021-01-23T16:24:29Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTM5Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171393", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "author": "mdcfe", "createdAt": "2021-01-23T16:28:30Z", "path": "Essentials/src/main/java/com/earth2me/essentials/User.java", "diffHunk": "@@ -917,6 +916,11 @@ public String getName() {\n         return this.getBase().getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcwMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171700", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and should not be used.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "author": "mdcfe", "createdAt": "2021-01-23T16:31:34Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcyMw==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171723", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and will fail at runtime.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "author": "mdcfe", "createdAt": "2021-01-23T16:32:00Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTc5MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171791", "bodyText": "I'm not sure why this isn't still just implemented in UserData?", "author": "mdcfe", "createdAt": "2021-01-23T16:32:34Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated\n+    abstract void addMail(String mail);", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ1NjAwMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563456000", "bodyText": "Due to the way the system works, we need an IUser, something UserData isn't. Doesn't cause any side effects so /shrug.", "author": "JRoy", "createdAt": "2021-01-25T04:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTk1OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171959", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UUID getUuid();\n          \n          \n            \n                UUID getUUID();", "author": "mdcfe", "createdAt": "2021-01-23T16:34:24Z", "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "diffHunk": "@@ -48,6 +50,13 @@\n      */\n     String getName();\n \n+    /**\n+     * Returns the UUID of this recipient. If the recipient is the console, null is returned.\n+     *\n+     * @return UUID of the this recipient or null if its console.\n+     */\n+    UUID getUuid();", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTc5NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n          \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUUID() == null ? \"null\" : sender.getUUID().toString());", "author": "JRoy", "createdAt": "2021-01-23T22:57:46Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTg1NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                    return this.parent.getUuid();\n          \n          \n            \n                public UUID getUUID() {\n          \n          \n            \n                    return this.parent.getUUID();", "author": "JRoy", "createdAt": "2021-01-23T22:58:36Z", "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/SimpleMessageRecipient.java", "diffHunk": "@@ -60,6 +61,11 @@ public String getName() {\n         return this.parent.getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {\n+        return this.parent.getUuid();", "originalCommit": "bfb39af0fd0172563a609e37d1e95dc72aaae931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTM5Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491392", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String sender;\n          \n          \n            \n                private final String senderName;", "author": "kashike", "createdAt": "2021-01-25T06:42:56Z", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;", "originalCommit": "2062c058757984ffa6076610d8f7b6c6570c8b93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTQxMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491412", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final UUID uuid;\n          \n          \n            \n                private final UUID senderId;", "author": "kashike", "createdAt": "2021-01-25T06:42:58Z", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;\n+    private final UUID uuid;", "originalCommit": "2062c058757984ffa6076610d8f7b6c6570c8b93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTU1Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491552", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    object.get(\"sender\").getAsString(),\n          \n          \n            \n                                    object.get(\"senderName\").getAsString(),", "author": "kashike", "createdAt": "2021-01-25T06:43:29Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),", "originalCommit": "2062c058757984ffa6076610d8f7b6c6570c8b93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTYyMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    UUID.fromString(object.get(\"uuid\").getAsString()),\n          \n          \n            \n                                    UUID.fromString(object.get(\"senderId\").getAsString()),", "author": "kashike", "createdAt": "2021-01-25T06:43:41Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),\n+                        UUID.fromString(object.get(\"uuid\").getAsString()),", "originalCommit": "2062c058757984ffa6076610d8f7b6c6570c8b93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "url": "https://github.com/EssentialsX/Essentials/commit/03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "message": "Add rich mail messages", "committedDate": "2021-06-09T15:57:22Z", "type": "forcePushed"}, {"oid": "06926a060036a8dd86627873e73ab8b42fb8a7de", "url": "https://github.com/EssentialsX/Essentials/commit/06926a060036a8dd86627873e73ab8b42fb8a7de", "message": "Add rich mail messages", "committedDate": "2021-06-09T16:00:44Z", "type": "commit"}, {"oid": "06926a060036a8dd86627873e73ab8b42fb8a7de", "url": "https://github.com/EssentialsX/Essentials/commit/06926a060036a8dd86627873e73ab8b42fb8a7de", "message": "Add rich mail messages", "committedDate": "2021-06-09T16:00:44Z", "type": "forcePushed"}, {"oid": "067c6847835456ec0396e27f469c3c9587534d02", "url": "https://github.com/EssentialsX/Essentials/commit/067c6847835456ec0396e27f469c3c9587534d02", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/UserData.java\n#\tEssentials/src/main/java/com/earth2me/essentials/config/holders/UserConfigHolder.java", "committedDate": "2021-06-09T21:36:27Z", "type": "commit"}, {"oid": "f2da0c73ffaec25107955a0b9eec2ec5b64d1dcd", "url": "https://github.com/EssentialsX/Essentials/commit/f2da0c73ffaec25107955a0b9eec2ec5b64d1dcd", "message": "Don't use bukkit configs :(", "committedDate": "2021-06-10T02:21:20Z", "type": "commit"}, {"oid": "30706b92fa7f8132f7ef551802b65d60eaa93a67", "url": "https://github.com/EssentialsX/Essentials/commit/30706b92fa7f8132f7ef551802b65d60eaa93a67", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-11T15:15:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDE3MjU4OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r650172589", "bodyText": "you need to pass the element type of the list through to configurate here somehow -- .set(Object) doesn't properly unwrap included values\ncould be .set(TypeToken<List<MailMessage>>, messages), or .setList(MailMessage.class, messages)", "author": "zml2008", "createdAt": "2021-06-11T17:58:00Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpgrade.java", "diffHunk": "@@ -146,6 +147,45 @@ public static void uuidFileConvert(final IEssentials ess, final Boolean ignoreUF\n         ess.getLogger().info(\"To rerun the conversion type /essentials uuidconvert\");\n     }\n \n+    public void convertMailList() {\n+        if (doneFile.getBoolean(\"updateUsersMailList\", false)) {\n+            return;\n+        }\n+\n+        final File userdataFolder = new File(ess.getDataFolder(), \"userdata\");\n+        if (!userdataFolder.exists() || !userdataFolder.isDirectory()) {\n+            return;\n+        }\n+        final File[] userFiles = userdataFolder.listFiles();\n+        for (File file : userFiles) {\n+            if (!file.isFile() || !file.getName().endsWith(\".yml\")) {\n+                continue;\n+            }\n+            final EssentialsConfiguration config = new EssentialsConfiguration(file);\n+            try {\n+                config.load();\n+                if (config.hasProperty(\"mail\") && config.isList(\"mail\")) {\n+                    final ArrayList<MailMessage> messages = new ArrayList<>();\n+                    for (String mailStr : Collections.synchronizedList(config.getList(\"mail\", String.class))) {\n+                        if (mailStr == null) {\n+                            continue;\n+                        }\n+                        messages.add(new MailMessage(false, true, null, null, 0L, 0L, mailStr));\n+                    }\n+                    config.removeProperty(\"mail\");\n+                    config.setProperty(\"mail\", messages);", "originalCommit": "30706b92fa7f8132f7ef551802b65d60eaa93a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b1b8488f51b1dfcdc0dc254825ebd51f70fe7d5", "url": "https://github.com/EssentialsX/Essentials/commit/3b1b8488f51b1dfcdc0dc254825ebd51f70fe7d5", "message": "Fix mail conversions\n\nthanks zml :))", "committedDate": "2021-06-11T18:20:54Z", "type": "commit"}, {"oid": "9312646cbc462a414adf9aaad6bd71a327e1f3f1", "url": "https://github.com/EssentialsX/Essentials/commit/9312646cbc462a414adf9aaad6bd71a327e1f3f1", "message": "lmfao", "committedDate": "2021-06-11T18:22:46Z", "type": "commit"}, {"oid": "7c33159805ca91cc55b6ffc6bd862e3508fdf1b9", "url": "https://github.com/EssentialsX/Essentials/commit/7c33159805ca91cc55b6ffc6bd862e3508fdf1b9", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-12T20:53:36Z", "type": "commit"}, {"oid": "d06bd22d1a2d14fb371ea92a166d00f861b56aa0", "url": "https://github.com/EssentialsX/Essentials/commit/d06bd22d1a2d14fb371ea92a166d00f861b56aa0", "message": "Don't use vanilla handler here, player names are cringe", "committedDate": "2021-06-12T21:10:44Z", "type": "commit"}, {"oid": "a8e2c4f60e3e4efab23f0d4ac4d5a60de956364a", "url": "https://github.com/EssentialsX/Essentials/commit/a8e2c4f60e3e4efab23f0d4ac4d5a60de956364a", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-14T11:31:34Z", "type": "commit"}, {"oid": "3902795bad5aae6d0eb10bf091e2ddea269555b9", "url": "https://github.com/EssentialsX/Essentials/commit/3902795bad5aae6d0eb10bf091e2ddea269555b9", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-18T01:34:16Z", "type": "commit"}, {"oid": "439cdbba84c934296e1b69807b36982e424b9eac", "url": "https://github.com/EssentialsX/Essentials/commit/439cdbba84c934296e1b69807b36982e424b9eac", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-26T22:35:39Z", "type": "commit"}, {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03", "url": "https://github.com/EssentialsX/Essentials/commit/e4b777d3807d37ea08db7bc1eb30108068aa7c03", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-27T03:36:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg2MjY1Nw==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660862657", "bodyText": "Shouldn't this include the sender name to be consistent with the old format? I can imagine some janky plugin somewhere trying to parse this.", "author": "mdcfe", "createdAt": "2021-06-29T18:23:37Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -313,17 +314,58 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n+    /**\n+     * @deprecated Mails are no longer just strings, this method is therefore misleading.\n+     */\n+    @Deprecated\n     public List<String> getMails() {\n-        return holder.mail();\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (MailMessage mail : getMailMessages()) {\n+                list.add(mail.getMessage());", "originalCommit": "e4b777d3807d37ea08db7bc1eb30108068aa7c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDk5MTYzNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660991635", "bodyText": "sadge", "author": "JRoy", "createdAt": "2021-06-29T21:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg2MjY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDk4NTA1NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660985055", "bodyText": "MailService", "author": "mdcfe", "createdAt": "2021-06-29T21:43:39Z", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/Mail.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import net.ess3.api.IUser;\n+\n+/**\n+ * This interface provides access to core Essentials mailing functions, allowing API users to send messages to {@link IUser IUser's }.\n+ */\n+public interface Mail {", "originalCommit": "e4b777d3807d37ea08db7bc1eb30108068aa7c03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1040e4ad675ea117655752225358dd19a9d861b", "url": "https://github.com/EssentialsX/Essentials/commit/a1040e4ad675ea117655752225358dd19a9d861b", "message": "Kill me", "committedDate": "2021-06-29T22:02:00Z", "type": "commit"}, {"oid": "8b1e33dff5afa5b8a72b4c5b8bfe3a1cadf37f58", "url": "https://github.com/EssentialsX/Essentials/commit/8b1e33dff5afa5b8a72b4c5b8bfe3a1cadf37f58", "message": "Mail -> MailService", "committedDate": "2021-06-29T22:02:49Z", "type": "commit"}, {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091", "url": "https://github.com/EssentialsX/Essentials/commit/51ebbe21d88b0589cbee2c4993dbcf3311b37091", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-06-30T12:28:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjE3NTUyMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r662175521", "bodyText": "...after my previous review I realised this would've returned a translated string in the past.\nNot sure if it's worth doing the mailFormat translation, keeping this hardcoded as it is now, or undoing this change entirely\nYes I'm indecisive shh", "author": "mdcfe", "createdAt": "2021-07-01T10:33:15Z", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -322,7 +323,8 @@ public void setJail(final String jail) {\n         final List<String> list = new ArrayList<>();\n         if (getMailAmount() != 0) {\n             for (MailMessage mail : getMailMessages()) {\n-                list.add(mail.getMessage());\n+                // I hate this code btw\n+                list.add(mail.isLegacy() ? mail.getMessage() : ChatColor.GOLD + \"[\" + ChatColor.RESET + mail.getSenderUsername() + ChatColor.GOLD + \"] \" + ChatColor.RESET + mail.getMessage());", "originalCommit": "51ebbe21d88b0589cbee2c4993dbcf3311b37091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjMwMzM4NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r662303384", "bodyText": "hardcoded, people need to move off this api", "author": "JRoy", "createdAt": "2021-07-01T13:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjE3NTUyMQ=="}], "type": "inlineReview"}, {"oid": "bff633f21873688e7efac6429e065633b97ba0f0", "url": "https://github.com/EssentialsX/Essentials/commit/bff633f21873688e7efac6429e065633b97ba0f0", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-07-01T13:46:53Z", "type": "commit"}, {"oid": "00a670096775555c7864a4bc977652c25d8d6b0e", "url": "https://github.com/EssentialsX/Essentials/commit/00a670096775555c7864a4bc977652c25d8d6b0e", "message": "Add missing methods from DiscordMessageRecipient", "committedDate": "2021-07-01T13:59:00Z", "type": "commit"}, {"oid": "182fd3ed321fe300c5905438327496cb2d1aa0df", "url": "https://github.com/EssentialsX/Essentials/commit/182fd3ed321fe300c5905438327496cb2d1aa0df", "message": "Merge branch '2.x' into feature/mail-revamp", "committedDate": "2021-07-01T15:18:11Z", "type": "commit"}]}