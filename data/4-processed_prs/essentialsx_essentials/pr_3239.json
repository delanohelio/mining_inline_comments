{"pr_number": 3239, "pr_title": "Fix spawner delay feature", "pr_createdAt": "2020-05-07T09:46:14Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3239", "timeline": [{"oid": "b0c97f0fe92a8204c7e6dbeedc88d48fa428394b", "url": "https://github.com/EssentialsX/Essentials/commit/b0c97f0fe92a8204c7e6dbeedc88d48fa428394b", "message": "Fix spawner delay feature", "committedDate": "2020-05-07T09:18:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzODU1Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r421538552", "bodyText": "All of the Class and Field objects should be stored as a private static final field. Additionally, the Method objects should be stored as a MethodHandle.\nSee https://github.com/EssentialsX/Essentials/pull/3157/files#diff-d515c857ac85b710ac67491e3dd1779aR121-R148 for an example.", "author": "JRoy", "createdAt": "2020-05-07T14:15:44Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandspawner.java", "diffHunk": "@@ -57,8 +62,31 @@ protected void run(final Server server, final User user, final String commandLab\n         final Trade charge = new Trade(\"spawner-\" + mob.name.toLowerCase(Locale.ENGLISH), ess);\n         charge.isAffordableFor(user);\n         try {\n-            CreatureSpawner spawner = (CreatureSpawner) target.getBlock().getState();\n+            Block block = target.getBlock();\n+            CreatureSpawner spawner = (CreatureSpawner) block.getState();\n             spawner.setSpawnedType(mob.getType());\n+            if (delay > 0) {\n+                if (VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_12_2_R01)) {\n+                    spawner.setMinSpawnDelay(0);\n+                    spawner.setMaxSpawnDelay(Integer.MAX_VALUE);\n+                    spawner.setMinSpawnDelay(delay);\n+                    spawner.setMaxSpawnDelay(delay);\n+                } else {\n+                    Class<?> craftWorld = ReflUtil.getOBCClass(\"CraftWorld\");\n+                    Class<?> tileEntityMobSpawner = ReflUtil.getNMSClass(\"TileEntityMobSpawner\");\n+                    Class<?> mobSpawnerAbstract = ReflUtil.getNMSClass(\"MobSpawnerAbstract\");\n+                    Method getSpawner = tileEntityMobSpawner.getDeclaredMethod(\"getSpawner\");\n+                    Method getTileEntityAt = craftWorld.getDeclaredMethod(\"getTileEntityAt\", int.class, int.class, int.class);\n+                    Object craftTileEntity = getTileEntityAt.invoke(block.getWorld(), block.getX(), block.getY(), block.getZ());\n+                    Object nmsSpawner = getSpawner.invoke(craftTileEntity);\n+                    Field minSpawnDelay = ReflUtil.getFieldCached(mobSpawnerAbstract, \"minSpawnDelay\");\n+                    Field maxSpawnDelay = ReflUtil.getFieldCached(mobSpawnerAbstract, \"maxSpawnDelay\");\n+                    if (minSpawnDelay != null && maxSpawnDelay != null) {\n+                        minSpawnDelay.setInt(nmsSpawner, delay);\n+                        maxSpawnDelay.setInt(nmsSpawner, delay);\n+                    }\n+                }\n+            }", "originalCommit": "b0c97f0fe92a8204c7e6dbeedc88d48fa428394b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2NDQwNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r421764404", "bodyText": "I overlooked this because I noticed ReflUtil already does a lot of the caching, but this is certainly a good idea. Also, didn't know about MethodHandle. From a quick google search, it looks like the main benefit there is it'll be a little faster to call than Method? I'll probably be refactoring this into it's own provider once I get some clarification from MD on how I should do that, so the NMS code won't just awkwardly be sitting inside Commandspawner.", "author": "pop4959", "createdAt": "2020-05-07T20:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzODU1Mg=="}], "type": "inlineReview"}, {"oid": "8a6af584217a51b252f27232d7155e34e7e4f2ac", "url": "https://github.com/EssentialsX/Essentials/commit/8a6af584217a51b252f27232d7155e34e7e4f2ac", "message": "Update branch", "committedDate": "2020-06-13T18:37:13Z", "type": "commit"}, {"oid": "98d7dca61316f1bedb004b07d85f860b06a04f3d", "url": "https://github.com/EssentialsX/Essentials/commit/98d7dca61316f1bedb004b07d85f860b06a04f3d", "message": "Spawner block provider", "committedDate": "2020-06-14T03:42:45Z", "type": "commit"}, {"oid": "34e63a8eda2f118ab4834908b387c235746aea32", "url": "https://github.com/EssentialsX/Essentials/commit/34e63a8eda2f118ab4834908b387c235746aea32", "message": "Revert \"Spawner block provider\"\n\nThis reverts commit 98d7dca61316f1bedb004b07d85f860b06a04f3d.", "committedDate": "2020-06-14T03:54:19Z", "type": "commit"}, {"oid": "259de82770e142a91a9ddb599d5cd884a4b9a90a", "url": "https://github.com/EssentialsX/Essentials/commit/259de82770e142a91a9ddb599d5cd884a4b9a90a", "message": "Revert \"Update branch\"\n\nThis reverts commit 8a6af584217a51b252f27232d7155e34e7e4f2ac.", "committedDate": "2020-06-14T03:54:35Z", "type": "commit"}, {"oid": "c4c757aa79ad2907a51184628af7008d9aeeee3b", "url": "https://github.com/EssentialsX/Essentials/commit/c4c757aa79ad2907a51184628af7008d9aeeee3b", "message": "Merge branch '2.x' into spawner-delay", "committedDate": "2020-06-14T03:57:12Z", "type": "commit"}, {"oid": "4134362d4a9424889b98d70751e7a7c8fb0608e3", "url": "https://github.com/EssentialsX/Essentials/commit/4134362d4a9424889b98d70751e7a7c8fb0608e3", "message": "Spawner block provider", "committedDate": "2020-06-14T03:59:13Z", "type": "commit"}, {"oid": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5", "url": "https://github.com/EssentialsX/Essentials/commit/b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5", "message": "remove unnecessary import", "committedDate": "2020-06-14T04:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1NjQwOA==", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r440156408", "bodyText": "tryProvider should be implemented by the abstract provider class and should attempt to call one of the provider's methods. Otherwise we don't know for certain that this provider actually does what it's supposed to in a consistent fashion.", "author": "mdcfe", "createdAt": "2020-06-15T12:58:03Z", "path": "nms/UpdatedMetaProvider/src/net/ess3/nms/updatedmeta/BukkitSpawnerBlockProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package net.ess3.nms.updatedmeta;\n+\n+import net.ess3.nms.SpawnerBlockProvider;\n+import org.bukkit.block.CreatureSpawner;\n+\n+public class BukkitSpawnerBlockProvider extends SpawnerBlockProvider {\n+    @Override\n+    public void setMaxSpawnDelay(CreatureSpawner spawner, int delay) {\n+        spawner.setMaxSpawnDelay(delay);\n+    }\n+\n+    @Override\n+    public void setMinSpawnDelay(CreatureSpawner spawner, int delay) {\n+        spawner.setMinSpawnDelay(delay);\n+    }\n+\n+    @Override\n+    public boolean tryProvider() {", "originalCommit": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5NjAzNw==", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r440496037", "bodyText": "Difficult to do in this circumstance, since we do not have a CreatureSpawner instance to call the provider's methods on. For the other providers, it's easier to do this since it only uses ItemStack, EntityType and Material classes, which are enums or easily instantiated. That's why I opted to implement tryProvider in the concrete class rather than in the abstract one. It's definitely different, but I don't think it's bad. The way it's set up, if the methods required from the API do not exist, we safely assume that this is MC 1.8-1.11, where we need NMS (old versions are not going to change). Otherwise, we can rely on the API (the implementation may change, but it should not concern us).", "author": "pop4959", "createdAt": "2020-06-15T23:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1NjQwOA=="}], "type": "inlineReview"}, {"oid": "db40224a6576f8bf2b529f1eabbb8d2f03b5ca9f", "url": "https://github.com/EssentialsX/Essentials/commit/db40224a6576f8bf2b529f1eabbb8d2f03b5ca9f", "message": "Merge branch '2.x' into spawner-delay", "committedDate": "2020-08-03T22:28:09Z", "type": "commit"}, {"oid": "d7da5e9a0afe8e7104717afa4fe9d3ddfa9947f8", "url": "https://github.com/EssentialsX/Essentials/commit/d7da5e9a0afe8e7104717afa4fe9d3ddfa9947f8", "message": "Refactor everything", "committedDate": "2020-08-03T23:16:32Z", "type": "commit"}, {"oid": "6588b679c68b01a0da35276bef566c650aec3eb8", "url": "https://github.com/EssentialsX/Essentials/commit/6588b679c68b01a0da35276bef566c650aec3eb8", "message": "Remove old files", "committedDate": "2020-08-03T23:19:19Z", "type": "commit"}, {"oid": "b525d28278fcdf0427bb5538086df8381fe10c49", "url": "https://github.com/EssentialsX/Essentials/commit/b525d28278fcdf0427bb5538086df8381fe10c49", "message": "Remove unused provider", "committedDate": "2020-08-03T23:23:19Z", "type": "commit"}]}