{"pr_number": 3418, "pr_title": "Implement random teleport command", "pr_createdAt": "2020-06-27T01:48:45Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3418", "timeline": [{"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc", "url": "https://github.com/EssentialsX/Essentials/commit/d99ef6bef5a8f39d8b25fab226922326570c9afc", "message": "Implement random teleport command", "committedDate": "2020-06-27T01:34:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MTA4NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446481085", "bodyText": "random seems like an odd name. Something like rtp, randomtp, or randomteleport", "author": "JRoy", "createdAt": "2020-06-27T04:02:11Z", "path": "Essentials/src/com/earth2me/essentials/RandomTeleport.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.InvalidWorldException;\n+import org.bukkit.Location;\n+\n+import java.io.File;\n+\n+public class RandomTeleport implements IConf {\n+    private final IEssentials essentials;\n+    private final EssentialsConf config;\n+\n+    public RandomTeleport(final IEssentials essentials) {\n+        this.essentials = essentials;\n+        File file = new File(essentials.getDataFolder(), \"random.yml\");\n+        config = new EssentialsConf(file);\n+        config.setTemplateName(\"/random.yml\");", "originalCommit": "d99ef6bef5a8f39d8b25fab226922326570c9afc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MTIwMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446481202", "bodyText": "English literals ruin the point of translation :P", "author": "JRoy", "createdAt": "2020-06-27T04:03:46Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandsettpr.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.User;\n+import org.bukkit.Server;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandsettpr extends EssentialsCommand {\n+    public Commandsettpr() {\n+        super(\"settpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        if (args.length == 0 || \"center\".equalsIgnoreCase(args[0])) {\n+            randomTeleport.setCenter(user.getLocation());\n+            user.sendMessage(tl(\"settpr\", \"center\"));", "originalCommit": "d99ef6bef5a8f39d8b25fab226922326570c9afc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MjI3OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446482278", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    config = new EssentialsConf(file);\n          \n          \n            \n                    config = new EssentialsConf(file);\n          \n          \n            \n                    config.options().header(\"this is a string stringy xdxdxd\");", "author": "JRoy", "createdAt": "2020-06-27T04:17:31Z", "path": "Essentials/src/com/earth2me/essentials/RandomTeleport.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.InvalidWorldException;\n+import org.bukkit.Location;\n+\n+import java.io.File;\n+\n+public class RandomTeleport implements IConf {\n+    private final IEssentials essentials;\n+    private final EssentialsConf config;\n+\n+    public RandomTeleport(final IEssentials essentials) {\n+        this.essentials = essentials;\n+        File file = new File(essentials.getDataFolder(), \"random.yml\");\n+        config = new EssentialsConf(file);", "originalCommit": "d99ef6bef5a8f39d8b25fab226922326570c9afc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf019292b272b9e036258f65e207308b29e1c8e5", "url": "https://github.com/EssentialsX/Essentials/commit/bf019292b272b9e036258f65e207308b29e1c8e5", "message": "rename file", "committedDate": "2020-06-27T05:34:02Z", "type": "commit"}, {"oid": "c9bc22c7b9d5c7da05c2a755fa9df17294c8d0e6", "url": "https://github.com/EssentialsX/Essentials/commit/c9bc22c7b9d5c7da05c2a755fa9df17294c8d0e6", "message": "tl fix", "committedDate": "2020-06-27T05:35:50Z", "type": "commit"}, {"oid": "23af2e42fc61317f82ff08bb567ba1c9ecae58e0", "url": "https://github.com/EssentialsX/Essentials/commit/23af2e42fc61317f82ff08bb567ba1c9ecae58e0", "message": "improve config", "committedDate": "2020-06-27T05:46:38Z", "type": "commit"}, {"oid": "d9428168dc516bae1d9364471b9cf5c7899c96f6", "url": "https://github.com/EssentialsX/Essentials/commit/d9428168dc516bae1d9364471b9cf5c7899c96f6", "message": "Add biome blocking (no more oceans!) and location finding / caching", "committedDate": "2020-06-27T08:07:36Z", "type": "commit"}, {"oid": "bd6e07111020c77776a91057dbe715849e0482d6", "url": "https://github.com/EssentialsX/Essentials/commit/bd6e07111020c77776a91057dbe715849e0482d6", "message": "optimisation - makes command significantly faster on spigot", "committedDate": "2020-06-27T19:58:32Z", "type": "commit"}, {"oid": "4748e2e3c9bb27ccdbc3fd395ab7395866ccf3ec", "url": "https://github.com/EssentialsX/Essentials/commit/4748e2e3c9bb27ccdbc3fd395ab7395866ccf3ec", "message": "Merge branch '2.x' into command-tpr", "committedDate": "2020-06-27T21:50:01Z", "type": "commit"}, {"oid": "7c580c5ec3ba4a08aaee477d8111cba09657c88d", "url": "https://github.com/EssentialsX/Essentials/commit/7c580c5ec3ba4a08aaee477d8111cba09657c88d", "message": "Default to worldborder center if none set", "committedDate": "2020-06-28T00:38:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNTkyMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446715921", "bodyText": "would rather this be inlined", "author": "JRoy", "createdAt": "2020-06-29T00:05:26Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpr.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.Trade;\n+import com.earth2me.essentials.User;\n+import com.earth2me.essentials.utils.VersionUtil;\n+import io.papermc.lib.PaperLib;\n+import net.ess3.api.events.UserRandomTeleportEvent;\n+import org.bukkit.Location;\n+import org.bukkit.Server;\n+import org.bukkit.event.player.PlayerTeleportEvent;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.Random;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandtpr extends EssentialsCommand {\n+    private static final Random RANDOM = new Random();\n+    private static final int HIGHEST_BLOCK_Y_OFFSET = VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_15_R01) ? 1 : 0;\n+\n+    public Commandtpr() {\n+        super(\"tpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        final Trade charge = new Trade(this.getName(), ess);\n+        charge.isAffordableFor(user);\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        UserRandomTeleportEvent event = new UserRandomTeleportEvent(user, randomTeleport.getCenter(), randomTeleport.getMinRange(), randomTeleport.getMaxRange());\n+        server.getPluginManager().callEvent(event);\n+        if (event.isCancelled()) {\n+            return;\n+        }\n+        Location center = event.getCenter();\n+        double minRange = event.getMinRange();\n+        double maxRange = event.getMaxRange();", "originalCommit": "7c580c5ec3ba4a08aaee477d8111cba09657c88d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjU2MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446716560", "bodyText": "i n l i n e", "author": "JRoy", "createdAt": "2020-06-29T00:10:18Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpr.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.Trade;\n+import com.earth2me.essentials.User;\n+import com.earth2me.essentials.utils.VersionUtil;\n+import io.papermc.lib.PaperLib;\n+import net.ess3.api.events.UserRandomTeleportEvent;\n+import org.bukkit.Location;\n+import org.bukkit.Server;\n+import org.bukkit.event.player.PlayerTeleportEvent;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.Random;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandtpr extends EssentialsCommand {\n+    private static final Random RANDOM = new Random();\n+    private static final int HIGHEST_BLOCK_Y_OFFSET = VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_15_R01) ? 1 : 0;\n+\n+    public Commandtpr() {\n+        super(\"tpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        final Trade charge = new Trade(this.getName(), ess);\n+        charge.isAffordableFor(user);\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        UserRandomTeleportEvent event = new UserRandomTeleportEvent(user, randomTeleport.getCenter(), randomTeleport.getMinRange(), randomTeleport.getMaxRange());\n+        server.getPluginManager().callEvent(event);\n+        if (event.isCancelled()) {\n+            return;\n+        }\n+        Location center = event.getCenter();\n+        double minRange = event.getMinRange();\n+        double maxRange = event.getMaxRange();\n+        getRandomLocation(randomTeleport, center, minRange, maxRange).thenAccept(location -> {\n+            CompletableFuture<Boolean> future = getNewExceptionFuture(user.getSource(), commandLabel);\n+            user.getAsyncTeleport().teleport(location, charge, PlayerTeleportEvent.TeleportCause.COMMAND, future);\n+            future.thenAccept(success -> {\n+                if (success) {\n+                    user.sendMessage(tl(\"tprSuccess\"));\n+                }\n+            });\n+        });\n+    }\n+\n+    // Get a random location; cached if possible. Otherwise on demand.\n+    private CompletableFuture<Location> getRandomLocation(RandomTeleport randomTeleport, Location center, double minRange, double maxRange) {\n+        int findAttempts = randomTeleport.getFindAttempts();\n+        Queue<Location> cachedLocations = randomTeleport.getCachedLocations();\n+        // Try to build up the cache if it is below the threshold\n+        if (cachedLocations.size() < randomTeleport.getCacheThreshold()) {\n+            ess.getServer().getScheduler().scheduleSyncDelayedTask(ess, () -> {\n+                for (int i = 0; i < findAttempts; ++i) {", "originalCommit": "7c580c5ec3ba4a08aaee477d8111cba09657c88d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcyMjIwMw==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446722203", "bodyText": "please elaborate", "author": "pop4959", "createdAt": "2020-06-29T00:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjU2MA=="}], "type": "inlineReview"}, {"oid": "f7290629bc4bfed1dd0633f520ebe923ded959e3", "url": "https://github.com/EssentialsX/Essentials/commit/f7290629bc4bfed1dd0633f520ebe923ded959e3", "message": "i n l i n e", "committedDate": "2020-06-29T00:51:37Z", "type": "commit"}, {"oid": "251667d44aa63f86bedcfb8112f01ca9bd5f236a", "url": "https://github.com/EssentialsX/Essentials/commit/251667d44aa63f86bedcfb8112f01ca9bd5f236a", "message": "More sensible ddefault max range", "committedDate": "2020-06-30T22:51:25Z", "type": "commit"}, {"oid": "79f78a410d9dc514b292f175fadd5a0829f1db89", "url": "https://github.com/EssentialsX/Essentials/commit/79f78a410d9dc514b292f175fadd5a0829f1db89", "message": "Refactor + add pre-caching", "committedDate": "2020-07-01T00:34:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyMjQ1Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r448622456", "bodyText": "Shouldn't this file include all the available config options (ie pre-cache, max-range)?", "author": "mdcfe", "createdAt": "2020-07-01T21:21:05Z", "path": "Essentials/src/tpr.yml", "diffHunk": "@@ -0,0 +1,16 @@\n+# Configuration for the random teleport command.\n+# Some settings may be defaulted, and can be changed via the /settpr command in-game.", "originalCommit": "79f78a410d9dc514b292f175fadd5a0829f1db89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNDA2OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r448634068", "bodyText": "Arguably yes, although once something gets saved into the file, it is effectively permanent. This can be problematic, so unless the server owner explicitly sets some of these settings. Here's an explanation for the thought process behind putting all of the current settings where they are:\ncenter: We cannot have a default in the config, because we cannot assume what the world name is. So instead, when getCenter is called, we try reading the config first, but if that isn't available (or the world is no longer valid), we write the config with the center of the current main world, which is an appropriate default. This can further be changed via explicitly running the /settpr command or entering manual config.\nmin-range: In the config by default, and also automatically zero if none specified. Zero is a fine default, and the server owner can increase it if they do not want players teleporting into a spawn protected zone, etc.\nmax-range: Not explicitly in the config, because we want the default to be the max range of whatever world the command is being used in. This allows a true random location in the world, when server owners do not specify something lower. We don't want to hard code 3E7 (the default vanilla world border size) into here, because the server owner may have already changed it. It can be lowered if servers don't want a true random location, but rather something closer to spawn (like 1k, 10k, etc).\nexcluded-biomes: Which biomes should be avoided when selecting a random location. Safe teleport doesn't handle this, and will happily randomly teleport players into oceans for example (and fairly often actually) if not otherwise checked. This is set in the config by default since there is something sensible to set it to, and the server owner can adjust it if they want to add/remove anything.\nfind-attempts: Used internally for determining how many times to try finding random locations. This is something that generally should not be changed (higher = potentially more lag, lower = potentially not finding locations). Server owners can adjust it to tweak performance vs optimal behavior, but it's better not written in the config by default in case Essentials wants to adjust the default value in the future. #EasterEgg\ncache-threshold: Also used internally to decide when the cache is getting too empty, and needs to be refilled. Not really much reason to need to change this either, in most cases. #EasterEgg\npre-cache: Having this on by default makes the command run much faster (particularly, on the first execution, where there may otherwise be no cache). Having a small number of locations cached isn't particularly heavy, so there is not much reason for most server owners to touch this. It still exists as an option to disable though. #EasterEgg", "author": "pop4959", "createdAt": "2020-07-01T21:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyMjQ1Ng=="}], "type": "inlineReview"}, {"oid": "dffb6818a59f01ffd511c3dde5979535a37a8663", "url": "https://github.com/EssentialsX/Essentials/commit/dffb6818a59f01ffd511c3dde5979535a37a8663", "message": "Merge branch '2.x' into command-tpr", "committedDate": "2020-07-06T18:51:42Z", "type": "commit"}]}