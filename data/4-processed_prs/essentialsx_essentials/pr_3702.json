{"pr_number": 3702, "pr_title": "Add Baltop API", "pr_createdAt": "2020-10-03T17:05:34Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3702", "timeline": [{"oid": "9f0ad681302fbfe6942da931cd45f2831d6d1703", "url": "https://github.com/EssentialsX/Essentials/commit/9f0ad681302fbfe6942da931cd45f2831d6d1703", "message": "Add balancetop api", "committedDate": "2020-10-03T17:00:06Z", "type": "commit"}, {"oid": "42d29b84fa6db2d8379d55199facbc3c63401091", "url": "https://github.com/EssentialsX/Essentials/commit/42d29b84fa6db2d8379d55199facbc3c63401091", "message": "Move API to its own class", "committedDate": "2020-10-04T03:45:15Z", "type": "commit"}, {"oid": "7d12ecfc1a720d427c2aa5667171d82efdfda61f", "url": "https://github.com/EssentialsX/Essentials/commit/7d12ecfc1a720d427c2aa5667171d82efdfda61f", "message": "Reduce diff in UserMap", "committedDate": "2020-10-04T03:46:41Z", "type": "commit"}, {"oid": "c2d2878945b6ecfdcad670fba884da3bb3ba670e", "url": "https://github.com/EssentialsX/Essentials/commit/c2d2878945b6ecfdcad670fba884da3bb3ba670e", "message": "Improve API + Fix startup bug", "committedDate": "2020-10-04T04:17:32Z", "type": "commit"}, {"oid": "a324c5bab5d5ff6fe8cc48abc9af3c68bb149f8f", "url": "https://github.com/EssentialsX/Essentials/commit/a324c5bab5d5ff6fe8cc48abc9af3c68bb149f8f", "message": "Merge branch '2.x' into feature/improved-baltop-api\n\n# Conflicts:\n#\tEssentials/src/com/earth2me/essentials/commands/Commandbalancetop.java", "committedDate": "2020-10-05T06:10:59Z", "type": "commit"}, {"oid": "4ecde5df6b5632b7575774c27efa7adce8484964", "url": "https://github.com/EssentialsX/Essentials/commit/4ecde5df6b5632b7575774c27efa7adce8484964", "message": "Glare.mp4", "committedDate": "2020-10-05T14:25:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxODQxMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r499918411", "bodyText": "Why remove final here?", "author": "mbax", "createdAt": "2020-10-05T23:04:56Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandbalancetop.java", "diffHunk": "@@ -102,38 +98,17 @@ public void run() {\n             lock.writeLock().lock();\n             try {\n                 if (force || cacheage <= System.currentTimeMillis() - CACHETIME) {\n-                    cache.getLines().clear();\n-                    final Map<String, BigDecimal> balances = new HashMap<>();\n-                    BigDecimal totalMoney = BigDecimal.ZERO;\n                     if (ess.getSettings().isEcoDisabled()) {\n                         if (ess.getSettings().isDebug()) {\n                             ess.getLogger().info(\"Internal economy functions disabled, aborting baltop.\");\n                         }\n                     } else {\n-                        for (final UUID u : ess.getUserMap().getAllUniqueUsers()) {\n-                            final User user = ess.getUserMap().getUser(u);\n-                            if (user != null) {\n-                                if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n-                                    // Don't list NPCs in output\n-                                    continue;\n-                                }\n-                                if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n-                                    final BigDecimal userMoney = user.getMoney();\n-                                    user.updateMoneyCache(userMoney);\n-                                    totalMoney = totalMoney.add(userMoney);\n-                                    final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n-                                    balances.put(name, userMoney);\n-                                }\n-                            }\n-                        }\n+                        viewer.getSender().calculateBalanceTopMap(ess);\n                     }\n \n-                    final List<Map.Entry<String, BigDecimal>> sortedEntries = new ArrayList<>(balances.entrySet());\n-                    sortedEntries.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n-\n-                    cache.getLines().add(tl(\"serverTotal\", NumberUtil.displayCurrency(totalMoney, ess)));\n+                    cache.getLines().add(tl(\"serverTotal\", NumberUtil.displayCurrency(ess.getBalanceTop().getBalanceTopTotal(), ess)));\n                     int pos = 1;\n-                    for (final Map.Entry<String, BigDecimal> entry : sortedEntries) {\n+                    for (Map.Entry<String, BigDecimal> entry : ess.getBalanceTop().getBalanceTopCache()) {", "originalCommit": "4ecde5df6b5632b7575774c27efa7adce8484964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzOTc4MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r499939781", "bodyText": "conflict hell", "author": "JRoy", "createdAt": "2020-10-06T00:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxODQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzNTkwOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r499935909", "bodyText": "Should there be a linebreak before the @return here?", "author": "mbax", "createdAt": "2020-10-06T00:03:44Z", "path": "Essentials/src/com/earth2me/essentials/BalanceTop.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTop {\n+    private final transient IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();\n+    private transient BigDecimal balanceTopTotal = BigDecimal.ZERO;\n+\n+    public BalanceTop(IEssentials ess) {\n+        this.ess = ess;\n+        calculateBalanceTopMap();\n+    }\n+\n+    protected void calculateBalanceTopMap() {\n+        final Map<String, BigDecimal> map = new HashMap<>();\n+        for (UUID u : ess.getUserMap().getAllUniqueUsers()) {\n+            final User user = ess.getUserMap().getUser(u);\n+            if (user != null) {\n+                if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n+                    // Don't list NPCs in output\n+                    continue;\n+                }\n+                if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n+                    final BigDecimal userMoney = user.getMoney();\n+                    user.updateMoneyCache(userMoney);\n+                    balanceTopTotal = balanceTopTotal.add(userMoney);\n+                    final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n+                    map.put(name, userMoney);\n+                }\n+            }\n+        }\n+        topCache = new ArrayList<>(map.entrySet());\n+        topCache.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n+    }\n+\n+    /**\n+     * Returns a future which will be completed with the latest calculated balance top map.\n+     * @return A future with the latest balance top map.", "originalCommit": "4ecde5df6b5632b7575774c27efa7adce8484964", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "url": "https://github.com/EssentialsX/Essentials/commit/be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "message": "mbax.ogg", "committedDate": "2020-10-06T00:18:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ2OTMxOA==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r510469318", "bodyText": "IMO this should be private to BalanceTop, and not exposed to plugins or /balancetop - both should wait on the async method.", "author": "mdcfe", "createdAt": "2020-10-22T21:30:15Z", "path": "Essentials/src/com/earth2me/essentials/BalanceTop.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTop {\n+    private final transient IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();\n+    private transient BigDecimal balanceTopTotal = BigDecimal.ZERO;\n+\n+    public BalanceTop(IEssentials ess) {\n+        this.ess = ess;\n+        calculateBalanceTopMap();\n+    }\n+\n+    protected void calculateBalanceTopMap() {", "originalCommit": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MTU4OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r510471589", "bodyText": "Returning the results here makes it less clear to API callers what this does. I'd suggest that this method wraps calculateBalanceTopMap and returns a CompletableFuture<Void> that completes when done, then plugins can access the newly-updated cached baltop map from getBalanceTopCache.", "author": "mdcfe", "createdAt": "2020-10-22T21:34:45Z", "path": "Essentials/src/com/earth2me/essentials/BalanceTop.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTop {\n+    private final transient IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();\n+    private transient BigDecimal balanceTopTotal = BigDecimal.ZERO;\n+\n+    public BalanceTop(IEssentials ess) {\n+        this.ess = ess;\n+        calculateBalanceTopMap();\n+    }\n+\n+    protected void calculateBalanceTopMap() {\n+        final Map<String, BigDecimal> map = new HashMap<>();\n+        for (UUID u : ess.getUserMap().getAllUniqueUsers()) {\n+            final User user = ess.getUserMap().getUser(u);\n+            if (user != null) {\n+                if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n+                    // Don't list NPCs in output\n+                    continue;\n+                }\n+                if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n+                    final BigDecimal userMoney = user.getMoney();\n+                    user.updateMoneyCache(userMoney);\n+                    balanceTopTotal = balanceTopTotal.add(userMoney);\n+                    final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n+                    map.put(name, userMoney);\n+                }\n+            }\n+        }\n+        topCache = new ArrayList<>(map.entrySet());\n+        topCache.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n+    }\n+\n+    /**\n+     * Returns a future which will be completed with the latest calculated balance top map.\n+     *\n+     * @return A future with the latest balance top map.\n+     */\n+    public CompletableFuture<List<Map.Entry<String, BigDecimal>>> calculateBalanceTopMapAsync() {", "originalCommit": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MjE3NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r510472174", "bodyText": "Consider adding a timestamp that stores the last update time, so that plugins and /baltop can decide to update the cache based on when the last update occurred?", "author": "mdcfe", "createdAt": "2020-10-22T21:35:57Z", "path": "Essentials/src/com/earth2me/essentials/BalanceTop.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTop {\n+    private final transient IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();\n+    private transient BigDecimal balanceTopTotal = BigDecimal.ZERO;\n+\n+    public BalanceTop(IEssentials ess) {\n+        this.ess = ess;\n+        calculateBalanceTopMap();\n+    }\n+\n+    protected void calculateBalanceTopMap() {\n+        final Map<String, BigDecimal> map = new HashMap<>();\n+        for (UUID u : ess.getUserMap().getAllUniqueUsers()) {\n+            final User user = ess.getUserMap().getUser(u);\n+            if (user != null) {\n+                if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n+                    // Don't list NPCs in output\n+                    continue;\n+                }\n+                if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n+                    final BigDecimal userMoney = user.getMoney();\n+                    user.updateMoneyCache(userMoney);\n+                    balanceTopTotal = balanceTopTotal.add(userMoney);\n+                    final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n+                    map.put(name, userMoney);\n+                }\n+            }\n+        }\n+        topCache = new ArrayList<>(map.entrySet());\n+        topCache.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n+    }\n+\n+    /**\n+     * Returns a future which will be completed with the latest calculated balance top map.\n+     *\n+     * @return A future with the latest balance top map.\n+     */\n+    public CompletableFuture<List<Map.Entry<String, BigDecimal>>> calculateBalanceTopMapAsync() {\n+        final CompletableFuture<List<Map.Entry<String, BigDecimal>>> future = new CompletableFuture<>();\n+        ess.runTaskAsynchronously(() -> {\n+            final Map<String, BigDecimal> map = new HashMap<>();\n+            final List<Map.Entry<String, BigDecimal>> returned;\n+            for (UUID u : ess.getUserMap().getAllUniqueUsers()) {\n+                final User user = ess.getUserMap().getUser(u);\n+                if (user != null) {\n+                    if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n+                        // Don't list NPCs in output\n+                        continue;\n+                    }\n+                    if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n+                        final BigDecimal userMoney = user.getMoney();\n+                        user.updateMoneyCache(userMoney);\n+                        final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n+                        map.put(name, userMoney);\n+                    }\n+                }\n+            }\n+            returned = new ArrayList<>(map.entrySet());\n+            returned.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n+            future.complete(returned);\n+        });\n+        return future;\n+    }\n+\n+    /**\n+     * There is no guarantee the returned cache is up to date. The balancetop command is directly responsible for updating\n+     * this cache and does so every two minutes (if executed). See {@link BalanceTop#calculateBalanceTopMapAsync()} if\n+     * you need an up-to-date balance map.\n+     *\n+     * @see BalanceTop#calculateBalanceTopMapAsync()\n+     * @return The balance top cache.\n+     */\n+    public List<Map.Entry<String, BigDecimal>> getBalanceTopCache() {\n+        return Collections.unmodifiableList(topCache);\n+    }\n+\n+    public BigDecimal getBalanceTopTotal() {\n+        return balanceTopTotal;\n+    }", "originalCommit": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MjM2Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r510472363", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * Helper method to access protected method {@link BalanceTop#calculateBalanceTopMap()} due to its dangerous nature.\n          \n          \n            \n                 */\n          \n          \n            \n                public void calculateBalanceTopMap(IEssentials ess) {\n          \n          \n            \n                    ess.getBalanceTop().calculateBalanceTopMap();\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nThis is leaking way too far beyond where it should exist", "author": "mdcfe", "createdAt": "2020-10-22T21:36:18Z", "path": "Essentials/src/com/earth2me/essentials/CommandSource.java", "diffHunk": "@@ -53,4 +53,11 @@ public String getSelfSelector() {\n     public String getDisplayName() {\n         return sender instanceof Player ? getPlayer().getDisplayName() : getSender().getName();\n     }\n+\n+    /**\n+     * Helper method to access protected method {@link BalanceTop#calculateBalanceTopMap()} due to its dangerous nature.\n+     */\n+    public void calculateBalanceTopMap(IEssentials ess) {\n+        ess.getBalanceTop().calculateBalanceTopMap();\n+    }", "originalCommit": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MjU0OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r510472549", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            execTimer.mark(\"Init(Balancetop)\");\n          \n          \n            \n                            execTimer.mark(\"Init(BalanceTop)\");", "author": "mdcfe", "createdAt": "2020-10-22T21:36:41Z", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -232,6 +234,9 @@ public void onEnable() {\n                 confList.add(userMap);\n                 execTimer.mark(\"Init(Usermap)\");\n \n+                balanceTop = new BalanceTop(this);\n+                execTimer.mark(\"Init(Balancetop)\");", "originalCommit": "be83245f6cebb1a2a97cb58c106ba5a9d7df1c22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7aa1c37973a1ba54378a54f62b19f5302c7cf9c", "url": "https://github.com/EssentialsX/Essentials/commit/e7aa1c37973a1ba54378a54f62b19f5302c7cf9c", "message": "Review changes\n\nCommandbalancetop now just implements the BalanceTop API\nrather than being granted special permissions from it", "committedDate": "2020-10-24T19:41:59Z", "type": "commit"}, {"oid": "e2d3df3f7b59d0ca426ab379bfe5ed1881613009", "url": "https://github.com/EssentialsX/Essentials/commit/e2d3df3f7b59d0ca426ab379bfe5ed1881613009", "message": "Merge branch '2.x' into feature/improved-baltop-api", "committedDate": "2020-10-24T19:42:10Z", "type": "commit"}, {"oid": "b9ae34280ded7e4631b1c2a4653d75711e6d20ed", "url": "https://github.com/EssentialsX/Essentials/commit/b9ae34280ded7e4631b1c2a4653d75711e6d20ed", "message": "Merge branch '2.x' into feature/improved-baltop-api", "committedDate": "2020-11-25T21:02:13Z", "type": "commit"}, {"oid": "55bf91a4cd71f8524fc956e7e2b2c843046ab937", "url": "https://github.com/EssentialsX/Essentials/commit/55bf91a4cd71f8524fc956e7e2b2c843046ab937", "message": "Fix javadoc formatting", "committedDate": "2020-11-25T21:18:24Z", "type": "commit"}, {"oid": "aeeb7563de6cb7b0323b9412ea0bafbc33dd33e9", "url": "https://github.com/EssentialsX/Essentials/commit/aeeb7563de6cb7b0323b9412ea0bafbc33dd33e9", "message": "Refactor to new api package", "committedDate": "2020-12-02T21:04:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4Mjk2Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r534482966", "bodyText": "Best to return BalanceTop here so people using Essentials will import the API class rather than impl", "author": "mdcfe", "createdAt": "2020-12-02T21:09:34Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -947,6 +952,11 @@ public UserMap getUserMap() {\n         return userMap;\n     }\n \n+    @Override\n+    public BalanceTopImpl getBalanceTop() {", "originalCommit": "aeeb7563de6cb7b0323b9412ea0bafbc33dd33e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4MzI1Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r534483253", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *\n          \n          \n            \n             * <p>", "author": "mdcfe", "createdAt": "2020-12-02T21:10:08Z", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/BalanceTop.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package net.essentialsx.api.v2.services;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * A class which provides numerous methods to interact with Essentials' balance top calculations.\n+ *", "originalCommit": "aeeb7563de6cb7b0323b9412ea0bafbc33dd33e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ce7c89e4ab8eccf032935f4559ad8c75f1231c3", "url": "https://github.com/EssentialsX/Essentials/commit/3ce7c89e4ab8eccf032935f4559ad8c75f1231c3", "message": "We can't have nice things", "committedDate": "2020-12-02T21:15:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzM1Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536167353", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    //If there are less than 50 users in our usermap, there is no need to display a warning as these calculations should be done quickly\n          \n          \n            \n                    // If there are less than 50 users in our usermap, there is no need to display a warning as these calculations should be done quickly", "author": "Proximyst", "createdAt": "2020-12-04T15:10:14Z", "path": "Essentials/src/main/java/com/earth2me/essentials/commands/Commandbalancetop.java", "diffHunk": "@@ -54,25 +48,17 @@ protected void run(final Server server, final CommandSource sender, final String\n             }\n         }\n \n-        if (!force && lock.readLock().tryLock()) {\n-            try {\n-                if (cacheage > System.currentTimeMillis() - CACHETIME) {\n-                    outputCache(sender, page);\n-                    return;\n-                }\n-                if (ess.getUserMap().getUniqueUsers() > MINUSERS) {\n-                    sender.sendMessage(tl(\"orderBalances\", ess.getUserMap().getUniqueUsers()));\n-                }\n-            } finally {\n-                lock.readLock().unlock();\n-            }\n-        } else {\n-            if (ess.getUserMap().getUniqueUsers() > MINUSERS) {\n-                sender.sendMessage(tl(\"orderBalances\", ess.getUserMap().getUniqueUsers()));\n-            }\n+        if (!force && ess.getBalanceTop().getCacheAge() > System.currentTimeMillis() - CACHETIME) {\n+            outputCache(sender, page);\n+            return;\n+        }\n+\n+        //If there are less than 50 users in our usermap, there is no need to display a warning as these calculations should be done quickly", "originalCommit": "3ce7c89e4ab8eccf032935f4559ad8c75f1231c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzQ2NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536167464", "bodyText": "Guava anyone ?", "author": "Proximyst", "createdAt": "2020-12-04T15:10:24Z", "path": "Essentials/src/main/java/com/earth2me/essentials/BalanceTopImpl.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+import net.essentialsx.api.v2.services.BalanceTop;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTopImpl implements BalanceTop {\n+    private final IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();", "originalCommit": "3ce7c89e4ab8eccf032935f4559ad8c75f1231c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDExMw==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536170113", "bodyText": "absolutely not", "author": "TehBrian", "createdAt": "2020-12-04T15:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MTg1NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536181854", "bodyText": "don't need any of guava's cache features. the whole list is thrown out periodically anyway.", "author": "JRoy", "createdAt": "2020-12-04T15:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzQ2NA=="}], "type": "inlineReview"}, {"oid": "ff5c7d71a74c18092ece60aac1728476d1630a10", "url": "https://github.com/EssentialsX/Essentials/commit/ff5c7d71a74c18092ece60aac1728476d1630a10", "message": "Update Essentials/src/main/java/com/earth2me/essentials/commands/Commandbalancetop.java\n\nCo-authored-by: Mariell <proximyst@proximyst.com>", "committedDate": "2020-12-04T15:11:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MjQ0MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536172440", "bodyText": "shouldn't the type be the interface and not the impl?", "author": "TehBrian", "createdAt": "2020-12-04T15:17:11Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -125,6 +126,7 @@\n     private transient PermissionsHandler permissionsHandler;\n     private transient AlternativeCommandsHandler alternativeCommandsHandler;\n     private transient UserMap userMap;\n+    private transient BalanceTopImpl balanceTop;", "originalCommit": "ff5c7d71a74c18092ece60aac1728476d1630a10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3NjAzOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r536176039", "bodyText": "Essentials is an impli class itself so it doesn't really matter. I'll keep it in case we need to use any impli methods in the Ess class itself.", "author": "JRoy", "createdAt": "2020-12-04T15:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MjQ0MA=="}], "type": "inlineReview"}, {"oid": "96492a305c2c7638041cae4df2aa65ea90e83f1d", "url": "https://github.com/EssentialsX/Essentials/commit/96492a305c2c7638041cae4df2aa65ea90e83f1d", "message": "Register with service api", "committedDate": "2021-01-07T14:47:08Z", "type": "commit"}, {"oid": "800cc9882263f328ca23d4a06b1733361ecb49b0", "url": "https://github.com/EssentialsX/Essentials/commit/800cc9882263f328ca23d4a06b1733361ecb49b0", "message": "Merge branch '2.x' into feature/improved-baltop-api", "committedDate": "2021-01-07T14:49:17Z", "type": "commit"}, {"oid": "0fd75e78c03688b8f82da050bbb9f0c578486725", "url": "https://github.com/EssentialsX/Essentials/commit/0fd75e78c03688b8f82da050bbb9f0c578486725", "message": "Add fake service manager for tests", "committedDate": "2021-01-07T14:56:26Z", "type": "commit"}, {"oid": "91ebab3364da3825a06f7c0800a5dc39dd5ec0b1", "url": "https://github.com/EssentialsX/Essentials/commit/91ebab3364da3825a06f7c0800a5dc39dd5ec0b1", "message": "Cache baltop exempt state in userdata", "committedDate": "2021-01-11T16:08:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2MTYxNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r560061615", "bodyText": "LinkedHashMap is probably what we're after?", "author": "mdcfe", "createdAt": "2021-01-19T10:11:57Z", "path": "Essentials/src/main/java/com/earth2me/essentials/BalanceTopImpl.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.IEssentials;\n+import net.essentialsx.api.v2.services.BalanceTop;\n+import org.bukkit.plugin.ServicePriority;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class BalanceTopImpl implements BalanceTop {\n+    private final IEssentials ess;\n+    private List<Map.Entry<String, BigDecimal>> topCache = new ArrayList<>();", "originalCommit": "91ebab3364da3825a06f7c0800a5dc39dd5ec0b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2NDYyMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r560064622", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                List<Map.Entry<String, BigDecimal>> getBalanceTopCache();\n          \n          \n            \n                LinkedHashMap<String, BigDecimal> getBalanceTopCache();", "author": "mdcfe", "createdAt": "2021-01-19T10:16:31Z", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/BalanceTop.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package net.essentialsx.api.v2.services;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * A class which provides numerous methods to interact with Essentials' balance top calculations.\n+ * <p>\n+ * Note: Implementations of this class should be thread-safe and thus do not need to be called from the server thread.\n+ */\n+public interface BalanceTop extends EssentialsService {\n+\n+    /**\n+     * Re-calculates the balance top cache asynchronously.\n+     *\n+     * This method will return a {@link CompletableFuture CompletableFuture&lt;Void&gt;} which\n+     * will be completed upon the recalculation of the balance top map.\n+     * After which you should run {@link BalanceTop#getBalanceTopCache()}\n+     * to get the newly updated cache\n+     *\n+     * @return A future which completes after the balance top cache has been calculated.\n+     */\n+    CompletableFuture<Void> calculateBalanceTopMapAsync();\n+\n+    /**\n+     * Gets the balance top cache or an empty list if one has not been calculated yet. The balance top cache is a list\n+     * of {@link Map.Entry} objects which map a user's display name to their balance. The returned list is sorted by\n+     * greatest to least wealth.\n+     *\n+     * There is no guarantee the returned cache is up to date. The balancetop command is directly responsible for updating\n+     * this cache and does so every two minutes (if executed). See {@link BalanceTop#calculateBalanceTopMapAsync()} to\n+     * manually update this cache yourself.\n+     *\n+     * @see BalanceTop#calculateBalanceTopMapAsync()\n+     * @return The balance top cache.\n+     */\n+    List<Map.Entry<String, BigDecimal>> getBalanceTopCache();", "originalCommit": "91ebab3364da3825a06f7c0800a5dc39dd5ec0b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce45f11536e691797bec5908b3aef1dfad4f69d1", "url": "https://github.com/EssentialsX/Essentials/commit/ce45f11536e691797bec5908b3aef1dfad4f69d1", "message": "Merge branch '2.x' into feature/improved-baltop-api", "committedDate": "2021-01-19T16:27:38Z", "type": "commit"}, {"oid": "ce9b5e1a78875971a63664e2baa97d775c485298", "url": "https://github.com/EssentialsX/Essentials/commit/ce9b5e1a78875971a63664e2baa97d775c485298", "message": "Switch to a less cancer storage method", "committedDate": "2021-01-19T23:25:05Z", "type": "commit"}, {"oid": "3c64cf52a9eff6c7ac4419a5c919be4d1b80bd2d", "url": "https://github.com/EssentialsX/Essentials/commit/3c64cf52a9eff6c7ac4419a5c919be4d1b80bd2d", "message": "Merge branch '2.x' into feature/improved-baltop-api\n\n# Conflicts:\n#\tEssentials/src/main/java/net/essentialsx/api/v2/package-info.java\n#\tEssentials/src/main/java/net/essentialsx/api/v2/services/package-info.java", "committedDate": "2021-02-05T20:18:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE0MDAxMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3702#discussion_r576140012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        future.thenAccept(unused -> {\n          \n          \n            \n                        future.thenRun(() -> {", "author": "mdcfe", "createdAt": "2021-02-15T11:55:01Z", "path": "Essentials/src/main/java/com/earth2me/essentials/commands/Commandbalancetop.java", "diffHunk": "@@ -88,89 +75,42 @@ protected void run(final Server server, final CommandSource sender, final String\n         }\n     }\n \n-    private class Calculator implements Runnable {\n-        private final transient Viewer viewer;\n-        private final boolean force;\n-\n-        Calculator(final Viewer viewer, final boolean force) {\n-            this.viewer = viewer;\n-            this.force = force;\n-        }\n-\n-        @Override\n-        public void run() {\n-            lock.writeLock().lock();\n-            try {\n-                if (force || cacheage <= System.currentTimeMillis() - CACHETIME) {\n-                    cache.getLines().clear();\n-                    final Map<String, BigDecimal> balances = new HashMap<>();\n-                    BigDecimal totalMoney = BigDecimal.ZERO;\n-                    if (ess.getSettings().isEcoDisabled()) {\n-                        if (ess.getSettings().isDebug()) {\n-                            ess.getLogger().info(\"Internal economy functions disabled, aborting baltop.\");\n-                        }\n-                    } else {\n-                        for (final UUID u : ess.getUserMap().getAllUniqueUsers()) {\n-                            final User user = ess.getUserMap().getUser(u);\n-                            if (user != null) {\n-                                if (!ess.getSettings().isNpcsInBalanceRanking() && user.isNPC()) {\n-                                    // Don't list NPCs in output\n-                                    continue;\n-                                }\n-                                if (!user.isAuthorized(\"essentials.balancetop.exclude\")) {\n-                                    final BigDecimal userMoney = user.getMoney();\n-                                    user.updateMoneyCache(userMoney);\n-                                    totalMoney = totalMoney.add(userMoney);\n-                                    final String name = user.isHidden() ? user.getName() : user.getDisplayName();\n-                                    balances.put(name, userMoney);\n-                                }\n-                            }\n-                        }\n-                    }\n-\n-                    final List<Map.Entry<String, BigDecimal>> sortedEntries = new ArrayList<>(balances.entrySet());\n-                    sortedEntries.sort((entry1, entry2) -> entry2.getValue().compareTo(entry1.getValue()));\n-\n-                    cache.getLines().add(tl(\"serverTotal\", NumberUtil.displayCurrency(totalMoney, ess)));\n-                    int pos = 1;\n-                    for (final Map.Entry<String, BigDecimal> entry : sortedEntries) {\n-                        cache.getLines().add(tl(\"balanceTopLine\", pos, entry.getKey(), NumberUtil.displayCurrency(entry.getValue(), ess)));\n-                        pos++;\n-                    }\n-                    cacheage = System.currentTimeMillis();\n-                }\n-            } finally {\n-                lock.writeLock().unlock();\n-            }\n-            ess.runTaskAsynchronously(viewer);\n-        }\n-    }\n-\n     private class Viewer implements Runnable {\n         private final transient CommandSource sender;\n         private final transient int page;\n         private final transient boolean force;\n-        private final transient String commandLabel;\n \n-        Viewer(final CommandSource sender, final String commandLabel, final int page, final boolean force) {\n+        Viewer(final CommandSource sender, final int page, final boolean force) {\n             this.sender = sender;\n             this.page = page;\n             this.force = force;\n-            this.commandLabel = commandLabel;\n         }\n \n         @Override\n         public void run() {\n-            lock.readLock().lock();\n-            try {\n-                if (!force && cacheage > System.currentTimeMillis() - CACHETIME) {\n-                    outputCache(sender, page);\n-                    return;\n+            if (ess.getSettings().isEcoDisabled()) {\n+                if (ess.getSettings().isDebug()) {\n+                    ess.getLogger().info(\"Internal economy functions disabled, aborting baltop.\");\n                 }\n-            } finally {\n-                lock.readLock().unlock();\n+                return;\n             }\n-            ess.runTaskAsynchronously(new Calculator(new Viewer(sender, commandLabel, page, false), force));\n+\n+            final boolean fresh = force || ess.getBalanceTop().isCacheLocked() || ess.getBalanceTop().getCacheAge() <= System.currentTimeMillis() - CACHETIME;\n+            final CompletableFuture<Void> future = fresh ? ess.getBalanceTop().calculateBalanceTopMapAsync() : CompletableFuture.completedFuture(null);\n+            future.thenAccept(unused -> {", "originalCommit": "3c64cf52a9eff6c7ac4419a5c919be4d1b80bd2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb1397970005344a1b06ecc269bae37fd0fcc726", "url": "https://github.com/EssentialsX/Essentials/commit/bb1397970005344a1b06ecc269bae37fd0fcc726", "message": "Update Essentials/src/main/java/com/earth2me/essentials/commands/Commandbalancetop.java\n\nCo-authored-by: MD <1917406+mdcfe@users.noreply.github.com>", "committedDate": "2021-02-15T15:14:50Z", "type": "commit"}, {"oid": "93f2e94ed515ee3e8a75c64142b1acd5f72c22fb", "url": "https://github.com/EssentialsX/Essentials/commit/93f2e94ed515ee3e8a75c64142b1acd5f72c22fb", "message": "Merge branch '2.x' into feature/improved-baltop-api", "committedDate": "2021-02-15T15:15:06Z", "type": "commit"}]}