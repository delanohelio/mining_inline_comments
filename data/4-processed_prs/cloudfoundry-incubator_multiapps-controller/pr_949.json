{"pr_number": 949, "pr_title": "Use historic operations", "pr_createdAt": "2020-09-11T06:31:05Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949", "timeline": [{"oid": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "message": "Refactor actions", "committedDate": "2020-09-11T07:50:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0ODI0OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486848248", "bodyText": "The same can be achieved without the class variable with name().toLowerCase()", "author": "radito3", "createdAt": "2020-09-11T08:10:41Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/flowable/Action.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+\n+public enum Action {\n+\n+    ABORT(\"abort\"), RESUME(\"resume\"), RETRY(\"retry\"), START(\"start\");\n+\n+    private final String actionId;\n+\n+    private static final Map<String, Action> namesToActions = Stream.of(values())\n+                                                                    .collect(Collectors.toMap(Action::getActionId, Function.identity()));\n+\n+    Action(String actionId) {\n+        this.actionId = actionId;\n+    }\n+\n+    public String getActionId() {\n+        return actionId;", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkzMzc1MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486933750", "bodyText": "Fix order of methods", "author": "radito3", "createdAt": "2020-09-11T09:55:22Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/flowable/SetRetryPhaseAdditionalProcessAction.java", "diffHunk": "@@ -25,19 +25,22 @@ public void executeAdditionalProcessAction(String processInstanceId) {\n                       .map(this::toExecutionEntityImpl)\n                       .filter(executionEntityImpl -> executionEntityImpl.getDeadLetterJobCount() > 0)\n                       .map(ExecutionEntityImpl::getProcessInstanceId)\n-                      .forEach(executionProcessId -> flowableFacade.getProcessEngine()\n-                                                                   .getRuntimeService()\n-                                                                   .setVariable(executionProcessId, Variables.STEP_PHASE.getName(),\n-                                                                                StepPhase.RETRY.toString()));\n+                      .forEach(this::setRetryPhaseForProcess);\n     }\n \n-    private ExecutionEntityImpl toExecutionEntityImpl(Execution e) {\n-        return (ExecutionEntityImpl) e;\n+    private void setRetryPhaseForProcess(String executionProcessId) {\n+        flowableFacade.getProcessEngine()\n+                      .getRuntimeService()\n+                      .setVariable(executionProcessId, Variables.STEP_PHASE.getName(), StepPhase.RETRY.toString());\n+    }\n+\n+    private ExecutionEntityImpl toExecutionEntityImpl(Execution execution) {", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkzNjE1MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486936150", "bodyText": "Wouldn't it be better, now that Action is an enum, that this method takes an Action variable as its input parameter?", "author": "radito3", "createdAt": "2020-09-11T09:57:39Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/flowable/ProcessActionRegistry.java", "diffHunk": "@@ -17,9 +20,10 @@ public ProcessActionRegistry(List<ProcessAction> processActions) {\n \n     public ProcessAction getAction(String actionId) {", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk0NjY2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486946665", "bodyText": "If this is only used in ProcessStepHelper, I don't think we need this extra class.\nAnd, if it's only used to check about the ABORT_EXECUTED event type, I suggest changing this to\nhistoricEventService.createQuery().processId(...).type(ABORT_EXECUTED).list()\nand checking whether this list is empty.", "author": "radito3", "createdAt": "2020-09-11T10:08:11Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/util/HistoricOperationEventGetter.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.cloudfoundry.multiapps.controller.process.util;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.multiapps.controller.core.model.HistoricOperationEvent;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.HistoricOperationEventService;\n+\n+@Named\n+public class HistoricOperationEventGetter {\n+\n+    private final HistoricOperationEventService historicOperationEventService;\n+\n+    @Inject\n+    public HistoricOperationEventGetter(HistoricOperationEventService historicOperationEventService) {\n+        this.historicOperationEventService = historicOperationEventService;\n+    }\n+\n+    public List<HistoricOperationEvent> getHistoricOperationEventsByProcessId(String processId) {", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4ODMxOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486988318", "bodyText": "Used ProcessHelper instead of this class", "author": "IvanBorislavovDimitrov", "createdAt": "2020-09-11T11:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk0NjY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk0NzA4MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486947080", "bodyText": "This class already has 4 parameters, which is a bit much, and changing it to 5 isn't recommended.", "author": "radito3", "createdAt": "2020-09-11T10:09:11Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/SyncFlowableStep.java", "diffHunk": "@@ -188,7 +191,8 @@ protected ProcessStepHelper getStepHelper() {\n             stepHelper = new ProcessStepHelper(getProgressMessageService(),", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4OTg4Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486989883", "bodyText": "Used immutable instead", "author": "IvanBorislavovDimitrov", "createdAt": "2020-09-11T11:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk0NzA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk0OTE5Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486949193", "bodyText": "Change it to use the concrete processId, not just any string", "author": "radito3", "createdAt": "2020-09-11T10:13:27Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/AbortProcessActionTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import java.util.Collections;\n+\n+import org.cloudfoundry.multiapps.controller.api.model.Operation;\n+import org.cloudfoundry.multiapps.controller.core.model.HistoricOperationEvent;\n+import org.cloudfoundry.multiapps.controller.core.persistence.query.OperationQuery;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.OperationService;\n+import org.cloudfoundry.multiapps.controller.process.util.HistoricOperationEventPersister;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+\n+class AbortProcessActionTest extends ProcessActionTest {\n+\n+    @Mock\n+    private HistoricOperationEventPersister historicOperationEventPersister;\n+    @Mock\n+    private OperationService operationService;\n+\n+    @BeforeEach\n+    void setUp() {\n+        prepareOperationService();\n+    }\n+\n+    @Test\n+    void testAbortExecution() {\n+        processAction.execute(null, PROCESS_GUID);\n+        Mockito.verify(historicOperationEventPersister)\n+               .add(PROCESS_GUID, HistoricOperationEvent.EventType.ABORTED);\n+        Mockito.verify(historicOperationEventPersister)\n+               .add(PROCESS_GUID, HistoricOperationEvent.EventType.ABORT_EXECUTED);\n+    }\n+\n+    private void prepareOperationService() {\n+        OperationQuery mockedOperationQuery = Mockito.mock(OperationQuery.class);\n+        Mockito.when(mockedOperationQuery.processId(anyString()))", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MDMxMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486950311", "bodyText": "When having this many identical function calls, I suggest making a supplier of random uuids and calling its get() method", "author": "radito3", "createdAt": "2020-09-11T10:15:40Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/ProcessActionTest.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import org.cloudfoundry.multiapps.controller.core.cf.CloudControllerClientProvider;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.ProgressMessageService;\n+import org.flowable.engine.HistoryService;\n+import org.flowable.engine.ProcessEngine;\n+import org.flowable.engine.RuntimeService;\n+import org.flowable.engine.runtime.Execution;\n+import org.flowable.variable.api.history.HistoricVariableInstanceQuery;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+abstract class ProcessActionTest {\n+\n+    static final String EXECUTION_ID = UUID.randomUUID()\n+                                           .toString();", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MTQyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486951426", "bodyText": "This test is identical to testGetAbortProcessAction. Either change or remove it", "author": "radito3", "createdAt": "2020-09-11T10:17:50Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/ProcessActonRegistryTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class ProcessActonRegistryTest {\n+\n+    private ProcessActionRegistry processActionRegistry;\n+\n+    @BeforeEach\n+    void setUp() {\n+        processActionRegistry = new ProcessActionRegistry(getProcessActions());\n+    }\n+\n+    @Test\n+    void testGetStartProcessAction() {", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MTYyMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486951621", "bodyText": "These 3 tests are really similar, so I suggest making them one ParameterizedTest", "author": "radito3", "createdAt": "2020-09-11T10:18:16Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/ProcessActonRegistryTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class ProcessActonRegistryTest {\n+\n+    private ProcessActionRegistry processActionRegistry;\n+\n+    @BeforeEach\n+    void setUp() {\n+        processActionRegistry = new ProcessActionRegistry(getProcessActions());\n+    }\n+\n+    @Test\n+    void testGetStartProcessAction() {\n+        ProcessAction abortProcessAction = processActionRegistry.getAction(Action.ABORT.getActionId());\n+        assertEquals(Action.ABORT, abortProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetResumeProcessAction() {\n+        ProcessAction resumeProcessAction = processActionRegistry.getAction(Action.RESUME.getActionId());\n+        assertEquals(Action.RESUME, resumeProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetRetryProcessAction() {\n+        ProcessAction retryProcessAction = processActionRegistry.getAction(Action.RETRY.getActionId());\n+        assertEquals(Action.RETRY, retryProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetAbortProcessAction() {", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MjQyMA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486952420", "bodyText": "Why do you need these mock classes?\nIsn't is possible with Mockito.spy(StartProcessAction.class)?", "author": "radito3", "createdAt": "2020-09-11T10:19:49Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/ProcessActonRegistryTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class ProcessActonRegistryTest {\n+\n+    private ProcessActionRegistry processActionRegistry;\n+\n+    @BeforeEach\n+    void setUp() {\n+        processActionRegistry = new ProcessActionRegistry(getProcessActions());\n+    }\n+\n+    @Test\n+    void testGetStartProcessAction() {\n+        ProcessAction abortProcessAction = processActionRegistry.getAction(Action.ABORT.getActionId());\n+        assertEquals(Action.ABORT, abortProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetResumeProcessAction() {\n+        ProcessAction resumeProcessAction = processActionRegistry.getAction(Action.RESUME.getActionId());\n+        assertEquals(Action.RESUME, resumeProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetRetryProcessAction() {\n+        ProcessAction retryProcessAction = processActionRegistry.getAction(Action.RETRY.getActionId());\n+        assertEquals(Action.RETRY, retryProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetAbortProcessAction() {\n+        ProcessAction abortProcessAction = processActionRegistry.getAction(Action.ABORT.getActionId());\n+        assertEquals(Action.ABORT, abortProcessAction.getAction());\n+    }\n+\n+    @Test\n+    void testGetInvalidOperation() {\n+        Exception exception = assertThrows(IllegalStateException.class, () -> processActionRegistry.getAction(\"invalid\"));\n+        assertEquals(MessageFormat.format(Messages.UNSUPPORTED_ACTION, \"invalid\"), exception.getMessage());\n+    }\n+\n+    private List<ProcessAction> getProcessActions() {\n+        return List.of(new MockedStartProcessAction(), new MockedResumeProcessAction(), new MockedRetryProcessAction(),", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4ODgyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486988826", "bodyText": "Mockito.spy requires 0 arguments constructor", "author": "IvanBorislavovDimitrov", "createdAt": "2020-09-11T11:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1Mjg2OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486952868", "bodyText": "Why is the resume action called twice here?", "author": "radito3", "createdAt": "2020-09-11T10:20:35Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/ResumeProcessActionTest.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.Mockito.times;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.engine.runtime.Execution;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+class ResumeProcessActionTest extends ProcessActionTest {\n+\n+    @Test\n+    void testResumeExecutionWithExecutionsAtReceiveTask() {\n+        processAction.execute(\"fake-user\", PROCESS_GUID);\n+        Mockito.verify(flowableFacade, times(2))", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4ODk5NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486988995", "bodyText": "Because of the root process and one of the parent processes", "author": "IvanBorislavovDimitrov", "createdAt": "2020-09-11T11:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1Mjg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MzY2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486953665", "bodyText": "Same comment as before. Use Supplier", "author": "radito3", "createdAt": "2020-09-11T10:22:14Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/RetryProcessAdditionalActionTest.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import org.cloudfoundry.multiapps.controller.core.persistence.query.ProgressMessageQuery;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.ProgressMessageService;\n+import org.flowable.engine.runtime.Execution;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+class RetryProcessAdditionalActionTest {\n+\n+    private static final String PROCESS_GUID = UUID.randomUUID()", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1NDE0MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486954140", "bodyText": "We can use List.of(...) now that we have Java 11", "author": "radito3", "createdAt": "2020-09-11T10:23:18Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/RetryProcessAdditionalActionTest.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import org.cloudfoundry.multiapps.controller.core.persistence.query.ProgressMessageQuery;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.ProgressMessageService;\n+import org.flowable.engine.runtime.Execution;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+class RetryProcessAdditionalActionTest {\n+\n+    private static final String PROCESS_GUID = UUID.randomUUID()\n+                                                   .toString();\n+    private static final String EXECUTION_1_ACTIVITY_ID = UUID.randomUUID()\n+                                                              .toString();\n+    private static final String EXECUTION_2_ACTIVITY_ID = UUID.randomUUID()\n+                                                              .toString();\n+\n+    @Mock\n+    private FlowableFacade flowableFacade;\n+    @Mock\n+    private ProgressMessageService progressMessageService;\n+    @Mock\n+    private ProgressMessageQuery progressMessageQuery;\n+    @InjectMocks\n+    private RetryProcessAdditionalAction retryProcessAdditionalAction;\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MockitoAnnotations.openMocks(this)\n+                          .close();\n+        prepareFlowableFacade();\n+        prepareProgressMessageService();\n+        prepareProgressMessageQuery();\n+    }\n+\n+    @Test\n+    void testExecuteAdditionalAction() {\n+        retryProcessAdditionalAction.executeAdditionalProcessAction(PROCESS_GUID);\n+        Mockito.verify(progressMessageQuery, times(2))\n+               .delete();\n+    }\n+\n+    private void prepareFlowableFacade() {\n+        List<Execution> mockedExecutions = getMockedExecutions();\n+        Mockito.when(flowableFacade.getActiveProcessExecutions(PROCESS_GUID))\n+               .thenReturn(mockedExecutions);\n+    }\n+\n+    private List<Execution> getMockedExecutions() {\n+        Execution firstExecution = Mockito.mock(Execution.class);\n+        Mockito.when(firstExecution.getActivityId())\n+               .thenReturn(EXECUTION_1_ACTIVITY_ID);\n+        Execution secondExecution = Mockito.mock(Execution.class);\n+        Mockito.when(secondExecution.getActivityId())\n+               .thenReturn(EXECUTION_2_ACTIVITY_ID);\n+        return Arrays.asList(firstExecution, secondExecution);", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1NDQ2Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486954463", "bodyText": "Use Supplier", "author": "radito3", "createdAt": "2020-09-11T10:24:03Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/flowable/SetRetryPhaseAdditionalProcessActionTest.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.cloudfoundry.multiapps.controller.process.flowable;\n+\n+import static org.mockito.Mockito.never;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import org.cloudfoundry.multiapps.controller.process.steps.StepPhase;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.engine.ProcessEngine;\n+import org.flowable.engine.RuntimeService;\n+import org.flowable.engine.impl.persistence.entity.ExecutionEntityImpl;\n+import org.flowable.engine.runtime.Execution;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+class SetRetryPhaseAdditionalProcessActionTest {\n+\n+    private static final String PROCESS_GUID = UUID.randomUUID()", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1NzMyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/949#discussion_r486957326", "bodyText": "Extract in method", "author": "radito3", "createdAt": "2020-09-11T10:30:00Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/ProcessStepHelperTest.java", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.multiapps.common.ContentException;\n+import org.cloudfoundry.multiapps.common.SLException;\n+import org.cloudfoundry.multiapps.controller.core.model.ErrorType;\n+import org.cloudfoundry.multiapps.controller.core.model.HistoricOperationEvent;\n+import org.cloudfoundry.multiapps.controller.core.model.ImmutableHistoricOperationEvent;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.ProgressMessageService;\n+import org.cloudfoundry.multiapps.controller.persistence.services.ProcessLogger;\n+import org.cloudfoundry.multiapps.controller.persistence.services.ProcessLogsPersister;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.util.HistoricOperationEventGetter;\n+import org.cloudfoundry.multiapps.controller.process.util.StepLogger;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.bpmn.model.FlowElement;\n+import org.flowable.bpmn.model.SubProcess;\n+import org.flowable.engine.ProcessEngineConfiguration;\n+import org.flowable.engine.RuntimeService;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.flowable.engine.runtime.Execution;\n+import org.flowable.engine.runtime.ExecutionQuery;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+class ProcessStepHelperTest {\n+\n+    private static final String CORRELATION_GUID = UUID.randomUUID()\n+                                                       .toString();\n+    private static final String TASK_GUID = UUID.randomUUID()\n+                                                .toString();\n+\n+    @Mock\n+    private ProgressMessageService progressMessageService;\n+    @Mock\n+    private ProcessLogsPersister processLogsPersister;\n+    @Mock\n+    private StepLogger stepLogger;\n+    @Mock\n+    private ProcessEngineConfiguration processEngineConfiguration;\n+    @Mock\n+    private HistoricOperationEventGetter historicOperationEventGetter;\n+    @Mock\n+    private ProcessContext context;\n+    @Mock\n+    private DelegateExecution execution;\n+    private ProcessStepHelper processStepHelper;\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MockitoAnnotations.openMocks(this)\n+                          .close();\n+        prepareStepLogger();\n+        prepareContext();\n+        processStepHelper = new ProcessStepHelper(progressMessageService,\n+                                                  stepLogger,\n+                                                  processLogsPersister,\n+                                                  processEngineConfiguration,\n+                                                  historicOperationEventGetter);\n+    }\n+\n+    @Test\n+    void testPostExecutionStep() {\n+        Mockito.when(context.getVariable(Variables.TASK_ID))\n+               .thenReturn(TASK_GUID);\n+        FlowElement flowElement = Mockito.mock(SubProcess.class);\n+        Mockito.when(execution.getCurrentFlowElement())\n+               .thenReturn(flowElement);\n+\n+        processStepHelper.postExecuteStep(context, StepPhase.DONE);\n+        Mockito.verify(processLogsPersister)\n+               .persistLogs(CORRELATION_GUID, TASK_GUID);\n+        Mockito.verify(context)\n+               .setVariable(Variables.STEP_EXECUTION, StepPhase.DONE.toString());\n+    }\n+\n+    @Test\n+    void testPreExecuteStepWithoutError() {\n+        Mockito.when(execution.getCurrentActivityId())\n+               .thenReturn(\"activityId\");\n+        processStepHelper.preExecuteStep(context, StepPhase.EXECUTE);\n+        Mockito.verify(context)\n+               .setVariable(Variables.TASK_ID, \"activityId\");\n+        Mockito.verify(context)\n+               .setVariable(Variables.STEP_PHASE, StepPhase.EXECUTE);\n+    }\n+\n+    @Test\n+    void testPreExecuteStepWithError() {\n+        Mockito.when(execution.getCurrentActivityId())\n+               .thenReturn(\"activityId\");\n+        Mockito.when(context.getVariable(Variables.ERROR_TYPE))\n+               .thenReturn(ErrorType.CONTENT_ERROR);\n+        processStepHelper.preExecuteStep(context, StepPhase.DONE);\n+        Mockito.verify(context)\n+               .setVariable(Variables.TASK_ID, \"activityId\");\n+        Mockito.verify(context)\n+               .setVariable(Variables.STEP_PHASE, StepPhase.DONE);\n+        Mockito.verify(context)\n+               .removeVariable(Variables.ERROR_TYPE);\n+    }\n+\n+    @Test\n+    void testLogExceptionAndStoreExceptionContentError() {\n+        prepareProgressMessagesService();\n+        processStepHelper.logExceptionAndStoreProgressMessage(context, new ContentException(\"content exception\"));\n+        Mockito.verify(context)\n+               .setVariable(Variables.ERROR_TYPE, ErrorType.CONTENT_ERROR);\n+        Mockito.verify(progressMessageService)\n+               .add(any());\n+    }\n+\n+    @Test\n+    void testLogExceptionAndStoreExceptionUnknownError() {\n+        prepareProgressMessagesService();\n+        processStepHelper.logExceptionAndStoreProgressMessage(context, new RuntimeException(\"runtime exception\"));\n+        Mockito.verify(context)\n+               .setVariable(Variables.ERROR_TYPE, ErrorType.UNKNOWN_ERROR);\n+        Mockito.verify(progressMessageService)\n+               .add(any());\n+    }\n+\n+    @Test\n+    void testFailStepPhaseAbortIsInvoked() {\n+        prepareHistoricOperationsEventGetter(HistoricOperationEvent.EventType.STARTED, HistoricOperationEvent.EventType.FINISHED,\n+                                             HistoricOperationEvent.EventType.ABORT_EXECUTED);\n+        Exception exception = Assertions.assertThrows(SLException.class, () -> processStepHelper.failStepIfProcessIsAborted(context));\n+        Assertions.assertEquals(Messages.PROCESS_WAS_ABORTED, exception.getMessage());\n+    }\n+\n+    @Test\n+    void testFailedStepPhaseAbortIsNotInvoked() {\n+        prepareHistoricOperationsEventGetter(HistoricOperationEvent.EventType.STARTED, HistoricOperationEvent.EventType.FINISHED);\n+        Assertions.assertDoesNotThrow(() -> processStepHelper.failStepIfProcessIsAborted(context));\n+    }\n+\n+    private void prepareStepLogger() {\n+        ProcessLogger processLogger = Mockito.mock(ProcessLogger.class);\n+        Mockito.when(stepLogger.getProcessLogger())\n+               .thenReturn(processLogger);\n+    }\n+\n+    private void prepareContext() {\n+        Mockito.when(context.getVariable(Variables.CORRELATION_ID))\n+               .thenReturn(CORRELATION_GUID);\n+        Mockito.when(context.getExecution())\n+               .thenReturn(execution);\n+    }\n+\n+    private void prepareProgressMessagesService() {\n+        RuntimeService runtimeService = Mockito.mock(RuntimeService.class);\n+        ExecutionQuery executionQuery = Mockito.mock(ExecutionQuery.class);\n+        Mockito.when(processEngineConfiguration.getRuntimeService())\n+               .thenReturn(runtimeService);\n+        Mockito.when(runtimeService.createExecutionQuery())\n+               .thenReturn(executionQuery);\n+        Mockito.when(executionQuery.processInstanceId(any()))\n+               .thenReturn(executionQuery);\n+        List<Execution> mockedExecutions = getMockedExecutions();\n+        Mockito.when(executionQuery.list())\n+               .thenReturn(mockedExecutions);\n+    }\n+\n+    private List<Execution> getMockedExecutions() {\n+        Execution execution = Mockito.mock(Execution.class);\n+        Mockito.when(execution.getActivityId())\n+               .thenReturn(\"activityId\");\n+        return Collections.singletonList(execution);\n+    }\n+\n+    private void prepareHistoricOperationsEventGetter(HistoricOperationEvent.EventType... eventTypes) {\n+        List<HistoricOperationEvent> historicOperationEvents = mapEventTypesToHistoricEvents(eventTypes);\n+        Mockito.when(historicOperationEventGetter.getHistoricOperationEventsByProcessId(CORRELATION_GUID))\n+               .thenReturn(historicOperationEvents);\n+    }\n+\n+    private List<HistoricOperationEvent> mapEventTypesToHistoricEvents(HistoricOperationEvent.EventType... eventTypes) {\n+        return Arrays.stream(eventTypes)\n+                     .map(eventType -> ImmutableHistoricOperationEvent.builder()", "originalCommit": "4a3eb1cf6d4717fd4df55af981b83d68f4a303c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b010ddaaadf5752f4adb9599ed3e8e610f243130", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/b010ddaaadf5752f4adb9599ed3e8e610f243130", "message": "Use historic operation table to abort a process", "committedDate": "2020-09-11T11:35:59Z", "type": "commit"}, {"oid": "d396ace06a65d08d759f5a839096b3594fe4941d", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d396ace06a65d08d759f5a839096b3594fe4941d", "message": "Refactor actions", "committedDate": "2020-09-11T11:36:02Z", "type": "forcePushed"}, {"oid": "576169e11c087658d04926ff446b72a566790ac3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/576169e11c087658d04926ff446b72a566790ac3", "message": "Refactor actions", "committedDate": "2020-09-14T13:00:01Z", "type": "commit"}, {"oid": "576169e11c087658d04926ff446b72a566790ac3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/576169e11c087658d04926ff446b72a566790ac3", "message": "Refactor actions", "committedDate": "2020-09-14T13:00:01Z", "type": "forcePushed"}]}