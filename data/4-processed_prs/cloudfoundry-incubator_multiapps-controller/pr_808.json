{"pr_number": 808, "pr_title": "Refactor ServiceCreator to call cf client", "pr_createdAt": "2020-03-17T09:11:08Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NTI1Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393585256", "bodyText": "Please make sure that this request covers all the Request parameters + calls the correct URL(accepts_incomplete query parameter).", "author": "enchobelezirev", "createdAt": "2020-03-17T10:39:12Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/clients/ServiceCreator.java", "diffHunk": "@@ -36,36 +29,15 @@ ServiceCreator withErrorHandlerSupplier(Supplier<CustomControllerClientErrorHand\n         return this;\n     }\n \n-    public MethodExecution<String> createService(CloudControllerClient client, CloudServiceExtended service, String spaceId) {\n+    public MethodExecution<String> createService(CloudControllerClient client, CloudServiceExtended service) {\n         return errorHandlerSupplier.get()\n-                                   .handleErrorsOrReturnResult(() -> attemptToCreateService(client, service, spaceId));\n+                                   .handleErrorsOrReturnResult(() -> attemptToCreateService(client, service));\n     }\n \n-    private MethodExecution<String> attemptToCreateService(CloudControllerClient client, CloudServiceExtended service, String spaceId) {\n+    private MethodExecution<String> attemptToCreateService(CloudControllerClient client, CloudServiceExtended service) {\n         assertServiceAttributes(service);\n-\n-        RestTemplate restTemplate = getRestTemplate(client);\n-        String cloudControllerUrl = client.getCloudControllerUrl()\n-                                          .toString();\n-        CloudServicePlan cloudServicePlan = findPlanForService(client, service);\n-\n-        Map<String, Object> serviceRequest = createServiceRequest(service, spaceId, cloudServicePlan);\n-        String url = getUrl(cloudControllerUrl, CREATE_SERVICE_URL_ACCEPTS_INCOMPLETE_TRUE);\n-        HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(serviceRequest);\n-        ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, requestEntity, String.class);\n-        return MethodExecution.fromResponseEntity(response);\n-    }\n-\n-    private Map<String, Object> createServiceRequest(CloudServiceExtended service, String spaceId, CloudServicePlan cloudServicePlan) {\n-        Map<String, Object> serviceRequest = new HashMap<>();\n-        serviceRequest.put(SPACE_GUID, spaceId);\n-        serviceRequest.put(SERVICE_NAME, service.getName());\n-        serviceRequest.put(SERVICE_PLAN_GUID, cloudServicePlan.getMetadata()\n-                                                              .getGuid()\n-                                                              .toString());\n-        serviceRequest.put(SERVICE_PARAMETERS, service.getCredentials());\n-        serviceRequest.put(SERVICE_TAGS, service.getTags());\n-        return serviceRequest;\n+        client.createService(service);", "originalCommit": "a2c46a3123fff94eb58550a6d900b89de4ebbe63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NTkzOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393585939", "bodyText": "If you are sure that this call is enough and is doing all the necessarry putting of request parameters, remove the class and replace every usage of ServiceCreator with client.createService(service);", "author": "enchobelezirev", "createdAt": "2020-03-17T10:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NzMyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393587326", "bodyText": "Why reset? Isn't the new Mocked object be enough here?\nIf no, please refactor the test in order to be.\nFurther reading: https://softwareengineering.stackexchange.com/questions/188299/is-this-an-appropriate-use-of-mockitos-reset-method", "author": "enchobelezirev", "createdAt": "2020-03-17T10:42:56Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/cf/clients/CloudServiceOperatorTest.java", "diffHunk": "@@ -49,15 +46,13 @@ private void prepareRestTemplateFactory() {\n \n     private void prepareClient() throws IOException {\n         URL controllerUrl = new URL(CONTROLLER_URL);\n+        Mockito.reset(client);", "originalCommit": "a2c46a3123fff94eb58550a6d900b89de4ebbe63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NzY3MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393587671", "bodyText": "What about the detailed message? Is it gone and how the 401 Unauthorized is replacing it?", "author": "enchobelezirev", "createdAt": "2020-03-17T10:43:33Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/cf/clients/ServiceWithAlternativesCreatorTest.java", "diffHunk": "@@ -48,62 +38,44 @@\n                 Arguments.of(\"service-03.json\", \"Service label must not be null\", IllegalArgumentException.class),\n                 Arguments.of(\"service-04.json\", \"Service name must not be null\", IllegalArgumentException.class),\n                 Arguments.of(\"service-05.json\", \"Service plan must not be null\", IllegalArgumentException.class),\n-                Arguments.of(\"service-06.json\", \"Could not create service instance \\\"foo\\\". Service plan \\\"v3.4-extra-large\\\" from service offering \\\"mongodb\\\" was not found.\", CloudOperationException.class),\n-                Arguments.of(\"service-07.json\", \"Could not create service instance \\\"foo\\\". Service plan \\\"v2.0-sp3\\\" from service offering \\\"hana\\\" was not found.\", CloudOperationException.class),\n+                Arguments.of(\"service-06.json\", \"401 Unauthorized\", CloudOperationException.class),", "originalCommit": "a2c46a3123fff94eb58550a6d900b89de4ebbe63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5Mjc0NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393592745", "bodyText": "It is a totally different test, in fact test case 16 and 17 are in place 06 and 07. Test cases 06 and 07 are removed because they are not applicable any more. The logic, which they tested is in CloudControllerClient implementation.", "author": "radoslav-d", "createdAt": "2020-03-17T10:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NzY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYyOTg3Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393629876", "bodyText": "Okay", "author": "enchobelezirev", "createdAt": "2020-03-17T12:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4NzY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4ODQwNw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/808#discussion_r393588407", "bodyText": "In testing the appropiate words for inputs are \"actual\" and \"expected\".\nSo, maybe you culd use actualService ?", "author": "enchobelezirev", "createdAt": "2020-03-17T10:44:58Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/resources/com/sap/cloud/lm/sl/cf/core/cf/clients/service-01.json", "diffHunk": "@@ -1,5 +1,5 @@\n {\n-  \"service\": {\n+  \"initialService\": {", "originalCommit": "a2c46a3123fff94eb58550a6d900b89de4ebbe63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "206c84cec7b994e62b7f479fa96da305f72b8146", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/206c84cec7b994e62b7f479fa96da305f72b8146", "message": "Refactor ServiceCreator to call cf client\n\nReplace the programmatic filtering of services and the plain http rest\ncall for creating a service with a call to the CloudControllerClient.\nThis will remove duplicated logic and code, which already lives in\ncf-java-client. JIRA: LMCROSSITXSADEPLOY-1516", "committedDate": "2020-03-17T11:22:46Z", "type": "commit"}, {"oid": "206c84cec7b994e62b7f479fa96da305f72b8146", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/206c84cec7b994e62b7f479fa96da305f72b8146", "message": "Refactor ServiceCreator to call cf client\n\nReplace the programmatic filtering of services and the plain http rest\ncall for creating a service with a call to the CloudControllerClient.\nThis will remove duplicated logic and code, which already lives in\ncf-java-client. JIRA: LMCROSSITXSADEPLOY-1516", "committedDate": "2020-03-17T11:22:46Z", "type": "forcePushed"}, {"oid": "2dd133aedf6a52721134c73bb28c81c5f17cac6c", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/2dd133aedf6a52721134c73bb28c81c5f17cac6c", "message": "Adopt CF Java client 1.21.3\n\nJIRA: LMCROSSITXSADEPLOY-1516", "committedDate": "2020-03-17T12:44:37Z", "type": "commit"}]}