{"pr_number": 954, "pr_title": "Make parallel bind/unbind of services", "pr_createdAt": "2020-09-18T14:38:57Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954", "timeline": [{"oid": "acd457990f9bf51ee2ca18682c4dd11ebaa227cb", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/acd457990f9bf51ee2ca18682c4dd11ebaa227cb", "message": "Make parallel bind/unbind of services\n\nJIRA:LMCROSSITXSADEPLOY-1867", "committedDate": "2020-09-18T14:49:26Z", "type": "forcePushed"}, {"oid": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "message": "Fix setting of call activity variable in parent process", "committedDate": "2020-09-30T14:44:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwOTEyOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498809128", "bodyText": "Make this variable final", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T13:07:04Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -51,15 +52,25 @@\n import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n import org.cloudfoundry.multiapps.mta.handlers.ArchiveHandler;\n import org.cloudfoundry.multiapps.mta.util.NameUtil;\n+import org.flowable.engine.ProcessEngine;\n import org.springframework.beans.factory.config.BeanDefinition;\n import org.springframework.context.annotation.Scope;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+\n @Named(\"createOrUpdateAppStep\")\n @Scope(BeanDefinition.SCOPE_PROTOTYPE)\n public class CreateOrUpdateAppStep extends SyncFlowableStep {\n \n     protected BooleanSupplier shouldPrettyPrint = () -> true;\n \n+    private ProcessEngine processEngine;", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxNzIwMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498817201", "bodyText": "Instead of getting this JsonNode and checking if it's null, can we move getBindUnbindServicesCallActivity(context) in a method and check if it is null and the to use this method in this if statement: if (bindUnbindServicesCallActivity != null), something like \"shouldUseNewHandlers(...)\", it will be more readable. I guess this is only for a temporary backwards compatibility?", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T13:21:48Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -90,10 +101,27 @@ protected String getStepErrorMessage(ProcessContext context) {\n \n     private StepFlowHandler createStepFlowHandler(ProcessContext context, CloudControllerClient client, CloudApplicationExtended app,\n                                                   CloudApplication existingApp) {\n+        JsonNode bindUnbindServicesCallActivity = getBindUnbindServicesCallActivity(context);\n+        if (bindUnbindServicesCallActivity != null) {", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ5NDY3Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499494676", "bodyText": "Yes, it will be used for temporary backwards compatability.", "author": "theghost5800", "createdAt": "2020-10-05T10:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxNzIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyODYyMg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498828622", "bodyText": "Really nice, but can we move this stream in a separate method?", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T13:41:18Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -242,16 +353,11 @@ public void handleApplicationServices() throws FileStorageException {\n             if (context.getVariable(Variables.SHOULD_SKIP_SERVICE_REBINDING)) {\n                 return;\n             }\n-\n-            List<String> services = app.getServices();\n-            boolean hasUnboundServices = unbindServicesIfNeeded(app, existingApp, client, services);\n-\n-            Map<String, Map<String, Object>> bindingParameters = getBindingParameters(context, app);\n-\n-            boolean hasUpdatedServices = updateServices(context, app.getName(), bindingParameters, client,\n-                                                        calculateServicesForUpdate(app, existingApp.getServices()));\n-\n-            context.setVariable(Variables.VCAP_SERVICES_PROPERTIES_CHANGED, hasUnboundServices || hasUpdatedServices);\n+            List<String> services = Stream.of(app.getServices(), existingApp.getServices())", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0MjIzNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498842235", "bodyText": "services.stream() .map(service -> BindUnbindServiceEndListener.buildExportedVariableName(app.getName(), service)) .map(variableName -> StepsUtil.getObject(context.getExecution(), variableName)) .filter(Boolean.class::isInstance) .anyMatch(Boolean.class::cast);", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T14:04:01Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/DetermineVcapServicesPropertiesChangedStep.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.listeners.BindUnbindServiceEndListener;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"determineVcapServicesPropertiesChangedStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetermineVcapServicesPropertiesChangedStep extends SyncFlowableStep {\n+\n+    @Override\n+    protected StepPhase executeStep(ProcessContext context) {\n+        List<String> services = context.getVariable(Variables.SERVICES_TO_UNBIND_BIND);\n+        CloudApplicationExtended app = context.getVariable(Variables.APP_TO_PROCESS);\n+\n+        boolean changedVcapServicesProperties = services.stream()\n+                                                        .map(service -> BindUnbindServiceEndListener.buildExportedVariableName(app.getName(),\n+                                                                                                                               service))\n+                                                        .map(variableName -> StepsUtil.getObject(context.getExecution(), variableName))", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0Mjk4NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498842985", "bodyText": "Can be simplified a bit.\nIs this filter needed: filter(Boolean.class::isInstance). It should always be boolean?\nCan you extract it in a separate method?", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T14:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0MjIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0OTczMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498849731", "bodyText": "Use UUID.randomUUID()", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T14:16:46Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/util/ServiceBindingParametersGetterTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package org.cloudfoundry.multiapps.controller.process.util;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Stream;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.CloudOperationException;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudServiceBinding;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudMetadata;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudServiceBinding;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.ImmutableCloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.ImmutableCloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.core.helpers.MtaArchiveElements;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileService;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileStorageException;\n+import org.cloudfoundry.multiapps.controller.process.steps.ProcessContext;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+import org.springframework.http.HttpStatus;\n+\n+class ServiceBindingParametersGetterTest {\n+\n+    private static final String APP_NAME = \"test_application\";\n+    private static final String SERVICE_NAME = \"test_service\";\n+    private static final String APP_ARCHIVE_ID = \"test_archive_id\";\n+    private static final String SERVICE_BINDING_PARAMETERS_FILENAME = \"test_binding_parameters.json\";\n+    private static final UUID RANDOM_GUID = UUID.fromString(\"9f274e3f-e086-426d-8ab7-e16bda2485ae\");", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyMzg0NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499523844", "bodyText": "This UUID was generated from this site because previously frequent random generation of UUIDs lead to performance degradation in unit tests but as I can see now, there is now issue with performance, so I will change it.", "author": "theghost5800", "createdAt": "2020-10-05T11:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg0OTczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1MTQwNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r498851406", "bodyText": "openMocks().close", "author": "IvanBorislavovDimitrov", "createdAt": "2020-10-02T14:19:33Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/listeners/BindUnbindServiceEndListenerTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package org.cloudfoundry.multiapps.controller.process.listeners;\n+\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.stream.Stream;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudApplication;\n+import org.cloudfoundry.multiapps.common.util.JsonUtil;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.engine.RuntimeService;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.flowable.engine.runtime.Execution;\n+import org.flowable.engine.runtime.ExecutionQuery;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+class BindUnbindServiceEndListenerTest {\n+\n+    private static final String APPLICATION_NAME = \"test_application\";\n+    private static final String SERVICE_NAME = \"test_service\";\n+    private static final String PARENT_EXECUTION_ID = \"1234\";\n+\n+    @Mock\n+    private DelegateExecution execution;\n+    @Mock\n+    private RuntimeService runtimeService;\n+    @Mock\n+    private ExecutionQuery executionQuery;\n+    @Mock\n+    private Execution parentExecution;\n+\n+    private BindUnbindServiceEndListener bindUnbindServiceEndListener;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.openMocks(this);", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NTgwNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499375805", "bodyText": "It should be in reverse wording:\nError while binding service\"{0}\" to application \"{1}\"", "author": "boyan-velinov", "createdAt": "2020-10-05T06:51:06Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/Messages.java", "diffHunk": "@@ -142,6 +142,10 @@\n     public static final String ERROR_DELETING_OPERATION_WITH_ID = \"Error deleting operation with ID \\\"{0}\\\"\";\n     public static final String ERROR_DELETING_FLOWABLE_PROCESS_WITH_ID = \"Error deleting Flowable process with ID \\\"{0}\\\"\";\n     public static final String ERROR_MISSING_DEFAULT_DOMAIN = \"Missing default domain in current org\";\n+    public static final String ERROR_WHILE_DETERMINE_BIND_UNBIND_OEPRATIONS_OF_APPLICATION_TO_SERVICE = \"Error while determine bind/unbind operations of application \\\"{0}\\\" to service \\\"{1}\\\"\";\n+    public static final String ERROR_WHILE_UNBINDING_SERVICE_FROM_APPLICATION = \"Error while unbinding service \\\"{0}\\\" from application \\\"{1}\\\"\";\n+    public static final String ERROR_WHILE_BINDING_APPLICATION_TO_SERVICE = \"Error while binding application \\\"{0}\\\" to service \\\"{1}\\\"\";", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2MjUyOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499562529", "bodyText": "I have used the same order from this message COULD_NOT_BIND_APP_TO_SERVICE", "author": "theghost5800", "createdAt": "2020-10-05T12:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NTgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU3MjA0OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499572048", "bodyText": "Yes, we often tell is in this way \ud83d\ude04\nBut it is not correct comparing with CF documentation:\nhttps://docs.cloudfoundry.org/devguide/services/managing-services.html#app-binding", "author": "boyan-velinov", "createdAt": "2020-10-05T12:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NTgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NzE1Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499377156", "bodyText": "Can you extract this in separate new super class that this and other listeners to reuse?", "author": "boyan-velinov", "createdAt": "2020-10-05T06:54:34Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/listeners/BindUnbindServiceEndListener.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package org.cloudfoundry.multiapps.controller.process.listeners;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.process.Constants;\n+import org.cloudfoundry.multiapps.controller.process.variables.VariableHandling;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.engine.RuntimeService;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.flowable.engine.delegate.ExecutionListener;\n+import org.flowable.engine.impl.context.Context;\n+import org.flowable.engine.runtime.Execution;\n+\n+@Named(\"bindUnbindServiceEndListener\")\n+public class BindUnbindServiceEndListener implements ExecutionListener {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    @Override\n+    public void notify(DelegateExecution execution) {\n+        RuntimeService runtimeService = getRuntimeService();\n+\n+        CloudApplicationExtended app = VariableHandling.get(execution, Variables.APP_TO_PROCESS);\n+        String service = VariableHandling.get(execution, Variables.SERVICE_TO_UNBIND_BIND);\n+        boolean shouldUnbindService = VariableHandling.get(execution, Variables.SHOULD_UNBIND_SERVICE);\n+        boolean shouldBindService = VariableHandling.get(execution, Variables.SHOULD_BIND_SERVICE);\n+\n+        String superExecutionId = execution.getParentId();\n+        Execution superExecutionResult = runtimeService.createExecutionQuery()\n+                                                       .executionId(superExecutionId)\n+                                                       .singleResult();\n+        superExecutionId = superExecutionResult.getSuperExecutionId();\n+        String exportedVariableName = buildExportedVariableName(app.getName(), service);\n+\n+        runtimeService.setVariable(superExecutionId, exportedVariableName, shouldUnbindService || shouldBindService);", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2ODg1NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499568855", "bodyText": "What do you think could be reused? Maybe getting id of parent process.", "author": "theghost5800", "createdAt": "2020-10-05T12:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NzE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU3MTA3Nw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499571077", "bodyText": "Yes, or event setting up variable in root context", "author": "boyan-velinov", "createdAt": "2020-10-05T12:46:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NzE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NzY1OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499377658", "bodyText": "Replact Vcap services with VCAP_SERVICES", "author": "boyan-velinov", "createdAt": "2020-10-05T06:55:49Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/Messages.java", "diffHunk": "@@ -538,6 +542,8 @@\n     public static final String VERIFYING_APPLICATION_0_EXISTS = \"Verifying application: \\\"{0}\\\" exists\";\n     public static final String TIME_STATISTICS_FOR_PROCESS_0_OPERATION_1_DURATION_2_DELAY_3 = \"Time statistics for process \\\"{0}\\\" (part of operation \\\"{1}\\\"): duration \\\"{2}\\\" ms; delay between steps \\\"{3}\\\" ms\";\n     public static final String TIME_STATISTICS_FOR_OPERATION_0_DURATION_1_DELAY_2 = \"Time statistics for operation \\\"{0}\\\": duration \\\"{1}\\\" ms; delay between steps \\\"{2}\\\" ms\";\n+    public static final String DETERMINE_BIND_UNBIND_OPERATIONS_APPLICATION_0_SERVICE_1 = \"Determine bind/unbind operations of application \\\"{0}\\\" to service \\\"{1}\\\"\";\n+    public static final String VCAP_SERVICES_PROPERTIES_FOR_APPLICATION_CHANGED = \"Vcap services properties for application \\\"{0}\\\" changed: {1}\";", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3ODgyNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499378825", "bodyText": "Is there a possibility to have situation where the variable is not set in the cotext (e.g. some flowable bug)?\nIf so what will happen with the code below?", "author": "boyan-velinov", "createdAt": "2020-10-05T06:58:44Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/DetermineVcapServicesPropertiesChangedStep.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.listeners.BindUnbindServiceEndListener;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"determineVcapServicesPropertiesChangedStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetermineVcapServicesPropertiesChangedStep extends SyncFlowableStep {\n+\n+    @Override\n+    protected StepPhase executeStep(ProcessContext context) {\n+        List<String> services = context.getVariable(Variables.SERVICES_TO_UNBIND_BIND);\n+        CloudApplicationExtended app = context.getVariable(Variables.APP_TO_PROCESS);\n+\n+        boolean changedVcapServicesProperties = services.stream()", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3OTQ0Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499379442", "bodyText": "You can rename it to be more explicit with \"unbindServiceFromAppStep\"\nI sugggest this because we could support bind and unbind services from routes at some moment in future.", "author": "boyan-velinov", "createdAt": "2020-10-05T07:00:13Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UnbindServiceStep.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"unbindServiceStep\")", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwMzAxMA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499403010", "bodyText": "I think the previous logic does not rebind at all. It only bind (existing or non-existing) and unbind not needed.\nPlease verify that rebinding is ok", "author": "boyan-velinov", "createdAt": "2020-10-05T07:50:30Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/DetermineServiceBindUnbindStep.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended.AttributeUpdateStrategy;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileStorageException;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.util.ServiceBindingParametersGetter;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"determineServiceBindUnbindStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetermineServiceBindUnbindStep extends SyncFlowableStep {\n+\n+    @Override\n+    protected StepPhase executeStep(ProcessContext context) throws FileStorageException {\n+        CloudApplicationExtended app = context.getVariable(Variables.APP_TO_PROCESS);\n+        String service = context.getVariable(Variables.SERVICE_TO_UNBIND_BIND);\n+        getStepLogger().debug(Messages.DETERMINE_BIND_UNBIND_OPERATIONS_APPLICATION_0_SERVICE_1, app.getName(), service);\n+\n+        if (!isServicePartFromMta(app, service) && !shouldKeepExistingServiceBindings(app)) {\n+            context.setVariable(Variables.SHOULD_UNBIND_SERVICE, true);\n+            context.setVariable(Variables.SHOULD_BIND_SERVICE, false);\n+            return StepPhase.DONE;\n+        }\n+\n+        CloudControllerClient client = context.getControllerClient();\n+        CloudApplication existingApp = client.getApplication(app.getName());\n+\n+        ServiceBindingParametersGetter serviceBindingParametersGetter = getServiceBindingParametersGetter(context);\n+        Map<String, Object> bindingParameters = serviceBindingParametersGetter.getServiceBindingParametersFromMta(app, service);\n+        if (!doesServiceBindingExist(service, existingApp)) {\n+            context.setVariable(Variables.SHOULD_UNBIND_SERVICE, false);\n+            context.setVariable(Variables.SHOULD_BIND_SERVICE, true);\n+            context.setVariable(Variables.SERVICE_BINDING_PARAMETERS, bindingParameters);\n+            return StepPhase.DONE;\n+        }\n+\n+        if (shouldRebindService(serviceBindingParametersGetter, existingApp, service, bindingParameters)) {", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwOTQ4OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499409488", "bodyText": "You could rename to bindServiceToAppStep becaus we could support route services in future.", "author": "boyan-velinov", "createdAt": "2020-10-05T08:00:31Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/BindServiceStep.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.client.lib.ApplicationServicesUpdateCallback;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.CloudOperationException;\n+import org.cloudfoundry.multiapps.common.SLException;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"bindServiceStep\")", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQxMTI0Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499411246", "bodyText": "You can generilize the naming to \"Manage Application Service Bindings Call Activity\" and propagate the wording.", "author": "boyan-velinov", "createdAt": "2020-10-05T08:02:02Z", "path": "multiapps-controller-process/src/main/resources/org/cloudfoundry/multiapps/controller/process/deploy-app.bpmn", "diffHunk": "@@ -130,6 +126,25 @@\n       </extensionElements>\n       <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${appStateActionsToExecute.contains('START')}]]></conditionExpression>\n     </sequenceFlow>\n+    <callActivity id=\"bindUnbindServicesCallActivity\" name=\"Bind Unbind Services Call Activity\" flowable:async=\"true\" calledElement=\"bindUnbindServiceSubProcess\" flowable:calledElementType=\"key\" flowable:inheritVariables=\"true\" flowable:completeAsync=\"true\" flowable:fallbackToDefaultTenant=\"false\">", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQxMjQ5OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499412499", "bodyText": "We can rename it to \"CreateOrUpdateAppStepWithExistingAppTests\"", "author": "boyan-velinov", "createdAt": "2020-10-05T08:03:12Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateStepWithExistingAppTest.java", "diffHunk": "@@ -30,18 +30,25 @@\n import org.cloudfoundry.multiapps.controller.client.lib.domain.ServiceKeyToInject;\n import org.cloudfoundry.multiapps.controller.core.util.NameUtil;\n import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.flowable.engine.ProcessEngine;\n import org.junit.jupiter.api.Assertions;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.Arguments;\n import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n import org.mockito.Mockito;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+\n class CreateOrUpdateStepWithExistingAppTest extends SyncFlowableStepTest<CreateOrUpdateAppStep> {", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQxODc2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499418765", "bodyText": "Rename to \"DeterminServiceBindingsActionsStep\"", "author": "boyan-velinov", "createdAt": "2020-10-05T08:14:51Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/DetermineServiceBindUnbindStep.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+import javax.inject.Named;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended.AttributeUpdateStrategy;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileStorageException;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.util.ServiceBindingParametersGetter;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+@Named(\"determineServiceBindUnbindStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetermineServiceBindUnbindStep extends SyncFlowableStep {", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQyMDQzOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499420438", "bodyText": "One idea is to change naming only to service and consequent check to !service.isPresent()\nit is to not mislead this service to the optional services term", "author": "boyan-velinov", "createdAt": "2020-10-05T08:18:02Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/util/ServiceBindingParametersGetter.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package org.cloudfoundry.multiapps.controller.process.util;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.text.MessageFormat;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.CloudOperationException;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudServiceBinding;\n+import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.multiapps.common.SLException;\n+import org.cloudfoundry.multiapps.common.util.JsonUtil;\n+import org.cloudfoundry.multiapps.common.util.MapUtil;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudApplicationExtended;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.core.helpers.MtaArchiveElements;\n+import org.cloudfoundry.multiapps.controller.core.security.serialization.SecureSerialization;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileContentProcessor;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileService;\n+import org.cloudfoundry.multiapps.controller.persistence.services.FileStorageException;\n+import org.cloudfoundry.multiapps.controller.process.Messages;\n+import org.cloudfoundry.multiapps.controller.process.steps.ProcessContext;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+import org.cloudfoundry.multiapps.mta.handlers.ArchiveHandler;\n+import org.cloudfoundry.multiapps.mta.util.NameUtil;\n+import org.springframework.http.HttpStatus;\n+\n+public class ServiceBindingParametersGetter {\n+\n+    private final ProcessContext context;\n+    private final FileService fileService;\n+    private final long maxManifestSize;\n+\n+    public ServiceBindingParametersGetter(ProcessContext context, FileService fileService, long maxManifestSize) {\n+        this.context = context;\n+        this.fileService = fileService;\n+        this.maxManifestSize = maxManifestSize;\n+    }\n+\n+    public Map<String, Object> getServiceBindingParametersFromMta(CloudApplicationExtended app, String serviceName)\n+        throws FileStorageException {\n+        Optional<CloudServiceInstanceExtended> optionalService = getService(context.getVariable(Variables.SERVICES_TO_BIND), serviceName);", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQyNjIzNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/954#discussion_r499426236", "bodyText": "This will skip test of two differents flows (New and old), is that right?", "author": "boyan-velinov", "createdAt": "2020-10-05T08:28:33Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateStepWithExistingAppTest.java", "diffHunk": "@@ -359,10 +366,19 @@ CloudServiceInstanceExtended toCloudService() {\n \n     @Override\n     protected CreateOrUpdateAppStep createStep() {\n-        return new CreateAppStepMock();\n+        return new CreateAppStepMock(processEngine);\n     }\n \n     private static class CreateAppStepMock extends CreateOrUpdateAppStep {\n+        public CreateAppStepMock(ProcessEngine processEngine) {\n+            super(processEngine);\n+        }\n+\n+        @Override\n+        protected JsonNode getBindUnbindServicesCallActivity(ProcessContext context) {", "originalCommit": "ae4f9425ec33a6d2adf380b25ef07b0b218c016c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "721df3a73550cd35d8d2ab086ccb48089f85124d", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/721df3a73550cd35d8d2ab086ccb48089f85124d", "message": "Refactor 2", "committedDate": "2020-10-07T13:11:40Z", "type": "forcePushed"}, {"oid": "5338a0d727e1c4b0d49a9224c12475a7ee52beeb", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/5338a0d727e1c4b0d49a9224c12475a7ee52beeb", "message": "Refactor 2", "committedDate": "2020-10-07T13:26:34Z", "type": "forcePushed"}, {"oid": "51ab57c5c313e249c75cff57c3d8eb44a19bc6eb", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/51ab57c5c313e249c75cff57c3d8eb44a19bc6eb", "message": "Refactor 2", "committedDate": "2020-10-08T13:07:57Z", "type": "forcePushed"}, {"oid": "6e399323e77803452284b72cc3dd616d54b541dc", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e399323e77803452284b72cc3dd616d54b541dc", "message": "Make parallel bind/unbind of services\n\nJIRA:LMCROSSITXSADEPLOY-1867", "committedDate": "2020-10-09T09:00:51Z", "type": "commit"}, {"oid": "6e399323e77803452284b72cc3dd616d54b541dc", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e399323e77803452284b72cc3dd616d54b541dc", "message": "Make parallel bind/unbind of services\n\nJIRA:LMCROSSITXSADEPLOY-1867", "committedDate": "2020-10-09T09:00:51Z", "type": "forcePushed"}]}