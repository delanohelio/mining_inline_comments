{"pr_number": 1406, "pr_title": "Fix concurrency issue in state update", "pr_createdAt": "2020-04-05T16:34:24Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1406", "timeline": [{"oid": "86744d0cc0f549b74df87c98ee27e8280a595fee", "url": "https://github.com/openhab/openhab-core/commit/86744d0cc0f549b74df87c98ee27e8280a595fee", "message": "Fix concurrency issue in state update\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-04-05T16:33:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1MDU0NA==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r403750544", "bodyText": "Minor point - I assume that this should say -:\nfailed comparing oldState '{}' to newState '{}' during state update of item\n\nor\nfailed comparing oldState '{}' to newState '{}' while updating state of item\n\nor something similar - basically the \"about\" doesn't seem right.\n(I told you it was minor - sorry for being pick :) ).", "author": "cdjackson", "createdAt": "2020-04-05T20:08:05Z", "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/items/GenericItem.java", "diffHunk": "@@ -251,18 +251,23 @@ protected void notifyListeners(final State oldState, final State newState) {\n         Set<StateChangeListener> clonedListeners = null;\n         clonedListeners = new CopyOnWriteArraySet<>(listeners);\n         ExecutorService pool = ThreadPoolManager.getPool(ITEM_THREADPOOLNAME);\n-        for (final StateChangeListener listener : clonedListeners) {\n-            pool.execute(() -> {\n-                try {\n-                    listener.stateUpdated(GenericItem.this, newState);\n-                    if (newState != null && !newState.equals(oldState)) {\n-                        listener.stateChanged(GenericItem.this, oldState, newState);\n+        try {\n+            final boolean stateChanged = newState != null && !newState.equals(oldState);\n+            clonedListeners.forEach(listener ->\n+                pool.execute(() -> {\n+                    try {\n+                        listener.stateUpdated(GenericItem.this, newState);\n+                        if (stateChanged) {\n+                            listener.stateChanged(GenericItem.this, oldState, newState);\n+                        }\n+                    } catch (Exception e) {\n+                        logger.warn(\"failed notifying listener '{}' about state update of item {}: {}\", listener,\n+                                GenericItem.this.getName(), e.getMessage(), e);\n                     }\n-                } catch (Exception e) {\n-                    logger.warn(\"failed notifying listener '{}' about state update of item {}: {}\", listener,\n-                            GenericItem.this.getName(), e.getMessage(), e);\n-                }\n-            });\n+                }));\n+        } catch (Exception e) {\n+            logger.warn(\"failed comparing oldState '{}' to newState '{}' about state update of item {}: {}\", oldState,", "originalCommit": "86744d0cc0f549b74df87c98ee27e8280a595fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1Mjk0Mw==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r403752943", "bodyText": "Copy&Paste error... Will fix it.", "author": "J-N-K", "createdAt": "2020-04-05T20:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc1MDU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NzU2OA==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r403747568", "bodyText": "Do we really have to catch a base Exception here. Or is a more specific one possible (e.g. IAE thrown by the compareTo() method).", "author": "cweitkamp", "createdAt": "2020-04-05T19:40:53Z", "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/items/GenericItem.java", "diffHunk": "@@ -251,18 +251,23 @@ protected void notifyListeners(final State oldState, final State newState) {\n         Set<StateChangeListener> clonedListeners = null;\n         clonedListeners = new CopyOnWriteArraySet<>(listeners);\n         ExecutorService pool = ThreadPoolManager.getPool(ITEM_THREADPOOLNAME);\n-        for (final StateChangeListener listener : clonedListeners) {\n-            pool.execute(() -> {\n-                try {\n-                    listener.stateUpdated(GenericItem.this, newState);\n-                    if (newState != null && !newState.equals(oldState)) {\n-                        listener.stateChanged(GenericItem.this, oldState, newState);\n+        try {\n+            final boolean stateChanged = newState != null && !newState.equals(oldState);\n+            clonedListeners.forEach(listener ->\n+                pool.execute(() -> {\n+                    try {\n+                        listener.stateUpdated(GenericItem.this, newState);\n+                        if (stateChanged) {\n+                            listener.stateChanged(GenericItem.this, oldState, newState);\n+                        }\n+                    } catch (Exception e) {\n+                        logger.warn(\"failed notifying listener '{}' about state update of item {}: {}\", listener,\n+                                GenericItem.this.getName(), e.getMessage(), e);\n                     }\n-                } catch (Exception e) {\n-                    logger.warn(\"failed notifying listener '{}' about state update of item {}: {}\", listener,\n-                            GenericItem.this.getName(), e.getMessage(), e);\n-                }\n-            });\n+                }));\n+        } catch (Exception e) {", "originalCommit": "86744d0cc0f549b74df87c98ee27e8280a595fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIyNTk1Mw==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r404225953", "bodyText": "Changed to IAE. WDYT about making compareTo a synchronized method?", "author": "J-N-K", "createdAt": "2020-04-06T16:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NzU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyNzQzMg==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r405027432", "bodyText": "In general I am not a big fan of synchronized for this method because we cannot be sure the result is still the same after the synchronization was left. If we want to force that we have to snyc the whole block - the compared objects too. We should make sure the values used for comparison are immutable and preferable final.", "author": "cweitkamp", "createdAt": "2020-04-07T18:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NzU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzODA4Ng==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r405038086", "bodyText": "The problem is not our code. The problem is that https://github.com/unitsofmeasurement/uom-se/blob/b9b4d770e25a245492d98909529e51961edb7bc3/src/main/java/tec/uom/se/unit/ProductUnit.java#L75 is not as final as it looks (the array itself is final, its elements are not) and during comparison the elements are changed https://github.com/unitsofmeasurement/uom-se/blob/b9b4d770e25a245492d98909529e51961edb7bc3/src/main/java/tec/uom/se/unit/ProductUnit.java#L279 which probably causes a problem if the same Unit is compared a second time while the first comparison is not finished. That explains why moving the comparison solves our problem and why it only happens under high load conditions when a lot of scheduled comparison are executed.\nI don\u2018t see an easy way to solve this (except changing the array to a thread-safe collection-type).", "author": "J-N-K", "createdAt": "2020-04-07T18:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NzU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzQxOA==", "url": "https://github.com/openhab/openhab-core/pull/1406#discussion_r405707418", "bodyText": "Your current change is a good step and I will merge it for now. I think we can synchronize the comparison later if needed.\nMaybe @keilw is interested in this topic.", "author": "cweitkamp", "createdAt": "2020-04-08T17:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NzU2OA=="}], "type": "inlineReview"}, {"oid": "31de23f71f7da7647d0aaa88b65d5632518772d8", "url": "https://github.com/openhab/openhab-core/commit/31de23f71f7da7647d0aaa88b65d5632518772d8", "message": "address review comments\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-04-06T16:27:46Z", "type": "commit"}]}