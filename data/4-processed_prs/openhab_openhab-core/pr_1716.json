{"pr_number": 1716, "pr_title": "Fixed ScriptEngine parameter option removal", "pr_createdAt": "2020-10-12T12:32:17Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1716", "timeline": [{"oid": "f123e7ca0fac527de00e1ded39c87e0ba29a6e50", "url": "https://github.com/openhab/openhab-core/commit/f123e7ca0fac527de00e1ded39c87e0ba29a6e50", "message": "Fix ScriptEngine parameter option removal\n\nWhen one of the engines is unset the ScriptModuleTypeProvider clears all parameter options instead of only those that apply to that engine.\nThis fixes the Nashorn engine missing from the parameter options on the first openHAB startup.\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-10-12T12:33:14Z", "type": "forcePushed"}, {"oid": "070bd55d804f7b5a3110fb37b9f7eaf50f47c45e", "url": "https://github.com/openhab/openhab-core/commit/070bd55d804f7b5a3110fb37b9f7eaf50f47c45e", "message": "Fix ScriptEngine parameter option removal\n\nWhen one of the engines is unset the ScriptModuleTypeProvider clears all parameter options instead of only those that apply to that engine.\nThis fixes the Nashorn engine missing from the parameter options on the first openHAB startup.\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-10-12T12:36:58Z", "type": "forcePushed"}, {"oid": "b1dc9ac528001cde9e5cc3e60e446aba7f038066", "url": "https://github.com/openhab/openhab-core/commit/b1dc9ac528001cde9e5cc3e60e446aba7f038066", "message": "Fix ScriptEngine parameter option removal\n\nWhen one of the engines is unset the ScriptModuleTypeProvider clears all parameter options instead of only those that apply to that engine.\nThis fixes the Nashorn engine missing from the parameter options on the first openHAB startup.\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-10-12T12:58:16Z", "type": "commit"}, {"oid": "b1dc9ac528001cde9e5cc3e60e446aba7f038066", "url": "https://github.com/openhab/openhab-core/commit/b1dc9ac528001cde9e5cc3e60e446aba7f038066", "message": "Fix ScriptEngine parameter option removal\n\nWhen one of the engines is unset the ScriptModuleTypeProvider clears all parameter options instead of only those that apply to that engine.\nThis fixes the Nashorn engine missing from the parameter options on the first openHAB startup.\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-10-12T12:58:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MTc2Mw==", "url": "https://github.com/openhab/openhab-core/pull/1716#discussion_r504261763", "bodyText": "Not too nice to call \"createScriptEngine\" here, but it seems to be the only way to get hold of the mimeTypes to remove...", "author": "kaikreuzer", "createdAt": "2020-10-13T21:13:13Z", "path": "bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/provider/ScriptModuleTypeProvider.java", "diffHunk": "@@ -145,26 +145,34 @@ public void removeProviderChangeListener(ProviderChangeListener<ModuleType> list\n     public void setScriptEngineFactory(ScriptEngineFactory engineFactory) {\n         ScriptEngine scriptEngine = engineFactory.createScriptEngine(engineFactory.getScriptTypes().get(0));\n         if (scriptEngine != null) {\n-            List<String> mimeTypes = new ArrayList<>();\n-\n             javax.script.ScriptEngineFactory factory = scriptEngine.getFactory();\n-            String languageName = String.format(\"%s (%s)\",\n-                    factory.getLanguageName().substring(0, 1).toUpperCase() + factory.getLanguageName().substring(1),\n-                    factory.getLanguageVersion());\n-            mimeTypes.addAll(factory.getMimeTypes());\n-            String preferredMimeType = mimeTypes.get(0);\n-            mimeTypes.removeIf(mimeType -> !mimeType.contains(\"application\") || mimeType.contains(\"x-\"));\n-            if (!mimeTypes.isEmpty()) {\n-                preferredMimeType = mimeTypes.get(0);\n-            }\n-            parameterOptions.put(preferredMimeType, languageName);\n+            parameterOptions.put(getPreferredMimeType(factory), getLanguageName(factory));\n             logger.trace(\"ParameterOptions: {}\", parameterOptions);\n         } else {\n             logger.trace(\"setScriptEngineFactory: engine was null\");\n         }\n     }\n \n-    public void unsetScriptEngineFactory(ScriptEngineFactory scriptEngineFactory) {\n-        parameterOptions.clear();\n+    public void unsetScriptEngineFactory(ScriptEngineFactory engineFactory) {\n+        ScriptEngine scriptEngine = engineFactory.createScriptEngine(engineFactory.getScriptTypes().get(0));", "originalCommit": "b1dc9ac528001cde9e5cc3e60e446aba7f038066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3MDA4NQ==", "url": "https://github.com/openhab/openhab-core/pull/1716#discussion_r504270085", "bodyText": "Another way might have been to introduce another mapping to keep track of it but this also worked when I tested it.", "author": "wborn", "createdAt": "2020-10-13T21:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MTc2Mw=="}], "type": "inlineReview"}]}