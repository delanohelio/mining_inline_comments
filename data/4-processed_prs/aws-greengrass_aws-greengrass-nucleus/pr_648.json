{"pr_number": 648, "pr_title": "Updating the IPC API UpdateConfiguration as per new interface", "pr_createdAt": "2020-11-10T04:00:50Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648", "timeline": [{"oid": "b47172693cbcfae543d06154070c26b138350ebc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b47172693cbcfae543d06154070c26b138350ebc", "message": "Updating the IPC API UpdateConfiguration as per new interface", "committedDate": "2020-11-10T04:03:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MjgwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520272809", "bodyText": "what if it has no timestamp in the request? Should be using the current time.", "author": "MikeDombo", "createdAt": "2020-11-10T04:04:54Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -256,60 +257,32 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n-\n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n-                }\n-\n+                validateRequest(request);\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n                 Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n                 String[] keyPath = request.getKeyPath().toArray(new String[0]);\n                 Node node = configTopics.findNode(keyPath);\n-                if (node == null) {\n+\n+                if (node == null || node instanceof Topic) {\n                     try {\n-                        configTopics.lookup(keyPath)\n-                                .withValueChecked(request.getNewValue().get(keyPath[keyPath.length - 1]));\n+                        Topic updatedNode = configTopics.lookup(keyPath)\n+                                .withValueChecked(request.getTimestamp().toEpochMilli(),", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM0OTY2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520349663", "bodyText": "Timestamp is a required property. But we know that client can still allow the request to come through so will put validation for it.", "author": "abanthiy", "createdAt": "2020-11-10T07:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MjgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIxMTc5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r522211793", "bodyText": "What is the validation you are performing? 0, low numbers, negative numbers, MAX_INT are all legal times.", "author": "JamieHunter", "createdAt": "2020-11-12T15:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MjgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzQ0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273447", "bodyText": "what if the value is a map and not a terminal value?", "author": "MikeDombo", "createdAt": "2020-11-10T04:07:28Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -256,60 +257,32 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n-\n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n-                }\n-\n+                validateRequest(request);\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n                 Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n                 String[] keyPath = request.getKeyPath().toArray(new String[0]);\n                 Node node = configTopics.findNode(keyPath);\n-                if (node == null) {\n+\n+                if (node == null || node instanceof Topic) {\n                     try {\n-                        configTopics.lookup(keyPath)\n-                                .withValueChecked(request.getNewValue().get(keyPath[keyPath.length - 1]));\n+                        Topic updatedNode = configTopics.lookup(keyPath)\n+                                .withValueChecked(request.getTimestamp().toEpochMilli(),\n+                                        request.getValueToMerge().get(keyPath[keyPath.length - 1]));", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM1ODY1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520358651", "bodyText": "For null we need to create an interior node in that case. But if the node is a Topic already, I believe we do not support conversion of leaf to container right now.", "author": "abanthiy", "createdAt": "2020-11-10T07:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyOTQ0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520729440", "bodyText": "Yes conversion is supported but not using withValueChecked", "author": "MikeDombo", "createdAt": "2020-11-10T17:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzU3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273574", "bodyText": "use the configuration key instead of parameter", "author": "MikeDombo", "createdAt": "2020-11-10T04:07:57Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -318,6 +291,27 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Key is required\");\n+            }\n+\n+            Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+            if (serviceTopics == null) {\n+                throw new InvalidArgumentsError(\"Service config not found for service \" + serviceName);\n+            }\n+            Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDM3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520934379", "bodyText": "^", "author": "MikeDombo", "createdAt": "2020-11-10T23:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzU5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273596", "bodyText": "Component, not service", "author": "MikeDombo", "createdAt": "2020-11-10T04:08:04Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -318,6 +291,27 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Key is required\");\n+            }\n+\n+            Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+            if (serviceTopics == null) {\n+                throw new InvalidArgumentsError(\"Service config not found for service \" + serviceName);", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzY0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273644", "bodyText": "Key path is required", "author": "MikeDombo", "createdAt": "2020-11-10T04:08:17Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -318,6 +291,27 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Key is required\");", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3Mzc1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273753", "bodyText": "space before has", "author": "MikeDombo", "createdAt": "2020-11-10T04:08:41Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -318,6 +291,27 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Key is required\");\n+            }\n+\n+            Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+            if (serviceTopics == null) {\n+                throw new InvalidArgumentsError(\"Service config not found for service \" + serviceName);\n+            }\n+            Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n+            String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+            Node node = configTopics.findNode(keyPath);\n+            if (node != null && !(node instanceof Topic) && !(node instanceof Topics)) {\n+                logger.atError().kv(SERVICE_NAME, serviceName)\n+                        .log(\"Somehow Node has an unknown type {}\", node.getClass());\n+                throw new InvalidArgumentsError(\"Node corresponding to keypath \"\n+                        + request.getKeyPath().toString() + \"has an unknown type\");", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3Mzk3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520273974", "bodyText": "remove", "author": "MikeDombo", "createdAt": "2020-11-10T04:09:18Z", "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java", "diffHunk": "@@ -58,6 +58,7 @@ public void runServer() {\n         }\n         serverBootstrap = new ServerBootstrap(eventLoopGroup);\n         tlsContext = tlsContextOptions != null ? new ServerTlsContext(tlsContextOptions) : null;\n+        System.out.println(\"Hostname: \" + hostname);", "originalCommit": "b47172693cbcfae543d06154070c26b138350ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eab8b23c30e85399ddfe17a25d587694f507b27b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eab8b23c30e85399ddfe17a25d587694f507b27b", "message": "Updating the IPC API UpdateConfiguration as per new interface", "committedDate": "2020-11-10T21:13:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjM1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520932351", "bodyText": "should match not be match", "author": "MikeDombo", "createdAt": "2020-11-10T23:09:39Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +258,70 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                // The top level key is expected to be same as keyPath[keyPath.length - 1]\n+                Object value = request.getValueToMerge().get(keyPath[keyPath.length - 1]);\n+                if (value == null) {\n+                    throw new InvalidArgumentsError(\"Top level key in valueToMerge map should be match \"", "originalCommit": "3986bb6dce3c3a5403ef7b0b80ffc7ac90a7df66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjUwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520932502", "bodyText": "check for null, the service might not exist", "author": "MikeDombo", "createdAt": "2020-11-10T23:09:59Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +258,70 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                // The top level key is expected to be same as keyPath[keyPath.length - 1]\n+                Object value = request.getValueToMerge().get(keyPath[keyPath.length - 1]);\n+                if (value == null) {\n+                    throw new InvalidArgumentsError(\"Top level key in valueToMerge map should be match \"\n+                            + \"the last node in keypath ( \" + keyPath[keyPath.length - 1] + \" )\");\n                 }\n-\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);", "originalCommit": "3986bb6dce3c3a5403ef7b0b80ffc7ac90a7df66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0ODQyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520948428", "bodyText": "That's covered in the validateRequest method", "author": "abanthiy", "createdAt": "2020-11-10T23:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjY5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520932696", "bodyText": "you can just use mergeMap, it does the same thing with less work for you.", "author": "MikeDombo", "createdAt": "2020-11-10T23:10:32Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +258,70 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                // The top level key is expected to be same as keyPath[keyPath.length - 1]\n+                Object value = request.getValueToMerge().get(keyPath[keyPath.length - 1]);\n+                if (value == null) {\n+                    throw new InvalidArgumentsError(\"Top level key in valueToMerge map should be match \"\n+                            + \"the last node in keypath ( \" + keyPath[keyPath.length - 1] + \" )\");\n                 }\n-\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n-                Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n-                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                Topics configTopics = serviceTopics.lookupTopics(CONFIGURATION_CONFIG_KEY);\n                 Node node = configTopics.findNode(keyPath);\n                 if (node == null) {\n+                    if (value instanceof Map) {\n+                        configTopics.lookupTopics(keyPath).updateFromMap((Map)value,", "originalCommit": "3986bb6dce3c3a5403ef7b0b80ffc7ac90a7df66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1MjM5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520952398", "bodyText": "That is in Configuration. To use that I would need to create a new Configuration or need to create the complete value map with first key in keypath as the top level key. Both seem more work to me.", "author": "abanthiy", "createdAt": "2020-11-11T00:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDMxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520934318", "bodyText": "component, not service", "author": "MikeDombo", "createdAt": "2020-11-10T23:14:46Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -317,6 +330,33 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Keypath is required\");\n+            }\n+            if (request.getTimestamp() == null) {\n+                throw new InvalidArgumentsError(\"Timestamp is required\");\n+            }\n+            if (request.getValueToMerge() == null) {\n+                throw new InvalidArgumentsError(\"ValueToMerge is required\");\n+            }\n+\n+            Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+            if (serviceTopics == null) {\n+                throw new InvalidArgumentsError(\"Component config not found for service \" + serviceName);", "originalCommit": "3986bb6dce3c3a5403ef7b0b80ffc7ac90a7df66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1NzkwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520957906", "bodyText": "Updated", "author": "abanthiy", "createdAt": "2020-11-11T00:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDU5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520934592", "bodyText": "should work now", "author": "MikeDombo", "createdAt": "2020-11-10T23:15:28Z", "path": "src/test/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgentTest.java", "diffHunk": "@@ -267,92 +266,87 @@ void GIVEN_update_config_request_WHEN_update_key_does_not_exist_THEN_create_key(\n     }\n \n     @Test\n-    void GIVEN_update_config_request_WHEN_current_value_in_request_matches_current_value_for_node_THEN_update() {\n-        when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_A);\n-        when(kernel.findServiceTopic(TEST_COMPONENT_A))\n-                .thenReturn(configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A));\n-        UpdateConfigurationRequest request = new UpdateConfigurationRequest();\n-        request.setComponentName(TEST_COMPONENT_A);\n-        request.setKeyPath(Collections.singletonList(TEST_CONFIG_KEY_1));\n-        request.setNewValue(Collections.singletonMap(TEST_CONFIG_KEY_1, 30));\n-        request.setTimestamp(Instant.now());\n-        request.setOldValue(Collections.singletonMap(TEST_CONFIG_KEY_1, TEST_CONFIG_KEY_1_INITIAL_VALUE));\n-        UpdateConfigurationResponse response = agent.getUpdateConfigurationHandler(mockContext).handleRequest(request);\n-        assertNotNull(response);\n-\n-        assertEquals(30,\n-                kernel.findServiceTopic(TEST_COMPONENT_A).find(PARAMETERS_CONFIG_KEY, TEST_CONFIG_KEY_1).getOnce());\n-    }\n-\n-    @Test\n-    void GIVEN_update_config_request_WHEN_current_value_in_request_does_not_match_current_value_for_node_THEN_fail() {\n+    void GIVEN_update_config_request_WHEN_proposed_timestamp_is_stale_THEN_fail() {\n         when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_A);\n-        when(kernel.findServiceTopic(TEST_COMPONENT_A))\n-                .thenReturn(configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A));\n+        Topics componentAConfiguration =\n+                configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A);\n+        when(kernel.findServiceTopic(TEST_COMPONENT_A)).thenReturn(componentAConfiguration);\n+        long actualModTime = componentAConfiguration.lookup(PARAMETERS_CONFIG_KEY, TEST_CONFIG_KEY_1).getModtime();\n         UpdateConfigurationRequest request = new UpdateConfigurationRequest();\n-        request.setComponentName(TEST_COMPONENT_A);\n         request.setKeyPath(Collections.singletonList(TEST_CONFIG_KEY_1));\n-        request.setNewValue(Collections.singletonMap(TEST_CONFIG_KEY_1, 30));\n-        request.setTimestamp(Instant.now());\n-        request.setOldValue(Collections.singletonMap(TEST_CONFIG_KEY_1, 100));\n+        request.setValueToMerge(Collections.singletonMap(TEST_CONFIG_KEY_1, 30));\n+        request.setTimestamp(Instant.ofEpochMilli(actualModTime - 10));\n         FailedUpdateConditionCheckError error = assertThrows(FailedUpdateConditionCheckError.class, () ->\n                 agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n-        assertEquals(\"Current value for config is different from the current value needed for the update\",\n+        assertEquals(\"Proposed timestamp is older than the config's latest modified timestamp\",\n                 error.getMessage());\n     }\n \n     @Test\n-    void GIVEN_update_config_request_WHEN_proposed_timestamp_is_stale_THEN_fail() {\n+    void GIVEN_update_config_request_WHEN_requested_node_is_container_THEN_update_is_successful() {\n         when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_A);\n         Topics componentAConfiguration =\n                 configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A);\n+        componentAConfiguration.lookup(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\", \"SomeLeafKey\").withValue(\"SomeValue\");\n         when(kernel.findServiceTopic(TEST_COMPONENT_A)).thenReturn(componentAConfiguration);\n-        long actualModTime = componentAConfiguration.lookup(PARAMETERS_CONFIG_KEY, TEST_CONFIG_KEY_1).getModtime();\n+\n         UpdateConfigurationRequest request = new UpdateConfigurationRequest();\n-        request.setComponentName(TEST_COMPONENT_A);\n-        request.setKeyPath(Collections.singletonList(TEST_CONFIG_KEY_1));\n-        request.setNewValue(Collections.singletonMap(TEST_CONFIG_KEY_1, 30));\n-        request.setTimestamp(Instant.ofEpochMilli(actualModTime - 10));\n-        FailedUpdateConditionCheckError error = assertThrows(FailedUpdateConditionCheckError.class, () ->\n-                agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n-        assertEquals(\"Proposed timestamp is older than the config's latest modified timestamp\",\n-                error.getMessage());\n+        request.setKeyPath(Arrays.asList(\"SomeContainerKey\"));\n+        request.setValueToMerge(Collections.singletonMap(\"SomeContainerKey\", Collections.singletonMap(\"SomeLeafKey\",\n+                \"SomeOtherValue\")));\n+        request.setTimestamp(Instant.now());\n+        agent.getUpdateConfigurationHandler(mockContext).handleRequest(request);\n+        Topics updateTopics = componentAConfiguration.findTopics(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\");\n+        assertNotNull(updateTopics);\n+        assertEquals(\"SomeOtherValue\", Coerce.toString(((Topic)updateTopics.getChild(\"SomeLeafKey\")).getOnce()));\n     }\n \n     @Test\n-    void GIVEN_update_config_request_WHEN_requested_node_is_container_THEN_fail() {\n+    void GIVEN_update_config_request_WHEN_requested_node_is_leaf_THEN_update_to_convert_to_container_is_successful() {\n         when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_A);\n         Topics componentAConfiguration =\n                 configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A);\n         componentAConfiguration.lookup(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\", \"SomeLeafKey\").withValue(\"SomeValue\");\n         when(kernel.findServiceTopic(TEST_COMPONENT_A)).thenReturn(componentAConfiguration);\n \n         UpdateConfigurationRequest request = new UpdateConfigurationRequest();\n-        request.setComponentName(TEST_COMPONENT_A);\n-        request.setKeyPath(Collections.singletonList(\"SomeContainerKey\"));\n-        request.setNewValue(Collections.singletonMap(\"SomeContainerKey\", \"SomeOtherValue\"));\n+        request.setKeyPath(Arrays.asList(\"SomeContainerKey\", \"SomeLeafKey\"));\n+        request.setValueToMerge(Collections.singletonMap(\"SomeLeafKey\", Collections.singletonMap(\"newKey\",\n+                \"SomeOtherValue\")));\n         request.setTimestamp(Instant.now());\n+        assertThrows(InvalidArgumentsError.class,\n+                () -> agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n \n-        InvalidArgumentsError error = assertThrows(InvalidArgumentsError.class, () ->\n-                agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n-        assertEquals(\"Cannot update a non-leaf config node\",\n-                error.getMessage());\n+        //TODO: Uncomment this when node conversion from leaf to container is supported\n+\n+        //        Topics updateTopics = componentAConfiguration.findTopics(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\");\n+        //        assertNotNull(updateTopics);\n+        //        Topics convertedNode = (Topics)updateTopics.getChild(\"SomeLeafKey\");\n+        //        assertEquals(\"SomeOtherValue\",\n+        //                Coerce.toString(((Topic)convertedNode.getChild(\"newKey\")).getOnce()));\n     }\n \n     @Test\n-    void GIVEN_update_config_request_WHEN_requested_component_is_not_self_THEN_fail() {\n-        when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_B);\n+    void GIVEN_update_config_request_WHEN_requested_node_is_container_THEN_update_to_convert_to_leaf_is_successful() {\n+        when(mockAuthenticationData.getIdentityLabel()).thenReturn(TEST_COMPONENT_A);\n+        Topics componentAConfiguration =\n+                configuration.getRoot().lookupTopics(SERVICES_NAMESPACE_TOPIC, TEST_COMPONENT_A);\n+        componentAConfiguration.lookup(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\", \"SomeLeafKey\").withValue(\"SomeValue\");\n+        when(kernel.findServiceTopic(TEST_COMPONENT_A)).thenReturn(componentAConfiguration);\n \n         UpdateConfigurationRequest request = new UpdateConfigurationRequest();\n-        request.setComponentName(TEST_COMPONENT_A);\n-        request.setKeyPath(Collections.singletonList(TEST_CONFIG_KEY_1));\n-        request.setNewValue(Collections.singletonMap(TEST_CONFIG_KEY_1, 20));\n+        request.setKeyPath(Arrays.asList(\"SomeContainerKey\"));\n+        request.setValueToMerge(Collections.singletonMap(\"SomeContainerKey\", \"SomeOtherValue\"));\n         request.setTimestamp(Instant.now());\n+        assertThrows(InvalidArgumentsError.class,\n+                () -> agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n \n-        InvalidArgumentsError error = assertThrows(InvalidArgumentsError.class, () ->\n-                agent.getUpdateConfigurationHandler(mockContext).handleRequest(request));\n-        assertEquals(\"Cross component updates are not allowed\",\n-                error.getMessage());\n+        //TODO: Uncomment this when node conversion from container to leaf is supported\n+\n+        //        Topic updateTopic = componentAConfiguration.find(PARAMETERS_CONFIG_KEY, \"SomeContainerKey\");\n+        //        assertNotNull(updateTopic);\n+        //        assertEquals(\"SomeOtherValue\",\n+        //                Coerce.toString(updateTopic.getOnce()));", "originalCommit": "3986bb6dce3c3a5403ef7b0b80ffc7ac90a7df66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1Nzk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520957948", "bodyText": "Updated", "author": "abanthiy", "createdAt": "2020-11-11T00:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDU5Mg=="}], "type": "inlineReview"}, {"oid": "b6fa8f77ad8242e9e91804ed2b6c157759993268", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b6fa8f77ad8242e9e91804ed2b6c157759993268", "message": "Updating the IPC API UpdateConfiguration as per new interface", "committedDate": "2020-11-10T23:24:59Z", "type": "forcePushed"}, {"oid": "29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "message": "Addressing review comments", "committedDate": "2020-11-10T23:55:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2ODkwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520968906", "bodyText": "nit: remove?", "author": "hui-yang", "createdAt": "2020-11-11T00:50:19Z", "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/EventStreamRPCClient.java", "diffHunk": "@@ -100,6 +100,7 @@ protected void onContinuationMessage(List<Header> headers, byte[] payload, Messa\n                     if (messageFlags == MessageFlags.TerminateStream.getByteValue()) {\n                         try {\n                             this.close();\n+                            //is this call needed?", "originalCommit": "29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk3MTM2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520971369", "bodyText": "Is it possible a valid config node is null here? How does configuration without default value (not in recipes but in documentation) translate into config topics?", "author": "hui-yang", "createdAt": "2020-11-11T00:55:07Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -317,6 +329,33 @@ public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest requ\n         public void handleStreamEvent(EventStreamJsonMessage streamRequestEvent) {\n \n         }\n+\n+        private void validateRequest(UpdateConfigurationRequest request) {\n+            if (Utils.isEmpty(request.getKeyPath())) {\n+                throw new InvalidArgumentsError(\"Keypath is required\");\n+            }\n+            if (request.getTimestamp() == null) {\n+                throw new InvalidArgumentsError(\"Timestamp is required\");\n+            }\n+            if (request.getValueToMerge() == null) {\n+                throw new InvalidArgumentsError(\"ValueToMerge is required\");\n+            }\n+\n+            Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+            if (serviceTopics == null) {\n+                throw new InvalidArgumentsError(\"Component config not found for component \" + serviceName);\n+            }\n+            Topics configTopics = serviceTopics.lookupTopics(CONFIGURATION_CONFIG_KEY);\n+            String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+            Node node = configTopics.findNode(keyPath);\n+            if (node != null && !(node instanceof Topic) && !(node instanceof Topics)) {", "originalCommit": "29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2Nzc2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r521667765", "bodyText": "Not sure if I understand the concern. A new node which is meant to be created in this update will always be null. node without default value in recipe will also be null.", "author": "abanthiy", "createdAt": "2020-11-11T22:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk3MTM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk3MzgyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520973824", "bodyText": "should this be in validateRequest()?", "author": "hui-yang", "createdAt": "2020-11-11T00:58:46Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +257,70 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                // The top level key is expected to be same as keyPath[keyPath.length - 1]\n+                Object value = request.getValueToMerge().get(keyPath[keyPath.length - 1]);\n+                if (value == null) {\n+                    throw new InvalidArgumentsError(\"Top level key in valueToMerge map should match \"\n+                            + \"the last node in keypath ( \" + keyPath[keyPath.length - 1] + \" )\");", "originalCommit": "29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk3NjExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r520976110", "bodyText": "Not sure if I understand all the different branches here. Why .parent.updateFromMap in this case?", "author": "hui-yang", "createdAt": "2020-11-11T01:02:09Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +257,70 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                // The top level key is expected to be same as keyPath[keyPath.length - 1]\n+                Object value = request.getValueToMerge().get(keyPath[keyPath.length - 1]);\n+                if (value == null) {\n+                    throw new InvalidArgumentsError(\"Top level key in valueToMerge map should match \"\n+                            + \"the last node in keypath ( \" + keyPath[keyPath.length - 1] + \" )\");\n                 }\n-\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n-                Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n-                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                Topics configTopics = serviceTopics.lookupTopics(CONFIGURATION_CONFIG_KEY);\n                 Node node = configTopics.findNode(keyPath);\n                 if (node == null) {\n-                    try {\n-                        configTopics.lookup(keyPath)\n-                                .withValueChecked(request.getNewValue().get(keyPath[keyPath.length - 1]));\n-                    } catch (UnsupportedInputTypeException e) {\n-                        throw new InvalidArgumentsError(e.getMessage());\n+                    if (value instanceof Map) {\n+                        configTopics.lookupTopics(keyPath).updateFromMap((Map)value,\n+                                new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE,\n+                                request.getTimestamp().toEpochMilli()));\n+                    } else {\n+                        try {\n+                            configTopics.lookup(keyPath)\n+                                    .withValueChecked(request.getTimestamp().toEpochMilli(), value);\n+                        } catch (UnsupportedInputTypeException e) {\n+                            throw new InvalidArgumentsError(e.getMessage());\n+                        }\n+                    }\n+                } else if (node instanceof Topic) {\n+                    if (value instanceof Map) {\n+                        Topic topic = (Topic)node;\n+                        try {\n+                            topic.parent.updateFromMap(Collections.singletonMap(topic.getName(), value),\n+                                    new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE,\n+                                            request.getTimestamp().toEpochMilli()));\n+                        } catch (IllegalArgumentException e) {\n+                            throw new InvalidArgumentsError(e.getMessage());\n+                        }", "originalCommit": "29d71cac0a04b45c6f9928fa96dbc3e531f90bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2MjQyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r521562420", "bodyText": "Use lookupTopics here to simplify the if else block below?", "author": "fahadmohammed01", "createdAt": "2020-11-11T18:39:06Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +256,44 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = new String[0];\n+                // Keypath is expected to denote the container node\n+                if (request.getKeyPath() != null) {\n+                    keyPath = request.getKeyPath().toArray(new String[0]);\n                 }\n \n+                Object value = request.getValueToMerge();\n+\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n-                Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n-                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                Topics configTopics = serviceTopics.lookupTopics(CONFIGURATION_CONFIG_KEY);\n                 Node node = configTopics.findNode(keyPath);", "originalCommit": "e15c64e77a696921cb09f2db5d8db9b26c3b0d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2NDI0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r521564245", "bodyText": "What happens when this condition is true for the updatedNode but not true for one of its sub nodes. Wouldn't the update go through but the api throw back an error?", "author": "fahadmohammed01", "createdAt": "2020-11-11T18:42:28Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -255,60 +256,44 @@ protected void onStreamClosed() {\n         public UpdateConfigurationResponse handleRequest(UpdateConfigurationRequest request) {\n             return translateExceptions(() -> {\n                 logger.atDebug().kv(SERVICE_NAME, serviceName).log(\"Config IPC config update request\");\n-                if (Utils.isEmpty(request.getKeyPath())) {\n-                    throw new InvalidArgumentsError(\"Key is required\");\n-                }\n+                validateRequest(request);\n \n-                if (request.getComponentName() != null && !serviceName.equals(request.getComponentName())) {\n-                    throw new InvalidArgumentsError(\"Cross component updates are not allowed\");\n+                String[] keyPath = new String[0];\n+                // Keypath is expected to denote the container node\n+                if (request.getKeyPath() != null) {\n+                    keyPath = request.getKeyPath().toArray(new String[0]);\n                 }\n \n+                Object value = request.getValueToMerge();\n+\n                 Topics serviceTopics = kernel.findServiceTopic(serviceName);\n-                if (serviceTopics == null) {\n-                    throw new InvalidArgumentsError(\"Service config not found\");\n-                }\n-                Topics configTopics = serviceTopics.lookupTopics(PARAMETERS_CONFIG_KEY);\n-                String[] keyPath = request.getKeyPath().toArray(new String[0]);\n+                Topics configTopics = serviceTopics.lookupTopics(CONFIGURATION_CONFIG_KEY);\n                 Node node = configTopics.findNode(keyPath);\n+\n                 if (node == null) {\n+                    configTopics.lookupTopics(keyPath)\n+                            .updateFromMap((Map) value, new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE,\n+                                    request.getTimestamp().toEpochMilli()));\n+                } else if (node instanceof Topic) {\n+                    Topic topic = (Topic)node;\n                     try {\n-                        configTopics.lookup(keyPath)\n-                                .withValueChecked(request.getNewValue().get(keyPath[keyPath.length - 1]));\n-                    } catch (UnsupportedInputTypeException e) {\n+                        topic.parent.updateFromMap(Collections.singletonMap(topic.getName(), value),\n+                                new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE,\n+                                        request.getTimestamp().toEpochMilli()));\n+                    } catch (IllegalArgumentException e) {\n                         throw new InvalidArgumentsError(e.getMessage());\n                     }\n-                    return new UpdateConfigurationResponse();\n-                }\n-                // TODO :[P41210581]: UpdateConfiguration API should support updating nested configuration\n-                if (node instanceof Topics) {\n-                    throw new InvalidArgumentsError(\"Cannot update a non-leaf config node\");\n-                }\n-                if (!(node instanceof Topic)) {\n-                    logger.atError().kv(SERVICE_NAME, serviceName)\n-                            .log(\"Somehow Node has an unknown type {}\", node.getClass());\n-                    throw new InvalidArgumentsError(\"Node has an unknown type\");\n+                } else {\n+                    Topics topics = (Topics)node;\n+                    topics.updateFromMap((Map)value,\n+                            new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.MERGE, request\n+                            .getTimestamp().toEpochMilli()));\n                 }\n-                Topic topic = (Topic) node;\n-\n-                // Perform compare and swap if the customer has specified current value to compare\n-                if (request.getOldValue() != null && request.getOldValue().get(topic.getName()) != null && !request\n-                        .getOldValue().get(topic.getName()).equals(topic.getOnce())) {\n+                Node updatedNode = configTopics.findNode(keyPath);\n+                if (request.getTimestamp().toEpochMilli() < updatedNode.getModtime()) {", "originalCommit": "e15c64e77a696921cb09f2db5d8db9b26c3b0d47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2NzY5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r521567691", "bodyText": "Do we need this? Its fine if one node is updated and another is not based on timestamp. As long as the customer is aware that is the behaviour", "author": "fahadmohammed01", "createdAt": "2020-11-11T18:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2NDI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODkwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/648#discussion_r521598901", "bodyText": "If some of child nodes do not get updated due to timestamp, but atlease one of the child node got updated, the timestamp of container node will still point to the latest timestamp (by default parent will get notified of child updated). So the API will not throw the error in that case.\nI think this is the right behavior as even if children get updated partially, it is still an updated of the container node. And right now we accept timestamp at the container node level and not at individual child node level.", "author": "abanthiy", "createdAt": "2020-11-11T19:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2NDI0NQ=="}], "type": "inlineReview"}, {"oid": "0fd14226f0b7d6bd5879e0cafe930b1a2b295a98", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fd14226f0b7d6bd5879e0cafe930b1a2b295a98", "message": "Updating the IPC API UpdateConfiguration as per new interface", "committedDate": "2020-11-11T20:22:39Z", "type": "commit"}, {"oid": "d16e04255ae7702d34df233fb3c51741d58f2b70", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d16e04255ae7702d34df233fb3c51741d58f2b70", "message": "Addressing review comments", "committedDate": "2020-11-11T20:22:39Z", "type": "commit"}, {"oid": "d8366479bbfb84225f1961ffab820425fb97a601", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d8366479bbfb84225f1961ffab820425fb97a601", "message": "Changing the design of UpdateConfiguration API. Now node specifed by keypath is expected to be a container node always", "committedDate": "2020-11-11T20:22:39Z", "type": "commit"}, {"oid": "e12f5debceb7b1d057faf4a08347de57fe3cb56c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e12f5debceb7b1d057faf4a08347de57fe3cb56c", "message": "Adding a fix to UpdateConfiguration API", "committedDate": "2020-11-11T21:04:55Z", "type": "commit"}, {"oid": "e12f5debceb7b1d057faf4a08347de57fe3cb56c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e12f5debceb7b1d057faf4a08347de57fe3cb56c", "message": "Adding a fix to UpdateConfiguration API", "committedDate": "2020-11-11T21:04:55Z", "type": "forcePushed"}, {"oid": "463e609d62760e2f7129fdd57777f87878326205", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/463e609d62760e2f7129fdd57777f87878326205", "message": "Merge branch 'master' into updateConfigIpc", "committedDate": "2020-11-11T22:24:55Z", "type": "commit"}]}