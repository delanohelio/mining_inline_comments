{"pr_number": 596, "pr_title": "Set artifact permissions according to recipe artifact permissions", "pr_createdAt": "2020-10-31T06:16:04Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596", "timeline": [{"oid": "0a90a62fe57124edd8b4b44028c12232398504ed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0a90a62fe57124edd8b4b44028c12232398504ed", "message": "Set artifact permissions according to recipe artifact permissions\n\nDefaults to Readonly for user if not present", "committedDate": "2020-10-31T06:14:27Z", "type": "commit"}, {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c199df3563d60f657f736f3d6e99c70cf9402be7", "message": "Merge branch 'master' into artifact-perms", "committedDate": "2020-10-31T06:16:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDExOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464118", "bodyText": "Indentation seems to be 8 spaces per tab, but our regular style is 4.", "author": "MikeDombo", "createdAt": "2020-10-31T06:42:52Z", "path": "src/main/java/com/aws/greengrass/componentmanager/models/Permission.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+import com.aws.greengrass.util.FileSystemPermission;\n+import lombok.Builder;\n+import lombok.NonNull;\n+import lombok.Value;\n+\n+\n+/**\n+ * Permission settings for component artifacts. Read and Execute permissions can be set.\n+ * By default, the read permission is set to allow only the owner of the artifact on the disk and the execute permission\n+ * is set to NONE.\n+ */\n+@Value\n+@Builder\n+public class Permission {\n+        @NonNull", "originalCommit": "c199df3563d60f657f736f3d6e99c70cf9402be7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDI2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464263", "bodyText": "check s for null? Otherwise the toUppeCase can throw a NPE", "author": "MikeDombo", "createdAt": "2020-10-31T06:44:44Z", "path": "src/main/java/com/aws/greengrass/componentmanager/models/PermissionType.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+/**\n+ * Permission attribute to set. In Linux this corresponds to setting the User or Other bits of the standard POSIX\n+ * file permissions. In Windows this would correspond with modifying the ACL for owner and \"Everyone\" groups.\n+ */\n+public enum PermissionType {\n+    /**\n+     * No permissions.\n+     */\n+    NONE,\n+    /**\n+     * Owner of file has permission.\n+     */\n+    OWNER,\n+    /**\n+     * All users have permission.\n+     */\n+    ALL;\n+\n+    public static PermissionType fromString(String s) {\n+        return PermissionType.valueOf(s.toUpperCase());", "originalCommit": "c199df3563d60f657f736f3d6e99c70cf9402be7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDQxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464411", "bodyText": "add our GGExtension", "author": "MikeDombo", "createdAt": "2020-10-31T06:46:29Z", "path": "src/test/java/com/aws/greengrass/util/PermissionsTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+import static com.aws.greengrass.testcommons.testutilities.Matchers.hasPermission;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+class PermissionsTest {", "originalCommit": "c199df3563d60f657f736f3d6e99c70cf9402be7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2a8009466858f72f2c6fb7d058e9a0697ddf824", "message": "Cleanup", "committedDate": "2020-10-31T07:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNTgwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515515804", "bodyText": "We don't model group as a permission type? How can the customer specify that an component can only be accessed by a group?", "author": "fengwang666", "createdAt": "2020-10-31T16:51:49Z", "path": "src/main/java/com/aws/greengrass/componentmanager/models/PermissionType.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+/**\n+ * Permission attribute to set. In Linux this corresponds to setting the User or Other bits of the standard POSIX\n+ * file permissions. In Windows this would correspond with modifying the ACL for owner and \"Everyone\" groups.\n+ */\n+public enum PermissionType {", "originalCommit": "f2a8009466858f72f2c6fb7d058e9a0697ddf824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5NTU5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515695592", "bodyText": "They cannot - POSIX style group permissions are not cross platform so we only have owner and all", "author": "rbattle", "createdAt": "2020-11-02T00:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNTgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTczMDk0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515730948", "bodyText": "I've updated so that group is set when you set OWNER.\nIf customers want to specify that components can only be accessed by a group, they can the permission to OWNER and ensure that components are running with the same posixGroup", "author": "rbattle", "createdAt": "2020-11-02T04:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjMyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515516323", "bodyText": "Why is the group's permission set by the ALL instead of OWNER. Isn't group also a type of OWNER?", "author": "fengwang666", "createdAt": "2020-10-31T16:57:06Z", "path": "src/main/java/com/aws/greengrass/componentmanager/models/Permission.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+import com.aws.greengrass.util.FileSystemPermission;\n+import lombok.Builder;\n+import lombok.NonNull;\n+import lombok.Value;\n+\n+\n+/**\n+ * Permission settings for component artifacts. Read and Execute permissions can be set. By default, the read permission\n+ * is set to allow only the owner of the artifact on the disk and the execute permission is set to NONE.\n+ */\n+@Value\n+@Builder\n+public class Permission {\n+    @NonNull\n+    @Builder.Default\n+    PermissionType read = PermissionType.OWNER;\n+    @NonNull\n+    @Builder.Default\n+    PermissionType execute = PermissionType.NONE;\n+\n+    /**\n+     * Convert to file system permission.\n+     *\n+     * @return a permission.\n+     */\n+    public FileSystemPermission toFileSystemPermission() {\n+        return FileSystemPermission.builder()\n+                .ownerRead(true) // we always want owner to read\n+                .ownerExecute(execute == PermissionType.ALL || execute == PermissionType.OWNER)\n+                .groupRead(read == PermissionType.ALL)\n+                .groupExecute(execute == PermissionType.ALL)", "originalCommit": "f2a8009466858f72f2c6fb7d058e9a0697ddf824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5NzQwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515697400", "bodyText": "I suppose it depends on how restrictive we want the owner to be - I can see an argument for it being modeled either way.\nI don't have a problem setting the group bits when it is set to OWNER\nRead\nOWNER \nr--r-----\nALL\nr--r--r--\nNONE\nr-------\n\nExecute - has to be readable if you set executable\nOWNER \nr-xr-x---\nALL\nr-xr-xr-x\nNONE\n?--?----- (where ? is r if they have read permissions set)", "author": "rbattle", "createdAt": "2020-11-02T00:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjQ4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515516485", "bodyText": "What happens if the nucleus is run with a non-root user?", "author": "fengwang666", "createdAt": "2020-10-31T16:59:12Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -346,9 +346,9 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n             }\n             File artifactFile = downloader.getArtifactFile(packageArtifactDirectory, artifact, componentIdentifier);\n             if (artifactFile != null) {\n-                // TODO: Change permissions - set world readable until artifact permissions can be set via model\n                 try {\n-                    Permissions.setArtifactPermission(artifactFile.toPath());\n+                    Permissions.setArtifactPermission(artifactFile.toPath(),", "originalCommit": "f2a8009466858f72f2c6fb7d058e9a0697ddf824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5NjgwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515696808", "bodyText": "If nucleus is run as a non-root user, we'd probably want to keep write permission on the files - otherwise they wouldn't be able to remove them when the system goes to clean up\nSetting the permissions to be group/other readable/executable can still apply though.\nDo you think that in non-root mode we should not set the \"other\" permissions bits?", "author": "rbattle", "createdAt": "2020-11-02T00:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTczMTIyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515731222", "bodyText": "I've updated so that the write permissions is always kept on when running as a non-system user. This allows the artifact clean up to still work.", "author": "rbattle", "createdAt": "2020-11-02T04:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjQ4NQ=="}], "type": "inlineReview"}, {"oid": "0b3f5fb02368383b4eb2553092a2fe5b03befb46", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b3f5fb02368383b4eb2553092a2fe5b03befb46", "message": "Set group permissions when OWNER is specified. Set read permissions when execute is specified", "committedDate": "2020-11-02T03:42:50Z", "type": "commit"}, {"oid": "17a0ac68991e79d09f7e585b12f9efe985f9da6f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17a0ac68991e79d09f7e585b12f9efe985f9da6f", "message": "Merge remote-tracking branch 'origin/master' into artifact-perms", "committedDate": "2020-11-02T03:43:26Z", "type": "commit"}, {"oid": "016138f4d34ff13a63f19811fe370cd3364d5315", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/016138f4d34ff13a63f19811fe370cd3364d5315", "message": "Fix E2E test", "committedDate": "2020-11-02T07:05:08Z", "type": "commit"}]}