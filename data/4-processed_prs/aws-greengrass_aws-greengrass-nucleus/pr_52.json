{"pr_number": 52, "pr_title": "Refactor EvergreenService with initial unit test", "pr_createdAt": "2020-02-04T21:23:23Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52", "timeline": [{"oid": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "message": "Refactor EvergreenService with initial unit test", "committedDate": "2020-02-04T21:18:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMTk4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374931982", "bodyText": "I think these comments are pretty unnecessary.", "author": "MikeDombo", "createdAt": "2020-02-04T21:26:32Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -43,92 +43,57 @@\n \n @SuppressFBWarnings(value = \"DMI_HARDCODED_ABSOLUTE_FILENAME\", justification = \"Need hardcoded paths to find what OS we're on\")\n public class EvergreenService implements InjectionActions, Subscriber, Closeable {\n-    public static final String stateTopicName = \"_State\";\n-    private static final Pattern depParse = Pattern.compile(\" *([^,:;& ]+)(:([^,; ]+))?[,; ]*\");\n-    private static final HashMap<String, Integer> ranks = new HashMap<>();\n \n-    static {\n-        // figure out what OS we're running and add applicable tags\n-        // The more specific a tag is, the higher its rank should be\n-        // TODO: a loopy set of hacks\n-        ranks.put(\"all\", 0);\n-        ranks.put(\"any\", 0);\n-        if (Files.exists(Paths.get(\"/bin/bash\")) || Files.exists(Paths.get(\"/usr/bin/bash\"))) {\n-            ranks.put(\"unix\", 3);\n-            ranks.put(\"posix\", 3);\n-        }\n-        if (Files.exists(Paths.get(\"/proc\"))) {\n-            ranks.put(\"linux\", 10);\n-        }\n-        if (Files.exists(Paths.get(\"/usr/bin/apt-get\"))) {\n-            ranks.put(\"debian\", 11);\n-        }\n-        if (Exec.isWindows) {\n-            ranks.put(\"windows\", 5);\n-        }\n-        if (Files.exists(Paths.get(\"/usr/bin/yum\"))) {\n-            ranks.put(\"fedora\", 11);\n-        }\n-        String sysver = Exec.sh(\"uname -a\").toLowerCase();\n-        if (sysver.contains(\"ubuntu\")) {\n-            ranks.put(\"ubuntu\", 20);\n-        }\n-        if (sysver.contains(\"darwin\")) {\n-            ranks.put(\"macos\", 20);\n-        }\n-        if (sysver.contains(\"raspbian\")) {\n-            ranks.put(\"raspbian\", 22);\n-        }\n-        if (sysver.contains(\"qnx\")) {\n-            ranks.put(\"qnx\", 22);\n-        }\n-        if (sysver.contains(\"cygwin\")) {\n-            ranks.put(\"cygwin\", 22);\n-        }\n-        if (sysver.contains(\"freebsd\")) {\n-            ranks.put(\"freebsd\", 22);\n-        }\n-        if (sysver.contains(\"solaris\") || sysver.contains(\"sunos\")) {\n-            ranks.put(\"solaris\", 22);\n-        }\n-        try {\n-            ranks.put(InetAddress.getLocalHost().getHostName(), 99);\n-        } catch (UnknownHostException ex) {\n-        }\n-    }\n+    // static variables\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final Pattern DEP_PARSE = Pattern.compile(\" *([^,:;& ]+)(:([^,; ]+))?[,; ]*\");\n+    private static final Map<String, Integer> RANKS = buildRanks();\n \n+    // instance variables\n+    // public\n     public final Topics config;\n-    protected final CopyOnWriteArrayList<EvergreenService> explicitDependencies = new CopyOnWriteArrayList<>();\n-    final Object dependencyReadyLock = new Object();\n-    private final Topic state;\n     public Context context;\n+\n+    // protected", "originalCommit": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5Mzg3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374993875", "bodyText": "I added them when I had to deal with 10+ fields initially since it adds a lot readability. Could be removed as long as everyone feels comfortable.", "author": "leaf94", "createdAt": "2020-02-05T00:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMTk4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNTI5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375015296", "bodyText": "+1, feel unnecessary for comments like //protected , //public , etc.", "author": "ShirleyZheng92", "createdAt": "2020-02-05T01:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMTk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjg4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374932883", "bodyText": "Anything here?", "author": "MikeDombo", "createdAt": "2020-02-04T21:28:29Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.util.Log;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.InOrder;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class EvergreenServiceTest {\n+\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final String EVERGREEN_SERVICE_FULL_NAME = \"EvergreenServiceFullName\";\n+\n+    private EvergreenService evergreenService;\n+\n+    @Mock\n+    private Topics config;\n+\n+    @Mock\n+    private Topic stateTopic;\n+\n+    @Mock\n+    private Context context;\n+\n+    @Mock\n+    private Log log;\n+\n+    @Captor\n+    private ArgumentCaptor<Validator> validatorArgumentCaptor;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        Mockito.when(config.createLeafChild(Mockito.any())).thenReturn(stateTopic);\n+\n+        evergreenService = new EvergreenService(config);\n+        evergreenService.context = context;\n+    }\n+\n+    @Test\n+    void testConstructor() {\n+        // GIVEN\n+        // beforeEach\n+\n+        // WHEN\n+        // beforeEach", "originalCommit": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5MzIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374993232", "bodyText": "Nah. I added these because I struggled with myself when I feel readers may be confused why this test directly starts verification so I put the comment to indicate the GIVEN and WHEN are inside beforeEach.", "author": "leaf94", "createdAt": "2020-02-05T00:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5ODM3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374998373", "bodyText": "OK, that was not clear to me :D. Can you just say\n// GIVEN\n// provided in the beforeEach\n\nOr something along those lines?", "author": "MikeDombo", "createdAt": "2020-02-05T00:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5ODk1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374998957", "bodyText": "Absolutely! Changed.", "author": "leaf94", "createdAt": "2020-02-05T00:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjg4Mw=="}], "type": "inlineReview"}, {"oid": "75d3b57e309993add192282047d4be90e1cb11d2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/75d3b57e309993add192282047d4be90e1cb11d2", "message": "Minor change in EvergreenServiceTest", "committedDate": "2020-02-05T01:17:58Z", "type": "commit"}, {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/46252a3d304e55290f22fd9bc24df2ceea55e11c", "message": "Remove unnecessary comments per team's suggestion", "committedDate": "2020-02-05T02:00:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMTQ3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375421474", "bodyText": "Should use the latest: 3.2.4, and mockito core isn't needed, only this dep is required.", "author": "MikeDombo", "createdAt": "2020-02-05T18:11:18Z", "path": "pom.xml", "diffHunk": "@@ -21,6 +21,18 @@\n             <version>5.5.2</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-core</artifactId>\n+            <version>2.21.0</version>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-junit-jupiter</artifactId>\n+            <version>2.23.0</version>", "originalCommit": "46252a3d304e55290f22fd9bc24df2ceea55e11c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU2NjExOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375566118", "bodyText": "Changed.", "author": "leaf94", "createdAt": "2020-02-05T23:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMzkzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375423939", "bodyText": "For Greenlake we had the practice of putting the scenario into the test name such as \"GIVEN_a_service_in_new_WHEN_setState_to_installing_THEN_service_gets_installed\" or whatever. We don't necessarily need to follow that, but I would at least suggest explaining what is Given, what is the When, and what is the Then in your comments. Just having the blocks doesn't explain enough.", "author": "MikeDombo", "createdAt": "2020-02-05T18:15:56Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.util.Log;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.InOrder;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class EvergreenServiceTest {\n+\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final String EVERGREEN_SERVICE_FULL_NAME = \"EvergreenServiceFullName\";\n+\n+    private EvergreenService evergreenService;\n+\n+    @Mock\n+    private Topics config;\n+\n+    @Mock\n+    private Topic stateTopic;\n+\n+    @Mock\n+    private Context context;\n+\n+    @Mock\n+    private Log log;\n+\n+    @Captor\n+    private ArgumentCaptor<Validator> validatorArgumentCaptor;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        Mockito.when(config.createLeafChild(Mockito.any())).thenReturn(stateTopic);\n+\n+        evergreenService = new EvergreenService(config);\n+        evergreenService.context = context;\n+    }\n+\n+    @Test\n+    void testConstructor() {\n+        // GIVEN\n+        // provided in the beforeEach\n+\n+        // WHEN\n+        // provided in the beforeEach\n+\n+        // THEN\n+        // verify config\n+        Assertions.assertSame(config, evergreenService.config);\n+        Mockito.verify(config).createLeafChild(STATE_TOPIC_NAME);\n+\n+        // verify stateTopic\n+        Mockito.verify(stateTopic).setParentNeedsToKnow(false);\n+        Mockito.verify(stateTopic).setValue(Long.MAX_VALUE, State.New);\n+        Mockito.verify(stateTopic).validate(validatorArgumentCaptor.capture());\n+        Mockito.verify(stateTopic).subscribe(evergreenService);\n+        Mockito.verifyNoMoreInteractions(stateTopic);\n+\n+        // verify validator\n+        Validator validator = validatorArgumentCaptor.getValue();\n+        State returnedState = (State) validator.validate(State.New, null);\n+        Assertions.assertSame(State.New, returnedState);\n+    }\n+\n+    @Test\n+    void getState() {\n+        Mockito.when(stateTopic.getOnce()).thenReturn(State.New);\n+\n+        Assertions.assertSame(State.New, evergreenService.getState());\n+\n+        Mockito.verify(stateTopic).getOnce();\n+    }\n+\n+    @Test\n+    void setState() {\n+        // GIVEN", "originalCommit": "46252a3d304e55290f22fd9bc24df2ceea55e11c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU2NjY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375566687", "bodyText": "I actually like this practice a lot since it helps a lot reading and maintaining unit tests. Will start adding this pattern.", "author": "leaf94", "createdAt": "2020-02-05T23:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMzkzOQ=="}], "type": "inlineReview"}, {"oid": "7a01e323612e324a9c9adfcc9cd9be0de142df63", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a01e323612e324a9c9adfcc9cd9be0de142df63", "message": "Change unit test methods name", "committedDate": "2020-02-05T23:57:26Z", "type": "commit"}, {"oid": "586c2a76de3ba70871d1ca8c0f78abce82b7b9a3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/586c2a76de3ba70871d1ca8c0f78abce82b7b9a3", "message": "Merge branch 'master' into EGService_Refactor", "committedDate": "2020-02-06T00:08:54Z", "type": "commit"}]}