{"pr_number": 364, "pr_title": "Initial work to support component plugin with integ test", "pr_createdAt": "2020-08-13T20:45:32Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzOTM2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r470239361", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nThis line of code contains a resource that might not be closed properly. Resource leaks can cause your system to slow down or crash.\nFix\nConsider closing the following resource: cl. The resource is referenced in statements at the following line: 96. The resource is returned at line: 99. There are other execution paths that don't close the resource or return it, for example, when FastClasspathScanner constructor throws an exception. To prevent this resource leak, close cl along these other paths before you exit this method.\nMore info\nView resource management guidelines at oracle.com (external link).", "author": "MikeDombo", "createdAt": "2020-08-13T20:48:33Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/EZPlugins.java", "diffHunk": "@@ -82,6 +82,23 @@ private void loadPlugins(boolean trusted, Path p) throws IOException {\n         loadPlugins(trusted, cl);\n     }\n \n+    /**\n+     * Load a single plugin with the classpath scanner.\n+     * @param p path to jar file\n+     * @param matcher matcher to use\n+     * @throws IOException if loading the class fails\n+     */\n+    @SuppressWarnings(\"PMD.CloseResource\")\n+    public ClassLoader loadPlugin(Path p, Consumer<FastClasspathScanner> matcher) throws IOException {\n+        URLClassLoader cl = new URLClassLoader(new URL[]{p.toUri().toURL()});", "originalCommit": "e1e0cd50d6f9a8d51cbf3403f0b081bc090c0ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDg2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r470250861", "bodyText": "The class loader cannot be closed because we need to continue loading classes from it after this method exits. It cannot even be closed after we initialize the service class because we may need more classes from the loaded jar dynamically.", "author": "MikeDombo", "createdAt": "2020-08-13T21:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzOTM2MQ=="}], "type": "inlineReview"}, {"oid": "465a1a9c2a57d8a1cafd990543d5390b60838274", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/465a1a9c2a57d8a1cafd990543d5390b60838274", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T20:53:21Z", "type": "forcePushed"}, {"oid": "63b2c423d175baddacd3c9a282fa15b22d818a8f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63b2c423d175baddacd3c9a282fa15b22d818a8f", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T20:59:04Z", "type": "forcePushed"}, {"oid": "a9c27720a12f2fab9d78185779ba7e45bef57b0f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9c27720a12f2fab9d78185779ba7e45bef57b0f", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T21:01:31Z", "type": "forcePushed"}, {"oid": "3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T21:57:12Z", "type": "forcePushed"}, {"oid": "ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T22:02:43Z", "type": "forcePushed"}, {"oid": "be119b4a1e15cd34bf22b4691c724404188cb325", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/be119b4a1e15cd34bf22b4691c724404188cb325", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-13T22:40:18Z", "type": "forcePushed"}, {"oid": "6193b2f5cae21990d9a60c6946f5553ef722478e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6193b2f5cae21990d9a60c6946f5553ef722478e", "message": "Fix windows", "committedDate": "2020-08-14T04:40:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NzM2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471557366", "bodyText": "So every in jvm component has to be built as plugin.jar? Why can't we use the component name to infer the jar name instead of using hardcoded plugin.jar?", "author": "fengwang666", "createdAt": "2020-08-17T15:27:16Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";", "originalCommit": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODYxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471588613", "bodyText": "Yes, that's correct. In my proof of concept I had added a field to specify the jar name, but I decided against that because it requires a recipe change. I think that it is reasonable to force the artifact to be named plugin.jar.", "author": "MikeDombo", "createdAt": "2020-08-17T16:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NzM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5NDQxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471594418", "bodyText": "Why can't we just infer the jar name from the component name? It seems hacky to require every component building plugin.jar.", "author": "fengwang666", "createdAt": "2020-08-17T16:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NzM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Nzk4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471557988", "bodyText": "nit: ident seems an odd abbreviation. Maybe just id or pkgId?", "author": "fengwang666", "createdAt": "2020-08-17T15:28:15Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";\n+        PackageIdentifier ident = PackageIdentifier.fromServiceTopics(serviceRootTopics);", "originalCommit": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2NzI0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471567249", "bodyText": "Extract plugin to a constant?\nAlso this whole if..else block is getting a bit difficult to read. Maybe add some comments or refactor to private methods with more clear name?", "author": "fengwang666", "createdAt": "2020-08-17T15:41:54Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -355,6 +359,9 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n                     if (n != null) {\n                         cn = ((Map<String, String>) context.getvIfExists(SERVICE_TYPE_TO_CLASS_MAP_KEY).get())\n                                 .get(Coerce.toString(n).toLowerCase());\n+                        if (cn == null && Coerce.toString(n).toLowerCase().equals(\"plugin\")) {", "originalCommit": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDIwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471570209", "bodyText": "Why change to 0 timestamp?", "author": "fengwang666", "createdAt": "2020-08-17T15:46:01Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -400,7 +407,7 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n                     }\n                     if (clazz.getAnnotation(ImplementsService.class) != null) {\n                         topics.createLeafChild(VERSION_CONFIG_KEY)\n-                                .withValue(clazz.getAnnotation(ImplementsService.class).version());\n+                                .withNewerValue(0L, clazz.getAnnotation(ImplementsService.class).version());", "originalCommit": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NzYyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471587628", "bodyText": "The purpose is so that the version which is in the recipe file will overwrite this. This is just in case the version in the annotation isn't updated; but we know that the recipe will have the proper version because cloud won't allow it otherwise.", "author": "MikeDombo", "createdAt": "2020-08-17T16:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471576104", "bodyText": "This pretty much allows everyone create a plugin jar and run it in evergreen kernel jvm.", "author": "fengwang666", "createdAt": "2020-08-17T15:54:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";\n+        PackageIdentifier ident = PackageIdentifier.fromServiceTopics(serviceRootTopics);\n+        Path pluginJar = context.get(PackageStore.class).resolveArtifactDirectoryPath(ident)\n+                .resolve(jarName);", "originalCommit": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4OTQzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471589437", "bodyText": "Yes it does. I won't change anything in this PR to keep it smaller, but we can add more security around this. I think the idea was going to be to add code signing, right? What else do you think should be added for security other than code signing?", "author": "MikeDombo", "createdAt": "2020-08-17T16:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5ODIxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471598212", "bodyText": "How would code signing help in this case? A couple ideas:\n\nKernel has a list of hardcoded whitelisted components that are allowed to run inside kernel JVM;\nThe plugin directory is protected by file system permission and only kernel runas can access.", "author": "fengwang666", "createdAt": "2020-08-17T16:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMjM0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471602340", "bodyText": "Code signing would work by checking the signature against a set of trusted CAs. In our kernel only the Evergreen root CA would be trusted by default.", "author": "MikeDombo", "createdAt": "2020-08-17T16:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzQyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471603421", "bodyText": "A list could work, but I'd prefer to not have a list so that it is actually extensible. Anupam suggested maybe going by the publisher, so if it is \"AWS\", then it can be trusted.\nPermissions won't help at all since these components are coming from the cloud and not the disk", "author": "MikeDombo", "createdAt": "2020-08-17T16:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA=="}], "type": "inlineReview"}, {"oid": "00444b2ad523305e29ea0bac74120739f10fc17c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/00444b2ad523305e29ea0bac74120739f10fc17c", "message": "Initial work to support component plugin with integ test", "committedDate": "2020-08-17T16:17:03Z", "type": "commit"}, {"oid": "3c5b76926d720924fe2ba2034356e2b8ba0109b4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3c5b76926d720924fe2ba2034356e2b8ba0109b4", "message": "Fix windows", "committedDate": "2020-08-17T16:17:03Z", "type": "commit"}, {"oid": "026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "message": "Address comments", "committedDate": "2020-08-17T16:53:42Z", "type": "forcePushed"}, {"oid": "6f6356eedcf73a44e25a64ee24f090e8106bda0c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f6356eedcf73a44e25a64ee24f090e8106bda0c", "message": "Address comments", "committedDate": "2020-08-17T16:56:04Z", "type": "forcePushed"}, {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/99965a5d49a786e554d50867caf147ebb49c8f69", "message": "Address comments", "committedDate": "2020-08-17T16:59:29Z", "type": "commit"}, {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/99965a5d49a786e554d50867caf147ebb49c8f69", "message": "Address comments", "committedDate": "2020-08-17T16:59:29Z", "type": "forcePushed"}]}