{"pr_number": 238, "pr_title": "Fix tlog appending and add test", "pr_createdAt": "2020-05-13T16:47:13Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NjA2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424596066", "bodyText": "What's the reason Subscriber doesn't work?", "author": "fengwang666", "createdAt": "2020-05-13T17:06:20Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -21,7 +21,7 @@\n import static com.aws.iot.evergreen.util.Utils.appendLong;\n import static com.aws.iot.evergreen.util.Utils.flush;\n \n-public class ConfigurationWriter implements Closeable, Subscriber {\n+public class ConfigurationWriter implements Closeable, ChildChanged {", "originalCommit": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5Nzk2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424597966", "bodyText": "Subscriber is used for Topic, but ChildChanged is used for Topics. Since we are subscribing to the root of the config which is a Topics we need to do ChildChanged. Using the wrong interface caused the previous publish function to never be called.", "author": "MikeDombo", "createdAt": "2020-05-13T17:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMzI5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424613291", "bodyText": "Are these the same as line 47, 48, 49? Why do you need these twice?", "author": "fengwang666", "createdAt": "2020-05-13T17:34:57Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationWriterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.config;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+class ConfigurationWriterTest {\n+    @TempDir\n+    protected Path tempDir;\n+\n+    private Context context;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        context = new Context();\n+    }\n+\n+    @AfterEach\n+    void afterEach() throws IOException {\n+        if (context != null) {\n+            context.close();\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_config_with_configuration_writer_WHEN_config_changes_made_THEN_written_to_tlog() throws IOException {\n+        Path tlog = tempDir.resolve(\"c.tlog\");\n+        Configuration config = new Configuration(context);\n+\n+        try (ConfigurationWriter writer = ConfigurationWriter.logTransactionsTo(config, tlog)) {\n+            writer.flushImmediately(true);\n+\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e\").withValue(\"Some Val\");\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e2\").withValue(2);\n+            context.runOnPublishQueueAndWait(() -> {\n+            }); // Block until publish queue is empty to ensure all changes have\n+            // been processed\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e\").withValue(\"New Val\");\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e3\").withValue(Arrays.asList(\"1\", \"2\", \"3\"));\n+            context.runOnPublishQueueAndWait(() -> {\n+            });", "originalCommit": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNDU4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424614585", "bodyText": "This is different. It creates a tlog that doesn't just contain 1 node or 1 version of a node, but versions of a node over time. It also shows that we can serialize and deserialize various data types including lists, strings, and numbers.", "author": "MikeDombo", "createdAt": "2020-05-13T17:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMzI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxODAxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424618016", "bodyText": "Maybe add a comment to explain that. It's not obvious from the code.", "author": "fengwang666", "createdAt": "2020-05-13T17:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMzI5MQ=="}], "type": "inlineReview"}, {"oid": "272b5a9159c27a2b87818507cec837de4e739d64", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272b5a9159c27a2b87818507cec837de4e739d64", "message": "Fix tlog appending and create test", "committedDate": "2020-05-13T17:49:54Z", "type": "commit"}, {"oid": "272b5a9159c27a2b87818507cec837de4e739d64", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272b5a9159c27a2b87818507cec837de4e739d64", "message": "Fix tlog appending and create test", "committedDate": "2020-05-13T17:49:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyNTQyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424625423", "bodyText": "How do we know if customers actually want to load config.yaml with local dev changes? Do they have to delete the transaction logs in this case?", "author": "hui-yang", "createdAt": "2020-05-13T17:55:11Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -89,12 +89,13 @@ public void launch() {\n                 kernel.writeEffectiveConfig(configurationFile);\n                 Files.deleteIfExists(transactionLogPath);\n             } else {\n-                if (Files.exists(configurationFile)) {\n-                    kernel.getConfig().read(configurationFile);\n-                }", "originalCommit": "272b5a9159c27a2b87818507cec837de4e739d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzMjMxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424632319", "bodyText": "If they want to do that, then they will do what we do in our tests by using the command line to pass -i <config path>. Doing this will override this whole section of code because haveRead will be true.", "author": "MikeDombo", "createdAt": "2020-05-13T18:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyNTQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyOTQxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424629415", "bodyText": "I still don't get it why it didn't work earlier. Isn't deepForEachTopic going to add subscriber to leaf nodes?", "author": "hui-yang", "createdAt": "2020-05-13T18:01:48Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -116,6 +117,6 @@ public synchronized void published(WhatHappened what, Topic n) {\n     }\n \n     public void writeAll() { //TODO double check this\n-        conf.deepForEachTopic(n -> published(WhatHappened.childChanged, n));\n+        conf.deepForEachTopic(n -> childChanged(WhatHappened.childChanged, n));", "originalCommit": "272b5a9159c27a2b87818507cec837de4e739d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzMjcyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424632726", "bodyText": "No, it doesn't add a subscriber; it simply calls the childChanged callback on each Topic in the config store.", "author": "MikeDombo", "createdAt": "2020-05-13T18:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyOTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNDU1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424634551", "bodyText": "But this writeAll isn't the method which had the problem. The problem was with using Subscriber instead of ChildChanged.", "author": "MikeDombo", "createdAt": "2020-05-13T18:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyOTQxNQ=="}], "type": "inlineReview"}]}