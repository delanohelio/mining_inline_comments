{"pr_number": 446, "pr_title": "updated unit and integ tests", "pr_createdAt": "2020-09-17T21:35:33Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446", "timeline": [{"oid": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a2d33c176f3446666fb4e4812c5b56b7487ecd95", "message": "updated unit and integ tests", "committedDate": "2020-09-17T19:37:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3Njc0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490576740", "bodyText": "why removed? These are important tests", "author": "MikeDombo", "createdAt": "2020-09-17T21:37:59Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCPubSubTest.java", "diffHunk": "@@ -157,83 +195,60 @@ void GIVEN_pubsubclient_WHEN_authorized_THEN_parameters_child_removed_THEN_updat\n         c.publishToTopic(\"a\", \"some message\".getBytes(StandardCharsets.UTF_8));\n         cb.getLeft().get(TIMEOUT_FOR_PUBSUB_SECONDS, TimeUnit.SECONDS);\n \n-        Topics serviceTopic = kernel.findServiceTopic(TEST_SERVICE_NAME);\n+        Topics serviceTopic = kernel.findServiceTopic(\"DoAll2\");\n         Topics parameters = serviceTopic.findTopics(PARAMETERS_CONFIG_KEY);\n         if (parameters != null) {\n             parameters.remove();\n         }\n         //Block until events are completed\n-        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {\n+        });\n         //Now the authorization policies should have been removed and these should fail\n         assertThrows(PubSubException.class, () -> c.subscribeToTopic(\"a\", cb.getRight()));\n         assertThrows(PubSubException.class, () -> c.publishToTopic(\"a\", \"some message\".getBytes(StandardCharsets.UTF_8)));\n     }\n \n     @Test\n     void GIVEN_pubsubclient_WHEN_service_removed_and_added_THEN_fail_and_succeed() throws Exception {\n-        kernel = prepareKernelFromConfigFile(\"pubsub_authorized.yaml\", this.getClass(), TEST_SERVICE_NAME);\n-        KernelIPCClientConfig config = getIPCConfigForService(TEST_SERVICE_NAME, kernel);\n+        KernelIPCClientConfig config = getIPCConfigForService(\"SubscribeAndPublish\", kernel);\n         client = new IPCClientImpl(config);\n         PubSub c = new PubSubImpl(client);\n         Pair<CompletableFuture<Void>, Consumer<byte[]>> cb = asyncAssertOnConsumer((m) -> {\n             assertEquals(\"some message\", new String(m, StandardCharsets.UTF_8));\n         }, -1);\n         Permission policyId1 =\n-                Permission.builder().principal(TEST_SERVICE_NAME).operation(\"*\").resource(\"*\").build();\n+                Permission.builder().principal(\"SubscribeAndPublish\").operation(\"*\").resource(\"*\").build();\n         Permission policyId2 =\n-                Permission.builder().principal(\"mqtt\").operation(\"publish\").resource(\"*\").build();\n-        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId1));\n-        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId2));\n+                Permission.builder().principal(\"PublishNotSubscribe\").operation(\"publish\").resource(\"*\").build();\n+        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId1));\n+        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId2));\n         c.subscribeToTopic(\"a\", cb.getRight());\n         c.publishToTopic(\"a\", \"some message\".getBytes(StandardCharsets.UTF_8));\n         cb.getLeft().get(TIMEOUT_FOR_PUBSUB_SECONDS, TimeUnit.SECONDS);\n \n         // Remove the service topic\n-        Topics serviceTopic = kernel.findServiceTopic(TEST_SERVICE_NAME);\n+        Topics serviceTopic = kernel.findServiceTopic(\"SubscribeAndPublish\");\n         if (serviceTopic != null) {\n             serviceTopic.remove();\n         }\n-        kernel.getContext().runOnPublishQueueAndWait(() -> {});\n-        assertFalse(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId1));\n-        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId2));\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {\n+        });\n+        assertFalse(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId1));\n+        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId2));\n         assertThrows(PubSubException.class, () -> c.subscribeToTopic(\"a\", cb.getRight()));\n         assertThrows(PubSubException.class, () -> c.publishToTopic(\"a\", \"some message\".getBytes(StandardCharsets.UTF_8)));\n \n         // Reload the kernel with the service and correct authorization policy\n-        kernel.getConfig().read(new URL(IPCPubSubTest.class.getResource(\"pubsub_authorized.yaml\").toString()), false);\n+        kernel.getConfig().read(new URL(IPCPubSubTest.class.getResource(\"pubsub.yaml\").toString()), false);\n         kernel.getContext().runOnPublishQueueAndWait(() -> {\n         });\n-        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId1));\n-        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME,policyId2));\n+        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId1));\n+        assertTrue(kernel.getContext().get(AuthorizationModule.class).isPresent(PUB_SUB_SERVICE_NAME, policyId2));\n         c.subscribeToTopic(\"a\", cb.getRight()); //now this should succeed\n         c.publishToTopic(\"a\", \"some message\".getBytes(StandardCharsets.UTF_8));\n         cb.getLeft().get(TIMEOUT_FOR_PUBSUB_SECONDS, TimeUnit.SECONDS);\n     }\n \n-    @Test", "originalCommit": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3OTQ4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490579488", "bodyText": "Not removed but moved to the top of the file", "author": "fahadmohammed01", "createdAt": "2020-09-17T21:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3Njc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NzIwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490577207", "bodyText": "this really does need to be private, we don't want anything to mess with the lifecycle because it is so critical, even the subclasses.", "author": "MikeDombo", "createdAt": "2020-09-17T21:39:02Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -62,7 +62,7 @@\n     @Getter\n     public Context context;\n \n-    private final Lifecycle lifecycle;\n+    protected final Lifecycle lifecycle;", "originalCommit": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTUzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490581536", "bodyText": "This was for testing but the final revision does require this, reverted", "author": "fahadmohammed01", "createdAt": "2020-09-17T21:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NzIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODAxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490578012", "bodyText": "windows?", "author": "MikeDombo", "createdAt": "2020-09-17T21:40:54Z", "path": "src/test/resources/com/aws/iot/evergreen/kernel/services.yaml", "diffHunk": "@@ -0,0 +1,32 @@\n+---\n+services:\n+  A:\n+    Lifecycle:\n+    Dependencies:\n+        - B:HARD\n+        - C:SOFT\n+        - D\n+  B:\n+    Lifecycle:\n+    Dependencies:\n+  C:\n+    Lifecycle:\n+    Dependencies:\n+  D:\n+    Lifecycle:\n+    Dependencies:\n+  E:\n+    Lifecycle:\n+    Dependencies:\n+\n+  main:\n+    Lifecycle:\n+      run: |-\n+        echo $PATH\n+        pwd\n+        printenv\n+        while true; do\n+        date; sleep 5; echo RUNNING\n+        done", "originalCommit": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTk0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490581940", "bodyText": "removed, not required for the tests", "author": "fahadmohammed01", "createdAt": "2020-09-17T21:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODIxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490578219", "bodyText": "close the context in after", "author": "MikeDombo", "createdAt": "2020-09-17T21:41:25Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -3,31 +3,73 @@\n \n package com.aws.iot.evergreen.kernel;\n \n-import com.aws.iot.evergreen.config.Validator;\n+import com.amazon.aws.iot.greengrass.component.common.DependencyType;\n+import com.aws.iot.evergreen.config.Configuration;\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.exceptions.ServiceLoadException;\n import com.aws.iot.evergreen.testcommons.testutilities.EGServiceTestUtil;\n import org.junit.jupiter.api.Assertions;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.junit.jupiter.api.extension.ExtendWith;\n-import org.mockito.ArgumentCaptor;\n-import org.mockito.Captor;\n-import org.mockito.Mockito;\n+import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n \n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+\n+import static com.aws.iot.evergreen.kernel.EvergreenService.PRIVATE_STORE_NAMESPACE_TOPIC;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICE_DEPENDENCIES_NAMESPACE_TOPIC;\n import static com.aws.iot.evergreen.kernel.Lifecycle.STATE_TOPIC_NAME;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n @ExtendWith(MockitoExtension.class)\n public class EvergreenServiceTest extends EGServiceTestUtil {\n \n-    private EvergreenService evergreenService;\n-\n-    @Captor\n-    private ArgumentCaptor<Validator> validatorArgumentCaptor;\n+    @Mock\n+    private Kernel kernel;\n+    private Context context;\n+    private Configuration configuration;\n+    private EvergreenService aService;\n+    private EvergreenService bService;\n+    private EvergreenService cService;\n+    private EvergreenService dService;\n+    private EvergreenService eService;\n \n     @BeforeEach\n-    void beforeEach() {\n-        evergreenService = new EvergreenService(initializeMockedConfig());\n+    void beforeEach() throws IOException, URISyntaxException, ServiceLoadException {\n+        Path configPath = Paths.get(this.getClass().getResource(\"services.yaml\").toURI());\n+        context = spy(new Context());", "originalCommit": "a2d33c176f3446666fb4e4812c5b56b7487ecd95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTI2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/446#discussion_r490581263", "bodyText": "updated", "author": "fahadmohammed01", "createdAt": "2020-09-17T21:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODIxOQ=="}], "type": "inlineReview"}, {"oid": "e5062b1ec0693dc281d0de624c5ad5a07647f90b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e5062b1ec0693dc281d0de624c5ad5a07647f90b", "message": "addressed comments", "committedDate": "2020-09-17T21:50:43Z", "type": "commit"}, {"oid": "ace700d271d17ff56472c71d1bd9c8f0a3b493d4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ace700d271d17ff56472c71d1bd9c8f0a3b493d4", "message": "Merge branch 'master' into improve-tests", "committedDate": "2020-09-17T22:53:00Z", "type": "commit"}]}