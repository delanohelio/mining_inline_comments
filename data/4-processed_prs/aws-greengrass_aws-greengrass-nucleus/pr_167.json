{"pr_number": 167, "pr_title": "Fix for race condition when service transition from installed to running", "pr_createdAt": "2020-04-08T21:59:00Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167", "timeline": [{"oid": "d915233800c952ec7810d9e0cd60b96141f47e6a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d915233800c952ec7810d9e0cd60b96141f47e6a", "message": "fixed race condition when changing state", "committedDate": "2020-04-08T21:46:48Z", "type": "commit"}, {"oid": "23cea783978267eeb752c09a13ab1a920bec69ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/23cea783978267eeb752c09a13ab1a920bec69ee", "message": "Merge branch 'master' into fix-flaky-tests", "committedDate": "2020-04-08T22:00:42Z", "type": "commit"}, {"oid": "3e18ecc658e21649b144528ade17caa9a7a3fdac", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e18ecc658e21649b144528ade17caa9a7a3fdac", "message": "added more comments", "committedDate": "2020-04-08T22:07:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzEyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405843125", "bodyText": "I don't think we should sync on this. Make a new object to sync on within this method.", "author": "MikeDombo", "createdAt": "2020-04-08T22:07:39Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -98,38 +98,28 @@ public void startup() throws InterruptedException {\n         if (result == RunStatus.Errored) {\n             reportState(State.ERRORED);\n         } else if (result == RunStatus.NothingDone) {\n-            result = run(\"run\", exit -> {\n-                runScript = null;\n-                if (!inShutdown) {\n-                    if (exit == 0) {\n-                        this.requestStop();\n-                        logger.atInfo().setEventType(\"generic-service-stopping\").log(\"Service finished running\");\n-                    } else {\n-                        reportState(State.ERRORED);\n-                        logger.atError().setEventType(\"generic-service-errored\").addKeyValue(\"exitCode\", exit).log();\n-                    }\n-                }\n-            });\n-            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n-                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n-            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n-            if (timeout != null) {\n-                Exec processToClose = currentScript;\n-                context.get(ScheduledExecutorService.class).schedule(() -> {\n-                    if (processToClose.isRunning()) {\n-                        try {\n-                            logger.atWarn(\"service-run-timed-out\")\n-                                    .log(\"Service failed to run within timeout, calling close in process\");\n+            handleRunScript();\n+        }\n+    }\n+\n+    private void handleRunScript() throws InterruptedException {\n+        synchronized (this) {", "originalCommit": "23cea783978267eeb752c09a13ab1a920bec69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0OTIxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405849216", "bodyText": "Changed", "author": "fahadmohammed01", "createdAt": "2020-04-08T22:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzU2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405843564", "bodyText": "What about startup? Don't we need the same fix there?", "author": "MikeDombo", "createdAt": "2020-04-08T22:08:51Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -98,38 +98,28 @@ public void startup() throws InterruptedException {\n         if (result == RunStatus.Errored) {\n             reportState(State.ERRORED);\n         } else if (result == RunStatus.NothingDone) {\n-            result = run(\"run\", exit -> {\n-                runScript = null;\n-                if (!inShutdown) {\n-                    if (exit == 0) {\n-                        this.requestStop();\n-                        logger.atInfo().setEventType(\"generic-service-stopping\").log(\"Service finished running\");\n-                    } else {\n-                        reportState(State.ERRORED);\n-                        logger.atError().setEventType(\"generic-service-errored\").addKeyValue(\"exitCode\", exit).log();\n-                    }\n-                }\n-            });\n-            Topic timeoutTopic = config.find(SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n-                    LIFECYCLE_RUN_NAMESPACE_TOPIC, TIMEOUT_NAMESPACE_TOPIC);\n-            Integer timeout = timeoutTopic == null ? null : (Integer) timeoutTopic.getOnce();\n-            if (timeout != null) {\n-                Exec processToClose = currentScript;\n-                context.get(ScheduledExecutorService.class).schedule(() -> {\n-                    if (processToClose.isRunning()) {\n-                        try {\n-                            logger.atWarn(\"service-run-timed-out\")\n-                                    .log(\"Service failed to run within timeout, calling close in process\");\n+            handleRunScript();", "originalCommit": "23cea783978267eeb752c09a13ab1a920bec69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0OTY0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405849647", "bodyText": "Nope, in startup we don't have this race condition as transitioning to running is handled by the callback.\nThread 1\nservice executes the startup script using thread 2\nThread 2\nOnce startup script finishes the service sets its stage as finished.", "author": "fahadmohammed01", "createdAt": "2020-04-08T22:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0Mzc1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405843754", "bodyText": "make final", "author": "MikeDombo", "createdAt": "2020-04-08T22:09:15Z", "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -98,7 +100,7 @@\n     Consumer<CharSequence> stderr = NOP;\n     private Copier stderrc;\n     private Copier stdoutc;\n-    private boolean closed = false;\n+    private AtomicBoolean isClosed = new AtomicBoolean(false);", "originalCommit": "23cea783978267eeb752c09a13ab1a920bec69ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0OTE5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/167#discussion_r405849192", "bodyText": "yep, PMD is screaming. Updated", "author": "fahadmohammed01", "createdAt": "2020-04-08T22:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0Mzc1NA=="}], "type": "inlineReview"}, {"oid": "84d69686ecfc5a3abe4fca18eb964ab83cc3996a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/84d69686ecfc5a3abe4fca18eb964ab83cc3996a", "message": "fixed PMD violation", "committedDate": "2020-04-08T22:13:16Z", "type": "commit"}, {"oid": "5bd2e689c6d1de601e6e15f924138a36849f8fd0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5bd2e689c6d1de601e6e15f924138a36849f8fd0", "message": "addressed  PR comments", "committedDate": "2020-04-08T22:22:55Z", "type": "commit"}, {"oid": "14a1b154a251a2ca404b39fe342d32aa0ed043fb", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14a1b154a251a2ca404b39fe342d32aa0ed043fb", "message": "Merge branch 'master' into fix-flaky-tests", "committedDate": "2020-04-09T16:53:28Z", "type": "commit"}]}