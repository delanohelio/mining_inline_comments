{"pr_number": 567, "pr_title": "Suspend service lifecycle when config is being merged during deployment", "pr_createdAt": "2020-10-23T19:32:51Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567", "timeline": [{"oid": "8859f82a4e23cbeee04f7f49feb1a5d36da1b555", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8859f82a4e23cbeee04f7f49feb1a5d36da1b555", "message": "Suspend lifecycle when config is being merged.\n\nSo that service won't be started with partially updated config.", "committedDate": "2020-10-23T19:53:03Z", "type": "forcePushed"}, {"oid": "8f7aff7f1fec9a6c9ffe0216c5b7f6f731b31f9d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8f7aff7f1fec9a6c9ffe0216c5b7f6f731b31f9d", "message": "Suspend lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nSuspend lifecycle thread when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-23T19:58:43Z", "type": "forcePushed"}, {"oid": "4b4565f861032e082e2a2f5bad9335a2ab80b88b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4b4565f861032e082e2a2f5bad9335a2ab80b88b", "message": "Suspend lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nSuspend lifecycle thread when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-23T20:33:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjIzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511152235", "bodyText": "Configuration currently updating, will wait for the update to complete", "author": "MikeDombo", "createdAt": "2020-10-23T20:57:58Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCAgent.java", "diffHunk": "@@ -184,6 +185,19 @@ public GetConfigurationResponse getConfig(GetConfigurationRequest request, Conne\n         log.atDebug().kv(CONTEXT_LOGGING_KEY, context).log(\"Config IPC get config request\");\n         String serviceName = request.getComponentName() == null ? context.getServiceName() : request.getComponentName();\n         Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+        if (DeploymentService.CONFIG_UNDER_UPDATE.get()) {\n+            log.info(\"Config is under update. Wait until config updated\");", "originalCommit": "4b4565f861032e082e2a2f5bad9335a2ab80b88b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjY4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511152682", "bodyText": "if interrupted, the thread should quit.", "author": "MikeDombo", "createdAt": "2020-10-23T20:59:06Z", "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCAgent.java", "diffHunk": "@@ -184,6 +185,19 @@ public GetConfigurationResponse getConfig(GetConfigurationRequest request, Conne\n         log.atDebug().kv(CONTEXT_LOGGING_KEY, context).log(\"Config IPC get config request\");\n         String serviceName = request.getComponentName() == null ? context.getServiceName() : request.getComponentName();\n         Topics serviceTopics = kernel.findServiceTopic(serviceName);\n+        if (DeploymentService.CONFIG_UNDER_UPDATE.get()) {\n+            log.info(\"Config is under update. Wait until config updated\");\n+            synchronized (DeploymentService.CONFIG_UPDATE_NOTIFIER) {\n+                while (DeploymentService.CONFIG_UNDER_UPDATE.get()) {\n+                    try {\n+                        DeploymentService.CONFIG_UPDATE_NOTIFIER.wait(5000);\n+                    } catch (InterruptedException e) {\n+                        continue;", "originalCommit": "4b4565f861032e082e2a2f5bad9335a2ab80b88b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1Nzg0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511157847", "bodyText": "This really shouldn't happen, since it's in the middle of kernel responding to service request. It can only be interrupted when kernel is shutdown", "author": "ShirleyZheng92", "createdAt": "2020-10-23T21:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1ODMyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511158322", "bodyText": "Yes, so you should quit. You shouldn't keep the thread alive.", "author": "MikeDombo", "createdAt": "2020-10-23T21:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2ODA4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511168084", "bodyText": "Updated to return InternalError", "author": "ShirleyZheng92", "createdAt": "2020-10-23T21:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511153207", "bodyText": "do you think it is possible to have a more general solution? We ran into an issue with lambda because the updateMap causes lots of update callbacks that run before all the changes have actually gone through, so we read partial data.", "author": "MikeDombo", "createdAt": "2020-10-23T21:00:25Z", "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -72,11 +73,17 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n         // when deployment adds a new dependency (component B) to component A\n         // the config for component B has to be merged in before externalDependenciesTopic of component A trigger\n         // executing mergeMap using publish thread ensures this\n-        kernel.getContext().runOnPublishQueueAndWait(() ->\n-                kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR));\n+        kernel.getContext().runOnPublishQueueAndWait(() -> {\n+            DeploymentService.CONFIG_UNDER_UPDATE.set(true);\n+            kernel.getConfig().updateMap(deploymentDocument.getTimestamp(), newConfig, DEPLOYMENT_MERGE_BEHAVIOR);", "originalCommit": "4b4565f861032e082e2a2f5bad9335a2ab80b88b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2MDU2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511160562", "bodyText": "I think more general solution need some design. There are requirement of listening on specific config topic update(which we are supporting now), but there are also requirement of getting full config during deployment at once (eg: lambda) .  I think with the CR, getConfig() IPC request will return the updated config . Will that help lambda use case?", "author": "ShirleyZheng92", "createdAt": "2020-10-23T21:20:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2MTIyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511161223", "bodyText": "No, lambda is in the kernel, so it doesn't help.", "author": "MikeDombo", "createdAt": "2020-10-23T21:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2NzYyNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511167624", "bodyText": "Do you think moving this global var into Context and have config.getConfig() block on it will be better? I think it's a little risky at this point but probably that can help you.", "author": "ShirleyZheng92", "createdAt": "2020-10-23T21:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2ODQ4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511168489", "bodyText": "No, ideally updateMap wouldn't trigger any updates until it is 100% done. That's my ideal fix for lambda.", "author": "MikeDombo", "createdAt": "2020-10-23T21:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3ODM3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511178370", "bodyText": "Then it need change in Topics class. I'd prefer postpone that optimization for now, it's too risky", "author": "ShirleyZheng92", "createdAt": "2020-10-23T22:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3ODc4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511178782", "bodyText": "Yes, agree", "author": "MikeDombo", "createdAt": "2020-10-23T22:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511153479", "bodyText": "why only these states?", "author": "MikeDombo", "createdAt": "2020-10-23T21:01:07Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java", "diffHunk": "@@ -281,6 +282,17 @@ private void startStateTransition() throws InterruptedException {\n             State current = getState();\n             logger.atDebug(\"service-state-transition-start\").log();\n \n+            // postpone start/install when configuration is under update.\n+            if ((current == State.NEW || current == State.INSTALLED) && DeploymentService.CONFIG_UNDER_UPDATE.get()) {", "originalCommit": "4b4565f861032e082e2a2f5bad9335a2ab80b88b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1NzI3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r511157273", "bodyText": "If service need to stop due to the update, we don't want to suspend stopping service", "author": "ShirleyZheng92", "createdAt": "2020-10-23T21:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzQ3OQ=="}], "type": "inlineReview"}, {"oid": "3b112e2d9cee0050b98880d69596e709e5d716d9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3b112e2d9cee0050b98880d69596e709e5d716d9", "message": "Suspend service lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nPostponse installing/starting when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-23T21:16:05Z", "type": "forcePushed"}, {"oid": "17b5e3281ed70ff7011189d4ad384cf6aa8f2c9f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17b5e3281ed70ff7011189d4ad384cf6aa8f2c9f", "message": "Suspend service lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nPostponse installing/starting when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-23T21:38:26Z", "type": "forcePushed"}, {"oid": "82ba30ad9aecab880b554a249b86c6a194c093a5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/82ba30ad9aecab880b554a249b86c6a194c093a5", "message": "Address comments", "committedDate": "2020-10-23T23:51:54Z", "type": "forcePushed"}, {"oid": "677f1aea155f986c5046d5a6e2d2df153c6ef369", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/677f1aea155f986c5046d5a6e2d2df153c6ef369", "message": "Address comments", "committedDate": "2020-10-26T19:45:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODExNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r512348114", "bodyText": "it isn't clear to me that this is the right place to stop. The requests have already been added to the queue, shouldn't it prevent the requestRestart or whatever at that point instead of here when we are going to do the transition?", "author": "MikeDombo", "createdAt": "2020-10-27T00:34:23Z", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Lifecycle.java", "diffHunk": "@@ -281,6 +282,18 @@ private void startStateTransition() throws InterruptedException {\n             State current = getState();\n             logger.atDebug(\"service-state-transition-start\").log();\n \n+            Configuration kernelConfig = greengrassService.getContext().get(Configuration.class);\n+            // postpone start/install when configuration is under update.\n+            if ((current == State.NEW || current == State.INSTALLED) && kernelConfig.configUnderUpdate.get()) {", "originalCommit": "7c891d96b259127d5793d05c248c944c6ecd6087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0OTEzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r512349133", "bodyText": "That will lead to code duplication. we don't want to halt the process of service being stopped, but want to halt the starting/install process when a service is being started/restarted/installed/re-installed.", "author": "ShirleyZheng92", "createdAt": "2020-10-27T00:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0OTk0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r512349941", "bodyText": "Do we de-dupe restart requests etc?", "author": "MikeDombo", "createdAt": "2020-10-27T00:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM1MTA0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r512351049", "bodyText": "Yes. but restart requests are translated to desiredStates in the queue, and it's lifecycle thread dequeue the desiredStates and perform state transition", "author": "ShirleyZheng92", "createdAt": "2020-10-27T00:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODExNA=="}], "type": "inlineReview"}, {"oid": "7a9cf48d5bc23b1118bba8f720dc359a3dee6379", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a9cf48d5bc23b1118bba8f720dc359a3dee6379", "message": "Suspend service lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nPostponse installing/starting when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-27T19:24:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3ODM5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r513078391", "bodyText": "Why are these public?", "author": "shaguptashaikh", "createdAt": "2020-10-27T22:49:33Z", "path": "src/main/java/com/aws/greengrass/config/Configuration.java", "diffHunk": "@@ -23,13 +23,17 @@\n import java.nio.file.Paths;\n import java.util.Map;\n import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.function.Consumer;\n import javax.annotation.Nullable;\n import javax.inject.Inject;\n \n import static com.aws.greengrass.util.Utils.extension;\n \n public class Configuration {\n+    public final AtomicBoolean configUnderUpdate = new AtomicBoolean(false);", "originalCommit": "b09c7e9bbab79ff842569c71ac69c3fc0392bdf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5MTcyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/567#discussion_r513091722", "bodyText": "So far this need to be accessed by Lifecycle and IPCServerAgent. I can make it private and wrap it with access method.", "author": "ShirleyZheng92", "createdAt": "2020-10-27T23:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3ODM5MQ=="}], "type": "inlineReview"}, {"oid": "27497fecff6bf8c6625101f6587b76212c6dd441", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27497fecff6bf8c6625101f6587b76212c6dd441", "message": "Suspend service lifecycle when config is being merged.\n\nConfiguration is updated asynchronously on each node, this will cause services to start with old config.\nPostponse installing/starting when config is being updated in deployment,\nso that service won't be started with partially updated config.", "committedDate": "2020-10-27T23:58:46Z", "type": "commit"}, {"oid": "33c50de767cdff5061875e30ecfe75b56a96ab71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33c50de767cdff5061875e30ecfe75b56a96ab71", "message": "Address comments", "committedDate": "2020-10-28T00:09:08Z", "type": "commit"}, {"oid": "33c50de767cdff5061875e30ecfe75b56a96ab71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33c50de767cdff5061875e30ecfe75b56a96ab71", "message": "Address comments", "committedDate": "2020-10-28T00:09:08Z", "type": "forcePushed"}, {"oid": "442fc8d2731ee9a735283b2e55feac99ce286fdc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/442fc8d2731ee9a735283b2e55feac99ce286fdc", "message": "Merge branch 'master' into lifecycle_fix", "committedDate": "2020-10-28T00:46:20Z", "type": "commit"}, {"oid": "9dd5b9d624752f644e92e71b05a1f7e3f055a84b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9dd5b9d624752f644e92e71b05a1f7e3f055a84b", "message": "Merge branch 'master' into lifecycle_fix", "committedDate": "2020-10-28T17:11:30Z", "type": "commit"}, {"oid": "4abb84a1b6dd59f9e4e2e87709a508c6e4be135e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4abb84a1b6dd59f9e4e2e87709a508c6e4be135e", "message": "Merge branch 'master' into lifecycle_fix", "committedDate": "2020-10-28T20:22:15Z", "type": "commit"}, {"oid": "ce3642df7770c421cdba3a76310eee53cca4728b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce3642df7770c421cdba3a76310eee53cca4728b", "message": "Merge branch 'master' into lifecycle_fix", "committedDate": "2020-10-28T21:25:41Z", "type": "commit"}]}