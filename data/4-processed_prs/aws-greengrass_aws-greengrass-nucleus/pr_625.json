{"pr_number": 625, "pr_title": "Prevent repeated truncate tlog", "pr_createdAt": "2020-11-05T17:35:18Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/625", "timeline": [{"oid": "73cc916d71a80d3c1fc143de3af1b3c38cfa4b34", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73cc916d71a80d3c1fc143de3af1b3c38cfa4b34", "message": "prevent repeated truncate tlog", "committedDate": "2020-11-05T17:31:22Z", "type": "commit"}, {"oid": "476d4e59b8be99f6b19f7ff520d87cfdcabca085", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/476d4e59b8be99f6b19f7ff520d87cfdcabca085", "message": "Merge branch 'master' into truncate-improvement", "committedDate": "2020-11-05T17:35:25Z", "type": "commit"}, {"oid": "83030e0e84f8c6c42533090149fcb8277a1720dd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/83030e0e84f8c6c42533090149fcb8277a1720dd", "message": "Merge branch 'master' into truncate-improvement", "committedDate": "2020-11-06T17:34:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyNjQ2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/625#discussion_r520926464", "bodyText": "use compareAndSet(false, true) I'm pretty sure that's the right order. It should be the expected value, and then the value to set if it is the expected value.\nOtherwise it still isn't threadsafe the way you've written it.", "author": "MikeDombo", "createdAt": "2020-11-10T22:55:07Z", "path": "src/main/java/com/aws/greengrass/config/ConfigurationWriter.java", "diffHunk": "@@ -170,9 +171,11 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n             flush(out);\n         }\n         long currCount = count.incrementAndGet();\n-        if (autoTruncate && currCount > maxCount && currCount > retryCount) {\n+        if (autoTruncate && currCount > maxCount && currCount > retryCount && !truncateQueued.get()) {", "originalCommit": "83030e0e84f8c6c42533090149fcb8277a1720dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDYwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/625#discussion_r520934600", "bodyText": "Thanks! Yeah it's compareAndSet(expect, update)", "author": "tilo-chen", "createdAt": "2020-11-10T23:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyNjQ2NA=="}], "type": "inlineReview"}, {"oid": "fa8d3ce2e6edc29325c9a6bfffcde330af5d21f7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa8d3ce2e6edc29325c9a6bfffcde330af5d21f7", "message": "use atomic var properly", "committedDate": "2020-11-10T23:33:30Z", "type": "commit"}, {"oid": "8a7e2cf31477efc6cc22bf209148df224b5d753c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a7e2cf31477efc6cc22bf209148df224b5d753c", "message": "Merge branch 'master' into truncate-improvement", "committedDate": "2020-11-10T23:33:40Z", "type": "commit"}, {"oid": "5436f95e5f4b70be4310e35bd8d9cba0ad376ddd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5436f95e5f4b70be4310e35bd8d9cba0ad376ddd", "message": "Merge branch 'master' into truncate-improvement", "committedDate": "2020-11-11T19:36:50Z", "type": "commit"}, {"oid": "eee54013c3dd0e69d78bef9b70d793ce8b9ab7c5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eee54013c3dd0e69d78bef9b70d793ce8b9ab7c5", "message": "Merge branch 'master' into truncate-improvement", "committedDate": "2020-11-11T20:24:04Z", "type": "commit"}]}