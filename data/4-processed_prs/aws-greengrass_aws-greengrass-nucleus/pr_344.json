{"pr_number": 344, "pr_title": "Set credential provider to be TES instead of environment credentials", "pr_createdAt": "2020-08-01T05:15:17Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344", "timeline": [{"oid": "d2b46635c6332b1139f24f53853addc3a0a062bf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d2b46635c6332b1139f24f53853addc3a0a062bf", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T05:30:59Z", "type": "forcePushed"}, {"oid": "236a3f3c526423a3308aee4b8b42eca175492a20", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/236a3f3c526423a3308aee4b8b42eca175492a20", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T05:56:06Z", "type": "forcePushed"}, {"oid": "fb8347fa1af22168594f877c3eb93d7d16fb5c16", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb8347fa1af22168594f877c3eb93d7d16fb5c16", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T06:26:43Z", "type": "forcePushed"}, {"oid": "260988fe024a755714ca923cc0cee84b2ba0cca4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/260988fe024a755714ca923cc0cee84b2ba0cca4", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T19:54:42Z", "type": "forcePushed"}, {"oid": "7f811f547178a8ce3ab3bd199288a3166cb916f5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7f811f547178a8ce3ab3bd199288a3166cb916f5", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T20:03:09Z", "type": "forcePushed"}, {"oid": "8dce249e895798a12b5d0656f07525fbc2de3b32", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8dce249e895798a12b5d0656f07525fbc2de3b32", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T20:22:58Z", "type": "forcePushed"}, {"oid": "759550e5183538c419efeb0e334229c26f9fdebf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/759550e5183538c419efeb0e334229c26f9fdebf", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T22:07:06Z", "type": "forcePushed"}, {"oid": "88024e107c2a55dbcb9a8eee5b3ce33c280cbfc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/88024e107c2a55dbcb9a8eee5b3ce33c280cbfc0", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T22:08:06Z", "type": "forcePushed"}, {"oid": "57bab11e112491536fa017230ad02461cb2eb1fd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57bab11e112491536fa017230ad02461cb2eb1fd", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T22:46:08Z", "type": "forcePushed"}, {"oid": "aa9e0861bd704aa6d60b487044c5062059ec202d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa9e0861bd704aa6d60b487044c5062059ec202d", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:04:29Z", "type": "forcePushed"}, {"oid": "2a8785235cd06aca1f965b9a7a4c44496cb50f57", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2a8785235cd06aca1f965b9a7a4c44496cb50f57", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:09:33Z", "type": "forcePushed"}, {"oid": "0aa0e9e318d8094d3bc23f1e3affe9138ffeb43e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0aa0e9e318d8094d3bc23f1e3affe9138ffeb43e", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:18:12Z", "type": "forcePushed"}, {"oid": "6ab3ac996566a7b9353a8b1cac503098e4a77123", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6ab3ac996566a7b9353a8b1cac503098e4a77123", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:27:19Z", "type": "forcePushed"}, {"oid": "53047c5921cedb82b2e4003f21f657bce3eb14b3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53047c5921cedb82b2e4003f21f657bce3eb14b3", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:36:52Z", "type": "forcePushed"}, {"oid": "4ee744531beb208c8b6c8a1b2b0c070ad8241b0c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ee744531beb208c8b6c8a1b2b0c070ad8241b0c", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:46:14Z", "type": "forcePushed"}, {"oid": "8acdc11bf6de51705952a6fddb7f1af8841115bf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8acdc11bf6de51705952a6fddb7f1af8841115bf", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-01T23:53:49Z", "type": "forcePushed"}, {"oid": "5b5026704559ab15bef52c18133ca63107434c44", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b5026704559ab15bef52c18133ca63107434c44", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-02T00:25:09Z", "type": "forcePushed"}, {"oid": "84b259e3670e81bbde7d6fba27589f62fc64c169", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/84b259e3670e81bbde7d6fba27589f62fc64c169", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-02T00:44:40Z", "type": "forcePushed"}, {"oid": "ae85de7b2e85449479544c115910d2f25909323a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ae85de7b2e85449479544c115910d2f25909323a", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-02T00:52:39Z", "type": "forcePushed"}, {"oid": "6d5c9fa0728c59283c5f2c35622ccc1de237717e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6d5c9fa0728c59283c5f2c35622ccc1de237717e", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-02T01:20:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTQ4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464585488", "bodyText": "Can we have these in postInject?", "author": "youtuyy", "createdAt": "2020-08-03T18:21:27Z", "path": "src/main/java/com/aws/iot/evergreen/tes/TokenExchangeService.java", "diffHunk": "@@ -55,15 +55,16 @@ public TokenExchangeService(Topics topics,\n                                 CredentialRequestHandler credentialRequestHandler,\n                                 AuthorizationHandler authZHandler) {\n         super(topics);\n-        // TODO: Add support for other params like role Aliases\n         topics.lookup(PARAMETERS_CONFIG_KEY, PORT_TOPIC)\n                 .dflt(DEFAULT_PORT)\n                 .subscribe((why, newv) ->\n                         port = Coerce.toInt(newv));\n \n         topics.lookup(PARAMETERS_CONFIG_KEY, IOT_ROLE_ALIAS_TOPIC)", "originalCommit": "6d5c9fa0728c59283c5f2c35622ccc1de237717e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTk0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464585942", "bodyText": "I think it could be, but why move it?", "author": "MikeDombo", "createdAt": "2020-08-03T18:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MTQ0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464591447", "bodyText": "It doesn't seem make a difference. Actually I was thinking we might want validateConfig() here", "author": "youtuyy", "createdAt": "2020-08-03T18:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MzE2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464593163", "bodyText": "We can't validate in the constructor because that may cause the construction to fail which we really don't want. It will still validate when TES is actually started.", "author": "MikeDombo", "createdAt": "2020-08-03T18:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5NTYyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464595623", "bodyText": "ok i see", "author": "youtuyy", "createdAt": "2020-08-03T18:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NTQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NjUyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464586526", "bodyText": "Who is calling this method? Why do we need to implement com.amazonaws.auth.AWSCredentialsProvider?", "author": "fengwang666", "createdAt": "2020-08-03T18:23:38Z", "path": "src/main/java/com/aws/iot/evergreen/tes/LazyCredentialProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.amazonaws.auth.AWSCredentials;\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.auth.BasicSessionCredentials;\n+import com.aws.iot.evergreen.dependency.Context;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+\n+import javax.inject.Inject;\n+\n+public class LazyCredentialProvider implements AWSCredentialsProvider, AwsCredentialsProvider {\n+\n+    private final Context context;\n+\n+    @Inject\n+    public LazyCredentialProvider(Context context) {\n+        this.context = context;\n+    }\n+\n+    @Override\n+    public AwsCredentials resolveCredentials() {\n+        return context.get(TokenExchangeService.class).resolveCredentials();\n+    }\n+\n+    @Override\n+    public AWSCredentials getCredentials() {", "originalCommit": "6d5c9fa0728c59283c5f2c35622ccc1de237717e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4OTg1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464589859", "bodyText": "The SDK calls it. We implement the interface so that the SDK can get credentials using TES", "author": "MikeDombo", "createdAt": "2020-08-03T18:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NjUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NzU3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464587570", "bodyText": "not implemented? Should it throw an exception if it's not intended to be called.", "author": "fengwang666", "createdAt": "2020-08-03T18:25:37Z", "path": "src/main/java/com/aws/iot/evergreen/tes/LazyCredentialProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.amazonaws.auth.AWSCredentials;\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.auth.BasicSessionCredentials;\n+import com.aws.iot.evergreen.dependency.Context;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+\n+import javax.inject.Inject;\n+\n+public class LazyCredentialProvider implements AWSCredentialsProvider, AwsCredentialsProvider {\n+\n+    private final Context context;\n+\n+    @Inject\n+    public LazyCredentialProvider(Context context) {\n+        this.context = context;\n+    }\n+\n+    @Override\n+    public AwsCredentials resolveCredentials() {\n+        return context.get(TokenExchangeService.class).resolveCredentials();\n+    }\n+\n+    @Override\n+    public AWSCredentials getCredentials() {\n+        AwsSessionCredentials credentials = (AwsSessionCredentials) resolveCredentials();\n+        return new BasicSessionCredentials(credentials.accessKeyId(), credentials.secretAccessKey(),\n+                credentials.sessionToken());\n+    }\n+\n+    @Override\n+    public void refresh() {", "originalCommit": "6d5c9fa0728c59283c5f2c35622ccc1de237717e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MDE1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464590152", "bodyText": "The SDK might call it, so I don't want to throw. But it doesn't need to be called; there's no need to force any refreshes, so I don't think it needs an implementation.", "author": "MikeDombo", "createdAt": "2020-08-03T18:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4NzU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4ODk4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464588986", "bodyText": "Why throw an AssertionError?", "author": "fengwang666", "createdAt": "2020-08-03T18:28:27Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/IotJobsUtils.java", "diffHunk": "@@ -59,8 +58,14 @@ public static void waitForJobExecutionStatusToSatisfy(IotClient client, String j\n                 status = client.describeJobExecution(\n                         DescribeJobExecutionRequest.builder().jobId(jobId).thingName(thingName).build()).execution()\n                         .status();\n-                if (condition.test(status)) {\n-                    return;\n+                // All statuses after and including SUCCEEDED are terminal, so they won't ever change\n+                // which means we can stop querying\n+                if (JobExecutionStatus.SUCCEEDED.ordinal() <= status.ordinal() || condition.test(status)) {\n+                    if (condition.test(status)) {\n+                        return;\n+                    }\n+                } else if (JobExecutionStatus.SUCCEEDED.ordinal() <= status.ordinal()) {\n+                    throw new AssertionError(\"Job ended in state: \" + status);", "originalCommit": "6d5c9fa0728c59283c5f2c35622ccc1de237717e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MDU0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464590540", "bodyText": "Because this is a test utility and the condition wasn't met. Originally it would throw a timeout exception, but that isn't really clear IMO.", "author": "MikeDombo", "createdAt": "2020-08-03T18:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4ODk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MTA4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/344#discussion_r464591084", "bodyText": "Basically this change means that if the test will fail, it can fail up to 20 minutes faster which is much better.", "author": "MikeDombo", "createdAt": "2020-08-03T18:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4ODk4Ng=="}], "type": "inlineReview"}, {"oid": "876d9576072b9765c6672dd7895287b3dcf70693", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/876d9576072b9765c6672dd7895287b3dcf70693", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-03T18:42:41Z", "type": "commit"}, {"oid": "876d9576072b9765c6672dd7895287b3dcf70693", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/876d9576072b9765c6672dd7895287b3dcf70693", "message": "Set credential provider to be TES instead of environment credentials", "committedDate": "2020-08-03T18:42:41Z", "type": "forcePushed"}]}