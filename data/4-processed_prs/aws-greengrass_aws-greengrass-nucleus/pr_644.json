{"pr_number": 644, "pr_title": "support Node type change in merge configuration Topics", "pr_createdAt": "2020-11-09T18:37:23Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzMzI4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520033281", "bodyText": "why is the value null? Why wouldn't this save the new value?", "author": "MikeDombo", "createdAt": "2020-11-09T18:40:07Z", "path": "src/main/java/com/aws/greengrass/config/ConfigurationWriter.java", "diffHunk": "@@ -152,6 +152,8 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n             tlogline = new Tlogline(t.getModtime(), t.path(), WhatHappened.changed, t.getOnce());\n         } else if (what == WhatHappened.childRemoved) {\n             tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.removed, null);\n+        } else if (what == WhatHappened.nodeTypeChanged) {\n+            tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.nodeTypeChanged, null);", "originalCommit": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5MTkwNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520091906", "bodyText": "Functionally nodeTypeChanged is same as removed. I'll remove the nodeTypeChanged type", "author": "ShirleyZheng92", "createdAt": "2020-11-09T20:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzMzI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNDc0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520034747", "bodyText": "without your change, does this test fail with the error that nodes cannot change type?", "author": "MikeDombo", "createdAt": "2020-11-09T18:42:34Z", "path": "src/test/java/com/aws/greengrass/config/ConfigurationTest.java", "diffHunk": "@@ -637,6 +637,101 @@ void GIVEN_config_update_WHEN_merge_update_interleave_THEN_expect_merge_correct(\n         assertEquals(now, config.findNode(\"nodeToBeMerged\", \"key3\").modtime);\n     }\n \n+\n+    @Test\n+    void GIVEN_config_update_WHEN_node_type_change_THEN_expect_merge_correct() throws Exception {", "originalCommit": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5MjcyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520092722", "bodyText": "Yes, since the UpdateBehaviorTree is using Merge not Replace. Without the change, merge will fail. My change basically makes merge has the same behavior as replace when node type changes", "author": "ShirleyZheng92", "createdAt": "2020-11-09T20:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNDc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNTgxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520035816", "bodyText": "The what here is only from childChanged so if your child changed doesn't propagate this what type, then this is useless.", "author": "MikeDombo", "createdAt": "2020-11-09T18:44:26Z", "path": "src/main/java/com/aws/greengrass/config/ConfigurationWriter.java", "diffHunk": "@@ -152,6 +152,8 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n             tlogline = new Tlogline(t.getModtime(), t.path(), WhatHappened.changed, t.getOnce());\n         } else if (what == WhatHappened.childRemoved) {\n             tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.removed, null);\n+        } else if (what == WhatHappened.nodeTypeChanged) {", "originalCommit": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNjM1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520036358", "bodyText": "Why do we need a new type? You were modeling this before as a remove and then an add, so what does this type do differently when it seems that you're just removing it on L77.", "author": "MikeDombo", "createdAt": "2020-11-09T18:45:18Z", "path": "src/main/java/com/aws/greengrass/config/ConfigurationReader.java", "diffHunk": "@@ -62,6 +62,19 @@ public static void mergeTLogInto(Configuration config, Reader reader, boolean fo\n                         } else {\n                             n.remove(tlogline.timestamp);\n                         }\n+                    } else if (WhatHappened.nodeTypeChanged.equals(tlogline.action)) {", "originalCommit": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5MTU2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520091563", "bodyText": "Functionally it's the same. Yeah I can remove the nodeTypeChanged type.", "author": "ShirleyZheng92", "createdAt": "2020-11-09T20:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNjM1OA=="}], "type": "inlineReview"}, {"oid": "6cb6974ccb512030a8416319919f93a4144a19e4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6cb6974ccb512030a8416319919f93a4144a19e4", "message": "Support node type change in merge topics\n\nSupport node type change in merge topics", "committedDate": "2020-11-09T20:41:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNzA3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520137078", "bodyText": "Since this branch is removed, the original mergeChild code path will go to line 311-314. Is that the correct behavior? Should mergeChild also remove the previous child (line311)?", "author": "fengwang666", "createdAt": "2020-11-09T21:39:17Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,28 +281,6 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);", "originalCommit": "d67a1be0293fa0521d6cf4545c932805bb67a9f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1Mjk3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520852977", "bodyText": "Discussed offline. it's the leafNode->containerNode change. If not removing then the updated value cannot merge in", "author": "ShirleyZheng92", "createdAt": "2020-11-10T20:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNzA3OA=="}], "type": "inlineReview"}, {"oid": "2df740880ec08e3fab0ee8a1b03c8ebaf848268e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2df740880ec08e3fab0ee8a1b03c8ebaf848268e", "message": "Add documentation", "committedDate": "2020-11-09T22:55:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMTQxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520831414", "bodyText": "why? If you're adding an interior node, then we want that event!", "author": "MikeDombo", "createdAt": "2020-11-10T19:47:29Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,55 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n-                remove(existingChild);\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n+                // not calling remove() to avoid WhatHappened.removed event\n+                if (!children.remove(new CaseInsensitiveString(existingChild.getName()), existingChild)) {\n+                    logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n+                            .kv(\"childNode\", existingChild.getName())\n+                            .log();\n+                    return;\n+                }\n+                context.runOnPublishQueue(() -> {\n+                    this.childChanged(WhatHappened.childRemoved, existingChild);\n+                });\n+                // not calling createInteriorChild() to avoid WhatHappened.interiorAdded event", "originalCommit": "77ced0918c8d6cd698c9f7159041864b97c487ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0MDI0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520840241", "bodyText": "Ok I thought it wrong. Will use createInteriorChild(0", "author": "ShirleyZheng92", "createdAt": "2020-11-10T20:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMTQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMzEwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520833108", "bodyText": "I don't understand why this logic just got so much more complicated than yesterday. Why so many changes to just copy over the watchers list?", "author": "MikeDombo", "createdAt": "2020-11-10T19:50:16Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,55 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n-                remove(existingChild);\n+            // if existing child is a container node", "originalCommit": "77ced0918c8d6cd698c9f7159041864b97c487ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzOTUzNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520839537", "bodyText": "Basically this just to remove node without invoking remove event on this node's listener. However we still need to have the 'childRemoved' event fire to parent nodes so that ConfigurationWriter knows this node is removed.", "author": "ShirleyZheng92", "createdAt": "2020-11-10T20:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMzEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0Mjk1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520842959", "bodyText": "I don't think that helps anyone. In pretty much all cases, we subscribe to topics and not a topic (or certainly not a topic which might turn into a topics). So ignoring the remove event doesn't help anything and just makes all this far more complicated.", "author": "MikeDombo", "createdAt": "2020-11-10T20:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMzEwOA=="}], "type": "inlineReview"}, {"oid": "5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "message": "Address comments. Copy subscribers over to new node", "committedDate": "2020-11-10T20:18:07Z", "type": "forcePushed"}, {"oid": "14204761b517722de38b3ca3e10e03f30e112b11", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14204761b517722de38b3ca3e10e03f30e112b11", "message": "Support node type change in merge topics\n\nSupport node type change in merge topics", "committedDate": "2020-11-10T20:27:28Z", "type": "commit"}, {"oid": "ce3aa87da3a8a8ce9edc2addff2cefd4beb3acf0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce3aa87da3a8a8ce9edc2addff2cefd4beb3acf0", "message": "Add documentation", "committedDate": "2020-11-10T20:27:28Z", "type": "commit"}, {"oid": "26869275513fbe64d83d3ca495ce9dca04be0f57", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/26869275513fbe64d83d3ca495ce9dca04be0f57", "message": "Address comments. Copy subscribers over to new node", "committedDate": "2020-11-10T20:32:29Z", "type": "forcePushed"}, {"oid": "6818262f066c56b25929d369ba87be5df363c1b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6818262f066c56b25929d369ba87be5df363c1b7", "message": "Address comments. Copy subscribers over to new node", "committedDate": "2020-11-10T20:41:02Z", "type": "commit"}, {"oid": "6818262f066c56b25929d369ba87be5df363c1b7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6818262f066c56b25929d369ba87be5df363c1b7", "message": "Address comments. Copy subscribers over to new node", "committedDate": "2020-11-10T20:41:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTIxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520881218", "bodyText": "nit\nformatting", "author": "MikeDombo", "createdAt": "2020-11-10T21:21:19Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,32 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n                 remove(existingChild);\n+                Topics newNode = createInteriorChild(key);\n+                for (Watcher watcher: existingChild.watchers) {", "originalCommit": "6818262f066c56b25929d369ba87be5df363c1b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTM1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520881359", "bodyText": "formatting", "author": "MikeDombo", "createdAt": "2020-11-10T21:21:36Z", "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,32 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n                 remove(existingChild);\n+                Topics newNode = createInteriorChild(key);\n+                for (Watcher watcher: existingChild.watchers) {\n+                    newNode.addWatcher(watcher);\n+                }\n+                newNode.updateFromMap((Map) value, childMergeBehavior);\n             }\n-            createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n         // if new node is a leaf node\n         } else {\n-            // if existing child is a container node\n-            if (existingChild != null && !(existingChild instanceof Topic)) {\n+            if (existingChild == null || existingChild instanceof Topic) {\n+                createLeafChild(key).withNewerValue(childMergeBehavior.getTimestampToUse(), value, false, true);\n+            } else {\n                 remove(existingChild);\n+                Topic newNode = createLeafChild(key);\n+                for (Watcher watcher: existingChild.watchers) {", "originalCommit": "6818262f066c56b25929d369ba87be5df363c1b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f741945e213d30441416b45b0405bebddb0bdf48", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f741945e213d30441416b45b0405bebddb0bdf48", "message": "Merge branch 'master' of https://github.com/aws/aws-greengrass-kernel into nodeTypeChange", "committedDate": "2020-11-10T22:12:36Z", "type": "commit"}, {"oid": "fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "message": "Address comments", "committedDate": "2020-11-10T22:14:12Z", "type": "commit"}, {"oid": "fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "message": "Address comments", "committedDate": "2020-11-10T22:14:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkwNzk0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520907940", "bodyText": "Thanks for updating this!", "author": "fengwang666", "createdAt": "2020-11-10T22:14:10Z", "path": "CONFIGURE_COMPONENT_README.md", "diffHunk": "@@ -121,6 +121,13 @@ At every level,\n 2. If a key doesn't exist, then key-value pair that is merging in will be added. Note a key that is not existed in the default value,\n could also be added.\n \n+#### 2.3.3 MERGE - The change between a 'leaf' node and a 'container node'\n+1. If a config node has children, it's a 'container' node.\n+1. If a config node has value while not having children, it's a 'leaf' node.\n+1. If during a MERGE, a node type changed between 'leaf' and 'container', the old node will be removed and new node will be created.\n+ Subscribers of the old node will be copied over to new node.\n+ Parent node subscribers will be notified of 'childRemoved' event.\n+", "originalCommit": "f0565f8afcef5421b41fb026942ffcd2c3e2baaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}