{"pr_number": 655, "pr_title": "Move ACL to a nested config style", "pr_createdAt": "2020-11-11T01:56:04Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655", "timeline": [{"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "message": "Move ACL to a nested config style", "committedDate": "2020-11-11T01:53:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNTAxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521015013", "bodyText": "noice, much cleaner now.", "author": "MikeDombo", "createdAt": "2020-11-11T01:57:47Z", "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/ipc/pubsub.yaml", "diffHunk": "@@ -11,23 +11,16 @@ services:\n   PublishNotSubscribe:\n     parameters:\n       accessControl:\n-        '{\n-          \"aws.greengrass.ipc.pubsub\":[\n-          {\n-            \"policyId1\":{\n-              \"policyDescription\":\"access to pubsub topics for mqtt\",\n-              \"operations\":[\n-                \"aws.greengrass#PublishToTopic\"\n-              ],\n-              \"resources\":[\n-                \"/topic/1/#\",\n-                \"/longer/topic/example/\",\n-                \"*\"\n-              ]\n-            }\n-          }\n-          ]\n-        }'\n+        aws.greengrass.ipc.pubsub:", "originalCommit": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNjAzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521016033", "bodyText": "why not use the lombok to string?", "author": "MikeDombo", "createdAt": "2020-11-11T01:59:14Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicy.java", "diffHunk": "@@ -5,42 +5,36 @@\n \n package com.aws.greengrass.authorization;\n \n+import lombok.AllArgsConstructor;\n import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n import lombok.NonNull;\n-import lombok.Value;\n \n import java.util.Set;\n \n-@Value\n-@Builder\n+/**\n+ * Class that holds full access control policy which translates to {@link Permission}.\n+ */\n+@Builder(toBuilder = true)\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n public class AuthorizationPolicy implements Comparable<AuthorizationPolicy> {\n     @NonNull String policyId;\n     String policyDescription;\n     @NonNull Set<String> principals;\n     @NonNull Set<String> operations;\n     Set<String> resources;\n \n-    enum PolicyComponentTypes {\n-        POLICY_DESCRIPTION(\"policyDescription\"),\n-        PRINCIPALS(\"principals\"),\n-        OPERATIONS(\"operations\"),\n-        RESOURCES(\"resources\"),\n-        UNKNOWN(\"unknown\");\n-\n-        private final String name;\n-\n-        PolicyComponentTypes(String s) {\n-            name = s;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return this.name;\n-        }\n-    }\n-\n     @Override\n     public int compareTo(AuthorizationPolicy other) {\n         return this.policyId.compareTo(other.policyId);\n     }\n+\n+    @Override\n+    public String toString() {", "originalCommit": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzODk0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521038945", "bodyText": "I was thinking to mask some stuff initially, dont need it now.", "author": "prateek-y", "createdAt": "2020-11-11T02:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNjAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzI3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017275", "bodyText": "Why have this? Seems like it is going to be noisy when we have debug logs.", "author": "MikeDombo", "createdAt": "2020-11-11T02:00:59Z", "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -211,6 +211,10 @@ void doAuthorization(String opName, String serviceName, String topic) throws Aut\n \n         for (String topicFilter : authorizedResources) {\n             if (topicFilter.equals(ANY_REGEX) || MqttTopic.topicIsSupersetOf(topicFilter, topic)) {\n+                LOGGER.atDebug().log(\"Hit policy with principal {}, operation {}, resource {}\",", "originalCommit": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzODUxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521038513", "bodyText": "you are right. Need some kind of throttled logs here. probably at trace.", "author": "prateek-y", "createdAt": "2020-11-11T02:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzYxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017610", "bodyText": "secret manager should be capitalized SecretsManager", "author": "MikeDombo", "createdAt": "2020-11-11T02:01:25Z", "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationPolicyParserTest.java", "diffHunk": "@@ -44,6 +45,7 @@\n @ExtendWith({MockitoExtension.class, GGExtension.class})\n class AuthorizationPolicyParserTest {\n \n+    private final static String SECRET_SERVICE = \"aws.greengrass.secretsManager\";", "originalCommit": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzOTE5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521039193", "bodyText": "just a component string here, could be \"abcd\". actually i should rename it to random.", "author": "prateek-y", "createdAt": "2020-11-11T02:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzYxMA=="}], "type": "inlineReview"}, {"oid": "ac053daa4f865c615e1f7ffaf309b1cb6c5c6b98", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ac053daa4f865c615e1f7ffaf309b1cb6c5c6b98", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-11T02:07:43Z", "type": "commit"}, {"oid": "8e20399840eb5f7accc3bc07e59a712968f5c456", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e20399840eb5f7accc3bc07e59a712968f5c456", "message": "Move ACL to a nested config style", "committedDate": "2020-11-11T02:19:01Z", "type": "commit"}, {"oid": "2bc13a5aed528378ac210b635e2ed0c57b580157", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2bc13a5aed528378ac210b635e2ed0c57b580157", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-11T21:40:03Z", "type": "commit"}, {"oid": "dfa6196bd121e97f0b1fd656096d1905fe65c6c9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dfa6196bd121e97f0b1fd656096d1905fe65c6c9", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-11T22:06:26Z", "type": "commit"}, {"oid": "045045b303ae3c6b59711f70d8fd11161bd2528b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/045045b303ae3c6b59711f70d8fd11161bd2528b", "message": "Fix some integ tests", "committedDate": "2020-11-12T07:50:26Z", "type": "commit"}, {"oid": "b4a50d014b0af3b4ee0a1abe19bd6f71b720c181", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4a50d014b0af3b4ee0a1abe19bd6f71b720c181", "message": "PR feedback", "committedDate": "2020-11-12T07:54:30Z", "type": "commit"}, {"oid": "7352142cc17aa6276280148cd350ec6430dc9625", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7352142cc17aa6276280148cd350ec6430dc9625", "message": "Remove mapper properties", "committedDate": "2020-11-12T08:31:48Z", "type": "commit"}, {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43f05bdb4e485814ded39d580544bbe5dc9338d7", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-12T23:33:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjA3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592076", "bodyText": "check for what is timestampUpdated or interiorAdded those 2 event types you can safely ignore to save on re-parsing effort.", "author": "MikeDombo", "createdAt": "2020-11-13T03:33:17Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -92,8 +91,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n             this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), false);\n         }\n \n-        //Subscribe to future auth config updates\n-        this.kernel.getConfig().getRoot().subscribe(\n+        // Subscribe to future auth config updates\n+        this.kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC).subscribe(\n                 (why, newv) -> {\n                     if (newv == null) {", "originalCommit": "43f05bdb4e485814ded39d580544bbe5dc9338d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwOTcyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r523209727", "bodyText": "added", "author": "prateek-y", "createdAt": "2020-11-13T20:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjE5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592196", "bodyText": "why remove case insensitive properties? We should be lenient IMO", "author": "MikeDombo", "createdAt": "2020-11-13T03:33:53Z", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicyParser.java", "diffHunk": "@@ -5,41 +5,33 @@\n \n package com.aws.greengrass.authorization;\n \n-import com.aws.greengrass.authorization.AuthorizationPolicy.PolicyComponentTypes;\n import com.aws.greengrass.config.Node;\n import com.aws.greengrass.config.Topic;\n import com.aws.greengrass.config.Topics;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n-import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.Utils;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.core.type.TypeReference;\n-import com.fasterxml.jackson.databind.MapperFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.json.JsonMapper;\n \n import java.util.ArrayList;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import static com.aws.greengrass.componentmanager.KernelConfigResolver.PARAMETERS_CONFIG_KEY;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.ACCESS_CONTROL_NAMESPACE_TOPIC;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.SERVICES_NAMESPACE_TOPIC;\n-import static com.aws.greengrass.util.Coerce.toEnum;\n \n public final class AuthorizationPolicyParser {\n     private static final Logger logger = LogManager.getLogger(AuthorizationPolicyParser.class);\n-    private static final ObjectMapper OBJECT_MAPPER =\n-            JsonMapper.builder().configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true).build();\n+    private static final ObjectMapper OBJECT_MAPPER = JsonMapper.builder().build();", "originalCommit": "43f05bdb4e485814ded39d580544bbe5dc9338d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwOTY0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r523209646", "bodyText": "retained", "author": "prateek-y", "createdAt": "2020-11-13T20:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjE5Ng=="}], "type": "inlineReview"}, {"oid": "90800418bb9439b20158e0cd037cda32c98e68d9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/90800418bb9439b20158e0cd037cda32c98e68d9", "message": "More feedback", "committedDate": "2020-11-13T19:54:48Z", "type": "commit"}, {"oid": "ccb987b0c8b5bd40aac069555b0e0cb3d2e090ce", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ccb987b0c8b5bd40aac069555b0e0cb3d2e090ce", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-13T20:00:03Z", "type": "commit"}, {"oid": "cd3c5cdcc44b10c41c0c73a745931b9226588e23", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cd3c5cdcc44b10c41c0c73a745931b9226588e23", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-13T20:02:46Z", "type": "commit"}, {"oid": "d02e76bff1cb35d1108134d5d563bd07ed191504", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d02e76bff1cb35d1108134d5d563bd07ed191504", "message": "update logging", "committedDate": "2020-11-13T20:06:30Z", "type": "commit"}, {"oid": "ed2a1122c2d352fe0de8767af65332c4a824d986", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed2a1122c2d352fe0de8767af65332c4a824d986", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-13T21:16:46Z", "type": "commit"}, {"oid": "40d62b02f6a80569bc331b5c218ada640d027de1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40d62b02f6a80569bc331b5c218ada640d027de1", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-13T23:00:31Z", "type": "commit"}, {"oid": "0cb25bcb4017ad013225e8119788905115219cad", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0cb25bcb4017ad013225e8119788905115219cad", "message": "Merge branch 'master' into ACL_config", "committedDate": "2020-11-16T01:45:08Z", "type": "commit"}]}