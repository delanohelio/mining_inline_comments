{"pr_number": 288, "pr_title": "Use x509CredentialsProvider to fetch credentials", "pr_createdAt": "2020-06-24T00:23:25Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288", "timeline": [{"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f12132ecb88d3508b1d86ba3087b3c1324423d47", "message": "Use x509CredentialsProvider to fetch credentials", "committedDate": "2020-06-23T23:41:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5NDA3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r444594075", "bodyText": "Instead of passing a wrong date, can we just skip sending expiration at all?", "author": "MikeDombo", "createdAt": "2020-06-24T01:28:50Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;\n+    }\n+\n+    /**\n+     * To fetch expiry.\n+     * @return Expiration date of the credential\n+     * @throws AWSIotException when fetching expiration fails\n+     */\n+    public Date getCredentialsExpiration() throws AWSIotException {", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1Nzg4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445157885", "bodyText": "We would need to test if that would break the SDK, but i think it would.", "author": "prateek-y", "createdAt": "2020-06-24T20:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5NDA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1OTM0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445059341", "bodyText": "this also needs to be reconfigurable if the device configuration changes.", "author": "MikeDombo", "createdAt": "2020-06-24T17:34:34Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1OTgzOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445059838", "bodyText": "Please change the DEFAULT_PORT above to be 0 so that it randomly chooses a port. This will allow us to run more than 1 evergreen on a device.", "author": "MikeDombo", "createdAt": "2020-06-24T17:35:28Z", "path": "src/main/java/com/aws/iot/evergreen/tes/TokenExchangeService.java", "diffHunk": "@@ -27,16 +27,16 @@\n     private String iotRoleAlias;", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1OTUwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445159509", "bodyText": "Nit: Lets just strip DOWNSTREAM from variables now.", "author": "prateek-y", "createdAt": "2020-06-24T20:42:07Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -6,50 +6,42 @@\n import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.DeserializationFeature;\n-import com.fasterxml.jackson.databind.JsonNode;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.sun.net.httpserver.HttpExchange;\n import com.sun.net.httpserver.HttpHandler;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n \n import java.io.IOException;\n import java.net.HttpURLConnection;\n+import java.nio.charset.StandardCharsets;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n import java.util.HashMap;\n+import java.util.Locale;\n import java.util.Map;\n \n public class CredentialRequestHandler implements HttpHandler {\n     private static final Logger LOGGER = LogManager.getLogger(CredentialRequestHandler.class);\n     public static final String IOT_CREDENTIALS_HTTP_VERB = \"GET\";\n-    private static final String CREDENTIALS_UPSTREAM_STR = \"credentials\";\n-    private static final String ACCESS_KEY_UPSTREAM_STR = \"accessKeyId\";\n     private static final String ACCESS_KEY_DOWNSTREAM_STR = \"AccessKeyId\";\n-    private static final String SECRET_ACCESS_UPSTREAM_STR = \"secretAccessKey\";\n     private static final String SECRET_ACCESS_DOWNSTREAM_STR = \"SecretAccessKey\";", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MDcxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445160717", "bodyText": "You need to update the logger class?", "author": "prateek-y", "createdAt": "2020-06-24T20:44:20Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MTMxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445161318", "bodyText": "Do you also need to validate if credentials is not null before returning?", "author": "prateek-y", "createdAt": "2020-06-24T20:45:29Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;", "originalCommit": "f12132ecb88d3508b1d86ba3087b3c1324423d47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MDE0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445740143", "bodyText": "We need to think about the error behavior for this library now, especially when network is not available, what kind of errors do we get.", "author": "prateek-y", "createdAt": "2020-06-25T18:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MTMxOA=="}], "type": "inlineReview"}, {"oid": "0740f298896d023407c1e6238d70d8b9c54f74d0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0740f298896d023407c1e6238d70d8b9c54f74d0", "message": "Address comments", "committedDate": "2020-06-25T17:05:25Z", "type": "commit"}, {"oid": "533f0d28d02e47e6b38621dc51602f97017cf9ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/533f0d28d02e47e6b38621dc51602f97017cf9ee", "message": "Add unit test", "committedDate": "2020-06-28T22:05:17Z", "type": "commit"}, {"oid": "19014fe73ade432b9885dc3b8ccfcd94b0e84e4b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19014fe73ade432b9885dc3b8ccfcd94b0e84e4b", "message": "Merge branch 'master' into tes-credsprovider", "committedDate": "2020-06-29T17:30:08Z", "type": "commit"}]}