{"pr_number": 297, "pr_title": "Add runtime namespace for service local datastore", "pr_createdAt": "2020-07-06T17:33:32Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2NjQyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450466426", "bodyText": "I know this is not part of this PR and that it has existed for some time now, but could we change this namespace to something better? Ideally we should name it based on the purpose it's serving and not how we internally handle updates to it.", "author": "shaguptashaikh", "createdAt": "2020-07-06T20:37:23Z", "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -25,16 +25,29 @@ services:\n         \n     lifecycle: # lifecycle commands.\n     \n+    resources: # service reserved resources path.\n+\n     logging: # logging config.\n       \n     custom: # custom config. \n     \n+    notRolledBack: # config that's not being rolled back during deployment", "originalCommit": "1af750645b3502a42950661761c0a6c63b8b1a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3NzA3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450477073", "bodyText": "For now I just update the readme with whatever current implementation has, we can have separate CR to update namings", "author": "ShirleyZheng92", "createdAt": "2020-07-06T20:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2NjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2ODA5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450468094", "bodyText": "I'm a little confused as to how this is meant to be 1) used and 2) updated. Will this come from the recipe? And can it be modified through deployments directly or can service modify it only over IPC? Could you maybe describe your thought process in the PR description?", "author": "shaguptashaikh", "createdAt": "2020-07-06T20:40:53Z", "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -25,16 +25,29 @@ services:\n         \n     lifecycle: # lifecycle commands.\n     \n+    resources: # service reserved resources path.", "originalCommit": "1af750645b3502a42950661761c0a6c63b8b1a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3Njc2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450476762", "bodyText": "I guess it comes from recipe. This was implemented in IPC long time ago before recipe is introduced. For now I just update the readme with whatever current implementation has.", "author": "ShirleyZheng92", "createdAt": "2020-07-06T20:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2ODA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2ODI2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450468264", "bodyText": "Same as above, how will this be used and modified, and why is this needed if there's is also per service configuration for resources?", "author": "shaguptashaikh", "createdAt": "2020-07-06T20:41:14Z", "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -25,16 +25,29 @@ services:\n         \n     lifecycle: # lifecycle commands.\n     \n+    resources: # service reserved resources path.\n+\n     logging: # logging config.\n       \n     custom: # custom config. \n     \n+    notRolledBack: # config that's not being rolled back during deployment\n+\n   <service2>:\n     lifecycle:\n     logging:\n     \n+  _AUTH_TOKENS: # auth token read by AuthHandler\n+    <authToken>: <serviceName>\n+\n system:\n   <kernel system config> \n+\n+registered-resource: # resources registered by service", "originalCommit": "1af750645b3502a42950661761c0a6c63b8b1a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1Njc5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r451756798", "bodyText": "This is updated in the runtime when service register a resource when running. It's not coming from recipe", "author": "ShirleyZheng92", "createdAt": "2020-07-08T18:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2ODI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3MDk3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450470978", "bodyText": "Why is there both 'runtime' and 'notRolledBack' namespace? if you're adding this namespace then we should change the notRolledBack namespace in DeploymentConfigMerger to runtime because it was essentially supposed to serve the same purpose. Please also change it in the config schema .md file.", "author": "shaguptashaikh", "createdAt": "2020-07-06T20:46:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -39,6 +39,7 @@\n \n public class EvergreenService implements InjectionActions, DisruptableCheck {\n     public static final String SERVICES_NAMESPACE_TOPIC = \"services\";\n+    public static final String RUNTIME_STORE_NAMESPACE_TOPIC = \"runtime\";", "originalCommit": "1af750645b3502a42950661761c0a6c63b8b1a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3NzQzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450477436", "bodyText": "are we combining local datastore 'runtime' and 'notRolledBack'?", "author": "ShirleyZheng92", "createdAt": "2020-07-06T21:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3MDk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0MjYwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450542604", "bodyText": "at least what in the runtime is not going to be roll back...", "author": "leaf94", "createdAt": "2020-07-07T00:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3MDk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1Njk1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r451756951", "bodyText": "Removed the 'notRolledBack' key", "author": "ShirleyZheng92", "createdAt": "2020-07-08T18:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3MDk3OA=="}], "type": "inlineReview"}, {"oid": "fa9ad25f464dbf130b188d555e75402a6057741b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa9ad25f464dbf130b188d555e75402a6057741b", "message": "Add runtime namespace for service local datastore\n\nPlace service local datastore under \"runtime\" keyword.\nMove TES roleAlias config under 'parameters' keyword.\nUpdate README_CONFIG_SCHEMA.md to date.", "committedDate": "2020-07-06T21:37:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0MjgwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450542803", "bodyText": "Nice! Let's start updating the README! Yay!", "author": "leaf94", "createdAt": "2020-07-07T00:13:32Z", "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -25,16 +25,30 @@ services:\n         \n     lifecycle: # lifecycle commands.\n     \n+    resources: # service reserved resources path.\n+\n     logging: # logging config.\n       \n     custom: # custom config. \n     \n+    runtime: # namespace for service local datastore\n+        # not rolled back during deployment\n+\n   <service2>:\n     lifecycle:\n     logging:\n     \n+  _AUTH_TOKENS: # auth token read by AuthHandler\n+    <authToken>: <serviceName>\n+", "originalCommit": "fa9ad25f464dbf130b188d555e75402a6057741b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0Njc3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450546776", "bodyText": "custom is gone, right?", "author": "MikeDombo", "createdAt": "2020-07-07T00:28:25Z", "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -25,16 +25,30 @@ services:\n         \n     lifecycle: # lifecycle commands.\n     \n+    resources: # service reserved resources path.\n+\n     logging: # logging config.\n       \n     custom: # custom config. ", "originalCommit": "fa9ad25f464dbf130b188d555e75402a6057741b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450547259", "bodyText": "we should use the DeviceConfiguration class to store this stuff.", "author": "MikeDombo", "createdAt": "2020-07-07T00:30:23Z", "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -297,7 +298,7 @@ public void setupIoTRoleForTes(String roleName, String roleAliasName, String cer\n      */\n     public void updateKernelConfigWithTesRoleInfo(Kernel kernel, String roleAliasName) {\n         Topics tesTopics = kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC, TOKEN_EXCHANGE_SERVICE_TOPICS);\n-        tesTopics.createLeafChild(IOT_ROLE_ALIAS_TOPIC).withValue(roleAliasName);\n+        tesTopics.lookupTopics(PARAMETERS_CONFIG_KEY).createLeafChild(IOT_ROLE_ALIAS_TOPIC).withValue(roleAliasName);", "originalCommit": "fa9ad25f464dbf130b188d555e75402a6057741b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY1MTY4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450651682", "bodyText": "Do you mean moving this under \"system\" key?", "author": "ShirleyZheng92", "createdAt": "2020-07-07T07:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODY5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r450828691", "bodyText": "Yes, and access it through that class, which is what that class is for.", "author": "MikeDombo", "createdAt": "2020-07-07T12:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1NjI3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r451756273", "bodyText": "Is it possible that user want to change iot role alias through deployment?", "author": "ShirleyZheng92", "createdAt": "2020-07-08T18:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1ODE4Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r451758182", "bodyText": "Yes. System should be configurable through deployment too", "author": "MikeDombo", "createdAt": "2020-07-08T18:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2NDQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/297#discussion_r452464491", "bodyText": "Discussed offline, let's keep it under TES for now", "author": "ShirleyZheng92", "createdAt": "2020-07-09T20:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzI1OQ=="}], "type": "inlineReview"}, {"oid": "62a251ce7875e659f593e2b639ff3eb4860e95f4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62a251ce7875e659f593e2b639ff3eb4860e95f4", "message": "Add runtime namespace for service local datastore\n\nPlace service local datastore under \"runtime\" keyword.\nMove TES roleAlias config under 'parameters' keyword.\nUpdate README_CONFIG_SCHEMA.md to date.", "committedDate": "2020-07-07T07:04:10Z", "type": "forcePushed"}, {"oid": "69c6185cea87fc7da7ce40fe1222f61b7ab9ca40", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/69c6185cea87fc7da7ce40fe1222f61b7ab9ca40", "message": "Add runtime namespace for service local datastore\n\nPlace service local datastore under \"runtime\" keyword.\nMove TES roleAlias config under 'parameters' keyword.\nUpdate README_CONFIG_SCHEMA.md to date.", "committedDate": "2020-07-08T19:02:07Z", "type": "commit"}, {"oid": "69c6185cea87fc7da7ce40fe1222f61b7ab9ca40", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/69c6185cea87fc7da7ce40fe1222f61b7ab9ca40", "message": "Add runtime namespace for service local datastore\n\nPlace service local datastore under \"runtime\" keyword.\nMove TES roleAlias config under 'parameters' keyword.\nUpdate README_CONFIG_SCHEMA.md to date.", "committedDate": "2020-07-08T19:02:07Z", "type": "forcePushed"}, {"oid": "d37a940e4c826bf96a4a9e98fea8a36170936b93", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d37a940e4c826bf96a4a9e98fea8a36170936b93", "message": "Merge branch 'master' into localDatastore", "committedDate": "2020-07-08T23:42:00Z", "type": "commit"}, {"oid": "b2c79b7fa609968f55ff14921c799f72b1878914", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b2c79b7fa609968f55ff14921c799f72b1878914", "message": "Merge branch 'master' into localDatastore", "committedDate": "2020-07-09T18:32:00Z", "type": "commit"}, {"oid": "16afbc4182c7f199bb1b2e915a556d516f972c72", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/16afbc4182c7f199bb1b2e915a556d516f972c72", "message": "Fix e2e test", "committedDate": "2020-07-10T06:17:40Z", "type": "commit"}, {"oid": "16afbc4182c7f199bb1b2e915a556d516f972c72", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/16afbc4182c7f199bb1b2e915a556d516f972c72", "message": "Fix e2e test", "committedDate": "2020-07-10T06:17:40Z", "type": "forcePushed"}]}