{"pr_number": 166, "pr_title": "[Bug Fix] EG Service's reportState should not lost!", "pr_createdAt": "2020-04-08T19:18:44Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166", "timeline": [{"oid": "4a7fb67fb857089f305f8759ecec33a7c9cf0652", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a7fb67fb857089f305f8759ecec33a7c9cf0652", "message": "* Do not clear `stateEventQueue` when adding element to it\n* Add a new boolean `latest` parameter to `globalServiceStateChanged` and make the necessary wiring\n* Fix tests\n* Increase size of `stateEventQueue`", "committedDate": "2020-04-08T19:03:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1ODQzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r405758439", "bodyText": "given that these branches are the same, just get rid of the if.", "author": "MikeDombo", "createdAt": "2020-04-08T19:21:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -335,12 +334,11 @@ private void setDesiredState(State... state) {\n         }\n     }\n \n-    @SuppressFBWarnings(value = \"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n+    @SuppressFBWarnings({\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\", \"DB_DUPLICATE_BRANCHES\"})\n     private void enqueueStateEvent(Object event) {\n         synchronized (stateEventLock) {\n             if (event instanceof State) {\n                 // override existing reportState\n-                stateEventQueue.clear();\n                 stateEventQueue.offer(event);\n             } else {", "originalCommit": "4a7fb67fb857089f305f8759ecec33a7c9cf0652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMTM0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r405911342", "bodyText": "Also please remove the new suppression for findbugs warning", "author": "shaguptashaikh", "createdAt": "2020-04-09T01:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1ODQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMDE1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406430156", "bodyText": "Done", "author": "fufranci", "createdAt": "2020-04-09T19:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1ODQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMTIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r405911232", "bodyText": "Nit - You seem to have added some space here", "author": "shaguptashaikh", "createdAt": "2020-04-09T01:50:26Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -412,7 +410,7 @@ public final void requestReinstall() {\n             setDesiredState(State.INSTALLED, State.NEW, State.RUNNING);\n         }\n     }\n-\n+   ", "originalCommit": "4a7fb67fb857089f305f8759ecec33a7c9cf0652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMjY4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406432683", "bodyText": "Fixed", "author": "fufranci", "createdAt": "2020-04-09T19:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMTIzMg=="}], "type": "inlineReview"}, {"oid": "c059384653cc3100887da0ff6eade822211962ee", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c059384653cc3100887da0ff6eade822211962ee", "message": "Add test", "committedDate": "2020-04-09T19:28:48Z", "type": "commit"}, {"oid": "99f12b54817dc741ec76ced54406faae2e7806dc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/99f12b54817dc741ec76ced54406faae2e7806dc", "message": "Removed dead space", "committedDate": "2020-04-09T19:37:00Z", "type": "commit"}, {"oid": "da17402e6f2ca390677befcdb36e31ce0cb62f9b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da17402e6f2ca390677befcdb36e31ce0cb62f9b", "message": "Merge remote-tracking branch 'origin/master' into report_state", "committedDate": "2020-04-09T19:59:45Z", "type": "commit"}, {"oid": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/642fd9f01fcdc580fa50930e7040fb1365e1974a", "message": "Fix PMD violation", "committedDate": "2020-04-09T20:10:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTA0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406469042", "bodyText": "not a problem, but why the change from array to linked?", "author": "MikeDombo", "createdAt": "2020-04-09T20:49:53Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -76,8 +76,7 @@\n \n     // A state event can be a state transition event, or a desired state updated notification.\n     // TODO: make class of StateEvent instead of generic object.\n-    private final BlockingQueue<Object> stateEventQueue = new ArrayBlockingQueue<>(1);\n-    private final Object stateEventLock = new Object();\n+    private final BlockingQueue<Object> stateEventQueue = new LinkedBlockingQueue<>();", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzEwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406513105", "bodyText": "The intention was to avoid losing any state change event. And also to avoid being blocked. Therefore, I changed this to LinkedBlockingQueue without a bound.", "author": "fufranci", "createdAt": "2020-04-09T22:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTQ1Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406469453", "bodyText": "remove print stack trace.", "author": "MikeDombo", "createdAt": "2020-04-09T20:50:38Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -261,18 +260,11 @@ private void setDesiredState(State... state) {\n \n     @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n     private void enqueueStateEvent(Object event) {\n-        synchronized (stateEventLock) {\n-            if (event instanceof State) {\n-                // override existing reportState\n-                stateEventQueue.clear();\n-                stateEventQueue.offer(event);\n-            } else {\n-                stateEventQueue.offer(event);\n-\n-                // Ignore returned value of offer().\n-                // If enqueue isn't successful, the event queue has contents and there is no need to send another\n-                // trigger to process state transition.\n-            }\n+        try {\n+            stateEventQueue.put(event);\n+        } catch (InterruptedException e) {\n+            logger.error(\"couldn't put the new event to stateEventQueue\");\n+            e.printStackTrace();", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTk2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406469966", "bodyText": "this put is blocking, so it won't be able to put until there is room. Is this what we want? If so, we need to be careful with the InterruptedException since that means that the thread wants to be shutdown. As such, that signal should be propagated by not catching it, but changing the signature instead.", "author": "MikeDombo", "createdAt": "2020-04-09T20:51:43Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -261,18 +260,11 @@ private void setDesiredState(State... state) {\n \n     @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n     private void enqueueStateEvent(Object event) {\n-        synchronized (stateEventLock) {\n-            if (event instanceof State) {\n-                // override existing reportState\n-                stateEventQueue.clear();\n-                stateEventQueue.offer(event);\n-            } else {\n-                stateEventQueue.offer(event);\n-\n-                // Ignore returned value of offer().\n-                // If enqueue isn't successful, the event queue has contents and there is no need to send another\n-                // trigger to process state transition.\n-            }\n+        try {\n+            stateEventQueue.put(event);", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyMTIxOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406521218", "bodyText": "I realized that this will affect our getReportState() logic, where it's assuming the queue size is 1 and trying to get one element. However, with this logic being changed, the state event queue can be arbitrary long and not all element are state change event. In this case the getReportState() logic will be updated, basically keep reading the until reach an element that's type of state change event.", "author": "ShirleyZheng92", "createdAt": "2020-04-09T22:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNTMxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406535315", "bodyText": "Good point about InterruptedException. If we propagate InterruptedException here, the caller is in no better position to handle it.\nSince we are using LinkedBlockingQueue, I am going to change it back tooffer, but to log the error here.", "author": "fufranci", "createdAt": "2020-04-09T23:46:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0NTMwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406545303", "bodyText": "@ShirleyZheng92 Do you mean \"DesiredStateUpdated\"? How is \"DesiredStateUpdated\" being used? I only see one place that we are inserting it into the queue. But there is no code that tests against if a state is \"DesiredStateUpdated\".\nIs DesiredStateUpdated actually being used? Can we remove it?", "author": "fufranci", "createdAt": "2020-04-10T00:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2OTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MDM5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406470398", "bodyText": "you can also use AtomicInteger for this.", "author": "MikeDombo", "createdAt": "2020-04-09T20:52:29Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -15,11 +17,23 @@\n import org.mockito.Mockito;\n import org.mockito.junit.jupiter.MockitoExtension;\n \n+import javax.inject.Inject;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.ThreadPoolExecutor;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n \n @ExtendWith(MockitoExtension.class)\n-class EvergreenServiceTest extends EGServiceTestUtil {\n+public class EvergreenServiceTest extends EGServiceTestUtil {\n+    private static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final int NUM = 100;\n \n-    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static int n = 0; // Easy way to pass n without creating a mutable integer.", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNjkwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406526909", "bodyText": "Nice. Done.", "author": "fufranci", "createdAt": "2020-04-09T23:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MDM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNTQxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406535416", "bodyText": "Changed. Thanks.", "author": "fufranci", "createdAt": "2020-04-09T23:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MTc0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406471747", "bodyText": "do not await without a timeout. Use assertTrue(cd.await(<timeout>))", "author": "MikeDombo", "createdAt": "2020-04-09T20:55:01Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -66,4 +78,55 @@ void GIVEN_a_new_state_WHEN_getState_THEN_return_the_new_state() {\n \n         Mockito.verify(stateTopic).getOnce();\n     }\n+\n+    private class AwesomeService extends EvergreenService {\n+        @Inject\n+        private CountDownLatch cd;\n+\n+        @Inject\n+        public AwesomeService(Context context) {\n+            super(Topics.errorNode(context, \"AwesomeService\", \"testing\"));\n+        }\n+\n+        @Override\n+        public void startup() {\n+            new Thread(() -> {\n+                for (int i = 0; i < NUM; i++) {\n+                    reportState(State.RUNNING);\n+                    reportState(State.STOPPING);\n+                }\n+\n+                cd.countDown();\n+            }).start();\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_a_service_WHEN_reportState_THEN_all_state_changes_are_notified() throws InterruptedException {\n+        ScheduledThreadPoolExecutor ses = new ScheduledThreadPoolExecutor(2);\n+        ExecutorService cachedPool = Executors.newCachedThreadPool();\n+        CountDownLatch cd = new CountDownLatch(1);\n+\n+        Context context = new Context();\n+        context.put(ScheduledThreadPoolExecutor.class, ses);\n+        context.put(ScheduledExecutorService.class, ses);\n+        context.put(Executor.class, cachedPool);\n+        context.put(ExecutorService.class, cachedPool);\n+        context.put(ThreadPoolExecutor.class, ses);\n+        context.put(CountDownLatch.class, cd);\n+        context.addGlobalStateChangeListener((service, oldState, newState, latest) -> {\n+            n++;\n+        });\n+\n+        context.get(AwesomeService.class).requestStart();\n+        cd.await();", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNjgyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406526821", "bodyText": "Done", "author": "fufranci", "createdAt": "2020-04-09T23:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNTQ5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406535493", "bodyText": "Done", "author": "fufranci", "createdAt": "2020-04-09T23:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MTc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3Mjk1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406472959", "bodyText": "don't report stopping as no customer service should ever do this. Try ERRORED instead.", "author": "MikeDombo", "createdAt": "2020-04-09T20:57:32Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -66,4 +78,55 @@ void GIVEN_a_new_state_WHEN_getState_THEN_return_the_new_state() {\n \n         Mockito.verify(stateTopic).getOnce();\n     }\n+\n+    private class AwesomeService extends EvergreenService {\n+        @Inject\n+        private CountDownLatch cd;\n+\n+        @Inject\n+        public AwesomeService(Context context) {\n+            super(Topics.errorNode(context, \"AwesomeService\", \"testing\"));\n+        }\n+\n+        @Override\n+        public void startup() {\n+            new Thread(() -> {\n+                for (int i = 0; i < NUM; i++) {\n+                    reportState(State.RUNNING);\n+                    reportState(State.STOPPING);", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzNDE0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406834140", "bodyText": "For some reason, if I use ERRORED, the lifecycle thread notifies me ~1000 times instead of ~200. I haven't studied the code well enough to understand why yet. But with STOPPING, there are only two extra events when running on my mac which i can explain.", "author": "fufranci", "createdAt": "2020-04-10T16:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3Mjk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzODU1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406838556", "bodyText": "The reason should be that the service is restarted, so it will create this thread again.", "author": "MikeDombo", "createdAt": "2020-04-10T16:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3Mjk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MzM3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406473376", "bodyText": "Why not have this be a countdownlatch also? That way you can wait for it to reach 0 instead of just sleeping 10 seconds.", "author": "MikeDombo", "createdAt": "2020-04-09T20:58:18Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -66,4 +78,55 @@ void GIVEN_a_new_state_WHEN_getState_THEN_return_the_new_state() {\n \n         Mockito.verify(stateTopic).getOnce();\n     }\n+\n+    private class AwesomeService extends EvergreenService {\n+        @Inject\n+        private CountDownLatch cd;\n+\n+        @Inject\n+        public AwesomeService(Context context) {\n+            super(Topics.errorNode(context, \"AwesomeService\", \"testing\"));\n+        }\n+\n+        @Override\n+        public void startup() {\n+            new Thread(() -> {\n+                for (int i = 0; i < NUM; i++) {\n+                    reportState(State.RUNNING);\n+                    reportState(State.STOPPING);\n+                }\n+\n+                cd.countDown();\n+            }).start();\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_a_service_WHEN_reportState_THEN_all_state_changes_are_notified() throws InterruptedException {\n+        ScheduledThreadPoolExecutor ses = new ScheduledThreadPoolExecutor(2);\n+        ExecutorService cachedPool = Executors.newCachedThreadPool();\n+        CountDownLatch cd = new CountDownLatch(1);\n+\n+        Context context = new Context();\n+        context.put(ScheduledThreadPoolExecutor.class, ses);\n+        context.put(ScheduledExecutorService.class, ses);\n+        context.put(Executor.class, cachedPool);\n+        context.put(ExecutorService.class, cachedPool);\n+        context.put(ThreadPoolExecutor.class, ses);\n+        context.put(CountDownLatch.class, cd);\n+        context.addGlobalStateChangeListener((service, oldState, newState, latest) -> {\n+            n++;", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNjcyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406526723", "bodyText": ":)   Thanks for the suggestion. Done.", "author": "fufranci", "createdAt": "2020-04-09T23:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MzM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyMTQ3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406521479", "bodyText": "NIT: add \"interrupted\" in the error message", "author": "ShirleyZheng92", "createdAt": "2020-04-09T22:57:16Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -261,18 +260,11 @@ private void setDesiredState(State... state) {\n \n     @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n     private void enqueueStateEvent(Object event) {\n-        synchronized (stateEventLock) {\n-            if (event instanceof State) {\n-                // override existing reportState\n-                stateEventQueue.clear();\n-                stateEventQueue.offer(event);\n-            } else {\n-                stateEventQueue.offer(event);\n-\n-                // Ignore returned value of offer().\n-                // If enqueue isn't successful, the event queue has contents and there is no need to send another\n-                // trigger to process state transition.\n-            }\n+        try {\n+            stateEventQueue.put(event);\n+        } catch (InterruptedException e) {\n+            logger.error(\"couldn't put the new event to stateEventQueue\");", "originalCommit": "642fd9f01fcdc580fa50930e7040fb1365e1974a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNTk5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406535994", "bodyText": "See the discussion about catching InterruptedException. I am going to revert back to use offer but log any error.", "author": "fufranci", "createdAt": "2020-04-09T23:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyMTQ3OQ=="}], "type": "inlineReview"}, {"oid": "e5e8bc89bf816248773a337cd14098258c7b51f7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e5e8bc89bf816248773a337cd14098258c7b51f7", "message": "Address feedback", "committedDate": "2020-04-10T00:37:24Z", "type": "commit"}, {"oid": "a10fbad6785762c26c8a4cb4ea1f03ba53d5a781", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a10fbad6785762c26c8a4cb4ea1f03ba53d5a781", "message": "Merge remote-tracking branch 'origin/master' into report_state", "committedDate": "2020-04-10T16:19:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzODMwMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406838302", "bodyText": "this can be removed.", "author": "MikeDombo", "createdAt": "2020-04-10T16:37:38Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -197,18 +197,8 @@ void setDesiredState(State... state) {\n \n     @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")", "originalCommit": "a10fbad6785762c26c8a4cb4ea1f03ba53d5a781", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "015a88caaa7fadfd503a9e2fd80f004783ba998e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/015a88caaa7fadfd503a9e2fd80f004783ba998e", "message": "Remove unnecessary SuppressFBWarnings", "committedDate": "2020-04-10T16:54:35Z", "type": "commit"}, {"oid": "97c2518e21824378421016481fb77be0de87c094", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/97c2518e21824378421016481fb77be0de87c094", "message": "address feedback", "committedDate": "2020-04-10T18:58:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNzgzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406907832", "bodyText": "please add comments for what is going on here and why.\nThis seems a bit dangerous to me since we use the queue to unblock the thread, but here you're going to be removing things from the queue, possibly racing with the lifecycle thread it would seem.", "author": "MikeDombo", "createdAt": "2020-04-10T19:29:04Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -145,7 +145,11 @@ synchronized void reportState(State newState) {\n \n     private Optional<State> getReportState() {\n         Object top = stateEventQueue.poll();\n-        if (top instanceof State) {\n+        while (top != null && !(top instanceof State)) {", "originalCommit": "97c2518e21824378421016481fb77be0de87c094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxMTI5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406911296", "bodyText": "You probably will drain the queue unintentionally", "author": "ShirleyZheng92", "createdAt": "2020-04-10T19:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMzMyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r406933325", "bodyText": "Hmm... I thought I understood the problem but I am confused again. Here is the original code:\n    private Optional<State> getReportState() {\n        Object top = stateEventQueue.poll();\n        if (top instanceof State) {\n            return Optional.of((State) top);\n        }\n        return Optional.empty();\n    }\n\n\nIf the queue is empty, we return null.\nIf the first element is a State, we return that state.\nIf the first element is the special \"DesiredStateUpdated\" value, we return null.\n\nSo why does this code not work when we have an unbound queue? Can you show me an example of the queue that would make the existing code to fail? For example:\n[S, X] where\nS - valid state\nX - special value \"DesiredStateUpdated\"\nHow would the queue look like that would cause a problem?\nThe logic seems to be very tricky. Currently, getReportState is called by two places:\n\nhandleCurrentStateNew\nhandleCurrentStateStopping\n\nWhen the thread is there, that also means it is not waiting at take.", "author": "fufranci", "createdAt": "2020-04-10T20:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MDA2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407590069", "bodyText": "Discussed offline together with  both Shirley and Michael and we think what is in the PR is fine.", "author": "fufranci", "createdAt": "2020-04-13T17:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkwNzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjE1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407566154", "bodyText": "I'd still prefer using the logic of\nif (event instanceof State || stateEventQueue.emtpy()) {\n  stateEventQueue.offer(event);\n} \n\nrequire lifecycle change calls can be invoked arbitrary many times, causing the \"DesiredStateUpdated\" event to accumulate in the queue.", "author": "ShirleyZheng92", "createdAt": "2020-04-13T16:19:40Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -195,20 +199,9 @@ void setDesiredState(State... state) {\n         }\n     }\n \n-    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n     private void enqueueStateEvent(Object event) {\n-        synchronized (stateEventLock) {\n-            if (event instanceof State) {\n-                // override existing reportState\n-                stateEventQueue.clear();\n-                stateEventQueue.offer(event);\n-            } else {\n-                stateEventQueue.offer(event);\n-\n-                // Ignore returned value of offer().\n-                // If enqueue isn't successful, the event queue has contents and there is no need to send another\n-                // trigger to process state transition.\n-            }\n+        if (!stateEventQueue.offer(event)) {\n+            logger.error(\"couldn't put the new event to stateEventQueue\");\n         }", "originalCommit": "97c2518e21824378421016481fb77be0de87c094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU3MTIzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407571239", "bodyText": "How does that make sense? If we do that, then we're just in the same situation that we were before this change, meaning that transitions will be lost.\nNevermind, it is || so that's ok.", "author": "MikeDombo", "createdAt": "2020-04-13T16:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MDE1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407590154", "bodyText": "Discussed offline together with  both Shirley and Michael and we think what is in the PR is fine.", "author": "fufranci", "createdAt": "2020-04-13T17:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjE1NA=="}], "type": "inlineReview"}, {"oid": "65ce5d92be64049a795d80c3f4d419dc8c1f91e7", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/65ce5d92be64049a795d80c3f4d419dc8c1f91e7", "message": "Merge branch 'master' into report_state", "committedDate": "2020-04-13T17:02:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MzExMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407593110", "bodyText": "isEmpty isn't necessarily correct given that it contains both states and strings, but this state change is only for states.\nI think that given this limitation, I'd rather not have the latest argument added to this. Also, since none of your changes are using the latest at all. Let's reinvestigate if we need it at a later date. For now, I'm happy to just have the fix to unbound the queue.", "author": "MikeDombo", "createdAt": "2020-04-13T17:09:05Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -100,7 +99,8 @@ private void updateStateAndBroadcast(State newState) {\n         synchronized (State.class) {\n             prevState = currentState;\n             stateTopic.withValue(newState);\n-            evergreenService.getContext().globalNotifyStateChanged(evergreenService, prevState, newState);\n+            evergreenService.getContext().globalNotifyStateChanged(evergreenService, prevState, newState,\n+                    stateEventQueue.isEmpty());", "originalCommit": "65ce5d92be64049a795d80c3f4d419dc8c1f91e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwNTA4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407605086", "bodyText": ":(  but good call.", "author": "fufranci", "createdAt": "2020-04-13T17:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MzExMA=="}], "type": "inlineReview"}, {"oid": "9935cc03b7bab092cd0d80d8f8150d8e9cd80417", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9935cc03b7bab092cd0d80d8f8150d8e9cd80417", "message": "remove `latest`", "committedDate": "2020-04-13T17:54:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzMTQ2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407631460", "bodyText": "Why keep this at all?", "author": "MikeDombo", "createdAt": "2020-04-13T18:17:58Z", "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "diffHunk": "@@ -257,9 +257,10 @@ public synchronized void removeGlobalStateChangeListener(GlobalStateChangeListen\n      * @param changedService the service which had a state change\n      * @param oldState  the old state of the service\n      * @param newState the new state of the service\n+     * @param latest True if this is the latest state. False if there are more state changes coming.\n      */\n     public synchronized void globalNotifyStateChanged(EvergreenService changedService, final State oldState,\n-                                                      final State newState) {\n+                                                      final State newState, boolean latest) {", "originalCommit": "9935cc03b7bab092cd0d80d8f8150d8e9cd80417", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzNDcwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/166#discussion_r407634707", "bodyText": "Missed. Thanks!", "author": "fufranci", "createdAt": "2020-04-13T18:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzMTQ2MA=="}], "type": "inlineReview"}, {"oid": "f4b3be0d89acb92246c62ce5b8fd4fa66fdded1c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f4b3be0d89acb92246c62ce5b8fd4fa66fdded1c", "message": "Missed some `latest` usage.\nRemoved them as well.", "committedDate": "2020-04-13T18:28:44Z", "type": "commit"}, {"oid": "1c9a306c0935a66bb47e7c60269b634522b4041b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1c9a306c0935a66bb47e7c60269b634522b4041b", "message": "Merge branch 'master' into report_state", "committedDate": "2020-04-13T19:33:10Z", "type": "commit"}]}