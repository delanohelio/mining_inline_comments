{"pr_number": 466, "pr_title": "More robust handling of timeouts in MqttClient", "pr_createdAt": "2020-09-22T23:30:35Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5OTM1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493099350", "bodyText": "Why do you need .get() on this one?", "author": "fengwang666", "createdAt": "2020-09-23T00:03:03Z", "path": "src/main/java/com/aws/greengrass/mqttclient/AwsIotMqttClient.java", "diffHunk": "@@ -155,15 +165,15 @@ void reconnect() throws TimeoutException, ExecutionException, InterruptedExcepti\n         }\n     }\n \n-    private int getTimeout() {\n+    int getTimeout() {\n         return Coerce.toInt(mqttTopics.findOrDefault(\n                 MqttClient.DEFAULT_MQTT_OPERATION_TIMEOUT, MqttClient.MQTT_OPERATION_TIMEOUT_KEY));\n     }\n \n     private void resubscribe() {\n         subscriptionTopics.forEach((key, value) -> {\n             try {\n-                subscribe(key, value);\n+                subscribe(key, value).get(getTimeout(), TimeUnit.MILLISECONDS);", "originalCommit": "f81d55c51e90a8599071adf560410fe5a9794205", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE1MDI0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493150249", "bodyText": "removed", "author": "MikeDombo", "createdAt": "2020-09-23T02:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5OTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTU3Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493101577", "bodyText": "same here. Is timeout needed?", "author": "fengwang666", "createdAt": "2020-09-23T00:10:52Z", "path": "src/main/java/com/aws/greengrass/mqttclient/MqttClient.java", "diffHunk": "@@ -194,11 +195,17 @@ public synchronized void subscribe(SubscribeRequest request)\n             try (LockScope scope = LockScope.lock(connectionLock.readLock())) {\n                 // Connection isn't null, so we should subscribe to the topic\n                 if (connection != null) {\n-                    connection.subscribe(request.getTopic(), request.getQos());\n-                    subscriptionTopics.put(new MqttTopic(request.getTopic()), connection);\n+                    AwsIotMqttClient finalConnection = connection;\n+                    connection.subscribe(request.getTopic(), request.getQos()).whenComplete((i, t) -> {\n+                        if (t == null) {\n+                            subscriptionTopics.put(new MqttTopic(request.getTopic()), finalConnection);\n+                        } else {\n+                            subscriptions.remove(request);\n+                        }\n+                    }).get(connection.getTimeout(), TimeUnit.MILLISECONDS);", "originalCommit": "f81d55c51e90a8599071adf560410fe5a9794205", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTk0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493109945", "bodyText": "The get is called so it can throw an error if there is one. The timeout is there so we don't block forever", "author": "MikeDombo", "createdAt": "2020-09-23T00:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTU3Nw=="}], "type": "inlineReview"}, {"oid": "9155d12333f18797f1316e1b8903120bcd5895b6", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9155d12333f18797f1316e1b8903120bcd5895b6", "message": "More robust handling of timeouts in MqttClient", "committedDate": "2020-09-23T02:02:52Z", "type": "commit"}, {"oid": "ed52f30605a54b196b882a1565129c6ec9712936", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed52f30605a54b196b882a1565129c6ec9712936", "message": "Fix test", "committedDate": "2020-09-23T02:02:52Z", "type": "commit"}, {"oid": "ae0a239639ade5500a4c1bf3de08dbdb4404d809", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ae0a239639ade5500a4c1bf3de08dbdb4404d809", "message": "Log errors", "committedDate": "2020-09-23T02:08:43Z", "type": "forcePushed"}, {"oid": "649affe743d92e40f473f04882521e6b2c4f9ece", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/649affe743d92e40f473f04882521e6b2c4f9ece", "message": "Log errors", "committedDate": "2020-09-23T02:16:20Z", "type": "forcePushed"}, {"oid": "ff93886338d957ae56b3da09138a9d307b0e3b0f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff93886338d957ae56b3da09138a9d307b0e3b0f", "message": "Log errors", "committedDate": "2020-09-23T03:01:18Z", "type": "commit"}, {"oid": "ff93886338d957ae56b3da09138a9d307b0e3b0f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff93886338d957ae56b3da09138a9d307b0e3b0f", "message": "Log errors", "committedDate": "2020-09-23T03:01:18Z", "type": "forcePushed"}, {"oid": "cc851b821a15969aa4dcc87f7bc633f05ede4695", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc851b821a15969aa4dcc87f7bc633f05ede4695", "message": "Update for windows", "committedDate": "2020-09-23T03:41:00Z", "type": "commit"}, {"oid": "fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "message": "Correct order of iot http status code setting", "committedDate": "2020-09-23T06:08:41Z", "type": "commit"}, {"oid": "fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "message": "Correct order of iot http status code setting", "committedDate": "2020-09-23T06:08:41Z", "type": "forcePushed"}, {"oid": "25874e206631fedb357ee86065710d7f3183ea73", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25874e206631fedb357ee86065710d7f3183ea73", "message": "Merge branch 'mqtt-timeout' of https://github.com/aws/aws-greengrass-kernel into mqtt-timeout", "committedDate": "2020-09-23T06:25:50Z", "type": "commit"}]}