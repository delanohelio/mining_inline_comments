{"pr_number": 213, "pr_title": "Cleanup all threads during tests", "pr_createdAt": "2020-04-23T23:48:12Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213", "timeline": [{"oid": "35fd1cf1f39e24fe7eef67d1a4da216d14248cde", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/35fd1cf1f39e24fe7eef67d1a4da216d14248cde", "message": "Cleanup all threads during tests", "committedDate": "2020-04-23T23:50:31Z", "type": "forcePushed"}, {"oid": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/55653ca44d71da3e58345ac6d79b48ac86c988a1", "message": "Cleanup all threads during tests", "committedDate": "2020-04-23T23:53:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNjM3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414226375", "bodyText": "Great!!! What about in context.close(), we try to find these and call shutdownNow?", "author": "leaf94", "createdAt": "2020-04-24T01:17:14Z", "path": "src/test/java/com/aws/iot/evergreen/dependency/LifecycleTest.java", "diffHunk": "@@ -25,24 +29,39 @@\n import static org.junit.jupiter.api.Assertions.assertSame;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n+import static org.mockito.Mockito.mock;\n \n @SuppressWarnings({\"PMD.CloseResource\", \"PMD.NonStaticInitializer\"})\n @ExtendWith(EGExtension.class)\n public class LifecycleTest {\n     static int seq;\n     static CountDownLatch cd;\n+    private Context context;\n \n-    @Test\n-    public void T1() {\n-        cd = new CountDownLatch(2);\n-        Context context = new Context();\n+    @BeforeEach\n+    void beforeEach() {\n+        context = new Context();\n         ScheduledThreadPoolExecutor ses = new ScheduledThreadPoolExecutor(2);\n         ExecutorService cachedPool = Executors.newCachedThreadPool();\n         context.put(ScheduledThreadPoolExecutor.class, ses);\n         context.put(ScheduledExecutorService.class, ses);\n         context.put(Executor.class, cachedPool);\n         context.put(ExecutorService.class, cachedPool);\n         context.put(ThreadPoolExecutor.class, ses);\n+        context.put(Kernel.class, mock(Kernel.class));\n+    }\n+\n+    @AfterEach\n+    void afterEach() throws IOException {\n+        context.get(ScheduledThreadPoolExecutor.class).shutdownNow();\n+        context.get(ExecutorService.class).shutdownNow();", "originalCommit": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNjM4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414226383", "bodyText": "Good job. I've seen you added this so many times...", "author": "leaf94", "createdAt": "2020-04-24T01:17:17Z", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -102,11 +101,12 @@ public void setup() {\n     }\n \n     @AfterEach\n-    void afterEach() {\n+    void afterEach() throws InterruptedException {\n         deploymentService.shutdown();\n         if (deploymentServiceThread != null && deploymentServiceThread.isAlive()) {\n             deploymentServiceThread.interrupt();\n         }\n+        mockKernel.shutdown();", "originalCommit": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNjc1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414226751", "bodyText": "Did mock cause issue?", "author": "leaf94", "createdAt": "2020-04-24T01:18:35Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/KernelTest.java", "diffHunk": "@@ -128,7 +128,7 @@ void GIVEN_kernel_and_services_WHEN_orderedDependencies_THEN_dependencies_are_re\n     @Test\n     void GIVEN_kernel_and_services_WHEN_orderedDependencies_with_a_cycle_THEN_no_dependencies_returned()\n             throws InputValidationException {\n-        KernelLifecycle kernelLifecycle = mock(KernelLifecycle.class);\n+        KernelLifecycle kernelLifecycle = spy(new KernelLifecycle(kernel, mock(KernelCommandLine.class)));", "originalCommit": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI0OTAzMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414249033", "bodyText": "No, but it was unable to shut things down correctly since I was mocking the lifecycle. With the real lifecycle it can properly shutdown.", "author": "MikeDombo", "createdAt": "2020-04-24T02:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNjc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNjgxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414226810", "bodyText": "nit: format", "author": "leaf94", "createdAt": "2020-04-24T01:18:46Z", "path": "src/test/java/com/aws/iot/evergreen/kernel/MergeTest.java", "diffHunk": "@@ -42,10 +42,12 @@ public void setup() {\n \n     @Test\n     public void testSomeMethod() throws Exception {\n-        Configuration c = new Configuration(new Context());\n-        c.read(Kernel.class.getResource(\"config.yaml\"), false);\n-        Configuration b = new Configuration(new Context()).copyFrom(c);\n-        assertEquals(c.getRoot(), b.getRoot());\n+        try(Context context = new Context()) {", "originalCommit": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyNzI0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414227242", "bodyText": "Nice!", "author": "leaf94", "createdAt": "2020-04-24T01:20:15Z", "path": "src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.testcommons.testutilities;\n+\n+import org.junit.jupiter.api.extension.AfterAllCallback;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@SuppressWarnings(\"PMD.SystemPrintln\")\n+public class ThreadProtector implements AfterAllCallback {\n+    private static final Set<String> ALLOWED_THREAD_NAMES = new HashSet<>(Arrays.asList(\"main\", \"Monitor Ctrl-Break\"));\n+\n+    @Override\n+    public void afterAll(ExtensionContext context) throws Exception {\n+        Set<Thread> threadSet = Thread.getAllStackTraces().keySet();\n+        List<String> liveThreads =\n+                threadSet.stream().filter(Thread::isAlive).filter(t -> t.getThreadGroup().getName().equals(\"main\"))\n+                        .map(Thread::getName).filter(Objects::nonNull)\n+                        .filter(name -> !ALLOWED_THREAD_NAMES.contains(name)).collect(Collectors.toList());\n+        if (!liveThreads.isEmpty()) {\n+            // Don't fail tests right now. Too many things would break.\n+            // fail(\"Threads are still running: \" + liveThreads);\n+            System.err.println(\"Threads are still running: \" + liveThreads);\n+        }", "originalCommit": "55653ca44d71da3e58345ac6d79b48ac86c988a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1de52e02247992d8357b2bff64883aae413dcd54", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1de52e02247992d8357b2bff64883aae413dcd54", "message": "Revert clearODcache so that it sets null instead of clearing", "committedDate": "2020-04-24T15:32:15Z", "type": "forcePushed"}, {"oid": "b71d6f9ea3a73595cf7c9b71fbc9f2cc5fc09ced", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b71d6f9ea3a73595cf7c9b71fbc9f2cc5fc09ced", "message": "Revert clearODcache so that it sets null instead of clearing", "committedDate": "2020-04-24T15:33:17Z", "type": "forcePushed"}, {"oid": "237d67d30cfdf3aac45368a321337811df6215b5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/237d67d30cfdf3aac45368a321337811df6215b5", "message": "Revert clearODcache so that it sets null instead of clearing", "committedDate": "2020-04-24T16:05:41Z", "type": "forcePushed"}, {"oid": "7d8de3ea4080952156bedd4d08741378345cef10", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d8de3ea4080952156bedd4d08741378345cef10", "message": "Cleanup all threads during tests", "committedDate": "2020-04-24T17:11:55Z", "type": "commit"}, {"oid": "fce204078f5197d1398c9e6ed1d41314a937e1ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fce204078f5197d1398c9e6ed1d41314a937e1ec", "message": "Revert clearODcache so that it sets null instead of clearing", "committedDate": "2020-04-24T17:13:27Z", "type": "commit"}, {"oid": "fce204078f5197d1398c9e6ed1d41314a937e1ec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fce204078f5197d1398c9e6ed1d41314a937e1ec", "message": "Revert clearODcache so that it sets null instead of clearing", "committedDate": "2020-04-24T17:13:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczOTIzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414739239", "bodyText": "Why do we need this new condition?", "author": "shaguptashaikh", "createdAt": "2020-04-24T17:23:02Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -131,7 +131,7 @@ private Topic initStateTopic(final Topics topics) {\n \n     private synchronized void initDependenciesTopic() {\n         externalDependenciesTopic.subscribe((what, node) -> {\n-            if (!WhatHappened.changed.equals(what)) {\n+            if (!WhatHappened.changed.equals(what) || node.getModtime() <= 1) {", "originalCommit": "fce204078f5197d1398c9e6ed1d41314a937e1ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczOTg4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/213#discussion_r414739884", "bodyText": "I use dflt in the constructor to initialize it with an empty list, but that does publish, so there's a race between the publish and this subscribe. So I added this check since dflt uses a modification time of 1.", "author": "MikeDombo", "createdAt": "2020-04-24T17:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczOTIzOQ=="}], "type": "inlineReview"}]}