{"pr_number": 591, "pr_title": "Restart nucleus when proxy or role alias parameters change", "pr_createdAt": "2020-10-30T19:09:59Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591", "timeline": [{"oid": "b3ff6170a0bc0f9cafda1a87a8e4f440aa082202", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3ff6170a0bc0f9cafda1a87a8e4f440aa082202", "message": "Restart nucleus when proxy or role alias parameters change", "committedDate": "2020-10-30T17:08:55Z", "type": "commit"}, {"oid": "a1d75b5424b19e99c30ca5000a562d0f498bfd42", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1d75b5424b19e99c30ca5000a562d0f498bfd42", "message": "Only restart for role alias when network proxy is used and use device config", "committedDate": "2020-10-30T19:06:44Z", "type": "commit"}, {"oid": "582daa84e513f6d0379526f8fe689b29cf73e4f2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/582daa84e513f6d0379526f8fe689b29cf73e4f2", "message": "Merge branch 'master' into proxy-change-restart", "committedDate": "2020-10-30T19:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5NjcwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516096707", "bodyText": "configuration, not parameter", "author": "MikeDombo", "createdAt": "2020-11-02T16:31:38Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -58,6 +69,7 @@\n @NotThreadSafe\n public class BootstrapManager implements Iterator<BootstrapTaskStatus>  {\n     private static final String COMPONENT_NAME_LOG_KEY_NAME = \"componentName\";\n+    private static final String RESTART_REQUIRED_MESSAGE = \"Restart required due to parameter change\";", "originalCommit": "582daa84e513f6d0379526f8fe689b29cf73e4f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NzQ1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516197451", "bodyText": "Updated", "author": "tomnagy-aws", "createdAt": "2020-11-02T19:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5NjcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5ODA0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516098040", "bodyText": "don't concat, just use the no proxy key.", "author": "MikeDombo", "createdAt": "2020-11-02T16:33:22Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -127,10 +139,101 @@ public boolean isBootstrapRequired(Map<String, Object> newConfig)\n         return nucleusConfigValidAndNeedsRestart || !bootstrapTaskStatusList.isEmpty();\n     }\n \n+    private Map<String, Object> getNucleusParametersFromDeploymentConfig(Map<String, Object> newConfig) {\n+        Map<String, Object> services = (Map<String, Object>) newConfig.get(SERVICES_NAMESPACE_TOPIC);\n+        if (services == null) {\n+            return null;\n+        }\n+        Map<String, Object> nucleus = (Map<String, Object>) services.get(DEFAULT_NUCLEUS_COMPONENT_NAME);\n+        if (nucleus == null) {\n+            return null;\n+        }\n+        return (Map<String, Object>) nucleus.get(PARAMETERS_CONFIG_KEY);\n+    }\n+\n+    private boolean iotRoleAliasHasChanged(Map<String, Object> newNucleusParameters,\n+                                           DeviceConfiguration currentDeviceConfiguration) {\n+        String newIotRoleAlias = Coerce.toString(newNucleusParameters.get(IOT_ROLE_ALIAS_TOPIC));\n+        String currentIotRoleAlias = Coerce.toString(currentDeviceConfiguration.getIotRoleAlias());\n+\n+        if (Utils.stringHasChanged(newIotRoleAlias, currentIotRoleAlias)) {\n+            logger.atInfo().kv(IOT_ROLE_ALIAS_TOPIC, newIotRoleAlias).log(RESTART_REQUIRED_MESSAGE);\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    private boolean networkProxyIsCurrentlyUsed(DeviceConfiguration currentDeviceConfiguration) {\n+        return Utils.isNotEmpty(currentDeviceConfiguration.getProxyUrl());\n+    }\n+\n+    private boolean networkProxyHasChanged(Map<String, Object> newNucleusParameters,\n+                                           DeviceConfiguration currentDeviceConfiguration) {\n+        Map<String, Object> newNetworkProxy =\n+                (Map<String, Object>) newNucleusParameters.get(DEVICE_NETWORK_PROXY_NAMESPACE);\n+        if (newNetworkProxy == null) {\n+            return false;\n+        }\n+\n+        String newNoProxyAddresses = Coerce.toString(newNetworkProxy.get(DEVICE_PARAM_NO_PROXY_ADDRESSES));\n+        String currentNoProxyAddresses = Coerce.toString(currentDeviceConfiguration.getNoProxyAddresses());\n+        if (Utils.stringHasChanged(newNoProxyAddresses, currentNoProxyAddresses)) {\n+            logger.atInfo().kv(DEVICE_NETWORK_PROXY_NAMESPACE.concat(\".\").concat(DEVICE_PARAM_NO_PROXY_ADDRESSES),", "originalCommit": "582daa84e513f6d0379526f8fe689b29cf73e4f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NzQ5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516197491", "bodyText": "Done", "author": "tomnagy-aws", "createdAt": "2020-11-02T19:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5ODA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5OTQ4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516099483", "bodyText": "This isn't correct because it could have a different name, you'd need to search for the component by type.", "author": "MikeDombo", "createdAt": "2020-11-02T16:35:18Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -127,10 +139,101 @@ public boolean isBootstrapRequired(Map<String, Object> newConfig)\n         return nucleusConfigValidAndNeedsRestart || !bootstrapTaskStatusList.isEmpty();\n     }\n \n+    private Map<String, Object> getNucleusParametersFromDeploymentConfig(Map<String, Object> newConfig) {\n+        Map<String, Object> services = (Map<String, Object>) newConfig.get(SERVICES_NAMESPACE_TOPIC);\n+        if (services == null) {\n+            return null;\n+        }\n+        Map<String, Object> nucleus = (Map<String, Object>) services.get(DEFAULT_NUCLEUS_COMPONENT_NAME);", "originalCommit": "582daa84e513f6d0379526f8fe689b29cf73e4f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5Nzk2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516197962", "bodyText": "Using getProposedNucleusConfig which searches for ComponentType.NUCLEUS", "author": "tomnagy-aws", "createdAt": "2020-11-02T19:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5OTQ4Mw=="}], "type": "inlineReview"}, {"oid": "2421e1ac5af67089643784f027fc76ec893fbd84", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2421e1ac5af67089643784f027fc76ec893fbd84", "message": "Addressing feedback", "committedDate": "2020-11-02T19:12:08Z", "type": "commit"}, {"oid": "527fbdaeb3bfae8a143191230a2c12bc2b4fd6e5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/527fbdaeb3bfae8a143191230a2c12bc2b4fd6e5", "message": "Merge branch 'master' into proxy-change-restart", "committedDate": "2020-11-02T19:17:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMTg0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516201849", "bodyText": "remove all the concats everywhere", "author": "MikeDombo", "createdAt": "2020-11-02T19:22:06Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -127,10 +136,62 @@ public boolean isBootstrapRequired(Map<String, Object> newConfig)\n         return nucleusConfigValidAndNeedsRestart || !bootstrapTaskStatusList.isEmpty();\n     }\n \n+    private boolean networkProxyHasChanged(Map<String, Object> newNucleusParameters,\n+                                           DeviceConfiguration currentDeviceConfiguration) {\n+        Map<String, Object> newNetworkProxy =\n+                (Map<String, Object>) newNucleusParameters.get(DEVICE_NETWORK_PROXY_NAMESPACE);\n+        if (newNetworkProxy == null) {\n+            return false;\n+        }\n+\n+        String newNoProxyAddresses = Coerce.toString(newNetworkProxy.get(DEVICE_PARAM_NO_PROXY_ADDRESSES));\n+        String currentNoProxyAddresses = Coerce.toString(currentDeviceConfiguration.getNoProxyAddresses());\n+        if (Utils.stringHasChanged(newNoProxyAddresses, currentNoProxyAddresses)) {\n+            logger.atInfo().kv(DEVICE_PARAM_NO_PROXY_ADDRESSES, newNoProxyAddresses).log(RESTART_REQUIRED_MESSAGE);\n+            return true;\n+        }\n+\n+        Map<String, Object> newProxy = (Map<String, Object>) newNetworkProxy.get(DEVICE_PROXY_NAMESPACE);\n+        String newProxyUrl = Coerce.toString(newProxy.get(DEVICE_PARAM_PROXY_URL));\n+        String currentProxyUrl = Coerce.toString(currentDeviceConfiguration.getProxyUrl());\n+        if (Utils.stringHasChanged(newProxyUrl, currentProxyUrl)) {\n+            logger.atInfo().kv(DEVICE_NETWORK_PROXY_NAMESPACE.concat(\".\").concat(DEVICE_PROXY_NAMESPACE).concat(\".\")", "originalCommit": "527fbdaeb3bfae8a143191230a2c12bc2b4fd6e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwNTk0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516205949", "bodyText": "done", "author": "tomnagy-aws", "createdAt": "2020-11-02T19:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMTg0OQ=="}], "type": "inlineReview"}, {"oid": "6aab2bcbf73fcf0cff91b7fe17c48779105aa180", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6aab2bcbf73fcf0cff91b7fe17c48779105aa180", "message": "Remove concats", "committedDate": "2020-11-02T19:29:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyMjU4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516222586", "bodyText": "Shouldn't this return true if the currentDeviceConfiguration has proxy settings? (in the null \"new\" case)", "author": "philcali", "createdAt": "2020-11-02T20:02:05Z", "path": "src/main/java/com/aws/greengrass/deployment/bootstrap/BootstrapManager.java", "diffHunk": "@@ -127,10 +136,59 @@ public boolean isBootstrapRequired(Map<String, Object> newConfig)\n         return nucleusConfigValidAndNeedsRestart || !bootstrapTaskStatusList.isEmpty();\n     }\n \n+    private boolean networkProxyHasChanged(Map<String, Object> newNucleusParameters,\n+                                           DeviceConfiguration currentDeviceConfiguration) {\n+        Map<String, Object> newNetworkProxy =\n+                (Map<String, Object>) newNucleusParameters.get(DEVICE_NETWORK_PROXY_NAMESPACE);\n+        if (newNetworkProxy == null) {\n+            return false;\n+        }", "originalCommit": "6aab2bcbf73fcf0cff91b7fe17c48779105aa180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NTkzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516245939", "bodyText": "It should. Updated.", "author": "tomnagy-aws", "createdAt": "2020-11-02T20:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyMjU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDczMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516224732", "bodyText": "Doesn't case matter? philcali != Philcali for things like auth, right?", "author": "philcali", "createdAt": "2020-11-02T20:06:25Z", "path": "src/main/java/com/aws/greengrass/util/Utils.java", "diffHunk": "@@ -89,6 +89,23 @@ public static Throwable flush(Object flushable) {\n         }\n     }\n \n+    /**\n+     * Returns true if the two strings are different, including null.\n+     *\n+     * @param oldValue first string\n+     * @param newValue second string\n+     * @return true if the two strings are not equal\n+     */\n+    public static boolean stringHasChanged(String oldValue, String newValue) {\n+        if (oldValue == null && newValue == null) {\n+            return false;\n+        }\n+        if ((oldValue == null) != (newValue == null)) {\n+            return true;\n+        }\n+        return !oldValue.equalsIgnoreCase(newValue);", "originalCommit": "6aab2bcbf73fcf0cff91b7fe17c48779105aa180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjA3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516246072", "bodyText": "Yup. Changed to just .equals()", "author": "tomnagy-aws", "createdAt": "2020-11-02T20:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNjI2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516226261", "bodyText": "assertTrue(Utils.stringHasChanged(\"tEsT1\", \"test1\"))", "author": "philcali", "createdAt": "2020-11-02T20:09:29Z", "path": "src/test/java/com/aws/greengrass/util/UtilsTest.java", "diffHunk": "@@ -133,4 +135,17 @@ void testInverseMap() {\n         assertThat(result.get(1), containsInAnyOrder(\"a\", \"c\"));\n         assertThat(result.get(2), containsInAnyOrder(\"b\"));\n     }\n+\n+    @Test\n+    void testStringHasChanged() {\n+        assertTrue(Utils.stringHasChanged(\"test1\", \"test2\"));\n+        assertTrue(Utils.stringHasChanged(\"test1\", null));\n+        assertTrue(Utils.stringHasChanged(null, \"test2\"));\n+        assertTrue(Utils.stringHasChanged(\"test1\", \"\"));\n+        assertTrue(Utils.stringHasChanged(\"\", \"test2\"));\n+", "originalCommit": "6aab2bcbf73fcf0cff91b7fe17c48779105aa180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NjE2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/591#discussion_r516246166", "bodyText": "Added.", "author": "tomnagy-aws", "createdAt": "2020-11-02T20:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNjI2MQ=="}], "type": "inlineReview"}, {"oid": "2f29ce690093cc7fbc37611fd8c5adcf3ba3411e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f29ce690093cc7fbc37611fd8c5adcf3ba3411e", "message": "Add restart condition for removing proxy config and make stringHasChanged case sensitive", "committedDate": "2020-11-02T20:49:23Z", "type": "commit"}, {"oid": "3661f0e6700165e43407916461a7b67fe172825d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3661f0e6700165e43407916461a7b67fe172825d", "message": "Merge branch 'master' into proxy-change-restart", "committedDate": "2020-11-02T20:50:46Z", "type": "commit"}, {"oid": "f5af1791ba2879077b324b00326208009ea3da71", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5af1791ba2879077b324b00326208009ea3da71", "message": "Fix bootstrap tests", "committedDate": "2020-11-02T21:09:43Z", "type": "commit"}, {"oid": "45a1d62bf1f3abd1a5d835481898dbd2e577b3bd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/45a1d62bf1f3abd1a5d835481898dbd2e577b3bd", "message": "Merge branch 'master' into proxy-change-restart", "committedDate": "2020-11-02T21:11:16Z", "type": "commit"}]}