{"pr_number": 237, "pr_title": "Support dependency type in package recipe", "pr_createdAt": "2020-05-13T02:37:19Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NDM0Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424544347", "bodyText": "Can this not be a Map<String, Map<...>> so that we can do dependency syntax validation right at the time of parsing and don't move further at all?", "author": "shaguptashaikh", "createdAt": "2020-05-13T15:48:47Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageRecipe.java", "diffHunk": "@@ -50,7 +52,7 @@\n     // TODO: Migrate to artifact objects, this is only a list of URLs at the moment\n     private final List<String> artifacts;\n \n-    private final Map<String, String> dependencies;\n+    private final Map<String, Object> dependencies;", "originalCommit": "68e82224cf86d65b74997bb6ad2d4e684f921127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMzM3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424613376", "bodyText": "Yeah I can try that.", "author": "hui-yang", "createdAt": "2020-05-13T17:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NDM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NTA2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424545060", "bodyText": "Nit -move out to a method?", "author": "shaguptashaikh", "createdAt": "2020-05-13T15:49:46Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -146,7 +150,21 @@ PackageRecipe getPackageRecipe(@NonNull PackageIdentifier pkgId) throws PackageL\n      * @throws PackagingException if fails to find or parse the recipe\n      */\n     PackageMetadata getPackageMetadata(@NonNull PackageIdentifier pkgId) throws PackagingException {\n-        return new PackageMetadata(pkgId, getPackageRecipe(pkgId).getDependencies());\n+        Map<String, String> dependencyMetadata = new HashMap<>();\n+        for (Map.Entry<String, Object> entry : getPackageRecipe(pkgId).getDependencies().entrySet()) {\n+            if (!(entry.getValue() instanceof Map)) {\n+                throw new PackageLoadingException(String.format(\"Illegal dependency syntax in package recipe of %s\",\n+                        pkgId));\n+            }\n+            Map<String, String> propMap = (Map<String, String>) entry.getValue();\n+            if (!propMap.containsKey(DEPENDENCY_VERSION_REQUIREMENTS_KEY)) {\n+                throw new PackageLoadingException(String.format(\n+                        \"Illegal dependency syntax in package recipe of %s: Missing %s\",\n+                        pkgId, DEPENDENCY_VERSION_REQUIREMENTS_KEY));\n+            }\n+            dependencyMetadata.put(entry.getKey(), propMap.get(DEPENDENCY_VERSION_REQUIREMENTS_KEY));\n+        }\n+        return new PackageMetadata(pkgId, dependencyMetadata);", "originalCommit": "68e82224cf86d65b74997bb6ad2d4e684f921127", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NzE2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424547169", "bodyText": "Can also move this out to a method", "author": "shaguptashaikh", "createdAt": "2020-05-13T15:52:38Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -102,13 +103,21 @@\n         }\n         resolvedServiceConfig.put(SETENV_CONFIG_NAMESPACE, resolvedSetEnvConfig);\n \n-        // TODO : Update package recipe format to include all information that service dependencies config\n-        // expects according to the new syntax e.g. dependencyType,\n-        // then change the following code accordingly\n-\n         // Generate dependencies\n-        List<String> dependencyServiceNames = new ArrayList<>(packageRecipe.getDependencies().keySet());\n-        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC, dependencyServiceNames);\n+        List<String> dependencyConfig = new ArrayList<>();\n+        for (Map.Entry<String, Object> entry : packageRecipe.getDependencies().entrySet()) {\n+            if (!(entry.getValue() instanceof Map)) {\n+                throw new PackageLoadingException(String\n+                        .format(\"Illegal dependency syntax in package recipe of %s\", packageIdentifier));\n+            }\n+            Map<String, String> propMap = (Map<String, String>) entry.getValue();\n+            if (!propMap.containsKey(DEPENDENCY_TYPE_KEY)) {\n+                dependencyConfig.add(entry.getKey());\n+                continue;\n+            }\n+            dependencyConfig.add(entry.getKey() + \":\" + propMap.get(DEPENDENCY_TYPE_KEY));\n+        }", "originalCommit": "68e82224cf86d65b74997bb6ad2d4e684f921127", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "message": "Support dependency type in package recipe", "committedDate": "2020-05-14T02:28:22Z", "type": "forcePushed"}, {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abd5e9c7eae611fda27473b73c2c37443063352f", "message": "Support dependency type in package recipe", "committedDate": "2020-05-14T02:30:14Z", "type": "commit"}, {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abd5e9c7eae611fda27473b73c2c37443063352f", "message": "Support dependency type in package recipe", "committedDate": "2020-05-14T02:30:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyNzY2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425327669", "bodyText": "Do you plan to turn this into a map as well instead of a string? Not necessary for this PR to keep changes smaller, but eventually, right?", "author": "MikeDombo", "createdAt": "2020-05-14T17:55:43Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -191,9 +189,9 @@ private String replace(String stringValue, PackageIdentifier packageIdentifier,\n \n         Map<Object, Object> mainServiceConfig = new HashMap<>();\n         ArrayList<String> mainDependencies = new ArrayList<>(rootPackages);\n-        kernel.getMain().getDependencies().keySet().forEach(evergreenService -> {\n+        kernel.getMain().getDependencies().forEach((evergreenService, dependencyType) -> {\n             if (!(evergreenService instanceof GenericExternalService)) {\n-                mainDependencies.add(evergreenService.getName());\n+                mainDependencies.add(evergreenService.getName() + \":\" + dependencyType);", "originalCommit": "abd5e9c7eae611fda27473b73c2c37443063352f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzODYwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425338604", "bodyText": "Eventually. The reason that I didn't do it now is, turning dependencies into a map implicitly means each dependency node will be a Topics. We don't have proper support to remove a config node during config merge, so when we need to remove a dependency during deployments, the old dependency won't be removed. That's a blocker for now.", "author": "hui-yang", "createdAt": "2020-05-14T18:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyNzY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyOTIzMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425329232", "bodyText": "Why not change the data type in PackageMetadata to contain all the dependency info and not just the version requirement?", "author": "MikeDombo", "createdAt": "2020-05-14T17:58:11Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -146,7 +148,10 @@ PackageRecipe getPackageRecipe(@NonNull PackageIdentifier pkgId) throws PackageL\n      * @throws PackagingException if fails to find or parse the recipe\n      */\n     PackageMetadata getPackageMetadata(@NonNull PackageIdentifier pkgId) throws PackagingException {\n-        return new PackageMetadata(pkgId, getPackageRecipe(pkgId).getDependencies());\n+        Map<String, String> dependencyMetadata = new HashMap<>();\n+        getPackageRecipe(pkgId).getDependencies().forEach((name, prop) ->\n+                dependencyMetadata.put(name, prop.getVersionRequirements()));\n+        return new PackageMetadata(pkgId, dependencyMetadata);", "originalCommit": "abd5e9c7eae611fda27473b73c2c37443063352f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MDEyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425340128", "bodyText": "It seems to me the metadata does not include any information relevant to service runtime. The way we use Metadata today doesn't care about dependencyType. This might change when we have other dependency properties. But I think we should control what's exposed in metadata", "author": "hui-yang", "createdAt": "2020-05-14T18:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyOTIzMg=="}], "type": "inlineReview"}, {"oid": "24dd3678c54978190b17aeb0c5b173943de32c41", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/24dd3678c54978190b17aeb0c5b173943de32c41", "message": "Merge branch 'master' into soft-dep-recipe", "committedDate": "2020-05-14T20:42:04Z", "type": "commit"}]}