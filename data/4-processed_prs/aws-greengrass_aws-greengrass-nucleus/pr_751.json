{"pr_number": 751, "pr_title": "Add retry on client error(e.g. network loss) during deployment", "pr_createdAt": "2020-12-03T07:21:54Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1MzUyOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534853528", "bodyText": "do you want to pull this out so it can be reused?", "author": "MikeDombo", "createdAt": "2020-12-03T07:56:24Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -157,30 +161,50 @@ private void removeRecipeDigestIfExists(ComponentIdentifier componentIdentifier)\n                 .find(Kernel.SERVICE_DIGEST_TOPIC_KEY, componentIdentifier.toString());\n         if (digestTopic != null) {\n             digestTopic.remove();\n-            logger.atInfo().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n+            logger.atDebug().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n         }\n     }\n \n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n-                                                          Map<String, Requirement> versionRequirements,\n-                                                          ComponentIdentifier localCandidate)\n-            throws PackagingException {\n+            Map<String, Requirement> versionRequirements,\n+            ComponentIdentifier localCandidate)\n+            throws PackagingException, InterruptedException {\n         ResolvedComponentVersion resolvedComponentVersion;\n-        try {\n-            resolvedComponentVersion = componentServiceHelper\n-                    .resolveComponentVersion(componentName, localCandidate == null ? null : localCandidate.getVersion(),\n-                            versionRequirements);\n-        } catch (ComponentVersionNegotiationException | NoAvailableComponentVersionException e) {\n-            logger.atInfo().setCause(e).kv(\"componentName\", componentName).kv(\"versionRequirement\", versionRequirements)\n-                    .kv(\"localVersion\", localCandidate)\n-                    .log(\"Failed to negotiate version with cloud due to a exception and trying to fall back \"\n-                            + \"to use the available local version\");\n-            if (localCandidate != null) {\n+\n+        if (localCandidate == null) {\n+            try {\n+                RetryUtils.RetryConfig clientExceptionRetryConfig =", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1NDI5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534854297", "bodyText": "infinite retries? Maybe, but I'd want to be sure of what types of error fall under SdkClientException", "author": "MikeDombo", "createdAt": "2020-12-03T07:56:49Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -157,30 +161,50 @@ private void removeRecipeDigestIfExists(ComponentIdentifier componentIdentifier)\n                 .find(Kernel.SERVICE_DIGEST_TOPIC_KEY, componentIdentifier.toString());\n         if (digestTopic != null) {\n             digestTopic.remove();\n-            logger.atInfo().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n+            logger.atDebug().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n         }\n     }\n \n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n-                                                          Map<String, Requirement> versionRequirements,\n-                                                          ComponentIdentifier localCandidate)\n-            throws PackagingException {\n+            Map<String, Requirement> versionRequirements,\n+            ComponentIdentifier localCandidate)\n+            throws PackagingException, InterruptedException {\n         ResolvedComponentVersion resolvedComponentVersion;\n-        try {\n-            resolvedComponentVersion = componentServiceHelper\n-                    .resolveComponentVersion(componentName, localCandidate == null ? null : localCandidate.getVersion(),\n-                            versionRequirements);\n-        } catch (ComponentVersionNegotiationException | NoAvailableComponentVersionException e) {\n-            logger.atInfo().setCause(e).kv(\"componentName\", componentName).kv(\"versionRequirement\", versionRequirements)\n-                    .kv(\"localVersion\", localCandidate)\n-                    .log(\"Failed to negotiate version with cloud due to a exception and trying to fall back \"\n-                            + \"to use the available local version\");\n-            if (localCandidate != null) {\n+\n+        if (localCandidate == null) {\n+            try {\n+                RetryUtils.RetryConfig clientExceptionRetryConfig =\n+                        RetryUtils.RetryConfig.builder().initialRetryInterval(Duration.ofMinutes(1))\n+                                .maxRetryInterval(Duration.ofMinutes(1)).maxAttempt(Integer.MAX_VALUE)", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI4MjY4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536282688", "bodyText": "From the java doc:\nBase type for all client exceptions thrown by the SDK. This exception is thrown when service could not be contacted for a response, or when client is unable to parse the response from service. All exceptions that extend SdkClientException are assumed to be not retryable.", "author": "fengwang666", "createdAt": "2020-12-04T18:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1NDI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg3MjI0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534872245", "bodyText": "cache the size. This gets called multiple times.", "author": "MikeDombo", "createdAt": "2020-12-03T08:07:01Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,115 +58,138 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n-        if (artifactSize != null) {\n-            return artifactSize;\n+        try {", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg3Mzc4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534873788", "bodyText": "space after period", "author": "MikeDombo", "createdAt": "2020-12-03T08:07:46Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,115 +58,138 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n-        if (artifactSize != null) {\n-            return artifactSize;\n+        try {\n+            return RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n         }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n+            }\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        }\n     }\n \n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Fail to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch.\" + \"Expected artifact size %d. HTTP contentLength %d\",", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg3NDMzNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534874336", "bodyText": "space after period", "author": "MikeDombo", "createdAt": "2020-12-03T08:08:03Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,115 +58,138 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n-        if (artifactSize != null) {\n-            return artifactSize;\n+        try {\n+            return RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n         }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n+            }\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        }\n     }\n \n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Fail to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch.\" + \"Expected artifact size %d. HTTP contentLength %d\",\n+                                    rangeEnd, httpConn.getContentLengthLong());\n+                            throw new PackageDownloadException(errMsg);\n+                        }\n+                        // 200 means server doesn't recognize the Range header and returns all contents.\n+                        // try to discard the offset number of bytes.\n+                        InputStream inputStream = httpConn.getInputStream();\n+                        long byteSkipped = inputStream.skip(rangeStart);\n+                        // If number of bytes skipped is less than declared, throw error.\n+                        if (byteSkipped != rangeStart) {\n+                            throw new PackageDownloadException(getErrorString(\"Reach the end of the stream\"));\n+                        }\n+                        long downloaded = download(inputStream, messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Fail to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else {\n+                        throw new PackageDownloadException(getErrorString(\n+                                \"Unable to download greengrass artifact. \" + \"HTTP Error: \" + responseCode));", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg3Njc3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r534876775", "bodyText": "Failed to read", "author": "MikeDombo", "createdAt": "2020-12-03T08:09:21Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/S3Downloader.java", "diffHunk": "@@ -57,44 +64,63 @@ protected String getArtifactFilename() {\n         return pathStrings[pathStrings.length - 1];\n     }\n \n-    @SuppressWarnings(\"PMD.CloseResource\")\n+    @SuppressWarnings(\n+            {\"PMD.CloseResource\", \"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     @Override\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n-            throws PackageDownloadException, InterruptedException {\n+            throws InterruptedException, PackageDownloadException {\n         String bucket = s3ObjectPath.bucket;\n         String key = s3ObjectPath.key;\n \n         S3Client regionClient = getRegionClientForBucket(bucket);\n         GetObjectRequest getObjectRequest = GetObjectRequest.builder().bucket(bucket).key(key)\n                 .range(String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd)).build();\n-        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket())\n-                .kv(\"s3-key\", getObjectRequest.key())\n+        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket()).kv(\"s3-key\", getObjectRequest.key())\n                 .kv(\"range\", getObjectRequest.range()).log(\"Getting s3 object request\");\n \n-        return runWithRetry(\"download-S3-artifact\", MAX_RETRY,() -> {\n-            try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n-                return download(inputStream, messageDigest);\n-            } catch (SdkClientException | S3Exception e) {\n-                String errorMsg = getErrorString(\"Failed to get artifact object from S3\");\n-                throw new PackageDownloadException(errorMsg, e);\n+        try {\n+            return RetryUtils.runWithRetry(s3ClientExceptionRetryConfig, () -> {\n+                try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n+                    long downloaded = download(inputStream, messageDigest);\n+                    if (downloaded == 0) {\n+                        // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                        // Therefore throw IOException to trigger the retry logic.\n+                        throw new IOException(\"Fail to read any byte from the inputStream\");", "originalCommit": "1b8d59eede294b3703e997427f1e03d4399f94bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca9e92538a3cc1c35babc319354335421bb8719b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ca9e92538a3cc1c35babc319354335421bb8719b", "message": "Add retry on client error(e.g. network loss) during deployment", "committedDate": "2020-12-03T23:52:31Z", "type": "forcePushed"}, {"oid": "f3d4fab7d352745747559f3aa95c27a6dbd2b25b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f3d4fab7d352745747559f3aa95c27a6dbd2b25b", "message": "Add unit tests for RetryUtil", "committedDate": "2020-12-04T04:48:20Z", "type": "forcePushed"}, {"oid": "d39ac44ce5025e968573b77c63dc1467ece1e1b2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d39ac44ce5025e968573b77c63dc1467ece1e1b2", "message": "Fix e2e tests failure", "committedDate": "2020-12-04T06:51:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0NTg5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536245892", "bodyText": "NIT: remove \" + \"", "author": "rbattle", "createdAt": "2020-12-04T17:05:17Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,141 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n+            }\n+        }\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch. \" + \"Expected artifact size %d. HTTP contentLength %d\",", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0OTE2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536249169", "bodyText": "why do some exceptions use getErrorString and some don't? This looks identical to line 76 but one without using getErrorString", "author": "rbattle", "createdAt": "2020-12-04T17:12:19Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,141 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0OTUxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536249511", "bodyText": "nit: formatting", "author": "rbattle", "createdAt": "2020-12-04T17:13:00Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,141 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n+            }\n+        }\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch. \" + \"Expected artifact size %d. HTTP contentLength %d\",\n+                                    rangeEnd, httpConn.getContentLengthLong());\n+                            throw new PackageDownloadException(errMsg);\n+                        }\n+                        // 200 means server doesn't recognize the Range header and returns all contents.\n+                        // try to discard the offset number of bytes.\n+                        InputStream inputStream = httpConn.getInputStream();\n+                        long byteSkipped = inputStream.skip(rangeStart);\n+                        // If number of bytes skipped is less than declared, throw error.\n+                        if (byteSkipped != rangeStart) {\n+                            throw new PackageDownloadException(getErrorString(\"Reach the end of the stream\"));\n+                        }\n+                        long downloaded = download(inputStream, messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else {\n+                        throw new PackageDownloadException(getErrorString(\n+                                \"Unable to download Greengrass artifact. \" + \"HTTP Error: \" + responseCode));", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0OTYxNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536249616", "bodyText": "nit: stream", "author": "rbattle", "createdAt": "2020-12-04T17:13:12Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,141 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n+            }\n+        }\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch. \" + \"Expected artifact size %d. HTTP contentLength %d\",\n+                                    rangeEnd, httpConn.getContentLengthLong());\n+                            throw new PackageDownloadException(errMsg);\n+                        }\n+                        // 200 means server doesn't recognize the Range header and returns all contents.\n+                        // try to discard the offset number of bytes.\n+                        InputStream inputStream = httpConn.getInputStream();\n+                        long byteSkipped = inputStream.skip(rangeStart);\n+                        // If number of bytes skipped is less than declared, throw error.\n+                        if (byteSkipped != rangeStart) {\n+                            throw new PackageDownloadException(getErrorString(\"Reach the end of the stream\"));\n+                        }\n+                        long downloaded = download(inputStream, messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0OTc4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536249788", "bodyText": "nit: stream", "author": "rbattle", "createdAt": "2020-12-04T17:13:30Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,141 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(\"Failed to get download size\");\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\"Failed to get download size. HTTP response: \" + responseCode);\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n+            }\n+        }\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTc1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536251751", "bodyText": "you have this in 3 places. Should download(inputStream, messageDigest); just throw the exception itself so you don't have to do it everywhere you call it?", "author": "rbattle", "createdAt": "2020-12-04T17:16:52Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/S3Downloader.java", "diffHunk": "@@ -57,44 +64,63 @@ protected String getArtifactFilename() {\n         return pathStrings[pathStrings.length - 1];\n     }\n \n-    @SuppressWarnings(\"PMD.CloseResource\")\n+    @SuppressWarnings(\n+            {\"PMD.CloseResource\", \"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     @Override\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n-            throws PackageDownloadException, InterruptedException {\n+            throws InterruptedException, PackageDownloadException {\n         String bucket = s3ObjectPath.bucket;\n         String key = s3ObjectPath.key;\n \n         S3Client regionClient = getRegionClientForBucket(bucket);\n         GetObjectRequest getObjectRequest = GetObjectRequest.builder().bucket(bucket).key(key)\n                 .range(String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd)).build();\n-        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket())\n-                .kv(\"s3-key\", getObjectRequest.key())\n+        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket()).kv(\"s3-key\", getObjectRequest.key())\n                 .kv(\"range\", getObjectRequest.range()).log(\"Getting s3 object request\");\n \n-        return runWithRetry(\"download-S3-artifact\", MAX_RETRY,() -> {\n-            try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n-                return download(inputStream, messageDigest);\n-            } catch (SdkClientException | S3Exception e) {\n-                String errorMsg = getErrorString(\"Failed to get artifact object from S3\");\n-                throw new PackageDownloadException(errorMsg, e);\n+        try {\n+            return RetryUtils.runWithRetry(s3ClientExceptionRetryConfig, () -> {\n+                try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n+                    long downloaded = download(inputStream, messageDigest);\n+                    if (downloaded == 0) {\n+                        // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                        // Therefore throw IOException to trigger the retry logic.\n+                        throw new IOException(\"Failed to read any byte from the inputStream\");\n+                    } else {\n+                        return downloaded;\n+                    }", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI3ODM3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536278373", "bodyText": "download(inputStream, messageDigest) can succeed partially and the caller needs to know how many bytes has been read successfully before the exception. That's why it's a bit awkward.", "author": "fengwang666", "createdAt": "2020-12-04T18:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1NjQ1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536256454", "bodyText": "nit: break\nor can you do:\nretryable = retryConfig.retryableExceptions.stream().anyMatch(c -> c.isInstance(e))\ncan retryable be local to this catch block? I don't see it being used outside of here.", "author": "rbattle", "createdAt": "2020-12-04T17:24:37Z", "path": "src/main/java/com/aws/greengrass/util/RetryUtils.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import com.aws.greengrass.logging.api.Logger;\n+import lombok.Builder;\n+import lombok.Getter;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+public class RetryUtils {\n+\n+    // Need this to make spotbug check happy\n+    private RetryUtils() {\n+    }\n+\n+    /**\n+     * Run a task with retry. Only exceptions in the retryable exception list are retried. Stop the retry when\n+     * interrupted.\n+     *\n+     * @param retryConfig     retry configuration\n+     * @param task            task to run\n+     * @param taskDescription task description\n+     * @param logger          logger\n+     * @param <T>             return type\n+     * @return return value\n+     * @throws Exception Exception\n+     */\n+    @SuppressWarnings({\"PMD.SignatureDeclareThrowsException\", \"PMD.AvoidCatchingGenericException\",\n+            \"PMD.AvoidInstanceofChecksInCatchClause\"})\n+    public static <T> T runWithRetry(RetryConfig retryConfig, CrashableSupplier<T, Exception> task,\n+            String taskDescription, Logger logger) throws Exception {\n+        long retryInterval = retryConfig.getInitialRetryInterval().toMillis();\n+        int attempt = 1;\n+        Exception lastException = null;\n+        boolean retryable = false;\n+        while (attempt <= retryConfig.maxAttempt) {\n+            if (Thread.currentThread().isInterrupted()) {\n+                throw new InterruptedException(taskDescription + \" task is interrupted\");\n+            }\n+            try {\n+                return task.apply();\n+            } catch (Exception e) {\n+                if (e instanceof InterruptedException) {\n+                    throw e;\n+                }\n+\n+                for (Class retryableException : retryConfig.retryableExceptions) {\n+                    if (retryableException.isInstance(e)) {\n+                        retryable = true;", "originalCommit": "b4210e74143e77bf5378a4e0976cf13e6f57da4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0NzM2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536347363", "bodyText": "Can we add back SemverException? new Semver() can throw this error. compVersion is parsed from file names so it may not be reliable", "author": "hui-yang", "createdAt": "2020-12-04T20:00:38Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -417,13 +438,14 @@ public void cleanupStaleVersions() throws PackageLoadingException {\n                     ComponentIdentifier identifier = new ComponentIdentifier(compName, new Semver(compVersion));\n                     removeRecipeDigestIfExists(identifier);\n                     componentStore.deleteComponent(identifier);\n-                } catch (SemverException e) {", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NjQ4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536396481", "bodyText": "Thanks! I didn't know SemverException is an unchecked exception.", "author": "fengwang666", "createdAt": "2020-12-04T21:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0NzM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0ODk4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536348983", "bodyText": "I'm yet to read logic in RetryUtils but resolveComponentVersion wraps SdkClientException into a ComponentVersionNegotiationException. Need to make sure this retry logic works.", "author": "hui-yang", "createdAt": "2020-12-04T20:03:50Z", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -157,30 +165,45 @@ private void removeRecipeDigestIfExists(ComponentIdentifier componentIdentifier)\n                 .find(Kernel.SERVICE_DIGEST_TOPIC_KEY, componentIdentifier.toString());\n         if (digestTopic != null) {\n             digestTopic.remove();\n-            logger.atInfo().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n+            logger.atDebug().kv(COMPONENT_STR, componentIdentifier).log(\"Remove digest from store\");\n         }\n     }\n \n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n-                                                          Map<String, Requirement> versionRequirements,\n-                                                          ComponentIdentifier localCandidate)\n-            throws PackagingException {\n+            Map<String, Requirement> versionRequirements,\n+            ComponentIdentifier localCandidate)\n+            throws PackagingException, InterruptedException {\n         ResolvedComponentVersion resolvedComponentVersion;\n-        try {\n-            resolvedComponentVersion = componentServiceHelper\n-                    .resolveComponentVersion(componentName, localCandidate == null ? null : localCandidate.getVersion(),\n-                            versionRequirements);\n-        } catch (ComponentVersionNegotiationException | NoAvailableComponentVersionException e) {\n-            logger.atInfo().setCause(e).kv(\"componentName\", componentName).kv(\"versionRequirement\", versionRequirements)\n-                    .kv(\"localVersion\", localCandidate)\n-                    .log(\"Failed to negotiate version with cloud due to a exception and trying to fall back \"\n-                            + \"to use the available local version\");\n-            if (localCandidate != null) {\n+\n+        if (localCandidate == null) {\n+            try {\n+                resolvedComponentVersion = RetryUtils.runWithRetry(clientExceptionRetryConfig,\n+                        () -> componentServiceHelper.resolveComponentVersion(componentName, null, versionRequirements),\n+                        \"resolve-component-version\", logger);", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5Mzg2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536393863", "bodyText": "Good catch.", "author": "fengwang666", "createdAt": "2020-12-04T21:37:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0ODk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1MDYxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536350617", "bodyText": "Does the 2nd PackageDownloadException need to be retried? depending on response code?", "author": "hui-yang", "createdAt": "2020-12-04T20:06:55Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,142 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(getErrorString(\"Failed to get download size\"));\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\n+                        getErrorString(\"Failed to get download size. HTTP response: \" + responseCode));", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwODY5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536408692", "bodyText": "hmmm....I decided to put it off for now. It's a bit convoluted to handle the different HTTP response codes.", "author": "fengwang666", "createdAt": "2020-12-04T22:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1MDYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1MTUxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536351511", "bodyText": "same. SdkClientException is wrapped into PackageDownloadException", "author": "hui-yang", "createdAt": "2020-12-04T20:08:51Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,142 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwMDU0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536400546", "bodyText": "Can you point me to the code? I think I already handled it correctly. The SdkClientException is only wrapped after retry.", "author": "fengwang666", "createdAt": "2020-12-04T21:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1MTUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMzIyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536423226", "bodyText": "You're right. I missed that.", "author": "hui-yang", "createdAt": "2020-12-04T22:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1MTUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1NDc3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536354771", "bodyText": "Seems this merged two case compared to before. Does this need retry?", "author": "hui-yang", "createdAt": "2020-12-04T20:15:13Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -49,114 +59,142 @@ protected String getArtifactFilename() {\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     public Long getDownloadSize() throws PackageDownloadException, InterruptedException {\n         if (artifactSize != null) {\n             return artifactSize;\n         }\n+        try {\n+            artifactSize = RetryUtils\n+                    .runWithRetry(clientExceptionRetryConfig, () -> getDownloadSizeWithoutRetry(), \"get-artifact-size\",\n+                            logger);\n+            return artifactSize;\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to get download size\"), e);\n+            }\n+        }\n+    }\n \n+    private Long getDownloadSizeWithoutRetry() throws InterruptedException, PackageDownloadException, IOException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        runWithRetry(\"get-artifact-info\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                httpConn = connect(url);\n-                int responseCode = httpConn.getResponseCode();\n-                if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    long length = httpConn.getContentLengthLong();\n-                    if (length == -1) {\n-                        throw new PackageDownloadException(\"Failed to get download size\");\n-                    }\n-                    this.artifactSize = length;\n-                } else {\n-                    throw new PackageDownloadException(\"Failed to check greengrass artifact. HTTP response: \"\n-                            + responseCode);\n-                }\n-            } finally {\n-                if (httpConn != null) {\n-                    httpConn.disconnect();\n+        HttpURLConnection httpConn = null;\n+        try {\n+            httpConn = connect(url);\n+            int responseCode = httpConn.getResponseCode();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                long length = httpConn.getContentLengthLong();\n+                if (length == -1) {\n+                    throw new PackageDownloadException(getErrorString(\"Failed to get download size\"));\n                 }\n+                return length;\n+            } else {\n+                throw new PackageDownloadException(\n+                        getErrorString(\"Failed to get download size. HTTP response: \" + responseCode));\n             }\n-            return null;\n-        });\n-        return artifactSize;\n+        } finally {\n+            if (httpConn != null) {\n+                httpConn.disconnect();\n+            }\n+        }\n     }\n \n     @Override\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n             throws PackageDownloadException, InterruptedException {\n         URL url = getArtifactDownloadURL(identifier, artifact.getArtifactUri().getSchemeSpecificPart());\n \n-        return runWithRetry(\"establish HTTP connection\", MAX_RETRY, () -> {\n-            HttpURLConnection httpConn = null;\n-            try {\n-                // establish http connection\n-                httpConn = connect(url);\n-                httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n-                        String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n-                int responseCode = httpConn.getResponseCode();\n-\n-                // check response code\n-                if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n-                    return download(httpConn.getInputStream(), messageDigest);\n-                } else if (responseCode == HttpURLConnection.HTTP_OK) {\n-                    if (httpConn.getContentLengthLong() < rangeEnd) {\n-                        String errMsg = String.format(\"Artifact size mismatch.\"\n-                               + \"Expected artifact size %d. HTTP contentLength %d\",\n-                               rangeEnd, httpConn.getContentLengthLong());\n-                        throw new PackageDownloadException(errMsg);\n+        try {\n+            return RetryUtils.runWithRetry(clientExceptionRetryConfig, () -> {\n+                HttpURLConnection httpConn = null;\n+                try {\n+                    // establish http connection\n+                    httpConn = connect(url);\n+                    httpConn.setRequestProperty(HTTP_RANGE_HEADER_KEY,\n+                            String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd));\n+                    int responseCode = httpConn.getResponseCode();\n+\n+                    // check response code\n+                    if (responseCode == HttpURLConnection.HTTP_PARTIAL) {\n+                        long downloaded = download(httpConn.getInputStream(), messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the input stream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(getErrorString(\"Failed to read any byte from the stream\"));\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else if (responseCode == HttpURLConnection.HTTP_OK) {\n+                        if (httpConn.getContentLengthLong() < rangeEnd) {\n+                            String errMsg = String.format(\n+                                    \"Artifact size mismatch. Expected artifact size %d. HTTP contentLength %d\",\n+                                    rangeEnd, httpConn.getContentLengthLong());\n+                            throw new PackageDownloadException(getErrorString(errMsg));\n+                        }\n+                        // 200 means server doesn't recognize the Range header and returns all contents.\n+                        // try to discard the offset number of bytes.\n+                        InputStream inputStream = httpConn.getInputStream();\n+                        long byteSkipped = inputStream.skip(rangeStart);\n+                        // If number of bytes skipped is less than declared, throw error.\n+                        if (byteSkipped != rangeStart) {\n+                            throw new PackageDownloadException(getErrorString(\"Reach the end of the stream\"));\n+                        }\n+                        long downloaded = download(inputStream, messageDigest);\n+                        if (downloaded == 0) {\n+                            // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                            // Therefore throw IOException to trigger the retry logic.\n+                            throw new IOException(\"Failed to read any byte from the inputStream\");\n+                        } else {\n+                            return downloaded;\n+                        }\n+                    } else {\n+                        throw new PackageDownloadException(getErrorString(", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwOTc4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536409786", "bodyText": "Similar to the previous comment. I decided to put off handling retry server side errors for raw HTTP client.", "author": "fengwang666", "createdAt": "2020-12-04T22:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1NDc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2Mzg2NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536363865", "bodyText": "Seems createNewDeployment is skipped for local deployment?", "author": "hui-yang", "createdAt": "2020-12-04T20:33:44Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -191,46 +190,50 @@ protected void startup() throws InterruptedException {\n             // the waiting on currentProcessStatus in its own thread. I currently choose to not do this.\n             Deployment deployment = deploymentQueue.peek();\n             if (deployment != null) {\n-                if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()\n-                        .equals(deployment.getDeploymentType()) && deployment.isCancelled()\n-                        && currentDeploymentTaskMetadata.isCancellable()) {\n-                    logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n-                            .log(\"Canceling current deployment\");\n-                    // Assuming cancel will either cancel the current deployment or wait till it finishes\n-                    cancelCurrentDeployment();\n-                }\n-                if (currentDeploymentTaskMetadata != null && deployment.getId()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentId()) && deployment.getDeploymentType()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n-                    // Duplicate message and already processing this deployment so nothing is needed\n+                if (deployment.isCancelled()) {\n+                    // Handle IoT Jobs cancellation\n                     deploymentQueue.remove();\n-                    continue;\n-                }\n-                if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n-                    // A new device deployment invalidates the previous deployment, cancel the ongoing device deployment\n-                    // and wait till the new device deployment can be picked up.\n-                    if (currentDeploymentTaskMetadata != null && DeploymentType.SHADOW.equals(\n-                            currentDeploymentTaskMetadata.getDeploymentType())) {\n+                    if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()\n+                            .equals(deployment.getDeploymentType()) && currentDeploymentTaskMetadata.isCancellable()) {\n                         logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n-                                .log(\"Canceling current device deployment\");\n+                                .log(\"Canceling current deployment\");\n+                        // Send interrupt signal to the deployment task.\n                         cancelCurrentDeployment();\n-                        continue;\n+                    } else if (currentDeploymentTaskMetadata != null && !currentDeploymentTaskMetadata\n+                            .isCancellable()) {\n+                        logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                                .log(\"The current deployment cannot be cancelled\");\n                     }\n+                } else if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n                     // On device start up, Shadow listener will fetch the shadow and schedule a shadow deployment\n                     // Discard the deployment if Kernel starts up from a tlog file and has already processed deployment\n                     if (deployment.getId()\n                             .equals(Coerce.toString(config.lookup(LAST_SUCCESSFUL_SHADOW_DEPLOYMENT_ID_TOPIC)))) {\n+                        logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, deployment.getId())\n+                                .log(\"Skip the already processed shadow deployment\");\n+                        deploymentQueue.remove();\n+                    } else if (currentDeploymentTaskMetadata != null && DeploymentType.SHADOW\n+                            .equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n+                        // A new device deployment invalidates the previous deployment, cancel the ongoing device\n+                        //deployment and wait till the new device deployment can be picked up.\n+                        logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                                .log(\"Canceling current device deployment\");\n+                        cancelCurrentDeployment();\n+                    } else if (currentDeploymentTaskMetadata == null) {\n                         deploymentQueue.remove();\n-                        continue;\n+                        createNewDeployment(deployment);\n+                    }\n+                } else if (deployment.getDeploymentType().equals(DeploymentType.IOT_JOBS)) {\n+                    if (currentDeploymentTaskMetadata != null && deployment.getId()\n+                            .equals(currentDeploymentTaskMetadata.getDeploymentId()) && deployment.getDeploymentType()\n+                            .equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n+                        deploymentQueue.remove();\n+                        logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, deployment.getId())\n+                                .log(\"Skip the duplicated IoT Jobs deployment\");\n+                    } else if (currentDeploymentTaskMetadata == null) {\n+                        deploymentQueue.remove();\n+                        createNewDeployment(deployment);", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNTI5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536415292", "bodyText": "Good catch! Unfortunately we don't have a unit test catching this :(", "author": "fengwang666", "createdAt": "2020-12-04T22:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2Mzg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2Njc3MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536366771", "bodyText": "Nit - This code is very similar to an existing class https://github.com/aws/aws-greengrass-nucleus/blob/master/src/main/java/com/aws/greengrass/util/BaseRetryableAccessor.java Would be nice to consolidate if we have the time", "author": "shaguptashaikh", "createdAt": "2020-12-04T20:40:04Z", "path": "src/main/java/com/aws/greengrass/util/RetryUtils.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import com.aws.greengrass.logging.api.Logger;\n+import lombok.Builder;\n+import lombok.Getter;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+public class RetryUtils {\n+\n+    // Need this to make spotbug check happy\n+    private RetryUtils() {\n+    }\n+\n+    /**\n+     * Run a task with retry. Only exceptions in the retryable exception list are retried. Stop the retry when\n+     * interrupted.\n+     *\n+     * @param retryConfig     retry configuration\n+     * @param task            task to run\n+     * @param taskDescription task description\n+     * @param logger          logger\n+     * @param <T>             return type\n+     * @return return value\n+     * @throws Exception Exception\n+     */\n+    @SuppressWarnings({\"PMD.SignatureDeclareThrowsException\", \"PMD.AvoidCatchingGenericException\",\n+            \"PMD.AvoidInstanceofChecksInCatchClause\"})\n+    public static <T> T runWithRetry(RetryConfig retryConfig, CrashableSupplier<T, Exception> task,", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2ODgyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536368821", "bodyText": "Why do we remove this? If we don't wait for currentDeploymentTaskMetadata.getDeploymentResultFuture to finish and remove the pointer, will we start processing a new deployment before this one finishes?", "author": "hui-yang", "createdAt": "2020-12-04T20:44:06Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -381,32 +384,20 @@ private void cancelCurrentDeployment() {\n                                 .getDeploymentDocumentObj().getDeploymentId());\n                 if (canCancelDeployment) {\n                     currentDeploymentTaskMetadata.getDeploymentResultFuture().cancel(true);\n+                    if (DeploymentType.SHADOW.equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n+                        deploymentStatusKeeper\n+                                .persistAndPublishDeploymentStatus(currentDeploymentTaskMetadata.getDeploymentId(),\n+                                        currentDeploymentTaskMetadata.getDeploymentType(),\n+                                        JobStatus.CANCELED.toString(), new HashMap<>());\n+                    }\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment was cancelled\");\n                 } else {\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment is in a stage where it cannot be cancelled,\"\n                                          + \" need to wait for it to finish\");\n-                    try {\n-                        currentDeploymentTaskMetadata.getDeploymentResultFuture().get();", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzM0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536417342", "bodyText": "The idea is to make cancelCurrentDeployment not block any more. Since currentDeploymentTaskMetadata is not set null (line409 is removed), a new deployment will be waited in the queue until the current deployment is finished.", "author": "fengwang666", "createdAt": "2020-12-04T22:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2ODgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyNTg2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536425864", "bodyText": "Does it mean if deployment is cancelled from cloud, we still wait for deployment to finish and report status back?\nNot a concern, but the status report will be rejected in iot jobs.\nI'm not sure about shadow deployment reporting.", "author": "hui-yang", "createdAt": "2020-12-04T22:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2ODgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzMzc5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536433793", "bodyText": "When a deployment is cancelled from cloud, the main thread of deploymentService will call cancelCurrentDeployment, which then cancels the deployment result future. The cancellation of the future will send an interrupt signal to the DeploymentTask thread. The deployment task thread will exit as soon as it get notified with the interrupt. In the deployment task code path, all the blocking operations and while loops should check interrupt flag periodically. Once deployment task exits, finishCurrentDeployment will also return with a CancellationException when next time the deployment service main loop gets there.", "author": "fengwang666", "createdAt": "2020-12-04T23:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM2ODgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzM0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536373348", "bodyText": "Does isInstance check cause of an exception?", "author": "hui-yang", "createdAt": "2020-12-04T20:53:36Z", "path": "src/main/java/com/aws/greengrass/util/RetryUtils.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import com.aws.greengrass.logging.api.Logger;\n+import lombok.Builder;\n+import lombok.Getter;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+public class RetryUtils {\n+\n+    // Need this to make spotbug check happy\n+    private RetryUtils() {\n+    }\n+\n+    /**\n+     * Run a task with retry. Only exceptions in the retryable exception list are retried. Stop the retry when\n+     * interrupted.\n+     *\n+     * @param retryConfig     retry configuration\n+     * @param task            task to run\n+     * @param taskDescription task description\n+     * @param logger          logger\n+     * @param <T>             return type\n+     * @return return value\n+     * @throws Exception Exception\n+     */\n+    @SuppressWarnings({\"PMD.SignatureDeclareThrowsException\", \"PMD.AvoidCatchingGenericException\",\n+            \"PMD.AvoidInstanceofChecksInCatchClause\"})\n+    public static <T> T runWithRetry(RetryConfig retryConfig, CrashableSupplier<T, Exception> task,\n+            String taskDescription, Logger logger) throws Exception {\n+        long retryInterval = retryConfig.getInitialRetryInterval().toMillis();\n+        int attempt = 1;\n+        Exception lastException = null;\n+        while (attempt <= retryConfig.maxAttempt) {\n+            if (Thread.currentThread().isInterrupted()) {\n+                throw new InterruptedException(taskDescription + \" task is interrupted\");\n+            }\n+            try {\n+                return task.apply();\n+            } catch (Exception e) {\n+                if (e instanceof InterruptedException) {\n+                    throw e;\n+                }\n+                if (retryConfig.retryableExceptions.stream().anyMatch(c -> c.isInstance(e))) {", "originalCommit": "57584c1934859b972a05905b1e6e3fbc2cb06190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzgxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536417813", "bodyText": "It doesn't. Does it need to be?", "author": "fengwang666", "createdAt": "2020-12-04T22:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMzg0NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r536423845", "bodyText": "If we handle it here #751 (comment), it should be fine too", "author": "hui-yang", "createdAt": "2020-12-04T22:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzM0OA=="}], "type": "inlineReview"}, {"oid": "c2f2eef9b636f8c900101a9813a3ffa64265822a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c2f2eef9b636f8c900101a9813a3ffa64265822a", "message": "Address comments, add more unit tests", "committedDate": "2020-12-05T05:46:03Z", "type": "forcePushed"}, {"oid": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "message": "Add retry on get bucket region", "committedDate": "2020-12-07T23:40:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2Nzg0Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537967846", "bodyText": "this seems awkward - why not\ntry {\n} catch (InterruptedException e) {\n// rethrow\n} catch (S3Exception e) {\n// get the region\n} catch (Exception e) {\n  throw new PackageDwonloadingException\n}", "author": "rbattle", "createdAt": "2020-12-08T01:44:24Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/S3Downloader.java", "diffHunk": "@@ -57,59 +64,90 @@ protected String getArtifactFilename() {\n         return pathStrings[pathStrings.length - 1];\n     }\n \n-    @SuppressWarnings(\"PMD.CloseResource\")\n+    @SuppressWarnings(\n+            {\"PMD.CloseResource\", \"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     @Override\n     protected long download(long rangeStart, long rangeEnd, MessageDigest messageDigest)\n-            throws PackageDownloadException, InterruptedException {\n+            throws InterruptedException, PackageDownloadException {\n         String bucket = s3ObjectPath.bucket;\n         String key = s3ObjectPath.key;\n \n         S3Client regionClient = getRegionClientForBucket(bucket);\n         GetObjectRequest getObjectRequest = GetObjectRequest.builder().bucket(bucket).key(key)\n                 .range(String.format(HTTP_RANGE_HEADER_FORMAT, rangeStart, rangeEnd)).build();\n-        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket())\n-                .kv(\"s3-key\", getObjectRequest.key())\n+        logger.atDebug().kv(\"bucket\", getObjectRequest.bucket()).kv(\"s3-key\", getObjectRequest.key())\n                 .kv(\"range\", getObjectRequest.range()).log(\"Getting s3 object request\");\n \n-        return runWithRetry(\"download-S3-artifact\", MAX_RETRY,() -> {\n-            try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n-                return download(inputStream, messageDigest);\n-            } catch (SdkClientException | S3Exception e) {\n-                String errorMsg = getErrorString(\"Failed to get artifact object from S3\");\n-                throw new PackageDownloadException(errorMsg, e);\n+        try {\n+            return RetryUtils.runWithRetry(s3ClientExceptionRetryConfig, () -> {\n+                try (InputStream inputStream = regionClient.getObject(getObjectRequest)) {\n+                    long downloaded = download(inputStream, messageDigest);\n+                    if (downloaded == 0) {\n+                        // If 0 byte is read, it's fairly certain that the inputStream is closed.\n+                        // Therefore throw IOException to trigger the retry logic.\n+                        throw new IOException(\"Failed to read any byte from the inputStream\");\n+                    } else {\n+                        return downloaded;\n+                    }\n+                }\n+            }, \"download-S3-artifact\", logger);\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to download object from S3\"), e);\n             }\n-        });\n+        }\n     }\n \n-    @SuppressWarnings(\"PMD.CloseResource\")\n+    @SuppressWarnings(\n+            {\"PMD.CloseResource\", \"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n     @Override\n-    public Long getDownloadSize() throws PackageDownloadException {\n+    public Long getDownloadSize() throws InterruptedException, PackageDownloadException {\n         logger.atInfo().setEventType(\"get-download-size-from-s3\").log();\n         // Parse artifact path\n         String key = s3ObjectPath.key;\n         String bucket = s3ObjectPath.bucket;\n         try {\n             S3Client regionClient = getRegionClientForBucket(bucket);\n             HeadObjectRequest headObjectRequest = HeadObjectRequest.builder().bucket(bucket).key(key).build();\n-            HeadObjectResponse headObjectResponse = regionClient.headObject(headObjectRequest);\n-            return headObjectResponse.contentLength();\n-        } catch (SdkClientException | S3Exception e) {\n-            throw new PackageDownloadException(getErrorString(\"Failed to head artifact object from S3\"), e);\n+            return RetryUtils.runWithRetry(s3ClientExceptionRetryConfig, () -> {\n+                HeadObjectResponse headObjectResponse = regionClient.headObject(headObjectRequest);\n+                return headObjectResponse.contentLength();\n+            }, \"get-download-size-from-s3\", logger);\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to head artifact object from S3\"), e);\n+            }\n         }\n     }\n \n-    private S3Client getRegionClientForBucket(String bucket) {\n+    @SuppressWarnings(\n+            {\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidInstanceofChecksInCatchClause\"})\n+    private S3Client getRegionClientForBucket(String bucket) throws InterruptedException, PackageDownloadException {\n         GetBucketLocationRequest getBucketLocationRequest = GetBucketLocationRequest.builder().bucket(bucket).build();\n         String region = null;\n         try {\n+            region = RetryUtils.runWithRetry(s3ClientExceptionRetryConfig,\n+                    () -> s3ClientFactory.getS3Client().getBucketLocation(getBucketLocationRequest)\n+                            .locationConstraintAsString(), \"get-bucket-location\", logger);\n             region = s3ClientFactory.getS3Client().getBucketLocation(getBucketLocationRequest)\n                     .locationConstraintAsString();\n-        } catch (S3Exception e) {\n-            String message = e.getMessage();\n-            if (message.contains(REGION_EXPECTING_STRING)) {\n-                message =\n-                        message.substring(message.indexOf(REGION_EXPECTING_STRING) + REGION_EXPECTING_STRING.length());\n-                region = message.substring(0, message.indexOf('\\''));\n+        } catch (Exception e) {\n+            if (e instanceof S3Exception) {\n+                String message = e.getMessage();\n+                if (message.contains(REGION_EXPECTING_STRING)) {\n+                    message =\n+                            message.substring(\n+                                    message.indexOf(REGION_EXPECTING_STRING) + REGION_EXPECTING_STRING.length());\n+                    region = message.substring(0, message.indexOf('\\''));\n+                }\n+            } else if (e instanceof InterruptedException) {\n+                throw (InterruptedException) e;\n+            } else {\n+                throw new PackageDownloadException(getErrorString(\"Failed to head artifact object from S3\"), e);\n             }", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAyNTM2OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r538025369", "bodyText": "I don't know what I was thinking...updated.", "author": "fengwang666", "createdAt": "2020-12-08T04:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2Nzg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTA1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537969056", "bodyText": "super super nit: canceling has one \"l\" while cancelled has two-  should be \"cancelling\" or \"canceled\"\nUS English tends to use one \"l\" so I'd probably use that, while the British speaking world does 2", "author": "rbattle", "createdAt": "2020-12-08T01:47:22Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -191,46 +190,56 @@ protected void startup() throws InterruptedException {\n             // the waiting on currentProcessStatus in its own thread. I currently choose to not do this.\n             Deployment deployment = deploymentQueue.peek();\n             if (deployment != null) {\n-                if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()\n-                        .equals(deployment.getDeploymentType()) && deployment.isCancelled()\n-                        && currentDeploymentTaskMetadata.isCancellable()) {\n-                    logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n-                            .log(\"Canceling current deployment\");\n-                    // Assuming cancel will either cancel the current deployment or wait till it finishes\n-                    cancelCurrentDeployment();\n-                }\n-                if (currentDeploymentTaskMetadata != null && deployment.getId()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentId()) && deployment.getDeploymentType()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n-                    // Duplicate message and already processing this deployment so nothing is needed\n+                if (deployment.isCancelled()) {\n+                    // Handle IoT Jobs cancellation\n                     deploymentQueue.remove();\n-                    continue;\n-                }\n-                if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n-                    // A new device deployment invalidates the previous deployment, cancel the ongoing device deployment\n-                    // and wait till the new device deployment can be picked up.\n-                    if (currentDeploymentTaskMetadata != null && DeploymentType.SHADOW.equals(\n-                            currentDeploymentTaskMetadata.getDeploymentType())) {\n+                    if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()\n+                            .equals(deployment.getDeploymentType()) && currentDeploymentTaskMetadata.isCancellable()) {\n                         logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n-                                .log(\"Canceling current device deployment\");\n+                                .log(\"Canceling current deployment\");\n+                        // Send interrupt signal to the deployment task.\n                         cancelCurrentDeployment();\n-                        continue;\n+                    } else if (currentDeploymentTaskMetadata != null && !currentDeploymentTaskMetadata\n+                            .isCancellable()) {\n+                        logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                                .log(\"The current deployment cannot be cancelled\");", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAyMDMxNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r538020314", "bodyText": "Tough choice...I was going to change all the cancelled to canceled in the code but then I found Java standard library also uses cancelled. Either we'll be inconsistent.", "author": "fengwang666", "createdAt": "2020-12-08T04:11:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA0NDU0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r538044541", "bodyText": "\ud83e\udd2f", "author": "rbattle", "createdAt": "2020-12-08T05:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTU1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537969559", "bodyText": "same nit - our JobStatus is \"Canceled\" so we should use 1 'L\" here", "author": "rbattle", "createdAt": "2020-12-08T01:48:44Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -331,25 +340,25 @@ private void finishCurrentDeployment() throws InterruptedException {\n                 }\n             }\n         } catch (ExecutionException e) {\n-            logger.atError().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId()).setCause(e)\n-                    .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            HashMap<String, String> statusDetails = new HashMap<>();\n-            statusDetails.put(\"error\", t.getMessage());\n-            if (t instanceof NonRetryableDeploymentTaskFailureException\n-                    || currentDeploymentTaskMetadata.getDeploymentAttemptCount().get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n+            if (t instanceof InterruptedException) {\n+                logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                        .log(\"Deployment task is interrupted\");\n+            } else {\n+                // This code path can only occur when DeploymentTask throws unchecked exception.\n+                logger.atError().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                        .setCause(t).log(\"Deployment task throws unknown exception\");\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", t.getMessage());\n                 deploymentStatusKeeper\n                         .persistAndPublishDeploymentStatus(currentDeploymentTaskMetadata.getDeploymentId(),\n-                                                           currentDeploymentTaskMetadata.getDeploymentType(),\n-                                                           JobStatus.FAILED.toString(), statusDetails);\n+                                currentDeploymentTaskMetadata.getDeploymentType(), JobStatus.FAILED.toString(),\n+                                statusDetails);\n                 deploymentDirectoryManager.persistLastFailedDeployment();\n-            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n-                // Resubmit task, increment attempt count and return\n-                currentDeploymentTaskMetadata.setDeploymentResultFuture(\n-                        executorService.submit(currentDeploymentTaskMetadata.getDeploymentTask()));\n-                currentDeploymentTaskMetadata.getDeploymentAttemptCount().incrementAndGet();\n-                return;\n             }\n+        } catch (CancellationException e) {\n+            logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n+                    .log(\"Deployment task is cancelled\");", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTYyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537969623", "bodyText": "\"canceled\"", "author": "rbattle", "createdAt": "2020-12-08T01:48:56Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -381,32 +390,20 @@ private void cancelCurrentDeployment() {\n                                 .getDeploymentDocumentObj().getDeploymentId());\n                 if (canCancelDeployment) {\n                     currentDeploymentTaskMetadata.getDeploymentResultFuture().cancel(true);\n+                    if (DeploymentType.SHADOW.equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n+                        deploymentStatusKeeper\n+                                .persistAndPublishDeploymentStatus(currentDeploymentTaskMetadata.getDeploymentId(),\n+                                        currentDeploymentTaskMetadata.getDeploymentType(),\n+                                        JobStatus.CANCELED.toString(), new HashMap<>());\n+                    }\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment was cancelled\");", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2OTcxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537969719", "bodyText": "\"canceled\"", "author": "rbattle", "createdAt": "2020-12-08T01:49:11Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -381,32 +390,20 @@ private void cancelCurrentDeployment() {\n                                 .getDeploymentDocumentObj().getDeploymentId());\n                 if (canCancelDeployment) {\n                     currentDeploymentTaskMetadata.getDeploymentResultFuture().cancel(true);\n+                    if (DeploymentType.SHADOW.equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n+                        deploymentStatusKeeper\n+                                .persistAndPublishDeploymentStatus(currentDeploymentTaskMetadata.getDeploymentId(),\n+                                        currentDeploymentTaskMetadata.getDeploymentType(),\n+                                        JobStatus.CANCELED.toString(), new HashMap<>());\n+                    }\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment was cancelled\");\n                 } else {\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment is in a stage where it cannot be cancelled,\"", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3MTU1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r537971554", "bodyText": "this whole section is pretty tough to get through - so many nested ifs - can you add some more comments in here around under what circumstances the currentDeploymentTaskMetadata is null or not - is it the case that if something is in progress and you get another deployment, the currentDeploymentTaskMetadata will not be null?", "author": "rbattle", "createdAt": "2020-12-08T01:53:28Z", "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -191,46 +190,56 @@ protected void startup() throws InterruptedException {\n             // the waiting on currentProcessStatus in its own thread. I currently choose to not do this.\n             Deployment deployment = deploymentQueue.peek();\n             if (deployment != null) {\n-                if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()\n-                        .equals(deployment.getDeploymentType()) && deployment.isCancelled()\n-                        && currentDeploymentTaskMetadata.isCancellable()) {\n-                    logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n-                            .log(\"Canceling current deployment\");\n-                    // Assuming cancel will either cancel the current deployment or wait till it finishes\n-                    cancelCurrentDeployment();\n-                }\n-                if (currentDeploymentTaskMetadata != null && deployment.getId()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentId()) && deployment.getDeploymentType()\n-                        .equals(currentDeploymentTaskMetadata.getDeploymentType())) {\n-                    // Duplicate message and already processing this deployment so nothing is needed\n+                if (deployment.isCancelled()) {\n+                    // Handle IoT Jobs cancellation\n                     deploymentQueue.remove();\n-                    continue;\n-                }\n-                if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n-                    // A new device deployment invalidates the previous deployment, cancel the ongoing device deployment\n-                    // and wait till the new device deployment can be picked up.\n-                    if (currentDeploymentTaskMetadata != null && DeploymentType.SHADOW.equals(\n-                            currentDeploymentTaskMetadata.getDeploymentType())) {\n+                    if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA5MDQzMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r538090430", "bodyText": "added more comments.", "author": "fengwang666", "createdAt": "2020-12-08T07:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3MTU1NA=="}], "type": "inlineReview"}, {"oid": "e2c10ff8f01002893206647647c957430bbdc38e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e2c10ff8f01002893206647647c957430bbdc38e", "message": "Add retry on client error(e.g. network loss) during deployment", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "5fff3b917433b51cfb6285f0ec19f22dc4521be5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5fff3b917433b51cfb6285f0ec19f22dc4521be5", "message": "Fix unit test failure", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "c3d5e7ac9468aa53f8487cd361587c5e2cd5efef", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3d5e7ac9468aa53f8487cd361587c5e2cd5efef", "message": "Add unit tests for RetryUtil", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "d51cd353584b1fa0f23a02026f614ccb991b2bda", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d51cd353584b1fa0f23a02026f614ccb991b2bda", "message": "Fix e2e tests failure", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "1133a2295e8f17a906bad568a82fd5ba2f7d0e1d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1133a2295e8f17a906bad568a82fd5ba2f7d0e1d", "message": "Fix assertion", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "d4c80354456ed1e1fd94f9b6c5aeb449446b2477", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d4c80354456ed1e1fd94f9b6c5aeb449446b2477", "message": "Address comments", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "9992f56f1b204f83cc5323dc0d9a24bf61fe9b4a", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9992f56f1b204f83cc5323dc0d9a24bf61fe9b4a", "message": "Address comments, add more unit tests", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "87f4900a4e88a8f17b0e1820e72bff3894ff187e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/87f4900a4e88a8f17b0e1820e72bff3894ff187e", "message": "Fix test failure", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "1a0cfe9bce33a5425cae4f5f382d30ee9dd22742", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a0cfe9bce33a5425cae4f5f382d30ee9dd22742", "message": "Fix test failure, add deleted code back", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "db17c84904b9cfaa1ca0a55e93b9d742dda9538d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/db17c84904b9cfaa1ca0a55e93b9d742dda9538d", "message": "Add retry on get bucket region", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "fbb8c3fd8a04fabc55ae344e7223f5586529190b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fbb8c3fd8a04fabc55ae344e7223f5586529190b", "message": "Address comments", "committedDate": "2020-12-08T06:29:15Z", "type": "commit"}, {"oid": "fbb8c3fd8a04fabc55ae344e7223f5586529190b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fbb8c3fd8a04fabc55ae344e7223f5586529190b", "message": "Address comments", "committedDate": "2020-12-08T06:29:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzExMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/751#discussion_r538067111", "bodyText": "Nit - combine string", "author": "shaguptashaikh", "createdAt": "2020-12-08T06:26:16Z", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "diffHunk": "@@ -148,35 +113,45 @@ public final File downloadToPath() throws PackageDownloadException, IOException,\n             }\n         }\n \n-        return runWithRetry(\"download-artifact\", MAX_RETRY,\n-                Collections.singletonList(ArtifactChecksumMismatchException.class),\n-                () -> {\n-                    while (offset.get() < artifactSize) {\n-                        long downloadedBytes = download(offset.get(), artifactSize - 1, messageDigest);\n-                        offset.addAndGet(downloadedBytes);\n-                    }\n+        try {\n+            // A checksum mismatch probably means the downloaded artifact is corrupted, Greengrass will retry the\n+            //download for 10 times before giving up.\n+            return RetryUtils.runWithRetry(checksumMismatchRetryConfig, () -> {\n+                while (offset.get() < artifactSize) {\n+                    long downloadedBytes = download(offset.get(), artifactSize - 1, messageDigest);\n+                    offset.addAndGet(downloadedBytes);\n+                }\n \n-                    String digest = Base64.getEncoder().encodeToString(messageDigest.digest());\n-                    if (!digest.equals(artifact.getChecksum())) {\n-                        // Handle failure in integrity check, delete bad file then throw\n-                        Files.deleteIfExists(saveToPath);\n-                        offset.set(0);\n-                        messageDigest.reset();\n-                        throw new ArtifactChecksumMismatchException(\"Integrity check for downloaded artifact failed. \"\n-                                + \"Probably due to file corruption.\");\n-                    }\n-                    logger.atDebug().setEventType(\"download-artifact\").log(\"Passed integrity check\");\n-                    return saveToPath.toFile();\n-                });\n+                String digest = Base64.getEncoder().encodeToString(messageDigest.digest());\n+                if (!digest.equals(artifact.getChecksum())) {\n+                    // Handle failure in integrity check, delete bad file then throw\n+                    Files.deleteIfExists(saveToPath);\n+                    offset.set(0);\n+                    messageDigest.reset();\n+                    throw new ArtifactChecksumMismatchException(\n+                            \"Integrity check for downloaded artifact failed. \" + \"Probably due to file corruption.\");", "originalCommit": "f1915d4e8b42bec422ccb6a32cfa3fcb6256c21b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6fb3d3bab4b1ce6d1382ba1b7793ed041ea5915", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d6fb3d3bab4b1ce6d1382ba1b7793ed041ea5915", "message": "Merge branch 'master' into handle-intermittent-network", "committedDate": "2020-12-08T17:11:00Z", "type": "commit"}, {"oid": "7d9071e223554873620aaed8a6076ff99510e4f4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d9071e223554873620aaed8a6076ff99510e4f4", "message": "Merge branch 'master' into handle-intermittent-network", "committedDate": "2020-12-08T17:29:54Z", "type": "commit"}]}