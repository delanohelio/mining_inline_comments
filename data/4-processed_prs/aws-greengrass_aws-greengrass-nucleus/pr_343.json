{"pr_number": 343, "pr_title": "AuthZ integration with TES", "pr_createdAt": "2020-07-31T17:09:13Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343", "timeline": [{"oid": "845ed9a7cc3c578e48f32e3505d288bf582d9781", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/845ed9a7cc3c578e48f32e3505d288bf582d9781", "message": "AuthZ integration with TES", "committedDate": "2020-07-31T08:46:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMjYyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463732627", "bodyText": "rename to doAuthentication", "author": "MikeDombo", "createdAt": "2020-07-31T17:17:29Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/AuthenticationHandler.java", "diffHunk": "@@ -63,28 +63,39 @@ public static void registerAuthToken(EvergreenService s) {\n      * @param message       incoming message frame to be validated.\n      * @param remoteAddress remote address the client is connected from\n      * @return RequestContext containing the server name if validated.\n-     * @throws IPCClientNotAuthorizedException thrown if not authorized, or any other error happens.\n+     * @throws UnauthenticatedException thrown if not authorized, or any other error happens.\n      */\n     public ConnectionContext doAuth(FrameReader.Message message, SocketAddress remoteAddress)", "originalCommit": "845ed9a7cc3c578e48f32e3505d288bf582d9781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2MDYwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463760604", "bodyText": "ok", "author": "prateek-y", "createdAt": "2020-07-31T18:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMjYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMjg2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463732868", "bodyText": "use Coerce.toString(service)", "author": "MikeDombo", "createdAt": "2020-07-31T17:18:00Z", "path": "src/main/java/com/aws/iot/evergreen/ipc/AuthenticationHandler.java", "diffHunk": "@@ -63,28 +63,39 @@ public static void registerAuthToken(EvergreenService s) {\n      * @param message       incoming message frame to be validated.\n      * @param remoteAddress remote address the client is connected from\n      * @return RequestContext containing the server name if validated.\n-     * @throws IPCClientNotAuthorizedException thrown if not authorized, or any other error happens.\n+     * @throws UnauthenticatedException thrown if not authorized, or any other error happens.\n      */\n     public ConnectionContext doAuth(FrameReader.Message message, SocketAddress remoteAddress)\n-            throws IPCClientNotAuthorizedException {\n+            throws UnauthenticatedException {\n \n         ApplicationMessage applicationMessage = ApplicationMessage.fromBytes(message.getPayload());\n         AuthRequest authRequest;\n         try {\n             authRequest = IPCUtil.decode(applicationMessage.getPayload(), AuthRequest.class);\n         } catch (IOException e) {\n-            throw new IPCClientNotAuthorizedException(\"Fail to decode Auth message\", e);\n+            throw new UnauthenticatedException(\"Fail to decode Auth message\", e);\n         }\n \n-        String authToken = authRequest.getAuthToken();\n-        // Lookup the provided auth token to associate it with a service (or reject it)\n-        String serviceName = (String) config.lookup(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n-                AUTH_TOKEN_LOOKUP_KEY, authToken).getOnce();\n+        String serviceName = doAuthentication(authRequest.getAuthToken());\n+        return new ConnectionContext(serviceName, remoteAddress, router);\n+    }\n \n-        if (serviceName == null) {\n-            throw new IPCClientNotAuthorizedException(\"Auth token not found\");\n+    /**\n+     * Lookup the provided auth token to associate it with a service (or reject it).\n+     * @param authToken token to be looked up.\n+     * @return service name to which the token is associated.\n+     * @throws UnauthenticatedException if token is invalid or unassociated.\n+     */\n+    public String doAuthentication(String authToken) throws UnauthenticatedException {\n+        if (authToken == null) {\n+            throw new UnauthenticatedException(\"Invalid auth token\");\n         }\n-        return new ConnectionContext(serviceName, remoteAddress, router);\n+        Topic service = config.find(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n+                AUTH_TOKEN_LOOKUP_KEY, authToken);\n+        if (service == null) {\n+            throw new UnauthenticatedException(\"Auth token not found\");\n+        }\n+        return (String) service.getOnce();", "originalCommit": "845ed9a7cc3c578e48f32e3505d288bf582d9781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2MDY0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463760642", "bodyText": "ok", "author": "prateek-y", "createdAt": "2020-07-31T18:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMjg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMzU4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463733581", "bodyText": "don't log just the message, log the whole exception by passing e instead of e.getMessage() (and remove the {})", "author": "MikeDombo", "createdAt": "2020-07-31T17:19:34Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -63,35 +74,67 @@\n     /**\n      * Constructor.\n      *\n-     * @param iotRoleAlias      Iot role alias configured by the customer in AWS account.\n      * @param cloudHelper       {@link IotCloudHelper} for making http requests to cloud.\n      * @param connectionManager {@link IotConnectionManager} underlying connection manager for cloud.\n+     * @param authenticationHandler {@link AuthenticationHandler} authN module for authenticating requests.\n+     * @param authZHandler {@link AuthorizationHandler} authZ module for authorizing requests.\n      */\n-    public CredentialRequestHandler(final String iotRoleAlias, final IotCloudHelper cloudHelper,\n-                                    final IotConnectionManager connectionManager) {\n-        this.iotCredentialsPath = \"/role-aliases/\" + iotRoleAlias + \"/credentials\";\n+    @Inject\n+    public CredentialRequestHandler(final IotCloudHelper cloudHelper,\n+                                    final IotConnectionManager connectionManager,\n+                                    final AuthenticationHandler authenticationHandler,\n+                                    final AuthorizationHandler authZHandler) {\n         this.iotCloudHelper = cloudHelper;\n         this.iotConnectionManager = connectionManager;\n+        this.authNHandler = authenticationHandler;\n+        this.authZHandler = authZHandler;\n+    }\n+\n+    /**\n+     * Set the role alias.\n+     * @param iotRoleAlias  Iot role alias configured by the customer in AWS account.\n+     */\n+    public void setIotCredentialsPath(String iotRoleAlias) {\n+        this.iotCredentialsPath = \"/role-aliases/\" + iotRoleAlias + \"/credentials\";\n         this.tesCache.put(this.iotCredentialsPath, new TESCache());\n         this.tesCache.get(iotCredentialsPath).expiry = Instant.now(clock);\n     }\n \n     @Override\n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n     public void handle(final HttpExchange exchange) throws IOException {\n-        final byte[] credentials = getCredentials();\n-        exchange.sendResponseHeaders(tesCache.get(iotCredentialsPath).responseCode, credentials.length);\n-        exchange.getResponseBody().write(credentials);\n-        exchange.close();\n+        try {\n+            doAuth(exchange);\n+            final byte[] credentials = getCredentials();\n+            exchange.sendResponseHeaders(tesCache.get(iotCredentialsPath).responseCode, credentials.length);\n+            exchange.getResponseBody().write(credentials);\n+        } catch (AuthorizationException e) {\n+            LOGGER.atInfo().log(\"Request is not authorized\");\n+            generateError(exchange, HttpURLConnection.HTTP_FORBIDDEN);\n+        } catch (UnauthenticatedException e) {\n+            LOGGER.atInfo().log(\"Request denied due to invalid token\");\n+            generateError(exchange, HttpURLConnection.HTTP_FORBIDDEN);\n+        } catch (Throwable e) {\n+            // Dont let the server crash, swallow problems with a 5xx\n+            LOGGER.atInfo().log(\"Request failed due to {}\", e.getMessage());", "originalCommit": "845ed9a7cc3c578e48f32e3505d288bf582d9781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2MDY5MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463760691", "bodyText": "ok", "author": "prateek-y", "createdAt": "2020-07-31T18:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMzU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMzk1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463733958", "bodyText": "omit the resource in your build since it is null?", "author": "MikeDombo", "createdAt": "2020-07-31T17:20:18Z", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -183,6 +225,19 @@ public void handle(final HttpExchange exchange) throws IOException {\n         }\n     }\n \n+    private void doAuth(final HttpExchange exchange) throws UnauthenticatedException, AuthorizationException {\n+        // if header is not present, then authToken would be null and authNhandler would throw\n+        String authNToken = exchange.getRequestHeaders().getFirst(AUTH_HEADER);\n+        String clientService = authNHandler.doAuthentication(authNToken);\n+        authZHandler.isAuthorized(\n+                TokenExchangeService.TOKEN_EXCHANGE_SERVICE_TOPICS,\n+                Permission.builder()\n+                        .principal(clientService)\n+                        .operation(TokenExchangeService.AUTHZ_TES_OPERATION)\n+                        .resource(null)", "originalCommit": "845ed9a7cc3c578e48f32e3505d288bf582d9781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2MTI2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463761263", "bodyText": "I like it this way. tells the reader explicitly that we want to set it to null.", "author": "prateek-y", "createdAt": "2020-07-31T18:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMzk1OA=="}], "type": "inlineReview"}, {"oid": "100ca726231220bba03d559cc7720691c2475614", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/100ca726231220bba03d559cc7720691c2475614", "message": "Add PR feedback", "committedDate": "2020-07-31T18:19:23Z", "type": "commit"}, {"oid": "ad2c3494abfe48ea9b9797129dd680b95b0da995", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ad2c3494abfe48ea9b9797129dd680b95b0da995", "message": "Merge branch 'master' into auth_tes_take_2", "committedDate": "2020-07-31T18:20:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2NTg4OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463765888", "bodyText": "status is used below. should change line 118 as well", "author": "youtuyy", "createdAt": "2020-07-31T18:28:40Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/tes/TESTest.java", "diffHunk": "@@ -74,22 +88,16 @@ void tearDown() {\n \n     @Test\n     void GIVEN_iot_role_alias_WHEN_tes_is_queried_THEN_valid_credentials_are_returned() throws Exception {\n-        CountDownLatch tesRunning = new CountDownLatch(1);\n-        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (service.getName().equals(TOKEN_EXCHANGE_SERVICE_TOPICS) && newState.equals(State.RUNNING)) {\n-                tesRunning.countDown();\n-            }\n-        });\n-        kernel.launch();\n-        assertTrue(tesRunning.await(5, TimeUnit.SECONDS));\n-        Thread.sleep(5000);\n         String urlString = kernel.getConfig().find(SETENV_CONFIG_NAMESPACE, TES_URI_ENV_VARIABLE_NAME).getOnce().toString();\n         assertNotNull(urlString);\n         URL url = new URL(urlString);\n+        // Get the first token from the token map\n+        String token = kernel.getConfig().findTopics(SERVICES_NAMESPACE_TOPIC, AuthenticationHandler.AUTH_TOKEN_LOOKUP_KEY).iterator().next().getName();\n+        assertNotNull(token);\n         HttpURLConnection con = (HttpURLConnection) url.openConnection();\n         con.setRequestMethod(\"GET\");\n-        int status = con.getResponseCode();", "originalCommit": "ad2c3494abfe48ea9b9797129dd680b95b0da995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2NzUwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/343#discussion_r463767503", "bodyText": "yeah. updated now. thanks.", "author": "prateek-y", "createdAt": "2020-07-31T18:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc2NTg4OA=="}], "type": "inlineReview"}, {"oid": "653a767698b07049488f1df5850e3f4e80677712", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/653a767698b07049488f1df5850e3f4e80677712", "message": "Resolve merge conflict after merging from mainline\n\nA test was referring to status variable which was modified as part of my change. Updating the UT to reflect the new changes.", "committedDate": "2020-07-31T18:31:49Z", "type": "commit"}, {"oid": "31758b19fda50493d73a9d3872f98c6d6532aa77", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/31758b19fda50493d73a9d3872f98c6d6532aa77", "message": "Update TES test after merge\n\nadd missing auth token, also reverse the assert parameters.", "committedDate": "2020-07-31T19:46:20Z", "type": "commit"}]}