{"pr_number": 597, "pr_title": "Fix flaky integration tests.", "pr_createdAt": "2020-10-31T20:21:55Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597", "timeline": [{"oid": "14658957e314f7aca1c1e3a279a1884eb3ca00d2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14658957e314f7aca1c1e3a279a1884eb3ca00d2", "message": "Fix flaky integ tests.", "committedDate": "2020-10-31T20:28:06Z", "type": "commit"}, {"oid": "14658957e314f7aca1c1e3a279a1884eb3ca00d2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14658957e314f7aca1c1e3a279a1884eb3ca00d2", "message": "Fix flaky integ tests.", "committedDate": "2020-10-31T20:28:06Z", "type": "forcePushed"}, {"oid": "f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "message": "Merge branch 'master' into fixFlakyTests", "committedDate": "2020-10-31T21:07:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjAxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515542015", "bodyText": "does the countdown latch ever get reset? It's initialized in a field but used countdown happens in before each", "author": "rbattle", "createdAt": "2020-10-31T21:31:32Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -70,6 +65,19 @@ void setupKernel(ExtensionContext context) throws DeviceConfigurationException,\n         kernel.parseArgs(\"-i\", IotJobsFleetStatusServiceTest.class.getResource(\"smallPeriodicIntervalConfig.yaml\").toString());\n         kernel.getContext().put(MqttClient.class, mqttClient);\n \n+        when(mqttClient.publish(any(PublishRequest.class))).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            try {\n+                fleetStatusDetails.set(OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                        FleetStatusDetails.class));\n+                if (kernel.orderedDependencies().size() == fleetStatusDetails.get().getComponentStatusDetails().size()) {\n+                    allComponentsInFssUpdate.countDown();", "originalCommit": "f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0Mjk1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515542958", "bodyText": "The countdown happens in the mocked MQTT client. so that will only get counted down when FSS updates with all the components.", "author": "nikkhilmuthye", "createdAt": "2020-10-31T21:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjExNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515542116", "bodyText": "when would this not be the case that the fleet status details isn't reporting all of the ordered dependencies?\nshould this check more than just size?", "author": "rbattle", "createdAt": "2020-10-31T21:32:38Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -70,6 +65,19 @@ void setupKernel(ExtensionContext context) throws DeviceConfigurationException,\n         kernel.parseArgs(\"-i\", IotJobsFleetStatusServiceTest.class.getResource(\"smallPeriodicIntervalConfig.yaml\").toString());\n         kernel.getContext().put(MqttClient.class, mqttClient);\n \n+        when(mqttClient.publish(any(PublishRequest.class))).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            try {\n+                fleetStatusDetails.set(OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                        FleetStatusDetails.class));\n+                if (kernel.orderedDependencies().size() == fleetStatusDetails.get().getComponentStatusDetails().size()) {", "originalCommit": "f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MzA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515543085", "bodyText": "Theoretically it should always send all the components when FSS updates periodically. This just ensures that all the components that the kernel is aware of, is in the update.", "author": "nikkhilmuthye", "createdAt": "2020-10-31T21:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjI2MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515542261", "bodyText": "should you also assert on the size, or that it at least isn't empty?", "author": "rbattle", "createdAt": "2020-10-31T21:34:16Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -102,42 +109,17 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n-\n-        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n-            Object argument = i.getArgument(0);\n-            PublishRequest publishRequest = (PublishRequest) argument;\n-            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n-                    FleetStatusDetails.class);\n-            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n-                allComponentsInFssUpdate.countDown();\n-            }\n-            return CompletableFuture.completedFuture(0);\n-        });\n-\n         // Wait for some time for the publish request to have all the components update.\n         assertTrue(allComponentsInFssUpdate.await(30, TimeUnit.SECONDS), \"component publish requests\");\n-\n-        List<PublishRequest> prs = captor.getAllValues();\n-        // Get the last FSS publish request which should have all the components information.\n-        PublishRequest pr = prs.get(prs.size() - 1);\n-        try {\n-            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(pr.getPayload(),\n-                    FleetStatusDetails.class);\n-            assertEquals(\"ThingName\", fleetStatusDetails.getThing());\n-            assertEquals(OverallStatus.HEALTHY, fleetStatusDetails.getOverallStatus());\n-            assertNotNull(fleetStatusDetails.getComponentStatusDetails());\n-            String allUpdatedComponentNames = fleetStatusDetails.getComponentStatusDetails().stream()\n-                    .map(ComponentStatusDetails::getComponentName).collect(Collectors.joining(\", \"));\n-            assertEquals(componentNamesToCheck.size(), fleetStatusDetails.getComponentStatusDetails().size(),\n-                    \"Not all components were updated. Updated Components names are: \"\n-                            + allUpdatedComponentNames + \". All Components: \" +\n-                            String.join(\", \", componentNamesToCheck));\n-            fleetStatusDetails.getComponentStatusDetails().forEach(componentStatusDetails -> {\n-                componentNamesToCheck.remove(componentStatusDetails.getComponentName());\n-            });\n-        } catch (UnrecognizedPropertyException ignored) {\n+        assertNotNull(fleetStatusDetails);\n+        assertNotNull(fleetStatusDetails.get());\n+        assertEquals(\"ThingName\", fleetStatusDetails.get().getThing());\n+        assertEquals(OverallStatus.HEALTHY, fleetStatusDetails.get().getOverallStatus());\n+        assertNotNull(fleetStatusDetails.get().getComponentStatusDetails());", "originalCommit": "f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MzIwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515543200", "bodyText": "Since we are awaiting on the latch, the latch will only return true (count down happens) if all the components are in the FSS update. So we don't need to assert on the size again.", "author": "nikkhilmuthye", "createdAt": "2020-10-31T21:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjY3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515542678", "bodyText": "does it check anywhere that the components that are reported are actually the ones that you expect?", "author": "rbattle", "createdAt": "2020-10-31T21:38:57Z", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -102,42 +109,17 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n-\n-        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n-            Object argument = i.getArgument(0);\n-            PublishRequest publishRequest = (PublishRequest) argument;\n-            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n-                    FleetStatusDetails.class);\n-            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n-                allComponentsInFssUpdate.countDown();\n-            }\n-            return CompletableFuture.completedFuture(0);\n-        });\n-\n         // Wait for some time for the publish request to have all the components update.\n         assertTrue(allComponentsInFssUpdate.await(30, TimeUnit.SECONDS), \"component publish requests\");\n-\n-        List<PublishRequest> prs = captor.getAllValues();\n-        // Get the last FSS publish request which should have all the components information.\n-        PublishRequest pr = prs.get(prs.size() - 1);\n-        try {\n-            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(pr.getPayload(),\n-                    FleetStatusDetails.class);\n-            assertEquals(\"ThingName\", fleetStatusDetails.getThing());\n-            assertEquals(OverallStatus.HEALTHY, fleetStatusDetails.getOverallStatus());\n-            assertNotNull(fleetStatusDetails.getComponentStatusDetails());\n-            String allUpdatedComponentNames = fleetStatusDetails.getComponentStatusDetails().stream()\n-                    .map(ComponentStatusDetails::getComponentName).collect(Collectors.joining(\", \"));\n-            assertEquals(componentNamesToCheck.size(), fleetStatusDetails.getComponentStatusDetails().size(),\n-                    \"Not all components were updated. Updated Components names are: \"\n-                            + allUpdatedComponentNames + \". All Components: \" +\n-                            String.join(\", \", componentNamesToCheck));\n-            fleetStatusDetails.getComponentStatusDetails().forEach(componentStatusDetails -> {\n-                componentNamesToCheck.remove(componentStatusDetails.getComponentName());\n-            });\n-        } catch (UnrecognizedPropertyException ignored) {\n+        assertNotNull(fleetStatusDetails);\n+        assertNotNull(fleetStatusDetails.get());\n+        assertEquals(\"ThingName\", fleetStatusDetails.get().getThing());\n+        assertEquals(OverallStatus.HEALTHY, fleetStatusDetails.get().getOverallStatus());\n+        assertNotNull(fleetStatusDetails.get().getComponentStatusDetails());\n+        for (ComponentStatusDetails componentStatusDetail : fleetStatusDetails.get().getComponentStatusDetails()) {", "originalCommit": "f7643556a4e9ae09ee29d29fe7a9b18d3ce3e426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MzMyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515543322", "bodyText": "When FSS updates periodically, it report status on all components. That is guaranteed by the latch count down. So if the latch await has returned true, we are sure that we have all the components information in the status update.", "author": "nikkhilmuthye", "createdAt": "2020-10-31T21:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0NDA2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515544063", "bodyText": "It's guaranteed that you have some number of components - the previous test actually checked the component names to guarantee that they were present. We've lost that in this test now.\nAs an integration test, I'd really like it to check that what is supposed to be reported is actually being reported.\nIt could be as simple as looping through the dependencies in the kernel and checking that they exist in the status details. It is really easy for tests to fail because they have the right count of things, but the content is incorrect.", "author": "rbattle", "createdAt": "2020-10-31T21:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0NDcxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/597#discussion_r515544713", "bodyText": "Makes sense. Made the change.", "author": "nikkhilmuthye", "createdAt": "2020-10-31T21:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU0MjY3OA=="}], "type": "inlineReview"}, {"oid": "079ae3ee9ad4b40e94bb31cfa37152af1c03cf3e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/079ae3ee9ad4b40e94bb31cfa37152af1c03cf3e", "message": "Move initialization into before each.", "committedDate": "2020-10-31T21:49:12Z", "type": "commit"}, {"oid": "7c06b7dc84d786546179389a9611aa57f6e0c6b1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c06b7dc84d786546179389a9611aa57f6e0c6b1", "message": "Assert all components are in FSS update message.", "committedDate": "2020-10-31T21:58:59Z", "type": "commit"}]}