{"pr_number": 117, "pr_title": "Update definition of skip if, remove support for arbitrary scripts", "pr_createdAt": "2020-03-16T22:15:18Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MDYzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393340635", "bodyText": "remove -log stdout.", "author": "MikeDombo", "createdAt": "2020-03-16T22:19:25Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()\n+            throws Throwable {\n+        // GIVEN\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir.toString(), \"-log\", \"stdout\", \"-i\",", "originalCommit": "45a8c998fede40d1b89f8498224fc42813b2d485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MjU4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393342583", "bodyText": "done", "author": "chaurah", "createdAt": "2020-03-16T22:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MDYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTA2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393341062", "bodyText": "This name is not correct.", "author": "MikeDombo", "createdAt": "2020-03-16T22:20:42Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()", "originalCommit": "45a8c998fede40d1b89f8498224fc42813b2d485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MjU0Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393342542", "bodyText": "Oops, bad merge, updating.", "author": "chaurah", "createdAt": "2020-03-16T22:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTcxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393341719", "bodyText": "I'm not sure we want it to be in errored, is it possible to do this validation and just fail to create the service?", "author": "MikeDombo", "createdAt": "2020-03-16T22:22:30Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()\n+            throws Throwable {\n+        // GIVEN\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir.toString(), \"-log\", \"stdout\", \"-i\",\n+                getClass().getResource(\"skipif_broken.yaml\").toString());\n+\n+        CountDownLatch testErrored = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"test\") && newState.equals(State.ERRORED)) {", "originalCommit": "45a8c998fede40d1b89f8498224fc42813b2d485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2MDQwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393360407", "bodyText": "Discussed offline, there will be a separate task for input validation for all IPC services. Early failure will be handled in that task. Added a TODO to make sure skipif is not missed in the Service constructor.", "author": "chaurah", "createdAt": "2020-03-16T23:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDQ5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393350498", "bodyText": "no git defined here?", "author": "MikeDombo", "createdAt": "2020-03-16T22:43:48Z", "path": "src/integrationtests/resources/com/aws/iot/evergreen/integrationtests/kernel/skipif_broken.yaml", "diffHunk": "@@ -0,0 +1,16 @@\n+services:\n+  test:\n+    lifecycle:\n+      run:\n+        debian:\n+          skipif: This is broken\n+          script: echo \"Running test\" && sleep 10\n+        macos:\n+          skipif: This is broken\n+          script: echo \"Running test\" && sleep 10\n+  main:\n+    lifecycle:\n+      run:\n+        script: echo \"Running main\" && sleep 60\n+    dependencies:\n+      - git", "originalCommit": "45a8c998fede40d1b89f8498224fc42813b2d485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MTg2MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393351860", "bodyText": "bad merge, updating", "author": "chaurah", "createdAt": "2020-03-16T22:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDQ5OA=="}], "type": "inlineReview"}, {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-16T22:48:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MTIxNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393381215", "bodyText": "NIT: Duplicate with L45?", "author": "ShirleyZheng92", "createdAt": "2020-03-17T00:25:07Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();", "originalCommit": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ec974e018e433094b46874ce34c5d574ad7a9e5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ec974e018e433094b46874ce34c5d574ad7a9e5", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-17T06:58:37Z", "type": "forcePushed"}, {"oid": "f339c221cf6656311ba40018ce0f822f45365cec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f339c221cf6656311ba40018ce0f822f45365cec", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-17T09:46:48Z", "type": "forcePushed"}, {"oid": "8496fedcebb55ac08f0f80a6568c50894f720b8b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8496fedcebb55ac08f0f80a6568c50894f720b8b", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-17T10:51:22Z", "type": "forcePushed"}, {"oid": "cf2f796b433a251539158a26ccdb711eba3725ce", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf2f796b433a251539158a26ccdb711eba3725ce", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-17T11:03:13Z", "type": "commit"}, {"oid": "cf2f796b433a251539158a26ccdb711eba3725ce", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf2f796b433a251539158a26ccdb711eba3725ce", "message": "Update definition of skip if, remove support for arbitrary scripts", "committedDate": "2020-03-17T11:03:13Z", "type": "forcePushed"}]}