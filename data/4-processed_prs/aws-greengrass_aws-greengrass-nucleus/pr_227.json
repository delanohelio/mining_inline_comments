{"pr_number": 227, "pr_title": "Add Deployment safe namespace topic", "pr_createdAt": "2020-05-07T16:41:18Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDAxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421654019", "bodyText": "If the mergeCondition is null, then the default should be to do the merge, IMO.", "author": "MikeDombo", "createdAt": "2020-05-07T16:58:11Z", "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationReader.java", "diffHunk": "@@ -69,16 +70,20 @@ public static Configuration createFromTLog(Context context, Path p) throws IOExc\n      * @param forceTimestamp should ignore if the proposed timestamp is older than current\n      * @throws IOException if reading fails\n      */\n-    public static void mergeTlogIntoConfig(Configuration config, Path tlogPath, boolean forceTimestamp)\n+    public static void mergeTlogIntoConfig(Configuration config, Path tlogPath, boolean forceTimestamp,\n+                                           Predicate<String> mergeCondition)\n             throws IOException {\n         // This can cause memory issues when the tlog files is large, use it only merge config that can fit in memory\n         // TODO : Maybe track this in benchmarking if the tlog file has the potential to cause memory issues\n         Iterator<String> logLines = Files.readAllLines(tlogPath).iterator();\n         while (logLines.hasNext()) {\n             java.util.regex.Matcher m = logLine.matcher(logLines.next());\n             if (m.matches()) {\n-                config.lookup(seperator.split(m.group(2)))\n-                        .withNewerValue(parseLong(m.group(1)), toObject(m.group(3)), forceTimestamp);\n+                String matchedValue = m.group(2);\n+                if (mergeCondition != null && mergeCondition.test(matchedValue)) {", "originalCommit": "3205bb0370eec88134bae05685a25b8025d93df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NTA0NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421675044", "bodyText": "Done", "author": "chaurah", "createdAt": "2020-05-07T17:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDUyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421654522", "bodyText": "you need to escape the . in the regex, otherwise it is a wildcard.", "author": "MikeDombo", "createdAt": "2020-05-07T16:59:00Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -43,6 +43,8 @@\n     private static final String MERGE_ERROR_LOG_EVENT_KEY = \"config-update-error\";\n     private static final String DEPLOYMENT_ID_LOG_KEY = \"deploymentId\";\n     private static final String ROLLBACK_SNAPSHOT_PATH_FORMAT = \"rollback_snapshot_%s.tlog\";\n+    private static final java.util.regex.Pattern notDeployedParams =", "originalCommit": "3205bb0370eec88134bae05685a25b8025d93df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDg5OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421674899", "bodyText": "Updated to use childOf as discussed", "author": "chaurah", "createdAt": "2020-05-07T17:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NjQwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421656404", "bodyText": "You should get services from the const that we have.\nAlso, not sure I like the idea of using a regex for this. I think I'd prefer to make it a Predicate<Topic> so that we can have better understanding within the predicate of the tree structure.", "author": "MikeDombo", "createdAt": "2020-05-07T17:01:57Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -43,6 +43,8 @@\n     private static final String MERGE_ERROR_LOG_EVENT_KEY = \"config-update-error\";\n     private static final String DEPLOYMENT_ID_LOG_KEY = \"deploymentId\";\n     private static final String ROLLBACK_SNAPSHOT_PATH_FORMAT = \"rollback_snapshot_%s.tlog\";\n+    private static final java.util.regex.Pattern notDeployedParams =\n+            java.util.regex.Pattern.compile(\"services.([^,.]*).notDeployed.([^,]*)\");", "originalCommit": "3205bb0370eec88134bae05685a25b8025d93df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDg0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421674840", "bodyText": "Updated to use childOf as discussed", "author": "chaurah", "createdAt": "2020-05-07T17:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NjQwNA=="}], "type": "inlineReview"}, {"oid": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/98fe74de3acad7fd2ebaee23d36e7af1f4365163", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-07T17:28:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDA2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421674063", "bodyText": "go ahead and make this public so you can use it in your tests.", "author": "MikeDombo", "createdAt": "2020-05-07T17:31:51Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -43,6 +43,7 @@\n     private static final String MERGE_ERROR_LOG_EVENT_KEY = \"config-update-error\";\n     private static final String DEPLOYMENT_ID_LOG_KEY = \"deploymentId\";\n     private static final String ROLLBACK_SNAPSHOT_PATH_FORMAT = \"rollback_snapshot_%s.tlog\";\n+    private static final String DEPLOYMENT_SAFE_NAMESPACE_TOPIC = \"notDeployed\";", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwMTc1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421701759", "bodyText": "done", "author": "chaurah", "createdAt": "2020-05-07T18:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDI5Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421674297", "bodyText": "nit: formatting.", "author": "MikeDombo", "createdAt": "2020-05-07T17:32:16Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -148,8 +149,13 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n         long mergeTime;\n         try {\n             mergeTime = System.currentTimeMillis();\n+            // The lambda is set up to ignore anything that is a child of DEPLOYMENT_SAFE_NAMESPACE_TOPIC\n+            // Does not necessarily have to be a child of services, customers are free to put this namespace wherever\n+            // they like in the config\n             ConfigurationReader.mergeTlogIntoConfig(kernel.getConfig(),\n-                    kernel.getConfigPath().resolve(String.format(ROLLBACK_SNAPSHOT_PATH_FORMAT, deploymentId)), true);\n+                    kernel.getConfigPath()\n+                          .resolve(String.format(ROLLBACK_SNAPSHOT_PATH_FORMAT, deploymentId)),true,", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcxOTY2Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421719666", "bodyText": "+1", "author": "shaguptashaikh", "createdAt": "2020-05-07T18:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNjk4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421826984", "bodyText": "Formatting is still off here. Needs spaces between parameters.", "author": "MikeDombo", "createdAt": "2020-05-07T22:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDkxMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421674912", "bodyText": "here technically \"services\" should be a param as well and get it from our const.", "author": "MikeDombo", "createdAt": "2020-05-07T17:33:19Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentTaskIntegrationTest.java", "diffHunk": "@@ -280,6 +281,10 @@ void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_do_n\n     @Order(5)\n     void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_rollback_THEN_services_are_rolled_back(\n             ExtensionContext context) throws Exception {\n+        kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NTM1Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421675356", "bodyText": "This isn't really necessary as Configuration is tested separately, but this won't slow down the test, so I guess it doesn't matter.", "author": "MikeDombo", "createdAt": "2020-05-07T17:33:59Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentTaskIntegrationTest.java", "diffHunk": "@@ -280,6 +281,10 @@ void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_do_n\n     @Order(5)\n     void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_rollback_THEN_services_are_rolled_back(\n             ExtensionContext context) throws Exception {\n+        kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",\n+                                                DEPLOYMENT_SAFE_NAMESPACE_TOPIC)).withValue(\"Test\");\n+        assertEquals(\"Test\", kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NjI1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421676255", "bodyText": "L300+L303 seem pointless since we know that withValue will set the value to Test.", "author": "MikeDombo", "createdAt": "2020-05-07T17:35:38Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentTaskIntegrationTest.java", "diffHunk": "@@ -292,6 +297,12 @@ void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_roll\n         assertEquals(3, services.size());\n         assertThat(services, containsInAnyOrder(\"main\", \"YellowSignal\", \"RedSignal\"));\n \n+        kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",\n+                                                DEPLOYMENT_SAFE_NAMESPACE_TOPIC)).withValue(\"Test\");", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NzcxOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421677719", "bodyText": "Seems like this test is misplaced, I think it makes more sense if it is in the DeploymentConfigMergerTest.", "author": "MikeDombo", "createdAt": "2020-05-07T17:37:59Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentTaskIntegrationTest.java", "diffHunk": "@@ -310,6 +321,56 @@ void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_roll\n         assertEquals(DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, result.getDeploymentStatus());\n     }\n \n+    /**", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3ODA5NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421678094", "bodyText": "Why would it have changed? You never changed the value to anything else, so it shouldn't be possible for it to be different anyway.", "author": "MikeDombo", "createdAt": "2020-05-07T17:38:40Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentTaskIntegrationTest.java", "diffHunk": "@@ -310,6 +321,56 @@ void GIVEN_services_running_WHEN_new_service_breaks_failure_handling_policy_roll\n         assertEquals(DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, result.getDeploymentStatus());\n     }\n \n+    /**\n+     * First deployment starts some services. Second deployment tries to add a service that breaks\n+     * and removes an existing service and the failure handling policy is to rollback\n+     * As a result, kernel should be reverted to the state before deployment\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    @Order(6)\n+    void GIVEN_services_running_with_rollback_safe_param_WHEN_rollback_THEN_rollback_safe_param_not_updated(\n+            ExtensionContext context) throws Exception {\n+        // 1. Perform forward deployment with YellowSignalService\n+        Future<DeploymentResult> resultFuture = submitSampleJobDocument(\n+                DeploymentTaskIntegrationTest.class.getResource(\"YellowAndRedSignal.json\").toURI(),\n+                System.currentTimeMillis());\n+        resultFuture.get(30, TimeUnit.SECONDS);\n+        List<String> services = kernel.orderedDependencies().stream()\n+                                      .filter(evergreenService -> evergreenService instanceof GenericExternalService)\n+                                      .map(evergreenService -> evergreenService.getName()).collect(Collectors.toList());\n+\n+        // should contain main, YellowSignal, RedSignal\n+        assertEquals(3, services.size());\n+        assertThat(services, containsInAnyOrder(\"main\", \"YellowSignal\", \"RedSignal\"));\n+\n+        // 2. Add deployment safe parameter\n+        kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",\n+                                                DEPLOYMENT_SAFE_NAMESPACE_TOPIC)).withValue(\"Test\");\n+        assertEquals(\"Test\", kernel.getConfig().lookup(String.format(\"services.YellowSignal.%s.testTopic\",\n+                                                                     DEPLOYMENT_SAFE_NAMESPACE_TOPIC)).getOnce());\n+\n+        // 3. Perform failed deployment with rollback\n+        ignoreExceptionUltimateCauseOfType(context, ServiceUpdateException.class);\n+        resultFuture = submitSampleJobDocument(\n+                DeploymentTaskIntegrationTest.class.getResource(\"FailureRollbackDeployment.json\").toURI(),\n+                System.currentTimeMillis());\n+        DeploymentResult result = resultFuture.get(30, TimeUnit.SECONDS);\n+        services = kernel.orderedDependencies().stream()\n+                         .filter(evergreenService -> evergreenService instanceof GenericExternalService)\n+                         .map(evergreenService -> evergreenService.getName()).collect(Collectors.toList());\n+\n+        // should still contain main, YellowSignal, RedSignal\n+        assertEquals(3, services.size());\n+        assertThat(services, containsInAnyOrder(\"main\", \"YellowSignal\", \"RedSignal\"));\n+        assertEquals(DeploymentResult.DeploymentStatus.FAILED_ROLLBACK_COMPLETE, result.getDeploymentStatus());\n+\n+        // Value for deployment safe topic should not change", "originalCommit": "98fe74de3acad7fd2ebaee23d36e7af1f4365163", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3OTAzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421679031", "bodyText": "One thing to try would be adding a globalstatelistener to listen for the service moving to ERRORED, then set the param to something other than Test, then once it rolls back the value should still be the new one. Without your change it would have been rolled back to being Test.\nWe need a test that proves your change is effective, but I'm pretty sure this test passes either way.", "author": "MikeDombo", "createdAt": "2020-05-07T17:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3ODA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzMjc3MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421832770", "bodyText": "Updated test, I wasn't very sure this version was adding any value either. Hopefully the new one should be better.", "author": "chaurah", "createdAt": "2020-05-07T22:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3ODA5NA=="}], "type": "inlineReview"}, {"oid": "03f2191911f947689d64584097889086693f61cc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03f2191911f947689d64584097889086693f61cc", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-07T18:34:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNjU3OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421826579", "bodyText": "nothing should be detached here, these look proper. You should try removing this supression.", "author": "MikeDombo", "createdAt": "2020-05-07T22:17:15Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.config;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@SuppressWarnings({\"PMD.DetachedTestCase\", \"PMD.UnusedLocalVariable\"})", "originalCommit": "03f2191911f947689d64584097889086693f61cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzMTE0Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421831143", "bodyText": "Haven't finished updating :P Give me 10 more mins :)", "author": "chaurah", "createdAt": "2020-05-07T22:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNjU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyNjY0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421826641", "bodyText": "don't copy this. Use the public const.", "author": "MikeDombo", "createdAt": "2020-05-07T22:17:26Z", "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationReaderTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.config;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@SuppressWarnings({\"PMD.DetachedTestCase\", \"PMD.UnusedLocalVariable\"})\n+@ExtendWith(EGExtension.class)\n+public class ConfigurationReaderTest {\n+    private static final String DEPLOYMENT_SAFE_NAMESPACE_TOPIC = \"notDeployed\";", "originalCommit": "03f2191911f947689d64584097889086693f61cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf9a2465fa4dbbcd0ba65cddcc77840accefe4e3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf9a2465fa4dbbcd0ba65cddcc77840accefe4e3", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-07T22:54:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxOTUzNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r421919534", "bodyText": "The \"notDeployed\" name is confusing and seems inaccurate. Feels more accurate to say that it won't be rolled back, because it can be overwritten through a deployment; it just won't be rolled back if the deployment fails.", "author": "MikeDombo", "createdAt": "2020-05-08T03:41:55Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -44,6 +44,8 @@\n     private static final String DEPLOYMENT_ID_LOG_KEY = \"deploymentId\";\n     private static final String ROLLBACK_SNAPSHOT_PATH_FORMAT = \"rollback_snapshot_%s.tlog\";\n \n+    public static final String DEPLOYMENT_SAFE_NAMESPACE_TOPIC = \"notDeployed\";", "originalCommit": "cf9a2465fa4dbbcd0ba65cddcc77840accefe4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0OTE4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r422249185", "bodyText": "changed to notRolledBack", "author": "chaurah", "createdAt": "2020-05-08T16:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxOTUzNA=="}], "type": "inlineReview"}, {"oid": "3a55042d635f73ece7ae7c83f14d37e26aa157ab", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a55042d635f73ece7ae7c83f14d37e26aa157ab", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T16:45:02Z", "type": "forcePushed"}, {"oid": "0a199dc9a9de544d70ef8d45934d2b28fb28ca2f", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0a199dc9a9de544d70ef8d45934d2b28fb28ca2f", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T16:47:35Z", "type": "forcePushed"}, {"oid": "79a97787415a911663277a73a3da47b187b2b093", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/79a97787415a911663277a73a3da47b187b2b093", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T17:34:40Z", "type": "forcePushed"}, {"oid": "b12da07f41bdd0286c3a2798e7e98d707503b895", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b12da07f41bdd0286c3a2798e7e98d707503b895", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T17:47:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI3OTcyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r422279723", "bodyText": "you don't need this here because the base class already has it. I don't think it hurts to have it though.", "author": "MikeDombo", "createdAt": "2020-05-08T17:46:37Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -48,6 +55,7 @@\n import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n \n+@ExtendWith(EGExtension.class)", "originalCommit": "79a97787415a911663277a73a3da47b187b2b093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI3OTkyMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r422279923", "bodyText": "use const for lifecycle from the GenericExternalService class.", "author": "MikeDombo", "createdAt": "2020-05-08T17:47:03Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -467,8 +475,77 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n         }\n     }\n \n+    @Test\n+    void GIVEN_service_running_with_rollback_safe_param_WHEN_rollback_THEN_rollback_safe_param_not_updated(\n+            ExtensionContext context)\n+            throws Throwable {\n+\n+        ignoreExceptionUltimateCauseWithMessage(context, \"Service sleeperB in broken state after deployment\");\n+\n+        // GIVEN\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"long_running_services.yaml\").toString());\n+\n+        kernel.launch();\n+\n+        Configuration config = kernel.getConfig();\n+        config.lookup(SERVICES_NAMESPACE_TOPIC, \"sleeperB\",\n+                      DEPLOYMENT_SAFE_NAMESPACE_TOPIC, \"testKey\")\n+              .withNewerValue(System.currentTimeMillis(), \"initialValue\");\n+\n+        // WHEN\n+        // merge broken config\n+        HashMap<Object, Object> brokenConfig = new HashMap<Object, Object>() {{\n+            put(SERVICES_NAMESPACE_TOPIC, new HashMap<Object, Object>() {{\n+                put(\"sleeperB\", new HashMap<Object, Object>() {{\n+                    put(\"lifecycle\", new HashMap<Object, Object>() {{", "originalCommit": "79a97787415a911663277a73a3da47b187b2b093", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4MTU1OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/227#discussion_r422281558", "bodyText": "Done", "author": "chaurah", "createdAt": "2020-05-08T17:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI3OTkyMw=="}], "type": "inlineReview"}, {"oid": "dcc1bf37892d225d5ec2da32e7fc0b6592ff93a2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dcc1bf37892d225d5ec2da32e7fc0b6592ff93a2", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T17:56:16Z", "type": "commit"}, {"oid": "dcc1bf37892d225d5ec2da32e7fc0b6592ff93a2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dcc1bf37892d225d5ec2da32e7fc0b6592ff93a2", "message": "Add Deployment safe namespace topic", "committedDate": "2020-05-08T17:56:16Z", "type": "forcePushed"}]}