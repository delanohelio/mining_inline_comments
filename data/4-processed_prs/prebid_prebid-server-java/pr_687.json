{"pr_number": 687, "pr_title": "Targeting attribute truncation", "pr_createdAt": "2020-04-23T10:40:47Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/687", "timeline": [{"oid": "43ce99100390149a35f9dcc2ed8b3dd20b30432e", "url": "https://github.com/prebid/prebid-server-java/commit/43ce99100390149a35f9dcc2ed8b3dd20b30432e", "message": "Ad Server Targeting attribute truncation", "committedDate": "2020-04-22T13:55:09Z", "type": "commit"}, {"oid": "b5f9ab224962ee8187694aacd709157ad3f53e3d", "url": "https://github.com/prebid/prebid-server-java/commit/b5f9ab224962ee8187694aacd709157ad3f53e3d", "message": "variable name change", "committedDate": "2020-04-23T10:39:13Z", "type": "commit"}, {"oid": "5def2aab654a635c4fa7b72138506876fae79bb2", "url": "https://github.com/prebid/prebid-server-java/commit/5def2aab654a635c4fa7b72138506876fae79bb2", "message": "test fix", "committedDate": "2020-04-23T11:15:10Z", "type": "commit"}, {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "url": "https://github.com/prebid/prebid-server-java/commit/3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "message": "tests added", "committedDate": "2020-04-23T12:01:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MTMzMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414461331", "bodyText": "extract method", "author": "DGarbar", "createdAt": "2020-04-24T10:14:55Z", "path": "src/main/java/org/prebid/server/auction/TargetingKeywordsCreator.java", "diffHunk": "@@ -249,7 +257,13 @@ void put(String prefix, String value) {\n         private List<String> createKeys(String prefix) {\n             final List<String> keys = new ArrayList<>(2);\n             if (includeBidderKeys && !excludedBidderKeys.contains(prefix)) {\n-                keys.add(String.format(\"%s_%s\", prefix, bidder));\n+                final String targetKey = String.format(\"%s_%s\", prefix, bidder);\n+                if (truncateAttrChars != null && !truncateAttrChars.equals(0)\n+                        && targetKey.length() >= truncateAttrChars) {\n+                    keys.add(targetKey.substring(0, truncateAttrChars));\n+                } else {\n+                    keys.add(targetKey);\n+                }", "originalCommit": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzA0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414463048", "bodyText": "this is redundant", "author": "DGarbar", "createdAt": "2020-04-24T10:17:46Z", "path": "src/main/java/org/prebid/server/handler/AuctionHandler.java", "diffHunk": "@@ -402,12 +405,16 @@ private static PreBidResponse mergeBidsWithCacheResults(PreBidResponse preBidRes\n      * The bids are sorted by cpm to find the highest bid.\n      * The ad server targeting keywords are added to all bids, with specific keywords for the highest bid.\n      */\n-    private static PreBidResponse addTargetingKeywords(PreBidRequest preBidRequest, Account account,\n+    private PreBidResponse addTargetingKeywords(PreBidRequest preBidRequest, Account account,\n                                                        PreBidResponse preBidResponse) {\n         final Integer sortBids = preBidRequest.getSortBids();\n         if (sortBids != null && sortBids == 1) {\n+            final Integer truncateAttrChars = ObjectUtils.firstNonNull(account.getTruncateTargetAttr(),\n+                    preBidRequest.getMaxKeyLength(), this.truncateTargetingAttrMaxChars);", "originalCommit": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2OTMzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414469330", "bodyText": "@rpanchyk\nIs it ok to perform validation in the configuration ?", "author": "DGarbar", "createdAt": "2020-04-24T10:28:22Z", "path": "src/main/java/org/prebid/server/spring/config/ServiceConfiguration.java", "diffHunk": "@@ -529,9 +529,16 @@ BidResponseCreator bidResponseCreator(\n             BidderCatalog bidderCatalog,\n             EventsService eventsService,\n             StoredRequestProcessor storedRequestProcessor,\n+            @Value(\"${settings.targeting.truncate-attr-chars}\") Integer truncateTargetingAttrMaxChars,\n             JacksonMapper mapper) {\n \n-        return new BidResponseCreator(cacheService, bidderCatalog, eventsService, storedRequestProcessor, mapper);\n+        if (truncateTargetingAttrMaxChars != null\n+                && (truncateTargetingAttrMaxChars < 0 || truncateTargetingAttrMaxChars > 255)) {\n+            throw new IllegalArgumentException(\n+                    \"application.yaml settings.targeting.truncate-attr-chars value must be from 0 to 225 or null\");\n+        }", "originalCommit": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "223e08e730529e16ac3ef5d37cc70aacd07af8fd", "url": "https://github.com/prebid/prebid-server-java/commit/223e08e730529e16ac3ef5d37cc70aacd07af8fd", "message": "PR changes", "committedDate": "2020-04-24T10:56:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MTk1OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414491959", "bodyText": "@rpanchyk notice that default value for rubicon need to be 20", "author": "DGarbar", "createdAt": "2020-04-24T11:08:57Z", "path": "src/main/resources/application.yaml", "diffHunk": "@@ -76,6 +76,8 @@ settings:\n     ttl-seconds: 360\n     notification-endpoints-enabled: false\n     account-invalidation-enabled: true\n+  targeting:\n+    truncate-attr-chars: 0", "originalCommit": "223e08e730529e16ac3ef5d37cc70aacd07af8fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f4866f741fce8dc0f84ecdfb809af0391fdfb6a", "url": "https://github.com/prebid/prebid-server-java/commit/4f4866f741fce8dc0f84ecdfb809af0391fdfb6a", "message": "minor", "committedDate": "2020-04-24T12:56:15Z", "type": "commit"}, {"oid": "7743115fcd1c8e2c3700bb087f40a31eb403233d", "url": "https://github.com/prebid/prebid-server-java/commit/7743115fcd1c8e2c3700bb087f40a31eb403233d", "message": "minor", "committedDate": "2020-04-24T13:11:21Z", "type": "commit"}, {"oid": "da880a5399273f9713755b72cc92a057af268bd4", "url": "https://github.com/prebid/prebid-server-java/commit/da880a5399273f9713755b72cc92a057af268bd4", "message": "Merge branch 'master' into targeting-attribute-truncation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/BidResponseCreator.java\n#\tsrc/main/java/org/prebid/server/settings/JdbcApplicationSettings.java\n#\tsrc/main/java/org/prebid/server/spring/config/ServiceConfiguration.java\n#\tsrc/test/java/org/prebid/server/auction/BidResponseCreatorTest.java\n#\tsrc/test/java/org/prebid/server/settings/JdbcApplicationSettingsTest.java", "committedDate": "2020-06-09T16:13:13Z", "type": "commit"}, {"oid": "d772bb087a3699f4b4d8507976de92542ffb915d", "url": "https://github.com/prebid/prebid-server-java/commit/d772bb087a3699f4b4d8507976de92542ffb915d", "message": "Fixes after review", "committedDate": "2020-06-10T06:53:52Z", "type": "commit"}]}