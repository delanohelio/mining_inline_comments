{"pr_number": 1015, "pr_title": "Add http api for fetching accounts", "pr_createdAt": "2020-11-17T13:24:35Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/1015", "timeline": [{"oid": "687a4eb9e8b6d2b91016b35cc1e1045cd360d815", "url": "https://github.com/prebid/prebid-server-java/commit/687a4eb9e8b6d2b91016b35cc1e1045cd360d815", "message": "Add http api for fetching accounts", "committedDate": "2020-11-17T13:22:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwODQ4Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/1015#discussion_r526908482", "bodyText": "Since account payload is mapped to Account in HttpApplicationSettings it makes sense to do this conversion one time when HttpAccountResponse is constructed out of response body by changing this field to have Map<String, Account> type.", "author": "schernysh", "createdAt": "2020-11-19T14:00:37Z", "path": "src/main/java/org/prebid/server/settings/proto/response/HttpAccountsResponse.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package org.prebid.server.settings.proto.response;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.util.Map;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class HttpAccountsResponse {\n+\n+    Map<String, ObjectNode> accounts;", "originalCommit": "687a4eb9e8b6d2b91016b35cc1e1045cd360d815", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c4851f073f4f42544c60b307e2c354caebb3c27", "url": "https://github.com/prebid/prebid-server-java/commit/4c4851f073f4f42544c60b307e2c354caebb3c27", "message": "Replace ObjectNode with Account type in HttpAccountResponse model", "committedDate": "2020-11-20T10:07:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM3NzQyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/1015#discussion_r533377428", "bodyText": "pls rename to processStoredDataResponse(..)", "author": "rpanchyk", "createdAt": "2020-12-01T12:39:33Z", "path": "src/main/java/org/prebid/server/settings/HttpApplicationSettings.java", "diffHunk": "@@ -169,14 +219,14 @@ private static String joinIds(Set<String> ids) {\n         return String.join(\"\\\",\\\"\", ids);\n     }\n \n-    private static Future<StoredDataResult> failResponse(Throwable throwable, Set<String> requestIds,\n-                                                         Set<String> impIds) {\n+    private static Future<StoredDataResult> failStoreDataResponse(Throwable throwable, Set<String> requestIds,\n+                                                                  Set<String> impIds) {\n         return Future.succeededFuture(\n                 toFailedStoredDataResult(requestIds, impIds, throwable.getMessage()));\n     }\n \n-    private Future<StoredDataResult> processResponse(HttpClientResponse response, Set<String> requestIds,\n-                                                     Set<String> impIds) {\n+    private Future<StoredDataResult> processStoreDataResponse(HttpClientResponse response, Set<String> requestIds,", "originalCommit": "4c4851f073f4f42544c60b307e2c354caebb3c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM3NzU2Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/1015#discussion_r533377566", "bodyText": "pls rename to failStoredDataResponse(..)", "author": "rpanchyk", "createdAt": "2020-12-01T12:39:49Z", "path": "src/main/java/org/prebid/server/settings/HttpApplicationSettings.java", "diffHunk": "@@ -169,14 +219,14 @@ private static String joinIds(Set<String> ids) {\n         return String.join(\"\\\",\\\"\", ids);\n     }\n \n-    private static Future<StoredDataResult> failResponse(Throwable throwable, Set<String> requestIds,\n-                                                         Set<String> impIds) {\n+    private static Future<StoredDataResult> failStoreDataResponse(Throwable throwable, Set<String> requestIds,", "originalCommit": "4c4851f073f4f42544c60b307e2c354caebb3c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM3OTA1OA==", "url": "https://github.com/prebid/prebid-server-java/pull/1015#discussion_r533379058", "bodyText": "Potentially, accounts can be undefined in response, so we should tolerate the case.", "author": "rpanchyk", "createdAt": "2020-12-01T12:42:29Z", "path": "src/main/java/org/prebid/server/settings/HttpApplicationSettings.java", "diffHunk": "@@ -77,12 +78,61 @@ public HttpApplicationSettings(HttpClient httpClient, JacksonMapper mapper, Stri\n         this.videoEndpoint = HttpUtil.validateUrl(Objects.requireNonNull(videoEndpoint));\n     }\n \n-    /**\n-     * Not supported and returns failed result.\n-     */\n     @Override\n     public Future<Account> getAccountById(String accountId, Timeout timeout) {\n-        return Future.failedFuture(new PreBidException(\"Not supported\"));\n+\n+        return fetchAccountsByIds(Collections.singleton(accountId), timeout)\n+                .map(accounts -> accounts.stream()\n+                        .findFirst()\n+                        .orElseThrow(() ->\n+                                new PreBidException(String.format(\"Account with id :%s not found\", accountId))));\n+    }\n+\n+    private Future<Set<Account>> fetchAccountsByIds(Set<String> accountIds, Timeout timeout) {\n+        if (CollectionUtils.isEmpty(accountIds)) {\n+            return Future.succeededFuture(Collections.emptySet());\n+        }\n+        final long remainingTimeout = timeout.remaining();\n+        if (timeout.remaining() <= 0) {\n+            return Future.failedFuture(new TimeoutException(\"Timeout has been exceeded\"));\n+        }\n+\n+        return httpClient.get(accountsRequestUrlFrom(endpoint, accountIds), HttpUtil.headers(), remainingTimeout)\n+                .compose(response -> processAccountsResponse(response, accountIds))\n+                .recover(Future::failedFuture);\n+    }\n+\n+    private static String accountsRequestUrlFrom(String endpoint, Set<String> accountIds) {\n+        final StringBuilder url = new StringBuilder(endpoint);\n+        url.append(endpoint.contains(\"?\") ? \"&\" : \"?\");\n+\n+        if (!accountIds.isEmpty()) {\n+            url.append(\"account-ids=[\\\"\").append(joinIds(accountIds)).append(\"\\\"]\");\n+        }\n+\n+        return url.toString();\n+    }\n+\n+    private Future<Set<Account>> processAccountsResponse(HttpClientResponse response, Set<String> accountIds) {\n+        return Future.succeededFuture(\n+                toAccountsResult(response.getStatusCode(), response.getBody(), accountIds));\n+    }\n+\n+    private Set<Account> toAccountsResult(int statusCode, String body, Set<String> accountIds) {\n+        if (statusCode != HttpResponseStatus.OK.code()) {\n+            throw new PreBidException(String.format(\"Error fetching accounts %s via http: \"\n+                    + \"unexpected response status %d\", accountIds, statusCode));\n+        }\n+\n+        final HttpAccountsResponse response;\n+        try {\n+            response = mapper.decodeValue(body, HttpAccountsResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(String.format(\"Error fetching accounts %s \"\n+                    + \"via http: failed to parse response: %s\", accountIds, e.getMessage()));\n+        }\n+\n+        return new HashSet<>(response.getAccounts().values());", "originalCommit": "4c4851f073f4f42544c60b307e2c354caebb3c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MTE4NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/1015#discussion_r533381185", "bodyText": "Minor. Pls set white-space after the colon.", "author": "rpanchyk", "createdAt": "2020-12-01T12:46:13Z", "path": "src/main/java/org/prebid/server/settings/HttpApplicationSettings.java", "diffHunk": "@@ -77,12 +78,61 @@ public HttpApplicationSettings(HttpClient httpClient, JacksonMapper mapper, Stri\n         this.videoEndpoint = HttpUtil.validateUrl(Objects.requireNonNull(videoEndpoint));\n     }\n \n-    /**\n-     * Not supported and returns failed result.\n-     */\n     @Override\n     public Future<Account> getAccountById(String accountId, Timeout timeout) {\n-        return Future.failedFuture(new PreBidException(\"Not supported\"));\n+\n+        return fetchAccountsByIds(Collections.singleton(accountId), timeout)\n+                .map(accounts -> accounts.stream()\n+                        .findFirst()\n+                        .orElseThrow(() ->\n+                                new PreBidException(String.format(\"Account with id :%s not found\", accountId))));", "originalCommit": "4c4851f073f4f42544c60b307e2c354caebb3c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b04ab51d5b581c1b408e15392245be12084cae25", "url": "https://github.com/prebid/prebid-server-java/commit/b04ab51d5b581c1b408e15392245be12084cae25", "message": "Fixes after review", "committedDate": "2020-12-01T13:18:39Z", "type": "commit"}, {"oid": "34fa8276492e8171438d84cfd293ff8216cdc241", "url": "https://github.com/prebid/prebid-server-java/commit/34fa8276492e8171438d84cfd293ff8216cdc241", "message": "Merge branch 'master' into http/fetch/account", "committedDate": "2020-12-02T13:14:35Z", "type": "commit"}]}