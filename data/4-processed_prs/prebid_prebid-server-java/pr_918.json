{"pr_number": 918, "pr_title": "Add sizes support to AdoceanBidder", "pr_createdAt": "2020-09-21T22:16:33Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/918", "timeline": [{"oid": "3dc8d1efc908949badef2f1e5997281155e0d976", "url": "https://github.com/prebid/prebid-server-java/commit/3dc8d1efc908949badef2f1e5997281155e0d976", "message": "Add sizes support", "committedDate": "2020-09-21T22:11:43Z", "type": "commit"}, {"oid": "f137bb9a47418838b89af5e6bcc5efaa6e0aae95", "url": "https://github.com/prebid/prebid-server-java/commit/f137bb9a47418838b89af5e6bcc5efaa6e0aae95", "message": "Merge branch 'master' into adocean-add-support-sizes", "committedDate": "2020-10-27T12:51:21Z", "type": "commit"}, {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16", "url": "https://github.com/prebid/prebid-server-java/commit/d09aa16f81f66049cf793c7956c2e1046a0adc16", "message": "Fixes after review", "committedDate": "2020-10-27T13:31:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MTM1Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514441353", "bodyText": "What the difference?", "author": "rpanchyk", "createdAt": "2020-10-29T17:31:48Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -125,13 +132,19 @@ private boolean addRequestAndCheckIfDuplicates(List<HttpRequest<Void>> httpReque\n                         continue;\n                     }\n \n+                    queryParams.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+                    final List<String> sizeValues = test != null && test == 1\n+                            ? setSlaveSizesParam(slaveSizes, true)", "originalCommit": "d09aa16f81f66049cf793c7956c2e1046a0adc16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA==", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514442190", "bodyText": "Check for nulls in values for headers.", "author": "rpanchyk", "createdAt": "2020-10-29T17:33:07Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -170,38 +207,55 @@ private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consen\n             uriBuilder.addParameter(\"hcuserid\", user.getBuyeruid());\n         }\n \n+        final List<String> sizeValues = test != null && test == 1\n+                ? setSlaveSizesParam(slaveSizes, true)\n+                : setSlaveSizesParam(slaveSizes, false);\n+\n+        if (CollectionUtils.isNotEmpty(sizeValues)) {\n+            uriBuilder.addParameter(\"aosspsizes\", String.join(\"-\", sizeValues));\n+        }\n+\n         return uriBuilder.toString();\n     }\n \n+    private List<String> setSlaveSizesParam(Map<String, String> slaveSizes, boolean orderByKey) {\n+        final Set<String> slaveIDs = orderByKey ? new TreeSet<>(slaveSizes.keySet()) : slaveSizes.keySet();\n+\n+        return slaveIDs.stream()\n+                .filter(slaveId -> StringUtils.isNotBlank(slaveSizes.get(slaveId)))\n+                .map(rawSlaveID -> String.format(\"%s~%s\", rawSlaveID.replaceFirst(\"adocean\", \"\"),\n+                        slaveSizes.get(rawSlaveID)))\n+                .collect(Collectors.toList());\n+    }\n+\n     private static MultiMap getHeaders(BidRequest request) {\n         final MultiMap headers = HttpUtil.headers();\n         if (request.getDevice() != null) {\n-            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n-                    request.getDevice().getUa());\n-\n-            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIp());\n-            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIpv6());\n-            }\n+            addHeader(headers, \"User-Agent\", request.getDevice().getUa());", "originalCommit": "d09aa16f81f66049cf793c7956c2e1046a0adc16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzODM2Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514538362", "bodyText": "method addHeader contains StringUtils.isNotBlank(value)", "author": "snahornyi", "createdAt": "2020-10-29T20:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxNDg1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514914850", "bodyText": "fair", "author": "rpanchyk", "createdAt": "2020-10-30T07:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA=="}], "type": "inlineReview"}, {"oid": "20839591fcf7ebd44fd3a82579e4b13db0fb9e13", "url": "https://github.com/prebid/prebid-server-java/commit/20839591fcf7ebd44fd3a82579e4b13db0fb9e13", "message": "Code fix", "committedDate": "2020-10-29T20:14:41Z", "type": "commit"}]}