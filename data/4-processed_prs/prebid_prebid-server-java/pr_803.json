{"pr_number": 803, "pr_title": "Support app in EplanningBidder", "pr_createdAt": "2020-07-09T19:38:28Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/803", "timeline": [{"oid": "53b39429f12be5956060cf0bce529290690ad874", "url": "https://github.com/prebid/prebid-server-java/commit/53b39429f12be5956060cf0bce529290690ad874", "message": "Support app in EplanningBidder", "committedDate": "2020-07-09T19:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0NzkyMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486247921", "bodyText": "Pls extract request.getApp() to separate variable since it is used several times in method.", "author": "rpanchyk", "createdAt": "2020-09-10T10:58:16Z", "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())", "originalCommit": "53b39429f12be5956060cf0bce529290690ad874", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI1MDA5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486250093", "bodyText": "Would it be better if we get a small refactoring for fetching the value like:\nfinal String buyeruid = user != null ? user.getBuyeruid() : null;\nthen just replace current condition with buyeruid != null.\nBut up to you.", "author": "rpanchyk", "createdAt": "2020-09-10T11:02:28Z", "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())\n+                ? request.getApp().getBundle()\n+                : pageDomain;\n+\n+        final String uri = endpointUrl + String.format(\"/%s/%s/%s/%s\", clientId, DFP_CLIENT_ID, requestTarget, SEC);\n+\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(uri)\n+                .addParameter(\"r\", \"pbs\")\n+                .addParameter(\"ncb\", \"1\");\n+\n+        if (request.getApp() == null) {\n+            uriBuilder.addParameter(\"ur\", pageUrl);\n+        }\n+        uriBuilder.addParameter(\"e\", String.join(\"+\", requestsStrings));\n \n         final User user = request.getUser();\n         if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {", "originalCommit": "53b39429f12be5956060cf0bce529290690ad874", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI1MTA2MA==", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486251060", "bodyText": "We need to safe query string values with StringUtils.stripToNull(..) to avoid null as value.\nPls check all added (and existing) params.", "author": "rpanchyk", "createdAt": "2020-09-10T11:04:32Z", "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())\n+                ? request.getApp().getBundle()\n+                : pageDomain;\n+\n+        final String uri = endpointUrl + String.format(\"/%s/%s/%s/%s\", clientId, DFP_CLIENT_ID, requestTarget, SEC);\n+\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(uri)\n+                .addParameter(\"r\", \"pbs\")\n+                .addParameter(\"ncb\", \"1\");\n+\n+        if (request.getApp() == null) {\n+            uriBuilder.addParameter(\"ur\", pageUrl);\n+        }\n+        uriBuilder.addParameter(\"e\", String.join(\"+\", requestsStrings));\n \n         final User user = request.getUser();\n         if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n-            uri = uri + String.format(\"&uid=%s\", user.getBuyeruid());\n+            uriBuilder.addParameter(\"uid\", user.getBuyeruid());", "originalCommit": "53b39429f12be5956060cf0bce529290690ad874", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fd3cdf80c7711e68101cb64c49c4787ea9b437f4", "url": "https://github.com/prebid/prebid-server-java/commit/fd3cdf80c7711e68101cb64c49c4787ea9b437f4", "message": "Refactoring code", "committedDate": "2020-09-11T09:21:37Z", "type": "commit"}, {"oid": "bb82e47cfb6612ccadb96dc2963780c616221d77", "url": "https://github.com/prebid/prebid-server-java/commit/bb82e47cfb6612ccadb96dc2963780c616221d77", "message": "Merge branch 'master' into eplanning-support-apps", "committedDate": "2020-09-15T16:38:37Z", "type": "commit"}]}