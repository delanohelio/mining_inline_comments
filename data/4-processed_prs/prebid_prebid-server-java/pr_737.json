{"pr_number": 737, "pr_title": "Add AdgenerationBidder and tests", "pr_createdAt": "2020-05-29T20:45:08Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/737", "timeline": [{"oid": "7a6eddc1a7703bb625fcc4619d6b923d98ab6122", "url": "https://github.com/prebid/prebid-server-java/commit/7a6eddc1a7703bb625fcc4619d6b923d98ab6122", "message": "Add AdgenerationBidder and tests", "committedDate": "2020-05-29T20:43:16Z", "type": "commit"}, {"oid": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "url": "https://github.com/prebid/prebid-server-java/commit/5b1e2ff354c6a999eaae0cda32df25359b33b355", "message": "Fix tests: add bidresponse parameters", "committedDate": "2020-05-30T20:15:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NDA1NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444074055", "bodyText": "There is a simpler way to concatenate\n   private String getAdSize(Imp imp) {\n        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n            return \"\";\n        }\n\n        return imp.getBanner().getFormat().stream()\n                .map(format -> String.format(\"%s\u00d7%s\", format.getW(), format.getH()))\n                .collect(Collectors.joining(\",\"));\n    }", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T09:03:08Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM1NjEyMw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444356123", "bodyText": "Thanks! Pretty nice!", "author": "AndriyPavlyuk", "createdAt": "2020-06-23T16:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3ODQ4Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444078487", "bodyText": "Consider this approach. The only benefit is less nesting and maybe readability, second depends on habit.\n    private String getCurrency(BidRequest request) {\n        final List<String> currencies = request.getCur();\n        return CollectionUtils.isEmpty(request.getCur())\n                ? DEFAULT_REQUEST_CURRENCY\n                : currencies.contains(DEFAULT_REQUEST_CURRENCY) ? DEFAULT_REQUEST_CURRENCY : currencies.get(0);\n    }", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T09:10:36Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2MDAyMA==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444360020", "bodyText": "Thanks, looks pretty nice and shorter!", "author": "AndriyPavlyuk", "createdAt": "2020-06-23T16:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3ODQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3OTYxMg==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444079612", "bodyText": "For each request with adgenereation impressions new MultMap will be created with the same values. You can make it as final static class field and reuse the same object", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T09:12:26Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MzY0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444083646", "bodyText": "I don't see a reason to make this class generic. Results in go version is used only to check if it is empty or not. It can be Listresults. Also check for not empty results missed on makeBids(), please update it.\nAlso fields baconurl, ttl, landingUrl, scheduleid are also never used", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T09:19:15Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/model/AdgenerationResponse.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.prebid.server.bidder.adgeneration.model;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.math.BigDecimal;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class AdgenerationResponse<T> {", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQzMDYzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444430630", "bodyText": "Ok, i removed generic from class and added check for results empty.\nbaconurl, ttl, landingUrl, scheduleid are used in Go tests. They include this parameters in   AdgenerationResponse.results. So maybe we need this fields for correct flow?", "author": "AndriyPavlyuk", "createdAt": "2020-06-23T18:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MzY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4NzY5OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444087699", "bodyText": "Maybe String.format more readable?", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T09:25:48Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+            }\n+\n+            if (extImpAdgeneration.getId().equals(adgenerationResponse.getLocationid())) {\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adgenerationResponse.getLocationid())\n+                        .impid(imp.getId())\n+                        .adm(getAdm(adgenerationResponse, imp.getId()))\n+                        .price(adgenerationResponse.getCpm())\n+                        .w(adgenerationResponse.getW())\n+                        .h(adgenerationResponse.getH())\n+                        .crid(adgenerationResponse.getCreativeid())\n+                        .dealid(adgenerationResponse.getDealid())\n+                        .build();\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+                return Result.of(bidderBids, Collections.emptyList());\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private AdgenerationResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), AdgenerationResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private String getAdm(AdgenerationResponse adgenerationResponse, String impId) {\n+        String ad = adgenerationResponse.getAd();\n+        if (StringUtils.isNotBlank(adgenerationResponse.getVastxml())) {\n+            ad = \"<body><div id=\\\"apvad-\" + impId + \"\\\"></div><script type=\\\"text/javascript\\\" id=\\\"apv\\\" \"", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQzMTAxMA==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444431010", "bodyText": "Yes, thanks", "author": "AndriyPavlyuk", "createdAt": "2020-06-23T18:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4NzY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyODI2Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444128267", "bodyText": "Pattern.compile() methods have a significant performance cost\nConsider to use precompiled Pattern in static field, instead creating new Pattern for each response in replcaceAll method.", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:37:45Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+            }\n+\n+            if (extImpAdgeneration.getId().equals(adgenerationResponse.getLocationid())) {\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adgenerationResponse.getLocationid())\n+                        .impid(imp.getId())\n+                        .adm(getAdm(adgenerationResponse, imp.getId()))\n+                        .price(adgenerationResponse.getCpm())\n+                        .w(adgenerationResponse.getW())\n+                        .h(adgenerationResponse.getH())\n+                        .crid(adgenerationResponse.getCreativeid())\n+                        .dealid(adgenerationResponse.getDealid())\n+                        .build();\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+                return Result.of(bidderBids, Collections.emptyList());\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private AdgenerationResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), AdgenerationResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private String getAdm(AdgenerationResponse adgenerationResponse, String impId) {\n+        String ad = adgenerationResponse.getAd();\n+        if (StringUtils.isNotBlank(adgenerationResponse.getVastxml())) {\n+            ad = \"<body><div id=\\\"apvad-\" + impId + \"\\\"></div><script type=\\\"text/javascript\\\" id=\\\"apv\\\" \"\n+                    + \"src=\\\"https://cdn.apvdr.com/js/VideoAd.min.js\\\"></script>\" + insertVASTMethod(impId,\n+                    adgenerationResponse.getVastxml()) + \"</body>\";\n+        }\n+        ad = appendChildToBody(ad, adgenerationResponse.getBeacon());\n+        final String unwrappedAd = removeWrapper(ad);\n+        if (StringUtils.isNotBlank(unwrappedAd)) {\n+            return unwrappedAd;\n+        }\n+        return ad;\n+    }\n+\n+    private String insertVASTMethod(String impId, String vastXml) {\n+        final String replacedVastxml = vastXml.replaceAll(\"/\\\\r?\\\\n/g\", \"\");", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzMDc2OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444130769", "bodyText": "What if beacon is null?", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:42:37Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+            }\n+\n+            if (extImpAdgeneration.getId().equals(adgenerationResponse.getLocationid())) {\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adgenerationResponse.getLocationid())\n+                        .impid(imp.getId())\n+                        .adm(getAdm(adgenerationResponse, imp.getId()))\n+                        .price(adgenerationResponse.getCpm())\n+                        .w(adgenerationResponse.getW())\n+                        .h(adgenerationResponse.getH())\n+                        .crid(adgenerationResponse.getCreativeid())\n+                        .dealid(adgenerationResponse.getDealid())\n+                        .build();\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+                return Result.of(bidderBids, Collections.emptyList());\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private AdgenerationResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), AdgenerationResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private String getAdm(AdgenerationResponse adgenerationResponse, String impId) {\n+        String ad = adgenerationResponse.getAd();\n+        if (StringUtils.isNotBlank(adgenerationResponse.getVastxml())) {\n+            ad = \"<body><div id=\\\"apvad-\" + impId + \"\\\"></div><script type=\\\"text/javascript\\\" id=\\\"apv\\\" \"\n+                    + \"src=\\\"https://cdn.apvdr.com/js/VideoAd.min.js\\\"></script>\" + insertVASTMethod(impId,\n+                    adgenerationResponse.getVastxml()) + \"</body>\";\n+        }\n+        ad = appendChildToBody(ad, adgenerationResponse.getBeacon());", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzMTA1OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444131059", "bodyText": "not covered with test", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:43:10Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+            }\n+\n+            if (extImpAdgeneration.getId().equals(adgenerationResponse.getLocationid())) {\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adgenerationResponse.getLocationid())\n+                        .impid(imp.getId())\n+                        .adm(getAdm(adgenerationResponse, imp.getId()))\n+                        .price(adgenerationResponse.getCpm())\n+                        .w(adgenerationResponse.getW())\n+                        .h(adgenerationResponse.getH())\n+                        .crid(adgenerationResponse.getCreativeid())\n+                        .dealid(adgenerationResponse.getDealid())\n+                        .build();\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+                return Result.of(bidderBids, Collections.emptyList());\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private AdgenerationResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), AdgenerationResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private String getAdm(AdgenerationResponse adgenerationResponse, String impId) {\n+        String ad = adgenerationResponse.getAd();\n+        if (StringUtils.isNotBlank(adgenerationResponse.getVastxml())) {\n+            ad = \"<body><div id=\\\"apvad-\" + impId + \"\\\"></div><script type=\\\"text/javascript\\\" id=\\\"apv\\\" \"\n+                    + \"src=\\\"https://cdn.apvdr.com/js/VideoAd.min.js\\\"></script>\" + insertVASTMethod(impId,\n+                    adgenerationResponse.getVastxml()) + \"</body>\";\n+        }\n+        ad = appendChildToBody(ad, adgenerationResponse.getBeacon());\n+        final String unwrappedAd = removeWrapper(ad);\n+        if (StringUtils.isNotBlank(unwrappedAd)) {\n+            return unwrappedAd;\n+        }\n+        return ad;", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzMTQ0MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444131441", "bodyText": "not covered with test", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:44:01Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzMTk4Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444131983", "bodyText": "check exception instance and message", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:45:07Z", "path": "src/test/java/org/prebid/server/bidder/adgeneration/AdgenerationBidderTest.java", "diffHunk": "@@ -0,0 +1,208 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+\n+public class AdgenerationBidderTest extends VertxTest {\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com/\";\n+\n+    private AdgenerationBidder adgenerationBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adgenerationBidder = new AdgenerationBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new AdgenerationBidder(\"invalid_url\", jacksonMapper));", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNDE0OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444134149", "bodyText": "this else case is not covered, add tests for cases when currency is default and .get(0) currency", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:49:05Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNDM1Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444134353", "bodyText": "cover with test", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:49:31Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNDQwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444134408", "bodyText": "cover with test", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:49:41Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNTIyMA==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444135220", "bodyText": "Not all status codes covered with tests", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:51:12Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNTk0Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444135943", "bodyText": "Cover this case with test", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T10:52:49Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            final ExtImpAdgeneration extImpAdgeneration;\n+            try {\n+                extImpAdgeneration = parseAndValidateImpExt(imp);\n+            } catch (PreBidException e) {\n+                return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+            }\n+\n+            if (extImpAdgeneration.getId().equals(adgenerationResponse.getLocationid())) {\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adgenerationResponse.getLocationid())\n+                        .impid(imp.getId())\n+                        .adm(getAdm(adgenerationResponse, imp.getId()))\n+                        .price(adgenerationResponse.getCpm())\n+                        .w(adgenerationResponse.getW())\n+                        .h(adgenerationResponse.getH())\n+                        .crid(adgenerationResponse.getCreativeid())\n+                        .dealid(adgenerationResponse.getDealid())\n+                        .build();\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+                return Result.of(bidderBids, Collections.emptyList());\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private AdgenerationResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), AdgenerationResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private String getAdm(AdgenerationResponse adgenerationResponse, String impId) {\n+        String ad = adgenerationResponse.getAd();\n+        if (StringUtils.isNotBlank(adgenerationResponse.getVastxml())) {\n+            ad = \"<body><div id=\\\"apvad-\" + impId + \"\\\"></div><script type=\\\"text/javascript\\\" id=\\\"apv\\\" \"\n+                    + \"src=\\\"https://cdn.apvdr.com/js/VideoAd.min.js\\\"></script>\" + insertVASTMethod(impId,\n+                    adgenerationResponse.getVastxml()) + \"</body>\";\n+        }\n+        ad = appendChildToBody(ad, adgenerationResponse.getBeacon());\n+        final String unwrappedAd = removeWrapper(ad);\n+        if (StringUtils.isNotBlank(unwrappedAd)) {\n+            return unwrappedAd;\n+        }\n+        return ad;\n+    }\n+\n+    private String insertVASTMethod(String impId, String vastXml) {\n+        final String replacedVastxml = vastXml.replaceAll(\"/\\\\r?\\\\n/g\", \"\");\n+        return \"<script type=\\\"text/javascript\\\"> (function(){ new APV.VideoAd({s:\\\"\" + impId + \"\\\"}).load('\"\n+                + replacedVastxml + \"'); })(); </script>\";\n+    }\n+\n+    private String appendChildToBody(String ad, String beacon) {\n+        return ad.replaceAll(\"</\\\\s?body>\", beacon + \"</body>\");\n+    }\n+\n+    private String removeWrapper(String ad) {\n+        if (!ad.contains(\"<body>\") || ad.lastIndexOf(\"</body>\") == -1) {\n+            return \"\";", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0MTU5Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444141596", "bodyText": "missing\nif(CollectionUtils.isEmpty(adgenerationResponse.getResults())){\nreturn Result.empty();\n}\nPlease look at adgeneration.go line 178", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T11:04:48Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/AdgenerationBidder.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.prebid.server.bidder.adgeneration;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adgeneration.model.AdgenerationResponse;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adgeneration.ExtImpAdgeneration;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * AdgenerationBidder {@link Bidder} implementation.\n+ */\n+public class AdgenerationBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdgeneration>> ADGENERATION_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdgeneration>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final String DEFAULT_REQUEST_CURRENCY = \"JPY\";\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdgenerationBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdgeneration extImpAdgeneration = parseAndValidateImpExt(imp);\n+                final String uri = getUri(endpointUrl, getAdSize(imp), extImpAdgeneration.getId(),\n+                        getCurrency(request), request.getSite());\n+                result.add(createSingleRequest(imp, request, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdgeneration parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdgeneration extImpAdgeneration;\n+        try {\n+            extImpAdgeneration = mapper.mapper().convertValue(imp.getExt(), ADGENERATION_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage());\n+        }\n+\n+        if (StringUtils.isBlank(extImpAdgeneration.getId())) {\n+            throw new PreBidException(\"No Location ID in ExtImpAdgeneration.\");\n+        }\n+        return extImpAdgeneration;\n+    }\n+\n+    private String getUri(String endpointUrl, String adSize, String id, String currency, Site site) {\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(endpointUrl)\n+                .addParameter(\"posall\", \"SSPLOC\")\n+                .addParameter(\"id\", id)\n+                .addParameter(\"sdktype\", \"0\")\n+                .addParameter(\"hb\", \"true\")\n+                .addParameter(\"t\", \"json3\")\n+                .addParameter(\"currency\", currency)\n+                .addParameter(\"sdkname\", \"prebidserver\")\n+                .addParameter(\"adapterver\", VERSION);\n+\n+        if (StringUtils.isNotBlank(adSize)) {\n+            uriBuilder.addParameter(\"size\", adSize);\n+        }\n+\n+        if (site != null && StringUtils.isNotBlank(site.getPage())) {\n+            uriBuilder.addParameter(\"tp\", site.getPage());\n+        }\n+\n+        return uriBuilder.toString();\n+    }\n+\n+    private String getAdSize(Imp imp) {\n+        if (imp.getBanner() == null || CollectionUtils.isEmpty(imp.getBanner().getFormat())) {\n+            return \"\";\n+        }\n+        StringBuilder adSize = new StringBuilder();\n+        for (Format format : imp.getBanner().getFormat()) {\n+            final Integer formatHeight = format.getH();\n+            final Integer formatWidth = format.getW();\n+            adSize.append(String.format(\"%s\u00d7%s,\", formatWidth, formatHeight));\n+        }\n+\n+        if (adSize.length() > 0 && adSize.lastIndexOf(\",\") == adSize.length() - 1) {\n+            adSize.deleteCharAt(adSize.length() - 1);\n+        }\n+\n+        return adSize.toString();\n+    }\n+\n+    private String getCurrency(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getCur())) {\n+            return DEFAULT_REQUEST_CURRENCY;\n+        } else {\n+            for (String cur : request.getCur()) {\n+                if (cur.equals(DEFAULT_REQUEST_CURRENCY)) {\n+                    return cur;\n+                }\n+            }\n+            return request.getCur().get(0);\n+        }\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String uri) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(uri)\n+                .headers(HttpUtil.headers())\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final AdgenerationResponse adgenerationResponse;\n+        try {\n+            adgenerationResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0MjExNw==", "url": "https://github.com/prebid/prebid-server-java/pull/737#discussion_r444142117", "bodyText": "Type beaconUrl", "author": "BraslavskiyAndrey", "createdAt": "2020-06-23T11:05:54Z", "path": "src/main/java/org/prebid/server/bidder/adgeneration/model/AdgenerationResponse.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.prebid.server.bidder.adgeneration.model;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.math.BigDecimal;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class AdgenerationResponse<T> {\n+\n+    String locationid;\n+\n+    String dealid;\n+\n+    String ad;\n+\n+    String beacon;\n+\n+    String baconurl;", "originalCommit": "5b1e2ff354c6a999eaae0cda32df25359b33b355", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b095b1edf37e6650dbcfb21af33af225a25550f", "url": "https://github.com/prebid/prebid-server-java/commit/7b095b1edf37e6650dbcfb21af33af225a25550f", "message": "Refactoring methods and adding new unit tests", "committedDate": "2020-06-24T09:27:51Z", "type": "commit"}, {"oid": "5fdd0a96c8d691ccd71c85c66d8712741f065d6d", "url": "https://github.com/prebid/prebid-server-java/commit/5fdd0a96c8d691ccd71c85c66d8712741f065d6d", "message": "Merge branch 'master' into add-adgeneration-bidder", "committedDate": "2020-06-24T09:33:47Z", "type": "commit"}, {"oid": "47f82e21a538b871730afd1f9d66fb9b6fa52af1", "url": "https://github.com/prebid/prebid-server-java/commit/47f82e21a538b871730afd1f9d66fb9b6fa52af1", "message": "Enable ccppa in configuration file", "committedDate": "2020-06-24T09:43:20Z", "type": "commit"}, {"oid": "d500022aa3caae956a56bd968de7707c22fc3e90", "url": "https://github.com/prebid/prebid-server-java/commit/d500022aa3caae956a56bd968de7707c22fc3e90", "message": "Fixed HTTP request type.\nAdd it test parameters\nRefactor", "committedDate": "2020-07-02T13:05:41Z", "type": "commit"}, {"oid": "f14dde4f4678ea739f596c971f8af8efd172748b", "url": "https://github.com/prebid/prebid-server-java/commit/f14dde4f4678ea739f596c971f8af8efd172748b", "message": "Merge branch 'master' into add-adgeneration-bidder", "committedDate": "2020-07-06T09:09:04Z", "type": "commit"}, {"oid": "c9bcafc0a1998ba5a23c7049a5c612ec036d6393", "url": "https://github.com/prebid/prebid-server-java/commit/c9bcafc0a1998ba5a23c7049a5c612ec036d6393", "message": "Merge remote-tracking branch 'github-rubicon/add-adgeneration-bidder' into add-adgeneration-bidder", "committedDate": "2020-07-06T09:17:26Z", "type": "commit"}]}