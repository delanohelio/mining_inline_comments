{"pr_number": 653, "pr_title": "Add timestamp and biddercode to event URL - refactored", "pr_createdAt": "2020-04-03T18:21:34Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/653", "timeline": [{"oid": "e4d1a323404ee11b360588ec794fe28b304238b5", "url": "https://github.com/prebid/prebid-server-java/commit/e4d1a323404ee11b360588ec794fe28b304238b5", "message": "Add timestamp and biddercode to event URL - refactored", "committedDate": "2020-04-03T18:17:02Z", "type": "commit"}, {"oid": "8ef760b23a8262be41e0eb64d0d38deec21255fe", "url": "https://github.com/prebid/prebid-server-java/commit/8ef760b23a8262be41e0eb64d0d38deec21255fe", "message": "Add timestamp and biddercode to event URL - refactored\n\nadded timestamp field to PutObject", "committedDate": "2020-04-03T19:58:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzNTQwMg==", "url": "https://github.com/prebid/prebid-server-java/pull/653#discussion_r403935402", "bodyText": "NumberUtils.isDigits() or StringUtils.isDigits(), (but we still need to check for null bc this value is not required)", "author": "DGarbar", "createdAt": "2020-04-06T09:03:02Z", "path": "src/main/java/org/prebid/server/events/EventUtil.java", "diffHunk": "@@ -88,10 +81,14 @@ public static void validateAnalytics(RoutingContext context) {\n     }\n \n     public static void validateTimestamp(RoutingContext context) {\n-        final String timestamp = context.request().params().get(TIMESTAMP_PARAMETER);\n-        if (StringUtils.isBlank(timestamp)) {\n-            throw new IllegalArgumentException(String.format(\n-                    \"Timestamp '%s' is required query parameter and can't be empty\", TIMESTAMP_PARAMETER));\n+        final String timestamp = StringUtils.stripToNull(context.request().params().get(TIMESTAMP_PARAMETER));\n+        if (timestamp != null) {\n+            try {\n+                Long.parseLong(timestamp);", "originalCommit": "8ef760b23a8262be41e0eb64d0d38deec21255fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxODc1NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/653#discussion_r404018755", "bodyText": "Both util methods doesn't guaranteed Long range value checking, so NumberFormatException can be thrown. Don't think they are useful here.", "author": "rpanchyk", "createdAt": "2020-04-06T11:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzNTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk0NTM1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/653#discussion_r403945350", "bodyText": "suggest\n   for (PutObject putObject : putObjects) {\n\n            JsonNode value = putObject.getValue();\n            if (biddersAllowingVastUpdate.contains(putObject.getBidder()) && value != null) {\n                final String updatedVastXml = modifyVastXml(value.asText(), putObject.getBidid(),\n                        putObject.getBidder(), accountId, putObject.getTimestamp());\n                value = new TextNode(updatedVastXml);\n            }\n\n            updatedPutObjects.add(putObject.toBuilder()\n                    // remove \"/vtrack\" specific fields\n                    .bidid(null)\n                    .bidder(null)\n                    .timestamp(null)\n                    \n                    .value(value)\n                    .build());\n        }", "author": "DGarbar", "createdAt": "2020-04-06T09:18:55Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -168,32 +168,36 @@ public String getCachedAssetURLTemplate() {\n      * The returned result will always have the number of elements equals putObjects list size.\n      */\n     public Future<BidCacheResponse> cachePutObjects(List<PutObject> putObjects, Set<String> biddersAllowingVastUpdate,\n-                                                    String accountId, Timeout timeout, Long auctionTimestamp) {\n-        final List<PutObject> updatedPutObjects = updatePutObjects(putObjects, biddersAllowingVastUpdate,\n-                accountId, auctionTimestamp);\n+                                                    String accountId, Timeout timeout) {\n+        final List<PutObject> updatedPutObjects = updatePutObjects(putObjects, biddersAllowingVastUpdate, accountId);\n         return makeRequest(BidCacheRequest.of(updatedPutObjects), updatedPutObjects.size(), timeout);\n     }\n \n     /**\n      * Modify VAST value in putObjects.\n      */\n     private List<PutObject> updatePutObjects(List<PutObject> putObjects, Set<String> biddersAllowingVastUpdate,\n-                                             String accountId, Long auctionTimestamp) {\n+                                             String accountId) {\n         if (CollectionUtils.isEmpty(biddersAllowingVastUpdate)) {\n             return putObjects;\n         }\n \n         final List<PutObject> updatedPutObjects = new ArrayList<>();\n         for (PutObject putObject : putObjects) {\n+            final PutObject.PutObjectBuilder builder = putObject.toBuilder()\n+                    // remove \"/vtrack\" specific fields\n+                    .bidid(null)\n+                    .bidder(null)\n+                    .timestamp(null);\n+\n             final JsonNode value = putObject.getValue();\n             if (biddersAllowingVastUpdate.contains(putObject.getBidder()) && value != null) {\n-                final String updatedVastValue = modifyVastXml(value.asText(), putObject.getBidid(),\n-                        putObject.getBidder(), accountId, auctionTimestamp);\n-                final PutObject updatedPutObject = putObject.toBuilder().value(new TextNode(updatedVastValue)).build();\n-                updatedPutObjects.add(updatedPutObject);\n-            } else {\n-                updatedPutObjects.add(putObject);\n+                final String updatedVastXml = modifyVastXml(value.asText(), putObject.getBidid(),\n+                        putObject.getBidder(), accountId, putObject.getTimestamp());\n+                builder.value(new TextNode(updatedVastXml)).build();\n             }\n+\n+            updatedPutObjects.add(builder.build());", "originalCommit": "8ef760b23a8262be41e0eb64d0d38deec21255fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAxODkxMA==", "url": "https://github.com/prebid/prebid-server-java/pull/653#discussion_r404018910", "bodyText": "kind of taste-)", "author": "rpanchyk", "createdAt": "2020-04-06T11:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk0NTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk0ODQ1Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/653#discussion_r403948453", "bodyText": "I'd also added .timestamp(1231221L) to test", "author": "DGarbar", "createdAt": "2020-04-06T09:23:57Z", "path": "src/test/java/org/prebid/server/cache/CacheServiceTest.java", "diffHunk": "@@ -1072,35 +1071,63 @@ public void cachePutObjectsShouldModifyVastAndCachePutObjects() throws IOExcepti\n         // given\n         final PutObject firstPutObject = PutObject.builder()\n                 .type(\"xml\")\n-                .bidid(\"biddid1\")\n+                .bidid(\"bidId1\")", "originalCommit": "8ef760b23a8262be41e0eb64d0d38deec21255fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc38d236626006e6554d50f89210df9fde9c36c0", "url": "https://github.com/prebid/prebid-server-java/commit/bc38d236626006e6554d50f89210df9fde9c36c0", "message": "Add timestamp and biddercode to event URL - refactored\n\nfixed PR", "committedDate": "2020-04-06T11:31:03Z", "type": "commit"}]}