{"pr_number": 618, "pr_title": "Add customized admin endpoints", "pr_createdAt": "2020-02-13T10:22:49Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/618", "timeline": [{"oid": "14041e797943cbd94df6fdfa7447280b80fb57bf", "url": "https://github.com/prebid/prebid-server-java/commit/14041e797943cbd94df6fdfa7447280b80fb57bf", "message": "Add customized admin endpoints\n\nUpdate configuration docs\n\nChange\n`/storedrequests/amp` -> `/pbs-admin/storedrequests/amp` (settings.in-memory-cache.notification-endpoints-enabled)\n`/storedrequests/openrtb2` -> `/pbs-admin/storedrequests/openrtb2` (settings.in-memory-cache.notification-endpoints-enabled)\n`/admin` -> `/pbs-admin/admin` (logger-level-modifier.enabled)\n`/currency-rates` -> `/pbs-admin/currency-rates` (currency-converter.external-rates.enabled)\n\nKeep in mind, that if any enabled, you need to specified corresponding: (bc we don't use default)\n```\nadmin-endpoints.***.on-application-port=\nadmin-endpoints.***.protected=\n```\n\nAdd configuration differences.", "committedDate": "2020-02-13T10:22:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA3NDM0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/618#discussion_r380074348", "bodyText": "I would avoid polluting context with such generic bean as Map<String, String>. It's much more reliable and straightforward to inject AdminEndpointCredentials in ampCacheNotificationEndpoint factory method and just use getter getCredentials() right there.", "author": "schernysh", "createdAt": "2020-02-17T09:41:20Z", "path": "src/main/java/org/prebid/server/spring/config/AdminEndpointsConfiguration.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package org.prebid.server.spring.config;\n+\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.prebid.server.currency.CurrencyConversionService;\n+import org.prebid.server.execution.LogModifier;\n+import org.prebid.server.handler.AdminHandler;\n+import org.prebid.server.handler.CurrencyRatesHandler;\n+import org.prebid.server.handler.CustomizedAdminEndpoint;\n+import org.prebid.server.handler.SettingsCacheNotificationHandler;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.settings.SettingsCache;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+@Configuration\n+public class AdminEndpointsConfiguration {\n+\n+    private static final String LOGGER_LEVEL_ENDPOINT = \"/pbs-admin/admin\";\n+    private static final String CURRENCY_RATES_ENDPOINT = \"/pbs-admin/currency-rates\";\n+    private static final String STOREDREQUESTS_OPENRTB_ENDPOINT = \"/pbs-admin/storedrequests/openrtb2\";\n+    private static final String STOREDREQUESTS_AMP_ENDPOINT = \"/pbs-admin/storedrequests/amp\";\n+\n+    @Bean\n+    @ConditionalOnProperty(prefix = \"logger-level-modifier\", name = \"enabled\", havingValue = \"true\")\n+    CustomizedAdminEndpoint loggerLevelModifierEndpoint(\n+            LogModifier logModifier,\n+            @Autowired(required = false) Map<String, String> adminEndpointCredentials,\n+            @Value(\"${admin-endpoints.logger-level-modifier.on-application-port}\") boolean isOnApplicationPort,\n+            @Value(\"${admin-endpoints.logger-level-modifier.protected}\") boolean isProtected) {\n+        final AdminHandler adminHandler = new AdminHandler(logModifier);\n+        return new CustomizedAdminEndpoint(LOGGER_LEVEL_ENDPOINT, adminHandler, isOnApplicationPort,\n+                isProtected)\n+                .credentials(adminEndpointCredentials);\n+    }\n+\n+    @Bean\n+    @ConditionalOnProperty(prefix = \"currency-converter.external-rates\", name = \"enabled\", havingValue = \"true\")\n+    CustomizedAdminEndpoint currencyConversionRatesEndpoint(\n+            CurrencyConversionService currencyConversionRates,\n+            JacksonMapper mapper,\n+            @Autowired(required = false) Map<String, String> adminEndpointCredentials,\n+            @Value(\"${admin-endpoints.currency-rates.on-application-port}\") boolean isOnApplicationPort,\n+            @Value(\"${admin-endpoints.currency-rates.protected}\") boolean isProtected) {\n+        final CurrencyRatesHandler currencyRatesHandler = new CurrencyRatesHandler(currencyConversionRates, mapper);\n+        return new CustomizedAdminEndpoint(CURRENCY_RATES_ENDPOINT, currencyRatesHandler, isOnApplicationPort,\n+                isProtected)\n+                .credentials(adminEndpointCredentials);\n+    }\n+\n+    @Bean\n+    @ConditionalOnProperty(prefix = \"settings.in-memory-cache\", name = \"notification-endpoints-enabled\",\n+            havingValue = \"true\")\n+    CustomizedAdminEndpoint cacheNotificationEndpoint(\n+            SettingsCache settingsCache,\n+            JacksonMapper mapper,\n+            @Autowired(required = false) Map<String, String> adminEndpointCredentials,\n+            @Value(\"${admin-endpoints.storedrequest.on-application-port}\") boolean isOnApplicationPort,\n+            @Value(\"${admin-endpoints.storedrequest.protected}\") boolean isProtected) {\n+        final SettingsCacheNotificationHandler cacheNotificationHandler =\n+                new SettingsCacheNotificationHandler(settingsCache, mapper);\n+        return new CustomizedAdminEndpoint(STOREDREQUESTS_OPENRTB_ENDPOINT, cacheNotificationHandler,\n+                isOnApplicationPort, isProtected)\n+                .credentials(adminEndpointCredentials);\n+    }\n+\n+    @Bean\n+    @ConditionalOnProperty(prefix = \"settings.in-memory-cache\", name = \"notification-endpoints-enabled\",\n+            havingValue = \"true\")\n+    CustomizedAdminEndpoint ampCacheNotificationEndpoint(\n+            SettingsCache ampSettingsCache,\n+            JacksonMapper mapper,\n+            @Autowired(required = false) Map<String, String> adminEndpointCredentials,\n+            @Value(\"${admin-endpoints.storedrequest-amp.on-application-port}\") boolean isOnApplicationPort,\n+            @Value(\"${admin-endpoints.storedrequest-amp.protected}\") boolean isProtected) {\n+        final SettingsCacheNotificationHandler settingsCacheNotificationHandler =\n+                new SettingsCacheNotificationHandler(ampSettingsCache, mapper);\n+        return new CustomizedAdminEndpoint(STOREDREQUESTS_AMP_ENDPOINT, settingsCacheNotificationHandler,\n+                isOnApplicationPort, isProtected)\n+                .credentials(adminEndpointCredentials);\n+    }\n+\n+    @Bean\n+    Map<String, String> adminEndpointCredentials(", "originalCommit": "14041e797943cbd94df6fdfa7447280b80fb57bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA3NjQ5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/618#discussion_r380076493", "bodyText": "Having this method makes this class a bit of a puzzle as it looks more like a part of the builder approach whilst it is not the case. As a corresponding alternative to what this method is supposed to do you can create another constructor overload that accepts credentials in addition to other properties.", "author": "schernysh", "createdAt": "2020-02-17T09:45:04Z", "path": "src/main/java/org/prebid/server/handler/CustomizedAdminEndpoint.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.prebid.server.handler;\n+\n+import io.vertx.core.Future;\n+import io.vertx.core.Handler;\n+import io.vertx.ext.auth.AuthProvider;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BasicAuthHandler;\n+import org.apache.commons.collections4.MapUtils;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class CustomizedAdminEndpoint {\n+\n+    private final Handler<RoutingContext> handler;\n+    private final boolean isOnApplicationPort;\n+    private final boolean isProtected;\n+    private final String path;\n+    private Map<String, String> adminEndpointCredentials;\n+\n+    public CustomizedAdminEndpoint(String path, Handler<RoutingContext> handler, boolean isOnApplicationPort,\n+                                   boolean isProtected) {\n+        this.path = path;\n+        this.handler = handler;\n+        this.isOnApplicationPort = isOnApplicationPort;\n+        this.isProtected = isProtected;\n+    }\n+\n+    public CustomizedAdminEndpoint credentials(Map<String, String> adminEndpointCredentials) {", "originalCommit": "14041e797943cbd94df6fdfa7447280b80fb57bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA4NzA2Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/618#discussion_r380087063", "bodyText": "Since qualifier is used here I would suggest making router bean name explicit in place of its declaration (@Bean Router router(...) method)", "author": "schernysh", "createdAt": "2020-02-17T10:03:36Z", "path": "src/main/java/org/prebid/server/spring/config/WebConfiguration.java", "diffHunk": "@@ -99,6 +94,7 @@\n     private ExceptionHandler exceptionHandler;\n \n     @Autowired\n+    @Qualifier(\"router\")", "originalCommit": "14041e797943cbd94df6fdfa7447280b80fb57bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "718b18d16f4b515a7bf5c9119865e0cc024aa993", "url": "https://github.com/prebid/prebid-server-java/commit/718b18d16f4b515a7bf5c9119865e0cc024aa993", "message": "Remove @LAZY\n\nRemove unnecessary Map @Bean.\n\nAdd explicit @Bean name", "committedDate": "2020-02-17T12:19:17Z", "type": "commit"}, {"oid": "2fb682382b7461e69100fb4c6f96706878c1f07f", "url": "https://github.com/prebid/prebid-server-java/commit/2fb682382b7461e69100fb4c6f96706878c1f07f", "message": "Merge branch 'master' into admin-endpoints-open\n\n# Conflicts:\n#\tdocs/config-app.md\n#\tsrc/main/java/org/prebid/server/spring/config/WebConfiguration.java\n#\tsrc/test/java/org/prebid/server/it/ApplicationTest.java", "committedDate": "2020-05-08T12:09:00Z", "type": "commit"}, {"oid": "7f2fb9f10254125c5d1e73109cae964587864964", "url": "https://github.com/prebid/prebid-server-java/commit/7f2fb9f10254125c5d1e73109cae964587864964", "message": "Merge branch 'master' into admin-endpoints-open\n\n# Conflicts:\n#\tdocs/pbs-java-and-go-features-review.md", "committedDate": "2020-08-06T13:36:55Z", "type": "commit"}, {"oid": "d6a13648fcbb5a3418bb17ff906689c2d2a8e0c0", "url": "https://github.com/prebid/prebid-server-java/commit/d6a13648fcbb5a3418bb17ff906689c2d2a8e0c0", "message": "Fix geolocation spring configuration (#848)", "committedDate": "2020-08-10T11:33:47Z", "type": "commit"}, {"oid": "96a313824cd20b6fbb3b7b5beae3db54b801926d", "url": "https://github.com/prebid/prebid-server-java/commit/96a313824cd20b6fbb3b7b5beae3db54b801926d", "message": "Fixes after review", "committedDate": "2020-08-10T14:09:26Z", "type": "commit"}]}