{"pr_number": 635, "pr_title": "Add timestamp and biddercode to event URL", "pr_createdAt": "2020-03-11T16:24:55Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/635", "timeline": [{"oid": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "url": "https://github.com/prebid/prebid-server-java/commit/4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "message": "Add timestamp and biddercode to event URL", "committedDate": "2020-03-11T16:21:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4MDEyMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393580123", "bodyText": "Check your code style settings.\nThis do not need to change.", "author": "DGarbar", "createdAt": "2020-03-17T10:30:05Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -1,5 +1,9 @@\n package org.prebid.server.auction;\n \n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.collections4.ListUtils;\n+import org.apache.commons.collections4.MapUtils;\n+import org.apache.commons.lang3.BooleanUtils;", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5NTQ3MA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393595470", "bodyText": "Change to Long and auctiontimestamp", "author": "DGarbar", "createdAt": "2020-03-17T10:58:03Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebid.java", "diffHunk": "@@ -55,6 +55,11 @@\n      */\n     List<ExtRequestPrebidSchain> schains;\n \n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.timestamp\n+     */\n+    long timestamp;", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5NjY4MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393596681", "bodyText": "prebid.getTimestamp()can be missing also.\nSo you need to create timestamp if timestamp value is null.", "author": "DGarbar", "createdAt": "2020-03-17T11:00:18Z", "path": "src/main/java/org/prebid/server/auction/ExchangeService.java", "diffHunk": "@@ -705,6 +707,15 @@ private static ExtRequestTargeting targeting(ExtBidRequest requestExt) {\n         return prebid != null ? prebid.getTargeting() : null;\n     }\n \n+    /**\n+     * Extracts {@link ExtRequestPrebid} from {@link ExtBidRequest} model.\n+     */\n+    private static long auctionTimestamp(ExtBidRequest requestExt) {\n+        final ExtRequestPrebid prebid = requestExt != null ? requestExt.getPrebid() : null;\n+        final long auctionTimestamp = prebid != null ? prebid.getTimestamp() : Instant.now().toEpochMilli();\n+        return auctionTimestamp;", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5NzQzMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393597433", "bodyText": "rename to auctionTimestamp", "author": "DGarbar", "createdAt": "2020-03-17T11:01:44Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -167,16 +167,17 @@ public String getCachedAssetURLTemplate() {\n      * The returned result will always have the number of elements equals putObjects list size.\n      */\n     public Future<BidCacheResponse> cachePutObjects(List<PutObject> putObjects, Set<String> biddersAllowingVastUpdate,\n-                                                    String accountId, Timeout timeout) {\n-        final List<PutObject> updatedPutObjects = updatePutObjects(putObjects, biddersAllowingVastUpdate, accountId);\n+                                                    String accountId, Timeout timeout, long timestamp) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5NzUwMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393597501", "bodyText": "rename to auctionTimestamp", "author": "DGarbar", "createdAt": "2020-03-17T11:01:54Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -167,16 +167,17 @@ public String getCachedAssetURLTemplate() {\n      * The returned result will always have the number of elements equals putObjects list size.\n      */\n     public Future<BidCacheResponse> cachePutObjects(List<PutObject> putObjects, Set<String> biddersAllowingVastUpdate,\n-                                                    String accountId, Timeout timeout) {\n-        final List<PutObject> updatedPutObjects = updatePutObjects(putObjects, biddersAllowingVastUpdate, accountId);\n+                                                    String accountId, Timeout timeout, long timestamp) {\n+        final List<PutObject> updatedPutObjects = updatePutObjects(putObjects, biddersAllowingVastUpdate,\n+                accountId, timestamp);\n         return makeRequest(BidCacheRequest.of(updatedPutObjects), updatedPutObjects.size(), timeout);\n     }\n \n     /**\n      * Modify VAST value in putObjects.\n      */\n     private List<PutObject> updatePutObjects(List<PutObject> putObjects, Set<String> biddersAllowingVastUpdate,\n-                                             String accountId) {\n+                                             String accountId, long timestamp) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5NzU3OA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393597578", "bodyText": "rename to auctionTimestamp", "author": "DGarbar", "createdAt": "2020-03-17T11:02:04Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -199,7 +201,8 @@ public String getCachedAssetURLTemplate() {\n      * Makes cache for OpenRTB {@link com.iab.openrtb.response.Bid}s.\n      */\n     public Future<CacheServiceResult> cacheBidsOpenrtb(List<com.iab.openrtb.response.Bid> bids, List<Imp> imps,\n-                                                       CacheContext cacheContext, Account account, Timeout timeout) {\n+                                                       CacheContext cacheContext, Account account, Timeout timeout,\n+                                                       long timestamp) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5ODE2NA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393598164", "bodyText": "do not change style.\nprivate Future<CacheServiceResult> doCacheOpenrtb(List<CacheBid> bids, List<CacheBid> videoBids,\n                                                      Map<String, List<String>> bidderToVideoBidIdsToModify,\n                                                      String accountId, Timeout timeout, long auctionTimestamp)", "author": "DGarbar", "createdAt": "2020-03-17T11:03:12Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -298,11 +301,13 @@ private CacheBid toCacheBid(com.iab.openrtb.response.Bid bid, Map<String, Intege\n      * The returned result will always have the number of elements equals to sum of sizes of bids and video bids.\n      */\n     private Future<CacheServiceResult> doCacheOpenrtb(\n-            List<CacheBid> bids, List<CacheBid> videoBids, List<String> videoBidIdsToModify, String accountId,\n-            Timeout timeout) {\n+            List<CacheBid> bids, List<CacheBid> videoBids,", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5ODY2OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393598669", "bodyText": "rename to auctionTimestamp", "author": "DGarbar", "createdAt": "2020-03-17T11:04:10Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -392,8 +397,9 @@ private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid) {\n     /**\n      * Makes XML type {@link PutObject} from {@link com.iab.openrtb.response.Bid}. Used for OpenRTB auction request.\n      */\n-    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid, List<String> videoBidIdsToModify,\n-                                                String accountId) {\n+    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid,\n+                                                Map<String, List<String>> bidderToVideoBidIdsToModify,\n+                                                String accountId, long timestamp) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU5OTgwMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393599801", "bodyText": "I like usage of And word when we are working with Entry. nice", "author": "DGarbar", "createdAt": "2020-03-17T11:06:27Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -407,8 +413,11 @@ private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid, List<String> vide\n         }\n \n         final String bidId = bid.getId();\n-        if (CollectionUtils.isNotEmpty(videoBidIdsToModify) && videoBidIdsToModify.contains(bidId)) {\n-            vastXml = modifyVastXml(vastXml, bidId, accountId);\n+        for (Map.Entry<String, List<String>> biddersAndBidIds : bidderToVideoBidIdsToModify.entrySet()) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYwMjc4Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393602786", "bodyText": "final String vastUrlTracking = eventsService.vastUrlTracking(bidId, bidder, accountId, timestamp);\n    final String impressionUrl = \"<![CDATA[\" + vastUrlTracking + \"]]>\";", "author": "DGarbar", "createdAt": "2020-03-17T11:12:12Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -427,7 +436,8 @@ private String modifyVastXml(String stringValue, String bidId, String accountId)\n             return stringValue;\n         }\n \n-        final String impressionUrl = \"<![CDATA[\" + eventsService.vastUrlTracking(bidId, accountId) + \"]]>\";\n+        final String impressionUrl = \"<![CDATA[\" + eventsService.vastUrlTracking(bidId, bidder,", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYwNDIwMg==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393604202", "bodyText": "I am not sure if it good idea to use primitives.", "author": "DGarbar", "createdAt": "2020-03-17T11:15:03Z", "path": "src/main/java/org/prebid/server/events/EventRequest.java", "diffHunk": "@@ -14,12 +14,17 @@\n \n     String bidId;\n \n+    String bidder;\n+\n     String accountId;\n \n     Format format;\n \n     Analytics analytics;\n \n+    // According to requirements can not be null\n+    long timestamp;", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4NzA5OA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393687098", "bodyText": "Why this method is never used ?", "author": "DGarbar", "createdAt": "2020-03-17T13:41:49Z", "path": "src/main/java/org/prebid/server/events/EventUtil.java", "diffHunk": "@@ -50,6 +52,14 @@ public static void validateBidId(RoutingContext context) {\n         }\n     }\n \n+    public static void validateBiddder(RoutingContext context) {", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcwMjE4OA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393702188", "bodyText": "Dot you need to update TEMPLATE_URL to use ts and bidder parameters?\nAnd toUrl method", "author": "DGarbar", "createdAt": "2020-03-17T14:03:47Z", "path": "src/main/java/org/prebid/server/events/EventUtil.java", "diffHunk": "@@ -18,6 +19,7 @@\n     private static final String IMP_TYPE = \"imp\";\n \n     private static final String BID_ID_PARAMETER = \"b\";\n+    private static final String BIDDER_PARAMETER = \"bidder\";", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcwNjY3MA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393706670", "bodyText": "Are you sure, you do not get it from url as eventTimeMillis ?", "author": "DGarbar", "createdAt": "2020-03-17T14:10:08Z", "path": "src/main/java/org/prebid/server/events/EventUtil.java", "diffHunk": "@@ -93,9 +103,11 @@ public static EventRequest from(RoutingContext context) {\n         return EventRequest.builder()\n                 .type(type)\n                 .bidId(queryParams.get(BID_ID_PARAMETER))\n+                .bidder(queryParams.get(BIDDER_PARAMETER))\n                 .accountId(queryParams.get(ACCOUNT_ID_PARAMETER))\n                 .format(format)\n                 .analytics(analytics)\n+                .timestamp(Instant.now().toEpochMilli())", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcwODE0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393708146", "bodyText": "Do you really need to call EventUtill to get hardcoded value ?", "author": "DGarbar", "createdAt": "2020-03-17T14:12:12Z", "path": "src/main/java/org/prebid/server/handler/VtrackHandler.java", "diffHunk": "@@ -132,8 +134,9 @@ private void handleAccountResult(AsyncResult<Account> asyncAccount, RoutingConte\n             final Set<String> biddersAllowingVastUpdate = Objects.equals(asyncAccount.result().getEventsEnabled(), true)\n                     ? biddersAllowingVastUpdate(vtrackPuts)\n                     : Collections.emptySet();\n-\n-            cacheService.cachePutObjects(vtrackPuts, biddersAllowingVastUpdate, accountId, timeout)\n+            final EventRequest eventRequest = EventUtil.from(context);\n+            final long timestamp = eventRequest.getTimestamp();", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxMTE0NA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393711144", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-17T14:16:20Z", "path": "src/test/java/org/prebid/server/it/ApplicationTest.java", "diffHunk": "@@ -445,11 +445,13 @@ public void vtrackShouldReturnJsonWithUids() throws JSONException, IOException {\n                 .when()\n                 .body(jsonFrom(\"vtrack/test-vtrack-request.json\"))\n                 .queryParam(\"a\", \"14062\")\n+                .queryParam(\"t\", \"win\")\n                 .post(\"/vtrack\");\n \n         // then\n+        String actualStr = response.asString();", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxMjY0Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393712642", "bodyText": "why do you need this value ?", "author": "DGarbar", "createdAt": "2020-03-17T14:18:19Z", "path": "src/test/java/org/prebid/server/it/ApplicationTest.java", "diffHunk": "@@ -445,11 +445,13 @@ public void vtrackShouldReturnJsonWithUids() throws JSONException, IOException {\n                 .when()\n                 .body(jsonFrom(\"vtrack/test-vtrack-request.json\"))\n                 .queryParam(\"a\", \"14062\")\n+                .queryParam(\"t\", \"win\")", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxMzA3MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393713071", "bodyText": "you can just add L at the end", "author": "DGarbar", "createdAt": "2020-03-17T14:18:52Z", "path": "src/test/java/org/prebid/server/handler/openrtb2/AmpHandlerTest.java", "diffHunk": "@@ -440,15 +440,15 @@ public void shouldRespondWithDebugInfoIncludedIfExtPrebidDebugIsOn() {\n         given(exchangeService.holdAuction(any()))\n                 .willReturn(givenBidResponseWithExt(mapper.valueToTree(\n                         ExtBidResponse.of(ExtResponseDebug.of(null, auctionContext.getBidRequest()), null, null, null,\n-                                null))));\n+                                null, (long )1000))));", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNDM5MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393714391", "bodyText": "this also should include ts and bidder parameters", "author": "DGarbar", "createdAt": "2020-03-17T14:20:40Z", "path": "src/test/java/org/prebid/server/handler/VtrackHandlerTest.java", "diffHunk": "@@ -312,16 +338,20 @@ public void shouldSendToCacheExpectedPutsAndUpdatableUnknownBiddersWhenUnknownBi\n \n         given(applicationSettings.getAccountById(any(), any()))\n                 .willReturn(Future.succeededFuture(Account.builder().eventsEnabled(true).build()));\n-        given(cacheService.cachePutObjects(any(), any(), any(), any()))\n+        given(cacheService.cachePutObjects(any(), any(), any(), any(), anyLong()))\n                 .willReturn(Future.succeededFuture(BidCacheResponse.of(\n                         asList(CacheObject.of(\"uuid1\"), CacheObject.of(\"uuid2\")))));\n+        given(httpRequest.params()).willReturn(MultiMap.caseInsensitiveMultiMap()\n+                .add(\"t\", \"win\")\n+                .add(\"b\", \"bidId\")\n+                .add(\"a\", \"accountId\"));", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNTc1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393715756", "bodyText": "where ts and bidder parameter", "author": "DGarbar", "createdAt": "2020-03-17T14:22:30Z", "path": "src/test/java/org/prebid/server/events/EventsServiceTest.java", "diffHunk": "@@ -35,7 +35,7 @@ public void createEventsShouldReturnExpectedEvent() {\n     @Test\n     public void winUrlTargetingShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.winUrlTargeting(\"accountId\");\n+        final String winUrlTargeting = eventsService.winUrlTargeting(\"bidder\", \"accountId\",1000);\n \n         // then\n         assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&f=i\");", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNTc5Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393715792", "bodyText": "where ts and bidder parameter", "author": "DGarbar", "createdAt": "2020-03-17T14:22:34Z", "path": "src/test/java/org/prebid/server/events/EventsServiceTest.java", "diffHunk": "@@ -44,7 +44,7 @@ public void winUrlTargetingShouldReturnExpectedUrl() {\n     @Test\n     public void vastUrlTrackingShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.vastUrlTracking(\"bidId\", \"accountId\");\n+        final String winUrlTargeting = eventsService.vastUrlTracking(\"bidId\", \"bidder\",\"accountId\", 1000);\n \n         // then\n         assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=imp&b=bidId&a=accountId&f=b\");", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNjQ1NA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393716454", "bodyText": "Flaky test.", "author": "DGarbar", "createdAt": "2020-03-17T14:23:21Z", "path": "src/test/java/org/prebid/server/events/EventUtilTest.java", "diffHunk": "@@ -175,14 +176,14 @@ public void fromShouldReturnExpectedEventRequest() {\n \n         // when\n         final EventRequest result = EventUtil.from(routingContext);\n-\n         // then\n         assertThat(result).isEqualTo(EventRequest.builder()\n                 .type(EventRequest.Type.win)\n                 .bidId(\"bidId\")\n                 .accountId(\"accountId\")\n                 .format(EventRequest.Format.image)\n                 .analytics(EventRequest.Analytics.disabled)\n+                .timestamp(Instant.now().toEpochMilli())", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNjUwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393716508", "bodyText": "Flaky test.", "author": "DGarbar", "createdAt": "2020-03-17T14:23:24Z", "path": "src/test/java/org/prebid/server/events/EventUtilTest.java", "diffHunk": "@@ -204,6 +205,7 @@ public void fromShouldReturnExpectedEventRequestWithDefaultFormatAndAnalytics()\n                 .accountId(\"accountId\")\n                 .format(EventRequest.Format.blank)\n                 .analytics(EventRequest.Analytics.enabled)\n+                .timestamp(Instant.now().toEpochMilli())", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDU3MA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393720570", "bodyText": "not any long but eq(0)", "author": "DGarbar", "createdAt": "2020-03-17T14:28:48Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -173,14 +174,14 @@ public void shouldRequestCacheServiceWithExpectedArguments() {\n         givenCacheServiceResult(singletonMap(bid1, CacheIdInfo.of(null, null)));\n \n         // when\n-        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, false);\n+        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, 1000, false);\n \n         // then\n         verify(cacheService).cacheBidsOpenrtb(\n                 argThat(t -> t.containsAll(asList(bid1, bid4, bid3, bid2))), eq(emptyList()),\n                 eq(CacheContext.builder().shouldCacheBids(true).shouldCacheVideoBids(true).cacheBidsTtl(99)\n-                        .cacheVideoBidsTtl(101).videoBidIdsToModify(emptyList()).build()),\n-                eq(Account.builder().id(\"accountId\").build()), eq(timeout));\n+                        .cacheVideoBidsTtl(101).bidderToVideoBidIdsToModify(emptyMap()).build()),\n+                eq(Account.builder().id(\"accountId\").build()), eq(timeout), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDc5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393720793", "bodyText": "not any long but eq()", "author": "DGarbar", "createdAt": "2020-03-17T14:29:02Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -206,13 +207,13 @@ public void shouldRequestCacheServiceWithWinningBidsOnlyWhenWinningonlyIsTrue()\n         givenCacheServiceResult(singletonMap(bid1, CacheIdInfo.of(null, null)));\n \n         // when\n-        bidResponseCreator.create(bidderResponses, bidRequest, targeting, cacheInfo, ACCOUNT, timeout, false);\n+        bidResponseCreator.create(bidderResponses, bidRequest, targeting, cacheInfo, ACCOUNT, timeout, 1000, false);\n \n         // then\n         verify(cacheService).cacheBidsOpenrtb(\n                 argThat(t -> t.containsAll(asList(bid1, bid2)) && t.size() == 2), eq(emptyList()),\n-                eq(CacheContext.builder().videoBidIdsToModify(emptyList()).build()),\n-                eq(Account.builder().id(\"accountId\").build()), eq(timeout));\n+                eq(CacheContext.builder().bidderToVideoBidIdsToModify(emptyMap()).build()),\n+                eq(Account.builder().id(\"accountId\").build()), eq(timeout), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDk4OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393720989", "bodyText": "not any long but eq()", "author": "DGarbar", "createdAt": "2020-03-17T14:29:20Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -240,14 +241,14 @@ public void shouldRequestCacheServiceWithVideoBidsToModifyWhenEventsEnabledAndFo\n         given(bidderCatalog.isModifyingVastXmlAllowed(eq(\"bidder1\"))).willReturn(true);\n \n         // when\n-        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, account, timeout, false);\n+        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, account, timeout, 0, false);\n \n         // then\n         verify(cacheService).cacheBidsOpenrtb(\n                 argThat(t -> t.containsAll(asList(bid1, bid2))), eq(asList(imp1, imp2)),\n-                eq(CacheContext.builder().shouldCacheVideoBids(true).videoBidIdsToModify(singletonList(\"bidId1\"))\n+                eq(CacheContext.builder().shouldCacheVideoBids(true).bidderToVideoBidIdsToModify(singletonMap(\"bidder1\", singletonList(\"bidId1\")))\n                         .build()),\n-                same(account), eq(timeout));\n+                same(account), eq(timeout), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTAzNw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393721037", "bodyText": "not any long but eq()", "author": "DGarbar", "createdAt": "2020-03-17T14:29:24Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -264,13 +265,13 @@ public void shouldCallCacheServiceEvenRoundedCpmIsZero() {\n         givenCacheServiceResult(singletonMap(bid1, CacheIdInfo.of(null, null)));\n \n         // when\n-        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, false);\n+        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, 0, false);\n \n         // then\n         verify(cacheService).cacheBidsOpenrtb(\n                 argThat(bids -> bids.contains(bid1)), eq(emptyList()),\n-                eq(CacheContext.builder().videoBidIdsToModify(emptyList()).build()),\n-                eq(Account.builder().id(\"accountId\").build()), eq(timeout));\n+                eq(CacheContext.builder().bidderToVideoBidIdsToModify(emptyMap()).build()),\n+                eq(Account.builder().id(\"accountId\").build()), eq(timeout), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTM2OA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393721368", "bodyText": "Replace anyLong() to any() if you want to test method invocation", "author": "DGarbar", "createdAt": "2020-03-17T14:29:53Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -282,20 +283,20 @@ public void shouldSetExpectedConstantResponseFields() {\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n-                null, null, ACCOUNT, timeout, false).result();\n+                null, null, ACCOUNT, timeout, 1000,false).result();\n \n         // then\n         final BidResponse responseWithExpectedFields = BidResponse.builder()\n                 .id(\"123\")\n                 .cur(\"USD\")\n                 .ext(mapper.valueToTree(\n-                        ExtBidResponse.of(null, null, singletonMap(\"bidder1\", 100), 1000L, null)))\n+                        ExtBidResponse.of(null, null, singletonMap(\"bidder1\", 100), 1000L, null, (long)1000 )))\n                 .build();\n \n         assertThat(bidResponse)\n                 .isEqualToIgnoringGivenFields(responseWithExpectedFields, \"nbr\", \"seatbid\");\n \n-        verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n+        verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any(), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MjUxNw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399262517", "bodyText": "?", "author": "DGarbar", "createdAt": "2020-03-27T13:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMjgwMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393722803", "bodyText": "It should be passed in  response ext.prebid.auctiontimestamp", "author": "DGarbar", "createdAt": "2020-03-17T14:31:47Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/response/ExtBidResponse.java", "diffHunk": "@@ -37,4 +37,8 @@\n      */\n     Map<String, ExtResponseSyncData> usersync;\n \n+    /**\n+     * Defines the contract for bidresponse.ext.auctiontimestamp\n+     */\n+    Long timestamp;", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMjkwOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393722909", "bodyText": "not anyLong but eq(0).", "author": "DGarbar", "createdAt": "2020-03-17T14:31:56Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -140,10 +141,10 @@ public void shouldPassOriginalTimeoutToCacheServiceIfCachingIsRequested() {\n         givenCacheServiceResult(singletonMap(bid, CacheIdInfo.of(null, null)));\n \n         // when\n-        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, false);\n+        bidResponseCreator.create(bidderResponses, bidRequest, null, cacheInfo, ACCOUNT, timeout, 0, false);\n \n         // then\n-        verify(cacheService).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), same(timeout));\n+        verify(cacheService).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), same(timeout), anyLong());", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MTQ5Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399261497", "bodyText": "?", "author": "DGarbar", "createdAt": "2020-03-27T13:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMjkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyNjkwMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393726903", "bodyText": "L", "author": "DGarbar", "createdAt": "2020-03-17T14:37:16Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -1049,15 +1050,15 @@ public void impToStoredVideoJsonShouldAddErrorsWithPrebidBidderWhenStoredVideoRe\n \n         // when\n         final Future<BidResponse> result =\n-                bidResponseCreator.create(bidderResponses, bidRequest, null, CACHE_INFO, ACCOUNT, timeout, false);\n+                bidResponseCreator.create(bidderResponses, bidRequest, null, CACHE_INFO, ACCOUNT, timeout, 0, false);\n \n         // then\n         verify(storedRequestProcessor).videoStoredDataResult(eq(singletonList(imp1)), any(), eq(timeout));\n \n         assertThat(result.result().getExt()).isEqualTo(\n                 mapper.valueToTree(ExtBidResponse.of(null, singletonMap(\n                         \"prebid\", singletonList(ExtBidderError.of(BidderError.Type.generic.getCode(),\n-                                \"Bad timeout\"))), singletonMap(\"bidder1\", 100), 1000L, null)));\n+                                \"Bad timeout\"))), singletonMap(\"bidder1\", 100), 1000L, null, (long)0)));", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzczMjE1OA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r393732158", "bodyText": "Real logic implemented in EventUtil.toUrl(externalUrl, eventRequest);", "author": "DGarbar", "createdAt": "2020-03-17T14:44:40Z", "path": "src/main/java/org/prebid/server/events/EventsService.java", "diffHunk": "@@ -18,32 +18,36 @@ public EventsService(String externalUrl) {\n     /**\n      * Returns {@link Events} object based on given params.\n      */\n-    public Events createEvent(String bidId, String accountId) {\n+    public Events createEvent(String bidId, String bidder, String accountId, long timestamp) {\n         return Events.of(\n-                eventUrl(EventRequest.Type.win, bidId, accountId, EventRequest.Format.image),\n-                eventUrl(EventRequest.Type.imp, bidId, accountId, EventRequest.Format.image));\n+                eventUrl(EventRequest.Type.win, bidId, bidder, accountId, EventRequest.Format.image, timestamp),\n+                eventUrl(EventRequest.Type.imp, bidId, bidder, accountId, EventRequest.Format.image, timestamp));\n     }\n \n     /**\n      * Returns value for \"hb_winurl\" targeting keyword.\n      */\n-    public String winUrlTargeting(String accountId) {\n-        return eventUrl(EventRequest.Type.win, BIDID_PLACEHOLDER, accountId, EventRequest.Format.image);\n+    public String winUrlTargeting(String bidder, String accountId, long timestamp) {\n+        return eventUrl(EventRequest.Type.win, BIDID_PLACEHOLDER, bidder, accountId,\n+                EventRequest.Format.image, timestamp);\n     }\n \n     /**\n      * Returns url for VAST tracking.\n      */\n-    public String vastUrlTracking(String bidId, String accountId) {\n-        return eventUrl(EventRequest.Type.imp, bidId, accountId, EventRequest.Format.blank);\n+    public String vastUrlTracking(String bidId, String bidder, String accountId, long timestamp) {\n+        return eventUrl(EventRequest.Type.imp, bidId, bidder, accountId, EventRequest.Format.blank, timestamp);\n     }\n \n-    private String eventUrl(EventRequest.Type type, String bidId, String accountId, EventRequest.Format format) {\n+    private String eventUrl(EventRequest.Type type, String bidId, String bidder, String accountId,\n+                            EventRequest.Format format, long timestamp) {\n         final EventRequest eventRequest = EventRequest.builder()\n                 .type(type)\n                 .bidId(bidId)\n+                .bidder(bidder)", "originalCommit": "4fc16d245c3a0a5405c86f987c62e7b4b93ad685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "733dcfb22d5e65dc440047867247a8b2af883210", "url": "https://github.com/prebid/prebid-server-java/commit/733dcfb22d5e65dc440047867247a8b2af883210", "message": "Change to ExchangeService and tests", "committedDate": "2020-03-25T13:33:10Z", "type": "commit"}, {"oid": "deaedcd778ac352dcc743b6e31908a715e71fe17", "url": "https://github.com/prebid/prebid-server-java/commit/deaedcd778ac352dcc743b6e31908a715e71fe17", "message": "Prepare to merge", "committedDate": "2020-03-26T05:58:35Z", "type": "commit"}, {"oid": "66786a6cd808ee7be85f1cbf4de74ddce0f2f656", "url": "https://github.com/prebid/prebid-server-java/commit/66786a6cd808ee7be85f1cbf4de74ddce0f2f656", "message": "Timestamp and bidder code implement", "committedDate": "2020-03-26T11:04:24Z", "type": "commit"}, {"oid": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "url": "https://github.com/prebid/prebid-server-java/commit/76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "message": "Resolving conflicts and merge master to current branch", "committedDate": "2020-03-26T21:05:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0ODA2NA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399248064", "bodyText": "can be inlined", "author": "DGarbar", "createdAt": "2020-03-27T13:03:45Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -259,7 +263,8 @@ private static void tryAddWinningBidByBidder(Bid bid, String bidder,\n      */\n     private Future<CacheServiceResult> toBidsWithCacheIds(List<BidderResponse> bidderResponses, Set<Bid> bidsToCache,\n                                                           List<Imp> imps, BidRequestCacheInfo cacheInfo,\n-                                                          Account account, Timeout timeout) {\n+                                                          Account account, Timeout timeout,\n+                                                          Long auctionTimestamp) {", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MTMyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399251328", "bodyText": "final Events events = eventsEnabled \n                ? eventsService.createEvent(bid.getId(), bidder, account.getId(), auctionTimestamp) \n                : null;", "author": "DGarbar", "createdAt": "2020-03-27T13:09:18Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -639,7 +652,8 @@ private Bid toBid(BidderBid bidderBid, String bidder, ExtRequestTargeting target\n         }\n \n         final Video storedVideo = impIdToStoredVideo.get(bid.getImpid());\n-        final Events events = eventsEnabled ? eventsService.createEvent(bid.getId(), account.getId()) : null;\n+        final Events events = eventsEnabled ? eventsService.createEvent(bid.getId(), bidder, account.getId(),", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjEzMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399252133", "bodyText": "type Timestamp", "author": "DGarbar", "createdAt": "2020-03-27T13:10:46Z", "path": "src/main/java/org/prebid/server/auction/ExchangeService.java", "diffHunk": "@@ -705,6 +707,15 @@ private static ExtRequestTargeting targeting(ExtBidRequest requestExt) {\n         return prebid != null ? prebid.getTargeting() : null;\n     }\n \n+    /**\n+     * Extracts auctiontimestamp from {@link ExtBidRequest} model.\n+     */\n+    private static Long auctionTimestamp(ExtBidRequest requestExt) {\n+        final ExtRequestPrebid prebid = requestExt != null ? requestExt.getPrebid() : null;\n+        final Long auctionTmestamp = prebid != null ? prebid.getAuctiontimestamp() : null;", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjQ3NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399252475", "bodyText": "... or creates if is is null", "author": "DGarbar", "createdAt": "2020-03-27T13:11:25Z", "path": "src/main/java/org/prebid/server/auction/ExchangeService.java", "diffHunk": "@@ -705,6 +707,15 @@ private static ExtRequestTargeting targeting(ExtBidRequest requestExt) {\n         return prebid != null ? prebid.getTargeting() : null;\n     }\n \n+    /**\n+     * Extracts auctiontimestamp from {@link ExtBidRequest} model.", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1Nzc1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399257756", "bodyText": "biddersToCacheBidIds.entrySet().stream()\n                .filter(biddersAndBidIds -> biddersAndBidIds.getValue().contains(bidId))\n                .findFirst()\n                .map(Map.Entry::getKey)\n                .ifPresent(bidder -> bidObjectNode.put(\"wurl\", eventsService.winUrl(bid.getId(), bidder, accountId,\n                        timestamp)));", "author": "DGarbar", "createdAt": "2020-03-27T13:19:52Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -383,10 +389,18 @@ private static PutObject createPutObjectVideoOnly(Bid bid) {\n      * Makes JSON type {@link PutObject} from {@link com.iab.openrtb.response.Bid}.\n      * Used for OpenRTB auction request. Also, adds win url to result object.\n      */\n-    private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, String accountId) {\n+    private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, Map<String, List<String>> biddersToCacheBidIds,\n+                                                 String accountId, Long timestamp) {\n         final com.iab.openrtb.response.Bid bid = cacheBid.getBid();\n+        final String bidId = bid.getId();\n         final ObjectNode bidObjectNode = mapper.mapper().valueToTree(bid);\n-        bidObjectNode.put(\"wurl\", eventsService.winUrl(bid.getId(), accountId));\n+        for (Map.Entry<String, List<String>> biddersAndBidIds : biddersToCacheBidIds.entrySet()) {\n+            if (biddersAndBidIds.getValue().contains(bidId)) {\n+                bidObjectNode.put(\"wurl\", eventsService.winUrl(bid.getId(), biddersAndBidIds.getKey(), accountId,\n+                        timestamp));\n+                break;\n+            }\n+        }", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1OTAwMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399259001", "bodyText": "Above example with stream", "author": "DGarbar", "createdAt": "2020-03-27T13:22:01Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -413,8 +428,11 @@ private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid, List<String> vide\n         }\n \n         final String bidId = bid.getId();\n-        if (CollectionUtils.isNotEmpty(videoBidIdsToModify) && videoBidIdsToModify.contains(bidId)) {\n-            vastXml = modifyVastXml(vastXml, bidId, accountId);\n+        for (Map.Entry<String, List<String>> biddersAndBidIds : bidderToVideoBidIdsToModify.entrySet()) {\n+            if (biddersAndBidIds.getValue().contains(bidId)) {\n+                vastXml = modifyVastXml(vastXml, bidId, biddersAndBidIds.getKey(), accountId, timestamp);\n+                break;\n+            }", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MTEyMA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399261120", "bodyText": "The /vasttrack endpoint should support a 'timestamp' parameter, adding it to the video imp url as the 'ts' parameter", "author": "DGarbar", "createdAt": "2020-03-27T13:25:21Z", "path": "src/main/java/org/prebid/server/handler/VtrackHandler.java", "diffHunk": "@@ -35,6 +35,7 @@\n     private static final Logger logger = LoggerFactory.getLogger(VtrackHandler.class);\n \n     private static final String ACCOUNT_PARAMETER = \"a\";\n+    private static final String TIMESTAMP_PARAMETER = \"ts\";", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MjU5Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399262597", "bodyText": "L", "author": "DGarbar", "createdAt": "2020-03-27T13:27:41Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -282,20 +309,20 @@ public void shouldSetExpectedConstantResponseFields() {\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n-                null, null, ACCOUNT, timeout, false).result();\n+                null, null, ACCOUNT, timeout, 1000,false).result();\n \n         // then\n         final BidResponse responseWithExpectedFields = BidResponse.builder()\n                 .id(\"123\")\n                 .cur(\"USD\")\n                 .ext(mapper.valueToTree(\n-                        ExtBidResponse.of(null, null, singletonMap(\"bidder1\", 100), 1000L, null)))\n+                        ExtBidResponse.of(null, null, singletonMap(\"bidder1\", 100), 1000L, null, (long)1000 )))", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NjgyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401576828", "bodyText": "? 1000L", "author": "DGarbar", "createdAt": "2020-04-01T12:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MjU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MjY3NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399262675", "bodyText": "Check style", "author": "DGarbar", "createdAt": "2020-03-27T13:27:47Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -282,20 +309,20 @@ public void shouldSetExpectedConstantResponseFields() {\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n-                null, null, ACCOUNT, timeout, false).result();\n+                null, null, ACCOUNT, timeout, 1000,false).result();", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NjcwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401576708", "bodyText": "?\n(don't you see that there are space missing ?)", "author": "DGarbar", "createdAt": "2020-04-01T12:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2MjY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2NTIzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399265230", "bodyText": "Replace anyLong() to any() if you want to test method invocation. And please, fix it in others tests", "author": "DGarbar", "createdAt": "2020-03-27T13:31:24Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -305,13 +332,13 @@ public void shouldSetNbrValueTwoAndEmptySeatbidWhenIncomingBidResponsesAreEmpty(\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(emptyList(), bidRequest, null,\n-                null, ACCOUNT, timeout, false).result();\n+                null, ACCOUNT, timeout,0, false).result();\n \n         // then\n         assertThat(bidResponse).returns(0, BidResponse::getNbr);\n         assertThat(bidResponse).returns(emptyList(), BidResponse::getSeatbid);\n \n-        verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n+        verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any(), anyLong());", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5MjY1MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399292651", "bodyText": "please check ALL (long)0 occurrences and change it to 0L", "author": "DGarbar", "createdAt": "2020-03-27T14:11:57Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -693,14 +720,14 @@ public void shouldPopulateTargetingKeywordsWithEventsUrl() {\n \n         final Account account = Account.builder().id(\"accountId\").eventsEnabled(true).build();\n \n-        given(eventsService.winUrlTargeting(anyString())).willReturn(\"http://win-url\");\n+        given(eventsService.winUrlTargeting(anyString(), anyString(), anyLong())).willReturn(\"http://win-url\");\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n-                targeting, CACHE_INFO, account, timeout, false).result();\n+                targeting, CACHE_INFO, account, timeout, 0,false).result();\n \n         // then\n-        verify(eventsService).winUrlTargeting(eq(\"accountId\"));\n+        verify(eventsService).winUrlTargeting(eq(\"bidder1\"), eq(\"accountId\"), eq((long)0));", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5NDI1Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399294257", "bodyText": "If you are using '/n' for first parameter, keep this style for the next.\nFIX for others", "author": "DGarbar", "createdAt": "2020-03-27T14:14:08Z", "path": "src/test/java/org/prebid/server/cache/CacheServiceTest.java", "diffHunk": "@@ -351,7 +352,10 @@ public void cacheBidsOpenrtbShouldNeverCallCacheServiceIfNoBidsPassed() {\n     public void cacheBidsOpenrtbShouldPerformHttpRequestWithExpectedTimeout() {\n         // when\n         cacheService.cacheBidsOpenrtb(singletonList(givenBidOpenrtb(identity())), singletonList(givenImp(identity())),\n-                CacheContext.builder().shouldCacheBids(true).build(), account, timeout);\n+                CacheContext.builder()\n+                        .shouldCacheBids(true)", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5NDQyNw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399294427", "bodyText": "duplication", "author": "DGarbar", "createdAt": "2020-03-27T14:14:23Z", "path": "src/test/java/org/prebid/server/cache/CacheServiceTest.java", "diffHunk": "@@ -362,7 +366,10 @@ public void cacheBidsOpenrtbShouldTolerateGlobalTimeoutAlreadyExpired() {\n         // when\n         final Future<CacheServiceResult> future = cacheService.cacheBidsOpenrtb(\n                 singletonList(givenBidOpenrtb(identity())), singletonList(givenImp(identity())),\n-                CacheContext.builder().shouldCacheBids(true).build(), account, expiredTimeout);\n+                CacheContext.builder()\n+                        .shouldCacheBids(true)\n+                        .shouldCacheBids(true).biddersToCacheBidIds(singletonMap(\"bidder\", singletonList(\"bidId1\"))).build(),", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5NTcxNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399295715", "bodyText": "inline", "author": "DGarbar", "createdAt": "2020-03-27T14:16:14Z", "path": "src/test/java/org/prebid/server/events/EventUtilTest.java", "diffHunk": "@@ -171,11 +198,11 @@ public void fromShouldReturnExpectedEventRequest() {\n                 .add(\"b\", \"bidId\")\n                 .add(\"a\", \"accountId\")\n                 .add(\"f\", \"i\")\n-                .add(\"x\", \"0\"));\n+                .add(\"x\", \"0\")\n+        );", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5ODIxOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399298218", "bodyText": "where this test?", "author": "DGarbar", "createdAt": "2020-03-27T14:19:58Z", "path": "src/test/java/org/prebid/server/events/EventsServiceTest.java", "diffHunk": "@@ -24,29 +25,29 @@ public void setUp() {\n     @Test\n     public void createEventsShouldReturnExpectedEvent() {\n         // when\n-        final Events events = eventsService.createEvent(\"bidId\", \"accountId\");\n+        final Events events = eventsService.createEvent(\"bidId\", \"bidder\",\"accountId\", 1000L);\n \n         // then\n         assertThat(events).isEqualTo(Events.of(\n-                \"http://external-url/event?t=win&b=bidId&a=accountId&f=i\",\n-                \"http://external-url/event?t=imp&b=bidId&a=accountId&f=i\"));\n+                \"http://external-url/event?t=win&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\",\n+                \"http://external-url/event?t=imp&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\"));\n     }\n \n     @Test\n     public void winUrlTargetingShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.winUrlTargeting(\"accountId\");\n+        final String winUrlTargeting = eventsService.winUrlTargeting(\"bidder\", \"accountId\",1000L);\n \n         // then\n-        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&f=i\");\n+        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&ts=1000&bidder=bidder&f=i\");\n     }\n \n     @Test\n-    public void vastUrlTrackingShouldReturnExpectedUrl() {", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU4NTUzNg==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401585536", "bodyText": "Where test that calls eventsService.vastUrlTracking()?", "author": "DGarbar", "createdAt": "2020-04-01T12:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5ODIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5ODQyNw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r399298427", "bodyText": "duplication", "author": "DGarbar", "createdAt": "2020-03-27T14:20:17Z", "path": "src/test/java/org/prebid/server/events/EventsServiceTest.java", "diffHunk": "@@ -24,29 +25,29 @@ public void setUp() {\n     @Test\n     public void createEventsShouldReturnExpectedEvent() {\n         // when\n-        final Events events = eventsService.createEvent(\"bidId\", \"accountId\");\n+        final Events events = eventsService.createEvent(\"bidId\", \"bidder\",\"accountId\", 1000L);\n \n         // then\n         assertThat(events).isEqualTo(Events.of(\n-                \"http://external-url/event?t=win&b=bidId&a=accountId&f=i\",\n-                \"http://external-url/event?t=imp&b=bidId&a=accountId&f=i\"));\n+                \"http://external-url/event?t=win&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\",\n+                \"http://external-url/event?t=imp&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\"));\n     }\n \n     @Test\n     public void winUrlTargetingShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.winUrlTargeting(\"accountId\");\n+        final String winUrlTargeting = eventsService.winUrlTargeting(\"bidder\", \"accountId\",1000L);\n \n         // then\n-        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&f=i\");\n+        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&ts=1000&bidder=bidder&f=i\");\n     }\n \n     @Test\n-    public void vastUrlTrackingShouldReturnExpectedUrl() {\n+    public void winUrlTrackingShouldReturnExpectedUrl() {", "originalCommit": "76da6d8d68fbd47b4e65149d15f0eb8a591dd09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "url": "https://github.com/prebid/prebid-server-java/commit/adb6cfb2df8ccdc2ef844a5442af306704241a4e", "message": "Small refactoring after review", "committedDate": "2020-03-30T14:11:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3MjIwMw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401572203", "bodyText": "Array is redundant.\nAnd final is not needed (my mistake)", "author": "DGarbar", "createdAt": "2020-04-01T12:21:31Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -398,33 +411,38 @@ private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, String accountId\n     /**\n      * Makes XML type {@link PutObject} from {@link com.iab.openrtb.response.Bid}. Used for OpenRTB auction request.\n      */\n-    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid, List<String> videoBidIdsToModify,\n-                                                String accountId) {\n+    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid,\n+                                                Map<String, List<String>> bidderToVideoBidIdsToModify,\n+                                                String accountId, Long timestamp) {\n         final com.iab.openrtb.response.Bid bid = cacheBid.getBid();\n-        String vastXml;\n+        final String[] vastXml = new String[1];", "originalCommit": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NDk3Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401574973", "bodyText": "final String bidId = bid.getId();\n        final String modifiedVastXml =  bidderToVideoBidIdsToModify.entrySet().stream()\n                .filter(biddersAndBidIds -> biddersAndBidIds.getValue().contains(bidId))\n                .findFirst()\n                .map(Map.Entry::getKey)\n                .map(bidder -> modifyVastXml(vastXml, bidId, bidder, accountId, timestamp))\n                .orElse(vastXml);\n\n        return PutObject.builder()\n                .type(\"xml\")\n                .value(new TextNode(modifiedVastXml))\n                .expiry(cacheBid.getTtl())\n                .build();", "author": "DGarbar", "createdAt": "2020-04-01T12:26:29Z", "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -398,33 +411,38 @@ private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, String accountId\n     /**\n      * Makes XML type {@link PutObject} from {@link com.iab.openrtb.response.Bid}. Used for OpenRTB auction request.\n      */\n-    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid, List<String> videoBidIdsToModify,\n-                                                String accountId) {\n+    private PutObject createXmlPutObjectOpenrtb(CacheBid cacheBid,\n+                                                Map<String, List<String>> bidderToVideoBidIdsToModify,\n+                                                String accountId, Long timestamp) {\n         final com.iab.openrtb.response.Bid bid = cacheBid.getBid();\n-        String vastXml;\n+        final String[] vastXml = new String[1];\n         if (bid.getAdm() == null) {\n-            vastXml = \"<VAST version=\\\"3.0\\\"><Ad><Wrapper>\"\n+            vastXml[0] = \"<VAST version=\\\"3.0\\\"><Ad><Wrapper>\"\n                     + \"<AdSystem>prebid.org wrapper</AdSystem>\"\n                     + \"<VASTAdTagURI><![CDATA[\" + bid.getNurl() + \"]]></VASTAdTagURI>\"\n                     + \"<Impression></Impression><Creatives></Creatives>\"\n                     + \"</Wrapper></Ad></VAST>\";\n         } else {\n-            vastXml = bid.getAdm();\n+            vastXml[0] = bid.getAdm();\n         }\n-\n         final String bidId = bid.getId();\n-        if (CollectionUtils.isNotEmpty(videoBidIdsToModify) && videoBidIdsToModify.contains(bidId)) {\n-            vastXml = modifyVastXml(vastXml, bidId, accountId);\n-        }\n+        bidderToVideoBidIdsToModify.entrySet().stream()\n+                .filter(biddersAndBidIds -> biddersAndBidIds.getValue().contains(bidId))\n+                .findFirst()\n+                .map(Map.Entry::getKey)\n+                .ifPresent(bidder -> {\n+                    vastXml[0] = modifyVastXml(vastXml[0], bidId, bidder, accountId, timestamp);\n+                });\n \n         return PutObject.builder()\n                 .type(\"xml\")\n-                .value(new TextNode(vastXml))\n+                .value(new TextNode(vastXml[0]))\n                 .expiry(cacheBid.getTtl())\n                 .build();\n     }", "originalCommit": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NjkzOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401576938", "bodyText": "check style", "author": "DGarbar", "createdAt": "2020-04-01T12:29:52Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -305,13 +332,13 @@ public void shouldSetNbrValueTwoAndEmptySeatbidWhenIncomingBidResponsesAreEmpty(\n \n         // when\n         final BidResponse bidResponse = bidResponseCreator.create(emptyList(), bidRequest, null,\n-                null, ACCOUNT, timeout, false).result();\n+                null, ACCOUNT, timeout,0, false).result();", "originalCommit": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NzYxOA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401577618", "bodyText": "/n", "author": "DGarbar", "createdAt": "2020-04-01T12:31:09Z", "path": "src/test/java/org/prebid/server/auction/ExchangeServiceTest.java", "diffHunk": "@@ -797,7 +812,7 @@ public void shouldTolerateResponseBidValidationErrors() throws JsonProcessingExc\n                 // imp ids are not really used for matching, included them here for clarity\n                 givenImp(singletonMap(\"bidder1\", 1), builder -> builder.id(\"impId1\"))),\n                 builder -> builder.ext(mapper.valueToTree(ExtBidRequest.of(ExtRequestPrebid.builder()\n-                        .build()))));\n+                        .auctiontimestamp(1000L).build()))));", "originalCommit": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3Nzk0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r401577946", "bodyText": "check style", "author": "DGarbar", "createdAt": "2020-04-01T12:31:45Z", "path": "src/test/java/org/prebid/server/cache/CacheServiceTest.java", "diffHunk": "@@ -380,25 +391,34 @@ public void cacheBidsOpenrtbShouldStoreWinUrl() {\n         // when\n         cacheService.cacheBidsOpenrtb(\n                 singletonList(bid), singletonList(givenImp(builder -> builder.id(\"impId1\"))),\n-                CacheContext.builder().shouldCacheBids(true).build(), Account.builder().id(\"accountId\").build(),\n-                timeout);\n+                CacheContext\n+                        .builder()\n+                        .shouldCacheBids(true)\n+                        .biddersToCacheBidIds(singletonMap(\"bidder\", singletonList(\"bidId1\")))\n+                        .build(),\n+                Account.builder().id(\"accountId\").build(), timeout, 0L);\n \n         // then\n-        verify(eventsService).winUrl(eq(\"bidId1\"), eq(\"accountId\"));\n+        verify(eventsService).winUrl(eq(\"bidId1\"), eq(\"bidder\"),eq(\"accountId\"), eq(0L));", "originalCommit": "adb6cfb2df8ccdc2ef844a5442af306704241a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5701456bffb9836083acd577dd4b4640ad888961", "url": "https://github.com/prebid/prebid-server-java/commit/5701456bffb9836083acd577dd4b4640ad888961", "message": "Minor changes in tests", "committedDate": "2020-04-01T13:38:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2NTc4NA==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r402165784", "bodyText": "Intelij idea. Settings. Code Style -> Scheme = Project. If it doesn't help than\nClick to cogwheel -> import code scheme. From checkstyle file.\nPerform code style check formating for all files that you added", "author": "DGarbar", "createdAt": "2020-04-02T09:11:58Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -61,15 +69,6 @@\n import org.prebid.server.settings.model.Account;\n import org.prebid.server.settings.model.VideoStoredDataResult;\n \n-import java.io.IOException;\n-import java.math.BigDecimal;\n-import java.time.Clock;\n-import java.time.Instant;\n-import java.time.ZoneId;\n-import java.util.Arrays;\n-import java.util.List;\n-import java.util.Map;\n-", "originalCommit": "5701456bffb9836083acd577dd4b4640ad888961", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2Nzg0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r402167846", "bodyText": "ALWAYS", "author": "DGarbar", "createdAt": "2020-04-02T09:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2NTc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2NzA2OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/635#discussion_r402167069", "bodyText": "vastUrl Should Return Expected Url.\nWhere is vastUrl method call ?", "author": "DGarbar", "createdAt": "2020-04-02T09:14:08Z", "path": "src/test/java/org/prebid/server/events/EventsServiceTest.java", "diffHunk": "@@ -24,29 +24,38 @@ public void setUp() {\n     @Test\n     public void createEventsShouldReturnExpectedEvent() {\n         // when\n-        final Events events = eventsService.createEvent(\"bidId\", \"accountId\");\n+        final Events events = eventsService.createEvent(\"bidId\", \"bidder\", \"accountId\", 1000L);\n \n         // then\n         assertThat(events).isEqualTo(Events.of(\n-                \"http://external-url/event?t=win&b=bidId&a=accountId&f=i\",\n-                \"http://external-url/event?t=imp&b=bidId&a=accountId&f=i\"));\n+                \"http://external-url/event?t=win&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\",\n+                \"http://external-url/event?t=imp&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\"));\n     }\n \n     @Test\n     public void winUrlTargetingShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.winUrlTargeting(\"accountId\");\n+        final String winUrlTargeting = eventsService.winUrlTargeting(\"bidder\", \"accountId\", 1000L);\n \n         // then\n-        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&f=i\");\n+        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=win&b=BIDID&a=accountId&ts=1000&bidder=bidder&f=i\");\n     }\n \n     @Test\n-    public void vastUrlTrackingShouldReturnExpectedUrl() {\n+    public void winUrlShouldReturnExpectedUrl() {\n         // when\n-        final String winUrlTargeting = eventsService.vastUrlTracking(\"bidId\", \"accountId\");\n+        final String winUrl = eventsService.winUrl(\"bidId\", \"bidder\", \"accountId\", 1000L);\n \n         // then\n-        assertThat(winUrlTargeting).isEqualTo(\"http://external-url/event?t=imp&b=bidId&a=accountId&f=b\");\n+        assertThat(winUrl).isEqualTo(\"http://external-url/event?t=win&b=bidId&a=accountId&ts=1000&bidder=bidder&f=i\");\n+    }\n+\n+    @Test\n+    public void vastUrlShouldReturnExpectedUrl() {\n+        // when\n+        final String winUrl = eventsService.winUrl(\"bidId\", \"bidder\", \"accountId\", 1000L);", "originalCommit": "5701456bffb9836083acd577dd4b4640ad888961", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c5656d5a4b2feddcd01fc8657c201b3ddeb711f4", "url": "https://github.com/prebid/prebid-server-java/commit/c5656d5a4b2feddcd01fc8657c201b3ddeb711f4", "message": "Fix vastUrlTracking test", "committedDate": "2020-04-02T09:46:47Z", "type": "commit"}, {"oid": "f3c93625bfd6166905e6d3c1f66cb87246e645fc", "url": "https://github.com/prebid/prebid-server-java/commit/f3c93625bfd6166905e6d3c1f66cb87246e645fc", "message": "Fix checkstyle of code", "committedDate": "2020-04-02T10:18:18Z", "type": "commit"}, {"oid": "4f5410e2512a96174fa216ba3d0d9fcfe6143c26", "url": "https://github.com/prebid/prebid-server-java/commit/4f5410e2512a96174fa216ba3d0d9fcfe6143c26", "message": "Checkstyle update", "committedDate": "2020-04-02T13:35:07Z", "type": "commit"}, {"oid": "bf3464c43ef00000f6aaab79942df98c69e17f58", "url": "https://github.com/prebid/prebid-server-java/commit/bf3464c43ef00000f6aaab79942df98c69e17f58", "message": "Resolving conflicts", "committedDate": "2020-04-02T16:29:08Z", "type": "commit"}, {"oid": "37f20c2716204d44b1b4320a9330d4cf7a850c9b", "url": "https://github.com/prebid/prebid-server-java/commit/37f20c2716204d44b1b4320a9330d4cf7a850c9b", "message": "Add timestamp and biddercode to event URL - refactored (#653)", "committedDate": "2020-04-06T11:34:06Z", "type": "commit"}]}