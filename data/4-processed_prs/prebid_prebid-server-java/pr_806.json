{"pr_number": 806, "pr_title": "Create bidderconfing and imp.ext.context.data.attr in amp factory for\u2026", "pr_createdAt": "2020-07-13T09:27:05Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/806", "timeline": [{"oid": "e18647b57b401c0be3e509a372896c10ea294de4", "url": "https://github.com/prebid/prebid-server-java/commit/e18647b57b401c0be3e509a372896c10ea294de4", "message": "Create bidderconfing and imp.ext.context.data.attr in amp factory for fpd", "committedDate": "2020-07-13T09:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1ODE1MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453558151", "bodyText": "It would be more readable with guard condition of form:\nif(targeting == null) {\n    return extRequest;\n}\n\n...", "author": "schernysh", "createdAt": "2020-07-13T10:38:52Z", "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {", "originalCommit": "e18647b57b401c0be3e509a372896c10ea294de4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1OTk3Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453559976", "bodyText": "userNode and siteNode could be used instead of getters", "author": "schernysh", "createdAt": "2020-07-13T10:42:22Z", "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {\n+            final ExtRequestPrebid extRequestPrebid = extRequest != null ? extRequest.getPrebid() : null;\n+            final ExtRequestPrebidData extRequestPrebidData = extRequestPrebid != null\n+                    ? extRequestPrebid.getData()\n+                    : null;\n+\n+            final ExtRequestPrebidData resolvedExtRequestPrebidData = resolveExtRequestPrebidData(extRequestPrebidData,\n+                    targeting.getBidders());\n+            final List<ExtRequestPrebidBidderConfig> resolvedBidderConfig = createAllowedAllBidderConfig(targeting);\n+\n+            if (resolvedExtRequestPrebidData != null || resolvedBidderConfig != null) {\n+                final ExtRequestPrebid.ExtRequestPrebidBuilder prebidBuilder = extRequestPrebid != null\n+                        ? extRequestPrebid.toBuilder()\n+                        : ExtRequestPrebid.builder();\n+                return ExtRequest.of(prebidBuilder\n+                        .data(resolvedExtRequestPrebidData != null\n+                                ? resolvedExtRequestPrebidData\n+                                : extRequestPrebidData)\n+                        .bidderconfig(resolvedBidderConfig).build());\n+            }\n+        }\n+        return extRequest;\n+    }\n+\n+    private ExtRequestPrebidData resolveExtRequestPrebidData(ExtRequestPrebidData data, List<String> fpdBidders) {\n+        if (CollectionUtils.isEmpty(fpdBidders) && data == null) {\n+            return null;\n+        }\n+        final List<String> originBidders = data != null ? data.getBidders() : Collections.emptyList();\n+        return CollectionUtils.isEmpty(originBidders)\n+                ? ExtRequestPrebidData.of(fpdBidders)\n+                : ExtRequestPrebidData.of(mergeBidders(fpdBidders, originBidders));\n+    }\n+\n+    private List<ExtRequestPrebidBidderConfig> createAllowedAllBidderConfig(Targeting targeting) {\n+        final ObjectNode userNode = targeting.getUser();\n+        final ObjectNode siteNode = targeting.getSite();\n+        if (targeting.getUser() == null && targeting.getSite() == null) {", "originalCommit": "e18647b57b401c0be3e509a372896c10ea294de4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6", "url": "https://github.com/prebid/prebid-server-java/commit/7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6", "message": "Fix pull request comments", "committedDate": "2020-07-13T11:35:37Z", "type": "commit"}]}