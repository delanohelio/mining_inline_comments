{"pr_number": 273, "pr_title": "BLUEBUTTON-1864: Refactor medicare opt out module to support assumed writer role", "pr_createdAt": "2020-05-13T19:33:05Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273", "timeline": [{"oid": "4b167816a009cf0df2f51c47c8bb555dab31511b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4b167816a009cf0df2f51c47c8bb555dab31511b", "message": "Add AB2D root ARN due to greenfield", "committedDate": "2020-05-04T21:50:40Z", "type": "commit"}, {"oid": "b432b87007e50ef37662332d21a6e8ae6472d151", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b432b87007e50ef37662332d21a6e8ae6472d151", "message": "Make bucket policy statements apply to root and objects", "committedDate": "2020-05-05T18:17:39Z", "type": "commit"}, {"oid": "b8fce0ceded7bd6b3488fdfa7ce958ac6551e903", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b8fce0ceded7bd6b3488fdfa7ce958ac6551e903", "message": "Add object versioning to policy", "committedDate": "2020-05-05T19:42:19Z", "type": "commit"}, {"oid": "a1774d736a8eaa4602e198b99bc24cc83eb1ad4c", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a1774d736a8eaa4602e198b99bc24cc83eb1ad4c", "message": "More inclusive permissions", "committedDate": "2020-05-12T18:33:34Z", "type": "commit"}, {"oid": "231c4114f9371c0b935fe3eb3b438e878f04b38a", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/231c4114f9371c0b935fe3eb3b438e878f04b38a", "message": "Add writer assume from external acct role and policy", "committedDate": "2020-05-13T14:19:23Z", "type": "commit"}, {"oid": "caaff2a7edd24db4100fe40b1f94b915b88dc094", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/caaff2a7edd24db4100fe40b1f94b915b88dc094", "message": "Revert \"Add AB2D root ARN due to greenfield\"\n\nThis reverts commit 4b167816a009cf0df2f51c47c8bb555dab31511b.", "committedDate": "2020-05-13T14:26:36Z", "type": "commit"}, {"oid": "18f16d1a7e6bcde93694a19a1db2e28b11c58291", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/18f16d1a7e6bcde93694a19a1db2e28b11c58291", "message": "Add headbucket perm", "committedDate": "2020-05-13T14:32:26Z", "type": "commit"}, {"oid": "ccbc61cec2285be1a491ab7bfb0be220f1819258", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/ccbc61cec2285be1a491ab7bfb0be220f1819258", "message": "Pass through write ext assume acct", "committedDate": "2020-05-13T14:39:00Z", "type": "commit"}, {"oid": "3841002c20d7e38787d00a9177fe27739b81b5cb", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3841002c20d7e38787d00a9177fe27739b81b5cb", "message": "Fix typo", "committedDate": "2020-05-13T14:40:26Z", "type": "commit"}, {"oid": "0fedb127af32044c31bc8ea9e24f030c42019434", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0fedb127af32044c31bc8ea9e24f030c42019434", "message": "HeadBucket must target *, add perms to write assume role", "committedDate": "2020-05-13T14:59:28Z", "type": "commit"}, {"oid": "1682f8678334be6a20f1f940b004f1a423775147", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1682f8678334be6a20f1f940b004f1a423775147", "message": "Fix policy syntax", "committedDate": "2020-05-13T15:04:35Z", "type": "commit"}, {"oid": "5886e0222b814f0b26566d7add849db63c6ace42", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5886e0222b814f0b26566d7add849db63c6ace42", "message": "Completely refactor S3 PII module to use jsonencode in templates to fix various validation issues", "committedDate": "2020-05-13T18:39:57Z", "type": "commit"}, {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/bff6f8061f75f5b9a793cd652a3355f328ca92cd", "message": "Fix formatting", "committedDate": "2020-05-13T18:54:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NDk2OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424684968", "bodyText": "Confirmed from BCDA perspective, these are no longer needed.", "author": "msnook", "createdAt": "2020-05-13T19:38:17Z", "path": "ops/terraform/env/prod-sbx/stateful/main.tf", "diffHunk": "@@ -51,7 +51,7 @@ module \"stateful\" {\n \n   medicare_opt_out_config = {\n     read_roles        = [\"arn:aws:iam::755619740999:role/dpc-dev-consent-execution-role\", \"arn:aws:iam::349849222861:role/Ab2dInstanceRole\", \"arn:aws:iam::777200079629:role/Ab2dInstanceRole\", \"arn:aws:iam::330810004472:role/Ab2dInstanceRole\"]\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-dev-nfs-instance\", \"arn:aws:iam::755619740999:role/bcda-test-nfs-instance\"]", "originalCommit": "bff6f8061f75f5b9a793cd652a3355f328ca92cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NTA5NQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424685095", "bodyText": "Confirmed from BCDA perspective, this is no longer needed.", "author": "msnook", "createdAt": "2020-05-13T19:38:32Z", "path": "ops/terraform/env/prod/stateful/main.tf", "diffHunk": "@@ -60,7 +60,7 @@ module \"stateful\" {\n   medicare_opt_out_config = {\n     # TODO: add read roles for DPC\n     read_roles        = []\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-prod-nfs-instance\"]", "originalCommit": "bff6f8061f75f5b9a793cd652a3355f328ca92cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA2NQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424701065", "bodyText": "Suggest that you could add s3:HeadBucket, and s3: GetBucketLocation to the actions list.", "author": "RickHawesUSDS", "createdAt": "2020-05-13T20:08:19Z", "path": "ops/terraform/modules/resources/s3_pii/templates/bucket-policy.json", "diffHunk": "@@ -1,62 +1,48 @@\n+${jsonencode(\n {\n   \"Version\": \"2012-10-17\",\n   \"Id\": \"bfd-${env}-${bucket_name}-s3-policy\",\n   \"Statement\": [\n-    {\n-      \"Sid\": \"BFDPIIS3ListBucket\",\n-      \"Effect\": \"Allow\",\n-      \"Principal\": {\n-        \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n-        ]\n-      },\n-      \"Action\": [\n-        \"s3:ListBucket\"\n-      ],\n-      \"Resource\": \"arn:aws:s3:::${bucket_id}\"\n-    },\n     {\n       \"Sid\": \"BFDPIIS3ReadBucket\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n+          for arn in concat(readers, writers) : \"${arn}\"\n         ]\n       },\n       \"Action\": [\n-        \"s3:GetObject\"\n+        \"s3:ListBucket*\",", "originalCommit": "bff6f8061f75f5b9a793cd652a3355f328ca92cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxODYxMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r425218613", "bodyText": "It appears s3:HeadBucket is not a valid operation for a specific S3 bucket, only for * so not valid within the context of the S3 policy.  The IAM writer policy already has s3:HeadBucket.  I have added s3:GetBucket* to the S3 policy to be more inclusive of read operations.", "author": "njdister", "createdAt": "2020-05-14T15:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA2NQ=="}], "type": "inlineReview"}, {"oid": "3e7aa9958bcfa0fe36e7e7d3df4139c0c440fba1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3e7aa9958bcfa0fe36e7e7d3df4139c0c440fba1", "message": "Add more bucket read operations to s3 policy", "committedDate": "2020-05-14T15:01:14Z", "type": "commit"}, {"oid": "d4241d1480ca1fdcee32596f4c6aaa32ba5e6ffe", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d4241d1480ca1fdcee32596f4c6aaa32ba5e6ffe", "message": "Head bucket not valid within S3 policy on specific bucket ARN", "committedDate": "2020-05-14T15:18:24Z", "type": "commit"}, {"oid": "d787750974c030852da30975858af3f1e7f0e36d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d787750974c030852da30975858af3f1e7f0e36d", "message": "Use Ricks account from BFD", "committedDate": "2020-05-14T16:53:31Z", "type": "commit"}]}