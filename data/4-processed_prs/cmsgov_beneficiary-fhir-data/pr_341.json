{"pr_number": 341, "pr_title": "Cbrune/Fix For IT Endpoint Diagnosis Type Order Failures", "pr_createdAt": "2020-08-19T07:04:53Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/341", "timeline": [{"oid": "4e7bf604dbd804a9984f85b90c24f7183fcd3718", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4e7bf604dbd804a9984f85b90c24f7183fcd3718", "message": "Switch GH Actions runner to macos", "committedDate": "2020-08-18T20:20:56Z", "type": "commit"}, {"oid": "54ef68c08a11972ef1db142781821f0588bd04fd", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/54ef68c08a11972ef1db142781821f0588bd04fd", "message": "Added serialization feature for keys", "committedDate": "2020-08-18T21:10:07Z", "type": "commit"}, {"oid": "3b5f8f49a8019b054dcef2aaca4b49d94580fa75", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3b5f8f49a8019b054dcef2aaca4b49d94580fa75", "message": "Added serialization feature for keys", "committedDate": "2020-08-18T21:14:13Z", "type": "commit"}, {"oid": "a96a31144178dcc38e5f9f59bbab3a9067620578", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a96a31144178dcc38e5f9f59bbab3a9067620578", "message": "Added compare to order diagnosis types", "committedDate": "2020-08-19T07:03:12Z", "type": "commit"}, {"oid": "9b66659e779b54dc56c8f087f6ab515b62cdd485", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9b66659e779b54dc56c8f087f6ab515b62cdd485", "message": "Changed and added comments", "committedDate": "2020-08-19T15:59:05Z", "type": "commit"}, {"oid": "eeddaa244047e659fe581c6c9dcafed3fdf8b270", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/eeddaa244047e659fe581c6c9dcafed3fdf8b270", "message": "Added comments to the fix", "committedDate": "2020-08-19T16:06:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MDM0MA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/341#discussion_r474980340", "bodyText": "Just an FYI that using APIs from recent versions of Java, you can make this stuff cleaner: https://www.baeldung.com/java-8-comparator-comparing#1-key-selector-variant", "author": "karlmdavis", "createdAt": "2020-08-21T21:36:04Z", "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/utils/EndpointJsonResponseComparatorIT.java", "diffHunk": "@@ -297,6 +297,77 @@ public int compare(JsonNode node1, JsonNode node2) {\n     return jsonResponse;\n   }\n \n+  /**\n+   * FIXME: Additional workaround due to HAPI not always returning array elements in the same order\n+   * for a specific searchParam {@link JsonArray} in the capability statement. This method is only\n+   * necessary until the following issue has been resolved with HAPI:\n+   * https://github.com/jamesagnew/hapi-fhir/issues/1183\n+   *\n+   * <p>Before: { \"type\" : [ {\"coding\" : [ {\"system\" :\n+   * \"https://bluebutton.cms.gov/resources/codesystem/diagnosis-type\", \"code\" : \"principal\",\n+   * \"display\" : \"The single medical diagnosis that is most relevant to the patient's chief\n+   * complaint or need for treatment.\" ] }, {\"coding\" : [ {\"system\" :\n+   * \"https://bluebutton.cms.gov/resources/codesystem/diagnosis-type\", \"code\" :\n+   * \"external-first\",\"display\" : \"The code used to identify the 1st external cause of injury,\n+   * poisoning, or other adverse effect.\"} } ]} ]}\n+   *\n+   * <p>After: { \"type\" : [ {\"coding\" : [ {\"system\" :\n+   * \"https://bluebutton.cms.gov/resources/codesystem/diagnosis-type\", \"code\" :\n+   * \"external-first\",\"display\" : \"The code used to identify the 1st external cause of injury,\n+   * poisoning, or other adverse effect.\"} ] }, {\"coding\" : [ {\"system\" :\n+   * \"https://bluebutton.cms.gov/resources/codesystem/diagnosis-type\",\"code\" : \"principal\",\n+   * \"display\" : \"The single medical diagnosis that is most relevant to the patient's chief\n+   * complaint or need for treatment.\"} ]} ]}\n+   *\n+   * @param unsortedResponse the JSON string with an unsorted diagnosisType array\n+   * @param parseStringAt the JSON string with the search string\n+   * @return the JSON string with the sorted diagnosis type array\n+   */\n+  private static String sortDiagnosisTypes(String unsortedResponse, String parseStringAt) {\n+    ObjectMapper mapper = new ObjectMapper();\n+    mapper.writerWithDefaultPrettyPrinter();\n+    JsonNode parsedJson = null;\n+    try {\n+      parsedJson = mapper.readTree(unsortedResponse);\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\n+          \"Unable to deserialize the following JSON content as tree: \" + unsortedResponse, e);\n+    }\n+\n+    // This returns the DiagnosisType array node for the resource\n+    JsonNode diagnosisTypeArray = parsedJson.at(parseStringAt);\n+\n+    Iterator<JsonNode> diagnosisTypeArrayIterator = diagnosisTypeArray.elements();\n+    List<JsonNode> diagnosisTypes = new ArrayList<JsonNode>();\n+    while (diagnosisTypeArrayIterator.hasNext()) {\n+      diagnosisTypes.add(diagnosisTypeArrayIterator.next());\n+    }\n+\n+    Collections.sort(\n+        diagnosisTypes,\n+        new Comparator<JsonNode>() {\n+          public int compare(JsonNode node1, JsonNode node2) {\n+            String name1 = node1.get(\"coding\").get(0).get(\"code\").toString();\n+            String name2 = node2.get(\"coding\").get(0).get(\"code\").toString();\n+            return name1.compareTo(name2);\n+          }\n+        });", "originalCommit": "eeddaa244047e659fe581c6c9dcafed3fdf8b270", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}