{"pr_number": 210, "pr_title": "BLUEBUTTON-1281: Build MGMT TEST environment", "pr_createdAt": "2020-02-04T00:48:38Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210", "timeline": [{"oid": "9a4f60c1336c7b4d040e43b6036efba48b00a5c4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9a4f60c1336c7b4d040e43b6036efba48b00a5c4", "message": "Adding mgmt-test core files", "committedDate": "2020-02-04T00:12:10Z", "type": "commit"}, {"oid": "055e0c5eda0f6fe05a3216c0384a0adaa068ffa8", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/055e0c5eda0f6fe05a3216c0384a0adaa068ffa8", "message": "Adding vars file", "committedDate": "2020-02-04T00:12:44Z", "type": "commit"}, {"oid": "e33fdc607bca703ffe7132124ab5e1f59e1bc375", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e33fdc607bca703ffe7132124ab5e1f59e1bc375", "message": "Stateful backend", "committedDate": "2020-02-04T00:13:27Z", "type": "commit"}, {"oid": "9bb3723e2ab011086b9343b3b7f751bf7fe25b29", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9bb3723e2ab011086b9343b3b7f751bf7fe25b29", "message": "Stateful main for mgmt-test", "committedDate": "2020-02-04T00:14:01Z", "type": "commit"}, {"oid": "d43ae0748990910bea8ab8260482cff612c453e3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d43ae0748990910bea8ab8260482cff612c453e3", "message": "Stateless backend config", "committedDate": "2020-02-04T00:14:42Z", "type": "commit"}, {"oid": "fbf343783d3652e4eb6d78bbbac3e546550273c9", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/fbf343783d3652e4eb6d78bbbac3e546550273c9", "message": "Stateless main for mgmt-test", "committedDate": "2020-02-04T00:15:25Z", "type": "commit"}, {"oid": "b24d10566dbaabac5336e361d0fc40c7d74bff58", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b24d10566dbaabac5336e361d0fc40c7d74bff58", "message": "Updating mgmt_stateful module main tf", "committedDate": "2020-02-04T00:17:37Z", "type": "commit"}, {"oid": "64c471fac0ec341875828628de6421ae8e54fe4e", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/64c471fac0ec341875828628de6421ae8e54fe4e", "message": "Updating mgmt_stateful vars, add az", "committedDate": "2020-02-04T00:18:20Z", "type": "commit"}, {"oid": "90430e547f65bdb838c017cbc310e81a2bea1821", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/90430e547f65bdb838c017cbc310e81a2bea1821", "message": "Updating mgmt_stateless module with new layout", "committedDate": "2020-02-04T00:19:42Z", "type": "commit"}, {"oid": "4574fa3bcdd835de22c615a9c7afc0ffc9b062d9", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4574fa3bcdd835de22c615a9c7afc0ffc9b062d9", "message": "Updaitng stateless vars with public and az option", "committedDate": "2020-02-04T00:20:23Z", "type": "commit"}, {"oid": "68d939c80eb9413bca85871c486bc9eba4f5dd5d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/68d939c80eb9413bca85871c486bc9eba4f5dd5d", "message": "Adding generic user_data script for jenkins", "committedDate": "2020-02-04T00:36:22Z", "type": "commit"}, {"oid": "8e1f92b106c36dbb2031f403ffc57a5e9ac3728b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8e1f92b106c36dbb2031f403ffc57a5e9ac3728b", "message": "Updating Jenkins module", "committedDate": "2020-02-04T00:37:24Z", "type": "commit"}, {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f38c13832e54ec6c929044ecee8f0731c52c1516", "message": "Remove app_subnets var, use data to get vals.", "committedDate": "2020-02-04T01:06:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5NzE0OQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374797149", "bodyText": "For standardization across modules I would move the azs var outside of env_config.", "author": "njdister", "createdAt": "2020-02-04T16:57:09Z", "path": "ops/terraform/env/mgmt-test/stateful/main.tf", "diffHunk": "@@ -0,0 +1,18 @@\n+terraform {\n+  required_version = \"~> 0.12\"\n+}\n+\n+provider \"aws\" {\n+  version = \"~> 2.25\"\n+  region = \"us-east-1\"\n+}\n+\n+module \"stateful\" {\n+  source = \"../../../modules/mgmt_stateful\"\n+\n+  env_config = {\n+    env               = \"mgmt-test\"\n+    tags              = {application=\"bfd\", business=\"oeda\", stack=\"mgmt-test\", Environment=\"mgmt-test\"}\n+    azs               = \"us-east-1c\"", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwMDA1NA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375600054", "bodyText": "This is how other modules are set for our other environments. Leaving this as is for now.", "author": "jzulim", "createdAt": "2020-02-06T01:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5NzE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzODQ5OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374838498", "bodyText": "Is renaming this going to affect any other modules that use this policy?  Worth a sanity check.", "author": "njdister", "createdAt": "2020-02-04T18:15:48Z", "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -77,27 +75,19 @@ data \"aws_security_group\" \"management\" {\n #\n # Build a VPC private local zone for CNAME records\n #\n+\n resource \"aws_route53_zone\" \"local_zone\" {\n   name    = \"bfd-${var.env_config.env}.local\"\n   vpc {\n     vpc_id = data.aws_vpc.main.id\n   }\n }\n \n-# S3 Admin bucket for logs and other adminstrative \n-#\n-module \"admin\" {\n-  source              = \"../resources/s3\"\n-  role                = \"admin\"\n-  env_config          = local.env_config\n-  kms_key_id          = data.aws_kms_key.master_key.arn\n-  acl                 = \"log-delivery-write\"\n-}\n-\n # IAM policy to allow read access to ansible vault password\n #\n+\n resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n-  name        = \"bfd-ansible-vault-pw-ro-s3\"\n+  name        = \"bfd-${var.env_config.env}-ansible-vault-pw-ro-s3\"", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MTI3OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374851278", "bodyText": "Do you know if any of the packer roles/policies are actually used?  I suspect not unless we are doing something fancy in jenkins to sandbox packer (didn't appear so when I checked)", "author": "njdister", "createdAt": "2020-02-04T18:40:11Z", "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -121,33 +111,54 @@ resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n EOF\n }\n \n-# S3 bucket for Build Artifacts\n+# S3 Admin bucket for adminstrative stuff\n #\n-module \"artifacts\" {\n+\n+module \"admin\" { \n   source              = \"../resources/s3\"\n-  role                = \"artifacts\"\n+  role                = \"admin\"\n   env_config          = local.env_config\n   kms_key_id          = data.aws_kms_key.master_key.arn\n-  log_bucket          = module.admin.id\n+  log_bucket          = module.logs.id\n+}\n+\n+# S3 bucket for logs \n+#\n+\n+module \"logs\" { \n+  source              = \"../resources/s3\"\n+  role                = \"logs\"\n+  env_config          = local.env_config\n+  acl                 = \"log-delivery-write\"  # For AWS bucket logs\n+  kms_key_id          = null                  # Use AWS encryption to support AWS Agents writing to this bucket\n }\n \n-# EBS Volume for Jenkins Data\n+# EFS for Jenkins Data (JENKINS_HOME)\n+resource \"aws_efs_file_system\" \"foo\" {\n+  creation_token = \"bfd-${var.env_config.env}-jenkins-data\"\n+\n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-jenkins-data\"\n+  }\n+}\n \n resource \"aws_ebs_volume\" \"jenkins_data\" {\n-  availability_zone = data.aws_subnet.selected[0].availability_zone\n+  availability_zone = var.env_config.azs\n   size              = 1000\n   type              = \"gp2\"\n+  encrypted         = true\n+  kms_key_id        = data.aws_kms_key.master_key.arn\n \n   tags = {\n-    Name       = \"bfd-mgmt-jenkins-data-master\"\n+    Name       = \"bfd-${var.env_config.env}-jenkins-data\"\n     cpm_backup = \"4HR Daily Weekly Monthly\"\n   }\n }\n \n # IAM Roles, Profiles and Policies for Packer", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3MDY3Nw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374970677", "bodyText": "Good question, might be dead / unused. Will verify.", "author": "jzulim", "createdAt": "2020-02-04T22:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwMDE2Ng==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375600166", "bodyText": "I think the removal of this is out of scope. I will take a look at this when testing in mgmt-test and remove if needed.", "author": "jzulim", "createdAt": "2020-02-06T01:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MzU3Ng==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374853576", "bodyText": "This is a bit confusing having two AZ variables.  It would be good to standardize how we do this.", "author": "njdister", "createdAt": "2020-02-04T18:44:39Z", "path": "ops/terraform/modules/resources/jenkins/main.tf", "diffHunk": "@@ -1,4 +1,6 @@\n locals {\n+  azs         = [\"us-east-1a\"]\n+  env_config  = {env=var.env_config.env, tags=var.env_config.tags, azs=local.azs}", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzgxMQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375233811", "bodyText": "In the current version of stateless/main.tf there is a variable for vpn_security_group_id, was this intentionally left out?", "author": "cthulhuplus", "createdAt": "2020-02-05T12:45:02Z", "path": "ops/terraform/env/mgmt-test/stateless/main.tf", "diffHunk": "@@ -0,0 +1,22 @@\n+terraform {\n+  required_version = \"~> 0.12\"\n+}\n+\n+provider \"aws\" {\n+  version = \"~> 2.25\"\n+  region = \"us-east-1\"\n+}\n+\n+module \"stateless\" {\n+  source = \"../../../modules/mgmt_stateless\"\n+\n+  env_config = {\n+    env               = \"mgmt-test\"\n+    tags              = {application=\"bfd\", business=\"oeda\", stack=\"mgmt\", Environment=\"mgmt-test\"}\n+  }  \n+\n+  jenkins_ami            = var.jenkins_ami\n+  jenkins_key_name       = var.jenkins_key_name\n+  jenkins_instance_size  = var.jenkins_instance_size\n+  azs                    = var.azs", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwMDQ4Nw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375600487", "bodyText": "This was removed, we now use a 'data' call to gather this vpn security group via the following code in the mgm_stateless module:\ndata \"aws_security_group\" \"vpn\" {\n  filter {\n    name        = \"tag:Name\"\n    values      = [\"bfd-mgmt-vpn-private\"]\n  }\n}", "author": "jzulim", "createdAt": "2020-02-06T01:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNDUzNQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375234535", "bodyText": "Same as before, there is a missing declaration for vpn_security_group_id.", "author": "cthulhuplus", "createdAt": "2020-02-05T12:46:49Z", "path": "ops/terraform/env/mgmt-test/stateless/variables.tf", "diffHunk": "@@ -0,0 +1,20 @@\n+variable \"jenkins_ami\" {\n+  description       = \"Jenkins server AMI\"\n+  type              = string\n+}\n+\n+variable \"jenkins_key_name\" {\n+  description       = \"The EC2 key pair name to assign to jenkins instances\"\n+  type              = string\n+}\n+\n+variable \"jenkins_instance_size\" {\n+  type              = string\n+  description       = \"The EC2 instance size to use\"\n+  default           = \"c5.xlarge\"\n+}\n+\n+variable \"azs\" {\n+  description       = \"AZs to use\"\n+  type              = list", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwMDYyMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375600623", "bodyText": "Same as above.", "author": "jzulim", "createdAt": "2020-02-06T01:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNjU1OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375236558", "bodyText": "Maybe I'm being nit picky, but \"foo\" seems out of place in production code", "author": "cthulhuplus", "createdAt": "2020-02-05T12:51:39Z", "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -121,33 +111,54 @@ resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n EOF\n }\n \n-# S3 bucket for Build Artifacts\n+# S3 Admin bucket for adminstrative stuff\n #\n-module \"artifacts\" {\n+\n+module \"admin\" { \n   source              = \"../resources/s3\"\n-  role                = \"artifacts\"\n+  role                = \"admin\"\n   env_config          = local.env_config\n   kms_key_id          = data.aws_kms_key.master_key.arn\n-  log_bucket          = module.admin.id\n+  log_bucket          = module.logs.id\n+}\n+\n+# S3 bucket for logs \n+#\n+\n+module \"logs\" { \n+  source              = \"../resources/s3\"\n+  role                = \"logs\"\n+  env_config          = local.env_config\n+  acl                 = \"log-delivery-write\"  # For AWS bucket logs\n+  kms_key_id          = null                  # Use AWS encryption to support AWS Agents writing to this bucket\n }\n \n-# EBS Volume for Jenkins Data\n+# EFS for Jenkins Data (JENKINS_HOME)\n+resource \"aws_efs_file_system\" \"foo\" {", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNzQ5MQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375237491", "bodyText": "I feel like switching to hard coded values is a step backwards, if it is necessary to achieve a short term goal we should create a tech debt ticket to re-variable-ize in the future.", "author": "cthulhuplus", "createdAt": "2020-02-05T12:53:45Z", "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -5,16 +5,15 @@\n #\n \n locals {\n-  azs = [\"us-east-1a\", \"us-east-1b\", \"us-east-1c\"]\n-  env_config = {env=var.env_config.env, tags=var.env_config.tags, vpc_id=data.aws_vpc.main.id, zone_id=aws_route53_zone.local_zone.id }\n+  env_config = {env=var.env_config.env, tags=var.env_config.tags, vpc_id=data.aws_vpc.main.id, zone_id=aws_route53_zone.local_zone.id, azs=var.env_config.azs}\n }\n \n # VPC\n #\n data \"aws_vpc\" \"main\" {\n   filter {\n     name = \"tag:Name\"\n-    values = [\"bfd-${var.env_config.env}-vpc\"]\n+    values = [\"bfd-mgmt-vpc\"]", "originalCommit": "f38c13832e54ec6c929044ecee8f0731c52c1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwMDg5Mg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375600892", "bodyText": "It's only necessary for the shared services that mgmt and mgmt-test will rely on. Since there are no other VPC, SG's, etc outside of the mgmt environment, these have to be hard coded so that the env variable can be used to name other resources that will conflict. I'd be happy to elaborate on this further if you have questions. See the other resources and it might make sense.", "author": "jzulim", "createdAt": "2020-02-06T01:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNzQ5MQ=="}], "type": "inlineReview"}, {"oid": "1ac11c4d780d31d3244dc1b9f6288427915e8e83", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1ac11c4d780d31d3244dc1b9f6288427915e8e83", "message": "Merge branch 'master' into BLUEBUTTON-1281-mgmt-test-v2", "committedDate": "2020-02-07T18:22:02Z", "type": "commit"}]}