{"pr_number": 295, "pr_title": "BFD-63: Deployment information and troubleshooting documentation", "pr_createdAt": "2020-06-10T16:53:26Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/295", "timeline": [{"oid": "b2422037f20ef5029e9cfab26a67e2351144e6d3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b2422037f20ef5029e9cfab26a67e2351144e6d3", "message": "Add deployment information runbook", "committedDate": "2020-06-10T16:44:39Z", "type": "commit"}, {"oid": "8b008ad3be5424f5d9b34cd6b48e08fe8b3a6766", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8b008ad3be5424f5d9b34cd6b48e08fe8b3a6766", "message": "Resize section headers", "committedDate": "2020-06-10T16:54:09Z", "type": "commit"}, {"oid": "650195a945ebe33c6eb13b86efc1df3cdecca88b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/650195a945ebe33c6eb13b86efc1df3cdecca88b", "message": "Add example tags", "committedDate": "2020-06-10T16:58:23Z", "type": "commit"}, {"oid": "846ee9e8ef6ab3fb7892c56d631a0346eb495f62", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/846ee9e8ef6ab3fb7892c56d631a0346eb495f62", "message": "Change doc name", "committedDate": "2020-06-10T17:00:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDYzMg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/295#discussion_r438884632", "bodyText": "Good tip, thanks for that!", "author": "jzulim", "createdAt": "2020-06-11T15:43:09Z", "path": "ops/ccs-ops-misc/DEPLOY-INFO.md", "diffHunk": "@@ -0,0 +1,36 @@\n+Deployment Info\n+---------------\n+\n+### General Info\n+\n+- Single, multibranch Jenkinsfile provides all stage orchestration.\n+  - App build logic located here: `apps/build.groovy`\n+  - Deploy logic located here: `ops/deploy-ccs.groovy`\n+- Platinum AMI is an optional stage controlled by `build_platinum` var.  Recommend building at least once a month.\n+- Only the master branch can deploy to production environments unless `deploy_prod_from_non_master` var is set to true.\n+- Deployment stages use locks to prevent multiple deployments from occuring at once to the same environment.\n+- There is a gate (manual approval stage) between TEST and PROD-SBX deployment, but not between PROD-SBX and PROD deployment.  Recommend locking the PROD environment in order to gate the PROD-SBX deployment for additional testing.\n+- Our merge strategy in Jenkins is to merge the current deploying branch with master, which creates a unique commit ID in Jenkins that is appended to deployed AMIs.  To look up the commit ID of an AMI, you'll need to look up the merge commit in Jenkins and then find the originating commit from the BFD repo.", "originalCommit": "846ee9e8ef6ab3fb7892c56d631a0346eb495f62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTEwMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/295#discussion_r438885103", "bodyText": "Good advice.", "author": "jzulim", "createdAt": "2020-06-11T15:43:47Z", "path": "ops/ccs-ops-misc/DEPLOY-INFO.md", "diffHunk": "@@ -0,0 +1,36 @@\n+Deployment Info\n+---------------\n+\n+### General Info\n+\n+- Single, multibranch Jenkinsfile provides all stage orchestration.\n+  - App build logic located here: `apps/build.groovy`\n+  - Deploy logic located here: `ops/deploy-ccs.groovy`\n+- Platinum AMI is an optional stage controlled by `build_platinum` var.  Recommend building at least once a month.\n+- Only the master branch can deploy to production environments unless `deploy_prod_from_non_master` var is set to true.\n+- Deployment stages use locks to prevent multiple deployments from occuring at once to the same environment.\n+- There is a gate (manual approval stage) between TEST and PROD-SBX deployment, but not between PROD-SBX and PROD deployment.  Recommend locking the PROD environment in order to gate the PROD-SBX deployment for additional testing.", "originalCommit": "846ee9e8ef6ab3fb7892c56d631a0346eb495f62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5NDMwMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/295#discussion_r438894303", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n            For insight into the cloud-init stage look at /var/log/cloud-init.log and /var/log/cloud-init-output.log\n          \n          \n            \n            For insight into the BFD FHIR application servers look in /usr/local/bfd-server/", "author": "jzulim", "createdAt": "2020-06-11T15:53:56Z", "path": "ops/ccs-ops-misc/DEPLOY-INFO.md", "diffHunk": "@@ -0,0 +1,36 @@\n+Deployment Info\n+---------------\n+\n+### General Info\n+\n+- Single, multibranch Jenkinsfile provides all stage orchestration.\n+  - App build logic located here: `apps/build.groovy`\n+  - Deploy logic located here: `ops/deploy-ccs.groovy`\n+- Platinum AMI is an optional stage controlled by `build_platinum` var.  Recommend building at least once a month.\n+- Only the master branch can deploy to production environments unless `deploy_prod_from_non_master` var is set to true.\n+- Deployment stages use locks to prevent multiple deployments from occuring at once to the same environment.\n+- There is a gate (manual approval stage) between TEST and PROD-SBX deployment, but not between PROD-SBX and PROD deployment.  Recommend locking the PROD environment in order to gate the PROD-SBX deployment for additional testing.\n+- Our merge strategy in Jenkins is to merge the current deploying branch with master, which creates a unique commit ID in Jenkins that is appended to deployed AMIs.  To look up the commit ID of an AMI, you'll need to look up the merge commit in Jenkins and then find the originating commit from the BFD repo.\n+\n+### Failed Deployment Troubleshooting\n+\n+ELB health checks and smoke testing embedded in the BFD startup script prevent completely broken deployments.  Additionally we use a create-before-destroy apply method in terraform when creating a new deployment autoscaling group.  If a new deployment fails these checks, it will time out the terraform deployment, leaving the original autoscaling group in tact, thus preventing an outage.\n+\n+Non-outage deployment timeout is the #1 issue encountered when deploying BFD, and unfortunately can happen for many reasons:\n+- Startup routines in the gold image defined stage of cloud-init are failing or slow\n+- Startup routines in our user data defined stage of cloud-init are failing or slow\n+  - Can occur in our actual user data bash script\n+  - Can occur in ansible launch playbook\n+- BFD service itself fails or is slow to start\n+- AWS operations called by terraform are slow\n+", "originalCommit": "846ee9e8ef6ab3fb7892c56d631a0346eb495f62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b76ed38e8891871a3831f60c2d307589d05361c9", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b76ed38e8891871a3831f60c2d307589d05361c9", "message": "Update deploy info doc with suggested change\n\nCo-authored-by: John Zulim <john.zulim@adhocteam.us>", "committedDate": "2020-06-11T19:27:13Z", "type": "commit"}]}