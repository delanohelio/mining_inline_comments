{"pr_number": 275, "pr_title": "BFD-164: AB2D glue role", "pr_createdAt": "2020-05-15T17:33:15Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275", "timeline": [{"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "message": "AB2D glue role", "committedDate": "2020-05-15T17:31:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDA5NQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954095", "bodyText": "This change makes defaults explicit", "author": "RickHawesUSDS", "createdAt": "2020-05-15T17:44:09Z", "path": "insights/terraform/modules/bucket/main.tf", "diffHunk": "@@ -47,6 +47,8 @@ resource \"aws_s3_bucket_object\" \"top\" {\n resource \"aws_kms_key\" \"main\" {\n   description   = \"CMK for the ${local.full_name} bucket\"\n   tags          = var.tags\n+  key_usage     = \"ENCRYPT_DECRYPT\"\n+  is_enabled    = true\n   policy        = length(var.cross_accounts) > 0 ? data.aws_iam_policy_document.cmk_policy.json : null", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDM1Ng==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954356", "bodyText": "Will need the arn later.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T17:44:38Z", "path": "insights/terraform/modules/bucket/outputs.tf", "diffHunk": "@@ -9,3 +9,7 @@ output \"id\" {\n output \"bucket_cmk\" {\n   value = aws_kms_key.main.key_id\n }\n+\n+output \"bucket_cmk_arn\" {\n+  value = aws_kms_key.main.arn\n+}", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDcyMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954723", "bodyText": "Expanding the policy to be more comprehensive.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T17:45:19Z", "path": "insights/terraform/modules/bucket/policies.tf", "diffHunk": "@@ -187,11 +189,11 @@ resource \"aws_s3_bucket_policy\" \"cross_account\" {\n               \"Action\": [\n                   \"s3:AbortMultipartUpload\",\n                   \"s3:GetBucketLocation\",\n-                  \"s3:GetObject\",\n+                  \"s3:GetObject*\",\n                   \"s3:ListBucket\",\n                   \"s3:ListBucketMultipartUploads\",\n-                  \"s3:PutObject\",\n-                  \"s3:PutObjectAcl\"\n+                  \"s3:PutObject*\",\n+                  \"s3:DeleteObject*\"\n               ],", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTMwMQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955301", "bodyText": "Moving these tables to a new tables.tf as refactoring.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T17:46:28Z", "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -46,148 +54,17 @@ module \"database\" {\n   tags            = local.tags\n }\n \n-## Tables for the project", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTgwOQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955809", "bodyText": "The Glue Jobs module will have a lot more in the future.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T17:47:28Z", "path": "insights/terraform/modules/jobs/main.tf", "diffHunk": "@@ -0,0 +1 @@\n+# Glue jobs stuff goes here", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjA4Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012083", "bodyText": "Somewhat inconsequential, but the SID is included, yet blank.", "author": "njdister", "createdAt": "2020-05-15T19:43:57Z", "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjg5OQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012899", "bodyText": "Interesting way to generate policy documents!  Appears less likely to break than by directly embedding JSON in a HEREDOC.", "author": "njdister", "createdAt": "2020-05-15T19:45:45Z", "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"\n+      }\n+    ]\n+  }\n+  POLICY\n+}\n+\n+## Find and create policies for the role\n+\n+data \"aws_iam_policy\" \"glue_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole\"\n+}\n+\n+data \"aws_iam_policy\" \"athena_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/AmazonAthenaFullAccess\"\n+}\n+\n+data \"aws_iam_policy_document\" \"s3_access\" {", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAzODk0Mg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426038942", "bodyText": "Right. JSON and HEREDOC are harder to debug.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T20:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNDcxMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426014713", "bodyText": "Suggest replacing hardcoded acct number with the caller identity data source", "author": "njdister", "createdAt": "2020-05-15T19:49:43Z", "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -25,6 +25,14 @@ module \"bucket\" {\n   ]\n }\n \n+data \"aws_s3_bucket\" \"moderate_bucket\" {\n+  bucket = \"bfd-insights-moderate-577373831711\"", "originalCommit": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0MjI2MQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426042261", "bodyText": "Good point. Pushed a new change.", "author": "RickHawesUSDS", "createdAt": "2020-05-15T20:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNDcxMw=="}], "type": "inlineReview"}, {"oid": "7bb9ba9888014c1af4444ed98b4272057100f7b5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/7bb9ba9888014c1af4444ed98b4272057100f7b5", "message": "Changes suggested by Nathan", "committedDate": "2020-05-15T20:54:08Z", "type": "commit"}]}