{"pr_number": 2070, "pr_title": "Fix chat user player status state updates", "pr_createdAt": "2020-12-17T05:07:17Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/2070", "timeline": [{"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "url": "https://github.com/FAForever/downlords-faf-client/commit/bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "message": "Fix chat user player status state updates", "committedDate": "2020-12-17T05:07:45Z", "type": "commit"}, {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "url": "https://github.com/FAForever/downlords-faf-client/commit/bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "message": "Fix chat user player status state updates", "committedDate": "2020-12-17T05:07:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMjgwNg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545412806", "bodyText": "Maybe we can refactor this since it is hardly readable anymore. Should be extracted into methods. Too many nesting", "author": "1-alex98", "createdAt": "2020-12-17T21:24:27Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzQxMQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545413411", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (chatChannelUser.getClan().isEmpty()) {\n          \n          \n            \n                  if (!chatChannelUser.getClan().isEmpty()) {\n          \n          \n            \n                       return;\n          \n          \n            \n                  }", "author": "1-alex98", "createdAt": "2020-12-17T21:25:39Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzg5Mg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545413892", "bodyText": "Early return avoids another level of nesting", "author": "1-alex98", "createdAt": "2020-12-17T21:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNDMyMg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545414322", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (chatChannelUser.getAvatar().isEmpty()) {\n          \n          \n            \n                  if (!chatChannelUser.getAvatar().isEmpty()) {\n          \n          \n            \n                      return;\n          \n          \n            \n                  }", "author": "1-alex98", "createdAt": "2020-12-17T21:27:30Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNDUzOQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545414539", "bodyText": "early return -> less nesting", "author": "1-alex98", "createdAt": "2020-12-17T21:27:59Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNTc1NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545415754", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        PlayerStatus status = player.getStatus();\n          \n          \n            \n                        Image playerStatusImage = switch (status) {\n          \n          \n            \n                          case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n          \n          \n            \n                          case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n          \n          \n            \n                          case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n          \n          \n            \n                          default -> null;\n          \n          \n            \n                        };\n          \n          \n            \n                        Image mapImage;\n          \n          \n            \n                        if (status != PlayerStatus.IDLE) {\n          \n          \n            \n                          mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n          \n          \n            \n                        } else {\n          \n          \n            \n                          mapImage = null;\n          \n          \n            \n                        }\n          \n          \n            \n                        Platform.runLater(() -> {\n          \n          \n            \n                          chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n          \n          \n            \n                          chatChannelUser.setGameStatusImage(playerStatusImage);\n          \n          \n            \n                          chatChannelUser.setMapImage(mapImage);\n          \n          \n            \n                        });\n          \n          \n            \n                        setImages()", "author": "1-alex98", "createdAt": "2020-12-17T21:30:15Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n+              Platform.runLater(() -> {\n+                chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n+                chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setCountryFlag(null);\n+      chatChannelUser.setCountryName(null);\n     }\n   }\n \n   public void populateGameStatus(ChatChannelUser chatChannelUser) {\n-    chatChannelUser.getPlayer()\n-        .ifPresent(player -> {\n-          PlayerStatus status = player.getStatus();\n-          Image playerStatusImage = switch (status) {\n-            case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n-            case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n-            case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n-            default -> null;\n-          };\n-          Image mapImage;\n-          if (status != PlayerStatus.IDLE) {\n-            mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n-          } else {\n-            mapImage = null;\n-          }\n-          Platform.runLater(() -> {\n-            chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n-            chatChannelUser.setGameStatusImage(playerStatusImage);\n-            chatChannelUser.setMapImage(mapImage);\n-            chatChannelUser.setGameStatus(status);\n+    if (chatChannelUser.isDisplayed()) {\n+      chatChannelUser.getPlayer()\n+          .ifPresent(player -> {\n+            PlayerStatus status = player.getStatus();\n+            Image playerStatusImage = switch (status) {\n+              case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n+              case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n+              case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n+              default -> null;\n+            };\n+            Image mapImage;\n+            if (status != PlayerStatus.IDLE) {\n+              mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n+            } else {\n+              mapImage = null;\n+            }\n+            Platform.runLater(() -> {\n+              chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n+              chatChannelUser.setGameStatusImage(playerStatusImage);\n+              chatChannelUser.setMapImage(mapImage);\n+            });", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNjAwNQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545416005", "bodyText": "Miss leading name also does other things", "author": "1-alex98", "createdAt": "2020-12-17T21:30:44Z", "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n+              Platform.runLater(() -> {\n+                chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n+                chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setCountryFlag(null);\n+      chatChannelUser.setCountryName(null);\n     }\n   }\n \n   public void populateGameStatus(ChatChannelUser chatChannelUser) {", "originalCommit": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d34639e59e3e19c75a29426cfb1f2d2fe5e7ff8e", "url": "https://github.com/FAForever/downlords-faf-client/commit/d34639e59e3e19c75a29426cfb1f2d2fe5e7ff8e", "message": "simplify chat user service", "committedDate": "2020-12-18T00:23:45Z", "type": "commit"}, {"oid": "9a3a09d0d8f8576a3d4c1acbb965eb033db7ee6c", "url": "https://github.com/FAForever/downlords-faf-client/commit/9a3a09d0d8f8576a3d4c1acbb965eb033db7ee6c", "message": "Use equals", "committedDate": "2020-12-18T01:21:44Z", "type": "commit"}]}