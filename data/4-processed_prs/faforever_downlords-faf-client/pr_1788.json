{"pr_number": 1788, "pr_title": "Fix \"None\" map name retrieved for generated maps", "pr_createdAt": "2020-06-20T00:53:39Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/1788", "timeline": [{"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "url": "https://github.com/FAForever/downlords-faf-client/commit/8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "message": "Fix \"None\" map name retrieved for generated maps", "committedDate": "2020-06-20T00:48:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134885", "bodyText": "Can u specify what you mean, maybe link a GitHub issue. Donot think that a user could use this string to attack another client", "author": "1-alex98", "createdAt": "2020-06-20T14:25:44Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +233,7 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    // TODO make sure that these are valid characters for a file name? this is potentially unsafe user input", "originalCommit": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzMDE5OA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443230198", "bodyText": "The usual maps dont require calling this beause mapName is in metadata. That mapName is retrived from some server column by matching via filename. So for normal maps we are guarantueed to get server entries. When directly parsing, we are reading a name that comes directly from one players client.\nI guess it doesnt matter because downloading the mapo will simply fail if we have invalid characters right?", "author": "Katharsas", "createdAt": "2020-06-21T15:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4MzU1Nw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r447383557", "bodyText": "I added in a check for invalid filename characters", "author": "Sheikah45", "createdAt": "2020-06-30T03:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDk5Mg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134992", "bodyText": "This is also the case for other featured mods like coop.  How would that work out there?", "author": "1-alex98", "createdAt": "2020-06-20T14:27:36Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {", "originalCommit": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyOTg4MA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443229880", "bodyText": "Coop maps seem to be handled in the lines directly above this code. Maybe it was null or empty in the past and due to a replay server change is \"None\" now for coop maps as well?", "author": "Katharsas", "createdAt": "2020-06-21T15:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443135015", "bodyText": "Could we write a unit test for that?", "author": "1-alex98", "createdAt": "2020-06-20T14:27:59Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n+      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n+      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n+        mapName = maybeMapGen;\n+      }\n+    }", "originalCommit": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzMDQwMg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443230402", "bodyText": "Do we have some actual specification that determines when mapName is supposed to be null, empty or \"None\"? Otherwise the test will just enforce arbitrary things.", "author": "Katharsas", "createdAt": "2020-06-21T15:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwMTg3MQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r449901871", "bodyText": "Sheikah added a test", "author": "Katharsas", "createdAt": "2020-07-05T17:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ=="}], "type": "inlineReview"}, {"oid": "efb633d8ff349a036b1ac5639ddaad1aac20d93e", "url": "https://github.com/FAForever/downlords-faf-client/commit/efb633d8ff349a036b1ac5639ddaad1aac20d93e", "message": "Add check for invalid characters in filename", "committedDate": "2020-06-30T03:14:13Z", "type": "commit"}, {"oid": "fd7ff9f6253da3bdb835bcee19d6ebbb322881dc", "url": "https://github.com/FAForever/downlords-faf-client/commit/fd7ff9f6253da3bdb835bcee19d6ebbb322881dc", "message": "Add unit tests for invalid filenames", "committedDate": "2020-06-30T03:14:35Z", "type": "commit"}, {"oid": "3f56b55ba9f76aadb8058cb058d3fb6964168105", "url": "https://github.com/FAForever/downlords-faf-client/commit/3f56b55ba9f76aadb8058cb058d3fb6964168105", "message": "Add unit test for generated map check", "committedDate": "2020-06-30T11:56:09Z", "type": "commit"}, {"oid": "3fd54d238db31e581a13735c82d0a1f098c0778b", "url": "https://github.com/FAForever/downlords-faf-client/commit/3fd54d238db31e581a13735c82d0a1f098c0778b", "message": "Use parseMapName over parseMapFolderName\n\nFor some reason parseMapFolderName returns the map name without any capitalization from the raw replay bytes. This causes issues with the base64 string encoding used by the next gen map generator. parseMapName returns the map name with correct capitalization making it more suitable for usage. As an aside it appears that parseMapFolderName uses the scenario file in the raw bytes to get the map name whereas parseMapName uses the .scmap file and the capitalization differences are reflected there.", "committedDate": "2020-07-02T04:43:17Z", "type": "commit"}, {"oid": "13be0cc079701e1adf171c49d5f6ada271e13209", "url": "https://github.com/FAForever/downlords-faf-client/commit/13be0cc079701e1adf171c49d5f6ada271e13209", "message": "Update unit tests", "committedDate": "2020-07-02T11:51:35Z", "type": "commit"}]}