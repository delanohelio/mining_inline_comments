{"pr_number": 10270, "pr_title": "Fix a potential fd leak in AbstractDiskHttpData.getChunk", "pr_createdAt": "2020-05-10T16:03:32Z", "pr_url": "https://github.com/netty/netty/pull/10270", "timeline": [{"oid": "36c31881d7610ea1ee669389575d14f65e6e9438", "url": "https://github.com/netty/netty/commit/36c31881d7610ea1ee669389575d14f65e6e9438", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-10T14:54:46Z", "type": "commit"}, {"oid": "f33aae8e0fb8120757da601874d4403bea3c7e46", "url": "https://github.com/netty/netty/commit/f33aae8e0fb8120757da601874d4403bea3c7e46", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-10T16:05:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY2NjQzMA==", "url": "https://github.com/netty/netty/pull/10270#discussion_r422666430", "bodyText": "Should this try finally better englobing the while loop? Because there, the read operation will be only valid once, then failed since it will be closed from the very first iteration...", "author": "fredericBregier", "createdAt": "2020-05-10T16:19:26Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -301,7 +301,15 @@ public ByteBuf getChunk(int length) throws IOException {\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n         while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n+            int readnow=-1;\n+            try {\n+                readnow = fileChannel.read(byteBuffer);\n+            }catch (IOException e){\n+                logger.warn(\"Failed to read a file.\", e);\n+            }\n+            finally {\n+                fileChannel.close();", "originalCommit": "36c31881d7610ea1ee669389575d14f65e6e9438", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc1MjE3Mw==", "url": "https://github.com/netty/netty/pull/10270#discussion_r422752173", "bodyText": "yes, according to your suggest. I rewrite the fix.", "author": "prgitpr", "createdAt": "2020-05-11T02:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY2NjQzMA=="}], "type": "inlineReview"}, {"oid": "8ef4aedc8b6f798ddbae0e921036cd91a84a2c8a", "url": "https://github.com/netty/netty/commit/8ef4aedc8b6f798ddbae0e921036cd91a84a2c8a", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-11T00:57:44Z", "type": "commit"}, {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33", "url": "https://github.com/netty/netty/commit/c6e798efb15f957bfc82858a74e97052fc1fee33", "message": "checkstyle", "committedDate": "2020-05-11T07:02:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgyNDI2OQ==", "url": "https://github.com/netty/netty/pull/10270#discussion_r422824269", "bodyText": "this will throw a NPE if readnow == -1 is true. you will need to add a null check here", "author": "normanmaurer", "createdAt": "2020-05-11T07:03:19Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,15 +300,19 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n-                fileChannel.close();\n-                fileChannel = null;\n-                break;\n-            } else {\n-                read += readnow;\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n             }\n+        } finally {\n+            fileChannel.close();", "originalCommit": "c6e798efb15f957bfc82858a74e97052fc1fee33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5NjY3NQ==", "url": "https://github.com/netty/netty/pull/10270#discussion_r422896675", "bodyText": "@prgitpr I agree with @normanmaurer\nPerhaps removing the lines 307 and 308 (closing and setting to null fileChannel) but keeping the break is one way to go, moving the setting to null just after the close in the finally part (so moving all close and set to null in the finally)?", "author": "fredericBregier", "createdAt": "2020-05-11T09:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgyNDI2OQ=="}], "type": "inlineReview"}, {"oid": "2628d644e01196594dbc36884c903c135998e950", "url": "https://github.com/netty/netty/commit/2628d644e01196594dbc36884c903c135998e950", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-11T14:35:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMTI3MA==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423101270", "bodyText": "What about this version? Interest: no close within the loop, setting to null in finally (no check needed)\n    try {\n        while (read < length) {\n            int readnow = fileChannel.read(byteBuffer);\n            if (readnow == -1) {\n                break;\n            }\n            read += readnow;\n        }\n    } finally {\n        fileChannel.close();\n        fileChannel = null;\n    }", "author": "fredericBregier", "createdAt": "2020-05-11T14:56:51Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,14 +300,20 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n+            }\n+        } finally {\n+            if (fileChannel != null) {", "originalCommit": "2628d644e01196594dbc36884c903c135998e950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNzkxNg==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423107916", "bodyText": "yes, it look much clean", "author": "prgitpr", "createdAt": "2020-05-11T15:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMTI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzExNzU5Nw==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423117597", "bodyText": "Thanks", "author": "fredericBregier", "createdAt": "2020-05-11T15:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMTI3MA=="}], "type": "inlineReview"}, {"oid": "a858f0c6e30aeed93b347fcaeae876787433f810", "url": "https://github.com/netty/netty/commit/a858f0c6e30aeed93b347fcaeae876787433f810", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-11T15:09:27Z", "type": "commit"}, {"oid": "d412193fccfd2d12c97a07a996da76ba41defa11", "url": "https://github.com/netty/netty/commit/d412193fccfd2d12c97a07a996da76ba41defa11", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-12T01:40:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMTA1MA==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423501050", "bodyText": "just remove the above two lines as you already call close in the finally block anyway.", "author": "normanmaurer", "createdAt": "2020-05-12T06:53:02Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,14 +300,20 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;", "originalCommit": "d412193fccfd2d12c97a07a996da76ba41defa11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMDcwNA==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423520704", "bodyText": "ok", "author": "prgitpr", "createdAt": "2020-05-12T07:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMTA1MA=="}], "type": "inlineReview"}, {"oid": "63dbfdf7caab19a1d48297596d76b6a3f37bbba9", "url": "https://github.com/netty/netty/commit/63dbfdf7caab19a1d48297596d76b6a3f37bbba9", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-12T07:26:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MjU2Nw==", "url": "https://github.com/netty/netty/pull/10270#discussion_r423542567", "bodyText": "Previously, there was a fileChannel = null; after closing it. I believe that we still need it to be consistent in the finally part.", "author": "fredericBregier", "createdAt": "2020-05-12T08:08:50Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,15 +300,17 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n-                fileChannel.close();\n-                fileChannel = null;\n-                break;\n-            } else {\n-                read += readnow;\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n             }\n+        } finally {\n+                fileChannel.close();", "originalCommit": "63dbfdf7caab19a1d48297596d76b6a3f37bbba9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5ODkzNA==", "url": "https://github.com/netty/netty/pull/10270#discussion_r424098934", "bodyText": "ok", "author": "prgitpr", "createdAt": "2020-05-12T23:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MjU2Nw=="}], "type": "inlineReview"}, {"oid": "19a61e48ee970fbe809f2af0c6f201355d8e9841", "url": "https://github.com/netty/netty/commit/19a61e48ee970fbe809f2af0c6f201355d8e9841", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\"", "committedDate": "2020-05-12T23:57:42Z", "type": "commit"}, {"oid": "056945f6afcd2dc24fd565ae3972a6d9c83aad8b", "url": "https://github.com/netty/netty/commit/056945f6afcd2dc24fd565ae3972a6d9c83aad8b", "message": "Fix whitespaces", "committedDate": "2020-05-13T06:40:55Z", "type": "commit"}, {"oid": "91e75a85342604229f8b7e5888ec76213280a431", "url": "https://github.com/netty/netty/commit/91e75a85342604229f8b7e5888ec76213280a431", "message": "Remove else", "committedDate": "2020-05-13T06:41:55Z", "type": "commit"}]}