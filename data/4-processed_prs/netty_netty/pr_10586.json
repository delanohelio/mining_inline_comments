{"pr_number": 10586, "pr_title": "Cleanup", "pr_createdAt": "2020-09-18T04:22:48Z", "pr_url": "https://github.com/netty/netty/pull/10586", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MTYyNw==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491461627", "bodyText": "We may want to leave this here since I think some similar logic will be needed to what this is used for with epoll - specifically we need to do a final blocking read upon event loop shutdown before closing the eventfd if this flag is set, otherwise the corresponding \"wakeup\" write could be made after the fd has been reassigned to something else.", "author": "njhill", "createdAt": "2020-09-19T14:45:50Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -52,9 +52,11 @@\n     private final FileDescriptor eventfd;\n \n     private final IovArrays iovArrays;\n+    // The maximum number of bytes for an InetAddress / Inet6Address\n+    private final byte[] inet4AddressArray = new byte[4];\n+    private final byte[] inet6AddressArray = new byte[16];\n \n     private long prevDeadlineNanos = NONE;\n-    private boolean pendingWakeup;", "originalCommit": "d4a8fb5716a30a0562f5545cb940236f41b64c18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY2MjA4Nw==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491662087", "bodyText": "@njhill can you do a pr ?", "author": "normanmaurer", "createdAt": "2020-09-20T07:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MTYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3MTE2OA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r492871168", "bodyText": "Let me pull this one in first and we can add this stuff back when needed.", "author": "normanmaurer", "createdAt": "2020-09-22T16:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MTYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxMzIyOA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r495513228", "bodyText": "@normanmaurer @1Jo1 I've now opened a PR for this: #10615", "author": "njhill", "createdAt": "2020-09-27T01:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MTYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491462012", "bodyText": "Hmm I see this is unused right now but it probably should be used. It doesn't look like we currently ever remove any channels from the channels map ... this should be done when they are deregistered from the EL (probably after the corresponding CQEs are processed).", "author": "njhill", "createdAt": "2020-09-19T14:48:27Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -97,27 +99,13 @@ public void run() {\n                 : PlatformDependent.<Runnable>newMpscQueue(maxPendingTasks);\n     }\n \n-    public void add(AbstractIOUringChannel ch) {\n+    void add(AbstractIOUringChannel ch) {\n         logger.trace(\"Add Channel: {} \", ch.socket.intValue());\n         int fd = ch.socket.intValue();\n \n         channels.put(fd, ch);\n     }\n \n-    public void remove(AbstractIOUringChannel ch) {", "originalCommit": "d4a8fb5716a30a0562f5545cb940236f41b64c18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY2MjE3OA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491662178", "bodyText": "it is removed: \n  \n    \n      netty/transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java\n    \n    \n         Line 238\n      in\n      267913d\n    \n    \n    \n    \n\n        \n          \n           channels.remove(fd);", "author": "normanmaurer", "createdAt": "2020-09-20T07:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY2Mjc4Mg==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491662782", "bodyText": "oh yeah we only remove channels when a poll remove is submitted", "author": "1Jo1", "createdAt": "2020-09-20T07:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY2MzcyNg==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491663726", "bodyText": "a poll remove event is submitted when a channel should be closed, I think we should remove channels from the channels map when no poll event is scheduled", "author": "1Jo1", "createdAt": "2020-09-20T07:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcwMDI5Mg==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491700292", "bodyText": "@normanmaurer my bad, I somehow forgot/missed the remove there", "author": "njhill", "createdAt": "2020-09-20T15:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg=="}], "type": "inlineReview"}, {"oid": "e6f7eeba50f562c98edfa009a5736207b1c7ab10", "url": "https://github.com/netty/netty/commit/e6f7eeba50f562c98edfa009a5736207b1c7ab10", "message": "Cleanup\n\nMotivation:\n\nsome cleanup to make it more readable\n\nModifications:\n\n- fix typos\n- remove cqe kRingMask\n- remove unused pendingWakeup\n\nResult:\n\ncleaner code", "committedDate": "2020-09-20T07:12:03Z", "type": "forcePushed"}, {"oid": "7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "url": "https://github.com/netty/netty/commit/7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel", "committedDate": "2020-09-20T23:16:09Z", "type": "forcePushed"}, {"oid": "b2c77a3867476dbe36e04d145157115353965861", "url": "https://github.com/netty/netty/commit/b2c77a3867476dbe36e04d145157115353965861", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel", "committedDate": "2020-09-20T23:25:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc0ODIwNw==", "url": "https://github.com/netty/netty/pull/10586#discussion_r491748207", "bodyText": "@normanmaurer we could just use ioState == 0, I'm not quite sure.. WDYT?", "author": "1Jo1", "createdAt": "2020-09-20T23:32:38Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -714,10 +714,14 @@ protected void doRegister() throws Exception {\n     }\n \n     @Override\n-    protected void doDeregister() throws Exception {\n+    protected void doDeregister() {\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n \n         if (submissionQueue != null) {\n+            if ((ioState & (POLL_IN_SCHEDULED | POLL_OUT_SCHEDULED | POLL_RDHUP_SCHEDULED)) == 0) {", "originalCommit": "b2c77a3867476dbe36e04d145157115353965861", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAxNDY1MQ==", "url": "https://github.com/netty/netty/pull/10586#discussion_r492014651", "bodyText": "Yeah I think that is right...", "author": "normanmaurer", "createdAt": "2020-09-21T12:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc0ODIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3MTYwNA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r492871604", "bodyText": "@1Jo1 please keep the code above", "author": "normanmaurer", "createdAt": "2020-09-22T16:25:08Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -108,17 +107,7 @@ void add(AbstractIOUringChannel ch) {\n     }\n \n     void remove(AbstractIOUringChannel ch) {\n-        logger.trace(\"Remove Channel: {}\", ch.socket.intValue());\n-        int fd = ch.socket.intValue();\n-\n-        AbstractIOUringChannel old = channels.remove(fd);\n-        if (old != null && old != ch) {\n-            // The Channel mapping was already replaced due FD reuse, put back the stored Channel.\n-            channels.put(fd, old);\n-\n-            // If we found another Channel in the map that is mapped to the same FD the given Channel MUST be closed.\n-            assert !ch.isOpen();\n-        }", "originalCommit": "b2c77a3867476dbe36e04d145157115353965861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3MTg4Mw==", "url": "https://github.com/netty/netty/pull/10586#discussion_r492871883", "bodyText": "if we don't need the return value we should just call set(...)", "author": "normanmaurer", "createdAt": "2020-09-22T16:25:35Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -168,8 +157,8 @@ protected void run() {\n                         }\n                     }\n                 } finally {\n-                    if (nextWakeupNanos.get() == AWAKE || nextWakeupNanos.getAndSet(AWAKE) == AWAKE) {\n-                        pendingWakeup = true;\n+                    if (nextWakeupNanos.get() == AWAKE) {\n+                        nextWakeupNanos.getAndSet(AWAKE);", "originalCommit": "b2c77a3867476dbe36e04d145157115353965861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3cb4f335e43d8d740374065834854b1fd741ca4d", "url": "https://github.com/netty/netty/commit/3cb4f335e43d8d740374065834854b1fd741ca4d", "message": "Cleanup\n\nMotivation:\n\nsome cleanup to make it more readable\n\nModifications:\n\n- fix typos\n- remove cqe kRingMask\n- remove unused pendingWakeup\n\nResult:\n\ncleaner code", "committedDate": "2020-09-23T05:11:38Z", "type": "commit"}, {"oid": "be9a04f2683c61ec4814e222ef69c53db70b2fa1", "url": "https://github.com/netty/netty/commit/be9a04f2683c61ec4814e222ef69c53db70b2fa1", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel", "committedDate": "2020-09-23T05:11:43Z", "type": "commit"}, {"oid": "570084ff0d76c0570bd4021ee2c4fde73cf6115a", "url": "https://github.com/netty/netty/commit/570084ff0d76c0570bd4021ee2c4fde73cf6115a", "message": "Address @normanmaurer's comments", "committedDate": "2020-09-23T05:11:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIxODk5MA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r493218990", "bodyText": "remove this change as we already call remove below", "author": "normanmaurer", "createdAt": "2020-09-23T06:08:14Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -109,6 +108,7 @@ void add(AbstractIOUringChannel ch) {\n \n     void remove(AbstractIOUringChannel ch) {\n         logger.trace(\"Remove Channel: {}\", ch.socket.intValue());\n+        channels.remove(ch.socket.intValue());", "originalCommit": "570084ff0d76c0570bd4021ee2c4fde73cf6115a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIyMDM4OA==", "url": "https://github.com/netty/netty/pull/10586#discussion_r493220388", "bodyText": "yeah my bad", "author": "1Jo1", "createdAt": "2020-09-23T06:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIxODk5MA=="}], "type": "inlineReview"}, {"oid": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "url": "https://github.com/netty/netty/commit/beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "message": "Address @normanmaurer's comments", "committedDate": "2020-09-23T06:14:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzMTg3Mg==", "url": "https://github.com/netty/netty/pull/10586#discussion_r493231872", "bodyText": "sorry... missed this one. This if makes no sense. Remove it and just call set every time", "author": "normanmaurer", "createdAt": "2020-09-23T06:39:35Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -168,8 +167,8 @@ protected void run() {\n                         }\n                     }\n                 } finally {\n-                    if (nextWakeupNanos.get() == AWAKE || nextWakeupNanos.getAndSet(AWAKE) == AWAKE) {\n-                        pendingWakeup = true;\n+                    if (nextWakeupNanos.get() == AWAKE) {", "originalCommit": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "url": "https://github.com/netty/netty/commit/b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "message": "Address @normanmaurer's comments", "committedDate": "2020-09-23T06:43:51Z", "type": "commit"}, {"oid": "b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "url": "https://github.com/netty/netty/commit/b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "message": "Address @normanmaurer's comments", "committedDate": "2020-09-23T06:43:51Z", "type": "forcePushed"}]}