{"pr_number": 9940, "pr_title": "Fix remove 'WebSocketServerExtensionHandler' from pipeline after upgrade ", "pr_createdAt": "2020-01-10T15:20:40Z", "pr_url": "https://github.com/netty/netty/pull/9940", "timeline": [{"oid": "8a9fd6af1190ac2f7601758e2c71997e90b3944a", "url": "https://github.com/netty/netty/commit/8a9fd6af1190ac2f7601758e2c71997e90b3944a", "message": "Fix remove 'WebSocketServerExtensionHandler' from pipeline after successful handshake", "committedDate": "2020-01-10T15:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5MTY3Ng==", "url": "https://github.com/netty/netty/pull/9940#discussion_r365291676", "bodyText": "Can we split this condition on 2 separate if's? So we can perform only 1 class cast:\n((HttpResponse) msg).headers()\nHttpResponse response = (HttpResponse) msg;\nAlso, response.headers() could be moved to variable.", "author": "doom369", "createdAt": "2020-01-10T15:34:42Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/websocketx/extensions/WebSocketServerExtensionHandler.java", "diffHunk": "@@ -103,36 +103,46 @@ public void channelRead(ChannelHandlerContext ctx, Object msg)\n \n     @Override\n     public void write(final ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n-        if (msg instanceof HttpResponse &&\n-                WebSocketExtensionUtil.isWebsocketUpgrade(((HttpResponse) msg).headers()) && validExtensions != null) {\n-            HttpResponse response = (HttpResponse) msg;\n-            String headerValue = response.headers().getAsString(HttpHeaderNames.SEC_WEBSOCKET_EXTENSIONS);\n-\n-            for (WebSocketServerExtension extension : validExtensions) {\n-                WebSocketExtensionData extensionData = extension.newReponseData();\n-                headerValue = WebSocketExtensionUtil.appendExtension(headerValue,\n-                        extensionData.name(), extensionData.parameters());\n+        if (msg instanceof HttpResponse && WebSocketExtensionUtil.isWebsocketUpgrade(((HttpResponse) msg).headers())) {", "originalCommit": "8a9fd6af1190ac2f7601758e2c71997e90b3944a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQyNjM2NA==", "url": "https://github.com/netty/netty/pull/9940#discussion_r365426364", "bodyText": "no problem", "author": "amizurov", "createdAt": "2020-01-10T20:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI5MTY3Ng=="}], "type": "inlineReview"}, {"oid": "1479c2e369864bbd6c5c171810a4599dd66178b7", "url": "https://github.com/netty/netty/commit/1479c2e369864bbd6c5c171810a4599dd66178b7", "message": "Fix PR comments", "committedDate": "2020-01-10T20:53:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI1ODE1OQ==", "url": "https://github.com/netty/netty/pull/9940#discussion_r366258159", "bodyText": "nit: use ctx.pipeline().remove(WebSocketServerExtensionHandler.this);", "author": "normanmaurer", "createdAt": "2020-01-14T10:24:57Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/websocketx/extensions/WebSocketServerExtensionHandler.java", "diffHunk": "@@ -103,35 +103,48 @@ public void channelRead(ChannelHandlerContext ctx, Object msg)\n \n     @Override\n     public void write(final ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n-        if (msg instanceof HttpResponse &&\n-                WebSocketExtensionUtil.isWebsocketUpgrade(((HttpResponse) msg).headers()) && validExtensions != null) {\n-            HttpResponse response = (HttpResponse) msg;\n-            String headerValue = response.headers().getAsString(HttpHeaderNames.SEC_WEBSOCKET_EXTENSIONS);\n-\n-            for (WebSocketServerExtension extension : validExtensions) {\n-                WebSocketExtensionData extensionData = extension.newReponseData();\n-                headerValue = WebSocketExtensionUtil.appendExtension(headerValue,\n-                        extensionData.name(), extensionData.parameters());\n-            }\n+        if (msg instanceof HttpResponse) {\n+            HttpHeaders headers = ((HttpResponse) msg).headers();\n \n-            promise.addListener(new ChannelFutureListener() {\n-                @Override\n-                public void operationComplete(ChannelFuture future) throws Exception {\n-                    if (future.isSuccess()) {\n-                        for (WebSocketServerExtension extension : validExtensions) {\n-                            WebSocketExtensionDecoder decoder = extension.newExtensionDecoder();\n-                            WebSocketExtensionEncoder encoder = extension.newExtensionEncoder();\n-                            ctx.pipeline().addAfter(ctx.name(), decoder.getClass().getName(), decoder);\n-                            ctx.pipeline().addAfter(ctx.name(), encoder.getClass().getName(), encoder);\n-                        }\n+            if (WebSocketExtensionUtil.isWebsocketUpgrade(headers)) {\n+\n+                if (validExtensions != null) {\n+                    String headerValue = headers.getAsString(HttpHeaderNames.SEC_WEBSOCKET_EXTENSIONS);\n+\n+                    for (WebSocketServerExtension extension : validExtensions) {\n+                        WebSocketExtensionData extensionData = extension.newReponseData();\n+                        headerValue = WebSocketExtensionUtil.appendExtension(headerValue,\n+                                                                             extensionData.name(),\n+                                                                             extensionData.parameters());\n                     }\n+                    promise.addListener(new ChannelFutureListener() {\n+                        @Override\n+                        public void operationComplete(ChannelFuture future) {\n+                            if (future.isSuccess()) {\n+                                for (WebSocketServerExtension extension : validExtensions) {\n+                                    WebSocketExtensionDecoder decoder = extension.newExtensionDecoder();\n+                                    WebSocketExtensionEncoder encoder = extension.newExtensionEncoder();\n+                                    ctx.pipeline()\n+                                       .addAfter(ctx.name(), decoder.getClass().getName(), decoder)\n+                                       .addAfter(ctx.name(), encoder.getClass().getName(), encoder);\n+                                }\n+                            }\n+                        }\n+                    });\n \n-                    ctx.pipeline().remove(ctx.name());\n+                    if (headerValue != null) {\n+                        headers.set(HttpHeaderNames.SEC_WEBSOCKET_EXTENSIONS, headerValue);\n+                    }\n                 }\n-            });\n \n-            if (headerValue != null) {\n-                response.headers().set(HttpHeaderNames.SEC_WEBSOCKET_EXTENSIONS, headerValue);\n+                promise.addListener(new ChannelFutureListener() {\n+                    @Override\n+                    public void operationComplete(ChannelFuture future) {\n+                        if (future.isSuccess()) {\n+                            ctx.pipeline().remove(ctx.name());", "originalCommit": "1479c2e369864bbd6c5c171810a4599dd66178b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM1Mzc4NA==", "url": "https://github.com/netty/netty/pull/9940#discussion_r366353784", "bodyText": "done", "author": "amizurov", "createdAt": "2020-01-14T14:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI1ODE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI1ODczMg==", "url": "https://github.com/netty/netty/pull/9940#discussion_r366258732", "bodyText": "call ch.finish() and assert return value.", "author": "normanmaurer", "createdAt": "2020-01-14T10:25:57Z", "path": "codec-http/src/test/java/io/netty/handler/codec/http/websocketx/extensions/WebSocketServerExtensionHandlerTest.java", "diffHunk": "@@ -190,4 +198,28 @@ public void testNoneExtensionMatchingSuccess() {\n         verify(fallbackHandshakerMock).handshakeExtension(webSocketExtensionDataMatcher(\"unknown\"));\n         verify(fallbackHandshakerMock).handshakeExtension(webSocketExtensionDataMatcher(\"unknown2\"));\n     }\n+\n+    @Test\n+    public void testExtensionHandlerNotRemovedByFailureWritePromise() {\n+        // initialize\n+        when(mainHandshakerMock.handshakeExtension(webSocketExtensionDataMatcher(\"main\")))\n+                .thenReturn(mainExtensionMock);\n+\n+        // execute\n+        WebSocketServerExtensionHandler extensionHandler =\n+                new WebSocketServerExtensionHandler(mainHandshakerMock);\n+        EmbeddedChannel ch = new EmbeddedChannel(extensionHandler);\n+\n+        HttpRequest req = newUpgradeRequest(\"unknown, unknown2\");\n+        ch.writeInbound(req);\n+\n+        HttpResponse res = newUpgradeResponse(null);\n+        ChannelPromise failurePromise = ch.newPromise();\n+        ch.writeOneOutbound(res, failurePromise);\n+        failurePromise.setFailure(new IOException(\"Cannot write response\"));\n+\n+        // test\n+        assertNull(ch.readOutbound());\n+        assertNotNull(ch.pipeline().context(extensionHandler));\n+    }", "originalCommit": "1479c2e369864bbd6c5c171810a4599dd66178b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM1MzgzMA==", "url": "https://github.com/netty/netty/pull/9940#discussion_r366353830", "bodyText": "done", "author": "amizurov", "createdAt": "2020-01-14T14:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI1ODczMg=="}], "type": "inlineReview"}, {"oid": "acc4e2760007fb724a79e708d4a3fb0c2fd6138f", "url": "https://github.com/netty/netty/commit/acc4e2760007fb724a79e708d4a3fb0c2fd6138f", "message": "Fix test and remove handler by instance", "committedDate": "2020-01-14T14:01:26Z", "type": "commit"}]}