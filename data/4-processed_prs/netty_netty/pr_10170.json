{"pr_number": 10170, "pr_title": "Set IPV4_ONLY as default when NIC has only local IPv6 addresses", "pr_createdAt": "2020-04-06T09:52:55Z", "pr_url": "https://github.com/netty/netty/pull/10170", "timeline": [{"oid": "cdb0ef2248f5a07917758331e560166f878b0727", "url": "https://github.com/netty/netty/commit/cdb0ef2248f5a07917758331e560166f878b0727", "message": "Fix a bug where making IPv6 DnsQuestion when it's not supported\nMotivation:\nRelated https://github.com/line/armeria/issues/2463\nHere is an example that an NIC has only link local address for IPv6.\n```\n$ ipaddr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n3: eth0@if18692: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1460 qdisc noqueue\n    link/ether 1a:5e:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff\n    inet 10.xxx.xxx.xxx/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::xxxx:xxxx:xxxx:xxxx/64 scope link\n       valid_lft forever preferred_lft forever\n```\nIf the NICs have only local or link local addresses, We should not send IPv6 DNS queris.\n\nModification:\n- Ignore link-local IPv6 addresses which may exist even on a machine without IPv6 network.\n\nResult:\n- `DnsNameResolver` does not send DNS queries for AAAA when IPv6 is not available.", "committedDate": "2020-04-06T09:50:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404032588", "bodyText": "@minwoox hmm... shouldn't we still support AAAA if its a loopback address ? I mean the user may run the DNS server on the same machine.", "author": "normanmaurer", "createdAt": "2020-04-06T11:54:38Z", "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsNameResolver.java", "diffHunk": "@@ -160,7 +160,9 @@ private static boolean anyInterfaceSupportsIpV6() {\n                 NetworkInterface iface = interfaces.nextElement();\n                 Enumeration<InetAddress> addresses = iface.getInetAddresses();\n                 while (addresses.hasMoreElements()) {\n-                    if (addresses.nextElement() instanceof Inet6Address) {\n+                    InetAddress inetAddress = addresses.nextElement();\n+                    if (inetAddress instanceof Inet6Address && !inetAddress.isAnyLocalAddress() &&\n+                        !inetAddress.isLoopbackAddress() && !inetAddress.isLinkLocalAddress()) {", "originalCommit": "cdb0ef2248f5a07917758331e560166f878b0727", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzNjI1Ng==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404036256", "bodyText": "So you mean the client and the DNS server in the same machine?\nYes, that could be possible, but I think, in that case, there should be another valid address that the client can connect to the DNS server so that the client can ultimately connect to other endpoints using that address.", "author": "minwoox", "createdAt": "2020-04-06T12:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzOTMwNA==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404039304", "bodyText": "yes ... I think it is valid to only have ::1 configured for this case.", "author": "normanmaurer", "createdAt": "2020-04-06T12:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA0NjQyNw==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404046427", "bodyText": "If the machine does not have any other addresses than ::1, shouldn't we prevent the client from sending any AAAA query? Because the client cannot establish a connection using the resolved IPv6 address to the endpoint? \ud83e\udd14", "author": "minwoox", "createdAt": "2020-04-06T12:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA3NDIzMQ==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404074231", "bodyText": "@minwoox no... the resolver is used during bootstrap but may also used separately (for only resolving addresses). It doesn't matter if we can connect to the address or not, thats no the job of the resolver to check.", "author": "normanmaurer", "createdAt": "2020-04-06T13:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUwNDQ5Mw==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404504493", "bodyText": "Ah, now I got it what you meant. \ud83d\ude04\nBut I still think that setting DEFAULT_RESOLVE_ADDRESS_TYPES to ResolvedAddressTypes.IPV4_ONLY is safe when there are only local addresses.\nBecause there's a chance that the DnsNameResolver gets the AAAA response ahead of A response and if the resolver uses it, the client would not make a connection. As we got reported.\nIf a user wants to send an IPv6 query like you gave an example, he or she can just set IPV4_PREFERRED or IPV6_PREFERRED when building DnsNameResovler.\nWhat do you think?", "author": "minwoox", "createdAt": "2020-04-07T02:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU0MzU3Mg==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404543572", "bodyText": "True...  I think the title of the PR did confuse me as I did not realise this is just about default behaviour", "author": "normanmaurer", "createdAt": "2020-04-07T05:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MTA0Ng==", "url": "https://github.com/netty/netty/pull/10170#discussion_r404551046", "bodyText": "Ah sorry about it. \ud83d\ude05 Just use the title from the original PR without much thinking.\nline/armeria#2464 Let me change it. Thank you!", "author": "minwoox", "createdAt": "2020-04-07T05:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAzMjU4OA=="}], "type": "inlineReview"}]}