{"pr_number": 10571, "pr_title": "Simplify JNI init code", "pr_createdAt": "2020-09-14T09:41:50Z", "pr_url": "https://github.com/netty/netty/pull/10571", "timeline": [{"oid": "2fcf4905405beba25aa6bef725a023e70a6c1737", "url": "https://github.com/netty/netty/commit/2fcf4905405beba25aa6bef725a023e70a6c1737", "message": "Simplify JNI init code\n\nMotivation:\n\nUsing classes which are not provided by the JDK itself in JNI is\nproblematic when shading may be used by customers of the library. Also\nit makes the maintainance of the code often more complicated.\n\nModifications:\n\n- Only us classes which are provided by the JDK in the JNI code\n- Cleanup\n\nResult:\n\nEasier to maintain code", "committedDate": "2020-09-14T09:36:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4NTk3OQ==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487785979", "bodyText": "Idea is nice: I would just put somewhere the expected (constant) named indexes of the parameters.\nIf exposed that would help users a bit (although won't rely on the order/value of them)", "author": "franz1981", "createdAt": "2020-09-14T09:46:55Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/Native.java", "diffHunk": "@@ -92,15 +91,43 @@ public void run() {\n     }\n \n     static RingBuffer createRingBuffer(int ringSize, Runnable submissionCallback) {\n-        //Todo throw Exception if it's null\n-        return ioUringSetup(ringSize, submissionCallback);\n+        long[][] values = ioUringSetup(ringSize);\n+        assert values.length == 2;\n+        long[] submissionQueueArgs = values[0];\n+        assert submissionQueueArgs.length == 11;\n+        IOUringSubmissionQueue submissionQueue = new IOUringSubmissionQueue(\n+                submissionQueueArgs[0],", "originalCommit": "2fcf4905405beba25aa6bef725a023e70a6c1737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4Nzg0OA==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487787848", "bodyText": "sure I can do...  That said its all \"internal\" so not sure if it really matters and is worth the effort.", "author": "normanmaurer", "createdAt": "2020-09-14T09:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5MDYyOA==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487790628", "bodyText": "Matter of taste, indeed: the simplification is welcome anyway :) well done", "author": "franz1981", "createdAt": "2020-09-14T09:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5NjM0MQ==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487796341", "bodyText": "lets just keep it like this for now... If needed we can it later", "author": "normanmaurer", "createdAt": "2020-09-14T10:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4NTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk3ODQxNA==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487978414", "bodyText": "We don't need to store ring_sz for either CQ or SQ. It's only used for unmap and we can just calculate it there.", "author": "njhill", "createdAt": "2020-09-14T14:31:04Z", "path": "transport-native-io_uring/src/main/c/netty_io_uring_native.c", "diffHunk": "@@ -260,29 +244,37 @@ static jobject netty_io_uring_setup(JNIEnv *env, jclass class1, jint entries, jo\n         return NULL;\n     }\n \n-    jobject ioUringSubmissionQueue = (*env)->NewObject(\n-        env, ioUringSubmissionQueueClass, ioUringSubmissionQueueMethodId,\n-        (jlong)io_uring_ring.sq.khead, (jlong)io_uring_ring.sq.ktail,\n+    jlong submissionArrayElements[] = {\n+        (jlong)io_uring_ring.sq.khead,\n+        (jlong)io_uring_ring.sq.ktail,\n         (jlong)io_uring_ring.sq.kring_mask,\n-        (jlong)io_uring_ring.sq.kring_entries, (jlong)io_uring_ring.sq.kflags,\n-        (jlong)io_uring_ring.sq.kdropped, (jlong)io_uring_ring.sq.array,\n-        (jlong)io_uring_ring.sq.sqes, (jlong)io_uring_ring.sq.ring_sz,\n-        (jlong)io_uring_ring.cq.ring_ptr, (jint)ring_fd, submitCallback);\n-\n-    jobject ioUringCompletionQueue = (*env)->NewObject(\n-        env, ioUringCompletionQueueClass, ioUringCommpletionQueueMethodId,\n-        (jlong)io_uring_ring.cq.khead, (jlong)io_uring_ring.cq.ktail,\n+        (jlong)io_uring_ring.sq.kring_entries,\n+        (jlong)io_uring_ring.sq.kflags,\n+        (jlong)io_uring_ring.sq.kdropped,\n+        (jlong)io_uring_ring.sq.array,\n+        (jlong)io_uring_ring.sq.sqes,\n+        (jlong)io_uring_ring.sq.ring_sz,", "originalCommit": "2fcf4905405beba25aa6bef725a023e70a6c1737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQzMTA1MQ==", "url": "https://github.com/netty/netty/pull/10571#discussion_r488431051", "bodyText": "I would prefer to keep it as it is so we don't need the logic for calculation in multiple places", "author": "normanmaurer", "createdAt": "2020-09-15T06:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk3ODQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NDY5NQ==", "url": "https://github.com/netty/netty/pull/10571#discussion_r487984695", "bodyText": "I don't think we need to pass the ringFd twice here or submissionQueueRingSize, and we can pass completionQueueRingEntries instead of completionQueueRingSize.\ni.e. number of args can be reduced by 2", "author": "njhill", "createdAt": "2020-09-14T14:39:19Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/Native.java", "diffHunk": "@@ -114,7 +141,11 @@ public static FileDescriptor newBlockingEventFd() {\n         return new FileDescriptor(blockingEventFd());\n     }\n \n-    public static native void ioUringExit(RingBuffer ringBuffer);\n+    public static native void ioUringExit(long submissionQueueArrayAddress, int submissionQueueRingEntries,\n+                                          long submissionQueueRingAddress, int submissionQueueRingSize,\n+                                          int submissionQueueRingFd,\n+                                          long completionQueueRingAddress, int completionQueueRingSize,\n+                                          int completionQueueRingfd);", "originalCommit": "2fcf4905405beba25aa6bef725a023e70a6c1737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyOTE4MQ==", "url": "https://github.com/netty/netty/pull/10571#discussion_r488029181", "bodyText": "I think it would better to pass the ringFd to the RingBuffer", "author": "1Jo1", "createdAt": "2020-09-14T15:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQxODI2Nw==", "url": "https://github.com/netty/netty/pull/10571#discussion_r488418267", "bodyText": "forget it, as sqe and cqe require ring_fd :)", "author": "1Jo1", "createdAt": "2020-09-15T06:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQzMzk3NA==", "url": "https://github.com/netty/netty/pull/10571#discussion_r488433974", "bodyText": "I would prefer to keep it mostly as it is for clarity.", "author": "normanmaurer", "createdAt": "2020-09-15T07:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NDY5NQ=="}], "type": "inlineReview"}, {"oid": "56325b64641137e4f91543a01f419f6723a64166", "url": "https://github.com/netty/netty/commit/56325b64641137e4f91543a01f419f6723a64166", "message": "cleanup", "committedDate": "2020-09-15T07:12:03Z", "type": "commit"}]}