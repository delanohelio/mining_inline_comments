{"pr_number": 10221, "pr_title": "Detect CNAME loops in the CNAME cache while trying to resolve", "pr_createdAt": "2020-04-27T14:22:55Z", "pr_url": "https://github.com/netty/netty/pull/10221", "timeline": [{"oid": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb", "url": "https://github.com/netty/netty/commit/7d28b37a1195a2760f49e4dd3b011a3b59b005eb", "message": "Detect CNAME loops in the CNAME cache while trying to resolve\n\nMotivation:\n\nWe need to detect CNAME loops during lookup the DnsCnameCache as otherwise we may try to follow cnames forever.\n\nModifications:\n\n- Correctly detect CNAME loops in the cache\n- Add unit test\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10220", "committedDate": "2020-04-27T14:20:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg2NDg1Mg==", "url": "https://github.com/netty/netty/pull/10221#discussion_r415864852", "bodyText": "Just code style, so not necessary: I would pack this \"uncommon case\" in a separate method", "author": "franz1981", "createdAt": "2020-04-27T14:33:21Z", "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsResolveContext.java", "diffHunk": "@@ -276,15 +276,48 @@ private static String hostnameWithDot(String name) {\n         return name + '.';\n     }\n \n-    private void internalResolve(String name, Promise<List<T>> promise) {\n-        for (;;) {\n-            // Resolve from cnameCache() until there is no more cname entry cached.\n-            String mapping = cnameCache().get(hostnameWithDot(name));\n-            if (mapping == null) {\n+    // Resolve the final name from the CNAME cache until there is nothing to follow anymore. This also\n+    // guards against loops in the cache but early return once a loop is detected.\n+    private String cnameResolveFromCache(String name) {\n+        DnsCnameCache cnameCache = cnameCache();\n+        String first = cnameCache.get(hostnameWithDot(name));\n+        if (first == null) {\n+            // Nothing in the cache at all\n+            return name;\n+        }\n+\n+        String mapping = cnameCache.get(hostnameWithDot(first));\n+        if (mapping == null) {\n+            // Nothing else to follow, return first match.\n+            return first;\n+        }\n+\n+        if (first.equals(mapping)) {\n+            // Loop detected.... early return.\n+            return first;\n+        }\n+\n+        // Detect loops using a HashSet. We use this as last resort implementation to reduce allocations in the most", "originalCommit": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkzNzcwOQ==", "url": "https://github.com/netty/netty/pull/10221#discussion_r415937709", "bodyText": "@franz1981 done... PTAL again", "author": "normanmaurer", "createdAt": "2020-04-27T15:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg2NDg1Mg=="}], "type": "inlineReview"}, {"oid": "3c0de1ac4c30c4e4975996f92f0d8247aa48bacc", "url": "https://github.com/netty/netty/commit/3c0de1ac4c30c4e4975996f92f0d8247aa48bacc", "message": "Move slow code to extra method", "committedDate": "2020-04-27T15:56:09Z", "type": "commit"}]}