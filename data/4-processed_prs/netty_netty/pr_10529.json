{"pr_number": 10529, "pr_title": "Fix ByteBufUtil.getBytes() incorrectly sharing the array in some cases", "pr_createdAt": "2020-09-03T14:34:57Z", "pr_url": "https://github.com/netty/netty/pull/10529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MDAyNg==", "url": "https://github.com/netty/netty/pull/10529#discussion_r483060026", "bodyText": "How about calling this bytes instead of v?", "author": "hyperxpro", "createdAt": "2020-09-03T15:19:34Z", "path": "buffer/src/main/java/io/netty/buffer/ByteBufUtil.java", "diffHunk": "@@ -906,11 +906,12 @@ public static ByteBuf threadLocalDirectBuffer() {\n         }\n \n         if (buf.hasArray()) {\n-            if (copy || start != 0 || length != capacity) {\n-                int baseOffset = buf.arrayOffset() + start;\n-                return Arrays.copyOfRange(buf.array(), baseOffset, baseOffset + length);\n+            int baseOffset = buf.arrayOffset() + start;\n+            byte[] v = buf.array();", "originalCommit": "a76580bbc673561281613964b65eb8381bc2febb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5NDQ5MQ==", "url": "https://github.com/netty/netty/pull/10529#discussion_r483094491", "bodyText": "I did that for consistency with byte[] v = PlatformDependent.allocateUninitializedArray(length); later in the same method (it's just cut off by GitHub's diff viewer), but sure. I could change both so they're still consistent?", "author": "grahamedgecombe", "createdAt": "2020-09-03T16:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMTE1Mg==", "url": "https://github.com/netty/netty/pull/10529#discussion_r483111152", "bodyText": "bytes or array is a good name IMO. I'm not sure what v means.\nSee \n  \n    \n      netty/buffer/src/main/java/io/netty/buffer/ByteBufUtil.java\n    \n    \n         Line 844\n      in\n      a76580b\n    \n    \n    \n    \n\n        \n          \n           final byte[] array;", "author": "hyperxpro", "createdAt": "2020-09-03T16:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEyNzc1MA==", "url": "https://github.com/netty/netty/pull/10529#discussion_r483127750", "bodyText": "I've renamed it to bytes, along with the existing byte[] v in that method (in a separate commit).", "author": "grahamedgecombe", "createdAt": "2020-09-03T17:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MDAyNg=="}], "type": "inlineReview"}, {"oid": "307253ec0efc5b2dabdd7717523b4271c07ba12d", "url": "https://github.com/netty/netty/commit/307253ec0efc5b2dabdd7717523b4271c07ba12d", "message": "Fix ByteBufUtil.getBytes() incorrectly sharing the array in some cases\n\nMotivation:\n\nIf ByteBufUtil.getBytes() is called with copy=false, it does not\ncorrectly check that the underlying array can be shared in some cases.\n\nIn particular:\n\n* It does not check that the arrayOffset() is zero. This causes it to\n  incorrectly return the underlying array if the other conditions are\n  met. The returned array will be longer than requested, with additional\n  unwanted bytes at its start.\n\n* It assumes that the capacity() of the ByteBuf is equal to the backing\n  array length. This is not true for some types of ByteBuf, such as\n  PooledHeapByteBuf. This causes it to incorrectly return the underlying\n  array if the other conditions are met. The returned array will be\n  longer than requested, with additional unwanted bytes at its end.\n\nModifications:\n\nThis commit fixes the two bugs by:\n\n* Checking that the arrayOffset() is zero before returning the\n  underlying array.\n\n* Comparing the requested length to the underlying array's length,\n  rather than the ByteBuf's capacity, before returning the underlying\n  array.\n\nThis commit also adds a series of test cases for ByteBufUtil.getBytes().\n\nResult:\n\nByteBufUtil.getBytes() now correctly checks whether the underlying array\ncan be shared or not.\n\nThe test cases will ensure the bug is not reintroduced in the future.", "committedDate": "2020-09-03T16:49:26Z", "type": "commit"}, {"oid": "e78d6fdf18d0d6d4d3b7e473cf1be15ba301e915", "url": "https://github.com/netty/netty/commit/e78d6fdf18d0d6d4d3b7e473cf1be15ba301e915", "message": "Rename v to bytes for consistency", "committedDate": "2020-09-03T16:49:48Z", "type": "commit"}, {"oid": "e78d6fdf18d0d6d4d3b7e473cf1be15ba301e915", "url": "https://github.com/netty/netty/commit/e78d6fdf18d0d6d4d3b7e473cf1be15ba301e915", "message": "Rename v to bytes for consistency", "committedDate": "2020-09-03T16:49:48Z", "type": "forcePushed"}]}