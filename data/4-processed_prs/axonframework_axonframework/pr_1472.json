{"pr_number": 1472, "pr_title": "[#1442] Use UPDATE query on storing a token", "pr_createdAt": "2020-07-23T09:30:44Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1472", "timeline": [{"oid": "a5ce813f27d6edfc8a748b9aa5f022b8afed414a", "url": "https://github.com/AxonFramework/AxonFramework/commit/a5ce813f27d6edfc8a748b9aa5f022b8afed414a", "message": "Add another getOrDefault method\n\nAdd another getOrDefault method which allows the provisioning of a\nFunction ingesting the verified instance. Alongside that, fine tune\njavadoc a little\n\n#1442", "committedDate": "2020-07-22T14:01:34Z", "type": "commit"}, {"oid": "bb2a0492a36cdf38458ef14c10e7aefec5842996", "url": "https://github.com/AxonFramework/AxonFramework/commit/bb2a0492a36cdf38458ef14c10e7aefec5842996", "message": "Adjust getTokenType method\n\nMake getTokenType public so that it can be accessed elsewhere.\nAdditionally, check if the set tokenType is null and return null if this\n is the case. Otherwise an exception wil be thrown by the\n SimpleSerializedType constructor\n\n#1442", "committedDate": "2020-07-22T14:02:57Z", "type": "commit"}, {"oid": "2535bc28dc7e20b814b0489ab953878f9a999a30", "url": "https://github.com/AxonFramework/AxonFramework/commit/2535bc28dc7e20b814b0489ab953878f9a999a30", "message": "Introduce update query on storing a token\n\nIntroduce an update query on storing a token. If the update does no\nsucceed, fallback to the old behaviour of fetching the token with a new\nclaim, and than updating it.\n\n#1442", "committedDate": "2020-07-22T14:03:51Z", "type": "commit"}, {"oid": "2cecc4d201dca4e5d70606ec579fac243716a42f", "url": "https://github.com/AxonFramework/AxonFramework/commit/2cecc4d201dca4e5d70606ec579fac243716a42f", "message": "Introduce update query on storing a token\n\nIntroduce an update query on storing a token. If the update does no\nsucceed, fallback to the old behaviour of fetching the token with a new\nclaim, and than updating it. Add the creation of the PreparedStatement\nto a protected method, so that users are able to override it.\n\n#1442", "committedDate": "2020-07-22T14:04:24Z", "type": "commit"}, {"oid": "7924fd6f77ab5ec7951f108142ea352489703838", "url": "https://github.com/AxonFramework/AxonFramework/commit/7924fd6f77ab5ec7951f108142ea352489703838", "message": "Merge remote-tracking branch 'origin/master' into feature/1442", "committedDate": "2020-07-23T11:24:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MjUyMg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1472#discussion_r460092522", "bodyText": "Is it useful to log.debug for example when it happens?", "author": "lfgcampos", "createdAt": "2020-07-24T14:35:24Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/tokenstore/jpa/JpaTokenStore.java", "diffHunk": "@@ -118,8 +118,31 @@ public void initializeTokenSegments(String processorName, int segmentCount, Trac\n     @Override\n     public void storeToken(TrackingToken token, String processorName, int segment) {\n         EntityManager entityManager = entityManagerProvider.getEntityManager();\n-        TokenEntry tokenEntry = loadToken(processorName, segment, entityManager);\n-        tokenEntry.updateToken(token, serializer);\n+        TokenEntry tokenToStore = new TokenEntry(processorName, segment, token, serializer);\n+        byte[] tokenDataToStore =\n+                getOrDefault(tokenToStore.getSerializedToken(), SerializedObject::getData, new byte[0]);\n+        String tokenTypeToStore = getOrDefault(tokenToStore.getTokenType(), SerializedType::getName, null);\n+\n+        int updatedTokens = entityManager.createQuery(\"UPDATE TokenEntry te SET \"\n+                                                              + \"te.token = :token, \"\n+                                                              + \"te.tokenType = :tokenType, \"\n+                                                              + \"te.timestamp = :timestamp \"\n+                                                              + \"WHERE te.owner = :owner \"\n+                                                              + \"AND te.processorName = :processorName \"\n+                                                              + \"AND te.segment = :segment\")\n+                                         .setParameter(\"token\", tokenDataToStore)\n+                                         .setParameter(\"tokenType\", tokenTypeToStore)\n+                                         .setParameter(\"timestamp\", tokenToStore.timestampAsString())\n+                                         .setParameter(\"owner\", nodeId)\n+                                         .setParameter(\"processorName\", processorName)\n+                                         .setParameter(\"segment\", segment)\n+                                         .executeUpdate();\n+\n+        if (updatedTokens == 0) {\n+            // Update couldn't succeed, trying to first load the token and than update it instead.", "originalCommit": "7924fd6f77ab5ec7951f108142ea352489703838", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg1NTY3Mw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1472#discussion_r460855673", "bodyText": "Sure thing, added!", "author": "smcvb", "createdAt": "2020-07-27T12:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MjUyMg=="}], "type": "inlineReview"}, {"oid": "a841630bea59adf47d196fcd1ed09ead8e081d1d", "url": "https://github.com/AxonFramework/AxonFramework/commit/a841630bea59adf47d196fcd1ed09ead8e081d1d", "message": "Replace comment for debug logging\n\nReplace comment for debug logging, as that's clearer for the developers\nand users\n\n#1442", "committedDate": "2020-07-27T08:10:37Z", "type": "commit"}, {"oid": "869659b7de2429dd1c9dd3c352cfb749f9b708d6", "url": "https://github.com/AxonFramework/AxonFramework/commit/869659b7de2429dd1c9dd3c352cfb749f9b708d6", "message": "Add and use executeUpdate method\n\nInstead of using the JdbcUtils#executeUpdates method in the\nJdbcTokenStore, we should add an JdbcUtils#executeUpdate method and use\nthat instead.\n\n#1442", "committedDate": "2020-07-27T12:28:28Z", "type": "commit"}]}