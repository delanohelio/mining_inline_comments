{"pr_number": 1306, "pr_title": "[#680]  Expect Scheduled Deadline based on Deadline name", "pr_createdAt": "2020-01-03T13:27:27Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1306", "timeline": [{"oid": "443ef225b7e18ee552c151af22207362b742a7fa", "url": "https://github.com/AxonFramework/AxonFramework/commit/443ef225b7e18ee552c151af22207362b742a7fa", "message": "Implement expectScheduledDeadlineWithName\n\nFor aggregate test fixtures it is beneficial to be able to test whether\na deadline for a given name has been scheduled. This is necessary in the\n scenario no payload has been used when scheduling\n\n#680", "committedDate": "2020-01-03T13:04:44Z", "type": "commit"}, {"oid": "3bd69b086fd29a1bfe7b6918fbf49d296db35839", "url": "https://github.com/AxonFramework/AxonFramework/commit/3bd69b086fd29a1bfe7b6918fbf49d296db35839", "message": "Resolve warnings\n\nResolve the warnings the IDE gives tells us about\n\n#680", "committedDate": "2020-01-03T13:05:10Z", "type": "commit"}, {"oid": "11ac23b445a17322b73ec6194419a254d3e02eb0", "url": "https://github.com/AxonFramework/AxonFramework/commit/11ac23b445a17322b73ec6194419a254d3e02eb0", "message": "Implement tests for the expectScheduledDeadlineWithName\n\nAdd a test case to validate the correct workings of the\nexpectScheduledDeadlineWithName method. Additionally, clean up the test\nclass slightly, by adding constants, removing warnings and adding\njavadoc\n\n#680", "committedDate": "2020-01-03T13:07:05Z", "type": "commit"}, {"oid": "24da071cd6ff7b6c9b828d58cf33c811b3dc594a", "url": "https://github.com/AxonFramework/AxonFramework/commit/24da071cd6ff7b6c9b828d58cf33c811b3dc594a", "message": "Implement expectScheduledDeadlineWithName\n\nFor saga test fixtures it is beneficial to be able to test whether\na deadline for a given name has been scheduled. This is necessary in the\nscenario no payload has been used when scheduling\n\n#680", "committedDate": "2020-01-03T13:20:36Z", "type": "commit"}, {"oid": "87b3217a985e607ebaba4e895f9478af95a6405a", "url": "https://github.com/AxonFramework/AxonFramework/commit/87b3217a985e607ebaba4e895f9478af95a6405a", "message": "Implement tests for the expectScheduledDeadlineWithName\n\nAdd a test case to validate the correct workings of the\nexpectScheduledDeadlineWithName method. Additionally, clean up the test\nclass slightly, by adding constants, removing warnings and adding\njavadoc\n\n#680", "committedDate": "2020-01-03T13:21:10Z", "type": "commit"}, {"oid": "76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "url": "https://github.com/AxonFramework/AxonFramework/commit/76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "message": "Merge branch 'feature/1050' into feature/680", "committedDate": "2020-01-03T15:07:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzMzUxMA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363233510", "bodyText": "Should be @code scheduledTime\nAlso the wording for it might change a bit since this is the expected time for the deadline and not the duration anymore.", "author": "lfgcampos", "createdAt": "2020-01-06T10:17:55Z", "path": "test/src/main/java/org/axonframework/test/aggregate/ResultValidator.java", "diffHunk": "@@ -249,6 +256,15 @@\n      */\n     ResultValidator<T> expectScheduledDeadlineOfType(Instant scheduledTime, Class<?> deadlineType);\n \n+    /**\n+     * Asserts that a deadline with the given {@code deadlineName} has been scheduled after the given {@code duration}.", "originalCommit": "76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMxMDc4Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363310782", "bodyText": "Good catch, thanks for that! Will update this line of javadoc accordingly.", "author": "smcvb", "createdAt": "2020-01-06T14:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzMzUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzNDM0NA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363234344", "bodyText": "Should be @code scheduledTime\nAlso the wording for it might change a bit since this is the expected time for the deadline and not the duration anymore.", "author": "lfgcampos", "createdAt": "2020-01-06T10:20:04Z", "path": "test/src/main/java/org/axonframework/test/saga/FixtureExecutionResult.java", "diffHunk": "@@ -209,6 +218,15 @@ FixtureExecutionResult expectScheduledDeadlineMatching(Instant scheduledTime,\n      */\n     FixtureExecutionResult expectScheduledDeadlineOfType(Instant scheduledTime, Class<?> deadlineType);\n \n+    /**\n+     * Asserts that a deadline with the given {@code deadlineName} has been scheduled after the given {@code duration}.", "originalCommit": "76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMxMTQ3Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363311472", "bodyText": "Good catch, thanks for that! Will update this line of javadoc accordingly.", "author": "smcvb", "createdAt": "2020-01-06T14:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzNDM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzODg0Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363238842", "bodyText": "Tests for the Instant scheduledTime option are needed as well?", "author": "lfgcampos", "createdAt": "2020-01-06T10:32:05Z", "path": "test/src/test/java/org/axonframework/test/aggregate/FixtureTest_Deadlines.java", "diffHunk": "@@ -44,61 +50,68 @@ void setUp() {\n     @Test\n     void testDeadlineScheduling() {\n         fixture.givenNoPriorActivity()\n-               .when(new CreateMyAggregateCommand(\"id\"))\n+               .when(CREATE_COMMAND)\n                .expectScheduledDeadline(Duration.ofMinutes(TRIGGER_DURATION_MINUTES), \"deadlineDetails\");\n     }\n \n     @Test\n     void testDeadlineSchedulingTypeMatching() {\n         fixture.givenNoPriorActivity()\n-               .when(new CreateMyAggregateCommand(\"id\"))\n+               .when(CREATE_COMMAND)\n                .expectScheduledDeadlineOfType(Duration.ofMinutes(TRIGGER_DURATION_MINUTES), String.class);\n     }\n \n+    @Test\n+    void testDeadlineSchedulingNameMatching() {\n+        fixture.given(new MyAggregateCreatedEvent(AGGREGATE_ID, \"deadlineName\", \"deadlineId\"))\n+               .when(new SetPayloadlessDeadlineCommand(AGGREGATE_ID))\n+               .expectScheduledDeadlineWithName(Duration.ofMinutes(TRIGGER_DURATION_MINUTES), \"payloadless-deadline\");", "originalCommit": "76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMxMjU1Ng==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363312556", "bodyText": "Good argument! Something I was initially thinking about as well, but decided against because the DeadlineManagerValidator class (used under the hood to actually perform the expectScheduledDeadline... methods) calls the DeadlineManagerValidator#assertScheduledDeadlineMatching(Instant, Matcher<?>) in the DeadlineManagerValidator#assertScheduledDeadlineMatching(Duration, Matcher<?>) method.\nThus, tests which validate the expect methods using Duration, will always end up doing a validation with Instant.\nI am assuming this was @m1l4n54v1c initial take on only providing tests for the expect methods using Duration too, hence why I stuck with it too.\nFine with adding the other set though, shouldn't be that big a deal.\nOr, maybe @m1l4n54v1c has a changed opinion on this part at the moment, justifying tests for the expect-with-instant methods too.", "author": "smcvb", "createdAt": "2020-01-06T14:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzODg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzOTAzMw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363239033", "bodyText": "Tests for the Instant scheduledTime option are needed as well?", "author": "lfgcampos", "createdAt": "2020-01-06T10:32:41Z", "path": "test/src/test/java/org/axonframework/test/saga/FixtureTest_Deadlines.java", "diffHunk": "@@ -57,15 +60,26 @@ void testDeadlineScheduling() {\n     @Test\n     void testDeadlineSchedulingTypeMatching() {\n         fixture.givenNoPriorActivity()\n-               .whenAggregate(\"id\").publishes(new TriggerSagaStartEvent(\"id\"))\n+               .whenAggregate(AGGREGATE_ID)\n+               .publishes(START_SAGA_EVENT)\n                .expectActiveSagas(1)\n                .expectScheduledDeadlineOfType(Duration.ofMinutes(TRIGGER_DURATION_MINUTES), String.class)\n                .expectNoScheduledEvents();\n     }\n \n+    @Test\n+    void testDeadlineSchedulingNameMatching() {\n+        fixture.givenAggregate(AGGREGATE_ID)\n+               .published(START_SAGA_EVENT)\n+               .whenAggregate(AGGREGATE_ID)\n+               .publishes(new PayloadlessDeadlineShouldBeSetEvent(AGGREGATE_ID))\n+               .expectScheduledDeadlineWithName(Duration.ofMinutes(TRIGGER_DURATION_MINUTES), \"payloadless-deadline\");", "originalCommit": "76dc02f53deec40d19a1c3fe3d77e42ea9aac3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMxMjY3NA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1306#discussion_r363312674", "bodyText": "Good argument! Something I was initially thinking about as well, but decided against because the DeadlineManagerValidator class (used under the hood to actually perform the expectScheduledDeadline... methods) calls the DeadlineManagerValidator#assertScheduledDeadlineMatching(Instant, Matcher<?>) in the DeadlineManagerValidator#assertScheduledDeadlineMatching(Duration, Matcher<?>) method.\nThus, tests which validate the expect methods using Duration, will always end up doing a validation with Instant.\nI am assuming this was @m1l4n54v1c initial take on only providing tests for the expect methods using Duration too, hence why I stuck with it too.\nFine with adding the other set though, shouldn't be that big a deal.\nOr, maybe @m1l4n54v1c has a changed opinion on this part at the moment, justifying tests for the expect-with-instant methods too.", "author": "smcvb", "createdAt": "2020-01-06T14:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIzOTAzMw=="}], "type": "inlineReview"}, {"oid": "e90ba4235f981f8d2c43cba8514547a0b15d31a4", "url": "https://github.com/AxonFramework/AxonFramework/commit/e90ba4235f981f8d2c43cba8514547a0b15d31a4", "message": "Merge branch 'feature/1050' into feature/680", "committedDate": "2020-01-06T14:15:07Z", "type": "commit"}, {"oid": "d71c15d3cf486ac45cc9aa7cbe374e5fde4f8f91", "url": "https://github.com/AxonFramework/AxonFramework/commit/d71c15d3cf486ac45cc9aa7cbe374e5fde4f8f91", "message": "Resolve javadoc typos\n\nResolve javadoc typos\n\n#680", "committedDate": "2020-01-06T14:22:48Z", "type": "commit"}]}