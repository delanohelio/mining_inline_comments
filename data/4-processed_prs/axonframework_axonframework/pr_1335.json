{"pr_number": 1335, "pr_title": "[#1253] Expose 'merging status' in Tracking Processor status", "pr_createdAt": "2020-01-31T16:16:47Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1335", "timeline": [{"oid": "92e42a0298cb947bb894ec0c41ee24d5d51dab58", "url": "https://github.com/AxonFramework/AxonFramework/commit/92e42a0298cb947bb894ec0c41ee24d5d51dab58", "message": "expose merge operation info on an EventTrackerStatus", "committedDate": "2020-01-30T14:26:42Z", "type": "commit"}, {"oid": "93ceb29463e5d33492c533a1928ac34f0e4a828d", "url": "https://github.com/AxonFramework/AxonFramework/commit/93ceb29463e5d33492c533a1928ac34f0e4a828d", "message": "introduce mergeCompletedPosition in EventTrackerStatus", "committedDate": "2020-01-31T16:05:52Z", "type": "commit"}, {"oid": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "url": "https://github.com/AxonFramework/AxonFramework/commit/7092083292cb15843ec2e5fa29ce892bb14e2c32", "message": "add minor fix after failing CI built", "committedDate": "2020-01-31T16:38:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MDgzMg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r373990832", "bodyText": "This gives the upper most position when merging should be resolved, but don't we also need the lowest point of the existing tokens?\nIt's those two numbers which can give us the \"merging progress\", quite similar to exposing the replayPosition and tokenAtResetPosition.", "author": "smcvb", "createdAt": "2020-02-03T09:16:27Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/MergedTrackingToken.java", "diffHunk": "@@ -76,6 +76,38 @@ protected MergedTrackingToken(TrackingToken lowerSegmentToken, TrackingToken upp\n         this.upperSegmentAdvanced = upperSegmentAdvanced;\n     }\n \n+    /**\n+     * Indicates whether the given {@code trackingToken} represents a position that is part of a merge.\n+     *\n+     * @param trackingToken The token to verify\n+     * @return {@code true} if the token indicates a merge\n+     */\n+    public static boolean isMergeInProgress(TrackingToken trackingToken) {\n+        return WrappedToken.unwrap(trackingToken, MergedTrackingToken.class).isPresent();\n+    }\n+\n+    /**\n+     * Return the estimated relative token position this Segment will have after a merge operation is complete.\n+     * In case no estimation can be given or no merge in progress, an {@code OptionalLong.empty()} will be returned.\n+     *\n+     * @return return the estimated relative position this Segment will reach after a merge operation is complete.\n+     */\n+    public static OptionalLong mergePosition(TrackingToken trackingToken) {", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MTUyNA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r373991524", "bodyText": "Added, I am not overly pleased with the name of this method, but haven't landed on something satisfying either...\nI can only think in terms of \"upper most token\" and \"lowest token\", which would suggest that this method would be renamed to upperMergePosition/upperMergingPosition and the other would be lowestMergePosition/lowestMergingPosition.\nWhat do you think?", "author": "smcvb", "createdAt": "2020-02-03T09:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MDgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NjE0Nw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374566147", "bodyText": "I believe this issue has been covered in the other discussion around sharing a regular getPosition method to be used for both replaying and merging, with a dedicated finish-line-position method. Hence I'll resolve this conversation.", "author": "smcvb", "createdAt": "2020-02-04T09:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MDgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MTgxMQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r373991811", "bodyText": "I am not overly pleased with the name of this method, but haven't landed on something satisfying either...\nI can only think in terms of \"upper most token\" and \"lowest token\", which would suggest that this method would be renamed to upperMergePosition/upperMergingPosition and the other would be lowestMergePosition/lowestMergingPosition.\nWhat do you think?", "author": "smcvb", "createdAt": "2020-02-03T09:18:50Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/EventTrackerStatus.java", "diffHunk": "@@ -49,6 +51,21 @@\n      */\n     boolean isReplaying();\n \n+    /**\n+     * Indicates whether this Segment is still merging events.\n+     *\n+     * @return {@code true} if this segment is merging events, otherwise {@code false}\n+     */\n+    boolean isMerging();\n+\n+    /**\n+     * Return the estimated relative token position this Segment will have after a merge operation is complete.\n+     * In case no estimation can be given or no merge in progress, an {@code OptionalLong.empty()} will be returned.\n+     *\n+     * @return return the estimated relative position this Segment will reach after a merge operation is complete.\n+     */\n+    OptionalLong mergeCompletedPosition();", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA4ODU2Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374088562", "bodyText": "I'm not happy with the name too, but didn't found nothing that fits better.\nFrom a user perspective upperMergePosition doen't provide the same information as merceCompletedPosition, in my opinion.\nLet's think about it for a while.", "author": "corradom", "createdAt": "2020-02-03T13:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEyNDA0Mw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374124043", "bodyText": "We discussed with @abuijze on this: from this comment https://github.com/AxonFramework/AxonFramework/pull/1330/files#r372591669 on another PR I think we can then have a method called currentPosition that exposes the estimation current tracking token position if available.\nIn addition to this we will have specific replay/merge method suck has\nmergeCompletedPosition() : estimated relative token position this Segment will have after a merge operation is complete\nisMerging() : Indicates whether this Segment is still merging events\nisReplaying() : Indicates whether this Segment is still replaying previously processed Events\ngetResetPosition() :  the relative position at which a reset was triggered for this Segment\nSo currentPosition will promote and expose TrackinToken.position() method and return\n\nthe estimated relative replay position this Segment represents (in case of Replay)\nthe estimated relative merge position this Segment represents (in case of merge)\nOptionalLong.empty() for all the other case\n\nwhat do you think?", "author": "corradom", "createdAt": "2020-02-03T14:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4OTc3NQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374189775", "bodyText": "That sounds like a great idea! Think my comment has been overruled by this \ud83d\udc4d", "author": "smcvb", "createdAt": "2020-02-03T16:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MTgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0MzQ1NA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374543454", "bodyText": "Nit: Maybe use a named variable for 0 called segmentId. I know what happens here, but on face value it's a magic number I think.", "author": "smcvb", "createdAt": "2020-02-04T08:58:11Z", "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventhandling/TrackingEventProcessorTest.java", "diffHunk": "@@ -966,8 +966,14 @@ void testMergeSegments() throws InterruptedException {\n         }\n \n         assertTrue(testSubject.mergeSegment(0).join(), \"Expected merge to succeed\");", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0NDExOQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374544119", "bodyText": "I have the same segmentId variable suggestion here :-)", "author": "smcvb", "createdAt": "2020-02-04T08:59:28Z", "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventhandling/TrackingEventProcessorTest.java", "diffHunk": "@@ -983,10 +989,17 @@ void testMergeSegments_BothClaimedByProcessor() throws Exception {\n         testSubject.start();\n         waitForActiveThreads(2);\n \n+        assertFalse(testSubject.processingStatus().get(0).isMerging());", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzMDEwMg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r375130102", "bodyText": "You can also use the ``segmentId` variable on this line! ^_^", "author": "smcvb", "createdAt": "2020-02-05T09:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0NDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1OTkzMg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374559932", "bodyText": "Why not check that after this mergeSegment call that the status isMerging returns true?", "author": "smcvb", "createdAt": "2020-02-04T09:31:53Z", "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventhandling/TrackingEventProcessorTest.java", "diffHunk": "@@ -1065,6 +1083,8 @@ void testDoubleSplitAndMerge() throws Exception {\n \n         waitForProcessingStatus(0, EventTrackerStatus::isCaughtUp);\n \n+        assertFalse(testSubject.processingStatus().get(0).isMerging());\n+\n         assertTrue(testSubject.mergeSegment(0).join(), \"Expected merge to succeed\");", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4ODMxMw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r375388313", "bodyText": "due to a race condition is really hard to test this into this particular test case. Most of the time the test will fail.\nWe will think about a better strategy to avoid this race condition that occurs from time to time also in CI env.", "author": "corradom", "createdAt": "2020-02-05T17:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1OTkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2MDI0MA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374560240", "bodyText": "Super nit: unnecessary empty line.", "author": "smcvb", "createdAt": "2020-02-04T09:32:31Z", "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventhandling/TrackingEventProcessorTest.java", "diffHunk": "@@ -1277,6 +1299,8 @@ void testMergeWithSingleSegmentRejected() throws InterruptedException {\n         CompletableFuture<Boolean> actual = testSubject.mergeSegment(0);\n \n         assertFalse(actual.join(), \"Expected merge to be rejected\");\n+        waitForProcessingNotInStatus(0, EventTrackerStatus::isMerging);\n+", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2MTY1NA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374561654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Indicates whether this Segment is still merging events.\n          \n          \n            \n                 * Indicates whether this Segment is still merging two (or more) Segments. The merging process will be done once all Segments have reached the same position.", "author": "smcvb", "createdAt": "2020-02-04T09:35:26Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/EventTrackerStatus.java", "diffHunk": "@@ -49,6 +51,21 @@\n      */\n     boolean isReplaying();\n \n+    /**\n+     * Indicates whether this Segment is still merging events.", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2MTc5MA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374561790", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return {@code true} if this segment is merging events, otherwise {@code false}\n          \n          \n            \n                 * @return {@code true} if this segment is merging Segments, otherwise {@code false}", "author": "smcvb", "createdAt": "2020-02-04T09:35:42Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/EventTrackerStatus.java", "diffHunk": "@@ -49,6 +51,21 @@\n      */\n     boolean isReplaying();\n \n+    /**\n+     * Indicates whether this Segment is still merging events.\n+     *\n+     * @return {@code true} if this segment is merging events, otherwise {@code false}", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NDYzMA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374564630", "bodyText": "I have a naming suggestion for this method. What about we call it the mergingFinishPosition or ``mergingGoalPosition`?\nI was thinking about what this field represent, and that's essentially the \"finish line when merging will be resolved\".", "author": "smcvb", "createdAt": "2020-02-04T09:41:28Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/EventTrackerStatus.java", "diffHunk": "@@ -49,6 +51,21 @@\n      */\n     boolean isReplaying();\n \n+    /**\n+     * Indicates whether this Segment is still merging events.\n+     *\n+     * @return {@code true} if this segment is merging events, otherwise {@code false}\n+     */\n+    boolean isMerging();\n+\n+    /**\n+     * Return the estimated relative token position this Segment will have after a merge operation is complete.\n+     * In case no estimation can be given or no merge in progress, an {@code OptionalLong.empty()} will be returned.\n+     *\n+     * @return return the estimated relative position this Segment will reach after a merge operation is complete.\n+     */\n+    OptionalLong mergeCompletedPosition();", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3NTk5OQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r375875999", "bodyText": "After a quick round of consultations, the team decided to stick with my proposal mergeCompletedPosition()", "author": "corradom", "createdAt": "2020-02-06T14:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NDYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NTYxNQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374565615", "bodyText": "Suggestion: might be nice to mention on this piece of javadoc that this method will return a non-empty result as long as isMerging returns true.", "author": "smcvb", "createdAt": "2020-02-04T09:43:23Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/EventTrackerStatus.java", "diffHunk": "@@ -49,6 +51,21 @@\n      */\n     boolean isReplaying();\n \n+    /**\n+     * Indicates whether this Segment is still merging events.\n+     *\n+     * @return {@code true} if this segment is merging events, otherwise {@code false}\n+     */\n+    boolean isMerging();\n+\n+    /**\n+     * Return the estimated relative token position this Segment will have after a merge operation is complete.\n+     * In case no estimation can be given or no merge in progress, an {@code OptionalLong.empty()} will be returned.\n+     *", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3NzUxNw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r376277517", "bodyText": "Think this line could still be added? \ud83d\udc7c", "author": "smcvb", "createdAt": "2020-02-07T08:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NTYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI4MTE2Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r376281162", "bodyText": "Oh sorry I forgot to reply this one \ud83e\udd26\u200d\u2642\ufe0f\nI feel that is not completely true : a segment can return true for isMerging(), but will return OptionalLong.empty() in case no estimation can be given.", "author": "corradom", "createdAt": "2020-02-07T09:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NTYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU2NjQyNA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1335#discussion_r374566424", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Indicates whether the given {@code trackingToken} represents a position that is part of a merge.\n          \n          \n            \n                 * Indicates whether the given {@code trackingToken} represents a token that is part of a merge.", "author": "smcvb", "createdAt": "2020-02-04T09:44:56Z", "path": "messaging/src/main/java/org/axonframework/eventhandling/MergedTrackingToken.java", "diffHunk": "@@ -76,6 +76,38 @@ protected MergedTrackingToken(TrackingToken lowerSegmentToken, TrackingToken upp\n         this.upperSegmentAdvanced = upperSegmentAdvanced;\n     }\n \n+    /**\n+     * Indicates whether the given {@code trackingToken} represents a position that is part of a merge.", "originalCommit": "7092083292cb15843ec2e5fa29ce892bb14e2c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04a16133b364acd927990ea7f442b506248a203a", "url": "https://github.com/AxonFramework/AxonFramework/commit/04a16133b364acd927990ea7f442b506248a203a", "message": "Apply suggestions from code review\n\nCo-Authored-By: Steven van Beelen <steven.vanbeelen@axoniq.io>", "committedDate": "2020-02-04T15:22:17Z", "type": "commit"}, {"oid": "129dda9218ce8ecda921d9cc82cda59c2342c4d7", "url": "https://github.com/AxonFramework/AxonFramework/commit/129dda9218ce8ecda921d9cc82cda59c2342c4d7", "message": "Apply suggestions from code review", "committedDate": "2020-02-04T17:10:17Z", "type": "commit"}, {"oid": "493aff656859172cc91d3f808164f134d3ed2538", "url": "https://github.com/AxonFramework/AxonFramework/commit/493aff656859172cc91d3f808164f134d3ed2538", "message": "Merge remote-tracking branch 'origin/master' into improve/expose-merge-info", "committedDate": "2020-02-05T15:56:54Z", "type": "commit"}, {"oid": "f4de6251dd015cce5614b9182981a586c8287627", "url": "https://github.com/AxonFramework/AxonFramework/commit/f4de6251dd015cce5614b9182981a586c8287627", "message": "minor suggestions from code review", "committedDate": "2020-02-06T14:44:54Z", "type": "commit"}, {"oid": "e95315018c6dd959ba78a6b67fe981d5367582fb", "url": "https://github.com/AxonFramework/AxonFramework/commit/e95315018c6dd959ba78a6b67fe981d5367582fb", "message": "improve javadoc", "committedDate": "2020-02-07T10:23:29Z", "type": "commit"}]}