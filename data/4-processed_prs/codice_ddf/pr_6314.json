{"pr_number": 6314, "pr_title": "[2.25.x] DDF-6313 Address SonarQube findings in LogoutRequestService", "pr_createdAt": "2020-09-10T18:42:07Z", "pr_url": "https://github.com/codice/ddf/pull/6314", "timeline": [{"oid": "14d347adeb221eb5b1e2d61eae7a78560602cf89", "url": "https://github.com/codice/ddf/commit/14d347adeb221eb5b1e2d61eae7a78560602cf89", "message": "DDF-6313 Address SonarQube findings in LogoutRequestService", "committedDate": "2020-09-10T18:38:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NTU3MQ==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486645571", "bodyText": "\u2753 The two different logoutMessage == null checks return different responses. Why an error for the other and not here?", "author": "SmithJosh", "createdAt": "2020-09-10T21:32:07Z", "path": "platform/security/handler/security-handler-saml/src/main/java/org/codice/ddf/security/idp/client/LogoutRequestService.java", "diffHunk": "@@ -204,7 +204,8 @@ public Response sendLogoutRequest(@QueryParam(\"EncryptedNameIdTime\") String encr\n \n         logout();\n         if (logoutMessage == null) {\n-          throw new RuntimeException(\"Logout message not available yet.\");\n+          LOGGER.info(\"Logout message not available yet\");\n+          return buildLogoutResponse(UNABLE_TO_CREATE_LOGOUT_REQUEST);", "originalCommit": "14d347adeb221eb5b1e2d61eae7a78560602cf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2ODE2OA==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486668168", "bodyText": "I wasn't sure what to do here. In the sendLogoutRequest method, buildLogoutResponse(\"some message\") is returned in error cases. In the soapLogoutRequest method, Response.serverError().build() is returned in error cases.\nWhat do you think would be the best to return in these 2 places?", "author": "emmberk", "createdAt": "2020-09-10T22:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NTU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4MTcwMg==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486681702", "bodyText": "I had to look how those endpoints are used again. sendLogoutRequest is the logout action endpoint where we redirect users for a SAML logout, so it makes sense to return a redirect. soapLogoutRequest is the SLO endpoint which is where the SAML IdP sends LogoutRequests, and returning a redirect to the IdP doesn't make sense.\nAll that to say I think it's fine like you have it \ud83d\ude04", "author": "SmithJosh", "createdAt": "2020-09-10T23:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NTU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NzUwOA==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486647508", "bodyText": "\u2753 Why static (same question for the build logout response methods)?", "author": "SmithJosh", "createdAt": "2020-09-10T21:36:33Z", "path": "platform/security/handler/security-handler-saml/src/main/java/org/codice/ddf/security/idp/client/LogoutRequestService.java", "diffHunk": "@@ -580,16 +572,14 @@ private void logout() {\n \n   private void logSecurityAuditRole() {\n     Element idpSecToken = getIdpSecurityToken();\n-    if (idpSecToken != null) {\n-      if (shouldAuditSubject(idpSecToken)) {\n-        securityLogger.audit(\n-            \"Subject with admin privileges has logged out: {}\",\n-            new SecurityAssertionSaml(idpSecToken).getPrincipal().getName());\n-      }\n+    if (idpSecToken != null && shouldAuditSubject(idpSecToken)) {\n+      securityLogger.audit(\n+          \"Subject with admin privileges has logged out: {}\",\n+          new SecurityAssertionSaml(idpSecToken).getPrincipal().getName());\n     }\n   }\n \n-  private boolean shouldAuditSubject(Element idpSecToken) {\n+  private static boolean shouldAuditSubject(Element idpSecToken) {", "originalCommit": "14d347adeb221eb5b1e2d61eae7a78560602cf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2ODY2Mg==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486668662", "bodyText": "That's just a style preference. I like using static for helper methods because it indicates that no instance variables are being used.", "author": "emmberk", "createdAt": "2020-09-10T22:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NzUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzgzMw==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r486707833", "bodyText": "I know we didn't do it before but we should verify that encodedSamlRequest != null here", "author": "blen-desta", "createdAt": "2020-09-11T00:39:32Z", "path": "platform/security/handler/security-handler-saml/src/main/java/org/codice/ddf/security/idp/client/LogoutRequestService.java", "diffHunk": "@@ -422,33 +424,29 @@ public Response postLogoutRequest(\n         LOGGER.info(UNABLE_TO_VALIDATE_LOGOUT_REQUEST, e);\n         return buildLogoutResponse(UNABLE_TO_VALIDATE_LOGOUT_REQUEST);\n       }\n-    } else {\n-      try {\n-        LogoutWrapper<LogoutResponse> logoutResponse =\n-            logoutMessage.extractSamlLogoutResponse(samlSecurity.base64Decode(encodedSamlResponse));\n-        if (logoutResponse == null) {\n-          LOGGER.info(UNABLE_TO_PARSE_LOGOUT_RESPONSE);\n-          return buildLogoutResponse(UNABLE_TO_PARSE_LOGOUT_RESPONSE);\n-        }\n-        new SamlValidator.Builder(simpleSign)\n-            .buildAndValidate(\n-                request.getRequestURL().toString(),\n-                SamlProtocol.Binding.HTTP_POST,\n-                logoutResponse.getMessage());\n-      } catch (ValidationException e) {\n-        LOGGER.info(UNABLE_TO_VALIDATE_LOGOUT_RESPONSE, e);\n-        return buildLogoutResponse(UNABLE_TO_VALIDATE_LOGOUT_RESPONSE);\n-      } catch (LogoutSecurityException | XMLStreamException e) {\n-        LOGGER.info(UNABLE_TO_PARSE_LOGOUT_RESPONSE, e);\n+    }\n+\n+    try {\n+      LogoutWrapper<LogoutResponse> logoutResponse =\n+          logoutMessage.extractSamlLogoutResponse(samlSecurity.base64Decode(encodedSamlResponse));", "originalCommit": "14d347adeb221eb5b1e2d61eae7a78560602cf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MDgyMQ==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r487170821", "bodyText": "Just pushed a commit, but I'm not sure I returned the right response. Does it look right to you?\nif (encodedSamlResponse == null) {\n  return Response.serverError().entity(SYSTEM_CANNOT_DECODE_REQUEST).build();\n}", "author": "emmberk", "createdAt": "2020-09-11T16:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNzU5Nw==", "url": "https://github.com/codice/ddf/pull/6314#discussion_r488107597", "bodyText": "I updated the message\nif (encodedSamlResponse == null) {\n  return Response.serverError()\n      .entity(\"System did not receive a SAMLRequest or a SAMLResponse to process\")\n      .build();\n}", "author": "emmberk", "createdAt": "2020-09-14T17:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzgzMw=="}], "type": "inlineReview"}, {"oid": "81fc7e668eea2046883b9ea2ebc1e5c02144e719", "url": "https://github.com/codice/ddf/commit/81fc7e668eea2046883b9ea2ebc1e5c02144e719", "message": "Check that encodedSamlResponse != null in postLogoutRequest", "committedDate": "2020-09-11T16:53:56Z", "type": "commit"}, {"oid": "eaf9624ff7323f381e7ef28756464b08050f7b8c", "url": "https://github.com/codice/ddf/commit/eaf9624ff7323f381e7ef28756464b08050f7b8c", "message": "Improve error message", "committedDate": "2020-09-14T17:34:22Z", "type": "commit"}]}