{"pr_number": 6347, "pr_title": "Prevent CVEs for docs and itests dependencies from appearing in OWASP reports and speed up OWASP scans during CI", "pr_createdAt": "2020-09-25T16:00:14Z", "pr_url": "https://github.com/codice/ddf/pull/6347", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4NjcyMQ==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495086721", "bodyText": "This only works for the check goal. Not useful for aggregate", "author": "SmithJosh", "createdAt": "2020-09-25T16:03:03Z", "path": "distribution/test/pom.xml", "diffHunk": "@@ -60,22 +60,4 @@\n             </dependency>\n         </dependencies>\n     </dependencyManagement>\n-    <build>\n-        <plugins>\n-            <!-- Disable vulnerability checks since this project only contains tests -->", "originalCommit": "9e1cc523e58b051d889a7e26f05f395c59b3d4db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "url": "https://github.com/codice/ddf/commit/9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "message": "Skip all itests for OWASP scan and only run aggregate goal for CI", "committedDate": "2020-09-25T01:31:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4OTQ2NA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495089464", "bodyText": "\u270f\ufe0f Is this property needed anymore now that there is an itest profile?", "author": "emmberk", "createdAt": "2020-09-25T16:08:01Z", "path": "Jenkinsfile", "diffHunk": "@@ -26,7 +26,7 @@ pipeline {\n     }\n     environment {\n         DOCS = 'distribution/docs'\n-        ITESTS = 'distribution/test/itests/test-itests-ddf'\n+        ITESTS = 'distribution/test/itests'", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMjQ3OA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495102478", "bodyText": "Yeah, we use it for the itests build. The \"itests\" profile determines whether the itests are included in the build, but if you just ran mvn install -Pitests, it would include all the other modules in the project as well.\nTo run only the itests, you have to use the -pl flag and specify exactly which modules you want to build - mvn install -Pitests -pl distribution/test/itests/test-itests-ddf", "author": "SmithJosh", "createdAt": "2020-09-25T16:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4OTQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MjcwMg==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495092702", "bodyText": "\u270f\ufe0f Why is -amd needed here?", "author": "emmberk", "createdAt": "2020-09-25T16:13:46Z", "path": "Jenkinsfile", "diffHunk": "@@ -96,7 +96,7 @@ pipeline {\n                 withMaven(maven: 'maven-latest', globalMavenSettingsConfig: 'default-global-settings', mavenSettingsConfig: 'codice-maven-settings', mavenOpts: '${LARGE_MVN_OPTS} ${LINUX_MVN_RANDOM}') {\n                     sh '''\n                         unset JAVA_TOOL_OPTIONS\n-                        mvn install -B -pl $ITESTS -nsu $DISABLE_DOWNLOAD_PROGRESS_OPTS\n+                        mvn install -B -pl $ITESTS,!$ITCORE -amd -nsu $DISABLE_DOWNLOAD_PROGRESS_OPTS", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwNDIwNw==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495104207", "bodyText": "Here's the description of the -amd flag from the Maven docs:\n-amd, --also-make-dependents\n        If project list is specified, also build projects that depend on projects on the list\n\nIf you just run mvn install -pl distribution/test/itests, it will only build the itests project, not the children. The children are dependent projects, so adding -amd allows us to build the whole project tree under the itests module without specifying each module individually", "author": "SmithJosh", "createdAt": "2020-09-25T16:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MjcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NTE0MQ==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495095141", "bodyText": "\u270f\ufe0f Why not just always scan the zips? Is it because it takes longer to run?", "author": "emmberk", "createdAt": "2020-09-25T16:18:18Z", "path": "pom.xml", "diffHunk": "@@ -1048,8 +1040,11 @@\n                 </plugins>\n             </build>\n         </profile>\n+        <!-- Adds all zip build artifacts to the OWASP scan. This includes the kernel, the DDF\n+             distro, etc. Those may include artifacts which aren't actually dependencies of any\n+             DDF modules, so won't appear in a normal scan. -->\n         <profile>\n-            <id>owasp</id>\n+            <id>owasp-dist</id>", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwNDc3Mg==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495104772", "bodyText": "I just did it this way because that's how it was before. I'm open to changing it if we want", "author": "SmithJosh", "createdAt": "2020-09-25T16:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NTE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NjIwNg==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495096206", "bodyText": "\u270f\ufe0f Shouldn't we always scan the distribution (i.e. zip files), even if this is a PR build? Is this if/else really necessary if it's not scanning changed modules?", "author": "emmberk", "createdAt": "2020-09-25T16:20:16Z", "path": "Jenkinsfile", "diffHunk": "@@ -134,9 +134,9 @@ pipeline {\n                     script {\n                         // If this build is not a pull request, run owasp scan on the distribution. Otherwise run incremental scan\n                         if (env.CHANGE_ID == null) {\n-                            sh 'mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories dependency-check:check dependency-check:aggregate -q -B -Powasp-dist -DskipTests=true -DskipStatic=true -pl !$DOCS $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n+                            sh 'mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories dependency-check:aggregate -q -B -pl !$DOCS -P !itests,owasp-dist $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n                         } else {\n-                            sh 'mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories dependency-check:check -q -B -Powasp -DskipTests=true -DskipStatic=true -pl !$DOCS -Dgib.enabled=true -Dgib.referenceBranch=/refs/remotes/origin/$CHANGE_TARGET $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n+                            sh 'mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories dependency-check:aggregate -q -B -pl !$DOCS -P !itests $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n                         }", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwNTE2Nw==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495105167", "bodyText": "Same answer as above: we were previously doing it this way - ignoring the distribution for PR builds", "author": "SmithJosh", "createdAt": "2020-09-25T16:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NjIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExNTIwNA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495115204", "bodyText": "My opinion is that we should always scan the zips. I think the only benefit to doing a different task during PR builds was to only scan changed files. Since the command in this if statement is no longer using gib, I think we should do the same, full scan (i.e. include zip files) on PR builds.", "author": "emmberk", "createdAt": "2020-09-25T16:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NjIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzOTY1NA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r495139654", "bodyText": "I think the only benefit to doing a different task during PR builds was to only scan changed files\n\nWell, the owasp-dist profile wasn't being run on the PR builds before either, and I see no reason why it couldn't be. It seems like an intentional decision to not scan the distro for PRs. I guess the question is why...\nA couple points:\n\nThe unique distro CVEs are not usually DDF's fault directly, but rather because it pulls in a bunch of upstream features from Karaf and other projects. I could see that info mattering sometimes for people putting up PRs (if they're messing with feature files), but in general those CVEs will be unrelated to their changes.\nIf we did scan the distro for PR builds, it's going to take a lot longer to get to the place where we can start failing builds on OWASP scans. There are so many more CVEs in the distro and most aren't even stuff we use at runtime.\n\nWith that in mind, I think it might be better to start with ignoring the distro for PR builds until we cut down on the distro CVEs. It's in our interest to get to the place where we can fail builds again as quickly as possible.", "author": "SmithJosh", "createdAt": "2020-09-25T17:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NjIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNzYyMA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r496037620", "bodyText": "Yes, this seems like the original decision we had on PR builds. It is not the ideal state but probably the best balance of performance, maintenance on dependencies, and process at the moment.", "author": "shaundmorris", "createdAt": "2020-09-28T15:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5NjIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNDQ5Nw==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r496034497", "bodyText": "Nice idea using a profile.", "author": "shaundmorris", "createdAt": "2020-09-28T15:21:36Z", "path": "Jenkinsfile", "diffHunk": "@@ -68,22 +68,22 @@ pipeline {\n             steps {\n                 withMaven(maven: 'maven-latest', globalMavenSettingsConfig: 'default-global-settings', mavenSettingsConfig: 'codice-maven-settings', mavenOpts: '${LARGE_MVN_OPTS} ${LINUX_MVN_RANDOM}') {\n                     sh 'mvn install -B -DskipStatic=true -DskipTests=true $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n-                    sh 'mvn clean install -B -pl !$ITESTS,!$ITCORE -Dgib.enabled=true -Dgib.referenceBranch=/refs/remotes/origin/$CHANGE_TARGET $DISABLE_DOWNLOAD_PROGRESS_OPTS'\n+                    sh 'mvn clean install -B -P !itests -Dgib.enabled=true -Dgib.referenceBranch=/refs/remotes/origin/$CHANGE_TARGET $DISABLE_DOWNLOAD_PROGRESS_OPTS'", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzODM3MA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r496038370", "bodyText": "\u2754 I assume making the docs provided scope means they won't be evaluated by dependency-check?", "author": "shaundmorris", "createdAt": "2020-09-28T15:25:06Z", "path": "distribution/docs/pom.xml", "diffHunk": "@@ -33,16 +33,19 @@\n             <groupId>org.asciidoctor</groupId>\n             <artifactId>asciidoctorj</artifactId>\n             <version>${asciidoctorj.version}</version>\n+            <scope>provided</scope>", "originalCommit": "9fb3c23dfe59fa25fa25f28a0df07589aab2cccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NDk5Mw==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r496074993", "bodyText": "The compile scope is transitive and since the distribution has a dependency on the docs, it had a transitive dependency on asciidoctor and jruby as well. This is to prevent that. The provided scope isn't transitive, so they no longer leak into projects that depend on the docs.\ndependency-check would still scan them (it scans compile, provided, and runtime dependencies), but we skip the docs module.", "author": "SmithJosh", "createdAt": "2020-09-28T16:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzODM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5Njg4MA==", "url": "https://github.com/codice/ddf/pull/6347#discussion_r496096880", "bodyText": "gotcha. Thanks!", "author": "shaundmorris", "createdAt": "2020-09-28T16:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzODM3MA=="}], "type": "inlineReview"}, {"oid": "9a412cafb94930ee333900164a30817971f9ce61", "url": "https://github.com/codice/ddf/commit/9a412cafb94930ee333900164a30817971f9ce61", "message": "Skip all itests for OWASP scan and only run aggregate goal for CI", "committedDate": "2020-10-01T15:20:07Z", "type": "forcePushed"}, {"oid": "ac2a3cfee367c8b3c2c73b382ae50dfeb8f81e3f", "url": "https://github.com/codice/ddf/commit/ac2a3cfee367c8b3c2c73b382ae50dfeb8f81e3f", "message": "Skip all itests for OWASP scan and only run aggregate goal for CI", "committedDate": "2020-10-23T18:50:34Z", "type": "commit"}, {"oid": "ac2a3cfee367c8b3c2c73b382ae50dfeb8f81e3f", "url": "https://github.com/codice/ddf/commit/ac2a3cfee367c8b3c2c73b382ae50dfeb8f81e3f", "message": "Skip all itests for OWASP scan and only run aggregate goal for CI", "committedDate": "2020-10-23T18:50:34Z", "type": "forcePushed"}]}