{"pr_number": 6112, "pr_title": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition", "pr_createdAt": "2020-06-02T21:33:51Z", "pr_url": "https://github.com/codice/ddf/pull/6112", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMDg0OQ==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434230849", "bodyText": "\u2753 Where does this place the CSRF filter in the order? Before the auth filters?", "author": "SmithJosh", "createdAt": "2020-06-02T23:34:35Z", "path": "platform/security/filter/security-filter-csrf/src/main/resources/OSGI-INF/blueprint/blueprint.xml", "diffHunk": "@@ -0,0 +1,49 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- /**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either\n+ * version 3 of the License, or any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ *\n+ **/ -->\n+<blueprint xmlns=\"http://www.osgi.org/xmlns/blueprint/v1.0.0\">\n+\n+  <reference id=\"securityLogger\" interface=\"ddf.security.audit.SecurityLogger\" availability=\"optional\"/>\n+\n+  <bean id=\"filter\" class=\"org.codice.ddf.security.filter.csrf.CsrfFilter\">\n+    <argument ref=\"securityLogger\"/>\n+    <property name=\"whiteListContexts\">\n+      <array value-type=\"java.lang.String\">\n+        <value>/services[/]?$=GET</value>\n+        <value>/services/admin/config[/]?$=GET</value>\n+        <value>/services/content[/]?$=GET</value>\n+        <value>/services/catalog/query[/]?$=GET</value> <!-- Simple Search -->\n+        <value>/services/catalog/sources.*=GET</value> <!-- REST Action providers -->\n+        <value>/services/internal/catalog/download/cache.*=GET</value>\n+        <value>/services/internal/session.*=GET</value>\n+        <value>/services/internal/metrics.*=GET</value>\n+        <value>/services/logout/actions[/]?$=GET</value>\n+        <value>/services/logout/local[/]?$=GET</value>\n+        <value>/services/platform/config/ui[/]?$=GET</value>\n+        <value>/services/saml/logout[/]?$=GET</value>\n+        <value>/services/saml/logout/request[/]?$=GET</value>\n+        <value>/services/saml/sso[/]?$=POST</value>\n+        <value>/services/saml/sso/metadata[/]?$=GET</value>\n+        <value>/services/store/config[/]?$=GET</value>\n+        <value>/services/internal/registries.*=GET</value>\n+        <value>/services/oidc/logout.*=GET</value>\n+      </array>\n+    </property>\n+  </bean>\n+\n+  <service ref=\"filter\" interface=\"org.codice.ddf.platform.filter.SecurityFilter\" ranking=\"101\">", "originalCommit": "83012cd46d2943c4e7baa11d8f72f9197fb15726", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5MDUwNg==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434790506", "bodyText": "That is my understanding after the websso and login filter but let me double-check", "author": "blen-desta", "createdAt": "2020-06-03T19:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMDg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMjMzMw==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434232333", "bodyText": "\u270f\ufe0f Just a minor thing, but an \"authorization failure\" would be more fitting imo", "author": "SmithJosh", "createdAt": "2020-06-02T23:39:47Z", "path": "platform/security/filter/security-filter-csrf/src/main/java/org/codice/ddf/security/filter/csrf/CsrfFilter.java", "diffHunk": "@@ -174,14 +176,14 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n       if (protectedContexts.stream().anyMatch(targetContextPath::startsWith)\n           && doBrowserProtectionFilter(\n               httpRequest, httpResponse, targetContextPath, requestMethod)) {\n-        return;\n+        throw new AuthenticationFailureException();\n       }\n \n       // Execute CSRF check if user is accessing /services\n       if (targetContextPath.startsWith(SERVICE_CONTEXT)\n           && doSystemProtectionFilter(\n               httpRequest, httpResponse, targetContextPath, requestMethod, userAgentHeader)) {\n-        return;\n+        throw new AuthenticationFailureException();", "originalCommit": "83012cd46d2943c4e7baa11d8f72f9197fb15726", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3", "url": "https://github.com/codice/ddf/commit/ba2281800f7334b5d589f76100cb1878b39688a3", "message": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition", "committedDate": "2020-06-03T16:30:33Z", "type": "commit"}, {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3", "url": "https://github.com/codice/ddf/commit/ba2281800f7334b5d589f76100cb1878b39688a3", "message": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition", "committedDate": "2020-06-03T16:30:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTI4Ng==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434785286", "bodyText": "\u2753 Can't seem to figure out where the CSRF filter reads from custom.system.properties.", "author": "bakejeyner", "createdAt": "2020-06-03T18:55:47Z", "path": "distribution/ddf-common/src/main/resources/security/default.policy", "diffHunk": "@@ -307,6 +307,10 @@ grant codeBase \"file:/admin-core-jolokia/javax.servlet-api/org.apache.shiro.core\n     permission java.security.SecurityPermission \"insertProvider\";\n }\n \n+grant codeBase \"file:/security-filter-csrf\" {\n+    permission java.io.FilePermission \"${ddf.home.perm}etc${/}custom.system.properties\", \"read\";\n+}", "originalCommit": "ba2281800f7334b5d589f76100cb1878b39688a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4OTQ2MQ==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434789461", "bodyText": "In etc/custom.system.properties you can configure:\n# Whether or not CSRF filtering should be enabled. This should only be disabled for testing and\n# debugging purposes, otherwise the system will be left insecure.\ncsrf.enabled=true\n\n# Comma separated list of host/port combinations that can be trusted to make requests to DDF.\ncsrf.trustedAuthorities=", "author": "blen-desta", "createdAt": "2020-06-03T19:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5NzEyOQ==", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434797129", "bodyText": "Ahhh ya I see that; thanks!\nI just find it weird that a call to System.getProperty would require reading from custom.system.properties. I thought that some other bundle is responsible for reading entries from custom.system.properties and loading those entries into the system properties, and the CSRF filter would just be reading the system properties without ever having to even know about the custom.system.properties file \ud83e\udd37 .", "author": "bakejeyner", "createdAt": "2020-06-03T19:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTI4Ng=="}], "type": "inlineReview"}, {"oid": "e8202e985f21f03d2c73ac82313f8367a55893b8", "url": "https://github.com/codice/ddf/commit/e8202e985f21f03d2c73ac82313f8367a55893b8", "message": "Reordered the filters", "committedDate": "2020-06-08T21:40:24Z", "type": "commit"}, {"oid": "9b78371d4a39ab6af9c8e8a0dfef41bfc7a7cf61", "url": "https://github.com/codice/ddf/commit/9b78371d4a39ab6af9c8e8a0dfef41bfc7a7cf61", "message": "Fixed unit test", "committedDate": "2020-06-09T00:52:14Z", "type": "commit"}]}