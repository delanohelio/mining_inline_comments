{"pr_number": 5868, "pr_title": "[2.19.x] DDF-5867 fix table export Visible", "pr_createdAt": "2020-03-02T21:40:40Z", "pr_url": "https://github.com/codice/ddf/pull/5868", "timeline": [{"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "url": "https://github.com/codice/ddf/commit/7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "message": "DDF-5867 fix table export Visible", "committedDate": "2020-03-02T21:28:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzNzc5MA==", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387137790", "bodyText": "so this results is a subset fo the total results, if the results exceeded the size of the request, right? I guess there's no way to only get the number that we want, i.e. cqlTransformRequest.getCount() number of results", "author": "cassandrabailey293", "createdAt": "2020-03-03T16:25:04Z", "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/query/handlers/CqlTransformHandler.java", "diffHunk": "@@ -158,7 +234,48 @@ public Object handle(Request request, Response response) throws Exception {\n       return ImmutableMap.of(\"message\", \"Service not found\");\n     }\n \n-    CqlQueryResponse cqlQueryResponse = cqlQueryUtil.executeCqlQuery(cqlRequest);\n+    List<Result> results =\n+        cqlRequests\n+            .stream()\n+            .map(\n+                cqlRequest -> {\n+                  CqlQueryResponse cqlQueryResponse = null;\n+                  try {\n+                    cqlQueryResponse = cqlQueryUtil.executeCqlQuery(cqlRequest);\n+                  } catch (Exception e) {\n+                    LOGGER.debug(\"Error fetching cql request for {}\", cqlRequest.getSrc());\n+                    return null;\n+                  }\n+                  return cqlQueryResponse.getQueryResponse().getResults();\n+                })\n+            .filter(cqlResults -> CollectionUtils.isNotEmpty(cqlResults))\n+            .flatMap(cqlResults -> cqlResults.stream())\n+            .collect(Collectors.toList());\n+\n+    results.sort(getResultComparators(cqlTransformRequest.getSorts()));\n+\n+    results =\n+        results.size() > cqlTransformRequest.getCount()\n+            ? results.subList(0, cqlTransformRequest.getCount())\n+            : results;\n+\n+    results =\n+        CollectionUtils.isEmpty(cqlTransformRequest.getHiddenResults())\n+            ? results\n+            : results\n+                .stream()\n+                .filter(\n+                    result ->\n+                        !cqlTransformRequest\n+                            .getHiddenResults()\n+                            .contains(result.getMetacard().getId()))\n+                .collect(Collectors.toList());\n+\n+    QueryResponse combinedResponse =\n+        new QueryResponseImpl(\n+            new QueryRequestImpl(new QueryImpl(ECQL.toFilter(cqlRequests.get(0).getCql()))),\n+            results,", "originalCommit": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1OTA2NA==", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387859064", "bodyText": "export all/exact number will have one combined cql request for all srcs because all srcs have the same starting index, so in this case we should only be retrieving the number of results we want. And just added a commit c43593d for visible to get the count per src so we should always be retrieving the correct amount of results. There are cases where downstream projects will be adding additional srcs to the request and will require the results being truncated", "author": "andrewzimmer", "createdAt": "2020-03-04T18:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzNzc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0MTIyOA==", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387141228", "bodyText": "\u2753 what's the hidden results for?", "author": "cassandrabailey293", "createdAt": "2020-03-03T16:29:35Z", "path": "ui/packages/catalog-ui-search/src/main/webapp/extension-points/table-export/table-export.tsx", "diffHunk": "@@ -165,19 +156,30 @@ export const getDownloadBody = (downloadInfo: DownloadInfo) => {\n     getExportCount({ exportSize, selectionInterface, customExportCount }),\n     properties.exportResultLimit\n   )\n-  const cql = getCqlForSize(exportSize, count, selectionInterface)\n+  const cql = selectionInterface.getCurrentQuery().get('cql')\n   const srcs = getSrcs(selectionInterface)\n   const sorts = getSorts(selectionInterface)\n+  const hiddenResults = getHiddenResults(exportSize)\n   const args = {\n     hiddenFields: hiddenFields.length > 0 ? hiddenFields : [],\n     columnOrder: columnOrder.length > 0 ? columnOrder : {},\n     columnAliasMap: properties.attributeAliases,\n   }\n+\n+  const searches = srcs.map((src: string) => {\n+    const start = getStartIndex(src, exportSize, selectionInterface)\n+    return {\n+      src,\n+      cql,\n+      start,\n+    }\n+  })\n+\n   return {\n-    cql,\n-    srcs,\n+    searches,\n     count,\n     sorts,\n+    hiddenResults,", "originalCommit": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5NDEyOQ==", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387794129", "bodyText": "Results can be hidden on the ui and we don't want these to appear for an export visible. Previously getActiveSearchResults did this filtering by only retrieving ids of non-hidden results, now we are passing this list of ids to do this filtering on the backend", "author": "andrewzimmer", "createdAt": "2020-03-04T16:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0MTIyOA=="}], "type": "inlineReview"}, {"oid": "95204536546b2a9a106dce047a74ef55ab2ac55f", "url": "https://github.com/codice/ddf/commit/95204536546b2a9a106dce047a74ef55ab2ac55f", "message": "DDF-5867 combine srcs for export all/exact", "committedDate": "2020-03-03T17:02:25Z", "type": "commit"}, {"oid": "c43593d1d487eacad775ce2ed6d7ae6f299d1763", "url": "https://github.com/codice/ddf/commit/c43593d1d487eacad775ce2ed6d7ae6f299d1763", "message": "DDF-5867 add individual source count", "committedDate": "2020-03-04T18:33:31Z", "type": "commit"}, {"oid": "57b8ef7fbc6b4f370cb00d422bd089203173f544", "url": "https://github.com/codice/ddf/commit/57b8ef7fbc6b4f370cb00d422bd089203173f544", "message": "DDF-5867 fix exporting incorrect results with cache active", "committedDate": "2020-03-18T15:03:23Z", "type": "commit"}, {"oid": "a5575eff9a3d3be8681cd67f46c7cb193f182f25", "url": "https://github.com/codice/ddf/commit/a5575eff9a3d3be8681cd67f46c7cb193f182f25", "message": "DDF-5867 undelete function", "committedDate": "2020-03-18T16:37:20Z", "type": "commit"}, {"oid": "1be037908761f61df0243506acc82cbcb41e8e94", "url": "https://github.com/codice/ddf/commit/1be037908761f61df0243506acc82cbcb41e8e94", "message": "DDF-5867 fix incorrect start index", "committedDate": "2020-03-19T19:37:35Z", "type": "commit"}, {"oid": "cf687726f96df153dc1ad0d7f11e96c56602df32", "url": "https://github.com/codice/ddf/commit/cf687726f96df153dc1ad0d7f11e96c56602df32", "message": "DDF-5867 fix tests", "committedDate": "2020-03-19T20:12:25Z", "type": "commit"}, {"oid": "7305482f34b58cee863a2e7f74f2abeb73c683c0", "url": "https://github.com/codice/ddf/commit/7305482f34b58cee863a2e7f74f2abeb73c683c0", "message": "DDF-5867 addressing comments", "committedDate": "2020-03-24T18:35:15Z", "type": "commit"}, {"oid": "dda0d1a28860d3571a856e5a8468d21242706bb5", "url": "https://github.com/codice/ddf/commit/dda0d1a28860d3571a856e5a8468d21242706bb5", "message": "DDF-5867 fix no source case", "committedDate": "2020-03-24T23:50:22Z", "type": "commit"}]}