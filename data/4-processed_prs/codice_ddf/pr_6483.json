{"pr_number": 6483, "pr_title": "[2.19.x] G-9036 pan to geos defined on search form", "pr_createdAt": "2020-12-28T23:52:33Z", "pr_url": "https://github.com/codice/ddf/pull/6483", "timeline": [{"oid": "aeaaa4fd8da40878d688de9dfe19cb8e70c08358", "url": "https://github.com/codice/ddf/commit/aeaaa4fd8da40878d688de9dfe19cb8e70c08358", "message": "G-9036 pan to geos defined on search form", "committedDate": "2020-12-28T23:34:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc5NTQwOQ==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r556795409", "bodyText": "\u2753 I'm curios why we're doing this when we're using the underscore flatten function here: https://github.com/codice/ddf/pull/6483/files#diff-61f3b5db651cfd7e289c041c39274cfa06a5b7e476b54fc20ef9ad5c574a21feR142 ?", "author": "leo-sakh", "createdAt": "2021-01-13T20:03:08Z", "path": "ui/packages/catalog-ui-search/src/main/webapp/component/search-form-editor/search-form-editor.view.js", "diffHunk": "@@ -118,10 +123,50 @@ module.exports = Marionette.LayoutView.extend({\n         selectionInterface: new SelectionInterface(),\n         onMapLoaded: olMap => {\n           this.showQueryForm(collection, id)\n+          if (this.model.get('filterTemplate')) {\n+            const geoFilters = (\n+              this.model.get('filterTemplate').filters || [\n+                this.model.get('filterTemplate'),\n+              ]\n+            ).filter(filter => CQLUtils.isGeoFilter(filter.type))\n+            const coords = this.wktToCoords(geoFilters)\n+            Common.queueExecution(() => {\n+              this.map.currentView.map.zoomToExtent(coords)\n+            })\n+          }\n         },\n       })\n     )\n   },\n+  wktToCoords(wktList) {\n+    const parsedGeoCoords = _.flatten(\n+      wktList.map(wkt => {\n+        if (wkt.value.startsWith('POINT') && parseFloat(wkt.distance) !== 0) {\n+          const center = terraformer.parse(wkt.value).coordinates\n+          return new TurfCircle(center, parseFloat(wkt.distance), 64, 'meters')\n+            .geometry.coordinates[0]\n+        }\n+        return terraformer.parse(wkt.value).coordinates\n+      }),\n+      true\n+    )\n+    return this.createCoordinatePairs(this.flatten(parsedGeoCoords))\n+  },\n+  flatten(arr) {", "originalCommit": "aeaaa4fd8da40878d688de9dfe19cb8e70c08358", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYyMTg3NQ==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r557621875", "bodyText": "it lets you specify a second argument, true, meaning it will only flatten to one level. but it looks like .flat() can achieve the same thing:\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flat\nso i will just use .flat()", "author": "cassandrabailey293", "createdAt": "2021-01-14T19:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc5NTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc5NjI1OA==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r556796258", "bodyText": "\u2753 Any specific reason to use function instead of a fat arrow => as in the previous .reduce instance above?", "author": "leo-sakh", "createdAt": "2021-01-13T20:04:46Z", "path": "ui/packages/catalog-ui-search/src/main/webapp/component/search-form-editor/search-form-editor.view.js", "diffHunk": "@@ -118,10 +123,50 @@ module.exports = Marionette.LayoutView.extend({\n         selectionInterface: new SelectionInterface(),\n         onMapLoaded: olMap => {\n           this.showQueryForm(collection, id)\n+          if (this.model.get('filterTemplate')) {\n+            const geoFilters = (\n+              this.model.get('filterTemplate').filters || [\n+                this.model.get('filterTemplate'),\n+              ]\n+            ).filter(filter => CQLUtils.isGeoFilter(filter.type))\n+            const coords = this.wktToCoords(geoFilters)\n+            Common.queueExecution(() => {\n+              this.map.currentView.map.zoomToExtent(coords)\n+            })\n+          }\n         },\n       })\n     )\n   },\n+  wktToCoords(wktList) {\n+    const parsedGeoCoords = _.flatten(\n+      wktList.map(wkt => {\n+        if (wkt.value.startsWith('POINT') && parseFloat(wkt.distance) !== 0) {\n+          const center = terraformer.parse(wkt.value).coordinates\n+          return new TurfCircle(center, parseFloat(wkt.distance), 64, 'meters')\n+            .geometry.coordinates[0]\n+        }\n+        return terraformer.parse(wkt.value).coordinates\n+      }),\n+      true\n+    )\n+    return this.createCoordinatePairs(this.flatten(parsedGeoCoords))\n+  },\n+  flatten(arr) {\n+    return arr.reduce((flat, toFlatten) => {\n+      return flat.concat(\n+        Array.isArray(toFlatten) ? this.flatten(toFlatten) : toFlatten\n+      )\n+    }, [])\n+  },\n+  createCoordinatePairs(arr) {\n+    return arr.reduce(function(result, value, index, array) {", "originalCommit": "aeaaa4fd8da40878d688de9dfe19cb8e70c08358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc5NzYxNQ==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r556797615", "bodyText": "\u270f\ufe0f I would recommend pulling the model attribute into a variable since it's being referenced multiple times here:\nconst filterTemplate = this.model.get('filterTemplate')\n\nalso reversing the predicate would collapse the nesting nicely:\nif (!filterTemplate)\n  return\n<normal code flow without '{}'>", "author": "leo-sakh", "createdAt": "2021-01-13T20:07:20Z", "path": "ui/packages/catalog-ui-search/src/main/webapp/component/search-form-editor/search-form-editor.view.js", "diffHunk": "@@ -118,10 +123,50 @@ module.exports = Marionette.LayoutView.extend({\n         selectionInterface: new SelectionInterface(),\n         onMapLoaded: olMap => {\n           this.showQueryForm(collection, id)\n+          if (this.model.get('filterTemplate')) {", "originalCommit": "aeaaa4fd8da40878d688de9dfe19cb8e70c08358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33e0809c5a3e374829311fc03b4be94d95f3312f", "url": "https://github.com/codice/ddf/commit/33e0809c5a3e374829311fc03b4be94d95f3312f", "message": "G-9036 remove underscore flatten and formatting", "committedDate": "2021-01-14T21:11:54Z", "type": "commit"}, {"oid": "d14e8af4c5595c075a03a943ea10988bced93e60", "url": "https://github.com/codice/ddf/commit/d14e8af4c5595c075a03a943ea10988bced93e60", "message": "G-9036 refactor for cleanliness", "committedDate": "2021-01-15T14:40:16Z", "type": "commit"}, {"oid": "91538c4b7a5d8100f017d15d11da2db85a350111", "url": "https://github.com/codice/ddf/commit/91538c4b7a5d8100f017d15d11da2db85a350111", "message": "G-9036 formatting", "committedDate": "2021-01-19T18:45:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjEwMzcxNg==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r562103716", "bodyText": "\u2753 What is the significance of 64 here? Can we make it a constant with a descriptive name?", "author": "leo-sakh", "createdAt": "2021-01-21T18:26:15Z", "path": "ui/packages/catalog-ui-search/src/main/webapp/component/search-form-editor/search-form-editor.view.js", "diffHunk": "@@ -117,11 +121,48 @@ module.exports = Marionette.LayoutView.extend({\n         showResultFilter: false,\n         selectionInterface: new SelectionInterface(),\n         onMapLoaded: olMap => {\n+          const filterTemplate = this.model.get('filterTemplate')\n           this.showQueryForm(collection, id)\n+          if (!filterTemplate) {\n+            return\n+          }\n+          const geoFilters = (\n+            filterTemplate.filters || [filterTemplate]\n+          ).filter(filter => CQLUtils.isGeoFilter(filter.type))\n+          const coords = this.wktToCoords(geoFilters)\n+          Common.queueExecution(() => {\n+            this.map.currentView.map.zoomToExtent(coords)\n+          })\n         },\n       })\n     )\n   },\n+  wktToCoords(wktList) {\n+    const parsedGeoCoords = wktList.map(wkt => {\n+      if (wkt.value.startsWith('POINT') && parseFloat(wkt.distance) !== 0) {\n+        const center = terraformer.parse(wkt.value).coordinates\n+        return new TurfCircle(center, parseFloat(wkt.distance), 64, 'meters')", "originalCommit": "91538c4b7a5d8100f017d15d11da2db85a350111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjEwNjIyNQ==", "url": "https://github.com/codice/ddf/pull/6483#discussion_r562106225", "bodyText": "it's the \"number of steps\", used for precision. the default in the new circle constructor is 64: https://turfjs.org/docs/#circle I'll make it a constant \ud83d\udc4d", "author": "cassandrabailey293", "createdAt": "2021-01-21T18:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjEwMzcxNg=="}], "type": "inlineReview"}, {"oid": "6ee2db52dbf384ed2e7a95427fa7200dc285e694", "url": "https://github.com/codice/ddf/commit/6ee2db52dbf384ed2e7a95427fa7200dc285e694", "message": "G-9036 make precision steps a constant", "committedDate": "2021-01-21T18:33:52Z", "type": "commit"}, {"oid": "68cb8fbd8ae2c70bf99b65b116dc44a66593d54a", "url": "https://github.com/codice/ddf/commit/68cb8fbd8ae2c70bf99b65b116dc44a66593d54a", "message": "G-9036 formatting", "committedDate": "2021-01-21T23:30:56Z", "type": "commit"}]}