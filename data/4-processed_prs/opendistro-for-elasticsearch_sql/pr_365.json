{"pr_number": 365, "pr_title": "Return Correct Type Information for Fields ", "pr_createdAt": "2020-02-07T01:15:00Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365", "timeline": [{"oid": "3b10e2d0cf540f3493ce39ef3d91141ace36755e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3b10e2d0cf540f3493ce39ef3d91141ace36755e", "message": "correcting Type Information return for JDBC format", "committedDate": "2020-02-05T22:31:02Z", "type": "commit"}, {"oid": "ee178aed0d25d4d9d719c80e8d41db10dcc7a5e5", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ee178aed0d25d4d9d719c80e8d41db10dcc7a5e5", "message": "added math Constants test", "committedDate": "2020-02-05T22:58:38Z", "type": "commit"}, {"oid": "537c42e861fa35aa6a69829c23bd77e7d4cf2ade", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/537c42e861fa35aa6a69829c23bd77e7d4cf2ade", "message": "fixed type assignment for multiple fields and added hard-coding for ORDER BY script fields", "committedDate": "2020-02-07T01:07:29Z", "type": "commit"}, {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f05894ff645f149c4eb6a27d3b31ec018e78ea28", "message": "minor formatting corrections", "committedDate": "2020-02-07T01:11:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU1NDI4OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r376554288", "bodyText": "A reminder: the number operators do not always return DOUBLE, for example, abs(integer) should return INTEGER, and sign(...) should always return an integer type.", "author": "chloe-zh", "createdAt": "2020-02-07T19:00:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -1023,4 +1015,31 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n                 );\n         }\n     }\n+\n+    public static Schema.Type getOrderByFieldType(Field field) {\n+        String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n+        if (functionName.equals(\"cast\")) {\n+            String castType = ((SQLCastExpr) field.getExpression()).getDataType().getName();\n+            return getCastFunctionReturnType(castType);\n+        }\n+\n+        if (numberOperators.contains(functionName) || mathConstants.contains(functionName)\n+                || trigFunctions.contains(functionName) || binaryOperators.contains(functionName)) {\n+            return Schema.Type.DOUBLE;", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU2MTU5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r376561592", "bodyText": "This is just for the ORDER BY clause- the scriptSortType will only return either STRING or NUMBER, so returning DOUBLE for every numeric field in the ORDER BY will not affect the field information of the fields in SELECT", "author": "davidcui1225", "createdAt": "2020-02-07T19:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU1NDI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE3MTI5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377171299", "bodyText": "Is it possible to avoid running performAnalysis two times by build another QueryPlanner around DefaultQueryAction?", "author": "penghuo", "createdAt": "2020-02-10T16:27:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -48,11 +51,14 @@\n     private ResultSet resultSet;\n     private ErrorMessage error;\n     private List<ColumnNode> columnNodeList;\n+    private ColumnTypeProvider scriptColumnType = new ColumnTypeProvider();\n \n     public Protocol(Client client, QueryAction queryAction, Object queryResult, String formatType) {\n         if (queryAction instanceof QueryPlanQueryAction) {\n             this.columnNodeList =\n                     ((QueryPlanRequestBuilder) (((QueryPlanQueryAction) queryAction).explain())).outputColumns();\n+        } else if (queryAction instanceof DefaultQueryAction) {", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzMDI3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377930273", "bodyText": "np: remove first space", "author": "dai-chen", "createdAt": "2020-02-11T22:11:02Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -325,7 +328,7 @@ private String getFieldName(Field field) {\n                 if (field.getExpression() instanceof SQLCaseExpr) {\n                     return Schema.Type.TEXT;\n                 }\n-                return SQLFunctions.getScriptFunctionReturnType(field);\n+                 return SQLFunctions.getScriptFunctionReturnType(fieldIndex, field, scriptColumnType);", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNDEzNA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377934134", "bodyText": "In which case fieldIndex is -1?", "author": "dai-chen", "createdAt": "2020-02-11T22:20:04Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,28 +974,19 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, Field field, ColumnTypeProvider scriptColumnType) {\n+        Schema.Type returnType = null;\n+        if (scriptColumnType != null && fieldIndex != -1) {", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MDIyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377950225", "bodyText": "if fieldName is not found in the fieldNameList", "author": "davidcui1225", "createdAt": "2020-02-11T22:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNDEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTczMQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377951731", "bodyText": "if fieldName is not found in the fieldNameList\n\nIs this possible? I'm asking because we're throwing unsupported exception in this case, I wonder if that's expected.", "author": "dai-chen", "createdAt": "2020-02-11T23:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNDEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNjE3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r378416179", "bodyText": "Looks like it's not- think its safe to remove based on for (String fieldName : fieldNameList) in SelectResultSet", "author": "davidcui1225", "createdAt": "2020-02-12T17:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNDEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTcxNw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377935717", "bodyText": "The 2nd argument should be MethodField?", "author": "dai-chen", "createdAt": "2020-02-11T22:23:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -308,7 +311,7 @@ private String getFieldName(Field field) {\n         }\n     }\n \n-    private Schema.Type fetchMethodReturnType(Field field) {\n+    private Schema.Type fetchMethodReturnType(int fieldIndex, Field field) {", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNjY1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377936655", "bodyText": "2nd argument should be MethodField. Then I think you should reorganize this method like this:\nreturnType\nif (methodField is cast)\n    returnType = ...\nelse\n    returnType = ...\n\nif (returnType == null)\n    throw exception ...\n\nreturn returnType\n\nAfter this, could you add UT for this function because of its importance? Maybe 3 test cases for the if, else and throw exception in SQLFunctionsTest.", "author": "dai-chen", "createdAt": "2020-02-11T22:25:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,28 +974,19 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, Field field, ColumnTypeProvider scriptColumnType) {", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTQyMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377939420", "bodyText": "Could you add JavaDoc here to clarify that why we stick with hardcoding return type here? Basically I think it's because there are only 2 order by type TEXT and NUMBER in ES so what is returned here is essentially the category of function rather than the actual return type.", "author": "dai-chen", "createdAt": "2020-02-11T22:32:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -1023,4 +1015,31 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n                 );\n         }\n     }\n+\n+    public static Schema.Type getOrderByFieldType(Field field) {", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NDA3OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377974078", "bodyText": "good idea- will do", "author": "davidcui1225", "createdAt": "2020-02-12T00:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MDc5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377940795", "bodyText": "I think you're safe to remove all these verifyDataRows() and focus on what this IT want to test (the type in schema). The correctness of data rows should be covered by other IT.", "author": "dai-chen", "createdAt": "2020-02-11T22:35:14Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TypeInformationIT.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.schema;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifySchema;\n+\n+public class TypeInformationIT extends SQLIntegTestCase {\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+        loadIndex(Index.ONLINE);\n+    }\n+\n+    /*\n+    numberOperators\n+     */\n+    @Test\n+    public void testAbsWithIntFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT ABS(age) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY age LIMIT 5\");\n+\n+        verifySchema(response, schema(\"ABS(age)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20));", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NDEwNg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377974106", "bodyText": "will do", "author": "davidcui1225", "createdAt": "2020-02-12T00:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MDc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzU0MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377943540", "bodyText": "I think I made this mistake. sin should always return double like log right? Could you help confirm and fix this as well as TAN, ATAN, ATAN2, COS and COSH in ScalarFunction type system?\nFor example, change SIN(func(T(NUMBER)).to(T)), to SIN(func(T(NUMBER)).to(DOUBLE)),.", "author": "dai-chen", "createdAt": "2020-02-11T22:41:50Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TypeInformationIT.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.schema;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifySchema;\n+\n+public class TypeInformationIT extends SQLIntegTestCase {\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+        loadIndex(Index.ONLINE);\n+    }\n+\n+    /*\n+    numberOperators\n+     */\n+    @Test\n+    public void testAbsWithIntFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT ABS(age) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY age LIMIT 5\");\n+\n+        verifySchema(response, schema(\"ABS(age)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20));\n+    }\n+\n+    @Test\n+    public void testCeilWithLongFieldReturnsLong() {\n+        JSONObject response = executeJdbcRequest(\"SELECT CEIL(balance) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY balance LIMIT 5\");\n+\n+        verifySchema(response, schema(\"CEIL(balance)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(1011),\n+                rows(1031),\n+                rows(1110),\n+                rows(1133),\n+                rows(1172));\n+    }\n+\n+    /*\n+    mathConstants\n+     */\n+    @Test\n+    public void testPiReturnsDouble() {\n+        JSONObject response = executeJdbcRequest(\"SELECT PI() FROM \" + TestsConstants.TEST_INDEX_ACCOUNT\n+                + \" LIMIT 1\");\n+\n+        verifySchema(response, schema(\"PI()\", null, \"double\"));\n+        verifyDataRows(response,\n+                rows(3.141592653589793));\n+    }\n+\n+    /*\n+    stringOperators\n+     */\n+    @Test\n+    public void testUpperWithStringFieldReturnsString() {\n+        JSONObject response = executeJdbcRequest(\"SELECT UPPER(firstname) AS firstname_alias FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname_alias LIMIT 2\");\n+\n+        verifySchema(response, schema(\"firstname_alias\", null, \"text\"));\n+        verifyDataRows(response,\n+                rows(\"ABBOTT\"),\n+                rows(\"ABIGAIL\"));\n+    }\n+\n+    @Test\n+    public void testLowerWithTextFieldReturnsText() {\n+        JSONObject response = executeJdbcRequest(\"SELECT LOWER(firstname) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"LOWER(firstname)\", null, \"text\"));\n+        verifyDataRows(response,\n+                rows(\"abbott\"),\n+                rows(\"abigail\"));\n+    }\n+\n+    /*\n+    stringFunctions\n+     */\n+    @Test\n+    public void testLengthWithTextFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT length(firstname) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"length(firstname)\", null, \"integer\"));\n+        verifyDataRows(response,\n+                rows(6),\n+                rows(7));\n+    }\n+\n+    /*\n+    trigFunctions\n+     */\n+    @Test\n+    public void testSinWithLongFieldReturnsLong() {\n+        JSONObject response = executeJdbcRequest(\"SELECT sin(balance) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"sin(balance)\", null, \"long\"));", "originalCommit": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NTcxOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377975718", "bodyText": "Sure- will look into it", "author": "davidcui1225", "createdAt": "2020-02-12T00:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3Njg0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377976843", "bodyText": "Thanks!", "author": "dai-chen", "createdAt": "2020-02-12T00:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzU0MA=="}], "type": "inlineReview"}, {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "message": "eliminated second performAnalysis() call, refactored ITs and added UTs.", "committedDate": "2020-02-18T19:14:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyOTE5OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381429198", "bodyText": "why change to public?", "author": "penghuo", "createdAt": "2020-02-19T17:29:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "diffHunk": "@@ -209,7 +210,7 @@ private boolean isSQLFeatureEnabled() {\n         return allowExplicitIndex && isSqlEnabled;\n     }\n \n-    private static ColumnTypeProvider performAnalysis(String sql) {\n+    public static ColumnTypeProvider performAnalysis(String sql) {", "originalCommit": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwNzk1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381607956", "bodyText": "outdated change from when it was called twice- will revert", "author": "davidcui1225", "createdAt": "2020-02-19T23:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyOTE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMDc1MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381430750", "bodyText": "why named scriptColumnType? In my understanding, it not limit to script, right?", "author": "penghuo", "createdAt": "2020-02-19T17:32:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -65,17 +66,19 @@\n     private String indexName;\n     private String typeName;\n     private List<Schema.Column> columns = new ArrayList<>();\n+    private ColumnTypeProvider scriptColumnType;\n \n     private List<String> head;\n     private long size;\n     private long totalHits;\n     private List<DataRows.Row> rows;\n \n-    public SelectResultSet(Client client, Query query, Object queryResult) {\n+    public SelectResultSet(Client client, Query query, Object queryResult, ColumnTypeProvider scriptColumnType) {\n         this.client = client;\n         this.query = query;\n         this.queryResult = queryResult;\n         this.selectAll = false;\n+        this.scriptColumnType = scriptColumnType;", "originalCommit": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwOTk5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381609999", "bodyText": "good point - will change to outputColumnType", "author": "davidcui1225", "createdAt": "2020-02-19T23:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMDc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMjI2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381432262", "bodyText": "remove the empty line", "author": "penghuo", "createdAt": "2020-02-19T17:35:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -374,12 +377,14 @@ private String getFieldName(Field field) {\n              * name instead.\n              */\n             if (fieldMap.get(fieldName) instanceof MethodField) {\n-                Field methodField = fieldMap.get(fieldName);\n+", "originalCommit": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNTM5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381435391", "bodyText": "Is it possible to handle the unsupported case in SemanticAnalyzer?", "author": "penghuo", "createdAt": "2020-02-19T17:40:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,34 +974,27 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {\n+        Schema.Type returnType;\n         String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n+        if (!numberOperators.contains(functionName) && !mathConstants.contains(functionName)\n+                && !trigFunctions.contains(functionName) && !stringOperators.contains(functionName)\n+                && !stringFunctions.contains(functionName) && !binaryOperators.contains(functionName)\n+                && !dateFunctions.contains(functionName) && !conditionalFunctions.contains(functionName)\n+                && !utilityFunctions.contains(functionName)) {\n+            throw new UnsupportedOperationException(", "originalCommit": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI5NTg5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r382295892", "bodyText": "good catch - looks like SemanticAnalyzer checks for unsupported functions", "author": "davidcui1225", "createdAt": "2020-02-20T22:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNzA4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381437082", "bodyText": "The input argument could be reduced as (MethodFiled field, Schema.Type resolvedType)", "author": "penghuo", "createdAt": "2020-02-19T17:43:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,34 +974,27 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {", "originalCommit": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyMzI1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381623259", "bodyText": "good catch - will change", "author": "davidcui1225", "createdAt": "2020-02-20T00:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNzA4Mg=="}], "type": "inlineReview"}, {"oid": "6afd24ee177cf4d44162bdea8c1622627a555907", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6afd24ee177cf4d44162bdea8c1622627a555907", "message": "addressed comments- refactored columnType variable and removed unsupported case check in SQLFunctions", "committedDate": "2020-02-20T22:52:09Z", "type": "commit"}, {"oid": "016795ece0b3c434d9cce0d251e054e03216f5ae", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/016795ece0b3c434d9cce0d251e054e03216f5ae", "message": "removed unused variables in SQLFunctionsTest", "committedDate": "2020-02-20T23:03:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NDE0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r382394149", "bodyText": "could it be simplified as return resolvedType", "author": "penghuo", "createdAt": "2020-02-21T04:40:27Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -974,25 +973,14 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(\n-            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {\n+    public static Schema.Type getScriptFunctionReturnType(MethodField field, Schema.Type resolvedType) {\n         Schema.Type returnType;\n         String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n-        if (!numberOperators.contains(functionName) && !mathConstants.contains(functionName)\n-                && !trigFunctions.contains(functionName) && !stringOperators.contains(functionName)\n-                && !stringFunctions.contains(functionName) && !binaryOperators.contains(functionName)\n-                && !dateFunctions.contains(functionName) && !conditionalFunctions.contains(functionName)\n-                && !utilityFunctions.contains(functionName)) {\n-            throw new UnsupportedOperationException(\n-                    String.format(\n-                            \"The following method is not supported in Schema: %s\",\n-                            functionName));\n-        }\n         if (functionName.equals(\"cast\")) {\n             String castType = ((SQLCastExpr) field.getExpression()).getDataType().getName();\n             return getCastFunctionReturnType(castType);\n         } else {\n-            returnType = scriptColumnType.get(fieldIndex);\n+            returnType = resolvedType;\n         }\n         return returnType;", "originalCommit": "016795ece0b3c434d9cce0d251e054e03216f5ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "32f1fa5054112320146882bc29cc03fa05c193db", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/32f1fa5054112320146882bc29cc03fa05c193db", "message": "addressed further comments", "committedDate": "2020-02-21T05:06:18Z", "type": "commit"}]}