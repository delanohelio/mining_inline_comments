{"pr_number": 731, "pr_title": "Support Head Command In PPL", "pr_createdAt": "2020-09-08T06:05:05Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731", "timeline": [{"oid": "709251df4251d8e48dd3761ad99d958caa19451e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/709251df4251d8e48dd3761ad99d958caa19451e", "message": "initial command impl", "committedDate": "2020-08-19T22:21:08Z", "type": "commit"}, {"oid": "d632f308ecd53384f1030d2c11cc80bc4a4bdb2e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d632f308ecd53384f1030d2c11cc80bc4a4bdb2e", "message": "finish initial head impl", "committedDate": "2020-08-20T22:15:57Z", "type": "commit"}, {"oid": "3928a5b55d867d1ba44a0fe38b4aefe15ad89763", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3928a5b55d867d1ba44a0fe38b4aefe15ad89763", "message": "while expression support & UT/ITs", "committedDate": "2020-08-26T15:32:29Z", "type": "commit"}, {"oid": "b61b1b58b5b82d64e6e129d950eede3e41cc9ffe", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b61b1b58b5b82d64e6e129d950eede3e41cc9ffe", "message": "add changes from implement-head-ppl-command", "committedDate": "2020-08-31T21:33:07Z", "type": "commit"}, {"oid": "cb19be1940d236bc34ff6e49283c9b831e06a5e7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cb19be1940d236bc34ff6e49283c9b831e06a5e7", "message": "fix checkstyle errors", "committedDate": "2020-08-31T23:16:11Z", "type": "commit"}, {"oid": "cea2945a4e69212a8ef0d58c8f5f62240b4bbdba", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cea2945a4e69212a8ef0d58c8f5f62240b4bbdba", "message": "checkstyle fix", "committedDate": "2020-09-01T17:44:35Z", "type": "commit"}, {"oid": "1e9b3be657184ad03a4c26fc44c534f485a6ee41", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1e9b3be657184ad03a4c26fc44c534f485a6ee41", "message": "- fix null pointer issue for head without while expr\n- update tests", "committedDate": "2020-09-02T19:22:18Z", "type": "commit"}, {"oid": "163b0580b576543ebb6577da044a73180b1d1857", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/163b0580b576543ebb6577da044a73180b1d1857", "message": "fix build errors", "committedDate": "2020-09-08T01:26:35Z", "type": "commit"}, {"oid": "2a8b3f4671ed8f4ec38978039c33a741d1d07579", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2a8b3f4671ed8f4ec38978039c33a741d1d07579", "message": "fix comments", "committedDate": "2020-09-08T02:17:14Z", "type": "commit"}, {"oid": "ce8c684e372e2be1def56d6178f00a3ffad1d377", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ce8c684e372e2be1def56d6178f00a3ffad1d377", "message": "update docs & integration test", "committedDate": "2020-09-08T05:55:16Z", "type": "commit"}, {"oid": "2c4639f432ec8a33d867ee2f6d18046f24e2dcb5", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2c4639f432ec8a33d867ee2f6d18046f24e2dcb5", "message": "merge develop", "committedDate": "2020-09-08T19:50:58Z", "type": "commit"}, {"oid": "2b71d253c9997dd9c847d122e9fd2ecf71406c3e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2b71d253c9997dd9c847d122e9fd2ecf71406c3e", "message": "change default value for keeplast to true", "committedDate": "2020-09-10T23:34:08Z", "type": "commit"}, {"oid": "1e1b9bb1fcca18b4dde808ad837a0cccb65367f9", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1e1b9bb1fcca18b4dde808ad837a0cccb65367f9", "message": "nit", "committedDate": "2020-09-11T17:42:35Z", "type": "commit"}, {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into ppl/head\n\n# Conflicts:\n#\tcore/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/logical/LogicalPlanDSL.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/DefaultImplementorTest.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/logical/LogicalPlanNodeVisitorTest.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/PhysicalPlanNodeVisitorTest.java\n#\telasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/executor/ElasticsearchExecutionProtectorTest.java", "committedDate": "2020-09-11T18:26:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI5NjEzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487296139", "bodyText": "Nit: Extra line", "author": "lyndonb-bq", "createdAt": "2020-09-11T21:20:49Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/ast/dsl/AstDSL.java", "diffHunk": "@@ -308,4 +332,5 @@ public static RareTopN rareTopN(UnresolvedPlan input, CommandType commandType,\n     return new RareTopN(input, commandType, noOfResults, Arrays.asList(fields), groupList)\n         .attach(input);\n   }\n+  ", "originalCommit": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0NzQ4OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487347488", "bodyText": "removed", "author": "rupal-bq", "createdAt": "2020-09-12T01:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI5NjEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMwNDA2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487304062", "bodyText": "This if statement logically equivalent to:\nif (isNull || isMissing || !booleanValue)\nWould suggest simplifying it to that", "author": "lyndonb-bq", "createdAt": "2020-09-11T21:43:27Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/HeadOperator.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprBooleanValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.LiteralExpression;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+@Getter\n+@EqualsAndHashCode\n+public class HeadOperator extends PhysicalPlan {\n+\n+  @Getter\n+  private final PhysicalPlan input;\n+  @Getter\n+  private final Boolean keepLast;\n+  @Getter\n+  private final Expression whileExpr;\n+  @Getter\n+  private final Integer number;\n+\n+  private static final Integer DEFAULT_LIMIT = 10;\n+  private static final Boolean IGNORE_LAST = false;\n+\n+  @EqualsAndHashCode.Exclude\n+  private int recordCount = 0;\n+  @EqualsAndHashCode.Exclude\n+  private boolean foundFirstFalse = false;\n+  @EqualsAndHashCode.Exclude\n+  private ExprValue next;\n+\n+  @NonNull\n+  public HeadOperator(PhysicalPlan input) {\n+    this(input, IGNORE_LAST, new LiteralExpression(ExprBooleanValue.of(true)), DEFAULT_LIMIT);\n+  }\n+\n+  /**\n+   * HeadOperator Constructor.\n+   *\n+   * @param input     Input {@link PhysicalPlan}\n+   * @param keepLast  Controls whether the last result in the result set is retained. The last\n+   *                  result returned is the result that caused the whileExpr to evaluate\n+   *                  to false or NULL.\n+   * @param whileExpr The search returns results until this expression evaluates to false\n+   * @param number    Number of specified results\n+   */\n+  @NonNull\n+  public HeadOperator(PhysicalPlan input, Boolean keepLast, Expression whileExpr, Integer number) {\n+    this.input = input;\n+    this.keepLast = keepLast;\n+    this.whileExpr = whileExpr;\n+    this.number = number;\n+  }\n+\n+  @Override\n+  public <R, C> R accept(PhysicalPlanNodeVisitor<R, C> visitor, C context) {\n+    return visitor.visitHead(this, context);\n+  }\n+\n+  @Override\n+  public List<PhysicalPlan> getChild() {\n+    return Collections.singletonList(input);\n+  }\n+\n+  @Override\n+  public boolean hasNext() {\n+    while (input.hasNext() && !foundFirstFalse) {\n+      ExprValue inputVal = input.next();\n+      ExprValue exprValue = whileExpr.valueOf(inputVal.bindingTuples());\n+\n+      if (recordCount < number) {\n+        if (!(!(exprValue.isNull() || exprValue.isMissing()) && (exprValue.booleanValue()))) {", "originalCommit": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0NzU0NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487347544", "bodyText": "Thanks, Lyndon. I upated PR with the simplified logic and removed while loop.", "author": "rupal-bq", "createdAt": "2020-09-12T01:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMwNDA2Mg=="}], "type": "inlineReview"}, {"oid": "7bf61cba4dc5a8e5e704ba649328d86536b29076", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7bf61cba4dc5a8e5e704ba649328d86536b29076", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into ppl/head", "committedDate": "2020-09-11T23:45:36Z", "type": "commit"}, {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "message": "address PR comments", "committedDate": "2020-09-12T00:36:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMTE4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488301187", "bodyText": "2019 -> 2020", "author": "penghuo", "createdAt": "2020-09-14T23:55:27Z", "path": "core/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/RareTopNOperatorTest.java", "diffHunk": "@@ -1,3 +1,18 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "originalCommit": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNjUyNg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488326526", "bodyText": "fixed", "author": "rupal-bq", "createdAt": "2020-09-15T01:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMTE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjI2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488302261", "bodyText": "Doc", "author": "penghuo", "createdAt": "2020-09-14T23:58:57Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/HeadOperator.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprBooleanValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.LiteralExpression;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+@Getter", "originalCommit": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNjU1OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488326558", "bodyText": "added", "author": "rupal-bq", "createdAt": "2020-09-15T01:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjI2MQ=="}], "type": "inlineReview"}, {"oid": "857b9ddcd6d26a471efbc9a19971f7603d964175", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/857b9ddcd6d26a471efbc9a19971f7603d964175", "message": "address PR comments", "committedDate": "2020-09-15T01:13:10Z", "type": "commit"}]}