{"pr_number": 611, "pr_title": "ODBC: Report error from Excel when executing an invalid query", "pr_createdAt": "2020-07-23T22:01:42Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611", "timeline": [{"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1c605da92d382f9eed7d01aec495e33648d9efdd", "message": "add support for ODBC 2.x SQLError function\n\n- save error type and details on connection errors\n- start checking error type when reporting error (first: query syntax)", "committedDate": "2020-07-23T21:59:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1NzY1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r459757659", "bodyText": "You should check this Statement, connection, then environment rather than the other way around. The most recently constructed handle gets priority.", "author": "jduo", "createdAt": "2020-07-23T22:13:52Z", "path": "sql-odbc/src/odfesqlodbc/odbcapi.c", "diffHunk": "@@ -1367,4 +1367,33 @@ SQLRETURN SQL_API SQLColAttributes(SQLHSTMT StatementHandle,\n     LEAVE_STMT_CS(stmt);\n     return ret;\n }\n+\n+/*\tSQLError -> SQLDiagRec */\n+RETCODE SQL_API SQLError(SQLHENV EnvironmentHandle, SQLHDBC ConnectionHandle,\n+                         SQLHSTMT StatementHandle, SQLCHAR *Sqlstate,\n+                         SQLINTEGER *NativeError, SQLCHAR *MessageText,\n+                         SQLSMALLINT BufferLength, SQLSMALLINT *TextLength) {\n+    RETCODE ret;\n+    SQLSMALLINT RecNumber = 1;\n+\n+    MYLOG(ES_TRACE, \"entering\\n\");\n+\n+    if (EnvironmentHandle) {", "originalCommit": "1c605da92d382f9eed7d01aec495e33648d9efdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4OTM3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r460289375", "bodyText": "Reversed order of handle checks", "author": "jordanw-bq", "createdAt": "2020-07-24T21:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1NzY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1OTE0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r459759149", "bodyText": "SQLCHAR inputs aren't guaranteed to be UTF-8. On Windows it depends on the OS codepage for example (usually codepage CP1252), though on Windows the DM does the conversion for you. This should likely be a separate issue to fix.", "author": "jduo", "createdAt": "2020-07-23T22:17:49Z", "path": "sql-odbc/src/odfesqlodbc/odbcapiw.c", "diffHunk": "@@ -1005,3 +1006,63 @@ RETCODE SQL_API SQLSetConnectOptionW(HDBC ConnectionHandle, SQLUSMALLINT Option,\n     LEAVE_CONN_CS(conn);\n     return ret;\n }\n+\n+RETCODE SQL_API SQLErrorW(SQLHENV EnvironmentHandle, SQLHDBC ConnectionHandle,\n+                          SQLHSTMT StatementHandle, SQLWCHAR *Sqlstate,\n+                          SQLINTEGER *NativeError, SQLWCHAR *MessageText,\n+                          SQLSMALLINT BufferLength, SQLSMALLINT *TextLength) {\n+    RETCODE ret;\n+    SQLSMALLINT buflen;\n+    SQLSMALLINT tlen = 0;\n+    SQLSMALLINT RecNumber = 1;\n+    char qstr_ansi[8], *mtxt = NULL;\n+\n+    MYLOG(ES_TRACE, \"entering\\n\");\n+    buflen = 0;\n+    if (MessageText && BufferLength > 0) {\n+        buflen = BufferLength;\n+        mtxt = malloc(buflen);\n+    }\n+\n+    if (EnvironmentHandle) {\n+        ret = ESAPI_EnvError(EnvironmentHandle, RecNumber, (SQLCHAR *)qstr_ansi,\n+                             NativeError, (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else if (ConnectionHandle) {\n+        ret = ESAPI_ConnectError(ConnectionHandle, RecNumber,\n+                                 (SQLCHAR *)qstr_ansi, NativeError,\n+                                 (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else if (StatementHandle) {\n+        ret = ESAPI_StmtError(StatementHandle, RecNumber, (SQLCHAR *)qstr_ansi,\n+                              NativeError, (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else {\n+        ret = SQL_ERROR;\n+    }\n+\n+    if (SQL_SUCCEEDED(ret)) {\n+        if (Sqlstate)\n+            utf8_to_ucs2(qstr_ansi, -1, Sqlstate, 6);\n+        if (mtxt && tlen <= BufferLength) {\n+            SQLULEN ulen = utf8_to_ucs2_lf(mtxt, tlen, FALSE, MessageText,", "originalCommit": "1c605da92d382f9eed7d01aec495e33648d9efdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1OTg1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r459759853", "bodyText": "\ud83d\udc4d Will log another issue for this", "author": "jordanw-bq", "createdAt": "2020-07-23T22:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1OTE0OQ=="}], "type": "inlineReview"}, {"oid": "20cc23e1555073d377c61f900b3468dcb1786d45", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/20cc23e1555073d377c61f900b3468dcb1786d45", "message": "qualify error enum names to avoid conflict with Windows libraries", "committedDate": "2020-07-23T23:28:58Z", "type": "commit"}, {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d0b1eda7353061a863e4ceab3c83d301d021f127", "message": "reversing order of SQLError handle checks", "committedDate": "2020-07-24T21:08:33Z", "type": "commit"}]}