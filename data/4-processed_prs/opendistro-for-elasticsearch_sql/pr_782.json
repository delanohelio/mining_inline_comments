{"pr_number": 782, "pr_title": "Support ORDER BY in new SQL engine", "pr_createdAt": "2020-10-16T00:05:06Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782", "timeline": [{"oid": "c8efdffb6ad2ee54dfa5d7869da5af61d770d834", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8efdffb6ad2ee54dfa5d7869da5af61d770d834", "message": "Change grammar and ast builder to support order by", "committedDate": "2020-10-14T23:19:31Z", "type": "commit"}, {"oid": "236d3a7b861e9e1d69706d942ea827bd3f2dbfbb", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/236d3a7b861e9e1d69706d942ea827bd3f2dbfbb", "message": "Add UT for order by function", "committedDate": "2020-10-14T23:32:56Z", "type": "commit"}, {"oid": "5370709933263d3a660ca7a69c3dc460671b86d2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5370709933263d3a660ca7a69c3dc460671b86d2", "message": "Pass jacoco for sql", "committedDate": "2020-10-14T23:57:52Z", "type": "commit"}, {"oid": "67eacf2b9b5ad92bb36e0dd99e99ea46587a57a5", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/67eacf2b9b5ad92bb36e0dd99e99ea46587a57a5", "message": "Fix order by function issue", "committedDate": "2020-10-15T00:44:11Z", "type": "commit"}, {"oid": "18544fd63f90dc086452c0f8622c452b45a5ae61", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/18544fd63f90dc086452c0f8622c452b45a5ae61", "message": "Improve test framework to support order by comparison", "committedDate": "2020-10-15T17:29:09Z", "type": "commit"}, {"oid": "c4220e7d429e4b93241d1d9c2ead0696756b4448", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c4220e7d429e4b93241d1d9c2ead0696756b4448", "message": "Add more comparison tests", "committedDate": "2020-10-15T17:55:38Z", "type": "commit"}, {"oid": "66fe7240a3bf452e401b8bd972a5833455482775", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/66fe7240a3bf452e401b8bd972a5833455482775", "message": "Add test for issue #123", "committedDate": "2020-10-15T18:41:16Z", "type": "commit"}, {"oid": "dd1674586b7736d971169a9e35304b06916b70d2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dd1674586b7736d971169a9e35304b06916b70d2", "message": "Add test for issue #674", "committedDate": "2020-10-15T18:49:26Z", "type": "commit"}, {"oid": "951f68829f472b0c11a008b38ee157c5d278b7d9", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/951f68829f472b0c11a008b38ee157c5d278b7d9", "message": "Avoid sort again when explain diff for order by query", "committedDate": "2020-10-15T20:18:03Z", "type": "commit"}, {"oid": "8c48bcc7f655f081a01cbcdbb5f4ebb7a2ec44be", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8c48bcc7f655f081a01cbcdbb5f4ebb7a2ec44be", "message": "Replace aggregator in order by clause", "committedDate": "2020-10-15T23:32:19Z", "type": "commit"}, {"oid": "5d120ceed4a195d43f2c5e2e9b456e005090fa5c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5d120ceed4a195d43f2c5e2e9b456e005090fa5c", "message": "Skip date_format test", "committedDate": "2020-10-15T23:53:05Z", "type": "commit"}, {"oid": "5987e257282e0e4e4d22fe1a80957d55887848b2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5987e257282e0e4e4d22fe1a80957d55887848b2", "message": "Add doctest", "committedDate": "2020-10-16T00:19:38Z", "type": "commit"}, {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3c84a54a7d621792cdd538d6e039b6b60cfe8c1c", "message": "Fix doctest format", "committedDate": "2020-10-16T00:28:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NTE4OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#discussion_r508645188", "bodyText": "It is also could be sort by, right?", "author": "penghuo", "createdAt": "2020-10-20T15:57:51Z", "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java", "diffHunk": "@@ -86,6 +99,52 @@ public void collect(QuerySpecificationContext query, String queryString) {\n     query.accept(new QuerySpecificationCollector(queryString));\n   }\n \n+  /**\n+   * Replace unresolved expression if it's an alias or ordinal that represents\n+   * an actual expression in SELECT list.\n+   * @param expr item to be replaced\n+   * @return select item that the given expr represents\n+   */\n+  public UnresolvedExpression replaceIfAliasOrOrdinal(UnresolvedExpression expr) {\n+    if (isIntegerLiteral(expr)) {\n+      return getSelectItemByOrdinal(expr);\n+    } else if (isSelectAlias(expr)) {\n+      return getSelectItemByAlias(expr);\n+    } else {\n+      return expr;\n+    }\n+  }\n+\n+  private boolean isIntegerLiteral(UnresolvedExpression expr) {\n+    if (!(expr instanceof Literal)) {\n+      return false;\n+    }\n+\n+    if (((Literal) expr).getType() != DataType.INTEGER) {\n+      throw new SemanticCheckException(StringUtils.format(\n+          \"Non-integer constant [%s] found in GROUP BY clause\", expr));\n+    }\n+    return true;\n+  }\n+\n+  private UnresolvedExpression getSelectItemByOrdinal(UnresolvedExpression expr) {\n+    int ordinal = (Integer) ((Literal) expr).getValue();\n+    if (ordinal <= 0 || ordinal > selectItems.size()) {\n+      throw new SemanticCheckException(StringUtils.format(\n+          \"Group by ordinal [%d] is out of bound of select item list\", ordinal));", "originalCommit": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY4NjcyNA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#discussion_r508686724", "bodyText": "I forgot to change the error message. Will do. Thanks!", "author": "dai-chen", "createdAt": "2020-10-20T16:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NTE4OA=="}], "type": "inlineReview"}, {"oid": "1c37ae4e3bab69e2ee377922f2b426e94d3a7665", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1c37ae4e3bab69e2ee377922f2b426e94d3a7665", "message": "Address PR comments", "committedDate": "2020-10-20T19:00:39Z", "type": "commit"}, {"oid": "2286933e6d11b6e236c95b54c038e47ede4256be", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2286933e6d11b6e236c95b54c038e47ede4256be", "message": "Merge branch 'develop' into support-order-by-in-new-sql-engine", "committedDate": "2020-10-20T19:00:45Z", "type": "commit"}]}