{"pr_number": 346, "pr_title": "Add post processing logic for aggregation query.", "pr_createdAt": "2020-01-14T16:38:40Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346", "timeline": [{"oid": "e8096980a017aef3a3318f113d161e3dc48f1686", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e8096980a017aef3a3318f113d161e3dc48f1686", "message": "update", "committedDate": "2020-01-13T18:47:01Z", "type": "commit"}, {"oid": "200f6039341b468d6d42b0a18804e60a4ea98269", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/200f6039341b468d6d42b0a18804e60a4ea98269", "message": "update", "committedDate": "2020-01-13T21:26:00Z", "type": "commit"}, {"oid": "caf3846bf43db7311b8a70d1bea67693eae44711", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/caf3846bf43db7311b8a70d1bea67693eae44711", "message": "update", "committedDate": "2020-01-13T23:48:42Z", "type": "commit"}, {"oid": "e865ef5a155f75e26dae2badad52e39bd1002311", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e865ef5a155f75e26dae2badad52e39bd1002311", "message": "update", "committedDate": "2020-01-14T14:50:14Z", "type": "commit"}, {"oid": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "message": "add post processing logic for aggregation query", "committedDate": "2020-01-14T16:10:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NDM0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r366544342", "bodyText": "can use .collect(Collectors.joining(\",\", \"<\", \">\")) directly and same suggestion for ExprTupleValue.toString().", "author": "dai-chen", "createdAt": "2020-01-14T20:00:11Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/domain/BindingTuple.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.domain;\n+\n+\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprMissingValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValue;\n+import lombok.Builder;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.Singular;\n+import org.json.JSONObject;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValueFactory.fromJson;\n+\n+/**\n+ * BindingTuple represents the a relationship between bindingName and ExprValue.\n+ * e.g. The operation output column name is bindingName, the value is the ExprValue.\n+ */\n+@Builder\n+@Getter\n+@EqualsAndHashCode\n+public class BindingTuple {\n+    @Singular(\"binding\")\n+    private Map<String, ExprValue> bindingMap;\n+\n+    /**\n+     * Resolve the Binding Name in BindingTuple context.\n+     * @param bindingName binding name.\n+     * @return binding value.\n+     */\n+    public ExprValue resolve(String bindingName) {\n+        return bindingMap.getOrDefault(bindingName, new ExprMissingValue());\n+    }\n+\n+    @Override\n+    public String toString() {\n+        final StringBuffer sb = new StringBuffer(\"<\");\n+        final List<String> list = bindingMap.entrySet()\n+                .stream()\n+                .map(entry -> String.format(\"%s:%s\", entry.getKey(), entry.getValue()))\n+                .collect(Collectors.toList());", "originalCommit": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTQ1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r368041455", "bodyText": "Done. For BindingTuple and ExprTupleValue.", "author": "penghuo", "createdAt": "2020-01-17T17:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NDM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjgwNA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r366546804", "bodyText": "can reuse return from(json.toMap()) ?\nBtw, what's difference between creating BindingTuple by constructor and builder?", "author": "dai-chen", "createdAt": "2020-01-14T20:05:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/domain/BindingTuple.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.domain;\n+\n+\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprMissingValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValue;\n+import lombok.Builder;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.Singular;\n+import org.json.JSONObject;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValueFactory.fromJson;\n+\n+/**\n+ * BindingTuple represents the a relationship between bindingName and ExprValue.\n+ * e.g. The operation output column name is bindingName, the value is the ExprValue.\n+ */\n+@Builder\n+@Getter\n+@EqualsAndHashCode\n+public class BindingTuple {\n+    @Singular(\"binding\")\n+    private Map<String, ExprValue> bindingMap;\n+\n+    /**\n+     * Resolve the Binding Name in BindingTuple context.\n+     * @param bindingName binding name.\n+     * @return binding value.\n+     */\n+    public ExprValue resolve(String bindingName) {\n+        return bindingMap.getOrDefault(bindingName, new ExprMissingValue());\n+    }\n+\n+    @Override\n+    public String toString() {\n+        final StringBuffer sb = new StringBuffer(\"<\");\n+        final List<String> list = bindingMap.entrySet()\n+                .stream()\n+                .map(entry -> String.format(\"%s:%s\", entry.getKey(), entry.getValue()))\n+                .collect(Collectors.toList());\n+        sb.append(String.join(\",\", list));\n+        sb.append('>');\n+        return sb.toString();\n+    }\n+\n+    public static BindingTuple from(Map<String, Object> map) {\n+        Map<String, ExprValue> ssValueMap = new HashMap<>();\n+        for (Map.Entry<String, Object> entry : map.entrySet()) {\n+            ssValueMap.put(entry.getKey(), fromJson(entry.getValue()));\n+        }\n+        return BindingTuple.builder()\n+                .bindingMap(ssValueMap)\n+                .build();\n+    }\n+\n+    public static BindingTuple from(JSONObject json) {\n+        Map<String, ExprValue> valueMap = new HashMap<>();\n+        for (String s : json.keySet()) {\n+            valueMap.put(s, fromJson(json.get(s)));\n+        }\n+        return new BindingTuple(valueMap);", "originalCommit": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MDg5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r368050899", "bodyText": "Done. There is no with constructor and builder. per https://projectlombok.org/features/Builder.\nFinally, applying @Builder to a class is as if you added @AllArgsConstructor(access = AccessLevel.PACKAGE) to the class and applied the @Builder annotation to this all-args-constructor.\nModify the code to use builder instead of constructor to build BindingTuple.", "author": "penghuo", "createdAt": "2020-01-17T17:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3NjYyMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r366576620", "bodyText": "I'm thinking can we use generic type for this interface and method and get rid of all the xxxValue methods below? Because I notice actually each implementation class implements only one of them.", "author": "dai-chen", "createdAt": "2020-01-14T21:17:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/model/ExprValue.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.model;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The definition of the Value used in the Expression\n+ */\n+public interface ExprValue {\n+    default Object value() {\n+        throw new IllegalStateException(\"invalid value operation on \" + kind());\n+    }", "originalCommit": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NDU5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r368194597", "bodyText": "I suggested to postpone the review of Expression on the next PR which will focus on expression implementation.", "author": "penghuo", "createdAt": "2020-01-18T01:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3NjYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2NDcxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r369164711", "bodyText": "Sure. Thanks!", "author": "dai-chen", "createdAt": "2020-01-21T18:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3NjYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzA4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r367037089", "bodyText": "Is this same as BindingTuple.from()?", "author": "dai-chen", "createdAt": "2020-01-15T18:30:02Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/planner/physical/node/scroll/PhysicalScroll.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.query.planner.physical.node.scroll;\n+\n+import com.amazon.opendistroforelasticsearch.sql.exception.SqlParseException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.domain.BindingTuple;\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.query.AggregationQueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.QueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.planner.core.ExecuteParams;\n+import com.amazon.opendistroforelasticsearch.sql.query.planner.core.PlanNode;\n+import com.amazon.opendistroforelasticsearch.sql.query.planner.physical.PhysicalOperator;\n+import com.amazon.opendistroforelasticsearch.sql.query.planner.physical.Row;\n+import com.amazon.opendistroforelasticsearch.sql.query.planner.physical.estimation.Cost;\n+import lombok.RequiredArgsConstructor;\n+import lombok.SneakyThrows;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.search.aggregations.Aggregations;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValueFactory.fromJson;\n+import static com.amazon.opendistroforelasticsearch.sql.query.planner.physical.node.scroll.SearchAggregationResponseHelper.flatten;\n+\n+/**\n+ * The definition of Scroll Operator.\n+ */\n+@RequiredArgsConstructor\n+public class PhysicalScroll implements PhysicalOperator<BindingTuple> {\n+    private final QueryAction queryAction;\n+\n+    private Iterator<BindingTupleRow> rowIterator;\n+\n+    @Override\n+    public Cost estimate() {\n+        return null;\n+    }\n+\n+    @Override\n+    public PlanNode[] children() {\n+        return new PlanNode[0];\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+        return rowIterator.hasNext();\n+    }\n+\n+    @Override\n+    public Row<BindingTuple> next() {\n+        return rowIterator.next();\n+    }\n+\n+    @Override\n+    public void open(ExecuteParams params) {\n+        try {\n+            ActionResponse response = queryAction.explain().get();\n+            if (queryAction instanceof AggregationQueryAction) {\n+                populateSearchAggregationResponse(((SearchResponse) response).getAggregations());\n+            } else {\n+                throw new IllegalStateException(\"Not support QueryAction type: \" + queryAction.getClass());\n+            }\n+        } catch (SqlParseException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private void populateSearchAggregationResponse(Aggregations aggs) {\n+        List<Map<String, Object>> flatten = flatten(aggs);\n+        List<BindingTupleRow> bindingTupleList = flatten.stream().map(map -> {\n+            Map<String, ExprValue> ssValueMap = new HashMap<>();\n+            for (Map.Entry<String, Object> entry : map.entrySet()) {\n+                ssValueMap.put(entry.getKey(), fromJson(entry.getValue()));\n+            }\n+            return BindingTuple.builder().bindingMap(ssValueMap).build();", "originalCommit": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MTYyNA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r368051624", "bodyText": "Done. Using populateSearchAggregationResponse function from SearchAggregationResponseHelper.", "author": "penghuo", "createdAt": "2020-01-17T17:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTUzOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r367039538", "bodyText": "Is this duplicate as the private method of same name in PhysicalScroll?", "author": "dai-chen", "createdAt": "2020-01-15T18:35:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/planner/physical/node/scroll/SearchAggregationResponseHelper.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.query.planner.physical.node.scroll;\n+\n+import com.amazon.opendistroforelasticsearch.sql.expression.domain.BindingTuple;\n+import com.google.common.annotations.VisibleForTesting;\n+import org.elasticsearch.search.aggregations.Aggregation;\n+import org.elasticsearch.search.aggregations.Aggregations;\n+import org.elasticsearch.search.aggregations.bucket.histogram.Histogram;\n+import org.elasticsearch.search.aggregations.bucket.terms.Terms;\n+import org.elasticsearch.search.aggregations.metrics.NumericMetricsAggregation;\n+import org.elasticsearch.search.aggregations.metrics.Percentile;\n+import org.elasticsearch.search.aggregations.metrics.Percentiles;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+/**\n+ * The definition of Search {@link Aggregations} parser helper class.\n+ */\n+public class SearchAggregationResponseHelper {\n+    public static List<BindingTupleRow> populateSearchAggregationResponse(Aggregations aggs) {", "originalCommit": "8ffd52b0a349d37da62f90db81a9bd4a08c510b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MTY3NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r368051674", "bodyText": "Done. Using populateSearchAggregationResponse function from SearchAggregationResponseHelper.", "author": "penghuo", "createdAt": "2020-01-17T17:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTUzOA=="}], "type": "inlineReview"}, {"oid": "58c195ee1b5c3d3234a6076448dad9067632155c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/58c195ee1b5c3d3234a6076448dad9067632155c", "message": "update", "committedDate": "2020-01-18T01:14:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzNDQ2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r369334469", "bodyText": "Does it work if the number of parameters in basic arithmetic expressions is indeterminate? eg. max(field_1) + max(field_2) + max(field_3) + ...", "author": "chloe-zh", "createdAt": "2020-01-22T01:45:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/core/ExpressionFactory.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.core;\n+\n+\n+import com.amazon.opendistroforelasticsearch.sql.expression.domain.BindingTuple;\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValueFactory;\n+import lombok.RequiredArgsConstructor;\n+\n+import java.util.function.BiFunction;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.expression.model.ExprValueFactory.doubleValue;\n+\n+/**\n+ * The definition of Expression factory.\n+ */\n+public class ExpressionFactory {\n+    /**\n+     * Reference\n+     */\n+    public static Expression ref(String bindingName) {\n+        return new Expression() {\n+            @Override\n+            public String toString() {\n+                return String.format(\"%s\", bindingName);\n+            }\n+\n+            @Override\n+            public ExprValue valueOf(BindingTuple tuple) {\n+                return tuple.resolve(bindingName);\n+            }\n+        };\n+    }\n+\n+    @RequiredArgsConstructor\n+    enum ArithmeticOperation {\n+        ADD(Integer::sum, Double::sum),\n+        SUB((arg1, arg2) -> arg1 - arg2,\n+            (arg1, arg2) -> arg1 - arg2);\n+\n+        private final BiFunction<Integer, Integer, Integer> integerFunc;\n+        private final BiFunction<Double, Double, Double> doubleFunc;\n+    }\n+\n+    public static Expression add(Expression left, Expression right) {\n+        return new Expression() {\n+            @Override\n+            public ExprValue valueOf(BindingTuple tuple) {\n+                return arithmetic(ArithmeticOperation.ADD, left.valueOf(tuple), right.valueOf(tuple));\n+            }\n+\n+            @Override\n+            public String toString() {\n+                return String.format(\"add(%s,%s)\", left, right);\n+            }\n+        };\n+    }\n+\n+    public static Expression sub(Expression left, Expression right) {\n+        return new Expression() {\n+            @Override\n+            public ExprValue valueOf(BindingTuple tuple) {\n+                return arithmetic(ArithmeticOperation.ADD, left.valueOf(tuple), right.valueOf(tuple));\n+            }\n+\n+            @Override\n+            public String toString() {\n+                return String.format(\"sub(%s,%s)\", left, right);\n+            }\n+        };\n+    }\n+\n+    public static Expression log(Expression expr) {\n+        return new Expression() {\n+            @Override\n+            public ExprValue valueOf(BindingTuple tuple) {\n+                final ExprValue exprValue = expr.valueOf(tuple);\n+                switch (exprValue.kind()) {\n+                    case INTEGER_VALUE:\n+                        return doubleValue(Math.log(exprValue.numberValue().intValue()));\n+                    case DOUBLE_VALUE:\n+                        return doubleValue(Math.log(exprValue.numberValue().doubleValue()));\n+                    default:\n+                        throw new RuntimeException(\"unsupported log operand: \" + exprValue.kind());\n+                }\n+            }\n+\n+            @Override\n+            public String toString() {\n+                return String.format(\"log(%s)\", expr);\n+            }\n+        };\n+    }\n+\n+    public static Expression cast(Expression expr) {\n+        return new Expression() {\n+            @Override\n+            public ExprValue valueOf(BindingTuple tuple) {\n+                return expr.valueOf(tuple);\n+            }\n+\n+            @Override\n+            public String toString() {\n+                return String.format(\"cast(%s)\", expr);\n+            }\n+        };\n+    }\n+\n+    private static ExprValue arithmetic(ArithmeticOperation op, ExprValue v1, ExprValue v2) {\n+        if (v1.kind() != v2.kind()) {\n+            throw new RuntimeException(\n+                    String.format(\"operation with different type is unsupported: %s(%s, %s)\", op.name(), v1.kind(),\n+                                  v2.kind()));\n+        } else {\n+            switch (v1.kind()) {\n+                case DOUBLE_VALUE:\n+                    return ExprValueFactory.doubleValue(\n+                            op.doubleFunc.apply(v1.numberValue().doubleValue(), v2.numberValue().doubleValue()));\n+                case INTEGER_VALUE:\n+                    return ExprValueFactory\n+                            .integerValue(\n+                                    op.integerFunc.apply(v1.numberValue().intValue(), v2.numberValue().intValue()));\n+                default:\n+                    throw new RuntimeException(String.format(\"unsupported operation: %s(%s, %s)\", op.name(), v1.kind(),\n+                                                             v2.kind()));\n+            }\n+        }\n+    }\n+}", "originalCommit": "58c195ee1b5c3d3234a6076448dad9067632155c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcxNzQ5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/346#discussion_r369717493", "bodyText": "Yes, it will be compile as add(max(field_1),add(max(field_2),max(field_3)).", "author": "penghuo", "createdAt": "2020-01-22T18:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzNDQ2OQ=="}], "type": "inlineReview"}]}