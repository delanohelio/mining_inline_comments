{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MDUyNTM2", "number": 3790, "title": "Correct AnnotatedIntersectionTypes", "bodyText": "General facts about intersections in javac that should make this pull request easier to review:\n\nIn source code, intersections can only be written as a cast type or an upper bound of a type parameter.\na. For cast types, the intersection type is parsed into an IntersectionTypeTree.\nb. For type variable upper bounds, the intersection type is parsed into a list of trees\nIn byte code, the Checker Framework only reads annotations on intersections for type parameter upper bounds.\nIntersection types can also arise from capture conversion and least upper bounds.\nThe bounds of explicitly written intersections must be declared types, but intersections from LUB or capture conversion can be any kind of type.\n\nChanges in this pull request:\nDefaulting rules for the primary annotation of an intersection type:\n\nOne or more of the bounds have an explicit annotation: the default annotation is the first explicit annotation.  (I tried making the default the glb of the (explicit or defaulted) annotations on the bounds, but I found this confusing in the case of casts.  We can discuss this further.)\nZero bounds have an explicit annotation: the default annotation of the location is applied.  (So, either explicit upper bound defaults, or for casts, the annotation of the cast expression.)\n\nWarning:\nIf any explicit annotation on a bound is not the same as the primary annotation, then a warning is issued.  (I was going to put this in a separate pull request, but it needs to be in this one so that the test cases are easier to understand.)\nChanges to AnnotatedIntersectionType:\n\nAdding a primary annotation to an intersection type causes that annotation to be copied to its bounds.  This is similar to what happens when an annotation is added to a type variable.\nNew method getBounds returns a list of the bounds of the intersection type.  (This used to be done via directSuperTypes method.\nThe bounds can be any AnnotatedTypeMirror if the intersection arises from capture conversion.\n\nFixes #868; Fixes #3349; Fixes #3362; Fixes #3659.", "createdAt": "2020-10-16T19:21:50Z", "url": "https://github.com/typetools/checker-framework/pull/3790", "merged": true, "mergeCommit": {"oid": "9dbf0c7c06210a9cb926242a8181eb0dd888ab04"}, "closed": true, "closedAt": "2020-10-20T20:05:24Z", "author": {"login": "smillst"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSOsXSAH2gAyNTA1MDUyNTM2OmZkYmY0ZTY4MmQ2NTJjMTg0ZGYwMzY0MGY0MTkzYzU3M2VjMDU3MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUbQZYAH2gAyNTA1MDUyNTM2OjIxZjdlYzkwYmE0OTkzMGY0ZmNkMjE5NzE0NjAxYzc3NDJiNGNjYTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fdbf4e682d652c184df03640f4193c573ec0571c", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/fdbf4e682d652c184df03640f4193c573ec0571c", "committedDate": "2020-10-13T20:35:00Z", "message": "The bounds of intersection types are not just declared types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "207102a5396a9094e0d522a2dc4a890b91a391c7", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/207102a5396a9094e0d522a2dc4a890b91a391c7", "committedDate": "2020-10-14T20:28:22Z", "message": "checkpoint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcf3ae89cf12c8470129725b20c6ce0372310610", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/fcf3ae89cf12c8470129725b20c6ce0372310610", "committedDate": "2020-10-14T20:28:35Z", "message": "Merge remote-tracking branch 'origin/master' into intersections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538bdd377a7b8bbbf222897036a414b65594cf3b", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/538bdd377a7b8bbbf222897036a414b65594cf3b", "committedDate": "2020-10-14T20:32:28Z", "message": "Replace code with equ."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00da1a09f1b61edb76f825ff815b0d898e40e5fb", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/00da1a09f1b61edb76f825ff815b0d898e40e5fb", "committedDate": "2020-10-14T20:46:34Z", "message": "Merge branch 'typevar-intersection' into intersections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d183d6907d8a94e6d419d05e34f39675993f80", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/a9d183d6907d8a94e6d419d05e34f39675993f80", "committedDate": "2020-10-14T21:56:17Z", "message": "Doneish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098ec6ce5f3d27bd968bc1706e774407e71f896c", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/098ec6ce5f3d27bd968bc1706e774407e71f896c", "committedDate": "2020-10-14T22:30:36Z", "message": "Fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34b5e1a7c3681c49a26fca0f46da44e9b7f44381", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/34b5e1a7c3681c49a26fca0f46da44e9b7f44381", "committedDate": "2020-10-14T22:36:26Z", "message": "Finish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f8cdfe4b77f7afc3cff66836636f353e1ff4c3c", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/6f8cdfe4b77f7afc3cff66836636f353e1ff4c3c", "committedDate": "2020-10-14T22:36:59Z", "message": "Merge remote-tracking branch 'origin/master' into intersections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "781fda12fcbfefcb558a42bade8d1bbf230e6ba8", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/781fda12fcbfefcb558a42bade8d1bbf230e6ba8", "committedDate": "2020-10-15T16:22:47Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into intersections\n\n# Conflicts:\n#\tframework/src/main/java/org/checkerframework/framework/flow/CFTreeBuilder.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51fd050303d2719cbea3ae3664eed1c7d6ba6417", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/51fd050303d2719cbea3ae3664eed1c7d6ba6417", "committedDate": "2020-10-15T16:23:43Z", "message": "Adapt to changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccc770dc071de9ecf0e1db3baf47f671fa4adbc", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/eccc770dc071de9ecf0e1db3baf47f671fa4adbc", "committedDate": "2020-10-15T16:47:32Z", "message": "check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f8250f5d47e28189d3903e9e1b52d480a1eb80c", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/0f8250f5d47e28189d3903e9e1b52d480a1eb80c", "committedDate": "2020-10-15T16:57:21Z", "message": "Remove method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cc352e291d4cd0d7732b0a8c474456a0b0eed72", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/4cc352e291d4cd0d7732b0a8c474456a0b0eed72", "committedDate": "2020-10-15T17:04:02Z", "message": "Rename."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90190eca860c493b959e2eca2368705ca4e5878", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/d90190eca860c493b959e2eca2368705ca4e5878", "committedDate": "2020-10-15T17:57:11Z", "message": "Added changelog."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d12899e66118bc50d966afc5578171bea30d9f0", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/3d12899e66118bc50d966afc5578171bea30d9f0", "committedDate": "2020-10-15T20:38:42Z", "message": "Add warning."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5962258506a11b7e14f2a79c1e2974a8d0e66736", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/5962258506a11b7e14f2a79c1e2974a8d0e66736", "committedDate": "2020-10-16T17:40:38Z", "message": "Fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2dced7ccea901c5e7b5ca31c9088be61b9d95d8", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/f2dced7ccea901c5e7b5ca31c9088be61b9d95d8", "committedDate": "2020-10-16T17:41:43Z", "message": "Merge remote-tracking branch 'origin/master' into warn-intersections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d5c32e52c2efe223209c8a1e0d99a4bfc72a65", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/22d5c32e52c2efe223209c8a1e0d99a4bfc72a65", "committedDate": "2020-10-16T17:54:29Z", "message": "Tweaks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b47cd4223f40119af30be741c001ed08324b0f", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/62b47cd4223f40119af30be741c001ed08324b0f", "committedDate": "2020-10-16T19:11:11Z", "message": "Add expected warnings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24bd31b6138e677591d15ef0e48e2dfe9cafdb0f", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/24bd31b6138e677591d15ef0e48e2dfe9cafdb0f", "committedDate": "2020-10-16T19:16:31Z", "message": "Add Javadoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODcxMjM4", "url": "https://github.com/typetools/checker-framework/pull/3790#pullrequestreview-510871238", "createdAt": "2020-10-17T03:48:31Z", "commit": {"oid": "24bd31b6138e677591d15ef0e48e2dfe9cafdb0f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMzo0ODozMVrOHjT-lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwNDowMDo0MFrOHjUB-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4OTUyNA==", "bodyText": "In this example, the annotation isn't just copied to the primary annotation location, but to every bound of the intersection.\nAlso, it would be helpful to indicate that the primary annotation location is different than all the annotations on the bounds.  The example doesn't actually show the primary annotation location.  So, I find the example a bit confusing.", "url": "https://github.com/typetools/checker-framework/pull/3790#discussion_r506789524", "createdAt": "2020-10-17T03:48:31Z", "author": {"login": "mernst"}, "path": "framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeMirror.java", "diffHunk": "@@ -2118,27 +2132,67 @@ public AnnotatedIntersectionType shallowCopy() {\n             return shallowCopy(true);\n         }\n \n-        protected List<AnnotatedDeclaredType> supertypes;\n-\n+        /**\n+         * {@inheritDoc}\n+         *\n+         * <p>This returns the same types as {@link #getBounds()}.\n+         *\n+         * @return the direct super types of this\n+         */\n         @Override\n-        public List<AnnotatedDeclaredType> directSuperTypes() {\n-            if (supertypes == null) {\n+        public List<? extends AnnotatedTypeMirror> directSuperTypes() {\n+            return getBounds();\n+        }\n+\n+        /**\n+         * This returns the bounds of the intersection type. Although only declared types can appear\n+         * in an explicitly written intersections, during capture conversion, intersections with\n+         * other kinds of types are created.\n+         *\n+         * <p>This returns the same types as {@link #directSuperTypes()}.\n+         *\n+         * @return the bounds of this, which are also the direct super types of this\n+         */\n+        public List<AnnotatedTypeMirror> getBounds() {\n+            if (bounds == null) {\n                 List<? extends TypeMirror> ubounds = ((IntersectionType) actualType).getBounds();\n-                List<AnnotatedDeclaredType> res = new ArrayList<>(ubounds.size());\n+                List<AnnotatedTypeMirror> res = new ArrayList<>(ubounds.size());\n                 for (TypeMirror bnd : ubounds) {\n-                    res.add((AnnotatedDeclaredType) createType(bnd, atypeFactory, false));\n+                    res.add(createType(bnd, atypeFactory, false));\n                 }\n-                supertypes = Collections.unmodifiableList(res);\n+                bounds = Collections.unmodifiableList(res);\n+                fixupBoundAnnotations();\n             }\n-            return supertypes;\n+            return bounds;\n         }\n \n-        public List<AnnotatedDeclaredType> directSuperTypesField() {\n-            return supertypes;\n+        /**\n+         * Sets the bounds.\n+         *\n+         * @param bounds bounds to use\n+         */\n+        /*default-visibility*/ void setBounds(List<AnnotatedTypeMirror> bounds) {\n+            this.bounds = bounds;\n         }\n \n-        void setDirectSuperTypes(List<AnnotatedDeclaredType> supertypes) {\n-            this.supertypes = new ArrayList<>(supertypes);\n+        /**\n+         * Copy the first annotation (in each hierarchy) on a bound to the primary annotation\n+         * location of the intersection type.\n+         *\n+         * <p>For example, {@code @NonNull Object & @Initialized @Nullable Serializable} is changed\n+         * to {@code @NonNull @Initialized Object & @Initialized @NonNull Serializable}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24bd31b6138e677591d15ef0e48e2dfe9cafdb0f"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc5MDM5Mw==", "bodyText": "When this is called, have the primary annotations already been applied to every bound, so that each bound stands on its own without any need to refer to the primary annotations?", "url": "https://github.com/typetools/checker-framework/pull/3790#discussion_r506790393", "createdAt": "2020-10-17T04:00:40Z", "author": {"login": "mernst"}, "path": "framework/src/main/java/org/checkerframework/framework/type/DefaultTypeHierarchy.java", "diffHunk": "@@ -1016,6 +990,26 @@ protected boolean visitIntersectionSupertype(\n         return result;\n     }\n \n+    /**\n+     * An intersection is a subtype if one of its bounds is a subtype of {@code supertype}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24bd31b6138e677591d15ef0e48e2dfe9cafdb0f"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc6386f077cfc3bc1ae07006944b7abea0ad70cb", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/dc6386f077cfc3bc1ae07006944b7abea0ad70cb", "committedDate": "2020-10-20T16:15:56Z", "message": "Merge remote-tracking branch 'origin/master' into warn-intersections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21f7ec90ba49930f4fcd219714601c7742b4cca6", "author": {"user": {"login": "smillst", "name": "Suzanne Millstein"}}, "url": "https://github.com/typetools/checker-framework/commit/21f7ec90ba49930f4fcd219714601c7742b4cca6", "committedDate": "2020-10-20T16:21:04Z", "message": "Add comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2581, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}