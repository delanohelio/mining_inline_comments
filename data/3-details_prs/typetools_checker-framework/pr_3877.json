{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NDE2MDM1", "number": 3877, "title": "Define method getDefaultValueAnnotatedType", "bodyText": "The CI failures are due to missing \"WARNING: Illegal reflective access\" in expected.txt files.  I'd like to find a way to avoid those warnings.\nThey occur because this implementation uses reflection to access private members.  What is a better implementation?\nIn case it helps, my end goal is to determine whether a field's annotation is compatible with the default value that Java uses for uninitialized fields.  That is, the client code looks like this:\n            AnnotatedTypeMirror fieldType = defaultValueAtypeFactory.getAnnotatedType(field);\n            AnnotatedTypeMirror defaultValueType =\n                    defaultValueAtypeFactory.getDefaultValueAnnotatedType(\n                            fieldType.getUnderlyingType());\n            if (!defaultValueAtypeFactory\n                    .getTypeHierarchy()\n                    .isSubtype(defaultValueType, fieldType)) {", "createdAt": "2020-11-09T01:46:39Z", "url": "https://github.com/typetools/checker-framework/pull/3877", "merged": true, "mergeCommit": {"oid": "f3c6259327958dbee68d7505582d07ea14552044"}, "closed": true, "closedAt": "2020-11-10T03:52:34Z", "author": {"login": "mernst"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaRsuLAH2gAyNTE3NDE2MDM1OjA0NmU1ZDNhMWI2Yzk1NTViMjMyOTg0ZTI2NDViNGMxZjZlYTY5ZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda-wEWgH2gAyNTE3NDE2MDM1OmYxZDE4MzU4MzA4MjI0ZTRjMzU4NjQ2ZjQzMzgyNjdjMjNmOGEwZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "046e5d3a1b6c9555b232984e2645b4c1f6ea69d4", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/046e5d3a1b6c9555b232984e2645b4c1f6ea69d4", "committedDate": "2020-11-07T20:36:30Z", "message": "Define method getDefaultValueAnnotatedType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ea45ca9d3957cb8f9dbbd7505f8f73590d48fcb", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/9ea45ca9d3957cb8f9dbbd7505f8f73590d48fcb", "committedDate": "2020-11-08T01:48:08Z", "message": "Update expected output"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5346eb249abe4e1e30c5f214b4aee3933ae5879c", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/5346eb249abe4e1e30c5f214b4aee3933ae5879c", "committedDate": "2020-11-08T14:11:54Z", "message": "Update expected output"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d726a544d24a676a79294c56bbac8325086ad27", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/7d726a544d24a676a79294c56bbac8325086ad27", "committedDate": "2020-11-09T00:42:06Z", "message": "Fix TypeTag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjQ2NDYy", "url": "https://github.com/typetools/checker-framework/pull/3877#pullrequestreview-526646462", "createdAt": "2020-11-09T20:55:11Z", "commit": {"oid": "7d726a544d24a676a79294c56bbac8325086ad27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo1NToxMlrOHwBPuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo1NToxMlrOHwBPuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExNDEwNA==", "bodyText": "org.checkerframework.javacutil.trees.TreeBuilder#buildLiteral seems to build a literal tree from a given value.\nYou should be able to do something like this:\n    public static LiteralTree buildLiteral(Object value, ProcessingEnvironment env) {\n        Context context = ((JavacProcessingEnvironment) env).getContext();\n         TreeMaker maker = TreeMaker.instance(context);\n        return maker.Literal(value);\n    }\n\n(This sort of method should be in TreeUtils.)\nIn case it's not easy to figure out.  Here are the imports for the code above:\nimport com.sun.tools.javac.tree.TreeMaker;\nimport javax.annotation.processing.ProcessingEnvironment;\nimport com.sun.tools.javac.util.Context;\nimport com.sun.tools.javac.processing.JavacProcessingEnvironment;", "url": "https://github.com/typetools/checker-framework/pull/3877#discussion_r520114104", "createdAt": "2020-11-09T20:55:12Z", "author": {"login": "smillst"}, "path": "framework/src/main/java/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.java", "diffHunk": "@@ -2174,4 +2181,76 @@ private boolean isRelevantHelper(TypeMirror tm) {\n                 throw new BugInCF(\"isRelevantHelper(%s): Unexpected TypeKind %s\", tm, tm.getKind());\n         }\n     }\n+\n+    /**\n+     * Return the type of the default value of the given type. The default value is 0, false, or\n+     * null.\n+     *\n+     * @param typeMirror a type\n+     * @return the annotated type of {@code type}'s default value\n+     */\n+    public AnnotatedTypeMirror getDefaultValueAnnotatedType(TypeMirror typeMirror) {\n+        return getAnnotatedType(getDefaultValueTree(typeMirror));\n+    }\n+\n+    /**\n+     * Return a tree for the default value of the given type. The default value is 0, false, or\n+     * null.\n+     *\n+     * @param typeMirror a type\n+     * @return a tree for {@code type}'s default value\n+     */\n+    private static LiteralTree getDefaultValueTree(TypeMirror typeMirror) {\n+        switch (typeMirror.getKind()) {\n+            case BYTE:\n+                return createJCLiteral(TypeTag.BYTE, (byte) 0, typeMirror);\n+            case CHAR:\n+                return createJCLiteral(TypeTag.CHAR, '\\u0000', typeMirror);\n+            case SHORT:\n+                return createJCLiteral(TypeTag.SHORT, (short) 0, typeMirror);\n+            case LONG:\n+                return createJCLiteral(TypeTag.LONG, 0L, typeMirror);\n+            case FLOAT:\n+                return createJCLiteral(TypeTag.FLOAT, 0.0f, typeMirror);\n+            case INT:\n+                return createJCLiteral(TypeTag.INT, 0, typeMirror);\n+            case DOUBLE:\n+                return createJCLiteral(TypeTag.DOUBLE, 0.0d, typeMirror);\n+            case BOOLEAN:\n+                return createJCLiteral(TypeTag.BOOLEAN, false, typeMirror);\n+            default:\n+                return createJCLiteral(TypeTag.BOT, null, typeMirror);\n+        }\n+    }\n+\n+    /** The constructor for the JCLiteral class. */\n+    private static Constructor<JCLiteral> jcLiteralConstructor;\n+\n+    {\n+        try {\n+            jcLiteralConstructor =\n+                    JCLiteral.class.getDeclaredConstructor(TypeTag.class, Object.class);\n+        } catch (NoSuchElementException | NoSuchMethodException e) {\n+            throw new BugInCF(e);\n+        }\n+        jcLiteralConstructor.setAccessible(true);\n+    }\n+\n+    /**\n+     * Calls the protected JCLiteral constructor.\n+     *\n+     * @param typeTag the literal's type tag\n+     * @param value the literal's value\n+     * @param typeMirror the typeMirror for the literal\n+     * @return a JCLiteral tree for the given type tag and value\n+     */\n+    private static JCLiteral createJCLiteral(TypeTag typeTag, Object value, TypeMirror typeMirror) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d726a544d24a676a79294c56bbac8325086ad27"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "672523fce73cf58ebda212cdd28b5254536ff721", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/672523fce73cf58ebda212cdd28b5254536ff721", "committedDate": "2020-11-09T22:43:17Z", "message": "Define method TreeUtils.createLiteral"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "130e789c3a1cfc28b44ae431a8aed4445f4748be", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/130e789c3a1cfc28b44ae431a8aed4445f4748be", "committedDate": "2020-11-09T22:49:49Z", "message": "Merge ../checker-framework-branch-master into getDefaultValueAnnotatedType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7102ffe700075909e9700d9e074d12494d2c585", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/c7102ffe700075909e9700d9e074d12494d2c585", "committedDate": "2020-11-09T22:52:02Z", "message": "Revert expected warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bcca8cbc67a865485a9bbe07acec1ec58511a46", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/6bcca8cbc67a865485a9bbe07acec1ec58511a46", "committedDate": "2020-11-09T22:52:12Z", "message": "Add TODO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzM3Nzcx", "url": "https://github.com/typetools/checker-framework/pull/3877#pullrequestreview-526737771", "createdAt": "2020-11-09T23:31:00Z", "commit": {"oid": "6bcca8cbc67a865485a9bbe07acec1ec58511a46"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzozMTowMFrOHwFuTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzozMjoxNFrOHwFwDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzQ2OQ==", "bodyText": "maker.Literal(TypeTag.BOT, null) should be  maker.Literal(typeTag, value), right?  Why doesn't maker.Literal(typeTag, value) work? I don't think there are any test for this, so I can't check myself.", "url": "https://github.com/typetools/checker-framework/pull/3877#discussion_r520187469", "createdAt": "2020-11-09T23:31:00Z", "author": {"login": "smillst"}, "path": "javacutil/src/main/java/org/checkerframework/javacutil/TreeUtils.java", "diffHunk": "@@ -1641,4 +1644,25 @@ public static boolean isWideningBinary(BinaryTree node) {\n             }\n         }\n     }\n+\n+    /**\n+     * Creates a LiteralTree for the given value.\n+     *\n+     * @param typeTag the literal's type tag\n+     * @param value a wrapped primitive, null, or a String\n+     * @param typeMirror the typeMirror for the literal\n+     * @param processingEnv the processing environment\n+     * @return a LiteralTree for the given type tag and value\n+     */\n+    public static LiteralTree createLiteral(\n+            TypeTag typeTag,\n+            Object value,\n+            TypeMirror typeMirror,\n+            ProcessingEnvironment processingEnv) {\n+        Context context = ((JavacProcessingEnvironment) processingEnv).getContext();\n+        TreeMaker maker = TreeMaker.instance(context);\n+        LiteralTree result = maker.Literal(TypeTag.BOT, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcca8cbc67a865485a9bbe07acec1ec58511a46"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzkxOQ==", "bodyText": "This should be in TreeUtils because it imports a class from outside the support complier API, (com.sun.tools.javac.code.TypeTag).", "url": "https://github.com/typetools/checker-framework/pull/3877#discussion_r520187919", "createdAt": "2020-11-09T23:32:14Z", "author": {"login": "smillst"}, "path": "framework/src/main/java/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.java", "diffHunk": "@@ -2198,4 +2200,46 @@ private boolean isRelevantHelper(TypeMirror tm) {\n                 throw new BugInCF(\"isRelevantHelper(%s): Unexpected TypeKind %s\", tm, tm.getKind());\n         }\n     }\n+\n+    /**\n+     * Return the type of the default value of the given type. The default value is 0, false, or\n+     * null.\n+     *\n+     * @param typeMirror a type\n+     * @return the annotated type of {@code type}'s default value\n+     */\n+    // TODO: Cache results to avoid recomputation.\n+    public AnnotatedTypeMirror getDefaultValueAnnotatedType(TypeMirror typeMirror) {\n+        return getAnnotatedType(getDefaultValueTree(typeMirror));\n+    }\n+\n+    /**\n+     * Return a tree for the default value of the given type. The default value is 0, false, or\n+     * null.\n+     *\n+     * @param typeMirror a type\n+     * @return a tree for {@code type}'s default value\n+     */\n+    private LiteralTree getDefaultValueTree(TypeMirror typeMirror) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcca8cbc67a865485a9bbe07acec1ec58511a46"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e30d56081d823842f09c698f20551f77f68d85da", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/e30d56081d823842f09c698f20551f77f68d85da", "committedDate": "2020-11-09T23:43:36Z", "message": "Fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzQ0ODIy", "url": "https://github.com/typetools/checker-framework/pull/3877#pullrequestreview-526744822", "createdAt": "2020-11-09T23:47:23Z", "commit": {"oid": "e30d56081d823842f09c698f20551f77f68d85da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32174b41c6ddd7e97e9def9e6582f936a5563a4c", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/32174b41c6ddd7e97e9def9e6582f936a5563a4c", "committedDate": "2020-11-09T23:47:40Z", "message": "Move method, also fix a dumb bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d18358308224e4c358646f4338267c23f8a0df", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/f1d18358308224e4c358646f4338267c23f8a0df", "committedDate": "2020-11-10T01:05:53Z", "message": "Add type annotation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2497, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}