{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMzY3Nzg0", "number": 3843, "title": "sideEffectsUnrefineAliases feature", "bodyText": "Read the comment in SourceChecker.java first.\nThe diffs are not as big as they look.  (GitHub ought to pass the --minimal command-line argument to diff.)\nThis pull request lacks a test case, but there is one here:\nhttps://github.com/mernst/checker-framework/compare/sideEffectsUnrefineAliases...mernst:hasnext-checker?expand=1", "createdAt": "2020-10-29T15:37:59Z", "url": "https://github.com/typetools/checker-framework/pull/3843", "merged": true, "mergeCommit": {"oid": "c5ce4d755eecb925991cb2443dc0c9b3daf3aa0d"}, "closed": true, "closedAt": "2020-10-30T00:44:03Z", "author": {"login": "mernst"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXKjLVAH2gAyNTEyMzY3Nzg0OjA3NDBhZGQyMDJmMGFjYmFlNzNjZThlZDFlYTQ3MmZkNjVkYzBlOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXZ-CggH2gAyNTEyMzY3Nzg0OjcwMjRlMmJlMjZmYjg2M2RkYjU3ZDZhNTc0MTZhZTg0ZWVkZjIwNTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0740add202f0acbae73ce8ed1ea472fd65dc0e91", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/0740add202f0acbae73ce8ed1ea472fd65dc0e91", "committedDate": "2020-10-29T04:34:58Z", "message": "Tweak comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "904b559180ecdabab1fc363e2dab70291658be32", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/904b559180ecdabab1fc363e2dab70291658be32", "committedDate": "2020-10-29T04:42:56Z", "message": "sideEffectsUnrefineAliases feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75ad1dc40a1904c64357c2df771ef2a72b7d29ef", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/75ad1dc40a1904c64357c2df771ef2a72b7d29ef", "committedDate": "2020-10-29T04:44:30Z", "message": "Merge ../checker-framework-branch-master into sideEffectsUnrefineAliases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "093eb9a3e54570796666345675824ebb0c426eb4", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/093eb9a3e54570796666345675824ebb0c426eb4", "committedDate": "2020-10-29T04:50:50Z", "message": "Merge ../checker-framework-branch-master into sideEffectsUnrefineAliases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33b3951249d1db502bd3051a898b613ae6bd95e1", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/33b3951249d1db502bd3051a898b613ae6bd95e1", "committedDate": "2020-10-29T05:03:01Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d28bdb20774758afef9519331815142a489f2912", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/d28bdb20774758afef9519331815142a489f2912", "committedDate": "2020-10-29T05:11:27Z", "message": "Set field for KeyForSubchecker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "120e06b0ce2dee4dcb56a98c75f27d8fae92c7c4", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/120e06b0ce2dee4dcb56a98c75f27d8fae92c7c4", "committedDate": "2020-10-29T05:23:08Z", "message": "Add TODO and test that ought to issue a warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "552e6eea0e4d2cff9670ae7c6c13dc2475d522e3", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/552e6eea0e4d2cff9670ae7c6c13dc2475d522e3", "committedDate": "2020-10-29T14:35:19Z", "message": "Disable sideEffectsUnrefineAliases for KeyFor Checker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02f02255fa609bb1cc9ddff4cd178ac4e400c81", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/f02f02255fa609bb1cc9ddff4cd178ac4e400c81", "committedDate": "2020-10-29T14:54:05Z", "message": "Add Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d804271bbe0b99de649a45b1a9bb29f4cd9986f", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/4d804271bbe0b99de649a45b1a9bb29f4cd9986f", "committedDate": "2020-10-29T15:25:58Z", "message": "Transfer function doesn't need field sideEffectsUnrefineAliases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54830fcc0e397a97b86a6ab2cbe693edcf702bc6", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/54830fcc0e397a97b86a6ab2cbe693edcf702bc6", "committedDate": "2020-10-29T15:29:32Z", "message": "Tweak comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e98954b4cdf52016c445d9d581133d098dc0373", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/2e98954b4cdf52016c445d9d581133d098dc0373", "committedDate": "2020-10-29T15:33:09Z", "message": "Merge ../checker-framework-branch-master into sideEffectsUnrefineAliases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be77e06f7c7f31fbb2e5cfa67a3508ac66db5ed9", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/be77e06f7c7f31fbb2e5cfa67a3508ac66db5ed9", "committedDate": "2020-10-29T16:00:05Z", "message": "Move comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDY3MTgw", "url": "https://github.com/typetools/checker-framework/pull/3843#pullrequestreview-520067180", "createdAt": "2020-10-29T20:45:51Z", "commit": {"oid": "be77e06f7c7f31fbb2e5cfa67a3508ac66db5ed9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDo0NTo1MVrOHqt_cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDo0OTo0M1rOHquHVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1NTc2Mw==", "bodyText": "Nit: I would probably move move this if/else to a helper method to reduce the indentation.", "url": "https://github.com/typetools/checker-framework/pull/3843#discussion_r514555763", "createdAt": "2020-10-29T20:45:51Z", "author": {"login": "smillst"}, "path": "framework/src/main/java/org/checkerframework/framework/flow/CFAbstractStore.java", "diffHunk": "@@ -199,54 +199,73 @@ public void updateForMethodCall(\n         if (!(analysis.checker.hasOption(\"assumeSideEffectFree\")\n                 || analysis.checker.hasOption(\"assumePure\")\n                 || isSideEffectFree(atypeFactory, method))) {\n-            // update field values\n-            Map<FieldAccess, V> newFieldValues = new HashMap<>();\n-            for (Map.Entry<FieldAccess, V> e : fieldValues.entrySet()) {\n-                FieldAccess fieldAccess = e.getKey();\n-                V otherVal = e.getValue();\n \n-                // case 3: the field has a monotonic annotation\n-                if (!((GenericAnnotatedTypeFactory<?, ?, ?, ?>) atypeFactory)\n-                        .getSupportedMonotonicTypeQualifiers()\n-                        .isEmpty()) {\n-                    List<Pair<AnnotationMirror, AnnotationMirror>> fieldAnnotations =\n-                            atypeFactory.getAnnotationWithMetaAnnotation(\n-                                    fieldAccess.getField(), MonotonicQualifier.class);\n-                    V newOtherVal = null;\n-                    for (Pair<AnnotationMirror, AnnotationMirror> fieldAnnotation :\n-                            fieldAnnotations) {\n-                        AnnotationMirror monotonicAnnotation = fieldAnnotation.second;\n-                        Name annotation =\n-                                AnnotationUtils.getElementValueClassName(\n-                                        monotonicAnnotation, \"value\", false);\n-                        AnnotationMirror target =\n-                                AnnotationBuilder.fromName(\n-                                        atypeFactory.getElementUtils(), annotation);\n-                        // Make sure the 'target' annotation is present.\n-                        if (AnnotationUtils.containsSame(otherVal.getAnnotations(), target)) {\n-                            newOtherVal =\n-                                    analysis.createSingleAnnotationValue(\n-                                                    target, otherVal.getUnderlyingType())\n-                                            .mostSpecific(newOtherVal, null);\n+            // update local variables\n+            // TODO: Also remove if any element/argument to the annotation is not\n+            // isUnmodifiableByOtherCode.  Example: @KeyFor(\"valueThatCanBeMutated\").\n+            if (analysis.checker.sideEffectsUnrefineAliases) {\n+                localVariableValues\n+                        .entrySet()\n+                        .removeIf(e -> !e.getKey().isUnmodifiableByOtherCode());\n+            }\n+\n+            // update this value\n+            if (analysis.checker.sideEffectsUnrefineAliases) {\n+                thisValue = null;\n+            }\n+\n+            // update field values\n+            if (analysis.checker.sideEffectsUnrefineAliases) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be77e06f7c7f31fbb2e5cfa67a3508ac66db5ed9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1Nzc4MA==", "bodyText": "Since this field is only used by checkers that use dataflow, it should be in GenericAnnotatedTypeFactory.", "url": "https://github.com/typetools/checker-framework/pull/3843#discussion_r514557780", "createdAt": "2020-10-29T20:49:43Z", "author": {"login": "smillst"}, "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -479,6 +479,17 @@\n      */\n     private Map<String, String> activeOptions;\n \n+    /**\n+     * Should the analysis assume that side effects to a value can change the type of aliased\n+     * references?\n+     *\n+     * <p>For many type systems, once a local variable's type is refined, side effects to the\n+     * variable's value do not change the variable's type annotations. For some type systems, a side\n+     * effect to the value could change them; set this field to true.\n+     */\n+    // Not final so that subclasses can set it.\n+    public boolean sideEffectsUnrefineAliases = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be77e06f7c7f31fbb2e5cfa67a3508ac66db5ed9"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68b73e10450a207ee271d48aaf5e727acd44271", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/c68b73e10450a207ee271d48aaf5e727acd44271", "committedDate": "2020-10-29T21:21:20Z", "message": "Move field from SourceChecker to GenericAnnotatedTypeFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e79a9d9abf2449a2cb6a0fdcd8bb29eb716416d", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/7e79a9d9abf2449a2cb6a0fdcd8bb29eb716416d", "committedDate": "2020-10-29T21:22:03Z", "message": "Merge ../checker-framework-branch-master into sideEffectsUnrefineAliases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "534747c54a3128e0ba19e5a59c7f580c8bae6f2e", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/534747c54a3128e0ba19e5a59c7f580c8bae6f2e", "committedDate": "2020-10-29T21:30:59Z", "message": "Document why nested class is not static"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTMyMjM4", "url": "https://github.com/typetools/checker-framework/pull/3843#pullrequestreview-520132238", "createdAt": "2020-10-29T22:25:29Z", "commit": {"oid": "7e79a9d9abf2449a2cb6a0fdcd8bb29eb716416d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyNToyOVrOHqw2ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyNToyOVrOHqw2ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMjYwMg==", "bodyText": "This needs to move, too.", "url": "https://github.com/typetools/checker-framework/pull/3843#discussion_r514602602", "createdAt": "2020-10-29T22:25:29Z", "author": {"login": "smillst"}, "path": "checker/src/main/java/org/checkerframework/checker/nullness/KeyForSubchecker.java", "diffHunk": "@@ -9,4 +9,11 @@\n  * @checker_framework.manual #map-key-checker Map Key Checker\n  * @checker_framework.manual #nullness-checker Nullness Checker\n  */\n-public class KeyForSubchecker extends BaseTypeChecker {}\n+public class KeyForSubchecker extends BaseTypeChecker {\n+    {\n+        // While strictly required for soundness, this leads to too many false positives.  Printing\n+        // a key or putting it in a map erases all knowledge of what maps it was a key for.\n+        // TODO: Revisit when side effect annotations are more precise.\n+        // this.sideEffectsUnrefineAliases = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e79a9d9abf2449a2cb6a0fdcd8bb29eb716416d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6282116472bc0ca963249296a56707140137c6fd", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/6282116472bc0ca963249296a56707140137c6fd", "committedDate": "2020-10-29T22:31:19Z", "message": "Adapt to moved field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b715d94f1872be5f3f57c36f43f88070ac087c9e", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/b715d94f1872be5f3f57c36f43f88070ac087c9e", "committedDate": "2020-10-29T22:32:37Z", "message": "Update another comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7024e2be26fb863ddb57d6a57416ae84eedf2053", "author": {"user": {"login": "mernst", "name": "Michael Ernst"}}, "url": "https://github.com/typetools/checker-framework/commit/7024e2be26fb863ddb57d6a57416ae84eedf2053", "committedDate": "2020-10-29T22:32:53Z", "message": "Merge ../checker-framework-branch-master into sideEffectsUnrefineAliases"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2476, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}