{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5ODkyMzg4", "number": 3602, "title": "Infer length properties from Array.getLength() method", "bodyText": "Fixes #2452\nThe checker did not infer length properties from Array.getLength() method.\nFix this by adding explicit support for this method similar to what's been done for length field of array.", "createdAt": "2020-08-19T03:07:14Z", "url": "https://github.com/typetools/checker-framework/pull/3602", "merged": true, "mergeCommit": {"oid": "b8497f540910e0dcdb5363361a67b78b18c70639"}, "closed": true, "closedAt": "2020-12-21T18:36:56Z", "author": {"login": "PRITI1999"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczjFNLgH2gAyNDY5ODkyMzg4OjU2MjRkMjdhNzhiNGYwMDFiMWUzYzIyMWJlZjM3M2Y2NmNiMjJhN2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm1R75gH2gAyNDY5ODkyMzg4OjQ1NmQzMThiNmQ4Y2QxYWI3MWNlNDJkMDM2MzgzZDEyMWVkY2NjMWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5624d27a78b4f001b1e3c221bef373f66cb22a7d", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/5624d27a78b4f001b1e3c221bef373f66cb22a7d", "committedDate": "2020-07-10T12:48:35Z", "message": "Merge pull request #1 from typetools/master\n\nUpdate fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3723b511d80ffc2424695f00d5765514782a92e4", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/3723b511d80ffc2424695f00d5765514782a92e4", "committedDate": "2020-07-21T02:21:51Z", "message": "Merge pull request #4 from typetools/master\n\nUpdating fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29bd19b4fa3bb917bd3ed8d432d8d88273463379", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/29bd19b4fa3bb917bd3ed8d432d8d88273463379", "committedDate": "2020-07-26T03:57:56Z", "message": "Merge pull request #6 from typetools/master\n\nUpdating fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39ac44ab6a7d63c166c8f67f2a86a16fd68b2566", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/39ac44ab6a7d63c166c8f67f2a86a16fd68b2566", "committedDate": "2020-07-29T02:03:14Z", "message": "Merge pull request #7 from typetools/master\n\nMerge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9549a409311d26653050df1554c8022cdddaa4", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/ba9549a409311d26653050df1554c8022cdddaa4", "committedDate": "2020-07-30T13:58:15Z", "message": "Check for Array.getLength() call and annotate the return value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c7d0c66ff1ce110b42120715810dd44f2b1409", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/d7c7d0c66ff1ce110b42120715810dd44f2b1409", "committedDate": "2020-07-30T15:30:29Z", "message": "Remove println"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bf17fb6ca9a8a9e4c7b6777837c65455a4a7ff4", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/8bf17fb6ca9a8a9e4c7b6777837c65455a4a7ff4", "committedDate": "2020-07-31T01:36:59Z", "message": "Merge pull request #10 from typetools/master\n\nUpdate fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d79f0e0136e547af62829b2bb2629c5c738f393", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/5d79f0e0136e547af62829b2bb2629c5c738f393", "committedDate": "2020-08-04T03:46:55Z", "message": "Some changes to add support for Array.getLength"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8d26485523b4f59815e493f585d835cc9b6aa8", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/3c8d26485523b4f59815e493f585d835cc9b6aa8", "committedDate": "2020-08-05T02:02:36Z", "message": "Merge pull request #12 from typetools/master\n\nUpdate fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a125ea2a25dfb01037c7e71bd206cb1a2c74fbc7", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/a125ea2a25dfb01037c7e71bd206cb1a2c74fbc7", "committedDate": "2020-08-11T02:04:03Z", "message": "Merge pull request #13 from typetools/master\n\nUpdate fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad78d7fbde29b8d5d5f67759dc7cb4bf762eddd1", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/ad78d7fbde29b8d5d5f67759dc7cb4bf762eddd1", "committedDate": "2020-08-12T02:19:27Z", "message": "retrieve array node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1284e979c490485cd77f3595a04989aedb39526e", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/1284e979c490485cd77f3595a04989aedb39526e", "committedDate": "2020-08-14T02:50:11Z", "message": "Merge pull request #15 from typetools/master\n\nUpdate fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0183886a717e98e20116f5216914590e3deda8e5", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/0183886a717e98e20116f5216914590e3deda8e5", "committedDate": "2020-08-14T02:50:48Z", "message": "Merge branch 'master' of https://github.com/priti1999/checker-framework into fix-issue-2452"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d4484fe9983111da1162057668a1e6922f0d5e2", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/4d4484fe9983111da1162057668a1e6922f0d5e2", "committedDate": "2020-08-17T02:44:14Z", "message": "fix and testcase for Issue #2452"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0fd341fba9ac02557042b422e28e770d250efef", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/b0fd341fba9ac02557042b422e28e770d250efef", "committedDate": "2020-08-18T01:57:13Z", "message": "Add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "committedDate": "2020-08-18T02:34:15Z", "message": "add more doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjcwNTg4", "url": "https://github.com/typetools/checker-framework/pull/3602#pullrequestreview-470670588", "createdAt": "2020-08-19T17:03:49Z", "commit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODIxOTgx", "url": "https://github.com/typetools/checker-framework/pull/3602#pullrequestreview-472821981", "createdAt": "2020-08-21T21:11:52Z", "commit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMToxMTo1MlrOHE-ABQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMToxNjo0OVrOHE-Glw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ==", "bodyText": "I suggest moving this block of code down so that it appears immediately after String.length() is handled.", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972165", "createdAt": "2020-08-21T21:11:52Z", "author": {"login": "kelloggm"}, "path": "framework/src/main/java/org/checkerframework/common/value/ValueTreeAnnotator.java", "diffHunk": "@@ -399,6 +399,18 @@ public Void visitMethodInvocation(MethodInvocationTree tree, AnnotatedTypeMirror\n             }\n         }\n \n+        if (atypeFactory\n+                .getMethodIdentifier()\n+                .isArrayGetLengthInvocation(tree, atypeFactory.getProcessingEnv())) {\n+            List<? extends ExpressionTree> args = tree.getArguments();\n+            AnnotatedTypeMirror argType = atypeFactory.getAnnotatedType(args.get(0));\n+            AnnotationMirror resultAnno = atypeFactory.createArrayLengthResultAnnotation(argType);\n+            if (resultAnno != null) {\n+                type.replaceAnnotation(resultAnno);\n+            }\n+            return null;\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjI0Ng==", "bodyText": "That will make the flow of this method more clear.", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972246", "createdAt": "2020-08-21T21:12:03Z", "author": {"login": "kelloggm"}, "path": "framework/src/main/java/org/checkerframework/common/value/ValueTreeAnnotator.java", "diffHunk": "@@ -399,6 +399,18 @@ public Void visitMethodInvocation(MethodInvocationTree tree, AnnotatedTypeMirror\n             }\n         }\n \n+        if (atypeFactory\n+                .getMethodIdentifier()\n+                .isArrayGetLengthInvocation(tree, atypeFactory.getProcessingEnv())) {\n+            List<? extends ExpressionTree> args = tree.getArguments();\n+            AnnotatedTypeMirror argType = atypeFactory.getAnnotatedType(args.get(0));\n+            AnnotationMirror resultAnno = atypeFactory.createArrayLengthResultAnnotation(argType);\n+            if (resultAnno != null) {\n+                type.replaceAnnotation(resultAnno);\n+            }\n+            return null;\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ=="}, "originalCommit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mjc5OA==", "bodyText": "Rather than checking for these in every place that refineStringAtLengthInvocation or refineArrayAtGetLengthInvocation might be called, I suggest creating one refineAtLengthInvocation method that then dispatches to those two methods (or just inlines their logic).", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972798", "createdAt": "2020-08-21T21:13:46Z", "author": {"login": "kelloggm"}, "path": "framework/src/main/java/org/checkerframework/common/value/ValueTransfer.java", "diffHunk": "@@ -1340,7 +1357,16 @@ private void addAnnotationToStore(CFStore store, AnnotationMirror anno, Node nod\n             if (node instanceof FieldAccessNode) {\n                 refineArrayAtLengthAccess((FieldAccessNode) internal, store);\n             } else if (node instanceof MethodInvocationNode) {\n-                refineStringAtLengthInvocation((MethodInvocationNode) internal, store);\n+                MethodInvocationNode miNode = (MethodInvocationNode) node;\n+                if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isStringLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineStringAtLengthInvocation(miNode, store);\n+                } else if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isArrayGetLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineArrayAtGetLengthInvocation(miNode, store);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MzQzMw==", "bodyText": "Since there is also a refineAtLengthAccess method that implements the logic for both, I suggest renaming that method to refineAtLengthAccessImpl and making the wrapper method called refineAtLengthAccess. That wrapper method should take a MethodInvocationTree and check what method is actually being invoked, and then call refineAtLengthAccessImpl with the appropriate arguments.", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474973433", "createdAt": "2020-08-21T21:15:35Z", "author": {"login": "kelloggm"}, "path": "framework/src/main/java/org/checkerframework/common/value/ValueTransfer.java", "diffHunk": "@@ -1340,7 +1357,16 @@ private void addAnnotationToStore(CFStore store, AnnotationMirror anno, Node nod\n             if (node instanceof FieldAccessNode) {\n                 refineArrayAtLengthAccess((FieldAccessNode) internal, store);\n             } else if (node instanceof MethodInvocationNode) {\n-                refineStringAtLengthInvocation((MethodInvocationNode) internal, store);\n+                MethodInvocationNode miNode = (MethodInvocationNode) node;\n+                if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isStringLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineStringAtLengthInvocation(miNode, store);\n+                } else if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isArrayGetLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineArrayAtGetLengthInvocation(miNode, store);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mjc5OA=="}, "originalCommit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mzg0Nw==", "bodyText": "Rather than adding these to the end of the file, please put them with the corresponding methods for String#length.", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474973847", "createdAt": "2020-08-21T21:16:49Z", "author": {"login": "kelloggm"}, "path": "framework/src/main/java/org/checkerframework/common/value/ValueMethodIdentifier.java", "diffHunk": "@@ -78,4 +82,26 @@ public boolean isEndsWithMethod(ExecutableElement method) {\n     public boolean isArraysCopyOfInvocation(Tree tree, ProcessingEnvironment processingEnv) {\n         return TreeUtils.isMethodInvocation(tree, copyOfMethod, processingEnv);\n     }\n+\n+    /**\n+     * Determines whether a tree is an invocation of the {@code Array.getLength()} method.\n+     *\n+     * @param tree tree to check\n+     * @param processingEnv the processing environment\n+     * @return true iff the argument is an invocation of {@code Array.getLength()} method\n+     */\n+    public boolean isArrayGetLengthInvocation(Tree tree, ProcessingEnvironment processingEnv) {\n+        return TreeUtils.isMethodInvocation(tree, getLengthMethod, processingEnv);\n+    }\n+\n+    /**\n+     * Determines whether a method is the {@code Array.getLength()} method.\n+     *\n+     * @param method the element to check\n+     * @return true iff the argument method is {@code Array.getLength()} method\n+     */\n+    public boolean isArrayGetLengthMethod(ExecutableElement method) {\n+        // equals (rather than ElementUtils.ismethod) because String.length cannot be overridden\n+        return method.equals(getLengthMethod);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf448ed71c898c5d76a2ec9f3903331a83111356", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/cf448ed71c898c5d76a2ec9f3903331a83111356", "committedDate": "2020-08-30T03:00:03Z", "message": "Remove redundant code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ccf44e71a5d0520bdac5230ef9cc911bf49506d", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/3ccf44e71a5d0520bdac5230ef9cc911bf49506d", "committedDate": "2020-08-30T03:08:31Z", "message": "Improve flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf05a1a610c7933a5bed6570109e0507ee73c445", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/cf05a1a610c7933a5bed6570109e0507ee73c445", "committedDate": "2020-08-30T03:09:52Z", "message": "Improve flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec1086090acf855ef3575ab77a1ad6a7aa3343c", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/9ec1086090acf855ef3575ab77a1ad6a7aa3343c", "committedDate": "2020-09-01T02:36:29Z", "message": "Improve flow add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "228bf74d656a001645940fd5c97c33dba8400c6d", "author": {"user": {"login": "PRITI1999", "name": "Priti Chattopadhyay"}}, "url": "https://github.com/typetools/checker-framework/commit/228bf74d656a001645940fd5c97c33dba8400c6d", "committedDate": "2020-09-02T10:46:37Z", "message": "Build fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5f951d3b4e07eb323158940ca8b6b29ca86b8b0", "author": {"user": {"login": "kelloggm", "name": "Martin Kellogg"}}, "url": "https://github.com/typetools/checker-framework/commit/e5f951d3b4e07eb323158940ca8b6b29ca86b8b0", "committedDate": "2020-12-16T18:27:20Z", "message": "Merge branch 'master' into fix-issue-2452"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTY4NjE2", "url": "https://github.com/typetools/checker-framework/pull/3602#pullrequestreview-553968616", "createdAt": "2020-12-16T18:28:00Z", "commit": {"oid": "e5f951d3b4e07eb323158940ca8b6b29ca86b8b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456d318b6d8cd1ab71ce42d036383d121edccc1d", "author": {"user": {"login": "kelloggm", "name": "Martin Kellogg"}}, "url": "https://github.com/typetools/checker-framework/commit/456d318b6d8cd1ab71ce42d036383d121edccc1d", "committedDate": "2020-12-16T20:50:55Z", "message": "fix errors intro'd by mergE"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2623, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}