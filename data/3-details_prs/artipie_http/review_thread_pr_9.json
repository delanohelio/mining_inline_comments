{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNzExMzQ1", "number": 9, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxMzozNVrODc54AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyMToxMVrODc6Aog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM0OTQ1OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxMzozNVrOFlMwPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxMzozNVrOFlMwPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MDU5MQ==", "bodyText": "@g4s8 I get the feeling I see this kind of rx dependencies in all the artipie projects. Can you add a comment <!-- --> explaining what they are for? They are for tests, obviously, but what tools do they actually provide?", "url": "https://github.com/artipie/http/pull/9#discussion_r374550591", "createdAt": "2020-02-04T09:13:35Z", "author": {"login": "amihaiemil"}, "path": "pom.xml", "diffHunk": "@@ -44,6 +44,18 @@\n       <version>${junit-platform.version}</version>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>io.reactivex.rxjava3</groupId>\n+      <artifactId>rxjava</artifactId>\n+      <version>3.0.0-RC6</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>com.github.akarnokd</groupId>\n+      <artifactId>rxjava3-jdk8-interop</artifactId>\n+      <version>3.0.0-RC6</version>\n+      <scope>test</scope>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM1MDY0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNDowMFrOFlMxAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMTowODozMVrOFlQSjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MDc4Nw==", "bodyText": "@g4s8 I guess this is the max buffersize. Should we name it as such?", "url": "https://github.com/artipie/http/pull/9#discussion_r374550787", "createdAt": "2020-02-04T09:14:00Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -86,6 +86,11 @@ public String line() throws IOException {\n      */\n     private static final class BodySubstription implements Subscription {\n \n+        /**\n+         * Buffer size for stream reading.\n+         */\n+        private static final int BUF_SIZE = 1024 * 8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYwODUyNw==", "bodyText": "@amihaiemil I don't think so - this is just a buffer size. The buffer is allocated with this size and used to read bytes from stream into this buffer. The buffer's size is always 8K.", "url": "https://github.com/artipie/http/pull/9#discussion_r374608527", "createdAt": "2020-02-04T11:08:31Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -86,6 +86,11 @@ public String line() throws IOException {\n      */\n     private static final class BodySubstription implements Subscription {\n \n+        /**\n+         * Buffer size for stream reading.\n+         */\n+        private static final int BUF_SIZE = 1024 * 8;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MDc4Nw=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM1MzE0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNDo1NlrOFlMymg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNDo1NlrOFlMymg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MTE5NA==", "bodyText": "@g4s8 Can we have a test for this method as well? For instance, what happens if cancel() is called twice, or if request(bytes) is called after cancel()?", "url": "https://github.com/artipie/http/pull/9#discussion_r374551194", "createdAt": "2020-02-04T09:14:56Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM1NDkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNTozNlrOFlMzxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNTozNlrOFlMzxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MTQ5Mg==", "bodyText": "@g4s8 I would put this if in the request() method, right before calling this method.", "url": "https://github.com/artipie/http/pull/9#discussion_r374551492", "createdAt": "2020-02-04T09:15:36Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM2MTM0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/artipie/http/tk/TkRequestTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxNzo1MVrOFlM31A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMTo0MjoxNFrOFlRIew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MjUzMg==", "bodyText": "@g4s8 Is it possible to write this test by using a String, or some chars? Something more meaningful than actual hardcoded bytes :D", "url": "https://github.com/artipie/http/pull/9#discussion_r374552532", "createdAt": "2020-02-04T09:17:51Z", "author": {"login": "amihaiemil"}, "path": "src/test/java/com/artipie/http/tk/TkRequestTest.java", "diffHunk": "@@ -77,4 +80,30 @@ void readsEmptyHeaders() throws Exception {\n             Matchers.anEmptyMap()\n         );\n     }\n+\n+    @Test\n+    void readsBody() throws Exception {\n+        final byte[] body = new byte[]{0x00, 0x01, 0x02, 0x03};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxNDQ4NQ==", "bodyText": "@amihaiemil I don't think it's correct to use string for bytes testing", "url": "https://github.com/artipie/http/pull/9#discussion_r374614485", "createdAt": "2020-02-04T11:22:38Z", "author": {"login": "g4s8"}, "path": "src/test/java/com/artipie/http/tk/TkRequestTest.java", "diffHunk": "@@ -77,4 +80,30 @@ void readsEmptyHeaders() throws Exception {\n             Matchers.anEmptyMap()\n         );\n     }\n+\n+    @Test\n+    void readsBody() throws Exception {\n+        final byte[] body = new byte[]{0x00, 0x01, 0x02, 0x03};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MjUzMg=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxNjIwNw==", "bodyText": "@g4s8 I was thinking of String.getBytes() rather than declaring a raw byte array :)", "url": "https://github.com/artipie/http/pull/9#discussion_r374616207", "createdAt": "2020-02-04T11:26:45Z", "author": {"login": "amihaiemil"}, "path": "src/test/java/com/artipie/http/tk/TkRequestTest.java", "diffHunk": "@@ -77,4 +80,30 @@ void readsEmptyHeaders() throws Exception {\n             Matchers.anEmptyMap()\n         );\n     }\n+\n+    @Test\n+    void readsBody() throws Exception {\n+        final byte[] body = new byte[]{0x00, 0x01, 0x02, 0x03};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MjUzMg=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjMzMQ==", "bodyText": "@amihaiemil I still don't understand why we should use string here. I think it may confuse the reader, because if we use array of bytes here, it becomes obvious that this class uses bytes for data transferring. Otherwise, the reader may misunderstand that class assumes some string to be encoded into byte array.", "url": "https://github.com/artipie/http/pull/9#discussion_r374622331", "createdAt": "2020-02-04T11:42:14Z", "author": {"login": "g4s8"}, "path": "src/test/java/com/artipie/http/tk/TkRequestTest.java", "diffHunk": "@@ -77,4 +80,30 @@ void readsEmptyHeaders() throws Exception {\n             Matchers.anEmptyMap()\n         );\n     }\n+\n+    @Test\n+    void readsBody() throws Exception {\n+        final byte[] body = new byte[]{0x00, 0x01, 0x02, 0x03};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MjUzMg=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM2NTE3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToxOTowOVrOFlM6Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMToxNDoxNFrOFlQbyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MzE0Ng==", "bodyText": "@g4s8 onNext what? What does this method do actually? :D", "url": "https://github.com/artipie/http/pull/9#discussion_r374553146", "createdAt": "2020-02-04T09:19:09Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {\n+                    len = TkRequest.BodySubstription.BUF_SIZE;\n+                } else {\n+                    len = (int) (bytes - total);\n+                }\n+                final int read = this.stream.read(buf, 0, len);\n+                total += read;\n+                if (read == -1) {\n+                    this.stream.close();\n+                    this.receiver.onComplete();\n+                    break;\n+                } else {\n+                    for (int pos = 0; pos < read; ++pos) {\n+                        this.receiver.onNext(buf[pos]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMDg4OQ==", "bodyText": "@amihaiemil onNext is a part of JDK9 Flow API you can check the javadoc here: https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.Subscriber.html#onNext-T-", "url": "https://github.com/artipie/http/pull/9#discussion_r374610889", "createdAt": "2020-02-04T11:14:14Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {\n+                    len = TkRequest.BodySubstription.BUF_SIZE;\n+                } else {\n+                    len = (int) (bytes - total);\n+                }\n+                final int read = this.stream.read(buf, 0, len);\n+                total += read;\n+                if (read == -1) {\n+                    this.stream.close();\n+                    this.receiver.onComplete();\n+                    break;\n+                } else {\n+                    for (int pos = 0; pos < read; ++pos) {\n+                        this.receiver.onNext(buf[pos]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MzE0Ng=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM3MTU0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyMToxMVrOFlM-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMTozODo0M1rOFlRCwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NDE1NA==", "bodyText": "@g4s8 I think this should be >= instead of <=. So if the maximum buf size is exceeded, then len takes buf_size. But I am not sure :D\nUgly algorithm... Isn't it possible to write this algorithm with class IOUtils from Apache Commons or something?", "url": "https://github.com/artipie/http/pull/9#discussion_r374554154", "createdAt": "2020-02-04T09:21:11Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMzMzNg==", "bodyText": "@amihaiemil yes, it looks ugly, maybe I'll extract it into separate library. I didn't find implementations to convert Flow to Streams. The logic is correct here: if requested amount of bytes to read is greater than already read bytes (total) + buffer size, then we read full buffer, else we need to read only missing chunk of bytes (requested amount - already read).", "url": "https://github.com/artipie/http/pull/9#discussion_r374613336", "createdAt": "2020-02-04T11:19:50Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NDE1NA=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxNjU5OQ==", "bodyText": "@g4s8 Can you add this algorithm's description (strep by step) in a JavaDoc over the method? So people can figure it out easier :D", "url": "https://github.com/artipie/http/pull/9#discussion_r374616599", "createdAt": "2020-02-04T11:27:45Z", "author": {"login": "amihaiemil"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NDE1NA=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMDg2NQ==", "bodyText": "@amihaiemil added javadoc", "url": "https://github.com/artipie/http/pull/9#discussion_r374620865", "createdAt": "2020-02-04T11:38:43Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/http/tk/TkRequest.java", "diffHunk": "@@ -108,16 +113,52 @@ public String line() throws IOException {\n \n         @Override\n         public void request(final long bytes) {\n-            throw new UnsupportedOperationException(\n-                String.format(\"request not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.read(bytes);\n+            } catch (final IOException | IllegalArgumentException err) {\n+                this.receiver.onError(err);\n+            }\n         }\n \n         @Override\n         public void cancel() {\n-            throw new UnsupportedOperationException(\n-                String.format(\"cancel not implemented: %s/%s\", this.stream, this.receiver)\n-            );\n+            try {\n+                this.stream.close();\n+            } catch (final IOException err) {\n+                this.receiver.onError(err);\n+            }\n+        }\n+\n+        /**\n+         * Read bytes from stream into receiver.\n+         * @param bytes Amount of bytes to read\n+         * @throws IOException On stream error\n+         */\n+        private void read(final long bytes) throws IOException {\n+            if (bytes <= 0) {\n+                throw new IllegalArgumentException(String.format(\"can't request %d bytes\", bytes));\n+            }\n+            final byte[] buf = new byte[TkRequest.BodySubstription.BUF_SIZE];\n+            long total = 0;\n+            while (total < bytes) {\n+                final int len;\n+                if (total + TkRequest.BodySubstription.BUF_SIZE <= bytes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NDE1NA=="}, "originalCommit": {"oid": "ada3b10d43ec1e9c854f9e4a0339f3f8b60272c9"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1926, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}