{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2Mjk3NzIy", "number": 65, "title": "Upload and download slices", "bodyText": "#64 - added upload and download slices to work with Storage by Key from path", "createdAt": "2020-03-10T18:31:12Z", "url": "https://github.com/artipie/http/pull/65", "merged": true, "mergeCommit": {"oid": "4b2a08c6b8e9e824cf29188121074d532b275011"}, "closed": true, "closedAt": "2020-03-12T10:07:46Z", "author": {"login": "g4s8"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMWzGbAH2gAyMzg2Mjk3NzIyOmIzMDUxMjY3Mjg1NjcxNTUwMWFiYzNkMjI2ODc3MjE3M2M4M2M2OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM21EqgH2gAyMzg2Mjk3NzIyOjI4NTM3NzAxMTZkYTM0YjZjZjViOTM4ZGRjYjZmZTM1ZjkxNWJiNTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b30512672856715501abc3d2268772173c83c68f", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/http/commit/b30512672856715501abc3d2268772173c83c68f", "committedDate": "2020-03-10T18:26:54Z", "message": "#64 - upload and download slices"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyODI3MTIw", "url": "https://github.com/artipie/http/pull/65#pullrequestreview-372827120", "createdAt": "2020-03-11T14:45:47Z", "commit": {"oid": "b30512672856715501abc3d2268772173c83c68f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDo0NTo0N1rOF06OKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDo1MTo1M1rOF06fyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyNDE2OA==", "bodyText": "@g4s8 I think that you need to test if SliceDownload is creating the response with the correct status and size too", "url": "https://github.com/artipie/http/pull/65#discussion_r391024168", "createdAt": "2020-03-11T14:45:47Z", "author": {"login": "paulodamaso"}, "path": "src/test/java/com/artipie/http/slice/SliceDownloadTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * MIT License\n+ *\n+ * Copyright (c) 2020 Artipie\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.http.slice;\n+\n+import com.artipie.asto.Content;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.memory.InMemoryStorage;\n+import com.artipie.http.hm.RsHasBody;\n+import com.artipie.http.rq.RequestLine;\n+import io.reactivex.Flowable;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Test case for {@link SliceDownload}.\n+ * @since 1.0\n+ */\n+public final class SliceDownloadTest {\n+\n+    @Test\n+    void downloadsByKeyFromPath() throws Exception {\n+        final Storage storage = new InMemoryStorage();\n+        final String path = \"one/two/target.txt\";\n+        final byte[] data = \"hello\".getBytes(StandardCharsets.UTF_8);\n+        storage.save(new Key.From(path), new Content.From(data)).get();\n+        MatcherAssert.assertThat(\n+            new SliceDownload(storage).response(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30512672856715501abc3d2268772173c83c68f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyNTM5Nw==", "bodyText": "@g4s8 Please put each assertion in a different test method.", "url": "https://github.com/artipie/http/pull/65#discussion_r391025397", "createdAt": "2020-03-11T14:47:26Z", "author": {"login": "paulodamaso"}, "path": "src/test/java/com/artipie/http/slice/SliceUploadTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * MIT License\n+ *\n+ * Copyright (c) 2020 Artipie\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.http.slice;\n+\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Remaining;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.memory.InMemoryStorage;\n+import com.artipie.http.hm.RsHasStatus;\n+import com.artipie.http.rq.RequestLine;\n+import com.artipie.http.rs.RsStatus;\n+import io.reactivex.Flowable;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import org.cactoos.map.MapEntry;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Test case for {@link SliceUpload}.\n+ * @since 0.6\n+ */\n+public final class SliceUploadTest {\n+\n+    @Test\n+    void uploadsKeyByPath() throws Exception {\n+        final Storage storage = new InMemoryStorage();\n+        final String hello = \"Hello\";\n+        final byte[] data = hello.getBytes(StandardCharsets.UTF_8);\n+        final String path = \"uploads/file.txt\";\n+        MatcherAssert.assertThat(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30512672856715501abc3d2268772173c83c68f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyNjkwNg==", "bodyText": "@g4s8 Use new IsEqual here, please. Also, you can add a message to this assertion failure, even if it's the only assertion of the method: most of times is easier and clearer to read the assertion message failure than to decipher what went wrong based on test method name", "url": "https://github.com/artipie/http/pull/65#discussion_r391026906", "createdAt": "2020-03-11T14:49:30Z", "author": {"login": "paulodamaso"}, "path": "src/test/java/com/artipie/http/slice/SliceUploadTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * MIT License\n+ *\n+ * Copyright (c) 2020 Artipie\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.http.slice;\n+\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Remaining;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.memory.InMemoryStorage;\n+import com.artipie.http.hm.RsHasStatus;\n+import com.artipie.http.rq.RequestLine;\n+import com.artipie.http.rs.RsStatus;\n+import io.reactivex.Flowable;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import org.cactoos.map.MapEntry;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Test case for {@link SliceUpload}.\n+ * @since 0.6\n+ */\n+public final class SliceUploadTest {\n+\n+    @Test\n+    void uploadsKeyByPath() throws Exception {\n+        final Storage storage = new InMemoryStorage();\n+        final String hello = \"Hello\";\n+        final byte[] data = hello.getBytes(StandardCharsets.UTF_8);\n+        final String path = \"uploads/file.txt\";\n+        MatcherAssert.assertThat(\n+            \"Wrong HTTP status returned\",\n+            new SliceUpload(storage).response(\n+                new RequestLine(\"PUT\", path, \"HTTP/1.1\").toString(),\n+                Collections.singleton(\n+                    new MapEntry<>(\"Content-Size\", Long.toString(data.length))\n+                ),\n+                Flowable.just(ByteBuffer.wrap(data))\n+            ),\n+            new RsHasStatus(RsStatus.CREATED)\n+        );\n+        MatcherAssert.assertThat(\n+            new String(\n+                new Remaining(\n+                    Flowable.fromPublisher(storage.value(new Key.From(path)).get()).toList()\n+                        .blockingGet().get(0)\n+                ).bytes(),\n+                StandardCharsets.UTF_8\n+            ),\n+            Matchers.equalTo(hello)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30512672856715501abc3d2268772173c83c68f"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyODY4Mg==", "bodyText": "@g4s8 We don't need this class as static; also we could move it into its own file and detach it from SliceUpload so we can use it wherever we need to measure content size", "url": "https://github.com/artipie/http/pull/65#discussion_r391028682", "createdAt": "2020-03-11T14:51:53Z", "author": {"login": "paulodamaso"}, "path": "src/main/java/com/artipie/http/slice/SliceUpload.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * MIT License\n+ *\n+ * Copyright (c) 2020 Artipie\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.http.slice;\n+\n+import com.artipie.asto.Content;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import com.artipie.http.async.AsyncResponse;\n+import com.artipie.http.rq.RequestLineFrom;\n+import com.artipie.http.rq.RqHeaders;\n+import com.artipie.http.rs.RsStatus;\n+import com.artipie.http.rs.RsWithStatus;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.Function;\n+import org.reactivestreams.Publisher;\n+import org.reactivestreams.Subscriber;\n+\n+/**\n+ * Slice to upload the resource to storage by key from path.\n+ * @see SliceDownload\n+ * @since 0.6\n+ */\n+public final class SliceUpload implements Slice {\n+\n+    /**\n+     * Storage.\n+     */\n+    private final Storage storage;\n+\n+    /**\n+     * Path to key transformation.\n+     */\n+    private final Function<String, Key> transform;\n+\n+    /**\n+     * Slice by key from storage.\n+     * @param storage Storage\n+     */\n+    public SliceUpload(final Storage storage) {\n+        this(storage, Key.From::new);\n+    }\n+\n+    /**\n+     * Slice by key from storage using custom URI path transformation.\n+     * @param storage Storage\n+     * @param transform Transformation\n+     */\n+    public SliceUpload(final Storage storage,\n+        final Function<String, Key> transform) {\n+        this.storage = storage;\n+        this.transform = transform;\n+    }\n+\n+    @Override\n+    public Response response(final String line,\n+        final Iterable<Map.Entry<String, String>> headers,\n+        final Publisher<ByteBuffer> body) {\n+        return new AsyncResponse(\n+            CompletableFuture.supplyAsync(() -> new RequestLineFrom(line).uri().getPath())\n+                .thenApply(this.transform)\n+                .thenCompose(key -> this.storage.save(key, new ContentWithSize(body, headers)))\n+                .thenApply(rsp -> new RsWithStatus(RsStatus.CREATED))\n+        );\n+    }\n+\n+    /**\n+     * Content with size from headers.\n+     * @since 0.6\n+     */\n+    private static final class ContentWithSize implements Content {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30512672856715501abc3d2268772173c83c68f"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2853770116da34b6cf5b938ddcb6fe35f915bb51", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/http/commit/2853770116da34b6cf5b938ddcb6fe35f915bb51", "committedDate": "2020-03-12T07:46:01Z", "message": "#64 - review fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3329, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}