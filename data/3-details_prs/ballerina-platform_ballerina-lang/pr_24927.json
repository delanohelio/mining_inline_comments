{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTQ2MjMw", "number": 24927, "title": " Fix test execution logic when before/after functions fail ", "bodyText": "Purpose\n\nFix test execution logic when before/after functions fail\nResolves #21091\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-07-24T08:20:23Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927", "merged": true, "mergeCommit": {"oid": "e15a14f92e99ea6ed13508944158d2523792f92f"}, "closed": true, "closedAt": "2020-08-12T08:31:15Z", "author": {"login": "azinneera"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5FukCgBqjM1OTEwMTIzNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7gzI5AFqTQ2MDUzNDE2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e59ba8182cfb10f8110cb75ea49860f56d554e", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/79e59ba8182cfb10f8110cb75ea49860f56d554e", "committedDate": "2020-07-24T09:11:51Z", "message": "Refactor AfterSuite annotation in test bal files"}, "afterCommit": {"oid": "d852195ad456fd7d5860208c05d9a493fb1af178", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d852195ad456fd7d5860208c05d9a493fb1af178", "committedDate": "2020-07-27T17:59:27Z", "message": "Refactor AfterSuite annotation in test bal files"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d852195ad456fd7d5860208c05d9a493fb1af178", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d852195ad456fd7d5860208c05d9a493fb1af178", "committedDate": "2020-07-27T17:59:27Z", "message": "Refactor AfterSuite annotation in test bal files"}, "afterCommit": {"oid": "dc9f58de577d9162635e355c67cf229f416537a0", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dc9f58de577d9162635e355c67cf229f416537a0", "committedDate": "2020-07-27T18:01:36Z", "message": "Refactor AfterSuite annotation in test bal files"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc9f58de577d9162635e355c67cf229f416537a0", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dc9f58de577d9162635e355c67cf229f416537a0", "committedDate": "2020-07-27T18:01:36Z", "message": "Refactor AfterSuite annotation in test bal files"}, "afterCommit": {"oid": "b2ab0b593739e84148e105126f56651b821fca91", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b2ab0b593739e84148e105126f56651b821fca91", "committedDate": "2020-07-27T19:20:49Z", "message": "Refactor AfterSuite annotation in test bal files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzEyMTg2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#pullrequestreview-456312186", "createdAt": "2020-07-28T05:28:30Z", "commit": {"oid": "ba67614b4d2e3fba1404b985e02e5984713fdea8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNToyODozMFrOG39Kjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNToyODozMFrOG39Kjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyNjk5MQ==", "bodyText": "Better to add a new line at the end there are some more files you need to fix.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#discussion_r461326991", "createdAt": "2020-07-28T05:28:30Z", "author": {"login": "hevayo"}, "path": "cli/ballerina-packerina/src/test/resources/test-resources/valid-project/src/mytemplate/tests/main_test.bal", "diffHunk": "@@ -33,7 +33,7 @@ function afterFunc () {\n \n # After Suite Function\n \n-@test:AfterSuite\n+@test:AfterSuite {}\n function afterSuiteFunc () {\n     io:println(\"I'm the after suite function!\");\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba67614b4d2e3fba1404b985e02e5984713fdea8"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzI4Mjc1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#pullrequestreview-456328275", "createdAt": "2020-07-28T06:11:17Z", "commit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDcyMDAw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#pullrequestreview-456472000", "createdAt": "2020-07-28T09:43:13Z", "commit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0MzoxM1rOG4FAZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0MzoxM1rOG4FAZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1NTQ2Mg==", "bodyText": "Instead of instanceof can we check the node kind? i.e. attachmentNode.getExpression().getKind() == NodeKind.RECORD_LITERAL_EXP", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#discussion_r461455462", "createdAt": "2020-07-28T09:43:13Z", "author": {"login": "anupama-pathirage"}, "path": "misc/testerina/modules/testerina-core/src/main/java/org/ballerinalang/testerina/core/TestAnnotationProcessor.java", "diffHunk": "@@ -148,7 +149,22 @@ public void process(FunctionNode functionNode, List<AnnotationAttachmentNode> an\n             if (BEFORE_SUITE_ANNOTATION_NAME.equals(annotationName)) {\n                 suite.addBeforeSuiteFunction(functionName);\n             } else if (AFTER_SUITE_ANNOTATION_NAME.equals(annotationName)) {\n-                suite.addAfterSuiteFunction(functionName);\n+                AtomicBoolean alwaysRun = new AtomicBoolean(false);\n+                if (attachmentNode.getExpression() instanceof BLangRecordLiteral) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDczNDQx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#pullrequestreview-456473441", "createdAt": "2020-07-28T09:45:10Z", "commit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0NToxMFrOG4FE9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0NToxMFrOG4FE9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1NjYzMA==", "bodyText": "Shall we have a more meaningful variable name here or simply avoid 2 at the end?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#discussion_r461456630", "createdAt": "2020-07-28T09:45:10Z", "author": {"login": "anupama-pathirage"}, "path": "misc/testerina/modules/testerina-runtime/src/main/java/org/ballerinalang/test/runtime/BTestRunner.java", "diffHunk": "@@ -406,41 +411,53 @@ private void executeFunction(Test test, TestSuite suite, String packageName, Cla\n         }\n     }\n \n-    private void executeAfterFunction(Test test, TestSuite suite, ClassLoader classLoader, Scheduler scheduler)  {\n-        try {\n-            if (test.getAfterTestFunction() != null) {\n-                invokeTestFunction(suite, test.getAfterTestFunction(), classLoader, scheduler);\n+    private void executeAfterFunction(Test test, TestSuite suite, ClassLoader classLoader, Scheduler scheduler,\n+                                      AtomicBoolean shouldSkip, AtomicBoolean shouldSkipTest,\n+                                      List<String> failedAfterFuncTests)  {\n+        if (!shouldSkip.get() && !shouldSkipTest.get()) {\n+            try {\n+                if (test.getAfterTestFunction() != null) {\n+                    invokeTestFunction(suite, test.getAfterTestFunction(), classLoader, scheduler);\n+                }\n+            } catch (Throwable e) {\n+                failedAfterFuncTests.add(test.getTestName());\n+                String error = String.format(\"\\t[fail] \" + test + \" [after test function for the test %s] :\\n\\t    %s\",\n+                        test, formatErrorMessage(e));\n+                errStream.println(error);\n             }\n-        } catch (Throwable e) {\n-            String error = String.format(\"\\t[fail] \" + test + \" [after test function for the test %s] :\\n\\t    %s\",\n-                                  test, formatErrorMessage(e));\n-            errStream.println(error);\n         }\n     }\n \n-    private void executeAfterEachFunction(Test test, TestSuite suite, ClassLoader classLoader, Scheduler scheduler) {\n-        suite.getAfterEachFunctionNames().forEach(afterEachTest -> {\n-            String errorMsg2;\n-            try {\n-                invokeTestFunction(suite, afterEachTest, classLoader, scheduler);\n-            } catch (Throwable e) {\n-                errorMsg2 = String.format(\"\\t[fail] \" + afterEachTest +\n-                                                  \" [after each test function for the test %s] :\\n\\t    %s\",\n-                                          test, formatErrorMessage(e));\n-                errStream.println(errorMsg2);\n-            }\n-        });\n+    private void executeAfterEachFunction(Test test, TestSuite suite, ClassLoader classLoader, Scheduler scheduler,\n+                                          AtomicBoolean shouldSkip, AtomicBoolean shouldSkipTest) {\n+        if (!shouldSkip.get() && !shouldSkipTest.get()) {\n+            suite.getAfterEachFunctionNames().forEach(afterEachTest -> {\n+                String errorMsg2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee"}, "originalPosition": 136}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6db6befef8716d1b1ee73a377f41b6f2a9145ee", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f6db6befef8716d1b1ee73a377f41b6f2a9145ee", "committedDate": "2020-07-28T05:50:32Z", "message": "Add review suggestions"}, "afterCommit": {"oid": "b4e9ea4a7b5915f888d8848dcd19679a7505e762", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b4e9ea4a7b5915f888d8848dcd19679a7505e762", "committedDate": "2020-07-29T07:27:09Z", "message": "Add review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4e9ea4a7b5915f888d8848dcd19679a7505e762", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b4e9ea4a7b5915f888d8848dcd19679a7505e762", "committedDate": "2020-07-29T07:27:09Z", "message": "Add review suggestions"}, "afterCommit": {"oid": "f9d41bce41b8b0bf906d682a5815dc344e391137", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9d41bce41b8b0bf906d682a5815dc344e391137", "committedDate": "2020-07-29T07:35:30Z", "message": "Add review suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ba520497bfedb1a58d9cac5b320bb2f7bbbaee7", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8ba520497bfedb1a58d9cac5b320bb2f7bbbaee7", "committedDate": "2020-07-29T18:00:50Z", "message": "Fix test execution logic when before/after functions fail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95fd6bd828082889ebe5cb88e09971be39c4f306", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/95fd6bd828082889ebe5cb88e09971be39c4f306", "committedDate": "2020-07-29T18:00:50Z", "message": "Add alwaysRun field to AfterSuite annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12ac4129cda92a2bf78b070e5e0248e3a40f49dd", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/12ac4129cda92a2bf78b070e5e0248e3a40f49dd", "committedDate": "2020-07-29T18:02:21Z", "message": "Update testerina before after failure tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30ab83da4ff8afb283068164004abb5951e9040e", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/30ab83da4ff8afb283068164004abb5951e9040e", "committedDate": "2020-07-29T18:02:22Z", "message": "Refactor AfterSuite annotation in test bal files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f480554fa9a80211a5216c12bb51f7395d72dc8", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2f480554fa9a80211a5216c12bb51f7395d72dc8", "committedDate": "2020-07-29T18:02:22Z", "message": "Fix lang-server-core test failures related to aftersuite annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a228e1cbc550eeffbfc6f9347cd193a8228509b", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2a228e1cbc550eeffbfc6f9347cd193a8228509b", "committedDate": "2020-07-29T18:02:22Z", "message": "Add review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9d41bce41b8b0bf906d682a5815dc344e391137", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9d41bce41b8b0bf906d682a5815dc344e391137", "committedDate": "2020-07-29T07:35:30Z", "message": "Add review suggestions"}, "afterCommit": {"oid": "2a228e1cbc550eeffbfc6f9347cd193a8228509b", "author": {"user": {"login": "azinneera", "name": "Asma Jabir"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2a228e1cbc550eeffbfc6f9347cd193a8228509b", "committedDate": "2020-07-29T18:02:22Z", "message": "Add review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTM0MTY1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24927#pullrequestreview-460534165", "createdAt": "2020-08-04T06:40:26Z", "commit": {"oid": "2a228e1cbc550eeffbfc6f9347cd193a8228509b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3705, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}