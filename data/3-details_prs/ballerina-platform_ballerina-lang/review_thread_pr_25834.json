{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NzE0OTAw", "number": 25834, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDozMjoxNFrOEj4f0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNjo0NzoxMVrOEkY-Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDYxMjY3OnYy", "diffSide": "RIGHT", "path": "langlib/langlib-test/src/test/resources/test-src/arraylib_test.bal", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDozMjoxNFrOHSfq_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDozMjoxNFrOHSfq_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NTMyNg==", "bodyText": "Instead of using toString shall we assert the value itself? We lose type information when we assert using toString.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489155326", "createdAt": "2020-09-16T04:32:14Z", "author": {"login": "MaryamZi"}, "path": "langlib/langlib-test/src/test/resources/test-src/arraylib_test.bal", "diffHunk": "@@ -1041,6 +1041,11 @@ function testSort10() {\n \n     assertValueEquality(sortedArr3.toString(), \"[0,1,10,2,3,6]\");\n     assertValueEquality(sortedArr3, arr);\n+\n+    int[] sortedArr4 = arr.sort(array:DESCENDING, (i) => i.toString());\n+\n+    assertValueEquality(sortedArr4.toString(), \"[6,3,2,10,1,0]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f13dbc8caa39e3c22b7489bf8404689190a01c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDYxNjk3OnYy", "diffSide": "RIGHT", "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDozNTowMVrOHSftaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjoyODowOVrOHS45Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NTk0NA==", "bodyText": "Can you please explain what we're trying to do with this block? Is there a sample invocation?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489155944", "createdAt": "2020-09-16T04:35:01Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -68,15 +69,15 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n         if (function != null) {\n-            BType elementType = ((BFunctionType) function.getType()).retType;\n-            if (!(elementType.getTag() == TypeTags.UNION_TAG &&\n-                    ((BUnionType) elementType).getMemberTypes().size() > 2)) {\n-                elemType = elementType;\n-            }\n+            elemType = ((BFunctionType) function.getType()).retType;\n             for (int i = 0; i < arr.size(); i++) {\n                 sortArr[i][0] = function.call(new Object[]{strand, arr.get(i), true});\n                 sortArr[i][1] = arr.get(i);\n             }\n+            if (elemType.getTag() == TypeTags.UNION_TAG &&\n+                    ((BUnionType) elemType).getMemberTypes().size() > 2) {\n+                elemType = TypeChecker.getType(sortArr[0][0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f13dbc8caa39e3c22b7489bf8404689190a01c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2MDQ4MQ==", "bodyText": "int[] arr = [1, 4, 2];\nint[] sortedArr = arr.sort(array:ASCENDING, (i) => i);\n\nwhen there is an arrow expression ((BFunctionType) function.getType()).retType is a union type containing all ordered types. This is to cater to getting the type of the array members we need to sort in such a scenario.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489160481", "createdAt": "2020-09-16T04:53:27Z", "author": {"login": "lasinicl"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -68,15 +69,15 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n         if (function != null) {\n-            BType elementType = ((BFunctionType) function.getType()).retType;\n-            if (!(elementType.getTag() == TypeTags.UNION_TAG &&\n-                    ((BUnionType) elementType).getMemberTypes().size() > 2)) {\n-                elemType = elementType;\n-            }\n+            elemType = ((BFunctionType) function.getType()).retType;\n             for (int i = 0; i < arr.size(); i++) {\n                 sortArr[i][0] = function.call(new Object[]{strand, arr.get(i), true});\n                 sortArr[i][1] = arr.get(i);\n             }\n+            if (elemType.getTag() == TypeTags.UNION_TAG &&\n+                    ((BUnionType) elemType).getMemberTypes().size() > 2) {\n+                elemType = TypeChecker.getType(sortArr[0][0]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NTk0NA=="}, "originalCommit": {"oid": "d9f13dbc8caa39e3c22b7489bf8404689190a01c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwMjk1Nw==", "bodyText": "Shall we add a comment explaining why we're doing it? Also it's not just an arrow function right? There can even be a normal function with a compatible union type as the return type?\nA union should have at least 2 members. If it has only 2, don't we have to change elemType?\nCan't sortArr or sortArr[0] be empty here?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489502957", "createdAt": "2020-09-16T14:55:12Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -68,15 +69,15 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n         if (function != null) {\n-            BType elementType = ((BFunctionType) function.getType()).retType;\n-            if (!(elementType.getTag() == TypeTags.UNION_TAG &&\n-                    ((BUnionType) elementType).getMemberTypes().size() > 2)) {\n-                elemType = elementType;\n-            }\n+            elemType = ((BFunctionType) function.getType()).retType;\n             for (int i = 0; i < arr.size(); i++) {\n                 sortArr[i][0] = function.call(new Object[]{strand, arr.get(i), true});\n                 sortArr[i][1] = arr.get(i);\n             }\n+            if (elemType.getTag() == TypeTags.UNION_TAG &&\n+                    ((BUnionType) elemType).getMemberTypes().size() > 2) {\n+                elemType = TypeChecker.getType(sortArr[0][0]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NTk0NA=="}, "originalCommit": {"oid": "d9f13dbc8caa39e3c22b7489bf8404689190a01c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU2ODUzMA==", "bodyText": "Added a comment. That condition checking was only added for arrow functions. When it's an arrow function we definitely know that the function return type is a union with more than 2 member types.  In other cases if return type is a union it can contain maximum of two members. Thus this condition is checked if (elemType.getTag() == TypeTags.UNION_TAG && ((BUnionType) elemType).getMemberTypes().size() > 2) and the type of values in sortArr is taken.\nThis is already handled in \n  \n    \n      ballerina-lang/langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java\n    \n    \n         Line 92\n      in\n      4fc6993\n    \n    \n    \n    \n\n        \n          \n           if (elemType.getTag() == TypeTags.UNION_TAG) { \n        \n    \n  \n\n\nyes. therefore changed the position of the condition checking for arrow functions", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489568530", "createdAt": "2020-09-16T16:28:09Z", "author": {"login": "lasinicl"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -68,15 +69,15 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n         if (function != null) {\n-            BType elementType = ((BFunctionType) function.getType()).retType;\n-            if (!(elementType.getTag() == TypeTags.UNION_TAG &&\n-                    ((BUnionType) elementType).getMemberTypes().size() > 2)) {\n-                elemType = elementType;\n-            }\n+            elemType = ((BFunctionType) function.getType()).retType;\n             for (int i = 0; i < arr.size(); i++) {\n                 sortArr[i][0] = function.call(new Object[]{strand, arr.get(i), true});\n                 sortArr[i][1] = arr.get(i);\n             }\n+            if (elemType.getTag() == TypeTags.UNION_TAG &&\n+                    ((BUnionType) elemType).getMemberTypes().size() > 2) {\n+                elemType = TypeChecker.getType(sortArr[0][0]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NTk0NA=="}, "originalCommit": {"oid": "d9f13dbc8caa39e3c22b7489bf8404689190a01c"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2Mjg1MTYxOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDo1ODoyOFrOHS1CyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0MjoyNlrOHS5azQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwNTQ4MA==", "bodyText": "Do we have tests covering this? Is this only an issue with lambda functions?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489505480", "createdAt": "2020-09-16T14:58:28Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -5382,12 +5382,15 @@ private void checkArrayLibSortFuncArgs(BLangInvocation iExpr) {\n             returnType = ((BLangSimpleVarRef) keyFunction).type.getReturnType();\n         } else if (keyFunction.getKind() == NodeKind.ARROW_EXPR) {\n             BLangArrowFunction arrowFunction = ((BLangArrowFunction) keyFunction);\n-            pos = arrowFunction.params.get(0).pos;\n-            returnType = arrowFunction.params.get(0).type;\n+            pos = arrowFunction.body.expr.pos;\n+            returnType = arrowFunction.body.expr.type;\n         } else {\n             BLangLambdaFunction keyLambdaFunction = (BLangLambdaFunction) keyFunction;\n             pos = keyLambdaFunction.function.pos;\n             returnType = keyLambdaFunction.function.type.getReturnType();\n+            if (returnType.tag == TypeTags.SEMANTIC_ERROR) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40fd3d9df1d71d0c56af65bfb7a11368013443b6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU3NzE2NQ==", "bodyText": "Added a test. It's an issue with arrow functions", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489577165", "createdAt": "2020-09-16T16:42:26Z", "author": {"login": "lasinicl"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -5382,12 +5382,15 @@ private void checkArrayLibSortFuncArgs(BLangInvocation iExpr) {\n             returnType = ((BLangSimpleVarRef) keyFunction).type.getReturnType();\n         } else if (keyFunction.getKind() == NodeKind.ARROW_EXPR) {\n             BLangArrowFunction arrowFunction = ((BLangArrowFunction) keyFunction);\n-            pos = arrowFunction.params.get(0).pos;\n-            returnType = arrowFunction.params.get(0).type;\n+            pos = arrowFunction.body.expr.pos;\n+            returnType = arrowFunction.body.expr.type;\n         } else {\n             BLangLambdaFunction keyLambdaFunction = (BLangLambdaFunction) keyFunction;\n             pos = keyLambdaFunction.function.pos;\n             returnType = keyLambdaFunction.function.type.getReturnType();\n+            if (returnType.tag == TypeTags.SEMANTIC_ERROR) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwNTQ4MA=="}, "originalCommit": {"oid": "40fd3d9df1d71d0c56af65bfb7a11368013443b6"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NTc4NjMyOnYy", "diffSide": "RIGHT", "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNTo1MToxMFrOHTSYQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNTo1MToxMFrOHTSYQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NjExMg==", "bodyText": "Do we need to check this element by element? This gets overridden right?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r489986112", "createdAt": "2020-09-17T05:51:10Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -69,13 +70,17 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n         if (function != null) {\n-            BType elementType = ((BFunctionType) function.getType()).retType;\n-            if (!(elementType.getTag() == TypeTags.UNION_TAG &&\n-                    ((BUnionType) elementType).getMemberTypes().size() > 2)) {\n-                elemType = elementType;\n-            }\n+            elemType = ((BFunctionType) function.getType()).retType;\n             for (int i = 0; i < arr.size(); i++) {\n                 sortArr[i][0] = function.call(new Object[]{strand, arr.get(i), true});\n+                // Get the type of the sortArr elements when there is an arrow expression as the key function\n+                if (elemType.getTag() == TypeTags.UNION_TAG &&\n+                        ((BUnionType) elemType).getMemberTypes().size() > 2) {\n+                    BType sortArrElemType = TypeChecker.getType(sortArr[i][0]);\n+                    if (sortArrElemType.getTag() != TypeTags.NULL_TAG) {\n+                        elemType = sortArrElemType;\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1969198d0fc9ab753082eda4cc9b9c30a24ea6d"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NTkzMzExOnYy", "diffSide": "RIGHT", "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNjo0NzoxMVrOHTTuWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNjo0NzoxMVrOHTTuWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAwODE1NA==", "bodyText": "Shall we move this to within the if block?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25834#discussion_r490008154", "createdAt": "2020-09-17T06:47:11Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.array/src/main/java/org/ballerinalang/langlib/array/Sort.java", "diffHunk": "@@ -68,14 +69,20 @@ public static ArrayValue sort(Strand strand, ArrayValue arr, Object direction, O\n \n         Object[][] sortArr = new Object[arr.size()][2];\n         Object[][] sortArrClone = new Object[arr.size()][2];\n+        boolean elementTypeIdentified = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "910ae3d6644efb15421c28e85823940759cec7b2"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 124, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}