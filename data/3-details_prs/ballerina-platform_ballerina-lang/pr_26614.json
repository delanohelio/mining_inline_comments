{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDU2NTQ4", "number": 26614, "title": "Replace DiagnosticPos, DiagnosticSource, and Diagnostic Kind with new diagnostic API", "bodyText": "Purpose\n$title\nFixes #25800\nApproach\n\nDescribe how you are implementing the solutions along with the design details.\n\nSamples\n\nProvide high-level details about the samples related to this feature.\n\nRemarks\n\nList any other known issues, related PRs, TODO items, or any other notes related to the PR.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-10-27T04:21:08Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614", "merged": true, "mergeCommit": {"oid": "d605cc2acb2d45df8baaa705756f6e072ebcdb10"}, "closed": true, "closedAt": "2020-11-02T09:21:42Z", "author": {"login": "dulajdilshan"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWiD5iAFqTUxNzM0ODIxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYhC9XgFqTUyMTQ1MzAyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzQ4MjEx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#pullrequestreview-517348211", "createdAt": "2020-10-27T04:56:18Z", "commit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDo1NjoxOFrOHorbZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNToyMzozMFrOHor3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxNjYxMw==", "bodyText": "We shouldn't expose this API in the interface, since this is temporary.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#discussion_r512416613", "createdAt": "2020-10-27T04:56:18Z", "author": {"login": "SupunS"}, "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/util/diagnostic/DiagnosticLog.java", "diffHunk": "@@ -30,12 +32,19 @@\n \n \n     /**\n-     * Logs a message of the specified {@link Diagnostic.Kind} at the {@link DiagnosticPosition}.\n+     * Logs a message of the specified {@link Diagnostic.Kind} at the {@link Location}.\n      *\n      * @param kind    the kind of the diagnostic\n-     * @param pos     the position of the source code element.\n+     * @param location  the location of the source code element.\n      * @param message the message\n      */\n-    void logDiagnostic(Kind kind, DiagnosticPosition pos, CharSequence message);\n+    void logDiagnostic(Kind kind, Location location, CharSequence message);\n+\n+    /**\n+     * Set the working package id for logging.\n+     *\n+     * @param packageID Package Id specified in the {@link BLangPackage}\n+     */\n+    void setCurrentPackageId(PackageID packageID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxNzIxNg==", "bodyText": "Let's deprecate this API, and introduce an overloaded API, that accepts the package ID as a parameter.\nvoid logDiagnostic(Kind kind, PackageID pkgId, Location location, CharSequence message);\nWe should eventually migrate everything to use this API", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#discussion_r512417216", "createdAt": "2020-10-27T04:58:40Z", "author": {"login": "SupunS"}, "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/util/diagnostic/DiagnosticLog.java", "diffHunk": "@@ -30,12 +32,19 @@\n \n \n     /**\n-     * Logs a message of the specified {@link Diagnostic.Kind} at the {@link DiagnosticPosition}.\n+     * Logs a message of the specified {@link Diagnostic.Kind} at the {@link Location}.\n      *\n      * @param kind    the kind of the diagnostic\n-     * @param pos     the position of the source code element.\n+     * @param location  the location of the source code element.\n      * @param message the message\n      */\n-    void logDiagnostic(Kind kind, DiagnosticPosition pos, CharSequence message);\n+    void logDiagnostic(Kind kind, Location location, CharSequence message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyMDcxMQ==", "bodyText": "Shall we remove this interface? The changes we are introducing with this PR are breaking-changes anyway, so I feel its good to do all these changes at one go.\nLets remove DiagnosticListener.class also", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#discussion_r512420711", "createdAt": "2020-10-27T05:12:07Z", "author": {"login": "SupunS"}, "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/util/diagnostic/Diagnostic.java", "diffHunk": "@@ -17,6 +17,9 @@\n */\n package org.ballerinalang.util.diagnostic;\n \n+import io.ballerina.tools.diagnostics.Location;\n+import org.ballerinalang.model.elements.PackageID;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyMjM1Ng==", "bodyText": "cUnitName is unused", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#discussion_r512422356", "createdAt": "2020-10-27T05:18:16Z", "author": {"login": "SupunS"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/Parser.java", "diffHunk": "@@ -117,30 +114,25 @@ private CompilationUnitNode generateCompilationUnitNew(CompilerInput sourceEntry\n             return compilationUnit;\n         }\n \n-        BLangNodeTransformer bLangNodeTransformer = new BLangNodeTransformer(this.context, diagnosticSource);\n+        BLangNodeTransformer bLangNodeTransformer = new BLangNodeTransformer(this.context, packageID, entryName);\n         compilationUnit = (BLangCompilationUnit) bLangNodeTransformer.accept(tree.rootNode()).get(0);\n+        compilationUnit.setPackageID(packageID);\n         parserCache.put(packageID, entryName, hash, length, compilationUnit);\n         // Node cloner will run for valid ASTs.\n         // This will verify, any modification done to the AST will get handled properly.\n         compilationUnit = nodeCloner.cloneCUnit(compilationUnit);\n         return compilationUnit;\n     }\n \n-    private BDiagnosticSource getDiagnosticSource(CompilerInput sourceEntry, PackageID packageID) {\n-        String entryName = sourceEntry.getEntryName();\n-        return new BDiagnosticSource(packageID, entryName);\n-    }\n-\n-\n     private static int getHash(byte[] code) {\n         // Assuming hash collision is unlikely in a modified source.\n         // Additionally code.Length is considered to avoid hash collision.\n         return Arrays.hashCode(code);\n     }\n \n-    private void reportSyntaxDiagnostics(BDiagnosticSource diagnosticSource, SyntaxTree tree) {\n+    private void reportSyntaxDiagnostics(String cUnitName, PackageID pkgID, SyntaxTree tree) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyMzcyOQ==", "bodyText": "I think we don't need this method, if we always pass the package ID when logging. Since we would eventually move to that, this method won't be needed.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#discussion_r512423729", "createdAt": "2020-10-27T05:23:30Z", "author": {"login": "SupunS"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/diagnostic/BLangDiagnosticLog.java", "diffHunk": "@@ -65,40 +66,58 @@ public static BLangDiagnosticLog getInstance(CompilerContext context) {\n         return dLogger;\n     }\n \n+    public static BLangDiagnosticLog getInstance(CompilerContext context, PackageID packageID) {\n+        BLangDiagnosticLog dLogger = context.get(DIAGNOSTIC_LOG_KEY);\n+        if (dLogger == null) {\n+            dLogger = new BLangDiagnosticLog(context);\n+        }\n+\n+        if (packageID != null) {\n+            dLogger.setCurrentPackageId(packageID);\n+        }\n+\n+        return dLogger;\n+    }\n+\n+    @Override\n+    public void setCurrentPackageId(PackageID packageID) {\n+        this.currentPackageId = packageID;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "885ca46480a3d83044206f9f1bb76257aae71515", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/885ca46480a3d83044206f9f1bb76257aae71515", "committedDate": "2020-10-27T04:06:48Z", "message": "Fix errors"}, "afterCommit": {"oid": "8b0794036cf9f24b6a4f94fcb176bf1cfe709890", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8b0794036cf9f24b6a4f94fcb176bf1cfe709890", "committedDate": "2020-10-29T05:35:40Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b0794036cf9f24b6a4f94fcb176bf1cfe709890", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8b0794036cf9f24b6a4f94fcb176bf1cfe709890", "committedDate": "2020-10-29T05:35:40Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}, "afterCommit": {"oid": "e94d053f5b4cb9f4008b7e3d7b60279c09136047", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e94d053f5b4cb9f4008b7e3d7b60279c09136047", "committedDate": "2020-10-29T06:23:46Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95140444b2eb28b8150787d4c4fec08b6328ff0b", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/95140444b2eb28b8150787d4c4fec08b6328ff0b", "committedDate": "2020-10-30T05:27:09Z", "message": "Apply again \"Remove DiagnosticSource and DiagnosticPos usages\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe49dca722fe0f88f2c4dac1c35927911a124cf0", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fe49dca722fe0f88f2c4dac1c35927911a124cf0", "committedDate": "2020-10-30T05:27:09Z", "message": "Fix errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54c5dae6b7672f6e8b18fc7d7825bd670f3ef52e", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/54c5dae6b7672f6e8b18fc7d7825bd670f3ef52e", "committedDate": "2020-10-30T05:27:09Z", "message": "Move DiagnosticKind to outside"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c5b598bcc19ac32073189c0923b60c70aa0c90b", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1c5b598bcc19ac32073189c0923b60c70aa0c90b", "committedDate": "2020-10-30T05:27:09Z", "message": "Remove Diagnostic interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9bae3e44658f94506e0f0074d6b4c07380b7ed", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bc9bae3e44658f94506e0f0074d6b4c07380b7ed", "committedDate": "2020-10-30T05:27:09Z", "message": "Refactor according to the review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e05f715f7fc571975b43b850c5c8a561b71e764", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e05f715f7fc571975b43b850c5c8a561b71e764", "committedDate": "2020-10-30T05:27:09Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e94d053f5b4cb9f4008b7e3d7b60279c09136047", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e94d053f5b4cb9f4008b7e3d7b60279c09136047", "committedDate": "2020-10-29T06:23:46Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}, "afterCommit": {"oid": "1e05f715f7fc571975b43b850c5c8a561b71e764", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e05f715f7fc571975b43b850c5c8a561b71e764", "committedDate": "2020-10-30T05:27:09Z", "message": "Replace DiagnosticKind with DiagnosticSeverity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f74a64df38d7232ebac7a55eb93b3d76cd7b8745", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f74a64df38d7232ebac7a55eb93b3d76cd7b8745", "committedDate": "2020-11-02T06:49:03Z", "message": "Merge branch 'master' into diag-new\n\n# Conflicts:\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/JvmMethodGen.java\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c97cd44db93632da8eb6fdc5fabfb2295d420217", "author": {"user": {"login": "dulajdilshan", "name": "Dulaj Dilshan"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c97cd44db93632da8eb6fdc5fabfb2295d420217", "committedDate": "2020-11-02T07:21:05Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDUzMDIy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26614#pullrequestreview-521453022", "createdAt": "2020-11-02T09:21:31Z", "commit": {"oid": "c97cd44db93632da8eb6fdc5fabfb2295d420217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4289, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}