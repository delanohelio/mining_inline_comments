{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDc4NTcy", "number": 20624, "title": "Fix intermittent WebSocketMetricsTestCase failure", "bodyText": "Purpose\nIssue was the test client attempting to connect to the WebSocket server before it was started.\nFixes #20595\nApproach\nAdded a timeout to wait up to 10 seconds to connect to the WebSocket server\nRemarks\nPR to 1.1.x - #20645", "createdAt": "2020-01-16T06:30:07Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624", "merged": true, "mergeCommit": {"oid": "8d12b0bb636de239235342ee73379dee0d36f0c6"}, "closed": true, "closedAt": "2020-01-22T03:32:45Z", "author": {"login": "kaneeldias"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb61-NJgFqTM0Mzc0Mzg5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8tO_MgFqTM0NjMyOTEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzQzODky", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#pullrequestreview-343743892", "createdAt": "2020-01-16T08:35:26Z", "commit": {"oid": "c4284a59030c2bbc804391c0b11c26ba0bdae0a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODozNToyNlrOFeRhAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODozNToyNlrOFeRhAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI4ODU3OQ==", "bodyText": "Please add a new line at the end of the file", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#discussion_r367288579", "createdAt": "2020-01-16T08:35:26Z", "author": {"login": "kalaiyarasiganeshalingam"}, "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/WebSocketMetricsTestCase.java", "diffHunk": "@@ -171,4 +179,4 @@ private String generateNewKey(String metric, String[] tags) {\n         key = key + \"}\";\n         return key;\n     }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4284a59030c2bbc804391c0b11c26ba0bdae0a7"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzU2MTM1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#pullrequestreview-343756135", "createdAt": "2020-01-16T08:58:22Z", "commit": {"oid": "c4284a59030c2bbc804391c0b11c26ba0bdae0a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODo1ODoyMlrOFeSG0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODo1ODoyMlrOFeSG0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI5ODI1Ng==", "bodyText": "Why we can't use setCountDownLatch()  instead of this?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#discussion_r367298256", "createdAt": "2020-01-16T08:58:22Z", "author": {"login": "kalaiyarasiganeshalingam"}, "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/WebSocketMetricsTestCase.java", "diffHunk": "@@ -82,24 +84,30 @@ private void setup() throws Exception {\n      */\n     @Test\n     public void testMetrics() throws Exception {\n-        WebSocketTestClient client = new WebSocketTestClient(\"ws://localhost:9090/basic/ws\");\n-        client.handshake();\n-        client.sendText(MESSAGE);\n-        client.sendText(MESSAGE);\n-        client.sendText(MESSAGE);\n-        client.sendText(MESSAGE);\n-        client.sendText(MESSAGE);\n-        client.sendPing(SENDING_BYTE_BUFFER);\n-        client.sendPong(SENDING_BYTE_BUFFER);\n-        client.sendBinary(SENDING_BYTE_BUFFER);\n-        client.sendText(CLOSE_MESSAGE);\n+        // Test Service\n+        final WebSocketTestClient[] client = new WebSocketTestClient[1];\n+        await().atMost(20, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4284a59030c2bbc804391c0b11c26ba0bdae0a7"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4284a59030c2bbc804391c0b11c26ba0bdae0a7", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c4284a59030c2bbc804391c0b11c26ba0bdae0a7", "committedDate": "2020-01-16T06:29:17Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}, "afterCommit": {"oid": "3be2e74bdb95c350404af171543fc4e780315054", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3be2e74bdb95c350404af171543fc4e780315054", "committedDate": "2020-01-16T13:29:17Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3be2e74bdb95c350404af171543fc4e780315054", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3be2e74bdb95c350404af171543fc4e780315054", "committedDate": "2020-01-16T13:29:17Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}, "afterCommit": {"oid": "2bb3f3efa07509435c7e81926fe46effd752fd6b", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2bb3f3efa07509435c7e81926fe46effd752fd6b", "committedDate": "2020-01-17T04:27:00Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bb3f3efa07509435c7e81926fe46effd752fd6b", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2bb3f3efa07509435c7e81926fe46effd752fd6b", "committedDate": "2020-01-17T04:27:00Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}, "afterCommit": {"oid": "97da8af470cd7483c222c25498602076c745909f", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/97da8af470cd7483c222c25498602076c745909f", "committedDate": "2020-01-17T04:27:48Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97da8af470cd7483c222c25498602076c745909f", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/97da8af470cd7483c222c25498602076c745909f", "committedDate": "2020-01-17T04:27:48Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}, "afterCommit": {"oid": "a422f9fc9852361e7373ec38abb3aa093cfa8100", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a422f9fc9852361e7373ec38abb3aa093cfa8100", "committedDate": "2020-01-17T04:50:09Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzY2MDU2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#pullrequestreview-344366056", "createdAt": "2020-01-17T05:08:25Z", "commit": {"oid": "a422f9fc9852361e7373ec38abb3aa093cfa8100"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNTowODoyNVrOFeu-kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNTowODoyNVrOFeu-kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MTI4MA==", "bodyText": "No need to create the countDownLatch to handshake because we already set it in the implementation. Please refer the test.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#discussion_r367771280", "createdAt": "2020-01-17T05:08:25Z", "author": {"login": "kalaiyarasiganeshalingam"}, "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/WebSocketMetricsTestCase.java", "diffHunk": "@@ -82,7 +86,9 @@ private void setup() throws Exception {\n      */\n     @Test\n     public void testMetrics() throws Exception {\n-        WebSocketTestClient client = new WebSocketTestClient(\"ws://localhost:9090/basic/ws\");\n+        WebSocketTestClient client = new WebSocketTestClient(SERVER_URL);\n+        CountDownLatch countDownLatch = new CountDownLatch(1);\n+        countDownLatch.await(10, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a422f9fc9852361e7373ec38abb3aa093cfa8100"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7024a2e0b11047d8e7a3e11c5efa32f51a21da2c", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7024a2e0b11047d8e7a3e11c5efa32f51a21da2c", "committedDate": "2020-01-20T07:44:48Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a422f9fc9852361e7373ec38abb3aa093cfa8100", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a422f9fc9852361e7373ec38abb3aa093cfa8100", "committedDate": "2020-01-17T04:50:09Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}, "afterCommit": {"oid": "7024a2e0b11047d8e7a3e11c5efa32f51a21da2c", "author": {"user": {"login": "kaneeldias", "name": "Kaneel Dias"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7024a2e0b11047d8e7a3e11c5efa32f51a21da2c", "committedDate": "2020-01-20T07:44:48Z", "message": "Fix intermittent WebSocketMetricsTestCase failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzI5MTA2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20624#pullrequestreview-346329106", "createdAt": "2020-01-22T03:32:29Z", "commit": {"oid": "7024a2e0b11047d8e7a3e11c5efa32f51a21da2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4311, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}