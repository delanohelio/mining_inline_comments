{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDQ5Nzk2", "number": 23087, "title": "Instantiate record values using closures values captured is typedesc", "bodyText": "Fixes #22908 sub task of #20851", "createdAt": "2020-05-04T16:19:04Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087", "merged": true, "mergeCommit": {"oid": "99f2646aa13b897d14f89ce3f27112ecc730abaa"}, "closed": true, "closedAt": "2020-05-06T11:13:24Z", "author": {"login": "manuranga"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcej8d4AFqTQwNjM3OTE0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcekqiHgFqTQwNjQxMzYxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2Mzc5MTQ0", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087#pullrequestreview-406379144", "createdAt": "2020-05-06T07:56:32Z", "commit": {"oid": "56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzo1NjozMlrOGRH3Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzo1NjozMlrOGRH3Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwNzc1OQ==", "bodyText": "remove this new line", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087#discussion_r420607759", "createdAt": "2020-05-06T07:56:32Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/JvmValueGen.java", "diffHunk": "@@ -568,17 +573,80 @@ private void createInstantiateMethod(ClassWriter cw, BRecordType recordType) {\n         loadType(mv, recordType);\n         mv.visitMethodInsn(INVOKESPECIAL, className, \"<init>\", String.format(\"(L%s;)V\", BTYPE), false);\n \n+\n+        BAttachedFunction initializer = ((BRecordTypeSymbol) recordType.tsymbol).initializerFunc;\n+        StringBuilder closureParamSignature = calcClosureMapSignature(initializer.type.paramTypes.size());\n+\n         // Invoke the init-function of this type.\n         mv.visitVarInsn(ALOAD, 1);\n         mv.visitInsn(SWAP);\n-        mv.visitMethodInsn(INVOKESTATIC, className, \"$init\",\n-                String.format(\"(L%s;L%s;)V\", STRAND, MAP_VALUE), false);\n \n+\n+        // Invoke the init-functions of referenced types. This is done to initialize the\n+        // defualt values of the fields coming from the referenced types.\n+        for (BType typeRef : typeDef.referencedTypes) {\n+            if (typeRef.tag == TypeTags.RECORD) {\n+                String refTypeClassName = getTypeValueClassName(typeRef.tsymbol.pkgID, toNameString(typeRef));\n+                mv.visitInsn(DUP2);\n+                mv.visitMethodInsn(INVOKESTATIC, refTypeClassName, \"$init\",\n+                                   String.format(\"(L%s;L%s;)V\", STRAND, MAP_VALUE), false);\n+            }\n+        }\n+\n+\n+        mv.visitVarInsn(ALOAD, 0);\n+        mv.visitFieldInsn(GETFIELD, TYPEDESC_VALUE_IMPL, TYPEDESC_VALUE_IMPL_CLOSURES,\n+                          String.format(\"[L%s;\", MAP_VALUE));\n+\n+        for (int i = 0; i < initializer.type.paramTypes.size(); i++) {\n+            mv.visitInsn(DUP);\n+            mv.visitIntInsn(BIPUSH, i);\n+            mv.visitInsn(AALOAD);\n+            mv.visitInsn(SWAP);\n+\n+            mv.visitInsn(ICONST_1);\n+            mv.visitInsn(SWAP);\n+        }\n+        mv.visitInsn(POP);\n+\n+\n+        // Invoke the init-function of this type.\n+        String initFuncName;\n+        String valueClassName;\n+        List<BIRFunction> attachedFuncs = typeDef.attachedFuncs;\n+\n+        // Attached functions are empty for type-labeling. In such cases, call the __init() of\n+        // the original type value;\n+        if (attachedFuncs.size() != 0) {\n+            initFuncName = attachedFuncs.get(0).name.value;\n+            valueClassName = className;\n+        } else {\n+            // record type is the original record-type of this type-label\n+            valueClassName = getTypeValueClassName(recordType.tsymbol.pkgID, toNameString(recordType));\n+            initFuncName = cleanupFunctionName(recordType.name + \"__init_\");\n+        }\n+\n+        mv.visitMethodInsn(INVOKESTATIC, valueClassName, initFuncName,\n+                           String.format(\"(L%s;L%s;%s)L%s;\", STRAND, MAP_VALUE, closureParamSignature, OBJECT),\n+                           false);\n+\n+        mv.visitInsn(POP);\n         mv.visitInsn(ARETURN);\n         mv.visitMaxs(0, 0);\n         mv.visitEnd();\n     }\n \n+    private StringBuilder calcClosureMapSignature(int size) {\n+        StringBuilder closureParamSignature = new StringBuilder();\n+        for (int i = 0; i < size; i++) {\n+            closureParamSignature.append('L');\n+            closureParamSignature.append(MAP_VALUE);\n+            closureParamSignature.append(\";Z\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzgwNDQ3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087#pullrequestreview-406380447", "createdAt": "2020-05-06T07:58:30Z", "commit": {"oid": "56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzo1ODozMFrOGRH62g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzo1ODozMFrOGRH62g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwODczMA==", "bodyText": "commented out sections? do we need them?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087#discussion_r420608730", "createdAt": "2020-05-06T07:58:30Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ClosureDesugar.java", "diffHunk": "@@ -1245,6 +1249,13 @@ public void visit(BLangRecordLiteral.BLangMapLiteral mapLiteral) {\n \n     @Override\n     public void visit(BLangRecordLiteral.BLangStructLiteral structLiteral) {\n+        SymbolEnv symbolEnv = env.createClone();\n+//        bLangLambdaFunction.capturedClosureEnv = symbolEnv;\n+        BLangFunction enclInvokable = (BLangFunction) symbolEnv.enclInvokable;\n+        // Save param closure map of the encl invokable.\n+//        bLangLambdaFunction.paramMapSymbolsOfEnclInvokable = enclInvokable.paramClosureMap;\n+//        boolean isWorker = bLangLambdaFunction.function.flagSet.contains(Flag.WORKER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ee33664c6448286038270823d4e32f3644d19e2", "author": {"user": {"login": "manuranga", "name": "manuranga perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0ee33664c6448286038270823d4e32f3644d19e2", "committedDate": "2020-05-06T08:18:57Z", "message": "Instantiate record values using closures values captured is typedesc\n\nFixes #22908 sub task of #20851"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf", "author": {"user": {"login": "manuranga", "name": "manuranga perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/56248cd7fe8bdb2369d6352ffe5bd03f7c2183cf", "committedDate": "2020-05-04T16:07:46Z", "message": "Instantiate record values using closures values captured is typedesc\n\nFixes #22908 sub task of #20851"}, "afterCommit": {"oid": "0ee33664c6448286038270823d4e32f3644d19e2", "author": {"user": {"login": "manuranga", "name": "manuranga perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0ee33664c6448286038270823d4e32f3644d19e2", "committedDate": "2020-05-06T08:18:57Z", "message": "Instantiate record values using closures values captured is typedesc\n\nFixes #22908 sub task of #20851"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NDEzNjE1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23087#pullrequestreview-406413615", "createdAt": "2020-05-06T08:46:51Z", "commit": {"oid": "0ee33664c6448286038270823d4e32f3644d19e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3376, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}