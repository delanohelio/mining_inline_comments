{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzMzMzODk0", "number": 27605, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDozODo1N1rOFOFitw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzoxMzoyMFrOFOxNHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMzE1MTkxOnYy", "diffSide": "RIGHT", "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDozODo1N1rOISpXxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDo1MDoyM1rOISpx-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyMzEwOQ==", "bodyText": "Seems like some calls to this function still pass the actual as the first arg, shall we check and update?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556423109", "createdAt": "2021-01-13T10:38:57Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -179,7 +202,7 @@ function testServiceDecl() {\n     reset();\n }\n \n-function assertEquality(any|error actual, any|error expected) {\n+function assertEquality(any|error expected, any|error actual) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyOTgxOA==", "bodyText": "will do", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556429818", "createdAt": "2021-01-13T10:50:23Z", "author": {"login": "rdhananjaya"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -179,7 +202,7 @@ function testServiceDecl() {\n     reset();\n }\n \n-function assertEquality(any|error actual, any|error expected) {\n+function assertEquality(any|error expected, any|error actual) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyMzEwOQ=="}, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMzE4NDIyOnYy", "diffSide": "RIGHT", "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDo0NzoyOFrOISprug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMTowMjoyM1rOISqOWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyODIxOA==", "bodyText": "Shouldn't LE be a subtype of the Listener object?\nThe spec says\n\nA module listener declares a variable in a similar way to a final variable declaration, but the type of the variable is always a subtype of the Listener object type, and it has the additional semantic of registering the variable's value with the module as a listener.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556428218", "createdAt": "2021-01-13T10:47:28Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -95,7 +117,8 @@ function getResourceAnnot(service object {} obj, string methodName, string[] pat\n } external;\n \n \n-listener Listener lsn = new Listener();\n+type LE Listener|EmptyListener|error;\n+listener LE lsn = new Listener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQzMDAyMQ==", "bodyText": "I don't this the spec is updated with this ballerina-platform/ballerina-spec#671", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556430021", "createdAt": "2021-01-13T10:50:46Z", "author": {"login": "rdhananjaya"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -95,7 +117,8 @@ function getResourceAnnot(service object {} obj, string methodName, string[] pat\n } external;\n \n \n-listener Listener lsn = new Listener();\n+type LE Listener|EmptyListener|error;\n+listener LE lsn = new Listener();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyODIxOA=="}, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQzNTQyMg==", "bodyText": "What's mentioned in the issue is re: the expression, right?\n\nWe could make listener-decl do the same thing: allow the expression in a listener to be of type L|E, where L is a listener and E is an error; if the expression results in an error, then module initialization fails.\n\nMy understanding was that a listener init can now return error;\nclass Listener {\n    function init() returns error? {\n\n    }\n    \n    ...\n}\nand if it is used in a listener-decl, and new actually returns error, module init fails?\nBut the listener declaration would still have just the listener as the type.\nlistener Listener ln = new;\nIf we allow the listener's type to include error, module initialization doesn't have to fail, right?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556435422", "createdAt": "2021-01-13T10:59:27Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -95,7 +117,8 @@ function getResourceAnnot(service object {} obj, string methodName, string[] pat\n } external;\n \n \n-listener Listener lsn = new Listener();\n+type LE Listener|EmptyListener|error;\n+listener LE lsn = new Listener();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyODIxOA=="}, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQzNzA4Mw==", "bodyText": "Yes you are correct", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556437083", "createdAt": "2021-01-13T11:02:23Z", "author": {"login": "rdhananjaya"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -95,7 +117,8 @@ function getResourceAnnot(service object {} obj, string methodName, string[] pat\n } external;\n \n \n-listener Listener lsn = new Listener();\n+type LE Listener|EmptyListener|error;\n+listener LE lsn = new Listener();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyODIxOA=="}, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNDI0MzgyOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxMzowMVrOISzxmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwMjozMzo1OVrOITM7QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5MzU2MQ==", "bodyText": "Would this work well when the union type has > 1 listener compatible type (say 2), and the user actually assigns a value of the second type to the variable?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556593561", "createdAt": "2021-01-13T15:13:01Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcxNzAwMQ==", "bodyText": "Updated the test case to test this scenario https://github.com/ballerina-platform/ballerina-lang/pull/27605/files#diff-2d258634ca06bf22db4f17e8bb66906ed1d42a448a1788a8e18403bdc2051583R120", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556717001", "createdAt": "2021-01-13T17:51:03Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5MzU2MQ=="}, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1MTk3MA==", "bodyText": "type LE EmptyListener|Listener;\nlistener LE lsn = new Listener();\n\nIn this scenario, this method would return EmptyListener, right? Was wondering if that could cause issues, because for example, when we consider the attach method, we'll be retrieving attach of EmptyListener instead of Listener even though the actual value is Listener.\nBasic scenarios seem to work as expected though.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556751970", "createdAt": "2021-01-13T18:48:03Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5MzU2MQ=="}, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAwNTYzMw==", "bodyText": "Not really, since method is invoked on the value as opposed to invoked on type I don't think there will be an issue,\nif we can guarantee that we pass the correct types as arguments.\nRelated discussion: ballerina-platform/ballerina-spec#320", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557005633", "createdAt": "2021-01-14T02:33:59Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5MzU2MQ=="}, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNDI3NDU2OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxOTowOVrOIS0EXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxOTowOVrOIS0EXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5ODM2Ng==", "bodyText": "No impact right now, but should we add the actual error types here? We can do this later maybe.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556598366", "createdAt": "2021-01-13T15:19:09Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));\n+        listenerCheckExpr.equivalentErrorTypeList.add(symTable.errorType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNTI4ODAzOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxODo1ODowMlrOIS9zVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1MToyMFrOITtrvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1Nzg0NA==", "bodyText": "The following results in a bad, sad error here.\npublic class Listener {\n\n    public isolated function 'start() returns error? { }\n\n    public isolated function gracefulStop() returns error? { }\n\n    public isolated function immediateStop() returns error? { }\n\n    public isolated function detach(service object { isolated function foo(); } s) returns error? { }\n\n    public isolated function attach(service object { isolated function foo(); } s, string[]|string? name = ()) returns error? { }\n\n    isolated function register(service object {} s, string[]|string? name) returns error? { }\n}\n\ntype ListenerType int|Listener;\n\nlistener ListenerType ln = new Listener();\n\nservice / on ln {\n\n}\n[2021-01-14 00:26:20,469] SEVERE {b7a.log.crash} - class org.wso2.ballerinalang.compiler.semantics.model.types.BType cannot be cast to class org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType (org.wso2.ballerinalang.compiler.semantics.model.types.BType and org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType are in unnamed module of loader 'app') \njava.lang.ClassCastException: class org.wso2.ballerinalang.compiler.semantics.model.types.BType cannot be cast to class org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType (org.wso2.ballerinalang.compiler.semantics.model.types.BType and org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType are in unnamed module of loader 'app')\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.visit(SemanticAnalyzer.java:3019)\n\tat org.wso2.ballerinalang.compiler.tree.BLangService.accept(BLangService.java:142)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeNode(SemanticAnalyzer.java:3250)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeNode(SemanticAnalyzer.java:3218)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeDef(SemanticAnalyzer.java:3210)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.visit(SemanticAnalyzer.java:291)\n\tat org.wso2.ballerinalang.compiler.tree.BLangPackage.accept(BLangPackage.java:163)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyze(SemanticAnalyzer.java:256)\n\tat io.ballerina.projects.internal.CompilerPhaseRunner.typeCheck(CompilerPhaseRunner.java:217)\n\tat io.ballerina.projects.internal.CompilerPhaseRunner.performTypeCheckPhases(CompilerPhaseRunner.java:115)\n\tat io.ballerina.projects.ModuleContext.compileInternal(ModuleContext.java:348)\n\tat io.ballerina.projects.ModuleCompilationState$1.compile(ModuleCompilationState.java:45)\n\tat io.ballerina.projects.ModuleCompilationState$1.generatePlatformSpecificCode(ModuleCompilationState.java:53)\n\tat io.ballerina.projects.ModuleContext.generatePlatformSpecificCode(ModuleContext.java:301)\n\tat io.ballerina.projects.JBallerinaBackend.performCodeGen(JBallerinaBackend.java:131)\n\tat io.ballerina.projects.JBallerinaBackend.<init>(JBallerinaBackend.java:117)\n\tat io.ballerina.projects.JBallerinaBackend.lambda$from$0(JBallerinaBackend.java:93)\n\tat java.base/java.util.HashMap.computeIfAbsent(HashMap.java:1133)\n\tat io.ballerina.projects.PackageCompilation.getCompilerBackend(PackageCompilation.java:126)\n\tat io.ballerina.projects.JBallerinaBackend.from(JBallerinaBackend.java:92)\n\tat io.ballerina.cli.task.CompileTask.execute(CompileTask.java:69)\n\tat io.ballerina.cli.TaskExecutor.executeTasks(TaskExecutor.java:40)\n\tat io.ballerina.cli.cmd.RunCommand.execute(RunCommand.java:154)\n\tat java.base/java.util.Optional.ifPresent(Optional.java:183)\n\tat io.ballerina.cli.launcher.Main.main(Main.java:58)", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556757844", "createdAt": "2021-01-13T18:58:02Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2891,9 +2911,17 @@ public void visit(BLangService serviceNode) {\n                 dlog.error(attachExpr.pos, DiagnosticErrorCode.INVALID_LISTENER_ATTACHMENT);\n             }\n \n+            // Validate listener attachment based on attach-point of the service decl and second param of listener.\n             if (exprType.getKind() == TypeKind.OBJECT) {\n                 BObjectType listenerType = (BObjectType) exprType;\n                 validateServicePathOnListener(serviceNode, attachExpr, listenerType);\n+            } else if (exprType.getKind() == TypeKind.UNION) {\n+                for (BType memberType : ((BUnionType) exprType).getMemberTypes()) {\n+                    if (memberType.tag == TypeTags.ERROR) {\n+                        continue;\n+                    }\n+                    validateServicePathOnListener(serviceNode, attachExpr, (BObjectType) memberType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2002cb0e185984d6d89c5d0f0f56eada9f23af3"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0MjMzMw==", "bodyText": "Fixed. Thank you.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557542333", "createdAt": "2021-01-14T16:51:20Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2891,9 +2911,17 @@ public void visit(BLangService serviceNode) {\n                 dlog.error(attachExpr.pos, DiagnosticErrorCode.INVALID_LISTENER_ATTACHMENT);\n             }\n \n+            // Validate listener attachment based on attach-point of the service decl and second param of listener.\n             if (exprType.getKind() == TypeKind.OBJECT) {\n                 BObjectType listenerType = (BObjectType) exprType;\n                 validateServicePathOnListener(serviceNode, attachExpr, listenerType);\n+            } else if (exprType.getKind() == TypeKind.UNION) {\n+                for (BType memberType : ((BUnionType) exprType).getMemberTypes()) {\n+                    if (memberType.tag == TypeTags.ERROR) {\n+                        continue;\n+                    }\n+                    validateServicePathOnListener(serviceNode, attachExpr, (BObjectType) memberType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1Nzg0NA=="}, "originalCommit": {"oid": "a2002cb0e185984d6d89c5d0f0f56eada9f23af3"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDMwNTU5OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzoxMzoyMFrOITumgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxMDoxNDo0N1rOIUVUCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ==", "bodyText": "Since the listener type should be a subtype of listener, check needs to be added only to the listener initialization (and when the expression type includes error), right?\nDo we need this change?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557557379", "createdAt": "2021-01-14T17:13:20Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1ODc3NA==", "bodyText": "Adding check here wouldn't add it for the initialization anyway, right?\nThe following results in a bad, sad error.\npublic class Listener {\n    public function init() returns error? => error(\"err\");\n\n    public isolated function 'start() returns error? { }\n\n    public isolated function gracefulStop() returns error? { }\n\n    public isolated function immediateStop() returns error? { }\n\n    public isolated function detach(service object {} s) returns error? { }\n\n    public isolated function attach(service object {} s, string[]|string? name = ()) returns error? { }\n}\n\nlistener Listener ln =  new;\n[2021-01-14 23:10:56,517] SEVERE {b7a.log.crash} - class io.ballerina.runtime.internal.values.ErrorValue cannot be cast to class io.ballerina.runtime.api.values.BObject (io.ballerina.runtime.internal.values.ErrorValue and io.ballerina.runtime.api.values.BObject are in unnamed module of loader 'app') \njava.lang.ClassCastException: class io.ballerina.runtime.internal.values.ErrorValue cannot be cast to class io.ballerina.runtime.api.values.BObject (io.ballerina.runtime.internal.values.ErrorValue and io.ballerina.runtime.api.values.BObject are in unnamed module of loader 'app')\n\tat $$$.$gen$$0046$0046$0060init$00620(.:15)\n\tat $_init.$gen$$0046$0060init$0062(.:0)\n\tat $_init.$moduleInit(.)\n\tat $_init.$lambda$$moduleInit$(.)\n\tat io.ballerina.runtime.internal.scheduling.SchedulerItem.execute(Scheduler.java:571)\n\tat io.ballerina.runtime.internal.scheduling.Scheduler.run(Scheduler.java:301)\n\tat io.ballerina.runtime.internal.scheduling.Scheduler.runSafely(Scheduler.java:269)\n\tat java.base/java.lang.Thread.run(Thread.java:834)", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557558774", "createdAt": "2021-01-14T17:15:32Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ=="}, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg0MDE3OA==", "bodyText": "Oh I totally forgot about the listener-decl \ud83d\ude1e", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557840178", "createdAt": "2021-01-15T03:28:25Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ=="}, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODE5MTYyNw==", "bodyText": "Fixed. And a test case is added https://github.com/ballerina-platform/ballerina-lang/pull/27605/files#diff-dedee6299f9c3f21babab9613444bee606906b9323bde0ac0cc0b0d215865d42R79", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r558191627", "createdAt": "2021-01-15T10:14:47Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ=="}, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2789, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}