{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNTY1Njkx", "number": 26692, "title": "Introduce a function for adding custom tags to system metrics", "bodyText": "Purpose\n\n`addTagToSpan()\u2019 is having an unexpected behavior which is adding tags to both metrics and tracing. Ideally, it should add a tag only to a tracing span. There can be a performance issue as well as high memory consumption since \u2018addTagToSpan()\u2019 method invocation is adding the tags to the metrics as well.\n\nCurrent API comprises one endpoint which can be used to add tags to tracing spans. We don't have an endpoint to add a tag to system metrics.\nFixes #25395\nApproach\n\n'addTagToSpan()' now adds custom tags only to tracing. A new method 'addTagToMetrics()' is introduced to add a custom tag to system metrics. The status code group added for both metrics and tracing is now limited for tracing.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-11-01T06:21:45Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692", "merged": true, "mergeCommit": {"oid": "1ad8a3b12e1720278b90f3be5a0b51761bca1b2f"}, "closed": true, "closedAt": "2020-12-10T03:58:12Z", "author": {"login": "LakshanKarunathilake"}, "timelineItems": {"totalCount": 53, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYK8QWgBqjM5NDQ4OTcxMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkrLW9AFqTU0ODgwMDgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23cad071bf9f0be3e4ebec994ae4c8343543de65", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/23cad071bf9f0be3e4ebec994ae4c8343543de65", "committedDate": "2020-11-01T07:15:47Z", "message": "format code"}, "afterCommit": {"oid": "9c6da1a019f876ff7535adbde944df991f7ec051", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9c6da1a019f876ff7535adbde944df991f7ec051", "committedDate": "2020-11-01T07:35:58Z", "message": "format code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c73e0ebc3c96d72d130e8dd0e345f215c9c93ab6", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c73e0ebc3c96d72d130e8dd0e345f215c9c93ab6", "committedDate": "2020-11-02T04:48:26Z", "message": "fix import order"}, "afterCommit": {"oid": "e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "committedDate": "2020-11-05T08:16:29Z", "message": "add test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e6bb4c8434bf51987bc81fdbf7267b88b9f87f65", "committedDate": "2020-11-05T08:16:29Z", "message": "add test cases"}, "afterCommit": {"oid": "51922344816aa982bf20f552fd13646e75b58a3a", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/51922344816aa982bf20f552fd13646e75b58a3a", "committedDate": "2020-11-05T08:39:43Z", "message": "add test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51922344816aa982bf20f552fd13646e75b58a3a", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/51922344816aa982bf20f552fd13646e75b58a3a", "committedDate": "2020-11-05T08:39:43Z", "message": "add test cases"}, "afterCommit": {"oid": "e55a0f2399ab0544a06d91024007b71eea60c620", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e55a0f2399ab0544a06d91024007b71eea60c620", "committedDate": "2020-11-05T09:26:18Z", "message": "add test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e55a0f2399ab0544a06d91024007b71eea60c620", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e55a0f2399ab0544a06d91024007b71eea60c620", "committedDate": "2020-11-05T09:26:18Z", "message": "add test cases"}, "afterCommit": {"oid": "9a02c34e53d9d7353111e6acb93efd5f83ba326c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9a02c34e53d9d7353111e6acb93efd5f83ba326c", "committedDate": "2020-11-05T11:50:07Z", "message": "add test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a02c34e53d9d7353111e6acb93efd5f83ba326c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9a02c34e53d9d7353111e6acb93efd5f83ba326c", "committedDate": "2020-11-05T11:50:07Z", "message": "add test cases"}, "afterCommit": {"oid": "153e439a3655ca6d4b38b5d047762a9199fc7a40", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/153e439a3655ca6d4b38b5d047762a9199fc7a40", "committedDate": "2020-11-06T05:43:56Z", "message": "Add test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64b37a3a4a0151471256b0d49608b11d9aae4275", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64b37a3a4a0151471256b0d49608b11d9aae4275", "committedDate": "2020-11-10T04:10:27Z", "message": "Fix lint issues"}, "afterCommit": {"oid": "cd3c8570a908a1f521aa2b266ede6e8ba5cbecc7", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cd3c8570a908a1f521aa2b266ede6e8ba5cbecc7", "committedDate": "2020-11-10T07:00:04Z", "message": "Fix lint issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07d22dfcad7ba175f5e8abe6a0c4eff169efeec9", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/07d22dfcad7ba175f5e8abe6a0c4eff169efeec9", "committedDate": "2020-11-10T07:55:20Z", "message": "Fix lint issue"}, "afterCommit": {"oid": "a39dda40f83ff72a39cc7696735b12c3488af4b3", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a39dda40f83ff72a39cc7696735b12c3488af4b3", "committedDate": "2020-11-10T08:22:21Z", "message": "Fix lint issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a39dda40f83ff72a39cc7696735b12c3488af4b3", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a39dda40f83ff72a39cc7696735b12c3488af4b3", "committedDate": "2020-11-10T08:22:21Z", "message": "Fix lint issue"}, "afterCommit": {"oid": "944329c585dc420a6e902e1bdfd9002fbec66f8c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/944329c585dc420a6e902e1bdfd9002fbec66f8c", "committedDate": "2020-11-10T09:15:00Z", "message": "Fix lint issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzEzMDA2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-528713006", "createdAt": "2020-11-12T03:09:17Z", "commit": {"oid": "bbe233128859456e48d18b0bb66d24fbdc5d36e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMzowOToxOFrOHxng4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMzowOToxOFrOHxng4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4OTY2NQ==", "bodyText": "U can directly add the property here without maintaining a separate isCustomTagsAvailable variable", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r521789665", "createdAt": "2020-11-12T03:09:18Z", "author": {"login": "nadundesilva"}, "path": "observelib/observe/src/main/java/org/ballerinalang/observe/nativeimpl/AddTagToMetrics.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.ballerinalang.observe.nativeimpl;\n+\n+import io.ballerina.runtime.api.Environment;\n+import io.ballerina.runtime.api.creators.ErrorCreator;\n+import io.ballerina.runtime.api.utils.StringUtils;\n+import io.ballerina.runtime.api.values.BString;\n+import io.ballerina.runtime.observability.ObserveUtils;\n+import io.ballerina.runtime.observability.ObserverContext;\n+import io.ballerina.runtime.observability.metrics.BallerinaMetricsObserver;\n+import io.ballerina.runtime.observability.metrics.Tag;\n+\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * This function add tags to System Metrics.\n+ * Custom tag is not included in the 'in progress-requests'\n+ */\n+public class AddTagToMetrics {\n+\n+    public static Object addTagToMetrics(Environment env, BString tagKey, BString tagValue) {\n+\n+        ObserverContext observerContext = ObserveUtils.getObserverContextOfCurrentFrame(env);\n+        boolean isCustomTagsAvailable = true;\n+        if (observerContext != null) {\n+            Map<String, Tag> customTags =\n+                    (Map<String, Tag>) observerContext.getProperty(BallerinaMetricsObserver.PROPERTY_CUSTOM_TAGS);\n+            if (customTags == null) {\n+                customTags = new HashMap<>();\n+                isCustomTagsAvailable = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe233128859456e48d18b0bb66d24fbdc5d36e4"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f130b44290ea3dcab7bd4b145075e2c64c8ba03", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7f130b44290ea3dcab7bd4b145075e2c64c8ba03", "committedDate": "2020-11-20T03:51:47Z", "message": "add test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9968be3ec391c3c3cc170b6bd9ace41475933ae2", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9968be3ec391c3c3cc170b6bd9ace41475933ae2", "committedDate": "2020-11-20T04:11:05Z", "message": "Add native implementation for AddTagToMetrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cd8fe3f0263f88e851d9e5af047ae5d98a46d91", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1cd8fe3f0263f88e851d9e5af047ae5d98a46d91", "committedDate": "2020-11-20T04:11:05Z", "message": "Create AddTagToMetrics java class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14d4081fb7e9c8835ccb767071cdb777664f5676", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/14d4081fb7e9c8835ccb767071cdb777664f5676", "committedDate": "2020-11-20T04:11:05Z", "message": "Add methods to store a single tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b40a2aa20845d1f148f12e92872aba2896e2bfe", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6b40a2aa20845d1f148f12e92872aba2896e2bfe", "committedDate": "2020-11-20T04:11:06Z", "message": "Use bspan property to store custom tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8291e137fb061d4506d30591340e1233f19a170c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8291e137fb061d4506d30591340e1233f19a170c", "committedDate": "2020-11-20T04:11:06Z", "message": "Move status code group to metrics observer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4db646b05770aea8a58b79340cffd1bee3f2474", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d4db646b05770aea8a58b79340cffd1bee3f2474", "committedDate": "2020-11-20T04:11:06Z", "message": "Format code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "038ae35d68470fdae0c3de269f7d6dfa1dd52ae0", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/038ae35d68470fdae0c3de269f7d6dfa1dd52ae0", "committedDate": "2020-11-20T04:11:06Z", "message": "Fix import order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59a9f27437c61613e9ea32647812915775f8c5e5", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/59a9f27437c61613e9ea32647812915775f8c5e5", "committedDate": "2020-11-20T04:12:05Z", "message": "Add test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef4c587707ed3f98a5fa427882a79eb68e788eb", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cef4c587707ed3f98a5fa427882a79eb68e788eb", "committedDate": "2020-11-20T04:12:05Z", "message": "Add map only if customTags exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de53b305ca48c1d8a30f0d2429a807d34da47651", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/de53b305ca48c1d8a30f0d2429a807d34da47651", "committedDate": "2020-11-20T04:12:05Z", "message": "Improve addTag functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16fcb68dcd7c12b09becff39ae893df9f6a8e9db", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/16fcb68dcd7c12b09becff39ae893df9f6a8e9db", "committedDate": "2020-11-20T04:12:05Z", "message": "Refactor code styles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a1f95b3d8c09b01a8bd97e6f19faea232c9f0e", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9a1f95b3d8c09b01a8bd97e6f19faea232c9f0e", "committedDate": "2020-11-20T04:12:06Z", "message": "Update test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a4056a4e9c1fb5fcd295c5a82cbb246d1416b9a", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5a4056a4e9c1fb5fcd295c5a82cbb246d1416b9a", "committedDate": "2020-11-20T04:12:06Z", "message": "Fix lint issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64fd21bf43d7f3d43816bf5ac000bb8600163f64", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64fd21bf43d7f3d43816bf5ac000bb8600163f64", "committedDate": "2020-11-20T04:12:06Z", "message": "Update strand with env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f67c786f9c0da3d25b638244b9e7fa9e3d043d44", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f67c786f9c0da3d25b638244b9e7fa9e3d043d44", "committedDate": "2020-11-20T04:12:06Z", "message": "Fix lint issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216e3a172a0713bba98849fb65130f9a2b693284", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/216e3a172a0713bba98849fb65130f9a2b693284", "committedDate": "2020-11-20T04:12:07Z", "message": "Update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b961187d5f17259ba198f17e5e56ff2cf5df1502", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b961187d5f17259ba198f17e5e56ff2cf5df1502", "committedDate": "2020-11-20T04:12:07Z", "message": "Remove boolean flag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90c0902ab97005fa6f12d1ac5b74baac960a56d5", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/90c0902ab97005fa6f12d1ac5b74baac960a56d5", "committedDate": "2020-11-12T05:08:44Z", "message": "Remove boolean flag"}, "afterCommit": {"oid": "b961187d5f17259ba198f17e5e56ff2cf5df1502", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b961187d5f17259ba198f17e5e56ff2cf5df1502", "committedDate": "2020-11-20T04:12:07Z", "message": "Remove boolean flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d9ceec95479dfd2bbf79ef4c39221209927debbf", "committedDate": "2020-11-20T04:54:34Z", "message": "Move addTagToMetrics test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDg1Nzcy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-535085772", "createdAt": "2020-11-20T04:59:59Z", "commit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNTowMDowMFrOH291yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNToyMjoxMVrOH2-NZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5ODM0Ng==", "bodyText": "Let's remove this additional line here", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527398346", "createdAt": "2020-11-20T05:00:00Z", "author": {"login": "nadundesilva"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/observability/metrics/BallerinaMetricsObserver.java", "diffHunk": "@@ -22,15 +22,23 @@\n \n import java.io.PrintStream;\n import java.time.Duration;\n+import java.util.HashSet;\n+import java.util.Map;\n import java.util.Set;\n \n+import static io.ballerina.runtime.observability.ObservabilityConstants.PROPERTY_KEY_HTTP_STATUS_CODE;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.STATUS_CODE_GROUP_SUFFIX;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.TAG_KEY_HTTP_STATUS_CODE_GROUP;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwMjQ5MA==", "bodyText": "We should rename the param and rephrase the description. endObservationTags is actually the additional tags added after start here.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527402490", "createdAt": "2020-11-20T05:15:29Z", "author": {"login": "nadundesilva"}, "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/MetricsTestCase.java", "diffHunk": "@@ -125,21 +125,41 @@ private Metrics filterByTag(Metrics metrics, String key, String value) {\n     /**\n      * Test the metrics generated for a particular function invocation.\n      *\n-     * @param allMetrics All the metrics collected from Metrics Registry\n+     * @param allMetrics         All the metrics collected from Metrics Registry\n      * @param invocationPosition The invocation position of the function invocation\n-     * @param invocationCount The number of times the function should have been called\n-     * @param additionalTags Additional tags that should be present in the metrics\n+     * @param invocationCount    The number of times the function should have been called\n+     * @param additionalTags     Additional tags that should be present in the metrics\n+     */\n+    private void testFunctionMetrics(Metrics allMetrics, String invocationPosition, long invocationCount,\n+                                     Tag... additionalTags) {\n+\n+        testFunctionMetrics(allMetrics, invocationPosition, invocationCount, additionalTags, null);\n+    }\n+\n+    /**\n+     * Test the metrics generated for a particular function invocation for a given start and end tag set.\n+     *\n+     * @param allMetrics           All the metrics collected from Metrics Registry\n+     * @param invocationPosition   The invocation position of the function invocation\n+     * @param invocationCount      The number of times the function should have been called\n+     * @param startObservationTags tags at the observation start which should be present in the metrics\n+     * @param endObservationTags   tags at the observation end which should be present in the metrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwMjY3Nw==", "bodyText": "Minor alignment issue here in the javadoc.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527402677", "createdAt": "2020-11-20T05:16:23Z", "author": {"login": "nadundesilva"}, "path": "tests/jballerina-integration-test/src/test/java/org/ballerinalang/test/observability/metrics/MetricsTestCase.java", "diffHunk": "@@ -175,25 +195,28 @@ private void testFunctionCounters(long invocationCount, Metrics functionMetrics,\n     }\n \n     /**\n-     * Test the gauge metrics generated for a particular function invocation.\n+     * Test the gauge metrics generated for a particular function invocation for given start and end tag set.\n      *\n      * @param invocationCount The number of times the function should have been called\n      * @param functionMetrics All the metrics generated for the function invocation\n-     * @param tags Tags that should be present in metrics\n+     * @param startTags            Tags that should be present in metrics at observation start\n+     * @param endTags            Tags that should be present in metrics at observation end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwMzgxMA==", "bodyText": "Shall we rename this file to 03_custom_metric_tags.bal ? (The convention for file names here is \"snake_case\")", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527403810", "createdAt": "2020-11-20T05:20:51Z", "author": {"login": "nadundesilva"}, "path": "tests/jballerina-integration-test/src/test/resources/observability/metrics_tests/03_addTagToMetrics_function.bal", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQwNDM4OQ==", "bodyText": "Minor alignment and spacing issues here", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r527404389", "createdAt": "2020-11-20T05:22:11Z", "author": {"login": "nadundesilva"}, "path": "tests/jballerina-integration-test/src/test/resources/observability/metrics_tests/03_addTagToMetrics_function.bal", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/testobserve;\n+import ballerina/observe;\n+\n+service testServiceTwo on new testobserve:Listener(10092) {\n+    # Resource function for test custom tags\n+    resource function testAddTagToMetrics(testobserve:Caller caller) {\n+         // Add a custom tag to span, this should not be included in system metrics\n+         var res =  observe:addTagToSpan(\"tracing\", \"Tracing Value\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9ceec95479dfd2bbf79ef4c39221209927debbf"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358d0d9277c299b75ab26dc7bb862c8fad36bf49", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/358d0d9277c299b75ab26dc7bb862c8fad36bf49", "committedDate": "2020-11-20T07:14:48Z", "message": "Fix styling issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a99c4fea351f227d49e340ed958be4407e3b4575", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a99c4fea351f227d49e340ed958be4407e3b4575", "committedDate": "2020-11-20T07:21:52Z", "message": "Remove additional spacing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MjQ1NzE4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-535245718", "createdAt": "2020-11-20T09:08:48Z", "commit": {"oid": "a99c4fea351f227d49e340ed958be4407e3b4575"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e817a4d1ac03d3157c560cd1a766dfc91c49fee", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e817a4d1ac03d3157c560cd1a766dfc91c49fee", "committedDate": "2020-11-20T09:28:37Z", "message": "Remove additional spacing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTc0OTg2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-536174986", "createdAt": "2020-11-23T04:43:44Z", "commit": {"oid": "1e817a4d1ac03d3157c560cd1a766dfc91c49fee"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce2de4eb17528c955ccebd54ddad9a4cd02e95c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4ce2de4eb17528c955ccebd54ddad9a4cd02e95c", "committedDate": "2020-12-04T04:47:10Z", "message": "Create custom metrics tags map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "837248703671dbbc91415cad924f51a81fb97884", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/837248703671dbbc91415cad924f51a81fb97884", "committedDate": "2020-12-04T04:50:58Z", "message": "Initialize custom metric tags map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a05dc5396dd8999f322b1d28a39868b9da71550", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3a05dc5396dd8999f322b1d28a39868b9da71550", "committedDate": "2020-12-04T04:51:16Z", "message": "Capture not found span error and log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e78a56f93ef308ca08f2cf1b29174da8844bf6", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73e78a56f93ef308ca08f2cf1b29174da8844bf6", "committedDate": "2020-12-04T04:53:58Z", "message": "Merge branch 'master-upstream'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "917ca30949fbb5b4d8c933c89811644c24aa732f", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/917ca30949fbb5b4d8c933c89811644c24aa732f", "committedDate": "2020-12-04T04:54:23Z", "message": "Merge branch 'master' into feature-add-tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a1a337fb47b63c3972b3518da67d844eabb3ab5", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3a1a337fb47b63c3972b3518da67d844eabb3ab5", "committedDate": "2020-12-06T17:06:54Z", "message": "Fix custom metrics update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d55d638a2ccad127b1c5da0e781864b97965459", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d55d638a2ccad127b1c5da0e781864b97965459", "committedDate": "2020-12-06T17:17:01Z", "message": "Fix check style issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODEyMjQ2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-545812246", "createdAt": "2020-12-07T03:44:00Z", "commit": {"oid": "9d55d638a2ccad127b1c5da0e781864b97965459"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMzo0NDowMFrOIAUvkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMzo0NzowM1rOIAUy7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMDc3MA==", "bodyText": "Can't we remove this now ?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r537210770", "createdAt": "2020-12-07T03:44:00Z", "author": {"login": "nadundesilva"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/observability/metrics/BallerinaMetricsObserver.java", "diffHunk": "@@ -22,15 +22,22 @@\n \n import java.io.PrintStream;\n import java.time.Duration;\n+import java.util.HashSet;\n+import java.util.Map;\n import java.util.Set;\n \n+import static io.ballerina.runtime.observability.ObservabilityConstants.PROPERTY_KEY_HTTP_STATUS_CODE;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.STATUS_CODE_GROUP_SUFFIX;\n+import static io.ballerina.runtime.observability.ObservabilityConstants.TAG_KEY_HTTP_STATUS_CODE_GROUP;\n+\n /**\n  * Observe the runtime and collect measurements.\n  */\n public class BallerinaMetricsObserver implements BallerinaObserver {\n \n     private static final String PROPERTY_START_TIME = \"_observation_start_time_\";\n     private static final String PROPERTY_IN_PROGRESS_COUNTER = \"_observation_in_progress_counter_\";\n+    public static final String PROPERTY_CUSTOM_TAGS = \"_custom_metric_tags_\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d55d638a2ccad127b1c5da0e781864b97965459"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMTYzMQ==", "bodyText": "Do we need this ?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r537211631", "createdAt": "2020-12-07T03:47:03Z", "author": {"login": "nadundesilva"}, "path": "observelib/observe/src/main/java/module-info.java", "diffHunk": "@@ -3,4 +3,5 @@\n     requires io.ballerina.runtime;\n     requires opentracing.api;\n     requires io.ballerina.config;\n+    requires slf4j.api;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d55d638a2ccad127b1c5da0e781864b97965459"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df3db9d5dfc75d8988bdeb8df3bdb814cdcdd37f", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/df3db9d5dfc75d8988bdeb8df3bdb814cdcdd37f", "committedDate": "2020-12-07T04:01:32Z", "message": "Add tags only if observability enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58", "committedDate": "2020-12-07T04:01:46Z", "message": "Remove unused property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODI0OTU3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-545824957", "createdAt": "2020-12-07T04:35:31Z", "commit": {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDQ1NDk4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-547045498", "createdAt": "2020-12-08T10:28:01Z", "commit": {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyODowMVrOIBSPOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyODowMVrOIBSPOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxODI5Nw==", "bodyText": "please extract this to a variable", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#discussion_r538218297", "createdAt": "2020-12-08T10:28:01Z", "author": {"login": "manuranga"}, "path": "observelib/observe/src/main/java/org/ballerinalang/observe/nativeimpl/OpenTracerBallerinaWrapper.java", "diffHunk": "@@ -149,29 +155,41 @@ public boolean finishSpan(Environment env, long spanId) {\n     /**\n      * Method to add tags to an existing span.\n      *\n-     * @param env current environment\n-     * @param tagKey the key of the tag\n+     * @param env      current environment\n+     * @param tagKey   the key of the tag\n      * @param tagValue the value of the tag\n-     * @param spanId id of the Span\n-     * @return boolean to indicate if tag was added to the span\n+     * @param spanId   id of the Span\n+     * @return Object to indicate if tag was added to the span\n      */\n-    public boolean addTag(Environment env, String tagKey, String tagValue, long spanId) {\n+    public Object addTag(Environment env, String tagKey, String tagValue, long spanId) {\n+\n         if (!enabled) {\n-            return false;\n+            return null;\n         }\n+\n+        final BSpan span;\n         if (spanId == -1) {\n             ObserverContext observer = ObserveUtils.getObserverContextOfCurrentFrame(env);\n-            if (observer != null) {\n-                observer.addTag(tagKey, tagValue);\n-                return true;\n+            if (observer == null) {\n+                return ErrorCreator.createError(\n+                        StringUtils.fromString(\n+                                (\"Span already finished. Can not add tag {\" + tagKey + \":\" + tagValue + \"}\")));\n             }\n-        }\n-        ObserverContext observerContext = observerContextMap.get(spanId);\n-        if (observerContext != null) {\n-            observerContext.addTag(tagKey, tagValue);\n-            return true;\n+            span = (BSpan) observer.getProperty(TraceConstants.KEY_SPAN);\n         } else {\n-            return false;\n+            ObserverContext observerContext = observerContextMap.get(spanId);\n+            if (observerContext == null) {\n+                log.info(\"Could not find the trace for given span id. Can not add tag {\" + tagKey + \":\" + tagValue +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDQ5ODM3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-547049837", "createdAt": "2020-12-08T10:30:53Z", "commit": {"oid": "d5efa7a8c2c912e8d5335800b98cc5bf75ae1d58"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2742ee2c382da891b1a38c35fe3259c59ee95fec", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2742ee2c382da891b1a38c35fe3259c59ee95fec", "committedDate": "2020-12-08T17:22:59Z", "message": "Remove duplicated strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e5ab0478255188f891a42b94ab221c4bcf55017", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e5ab0478255188f891a42b94ab221c4bcf55017", "committedDate": "2020-12-09T05:23:53Z", "message": "Change error msg scope"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f7eb95fe100f4a4455005d7689103869071802c", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7f7eb95fe100f4a4455005d7689103869071802c", "committedDate": "2020-12-09T04:29:31Z", "message": "Change error msg scope"}, "afterCommit": {"oid": "1e5ab0478255188f891a42b94ab221c4bcf55017", "author": {"user": {"login": "LakshanKarunathilake", "name": "Lakshan Karunathilake"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e5ab0478255188f891a42b94ab221c4bcf55017", "committedDate": "2020-12-09T05:23:53Z", "message": "Change error msg scope"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODAwODMw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26692#pullrequestreview-548800830", "createdAt": "2020-12-10T03:56:50Z", "commit": {"oid": "1e5ab0478255188f891a42b94ab221c4bcf55017"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4326, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}