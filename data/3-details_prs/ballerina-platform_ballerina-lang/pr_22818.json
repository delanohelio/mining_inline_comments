{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzE2NzE0", "number": 22818, "title": "Support module-var-decl inside module init", "bodyText": "Purpose\n$subject\nFixes #22503\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-04-21T14:36:22Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818", "merged": true, "mergeCommit": {"oid": "661e24320e5d85a6c25979e83555ef227500ee25"}, "closed": true, "closedAt": "2020-05-13T21:22:47Z", "author": {"login": "KavinduZoysa"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcagiuKABqjMyNjYxMTU5NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg90VjAFqTQxMTE0MDg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91d0f8b5f8573d1594a7208321259c526dbf67bd", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/91d0f8b5f8573d1594a7208321259c526dbf67bd", "committedDate": "2020-04-23T12:11:15Z", "message": "Fix failure unit tests"}, "afterCommit": {"oid": "114baf5353b335ffe3b73a96aea73ca8b3ae7078", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/114baf5353b335ffe3b73a96aea73ca8b3ae7078", "committedDate": "2020-04-23T17:41:30Z", "message": "Fix failure unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02f33b5d9298231945bc4cc21e8ef34258053eda", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/02f33b5d9298231945bc4cc21e8ef34258053eda", "committedDate": "2020-04-24T06:55:48Z", "message": "Add negative tests"}, "afterCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c124d2aca1839631a99ff5ad2c04d9de38622442", "committedDate": "2020-04-24T07:12:46Z", "message": "Add negative tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTYwNjM1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#pullrequestreview-400560635", "createdAt": "2020-04-26T23:17:54Z", "commit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQyMzoxNzo1NFrOGMLgkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwMTowMTozMlrOGMMyHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQyNDY1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (node.getKind() == NodeKind.FUNCTION &&\n          \n          \n            \n                            Names.USER_DEFINED_INIT_SUFFIX.value.equals(((BLangFunction) node).name.value)) {\n          \n          \n            \n                        return true;\n          \n          \n            \n                    }\n          \n          \n            \n                    return false;\n          \n          \n            \n                    return node.getKind() == NodeKind.FUNCTION &&\n          \n          \n            \n                            Names.USER_DEFINED_INIT_SUFFIX.value.equals(((BLangFunction) node).name.value);", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415424656", "createdAt": "2020-04-26T23:17:54Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        sortedListOfNodes.forEach(topLevelNode -> {\n+            if (isModuleInitFunction((BLangNode) topLevelNode)) {\n+                analyzeModuleInitFunc((BLangFunction) topLevelNode);\n+                checkForUninitializedGlobalVar(pkgNode.globalVars);\n+            } else {\n+                analyzeNode((BLangNode) topLevelNode, env);\n+            }\n+        });\n         pkgNode.getTestablePkgs().forEach(testablePackage -> visit((BLangPackage) testablePackage));\n         this.globalVariableRefAnalyzer.analyzeAndReOrder(pkgNode, this.globalNodeDependsOn);\n         this.globalVariableRefAnalyzer.populateFunctionDependencies(this.functionToDependency);\n         checkUnusedImports(pkgNode.imports);\n         pkgNode.completedPhases.add(CompilerPhase.DATAFLOW_ANALYZE);\n     }\n \n+    private boolean isModuleInitFunction(BLangNode node) {\n+        if (node.getKind() == NodeKind.FUNCTION &&\n+                Names.USER_DEFINED_INIT_SUFFIX.value.equals(((BLangFunction) node).name.value)) {\n+            return true;\n+        }\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQyNzEzNw==", "bodyText": "Shall we replace this with a simple for-each loop?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415427137", "createdAt": "2020-04-26T23:31:09Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        sortedListOfNodes.forEach(topLevelNode -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQyNzIxNQ==", "bodyText": "Shouldn't this be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void checkForUninitializedGlobalVar(List<BLangSimpleVariable> globalVars) {\n          \n          \n            \n                private void checkForUninitializedGlobalVars(List<BLangSimpleVariable> globalVars) {", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415427215", "createdAt": "2020-04-26T23:31:29Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        sortedListOfNodes.forEach(topLevelNode -> {\n+            if (isModuleInitFunction((BLangNode) topLevelNode)) {\n+                analyzeModuleInitFunc((BLangFunction) topLevelNode);\n+                checkForUninitializedGlobalVar(pkgNode.globalVars);\n+            } else {\n+                analyzeNode((BLangNode) topLevelNode, env);\n+            }\n+        });\n         pkgNode.getTestablePkgs().forEach(testablePackage -> visit((BLangPackage) testablePackage));\n         this.globalVariableRefAnalyzer.analyzeAndReOrder(pkgNode, this.globalNodeDependsOn);\n         this.globalVariableRefAnalyzer.populateFunctionDependencies(this.functionToDependency);\n         checkUnusedImports(pkgNode.imports);\n         pkgNode.completedPhases.add(CompilerPhase.DATAFLOW_ANALYZE);\n     }\n \n+    private boolean isModuleInitFunction(BLangNode node) {\n+        if (node.getKind() == NodeKind.FUNCTION &&\n+                Names.USER_DEFINED_INIT_SUFFIX.value.equals(((BLangFunction) node).name.value)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    private void analyzeModuleInitFunc(BLangFunction funcNode) {\n+        this.currDependentSymbol.push(funcNode.symbol);\n+        SymbolEnv funcEnv = SymbolEnv.createFunctionEnv(funcNode, funcNode.symbol.scope, env);\n+        analyzeNode(funcNode.body, funcEnv);\n+        this.currDependentSymbol.pop();\n+    }\n+\n+    private void checkForUninitializedGlobalVar(List<BLangSimpleVariable> globalVars) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQyOTgxNA==", "bodyText": "Shall we rename the existing UNINITIALIZED_VARIABLE (https://github.com/ballerina-platform/ballerina-lang/blob/master/compiler/ballerina-lang/src/main/java/org/ballerinalang/util/diagnostic/DiagnosticCode.java#L269) error to something like USAGE_OF_UNINITIALIZED_VARIABLE and call this UNINITIALIZED_VARIABLE instead?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415429814", "createdAt": "2020-04-26T23:45:12Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/ballerinalang/util/diagnostic/DiagnosticCode.java", "diffHunk": "@@ -267,6 +267,7 @@\n     INVALID_PATTERN_CLAUSES_IN_MATCH_STMT(\"invalid.pattern.clauses.in.match.stmt\"),\n     STATIC_MATCH_ONLY_SUPPORTS_ANYDATA(\"static.value.match.only.supports.anydata\"),\n     UNINITIALIZED_VARIABLE(\"uninitialized.variable\"),\n+    UNINITIALIZED_MODULE_VARIABLE(\"uninitialized.module.variable\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQzMTE3NQ==", "bodyText": "Shouldn't this be done irrespective of whether a user-specified module init exists?\nThe following two scenarios would produce two different sets of errors atm?\nCase I\nint i;\n\nfunction __init() {\n\n}\n\npublic function main() {\n   int j = i;\n}\nCase II\nint i;\n\npublic function main() {\n   int j = i;\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415431175", "createdAt": "2020-04-26T23:52:10Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        sortedListOfNodes.forEach(topLevelNode -> {\n+            if (isModuleInitFunction((BLangNode) topLevelNode)) {\n+                analyzeModuleInitFunc((BLangFunction) topLevelNode);\n+                checkForUninitializedGlobalVar(pkgNode.globalVars);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0MTg3Nw==", "bodyText": "Incorrect version.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415441877", "createdAt": "2020-04-27T00:45:16Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/vardeclr/ModuleVarDeclareNegative.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.ballerinalang.test.statements.vardeclr;\n+\n+import org.ballerinalang.test.util.BAssertUtil;\n+import org.ballerinalang.test.util.BCompileUtil;\n+import org.ballerinalang.test.util.CompileResult;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+/**\n+ * Class to test module variable declaration negative.\n+ *\n+ * @since 1.2.2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0MTk3Mg==", "bodyText": "Missing a new line.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415441972", "createdAt": "2020-04-27T00:45:38Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/statements/vardeclr/module-var-declare.bal", "diffHunk": "@@ -0,0 +1,34 @@\n+int i;\n+string s;\n+int a;\n+int b;\n+error er;\n+\n+const ERROR_REASON = \"Error Reason\";\n+const ASSERTION_ERROR_REASON = \"AssertionError\";\n+\n+function __init() {\n+    i = 10;\n+    s = \"Test string\";\n+    int x = 2;\n+    a = x + 10;\n+    b = 31 + foo();\n+    er = error(ERROR_REASON, message = \"error message\");\n+}\n+\n+function foo() returns int {\n+    return 1;\n+}\n+\n+function testModuleVarDeclaration() {\n+    if (i == 10 && s == \"Test string\" && a == 12 && b == 32) {\n+        return;\n+    }\n+\n+    string? msg = er.detail()?.message;\n+    if (msg is string && <string> msg == \"error message\") {\n+        return;\n+    }\n+\n+    panic error(ASSERTION_ERROR_REASON, message = \"expected 'true', found 'false'\");\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0MjI2Nw==", "bodyText": "Missing the licence header.\nWe also usually use _ for bal file names.\nPlease fix in the other bal file too.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415442267", "createdAt": "2020-04-27T00:46:51Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/statements/vardeclr/module-var-declare.bal", "diffHunk": "@@ -0,0 +1,34 @@\n+int i;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0MjMzOQ==", "bodyText": "Do we need a new class anyway? Can't we have these in GlobalVarNegativeTest?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415442339", "createdAt": "2020-04-27T00:47:18Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/statements/vardeclr/ModuleVarDeclareNegative.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.ballerinalang.test.statements.vardeclr;\n+\n+import org.ballerinalang.test.util.BAssertUtil;\n+import org.ballerinalang.test.util.BCompileUtil;\n+import org.ballerinalang.test.util.CompileResult;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+/**\n+ * Class to test module variable declaration negative.\n+ *\n+ * @since 1.2.2\n+ */\n+public class ModuleVarDeclareNegative {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ0NTUzMw==", "bodyText": "Why do we do a separate analysis for the module init?\nAnyway, we're missing annotation validations from visit(BLangFunction funcNode).\nFor example,\nannotation map<int> Foo on function;\n\nint i; // uninitialized variable 'i'\n\n@Foo {\n    i // NO error, expected `variable 'i' is not initialized`\n}\nfunction __init() {\n}\n\n@Foo {\n    i // variable 'i' is not initialized\n}\npublic function main() {\n   int j = i; // variable 'i' is not initialized\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r415445533", "createdAt": "2020-04-27T01:01:32Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        sortedListOfNodes.forEach(topLevelNode -> {\n+            if (isModuleInitFunction((BLangNode) topLevelNode)) {\n+                analyzeModuleInitFunc((BLangFunction) topLevelNode);\n+                checkForUninitializedGlobalVar(pkgNode.globalVars);\n+            } else {\n+                analyzeNode((BLangNode) topLevelNode, env);\n+            }\n+        });\n         pkgNode.getTestablePkgs().forEach(testablePackage -> visit((BLangPackage) testablePackage));\n         this.globalVariableRefAnalyzer.analyzeAndReOrder(pkgNode, this.globalNodeDependsOn);\n         this.globalVariableRefAnalyzer.populateFunctionDependencies(this.functionToDependency);\n         checkUnusedImports(pkgNode.imports);\n         pkgNode.completedPhases.add(CompilerPhase.DATAFLOW_ANALYZE);\n     }\n \n+    private boolean isModuleInitFunction(BLangNode node) {\n+        if (node.getKind() == NodeKind.FUNCTION &&\n+                Names.USER_DEFINED_INIT_SUFFIX.value.equals(((BLangFunction) node).name.value)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    private void analyzeModuleInitFunc(BLangFunction funcNode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c124d2aca1839631a99ff5ad2c04d9de38622442"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d083b0258a383d3f7f662b4999ebe186237160bc", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d083b0258a383d3f7f662b4999ebe186237160bc", "committedDate": "2020-04-27T05:22:37Z", "message": "Fix the suggestions"}, "afterCommit": {"oid": "54dee5e12c75c7c9fb9e1d5340500d34709106a1", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/54dee5e12c75c7c9fb9e1d5340500d34709106a1", "committedDate": "2020-04-27T05:45:07Z", "message": "Fix the suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDkyNjA5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#pullrequestreview-401492609", "createdAt": "2020-04-28T04:41:20Z", "commit": {"oid": "54dee5e12c75c7c9fb9e1d5340500d34709106a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNDo0MToyMFrOGNCP8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNDo0MToyMFrOGNCP8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMyMTUyMA==", "bodyText": "we need to analyze the init function before any other function.\nConsider blow\nimport ballerina/io;\n\npublic function main() {\n    io:println(\"hello\");\n    io:println(s);\n}\n\nfunction __init() {\n    s = \"hello\";\n}\nstring s;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r416321520", "createdAt": "2020-04-28T04:41:20Z", "author": {"login": "rdhananjaya"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -265,14 +265,45 @@ public void visit(BLangPackage pkgNode) {\n                 sortedListOfNodes.add(topLevelNode);\n             }\n         });\n-        sortedListOfNodes.forEach(topLevelNode -> analyzeNode((BLangNode) topLevelNode, env));\n+\n+        for (TopLevelNode topLevelNode : sortedListOfNodes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54dee5e12c75c7c9fb9e1d5340500d34709106a1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "571e2a8fee1eb20f2395cdc51953d1a2b0e18856", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/571e2a8fee1eb20f2395cdc51953d1a2b0e18856", "committedDate": "2020-05-10T13:04:37Z", "message": "Support module var decl inside module init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aa790d77eb0f6bf114a58d357d0de0ee25ed80b", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7aa790d77eb0f6bf114a58d357d0de0ee25ed80b", "committedDate": "2020-05-10T13:04:37Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71c2fcbd7817c51763923c24384f615603f4ff13", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/71c2fcbd7817c51763923c24384f615603f4ff13", "committedDate": "2020-05-10T13:04:37Z", "message": "Fix failure unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7801346c874c5144396a1340f807b8da2cf4c0f1", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7801346c874c5144396a1340f807b8da2cf4c0f1", "committedDate": "2020-05-10T13:04:37Z", "message": "Add negative tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c26b2aa80cebca38fee819857c761302dda278", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d1c26b2aa80cebca38fee819857c761302dda278", "committedDate": "2020-05-10T13:06:46Z", "message": "Fix the suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e01c0bd5cd72799d5bec2ef8f1a261cfb323cc67", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e01c0bd5cd72799d5bec2ef8f1a261cfb323cc67", "committedDate": "2020-05-10T13:06:46Z", "message": "Add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a164a98981a04e53c09aca5a4b62d71f738582", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e4a164a98981a04e53c09aca5a4b62d71f738582", "committedDate": "2020-05-10T13:08:06Z", "message": "Fix the conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54dee5e12c75c7c9fb9e1d5340500d34709106a1", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/54dee5e12c75c7c9fb9e1d5340500d34709106a1", "committedDate": "2020-04-27T05:45:07Z", "message": "Fix the suggestions"}, "afterCommit": {"oid": "e4a164a98981a04e53c09aca5a4b62d71f738582", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e4a164a98981a04e53c09aca5a4b62d71f738582", "committedDate": "2020-05-10T13:08:06Z", "message": "Fix the conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b16758f02f48605ee0e07f408209655eee92ef4", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8b16758f02f48605ee0e07f408209655eee92ef4", "committedDate": "2020-05-10T14:44:50Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5", "author": {"user": {"login": "KavinduZoysa", "name": null}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5", "committedDate": "2020-05-10T18:03:00Z", "message": "Fix failure tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTIzNzIw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#pullrequestreview-410923720", "createdAt": "2020-05-13T13:28:41Z", "commit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoyODo0MVrOGUxl4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoyODo0MVrOGUxl4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzNzIxNg==", "bodyText": "This test-case is failing intermittently. Shall I disable it for now?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424437216", "createdAt": "2020-05-13T13:28:41Z", "author": {"login": "hasithaa"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/globalvar/GlobalVarNegativeTest.java", "diffHunk": "@@ -33,12 +33,38 @@\n     public void testGlobalVarNegatives() {\n         CompileResult resultNegative = BCompileUtil.compile(\n                 \"test-src/statements/variabledef/global_variable_negative.bal\");\n-        Assert.assertEquals(resultNegative.getErrorCount(), 6);\n+        Assert.assertEquals(resultNegative.getErrorCount(), 4);\n         BAssertUtil.validateError(resultNegative, 0, \"invalid token 'int'\", 27, 8);\n         BAssertUtil.validateError(resultNegative, 1, \"invalid token 'int'\", 29, 8);\n-        BAssertUtil.validateError(resultNegative, 2, \"mismatched input ';'. expecting '='\", 31, 32);\n-        BAssertUtil.validateError(resultNegative, 3, \"mismatched input ';'. expecting '='\", 33, 27);\n-        BAssertUtil.validateError(resultNegative, 4, \"mismatched input ';'. expecting '='\", 35, 46);\n-        BAssertUtil.validateError(resultNegative, 5, \"mismatched input ';'. expecting '='\", 37, 59);\n+        BAssertUtil.validateError(resultNegative, 2, \"mismatched input ';'. expecting '='\", 31, 46);\n+        BAssertUtil.validateError(resultNegative, 3, \"mismatched input ';'. expecting '='\", 33, 59);\n+    }\n+\n+    @Test\n+    void testGlobalVariableInitNegative() {\n+        CompileResult result = BCompileUtil.compile(\"test-src/statements/variabledef/global_variable_init_negative\" +\n+                \".bal\");\n+\n+        Assert.assertEquals(result.getErrorCount(), 8);\n+        int i = 0;\n+        BAssertUtil.validateError(result, i++, \"uninitialized variable 'i'\", 17, 1);\n+        BAssertUtil.validateError(result, i++, \"uninitialized variable 's'\", 18, 1);\n+        BAssertUtil.validateError(result, i++, \"uninitialized variable 'a'\", 19, 1);\n+        BAssertUtil.validateError(result, i++, \"uninitialized variable 'b'\", 20, 1);\n+        BAssertUtil.validateError(result, i++, \"variable 'i' is not initialized\", 25, 5);\n+        BAssertUtil.validateError(result, i++, \"variable 'i' is not initialized\", 31, 5);\n+        BAssertUtil.validateError(result, i++, \"variable 'a' is not initialized\", 39, 13);\n+        BAssertUtil.validateError(result, i, \"variable 's' is not initialized\", 40, 18);\n+    }\n+\n+    @Test\n+    void testGlobalVariableInitWithInvocationNegative() {\n+        CompileResult result = BCompileUtil.compile(\"test-src/statements/variabledef\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTQwODUw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#pullrequestreview-411140850", "createdAt": "2020-05-13T17:22:35Z", "commit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyMjozNlrOGU74NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOToxMTo0NFrOGU_1dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNTc0OQ==", "bodyText": "Invalid changes. Will be fixed in the consolidated PR with d687c13.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424605749", "createdAt": "2020-05-13T17:22:36Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/antlr4/BallerinaLexer.java", "diffHunk": "@@ -1,4 +1,4 @@\n-// Generated from BallerinaLexer.g4 by ANTLR 4.5.3\n+// Generated from /home/kavindu/WSO2-GIT/ballerina-lang/compiler/ballerina-lang/src/main/resources/grammar/BallerinaLexer.g4 by ANTLR 4.5.3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0NzE5OA==", "bodyText": "Can't we avoid iterating through all the nodes twice + checking for existence by doing something like\n        for (TopLevelNode node : pkgNode.topLevelNodes) {\n            if (isModuleInitFunction((BLangNode) node)) {\n                sortedListOfNodes.add(0, node);\n                continue;\n            }\n\n            sortedListOfNodes.add(node);\n        }", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424647198", "createdAt": "2020-05-13T18:31:03Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -268,19 +268,64 @@ public void visit(BLangPackage pkgNode) {\n \n         // Rearrange the top level nodes so that global variables come on top\n         List<TopLevelNode> sortedListOfNodes = new ArrayList<>(pkgNode.globalVars);\n-        pkgNode.topLevelNodes.forEach(topLevelNode -> {\n-            if (!sortedListOfNodes.contains(topLevelNode)) {\n-                sortedListOfNodes.add(topLevelNode);\n+        addModuleInitToSortedNodeList(pkgNode, sortedListOfNodes);\n+        addNodesToSortedNodeList(pkgNode, sortedListOfNodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzA0MA==", "bodyText": "We can check the inverse and return early\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (env.isModuleInit) {\n          \n          \n            \n                        boolean isFirstUninitializedField = true;\n          \n          \n            \n                        StringBuilder uninitializedFields = new StringBuilder();\n          \n          \n            \n                        for (BSymbol symbol : this.uninitializedVars.keySet()) {\n          \n          \n            \n                            if (isFirstUninitializedField) {\n          \n          \n            \n                                uninitializedFields = new StringBuilder(symbol.getName().value);\n          \n          \n            \n                                isFirstUninitializedField = false;\n          \n          \n            \n                            } else {\n          \n          \n            \n                                uninitializedFields.append(\", \").append(symbol.getName().value);\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n          \n            \n                        if (uninitializedFields.length() != 0) {\n          \n          \n            \n                            this.dlog.error(pos, DiagnosticCode.CONTAINS_UNINITIALIZED_VARIABLES,\n          \n          \n            \n                                    uninitializedFields.toString());\n          \n          \n            \n                            return false;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    return true;\n          \n          \n            \n                    if (!env.isModuleInit) {\n          \n          \n            \n                        return true;\n          \n          \n            \n                    }\n          \n          \n            \n                    boolean isFirstUninitializedField = true;\n          \n          \n            \n                    StringBuilder uninitializedFields = new StringBuilder();\n          \n          \n            \n                    for (BSymbol symbol : this.uninitializedVars.keySet()) {\n          \n          \n            \n                        if (isFirstUninitializedField) {\n          \n          \n            \n                            uninitializedFields = new StringBuilder(symbol.getName().value);\n          \n          \n            \n                            isFirstUninitializedField = false;\n          \n          \n            \n                        } else {\n          \n          \n            \n                            uninitializedFields.append(\", \").append(symbol.getName().value);\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    \n          \n          \n            \n                    if (uninitializedFields.length() != 0) {\n          \n          \n            \n                        this.dlog.error(pos, DiagnosticCode.CONTAINS_UNINITIALIZED_VARIABLES,\n          \n          \n            \n                                        uninitializedFields.toString());\n          \n          \n            \n                        return false;\n          \n          \n            \n                    }\n          \n          \n            \n                    \n          \n          \n            \n                    return true;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424657040", "createdAt": "2020-05-13T18:47:58Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -877,6 +926,27 @@ private boolean isFieldsInitializedForSelfInvocation(List<BLangExpression> argEx\n         return true;\n     }\n \n+    private boolean isGlobalVarsInitialized(DiagnosticPos pos) {\n+        if (env.isModuleInit) {\n+            boolean isFirstUninitializedField = true;\n+            StringBuilder uninitializedFields = new StringBuilder();\n+            for (BSymbol symbol : this.uninitializedVars.keySet()) {\n+                if (isFirstUninitializedField) {\n+                    uninitializedFields = new StringBuilder(symbol.getName().value);\n+                    isFirstUninitializedField = false;\n+                } else {\n+                    uninitializedFields.append(\", \").append(symbol.getName().value);\n+                }\n+            }\n+            if (uninitializedFields.length() != 0) {\n+                this.dlog.error(pos, DiagnosticCode.CONTAINS_UNINITIALIZED_VARIABLES,\n+                        uninitializedFields.toString());\n+                return false;\n+            }\n+        }\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MjA3OQ==", "bodyText": "With this change, even module level final variables can be initialized in the __init() method right? Does that work? Can we add tests for the same?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424662079", "createdAt": "2020-05-13T18:56:20Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/statements/variabledef/global_variable_init_in_reverse_order.bal", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+public function testReverseOrderInitialization() {\n+    if (s == \"hello\" && a == 5) {\n+        return;\n+    }\n+\n+    panic error(ASSERTION_ERROR_REASON, message = \"expected 'true', found 'false'\");\n+}\n+\n+function __init() {\n+    s = \"hello\";\n+    int x = 2;\n+    a = x + 3;\n+}\n+\n+string s;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MDU4Mg==", "bodyText": "Why are we adding this to the SymbolEnv? IMO this doesn't belong here.\nLooking at the usage, can't we just use a boolean in the DataflowAnalyzer which we set and unset in analyzeModuleInitFunc? Like we generally do in CodeAnalyzer? \n  \n    \n      ballerina-lang/compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java\n    \n    \n         Line 252\n      in\n      6fc33a0\n    \n    \n    \n    \n\n        \n          \n           private boolean isJSONContext;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/22818#discussion_r424670582", "createdAt": "2020-05-13T19:11:44Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/model/SymbolEnv.java", "diffHunk": "@@ -75,6 +75,8 @@\n \n     public int relativeEnvCount;\n \n+    public boolean isModuleInit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc33a04d14a5d9d6fd49bd2507e5097fad2dfe5"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3618, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}