{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDA2NzA4", "number": 25695, "title": "Save global var dependencies in BIRFunction", "bodyText": "Purpose\n\n$title\nGlobal vars accessed inside functions are saved in the invokable symbol to be used in the Lock optimisation. Even though the dependencies are present in the symbol, BIR does not have it. Hence in case we are reading a module from a BIR, we loose this info leading to incorrect optimisation of locks.\n\nThis PR fixes that issue.\nFixes #24973\nCheck List\n\n[ x] Read the Contributing Guide\n Updated Change Log\n[ x] Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-09-09T17:18:56Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695", "merged": true, "mergeCommit": {"oid": "20eb40d8a873b3314c25db33bc30768a08827f8d"}, "closed": true, "closedAt": "2020-09-15T06:45:33Z", "author": {"login": "dulvinw"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHb2Y8gFqTQ4NTY2MjI2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJBuk8AFqTQ4ODM1ODQ1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjYyMjYx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-485662261", "createdAt": "2020-09-10T07:41:33Z", "commit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0MTozM1rOHPnFJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0MTozM1rOHPnFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMDk4Mg==", "bodyText": "Order is wrong here. you have to first write the size to the buffer and then write individual elements. And when reading, you read in the same order.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r486130982", "createdAt": "2020-09-10T07:41:33Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/writer/BIRBinaryWriter.java", "diffHunk": "@@ -296,6 +299,20 @@ private void writeFunction(ByteBuf buf, BIRTypeWriter typeWriter, BIRInstruction\n         buf.writeBytes(birbuf.nioBuffer().array(), 0, length);\n     }\n \n+    private void writeFunctionsGlobalVarDependency(ByteBuf buf, BIRNode.BIRFunction birFunction) {\n+        List<Integer> globalVarBuf = new LinkedList<>();\n+\n+        for (BIRNode.BIRVariableDcl var : birFunction.dependentGlobalVars) {\n+            if (var == null) {\n+                continue;\n+            }\n+            globalVarBuf.add(addStringCPEntry(var.name.value));\n+        }\n+\n+        buf.writeLong(globalVarBuf.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjY1Mzc2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-485665376", "createdAt": "2020-09-10T07:45:53Z", "commit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NTo1M1rOHPnO-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NTo1M1rOHPnO-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzQ5Ng==", "bodyText": "Btw, we can use writeInt here, than writing Long", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r486133496", "createdAt": "2020-09-10T07:45:53Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/writer/BIRBinaryWriter.java", "diffHunk": "@@ -296,6 +299,20 @@ private void writeFunction(ByteBuf buf, BIRTypeWriter typeWriter, BIRInstruction\n         buf.writeBytes(birbuf.nioBuffer().array(), 0, length);\n     }\n \n+    private void writeFunctionsGlobalVarDependency(ByteBuf buf, BIRNode.BIRFunction birFunction) {\n+        List<Integer> globalVarBuf = new LinkedList<>();\n+\n+        for (BIRNode.BIRVariableDcl var : birFunction.dependentGlobalVars) {\n+            if (var == null) {\n+                continue;\n+            }\n+            globalVarBuf.add(addStringCPEntry(var.name.value));\n+        }\n+\n+        buf.writeLong(globalVarBuf.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjI3MzUx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-486227351", "createdAt": "2020-09-10T19:00:28Z", "commit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4252c1a1d97dd10e8f6136ff00d0d94fb28ab112", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4252c1a1d97dd10e8f6136ff00d0d94fb28ab112", "committedDate": "2020-09-11T04:53:58Z", "message": "Save global var dependencies in BIRFunction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1ddb12c64e6b821ceb8aee76dc891f24bc2ddf4", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c1ddb12c64e6b821ceb8aee76dc891f24bc2ddf4", "committedDate": "2020-09-11T05:58:57Z", "message": "Fix review suggestion.\nAdd bir.ksy entry"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19d8f27632336e25766a0e08590bea8e236044c2", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/19d8f27632336e25766a0e08590bea8e236044c2", "committedDate": "2020-09-09T17:15:21Z", "message": "Save global var dependencies in BIRFunction"}, "afterCommit": {"oid": "c1ddb12c64e6b821ceb8aee76dc891f24bc2ddf4", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c1ddb12c64e6b821ceb8aee76dc891f24bc2ddf4", "committedDate": "2020-09-11T05:58:57Z", "message": "Fix review suggestion.\nAdd bir.ksy entry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDk2NDk5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-486496499", "createdAt": "2020-09-11T06:05:56Z", "commit": {"oid": "c1ddb12c64e6b821ceb8aee76dc891f24bc2ddf4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b1385288f600913065f68aa5351d8a4f7b138297", "committedDate": "2020-09-14T06:44:14Z", "message": "Fix review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee8b83c0dda142c5c4041515c39876d52593081b", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ee8b83c0dda142c5c4041515c39876d52593081b", "committedDate": "2020-09-14T06:41:29Z", "message": "Fix review suggestions"}, "afterCommit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b1385288f600913065f68aa5351d8a4f7b138297", "committedDate": "2020-09-14T06:44:14Z", "message": "Fix review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTk0ODc3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-487594877", "createdAt": "2020-09-14T09:52:26Z", "commit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwOTo1MjoyNlrOHRMTLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwOTo1MjoyNlrOHRMTLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4OTM1Ng==", "bodyText": "can this arg be moved to the above line? or did it exceed the 120 space?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r487789356", "createdAt": "2020-09-14T09:52:26Z", "author": {"login": "Kishanthan"}, "path": "docs/bir-spec/src/test/java/org/ballerinalang/birspec/BIRTestUtils.java", "diffHunk": "@@ -144,12 +144,30 @@ private static void assertFunctions(BIRNode.BIRPackage expectedBIR, Bir.Module b\n             Assert.assertEquals(actualFunctionBody.argsCount(), expectedFunction.argsCount);\n             Assert.assertEquals(actualFunctionBody.defaultParameterCount(), expectedFunction.parameters.size());\n \n+            // assert dependent global variables\n+            assertDepGlobalVar(actualFunction, expectedFunction.dependentGlobalVars.toArray(), constantPoolEntries);\n+\n             // assert basic blocks\n             assertBasicBlocks(actualFunctionBody.functionBasicBlocksInfo(), expectedFunction.basicBlocks,\n                     constantPoolEntries);\n         }\n     }\n \n+    private static void assertDepGlobalVar(Bir.Function actualFunction,\n+            Object[] dependentGlobalVars,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjY5MzU2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-487669356", "createdAt": "2020-09-14T11:41:46Z", "commit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTo0MTo0NlrOHRP1FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTo0MTo0NlrOHRP1FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0NzE4OQ==", "bodyText": "can this be null at any point?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r487847189", "createdAt": "2020-09-14T11:41:46Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/writer/BIRBinaryWriter.java", "diffHunk": "@@ -302,6 +305,20 @@ private void writeFunction(ByteBuf buf, BIRTypeWriter typeWriter, BIRInstruction\n         buf.writeBytes(birbuf.nioBuffer().array(), 0, length);\n     }\n \n+    private void writeFunctionsGlobalVarDependency(ByteBuf buf, BIRNode.BIRFunction birFunction) {\n+        List<Integer> globalVarBuf = new LinkedList<>();\n+\n+        for (BIRNode.BIRVariableDcl var : birFunction.dependentGlobalVars) {\n+            if (var == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1385288f600913065f68aa5351d8a4f7b138297"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a85dc64c9d9c02cef95163b4c776402d0d1ca3c7", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a85dc64c9d9c02cef95163b4c776402d0d1ca3c7", "committedDate": "2020-09-14T15:13:45Z", "message": "Formatting issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDIzMDU3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-488023057", "createdAt": "2020-09-14T18:10:14Z", "commit": {"oid": "a85dc64c9d9c02cef95163b4c776402d0d1ca3c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxMDoxNFrOHRg51w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxMDoxNFrOHRg51w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyNjkzNQ==", "bodyText": "what is the reason to remove the condition on CONSTANT here?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r488126935", "createdAt": "2020-09-14T18:10:14Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/cyclefind/GlobalVariableRefAnalyzer.java", "diffHunk": "@@ -192,9 +192,7 @@ private boolean isGlobalVarSymbol(BSymbol symbol) {\n             return false;\n         }\n \n-        return ((symbol.tag & SymTag.VARIABLE) == SymTag.VARIABLE) ||\n-                ((symbol.tag & SymTag.CONSTANT) == SymTag.CONSTANT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85dc64c9d9c02cef95163b4c776402d0d1ca3c7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDI0MTky", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-488024192", "createdAt": "2020-09-14T18:11:48Z", "commit": {"oid": "a85dc64c9d9c02cef95163b4c776402d0d1ca3c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxMTo0OFrOHRg9eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxMTo0OFrOHRg9eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyNzg2NA==", "bodyText": "this can be simplified now right? you don't need an intermediate list, but we can start writing to the buf directly from the loop?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#discussion_r488127864", "createdAt": "2020-09-14T18:11:48Z", "author": {"login": "Kishanthan"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/writer/BIRBinaryWriter.java", "diffHunk": "@@ -302,6 +305,17 @@ private void writeFunction(ByteBuf buf, BIRTypeWriter typeWriter, BIRInstruction\n         buf.writeBytes(birbuf.nioBuffer().array(), 0, length);\n     }\n \n+    private void writeFunctionsGlobalVarDependency(ByteBuf buf, BIRNode.BIRFunction birFunction) {\n+        List<Integer> globalVarBuf = new LinkedList<>();\n+\n+        for (BIRNode.BIRVariableDcl var : birFunction.dependentGlobalVars) {\n+            globalVarBuf.add(addStringCPEntry(var.name.value));\n+        }\n+\n+        buf.writeInt(globalVarBuf.size());\n+        globalVarBuf.forEach(buf::writeInt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85dc64c9d9c02cef95163b4c776402d0d1ca3c7"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be99d0b5613a87715ac86daa33051006779555b3", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/be99d0b5613a87715ac86daa33051006779555b3", "committedDate": "2020-09-15T03:59:00Z", "message": "Review suggestions"}, "afterCommit": {"oid": "cccced30368d5108450a1e8c5fb1ebf82a316996", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cccced30368d5108450a1e8c5fb1ebf82a316996", "committedDate": "2020-09-15T04:07:46Z", "message": "Review suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b81022599383f744e38babb03c91ea50bd4ebb0", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1b81022599383f744e38babb03c91ea50bd4ebb0", "committedDate": "2020-09-15T04:29:43Z", "message": "Review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cccced30368d5108450a1e8c5fb1ebf82a316996", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cccced30368d5108450a1e8c5fb1ebf82a316996", "committedDate": "2020-09-15T04:07:46Z", "message": "Review suggestions"}, "afterCommit": {"oid": "1b81022599383f744e38babb03c91ea50bd4ebb0", "author": {"user": {"login": "dulvinw", "name": "Dulvin Witharane"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1b81022599383f744e38babb03c91ea50bd4ebb0", "committedDate": "2020-09-15T04:29:43Z", "message": "Review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MzU4NDU3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25695#pullrequestreview-488358457", "createdAt": "2020-09-15T06:23:21Z", "commit": {"oid": "1b81022599383f744e38babb03c91ea50bd4ebb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4694, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}