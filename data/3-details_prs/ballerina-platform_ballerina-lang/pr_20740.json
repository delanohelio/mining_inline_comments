{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2ODA0NzE0", "number": 20740, "title": "Refactor the type def model for locally defined record types", "bodyText": "Purpose\n\nThis PR changes how locally defined anonymous record types are modeled. This makes the following notable changes:\n\nRefrain from creating a type def for locally defined anonymous record types. Instead, the symbols for such records are defined as they are encountered, when analyzing the code.\nDesugar the type def for the type node. This is to ensure there isn't any need to change the backend.\n\n\nFixes #20729\nRemarks\n\nThis PR builds on top of PR #20716 and is a part of work required for #20284.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-01-24T12:01:22Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740", "merged": true, "mergeCommit": {"oid": "5e488d42e978ba1ad0978350a4dc7994f13f084b"}, "closed": true, "closedAt": "2020-02-24T08:13:00Z", "author": {"login": "pubudu91"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9h8qPABqjI5Nzc5MjU4NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHZBi6AFqTM2MzIxNTIzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e175cb982457953704aaac3332b0a107b4ff76ed", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e175cb982457953704aaac3332b0a107b4ff76ed", "committedDate": "2020-01-24T16:54:07Z", "message": "Refactor desugar visit() for record and object types and fix checkstyle issues"}, "afterCommit": {"oid": "a34b6c4816457b492249979a46ff050702542eaa", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a34b6c4816457b492249979a46ff050702542eaa", "committedDate": "2020-01-24T16:57:06Z", "message": "Refactor desugar visit() for record and object types and fix checkstyle issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzODUyNDIz", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#pullrequestreview-353852423", "createdAt": "2020-02-05T16:22:06Z", "commit": {"oid": "de5312f3b5d20e3bd74e32ad46e1f7955a57d26d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjoyMjowNlrOFl-MMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjoyMjowNlrOFl-MMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM2MDU2Mw==", "bodyText": "Can we change this to private method?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#discussion_r375360563", "createdAt": "2020-02-05T16:22:06Z", "author": {"login": "anupama-pathirage"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java", "diffHunk": "@@ -460,6 +468,14 @@ void addBuiltInReferenceType(DiagnosticPos pos, Set<Whitespace> ws, String typeN\n         addType(refType);\n     }\n \n+    void startErrorType() {\n+        this.isInErrorType++;\n+    }\n+\n+    void endErrorType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de5312f3b5d20e3bd74e32ad46e1f7955a57d26d"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de5312f3b5d20e3bd74e32ad46e1f7955a57d26d", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/de5312f3b5d20e3bd74e32ad46e1f7955a57d26d", "committedDate": "2020-01-27T06:06:13Z", "message": "Add missing anonymous flag to anon record symbols"}, "afterCommit": {"oid": "d49e56392a2271f6773ffe7c92d4db3c8146db33", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d49e56392a2271f6773ffe7c92d4db3c8146db33", "committedDate": "2020-02-07T06:50:53Z", "message": "Add missing anonymous flag to anon record symbols"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae668163ee4b480ac31a7af4bc40581b85eac69", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0ae668163ee4b480ac31a7af4bc40581b85eac69", "committedDate": "2020-02-09T18:29:37Z", "message": "Skip creating a typedef and adding it as a top level node for local anon rec types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72171c31050d48649c1561978ae45e72a385e1f8", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/72171c31050d48649c1561978ae45e72a385e1f8", "committedDate": "2020-02-09T18:29:41Z", "message": "Add symbol defining logic for local anon record type nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3e0aad6b90174b3dab14dec694659a51794862f", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d3e0aad6b90174b3dab14dec694659a51794862f", "committedDate": "2020-02-09T18:29:42Z", "message": "Desugar typedef for locally defined record types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d012d1299f968e02c810c4fe3fe3267850dfcdc", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2d012d1299f968e02c810c4fe3fe3267850dfcdc", "committedDate": "2020-02-09T18:29:42Z", "message": "Refactor desugar visit() for record and object types and fix checkstyle issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79c4b54cce7d179484ce9acbee91b19fe8fac725", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/79c4b54cce7d179484ce9acbee91b19fe8fac725", "committedDate": "2020-02-09T18:29:42Z", "message": "Add missing anonymous flag to anon record symbols"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a26bf57b0b7174174545dc036ec516b48985e6", "author": {"user": {"login": "NipunaMarcus", "name": "Nipuna Marcus"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/48a26bf57b0b7174174545dc036ec516b48985e6", "committedDate": "2020-02-09T18:30:53Z", "message": "Add formatting support for local anonymous records"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7fb66eae6671ad278a154eb7710ada23714aa95", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b7fb66eae6671ad278a154eb7710ada23714aa95", "committedDate": "2020-02-09T18:30:53Z", "message": "Skip creating a typedef and adding it as a top level node for local anon rec types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3e9d2f33f24c50a05bc7e713cca817ad7e5b66", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0b3e9d2f33f24c50a05bc7e713cca817ad7e5b66", "committedDate": "2020-02-09T18:46:42Z", "message": "Modify visibility of endErrorType() method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bf2de581bd5c8e77d9a035419ffa5b86aeb1296", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4bf2de581bd5c8e77d9a035419ffa5b86aeb1296", "committedDate": "2020-02-07T07:51:06Z", "message": "Modify visibility of endErrorType() method"}, "afterCommit": {"oid": "0b3e9d2f33f24c50a05bc7e713cca817ad7e5b66", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0b3e9d2f33f24c50a05bc7e713cca817ad7e5b66", "committedDate": "2020-02-09T18:46:42Z", "message": "Modify visibility of endErrorType() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f539f2535ae35fa990821fa95320d84937fe575", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3f539f2535ae35fa990821fa95320d84937fe575", "committedDate": "2020-02-09T18:50:12Z", "message": "Remove duplicate var in package builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f700049d1280a53fdc0d6c5087c0d413f2582661", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f700049d1280a53fdc0d6c5087c0d413f2582661", "committedDate": "2020-02-17T16:59:35Z", "message": "Sync with master and resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8ce8c595bf85c59362d06e1b9ac7d1939e1121a", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a8ce8c595bf85c59362d06e1b9ac7d1939e1121a", "committedDate": "2020-02-17T18:16:24Z", "message": "Fix API changes in desugar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d", "author": {"user": {"login": "pubudu91", "name": "Pubudu Fernando"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c88ead47b42c40453cd0675c8bd0a14f86d01f3d", "committedDate": "2020-02-20T07:51:30Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into fix-20729"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjA0MTk4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#pullrequestreview-363204198", "createdAt": "2020-02-24T07:40:32Z", "commit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0MDozMlrOFtXfIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0MDozMlrOFtXfIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNTA0Mw==", "bodyText": "Please create an issue for this.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#discussion_r383115043", "createdAt": "2020-02-24T07:40:32Z", "author": {"login": "hasithaa"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/BLangPackageBuilder.java", "diffHunk": "@@ -408,12 +410,18 @@ private BLangRecordTypeNode populateRecordTypeNode(DiagnosticPos pos, Set<Whites\n         recordTypeNode.pos = pos;\n         recordTypeNode.addWS(ws);\n         recordTypeNode.isAnonymous = isAnonymous;\n+        recordTypeNode.isLocal = isInLocalDefinition();\n         this.varListStack.pop().forEach(variableNode -> {\n             recordTypeNode.addField((SimpleVariableNode) variableNode);\n         });\n         return recordTypeNode;\n     }\n \n+    private boolean isInLocalDefinition() {\n+        // TODO: When supporting local defs for errors, need to get rid of the second condition\n+        return !this.blockNodeStack.isEmpty() && this.isInErrorType <= 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjA0ODg2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#pullrequestreview-363204886", "createdAt": "2020-02-24T07:42:45Z", "commit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0Mjo0NVrOFtXhQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0Mjo0NVrOFtXhQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNTU4NQ==", "bodyText": "Add the reason field as well.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#discussion_r383115585", "createdAt": "2020-02-24T07:42:45Z", "author": {"login": "hasithaa"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/Desugar.java", "diffHunk": "@@ -719,9 +751,79 @@ public void visit(BLangRecordTypeNode recordTypeNode) {\n         // Add invocations for the initializers of each of the type referenced records. Here, the initializers of the\n         // referenced types are invoked on the current record type.\n \n+        if (recordTypeNode.isAnonymous && recordTypeNode.isLocal) {\n+            BLangUserDefinedType userDefinedType = desugarLocalAnonRecordTypeNode(recordTypeNode);\n+            TypeDefBuilderHelper.addTypeDefinition(recordTypeNode.type, recordTypeNode.type.tsymbol, recordTypeNode,\n+                                                   env);\n+            recordTypeNode.desugared = true;\n+            result = userDefinedType;\n+            return;\n+        }\n+\n         result = recordTypeNode;\n     }\n \n+    private BLangUserDefinedType desugarLocalAnonRecordTypeNode(BLangRecordTypeNode recordTypeNode) {\n+        return ASTBuilderUtil.createUserDefineTypeNode(recordTypeNode.symbol.name.value, recordTypeNode.type,\n+                                                       recordTypeNode.pos);\n+    }\n+\n+    @Override\n+    public void visit(BLangArrayType arrayType) {\n+        arrayType.elemtype = rewrite(arrayType.elemtype, env);\n+        result = arrayType;\n+    }\n+\n+    @Override\n+    public void visit(BLangConstrainedType constrainedType) {\n+        constrainedType.constraint = rewrite(constrainedType.constraint, env);\n+        result = constrainedType;\n+    }\n+\n+    @Override\n+    public void visit(BLangValueType valueType) {\n+        result = valueType;\n+    }\n+\n+    @Override\n+    public void visit(BLangUserDefinedType userDefinedType) {\n+        result = userDefinedType;\n+    }\n+\n+    @Override\n+    public void visit(BLangUnionTypeNode unionTypeNode) {\n+        List<BLangType> rewrittenMembers = new ArrayList<>();\n+        unionTypeNode.memberTypeNodes.forEach(typeNode -> rewrittenMembers.add(rewrite(typeNode, env)));\n+        unionTypeNode.memberTypeNodes = rewrittenMembers;\n+        result = unionTypeNode;\n+    }\n+\n+    @Override\n+    public void visit(BLangErrorType errorType) {\n+        errorType.detailType = rewrite(errorType.detailType, env);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjE1MjM4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20740#pullrequestreview-363215238", "createdAt": "2020-02-24T08:12:52Z", "commit": {"oid": "c88ead47b42c40453cd0675c8bd0a14f86d01f3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4380, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}