{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MzkzMDU3", "number": 20524, "title": "Enable Signature Help Feature", "bodyText": "Purpose\n\nEnable Signature Help Feature\n\nFixes #19728 #18910 #19727\nRelated PRs\n#20522\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-01-06T05:11:00Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524", "merged": true, "mergeCommit": {"oid": "df3a7224dff38ecb37724cf30ffb713760b6f24e"}, "closed": true, "closedAt": "2020-01-08T08:02:18Z", "author": {"login": "rasika"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb35HSpgFqTMzOTAyNjQyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4QioqAFqTMzOTY5MTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI2NDI2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339026426", "createdAt": "2020-01-07T04:33:19Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozMzoxOVrOFavpgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozMzoxOVrOFavpgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4Nzk3MA==", "bodyText": "Shall we add a doc comment for the public method?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363587970", "createdAt": "2020-01-07T04:33:19Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/completions/sourceprune/CompletionsTokenTraverserFactory.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+  Copyright (c) 2019, WSO2 Inc. (http://wso2.com) All Rights Reserved.\n+\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+ */\n+package org.ballerinalang.langserver.completions.sourceprune;\n+\n+import org.antlr.v4.runtime.TokenStream;\n+import org.ballerinalang.langserver.common.utils.CommonUtil;\n+import org.ballerinalang.langserver.compiler.workspace.WorkspaceDocumentException;\n+import org.ballerinalang.langserver.compiler.workspace.WorkspaceDocumentManager;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneContext;\n+import org.ballerinalang.langserver.sourceprune.TokenTraverser;\n+import org.ballerinalang.langserver.sourceprune.TokenTraverserFactory;\n+import org.wso2.ballerinalang.compiler.parser.antlr4.BallerinaParser;\n+\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * Factory class for providing token traversers and related artifacts for 'completions' service operation.\n+ */\n+public class CompletionsTokenTraverserFactory implements TokenTraverserFactory {\n+    private final SourcePruneContext sourcePruneCtx;\n+    private final boolean pruneTokens;\n+    private final TokenStream tokenStream;\n+\n+    private static final List<Integer> BLOCK_REMOVE_KW_TERMINALS;\n+    private static final List<Integer> LHS_TRAVERSE_TERMINALS;\n+    private static final List<Integer> RHS_TRAVERSE_TERMINALS;\n+\n+    static {\n+        BLOCK_REMOVE_KW_TERMINALS = Arrays.asList(\n+                BallerinaParser.SERVICE, BallerinaParser.FUNCTION, BallerinaParser.TYPE, BallerinaParser.MATCH,\n+                BallerinaParser.FOREACH, BallerinaParser.WORKER\n+        );\n+        LHS_TRAVERSE_TERMINALS = Arrays.asList(\n+                BallerinaParser.LEFT_BRACE, BallerinaParser.RIGHT_BRACE, BallerinaParser.SEMICOLON,\n+                BallerinaParser.COMMA, BallerinaParser.LEFT_PARENTHESIS, BallerinaParser.RIGHT_PARENTHESIS,\n+                BallerinaParser.LT, BallerinaParser.RETURNS, BallerinaParser.TRANSACTION,\n+                BallerinaParser.LEFT_CLOSED_RECORD_DELIMITER, BallerinaParser.LEFT_BRACKET\n+        );\n+        RHS_TRAVERSE_TERMINALS = Arrays.asList(\n+                BallerinaParser.SEMICOLON, BallerinaParser.DocumentationLineStart,\n+                BallerinaParser.AT, BallerinaParser.LEFT_BRACE, BallerinaParser.RIGHT_BRACE,\n+                BallerinaParser.RIGHT_PARENTHESIS, BallerinaParser.IMPORT, BallerinaParser.GT,\n+                BallerinaParser.XMLNS, BallerinaParser.SERVICE, BallerinaParser.PUBLIC, BallerinaParser.PRIVATE,\n+                BallerinaParser.REMOTE, BallerinaParser.FUNCTION, BallerinaParser.TYPE, BallerinaParser.ANNOTATION,\n+                BallerinaParser.CONST, BallerinaParser.RIGHT_BRACKET, BallerinaParser.RIGHT_CLOSED_RECORD_DELIMITER,\n+                BallerinaParser.RESOURCE, BallerinaParser.LISTENER, BallerinaParser.MATCH, BallerinaParser.IF,\n+                BallerinaParser.WHILE, BallerinaParser.FOREACH, BallerinaParser.BREAK, BallerinaParser.BREAK,\n+                BallerinaParser.FORK, BallerinaParser.THROW, BallerinaParser.TRANSACTION, BallerinaParser.WORKER\n+        );\n+    }\n+\n+    public CompletionsTokenTraverserFactory(Path filePath, WorkspaceDocumentManager documentManager,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI2NjEz", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339026613", "createdAt": "2020-01-07T04:34:27Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNDoyOFrOFavp_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNDoyOFrOFavp_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODA5NQ==", "bodyText": "Is it possible to make the class package-private if we do not expose this as a public API?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363588095", "createdAt": "2020-01-07T04:34:28Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/completions/sourceprune/LHSCompletionsTokenTraverser.java", "diffHunk": "@@ -32,7 +35,7 @@\n  * \n  * @since 0.995.0\n  */\n-class LHSTokenTraverser extends AbstractTokenTraverser {\n+public class LHSCompletionsTokenTraverser extends AbstractTokenTraverser {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI2NzY4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339026768", "createdAt": "2020-01-07T04:35:24Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNToyNFrOFavqbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNToyNFrOFavqbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODIwNg==", "bodyText": "Is it possible to make the class package-private since we do not expose this as a public API?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363588206", "createdAt": "2020-01-07T04:35:24Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/completions/sourceprune/RHSCompletionsTokenTraverser.java", "diffHunk": "@@ -29,7 +32,7 @@\n  * \n  * @since 0.995.0\n  */\n-class RHSTokenTraverser extends AbstractTokenTraverser {\n+public class RHSCompletionsTokenTraverser extends AbstractTokenTraverser {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI2OTA5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339026909", "createdAt": "2020-01-07T04:36:07Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNjowN1rOFavq2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNjowN1rOFavq2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODMxNQ==", "bodyText": "Missing doc comment for the public method", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363588315", "createdAt": "2020-01-07T04:36:07Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/completions/util/CompletionUtil.java", "diffHunk": "@@ -126,4 +135,20 @@ private static void setInvocationOrInteractionOrFieldAccessToken(LSContext conte\n         }\n         context.put(CompletionKeys.INVOCATION_TOKEN_TYPE_KEY, resultToken);\n     }\n+\n+    public static void pruneSource(LSContext lsContext) throws SourcePruneException, WorkspaceDocumentException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI3MjQy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339027242", "createdAt": "2020-01-07T04:37:59Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNzo1OVrOFavr3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDozNzo1OVrOFavr3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODU3Mg==", "bodyText": "Shall we remove the Commented code snippet?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363588572", "createdAt": "2020-01-07T04:37:59Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/signature/SignatureHelpUtil.java", "diffHunk": "@@ -210,31 +133,66 @@ private SignatureHelpUtil() {\n         return new ImmutablePair<>(parseAndGetFunctionInvocationPath(subRule, serviceContext), paramIndex);\n     }\n \n-    private static List<String> getSourcePrunedFunctionInvocation(LSServiceOperationContext serviceContext) {\n+    private static Pair<String, Integer> extractSourcePrunedInvocationDetails(\n+            LSServiceOperationContext serviceContext) {\n+        int parameterOffset = 0;\n         // Collect source-pruned tokens\n-        List<String> tokenText = new ArrayList<>();\n+        List<String> tokenTexts = new ArrayList<>();\n \n         final int[] pendingRParenthesisCount = new int[]{0};\n         Consumer<Integer> tokenAcceptor = type -> {\n-            if (type == BallerinaParser.RIGHT_PARENTHESIS) {\n-                pendingRParenthesisCount[0]++;\n-            } else if (type == BallerinaParser.LEFT_PARENTHESIS) {\n+            if (type == BallerinaParser.LEFT_PARENTHESIS) {\n                 pendingRParenthesisCount[0]--;\n+            } else if (type == BallerinaParser.RIGHT_PARENTHESIS) {\n+                pendingRParenthesisCount[0]++;\n             }\n         };\n \n-        // Visit Left-Hand side tokens\n+        // Visit Left-Hand side tokens before cursor\n         List<CommonToken> lhsTokens = serviceContext.get(CompletionKeys.LHS_TOKENS_KEY);\n         if (lhsTokens != null) {\n-            for (Token commonToken : lhsTokens) {\n-                tokenAcceptor.accept(commonToken.getType());\n-                tokenText.add(commonToken.getText());\n+            while (lhsTokens.get(0).getType() == BallerinaParser.COMMA) {\n+                lhsTokens.remove(0);\n+            }\n+            boolean isLastLeftParenthesisProcessed = false;\n+            for (int i = lhsTokens.size() - 1; i >= 0; i--) {\n+                Token commonToken = lhsTokens.get(i);\n+                int tokenType = commonToken.getType();\n+                if (tokenType == BallerinaParser.LEFT_PARENTHESIS) {\n+                    // Since we are traversing reverse order, we'll get the last LParenthesis first\n+                    isLastLeftParenthesisProcessed = true;\n+                }\n+                if (tokenType == BallerinaParser.COMMA) {\n+                    if (i - 1 >= 0 && lhsTokens.get(i - 1).getType() == BallerinaParser.RIGHT_PARENTHESIS) {\n+                        // eg. func1(func2(10, 10, 5),[cursor]);\n+//                        pendingRParenthesisCount[0]++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 226}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI3NzM2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339027736", "createdAt": "2020-01-07T04:40:35Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0MDozNVrOFavtcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0MDozNVrOFavtcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODk3Ng==", "bodyText": "Can there be semantically inconsistent issues if we do this?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363588976", "createdAt": "2020-01-07T04:40:35Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/signature/SignatureHelpUtil.java", "diffHunk": "@@ -243,20 +201,34 @@ private SignatureHelpUtil() {\n                     break;\n                 }\n                 tokenAcceptor.accept(commonToken.getType());\n-                tokenText.add(commonToken.getText());\n+                tokenTexts.add(commonToken.getText());\n             }\n         }\n \n+        // Remove if any comma[,] when pendingRParenthesis is less than zero\n+        int lastIndex = tokenTexts.size() - 1;\n+        if (COMMA.equals(tokenTexts.get(lastIndex)) && pendingRParenthesisCount[0] <= 0) {\n+            tokenTexts.remove(lastIndex);\n+        }\n+\n+        //  Remove if any semi-colon[;]\n+        lastIndex = tokenTexts.size() - 1;\n+        if (SEMI_COLON.equals(tokenTexts.get(lastIndex))) {\n+            tokenTexts.remove(lastIndex);\n+        }\n+\n         // Add Missing Parenthesis\n         while (pendingRParenthesisCount[0] < 0) {\n-            tokenText.add(\")\");\n+            tokenTexts.add(\")\");\n             pendingRParenthesisCount[0]++;\n         }\n-        return tokenText;\n+        return Pair.of(String.join(\"\", tokenTexts), parameterOffset);\n     }\n \n     private static Optional<String> parseAndGetFunctionInvocationPath(String subRule, LSServiceOperationContext context)\n             throws CompilationFailedException {\n+        // Replace 'optional field access' with 'field access' to avoid empty top-level nodes\n+        subRule = subRule.replaceAll(\"\\\\?.\", \".\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 293}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI4NjY5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339028669", "createdAt": "2020-01-07T04:45:52Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0NTo1M1rOFavwhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0NTo1M1rOFavwhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4OTc2NQ==", "bodyText": "Invalid version", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363589765", "createdAt": "2020-01-07T04:45:53Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/signature/sourceprune/LHSSignatureTokenTraverser.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+  Copyright (c) 2019, WSO2 Inc. (http://wso2.com) All Rights Reserved.\n+ \n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+ \n+  http://www.apache.org/licenses/LICENSE-2.0\n+ \n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+ */\n+package org.ballerinalang.langserver.signature.sourceprune;\n+\n+import org.antlr.v4.runtime.CommonToken;\n+import org.antlr.v4.runtime.Token;\n+import org.antlr.v4.runtime.TokenStream;\n+import org.ballerinalang.langserver.common.utils.CommonUtil;\n+import org.ballerinalang.langserver.sourceprune.AbstractTokenTraverser;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneContext;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneKeys;\n+import org.wso2.ballerinalang.compiler.parser.antlr4.BallerinaParser;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * LHS token traverser.\n+ *\n+ * @since 1.0.4", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI5MzI0", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339029324", "createdAt": "2020-01-07T04:49:21Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0OToyMlrOFavypw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo0OToyMlrOFavypw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MDMxMQ==", "bodyText": "Shall we refactor this one to use switch case instead of the if-else ladder?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363590311", "createdAt": "2020-01-07T04:49:22Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/signature/sourceprune/LHSSignatureTokenTraverser.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/*\n+  Copyright (c) 2019, WSO2 Inc. (http://wso2.com) All Rights Reserved.\n+ \n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+ \n+  http://www.apache.org/licenses/LICENSE-2.0\n+ \n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+ */\n+package org.ballerinalang.langserver.signature.sourceprune;\n+\n+import org.antlr.v4.runtime.CommonToken;\n+import org.antlr.v4.runtime.Token;\n+import org.antlr.v4.runtime.TokenStream;\n+import org.ballerinalang.langserver.common.utils.CommonUtil;\n+import org.ballerinalang.langserver.sourceprune.AbstractTokenTraverser;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneContext;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneKeys;\n+import org.wso2.ballerinalang.compiler.parser.antlr4.BallerinaParser;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * LHS token traverser.\n+ *\n+ * @since 1.0.4\n+ */\n+public class LHSSignatureTokenTraverser extends AbstractTokenTraverser {\n+    private List<Integer> lhsTraverseTerminals;\n+    private SourcePruneContext sourcePruneContext;\n+    private boolean forcedProcessedToken = false;\n+    private boolean capturedFirstLeftParenthesis = false;\n+    private boolean capturedFirstColon = false;\n+    private int pendingRightParenthesis = 1;\n+    private int pendingLeftParenthesis = 1;\n+    private int pendingLeftBrace = 0;\n+    private int pendingLeftBracket = 0;\n+    private boolean isCommaTerminal = true;\n+\n+    private boolean isCapturingEnabled = true;\n+    private boolean captureStatement = false;\n+    private boolean addSemiColon = false;\n+\n+    LHSSignatureTokenTraverser(SourcePruneContext sourcePruneContext, boolean pruneTokens) {\n+        super(pruneTokens);\n+        this.sourcePruneContext = sourcePruneContext;\n+        this.lhsTraverseTerminals = sourcePruneContext.get(SourcePruneKeys.LHS_TRAVERSE_TERMINALS_KEY);\n+        this.processedTokens = new ArrayList<>();\n+    }\n+\n+    @Override\n+    public List<CommonToken> traverse(TokenStream tokenStream, int tokenIndex) {\n+        Optional<Token> token = Optional.of(tokenStream.get(tokenIndex));\n+        if (token.isPresent()) {\n+            int type = token.get().getType();\n+            if (type == BallerinaParser.COMMA) {\n+                this.isCommaTerminal = false;\n+            }\n+        }\n+        while (token.isPresent()) {\n+            int type = token.get().getType();\n+            if (token.get().getChannel() != 0 && this.capturedFirstLeftParenthesis) {\n+                // if the first left parenthesis '(' is already captured, when we are getting non default channel token\n+                // we disable capturing tokens but continue pruning\n+                Optional<Token> prevToken = CommonUtil.getPreviousDefaultToken(tokenStream, tokenIndex);\n+\n+                // Exception is made for capturing explicit object initializations, eg. new Object()\n+                boolean explicitInit = prevToken.isPresent() && prevToken.get().getType() == BallerinaParser.NEW;\n+\n+                // Exception is made for capturing implicit object initializations, eg. Object obj = new()\n+                if (!this.captureStatement && this.processedTokens.size() >= 2) {\n+                    CommonToken nToken = this.processedTokens.get(this.processedTokens.size() - 1);\n+                    CommonToken nnToken = this.processedTokens.get(this.processedTokens.size() - 2);\n+                    this.captureStatement = nToken.getType() == BallerinaParser.NEW &&\n+                            nnToken.getType() == BallerinaParser.LEFT_PARENTHESIS;\n+                }\n+                if (!explicitInit && !this.captureStatement && this.pendingLeftParenthesis == 0) {\n+                    this.isCapturingEnabled = false;\n+                }\n+            }\n+            if (this.lhsTraverseTerminals.contains(type)) {\n+                boolean terminate = terminateLHSTraverse(token.get(), tokenStream);\n+                if (terminate) {\n+                    break;\n+                }\n+            }\n+            // If match statement, avoid adding semi-colon\n+            this.addSemiColon = this.addSemiColon || token.get().getType() == BallerinaParser.MATCH;\n+            if (!this.forcedProcessedToken) {\n+                processToken(token.get());\n+            }\n+            this.forcedProcessedToken = false;\n+            tokenIndex = token.get().getTokenIndex() - 1;\n+            token = tokenIndex < 0 ? Optional.empty() : Optional.of(tokenStream.get(tokenIndex));\n+        }\n+        sourcePruneContext.put(SourcePruneKeys.LEFT_PARAN_COUNT_KEY, this.pendingLeftParenthesis);\n+        sourcePruneContext.put(SourcePruneKeys.RIGHT_PARAN_COUNT_KEY, this.pendingRightParenthesis);\n+        sourcePruneContext.put(SourcePruneKeys.LEFT_BRACE_COUNT_KEY, this.pendingLeftBrace);\n+        sourcePruneContext.put(SourcePruneKeys.ADD_SEMICOLON_COUNT_KEY, this.addSemiColon);\n+        Collections.reverse(this.processedTokens);\n+\n+        removeProceedingNonDefaultTokens(this.processedTokens);\n+        return this.processedTokens;\n+    }\n+\n+    private void removeProceedingNonDefaultTokens(List<CommonToken> processedTokens) {\n+        int len = processedTokens.size();\n+        for (int i = 0; i < len; i++) {\n+            CommonToken token = processedTokens.get(i);\n+            if (token.getChannel() != 0) {\n+                processedTokens.remove(token);\n+                i--;\n+                len--;\n+            } else {\n+                break;\n+            }\n+        }\n+    }\n+\n+    private boolean terminateLHSTraverse(Token token, TokenStream tokenStream) {\n+        int type = token.getType();\n+        String text = token.getText();\n+        if (type == BallerinaParser.RIGHT_PARENTHESIS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 132}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI5NTkx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339029591", "createdAt": "2020-01-07T04:50:49Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo1MDo0OVrOFavzlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo1MDo0OVrOFavzlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MDU1MA==", "bodyText": "Invalid version", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363590550", "createdAt": "2020-01-07T04:50:49Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/signature/sourceprune/RHSSignatureTokenTraverser.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+  Copyright (c) 2019, WSO2 Inc. (http://wso2.com) All Rights Reserved.\n+ \n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+ \n+  http://www.apache.org/licenses/LICENSE-2.0\n+ \n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+ */\n+package org.ballerinalang.langserver.signature.sourceprune;\n+\n+import org.antlr.v4.runtime.CommonToken;\n+import org.antlr.v4.runtime.Token;\n+import org.antlr.v4.runtime.TokenStream;\n+import org.ballerinalang.langserver.sourceprune.AbstractTokenTraverser;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneContext;\n+import org.ballerinalang.langserver.sourceprune.SourcePruneKeys;\n+import org.wso2.ballerinalang.compiler.parser.antlr4.BallerinaParser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * RHS Token Traverser.\n+ *\n+ * @since 1.0.4", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDMwMzE1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339030315", "createdAt": "2020-01-07T04:55:04Z", "commit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo1NTowNFrOFav12g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo1NTowNFrOFav12g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MTEzMA==", "bodyText": "Invalid version", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#discussion_r363591130", "createdAt": "2020-01-07T04:55:04Z", "author": {"login": "nadeeshaan"}, "path": "language-server/modules/langserver-core/src/test/java/org/ballerinalang/langserver/sourceprune/SignatureSourcePruneTest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package org.ballerinalang.langserver.sourceprune;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import org.ballerinalang.langserver.LSContextOperation;\n+import org.ballerinalang.langserver.common.CommonKeys;\n+import org.ballerinalang.langserver.common.utils.CommonUtil;\n+import org.ballerinalang.langserver.compiler.DocumentServiceKeys;\n+import org.ballerinalang.langserver.compiler.LSContext;\n+import org.ballerinalang.langserver.compiler.LSServiceOperationContext;\n+import org.ballerinalang.langserver.compiler.workspace.WorkspaceDocumentException;\n+import org.ballerinalang.langserver.compiler.workspace.WorkspaceDocumentManagerImpl;\n+import org.ballerinalang.langserver.completions.util.SourcePruneException;\n+import org.ballerinalang.langserver.signature.sourceprune.SignatureTokenTraverserFactory;\n+import org.ballerinalang.langserver.util.FileUtils;\n+import org.eclipse.lsp4j.Position;\n+import org.eclipse.lsp4j.TextDocumentPositionParams;\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+\n+/**\n+ * Test the source prune operation with specific sources individual from the signature operation.\n+ *\n+ * @since 1.0.5", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a10b44bdbeb4e9bc902a4e2c2be5307df59e9f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad4dbb42cabae4c795e0a0b85e3e29e3ce694956", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ad4dbb42cabae4c795e0a0b85e3e29e3ce694956", "committedDate": "2020-01-07T08:51:26Z", "message": "Make SourcePruner extensible introducing TokenTraverserFactory\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57459e0384a078e005f9f2bbc06773080168d64e", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/57459e0384a078e005f9f2bbc06773080168d64e", "committedDate": "2020-01-07T08:51:33Z", "message": "Add signature source pruner\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfae1e450424413d73fc7cdbc6a5f7bc05744e78", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bfae1e450424413d73fc7cdbc6a5f7bc05744e78", "committedDate": "2020-01-07T08:51:43Z", "message": "Enable signature help\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01fdfb4dc647e925dcc89ef5b4f1b40b270df0d3", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/01fdfb4dc647e925dcc89ef5b4f1b40b270df0d3", "committedDate": "2020-01-07T08:51:57Z", "message": "persist last-processed token instead of token type\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58218cc9fdd769cee7b666a9bb729092027d72b2", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/58218cc9fdd769cee7b666a9bb729092027d72b2", "committedDate": "2020-01-07T08:52:03Z", "message": "Enable signature help tests\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6bd2c1d6396017eec15270ba6a501b6930ac2bf", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a6bd2c1d6396017eec15270ba6a501b6930ac2bf", "committedDate": "2020-01-07T08:52:20Z", "message": "Add source pruner tests\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6942bae220ea3622488ac658c032806283586d3", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a6942bae220ea3622488ac658c032806283586d3", "committedDate": "2020-01-07T08:52:37Z", "message": "Add signature tests to cover ballerina-spec-R3\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc3bcd2477dbb7629870ce11bdde90ba78e147b", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fdc3bcd2477dbb7629870ce11bdde90ba78e147b", "committedDate": "2020-01-07T08:53:16Z", "message": "Fix signature fails for match stmt\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63fd664e947db583131f95b250837495a83338ac", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/63fd664e947db583131f95b250837495a83338ac", "committedDate": "2020-01-07T08:53:21Z", "message": "Fix minor check style issues\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2446f80e6884abefccaa33abaa5085d9224a7c5f", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2446f80e6884abefccaa33abaa5085d9224a7c5f", "committedDate": "2020-01-07T08:53:32Z", "message": "Add minor refactoring\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970bd26d29d0aaa2ab6fd042ddde9b8ad8876b4d", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/970bd26d29d0aaa2ab6fd042ddde9b8ad8876b4d", "committedDate": "2020-01-07T08:53:38Z", "message": "Fix NPE issue\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdaefd8b513ef41ff0e15f10047949341a459a56", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bdaefd8b513ef41ff0e15f10047949341a459a56", "committedDate": "2020-01-07T08:53:48Z", "message": "Fix lastProcessedToken is getting replaced with WS\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "610f0143dd5e131ea074a0d60154b10f83f19236", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/610f0143dd5e131ea074a0d60154b10f83f19236", "committedDate": "2020-01-07T05:50:00Z", "message": "Fix ballerina test debug mode does not print debug suspended msg\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}, "afterCommit": {"oid": "bdaefd8b513ef41ff0e15f10047949341a459a56", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bdaefd8b513ef41ff0e15f10047949341a459a56", "committedDate": "2020-01-07T08:53:48Z", "message": "Fix lastProcessedToken is getting replaced with WS\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7028cd6836a9ac0e82e9c2eaf68caeca3171a24a", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7028cd6836a9ac0e82e9c2eaf68caeca3171a24a", "committedDate": "2020-01-07T11:45:15Z", "message": "Merge branch 'ballerina-1.1.x' of https://github.com/ballerina-platform/ballerina-lang into ballerina-1.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584fd37f5cef5b98644c39cda45a2e46042993f3", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/584fd37f5cef5b98644c39cda45a2e46042993f3", "committedDate": "2020-01-07T12:02:17Z", "message": "Change shipping version text\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb370ceed133071f71ea76515d98455cc0b15c76", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fb370ceed133071f71ea76515d98455cc0b15c76", "committedDate": "2020-01-07T12:22:45Z", "message": "Making TokenTraversers non public\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df1d707c3c2d550b6e32044190e592398a406be9", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/df1d707c3c2d550b6e32044190e592398a406be9", "committedDate": "2020-01-07T12:23:27Z", "message": "Add review suggestions\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83997acb89eafeb109d90ed44dc40f478d533047", "author": {"user": {"login": "rasika", "name": "Rasika Perera"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/83997acb89eafeb109d90ed44dc40f478d533047", "committedDate": "2020-01-07T12:26:58Z", "message": "Change shipping version\n\nSigned-off-by: Rasika <info.rasika@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjkxMzc3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20524#pullrequestreview-339691377", "createdAt": "2020-01-08T07:51:01Z", "commit": {"oid": "83997acb89eafeb109d90ed44dc40f478d533047"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4437, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}