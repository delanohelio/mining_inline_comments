{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODkxMzgy", "number": 20797, "title": "Improve final executable jar creation task", "bodyText": "Purpose\nThis PR adds improvements related to executable jar creation process, which reduces the final uber jar creation time by more than ~80% in average.\nFixes #20020.\nPossibly fixes #20438\nApproach\nThis PR uses apache.commons.compress.archivers.zip library APIs which is capable of copying the compressed data as it is, when constructing final executable uber jar by merging the thin jar with all the dependency jars.\nRemarks\nAverage uber jar creation execution time for time for few known samples are listed below.\n\n\n\nSample Scenario\nbefore (ms)\nafter (ms)\n\n\n\n\nHello World\n~1600\n~350\n\n\nHello World Service\n~4600\n~650\n\n\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-01-30T05:16:16Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20797", "merged": true, "mergeCommit": {"oid": "c0534ba50d21eace1809014391c70ba628c2b396"}, "closed": true, "closedAt": "2020-01-30T11:03:33Z", "author": {"login": "NipunaRanasinghe"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_TeGhAH2gAyMzY4ODkxMzgyOjM2M2FiNDkwOWI2OWQ1NjRmNjM4YTg4MzI2NmFiYWVjMDgwYTQwMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_Wr0iAFqTM1MDY2Mjg0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "363ab4909b69d564f638a883266abaec080a4012", "author": {"user": {"login": "NipunaRanasinghe", "name": "Nipuna Ransinghe "}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/363ab4909b69d564f638a883266abaec080a4012", "committedDate": "2020-01-30T05:13:14Z", "message": "improve final executable jar creation task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjA0ODgx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20797#pullrequestreview-350604881", "createdAt": "2020-01-30T06:33:02Z", "commit": {"oid": "363ab4909b69d564f638a883266abaec080a4012"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjozMzowMlrOFjgmTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjozMzowMlrOFjgmTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc3ODU3Mw==", "bodyText": "shall we wrap this with a BufferedInputStream as well?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20797#discussion_r372778573", "createdAt": "2020-01-30T06:33:02Z", "author": {"login": "SupunS"}, "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/CreateExecutableTask.java", "diffHunk": "@@ -111,77 +90,88 @@ public void execute(BuildContext buildContext) {\n         }\n     }\n \n-    private void assembleExecutable(Path jarFromCachePath, HashSet<Path> dependencySet, ZipOutputStream outStream) {\n+    private void assembleExecutable(Path jarFromCachePath, HashSet<Path> dependencySet,\n+                                    ZipArchiveOutputStream outStream) {\n         try {\n-            HashSet<String> entries = (HashSet<String>) namesField.get(outStream);\n-            HashMap<String, StringBuilder> services = new HashMap<>();\n-            copyJarToJar(outStream, jarFromCachePath.toString(), entries, services);\n+            // Used to prevent adding duplicated entries during the final jar creation.\n+            HashSet<String> entries = new HashSet<>();\n+            // Used to process SPI related metadata entries separately. The reason is unlike the other entry types,\n+            // service loader related information should be merged together in the final executable jar creation.\n+            HashMap<String, StringBuilder> serviceEntries = new HashMap<>();\n+            // Copy executable thin jar and the dependency jars.\n+            // Executable is created at given location.\n+            // If no entry point is found, we do nothing.\n+            copyJarToJar(outStream, jarFromCachePath.toString(), entries, serviceEntries);\n             for (Path path : dependencySet) {\n-                copyJarToJar(outStream, path.toString(), entries, services);\n+                copyJarToJar(outStream, path.toString(), entries, serviceEntries);\n             }\n-            // Copy merged spi services\n-            for (Map.Entry<String, StringBuilder> entry : services.entrySet()) {\n+            // Copy merged spi services.\n+            for (Map.Entry<String, StringBuilder> entry : serviceEntries.entrySet()) {\n                 String s = entry.getKey();\n                 StringBuilder service = entry.getValue();\n-                ZipEntry e = new ZipEntry(s);\n-                outStream.putNextEntry(e);\n+                JarArchiveEntry e = new JarArchiveEntry(s);\n+                outStream.putArchiveEntry(e);\n                 outStream.write(service.toString().getBytes(StandardCharsets.UTF_8));\n-                outStream.closeEntry();\n+                outStream.closeArchiveEntry();\n             }\n-            // Copy dependency jar\n-            // Copy dependency libraries\n-            // Executable is created at give location.\n-            // If no entry point is found we do nothing.\n-        } catch (IOException | NullPointerException | IllegalAccessException e) {\n+        } catch (IOException | NullPointerException e) {\n             throw createLauncherException(\"unable to create the executable: \" + e.getMessage());\n         }\n     }\n \n     /**\n-     * Copy jar file to executable fat jar.\n+     * Copies a given jar file into the executable fat jar.\n      *\n-     * @param outStream     Executable jar out stream\n-     * @param sourceJarFile Source file\n-     * @param entries       Entries set wiil be used ignore duplicate files\n+     * @param outStream     Output stream of the final uber jar.\n+     * @param sourceJarFile Path of the source jar file.\n+     * @param entries       Entries set will be used to ignore duplicate files.\n      * @param services      Services will be used to temporary hold merged spi files.\n-     * @throws IOException If file copy failed ioexception will be thrown\n+     * @throws IOException If jar file copying is failed.\n      */\n-    private void copyJarToJar(ZipOutputStream outStream, String sourceJarFile, HashSet<String> entries,\n+    private void copyJarToJar(ZipArchiveOutputStream outStream, String sourceJarFile, HashSet<String> entries,\n                               HashMap<String, StringBuilder> services) throws IOException {\n \n-        byte[] buffer = new byte[1024];\n-        int len;\n-        try (ZipInputStream inStream = new ZipInputStream(new FileInputStream(sourceJarFile))) {\n-            for (ZipEntry e; (e = inStream.getNextEntry()) != null; ) {\n-                String entryName = e.getName();\n-                // Skip already copied files or excluded extensions.\n-                if (e.isDirectory() || entries.contains(entryName) ||\n-                        excludeExtensions.contains(entryName.substring(entryName.lastIndexOf(\".\") + 1))) {\n-                    continue;\n-                }\n-                // SPIs will be merged first and then put into jar separately.\n+        ZipFile zipFile = new ZipFile(sourceJarFile);\n+        ZipArchiveEntryPredicate predicate = entry -> {\n+            try {\n+                String entryName = entry.getName();\n                 if (entryName.startsWith(\"META-INF/services\")) {\n                     StringBuilder s = services.get(entryName);\n                     if (s == null) {\n                         s = new StringBuilder();\n                         services.put(entryName, s);\n                     }\n                     char c = '\\n';\n+                    InputStream inStream = zipFile.getInputStream(entry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363ab4909b69d564f638a883266abaec080a4012"}, "originalPosition": 184}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04f172e6edd0a247c5e97f2164cd969b3c084bb", "author": {"user": {"login": "NipunaRanasinghe", "name": "Nipuna Ransinghe "}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a04f172e6edd0a247c5e97f2164cd969b3c084bb", "committedDate": "2020-01-30T08:48:39Z", "message": "Add buffered input stream"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b418de90e8199144b1781076e13d9a6dae6f91ba", "author": {"user": {"login": "NipunaRanasinghe", "name": "Nipuna Ransinghe "}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b418de90e8199144b1781076e13d9a6dae6f91ba", "committedDate": "2020-01-30T07:39:47Z", "message": "Add buffered input streams"}, "afterCommit": {"oid": "a04f172e6edd0a247c5e97f2164cd969b3c084bb", "author": {"user": {"login": "NipunaRanasinghe", "name": "Nipuna Ransinghe "}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a04f172e6edd0a247c5e97f2164cd969b3c084bb", "committedDate": "2020-01-30T08:48:39Z", "message": "Add buffered input stream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjYyODQ2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20797#pullrequestreview-350662846", "createdAt": "2020-01-30T08:57:56Z", "commit": {"oid": "a04f172e6edd0a247c5e97f2164cd969b3c084bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4279, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}