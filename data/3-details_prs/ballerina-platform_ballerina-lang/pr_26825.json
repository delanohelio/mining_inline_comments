{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjkxMTU2", "number": 26825, "title": "Update XML iterator  return type", "bodyText": "Purpose\n\nThe current implemetation of xml iterator retuens xml|string, with this pr it is updated to T of xml<T> . Inconsistencies found in the xml:concat() method and enabling xml:Text, xml<xml:Comment> and xml<xml:ProcessingInstruction> to be iterable is also done in this pr.\n\nFixes #24562\nFixes #26731\nFixes #27532\nFixes #27533\nFixes #27715\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-11-09T11:23:30Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825", "merged": true, "mergeCommit": {"oid": "572c9de28f3a585640acb5b9b5f7de08110d48a0"}, "closed": true, "closedAt": "2021-01-13T13:20:19Z", "author": {"login": "suleka96"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY5R6HAH2gAyNTE3NjkxMTU2OjU4Y2Q0YWM1NGQxNmMxNTc1ODNhM2MyZjdlN2EyMWJiYWJlMzZhZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvvXSZgFqTU2NzE5ODgyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "58cd4ac54d16c157583a3c2f7e7a21bbabe36adb", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/58cd4ac54d16c157583a3c2f7e7a21bbabe36adb", "committedDate": "2020-11-03T13:35:34Z", "message": "Update XML iterator to return xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e684d1b641d0989aca464d82650cce5ed9fecb", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/01e684d1b641d0989aca464d82650cce5ed9fecb", "committedDate": "2020-11-09T05:15:57Z", "message": "Update concat logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc1f833224d5cf832e752c5d0bc33e412253fef", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3bc1f833224d5cf832e752c5d0bc33e412253fef", "committedDate": "2020-11-09T14:00:54Z", "message": "Remove unnecessary conditions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1a42792e2a1d0b1e475c985e7e87dc0e05aa34e", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b1a42792e2a1d0b1e475c985e7e87dc0e05aa34e", "committedDate": "2020-11-09T19:37:33Z", "message": "Update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74498196e1a803cef862f474af639e0f17e50557", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/74498196e1a803cef862f474af639e0f17e50557", "committedDate": "2020-11-10T06:50:05Z", "message": "Update xml literal tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbdedbfd85c3d3615f82c17e5bf5018d31719933", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fbdedbfd85c3d3615f82c17e5bf5018d31719933", "committedDate": "2020-11-10T07:46:20Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/03d629b0fe733718c7073a08b29ade68ff74927f", "committedDate": "2020-11-10T08:47:00Z", "message": "Refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MzgyNzA0", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-528382704", "createdAt": "2020-11-11T17:24:38Z", "commit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNzoyNDozOFrOHxW78A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODozMjoxOVrOHxZakg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxODA2NA==", "bodyText": "Extra new line.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521518064", "createdAt": "2020-11-11T17:24:38Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml-literals-negative.bal", "diffHunk": "@@ -72,3 +72,16 @@ function testXmlNsInterpolation() returns xml {\n     xml x = xml `<foo xmlns=\"${ns}\" xmlns:foo=\"${ns}\">hello</foo>`;\n     return x;\n }\n+\n+function testXMLLiteralWithEscapeSequence(){\n+    xml x1 = xml `hello &lt; &gt; &amp;`;\n+    int i = 0;\n+    string[] strs = [];\n+    foreach string|xml e in x1 {\n+        if e is string {\n+            strs[i] = e;\n+            i += 1;\n+        }\n+    }\n+}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxODI5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            function testXMLLiteralWithEscapeSequence(){\n          \n          \n            \n            function testXMLLiteralWithEscapeSequence() {", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521518297", "createdAt": "2020-11-11T17:25:02Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml-literals-negative.bal", "diffHunk": "@@ -72,3 +72,16 @@ function testXmlNsInterpolation() returns xml {\n     xml x = xml `<foo xmlns=\"${ns}\" xmlns:foo=\"${ns}\">hello</foo>`;\n     return x;\n }\n+\n+function testXMLLiteralWithEscapeSequence(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxODQ3OQ==", "bodyText": "Don't we have to assert anything?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521518479", "createdAt": "2020-11-11T17:25:20Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml-literals-negative.bal", "diffHunk": "@@ -72,3 +72,16 @@ function testXmlNsInterpolation() returns xml {\n     xml x = xml `<foo xmlns=\"${ns}\" xmlns:foo=\"${ns}\">hello</foo>`;\n     return x;\n }\n+\n+function testXMLLiteralWithEscapeSequence(){\n+    xml x1 = xml `hello &lt; &gt; &amp;`;\n+    int i = 0;\n+    string[] strs = [];\n+    foreach string|xml e in x1 {\n+        if e is string {\n+            strs[i] = e;\n+            i += 1;\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxODgxOQ==", "bodyText": "Instead of using i we should be able to do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        strs[i] = e;\n          \n          \n            \n                        i += 1;\n          \n          \n            \n                        strs.push(e);\n          \n      \n    \n    \n  \n\nright?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521518819", "createdAt": "2020-11-11T17:25:58Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml-literals-negative.bal", "diffHunk": "@@ -72,3 +72,16 @@ function testXmlNsInterpolation() returns xml {\n     xml x = xml `<foo xmlns=\"${ns}\" xmlns:foo=\"${ns}\">hello</foo>`;\n     return x;\n }\n+\n+function testXMLLiteralWithEscapeSequence(){\n+    xml x1 = xml `hello &lt; &gt; &amp;`;\n+    int i = 0;\n+    string[] strs = [];\n+    foreach string|xml e in x1 {\n+        if e is string {\n+            strs[i] = e;\n+            i += 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxOTIwNg==", "bodyText": "Shall we fix the indentation here?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521519206", "createdAt": "2020-11-11T17:26:39Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration.bal", "diffHunk": "@@ -40,11 +40,9 @@ function foreachTest() returns [int, string][] {\n \n     int i = 0;\n     foreach var x in bookstore/<book> {\n-        if x is xml {\n             titles[count] = [i, (x/<title>/*).toString()];\n             count +=1;\n             i +=1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1Njk0Nw==", "bodyText": "Can't we keep the else logic as is and make this an else if?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521556947", "createdAt": "2020-11-11T18:29:09Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/java/org/ballerinalang/langlib/xml/Concat.java", "diffHunk": "@@ -51,6 +53,14 @@ public static BXml concat(Object... arrayValue) {\n                 backingArray.add(xmlText);\n                 lastItem = xmlText;\n             } else {\n+                if (refValue instanceof BXmlSequence) {\n+                    List<BXml> sequenceChildren = ((BXmlSequence) refValue).getChildrenList();\n+                    for (int j = 0; j < sequenceChildren.size(); j++) {\n+                        backingArray.add(sequenceChildren.get(j));\n+                    }\n+                    lastItem = (BXml) refValue;\n+                    continue;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NzgzNQ==", "bodyText": "Have we added tests for this fix?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521557835", "createdAt": "2020-11-11T18:30:46Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/java/org/ballerinalang/langlib/xml/Concat.java", "diffHunk": "@@ -51,6 +53,14 @@ public static BXml concat(Object... arrayValue) {\n                 backingArray.add(xmlText);\n                 lastItem = xmlText;\n             } else {\n+                if (refValue instanceof BXmlSequence) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1ODY3NA==", "bodyText": "Can't we just do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                List<BXml> sequenceChildren = ((BXmlSequence) refValue).getChildrenList();\n          \n          \n            \n                                for (int j = 0; j < sequenceChildren.size(); j++) {\n          \n          \n            \n                                    backingArray.add(sequenceChildren.get(j));\n          \n          \n            \n                                }\n          \n          \n            \n                                backingArray.addAll(((BXmlSequence) refValue).getChildrenList());", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r521558674", "createdAt": "2020-11-11T18:32:19Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/java/org/ballerinalang/langlib/xml/Concat.java", "diffHunk": "@@ -51,6 +53,14 @@ public static BXml concat(Object... arrayValue) {\n                 backingArray.add(xmlText);\n                 lastItem = xmlText;\n             } else {\n+                if (refValue instanceof BXmlSequence) {\n+                    List<BXml> sequenceChildren = ((BXmlSequence) refValue).getChildrenList();\n+                    for (int j = 0; j < sequenceChildren.size(); j++) {\n+                        backingArray.add(sequenceChildren.get(j));\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d629b0fe733718c7073a08b29ade68ff74927f"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aef16057bcb9a0d19bcd9a591b97ef7ded930a48", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aef16057bcb9a0d19bcd9a591b97ef7ded930a48", "committedDate": "2020-11-13T12:46:50Z", "message": "Add concat tests and refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718bcfc702b91acfb59c425787c038f0bd47e66a", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/718bcfc702b91acfb59c425787c038f0bd47e66a", "committedDate": "2020-11-13T13:19:33Z", "message": "Refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda917a970eeda017459f94ff551135d6bdeab1c", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cda917a970eeda017459f94ff551135d6bdeab1c", "committedDate": "2020-11-13T19:05:26Z", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into fix_xml\nMerge with upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49faf07613f9ad0942bbcf245f6d7bac20118057", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/49faf07613f9ad0942bbcf245f6d7bac20118057", "committedDate": "2020-11-13T19:35:17Z", "message": "Update completion test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaffd967803fb94d8f4d72fb8f581ce9ed6c5139", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aaffd967803fb94d8f4d72fb8f581ce9ed6c5139", "committedDate": "2020-11-19T05:39:32Z", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into fix_xml\nMerge Upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e51519c241395c4b66fd454e6c7c052c6547e7e1", "committedDate": "2020-11-20T10:15:48Z", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into fix_xml\nMerge with upstream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjI3ODUw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-535627850", "createdAt": "2020-11-20T17:21:09Z", "commit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzoyMToxMFrOH3Y_cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzozNzo0MFrOH3Z1zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0MzE4Ng==", "bodyText": "Can't we just do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                return that;\n          \n          \n            \n                                return this;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527843186", "createdAt": "2020-11-20T17:21:10Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/values/XmlText.java", "diffHunk": "@@ -113,7 +114,7 @@ public boolean hasNext() {\n             public Object next() {\n                 if (!read) {\n                     this.read = true;\n-                    return data;\n+                    return that;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0ODA0Nw==", "bodyText": "I think there's a deviation here too.\nThe spec says for xml<T> the iteration value type is T.\nSo the following should work, right?\npublic function main() {\n    xml<'xml:Element> el = xml `<foo>foo</foo><bar/>`;\n\n    foreach 'xml:Element item in el {\n        \n    }\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527848047", "createdAt": "2020-11-20T17:26:47Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1433,7 +1433,7 @@ public void setForeachTypedBindingPatternType(BLangForeach foreachNode) {\n                 varType = inferRecordFieldType(recordType);\n                 break;\n             case TypeTags.XML:\n-                varType = BUnionType.create(null, symTable.xmlType, symTable.stringType);\n+                varType = symTable.xmlType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1MTU2Mw==", "bodyText": "Similarly, the lang.xml:iterator() also needs to change.\nThe following doesn't work either.\npublic function main() {\n    xml<'xml:Element> el = xml `<foo>foo</foo><bar/>`;\n\n    record {| 'xml:Element value; |}? nextResult = el.iterator().next();\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527851563", "createdAt": "2020-11-20T17:31:00Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1433,7 +1433,7 @@ public void setForeachTypedBindingPatternType(BLangForeach foreachNode) {\n                 varType = inferRecordFieldType(recordType);\n                 break;\n             case TypeTags.XML:\n-                varType = BUnionType.create(null, symTable.xmlType, symTable.stringType);\n+                varType = symTable.xmlType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0ODA0Nw=="}, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1MzIwOQ==", "bodyText": "Maybe we can merge this PR first and then fix the xml<T> scenario.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527853209", "createdAt": "2020-11-20T17:33:00Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1433,7 +1433,7 @@ public void setForeachTypedBindingPatternType(BLangForeach foreachNode) {\n                 varType = inferRecordFieldType(recordType);\n                 break;\n             case TypeTags.XML:\n-                varType = BUnionType.create(null, symTable.xmlType, symTable.stringType);\n+                varType = symTable.xmlType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0ODA0Nw=="}, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1NDYxMw==", "bodyText": "Shall we also assert here that the original catalog does not change?\nBefore calling concat we can create a clone, and then check == for that clone and catalog after calling clone.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527854613", "createdAt": "2020-11-20T17:34:40Z", "author": {"login": "MaryamZi"}, "path": "langlib/langlib-test/src/test/resources/test-src/xmllib_test.bal", "diffHunk": "@@ -62,6 +62,25 @@ function testConcat() returns xml {\n     return 'xml:concat(x, <xml> testFromString(), \"hello from String\");\n }\n \n+function testConcatWithXMLSequence() {\n+    string a = \"string one\";\n+    string b = \"string two\";\n+\n+    xml c = 'xml:concat(catalog, a, b);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1Njc0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        result += x[\"title\"].getTextValue();\n          \n          \n            \n                    result += x[\"title\"].getTextValue();", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527856743", "createdAt": "2020-11-20T17:37:13Z", "author": {"login": "MaryamZi"}, "path": "tests/ballerina-spec-conformance-tests/src/S05_values_types_variables/tests/iterable_types.bal", "diffHunk": "@@ -110,9 +110,7 @@ function testIterableTypeXML() {\n                         </bookstore>`;\n     string result = \"\";\n     foreach var x in bookstore[\"book\"] {\n-        if x is xml {\n             result += x[\"title\"].getTextValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1NzEwMQ==", "bodyText": "Missing a new line.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r527857101", "createdAt": "2020-11-20T17:37:40Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml-literals-negative.bal", "diffHunk": "@@ -72,3 +71,13 @@ function testXmlNsInterpolation() returns xml {\n     xml x = xml `<foo xmlns=\"${ns}\" xmlns:foo=\"${ns}\">hello</foo>`;\n     return x;\n }\n+\n+function testXMLLiteralWithEscapeSequence() {\n+    xml x1 = xml `hello &lt; &gt; &amp;`;\n+    string[] strs = [];\n+    foreach xml e in x1 {\n+        if e is string {\n+            strs.push(e);\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350e8667abc2666510e7196a4cc14411cbdf232d", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/350e8667abc2666510e7196a4cc14411cbdf232d", "committedDate": "2020-11-26T09:23:02Z", "message": "Update xml foreach return type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c95b162c13543d00234598751ceec7769ace175b", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c95b162c13543d00234598751ceec7769ace175b", "committedDate": "2020-12-02T04:51:57Z", "message": "Update compiler foreach to return xml sub types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474639fd3bbe670782b1d5e22b8fcd8b40d68b6b", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/474639fd3bbe670782b1d5e22b8fcd8b40d68b6b", "committedDate": "2020-12-16T12:39:27Z", "message": "Update XML iterator return type and enable xml:Text iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06967e7a5f048b16c7cb359b260124cb89051a16", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/06967e7a5f048b16c7cb359b260124cb89051a16", "committedDate": "2020-12-17T01:02:47Z", "message": "Refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f3ba67e7c63cad1b7f944398515d777db243af", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/18f3ba67e7c63cad1b7f944398515d777db243af", "committedDate": "2020-12-17T01:05:56Z", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into fix_xml\nMerge upstream changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c985b98cc481405a740a7245e4f9dcefe631fe92", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c985b98cc481405a740a7245e4f9dcefe631fe92", "committedDate": "2020-12-18T12:30:05Z", "message": "Add Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3694538b81c4711e0a996154dc82440423996f8f", "committedDate": "2020-12-18T12:41:55Z", "message": "Refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MTU3NDM3", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-557157437", "createdAt": "2020-12-22T15:21:19Z", "commit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNToyMToxOVrOIJ-0MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzo1MjoyMFrOIKDp6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMzNzI2NQ==", "bodyText": "Extra new lines.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547337265", "createdAt": "2020-12-22T15:21:19Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/PredefinedTypes.java", "diffHunk": "@@ -170,9 +170,15 @@\n \n     public static final RecordType STRING_ITR_NEXT_RETURN_TYPE =\n             IteratorUtils.createIteratorNextReturnType(PredefinedTypes.TYPE_STRING);\n-    public static final RecordType XML_ITR_NEXT_RETURN_TYPE = IteratorUtils\n-            .createIteratorNextReturnType(\n-                    new BUnionType(Arrays.asList(PredefinedTypes.TYPE_STRING, PredefinedTypes.TYPE_XML)));\n+\n+    public static final RecordType XML_ITR_NEXT_RETURN_ELEMENT_TYPE =\n+            IteratorUtils.createIteratorNextReturnType(TYPE_ELEMENT);\n+    public static final RecordType XML_ITR_NEXT_RETURN_TEXT_TYPE =\n+            IteratorUtils.createIteratorNextReturnType(TYPE_TEXT);\n+    public static final RecordType XML_ITR_NEXT_RETURN_XML_TYPE = IteratorUtils.createIteratorNextReturnType\n+            (new BUnionType(Arrays.asList(TYPE_ELEMENT, TYPE_COMMENT, TYPE_PROCESSING_INSTRUCTION, TYPE_TEXT)));\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0ODA0Nw==", "bodyText": "Ah, missed that we were returning here from a method of the in-line initialization of new IteratorValue().", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547348047", "createdAt": "2020-12-22T15:40:05Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/values/XmlText.java", "diffHunk": "@@ -113,7 +114,7 @@ public boolean hasNext() {\n             public Object next() {\n                 if (!read) {\n                     this.read = true;\n-                    return data;\n+                    return that;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0MzE4Ng=="}, "originalCommit": {"oid": "e51519c241395c4b66fd454e6c7c052c6547e7e1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MDc4OA==", "bodyText": "Shall we rewrite the tests without this import? We try to avoid standard library imports in language tests.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547350788", "createdAt": "2020-12-22T15:45:01Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration_negative.bal", "diffHunk": "@@ -1,3 +1,5 @@\n+import ballerina/io;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MzM4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    count +=1;\n          \n          \n            \n                    i +=1;\n          \n          \n            \n                    count += 1;\n          \n          \n            \n                    i += 1;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547353388", "createdAt": "2020-12-22T15:49:40Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration.bal", "diffHunk": "@@ -40,11 +40,9 @@ function foreachTest() returns [int, string][] {\n \n     int i = 0;\n     foreach var x in bookstore/<book> {\n-        if x is xml {\n-            titles[count] = [i, (x/<title>/*).toString()];\n-            count +=1;\n-            i +=1;\n-        }\n+        titles[count] = [i, (x/<title>/*).toString()];\n+        count +=1;\n+        i +=1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMDM5Ng==", "bodyText": "These tests are bound to break once we fix #26340, right?\nInstead shall we rewrite these tests similar to\npublic function main() {\n    xml el = xml `<foo>foo</foo>`;\n    xml<'xml:Element> seq = <xml<'xml:Element>> el.concat(xml `<bar/>`);\n\n\n    foreach 'xml:Element x in seq {\n        \n    }\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547400396", "createdAt": "2020-12-22T17:18:54Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration.bal", "diffHunk": "@@ -142,10 +140,103 @@ function xmlSequenceIter() returns string {\n \n function xmlCharItemIter() returns string {\n     string result = \"\";\n-\n-    foreach xml|string elem in bitOfText {\n+    int i = 0;\n+    foreach xml elem in bitOfText {\n         string str = io:sprintf(\"%s\\n\", elem);\n         result += str;\n+        i += 1;\n     }\n     return result;\n }\n+\n+function xmlTypeParamElementIter() {\n+    xml<'xml:Element> el1 = xml `<foo>foo</foo><bar/>`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMDc3NQ==", "bodyText": "I think we can call these tests testXmlElementSequenceIteration, testXmlElementSequenceIteration, etc.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547400775", "createdAt": "2020-12-22T17:19:41Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration.bal", "diffHunk": "@@ -142,10 +140,103 @@ function xmlSequenceIter() returns string {\n \n function xmlCharItemIter() returns string {\n     string result = \"\";\n-\n-    foreach xml|string elem in bitOfText {\n+    int i = 0;\n+    foreach xml elem in bitOfText {\n         string str = io:sprintf(\"%s\\n\", elem);\n         result += str;\n+        i += 1;\n     }\n     return result;\n }\n+\n+function xmlTypeParamElementIter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMzI4Mg==", "bodyText": "We can check (!TypeTags.isXMLTypeTag(actualType.tag)) and return early here.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547403282", "createdAt": "2020-12-22T17:25:03Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -294,6 +295,29 @@ private void findTypeParam(Location loc, BType expType, BType actualType, Symbol\n         }\n         // Bound type is a structure. Visit recursively to find bound type.\n         switch (expType.tag) {\n+            case TypeTags.XML:\n+                if (TypeTags.isXMLTypeTag(actualType.tag)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMzU4MQ==", "bodyText": "Do we need to break in these cases? We can directly return, right?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547403581", "createdAt": "2020-12-22T17:25:43Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -294,6 +295,29 @@ private void findTypeParam(Location loc, BType expType, BType actualType, Symbol\n         }\n         // Bound type is a structure. Visit recursively to find bound type.\n         switch (expType.tag) {\n+            case TypeTags.XML:\n+                if (TypeTags.isXMLTypeTag(actualType.tag)) {\n+                    switch (actualType.tag) {\n+                        case TypeTags.XML:\n+                            BType constraint = ((BXMLType) actualType).constraint;\n+                            while (constraint.tag == TypeTags.XML) {\n+                                actualType = constraint;\n+                                constraint = ((BXMLType) actualType).constraint;\n+                            }\n+                            findTypeParam(loc, ((BXMLType) expType).constraint, constraint, env,\n+                                    resolvedTypes, result);\n+                            break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMzgzNg==", "bodyText": "Can't we directly do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            actualType = constraint;\n          \n          \n            \n                                            constraint = ((BXMLType) actualType).constraint;\n          \n          \n            \n                                            constraint = ((BXMLType) constraint).constraint;\n          \n      \n    \n    \n  \n\ninstead?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547403836", "createdAt": "2020-12-22T17:26:13Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -294,6 +295,29 @@ private void findTypeParam(Location loc, BType expType, BType actualType, Symbol\n         }\n         // Bound type is a structure. Visit recursively to find bound type.\n         switch (expType.tag) {\n+            case TypeTags.XML:\n+                if (TypeTags.isXMLTypeTag(actualType.tag)) {\n+                    switch (actualType.tag) {\n+                        case TypeTags.XML:\n+                            BType constraint = ((BXMLType) actualType).constraint;\n+                            while (constraint.tag == TypeTags.XML) {\n+                                actualType = constraint;\n+                                constraint = ((BXMLType) actualType).constraint;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNzA0Mg==", "bodyText": "Shall we add some tests in LangLibXMLTest for the direct invocation of lang.xml:iterator() too?\n    xml x = xml `<!--first-->`;\n    xml<'xml:Comment> seq = <xml<'xml:Comment>> x.concat(xml `<!--second-->`);\n\n    object {\n        public isolated function next() returns record {| 'xml:Comment value; |}?;\n    } iter = seq.iterator();\n\n    // tests based on `iter.next()`.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547407042", "createdAt": "2020-12-22T17:32:41Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/ballerina/xml.bal", "diffHunk": "@@ -77,7 +77,7 @@ type XmlType xml;\n # + return - iterator object\n # Each item is represented by an xml singleton.\n public isolated function iterator(xml<ItemType> x) returns object {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNjU1Mg==", "bodyText": "How come we don't need to do this for processing instruction and comment sequences?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r547416552", "createdAt": "2020-12-22T17:52:20Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/PredefinedTypes.java", "diffHunk": "@@ -170,9 +170,15 @@\n \n     public static final RecordType STRING_ITR_NEXT_RETURN_TYPE =\n             IteratorUtils.createIteratorNextReturnType(PredefinedTypes.TYPE_STRING);\n-    public static final RecordType XML_ITR_NEXT_RETURN_TYPE = IteratorUtils\n-            .createIteratorNextReturnType(\n-                    new BUnionType(Arrays.asList(PredefinedTypes.TYPE_STRING, PredefinedTypes.TYPE_XML)));\n+\n+    public static final RecordType XML_ITR_NEXT_RETURN_ELEMENT_TYPE =\n+            IteratorUtils.createIteratorNextReturnType(TYPE_ELEMENT);\n+    public static final RecordType XML_ITR_NEXT_RETURN_TEXT_TYPE =\n+            IteratorUtils.createIteratorNextReturnType(TYPE_TEXT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3694538b81c4711e0a996154dc82440423996f8f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d1f99f31183e352b897bd9ffb8e33aa61015a7", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a9d1f99f31183e352b897bd9ffb8e33aa61015a7", "committedDate": "2020-12-23T10:17:43Z", "message": "Add xml:iterator invocation tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f72a74570915030fb944acbc7bb29c938adf25", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/90f72a74570915030fb944acbc7bb29c938adf25", "committedDate": "2021-01-07T04:48:56Z", "message": "Enable iterability of xml<xml:Comment> and xml<xml:ProcessingInstruction>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddc67ee0f502271e7b57b5a4622dc2532d8537bc", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ddc67ee0f502271e7b57b5a4622dc2532d8537bc", "committedDate": "2021-01-07T04:45:21Z", "message": "enable iterability of xml<xml:Comment and xml<xml:ProcessingInstruction>"}, "afterCommit": {"oid": "90f72a74570915030fb944acbc7bb29c938adf25", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/90f72a74570915030fb944acbc7bb29c938adf25", "committedDate": "2021-01-07T04:48:56Z", "message": "Enable iterability of xml<xml:Comment> and xml<xml:ProcessingInstruction>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e47d8d294df9bbfd9a4fc102063b26b63266aa02", "committedDate": "2021-01-07T05:09:33Z", "message": "Refactor xml Next"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NDUzMjI4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-566453228", "createdAt": "2021-01-12T16:32:02Z", "commit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNjozMjowMlrOISJ8yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNzoyNjo0MlrOISMUNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwODI5OA==", "bodyText": "With this approach, the type of the value field returned on iterator next becomes the current value type, right? I don't think that is correct. The next value ideally shouldn't change between next invocations of the same iterator.\npublic function main() {\n    'xml:Text x1 = xml `foo`;\n    xml<'xml:Element|'xml:Text> x2 = <xml<'xml:Element|'xml:Text>> x1.concat(xml `<bar/>`);\n\n    var iterator = x2.iterator();\n    record {| 'xml:Element|'xml:Text value; |}? next = iterator.next();\n\n    boolean b1 = <any> next is record {| 'xml:Element|'xml:Text value; |}; // true\n    boolean b2 = next is record {| 'xml:Element value; |}; // false\n    boolean b3 = next is record {| 'xml:Text value; |}; // true - should be false!\n\n    record {| 'xml:Element|'xml:Text value; |}? nextNext = iterator.next();\n\n    boolean b4 = <any> nextNext is record {| 'xml:Element|'xml:Text value; |}; // true\n    boolean b5 = nextNext is record {| 'xml:Element value; |}; // true - should be false!\n    boolean b6 = nextNext is record {| 'xml:Text value; |}; // false\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r555908298", "createdAt": "2021-01-12T16:32:02Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/java/org/ballerinalang/langlib/xml/Next.java", "diffHunk": "@@ -49,10 +50,21 @@ public static Object next(BObject m) {\n \n         if (xmlIterator.hasNext()) {\n             Object xmlValue = xmlIterator.next();\n-            return ValueCreator.createRecordValue(ValueCreator.createMapValue(PredefinedTypes.XML_ITR_NEXT_RETURN_TYPE),\n-                                                  xmlValue);\n+            switch (((BXml) xmlValue).getType().getTag()) {\n+                case TypeTags.XML_ELEMENT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                                    (PredefinedTypes.XML_ITR_NEXT_RETURN_ELEMENT_TYPE), xmlValue);\n+                case TypeTags.XML_TEXT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_TEXT_TYPE), xmlValue);\n+                case TypeTags.XML_COMMENT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_COMMENT_TYPE), xmlValue);\n+                case TypeTags.XML_PI_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_PI_TYPE), xmlValue);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwODY1OQ==", "bodyText": "We probably need something like io.ballerina.runtime.api.values.BMap#getIteratorNextReturnType for XML. Can you create an issue for this?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r555908659", "createdAt": "2021-01-12T16:32:28Z", "author": {"login": "MaryamZi"}, "path": "langlib/lang.xml/src/main/java/org/ballerinalang/langlib/xml/Next.java", "diffHunk": "@@ -49,10 +50,21 @@ public static Object next(BObject m) {\n \n         if (xmlIterator.hasNext()) {\n             Object xmlValue = xmlIterator.next();\n-            return ValueCreator.createRecordValue(ValueCreator.createMapValue(PredefinedTypes.XML_ITR_NEXT_RETURN_TYPE),\n-                                                  xmlValue);\n+            switch (((BXml) xmlValue).getType().getTag()) {\n+                case TypeTags.XML_ELEMENT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                                    (PredefinedTypes.XML_ITR_NEXT_RETURN_ELEMENT_TYPE), xmlValue);\n+                case TypeTags.XML_TEXT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_TEXT_TYPE), xmlValue);\n+                case TypeTags.XML_COMMENT_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_COMMENT_TYPE), xmlValue);\n+                case TypeTags.XML_PI_TAG:\n+                    return ValueCreator.createRecordValue(ValueCreator.createMapValue\n+                            (PredefinedTypes.XML_ITR_NEXT_RETURN_PI_TYPE), xmlValue);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwODI5OA=="}, "originalCommit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkzOTgxMA==", "bodyText": "Using XmlComment.this may work instead of introducing the new variable that.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r555939810", "createdAt": "2021-01-12T17:15:57Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/values/XmlComment.java", "diffHunk": "@@ -45,6 +46,28 @@ public XmlComment(String data, boolean readonly) {\n         this.type = readonly ? PredefinedTypes.TYPE_READONLY_COMMENT : PredefinedTypes.TYPE_COMMENT;\n     }\n \n+    @Override\n+    public IteratorValue getIterator() {\n+        XmlComment that = this;\n+        return new IteratorValue() {\n+            boolean read = false;\n+            @Override\n+            public boolean hasNext() {\n+                return !read;\n+            }\n+\n+            @Override\n+            public Object next() {\n+                if (!read) {\n+                    this.read = true;\n+                    return that;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NzA2MQ==", "bodyText": "Shouldn't the following result in a compilation error?\npublic function main() {\n    'xml:Comment x = xml `<!-- foo -->`;\n    var iterator = x.iterator();\n}\nPlease check for the other non-text types too.\nThis seems to fail on slp8 too, let's create an issue.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r555947061", "createdAt": "2021-01-12T17:26:42Z", "author": {"login": "MaryamZi"}, "path": "langlib/langlib-test/src/test/resources/test-src/xmllib_test.bal", "diffHunk": "@@ -382,6 +397,53 @@ function testElementChildrenNS() {\n     assert(toNoNs.toString(), \"<to>Irshad</to><to>Irshad</to>\");\n }\n \n+function testXMLIteratorInvocation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e47d8d294df9bbfd9a4fc102063b26b63266aa02"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee", "author": {"user": {"login": "suleka96", "name": "Suleka Helmini"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d9a118602c10fce6b632a92f1562a1f42db2eaee", "committedDate": "2021-01-13T07:23:20Z", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into fix_xml\nMerge with upstream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MTM2MDk0", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-567136094", "createdAt": "2021-01-13T11:35:30Z", "commit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMTozNTozMFrOISrXnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMTozNTozMFrOISrXnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ1NTgzNw==", "bodyText": "Do we need to add the type also when type.tag == TypeTags.XML is true?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556455837", "createdAt": "2021-01-13T11:35:30Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -492,6 +517,12 @@ private void findTypeParamInUnion(Location loc, BType expType, BUnionType actual\n             if (type.tag == TypeTags.MAP) {\n                 members.add(((BMapType) type).constraint);\n             }\n+            if (TypeTags.isXMLTypeTag(type.tag)) {\n+                if (type.tag == TypeTags.XML) {\n+                    members.add(((BXMLType) type).constraint);\n+                }\n+                members.add(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MTM4OTEy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-567138912", "createdAt": "2021-01-13T11:39:23Z", "commit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMTozOToyM1rOISrgAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMTo1NjoxN1rOISsC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ1Nzk4NA==", "bodyText": "Is this variable name accurate?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556457984", "createdAt": "2021-01-13T11:39:23Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1494,7 +1494,55 @@ public void setForeachTypedBindingPatternType(BLangForeach foreachNode) {\n                 varType = inferRecordFieldType(recordType);\n                 break;\n             case TypeTags.XML:\n-                varType = BUnionType.create(null, symTable.xmlType, symTable.stringType);\n+                BType constraint = ((BXMLType) collectionType).constraint;\n+                while (constraint.tag == TypeTags.XML) {\n+                    collectionType = constraint;\n+                    constraint = ((BXMLType) collectionType).constraint;\n+                }\n+                switch (constraint.tag) {\n+                    case TypeTags.XML_ELEMENT:\n+                        varType = symTable.xmlElementType;\n+                        break;\n+                    case TypeTags.XML_COMMENT:\n+                        varType = symTable.xmlCommentType;\n+                        break;\n+                    case TypeTags.XML_TEXT:\n+                        varType = symTable.xmlTextType;\n+                        break;\n+                    case TypeTags.XML_PI:\n+                        varType = symTable.xmlPIType;\n+                        break;\n+                    default:\n+                        Set<BType> collectionTypes = getEffectiveMemberTypes((BUnionType) constraint);\n+                        Set<BType> builtinXMLConstraintTypes = getEffectiveMemberTypes\n+                                ((BUnionType) ((BXMLType) symTable.xmlType).constraint);\n+                        if (collectionTypes.size() == 4 && builtinXMLConstraintTypes.equals(collectionTypes)) {\n+                            varType = symTable.xmlType;\n+                        } else {\n+                            LinkedHashSet<BType> collectionTypesInSymTable = new LinkedHashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ1ODg1NA==", "bodyText": "Why can't we directly use constraint as the var type here?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556458854", "createdAt": "2021-01-13T11:41:07Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1494,7 +1494,55 @@ public void setForeachTypedBindingPatternType(BLangForeach foreachNode) {\n                 varType = inferRecordFieldType(recordType);\n                 break;\n             case TypeTags.XML:\n-                varType = BUnionType.create(null, symTable.xmlType, symTable.stringType);\n+                BType constraint = ((BXMLType) collectionType).constraint;\n+                while (constraint.tag == TypeTags.XML) {\n+                    collectionType = constraint;\n+                    constraint = ((BXMLType) collectionType).constraint;\n+                }\n+                switch (constraint.tag) {\n+                    case TypeTags.XML_ELEMENT:\n+                        varType = symTable.xmlElementType;\n+                        break;\n+                    case TypeTags.XML_COMMENT:\n+                        varType = symTable.xmlCommentType;\n+                        break;\n+                    case TypeTags.XML_TEXT:\n+                        varType = symTable.xmlTextType;\n+                        break;\n+                    case TypeTags.XML_PI:\n+                        varType = symTable.xmlPIType;\n+                        break;\n+                    default:\n+                        Set<BType> collectionTypes = getEffectiveMemberTypes((BUnionType) constraint);\n+                        Set<BType> builtinXMLConstraintTypes = getEffectiveMemberTypes\n+                                ((BUnionType) ((BXMLType) symTable.xmlType).constraint);\n+                        if (collectionTypes.size() == 4 && builtinXMLConstraintTypes.equals(collectionTypes)) {\n+                            varType = symTable.xmlType;\n+                        } else {\n+                            LinkedHashSet<BType> collectionTypesInSymTable = new LinkedHashSet<>();\n+                            for (BType subType : collectionTypes) {\n+                                switch (subType.tag) {\n+                                    case TypeTags.XML_ELEMENT:\n+                                        collectionTypesInSymTable.add(symTable.xmlElementType);\n+                                        break;\n+                                    case TypeTags.XML_COMMENT:\n+                                        collectionTypesInSymTable.add(symTable.xmlCommentType);\n+                                        break;\n+                                    case TypeTags.XML_TEXT:\n+                                        collectionTypesInSymTable.add(symTable.xmlTextType);\n+                                        break;\n+                                    case TypeTags.XML_PI:\n+                                        collectionTypesInSymTable.add(symTable.xmlPIType);\n+                                        break;\n+                                }\n+\n+                            }\n+                            varType = BUnionType.create(null, collectionTypesInSymTable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ2MzQ0NQ==", "bodyText": "We should ideally test iterating the entire sequence. Including () being returned after everything has been iterated.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556463445", "createdAt": "2021-01-13T11:49:37Z", "author": {"login": "MaryamZi"}, "path": "langlib/langlib-test/src/test/resources/test-src/xmllib_test.bal", "diffHunk": "@@ -382,6 +397,53 @@ function testElementChildrenNS() {\n     assert(toNoNs.toString(), \"<to>Irshad</to><to>Irshad</to>\");\n }\n \n+function testXMLIteratorInvocation() {\n+    xml a = xml `<!--first-->`;\n+    xml<'xml:Comment> seq1 = <xml<'xml:Comment>> a.concat(xml `<!--second-->`);\n+\n+    object {\n+        public isolated function next() returns record {| 'xml:Comment value; |}?;\n+    } iter1 = seq1.iterator();\n+\n+    assert((iter1.next()).toString(), \"{\\\"value\\\":`<!--first-->`}\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ2NTEzNw==", "bodyText": "Ideally, this error shouldn't be logged. The actual error is the next one, 'xml:Element' is not an iterable collection.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556465137", "createdAt": "2021-01-13T11:53:00Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/types/xml/XMLIterationTest.java", "diffHunk": "@@ -54,14 +54,64 @@ public void setup() {\n \n     @Test\n     public void testNegative() {\n-        Assert.assertEquals(negative.getErrorCount(), 2);\n+        Assert.assertEquals(negative.getErrorCount(), 17);\n         int index = 0;\n         BAssertUtil.validateError(negative, index++,\n-                                  \"invalid tuple binding pattern: expected a tuple type, but found '(xml|string)'\",\n-                                  11, 17);\n+                                  \"invalid tuple binding pattern: attempted to infer a tuple type, but found 'xml'\",\n+                                  13, 17);\n         BAssertUtil.validateError(negative, index++, \"incompatible types: expected \" +\n                 \"'function ((xml:Element|xml:Comment|xml:ProcessingInstruction|xml:Text)) returns ()',\" +\n-                \" found 'function ([int,xml,string]) returns ()'\", 16, 19);\n+                \" found 'function ([int,xml,string]) returns ()'\", 18, 19);\n+        BAssertUtil.validateError(negative, index++,\n+                \"incompatible types: expected 'other', found 'xml:Element'\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ2NjQ5NQ==", "bodyText": "Why do we need a module level variable? Why can't we use local variables and pass them as arguments to concatString?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556466495", "createdAt": "2021-01-13T11:55:30Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration.bal", "diffHunk": "@@ -103,6 +100,7 @@ function chainedIterableOps() returns xml {\n xml theXml = xml `<book>the book</book>`;\n xml bitOfText = xml `bit of text\\u2702\\u2705`;\n xml compositeXml = theXml + bitOfText;\n+string output = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ2NjkwNw==", "bodyText": "Same comment as above re: using local variables instead.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#discussion_r556466907", "createdAt": "2021-01-13T11:56:17Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/xml/xml_iteration_negative.bal", "diffHunk": "@@ -7,6 +7,8 @@ xml xdata = xml `<p:person xmlns:p=\"foo\" xmlns:q=\"bar\">\n                     <q:ID>1131313</q:ID>\n                   </p:person>`;\n \n+string result = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MTk4ODI0", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26825#pullrequestreview-567198824", "createdAt": "2021-01-13T13:02:39Z", "commit": {"oid": "d9a118602c10fce6b632a92f1562a1f42db2eaee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3239, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}