{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MTI3MDk1", "number": 26732, "title": "Improve error path when publishing traces", "bodyText": "Purpose\n\nHandle the error path when publishing the traces in choreo extension. By this approach it will inhibit the infinite growth of the span list if there is a service downtime.\n\nApproach\n\nOnce the predefined bound is reached, randomly pick spans and delete the related spans based on the TraceID.\n\nCheck List\n\n  Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-11-04T04:34:52Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26732", "merged": true, "mergeCommit": {"oid": "79e21afb9bc0a60ba5ec0e9445b9e068ba08d6c6"}, "closed": true, "closedAt": "2020-11-10T03:58:10Z", "author": {"login": "sachiniSam"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZGxQBABqjM5NTU4NTQxNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdauK5UAFqTUyNTkzODMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6064ced4bb802f54b8bacbe4d4e5c350ae845e7e", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6064ced4bb802f54b8bacbe4d4e5c350ae845e7e", "committedDate": "2020-11-03T12:50:34Z", "message": "Improve error path when publishing traces"}, "afterCommit": {"oid": "7cbabbea884863006ea3abde911ff698dfe436f7", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7cbabbea884863006ea3abde911ff698dfe436f7", "committedDate": "2020-11-04T05:16:54Z", "message": "Improve error path when publishing traces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41e628ba68d77e08371a1de857de51c14d8e9945", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/41e628ba68d77e08371a1de857de51c14d8e9945", "committedDate": "2020-11-04T06:38:55Z", "message": "Improve error path when publishing traces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cbabbea884863006ea3abde911ff698dfe436f7", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7cbabbea884863006ea3abde911ff698dfe436f7", "committedDate": "2020-11-04T05:16:54Z", "message": "Improve error path when publishing traces"}, "afterCommit": {"oid": "41e628ba68d77e08371a1de857de51c14d8e9945", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/41e628ba68d77e08371a1de857de51c14d8e9945", "committedDate": "2020-11-04T06:38:55Z", "message": "Improve error path when publishing traces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1d7bf6391bdd5986928f035eff6a8932350162a", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b1d7bf6391bdd5986928f035eff6a8932350162a", "committedDate": "2020-11-06T06:15:32Z", "message": "Update error path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d860861af944bab38db4a3fc71b94b4e92fe0b2", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6d860861af944bab38db4a3fc71b94b4e92fe0b2", "committedDate": "2020-11-06T07:47:56Z", "message": "Add span drop log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MDg4NTkx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26732#pullrequestreview-525088591", "createdAt": "2020-11-06T11:57:41Z", "commit": {"oid": "6d860861af944bab38db4a3fc71b94b4e92fe0b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMTo1Nzo0MVrOHurTfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMTo1Nzo0MVrOHurTfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNjA0Nw==", "bodyText": "I think it's better if we make this a WARN log since it's technically not an error. Shall we change the log to indicate that the buffer is full and we dropped the spans (including the count) ?\nAlso shall we move this inside the swappedTraceSpans.size() > SPAN_LIST_BOUND if condition ? That way the log will be only printed if the traces are dropped. (we can move the spanCount variable declaration inside too then)", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26732#discussion_r518706047", "createdAt": "2020-11-06T11:57:41Z", "author": {"login": "nadundesilva"}, "path": "misc/tracing-extensions/modules/ballerina-choreo-extension/src/main/java/org/ballerinalang/observe/trace/extension/choreo/ChoreoJaegerReporter.java", "diffHunk": "@@ -129,31 +132,50 @@ private void append(JaegerSpan jaegerSpan) {\n \n         @Override\n         public void run() {\n-            ChoreoTraceSpan[] spansToBeSent;\n+            List<ChoreoTraceSpan> swappedTraceSpans;\n+\n             synchronized (this) {\n                 if (traceSpans.size() > 0) {\n-                    spansToBeSent = traceSpans.toArray(new ChoreoTraceSpan[0]);\n-                    traceSpans.clear();\n+                    swappedTraceSpans = traceSpans;\n+                    traceSpans = new ArrayList<>();\n                 } else {\n-                    spansToBeSent = new ChoreoTraceSpan[0];\n+                    swappedTraceSpans = Collections.emptyList();\n                 }\n             }\n-            if (spansToBeSent.length > 0) {\n+            if (swappedTraceSpans.size() > 0) {\n                 if (!Objects.isNull(choreoClient)) {\n                     try {\n-                        choreoClient.publishTraceSpans(spansToBeSent);\n+                        choreoClient.publishTraceSpans(swappedTraceSpans);\n                     } catch (Throwable t) {\n                         synchronized (this) {\n-                            traceSpans.addAll(Arrays.asList(spansToBeSent));\n+                            int spanCount = 0;\n+                            if (swappedTraceSpans.size() > SPAN_LIST_BOUND) {\n+                                Random random = new Random();\n+                                // Remove 10% of the SPAN_LIST_BOUND\n+                                while (spanCount < SPANS_TO_REMOVE) {\n+                                    if (swappedTraceSpans.size() > 0) {\n+                                        int randomSpanPos = random.nextInt(swappedTraceSpans.size());\n+                                        long traceID = swappedTraceSpans.get(randomSpanPos).getTraceId();\n+                                        for (int j = 0; j < swappedTraceSpans.size(); j++) {\n+                                            if (swappedTraceSpans.get(j).getTraceId() == traceID) {\n+                                                swappedTraceSpans.remove(j);\n+                                                // Reduce the count as well since the size of the arrayList shrink\n+                                                j--;\n+                                                spanCount++;\n+                                            }\n+                                        }\n+                                    }\n+                                }\n+                            }\n+\n+                            traceSpans.addAll(swappedTraceSpans);\n+                            LOGGER.error(\"dropped \" + spanCount + \" spans\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d860861af944bab38db4a3fc71b94b4e92fe0b2"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd7882e44c65c17e83c203fb7421afebe1b76c95", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fd7882e44c65c17e83c203fb7421afebe1b76c95", "committedDate": "2020-11-07T11:56:18Z", "message": "Update log with span dropped info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c7a2bd6811b6de2892947d9f765740ab330c110", "author": {"user": {"login": "sachiniSam", "name": "Sachini Samson"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6c7a2bd6811b6de2892947d9f765740ab330c110", "committedDate": "2020-11-09T05:23:25Z", "message": "Fix the infinite loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTM4MzI1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26732#pullrequestreview-525938325", "createdAt": "2020-11-09T05:46:48Z", "commit": {"oid": "6c7a2bd6811b6de2892947d9f765740ab330c110"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3300, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}