{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzMzMzODk0", "number": 27605, "title": "Allow expression in listener declaration to return an error", "bodyText": "Purpose\nImplement the spec changes proposed in ballerina-platform/ballerina-spec#671\nNote: Scenario where the Listener init returning error is not tested in this PR.\nApproach\n\nDescribe how you are implementing the solutions along with the design details.\n\nSamples\n\nProvide high-level details about the samples related to this feature.\n\nRemarks\n\nList any other known issues, related PRs, TODO items, or any other notes related to the PR.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-12-21T08:43:04Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605", "merged": true, "mergeCommit": {"oid": "27dec2abe4e72746e1634a2152bc3a7fdeaa84be"}, "closed": true, "closedAt": "2021-01-15T10:30:25Z", "author": {"login": "rdhananjaya"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm9wGJAH2gAyNTQzMzMzODk0OjViMDViMzBkMGE2NjVhODgzMWQyNDVhYjJhN2QyYjMxOTE0YjIzNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdwVsJzAFqTU2OTEwNDQ2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b05b30d0a665a8831d245ab2a7d2b31914b2351", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5b05b30d0a665a8831d245ab2a7d2b31914b2351", "committedDate": "2020-12-17T06:43:06Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61333f20bc2afe559c8b6314a5d174bffd0883c8", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/61333f20bc2afe559c8b6314a5d174bffd0883c8", "committedDate": "2020-12-21T06:00:14Z", "message": "Re-enable listener balo test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2f5a1c670c37c7b8aa8ae2ca8c388d3f949b40a", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f2f5a1c670c37c7b8aa8ae2ca8c388d3f949b40a", "committedDate": "2020-12-21T08:40:42Z", "message": "Allow listener decl to use listener|error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64efd1ffd64a4bbe90dfe42b7a921798514dd563", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64efd1ffd64a4bbe90dfe42b7a921798514dd563", "committedDate": "2021-01-05T01:26:21Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/60cd794465406561e98f7d33e5449b12ef1429a8", "committedDate": "2021-01-13T04:17:14Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach\n\n\u0001 Conflicts:\n\u0001\ttests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MDkzMzEx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-567093311", "createdAt": "2021-01-13T10:38:57Z", "commit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDozODo1N1rOISpXxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxMDo0NzoyOFrOISprug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyMzEwOQ==", "bodyText": "Seems like some calls to this function still pass the actual as the first arg, shall we check and update?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556423109", "createdAt": "2021-01-13T10:38:57Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -179,7 +202,7 @@ function testServiceDecl() {\n     reset();\n }\n \n-function assertEquality(any|error actual, any|error expected) {\n+function assertEquality(any|error expected, any|error actual) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQyODIxOA==", "bodyText": "Shouldn't LE be a subtype of the Listener object?\nThe spec says\n\nA module listener declares a variable in a similar way to a final variable declaration, but the type of the variable is always a subtype of the Listener object type, and it has the additional semantic of registering the variable's value with the module as a listener.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556428218", "createdAt": "2021-01-13T10:47:28Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/services/service_decl.bal", "diffHunk": "@@ -95,7 +117,8 @@ function getResourceAnnot(service object {} obj, string methodName, string[] pat\n } external;\n \n \n-listener Listener lsn = new Listener();\n+type LE Listener|EmptyListener|error;\n+listener LE lsn = new Listener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60cd794465406561e98f7d33e5449b12ef1429a8"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e167f3ac78e7b40d79214375de3d4fb89d3a771", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3e167f3ac78e7b40d79214375de3d4fb89d3a771", "committedDate": "2021-01-13T10:55:21Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach\n\n\u0001 Conflicts:\n\u0001\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f676273e6c3cc85d3093dd6b191ffebcd797c689", "committedDate": "2021-01-13T14:23:21Z", "message": "Remove error from listener decl's type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MzIwNDYw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-567320460", "createdAt": "2021-01-13T15:13:01Z", "commit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxMzowMVrOISzxmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxMzowMVrOISzxmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5MzU2MQ==", "bodyText": "Would this work well when the union type has > 1 listener compatible type (say 2), and the user actually assigns a value of the second type to the variable?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556593561", "createdAt": "2021-01-13T15:13:01Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MzI2NzU2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-567326756", "createdAt": "2021-01-13T15:19:09Z", "commit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxOTowOVrOIS0EXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNToxOTowOVrOIS0EXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU5ODM2Ng==", "bodyText": "No impact right now, but should we add the actual error types here? We can do this later maybe.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556598366", "createdAt": "2021-01-13T15:19:09Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));\n+        listenerCheckExpr.equivalentErrorTypeList.add(symTable.errorType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f676273e6c3cc85d3093dd6b191ffebcd797c689"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9068dc08eecad70a049ab6acfbfbd9dd0616e545", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9068dc08eecad70a049ab6acfbfbd9dd0616e545", "committedDate": "2021-01-13T17:19:53Z", "message": "Change listener order in the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42a07e12dbb436ae084484047559e7aa5fc6e8b9", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/42a07e12dbb436ae084484047559e7aa5fc6e8b9", "committedDate": "2021-01-13T17:48:30Z", "message": "Validate attaching union of listeners to service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2002cb0e185984d6d89c5d0f0f56eada9f23af3", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a2002cb0e185984d6d89c5d0f0f56eada9f23af3", "committedDate": "2021-01-13T17:53:25Z", "message": "Fix param order of assertEquality function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NTI3ODg5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-567527889", "createdAt": "2021-01-13T18:58:02Z", "commit": {"oid": "a2002cb0e185984d6d89c5d0f0f56eada9f23af3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxODo1ODowMlrOIS9zVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxODo1ODowMlrOIS9zVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1Nzg0NA==", "bodyText": "The following results in a bad, sad error here.\npublic class Listener {\n\n    public isolated function 'start() returns error? { }\n\n    public isolated function gracefulStop() returns error? { }\n\n    public isolated function immediateStop() returns error? { }\n\n    public isolated function detach(service object { isolated function foo(); } s) returns error? { }\n\n    public isolated function attach(service object { isolated function foo(); } s, string[]|string? name = ()) returns error? { }\n\n    isolated function register(service object {} s, string[]|string? name) returns error? { }\n}\n\ntype ListenerType int|Listener;\n\nlistener ListenerType ln = new Listener();\n\nservice / on ln {\n\n}\n[2021-01-14 00:26:20,469] SEVERE {b7a.log.crash} - class org.wso2.ballerinalang.compiler.semantics.model.types.BType cannot be cast to class org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType (org.wso2.ballerinalang.compiler.semantics.model.types.BType and org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType are in unnamed module of loader 'app') \njava.lang.ClassCastException: class org.wso2.ballerinalang.compiler.semantics.model.types.BType cannot be cast to class org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType (org.wso2.ballerinalang.compiler.semantics.model.types.BType and org.wso2.ballerinalang.compiler.semantics.model.types.BObjectType are in unnamed module of loader 'app')\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.visit(SemanticAnalyzer.java:3019)\n\tat org.wso2.ballerinalang.compiler.tree.BLangService.accept(BLangService.java:142)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeNode(SemanticAnalyzer.java:3250)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeNode(SemanticAnalyzer.java:3218)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyzeDef(SemanticAnalyzer.java:3210)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.visit(SemanticAnalyzer.java:291)\n\tat org.wso2.ballerinalang.compiler.tree.BLangPackage.accept(BLangPackage.java:163)\n\tat org.wso2.ballerinalang.compiler.semantics.analyzer.SemanticAnalyzer.analyze(SemanticAnalyzer.java:256)\n\tat io.ballerina.projects.internal.CompilerPhaseRunner.typeCheck(CompilerPhaseRunner.java:217)\n\tat io.ballerina.projects.internal.CompilerPhaseRunner.performTypeCheckPhases(CompilerPhaseRunner.java:115)\n\tat io.ballerina.projects.ModuleContext.compileInternal(ModuleContext.java:348)\n\tat io.ballerina.projects.ModuleCompilationState$1.compile(ModuleCompilationState.java:45)\n\tat io.ballerina.projects.ModuleCompilationState$1.generatePlatformSpecificCode(ModuleCompilationState.java:53)\n\tat io.ballerina.projects.ModuleContext.generatePlatformSpecificCode(ModuleContext.java:301)\n\tat io.ballerina.projects.JBallerinaBackend.performCodeGen(JBallerinaBackend.java:131)\n\tat io.ballerina.projects.JBallerinaBackend.<init>(JBallerinaBackend.java:117)\n\tat io.ballerina.projects.JBallerinaBackend.lambda$from$0(JBallerinaBackend.java:93)\n\tat java.base/java.util.HashMap.computeIfAbsent(HashMap.java:1133)\n\tat io.ballerina.projects.PackageCompilation.getCompilerBackend(PackageCompilation.java:126)\n\tat io.ballerina.projects.JBallerinaBackend.from(JBallerinaBackend.java:92)\n\tat io.ballerina.cli.task.CompileTask.execute(CompileTask.java:69)\n\tat io.ballerina.cli.TaskExecutor.executeTasks(TaskExecutor.java:40)\n\tat io.ballerina.cli.cmd.RunCommand.execute(RunCommand.java:154)\n\tat java.base/java.util.Optional.ifPresent(Optional.java:183)\n\tat io.ballerina.cli.launcher.Main.main(Main.java:58)", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r556757844", "createdAt": "2021-01-13T18:58:02Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2891,9 +2911,17 @@ public void visit(BLangService serviceNode) {\n                 dlog.error(attachExpr.pos, DiagnosticErrorCode.INVALID_LISTENER_ATTACHMENT);\n             }\n \n+            // Validate listener attachment based on attach-point of the service decl and second param of listener.\n             if (exprType.getKind() == TypeKind.OBJECT) {\n                 BObjectType listenerType = (BObjectType) exprType;\n                 validateServicePathOnListener(serviceNode, attachExpr, listenerType);\n+            } else if (exprType.getKind() == TypeKind.UNION) {\n+                for (BType memberType : ((BUnionType) exprType).getMemberTypes()) {\n+                    if (memberType.tag == TypeTags.ERROR) {\n+                        continue;\n+                    }\n+                    validateServicePathOnListener(serviceNode, attachExpr, (BObjectType) memberType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2002cb0e185984d6d89c5d0f0f56eada9f23af3"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "416f4947cbc7d8f1cb0206f836132ea7ec01402a", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/416f4947cbc7d8f1cb0206f836132ea7ec01402a", "committedDate": "2021-01-14T15:02:57Z", "message": "Validate service-decl type with listener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8511cecc39b8a9bbf9b43e24f7be8875e1f42491", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8511cecc39b8a9bbf9b43e24f7be8875e1f42491", "committedDate": "2021-01-14T13:59:16Z", "message": "Validate service-decl type with listener"}, "afterCommit": {"oid": "416f4947cbc7d8f1cb0206f836132ea7ec01402a", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/416f4947cbc7d8f1cb0206f836132ea7ec01402a", "committedDate": "2021-01-14T15:02:57Z", "message": "Validate service-decl type with listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7c626ba0aa49b9d2000785cf60a9f0b86591db", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9e7c626ba0aa49b9d2000785cf60a9f0b86591db", "committedDate": "2021-01-14T16:38:38Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d72c59a9b56d07ef84a914b26980363ef7e9f76c", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d72c59a9b56d07ef84a914b26980363ef7e9f76c", "committedDate": "2021-01-14T16:50:27Z", "message": "Fix class cast error"}, "afterCommit": {"oid": "971bac9954d0b051d701f1913402939697e696ba", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/971bac9954d0b051d701f1913402939697e696ba", "committedDate": "2021-01-14T16:57:59Z", "message": "Fix class cast error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/357158c2ab35aef6b0aebfcceb598978a146a411", "committedDate": "2021-01-14T16:59:23Z", "message": "Fix class cast error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "971bac9954d0b051d701f1913402939697e696ba", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/971bac9954d0b051d701f1913402939697e696ba", "committedDate": "2021-01-14T16:57:59Z", "message": "Fix class cast error"}, "afterCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/357158c2ab35aef6b0aebfcceb598978a146a411", "committedDate": "2021-01-14T16:59:23Z", "message": "Fix class cast error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4NDQ5MDMy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-568449032", "createdAt": "2021-01-14T17:13:20Z", "commit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzoxMzoyMFrOITumgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzoxNTozMlrOITur9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ==", "bodyText": "Since the listener type should be a subtype of listener, check needs to be added only to the listener initialization (and when the expression type includes error), right?\nDo we need this change?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557557379", "createdAt": "2021-01-14T17:13:20Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1ODc3NA==", "bodyText": "Adding check here wouldn't add it for the initialization anyway, right?\nThe following results in a bad, sad error.\npublic class Listener {\n    public function init() returns error? => error(\"err\");\n\n    public isolated function 'start() returns error? { }\n\n    public isolated function gracefulStop() returns error? { }\n\n    public isolated function immediateStop() returns error? { }\n\n    public isolated function detach(service object {} s) returns error? { }\n\n    public isolated function attach(service object {} s, string[]|string? name = ()) returns error? { }\n}\n\nlistener Listener ln =  new;\n[2021-01-14 23:10:56,517] SEVERE {b7a.log.crash} - class io.ballerina.runtime.internal.values.ErrorValue cannot be cast to class io.ballerina.runtime.api.values.BObject (io.ballerina.runtime.internal.values.ErrorValue and io.ballerina.runtime.api.values.BObject are in unnamed module of loader 'app') \njava.lang.ClassCastException: class io.ballerina.runtime.internal.values.ErrorValue cannot be cast to class io.ballerina.runtime.api.values.BObject (io.ballerina.runtime.internal.values.ErrorValue and io.ballerina.runtime.api.values.BObject are in unnamed module of loader 'app')\n\tat $$$.$gen$$0046$0046$0060init$00620(.:15)\n\tat $_init.$gen$$0046$0060init$0062(.:0)\n\tat $_init.$moduleInit(.)\n\tat $_init.$lambda$$moduleInit$(.)\n\tat io.ballerina.runtime.internal.scheduling.SchedulerItem.execute(Scheduler.java:571)\n\tat io.ballerina.runtime.internal.scheduling.Scheduler.run(Scheduler.java:301)\n\tat io.ballerina.runtime.internal.scheduling.Scheduler.runSafely(Scheduler.java:269)\n\tat java.base/java.lang.Thread.run(Thread.java:834)", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#discussion_r557558774", "createdAt": "2021-01-14T17:15:32Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/desugar/ServiceDesugar.java", "diffHunk": "@@ -187,13 +196,26 @@ void rewriteServiceVariable(BLangService service, SymbolEnv env, BLangBlockStmt\n         }\n     }\n \n+    private BType getListenerType(BType type) {\n+        if (type.tag == TypeTags.UNION) {\n+            for (BType memberType : ((BUnionType) type).getMemberTypes()) {\n+                if (types.checkListenerCompatibility(memberType)) {\n+                    return memberType;\n+                }\n+            }\n+        }\n+        return type;\n+    }\n+\n     private void addMethodInvocation(Location pos, BLangSimpleVarRef varRef, BInvokableSymbol methodRefSymbol,\n                                      List<BLangExpression> args,\n                                      BlockNode body) {\n         // Create method invocation\n         final BLangInvocation methodInvocation =\n                 ASTBuilderUtil.createInvocationExprForMethod(pos, methodRefSymbol, args, symResolver);\n-        methodInvocation.expr = varRef;\n+        BLangCheckedExpr listenerCheckExpr = ASTBuilderUtil.createCheckExpr(pos, varRef, getListenerType(varRef.type));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NzM3OQ=="}, "originalCommit": {"oid": "357158c2ab35aef6b0aebfcceb598978a146a411"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e51dd6c48df5840c9ded3d029136fe51656dfcc5", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e51dd6c48df5840c9ded3d029136fe51656dfcc5", "committedDate": "2021-01-15T08:05:28Z", "message": "Fix bad-sad when listener is a error value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80832aeb3353c273eed78071c4399423a5b876ee", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/80832aeb3353c273eed78071c4399423a5b876ee", "committedDate": "2021-01-15T08:08:52Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67904504bab7a28bbdb39b7d8637481db73ba29", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b67904504bab7a28bbdb39b7d8637481db73ba29", "committedDate": "2021-01-15T08:51:47Z", "message": "Merge branch 'master' of github.com:ballerina-platform/ballerina-lang into service-typing-listener-attach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95b10bc1d672a7d8fb5fbeaee55ebc91952fe5b", "author": {"user": {"login": "rdhananjaya", "name": "Dhananjaya [Danje]"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f95b10bc1d672a7d8fb5fbeaee55ebc91952fe5b", "committedDate": "2021-01-15T09:35:41Z", "message": "Add module execution test for errored listener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5MTA0NDYw", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27605#pullrequestreview-569104460", "createdAt": "2021-01-15T09:41:50Z", "commit": {"oid": "f95b10bc1d672a7d8fb5fbeaee55ebc91952fe5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4659, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}