{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMzU3Nzg1", "number": 27339, "title": "Fix transaction validating if rollback is used with if condition", "bodyText": "Purpose\n\nFix transaction validating if rollback command is used with if condition, commit should happen in else block\n\nFixes #26854\nRemarks\n\nTests available in ballerina-platform/module-ballerinai-transaction#8..\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-12-04T07:50:04Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339", "merged": true, "mergeCommit": {"oid": "781a5bdea74bfb3b2ff194708f0647619631b02b"}, "closed": true, "closedAt": "2020-12-04T13:08:16Z", "author": {"login": "lasinicl"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdixb6nAH2gAyNTMyMzU3Nzg1OjUzOTQ3ZTJiNTliYzczYmQyZTAzMTg2N2E2Y2QxNzI0YzU2ODQ4NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi3d7sAFqTU0NDk0Mjk1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53947e2b59bc73bd2e031867a6cd1724c5684875", "author": {"user": {"login": "lasinicl", "name": "Lasini Liyange"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/53947e2b59bc73bd2e031867a6cd1724c5684875", "committedDate": "2020-12-04T06:06:30Z", "message": "Fix issue with rollback in if else"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b", "author": {"user": {"login": "lasinicl", "name": "Lasini Liyange"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b", "committedDate": "2020-12-04T08:34:20Z", "message": "Change condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Nzc0NTQ1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339#pullrequestreview-544774545", "createdAt": "2020-12-04T09:10:02Z", "commit": {"oid": "5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxMDowMlrOH_HhWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxMDowMlrOH_HhWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NTU2MQ==", "bodyText": "Can you check this fix instead for the else part against the tests\n       analyzeNode(ifStmt.elseStmt, env);\n        boolean elseWithinTrxMode = this.withinTransactionScope;\n        this.statementReturns = ifStmtReturns && this.statementReturns;\n        this.errorThrown = currentErrorThrown && this.errorThrown;\n        this.withinTransactionScope = (!prevTxMode || ifWithinTrxMode || elseWithinTrxMode) && prevTxMode;", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339#discussion_r535945561", "createdAt": "2020-12-04T09:10:02Z", "author": {"login": "pcnfernando"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -817,19 +808,25 @@ public void visit(BLangIf ifStmt) {\n         }\n         boolean ifStmtReturns = this.statementReturns;\n         boolean currentErrorThrown = this.errorThrown;\n+        boolean ifWithinTrxMode = this.withinTransactionScope;\n         this.resetStatementReturns();\n         this.resetErrorThrown();\n+        if (prevTxMode) {\n+            this.resetWithinTrxScopeToTrue();\n+        }\n         if (ifStmt.elseStmt != null) {\n-            if (independentBlocks) {\n-                commitRollbackAllowed = true;\n-                withinTransactionScope = true;\n-            }\n             analyzeNode(ifStmt.elseStmt, env);\n-            if ((prevCommitCount != commitCount) || prevRollbackCount != rollbackCount) {\n-                commitRollbackAllowed = false;\n+            boolean hasVisitedCommitOrRollback = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0135c1794ed47e1c5ff350d4b60334f2a40249e3", "author": {"user": {"login": "lasinicl", "name": "Lasini Liyange"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0135c1794ed47e1c5ff350d4b60334f2a40249e3", "committedDate": "2020-12-04T10:20:44Z", "message": "Fix checking for unnecessary conditions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTQyOTU2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339#pullrequestreview-544942956", "createdAt": "2020-12-04T13:08:08Z", "commit": {"oid": "0135c1794ed47e1c5ff350d4b60334f2a40249e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4739, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}