{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MjM2MDA4", "number": 21199, "title": "Enable gRPC command to support oneof using optional fields", "bodyText": "Purpose\nFixes #20485\nApproach\n\nUse a map of field list to push data to handlebars\nUpdate the mustache templates to generate the ballerina files accordingly\n\nSamples\nFor a given protobuf file like below,\nsyntax = \"proto3\";\n\nmessage Student {\n\tstring name = 1;\n\toneof identity {\n\t\tID id = 2;\n\t\tPassport passport = 3;\n\t}\n}\n\nmessage ID {\n\tstring idType = 7;\n\tstring idNumber = 8;\n};\n\nmessage Passport {\n\tstring ppNumber = 9;\n\tstring country = 10;\n};\nit generates the following ballerina stub file.\npublic type Student record {|\n    string name = \"\";\n    ID id?;\n    Passport passport?;\n    \n|};\n\nfunction isValidStudent(Student r) returns boolean {\n    int identityCount = 0;\n    if !(r?.id is ()) {\n        identityCount += 1;\n    }\n    if !(r?.passport is ()) {\n        identityCount += 1;\n    }\n    \n    if (identityCount > 1 ) {\n        return false;\n    }\n    return true;\n}\n\nfunction setStudent_Id(Student r, ID id) {\n    r.id = id;\n    r.remove(\"passport\");\n    \n}\nfunction setStudent_Passport(Student r, Passport passport) {\n    r.passport = passport;\n    r.remove(\"id\");\n    \n}\n\n\npublic type ID record {|\n    string idType = \"\";\n    string idNumber = \"\";\n    \n|};\n\npublic type Passport record {|\n    string ppNumber = \"\";\n    string country = \"\";\n    \n|};\n\n\nconst string ROOT_DESCRIPTOR = \"0A126F6E656F662D73616D706C652E70726F746F22690A0753747564656E7412120A046E616D6518012001280952046E616D6512150A02696418022001280B32032E494448005202696412270A0870617373706F727418032001280B32092E50617373706F72744800520870617373706F7274420A0A086964656E7469747922380A02494412160A066964547970651807200128095206696454797065121A0A0869644E756D626572180820012809520869644E756D62657222400A0850617373706F7274121A0A0870704E756D626572180920012809520870704E756D62657212180A07636F756E747279180A200128095207636F756E747279620670726F746F33\";\nfunction getDescriptorMap() returns map<string> {\n    return {\n        \"oneof-sample.proto\":\"0A126F6E656F662D73616D706C652E70726F746F22690A0753747564656E7412120A046E616D6518012001280952046E616D6512150A02696418022001280B32032E494448005202696412270A0870617373706F727418032001280B32092E50617373706F72744800520870617373706F7274420A0A086964656E7469747922380A02494412160A066964547970651807200128095206696454797065121A0A0869644E756D626572180820012809520869644E756D62657222400A0850617373706F7274121A0A0870704E756D626572180920012809520870704E756D62657212180A07636F756E747279180A200128095207636F756E747279620670726F746F33\"\n        \n    };\n}\nRemarks\nThis feature (#18873) should be supported before actually use the generated stub file.\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-02-21T11:27:48Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199", "merged": true, "mergeCommit": {"oid": "545b009583664c713a66e92738f8910d1195c953"}, "closed": true, "closedAt": "2020-03-11T23:59:49Z", "author": {"login": "BuddhiWathsala"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHoIX3AFqTM2MzgyMjQ4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMqOqUAH2gAyMzc4MjM2MDA4OmIyMDdkNTQzNDczYTU1NmU0ZDYyNzAyNzM0ZmVlYmIzYzJkNDkyNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODIyNDgy", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#pullrequestreview-363822482", "createdAt": "2020-02-25T01:48:53Z", "commit": {"oid": "ca1173ae7ff6266148258279a0f0d021eac0b7b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMTo0ODo1M1rOFt2F9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMTo0ODo1M1rOFt2F9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNjUwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{> message}}{{/each}}{{/if}}\n          \n          \n            \n            {{> message}}{{/each}}{{/if}}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383616503", "createdAt": "2020-02-25T01:48:53Z", "author": {"login": "daneshk"}, "path": "stdlib/grpc/src/main/resources/templates/skeleton/message.mustache", "diffHunk": "@@ -1,10 +1,29 @@\n public type {{messageName}} record {|\n     {{#fieldList}}{{fieldType}}{{#isNull defaultValue}}?{{/isNull}}{{fieldLabel}} {{{fieldName}}}{{#isNull defaultValue}} = (){{/isNull}}{{#isNotNull defaultValue}} = {{#equals fieldType \"string\"}}{{#if fieldLabel}}{{defaultValue}}{{else}}\"{{defaultValue}}\"{{/if}}{{/equals}}{{#not_equal fieldType \"string\"}}{{defaultValue}}{{/not_equal}}{{/isNotNull}};\n-    {{/fieldList}}{{#each oneofFieldMap as |value key|}}{{camelcase @key}} {{@key}};\n-    {{/each}}\n+    {{/fieldList ~}}\n+    {{#each oneofFieldMap as |value key|}}{{#each @value}}{{{fieldType}}}{{#isNull defaultValue}}{{/isNull}} {{{fieldName}}}?;\n+    {{/each ~}}\n+{{/each}}\n |};\n-{{#each oneofFieldMap}}\n-{{> oneoffield}}{{/each}}\n-{{#enumList}}\n+{{#if oneofFieldMap}}\n+function isValid{{camelcase messageName}}({{messageName}} r) returns boolean {\n+{{#each oneofFieldMap as |value key|}}    int {{@key}}Count = 0;\n+    {{#each @value}}if !(r?.{{{fieldName}}} is ()) {\n+        {{@key}}Count += 1;\n+    }\n+    {{/each}}\n+{{/each}}    if ({{#each oneofFieldMap as |value key|}}{{#unless @first}}|| {{/unless}}{{@key}}Count > 1 {{/each}}) {\n+        return false;\n+    }\n+    return true;\n+}\n+{{#each oneofFieldMap}}{{#each this}}\n+function set{{messageName}}_{{{camelcase fieldName}}}({{messageName}} r, {{{fieldType}}} {{{fieldName}}}) {\n+    r.{{{fieldName}}} = {{{fieldName}}};\n+    {{#each ../this}}{{#not_equal fieldName ../fieldName}}r.remove(\"{{fieldName}}\");\n+    {{/not_equal}}{{/each}}\n+}{{/each}}\n+{{/each}}\n+{{/if}}{{#enumList}}\n {{> enum}}{{/enumList}}{{#if this.nestedMessageList}}{{#each this.nestedMessageList}}\n {{> message}}{{/each}}{{/if}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca1173ae7ff6266148258279a0f0d021eac0b7b9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODI3MzQ5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#pullrequestreview-363827349", "createdAt": "2020-02-25T02:06:09Z", "commit": {"oid": "ca1173ae7ff6266148258279a0f0d021eac0b7b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjowNjowOVrOFt2XAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjowNjowOVrOFt2XAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMDg2Ng==", "bodyText": "Shall we move this logic to oneoffield.mustache file? refer that file here", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383620866", "createdAt": "2020-02-25T02:06:09Z", "author": {"login": "daneshk"}, "path": "stdlib/grpc/src/main/resources/templates/skeleton/message.mustache", "diffHunk": "@@ -1,10 +1,29 @@\n public type {{messageName}} record {|\n     {{#fieldList}}{{fieldType}}{{#isNull defaultValue}}?{{/isNull}}{{fieldLabel}} {{{fieldName}}}{{#isNull defaultValue}} = (){{/isNull}}{{#isNotNull defaultValue}} = {{#equals fieldType \"string\"}}{{#if fieldLabel}}{{defaultValue}}{{else}}\"{{defaultValue}}\"{{/if}}{{/equals}}{{#not_equal fieldType \"string\"}}{{defaultValue}}{{/not_equal}}{{/isNotNull}};\n-    {{/fieldList}}{{#each oneofFieldMap as |value key|}}{{camelcase @key}} {{@key}};\n-    {{/each}}\n+    {{/fieldList ~}}\n+    {{#each oneofFieldMap as |value key|}}{{#each @value}}{{{fieldType}}}{{#isNull defaultValue}}{{/isNull}} {{{fieldName}}}?;\n+    {{/each ~}}\n+{{/each}}\n |};\n-{{#each oneofFieldMap}}\n-{{> oneoffield}}{{/each}}\n-{{#enumList}}\n+{{#if oneofFieldMap}}\n+function isValid{{camelcase messageName}}({{messageName}} r) returns boolean {\n+{{#each oneofFieldMap as |value key|}}    int {{@key}}Count = 0;\n+    {{#each @value}}if !(r?.{{{fieldName}}} is ()) {\n+        {{@key}}Count += 1;\n+    }\n+    {{/each}}\n+{{/each}}    if ({{#each oneofFieldMap as |value key|}}{{#unless @first}}|| {{/unless}}{{@key}}Count > 1 {{/each}}) {\n+        return false;\n+    }\n+    return true;\n+}\n+{{#each oneofFieldMap}}{{#each this}}\n+function set{{messageName}}_{{{camelcase fieldName}}}({{messageName}} r, {{{fieldType}}} {{{fieldName}}}) {\n+    r.{{{fieldName}}} = {{{fieldName}}};\n+    {{#each ../this}}{{#not_equal fieldName ../fieldName}}r.remove(\"{{fieldName}}\");\n+    {{/not_equal}}{{/each}}\n+}{{/each}}\n+{{/each}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca1173ae7ff6266148258279a0f0d021eac0b7b9"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MTI5ODQ4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#pullrequestreview-364129848", "createdAt": "2020-02-25T13:15:34Z", "commit": {"oid": "188fb2a1218a87545571091a498eb5512d05f926"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497a705cd81929246256ae7c9e7a19ca80d19a40", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/497a705cd81929246256ae7c9e7a19ca80d19a40", "committedDate": "2020-03-11T05:49:19Z", "message": "set oneofFieldMap as a map of field list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1baa60a579d30f363e821dcae62736cda70403c5", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1baa60a579d30f363e821dcae62736cda70403c5", "committedDate": "2020-03-11T05:49:19Z", "message": "change mustache templates to support oneof with optional fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "158269d20c75086e9fe28fcbfd381a4225c54f84", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/158269d20c75086e9fe28fcbfd381a4225c54f84", "committedDate": "2020-03-11T05:49:20Z", "message": "fix the tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec7dd55c0ae1e714ec98389b846a1c3ad89df69b", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ec7dd55c0ae1e714ec98389b846a1c3ad89df69b", "committedDate": "2020-03-11T05:49:20Z", "message": "remove unnecessary oneof field maps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3bd34e99feb49540537f00d526013b9c4d51353", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e3bd34e99feb49540537f00d526013b9c4d51353", "committedDate": "2020-03-11T05:49:20Z", "message": "use oneoffield.mustache file as a nested handlebar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a3c47d50eeb329538c03ee8f58a64ee733041d", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/89a3c47d50eeb329538c03ee8f58a64ee733041d", "committedDate": "2020-03-11T05:49:20Z", "message": "change remove to removeIfHasKey"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67a6091953535597a65519d61fa070d6b0545ee3", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/67a6091953535597a65519d61fa070d6b0545ee3", "committedDate": "2020-03-11T06:10:58Z", "message": "remove tempList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "645878fabecfab5384452c610163bd9ba5fa36e6", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/645878fabecfab5384452c610163bd9ba5fa36e6", "committedDate": "2020-03-11T15:40:27Z", "message": "fix oneof integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b207d543473a556e4d62702734feebb3c2d49254", "author": {"user": {"login": "BuddhiWathsala", "name": "Buddhi Kothalawala"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b207d543473a556e4d62702734feebb3c2d49254", "committedDate": "2020-03-11T17:05:12Z", "message": "remove unused imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4144, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}