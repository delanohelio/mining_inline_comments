{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMzg3MjM1", "number": 21410, "title": "Support multiple attachments in Ballerina task scheduler", "bodyText": "Purpose\n\nCurrently task:Scheduler only supports single attachment. This was due to a limitation back then. But ideally, user should be able to provide multiple attachments to a task resource. With these changes, that functionality is being supported.\n\n\nFixes #21268\n\nApproach\n\nDescribe how you are implementing the solutions along with the design details.\n\nSamples\nProviding multiple arguments:\nimport ballerina/task;\n\npublic type Person record {\n    string name;\n    int age;\n};\n\npublic type Account record {\n    int number;\n    float balance;\n};\n\ntask:Scheduler timer = new({ intervalInMillis: 1000 });\n\npublic function main() {\n    Person sam = { name: \"Sam\", age: 29 };\n    Account acc = { number: 188008, balance: 1233.02 };\n    task:TimerConfiguration timerConfiguration = { intervalInMillis: 1000 };\n    task:Scheduler timer = new(timerConfiguration);\n    var attachResult = timer.attach(TimerService, sam, acc);\n    var startResult = timer.start();\n}\n\nservice TimerService = service {\n    resource function onTrigger(Person p, Account a) {\n        // Handle trigger\n    }\n};\nBreaking changes\n\nThis will break some of the existing codes, since the parameter attachment is no longer a public parameter.  Therefore, if there are places where a service is attached to a task:Scheduler along with an attachments as follows will break.\n\npublic type Person record {\n    string name;\n    int age;\n};\n\ntask:Scheduler timer = new({ intervalInMillis: 1000 });\n\npublic function main() {\n    Person p = { name: \"Sam\", age: 29 };\n    var attachResult = timer.attach(TimerService, attachment = p); // This will break\n    var startResult = timer.start();\n}\n\nservice TimerService = service {\n    resource function onTrigger(Person p) {\n        // Handle trigger\n    } \n};\nTo fix this, just remove the named argument.\npublic type Person record {\n    string name;\n    int age;\n};\n\ntask:Scheduler timer = new({ intervalInMillis: 1000 });\n\npublic function main() {\n    Person p = { name: \"Sam\", age: 29 };\n    var attachResult = timer.attach(TimerService, p); // Removed named argument\n    var startResult = timer.start();\n}\n\nservice TimerService = service {\n    resource function onTrigger(Person p) {\n        // Handle trigger\n    } \n};\nRemarks\n\nList any other known issues, related PRs, TODO items, or any other notes related to the PR.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-03-02T13:34:28Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410", "merged": true, "mergeCommit": {"oid": "f32b81bffb7df19632f3c071e05a447213464bff"}, "closed": true, "closedAt": "2020-03-05T11:09:03Z", "author": {"login": "ThisaruGuruge"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJsWEsAH2gAyMzgyMzg3MjM1Ojk3NWUwZWVhYzIyZGUwM2E5ZTljMmIwOGFiNjNkN2QzYmZiMmE2Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKpiTXAFqTM2OTQ4MTA4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "975e0eeac22de03a9e9c2b08ab63d7d3bfb2a638", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/975e0eeac22de03a9e9c2b08ab63d7d3bfb2a638", "committedDate": "2020-03-02T11:51:20Z", "message": "Support multiple attachments in task schedulers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ab589a337ea90a95198946e3b3c48eed8c04c8", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/56ab589a337ea90a95198946e3b3c48eed8c04c8", "committedDate": "2020-03-02T13:00:01Z", "message": "Add test for multiple attachments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aa6fa2d9f76caaa62b58b5af5b1974d778f54f1", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9aa6fa2d9f76caaa62b58b5af5b1974d778f54f1", "committedDate": "2020-03-02T13:14:43Z", "message": "Bump task module version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9809492afed99c5dc2e270d21612c675c415a203", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9809492afed99c5dc2e270d21612c675c415a203", "committedDate": "2020-03-02T13:15:00Z", "message": "Update task example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787bb2e81bd9ef89dc2bd28db20e87d138d87ca6", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/787bb2e81bd9ef89dc2bd28db20e87d138d87ca6", "committedDate": "2020-03-02T13:39:49Z", "message": "Remove unused constants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f838db11c118c0a98ac26fc646da2a2762265e", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a1f838db11c118c0a98ac26fc646da2a2762265e", "committedDate": "2020-03-02T14:13:54Z", "message": "Remove unnecessary constructor in ServiceInformation Object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "636cb0ff57cfce72012fc8bc0f92085d917ee815", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/636cb0ff57cfce72012fc8bc0f92085d917ee815", "committedDate": "2020-03-02T19:04:26Z", "message": "Fix spotbugs issues and rename multiple attachment test function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTIzNDEz", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410#pullrequestreview-368523413", "createdAt": "2020-03-04T06:06:18Z", "commit": {"oid": "636cb0ff57cfce72012fc8bc0f92085d917ee815"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjowNjoxOFrOFxg9Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjowNjoxOFrOFxg9Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2NDQ3NA==", "bodyText": "Shall we try to merge this to a single line?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410#discussion_r387464474", "createdAt": "2020-03-04T06:06:18Z", "author": {"login": "wggihan"}, "path": "stdlib/task/src/main/ballerina/src/task/scheduler.bal", "diffHunk": "@@ -25,23 +25,14 @@ public type Scheduler object {\n     # Attaches the provided `service` to the task.\n     #\n     # + serviceToAttach - Ballerina `service` object which needs to be attached to the task.\n-    # + attachment - An optional parameter which needs to passed inside the resources.\n+    # + attachments - Set of optional parameters which needs to passed inside the resources.\n     # + return - Returns `task:SchedulerError` if the process failed due to any reason, nil otherwise.\n-    public function attach(service serviceToAttach, public any attachment = ()) returns SchedulerError? {\n+    public function attach(service serviceToAttach, any... attachments) returns SchedulerError? {\n         string message = \"Failed to attach the service to the scheduler\";\n-        if (attachment != ()) {\n-            map<any> attachments = { attachment: attachment };\n-            var result = attachExternal(self.taskListener, serviceToAttach, attachments);\n-            if (result is ListenerError) {\n-                SchedulerError err = error(SCHEDULER_ERROR_REASON, message = message, cause = result);\n-                return err;\n-            }\n-        } else {\n-            var result = attachExternal(self.taskListener, serviceToAttach, {});\n-            if (result is ListenerError) {\n-                SchedulerError err = error(SCHEDULER_ERROR_REASON, message = message, cause = result);\n-                return err;\n-            }\n+        var result = attachExternal(self.taskListener, serviceToAttach, ...attachments);\n+        if (result is ListenerError) {\n+            SchedulerError err = error(SCHEDULER_ERROR_REASON, message = message, cause = result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "636cb0ff57cfce72012fc8bc0f92085d917ee815"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57accb56f539fe371c97b8185e7013e63dd7cd9d", "author": {"user": {"login": "ThisaruGuruge", "name": "Thisaru Guruge"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/57accb56f539fe371c97b8185e7013e63dd7cd9d", "committedDate": "2020-03-04T06:23:30Z", "message": "Remove redundant variable assignment in SchedulerError creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzIzMTcx", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410#pullrequestreview-369323171", "createdAt": "2020-03-05T06:34:14Z", "commit": {"oid": "57accb56f539fe371c97b8185e7013e63dd7cd9d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNjozNDoxNFrOFyHzUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNjozNDoxNFrOFyHzUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEwMDk0NQ==", "bodyText": "How does this behave in the error cases? If the # of onTrigger resource param count and the # of attach() function params are different, null will be returned.\nIf the above is validated during the compile-time, then this condition is not necessary. WDYT?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410#discussion_r388100945", "createdAt": "2020-03-05T06:34:14Z", "author": {"login": "chamil321"}, "path": "stdlib/task/src/main/java/org/ballerinalang/stdlib/task/utils/TaskExecutor.java", "diffHunk": "@@ -40,9 +38,17 @@ public static void executeFunction(ServiceInformation serviceInformation) {\n     }\n \n     private static Object[] getParameterList(AttachedFunction function, ServiceInformation serviceInformation) {\n-        if (function.type.paramTypes.length > 0 && Objects.nonNull(serviceInformation.getAttachment())) {\n-            return new Object[]{serviceInformation.getAttachment(), Boolean.TRUE};\n+        Object[] attachments = serviceInformation.getAttachment();\n+        int numberOfParameters = function.type.paramTypes.length;\n+        Object[] parameters = null;\n+        if (numberOfParameters == attachments.length) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57accb56f539fe371c97b8185e7013e63dd7cd9d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDgxMDg5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21410#pullrequestreview-369481089", "createdAt": "2020-03-05T11:08:54Z", "commit": {"oid": "57accb56f539fe371c97b8185e7013e63dd7cd9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4096, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}