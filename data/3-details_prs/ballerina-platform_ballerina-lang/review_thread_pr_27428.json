{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NzAwMzky", "number": 27428, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNjoyNjo0MlrOFEECYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzo1NzoxMFrOFFcrtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODA0NzY4OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-rt/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNjoyNjo0MlrOIEAMgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNjoyNjo0MlrOIEAMgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2ODQxOQ==", "bodyText": "Can we remove the com.moandjiezana.toml:toml4j:0.7.2 dependency with this change?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27428#discussion_r541068419", "createdAt": "2020-12-11T16:26:42Z", "author": {"login": "sameerajayasoma"}, "path": "bvm/ballerina-rt/build.gradle", "diffHunk": "@@ -84,6 +84,7 @@ dependencies {\n     dist 'org.slf4j:slf4j-api:1.7.22'\n     dist 'com.moandjiezana.toml:toml4j:0.7.2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b52d6119257f73af7131914b0571be5dbd21550"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODA1NTU4OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/configurable/ConfigToml.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNjoyODoxNVrOIEARAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMzowODoyM1rOIE-Cjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2OTU3MA==", "bodyText": "As explained by Hinduja, this is a duplication of the following class.\n\n  \n    \n      ballerina-lang/compiler/ballerina-lang/src/main/java/io/ballerina/projects/TomlDocument.java\n    \n    \n         Line 36\n      in\n      6aa2190\n    \n    \n    \n    \n\n        \n          \n           public abstract class TomlDocument { \n        \n    \n  \n\n\n@HindujaB Can you please create an issue to fix this? We need to bring this class to some other module.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27428#discussion_r541069570", "createdAt": "2020-12-11T16:28:15Z", "author": {"login": "sameerajayasoma"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/configurable/ConfigToml.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package io.ballerina.runtime.internal.configurable;\n+\n+import io.ballerina.runtime.internal.configurable.exceptions.TomlException;\n+import io.ballerina.toml.semantic.ast.TomlTableNode;\n+import io.ballerina.toml.semantic.ast.TomlTransformer;\n+import io.ballerina.toml.syntax.tree.DocumentNode;\n+import io.ballerina.toml.syntax.tree.SyntaxTree;\n+import io.ballerina.tools.diagnostics.Diagnostic;\n+import io.ballerina.tools.text.LineRange;\n+import io.ballerina.tools.text.TextDocument;\n+import io.ballerina.tools.text.TextDocuments;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static io.ballerina.runtime.internal.configurable.ConfigurableConstants.INVALID_TOML_FILE;\n+\n+/**\n+ * Represents configuration TOML document for `configurable` variables.\n+ *\n+ * @since 2.0.0\n+ */\n+public class ConfigToml {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b52d6119257f73af7131914b0571be5dbd21550"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA4MTY3OA==", "bodyText": "Created issue #27475", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27428#discussion_r542081678", "createdAt": "2020-12-14T03:08:23Z", "author": {"login": "HindujaB"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/configurable/ConfigToml.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package io.ballerina.runtime.internal.configurable;\n+\n+import io.ballerina.runtime.internal.configurable.exceptions.TomlException;\n+import io.ballerina.toml.semantic.ast.TomlTableNode;\n+import io.ballerina.toml.semantic.ast.TomlTransformer;\n+import io.ballerina.toml.syntax.tree.DocumentNode;\n+import io.ballerina.toml.syntax.tree.SyntaxTree;\n+import io.ballerina.tools.diagnostics.Diagnostic;\n+import io.ballerina.tools.text.LineRange;\n+import io.ballerina.tools.text.TextDocument;\n+import io.ballerina.tools.text.TextDocuments;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static io.ballerina.runtime.internal.configurable.ConfigurableConstants.INVALID_TOML_FILE;\n+\n+/**\n+ * Represents configuration TOML document for `configurable` variables.\n+ *\n+ * @since 2.0.0\n+ */\n+public class ConfigToml {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2OTU3MA=="}, "originalCommit": {"oid": "0b52d6119257f73af7131914b0571be5dbd21550"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjU3MTQxOnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/configurable/TomlParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzo1NzoxMFrOIF9k_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzo1NzoxMFrOIF9k_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEyMjY4NA==", "bodyText": "can we replace with\ncreateArray.<TomlType.BOOLEAN>(...)\n...\npublic static <T> ListInitialValueEntry.ExpressionEntry[] createArray(....) {\n        T rv = (T)o;\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27428#discussion_r543122684", "createdAt": "2020-12-15T07:57:10Z", "author": {"login": "manuranga"}, "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/configurable/TomlParser.java", "diffHunk": "@@ -47,88 +64,171 @@\n \n     static final Path CONFIG_FILE_PATH = Paths.get(RuntimeUtils.USER_DIR).resolve(CONFIG_FILE_NAME);\n \n-    private static Toml getConfigurationData() throws TomlException {\n+    private TomlParser() {\n+    }\n+\n+    private static TomlTableNode getConfigurationData() throws TomlException {\n         if (!Files.exists(CONFIG_FILE_PATH)) {\n             throw new TomlException(\"Configuration toml file `\" + CONFIG_FILE_NAME + \"` is not found\");\n         }\n-        try {\n-            return new Toml().read(CONFIG_FILE_PATH.toFile());\n-        } catch (RuntimeException exception) {\n-            throw new TomlException(INVALID_TOML_FILE + exception.getCause().getMessage());\n-        }\n+        ConfigToml configToml = new ConfigToml(CONFIG_FILE_PATH);\n+        return configToml.tomlAstNode();\n     }\n \n     public static void populateConfigMap(Map<Module, VariableKey[]> configurationData) throws TomlException {\n         if (configurationData.isEmpty()) {\n             return;\n         }\n-        Toml toml = getConfigurationData();\n-        if (toml.isEmpty()) {\n+        TomlTableNode tomlNode = getConfigurationData();\n+        if (tomlNode.entries().isEmpty()) {\n             //No values provided at toml file\n             return;\n         }\n         for (Map.Entry<Module, VariableKey[]> moduleEntry : configurationData.entrySet()) {\n             String orgName = moduleEntry.getKey().getOrg();\n             String moduleName = moduleEntry.getKey().getName();\n-            Toml orgToml = orgName.equals(ANON_ORG) ? toml : extractOrganizationTable(toml, orgName);\n-            Toml moduleToml = moduleName.equals(DEFAULT_MODULE) ? orgToml : extractModuleTable(orgToml, moduleName);\n+            TomlTableNode orgNode = orgName.equals(ANON_ORG) ? tomlNode : extractOrganizationNode(tomlNode, orgName);\n+            TomlTableNode moduleNode = moduleName.equals(DEFAULT_MODULE) ? orgNode : extractModuleNode(orgNode,\n+                    moduleName);\n             for (VariableKey key : moduleEntry.getValue()) {\n-                if (!moduleToml.contains(key.variable)) {\n+                if (!moduleNode.entries().containsKey(key.variable)) {\n                     //It is an optional configurable variable\n-                    break;\n+                    continue;\n                 }\n-                Object value = validateAndExtractValue(key, moduleToml);\n+                Object value = validateNodeAndExtractValue(key, moduleNode.entries());\n                 ConfigurableMap.put(key, value);\n             }\n         }\n     }\n \n-    private static Object validateAndExtractValue(VariableKey key, Toml moduleToml) throws TomlException {\n+    private static Object validateNodeAndExtractValue(VariableKey key, Map<String, TopLevelNode> valueMap) {\n         String variableName = key.variable;\n+        TomlValueNode tomlValue = ((TomlKeyValueNode) valueMap.get(variableName)).value();\n         Type type = key.type;\n         Object value;\n         try {\n             switch (type.getTag()) {\n                 case TypeTags.INT_TAG:\n-                    value = moduleToml.getLong(variableName);\n+                    checkTypeAndthrowError(TomlType.INTEGER,  tomlValue.kind(), variableName, type);\n+                    value = ((TomlLongValueNode) tomlValue).getValue();\n                     break;\n                 case TypeTags.BOOLEAN_TAG:\n-                    value = moduleToml.getBoolean(variableName);\n+                    checkTypeAndthrowError(TomlType.BOOLEAN,  tomlValue.kind(), variableName, type);\n+                    value = ((TomlBooleanValueNode) tomlValue).getValue();\n                     break;\n                 case TypeTags.FLOAT_TAG:\n-                    value = moduleToml.getDouble(variableName);\n+                    checkTypeAndthrowError(TomlType.DOUBLE,  tomlValue.kind(), variableName, type);\n+                    value = ((TomlDoubleValueNodeNode) tomlValue).getValue();\n                     break;\n                 case TypeTags.STRING_TAG:\n-                    value = StringUtils.fromString(moduleToml.getString(variableName));\n+                    checkTypeAndthrowError(TomlType.STRING,  tomlValue.kind(), variableName, type);\n+                    value = StringUtils.fromString(((TomlStringValueNode) tomlValue).getValue());\n+                    break;\n+                case TypeTags.DECIMAL_TAG:\n+                    checkTypeAndthrowError(TomlType.DOUBLE,  tomlValue.kind(), variableName, type);\n+                    value =\n+                            ValueCreator.createDecimalValue(\n+                                    BigDecimal.valueOf(((TomlDoubleValueNodeNode) tomlValue).getValue()));\n+                    break;\n+                case TypeTags.INTERSECTION_TAG:\n+                    Type effectiveType = ((BIntersectionType) type).getEffectiveType();\n+                    if (effectiveType.getTag() != TypeTags.ARRAY_TAG) {\n+                        throw new TomlException(String.format(CONFIGURATION_NOT_SUPPORTED, effectiveType.toString()));\n+                    }\n+                    checkTypeAndthrowError(TomlType.ARRAY,  tomlValue.kind(), variableName, effectiveType);\n+                    value = retrieveArrayValues((TomlArrayValueNode) tomlValue, variableName,\n+                            (ArrayType) effectiveType);\n                     break;\n                 default:\n-                    throw new TomlException(String.format(\"Configurable feature is yet to be supported for type '%s'\",\n-                            type.toString()));\n+                    throw new TomlException(String.format(CONFIGURATION_NOT_SUPPORTED, type.toString()));\n             }\n         } catch (ClassCastException e) {\n-            throw new TomlException(INVALID_TOML_FILE + String.format(INVALID_VARIABLE_TYPE, variableName,\n-                    type.toString()));\n+            throw new TomlException(INVALID_TOML_FILE, e);\n         }\n         return value;\n     }\n \n-    private static Toml extractModuleTable(Toml modules, String module) {\n-        Toml moduleToml = modules;\n-        int subModuleIndex = module.indexOf(SUBMODULE_DELIMITER);\n+    private static Object retrieveArrayValues(TomlArrayValueNode arrayNode, String variableName,\n+                                              ArrayType effectiveType) {\n+        Type elementType = effectiveType.getElementType();\n+        List<TomlValueNode> arrayList = arrayNode.elements();\n+        int arraySize = arrayList.size();\n+        ListInitialValueEntry.ExpressionEntry[] arrayEntries =\n+                new ListInitialValueEntry.ExpressionEntry[arraySize];\n+        TomlType retrievedType = arrayList.get(0).kind();\n+        try {\n+            switch (elementType.getTag()) {\n+                case TypeTags.INT_TAG:\n+                    checkTypeAndthrowError(TomlType.INTEGER, retrievedType, variableName, elementType);\n+                    for (int i = 0; i < arraySize; i++) {\n+                        arrayEntries[i] = new ListInitialValueEntry.ExpressionEntry(\n+                                ((TomlLongValueNode) arrayList.get(i)).getValue());\n+                    }\n+                    break;\n+                case TypeTags.BOOLEAN_TAG:\n+                    checkTypeAndthrowError(TomlType.BOOLEAN, retrievedType, variableName, elementType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f560fd4751f71d24799cee56e4b923b0f49e26a9"}, "originalPosition": 170}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2913, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}