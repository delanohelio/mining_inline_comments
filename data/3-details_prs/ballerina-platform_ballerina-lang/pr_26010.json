{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODk2NDk2", "number": 26010, "title": "Add Balo Writer", "bodyText": "Purpose\n\nAdd Balo Writer.\n\nFixes #25587\nFixes #26154\nApproach\n\nDescribe how you are implementing the solutions along with the design details.\n\nSamples\n\nProvide high-level details about the samples related to this feature.\n\nRemarks\n\nList any other known issues, related PRs, TODO items, or any other notes related to the PR.\n\nCheck List\n\n Read the Contributing Guide\n Updated Change Log\n Checked Tooling Support (#)\n Added necessary tests\n\n Unit Tests\n Spec Conformance Tests\n Integration Tests\n Ballerina By Example Tests\n\n\n Increased Test Coverage\n Added necessary documentation\n\n API documentation\n Module documentation in Module.md files\n Ballerina By Examples", "createdAt": "2020-09-22T12:13:23Z", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010", "merged": true, "mergeCommit": {"oid": "8eb318f84a7f59fb1a0c9c5eb004af90797fd5b2"}, "closed": true, "closedAt": "2020-10-03T09:06:44Z", "author": {"login": "pramodya1994"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLW45yAH2gAyNDkwODk2NDk2OmU0MmY4YjY2N2FmZTljOGVmNTRjMDM2YWJiOTQwZjY0NjFlNTQyODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdO22cdgFqTUwMTUzMjQ4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e42f8b667afe9c8ef54c036abb940f6461e54283", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e42f8b667afe9c8ef54c036abb940f6461e54283", "committedDate": "2020-09-22T12:10:28Z", "message": "Add Balo Writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MDg0OTg1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#pullrequestreview-494084985", "createdAt": "2020-09-23T04:51:18Z", "commit": {"oid": "e42f8b667afe9c8ef54c036abb940f6461e54283"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo1MToxOFrOHWWRjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNToyMDoxN1rOHWWv_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5NTY2Mw==", "bodyText": "Shall we not have the packagePath in package model. It should be a derived value from project path using project API.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#discussion_r493195663", "createdAt": "2020-09-23T04:51:18Z", "author": {"login": "hevayo"}, "path": "compiler/ballerina-lang/src/main/java/io/ballerina/projects/Package.java", "diffHunk": "@@ -100,7 +109,7 @@ public void resolveDependencies() {\n         return packageContext.packageDependencies();\n     }\n \n-//    public BallerinaToml ballerinaToml() {\n-//        return this.packageContext.ballerinaToml();\n-//    }\n+    public Path packagePath() {\n+        return packageContext.packagePath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e42f8b667afe9c8ef54c036abb940f6461e54283"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwMzQ1NA==", "bodyText": "Can we move this to util since this will be needed in other places.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#discussion_r493203454", "createdAt": "2020-09-23T05:20:17Z", "author": {"login": "hevayo"}, "path": "project-api/ballerina-projects/src/main/java/io/ballerina/projects/writers/BaloWriter.java", "diffHunk": "@@ -0,0 +1,390 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package io.ballerina.projects.writers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import io.ballerina.projects.Package;\n+import io.ballerina.projects.model.BaloJson;\n+import io.ballerina.projects.model.PackageJson;\n+import io.ballerina.projects.model.adaptors.JsonCollectionsAdaptor;\n+import io.ballerina.projects.model.adaptors.JsonStringsAdaptor;\n+import io.ballerina.projects.utils.ProjectConstants;\n+import org.ballerinalang.compiler.BLangCompilerException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.charset.Charset;\n+import java.nio.file.AccessDeniedException;\n+import java.nio.file.FileSystem;\n+import java.nio.file.FileSystems;\n+import java.nio.file.FileVisitResult;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.SimpleFileVisitor;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * {@code BaloWriter} writes a package to balo format.\n+ *\n+ * @since 2.0.0\n+ */\n+public class BaloWriter {\n+\n+    private BaloWriter() {}\n+\n+    /**\n+     * Write a package to a .balo and return the created .balo path.\n+     *\n+     * @param pkg  Package to be written as a .balo.\n+     * @param path Directory where the .balo should be created.\n+     * @return Newly created balo path\n+     */\n+    public static Path write(Package pkg, Path path) throws AccessDeniedException {\n+        // todo check if the given package is compiled properly\n+\n+        // Check if the path is a directory\n+        if (!path.toFile().isDirectory()) {\n+            throw new RuntimeException(\"Given path is not a directory: \" + path);\n+        }\n+\n+        if (!path.toFile().canWrite()) {\n+            throw new AccessDeniedException(\"No write access to create balo:\" + path);\n+        }\n+\n+        Path balo = path.resolve(\n+                getBaloName(pkg.packageOrg().toString(), pkg.packageName().toString(), pkg.packageVersion().toString(),\n+                        null));\n+\n+        // Create the archive over write if exists\n+        try (FileSystem baloFS = createBaloArchive(balo)) {\n+            // Now lets put stuff in\n+            populateBaloArchive(baloFS, pkg);\n+        } catch (IOException e) {\n+            throw new BLangCompilerException(\"Failed to create balo :\" + e.getMessage(), e);\n+        } catch (BLangCompilerException be) {\n+            // clean up if an error occur\n+            try {\n+                Files.delete(balo);\n+            } catch (IOException e) {\n+                // We ignore this error and throw out the original blang compiler error to the user\n+            }\n+            throw be;\n+        }\n+        return balo;\n+    }\n+\n+    private static String getBaloName(String org, String pkgName, String version, String platform) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e42f8b667afe9c8ef54c036abb940f6461e54283"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a602a13dcd3c359d13d5fb7b731527dc77f530", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/47a602a13dcd3c359d13d5fb7b731527dc77f530", "committedDate": "2020-09-23T08:29:13Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd3cf2c13b7a5a928d42ed404f8d27175aa12c73", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dd3cf2c13b7a5a928d42ed404f8d27175aa12c73", "committedDate": "2020-09-25T09:11:47Z", "message": "Merge branch 'prj_api_module_refactor' of https://github.com/ballerina-platform/ballerina-lang into add-balo-loader-prj_refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0955f9f22ec1cb7d792a16494ef034985a86db3", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f0955f9f22ec1cb7d792a16494ef034985a86db3", "committedDate": "2020-09-25T10:48:51Z", "message": "Modify balo writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44c3415a0fdc3998c52850260e60ccbafe179478", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/44c3415a0fdc3998c52850260e60ccbafe179478", "committedDate": "2020-09-28T19:42:01Z", "message": "Fix bugs in BaloWriter & checkstyles"}, "afterCommit": {"oid": "10d07f7ffbb94303c372d6b7515b2610153b9606", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/10d07f7ffbb94303c372d6b7515b2610153b9606", "committedDate": "2020-09-29T10:03:06Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10d07f7ffbb94303c372d6b7515b2610153b9606", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/10d07f7ffbb94303c372d6b7515b2610153b9606", "committedDate": "2020-09-29T10:03:06Z", "message": "Fix bugs in BaloWriter & checkstyles"}, "afterCommit": {"oid": "a0727e5b4cfa1579dc587550d600abaaf8613019", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a0727e5b4cfa1579dc587550d600abaaf8613019", "committedDate": "2020-09-29T11:46:26Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3981eafa18a14a68434a5602a50ab74c6222970", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f3981eafa18a14a68434a5602a50ab74c6222970", "committedDate": "2020-09-29T12:46:08Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0727e5b4cfa1579dc587550d600abaaf8613019", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a0727e5b4cfa1579dc587550d600abaaf8613019", "committedDate": "2020-09-29T11:46:26Z", "message": "Fix bugs in BaloWriter & checkstyles"}, "afterCommit": {"oid": "f3981eafa18a14a68434a5602a50ab74c6222970", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f3981eafa18a14a68434a5602a50ab74c6222970", "committedDate": "2020-09-29T12:46:08Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aceb66c7ef7bb54f0789362c27064f64a93f41b", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8aceb66c7ef7bb54f0789362c27064f64a93f41b", "committedDate": "2020-09-29T18:56:14Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3981eafa18a14a68434a5602a50ab74c6222970", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f3981eafa18a14a68434a5602a50ab74c6222970", "committedDate": "2020-09-29T12:46:08Z", "message": "Fix bugs in BaloWriter & checkstyles"}, "afterCommit": {"oid": "8aceb66c7ef7bb54f0789362c27064f64a93f41b", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8aceb66c7ef7bb54f0789362c27064f64a93f41b", "committedDate": "2020-09-29T18:56:14Z", "message": "Fix bugs in BaloWriter & checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5233efcbe757717aee4929da72afe277425a762c", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5233efcbe757717aee4929da72afe277425a762c", "committedDate": "2020-09-29T19:05:23Z", "message": "Fix some checkstyle issues in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9cb445a1ed18f136d7f88c18e89e7f055f1811a", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f9cb445a1ed18f136d7f88c18e89e7f055f1811a", "committedDate": "2020-09-30T15:04:09Z", "message": "Add apache commons compress library to create balo\n\nFixes https://github.com/ballerina-platform/ballerina-lang/issues/26154"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjQ1NTY4", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#pullrequestreview-499645568", "createdAt": "2020-09-30T17:11:10Z", "commit": {"oid": "f9cb445a1ed18f136d7f88c18e89e7f055f1811a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNzoxMToxMVrOHanbZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNzoxMToxMVrOHanbZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY3MTAxMw==", "bodyText": "We shouldn't be exposing the packageContext from the API. We should keep this package-private.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#discussion_r497671013", "createdAt": "2020-09-30T17:11:11Z", "author": {"login": "azinneera"}, "path": "compiler/ballerina-lang/src/main/java/io/ballerina/projects/Package.java", "diffHunk": "@@ -40,10 +40,14 @@ static Package from(Project project, PackageConfig packageConfig) {\n         return new Package(packageContext, project);\n     }\n \n-    PackageContext packageContext() {\n+    public PackageContext packageContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9cb445a1ed18f136d7f88c18e89e7f055f1811a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjU0NTA5", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#pullrequestreview-499654509", "createdAt": "2020-09-30T17:22:57Z", "commit": {"oid": "f9cb445a1ed18f136d7f88c18e89e7f055f1811a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNzoyMjo1N1rOHan66Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNzoyMjo1N1rOHan66Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY3OTA4MQ==", "bodyText": "There is already a constant defined for \".balo\" in ProjectDirConstants. Lets copy that to ProjectConstants and use it.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#discussion_r497679081", "createdAt": "2020-09-30T17:22:57Z", "author": {"login": "azinneera"}, "path": "project-api/ballerina-projects/src/main/java/io/ballerina/projects/utils/ProjectUtils.java", "diffHunk": "@@ -108,5 +108,14 @@ static Path createTargetDirectoryStructure(Path sourceRoot) throws IOException {\n \n         return targetDir;\n     }\n+\n+    public static String getBaloName(String org, String pkgName, String version, String platform) {\n+        // <orgname>-<packagename>-<platform>-<version>.balo\n+        if (platform == null || \"\".equals(platform)) {\n+            platform = \"any\";\n+        }\n+        return org + \"-\" + pkgName + \"-\" + platform + \"-\" + version + \".balo\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9cb445a1ed18f136d7f88c18e89e7f055f1811a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e88a2b826ef2b14812bf1b26572f68dee0d13e79", "author": {"user": {"login": "pramodya1994", "name": "Pramodya Mendis"}}, "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e88a2b826ef2b14812bf1b26572f68dee0d13e79", "committedDate": "2020-10-01T18:54:00Z", "message": "Add changes for review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTMyNDg2", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26010#pullrequestreview-501532486", "createdAt": "2020-10-03T09:06:31Z", "commit": {"oid": "e88a2b826ef2b14812bf1b26572f68dee0d13e79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4650, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}