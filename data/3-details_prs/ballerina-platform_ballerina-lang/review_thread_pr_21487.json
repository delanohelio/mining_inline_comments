{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDg3MjU4", "number": 21487, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozNDo0NFrODlch1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwODoxOTowMVrODmlI4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTkxMzE3OnYy", "diffSide": "RIGHT", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/worker/WorkerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozNDo0NFrOFyV4Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDo1ODo0MFrOFyW2Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMTUzMQ==", "bodyText": "Shall we validate the error message also?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388331531", "createdAt": "2020-03-05T14:34:44Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/worker/WorkerTest.java", "diffHunk": "@@ -347,4 +348,16 @@ public void waitInReturn() {\n         Assert.assertEquals(mapResult.get(\"w1\").stringValue(), \"w1\");\n         Assert.assertEquals(mapResult.get(\"w2\").stringValue(), \"w2\");\n     }\n+\n+    @Test(expectedExceptions = BLangRuntimeException.class)\n+    public void testFunctionWithWorkerInsideLock() {\n+        BValue[] returns = BRunUtil.invoke(result, \"testPanicWorkerInsideLock\");\n+    }\n+\n+    @Test\n+    public void testWorkerInsideLock() {\n+        CompileResult result = BCompileUtil.compile(\"test-src/workers/worker-in-lock.bal\");\n+        int index = 0;\n+        BAssertUtil.validateError(result, index++, 4, 20);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0NzQwMg==", "bodyText": "+1 will do", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347402", "createdAt": "2020-03-05T14:58:40Z", "author": {"login": "dulvinw"}, "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/worker/WorkerTest.java", "diffHunk": "@@ -347,4 +348,16 @@ public void waitInReturn() {\n         Assert.assertEquals(mapResult.get(\"w1\").stringValue(), \"w1\");\n         Assert.assertEquals(mapResult.get(\"w2\").stringValue(), \"w2\");\n     }\n+\n+    @Test(expectedExceptions = BLangRuntimeException.class)\n+    public void testFunctionWithWorkerInsideLock() {\n+        BValue[] returns = BRunUtil.invoke(result, \"testPanicWorkerInsideLock\");\n+    }\n+\n+    @Test\n+    public void testWorkerInsideLock() {\n+        CompileResult result = BCompileUtil.compile(\"test-src/workers/worker-in-lock.bal\");\n+        int index = 0;\n+        BAssertUtil.validateError(result, index++, 4, 20);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMTUzMQ=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTkxODU5OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLockStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozNjowM1rOFyV7bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozNjowM1rOFyV7bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMjM5Ng==", "bodyText": "We can combine the checks right?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (lock != null) {\n          \n          \n            \n                        if (!lock.isLockFree()) {\n          \n          \n            \n                    if (lock != null && !lock.isLockFree()) {", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388332396", "createdAt": "2020-03-05T14:36:03Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLockStore.java", "diffHunk": "@@ -40,9 +40,18 @@ public void addLockToMap(String lockName) {\n         globalLockMap.put(lockName, new BLock());\n     }\n \n-    public synchronized BLock getLockFromMap(String lockName) {\n+    public BLock getLockFromMap(String lockName) {\n         return globalLockMap.computeIfAbsent(lockName, (k) -> {\n             return new BLock();\n         });\n     }\n+\n+    public void panicIfInLock(String lockName) {\n+        BLock lock = globalLockMap.get(lockName);\n+        if (lock != null) {\n+            if (!lock.isLockFree()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTkyNDM3OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozNzozM1rOFyV_FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNTozNVrOF0IXrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMzMzMg==", "bodyText": "This method is only called in BLockStore.java right? Shall we move the method there?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388333332", "createdAt": "2020-03-05T14:37:33Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -162,6 +163,10 @@ public static ErrorValue createNumericConversionError(Object inputValue, BType i\n                 RuntimeErrors.INCOMPATIBLE_SIMPLE_TYPE_CONVERT_OPERATION, inputType, inputValue, targetType));\n     }\n \n+    public static ErrorValue createAsyncCallInsideLockError() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzQwNw==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207407", "createdAt": "2020-03-10T10:05:35Z", "author": {"login": "dulvinw"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -162,6 +163,10 @@ public static ErrorValue createNumericConversionError(Object inputValue, BType i\n                 RuntimeErrors.INCOMPATIBLE_SIMPLE_TYPE_CONVERT_OPERATION, inputType, inputValue, targetType));\n     }\n \n+    public static ErrorValue createAsyncCallInsideLockError() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMzMzMg=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTkzMTY0OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozOToyNlrOFyWDvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozOToyNlrOFyWDvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNDUyNQ==", "bodyText": "Shall we move this constant to BallerinaErrorReasons.java and prefix it with \"{ballerina}\"? (Check BallerinaErrorReasons for examples).\nAnd I guess we should suffix it with \"Error\"?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLock\";\n          \n          \n            \n                public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLockError\";", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388334525", "createdAt": "2020-03-05T14:39:26Z", "author": {"login": "MaryamZi"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -61,6 +61,7 @@\n     public static final String GENERATE_PKG_START = \"___start_\";\n     public static final String GENERATE_PKG_STOP = \"___stop_\";\n     public static final String GENERATE_OBJECT_CLASS_PREFIX = \".$value$\";\n+    public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLock\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTk1MzA1OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDo0NDozOFrOFyWRDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNToxOVrOF0IXJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw==", "bodyText": "Is it correct to do this for all action invocations too? They may or may not be async right?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388337933", "createdAt": "2020-03-05T14:44:38Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,7 +2000,12 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0ODA2Mw==", "bodyText": "I'll recheck and see.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388348063", "createdAt": "2020-03-05T14:59:40Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,7 +2000,12 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzI3MQ==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207271", "createdAt": "2020-03-10T10:05:19Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,7 +2000,12 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTk3MDk3OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDo0OTowN1rOFyWcbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNToxNDozOFrOFytYlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw==", "bodyText": "Can we differentiate between this error being cause due to start vs named worker?\nShall we also reword this to something like\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              usage of async call ''{0}'' inside of lock statment is prohibited\n          \n          \n            \n              cannot use an async call inside a lock statement\n          \n      \n    \n    \n  \n\nand\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              usage of async call ''{0}'' inside of lock statment is prohibited\n          \n          \n            \n              cannot use a named worker inside a lock statement\n          \n      \n    \n    \n  \n\n@hasithaa, @pubudu91, thoughts?\nThere's a typo in \"statment\" btw.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388340847", "createdAt": "2020-03-05T14:49:07Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -20,6 +20,9 @@\n # Compiler warning messages\n # -------------------------\n \n+error.usage.of.async.call.within.lock.is.prohibited=\\\n+  usage of async call ''{0}'' inside of lock statment is prohibited", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzg5NQ==", "bodyText": "In case of start the same thing should happen as well right?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347895", "createdAt": "2020-03-05T14:59:24Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -20,6 +20,9 @@\n # Compiler warning messages\n # -------------------------\n \n+error.usage.of.async.call.within.lock.is.prohibited=\\\n+  usage of async call ''{0}'' inside of lock statment is prohibited", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTc5Nw==", "bodyText": "+1 to reword. I think having two error messages is good.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388681797", "createdAt": "2020-03-06T02:23:07Z", "author": {"login": "hasithaa"}, "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -20,6 +20,9 @@\n # Compiler warning messages\n # -------------------------\n \n+error.usage.of.async.call.within.lock.is.prohibited=\\\n+  usage of async call ''{0}'' inside of lock statment is prohibited", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjY5Mw==", "bodyText": "will fix", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716693", "createdAt": "2020-03-06T05:14:38Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -20,6 +20,9 @@\n # Compiler warning messages\n # -------------------------\n \n+error.usage.of.async.call.within.lock.is.prohibited=\\\n+  usage of async call ''{0}'' inside of lock statment is prohibited", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTk3MjgyOnYy", "diffSide": "RIGHT", "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDo0OTozNFrOFyWdpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNToxMzozOVrOFytX0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA==", "bodyText": "Can we add a test for start too?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388341158", "createdAt": "2020-03-05T14:49:34Z", "author": {"login": "MaryamZi"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "diffHunk": "@@ -0,0 +1,9 @@\n+function testWorkerInsideLock() {\n+    lock {\n+        fork {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0NzMyNQ==", "bodyText": "Will add", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347325", "createdAt": "2020-03-05T14:58:33Z", "author": {"login": "dulvinw"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "diffHunk": "@@ -0,0 +1,9 @@\n+function testWorkerInsideLock() {\n+    lock {\n+        fork {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjEyMA==", "bodyText": "Also Add test case for nested fork statements.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388682120", "createdAt": "2020-03-06T02:24:29Z", "author": {"login": "hasithaa"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "diffHunk": "@@ -0,0 +1,9 @@\n+function testWorkerInsideLock() {\n+    lock {\n+        fork {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjQ5Ng==", "bodyText": "+1", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716496", "createdAt": "2020-03-06T05:13:39Z", "author": {"login": "dulvinw"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "diffHunk": "@@ -0,0 +1,9 @@\n+function testWorkerInsideLock() {\n+    lock {\n+        fork {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}, "originalCommit": {"oid": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODE1OTg3OnYy", "diffSide": "RIGHT", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLock.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMjoyMTowOFrOFyrOXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNToxMzoyN1rOFytXqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTMwOQ==", "bodyText": "Shouldn't this be a recursive check?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388681309", "createdAt": "2020-03-06T02:21:08Z", "author": {"login": "hasithaa"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLock.java", "diffHunk": "@@ -61,11 +61,11 @@ public synchronized void unlock() {\n         }\n     }\n \n-    private boolean isLockFree() {\n+    public boolean isLockFree() {\n         return this.current.isEmpty();\n     }\n \n-    private boolean lockedBySameContext(Strand ctx) {\n+    public boolean lockedBySameContext(Strand ctx) {\n         return this.current.getLast() == ctx;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf71bd19285a6cde0dde76e424f751ca1a727577"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjQ1Nw==", "bodyText": "Since we only create a new strand when we hit a worker or start, enough to check the current parent.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716457", "createdAt": "2020-03-06T05:13:27Z", "author": {"login": "dulvinw"}, "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLock.java", "diffHunk": "@@ -61,11 +61,11 @@ public synchronized void unlock() {\n         }\n     }\n \n-    private boolean isLockFree() {\n+    public boolean isLockFree() {\n         return this.current.isEmpty();\n     }\n \n-    private boolean lockedBySameContext(Strand ctx) {\n+    public boolean lockedBySameContext(Strand ctx) {\n         return this.current.getLast() == ctx;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTMwOQ=="}, "originalCommit": {"oid": "bf71bd19285a6cde0dde76e424f751ca1a727577"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODE2NTcyOnYy", "diffSide": "RIGHT", "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/workers.bal", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMjoyNTowMVrOFyrR7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNTowMVrOF0IWbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjIyMQ==", "bodyText": "Make this work for multiple levels.", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388682221", "createdAt": "2020-03-06T02:25:01Z", "author": {"login": "hasithaa"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/workers.bal", "diffHunk": "@@ -542,3 +542,15 @@ function waitInReturn() returns any {\n \n     return wait {w1, w2};\n }\n+\n+function testPanicWorkerInsideLock() {\n+    lock {\n+        panicWorkerInsideLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf71bd19285a6cde0dde76e424f751ca1a727577"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzA4NA==", "bodyText": "FIxed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207084", "createdAt": "2020-03-10T10:05:01Z", "author": {"login": "dulvinw"}, "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/workers.bal", "diffHunk": "@@ -542,3 +542,15 @@ function waitInReturn() returns any {\n \n     return wait {w1, w2};\n }\n+\n+function testPanicWorkerInsideLock() {\n+    lock {\n+        panicWorkerInsideLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjIyMQ=="}, "originalCommit": {"oid": "bf71bd19285a6cde0dde76e424f751ca1a727577"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTY5Njc4OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo0NTo0MVrOFzMxQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNDo1MlrOF0IWIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDkxMg==", "bodyText": "A lock-stmt can be written inside another lock-stmt right? In that case, I think we should maintain the previous this.withinLockBlock before setting this.withinLockBlock to true at L1237 and reset the previous value here.\nOr something like the following may not fail?\nfunction testFunc() {\n    lock {\n        lock {\n            \n        }\n\n        fork {\n            worker w1 {\n                \n            }\n        }\n    }\n}", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389230912", "createdAt": "2020-03-07T05:45:41Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1232,9 +1233,10 @@ public void visit(BLangWhile whileNode) {\n     @Override\n     public void visit(BLangLock lockNode) {\n \n-        checkExperimentalFeatureValidity(ExperimentalFeatures.LOCK, lockNode.pos);\n         this.checkStatementExecutionValidity(lockNode);\n+        this.withinLockBlock = true;\n         lockNode.body.stmts.forEach(e -> analyzeNode(e, env));\n+        this.withinLockBlock = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzAwOA==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207008", "createdAt": "2020-03-10T10:04:52Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1232,9 +1233,10 @@ public void visit(BLangWhile whileNode) {\n     @Override\n     public void visit(BLangLock lockNode) {\n \n-        checkExperimentalFeatureValidity(ExperimentalFeatures.LOCK, lockNode.pos);\n         this.checkStatementExecutionValidity(lockNode);\n+        this.withinLockBlock = true;\n         lockNode.body.stmts.forEach(e -> analyzeNode(e, env));\n+        this.withinLockBlock = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDkxMg=="}, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTY5NzIzOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo0NjoyN1rOFzMxcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo0NjoyN1rOFzMxcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDk2Mg==", "bodyText": "Do we need a separate method?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389230962", "createdAt": "2020-03-07T05:46:27Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }\n+        }\n+    }\n+\n+    private void logAsyncCallWithinLockError(BLangInvocation invocationExpr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTY5NzY4OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo0ODoxOFrOFzMxsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNDo0MFrOF0IVvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTAyNw==", "bodyText": "Shall we switch the checks and return early?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (invocationExpr.async && this.withinLockBlock) {\n          \n          \n            \n                            logAsyncCallWithinLockError(invocationExpr);\n          \n          \n            \n                        } else {\n          \n          \n            \n                            validateActionInvocation(invocationExpr.pos, invocationExpr);\n          \n          \n            \n                        }\n          \n          \n            \n                        if (!invocationExpr.async || !this.withinLockBlock) {\n          \n          \n            \n                            validateActionInvocation(invocationExpr.pos, invocationExpr);\n          \n          \n            \n                            return;\n          \n          \n            \n                        }\n          \n          \n            \n                        // log the error here", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389231027", "createdAt": "2020-03-07T05:48:18Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjkxMA==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206910", "createdAt": "2020-03-10T10:04:40Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTAyNw=="}, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTcwMTI1OnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo1NzozOVrOFzMzfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNDozMFrOF0IVUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTQ4Ng==", "bodyText": "We can simplify this using a ternary operator?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DiagnosticCode code;\n          \n          \n            \n            \n          \n          \n            \n                    if (invocationExpr.functionPointerInvocation) {\n          \n          \n            \n                        code = DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        code = DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED;\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    dlog.error(invocationExpr.pos, code);\n          \n          \n            \n                    dlog.error(invocationExpr.pos, invocationExpr.functionPointerInvocation ?  \n          \n          \n            \n                               DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED : \n          \n          \n            \n                               DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED);", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389231486", "createdAt": "2020-03-07T05:57:39Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }\n+        }\n+    }\n+\n+    private void logAsyncCallWithinLockError(BLangInvocation invocationExpr) {\n+        DiagnosticCode code;\n+\n+        if (invocationExpr.functionPointerInvocation) {\n+            code = DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED;\n+        } else {\n+            code = DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED;\n         }\n+\n+        dlog.error(invocationExpr.pos, code);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjgwMg==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206802", "createdAt": "2020-03-10T10:04:30Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }\n+        }\n+    }\n+\n+    private void logAsyncCallWithinLockError(BLangInvocation invocationExpr) {\n+        DiagnosticCode code;\n+\n+        if (invocationExpr.functionPointerInvocation) {\n+            code = DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED;\n+        } else {\n+            code = DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED;\n         }\n+\n+        dlog.error(invocationExpr.pos, code);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTQ4Ng=="}, "originalCommit": {"oid": "19c003adb986f632f41df2424e569000e50905c8"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzgwODIyOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwODoxODozMFrOF0E4ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDowNDoyMVrOF0IVCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDMzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!invocationExpr.async || !this.withinLockBlock) {\n          \n          \n            \n                        if (invocationExpr.actionInvocation || !this.withinLockBlock) {", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390150330", "createdAt": "2020-03-10T08:18:30Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -2000,7 +2003,14 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (!invocationExpr.async || !this.withinLockBlock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "642b4610edc44cb14579c96e97368e3c1d21ee83"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjczMA==", "bodyText": "Fixed", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206730", "createdAt": "2020-03-10T10:04:21Z", "author": {"login": "dulvinw"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -2000,7 +2003,14 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (!invocationExpr.async || !this.withinLockBlock) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDMzMA=="}, "originalCommit": {"oid": "642b4610edc44cb14579c96e97368e3c1d21ee83"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzgwOTYxOnYy", "diffSide": "RIGHT", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwODoxOTowMVrOF0E5lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwODoxOTowMVrOF0E5lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDU0OQ==", "bodyText": "Shall we indent these two lines to align with the beginning of invocationExpr.pos?", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390150549", "createdAt": "2020-03-10T08:19:01Z", "author": {"login": "MaryamZi"}, "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -2000,7 +2003,14 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (!invocationExpr.async || !this.withinLockBlock) {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+                return;\n+            }\n+\n+            dlog.error(invocationExpr.pos, invocationExpr.functionPointerInvocation ? \n+            DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED : \n+            DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "642b4610edc44cb14579c96e97368e3c1d21ee83"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 917, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}