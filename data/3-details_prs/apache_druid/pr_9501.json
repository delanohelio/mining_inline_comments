{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MzI0MTM2", "number": 9501, "title": "Adding s3, gcs, azure integration tests", "bodyText": "Adding s3, gcs, azure integration tests\nDescription\nAdding s3, gcs, azure integration tests which can be run BYO cloud style.\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-10T19:32:33Z", "url": "https://github.com/apache/druid/pull/9501", "merged": true, "mergeCommit": {"oid": "4c620b8f1c67e06e039b260de991c0e90f087010"}, "closed": true, "closedAt": "2020-03-17T10:08:45Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMXtW8AH2gAyMzg2MzI0MTM2OjRkNTI5M2EyZTI2OGRmNWMwZjllYWIzZWEwNjUyN2EyNTc4M2RhNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOavvdAFqTM3NTcyOTM3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d5293a2e268df5c0f9eab3ea06527a25783da6d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/4d5293a2e268df5c0f9eab3ea06527a25783da6d", "committedDate": "2020-03-10T19:30:32Z", "message": "exclude pulling s3 segments for tests that doesnt need it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db9d33eecc2308dbf9830761e81ea2989f849311", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/db9d33eecc2308dbf9830761e81ea2989f849311", "committedDate": "2020-03-10T19:58:55Z", "message": "fix script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3319067a869039e744578a76759ff416138e95b", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/a3319067a869039e744578a76759ff416138e95b", "committedDate": "2020-03-10T21:17:46Z", "message": "fix script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzMwNzgw", "url": "https://github.com/apache/druid/pull/9501#pullrequestreview-372330780", "createdAt": "2020-03-10T21:21:17Z", "commit": {"oid": "a3319067a869039e744578a76759ff416138e95b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMToyMToxN1rOF0he7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMToyMToxN1rOF0he7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxODg2Mw==", "bodyText": "This will work for how our travis CI is setup but if user try running manually locally with...\n\n-DexcludedGroups=not-query\nwithout -Dgroups and without DexcludedGroups\nthen the data won't be setup", "url": "https://github.com/apache/druid/pull/9501#discussion_r390618863", "createdAt": "2020-03-10T21:21:17Z", "author": {"login": "maytasm"}, "path": "integration-tests/docker/druid.sh", "diffHunk": "@@ -73,4 +76,20 @@ setupConfig() {\n       var=$(echo \"$evar\" | sed -e 's?^\\([^=]*\\)=.*?\\1?g' -e 's?_?.?g')\n       setKey $DRUID_SERVICE \"$var\" \"$val\"\n   done\n-}\n\\ No newline at end of file\n+}\n+\n+setupData()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3319067a869039e744578a76759ff416138e95b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a392bdf49c9041d9e963625017404ddd202ca204", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/a392bdf49c9041d9e963625017404ddd202ca204", "committedDate": "2020-03-10T22:10:43Z", "message": "fix script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa9b866fafba61bf20dd3b41737be08a5b9bad0b", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/aa9b866fafba61bf20dd3b41737be08a5b9bad0b", "committedDate": "2020-03-11T20:35:39Z", "message": "add s3 test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa7002a53c6024a99d3a820580ae5f67981a8f19", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/aa7002a53c6024a99d3a820580ae5f67981a8f19", "committedDate": "2020-03-11T20:41:27Z", "message": "fix merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b86f8fb8b86a39db5af36ccd0b042fd799b64d19", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/b86f8fb8b86a39db5af36ccd0b042fd799b64d19", "committedDate": "2020-03-11T20:57:22Z", "message": "refactor sample data script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9a447ffe4ee97d63ceb4aaaa2826e722c72ff5", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/fb9a447ffe4ee97d63ceb4aaaa2826e722c72ff5", "committedDate": "2020-03-13T01:15:57Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d023186d5dce33bfa49c95480eead70b0760c4d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/4d023186d5dce33bfa49c95480eead70b0760c4d", "committedDate": "2020-03-13T06:44:13Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c861df545234bc634824f36fbd24151ef51c4ff1", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/c861df545234bc634824f36fbd24151ef51c4ff1", "committedDate": "2020-03-13T06:48:31Z", "message": "add license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/ee5427fcf5212849eee89f3e303019ea7e59126e", "committedDate": "2020-03-13T20:56:57Z", "message": "fix failing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjkwMTc0", "url": "https://github.com/apache/druid/pull/9501#pullrequestreview-374690174", "createdAt": "2020-03-14T02:20:30Z", "commit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMjoyMDozMFrOF2XPrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMjozODoxNlrOF2XUBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODI2OQ==", "bodyText": "does this mean you need to edit this code to run the tests? Can this be a config so it can be passed in?", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548269", "createdAt": "2020-03-14T02:20:30Z", "author": {"login": "clintropolis"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/indexer/ITAzureParallelIndexTest.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.tests.indexer;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.indexer.partitions.DynamicPartitionsSpec;\n+import org.apache.druid.java.util.common.Pair;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.testing.guice.DruidTestModuleFactory;\n+import org.apache.druid.tests.TestNGGroup;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Guice;\n+import org.testng.annotations.Test;\n+\n+import java.io.Closeable;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.Function;\n+\n+/**\n+ * IMPORTANT:\n+ * To run this test, you must:\n+ * 1) Set the variables {@link ITAzureParallelIndexTest#CONTAINER} and {@link ITAzureParallelIndexTest#PATH} for your data\n+ * 2) Copy wikipedia_index_data1.json, wikipedia_index_data2.json, and wikipedia_index_data3.json\n+ *    located in integration-tests/src/test/resources/data/batch_index to your Azure at the location set in step 1.\n+ * 3) Provide -Doverride.config.path=<PATH_TO_FILE> with Azure credentials/configs set. See\n+ *    integration-tests/docker/environment-configs/override-examples/azure for env vars to provide.\n+ */\n+@Test(groups = TestNGGroup.AZURE_DEEP_STORAGE)\n+@Guice(moduleFactory = DruidTestModuleFactory.class)\n+public class ITAzureParallelIndexTest extends AbstractITBatchIndexTest\n+{\n+  // START: Change this with the configs for your Azure data\n+  private static final String CONTAINER = \"my-container\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODc2Mg==", "bodyText": "hmm, this doesn't seem a great way to handle this and doesn't really reflect how this will likely be run in practice, because the extension dependency jars will still all be on the classpath, just the extension jar itself will be in another folder. I think we will probably want to get the druid install similar to how it is in normal packaging to provide a more realistic test environment, which probably precludes using mvn -B dependency:copy-dependencies, or at least the way we are currently using it, so that way all extensions are split out in the separate extensions folder and not on the classpath.\nI guess this could be fine for now though, and we could figure out how to do this in a future PR.", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548762", "createdAt": "2020-03-14T02:28:27Z", "author": {"login": "clintropolis"}, "path": "integration-tests/run_cluster.sh", "diffHunk": "@@ -47,12 +47,25 @@\n   # Make directories if they dont exist\n   mkdir -p $SHARED_DIR/logs\n   mkdir -p $SHARED_DIR/tasklogs\n+  mkdir -p $SHARED_DIR/docker/extensions\n+  mkdir -p $SHARED_DIR/docker/credentials\n \n   # install druid jars\n   rm -rf $SHARED_DIR/docker\n   cp -R docker $SHARED_DIR/docker\n   mvn -B dependency:copy-dependencies -DoutputDirectory=$SHARED_DIR/docker/lib\n \n+  # move extensions into a seperate extension folder\n+  # For druid-s3-extensions\n+  mkdir -p $SHARED_DIR/docker/extensions/druid-s3-extensions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODkxOQ==", "bodyText": "this approach with trying to use overrides seems like it is going to be sort of brittle and hard to maintain. Like, if i want to ingest data from s3 into hdfs deep storage, or any combination of extensions, I'm not sure how well this approach will hold up, I guess we'll need separate override files for each configuration? That said, maybe is fine until we determine a better solution to integration test config management.", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548919", "createdAt": "2020-03-14T02:30:51Z", "author": {"login": "clintropolis"}, "path": "integration-tests/docker/environment-configs/override-examples/azure", "diffHunk": "@@ -0,0 +1,28 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+#\n+# Example of override config file to provide.\n+# Please replace <OVERRIDE_THIS> with your cloud configs/credentials\n+#\n+druid_storage_type=azure\n+druid_azure_account=<OVERRIDE_THIS>\n+druid_azure_key=<OVERRIDE_THIS>\n+druid_azure_container=<OVERRIDE_THIS>\n+druid_extensions_loadList=[\"druid-azure-extensions\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0OTM4MA==", "bodyText": "Hmm, this doesn't necessarily need to be changed now, but I think longer term we are going to need a mapping of test groups to configurations, but I'm not sure it should be encoded in a file in the container. This part should maybe be repurposed to allow running of initialization scripts that configurations bring with them to the container, and this stuff be in a script that initializes the legacy integration test environment.", "url": "https://github.com/apache/druid/pull/9501#discussion_r392549380", "createdAt": "2020-03-14T02:38:16Z", "author": {"login": "clintropolis"}, "path": "integration-tests/docker/druid.sh", "diffHunk": "@@ -73,4 +75,23 @@ setupConfig() {\n       var=$(echo \"$evar\" | sed -e 's?^\\([^=]*\\)=.*?\\1?g' -e 's?_?.?g')\n       setKey $DRUID_SERVICE \"$var\" \"$val\"\n   done\n-}\n\\ No newline at end of file\n+}\n+\n+setupData()\n+{\n+  # The \"query\" and \"security\" test groups require data to be setup before running the tests.\n+  # In particular, they requires segments to be download from a pre-existing s3 bucket.\n+  # This is done by using the loadSpec put into metadatastore and s3 credientials set below.\n+  if [ \"$DRUID_INTEGRATION_TEST_GROUP\" = \"query\" ] || [ \"$DRUID_INTEGRATION_TEST_GROUP\" = \"security\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e7020138678421ff7c2467aec993861a8ed112", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/58e7020138678421ff7c2467aec993861a8ed112", "committedDate": "2020-03-16T19:28:32Z", "message": "change bucket and path to config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ac17424acf22820df574b9b1820bb215e04d5d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/b1ac17424acf22820df574b9b1820bb215e04d5d", "committedDate": "2020-03-16T21:34:17Z", "message": "update integration test readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c799c96ad5dff763b2e4f7c5c835368990b0a19a", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/c799c96ad5dff763b2e4f7c5c835368990b0a19a", "committedDate": "2020-03-16T21:39:32Z", "message": "resolve conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e220ddcac806cf8f69f92d024afa81a86d36ddb6", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/e220ddcac806cf8f69f92d024afa81a86d36ddb6", "committedDate": "2020-03-16T21:49:48Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzI5Mzc1", "url": "https://github.com/apache/druid/pull/9501#pullrequestreview-375729375", "createdAt": "2020-03-17T04:10:42Z", "commit": {"oid": "e220ddcac806cf8f69f92d024afa81a86d36ddb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2625, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}