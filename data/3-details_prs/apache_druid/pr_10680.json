{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTk4MjQ4", "number": 10680, "title": "integration test for coordinator and overlord leadership client", "bodyText": "Description\nThis PR adds integration tests that try to get some coverage of coordinator and overlord leadership changes, using queries against system tables and then cycling which containers are running and forcing leadership changes. The goal is to get some coverage for DruidLeadershipClient in the integration tests and avoid any sort of regressions if possible. Once kubernetes integration tests are in place, I imagine we could run these tests against k8s discovery instead of curator based as well since #10544 has now gone in.\nTo aid in my sanity while testing this stuff, I have added is_leader to sys.servers which is a long column which returns 1 if the server is the leader and 0 if it is not (for coordinators and overlords), and for services which do not have the concept of leadership, will return the default long value (0 in default mode, null if druid.generic.useDefaultValueForNull=false).\nThe integration tests add a new test group, 'high-availability', which has a special docker-compose file that brings up a cluster with 1 router, 1 broker, 2 overlords, and 2 coordinators (and zk/kafka and metadata store). The tests check which containers are the leader, issues some system tables queries which should flex the leadership clients to both the current overlord and coordinator leaders, and then restart the containers to force leadership change, repeating this process a few times.\nI modified the base docker-compose file to specify the hostnames to the container names, and set druid.host to the same, so that the tests could refer to hosts by hostname instead of container IP address (which is what druid.host defaults to if not specified otherwise). This was because I also had to plumb this through to the integration test config so that I could fill in the correct internal host information for test code and query/expected response templates.\nIn other docker stuffs, I removed many of the links sections of the docker-compose file for integration tests, which afaict is deprecated and not necessary.\nFinally, I fixed a funny race condition that i think could really only happen when doing something like this in docker and starting multiple coordinators at the same time, which would have a race condition when trying to initialize the basic auth extension default auth stuffs, where both containers would detect that it had not been initialized, one would lose the race, and explode out of lifecycle start causing the service to die before starting. This probably isn't a big deal even in a real system because if the process gets started again it would succeed because it would be initialized on the 2nd pass, but our integration test configs do not auto-restart (which is noisy on purpose I think), so instead I just wrapped the initialization in a retry which will skip and continue startup if the duplicate initialization explosion is detected.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-12-15T05:58:39Z", "url": "https://github.com/apache/druid/pull/10680", "merged": true, "mergeCommit": {"oid": "da0eabaa01615f34145b14d585e5f3df14ef15b1"}, "closed": true, "closedAt": "2020-12-18T06:50:13Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmTdhcAH2gAyNTM5OTk4MjQ4OjJlNjA1ZWIwZjIzNmM4Y2I1NjY0NmQ2ZjUxOGJmZmQ4NjgxMWFmMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnMuGpAH2gAyNTM5OTk4MjQ4OmFiZDVjOTViYzM1Y2I3MDljZTYyNjNiNWVlMzM3ODBkNDg5ZDc1NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e605eb0f236c8cb56646d6f518bffd86811af39", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/2e605eb0f236c8cb56646d6f518bffd86811af39", "committedDate": "2020-12-15T05:26:48Z", "message": "integration test for coordinator and overlord leadership, added sys.servers is_leader column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be04821d6097e58f6be13efc5014f4e0a5e33810", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/be04821d6097e58f6be13efc5014f4e0a5e33810", "committedDate": "2020-12-15T05:46:32Z", "message": "docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7e8b1fd1a350dc1b96cc20cc3dced85c0a630c5", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c7e8b1fd1a350dc1b96cc20cc3dced85c0a630c5", "committedDate": "2020-12-15T05:49:01Z", "message": "remove not needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caa2205aa7956ab2f54870dace78ee551b0b6b97", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/caa2205aa7956ab2f54870dace78ee551b0b6b97", "committedDate": "2020-12-15T06:13:15Z", "message": "fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTY3Njk3", "url": "https://github.com/apache/druid/pull/10680#pullrequestreview-552167697", "createdAt": "2020-12-15T07:27:22Z", "commit": {"oid": "caa2205aa7956ab2f54870dace78ee551b0b6b97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzoyNzoyMlrOIF8mCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzoyNzoyMlrOIF8mCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEwNjU3MQ==", "bodyText": "hmm. shouldn't this always be zero?  Data nodes don't have any leader.", "url": "https://github.com/apache/druid/pull/10680#discussion_r543106571", "createdAt": "2020-12-15T07:27:22Z", "author": {"login": "abhishekagarwal87"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/SystemSchema.java", "diffHunk": "@@ -586,7 +638,8 @@ public TableType getJdbcTableType()\n           StringUtils.toLowerCase(discoveryDruidNode.getNodeRole().toString()),\n           druidServerToUse.getTier(),\n           currentSize,\n-          druidServerToUse.getMaxSize()\n+          druidServerToUse.getMaxSize(),\n+          NullHandling.defaultLongValue()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caa2205aa7956ab2f54870dace78ee551b0b6b97"}, "originalPosition": 141}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b369accf271f06886c94348bd963120fe977350", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/8b369accf271f06886c94348bd963120fe977350", "committedDate": "2020-12-15T10:29:06Z", "message": "fix compile heh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a917c791d21df8b9e7021c16e3d97599613de0", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c6a917c791d21df8b9e7021c16e3d97599613de0", "committedDate": "2020-12-15T18:13:53Z", "message": "oof"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDYyOTkx", "url": "https://github.com/apache/druid/pull/10680#pullrequestreview-553062991", "createdAt": "2020-12-15T23:12:08Z", "commit": {"oid": "c6a917c791d21df8b9e7021c16e3d97599613de0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzoxMjowOFrOIGkLHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzoxMjowOFrOIGkLHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NTAzNw==", "bodyText": "not sure why this is a LONG type variable and not STRING type which could have values \"true\", \"false\" and \"not-applicable\" ?", "url": "https://github.com/apache/druid/pull/10680#discussion_r543755037", "createdAt": "2020-12-15T23:12:08Z", "author": {"login": "himanshug"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/SystemSchema.java", "diffHunk": "@@ -159,6 +160,7 @@\n       .add(\"tier\", ValueType.STRING)\n       .add(\"curr_size\", ValueType.LONG)\n       .add(\"max_size\", ValueType.LONG)\n+      .add(\"is_leader\", ValueType.LONG)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6a917c791d21df8b9e7021c16e3d97599613de0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed27049d0a81bf65c05de2b10400bb5b19b7bba7", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/ed27049d0a81bf65c05de2b10400bb5b19b7bba7", "committedDate": "2020-12-15T23:31:26Z", "message": "revert unintended"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMTM5MjU2", "url": "https://github.com/apache/druid/pull/10680#pullrequestreview-553139256", "createdAt": "2020-12-16T00:04:21Z", "commit": {"oid": "ed27049d0a81bf65c05de2b10400bb5b19b7bba7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d1ffcf3c1d7ff5aa6c289b30776dff6e199461f", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/3d1ffcf3c1d7ff5aa6c289b30776dff6e199461f", "committedDate": "2020-12-16T09:46:39Z", "message": "fix tests, split out docker-compose file selection from starting cluster, use docker-compose down to stop cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6fcc2f66bf0951725813b55dc93e874db927808", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/b6fcc2f66bf0951725813b55dc93e874db927808", "committedDate": "2020-12-16T10:28:43Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f750cf9230d8f7f319c5598f34d6853214b452a", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/9f750cf9230d8f7f319c5598f34d6853214b452a", "committedDate": "2020-12-16T10:29:47Z", "message": "style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216b06a9813bd981b99f83275ab3c294a69c8775", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/216b06a9813bd981b99f83275ab3c294a69c8775", "committedDate": "2020-12-16T10:32:54Z", "message": "dang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "898948287e0dae8e54de3f6781aabfefca46dffe", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/898948287e0dae8e54de3f6781aabfefca46dffe", "committedDate": "2020-12-16T10:33:25Z", "message": "heh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c3d2cf22c737cfa4ba0d57ae4ae1d76a5e31b5b", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/3c3d2cf22c737cfa4ba0d57ae4ae1d76a5e31b5b", "committedDate": "2020-12-16T14:08:28Z", "message": "scripts are hard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e59bd423af151de1c40c08253c74f085e298fda", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/4e59bd423af151de1c40c08253c74f085e298fda", "committedDate": "2020-12-16T21:26:03Z", "message": "fix spelling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "433960acd91c285331642082afb5d058cd927282", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/433960acd91c285331642082afb5d058cd927282", "committedDate": "2020-12-16T21:41:35Z", "message": "fix thing that must not matter since was already wrong ip, log when test fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTI0MTkw", "url": "https://github.com/apache/druid/pull/10680#pullrequestreview-554124190", "createdAt": "2020-12-16T22:08:04Z", "commit": {"oid": "433960acd91c285331642082afb5d058cd927282"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f36491e2755e7b2c1827355b093ebd36ba695d8", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/2f36491e2755e7b2c1827355b093ebd36ba695d8", "committedDate": "2020-12-16T23:36:00Z", "message": "needs more heap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "518721dcd17bec4b5d3b4ecadb25b0efaf524433", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/518721dcd17bec4b5d3b4ecadb25b0efaf524433", "committedDate": "2020-12-17T07:09:05Z", "message": "Merge remote-tracking branch 'upstream/master' into ha-leadership-integration-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dea9e923958dcdc7c3cf51c4e33b00f5c7637bc", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/5dea9e923958dcdc7c3cf51c4e33b00f5c7637bc", "committedDate": "2020-12-17T07:44:05Z", "message": "fix merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "470dec3b1740d54feef6044290de3e8f29809252", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/470dec3b1740d54feef6044290de3e8f29809252", "committedDate": "2020-12-17T22:19:25Z", "message": "less aggro"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd5c95bc35cb709ce6263b5ee33780d489d7559", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/abd5c95bc35cb709ce6263b5ee33780d489d7559", "committedDate": "2020-12-18T00:09:30Z", "message": "Merge remote-tracking branch 'upstream/master' into ha-leadership-integration-tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3180, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}