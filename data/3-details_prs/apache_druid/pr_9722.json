{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NDQ5MTQy", "number": 9722, "title": "Optimize FileWriteOutBytes to avoid high system cpu usage", "bodyText": "Fixes #9721.\n\n\nDescription\nsee #9721\nThe benchmark report shows that the performance is improved by about 44% with this pr.\nMachine info:\nCPU: Intel(R) Xeon(R) Gold 5118 CPU @ 2.30GHz\nDisk: HDD\nCommand: java -Djava.io.tmpdir=/data00/tmp_dir -jar benchmarks.jar IndexMergeWithTmpFileBenchmark\nbefore optimization:\nBenchmark (numSegments) (rollup) (rowsPerSegment) (schema) Mode Cnt Score Error Units\nIndexMergeWithTmpFileBenchmark.mergeV9 5 true 75000 basic avgt 25 8161891.327 \u00b1 32636.767 us/op\nIndexMergeWithTmpFileBenchmark.mergeV9 5 false 75000 basic avgt 25 8041137.131 \u00b1 41477.861 us/op\n\nafter optimization:\nBenchmark (numSegments) (rollup) (rowsPerSegment) (schema) Mode Cnt Score Error Units\nIndexMergeWithTmpFileBenchmark.mergeV9 5 true 75000 basic avgt 25 4536098.486 \u00b1 13668.764 us/op\nIndexMergeWithTmpFileBenchmark.mergeV9 5 false 75000 basic avgt 25 4321243.165 \u00b1 30293.772 us/op\n\n\n\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\nFileWriteOutBytes\nIndexMergeWithTmpFileBenchmark", "createdAt": "2020-04-18T05:43:50Z", "url": "https://github.com/apache/druid/pull/9722", "merged": true, "mergeCommit": {"oid": "c5bfe3601135193de8527126dc6a1f7d3ffa5d5b"}, "closed": true, "closedAt": "2020-04-24T03:18:43Z", "author": {"login": "viongpanzi"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYvFx9gH2gAyNDA1NDQ5MTQyOmMzMzU1MWQxMWEwZTllZTVjZGI0ZGNiYjJmMDJlMGQzY2NjODY0Y2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcanQpyAFqTM5OTU4MzQ3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c33551d11a0e9ee5cdb4dcbb2f02e0d3ccc864cf", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/c33551d11a0e9ee5cdb4dcbb2f02e0d3ccc864cf", "committedDate": "2020-04-18T05:32:07Z", "message": "optimize FileWriteOutBytes to avoid high sys cpu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "149e08c091d06cae25b5d2ba375ae3a846c605b2", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/149e08c091d06cae25b5d2ba375ae3a846c605b2", "committedDate": "2020-04-18T06:56:56Z", "message": "optimize FileWriteOutBytes to avoid high sys cpu -- remove IOException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "965f74214820fb8768aea549a0498ef376f02cc8", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/965f74214820fb8768aea549a0498ef376f02cc8", "committedDate": "2020-04-18T13:23:29Z", "message": "optimize FileWriteOutBytes to avoid high sys cpu -- remove IOException in writeOutBytes.size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2abef0304950bc621842395aa8d7ff84cf4a3b83", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/2abef0304950bc621842395aa8d7ff84cf4a3b83", "committedDate": "2020-04-18T15:43:54Z", "message": "Revert \"optimize FileWriteOutBytes to avoid high sys cpu -- remove IOException in writeOutBytes.size\"\n\nThis reverts commit 965f7421"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9157029efd4145bf713882ce7e5244a250dc1e8", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/e9157029efd4145bf713882ce7e5244a250dc1e8", "committedDate": "2020-04-18T15:44:17Z", "message": "Revert \"optimize FileWriteOutBytes to avoid high sys cpu -- remove IOException\"\n\nThis reverts commit 149e08c0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a610003437bf476aafad7f45b6f04700cb3b6dca", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/a610003437bf476aafad7f45b6f04700cb3b6dca", "committedDate": "2020-04-18T16:16:00Z", "message": "optimize FileWriteOutBytes to avoid high sys cpu -- avoid IOEception never thrown check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTc3OTIz", "url": "https://github.com/apache/druid/pull/9722#pullrequestreview-397577923", "createdAt": "2020-04-21T18:43:35Z", "commit": {"oid": "a610003437bf476aafad7f45b6f04700cb3b6dca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODo0MzozNVrOGJTEpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODo0MzozNVrOGJTEpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwMjg1NQ==", "bodyText": "I think this is cleaner\n  public long size()\n  {\n    return writeOutBytes;\n  }", "url": "https://github.com/apache/druid/pull/9722#discussion_r412402855", "createdAt": "2020-04-21T18:43:35Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/segment/writeout/FileWriteOutBytes.java", "diffHunk": "@@ -105,8 +110,8 @@ public void write(byte[] b, int off, int len) throws IOException\n   @Override\n   public long size() throws IOException\n   {\n-    flush();\n-    return ch.size();\n+    flushIfNeeded(0); // To avoid check the declared IOException never thrown error", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a610003437bf476aafad7f45b6f04700cb3b6dca"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93dadcf927c6df341058d4c49ba5a331f4266bf0", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/93dadcf927c6df341058d4c49ba5a331f4266bf0", "committedDate": "2020-04-21T20:18:12Z", "message": "Merge remote-tracking branch 'upstream/master' into pr_9722"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69954723bddf223ae1eddb5387de10bcd88b8e7a", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/69954723bddf223ae1eddb5387de10bcd88b8e7a", "committedDate": "2020-04-21T21:38:47Z", "message": "Fix size counting to handle IOE in FileWriteOutBytes + tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Njk3NTU4", "url": "https://github.com/apache/druid/pull/9722#pullrequestreview-397697558", "createdAt": "2020-04-21T21:43:00Z", "commit": {"oid": "a610003437bf476aafad7f45b6f04700cb3b6dca"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73c9572731aa0e0bb2434654406bc67d0d2fe5e6", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/73c9572731aa0e0bb2434654406bc67d0d2fe5e6", "committedDate": "2020-04-22T03:56:55Z", "message": "Merge remote-tracking branch 'upstream/master' into feature-optimize-file-write-out\n\npull FileWriteOutBytesTest from upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf81212b0248384d8a8a38c72e03eaed98f68199", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/cf81212b0248384d8a8a38c72e03eaed98f68199", "committedDate": "2020-04-22T06:14:20Z", "message": "Merge branch 'pr_9741' into feature-optimize-file-write-out\n\nmerge tests from pr_9741"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290973536d2566e5e2ecc62507940e7dfc2bf3f5", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/290973536d2566e5e2ecc62507940e7dfc2bf3f5", "committedDate": "2020-04-22T16:22:12Z", "message": "remove unused throws IOException in WriteOutBytes.size()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzY5MDM5", "url": "https://github.com/apache/druid/pull/9722#pullrequestreview-398369039", "createdAt": "2020-04-22T16:32:38Z", "commit": {"oid": "290973536d2566e5e2ecc62507940e7dfc2bf3f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f6602aaf1660d4d9036d11e410f5879fa078457", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/2f6602aaf1660d4d9036d11e410f5879fa078457", "committedDate": "2020-04-22T16:36:08Z", "message": "Merge remote-tracking branch 'upstream/master' into feature-optimize-file-write-out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7876c7bb3897b3565d7d6869f80e0383d08cd23", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/e7876c7bb3897b3565d7d6869f80e0383d08cd23", "committedDate": "2020-04-22T20:56:52Z", "message": "Remove redundant throws IOExcpetion clauses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b50f6315cf4c44d8035cf3971790786e5f1b7652", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/b50f6315cf4c44d8035cf3971790786e5f1b7652", "committedDate": "2020-04-23T00:55:10Z", "message": "Parameterize IndexMergeBenchmark"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTgzNDcy", "url": "https://github.com/apache/druid/pull/9722#pullrequestreview-399583472", "createdAt": "2020-04-24T01:32:36Z", "commit": {"oid": "b50f6315cf4c44d8035cf3971790786e5f1b7652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2534, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}