{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4NTk5Njcx", "number": 9519, "title": "Ability to Delete task logs and segments from Google Storage", "bodyText": "Description\n\n\nimplement ability to delete all tasks logs or all task logs\nwritten before a particular date when written to Google storage\n\n\nimplement ability to delete all segments from Google deep storage\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-15T06:41:58Z", "url": "https://github.com/apache/druid/pull/9519", "merged": true, "mergeCommit": {"oid": "838735411f495e355820da35ab0765a56a95b090"}, "closed": true, "closedAt": "2020-03-19T01:00:44Z", "author": {"login": "zachjsh"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNzqDDgH2gAyMzg4NTk5NjcxOjMyYmVlNjNjMzIxZDZiN2M3YmZlYTJkZDdmZjQ3YjUxY2I0NDIzMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO_WWNgH2gAyMzg4NTk5NjcxOmNjZTYyM2E2OTA0MTQ1MGJjZTJkNTdlZmYyMTY3MzYyZWEzMzg4YWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/32bee63c321d6b7c7bfea2dd7ff47b51cb44230d", "committedDate": "2020-03-15T06:38:11Z", "message": "Ability to Delete task logs and segments from Google Storage\n\n* implement ability to delete all tasks logs or all task logs\n  written before a particular date when written to Google storage\n\n* implement ability to delete all segments from Google deep storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjY2MDcy", "url": "https://github.com/apache/druid/pull/9519#pullrequestreview-376666072", "createdAt": "2020-03-18T08:54:39Z", "commit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo1NDo0MFrOF37YQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo1NzozNlrOF37elg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4ODg2NQ==", "bodyText": "formatting\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  GoogleInputDataConfig inputDataConfig)\n          \n          \n            \n                  GoogleInputDataConfig inputDataConfig\n          \n          \n            \n              )", "url": "https://github.com/apache/druid/pull/9519#discussion_r394188865", "createdAt": "2020-03-18T08:54:40Z", "author": {"login": "clintropolis"}, "path": "extensions-core/google-extensions/src/main/java/org/apache/druid/storage/google/GoogleDataSegmentKiller.java", "diffHunk": "@@ -37,11 +38,18 @@\n   private static final Logger LOG = new Logger(GoogleDataSegmentKiller.class);\n \n   private final GoogleStorage storage;\n+  private final GoogleAccountConfig accountConfig;\n+  private final GoogleInputDataConfig inputDataConfig;\n \n   @Inject\n-  public GoogleDataSegmentKiller(final GoogleStorage storage)\n+  public GoogleDataSegmentKiller(\n+      final GoogleStorage storage,\n+      GoogleAccountConfig accountConfig,\n+      GoogleInputDataConfig inputDataConfig)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4OTIyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"Deleting all segment files from gs location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                         accountConfig.getBucket(), accountConfig.getPrefix()\n          \n          \n            \n                LOG.info(\n          \n          \n            \n                    \"Deleting all segment files from gs location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                    accountConfig.getBucket(),\n          \n          \n            \n                    accountConfig.getPrefix()", "url": "https://github.com/apache/druid/pull/9519#discussion_r394189223", "createdAt": "2020-03-18T08:55:20Z", "author": {"login": "clintropolis"}, "path": "extensions-core/google-extensions/src/main/java/org/apache/druid/storage/google/GoogleDataSegmentKiller.java", "diffHunk": "@@ -93,8 +101,23 @@ private void deleteIfPresent(String bucket, String path) throws IOException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    LOG.info(\"Deleting all segment files from gs location [bucket: '%s' prefix: '%s']\",\n+             accountConfig.getBucket(), accountConfig.getPrefix()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4OTQyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  CurrentTimeMillisSupplier timeSupplier)\n          \n          \n            \n                  CurrentTimeMillisSupplier timeSupplier\n          \n          \n            \n              )", "url": "https://github.com/apache/druid/pull/9519#discussion_r394189424", "createdAt": "2020-03-18T08:55:39Z", "author": {"login": "clintropolis"}, "path": "extensions-core/google-extensions/src/main/java/org/apache/druid/storage/google/GoogleTaskLogs.java", "diffHunk": "@@ -33,19 +34,28 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.nio.file.Files;\n+import java.util.Date;\n \n public class GoogleTaskLogs implements TaskLogs\n {\n   private static final Logger LOG = new Logger(GoogleTaskLogs.class);\n \n   private final GoogleTaskLogsConfig config;\n   private final GoogleStorage storage;\n+  private final GoogleInputDataConfig inputDataConfig;\n+  private final CurrentTimeMillisSupplier timeSupplier;\n \n   @Inject\n-  public GoogleTaskLogs(GoogleTaskLogsConfig config, GoogleStorage storage)\n+  public GoogleTaskLogs(\n+      GoogleTaskLogsConfig config,\n+      GoogleStorage storage,\n+      GoogleInputDataConfig inputDataConfig,\n+      CurrentTimeMillisSupplier timeSupplier)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4OTY4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'].\",\n          \n          \n            \n                         config.getBucket(), config.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                LOG.info(\n          \n          \n            \n                    \"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'].\",\n          \n          \n            \n                    config.getBucket(),\n          \n          \n            \n                    config.getPrefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9519#discussion_r394189685", "createdAt": "2020-03-18T08:56:07Z", "author": {"login": "clintropolis"}, "path": "extensions-core/google-extensions/src/main/java/org/apache/druid/storage/google/GoogleTaskLogs.java", "diffHunk": "@@ -159,14 +169,34 @@ private String getTaskReportKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    LOG.info(\"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'].\",\n+             config.getBucket(), config.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE5MDA4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                         config.getBucket(), config.getPrefix(), new Date(timestamp)\n          \n          \n            \n                );\n          \n          \n            \n                LOG.info(\n          \n          \n            \n                    \"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                    config.getBucket(),\n          \n          \n            \n                    config.getPrefix(),\n          \n          \n            \n                    new Date(timestamp)\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9519#discussion_r394190082", "createdAt": "2020-03-18T08:56:51Z", "author": {"login": "clintropolis"}, "path": "extensions-core/google-extensions/src/main/java/org/apache/druid/storage/google/GoogleTaskLogs.java", "diffHunk": "@@ -159,14 +169,34 @@ private String getTaskReportKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    LOG.info(\"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'].\",\n+             config.getBucket(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    LOG.info(\"Deleting all task logs from gs location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getBucket(), config.getPrefix(), new Date(timestamp)\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE5MDQ4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from s3 location [bucket: '%s' prefix: '%s'].\",\n          \n          \n            \n                         config.getS3Bucket(), config.getS3Prefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from s3 location [bucket: '%s' prefix: '%s'].\",\n          \n          \n            \n                    config.getS3Bucket(),\n          \n          \n            \n                    config.getS3Prefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9519#discussion_r394190486", "createdAt": "2020-03-18T08:57:36Z", "author": {"login": "clintropolis"}, "path": "extensions-core/s3-extensions/src/main/java/org/apache/druid/storage/s3/S3TaskLogs.java", "diffHunk": "@@ -165,7 +165,7 @@ String getTaskLogKey(String taskid, String filename)\n   @Override\n   public void killAll() throws IOException\n   {\n-    log.info(\"Deleting all task logs from s3 location [bucket: %s    prefix: %s].\",\n+    log.info(\"Deleting all task logs from s3 location [bucket: '%s' prefix: '%s'].\",\n              config.getS3Bucket(), config.getS3Prefix()\n     );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32bee63c321d6b7c7bfea2dd7ff47b51cb44230d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce623a69041450bce2d57eff2167362ea3388ae", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/cce623a69041450bce2d57eff2167362ea3388ae", "committedDate": "2020-03-18T22:49:27Z", "message": "* Address review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2654, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}