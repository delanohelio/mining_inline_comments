{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NDA2NzA2", "number": 10379, "title": "Adding task slot count metrics to Druid Overlord", "bodyText": "Fixes #10378 .\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-10T22:45:20Z", "url": "https://github.com/apache/druid/pull/10379", "merged": true, "mergeCommit": {"oid": "8168e14e9224c9459efda07b038269815975cf50"}, "closed": true, "closedAt": "2020-09-29T06:50:39Z", "author": {"login": "mghosh4"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHovlcgH2gAyNDg0NDA2NzA2OmFmMjY5YWI0ZDJhZTEwNTg5NGUzMDA0ZmM5YzY3MDg5NjhhMjc2YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNiggsAFqTQ5ODE0MjU5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af269ab4d2ae105894e3004fc9c6708968a276a5", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/af269ab4d2ae105894e3004fc9c6708968a276a5", "committedDate": "2020-09-10T22:42:53Z", "message": "Adding more worker metrics to Druid Overlord"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90a7c72863531d509323fad403639993f7ba314f", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/90a7c72863531d509323fad403639993f7ba314f", "committedDate": "2020-09-14T23:12:41Z", "message": "Changing the nomenclature from worker to peon as that represents the metrics that we want to monitor better"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3292dc641e079fbd68ca861c10592095039b659", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/c3292dc641e079fbd68ca861c10592095039b659", "committedDate": "2020-09-14T23:20:14Z", "message": "Few more instance of worker usage replaced with peon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e08eea8a6d4898785625d4e5d2e64295c1ae49", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/73e08eea8a6d4898785625d4e5d2e64295c1ae49", "committedDate": "2020-09-15T21:21:28Z", "message": "Modifying the peon idle count logic to only use eligible workers available capacity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb", "committedDate": "2020-09-15T23:58:56Z", "message": "Changing the naming to task slot count instead of peon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MjI5OTc1", "url": "https://github.com/apache/druid/pull/10379#pullrequestreview-489229975", "createdAt": "2020-09-16T02:27:08Z", "commit": {"oid": "df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMjoyNzowOFrOHSdvig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMjoyNzowOFrOHSdvig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEyMzcyMg==", "bodyText": "How about adding new interfaces such as TaskSlotCountable and WorkerCountable? Then, we can avoid implementing unnecessary interfaces, e.g., the new methods in SingleThreadedBackgroundRunner, by implementing required interfaces only.", "url": "https://github.com/apache/druid/pull/10379#discussion_r489123722", "createdAt": "2020-09-16T02:27:08Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/TaskRunner.java", "diffHunk": "@@ -121,4 +121,17 @@ default TaskLocation getTaskLocation(String taskId)\n    * @return ScalingStats if the runner has an underlying resource which can scale, Optional.absent() otherwise\n    */\n   Optional<ScalingStats> getScalingStats();\n+\n+  /**\n+   * APIs useful for emitting statistics for @TaskSlotCountStatsMonitor\n+  */\n+  long getTotalTaskSlotCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df7ff187efcf70aa24bc8b69ab3b8dab9198b9eb"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/3590ba8be86b21a85cf43815c6b90feac51cf040", "committedDate": "2020-09-18T05:52:26Z", "message": "Adding some unit test coverage for the new test runner apis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDk1MzAz", "url": "https://github.com/apache/druid/pull/10379#pullrequestreview-495095303", "createdAt": "2020-09-23T22:36:19Z", "commit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMjozNjoxOVrOHXDSWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzo1NTo0MlrOHXFD4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzMzE0Nw==", "bodyText": "I left a same comment in #10378 (comment). Please clarify the description on these metrics.", "url": "https://github.com/apache/druid/pull/10379#discussion_r493933147", "createdAt": "2020-09-23T22:36:19Z", "author": {"login": "jihoonson"}, "path": "docs/operations/metrics.md", "diffHunk": "@@ -186,6 +186,11 @@ Note: If the JVM does not support CPU time measurement for the current thread, i\n |`task/running/count`|Number of current running tasks. This metric is only available if the TaskCountStatsMonitor module is included.|dataSource.|Varies.|\n |`task/pending/count`|Number of current pending tasks. This metric is only available if the TaskCountStatsMonitor module is included.|dataSource.|Varies.|\n |`task/waiting/count`|Number of current waiting tasks. This metric is only available if the TaskCountStatsMonitor module is included.|dataSource.|Varies.|\n+|`taskSlot/total/count`|Number of total task slots per emission period. This metric is only available if the TaskSlotCountStatsMonitor module is included.| |Varies.|\n+|`taskSlot/idle/count`|Number of idle task slots per emission period. This metric is only available if the TaskSlotCountStatsMonitor module is included.| |Varies.|\n+|`taskSlot/used/count`|Number of busy task slots per emission period. This metric is only available if the TaskSlotCountStatsMonitor module is included.| |Varies.|\n+|`taskSlot/lazy/count`|Number of lazy task slots per emission period. This metric is only available if the TaskSlotCountStatsMonitor module is included.| |Varies.|\n+|`taskSlot/blacklisted/count`|Number of blacklisted task slots per emission period. This metric is only available if the TaskSlotCountStatsMonitor module is included.| |Varies.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzNTk3Mw==", "bodyText": "I think this monitor should emit metrics only when TaskMaster is a leader. Check out what TaskCountStatsMonitor does. Probably new interfaces in TaskSlotCountStatsProvider should be able to return null when TaskMaster is not a leader.", "url": "https://github.com/apache/druid/pull/10379#discussion_r493935973", "createdAt": "2020-09-23T22:44:31Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsMonitor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+import com.google.inject.Inject;\n+import org.apache.druid.java.util.emitter.service.ServiceEmitter;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent;\n+import org.apache.druid.java.util.metrics.AbstractMonitor;\n+\n+public class TaskSlotCountStatsMonitor extends AbstractMonitor\n+{\n+  private final TaskSlotCountStatsProvider statsProvider;\n+\n+  @Inject\n+  public TaskSlotCountStatsMonitor(\n+          TaskSlotCountStatsProvider statsProvider\n+  )\n+  {\n+    this.statsProvider = statsProvider;\n+  }\n+\n+  @Override\n+  public boolean doMonitor(ServiceEmitter emitter)\n+  {\n+    emit(emitter, \"taskSlot/total/count\", statsProvider.getTotalTaskSlotCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1NjY5MA==", "bodyText": "Even though this method was always called under a lock on workerWithUnacknowledgedTask before, this change seems OK because it will still be called under the same lock in tryAssignTask, and the new caller getIdleTaskSlotCount doesn't seem to require locking (as it doesn't update the workerWithUnacknowledgedTask map.", "url": "https://github.com/apache/druid/pull/10379#discussion_r493956690", "createdAt": "2020-09-23T23:43:26Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/RemoteTaskRunner.java", "diffHunk": "@@ -867,6 +857,18 @@ private boolean tryAssignTask(final Task task, final RemoteTaskRunnerWorkItem ta\n     }\n   }\n \n+  Map<String, ImmutableWorkerInfo> getWorkersEligibleToRunTasks()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MTY5OQ==", "bodyText": "It seems OK without this synchronization.", "url": "https://github.com/apache/druid/pull/10379#discussion_r493961699", "createdAt": "2020-09-23T23:53:56Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/overlord/hrtr/HttpRemoteTaskRunner.java", "diffHunk": "@@ -1342,6 +1343,13 @@ public TaskLocation getTaskLocation(String taskId)\n     ).collect(Collectors.toList());\n   }\n \n+  public Collection<ImmutableWorkerInfo> getBlackListedWorkers()\n+  {\n+    synchronized (blackListedWorkers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MjIwOQ==", "bodyText": "Please clarify the Javadoc of these methods too. It should be the number of task slots of lazy/blacklisted middleManagers and indexers.", "url": "https://github.com/apache/druid/pull/10379#discussion_r493962209", "createdAt": "2020-09-23T23:55:42Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsProvider.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+public interface TaskSlotCountStatsProvider\n+{\n+  /**\n+   * Return the number of total task slots during emission period.\n+   */\n+  long getTotalTaskSlotCount();\n+\n+  /**\n+   * Return the number of idle task slots during emission period.\n+   */\n+  long getIdleTaskSlotCount();\n+\n+  /**\n+   * Return the number of used task slots during emission period.\n+   */\n+  long getUsedTaskSlotCount();\n+\n+  /**\n+   * Return the number of lazy task slots during emission period.\n+   */\n+  long getLazyTaskSlotCount();\n+\n+  /**\n+   * Return the number of blacklisted task slots during emission period.\n+   */\n+  long getBlacklistedTaskSlotCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3590ba8be86b21a85cf43815c6b90feac51cf040"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a1673b47956449a230e65eb396360be7cc81637", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/7a1673b47956449a230e65eb396360be7cc81637", "committedDate": "2020-09-24T01:05:11Z", "message": "Addressing Review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a12eb773613bd409c4eea79b902dae67718b807", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/5a12eb773613bd409c4eea79b902dae67718b807", "committedDate": "2020-09-24T02:26:13Z", "message": "Modifying the TaskSlotCountStatsProvider apis so that overlords which are not leader do not emit these metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61343eb4995b94427816a168d4632e3112b245e2", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/61343eb4995b94427816a168d4632e3112b245e2", "committedDate": "2020-09-24T17:04:30Z", "message": "Fixing the spelling issue in the docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODIzOTEz", "url": "https://github.com/apache/druid/pull/10379#pullrequestreview-495823913", "createdAt": "2020-09-24T18:06:13Z", "commit": {"oid": "61343eb4995b94427816a168d4632e3112b245e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODowNjoxM1rOHXmmeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODowNjoxM1rOHXmmeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMTczOA==", "bodyText": "Please annotate the return value with @Nullable. Same comment for other methods.", "url": "https://github.com/apache/druid/pull/10379#discussion_r494511738", "createdAt": "2020-09-24T18:06:13Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/metrics/TaskSlotCountStatsProvider.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.metrics;\n+\n+public interface TaskSlotCountStatsProvider\n+{\n+  /**\n+   * Return the number of total task slots during emission period.\n+   */\n+  Long getTotalTaskSlotCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61343eb4995b94427816a168d4632e3112b245e2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a058cadbdb00bc1cdd2be2f57db67032e3030a9", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/9a058cadbdb00bc1cdd2be2f57db67032e3030a9", "committedDate": "2020-09-24T19:00:16Z", "message": "Setting the annotation Nullable on the TaskSlotCountStatsProvider methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTMxMTg0", "url": "https://github.com/apache/druid/pull/10379#pullrequestreview-495931184", "createdAt": "2020-09-24T20:35:02Z", "commit": {"oid": "9a058cadbdb00bc1cdd2be2f57db67032e3030a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MTQyNTk1", "url": "https://github.com/apache/druid/pull/10379#pullrequestreview-498142595", "createdAt": "2020-09-29T06:50:32Z", "commit": {"oid": "9a058cadbdb00bc1cdd2be2f57db67032e3030a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3611, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}