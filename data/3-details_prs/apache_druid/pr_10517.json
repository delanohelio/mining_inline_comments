{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1NDAzNDk1", "number": 10517, "title": "Fix compaction integration test CI timeout", "bodyText": "Fix compaction integration test CI timeout\nDescription\nCompaction integration test intermittently timeout (Travis job stuck until timeout of 50 minutes and/or Travis job terminates after 10 mins of not receiving new output) due to one of the test submitting/running too many tasks at the same time. Specifically, the test submits range partitioning compaction tasks with 2 subtasks each (for a total of 6 tasks). This causes the cluster to intermittently fails. I am not sure what is the real maximum number of tasks the Druid cluster running in Travis can handle. It probably also depends on the type of tasks too. Anyhow, changed the task to only have 1 subtask each (for a total of 4 tasks) and the intermittent failure is now fixed.\nPlease see below for Travis build with 72 compaction integration test.\n\nWithout any change from this PR. We can see that about 25% failed due to the above issue. https://travis-ci.org/github/maytasm/druid/builds/735867518\nRemoving the test that submits range partitioning compaction tasks with 2 subtasks each (for a total of 6 tasks). We can see that 100% passed. https://travis-ci.org/github/maytasm/druid/builds/736172442\nChanging the range partitioning compaction tasks to 1 subtask each. We can see that 100% passed. https://travis-ci.org/github/maytasm/druid/builds/736451204\n\nThis PR has:\n\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n\n added documentation for new or modified features or behaviors.\n\n\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n\n\n added or updated version, license, or notice information in licenses.yaml\n\n\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n\n\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n\n\n added integration tests.\n\n\n been tested in a test Druid cluster.\n\n\nFix compaction integration test CI timeout\n\n\nUpdate Integration test README on root cause of the test failure.", "createdAt": "2020-10-18T06:00:09Z", "url": "https://github.com/apache/druid/pull/10517", "merged": true, "mergeCommit": {"oid": "1b9a8c46874520d22b65573eeabfa3a62e16a5e0"}, "closed": true, "closedAt": "2020-10-22T05:38:11Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSkdmRgH2gAyNTA1NDAzNDk1OmFiZjA2NDA3ZDdlNzBiN2YzNTEyOTEzNzFhYmY3Y2IzOThhYmZiNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU4OWsgFqTUxNDMwOTMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "abf06407d7e70b7f351291371abf7cb398abfb6b", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/abf06407d7e70b7f351291371abf7cb398abfb6b", "committedDate": "2020-10-14T21:56:47Z", "message": "fix flaky IT Compaction test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd4da71bd17ca1ede3abf6b2cf155768be9250d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/0bd4da71bd17ca1ede3abf6b2cf155768be9250d", "committedDate": "2020-10-14T22:03:49Z", "message": "fix flaky IT Compaction test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c3c90b8ccfd26a041aff7ee2c2757f5021196be", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/9c3c90b8ccfd26a041aff7ee2c2757f5021196be", "committedDate": "2020-10-15T20:36:42Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06c3e28610d7940837b362f5432c742463bcb46d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/06c3e28610d7940837b362f5432c742463bcb46d", "committedDate": "2020-10-15T20:41:31Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76356058d4512277906bf4b3054a9f97cb14f41f", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/76356058d4512277906bf4b3054a9f97cb14f41f", "committedDate": "2020-10-15T20:42:39Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e49aef01cbf41cd41aea2a42d7d0a874dc0d1cbf", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/e49aef01cbf41cd41aea2a42d7d0a874dc0d1cbf", "committedDate": "2020-10-16T17:54:33Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09a5581a1d9bb8f4ca49377299c499634299218", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/d09a5581a1d9bb8f4ca49377299c499634299218", "committedDate": "2020-10-18T05:49:11Z", "message": "Fix compaction integration test CI timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDM2MTA3", "url": "https://github.com/apache/druid/pull/10517#pullrequestreview-511036107", "createdAt": "2020-10-18T06:02:13Z", "commit": {"oid": "d09a5581a1d9bb8f4ca49377299c499634299218"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQwNjowMjoxNFrOHjiKGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQwNjowMjoxNFrOHjiKGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAyMTg1MQ==", "bodyText": "This comment was stale. The compaction slot was always 5. It was not changed in this PR.", "url": "https://github.com/apache/druid/pull/10517#discussion_r507021851", "createdAt": "2020-10-18T06:02:14Z", "author": {"login": "maytasm"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/coordinator/duty/ITAutoCompactionTest.java", "diffHunk": "@@ -77,7 +77,7 @@\n   @BeforeMethod\n   public void setup() throws Exception\n   {\n-    // Set comapction slot to 10\n+    // Set comapction slot to 5", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09a5581a1d9bb8f4ca49377299c499634299218"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTk1Njk0", "url": "https://github.com/apache/druid/pull/10517#pullrequestreview-511995694", "createdAt": "2020-10-19T17:30:44Z", "commit": {"oid": "d09a5581a1d9bb8f4ca49377299c499634299218"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozMDo0NVrOHkZfWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozMDo0NVrOHkZfWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyODQwOQ==", "bodyText": "typo: fails -> fail", "url": "https://github.com/apache/druid/pull/10517#discussion_r507928409", "createdAt": "2020-10-19T17:30:45Z", "author": {"login": "jihoonson"}, "path": "integration-tests/README.md", "diffHunk": "@@ -385,3 +386,12 @@ Please be mindful when adding tests to the \"AllParallelizedTests\" test tag that\n other tests from the same class at the same time. i.e. test does not modify/restart/stop the druid cluster or other dependency containers,\n test does not use excessive memory starving other concurent task, test does not modify and/or use other task, \n supervisor, datasource it did not create. \n+\n+### Limitation of Druid cluster in Travis environment\n+\n+By default, integration tests are run in Travis environment on commits made to open PR. These integration test jobs are\n+required to pass for a PR to be elligible to be merged. Here are known issues and limitations to the Druid docker cluster\n+running in Travis machine that may cause the tests to fail:\n+- Number of concurrent running tasks. Although the default Druid cluster config sets the maximum number of tasks (druid.worker.capacity) to 10,\n+the actual maximum can be lower depending on the type of the tasks. For example, running 2 range partitioning compaction tasks with 2 subtasks each \n+(for a total of 6 tasks) concurrently can cause the cluster to intermittently fails.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09a5581a1d9bb8f4ca49377299c499634299218"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ca34b7101d1f215d041fc96dc62a27161175cb8", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/0ca34b7101d1f215d041fc96dc62a27161175cb8", "committedDate": "2020-10-19T19:26:43Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "673c3105a2290d690bc19d371457aaeef242e266", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/673c3105a2290d690bc19d371457aaeef242e266", "committedDate": "2020-10-20T05:52:47Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eb5b5641deb9a2b3f16a2717808acee972ec5ab", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/9eb5b5641deb9a2b3f16a2717808acee972ec5ab", "committedDate": "2020-10-20T05:53:45Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b9b7bc1667e267835c3821af65a3b69bd6e02e", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/52b9b7bc1667e267835c3821af65a3b69bd6e02e", "committedDate": "2020-10-20T07:08:10Z", "message": "Add print logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTE5MTY0", "url": "https://github.com/apache/druid/pull/10517#pullrequestreview-514119164", "createdAt": "2020-10-21T19:40:51Z", "commit": {"oid": "52b9b7bc1667e267835c3821af65a3b69bd6e02e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0MDo1MVrOHmAntg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0MDo1MVrOHmAntg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYxODEwMg==", "bodyText": "How about showing a certain amount of logs at the end instead of printing the whole? It will likely kill the Travis job by hitting the max number of logs per job. You can add a offset query parameter when you call the Overlord API.", "url": "https://github.com/apache/druid/pull/10517#discussion_r509618102", "createdAt": "2020-10-21T19:40:51Z", "author": {"login": "jihoonson"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/indexer/AbstractIndexerTest.java", "diffHunk": "@@ -69,6 +73,16 @@ protected Closeable unloader(final String dataSource)\n \n   protected void unloadAndKillData(final String dataSource)\n   {\n+    // Get all failed task logs\n+    List<TaskResponseObject> allTasks = indexer.getCompleteTasksForDataSource(dataSource);\n+    for (TaskResponseObject task : allTasks) {\n+      if (task.getStatus().isFailure()) {\n+        LOG.info(\"------- Found failed task. Start log:\");\n+        LOG.info(indexer.getTaskLog(task.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52b9b7bc1667e267835c3821af65a3b69bd6e02e"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecce6faea781a492e42cf69ae390894b7e2b713c", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/ecce6faea781a492e42cf69ae390894b7e2b713c", "committedDate": "2020-10-22T00:54:14Z", "message": "add error msg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59244d6697ae13df01a04ce08204b591ddff1d46", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/59244d6697ae13df01a04ce08204b591ddff1d46", "committedDate": "2020-10-22T01:11:37Z", "message": "add taskId to logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzA5MzE3", "url": "https://github.com/apache/druid/pull/10517#pullrequestreview-514309317", "createdAt": "2020-10-22T02:06:05Z", "commit": {"oid": "59244d6697ae13df01a04ce08204b591ddff1d46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3380, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}