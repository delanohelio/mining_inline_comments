{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNTY3NzU5", "number": 10196, "title": "Fix broken sampler for re-indexing", "bodyText": "Fixes  #10197\nDescription\nWhen re-indexing a Druid datasource, the web-console would generate an invalid inputFormat\nsince the type is not specified. The DruidInputSource does not need an InputFormat, so this change\nskips adding an inputFormat to the provided spec.\n\nThis PR has:\n\n been self-reviewed.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-07-18T00:07:26Z", "url": "https://github.com/apache/druid/pull/10196", "merged": true, "mergeCommit": {"oid": "6baea0b4d510e81095c13ece59c8426d63216f8f"}, "closed": true, "closedAt": "2020-08-12T02:22:27Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc188LPAH2gAyNDUxNTY3NzU5OmQxZjc3MmZlMGVkNmFkYmVkZWEzMGZmNGNkYWVkOTM4ZGI5NjcxNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-B5mCAFqTQ2NTU0ODE3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1f772fe0ed6adbedea30ff4cdaed938db967148", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/d1f772fe0ed6adbedea30ff4cdaed938db967148", "committedDate": "2020-07-18T00:04:06Z", "message": "Fix broken sampler for re-indexer\n\nWhen re-indexing a Druid datasource, the web-console would generate an\ninvalid inputFormat since the type is not specified."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDEzNzEw", "url": "https://github.com/apache/druid/pull/10196#pullrequestreview-451013710", "createdAt": "2020-07-18T00:29:48Z", "commit": {"oid": "d1f772fe0ed6adbedea30ff4cdaed938db967148"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMDoyOTo0OVrOGzkRtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMDoyOTo0OVrOGzkRtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcyNDkxNw==", "bodyText": "the issue is that ioConfig = deepSet(ioConfig, 'inputFormat.keepNullColumns', true); creates the ioConfig.inputFormat object even if it is not there. Right?\nI think the fix is to change:\nioConfig = deepSet(ioConfig, 'inputFormat.keepNullColumns', true);\n\nto:\nif (ioConfig.inputFormat) {\n  ioConfig = deepSet(ioConfig, 'inputFormat.keepNullColumns', true);\n}\n\nAnd not worry about the reingestMode here (we want to set keepNullColumns even if we are not re-ingesting)", "url": "https://github.com/apache/druid/pull/10196#discussion_r456724917", "createdAt": "2020-07-18T00:29:49Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/utils/sampler.ts", "diffHunk": "@@ -202,7 +203,10 @@ function makeSamplerIoConfig(\n     ioConfig = deepSet(ioConfig, 'useEarliestSequenceNumber', sampleStrategy === 'start');\n   }\n   // In order to prevent potential data loss null columns should be kept by the sampler and shown in the ingestion flow\n-  ioConfig = deepSet(ioConfig, 'inputFormat.keepNullColumns', true);\n+  const reingestMode = isDruidSourceFromInputSource(deepGet(ioConfig, 'inputSource'));\n+  if (!reingestMode) {\n+    ioConfig = deepSet(ioConfig, 'inputFormat.keepNullColumns', true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1f772fe0ed6adbedea30ff4cdaed938db967148"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "570f5897c0b9f7f2d49f289a472bcdd02f9751ee", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/570f5897c0b9f7f2d49f289a472bcdd02f9751ee", "committedDate": "2020-07-18T00:48:50Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTQ4MTc4", "url": "https://github.com/apache/druid/pull/10196#pullrequestreview-465548178", "createdAt": "2020-08-12T02:22:12Z", "commit": {"oid": "570f5897c0b9f7f2d49f289a472bcdd02f9751ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1864, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}