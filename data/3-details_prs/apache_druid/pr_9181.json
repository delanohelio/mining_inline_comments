{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDMwMzAx", "number": 9181, "title": "Speed up String first/last aggregators when folding isn't needed.", "bodyText": "Examines the value column, and disables fold checking via a needsFoldCheck\nflag if that column can't possibly contain SerializableLongStringPairs. This\nis helpful because it avoids calling getObject on the value selector when\nunnecessary; say, because the time selector didn't yield an earlier or later\nvalue.", "createdAt": "2020-01-14T03:50:55Z", "url": "https://github.com/apache/druid/pull/9181", "merged": true, "mergeCommit": {"oid": "448da787654ef6ebcab7bb5cba340b931c454320"}, "closed": true, "closedAt": "2020-01-17T05:02:03Z", "author": {"login": "gianm"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6IsVSAH2gAyMzYyNDMwMzAxOmVjYzQzMTA3MzIwNDg5ZWExMjY3YWVkN2IyZGJkMzBmNDQwMTA0Zjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7EyiggFqTM0NDMyNDY3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/ecc43107320489ea1267aed7b2dbd30f440104f9", "committedDate": "2020-01-14T03:50:12Z", "message": "Speed up String first/last aggregators when folding isn't needed.\n\nExamines the value column, and disables fold checking via a needsFoldCheck\nflag if that column can't possibly contain SerializableLongStringPairs. This\nis helpful because it avoids calling getObject on the value selector when\nunnecessary; say, because the time selector didn't yield an earlier or later\nvalue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMTM4NTY3", "url": "https://github.com/apache/druid/pull/9181#pullrequestreview-343138567", "createdAt": "2020-01-15T10:58:05Z", "commit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMDo1ODowNVrOFd0kmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMToyNToxNlrOFd1Png==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgxNDM2MQ==", "bodyText": "Hmm, it looks to me like this method only returns true if a selector definitely is a SerializablePairLongString . Should this just be returning true if we made it here?\nAlternatively, should needsFoldCheck be rebranded as isFold and the aggregate methods of the first last heap and buffer aggs just be reading a SerializablePairLongString from the value selector directly instead of calling readPairFromSelectors?", "url": "https://github.com/apache/druid/pull/9181#discussion_r366814361", "createdAt": "2020-01-15T10:58:05Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/StringFirstLastUtils.java", "diffHunk": "@@ -33,23 +36,63 @@\n {\n   private static final int NULL_VALUE = -1;\n \n+  /**\n+   * Shorten \"s\" to \"maxBytes\" chars. Fast and loose because these are *chars* not *bytes*. Use\n+   * {@link #chop(String, int)} for slower, but accurate chopping.\n+   */\n+  @Nullable\n+  public static String fastLooseChop(@Nullable final String s, final int maxBytes)\n+  {\n+    if (s == null || s.length() <= maxBytes) {\n+      return s;\n+    } else {\n+      return s.substring(0, maxBytes);\n+    }\n+  }\n+\n+  /**\n+   * Shorten \"s\" to what could fit in \"maxBytes\" bytes as UTF-8.\n+   */\n   @Nullable\n   public static String chop(@Nullable final String s, final int maxBytes)\n   {\n     if (s == null) {\n       return null;\n     } else {\n-      // Shorten firstValue to what could fit in maxBytes as UTF-8.\n       final byte[] bytes = new byte[maxBytes];\n       final int len = StringUtils.toUtf8WithLimit(s, ByteBuffer.wrap(bytes));\n       return new String(bytes, 0, len, StandardCharsets.UTF_8);\n     }\n   }\n \n+  /**\n+   * Returns whether a given value selector *might* contain SerializablePairLongString objects.\n+   */\n+  public static boolean selectorNeedsFoldCheck(\n+      final BaseObjectColumnValueSelector<?> valueSelector,\n+      @Nullable final ColumnCapabilities valueSelectorCapabilities\n+  )\n+  {\n+    if (valueSelectorCapabilities != null && valueSelectorCapabilities.getType() != ValueType.COMPLEX) {\n+      // Known, non-complex type.\n+      return false;\n+    }\n+\n+    if (valueSelector instanceof NilColumnValueSelector) {\n+      // Nil column, definitely no SerializablePairLongStrings.\n+      return false;\n+    }\n+\n+    // Check if the reported class could possibly be SerializablePairLongString.\n+    final Class<?> clazz = valueSelector.classOfObject();\n+    return clazz.isAssignableFrom(SerializablePairLongString.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgyNTM3NA==", "bodyText": "nit: typo 'expectec'", "url": "https://github.com/apache/druid/pull/9181#discussion_r366825374", "createdAt": "2020-01-15T11:25:16Z", "author": {"login": "clintropolis"}, "path": "processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java", "diffHunk": "@@ -81,6 +82,43 @@ public void testBufferAggregate()\n \n   }\n \n+  @Test\n+  public void testBufferAggregateWithFoldCheck()\n+  {\n+    final long[] timestamps = {1526724600L, 1526724700L, 1526724800L, 1526725900L, 1526725000L};\n+    final String[] strings = {\"AAAA\", \"BBBB\", \"CCCC\", \"DDDD\", \"EEEE\"};\n+    Integer maxStringBytes = 1024;\n+\n+    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n+    TestObjectColumnSelector<String> objectColumnSelector = new TestObjectColumnSelector<>(strings);\n+\n+    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n+        \"billy\", \"billy\", maxStringBytes\n+    );\n+\n+    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n+        longColumnSelector,\n+        objectColumnSelector,\n+        maxStringBytes,\n+        true\n+    );\n+\n+    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n+    int position = 0;\n+\n+    agg.init(buf, position);\n+    //noinspection ForLoopReplaceableByForEach\n+    for (int i = 0; i < timestamps.length; i++) {\n+      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n+    }\n+\n+    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n+\n+\n+    Assert.assertEquals(\"expectec last string value\", \"DDDD\", sp.rhs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjc4MTEx", "url": "https://github.com/apache/druid/pull/9181#pullrequestreview-343678111", "createdAt": "2020-01-16T05:19:02Z", "commit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f2218cf771c70b1173264e96621850bead8ea8", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/92f2218cf771c70b1173264e96621850bead8ea8", "committedDate": "2020-01-16T21:22:23Z", "message": "PR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c56d895caf30f0b3171ea5cc09615e551adeeae4", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/c56d895caf30f0b3171ea5cc09615e551adeeae4", "committedDate": "2020-01-16T22:47:00Z", "message": "Merge branch 'master' into speedy-earliest-latest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0d0075fe516cb52f8f8a84f2a891c2463ff09f9", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/f0d0075fe516cb52f8f8a84f2a891c2463ff09f9", "committedDate": "2020-01-17T01:43:47Z", "message": "Move fastLooseChop to StringUtils."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de0697cb1834f77a2fafc57e5d56673a558c5e83", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/de0697cb1834f77a2fafc57e5d56673a558c5e83", "committedDate": "2020-01-17T01:44:06Z", "message": "Merge branch 'master' into speedy-earliest-latest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzI0Njcz", "url": "https://github.com/apache/druid/pull/9181#pullrequestreview-344324673", "createdAt": "2020-01-17T01:51:02Z", "commit": {"oid": "de0697cb1834f77a2fafc57e5d56673a558c5e83"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTo1MTowM1rOFes1ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTo1MTowM1rOFes1ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzczNjE2NQ==", "bodyText": "\ud83d\ude42", "url": "https://github.com/apache/druid/pull/9181#discussion_r367736165", "createdAt": "2020-01-17T01:51:03Z", "author": {"login": "clintropolis"}, "path": "core/src/test/java/org/apache/druid/java/util/common/StringUtilsTest.java", "diffHunk": "@@ -246,4 +246,32 @@ public void testRpad()\n     Assert.assertEquals(s5, null);\n   }\n \n+  @Test\n+  public void testChop()\n+  {\n+    Assert.assertEquals(\"foo\", StringUtils.chop(\"foo\", 5));\n+    Assert.assertEquals(\"fo\", StringUtils.chop(\"foo\", 2));\n+    Assert.assertEquals(\"\", StringUtils.chop(\"foo\", 0));\n+    Assert.assertEquals(\"smile \ud83d\ude42 for\", StringUtils.chop(\"smile \ud83d\ude42 for the camera\", 14));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de0697cb1834f77a2fafc57e5d56673a558c5e83"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3730, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}