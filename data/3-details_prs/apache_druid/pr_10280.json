{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3ODEwNzY4", "number": 10280, "title": "recreate the balancer executor only when needed", "bodyText": "Fixes #10273", "createdAt": "2020-08-14T07:01:58Z", "url": "https://github.com/apache/druid/pull/10280", "merged": true, "mergeCommit": {"oid": "1b05d6e542fa3164a562f7112ee2d7a13c91d11e"}, "closed": true, "closedAt": "2020-09-16T19:25:58Z", "author": {"login": "ArvinZheng"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-vDiFgH2gAyNDY3ODEwNzY4OmJhYmU3OGVhZmVlN2E3MGM5OTZlZWVjYWI5NDZhOTMzYjQ3NDZhMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH2TJ3AFqTQ4Njg1ODk1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "babe78eafee7a70c996eeecab946a933b4746a07", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/babe78eafee7a70c996eeecab946a933b4746a07", "committedDate": "2020-08-14T06:58:47Z", "message": "recreate the balancer executor only when needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92157c1427b373243ba0ed8229decb3d5332804", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/b92157c1427b373243ba0ed8229decb3d5332804", "committedDate": "2020-08-14T18:18:29Z", "message": "fix UT error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd", "committedDate": "2020-08-14T21:15:48Z", "message": "Merge branch 'master' into druid-10273"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDg2NjMw", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-468086630", "createdAt": "2020-08-16T18:56:58Z", "commit": {"oid": "77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxODo1Njo1OFrOHBUe8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxODo1Njo1OFrOHBUe8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NjIyNA==", "bodyText": "do we need to worry about abandoning resources after removing this? Should the exec possibly be shutdown in stopBeingLeader() in your patch?", "url": "https://github.com/apache/druid/pull/10280#discussion_r471146224", "createdAt": "2020-08-16T18:56:58Z", "author": {"login": "capistrant"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -733,11 +762,24 @@ public void run()\n       catch (Exception e) {\n         log.makeAlert(e, \"Caught exception, ignoring so that schedule keeps going.\").emit();\n       }\n-      finally {\n-        if (balancerExec != null) {\n-          balancerExec.shutdownNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b81b6bef3e62d48a0565a1cc7379c2a1ddfafd"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/ebd0666acee5e3cc46186626755278d42df1ce32", "committedDate": "2020-08-18T06:02:30Z", "message": "shutdown the balancer executor in stopBeingLeader and stop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDI4OTM4", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-484428938", "createdAt": "2020-09-08T19:23:44Z", "commit": {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOToyMzo0NFrOHOq5vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOToyMzo0NFrOHOq5vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0NTAyMg==", "bodyText": "I see DutiesRunnable used to be public with a protected constructor but was flipped to private/private in pull 9644 ... Now we are flipping the class and constructor to protected. I want to make sure @maytasm sees this PR and can comment on the idea of going back to protected from private.", "url": "https://github.com/apache/druid/pull/10280#discussion_r485145022", "createdAt": "2020-09-08T19:23:44Z", "author": {"login": "capistrant"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -647,22 +678,53 @@ private void stopBeingLeader()\n     return ImmutableList.of(compactSegments);\n   }\n \n-  private class DutiesRunnable implements Runnable\n+  protected class DutiesRunnable implements Runnable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTA0NjQ2", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-484504646", "createdAt": "2020-09-08T21:27:22Z", "commit": {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNzoyMlrOHOumnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNzoyMlrOHOumnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTY2MA==", "bodyText": "unused variables should be removed instead of commented", "url": "https://github.com/apache/druid/pull/10280#discussion_r485205660", "createdAt": "2020-09-08T21:27:22Z", "author": {"login": "capistrant"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -653,8 +683,8 @@ private void stopBeingLeader()\n     private final long startTimeNanos = System.nanoTime();\n     private final List<CoordinatorDuty> duties;\n     private final int startingLeaderCounter;\n-    private int cachedBalancerThreadNumber;\n-    private ListeningExecutorService balancerExec;\n+    //private int cachedBalancerThreadNumber;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd0666acee5e3cc46186626755278d42df1ce32"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/1e502cb45efd86ff505976ce0b4df73bf2ce25f1", "committedDate": "2020-09-09T20:51:10Z", "message": "remove commented code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzU1NjI2", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-486355626", "createdAt": "2020-09-10T22:31:54Z", "commit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzY0MTE0", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-486364114", "createdAt": "2020-09-10T22:52:24Z", "commit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MjoyNFrOHQIZfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MjoyNFrOHQIZfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njg2Mg==", "bodyText": "nit: comment is not needed since we already have @VisibleForTesting annotation", "url": "https://github.com/apache/druid/pull/10280#discussion_r486676862", "createdAt": "2020-09-10T22:52:24Z", "author": {"login": "maytasm"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -483,6 +487,24 @@ public void moveSegment(\n     }\n   }\n \n+  /**\n+   * This method should be used for only testing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzY0MjAy", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-486364202", "createdAt": "2020-09-10T22:52:38Z", "commit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MjozOFrOHQIZzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MjozOFrOHQIZzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Njk0Mw==", "bodyText": "nit: same here as above", "url": "https://github.com/apache/druid/pull/10280#discussion_r486676943", "createdAt": "2020-09-10T22:52:38Z", "author": {"login": "maytasm"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -483,6 +487,24 @@ public void moveSegment(\n     }\n   }\n \n+  /**\n+   * This method should be used for only testing.\n+   */\n+  @VisibleForTesting\n+  public int getCachedBalancerThreadNumber()\n+  {\n+    return cachedBalancerThreadNumber;\n+  }\n+\n+  /**\n+   * This method should be used for only testing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e502cb45efd86ff505976ce0b4df73bf2ce25f1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "author": {"user": {"login": "ArvinZheng", "name": "Arvin.Z"}}, "url": "https://github.com/apache/druid/commit/85575950e46ea8ab767d0b63b9ea18ce1e9c4550", "committedDate": "2020-09-11T04:06:15Z", "message": "remove comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODU4OTU0", "url": "https://github.com/apache/druid/pull/10280#pullrequestreview-486858954", "createdAt": "2020-09-11T14:30:30Z", "commit": {"oid": "85575950e46ea8ab767d0b63b9ea18ce1e9c4550"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1970, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}