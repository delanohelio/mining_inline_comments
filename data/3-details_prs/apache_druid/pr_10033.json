{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MjA4MDcw", "number": 10033, "title": "Allow append to existing datasources when dynamic partitioning is used", "bodyText": "Fixes #9352. First PR of #10045.\nDescription\nThis PR is implemented on top of #10025 (you can see only the changes for this PR here: jihoonson/druid@hash-partition-core-set...jihoonson:append-dynamic).\nThis PR allows appending to existing datasources if the appended segments are partitioned using the dynamic partitionsSpec. The main change is found in IndexerSQLMetadataStorageCoordinator, which used to return null in createNewSegment() if the partitionsSpec is not compatible. It now allows segments to have mixed types of shardSpecs and finds the proper partitionId using a new method ShardSpec.sharePartitionSpace().\nA note for downgrade is that, as SingleDimensionShardSpec is changed to use NumberedPartitionChunk 1) to decouple partitionId and bucketId and 2) to allow append, the operators should be aware of that the appended segments to a range-partitioned datasource will be not recognized by Druid after downgrade. To avoid this, they should compact the segments in the core partitions and appended segments in each time chunk before downgrade.\nMost of the changes are new unit tests to verify the behavior. The added tests include\n\ntuningConfig test: allow only dynamic if appendToExisting = true\nAppend test\nWith time chunk lock\n\nAppend dynamically partitioned segments to a dynamically partitioned datasource\nAppend dynamically partitioned segments to a hash-partitioned datasource\nAppend dynamically partitioned segments to a range-partitioned datasource\nCompact segments of mixed shardSpecs\n\n\nWith segment lock\n\nAppend dynamically partitioned segments to a dynamically partitioned datasource\nOverwrite a datasource with segment lock and append dynamically partitioned segments\nCompact a subset of segments of mixed shardSpecs in each time chunk\n\n\n\nIntegration tests are still missing, I will add them in a follow-up pr.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.\n\n\nKey changed/added classes in this PR\n\nIndexerSQLMetadataStorageCoordinator\nShardSpec", "createdAt": "2020-06-14T21:57:46Z", "url": "https://github.com/apache/druid/pull/10033", "merged": true, "mergeCommit": {"oid": "aaee72c781dea0f06bd5781d085b356d5d4241d0"}, "closed": true, "closedAt": "2020-06-25T20:37:32Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 49, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpuYxWAH2gAyNDM0MjA4MDcwOmVkYWZkMTYxN2IyN2VmZjJlZWY4MTJlNDY5NzY5MzBkNzVmZDA5ZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuzGFQAFqTQzNzc1OTQzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "edafd1617b27eff2eef812e46976930d75fd09e8", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/edafd1617b27eff2eef812e46976930d75fd09e8", "committedDate": "2020-06-10T00:19:40Z", "message": "Fill in the core partition set size properly for batch ingestion with\ndynamic partitioning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "771eec1364aa3e2707a4c10d97cb372b15807842", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/771eec1364aa3e2707a4c10d97cb372b15807842", "committedDate": "2020-06-10T00:21:58Z", "message": "Merge branch 'master' of github.com:apache/druid into dynamic-partition-atomic-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1aeddb63487c4e646acc7b541fd00a3079479df", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/f1aeddb63487c4e646acc7b541fd00a3079479df", "committedDate": "2020-06-10T00:37:38Z", "message": "incomplete javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/42e37e2e85f58af0b0da4c7fcf6cfad29af4dadb", "committedDate": "2020-06-10T23:51:06Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5e197ea19b23d8cd68d61d9c5bb12da66a53332", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/d5e197ea19b23d8cd68d61d9c5bb12da66a53332", "committedDate": "2020-06-11T00:20:19Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99842f9d4793e185ab5c156ea1ff66b8ee187737", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/99842f9d4793e185ab5c156ea1ff66b8ee187737", "committedDate": "2020-06-11T01:13:07Z", "message": "fix json serde, add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2222b9a6596a88a9f44aa966adc364ba087c10e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b2222b9a6596a88a9f44aa966adc364ba087c10e", "committedDate": "2020-06-11T03:18:48Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ac529290320e64c4dd3e44a0c5d86f218397cd", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/f8ac529290320e64c4dd3e44a0c5d86f218397cd", "committedDate": "2020-06-11T22:00:40Z", "message": "Set core partition set size for hash-partitioned segments properly in\nbatch ingestion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4600bd689c3ab3e1580d7e531ff3751cf13b855a", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4600bd689c3ab3e1580d7e531ff3751cf13b855a", "committedDate": "2020-06-11T22:23:52Z", "message": "test for both parallel and single-threaded task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7448773ca598453cc27308da38eca0929a2de337", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/7448773ca598453cc27308da38eca0929a2de337", "committedDate": "2020-06-11T22:56:03Z", "message": "unused variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e2635fe76a93377e219cec5963338ec748a0d5", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/08e2635fe76a93377e219cec5963338ec748a0d5", "committedDate": "2020-06-12T00:39:13Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30cae0e323316f123c96b3db7023c0d68c0df4f6", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/30cae0e323316f123c96b3db7023c0d68c0df4f6", "committedDate": "2020-06-12T02:34:51Z", "message": "unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5664a6c4d3324f343971f9f8f655cabe46cbfd1e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/5664a6c4d3324f343971f9f8f655cabe46cbfd1e", "committedDate": "2020-06-13T07:48:09Z", "message": "add hash/range buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2c9bf3631eb39eb755a300385d12e2afdc2eef0", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/f2c9bf3631eb39eb755a300385d12e2afdc2eef0", "committedDate": "2020-06-13T15:47:24Z", "message": "some test adjustment and missing json serde"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af2b6958752674affa4a7e05019263eafe07cb0e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/af2b6958752674affa4a7e05019263eafe07cb0e", "committedDate": "2020-06-13T20:37:06Z", "message": "centralized partition id allocation in parallel and simple tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "209ad92b4d62f946565af2abf59c8b33e90a53de", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/209ad92b4d62f946565af2abf59c8b33e90a53de", "committedDate": "2020-06-13T20:47:34Z", "message": "Merge branch 'master' of github.com:apache/druid into hash-partition-core-set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae87c94af7f3e95fd4c3e060ac5c794decb24e73", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/ae87c94af7f3e95fd4c3e060ac5c794decb24e73", "committedDate": "2020-06-13T21:19:21Z", "message": "remove string partition chunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe705a9cfac40042b280530dace57ce8f12cd6e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/dbe705a9cfac40042b280530dace57ce8f12cd6e", "committedDate": "2020-06-13T21:33:13Z", "message": "revive string partition chunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e23248749c98d209cdc6dfc8cd7c589db1bc18", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/71e23248749c98d209cdc6dfc8cd7c589db1bc18", "committedDate": "2020-06-13T21:40:18Z", "message": "fill numCorePartitions for hadoop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6655afe81acba63caf0ea68a84f1466fb07b6dc", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/d6655afe81acba63caf0ea68a84f1466fb07b6dc", "committedDate": "2020-06-13T22:15:07Z", "message": "clean up hash stuffs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d0d3b90918793f36681e6201985156df2a1ca7e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/7d0d3b90918793f36681e6201985156df2a1ca7e", "committedDate": "2020-06-13T22:21:40Z", "message": "resolved todos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cff5b86a07367b73d0e3f147366ffd3ecb01334", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/6cff5b86a07367b73d0e3f147366ffd3ecb01334", "committedDate": "2020-06-13T23:40:56Z", "message": "javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a9e1b984abb976e3105104400e22032a73748f", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/07a9e1b984abb976e3105104400e22032a73748f", "committedDate": "2020-06-13T23:48:11Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e0ac6ef7f396c42501dbb3b6786ae45486e0d45", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/6e0ac6ef7f396c42501dbb3b6786ae45486e0d45", "committedDate": "2020-06-14T00:02:56Z", "message": "add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a27771ffe6a0c6cf784d2516ece13a91d6f671c", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4a27771ffe6a0c6cf784d2516ece13a91d6f671c", "committedDate": "2020-06-14T00:05:06Z", "message": "doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eaed9bdd649bfc571e5159dff4e758ba6935168", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/7eaed9bdd649bfc571e5159dff4e758ba6935168", "committedDate": "2020-06-14T01:14:10Z", "message": "unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db0a77acf690f15d8bcbb404aae391e7c59e7bf", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/2db0a77acf690f15d8bcbb404aae391e7c59e7bf", "committedDate": "2020-06-14T21:34:49Z", "message": "Allow append to existing datasources when dynamic partitioing is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "374a466a33e971933d53cf853001f986327b3873", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/374a466a33e971933d53cf853001f986327b3873", "committedDate": "2020-06-14T21:57:54Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1106c92f4cc5fc02ce3b8e7eafd64607de3e556e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/1106c92f4cc5fc02ce3b8e7eafd64607de3e556e", "committedDate": "2020-06-14T22:31:29Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f109a5a0740c1c187b18a0974e6fe582b2ecc511", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/f109a5a0740c1c187b18a0974e6fe582b2ecc511", "committedDate": "2020-06-14T22:41:38Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19d6546159123e2ab66feef5fbad6c82de749c8c", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/19d6546159123e2ab66feef5fbad6c82de749c8c", "committedDate": "2020-06-14T22:47:17Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d56a8870504bc88f822fd1842297a3eeeb5d2fe", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4d56a8870504bc88f822fd1842297a3eeeb5d2fe", "committedDate": "2020-06-15T00:55:41Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0475a63bbfe3b2a8b17ae976568d03c90fc79b60", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/0475a63bbfe3b2a8b17ae976568d03c90fc79b60", "committedDate": "2020-06-15T04:44:24Z", "message": "fix other tests.."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4da2f8b11deea1fcc622473043d6b1e896eda049", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4da2f8b11deea1fcc622473043d6b1e896eda049", "committedDate": "2020-06-15T16:23:58Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f246bbbc298e33e1bf0cbdc63d0270b1813e2e70", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/f246bbbc298e33e1bf0cbdc63d0270b1813e2e70", "committedDate": "2020-06-15T21:39:37Z", "message": "hansle unknown core partitions size in overlord segment allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d85a49a12238ae70ee4a257d809a644eef55c2bd", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/d85a49a12238ae70ee4a257d809a644eef55c2bd", "committedDate": "2020-06-17T03:26:35Z", "message": "fail to append when numCorePartitions is unknown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f48e446eceb5a14c057ed5a8b3c9d0232e23a7d", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/5f48e446eceb5a14c057ed5a8b3c9d0232e23a7d", "committedDate": "2020-06-17T03:29:03Z", "message": "log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4af415f9fd111c67570fb817b591a23616a3637a", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4af415f9fd111c67570fb817b591a23616a3637a", "committedDate": "2020-06-17T16:46:21Z", "message": "fix comment; rename to be more intuitive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21dea745f28abba1ab96bbd05294662e56668c50", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/21dea745f28abba1ab96bbd05294662e56668c50", "committedDate": "2020-06-18T20:16:47Z", "message": "double append test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc81b52cd3c3783aa4ab13540e81e8bca709202", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/8dc81b52cd3c3783aa4ab13540e81e8bca709202", "committedDate": "2020-06-19T02:10:01Z", "message": "Merge branch 'master' of github.com:apache/druid into append-dynamic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402c2dc9d9b4b71fdf6e94389c51535ae6a634cd", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/402c2dc9d9b4b71fdf6e94389c51535ae6a634cd", "committedDate": "2020-06-23T17:59:07Z", "message": "cleanup complete(); add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92a6e901f4d09612ceab0f4eddce1afb5feeebf8", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/92a6e901f4d09612ceab0f4eddce1afb5feeebf8", "committedDate": "2020-06-23T20:19:31Z", "message": "fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b423e964d258d2ba2f9760fa3224026157e98d0d", "committedDate": "2020-06-24T04:36:17Z", "message": "add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Mzg4OTI0", "url": "https://github.com/apache/druid/pull/10033#pullrequestreview-436388924", "createdAt": "2020-06-24T07:25:09Z", "commit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzoyNTowOVrOGoGGgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODoyNDoyMVrOGoIB_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NjE5Mg==", "bodyText": "just curious, this doesn't need to change, why does this test use new ObjectMapper() instead of MAPPER?", "url": "https://github.com/apache/druid/pull/10033#discussion_r444696192", "createdAt": "2020-06-24T07:25:09Z", "author": {"login": "clintropolis"}, "path": "core/src/test/java/org/apache/druid/timeline/partition/HashBasedNumberedPartialShardSpecTest.java", "diffHunk": "@@ -73,5 +73,21 @@ public void testJsonPropertyNames() throws IOException\n     Assert.assertEquals(expected.getPartitionDimensions(), map.get(\"partitionDimensions\"));\n     Assert.assertEquals(expected.getBucketId(), map.get(\"bucketId\"));\n     Assert.assertEquals(expected.getNumBuckets(), map.get(\"numPartitions\"));\n+    Assert.assertEquals(expected.getBucketId(), map.get(\"bucketId\"));\n+  }\n+\n+  @Test\n+  public void testComplete()\n+  {\n+    final HashBasedNumberedPartialShardSpec partialShardSpec = new HashBasedNumberedPartialShardSpec(\n+        ImmutableList.of(\"dim\"),\n+        2,\n+        4\n+    );\n+    final ShardSpec shardSpec = partialShardSpec.complete(new ObjectMapper(), 1, 3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyMzk5MA==", "bodyText": "nit, typo: Segmens\n\"testAppendLinearlyPartitionedSegmentsToHashPartitionedDatasourceSuccessfullyAppend\"", "url": "https://github.com/apache/druid/pull/10033#discussion_r444723990", "createdAt": "2020-06-24T08:17:42Z", "author": {"login": "clintropolis"}, "path": "indexing-service/src/test/java/org/apache/druid/indexing/common/task/batch/parallel/RangePartitionMultiPhaseParallelIndexingTest.java", "diffHunk": "@@ -201,48 +208,122 @@ private static void writeRow(\n   public void createsCorrectRangePartitions() throws Exception\n   {\n     int targetRowsPerSegment = NUM_ROW / DIM_FILE_CARDINALITY / NUM_PARTITION;\n-    final Set<DataSegment> publishedSegments;\n+    final Set<DataSegment> publishedSegments = runTestTask(\n+        new SingleDimensionPartitionsSpec(\n+            targetRowsPerSegment,\n+            null,\n+            DIM1,\n+            false\n+        ),\n+        useMultivalueDim ? TaskState.FAILED : TaskState.SUCCESS,\n+        false\n+    );\n+\n+    if (!useMultivalueDim) {\n+      assertRangePartitions(publishedSegments);\n+    }\n+  }\n+\n+  @Test\n+  public void testAppendLinearlyPartitionedSegmensToHashPartitionedDatasourceSuccessfullyAppend()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyNzgwNQ==", "bodyText": "How do we end up with these mixed shard spec situations, minor compaction? Like I understand why these evaluate to true given how the checks work, just trying to understand how it happens since afaict only dynamic can be appended.", "url": "https://github.com/apache/druid/pull/10033#discussion_r444727805", "createdAt": "2020-06-24T08:24:21Z", "author": {"login": "clintropolis"}, "path": "server/src/test/java/org/apache/druid/server/shard/SingleDimensionShardSpecTest.java", "diffHunk": "@@ -142,6 +146,16 @@ public void testPossibleInDomain()\n     Assert.assertTrue(shard7.possibleInDomain(domain2));\n   }\n \n+  @Test\n+  public void testSharePartitionSpace()\n+  {\n+    final SingleDimensionShardSpec shardSpec = makeSpec(\"start\", \"end\");\n+    Assert.assertTrue(shardSpec.sharePartitionSpace(NumberedPartialShardSpec.instance()));\n+    Assert.assertTrue(shardSpec.sharePartitionSpace(new HashBasedNumberedPartialShardSpec(null, 0, 1)));\n+    Assert.assertTrue(shardSpec.sharePartitionSpace(new SingleDimensionPartialShardSpec(\"dim\", 0, null, null, 1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDM2NzY4", "url": "https://github.com/apache/druid/pull/10033#pullrequestreview-437036768", "createdAt": "2020-06-24T22:00:04Z", "commit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjowMDowNFrOGoknBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjowMDowNFrOGoknBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5NjAzOQ==", "bodyText": "Should this be partialShardSpec.useNonRootGenerationPartitionSpace(); instead of !partialShardSpec.useNonRootGenerationPartitionSpace(); ?", "url": "https://github.com/apache/druid/pull/10033#discussion_r445196039", "createdAt": "2020-06-24T22:00:04Z", "author": {"login": "maytasm"}, "path": "core/src/main/java/org/apache/druid/timeline/partition/ShardSpec.java", "diffHunk": "@@ -125,8 +125,13 @@ default short getAtomicUpdateGroupSize()\n   boolean possibleInDomain(Map<String, RangeSet<String>> domain);\n \n   /**\n-   * Returns true if two segments of this and other shardSpecs can exist in the same time chunk.\n+   * Returns true if this shardSpec and the given {@link PartialShardSpec} share the same partition space.\n+   * Any implementation of {@link OverwriteShardSpec} should return true.\n+   *\n+   * @see PartitionIds\n    */\n-  @JsonIgnore\n-  boolean isCompatible(Class<? extends ShardSpec> other);\n+  default boolean sharePartitionSpace(PartialShardSpec partialShardSpec)\n+  {\n+    return !partialShardSpec.useNonRootGenerationPartitionSpace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDY0NDE3", "url": "https://github.com/apache/druid/pull/10033#pullrequestreview-437064417", "createdAt": "2020-06-24T23:05:13Z", "commit": {"oid": "b423e964d258d2ba2f9760fa3224026157e98d0d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4e702bc1719e0101ad106ebd0ef437dc7ba6bbb", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b4e702bc1719e0101ad106ebd0ef437dc7ba6bbb", "committedDate": "2020-06-25T05:08:11Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9025e3beeb1471b1e767f08031aeb37ead68e809", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/9025e3beeb1471b1e767f08031aeb37ead68e809", "committedDate": "2020-06-25T05:10:00Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzU5NDM3", "url": "https://github.com/apache/druid/pull/10033#pullrequestreview-437759437", "createdAt": "2020-06-25T18:38:24Z", "commit": {"oid": "9025e3beeb1471b1e767f08031aeb37ead68e809"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2098, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}