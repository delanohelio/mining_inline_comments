{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0Mzk2NDIz", "number": 10253, "title": "Allow forceLimitPushDown in SQL", "bodyText": "Fixes #9323.\nDescription\nvalidateAndGetForceLimitPushDown() can throw an exception while iterating candidate plans in sql planner. This PR postpones validation until it's necessary.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-08-07T05:22:51Z", "url": "https://github.com/apache/druid/pull/10253", "merged": true, "mergeCommit": {"oid": "a61263b4a97ef456e383dddb8a270082e122f4db"}, "closed": true, "closedAt": "2020-08-13T20:30:41Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8dcvvgH2gAyNDY0Mzk2NDIzOjBhMTA4MWY3MjNmNGU3NDI5NzAyODAyZDViMzU1Mzc5ZDNiNzE3MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-mEUnAFqTQ2NzEwNzc4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a1081f723f4e7429702802d5b355379d3b7170d", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/0a1081f723f4e7429702802d5b355379d3b7170d", "committedDate": "2020-08-07T05:20:11Z", "message": "Allow forceLimitPushDown in SQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "committedDate": "2020-08-07T16:30:16Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/8f63335e145685d2af61493da22ad3f6cf4c061f", "committedDate": "2020-08-07T18:45:34Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzE5NDY0", "url": "https://github.com/apache/druid/pull/10253#pullrequestreview-464319464", "createdAt": "2020-08-10T15:11:32Z", "commit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNToxMTozMlrOG-S1rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNToxMTozMlrOG-S1rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ==", "bodyText": "Can we default to false instead of making this nullable?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Boolean forceLimitPushDown;\n          \n          \n            \n              private boolean forceLimitPushDown;", "url": "https://github.com/apache/druid/pull/10253#discussion_r467973549", "createdAt": "2020-08-10T15:11:32Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -121,6 +120,10 @@ public static Builder builder()\n   @Nullable\n   private final DateTime universalTimestamp;\n \n+  private final boolean canPushDownLimit;\n+  @Nullable\n+  private Boolean forceLimitPushDown;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzYxMTAx", "url": "https://github.com/apache/druid/pull/10253#pullrequestreview-465361101", "createdAt": "2020-08-11T19:22:22Z", "commit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxOToyMjoyMlrOG_F_iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxOToyOToxMVrOG_GNNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMTY1Ng==", "bodyText": "I think this would cause extra calls to validateAndGetForceLimitPushDown whenever isApplyLimitPushdown is called because of being unable to distinguish between an actual false and the value not being computed yet. It's probably not especially harmful, but it also seems unnecessary.", "url": "https://github.com/apache/druid/pull/10253#discussion_r468811656", "createdAt": "2020-08-11T19:22:22Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -121,6 +120,10 @@ public static Builder builder()\n   @Nullable\n   private final DateTime universalTimestamp;\n \n+  private final boolean canPushDownLimit;\n+  @Nullable\n+  private Boolean forceLimitPushDown;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ=="}, "originalCommit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMzI1Mg==", "bodyText": "super nit: it seems funny to have ...LimitPushDown and ...PushDownLimit, but I'm not really sure what is the best way to square these up. I guess ...LimitPushDown is more prevalent, so maybe renaming to canDoLimitPushDown to be more consistent?", "url": "https://github.com/apache/druid/pull/10253#discussion_r468813252", "createdAt": "2020-08-11T19:25:28Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -409,7 +412,10 @@ public boolean getContextSortByDimsFirst()\n   @JsonIgnore\n   public boolean isApplyLimitPushDown()\n   {\n-    return applyLimitPushDown;\n+    if (forceLimitPushDown == null) {\n+      forceLimitPushDown = validateAndGetForceLimitPushDown();\n+    }\n+    return forceLimitPushDown || canPushDownLimit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTE1OA==", "bodyText": "nit: this method name should probably include LimitPushDown or at least Limit somehow to make it clearer that it applies to limits, maybe canDoLimitPushDown() if you decide to rename the field as well?", "url": "https://github.com/apache/druid/pull/10253#discussion_r468815158", "createdAt": "2020-08-11T19:29:11Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -474,14 +480,12 @@ private RowSignature computeResultRowSignature()\n                   .build();\n   }\n \n-  private boolean determineApplyLimitPushDown()\n+  private boolean canPushDown()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3bc9b260f08fa91fcf63f4709230d354806c885", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/e3bc9b260f08fa91fcf63f4709230d354806c885", "committedDate": "2020-08-13T04:35:10Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62f4d0080f67659c458466fb84f259e58cdde9d6", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/62f4d0080f67659c458466fb84f259e58cdde9d6", "committedDate": "2020-08-13T17:01:43Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTA3Nzgz", "url": "https://github.com/apache/druid/pull/10253#pullrequestreview-467107783", "createdAt": "2020-08-13T20:30:30Z", "commit": {"oid": "62f4d0080f67659c458466fb84f259e58cdde9d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1932, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}