{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2NjU0Mzcz", "number": 10669, "title": "Do Integrate test for Druid base on K8s cluster", "bodyText": "Linked #10542.\n\n\nDescription\nAs the relationship between Druid and K8s gets closer, maybe it is good to have a IT job to check the running status of Druid on K8s like #10544\nThis PR add a new travis job to do simple integrate test on K8s, using Minikube + druid-operator + single-server\nWhat I have done are as follows :\n\nLaunched/Destroyed a Druid Cluster on Minikube locally with a script.\n2.Tested ingest -> load segment -> query. And it works fine.\n\nAlthough It is in WIP\nThere are some bugs need to be fixed, such as\n\nPermissions issue\nIntegration with travis: It seems that I can't set hostNetWork in statefuleset using druid-operator. So I have to use NodePort Service to expose Druid service like router, middleManager and so on but only can use ports 30000-32767.\nSo I perform integration tests in int-tests-config-file mentioned  https://github.com/apache/druid/blob/master/integration-tests/README.md\nPod resource adjust including disks.\n\nAny help is greatly appreciated.\nUpdated:\nThis PR add a new IT Job 71:\n\nDeploy a K8s cluster based on minikube.\nDeploy Druid cluster on K8s: single Druid, use local disk as Deep Storage and use derby as MetaStorage.\nRun single IT test ITNestedQueryPushDownTest which includes data ingestion, Historical loading and query action.\n\nNow job 71 is successful which means this PR is not WIP anymore!\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\n.travis.yml", "createdAt": "2020-12-11T08:31:32Z", "url": "https://github.com/apache/druid/pull/10669", "merged": true, "mergeCommit": {"oid": "1884c356984695cf31ef63dd0075602b5087ec4b"}, "closed": true, "closedAt": "2020-12-17T00:00:42Z", "author": {"login": "zhangyue19921010"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlDGyrAH2gAyNTM2NjU0MzczOjliM2EyYWQzZDdjZjczYmNjOTgxMjJhN2I5NTllMDk3NWVmMDNmYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmpKbFgH2gAyNTM2NjU0MzczOjFhNDI3OTQ3MTRhZDFiY2UzZDgwY2E2MTJlMDE1YzY2NzgxMjM1ZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b3a2ad3d7cf73bcc98122a7b959e0975ef03fa5", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/9b3a2ad3d7cf73bcc98122a7b959e0975ef03fa5", "committedDate": "2020-12-11T07:49:34Z", "message": "add a travls job to do integrate test on K8s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ca937f5d33be1d9828db4ff2cf4866928109d00", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/3ca937f5d33be1d9828db4ff2cf4866928109d00", "committedDate": "2020-12-11T07:55:09Z", "message": "revert build_run_cluster.sh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1183b70c5d0f9a2ade0c106f54092ee3ed2a04b1", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/1183b70c5d0f9a2ade0c106f54092ee3ed2a04b1", "committedDate": "2020-12-11T07:56:16Z", "message": "revert msic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f215f79d7b5567a5ae6e6f3b3dee41e589e6274b", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/f215f79d7b5567a5ae6e6f3b3dee41e589e6274b", "committedDate": "2020-12-11T07:56:51Z", "message": "Merge branch 'master' into intergrate-test-base-on-K8s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f1d40d72c93bb0e66af2a885df9f426ccfb026", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/29f1d40d72c93bb0e66af2a885df9f426ccfb026", "committedDate": "2020-12-12T18:01:29Z", "message": "run IT test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aef19ddc5971ead8006d77ac57eb7af36a544e3", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/2aef19ddc5971ead8006d77ac57eb7af36a544e3", "committedDate": "2020-12-12T18:44:25Z", "message": "ready to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34901b27ce6b25c4c0b2f5509f7c4382e68af461", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/34901b27ce6b25c4c0b2f5509f7c4382e68af461", "committedDate": "2020-12-13T02:33:03Z", "message": "modify before/after script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a57cf2331080341302c716f7d31fd51ba0be5de", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/3a57cf2331080341302c716f7d31fd51ba0be5de", "committedDate": "2020-12-14T13:34:18Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dec7c6468a98d87b4cc63d545bc3863906835d58", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/dec7c6468a98d87b4cc63d545bc3863906835d58", "committedDate": "2020-12-14T13:34:24Z", "message": "Merge branch 'master' into intergrate-test-base-on-K8s"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "dec7c6468a98d87b4cc63d545bc3863906835d58", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/dec7c6468a98d87b4cc63d545bc3863906835d58", "committedDate": "2020-12-14T13:34:24Z", "message": "Merge branch 'master' into intergrate-test-base-on-K8s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389d8905494bf38a9f076102f470eb884bd05931", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/389d8905494bf38a9f076102f470eb884bd05931", "committedDate": "2020-12-14T23:55:46Z", "message": "change mod for script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d82d886da4036477fd29c36ae1fca2603ca8d0b", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/5d82d886da4036477fd29c36ae1fca2603ca8d0b", "committedDate": "2020-12-15T04:21:39Z", "message": "Merge branch 'master' into intergrate-test-base-on-K8s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adf69abdc59cc1bfc433fa8c13cc02c77a9b8a8e", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/adf69abdc59cc1bfc433fa8c13cc02c77a9b8a8e", "committedDate": "2020-12-15T08:10:52Z", "message": "Merge branch 'master' into intergrate-test-base-on-K8s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "committedDate": "2020-12-15T13:45:51Z", "message": "done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyOTcyMjQz", "url": "https://github.com/apache/druid/pull/10669#pullrequestreview-552972243", "createdAt": "2020-12-15T22:11:20Z", "commit": {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoxMToyMFrOIGiR9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoyNTo0MlrOIGiwxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDAyMA==", "bodyText": "nit: not sure why we need to copy, can't we directly use those two files ?", "url": "https://github.com/apache/druid/pull/10669#discussion_r543724020", "createdAt": "2020-12-15T22:11:20Z", "author": {"login": "himanshug"}, "path": "integration-tests/script/build_run_k8s_cluster.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+# setup client keystore\n+cd integration-tests\n+./docker/tls/generate-client-certs-and-keystores.sh\n+rm -rf docker/client_tls\n+cp -r client_tls docker/client_tls\n+cd ..\n+\n+# Build Docker images for pods\n+mvn -B -ff -q dependency:go-offline \\\n+      install \\\n+      -Pdist,bundle-contrib-exts \\\n+      -Pskip-static-checks,skip-tests \\\n+      -Dmaven.javadoc.skip=true\n+\n+docker build -t druid/cluster:v1 -f distribution/docker/DockerfileBuildTarAdvanced .\n+\n+# Set Necessary ENV\n+export CHANGE_MINIKUBE_NONE_USER=true\n+export MINIKUBE_WANTUPDATENOTIFICATION=false\n+export MINIKUBE_WANTREPORTERRORPROMPT=false\n+export MINIKUBE_HOME=$HOME\n+export KUBECONFIG=$HOME/.kube/config\n+sudo apt install -y conntrack\n+\n+# This tmp dir is used for MiddleManager pod and Historical Pod to cache segments.\n+mkdir tmp\n+chmod 777 tmp\n+\n+# Lacunch K8S cluster\n+curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.1/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n+curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.8.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/\n+sudo /usr/local/bin/minikube start --profile=minikube --vm-driver=none --kubernetes-version=v1.18.1\n+sudo /usr/local/bin/minikube update-context\n+\n+# Prepare For Druid-Operator\n+git clone https://github.com/druid-io/druid-operator.git\n+cd druid-operator\n+git checkout -b druid-operator-0.0.3 druid-operator-0.0.3\n+cd ..\n+sed -i 's|REPLACE_IMAGE|druidio/druid-operator:0.0.3|g' druid-operator/deploy/operator.yaml\n+cp integration-tests/tiny-cluster.yaml druid-operator/examples/\n+cp integration-tests/tiny-cluster-zk.yaml druid-operator/examples/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDYyMg==", "bodyText": "nit: maybe define DRUID_OPERATOR_VERSION=0.0.3 ?", "url": "https://github.com/apache/druid/pull/10669#discussion_r543724622", "createdAt": "2020-12-15T22:12:21Z", "author": {"login": "himanshug"}, "path": "integration-tests/script/build_run_k8s_cluster.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+# setup client keystore\n+cd integration-tests\n+./docker/tls/generate-client-certs-and-keystores.sh\n+rm -rf docker/client_tls\n+cp -r client_tls docker/client_tls\n+cd ..\n+\n+# Build Docker images for pods\n+mvn -B -ff -q dependency:go-offline \\\n+      install \\\n+      -Pdist,bundle-contrib-exts \\\n+      -Pskip-static-checks,skip-tests \\\n+      -Dmaven.javadoc.skip=true\n+\n+docker build -t druid/cluster:v1 -f distribution/docker/DockerfileBuildTarAdvanced .\n+\n+# Set Necessary ENV\n+export CHANGE_MINIKUBE_NONE_USER=true\n+export MINIKUBE_WANTUPDATENOTIFICATION=false\n+export MINIKUBE_WANTREPORTERRORPROMPT=false\n+export MINIKUBE_HOME=$HOME\n+export KUBECONFIG=$HOME/.kube/config\n+sudo apt install -y conntrack\n+\n+# This tmp dir is used for MiddleManager pod and Historical Pod to cache segments.\n+mkdir tmp\n+chmod 777 tmp\n+\n+# Lacunch K8S cluster\n+curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.1/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n+curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.8.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/\n+sudo /usr/local/bin/minikube start --profile=minikube --vm-driver=none --kubernetes-version=v1.18.1\n+sudo /usr/local/bin/minikube update-context\n+\n+# Prepare For Druid-Operator\n+git clone https://github.com/druid-io/druid-operator.git\n+cd druid-operator\n+git checkout -b druid-operator-0.0.3 druid-operator-0.0.3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczMTkwOQ==", "bodyText": "nit: this looks mostly a copy of other Dockerfile , it would be nice to reuse same if possible.", "url": "https://github.com/apache/druid/pull/10669#discussion_r543731909", "createdAt": "2020-12-15T22:25:42Z", "author": {"login": "himanshug"}, "path": "distribution/docker/DockerfileBuildTarAdvanced", "diffHunk": "@@ -0,0 +1,62 @@\n+#", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "375c253671c8e9dfacc69d84153e6a3af7422b8c", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/375c253671c8e9dfacc69d84153e6a3af7422b8c", "committedDate": "2020-12-16T02:52:51Z", "message": "add env DRUID_OPERATOR_VERSION=0.0.3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a42794714ad1bce3d80ca612e015c66781235d9", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/1a42794714ad1bce3d80ca612e015c66781235d9", "committedDate": "2020-12-16T06:43:51Z", "message": "change version"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3162, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}