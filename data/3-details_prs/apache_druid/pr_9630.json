{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTI0NTk0", "number": 9630, "title": "check paths used for shuffle intermediary data manager get and delete", "bodyText": "Description\nThis PR fixes an issue spotted by LGTM where strings provided by an HTTP request to the ShuffleResource used by native batch indexing were not checked, allowing paths to be supplied to delete, and to a lesser extent, read files outside of the intended storage directory.\nBoth of the fix areas are flagged with: https://lgtm.com/rules/5970070/\nThe added tests would fail prior to this PR and serve to illustrate the bug. I moved logic of DataSchema. validateDatasourceName and RandomIdUtils into druid-core under TaskIdUtils so that this logic could be recycled to ensure that the supervisorTaskId are chill to use.\n\nThis PR has:\n\n been self-reviewed.\n added unit tests or modified existing tests to cover new code paths.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\nIntermediaryDataManager\nRandomIdUtils -> TaskIdUtils", "createdAt": "2020-04-06T21:49:56Z", "url": "https://github.com/apache/druid/pull/9630", "merged": true, "mergeCommit": {"oid": "d267b1c414b9b55b129729692755273d2a35e304"}, "closed": true, "closedAt": "2020-04-07T16:47:18Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUI6_5gH2gAyMzk5OTI0NTk0OmMwMDllMmVlMDQzNDIxOTkwYjIxZTIyNWM1MzZmM2NhMDhiYWE4OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVRHChAH2gAyMzk5OTI0NTk0OmQxMjBjMjg4ZmVjYWFiMTI0ZTE5NTNmMzczZWE2YzJiOWU4NDJkMWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c009e2ee043421990b21e225c536f3ca08baa88c", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c009e2ee043421990b21e225c536f3ca08baa88c", "committedDate": "2020-04-03T22:48:15Z", "message": "check paths used for shuffle intermediary data manager get and delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1af6533628a510ff5a6fbf678ff4f7098361df", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/fc1af6533628a510ff5a6fbf678ff4f7098361df", "committedDate": "2020-04-07T00:15:10Z", "message": "Merge remote-tracking branch 'upstream/master' into sanitize-shuffle-file-path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2", "committedDate": "2020-04-07T00:35:09Z", "message": "add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzEyMjQ4", "url": "https://github.com/apache/druid/pull/9630#pullrequestreview-388712248", "createdAt": "2020-04-07T00:41:43Z", "commit": {"oid": "4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzM5MTYx", "url": "https://github.com/apache/druid/pull/9630#pullrequestreview-388739161", "createdAt": "2020-04-07T02:12:11Z", "commit": {"oid": "4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMjoxMjoxMVrOGBwcsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMjoxMjoxMVrOGBwcsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ5NTUzNg==", "bodyText": "What do you think about moving the validation up the stack to right when the external data enters druid (i.e., in the API resource layer like ShuffleResource.getPartition()/deletePartitions())? For example, in the future, there may be clients of the lower level code that do not need to do the validation.", "url": "https://github.com/apache/druid/pull/9630#discussion_r404495536", "createdAt": "2020-04-07T02:12:11Z", "author": {"login": "ccaominh"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/IntermediaryDataManager.java", "diffHunk": "@@ -336,6 +337,7 @@ long addSegment(String supervisorTaskId, String subTaskId, DataSegment segment,\n   @Nullable\n   public File findPartitionFile(String supervisorTaskId, String subTaskId, Interval interval, int partitionId)\n   {\n+    TaskIdUtils.validateId(\"supervisorTaskId\", supervisorTaskId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzU1NzY2", "url": "https://github.com/apache/druid/pull/9630#pullrequestreview-388755766", "createdAt": "2020-04-07T03:13:15Z", "commit": {"oid": "4b014adde22ff28f5a292d0574b7e1b2cf0fcdf2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a98cf778e20c0769c2bc89307c8007e043bc0bc", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/6a98cf778e20c0769c2bc89307c8007e043bc0bc", "committedDate": "2020-04-07T03:49:18Z", "message": "newline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d120c288fecaab124e1953f373ea6c2b9e842d1a", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/d120c288fecaab124e1953f373ea6c2b9e842d1a", "committedDate": "2020-04-07T10:54:34Z", "message": "meh"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2809, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}