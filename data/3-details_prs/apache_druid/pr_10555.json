{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MTgzNTAw", "number": 10555, "title": "Fix : Druid throws java.util.concurrent.RejectedExecutionException when ingest task is stopping.", "bodyText": "Fixes Druid throws java.util.concurrent.RejectedExecutionException when ingest task is stopping.\n\n\nDescription\nWhen ingest task is finished and doing clean up action, it may meet 'RejectedExecutionException' sometimes, like\n2020-11-03T11:33:42,279 INFO [task-runner-0-priority-0] org.apache.druid.curator.announcement.Announcer - Unannouncing [xxxx:8101]\n2020-11-03T11:33:42,288 INFO [task-runner-0-priority-0] org.apache.druid.indexing.worker.executor.ExecutorLifecycle - Task completed with status: {\n  \"id\" : \"xxxx__prd_73054d04b8a9754_ccpenhpd\",\n  \"status\" : \"SUCCESS\",\n  \"duration\" : 3780579,\n  \"errorMsg\" : null,\n  \"location\" : {\n    \"host\" : null,\n    \"port\" : -1,\n    \"tlsPort\" : -1\n  }\n}\n2020-11-03T11:33:42,291 INFO [main] org.apache.druid.java.util.common.lifecycle.Lifecycle - Stopping lifecycle [module] stage [ANNOUNCEMENTS]\n2020-11-03T11:33:42,293 INFO [main] org.apache.druid.curator.announcement.Announcer - Unannouncing [xxxxx.local:8101]\n2020-11-03T11:33:42,295 INFO [main] org.apache.druid.java.util.common.lifecycle.Lifecycle - Stopping lifecycle [module] stage [SERVER]\n2020-11-03T11:33:42,299 INFO [main] org.eclipse.jetty.server.AbstractConnector - Stopped ServerConnector@4ef8090b{HTTP/1.1,[http/1.1]}{0.0.0.0:8101}\n2020-11-03T11:33:42,299 INFO [main] org.eclipse.jetty.server.session - node0 Stopped scavenging\n2020-11-03T11:33:42,301 INFO [main] org.eclipse.jetty.server.handler.ContextHandler - Stopped o.e.j.s.ServletContextHandler@1f1fbc9f{/,null,UNAVAILABLE}\n2020-11-03T11:33:42,304 INFO [main] org.apache.druid.java.util.common.lifecycle.Lifecycle - Stopping lifecycle [module] stage [NORMAL]\n2020-11-03T11:33:42,304 INFO [main] org.apache.druid.server.listener.announcer.ListenerResourceAnnouncer - Unannouncing start time on [xxxx.cluster.local:8101]\n2020-11-03T11:33:42,304 INFO [main] org.apache.druid.indexing.overlord.SingleTaskBackgroundRunner - Starting graceful shutdown of task[xxxxx__prd_73054d04b8a9754_ccpenhpd].\n2020-11-03T11:33:42,304 INFO [main] org.apache.druid.indexing.seekablestream.SeekableStreamIndexTaskRunner - Stopping forcefully (status: [PUBLISHING])\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.security.basic.authorization.db.cache.CoordinatorPollingBasicAuthorizerCacheManager - CoordinatorPollingBasicAuthorizerCacheManager is stopping.\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.security.basic.authorization.db.cache.CoordinatorPollingBasicAuthorizerCacheManager - CoordinatorPollingBasicAuthorizerCacheManager is stopped.\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.security.basic.authentication.db.cache.CoordinatorPollingBasicAuthenticatorCacheManager - CoordinatorPollingBasicAuthenticatorCacheManager is stopping.\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.security.basic.authentication.db.cache.CoordinatorPollingBasicAuthenticatorCacheManager - CoordinatorPollingBasicAuthenticatorCacheManager is stopped.\n2020-11-03T11:33:42,307 INFO [LookupExtractorFactoryContainerProvider-MainThread] org.apache.druid.query.lookup.LookupReferencesManager - Lookup Management loop exited. Lookup notices are not handled anymore.\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.query.lookup.LookupReferencesManager - Closed lookup [xxxx1].\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.query.lookup.LookupReferencesManager - Closed lookup [xxxx2].\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.query.lookup.LookupReferencesManager - Closed lookup [xxxx3].\n2020-11-03T11:33:42,307 INFO [main] org.apache.druid.query.lookup.LookupReferencesManager - Closed lookup [xxxx4].\n2020-11-03T11:33:42,319 INFO [main] org.apache.druid.java.util.emitter.core.ComposingEmitter - Closing Composing Emitter.\n2020-11-03T11:33:42,319 INFO [main] org.apache.druid.java.util.emitter.core.ComposingEmitter - Closing emitter org.apache.druid.emitter.statsd.StatsDEmitter.\n2020-11-03T11:33:42,364 ERROR [BasicAuthenticatorCacheManager-Exec--0] org.apache.druid.java.util.common.concurrent.ScheduledExecutors - Uncaught exception.\njava.util.concurrent.RejectedExecutionException: Task java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask@2bbf15dd rejected from java.util.concurrent.ScheduledThreadPoolExecutor@2578eeda[Shutting down, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 59]\n\tat java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063) ~[?:1.8.0_221]\n\tat java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830) ~[?:1.8.0_221]\n\tat java.util.concurrent.ScheduledThreadPoolExecutor.delayedExecute(ScheduledThreadPoolExecutor.java:326) ~[?:1.8.0_221]\n\tat java.util.concurrent.ScheduledThreadPoolExecutor.schedule(ScheduledThreadPoolExecutor.java:533) ~[?:1.8.0_221]\n\tat java.util.concurrent.Executors$DelegatedScheduledExecutorService.schedule(Executors.java:729) ~[?:1.8.0_221]\n\tat org.apache.druid.java.util.common.concurrent.ScheduledExecutors$2.run(ScheduledExecutors.java:103) [druid-core-0.17.1.jar:0.17.1]\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [?:1.8.0_221]\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266) [?:1.8.0_221]\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180) [?:1.8.0_221]\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293) [?:1.8.0_221]\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_221]\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_221]\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_221]\n\nThe root cause of this exception is that the function 'call' in 'scheduleWithFixedDelay' always return  Signal.REPEAT all the time. It will constance submit jobs to exec , even though exec is shutdown.\nThis PR checks exec status before return Signal.\n\n\n\nFixed the bug ...\nRenamed the class ...\nAdded a forbidden-apis entry ...\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\nScheduledExecutors", "createdAt": "2020-11-04T07:07:45Z", "url": "https://github.com/apache/druid/pull/10555", "merged": true, "mergeCommit": {"oid": "31740b3b29cac6d81d3cc19374dbf04836e41436"}, "closed": true, "closedAt": "2020-11-23T22:52:04Z", "author": {"login": "zhangyue19921010"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZH-w9AH2gAyNTE1MTgzNTAwOjQ2Yzk0YmQyZGFlYjNlNDcwMDgxNGNiODllNDQyMTJjMGQ2MmZmZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfLUDmgH2gAyNTE1MTgzNTAwOjc1M2VjNmY4YTllOTQ4ZGE2ZDFhNWQ2NjcyOTRiMjE2MzljNzI0ZmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46c94bd2daeb3e4700814cb89e44212c0d62ffdd", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/46c94bd2daeb3e4700814cb89e44212c0d62ffdd", "committedDate": "2020-11-04T06:43:14Z", "message": "check exec status before return Signal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMTMyNzEy", "url": "https://github.com/apache/druid/pull/10555#pullrequestreview-523132712", "createdAt": "2020-11-04T08:27:20Z", "commit": {"oid": "46c94bd2daeb3e4700814cb89e44212c0d62ffdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODoyNzoyMFrOHtNgEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODoyNzoyMFrOHtNgEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2OTE2OQ==", "bodyText": "please add a log line here. It will be hard to debug if someone wrongly shuts down the exec.", "url": "https://github.com/apache/druid/pull/10555#discussion_r517169169", "createdAt": "2020-11-04T08:27:20Z", "author": {"login": "nishantmonu51"}, "path": "core/src/main/java/org/apache/druid/java/util/common/concurrent/ScheduledExecutors.java", "diffHunk": "@@ -53,7 +53,11 @@ public static void scheduleWithFixedDelay(\n           public Signal call()\n           {\n             runnable.run(); // (Exceptions are handled for us)\n-            return Signal.REPEAT;\n+            if (exec.isShutdown()) {\n+              return Signal.STOP;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46c94bd2daeb3e4700814cb89e44212c0d62ffdd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918447443146965658d5522990fc4816c5683f4c", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/918447443146965658d5522990fc4816c5683f4c", "committedDate": "2020-11-04T08:58:18Z", "message": "add more log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3aec58281804241464101bccf3c0c06111979d", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/9d3aec58281804241464101bccf3c0c06111979d", "committedDate": "2020-11-04T13:26:32Z", "message": "change log level to debug and add UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a590fb4afa4c85d715681e990200b2a1a8a28e", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/93a590fb4afa4c85d715681e990200b2a1a8a28e", "committedDate": "2020-11-23T01:57:51Z", "message": "Merge branch 'master' into fix-ScheduledExecutors-submit-bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "753ec6f8a9e948da6d1a5d667294b21639c724fe", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/753ec6f8a9e948da6d1a5d667294b21639c724fe", "committedDate": "2020-11-23T01:59:45Z", "message": "change log leverl to warn and merge master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3068, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}