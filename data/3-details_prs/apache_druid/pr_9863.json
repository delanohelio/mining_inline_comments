{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTk0MzMx", "number": 9863, "title": "Enforce code coverage", "bodyText": "Description\nAdd an automated way of checking if new code has adequate unit tests, since merging code coverage reports and check coverage thresholds via coveralls or codecov is unreliable.\nThe following minimum unit test code coverage is now enforced on new code:\n\n80% functions\n65% branch\n65% line\n\nBranch and line coverage thresholds are slightly lower for now as they are harder to achieve.\nAfter the code coverage check looks reliable, the thresholds can be increased later if needed.\n\nThis PR has:\n\n been self-reviewed.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n been manually tested: ccaominh#1", "createdAt": "2020-05-13T20:27:02Z", "url": "https://github.com/apache/druid/pull/9863", "merged": true, "mergeCommit": {"oid": "427239f4518cfd4642389e55e20f0cb19813e0d9"}, "closed": true, "closedAt": "2020-05-20T16:31:39Z", "author": {"login": "ccaominh"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg-zHIAH2gAyNDE3NTk0MzMxOjE2ZDcwZTkzMTY4ZTVhYWE4OWRjMmE3NWM2MWE3ZDE5YzcwNTJiMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci7vsYAH2gAyNDE3NTk0MzMxOmUwMTJlODBlMWY0MGZiYzNkZmRhMzcwM2M3ZjY1ODM2Mzg4YWY5YzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "author": {"user": {"login": "ccaominh", "name": "Chi Cao Minh"}}, "url": "https://github.com/apache/druid/commit/16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "committedDate": "2020-05-13T20:21:36Z", "message": "Enforce code coverage\n\nAdd an automated way of checking if new code has adequate unit tests,\nsince merging code coverage reports and check coverage thresholds via\ncoveralls or codecov is unreliable.\n\nThe following minimum unit test code coverage is now enforced:\n- 80% functions\n- 65% branch\n- 65% line\n\nBranch and line coverage thresholds are slightly lower for now as they\nare harder to achieve.\n\nAfter the code coverage check looks reliable, the thresholds can be\nincreased later if needed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzcyNDc4", "url": "https://github.com/apache/druid/pull/9863#pullrequestreview-411372478", "createdAt": "2020-05-13T23:43:15Z", "commit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMzo0MzoxNlrOGVHQWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMDowMzowOFrOGVHoBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5MjE1Mw==", "bodyText": "Can you add comments on what the difference and what each branch is doing", "url": "https://github.com/apache/druid/pull/9863#discussion_r424792153", "createdAt": "2020-05-13T23:43:16Z", "author": {"login": "maytasm"}, "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5MzcxMA==", "bodyText": "Maybe also print a message indicating this is the list of all files, etc.", "url": "https://github.com/apache/druid/pull/9863#discussion_r424793710", "createdAt": "2020-05-13T23:48:02Z", "author": {"login": "maytasm"}, "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5Mzc5Mg==", "bodyText": "Maybe also print a message indicating this is the list of all project files after filtering, etc.", "url": "https://github.com/apache/druid/pull/9863#discussion_r424793792", "createdAt": "2020-05-13T23:48:22Z", "author": {"login": "maytasm"}, "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >\n+          if [[ \"${MAVEN_PROJECTS}\" = \\!* ]]; then\n+          regex=\"${MAVEN_PROJECTS:1}\";\n+          regex=\"^${regex//,\\!/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep -v \"${regex}\" || [[ $? == 1 ]])\";\n+          else\n+          regex=\"^${MAVEN_PROJECTS//,/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep \"${regex}\" || [[ $? == 1 ]])\";\n+          fi\n+        - for f in ${project_files}; do echo $f; done  # for debugging", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5NzU5NQ==", "bodyText": "Maybe making these variables at the top with the other export", "url": "https://github.com/apache/druid/pull/9863#discussion_r424797595", "createdAt": "2020-05-14T00:01:00Z", "author": {"login": "maytasm"}, "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >\n+          if [[ \"${MAVEN_PROJECTS}\" = \\!* ]]; then\n+          regex=\"${MAVEN_PROJECTS:1}\";\n+          regex=\"^${regex//,\\!/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep -v \"${regex}\" || [[ $? == 1 ]])\";\n+          else\n+          regex=\"^${MAVEN_PROJECTS//,/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep \"${regex}\" || [[ $? == 1 ]])\";\n+          fi\n+        - for f in ${project_files}; do echo $f; done  # for debugging\n+        # Check diff code coverage for the maven projects being tested (retry install in case of network error)\n+        - >\n+          if [ -n \"${project_files}\" ]; then\n+          travis_retry npm install @connectis/diff-test-coverage@1.5.3\n+          && git diff origin/${TRAVIS_BRANCH}...HEAD -- ${project_files}\n+          | node_modules/.bin/diff-test-coverage\n+          --coverage \"**/target/site/jacoco/jacoco.xml\"\n+          --type jacoco\n+          --line-coverage 65", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5ODIxNQ==", "bodyText": "Should the integration-tests be skipped too?", "url": "https://github.com/apache/druid/pull/9863#discussion_r424798215", "createdAt": "2020-05-14T00:03:08Z", "author": {"login": "maytasm"}, "path": "benchmarks/pom.xml", "diffHunk": "@@ -220,6 +220,13 @@\n           <skip>true</skip>\n         </configuration>\n       </plugin>\n+      <plugin>\n+        <groupId>org.jacoco</groupId>\n+        <artifactId>jacoco-maven-plugin</artifactId>\n+        <configuration>\n+          <skip>true</skip> <!-- ignore non-production code -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f", "author": {"user": {"login": "ccaominh", "name": "Chi Cao Minh"}}, "url": "https://github.com/apache/druid/commit/4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f", "committedDate": "2020-05-14T00:42:10Z", "message": "Add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzkzNDE1", "url": "https://github.com/apache/druid/pull/9863#pullrequestreview-411393415", "createdAt": "2020-05-14T00:48:36Z", "commit": {"oid": "4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzI0Nzk0", "url": "https://github.com/apache/druid/pull/9863#pullrequestreview-412324794", "createdAt": "2020-05-15T03:34:14Z", "commit": {"oid": "4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTU2NzAw", "url": "https://github.com/apache/druid/pull/9863#pullrequestreview-413956700", "createdAt": "2020-05-18T21:38:04Z", "commit": {"oid": "4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e012e80e1f40fbc3dfda3703c7f65836388af9c2", "author": {"user": {"login": "ccaominh", "name": "Chi Cao Minh"}}, "url": "https://github.com/apache/druid/commit/e012e80e1f40fbc3dfda3703c7f65836388af9c2", "committedDate": "2020-05-19T21:56:00Z", "message": "Merge remote-tracking branch 'upstream/master' into coverage-check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2336, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}