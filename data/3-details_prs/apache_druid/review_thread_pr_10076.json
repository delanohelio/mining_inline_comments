{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5Njg1NTU3", "number": 10076, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNjowODozMFrOEIn48A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMzo1NzozN1rOEJJJRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NDc3NjE2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNjowODozMFrOGoslsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzowOToxNVrOGpEAvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMyNjc2OA==", "bodyText": "I... can't remember if there is a reason why this explodes violently while the others are all CloseQuietly... I'll try to figure out if this should be eaten too.", "url": "https://github.com/apache/druid/pull/10076#discussion_r445326768", "createdAt": "2020-06-25T06:08:30Z", "author": {"login": "clintropolis"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -1036,11 +1047,13 @@ public boolean isReleasable()\n     @Override\n     public void close()\n     {\n-      try {\n-        yielder.close();\n-      }\n-      catch (IOException e) {\n-        throw new RuntimeException(\"Failed to close yielder\", e);\n+      if (yielder != null) {\n+        try {\n+          yielder.close();\n+        }\n+        catch (IOException e) {\n+          throw new RuntimeException(\"Failed to close yielder\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2a22073ee2ae98b8f1707ca6b7538acf5dae99"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxMDUyNQ==", "bodyText": "It seems the exception will be eventually handled by CloseQuietly.", "url": "https://github.com/apache/druid/pull/10076#discussion_r445710525", "createdAt": "2020-06-25T17:09:15Z", "author": {"login": "jihoonson"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -1036,11 +1047,13 @@ public boolean isReleasable()\n     @Override\n     public void close()\n     {\n-      try {\n-        yielder.close();\n-      }\n-      catch (IOException e) {\n-        throw new RuntimeException(\"Failed to close yielder\", e);\n+      if (yielder != null) {\n+        try {\n+          yielder.close();\n+        }\n+        catch (IOException e) {\n+          throw new RuntimeException(\"Failed to close yielder\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMyNjc2OA=="}, "originalCommit": {"oid": "0c2a22073ee2ae98b8f1707ca6b7538acf5dae99"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NzA2Njc1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0NjoyNFrOGpDLZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0NjoyNFrOGpDLZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5Njg3MA==", "bodyText": "nit: Closer.register() has null check. You can use registerAll() instead.", "url": "https://github.com/apache/druid/pull/10076#discussion_r445696870", "createdAt": "2020-06-25T16:46:24Z", "author": {"login": "jihoonson"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -1350,4 +1363,24 @@ long getTotalCpuTimeNanos()\n       return totalCpuTimeNanos;\n     }\n   }\n+\n+  private static <T> void closeAllCursors(final PriorityQueue<BatchedResultsCursor<T>> pQueue)\n+  {\n+    Closer closer = Closer.create();\n+    while (!pQueue.isEmpty()) {\n+      final BatchedResultsCursor<T> yielder = pQueue.poll();\n+      if (yielder != null) {\n+        // Note: yielder can be null if our comparator threw an exception during queue.add.\n+        closer.register(yielder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2a22073ee2ae98b8f1707ca6b7538acf5dae99"}, "originalPosition": 135}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NzE1NjMyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzoxMDo0N1rOGpEEPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzoxMDo0N1rOGpEEPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxMTQyMw==", "bodyText": "You can merge these methods if you use registerAll() above.", "url": "https://github.com/apache/druid/pull/10076#discussion_r445711423", "createdAt": "2020-06-25T17:10:47Z", "author": {"login": "jihoonson"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -1350,4 +1363,24 @@ long getTotalCpuTimeNanos()\n       return totalCpuTimeNanos;\n     }\n   }\n+\n+  private static <T> void closeAllCursors(final PriorityQueue<BatchedResultsCursor<T>> pQueue)\n+  {\n+    Closer closer = Closer.create();\n+    while (!pQueue.isEmpty()) {\n+      final BatchedResultsCursor<T> yielder = pQueue.poll();\n+      if (yielder != null) {\n+        // Note: yielder can be null if our comparator threw an exception during queue.add.\n+        closer.register(yielder);\n+      }\n+    }\n+    CloseQuietly.close(closer);\n+  }\n+\n+  private static <T> void closeAllCursors(final List<BatchedResultsCursor<T>> list)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2a22073ee2ae98b8f1707ca6b7538acf5dae99"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MDIyNDcwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMzo1NzozN1rOGph7Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxOToxMjoyN1rOGpr39w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMDYzMA==", "bodyText": "Have you considered closing the sequenceCursors in a finally block incase a Throwable is thrown instead of an exception?", "url": "https://github.com/apache/druid/pull/10076#discussion_r446200630", "createdAt": "2020-06-26T13:57:37Z", "author": {"login": "suneet-s"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -341,6 +344,7 @@ protected void compute()\n         }\n       }\n       catch (Exception ex) {\n+        closeAllCursors(sequenceCursors);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464136b55ab430dc4b684980b31a07af719f4fee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTc3NA==", "bodyText": "Sorry, I misread this. A finally block won't work \ud83e\udd26\nDoes it provide any better guarantees if we catch a Throwable instead of an exception here - so that in case any of the code in the try block throws an Error instead of an Exception\nThis code appears to have been running ok all this time with a catch (Exception) block so I'm guessing it's not too bad if the catch condition is left as is", "url": "https://github.com/apache/druid/pull/10076#discussion_r446285774", "createdAt": "2020-06-26T16:27:35Z", "author": {"login": "suneet-s"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -341,6 +344,7 @@ protected void compute()\n         }\n       }\n       catch (Exception ex) {\n+        closeAllCursors(sequenceCursors);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMDYzMA=="}, "originalCommit": {"oid": "464136b55ab430dc4b684980b31a07af719f4fee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2MzYzOQ==", "bodyText": "Seems reasonable to switch to catching throwable, can swap it out", "url": "https://github.com/apache/druid/pull/10076#discussion_r446363639", "createdAt": "2020-06-26T19:12:27Z", "author": {"login": "clintropolis"}, "path": "core/src/main/java/org/apache/druid/java/util/common/guava/ParallelMergeCombiningSequence.java", "diffHunk": "@@ -341,6 +344,7 @@ protected void compute()\n         }\n       }\n       catch (Exception ex) {\n+        closeAllCursors(sequenceCursors);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMDYzMA=="}, "originalCommit": {"oid": "464136b55ab430dc4b684980b31a07af719f4fee"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2364, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}