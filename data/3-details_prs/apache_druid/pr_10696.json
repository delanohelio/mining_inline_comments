{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzMzEzNjU5", "number": 10696, "title": "Fix kinesis integration test", "bodyText": "Fix kinesis integration test\nDescription\nThis is a followup to #10692\nTurns out that I merge #10692 in too soon and that the Kinesis integration test can still fail intermittently. This PR should now really fix it. (Verify by 20 consecutive passing of the Kinesis IT group.)\nThere were two causes for Kinesis intermittent failure:\n\nPart of the Kinesis IT verify ingested data after the ingestion task completed (so that segments are loaded onto historical and are no longer \"realtime\". The test was doing this by terminating the supervisor to force the ingestion task to complete. However, it seems like there might be a bug that causes the running ingestion task to become stuck and continue running even after the supervisor terminated.\nSome part of Kinesis IT may take some time to successfully verify the result. The current timeout/retry count can be too low.\n\nThis PR addresses these issues by:\n\nDecrease task duration to 30 seconds. The test will then wait until task naturally complete and handoff segments to historical (instead of terminating the supervisor to force task to complete).\nIncrease retry timeout to 20 minutes from 10 minutes. This is done by increasing retry count from 120 to 240.\nThis PR also includes some nice to have:\nUpdate API for terminating supervisor to use /terminate since /shutdown is deprecated.\nAdd shutdown task API call to test teardown to make sure that we also properly clean up all task\nUpdate some logging to provide more information in case of test failure\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-12-21T08:08:49Z", "url": "https://github.com/apache/druid/pull/10696", "merged": true, "mergeCommit": {"oid": "5bd792429664d8f5274ffea314f8bdeb296eb88a"}, "closed": true, "closedAt": "2020-12-21T20:57:40Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoQ99nAH2gAyNTQzMzEzNjU5OjBiMmU1NWZmNzViMzIzNTgxMmM1NTQwMDY5OTEzYTMxNDk4NTM5YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdocXl5gFqTU1NjY1ODk2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0b2e55ff75b3235812c5540069913a31498539a3", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/0b2e55ff75b3235812c5540069913a31498539a3", "committedDate": "2020-12-21T07:40:22Z", "message": "fix kinesis IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/72a6f98e7337fea6b5b52ddc067f0fe959543f6f", "committedDate": "2020-12-21T07:41:49Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjU1OTU4", "url": "https://github.com/apache/druid/pull/10696#pullrequestreview-556255958", "createdAt": "2020-12-21T09:52:05Z", "commit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTUzMzQ0", "url": "https://github.com/apache/druid/pull/10696#pullrequestreview-556553344", "createdAt": "2020-12-21T17:41:29Z", "commit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNzo0MToyOVrOIJggHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNzo0MToyOVrOIJggHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg0MDYwNQ==", "bodyText": "Can you explain how we decided to set this to 20 minutes instead of 10?", "url": "https://github.com/apache/druid/pull/10696#discussion_r546840605", "createdAt": "2020-12-21T17:41:29Z", "author": {"login": "suneet-s"}, "path": "integration-tests/src/main/java/org/apache/druid/testing/utils/ITRetryUtil.java", "diffHunk": "@@ -30,7 +30,7 @@\n \n   private static final Logger LOG = new Logger(ITRetryUtil.class);\n \n-  public static final int DEFAULT_RETRY_COUNT = 120; // 10 minutes\n+  public static final int DEFAULT_RETRY_COUNT = 240; // 20 minutes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTcwMDM1", "url": "https://github.com/apache/druid/pull/10696#pullrequestreview-556570035", "createdAt": "2020-12-21T18:10:09Z", "commit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjU4OTY0", "url": "https://github.com/apache/druid/pull/10696#pullrequestreview-556658964", "createdAt": "2020-12-21T20:57:19Z", "commit": {"oid": "72a6f98e7337fea6b5b52ddc067f0fe959543f6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3213, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}