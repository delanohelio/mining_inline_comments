{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODU1NDI1", "number": 9893, "title": "Add REGEXP_LIKE, fix bugs in REGEXP_EXTRACT.", "bodyText": "Add REGEXP_LIKE function that returns a boolean, and is useful in\nWHERE clauses.\nFix REGEXP_EXTRACT return type (should be nullable; causes incorrect\nfilter elision in forms like WHERE REGEXP_EXTRACT(x, 'pattern') IS NOT NULL).\nFix REGEXP_EXTRACT behavior for empty patterns: should always match\n(previously, they threw errors).\nImprove error behavior when REGEXP_EXTRACT and REGEXP_LIKE are passed\nnon-literal patterns.\nImprove documentation of REGEXP_EXTRACT.", "createdAt": "2020-05-19T03:33:24Z", "url": "https://github.com/apache/druid/pull/9893", "merged": true, "mergeCommit": {"oid": "3dfd7c30c00238d35dc9e3d25bfd136e0b5f7240"}, "closed": true, "closedAt": "2020-06-03T21:31:38Z", "author": {"login": "gianm"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcir-rOgH2gAyNDE5ODU1NDI1OjczZDhmZDExZTZlMzlhMDkzOTNjOWIzODcxN2RiMmU1YzM2ZmFlNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcntJ4bgH2gAyNDE5ODU1NDI1OmJiMzIyMjczMTc0NzE2YjU4YzA0YjcyZmQ3OWMyZWE1M2ViMzFjOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/73d8fd11e6e39a09393c9b38717db2e5c36fae44", "committedDate": "2020-05-19T03:33:53Z", "message": "Add REGEXP_LIKE, fix empty-pattern bug in REGEXP_EXTRACT.\n\n- Add REGEXP_LIKE function that returns a boolean, and is useful in\n  WHERE clauses.\n- Fix REGEXP_EXTRACT return type (should be nullable; causes incorrect\n  filter elision).\n- Fix REGEXP_EXTRACT behavior for empty patterns: should always match\n  (previously, they threw errors).\n- Improve error behavior when REGEXP_EXTRACT and REGEXP_LIKE are passed\n  non-literal patterns.\n- Improve documentation of REGEXP_EXTRACT."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/73d8fd11e6e39a09393c9b38717db2e5c36fae44", "committedDate": "2020-05-19T03:33:53Z", "message": "Add REGEXP_LIKE, fix empty-pattern bug in REGEXP_EXTRACT.\n\n- Add REGEXP_LIKE function that returns a boolean, and is useful in\n  WHERE clauses.\n- Fix REGEXP_EXTRACT return type (should be nullable; causes incorrect\n  filter elision).\n- Fix REGEXP_EXTRACT behavior for empty patterns: should always match\n  (previously, they threw errors).\n- Improve error behavior when REGEXP_EXTRACT and REGEXP_LIKE are passed\n  non-literal patterns.\n- Improve documentation of REGEXP_EXTRACT."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MDA0OTMw", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-415004930", "createdAt": "2020-05-20T05:36:18Z", "commit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNTozNjoxOVrOGX76UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNjowMjo1MVrOGX8Zpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc1MjAxNg==", "bodyText": "Should this mention that it is like LIKE but with 100% more regex? Maybe it's obvious enough since it is in the function name. Regardless, we should add docs to math-expr.md as well?", "url": "https://github.com/apache/druid/pull/9893#discussion_r427752016", "createdAt": "2020-05-20T05:36:19Z", "author": {"login": "clintropolis"}, "path": "docs/querying/sql.md", "diffHunk": "@@ -322,17 +322,18 @@ String functions accept strings, and return a type appropriate to the function.\n |`LOWER(expr)`|Returns expr in all lowercase.|\n |`PARSE_LONG(string[, radix])`|Parses a string into a long (BIGINT) with the given radix, or 10 (decimal) if a radix is not provided.|\n |`POSITION(needle IN haystack [FROM fromIndex])`|Returns the index of needle within haystack, with indexes starting from 1. The search will begin at fromIndex, or 1 if fromIndex is not specified. If the needle is not found, returns 0.|\n-|`REGEXP_EXTRACT(expr, pattern, [index])`|Apply regular expression pattern and extract a capture group, or null if there is no match. If index is unspecified or zero, returns the substring that matched the pattern.|\n+|`REGEXP_EXTRACT(expr, pattern, [index])`|Apply regular expression `pattern` to `expr` and extract a capture group, or `NULL` if there is no match. If index is unspecified or zero, returns the substring that matched the pattern. The pattern must match starting at the beginning of `expr`, but does not need to match the entire string. Note: when `druid.generic.useDefaultValueForNull = true`, it is not possible to differentiate an empty-string match from a non-match (both will return `NULL`).|\n+|`REGEXP_LIKE(expr, pattern)`|Returns whether `expr` matches regular expression `pattern`. The pattern must match starting at the beginning of `expr`, but does not need to match the entire string. Especially useful in WHERE clauses.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc1NTEyOA==", "bodyText": "hmm, I forget why I added this function, but it appears at least now that nothing is calling it.. It was added with #6974, specifically to be able to set this as non-null. I guess with this change that block will always be null, so the if can probably be removed, though I wish I could remember why I added it. However, that PR was open for over a year so .. maybe over that lifetime of fixing it up for conflicts it's purpose was lost to time...", "url": "https://github.com/apache/druid/pull/9893#discussion_r427755128", "createdAt": "2020-05-20T05:47:03Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/expression/OperatorConversions.java", "diffHunk": "@@ -291,15 +294,15 @@ public OperatorBuilder operandTypes(final SqlTypeFamily... operandTypes)\n       return this;\n     }\n \n-    public OperatorBuilder operandTypeInference(final SqlOperandTypeInference operandTypeInference)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc1NjIzNA==", "bodyText": "this seems handy to have \ud83e\udd18, but (nit) could you add javadoc indicating that these are the positions of the operands that are required to be literals? bonus points if you add javadocs to other methods, but also, since nothing else has them don't feel obligated to add them even for this unless there are other changes to make", "url": "https://github.com/apache/druid/pull/9893#discussion_r427756234", "createdAt": "2020-05-20T05:50:49Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/expression/OperatorConversions.java", "diffHunk": "@@ -291,15 +294,15 @@ public OperatorBuilder operandTypes(final SqlTypeFamily... operandTypes)\n       return this;\n     }\n \n-    public OperatorBuilder operandTypeInference(final SqlOperandTypeInference operandTypeInference)\n+    public OperatorBuilder requiredOperands(final int requiredOperands)\n     {\n-      this.operandTypeInference = operandTypeInference;\n+      this.requiredOperands = requiredOperands;\n       return this;\n     }\n \n-    public OperatorBuilder requiredOperands(final int requiredOperands)\n+    public OperatorBuilder literalOperands(final int... literalOperands)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2MDAzOQ==", "bodyText": "Would it make sense for this null part of the check be consolidated with the else if (operandType.getSqlTypeName() == SqlTypeName.NULL) branch by putting the can be null check first in the if/else chain? I guess SqlUtil.isNullLiteral, is slightly more expensive of a check than just checking that the type name is null, but is also maybe more correct since casting a null is still probably null?", "url": "https://github.com/apache/druid/pull/9893#discussion_r427760039", "createdAt": "2020-05-20T06:02:51Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/expression/OperatorConversions.java", "diffHunk": "@@ -430,36 +434,64 @@ public void inferOperandTypes(\n \n   /**\n    * Operand type checker that is used in 'simple' situations: there are a particular number of operands, with\n-   * particular types, some of which may be optional or nullable.\n+   * particular types, some of which may be optional or nullable, and some of which may be required to be literals.\n    */\n   private static class DefaultOperandTypeChecker implements SqlOperandTypeChecker\n   {\n     private final List<SqlTypeFamily> operandTypes;\n     private final int requiredOperands;\n     private final IntSet nullableOperands;\n+    private final IntSet literalOperands;\n \n     DefaultOperandTypeChecker(\n         final List<SqlTypeFamily> operandTypes,\n         final int requiredOperands,\n-        final IntSet nullableOperands\n+        final IntSet nullableOperands,\n+        @Nullable final int[] literalOperands\n     )\n     {\n       Preconditions.checkArgument(requiredOperands <= operandTypes.size() && requiredOperands >= 0);\n       this.operandTypes = Preconditions.checkNotNull(operandTypes, \"operandTypes\");\n       this.requiredOperands = requiredOperands;\n       this.nullableOperands = Preconditions.checkNotNull(nullableOperands, \"nullableOperands\");\n+\n+      if (literalOperands == null) {\n+        this.literalOperands = IntSets.EMPTY_SET;\n+      } else {\n+        this.literalOperands = new IntArraySet();\n+        Arrays.stream(literalOperands).forEach(this.literalOperands::add);\n+      }\n     }\n \n     @Override\n     public boolean checkOperandTypes(SqlCallBinding callBinding, boolean throwOnFailure)\n     {\n-      if (operandTypes.size() != callBinding.getOperandCount()) {\n-        // Just like FamilyOperandTypeChecker: assume this is an inapplicable sub-rule of a composite rule; don't throw\n-        return false;\n-      }\n-\n       for (int i = 0; i < callBinding.operands().size(); i++) {\n         final SqlNode operand = callBinding.operands().get(i);\n+\n+        if (literalOperands.contains(i)) {\n+          // Verify that 'operand' is a literal.\n+          if (!SqlUtil.isLiteral(operand)) {\n+            return throwOrReturn(\n+                throwOnFailure,\n+                callBinding,\n+                cb -> cb.getValidator()\n+                        .newValidationError(\n+                            operand,\n+                            Static.RESOURCE.argumentMustBeLiteral(callBinding.getOperator().getName())\n+                        )\n+            );\n+          }\n+\n+          if (!nullableOperands.contains(i) && SqlUtil.isNullLiteral(operand, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d8fd11e6e39a09393c9b38717db2e5c36fae44"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/215971a097bd6f8d80dde17a178f372cc8a6863b", "committedDate": "2020-05-21T16:54:23Z", "message": "Changes based on PR review."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MzM1MDg5", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-416335089", "createdAt": "2020-05-21T17:12:24Z", "commit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzoxMjoyNFrOGY7blQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzoxMjoyNFrOGY7blQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5MjcyNQ==", "bodyText": "what is the 3rd argument for? I only see the first 2 being used in this expr\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (args.size() < 2 || args.size() > 3) {\n          \n          \n            \n                if (args.size() != 2) {", "url": "https://github.com/apache/druid/pull/9893#discussion_r428792725", "createdAt": "2020-05-21T17:12:24Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/expression/RegexpLikeExprMacro.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.expression;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.java.util.common.IAE;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.math.expr.Expr;\n+import org.apache.druid.math.expr.ExprEval;\n+import org.apache.druid.math.expr.ExprMacroTable;\n+import org.apache.druid.math.expr.ExprType;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class RegexpLikeExprMacro implements ExprMacroTable.ExprMacro\n+{\n+  private static final String FN_NAME = \"regexp_like\";\n+\n+  @Override\n+  public String name()\n+  {\n+    return FN_NAME;\n+  }\n+\n+  @Override\n+  public Expr apply(final List<Expr> args)\n+  {\n+    if (args.size() < 2 || args.size() > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MzU0ODY2", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-416354866", "createdAt": "2020-05-21T17:39:54Z", "commit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzozOTo1NFrOGY8XYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzo0MjozMVrOGY8dDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwODAzMg==", "bodyText": "Do we have tests that check how the function performs against\n\na multi-value column\na numeric column\nmatching against null", "url": "https://github.com/apache/druid/pull/9893#discussion_r428808032", "createdAt": "2020-05-21T17:39:54Z", "author": {"login": "suneet-s"}, "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -7300,6 +7301,74 @@ public void testRegexpExtract() throws Exception\n     );\n   }\n \n+  @Test\n+  public void testRegexpExtractFilterViaNotNullCheck() throws Exception\n+  {\n+    // Cannot vectorize due to extractionFn in dimension spec.\n+    cannotVectorize();\n+\n+    testQuery(\n+        \"SELECT COUNT(*)\\n\"\n+        + \"FROM foo\\n\"\n+        + \"WHERE REGEXP_EXTRACT(dim1, '^1') IS NOT NULL OR REGEXP_EXTRACT('Z' || dim1, '^Z2') IS NOT NULL\",\n+        ImmutableList.of(\n+            Druids.newTimeseriesQueryBuilder()\n+                  .dataSource(CalciteTests.DATASOURCE1)\n+                  .intervals(querySegmentSpec(Filtration.eternity()))\n+                  .granularity(Granularities.ALL)\n+                  .virtualColumns(\n+                      expressionVirtualColumn(\"v0\", \"regexp_extract(concat('Z',\\\"dim1\\\"),'^Z2')\", ValueType.STRING)\n+                  )\n+                  .filters(\n+                      or(\n+                          not(selector(\"dim1\", null, new RegexDimExtractionFn(\"^1\", 0, true, null))),\n+                          not(selector(\"v0\", null, null))\n+                      )\n+                  )\n+                  .aggregators(new CountAggregatorFactory(\"a0\"))\n+                  .context(TIMESERIES_CONTEXT_DEFAULT)\n+                  .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{3L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testRegexpLikeFilter() throws Exception\n+  {\n+    // Cannot vectorize due to usage of regex filter.\n+    cannotVectorize();\n+\n+    testQuery(\n+        \"SELECT COUNT(*)\\n\"\n+        + \"FROM foo\\n\"\n+        + \"WHERE REGEXP_LIKE(dim1, '^1') OR REGEXP_LIKE('Z' || dim1, '^Z2')\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwOTQ4NQ==", "bodyText": "The docs say that \"The pattern must match starting at the beginning of expr\" but it looks like the regex pattern you are passing in is asking that it start at the beginning of the string via ^ in the pattern string. Can I use a $ in my regex to ask that it matches the end of the expr?", "url": "https://github.com/apache/druid/pull/9893#discussion_r428809485", "createdAt": "2020-05-21T17:42:31Z", "author": {"login": "suneet-s"}, "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -7300,6 +7301,74 @@ public void testRegexpExtract() throws Exception\n     );\n   }\n \n+  @Test\n+  public void testRegexpExtractFilterViaNotNullCheck() throws Exception\n+  {\n+    // Cannot vectorize due to extractionFn in dimension spec.\n+    cannotVectorize();\n+\n+    testQuery(\n+        \"SELECT COUNT(*)\\n\"\n+        + \"FROM foo\\n\"\n+        + \"WHERE REGEXP_EXTRACT(dim1, '^1') IS NOT NULL OR REGEXP_EXTRACT('Z' || dim1, '^Z2') IS NOT NULL\",\n+        ImmutableList.of(\n+            Druids.newTimeseriesQueryBuilder()\n+                  .dataSource(CalciteTests.DATASOURCE1)\n+                  .intervals(querySegmentSpec(Filtration.eternity()))\n+                  .granularity(Granularities.ALL)\n+                  .virtualColumns(\n+                      expressionVirtualColumn(\"v0\", \"regexp_extract(concat('Z',\\\"dim1\\\"),'^Z2')\", ValueType.STRING)\n+                  )\n+                  .filters(\n+                      or(\n+                          not(selector(\"dim1\", null, new RegexDimExtractionFn(\"^1\", 0, true, null))),\n+                          not(selector(\"v0\", null, null))\n+                      )\n+                  )\n+                  .aggregators(new CountAggregatorFactory(\"a0\"))\n+                  .context(TIMESERIES_CONTEXT_DEFAULT)\n+                  .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{3L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testRegexpLikeFilter() throws Exception\n+  {\n+    // Cannot vectorize due to usage of regex filter.\n+    cannotVectorize();\n+\n+    testQuery(\n+        \"SELECT COUNT(*)\\n\"\n+        + \"FROM foo\\n\"\n+        + \"WHERE REGEXP_LIKE(dim1, '^1') OR REGEXP_LIKE('Z' || dim1, '^Z2')\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwODAzMg=="}, "originalCommit": {"oid": "215971a097bd6f8d80dde17a178f372cc8a6863b"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3170b2d5e5cd6111cc5efc873d7e2847ae8397", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/0f3170b2d5e5cd6111cc5efc873d7e2847ae8397", "committedDate": "2020-05-21T18:03:46Z", "message": "Fix arg check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00698bfe82b1cbc9719d0e8e180ccfd9ddec7982", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/00698bfe82b1cbc9719d0e8e180ccfd9ddec7982", "committedDate": "2020-05-21T18:24:59Z", "message": "Important fixes!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd0c16f1fecea3f6835e803477982219a26bcd8b", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/dd0c16f1fecea3f6835e803477982219a26bcd8b", "committedDate": "2020-05-21T18:26:47Z", "message": "Add speller."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89dcaa80ba46ec5f76122bb41d324179e8d001b7", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/89dcaa80ba46ec5f76122bb41d324179e8d001b7", "committedDate": "2020-05-21T18:27:00Z", "message": "Merge branch 'master' into regexp-stuff"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NzQwNTE2", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-418740516", "createdAt": "2020-05-26T23:14:05Z", "commit": {"oid": "89dcaa80ba46ec5f76122bb41d324179e8d001b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b95b9e5430469fee78e4bc18784d902087ec265", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/8b95b9e5430469fee78e4bc18784d902087ec265", "committedDate": "2020-05-27T00:40:13Z", "message": "Merge branch 'master' into regexp-stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c72cab02b0caecd2501b094c1fd685f37e773a24", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/c72cab02b0caecd2501b094c1fd685f37e773a24", "committedDate": "2020-05-27T01:03:46Z", "message": "wip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTY1MDAy", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-419565002", "createdAt": "2020-05-27T19:59:49Z", "commit": {"oid": "89dcaa80ba46ec5f76122bb41d324179e8d001b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f67d2c9a77a88c7f89bdcafa096734edcc68b51", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/0f67d2c9a77a88c7f89bdcafa096734edcc68b51", "committedDate": "2020-06-01T17:37:42Z", "message": "Merge branch 'master' into regexp-stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "192ac338d967493679f287e550d9d4a8361159d1", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/192ac338d967493679f287e550d9d4a8361159d1", "committedDate": "2020-06-01T23:17:25Z", "message": "Additional tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb89950a7c18e6ab92bd34f6571c398577d160fe", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/cb89950a7c18e6ab92bd34f6571c398577d160fe", "committedDate": "2020-06-02T01:57:14Z", "message": "Merge branch 'master' into regexp-stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4197c0dea05b854fee63c54eb1694f064f8fea", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/ce4197c0dea05b854fee63c54eb1694f064f8fea", "committedDate": "2020-06-02T02:09:55Z", "message": "Fix up tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71b9e298c4285dac6082f8484ee44aae73dfceb4", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/71b9e298c4285dac6082f8484ee44aae73dfceb4", "committedDate": "2020-06-02T15:14:21Z", "message": "Add validation error tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6641cab46b570ac537822e67371d9ce41f41b11d", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/6641cab46b570ac537822e67371d9ce41f41b11d", "committedDate": "2020-06-02T16:51:50Z", "message": "Additional tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDgzODgy", "url": "https://github.com/apache/druid/pull/9893#pullrequestreview-423083882", "createdAt": "2020-06-02T21:53:11Z", "commit": {"oid": "6641cab46b570ac537822e67371d9ce41f41b11d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTo1MzoxMlrOGeFQJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTo1MzoxMlrOGeFQJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NjUxOA==", "bodyText": "nit: Is this nullToEmptyIfNeeded still needed because of the if block on line 77 - same comment for RegexpExtractMacro\nUnclear to me if there's a performance loss from the extra function call (I'd think it's probably not measurable)", "url": "https://github.com/apache/druid/pull/9893#discussion_r434196518", "createdAt": "2020-06-02T21:53:12Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/expression/RegexpLikeExprMacro.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.expression;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.java.util.common.IAE;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.math.expr.Expr;\n+import org.apache.druid.math.expr.ExprEval;\n+import org.apache.druid.math.expr.ExprMacroTable;\n+import org.apache.druid.math.expr.ExprType;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class RegexpLikeExprMacro implements ExprMacroTable.ExprMacro\n+{\n+  private static final String FN_NAME = \"regexp_like\";\n+\n+  @Override\n+  public String name()\n+  {\n+    return FN_NAME;\n+  }\n+\n+  @Override\n+  public Expr apply(final List<Expr> args)\n+  {\n+    if (args.size() != 2) {\n+      throw new IAE(\"Function[%s] must have 2 arguments\", name());\n+    }\n+\n+    final Expr arg = args.get(0);\n+    final Expr patternExpr = args.get(1);\n+\n+    if (!ExprUtils.isStringLiteral(patternExpr)) {\n+      throw new IAE(\"Function[%s] pattern must be a string literal\", name());\n+    }\n+\n+    // Precompile the pattern.\n+    final Pattern pattern = Pattern.compile(\n+        StringUtils.nullToEmptyNonDruidDataString((String) patternExpr.getLiteralValue())\n+    );\n+\n+    class RegexpLikeExpr extends ExprMacroTable.BaseScalarUnivariateMacroFunctionExpr\n+    {\n+      private RegexpLikeExpr(Expr arg)\n+      {\n+        super(FN_NAME, arg);\n+      }\n+\n+      @Nonnull\n+      @Override\n+      public ExprEval eval(final ObjectBinding bindings)\n+      {\n+        final String s = NullHandling.nullToEmptyIfNeeded(arg.eval(bindings).asString());\n+\n+        if (s == null) {\n+          // True nulls do not match anything. Note: this branch only executes in SQL-compatible null handling mode.\n+          return ExprEval.of(false, ExprType.LONG);\n+        } else {\n+          final Matcher matcher = pattern.matcher(NullHandling.nullToEmptyIfNeeded(s));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6641cab46b570ac537822e67371d9ce41f41b11d"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "292836a4b21c33afa6acfa3f300157ffc8d7d6fe", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/292836a4b21c33afa6acfa3f300157ffc8d7d6fe", "committedDate": "2020-06-03T17:43:12Z", "message": "Merge branch 'master' into regexp-stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb322273174716b58c04b72fd79c2ea53eb31c96", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/bb322273174716b58c04b72fd79c2ea53eb31c96", "committedDate": "2020-06-03T17:45:39Z", "message": "Remove useless call."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2374, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}