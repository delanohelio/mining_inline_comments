{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2ODI2MjA5", "number": 10603, "title": "Add new coordinator metrics for coordinator duty runtimes", "bodyText": "Description\n\n\n\nAdds two new metrics to the coordinator. These metrics help operators evaluate coordinator runtimes and allow for analyzing runtimes for individual duties if the metrics are emitted (as of now, only HistoricalManagementDuties Runnable will emit the individual duty runtime metrics).\ncoordinator/time = the time for an individual duty to execute\ncoordinator/global/time = the time for the whole duties runnable to execute\nExample metric json:\ncoordinator/global/time\n{\"feed\":\"metrics\",\"timestamp\":\"2020-11-24T22:22:54.288Z\",\"service\":\"druid/coordinator\",\"host\":\"coordinator:8081\",\"version\":\"0.21.0-SNAPSHOT\",\"metric\":\"coordinator/global/time\",\"value\":250,\"dutyGroup\":\"HistoricalManagementDuties\"}\n\ncoordinator/time\n{\"feed\":\"metrics\",\"timestamp\":\"2020-11-24T22:22:54.287Z\",\"service\":\"druid/coordinator\",\"host\":\"coordinator:8081\",\"version\":\"0.21.0-SNAPSHOT\",\"metric\":\"coordinator/time\",\"value\":1,\"duty\":\"LogUsedSegments\"}\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\nCoordinatorStats\nDruidCoordinator\nCoordinatorDuty Interface\nEmitClusterStatsAndMetrics", "createdAt": "2020-11-24T22:33:55Z", "url": "https://github.com/apache/druid/pull/10603", "merged": true, "mergeCommit": {"oid": "2560bf0a1919c36b824bd0e4f9286e2899deddd3"}, "closed": true, "closedAt": "2020-11-29T22:47:36Z", "author": {"login": "capistrant"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfxbQ-gH2gAyNTI2ODI2MjA5OjA3YWY0ZWY1NTExNTcwYjFiYmZkN2YwYTczYjJlNmYzZDQ1OTBlZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkXr7BAFqTU0Nzg0MDI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07af4ef5511570b1bbfd7f0a73b2e6f3d4590ee9", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/07af4ef5511570b1bbfd7f0a73b2e6f3d4590ee9", "committedDate": "2020-11-24T22:24:01Z", "message": "Add new coordinator metrics for duty runtimes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af55290ca6e8b7d1adcbb7cd8c75a4ddab87d4b6", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/af55290ca6e8b7d1adcbb7cd8c75a4ddab87d4b6", "committedDate": "2020-11-24T22:32:21Z", "message": "fix spelling for a constant variable value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15525fbab893b4438fbaedd3663724c71ff720d9", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/15525fbab893b4438fbaedd3663724c71ff720d9", "committedDate": "2020-11-24T22:54:45Z", "message": "add comment clarifying why the global runtime metric is emitted where it is"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDc2ODg3", "url": "https://github.com/apache/druid/pull/10603#pullrequestreview-538076887", "createdAt": "2020-11-25T00:47:24Z", "commit": {"oid": "15525fbab893b4438fbaedd3663724c71ff720d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMDo0NzoyNFrOH5e4kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMDo0NzoyNFrOH5e4kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAzNjg4Mw==", "bodyText": "will it be ok to just use \"duty.getClass().getName()\" for this use case instead of extending the interface?", "url": "https://github.com/apache/druid/pull/10603#discussion_r530036883", "createdAt": "2020-11-25T00:47:24Z", "author": {"login": "himanshug"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -801,14 +811,24 @@ public void run()\n               && coordLeaderSelector.isLeader()\n               && startingLeaderCounter == coordLeaderSelector.localTerm()) {\n \n+            final long start = System.nanoTime();\n             params = duty.run(params);\n+            final long end = System.nanoTime();\n \n             if (params == null) {\n               // This duty wanted to cancel the run. No log message, since the duty should have logged a reason.\n               return;\n+            } else {\n+              params.getCoordinatorStats().addToDutyStat(\"runtime\", duty.getDutyAlias(), TimeUnit.NANOSECONDS.toMillis(end - start));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15525fbab893b4438fbaedd3663724c71ff720d9"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d815f8aea06f30bd17b2698b1b64ac23a38b583a", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/d815f8aea06f30bd17b2698b1b64ac23a38b583a", "committedDate": "2020-11-25T01:33:06Z", "message": "Remove duty alias in lieu of using the class name for metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff08d495ca1095fbacada7cde98bfa15e016403a", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/ff08d495ca1095fbacada7cde98bfa15e016403a", "committedDate": "2020-11-25T13:18:45Z", "message": "fix docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf99fbe3fce6584d93cc0103163c9f09c828c41", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/ecf99fbe3fce6584d93cc0103163c9f09c828c41", "committedDate": "2020-11-25T16:08:16Z", "message": "CoordinatorStats tests + add duty stats to accumulate() logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTMwOTM4", "url": "https://github.com/apache/druid/pull/10603#pullrequestreview-540530938", "createdAt": "2020-11-29T22:47:03Z", "commit": {"oid": "ecf99fbe3fce6584d93cc0103163c9f09c828c41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODQwMjQ4", "url": "https://github.com/apache/druid/pull/10603#pullrequestreview-547840248", "createdAt": "2020-12-09T05:14:18Z", "commit": {"oid": "ecf99fbe3fce6584d93cc0103163c9f09c828c41"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3096, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}