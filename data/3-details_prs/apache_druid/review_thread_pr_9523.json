{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTc2MzM5", "number": 9523, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0MjoyN1rODpA8_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0NjoxNFrODpBCIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzMzODIyOnYy", "diffSide": "RIGHT", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0MjoyN1rOF36-oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjo0MToxOVrOF4ZZDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MjMwNA==", "bodyText": "nit: formatting\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                         segmentConfig.getContainer(), segmentConfig.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                    segmentConfig.getContainer(),\n          \n          \n            \n                    segmentConfig.getPrefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182304", "createdAt": "2020-03-18T08:42:27Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDU4OA==", "bodyText": "done", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680588", "createdAt": "2020-03-18T22:41:19Z", "author": {"login": "zachjsh"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MjMwNA=="}, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzM0MTg3OnYy", "diffSide": "RIGHT", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0MzoyNVrOF37Aww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjo0MToxNVrOF4ZY9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mjg1MQ==", "bodyText": "Heh, should probably be\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting segment files from Azure. Error: %s\", e.getMessage());", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182851", "createdAt": "2020-03-18T08:43:25Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          segmentConfig.getContainer(),\n+          segmentConfig.getPrefix(),\n+          Predicates.alwaysTrue()\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDU2NQ==", "bodyText": "done", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680565", "createdAt": "2020-03-18T22:41:15Z", "author": {"login": "zachjsh"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          segmentConfig.getContainer(),\n+          segmentConfig.getPrefix(),\n+          Predicates.alwaysTrue()\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mjg1MQ=="}, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzM0NDg2OnYy", "diffSide": "RIGHT", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0NDoxMVrOF37Ciw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjo0MToxMlrOF4ZY2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MzMwNw==", "bodyText": "same wrong cloud\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting task log files from Azure. Error: %s\", e.getMessage());", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183307", "createdAt": "2020-03-18T08:44:11Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          config.getContainer(),\n+          config.getPrefix(),\n+          (object) -> object.getLastModifed().getTime() < timestamp\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDUzNg==", "bodyText": "done", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680536", "createdAt": "2020-03-18T22:41:12Z", "author": {"login": "zachjsh"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          config.getContainer(),\n+          config.getPrefix(),\n+          (object) -> object.getLastModifed().getTime() < timestamp\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MzMwNw=="}, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzM0NzY3OnYy", "diffSide": "RIGHT", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0NTowNVrOF37ESg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjo0MTowNVrOF4ZYsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mzc1NA==", "bodyText": "same comment about 1 line per arg formatting if spans multiple lines\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183754", "createdAt": "2020-03-18T08:45:05Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDQ5OA==", "bodyText": "done", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680498", "createdAt": "2020-03-18T22:41:05Z", "author": {"login": "zachjsh"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mzc1NA=="}, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzM1MTM5OnYy", "diffSide": "RIGHT", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0NjoxNFrOF37GvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjo0MDo1OVrOF4ZYkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NDM4MA==", "bodyText": "same formatting nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix(), new Date(timestamp)\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix(),\n          \n          \n            \n                    new Date(timestamp)\n          \n          \n            \n                );\n          \n      \n    \n    \n  \n\nsorry there isn't a style rule for this, last we checked it wasn't possible to do, but it's been a while so it might be worth checking on again...", "url": "https://github.com/apache/druid/pull/9523#discussion_r394184380", "createdAt": "2020-03-18T08:46:14Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDQ2Nw==", "bodyText": "done", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680467", "createdAt": "2020-03-18T22:40:59Z", "author": {"login": "zachjsh"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NDM4MA=="}, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2641, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}