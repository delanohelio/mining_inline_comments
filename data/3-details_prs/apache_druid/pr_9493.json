{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MDk1MjMz", "number": 9493, "title": "threshold based automatic query prioritization", "bodyText": "Description\nThis PR is a follow-up to #9407 that adds a new interface QueryPrioritizationStrategy intended to enable implementations to automatically prioritize queries based on some criteria. As a proof of concept implementation of this functionality, it provides ThresholdBasedQueryDeprioritizationStrategy, which offers the 3 thresholds of: period from the current time of the query, duration of the interval of the query, and number of segments taking part in the query, described in #6993.\nThis strategy can be enabled by setting druid.query.scheduler.prioritization.strategy to threshold.\n\n\n\nProperty\nDescription\nDefault\n\n\n\n\ndruid.query.scheduler.prioritization.periodThreshold\nISO duration threshold for how old data can be queried before automatically adjusting query priority.\nNone\n\n\ndruid.query.scheduler.prioritization.durationThreshold\nISO duration threshold for maximum duration a queries interval can span before the priority is automatically adjusted.\nNone\n\n\ndruid.query.scheduler.prioritization.segmentCountThreshold\nNumber threshold for maximum number of segments that can take part in a query before its priority is automatically adjusted.\nNone\n\n\ndruid.query.scheduler.prioritization.adjustment\nAmount to reduce the priority of queries which cross any threshold.\nNone\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-10T12:07:05Z", "url": "https://github.com/apache/druid/pull/9493", "merged": true, "mergeCommit": {"oid": "6afd55c8f4b49802d873ca181727231670abd566"}, "closed": true, "closedAt": "2020-03-13T08:41:55Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMQk99AH2gAyMzg2MDk1MjMzOmY5MDUzNzlkZjg3NDVhMTZhZWU3YjExYWQ4NmVhMjk2N2EzZDdjZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNLM86AH2gAyMzg2MDk1MjMzOmFmZGJlMTkxNDEzZDZmZGE4M2JmMDE4NzE3ZTExNThhMjcxMTdjNmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f905379df8745a16aee7b11ad86ea2967a3d7ce0", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/f905379df8745a16aee7b11ad86ea2967a3d7ce0", "committedDate": "2020-03-10T11:12:02Z", "message": "threshold based automatic query prioritization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae7557503c48c3681079ea72d81eae0b070ee9ba", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/ae7557503c48c3681079ea72d81eae0b070ee9ba", "committedDate": "2020-03-10T12:06:01Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd4ef712c86af85fd60dbccd5eda92556436ff31", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/dd4ef712c86af85fd60dbccd5eda92556436ff31", "committedDate": "2020-03-11T10:59:43Z", "message": "spelling and fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cb12057ba9a036fb7cd2f2a3ab597af7908cdbd", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/5cb12057ba9a036fb7cd2f2a3ab597af7908cdbd", "committedDate": "2020-03-11T11:10:06Z", "message": "fix docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7731a739d0a49e1a35e7343fff2519ce8391e254", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/7731a739d0a49e1a35e7343fff2519ce8391e254", "committedDate": "2020-03-11T11:13:13Z", "message": "spelling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/828a0ebdf497d46873b49c82ca65698361609cb4", "committedDate": "2020-03-11T13:04:42Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjIwMDQz", "url": "https://github.com/apache/druid/pull/9493#pullrequestreview-373220043", "createdAt": "2020-03-12T01:02:47Z", "commit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTowMjo0N1rOF1OMXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTowMjo0N1rOF1OMXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM1MTM5MQ==", "bodyText": "nit: hmm, is 'no auto' = 'manual'? Just wondering what is a better name.", "url": "https://github.com/apache/druid/pull/9493#discussion_r391351391", "createdAt": "2020-03-12T01:02:47Z", "author": {"login": "jihoonson"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1473,22 +1473,41 @@ These Broker configurations can be defined in the `broker/runtime.properties` fi\n \n #### Query configuration\n \n-##### Query prioritization\n+##### Query routing\n \n |Property|Possible Values|Description|Default|\n |--------|---------------|-----------|-------|\n |`druid.broker.balancer.type`|`random`, `connectionCount`|Determines how the broker balances connections to Historical processes. `random` choose randomly, `connectionCount` picks the process with the fewest number of active connections to|`random`|\n |`druid.broker.select.tier`|`highestPriority`, `lowestPriority`, `custom`|If segments are cross-replicated across tiers in a cluster, you can tell the broker to prefer to select segments in a tier with a certain priority.|`highestPriority`|\n |`druid.broker.select.tier.custom.priorities`|`An array of integer priorities.`|Select servers in tiers with a custom priority list.|None|\n \n-##### Query laning\n+##### Query prioritization and laning\n \n *Laning strategies* allow you to control capacity utilization for heterogeneous query workloads. With laning, the broker examines and classifies a query for the purpose of assigning it to a 'lane'. Lanes have capacity limits, enforced by the broker, that can be used to ensure sufficient resources are available for other lanes or for interactive queries (with no lane), or to limit overall throughput for queries within the lane. Requests in excess of the capacity are discarded with an HTTP 429 status code.\n \n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.query.scheduler.numThreads`|Maximum number of HTTP threads to dedicate to query processing. To save HTTP thread capacity, this should be lower than `druid.server.http.numThreads`.|Unbounded|\n |`druid.query.scheduler.laning.strategy`|Query laning strategy to use to assign queries to a lane in order to control capacities for certain classes of queries.|`none`|\n+|`druid.query.scheduler.prioritization.strategy`|Query prioritization strategy to automatically assign priorities.|`none`|\n+\n+##### Prioritization strategies\n+\n+###### No auto prioritization strategy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzY5MjYz", "url": "https://github.com/apache/druid/pull/9493#pullrequestreview-373769263", "createdAt": "2020-03-12T17:41:34Z", "commit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNzo0MTozNFrOF1oxPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNzo0MTozNFrOF1oxPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4NjgxNQ==", "bodyText": "nit: by rephrasing it to say, \"... strategy lowers priority of queries that...\" , we could make the heading be \"Threshold prioritization strategy\"", "url": "https://github.com/apache/druid/pull/9493#discussion_r391786815", "createdAt": "2020-03-12T17:41:34Z", "author": {"login": "himanshug"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1473,22 +1473,41 @@ These Broker configurations can be defined in the `broker/runtime.properties` fi\n \n #### Query configuration\n \n-##### Query prioritization\n+##### Query routing\n \n |Property|Possible Values|Description|Default|\n |--------|---------------|-----------|-------|\n |`druid.broker.balancer.type`|`random`, `connectionCount`|Determines how the broker balances connections to Historical processes. `random` choose randomly, `connectionCount` picks the process with the fewest number of active connections to|`random`|\n |`druid.broker.select.tier`|`highestPriority`, `lowestPriority`, `custom`|If segments are cross-replicated across tiers in a cluster, you can tell the broker to prefer to select segments in a tier with a certain priority.|`highestPriority`|\n |`druid.broker.select.tier.custom.priorities`|`An array of integer priorities.`|Select servers in tiers with a custom priority list.|None|\n \n-##### Query laning\n+##### Query prioritization and laning\n \n *Laning strategies* allow you to control capacity utilization for heterogeneous query workloads. With laning, the broker examines and classifies a query for the purpose of assigning it to a 'lane'. Lanes have capacity limits, enforced by the broker, that can be used to ensure sufficient resources are available for other lanes or for interactive queries (with no lane), or to limit overall throughput for queries within the lane. Requests in excess of the capacity are discarded with an HTTP 429 status code.\n \n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.query.scheduler.numThreads`|Maximum number of HTTP threads to dedicate to query processing. To save HTTP thread capacity, this should be lower than `druid.server.http.numThreads`.|Unbounded|\n |`druid.query.scheduler.laning.strategy`|Query laning strategy to use to assign queries to a lane in order to control capacities for certain classes of queries.|`none`|\n+|`druid.query.scheduler.prioritization.strategy`|Query prioritization strategy to automatically assign priorities.|`none`|\n+\n+##### Prioritization strategies\n+\n+###### No auto prioritization strategy\n+With this configuration, queries are never assigned a priority automatically, but will preserve a priority manually set on the [query context](../querying/query-context.md) with the `priority` key. This mode can be explicitly set by setting `druid.query.scheduler.prioritization.strategy` to `none`.\n+\n+###### Threshold deprioritization strategy\n+\n+This prioritization strategy deprioritizes queries that cross any of a configurable set of thresholds, such as how far in the past the data is, how large of an interval a query covers, or the number of segments taking part in a query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzcwNzE1", "url": "https://github.com/apache/druid/pull/9493#pullrequestreview-373770715", "createdAt": "2020-03-12T17:43:31Z", "commit": {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a307955ef146f43cbfb4405a1bf71f06298768", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/d0a307955ef146f43cbfb4405a1bf71f06298768", "committedDate": "2020-03-12T22:01:38Z", "message": "adjustments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afdbe191413d6fda83bf018717e1158a27117c6f", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/afdbe191413d6fda83bf018717e1158a27117c6f", "committedDate": "2020-03-13T07:30:12Z", "message": "doc fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2617, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}