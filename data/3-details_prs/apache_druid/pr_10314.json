{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDUwODY0", "number": 10314, "title": "Add config and header support for confluent schema registry. ", "bodyText": "(porting code from #9096)\nFixes #8806.\nDescription\nThis is an update to the code in PR 9096 (#9096), since it's stale. I report the original description and the changes I made\nEnhancing schema registry client i.e. SchemaRegistryBasedAvroBytesDecoder to accept additional configs, headers and able to query schemas from multi schema registry instances.\n\nChanged SchemaRegistryBasedAvroBytesDecoder to accept config and headers as JSON properties.\nAdded support to pass multiple URLs for multiple schema registry instances by passing them as an array\nUpgraded Confluent version to 5.5.1, which is compatible with existing kafka version: 2.6.0\nChanged deprecated method getByID to getById.\n\n\nKey changed/added classes in this PR\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n been tested in a test Druid cluster.\n\n\nKey changed/added classes in this PR\n\nSchemaRegistryBasedAvroBytesDecoder\nSchemaRegistryBasedAvroBytesDecoderTest\nUpdated libraries", "createdAt": "2020-08-24T11:26:29Z", "url": "https://github.com/apache/druid/pull/10314", "merged": true, "mergeCommit": {"oid": "99198c02af141bc2f6579bc9070cd34fbbf33e43"}, "closed": true, "closedAt": "2021-02-27T22:25:35Z", "author": {"login": "spinatelli"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCDXzgAH2gAyNDcyNDUwODY0OjU2NDcyZWQyY2EwNzBhZGEzNDAwZTQ3M2RkYWFmMGZlOTY3OTk0NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd-WXg0AFqTYwMDE5OTYyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56472ed2ca070ada3400e473ddaaf0fe96799446", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/56472ed2ca070ada3400e473ddaaf0fe96799446", "committedDate": "2020-08-24T14:20:48Z", "message": "Add config and header support for confluent schema registry. (porting code from https://github.com/apache/druid/pull/9096)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "56472ed2ca070ada3400e473ddaaf0fe96799446", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/56472ed2ca070ada3400e473ddaaf0fe96799446", "committedDate": "2020-08-24T14:20:48Z", "message": "Add config and header support for confluent schema registry. (porting code from https://github.com/apache/druid/pull/9096)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdf97f6928ae48accc520448cdb72f7d778897d5", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/bdf97f6928ae48accc520448cdb72f7d778897d5", "committedDate": "2020-08-24T18:13:04Z", "message": "Add Eclipse Public License 2.0 to license check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "bdf97f6928ae48accc520448cdb72f7d778897d5", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/bdf97f6928ae48accc520448cdb72f7d778897d5", "committedDate": "2020-08-24T18:13:04Z", "message": "Add Eclipse Public License 2.0 to license check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "14887008fd107f1e72b28b2592bb87641cf74749", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/14887008fd107f1e72b28b2592bb87641cf74749", "committedDate": "2020-08-26T08:21:23Z", "message": "Update licenses.yaml, revert changes to check-licenses.py and dependencies for integration-tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "14887008fd107f1e72b28b2592bb87641cf74749", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/14887008fd107f1e72b28b2592bb87641cf74749", "committedDate": "2020-08-26T08:21:23Z", "message": "Update licenses.yaml, revert changes to check-licenses.py and dependencies for integration-tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "444a972469a6a3403e488cb1c27a248236ec5bf9", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/444a972469a6a3403e488cb1c27a248236ec5bf9", "committedDate": "2020-08-26T15:47:15Z", "message": "Merge branch 'master' into Druid-8806"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "444a972469a6a3403e488cb1c27a248236ec5bf9", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/444a972469a6a3403e488cb1c27a248236ec5bf9", "committedDate": "2020-08-26T15:47:15Z", "message": "Merge branch 'master' into Druid-8806"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218fd4ddebf26d558345d48dea58a185996c101d", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/218fd4ddebf26d558345d48dea58a185996c101d", "committedDate": "2020-09-02T14:41:08Z", "message": "Merge branch 'master' into Druid-8806"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "900c97d3f1246856f0d71a883c0c3f5d48778a92", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/900c97d3f1246856f0d71a883c0c3f5d48778a92", "committedDate": "2020-09-07T07:06:29Z", "message": "Merge branch 'master' into Druid-8806"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b", "committedDate": "2020-09-28T11:26:52Z", "message": "Merge branch 'master' into Druid-8806"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDExNTk4", "url": "https://github.com/apache/druid/pull/10314#pullrequestreview-542411598", "createdAt": "2020-12-02T00:40:18Z", "commit": {"oid": "ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMDo0MToxOVrOH9FptA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMDo0ODoyN1rOH9FzSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgxNzc4MA==", "bodyText": "it seems like this method is deprecated as well, but it doesn't really seem like there is a better replacement since the underlying method is doing this\n    ParsedSchema schema = this.getSchemaById(id);\n    return schema instanceof AvroSchema ? ((AvroSchema)schema).rawSchema() : null;", "url": "https://github.com/apache/druid/pull/10314#discussion_r533817780", "createdAt": "2020-12-02T00:41:19Z", "author": {"login": "clintropolis"}, "path": "extensions-core/avro-extensions/src/main/java/org/apache/druid/data/input/avro/SchemaRegistryBasedAvroBytesDecoder.java", "diffHunk": "@@ -63,7 +73,7 @@ public GenericRecord parse(ByteBuffer bytes)\n       int id = bytes.getInt(); // extract schema registry id\n       int length = bytes.limit() - 1 - 4;\n       int offset = bytes.position() + bytes.arrayOffset();\n-      Schema schema = registry.getByID(id);\n+      Schema schema = registry.getById(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgxODg0Ng==", "bodyText": "nit: did this get tagged with an incorrect module or was it just missing from the file? (it doesn't seem like there were any changes to that extension)", "url": "https://github.com/apache/druid/pull/10314#discussion_r533818846", "createdAt": "2020-12-02T00:44:29Z", "author": {"login": "clintropolis"}, "path": "licenses.yaml", "diffHunk": "@@ -3081,13 +3081,105 @@ notices:\n ---\n \n name: Kafka Schema Registry Client\n-version: 3.0.1\n+version: 5.5.1\n license_category: binary\n module: extensions/druid-avro-extensions\n license_name: Apache License version 2.0\n libraries:\n   - io.confluent: kafka-schema-registry-client\n+  - io.confluent: common-config\n+  - io.confluent: common-utils\n+\n+---\n+\n+name: com.101tec zkclient\n+license_category: binary\n+version: '0.10'\n+module: druid-ranger-security", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyMDIzNQ==", "bodyText": "The basic auth example I don't think works anymore, looking at the code underneath it looks like the schema.registry prefix is only for the ssl config\n    if (configs != null && !configs.isEmpty()) {\n      restService.configure(configs);\n      Map<String, Object> sslConfigs = (Map)configs.entrySet().stream().filter((e) -> {\n        return ((String)e.getKey()).startsWith(\"schema.registry.\");\n      }).collect(Collectors.toMap((e) -> {\n        return ((String)e.getKey()).substring(\"schema.registry.\".length());\n      }, Entry::getValue));\n      SslFactory sslFactory = new SslFactory(sslConfigs);\n      if (sslFactory != null && sslFactory.sslContext() != null) {\n        restService.setSslSocketFactory(sslFactory.sslContext().getSocketFactory());\n      }\n    }\n\nwhere restService is not considering the prefix:\n    String basicCredentialsSource = (String)configs.get(\"basic.auth.credentials.source\");\n    String bearerCredentialsSource = (String)configs.get(\"bearer.auth.credentials.source\");\n...\n\nAfter reading through https://docs.confluent.io/platform/current/schema-registry/security/index.html#additional-configurations-for-https, should we also include the SSL config since it seems relevant if connecting to https?\nAlso, formatting seems a bit off here compared to the other JSON example:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               \"type\"   : \"schema_registry\",\n          \n          \n            \n               \"urls\"   : [<schema-registry-url-1>, <schema-registry-url-2>, ...],\n          \n          \n            \n               \"config\" : {\n          \n          \n            \n                           \"schema.registry.basic.auth.credentials.source\" : \"USER_INFO\",\n          \n          \n            \n                           \"schema.registry.basic.auth.user.info\"          : \"fred:letmein\",\n          \n          \n            \n                           ... \n          \n          \n            \n                          },\n          \n          \n            \n               \"headers\": {\n          \n          \n            \n                           \"traceID\"   : \"b29c5de2-0db4-490b-b421\",\n          \n          \n            \n                           \"timeStamp\" : \"1577191871865\",\n          \n          \n            \n                           ...\n          \n          \n            \n                           \n          \n          \n            \n                         }\n          \n          \n            \n               \"type\" : \"schema_registry\",\n          \n          \n            \n               \"urls\" : [<schema-registry-url-1>, <schema-registry-url-2>, ...],\n          \n          \n            \n               \"config\" : {\n          \n          \n            \n                    \"basic.auth.credentials.source\": \"USER_INFO\",\n          \n          \n            \n                    \"basic.auth.user.info\": \"fred:letmein\",\n          \n          \n            \n                    \"schema.registry.ssl.truststore.location\": \"/some/secrets/kafka.client.truststore.jks\",\n          \n          \n            \n                    \"schema.registry.ssl.truststore.password\": \"<password>\",\n          \n          \n            \n                    \"schema.registry.ssl.keystore.location\": \"/some/secrets/kafka.client.keystore.jks\",\n          \n          \n            \n                    \"schema.registry.ssl.keystore.password\": \"<password>\",\n          \n          \n            \n                    \"schema.registry.ssl.key.password\": \"<password>\"\n          \n          \n            \n                   ... \n          \n          \n            \n               },\n          \n          \n            \n               \"headers\": {\n          \n          \n            \n                   \"traceID\" : \"b29c5de2-0db4-490b-b421\",\n          \n          \n            \n                   \"timeStamp\" : \"1577191871865\",\n          \n          \n            \n                   ...\n          \n          \n            \n                }", "url": "https://github.com/apache/druid/pull/10314#discussion_r533820235", "createdAt": "2020-12-02T00:48:27Z", "author": {"login": "clintropolis"}, "path": "docs/ingestion/data-formats.md", "diffHunk": "@@ -1020,6 +1026,27 @@ For details, see the Schema Registry [documentation](http://docs.confluent.io/cu\n ...\n ```\n \n+Multiple Instances:\n+```json\n+...\n+\"avroBytesDecoder\" : {\n+   \"type\"   : \"schema_registry\",\n+   \"urls\"   : [<schema-registry-url-1>, <schema-registry-url-2>, ...],\n+   \"config\" : {\n+               \"schema.registry.basic.auth.credentials.source\" : \"USER_INFO\",\n+               \"schema.registry.basic.auth.user.info\"          : \"fred:letmein\",\n+               ... \n+              },\n+   \"headers\": {\n+               \"traceID\"   : \"b29c5de2-0db4-490b-b421\",\n+               \"timeStamp\" : \"1577191871865\",\n+               ...\n+               \n+             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7c7b0d18c47fd7599bf3da3fd9335c4c593c8b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d4ccbd63921fbf29f2b607bcfb52a18031ea8aa", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/6d4ccbd63921fbf29f2b607bcfb52a18031ea8aa", "committedDate": "2021-02-26T11:23:52Z", "message": "Merge remote-tracking branch 'upstream/master' into Druid-8806"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68cbd0a0f6da6e1b760e9f7263d88d58724a749b", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/68cbd0a0f6da6e1b760e9f7263d88d58724a749b", "committedDate": "2021-02-26T13:11:11Z", "message": "Add spelling exception and remove unused dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29f73ce4a5ba68ee1cc6d6498788a28cc2b8443", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/a29f73ce4a5ba68ee1cc6d6498788a28cc2b8443", "committedDate": "2021-02-26T14:04:34Z", "message": "Use non-deprecated getSchemaById() and remove duplicated license entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2925492a7d55c7bb1ade4c56145727fc8584fd9c", "author": {"user": {"login": "spinatelli", "name": null}}, "url": "https://github.com/apache/druid/commit/2925492a7d55c7bb1ade4c56145727fc8584fd9c", "committedDate": "2021-02-26T14:05:06Z", "message": "Update docs/ingestion/data-formats.md\n\nCo-authored-by: Clint Wylie <cjwylie@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "2925492a7d55c7bb1ade4c56145727fc8584fd9c", "author": {"user": {"login": "spinatelli", "name": null}}, "url": "https://github.com/apache/druid/commit/2925492a7d55c7bb1ade4c56145727fc8584fd9c", "committedDate": "2021-02-26T14:05:06Z", "message": "Update docs/ingestion/data-formats.md\n\nCo-authored-by: Clint Wylie <cjwylie@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26bffa3f2ec8bfba4038e64522f017abfec8bea5", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/26bffa3f2ec8bfba4038e64522f017abfec8bea5", "committedDate": "2021-02-26T14:25:36Z", "message": "Added check for schema being null, as per Confluent code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4cbfe2d778797aa849a2109cabc96d14cf8bfe7", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/a4cbfe2d778797aa849a2109cabc96d14cf8bfe7", "committedDate": "2021-02-26T17:08:44Z", "message": "Missing imports and whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77bc36675737459a425efc934e693af42295fee", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/f77bc36675737459a425efc934e693af42295fee", "committedDate": "2021-02-27T18:11:29Z", "message": "Updated unit tests with AvroSchema"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjAwMTk5NjI2", "url": "https://github.com/apache/druid/pull/10314#pullrequestreview-600199626", "createdAt": "2021-02-27T22:24:08Z", "commit": {"oid": "f77bc36675737459a425efc934e693af42295fee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3471, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}