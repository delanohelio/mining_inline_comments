{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNjYzNjc4", "number": 10198, "title": "Fix timeseries query constructor when postAggregator has an expression reading timestamp result column", "bodyText": "Description\nThe timestamp result column should be passed to Queries.prepareAggregation() for timeseries queries, otherwise the query can fail at the sanity check with the below error if there are some post aggregators which read the timestamp result column.\nCaused by: java.lang.IllegalArgumentException: Missing fields [[d0]] for postAggregator [p0]\n\tat com.google.common.base.Preconditions.checkArgument(Preconditions.java:148)\n\tat org.apache.druid.query.Queries.prepareAggregations(Queries.java:117)\n\tat org.apache.druid.query.timeseries.TimeseriesQuery.<init>(TimeseriesQuery.java:84)\n\tat org.apache.druid.sql.calcite.rel.DruidQuery.toTimeseriesQuery(DruidQuery.java:808)\n\tat org.apache.druid.sql.calcite.rel.DruidQuery.computeQuery(DruidQuery.java:703)\n\tat org.apache.druid.sql.calcite.rel.DruidQuery.<init>(DruidQuery.java:140)\n\tat org.apache.druid.sql.calcite.rel.DruidQuery.fromPartialQuery(DruidQuery.java:218)\n\tat org.apache.druid.sql.calcite.rel.PartialDruidQuery.build(PartialDruidQuery.java:307)\n\tat org.apache.druid.sql.calcite.rel.DruidQueryRel.toDruidQuery(DruidQueryRel.java:86)\n\tat org.apache.druid.sql.calcite.rel.DruidQueryRel.toDruidQueryForExplaining(DruidQueryRel.java:98)\n\tat org.apache.druid.sql.calcite.rel.DruidRel.isValidDruidQuery(DruidRel.java:55)\n\tat org.apache.druid.sql.calcite.rule.DruidRules$DruidQueryRule.onMatch(DruidRules.java:133)\n\tat org.apache.calcite.plan.volcano.VolcanoRuleCall.onMatch(VolcanoRuleCall.java:208)\n\t... 45 more\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-07-18T03:23:52Z", "url": "https://github.com/apache/druid/pull/10198", "merged": true, "mergeCommit": {"oid": "63c1746fe40fc40d60dbc77f411e58949c102bfa"}, "closed": true, "closedAt": "2020-07-27T17:54:45Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1_js6gH2gAyNDUxNjYzNjc4OmE0YjMyM2VjZWIwOTM5ZTViYjYwNmZiYzAwNzcxYWFkMzM3OTQxOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4JT-IAFqTQ1NTEzOTIyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a4b323eceb0939e5bb606fbc00771aad3379419a", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/a4b323eceb0939e5bb606fbc00771aad3379419a", "committedDate": "2020-07-18T03:07:05Z", "message": "Fix timeseries query constructor when postAggregator has an expression reading timestamp result column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3712395410d5c83966b7d5badf8cd85d894d2472", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/3712395410d5c83966b7d5badf8cd85d894d2472", "committedDate": "2020-07-18T20:15:43Z", "message": "fix npe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzczMzc2", "url": "https://github.com/apache/druid/pull/10198#pullrequestreview-451773376", "createdAt": "2020-07-20T16:34:26Z", "commit": {"oid": "3712395410d5c83966b7d5badf8cd85d894d2472"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4481f3eb40e040df7d6d6dfa7bff1cae8baaba3", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/d4481f3eb40e040df7d6d6dfa7bff1cae8baaba3", "committedDate": "2020-07-20T21:54:27Z", "message": "Fix postAgg referencing timestampResultField and add a test for it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb816ad85ec64987acfa5d7b65eff17ce609402", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/ccb816ad85ec64987acfa5d7b65eff17ce609402", "committedDate": "2020-07-21T04:01:05Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "912b8798b7f18482f001072749465ab67bee5979", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/912b8798b7f18482f001072749465ab67bee5979", "committedDate": "2020-07-21T05:06:57Z", "message": "doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODE1NjAw", "url": "https://github.com/apache/druid/pull/10198#pullrequestreview-452815600", "createdAt": "2020-07-21T20:45:36Z", "commit": {"oid": "912b8798b7f18482f001072749465ab67bee5979"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDo0NTozNlrOG1JHMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDo0NTozNlrOG1JHMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzAwOA==", "bodyText": "Hmm, I'm not sure that this additional content about timestampResultField is adding anything to the docs, really\u2026\nI'm in favor of removing it for now, for the following reasons:\n\nThis doesn't tell people much (it isn't clear what the parameter does, exactly).\nThe parameter is an internal thing that we don't expect people to use directly.\nMentioning it here distracts people from what they really need to know in this doc section, namely: learning what Druid SQL uses Timeseries queries for.\n\nIt could make sense to include some content in the \"Interpreting EXPLAIN PLAN output\" section, though. But I'm not sure if it's worth it.", "url": "https://github.com/apache/druid/pull/10198#discussion_r458377008", "createdAt": "2020-07-21T20:45:36Z", "author": {"login": "gianm"}, "path": "docs/querying/sql.md", "diffHunk": "@@ -629,7 +629,9 @@ Druid SQL uses four different native query types.\n period)`, have no other grouping expressions, no HAVING or LIMIT clauses, no nesting, and either no ORDER BY, or an\n ORDER BY that orders by same expression as present in GROUP BY. It also uses Timeseries for \"grand total\" queries that\n have aggregation functions but no GROUP BY. This query type takes advantage of the fact that Druid segments are sorted\n-by time.\n+by time. The SQL planner can inject `timestampResultField` in the query context when there is a grouping key. This", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "912b8798b7f18482f001072749465ab67bee5979"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81aae3f7fd708bb97d812471bacd72f645e2f45", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/c81aae3f7fd708bb97d812471bacd72f645e2f45", "committedDate": "2020-07-24T18:12:13Z", "message": "revert doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTM5MjIz", "url": "https://github.com/apache/druid/pull/10198#pullrequestreview-455139223", "createdAt": "2020-07-24T19:36:48Z", "commit": {"oid": "c81aae3f7fd708bb97d812471bacd72f645e2f45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1869, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}