{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzE5MzQ0", "number": 9279, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo0MTo1NVrODbb8Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo0MzoyM1rODc0Hqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk1OTE0OnYy", "diffSide": "RIGHT", "path": "benchmarks/src/main/java/org/apache/druid/benchmark/query/SqlVsNativeBenchmark.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo0MTo1NVrOFi7GLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzo0Mjo0M1rOFjRidw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NDE0Mw==", "bodyText": "This one is final but the one in SqlBenchmark isn't, any reason?\n(Fwiw I usually like labeling things final whenever possible but I don't insist on it, except for class fields)", "url": "https://github.com/apache/druid/pull/9279#discussion_r372164143", "createdAt": "2020-01-29T02:41:55Z", "author": {"login": "gianm"}, "path": "benchmarks/src/main/java/org/apache/druid/benchmark/query/SqlVsNativeBenchmark.java", "diffHunk": "@@ -116,12 +115,10 @@ public void setup()\n     final PlannerConfig plannerConfig = new PlannerConfig();\n \n     this.walker = closer.register(new SpecificSegmentsQuerySegmentWalker(conglomerate).add(dataSegment, index));\n-    final DruidSchema druidSchema = CalciteTests.createMockSchema(conglomerate, walker, plannerConfig);\n-    final SystemSchema systemSchema = CalciteTests.createMockSystemSchema(druidSchema, walker, plannerConfig);\n-\n+    final SchemaPlus rootSchema =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwODQ4Ng==", "bodyText": "I don't usually mark variables in a function as final, but I was trying to follow the pattern I saw in the class. That's why it's inconsistent :\\ I'll clean it up", "url": "https://github.com/apache/druid/pull/9279#discussion_r372208486", "createdAt": "2020-01-29T06:29:23Z", "author": {"login": "suneet-s"}, "path": "benchmarks/src/main/java/org/apache/druid/benchmark/query/SqlVsNativeBenchmark.java", "diffHunk": "@@ -116,12 +115,10 @@ public void setup()\n     final PlannerConfig plannerConfig = new PlannerConfig();\n \n     this.walker = closer.register(new SpecificSegmentsQuerySegmentWalker(conglomerate).add(dataSegment, index));\n-    final DruidSchema druidSchema = CalciteTests.createMockSchema(conglomerate, walker, plannerConfig);\n-    final SystemSchema systemSchema = CalciteTests.createMockSystemSchema(druidSchema, walker, plannerConfig);\n-\n+    final SchemaPlus rootSchema =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NDE0Mw=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMTgzMQ==", "bodyText": "In that case, keeping to the style of the surrounding code is probably best. I withdraw my request for consistency across files. (Unless we can reach consensus on whether vars should be marked final whenever possible.)", "url": "https://github.com/apache/druid/pull/9279#discussion_r372531831", "createdAt": "2020-01-29T17:42:43Z", "author": {"login": "gianm"}, "path": "benchmarks/src/main/java/org/apache/druid/benchmark/query/SqlVsNativeBenchmark.java", "diffHunk": "@@ -116,12 +115,10 @@ public void setup()\n     final PlannerConfig plannerConfig = new PlannerConfig();\n \n     this.walker = closer.register(new SpecificSegmentsQuerySegmentWalker(conglomerate).add(dataSegment, index));\n-    final DruidSchema druidSchema = CalciteTests.createMockSchema(conglomerate, walker, plannerConfig);\n-    final SystemSchema systemSchema = CalciteTests.createMockSystemSchema(druidSchema, walker, plannerConfig);\n-\n+    final SchemaPlus rootSchema =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NDE0Mw=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk2NTgxOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/AggregationModule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo0NzowNFrOFi7KHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjozMDowNVrOFi9z9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NTE0OA==", "bodyText": "Even though this is in the SQL module, I think it'd still be better to call it SqlAggregationModule. There's another AggregatorsModule and it would be confusing to see them side by side in an IDE or code search.", "url": "https://github.com/apache/druid/pull/9279#discussion_r372165148", "createdAt": "2020-01-29T02:47:04Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/AggregationModule.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.aggregation;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.Multibinder;\n+\n+/**\n+ * Module that provides SQL aggregations.\n+ * To add an aggregation use {@link org.apache.druid.sql.guice.SqlBindings#addAggregator(Binder, Class)}\n+ */\n+public class AggregationModule implements Module", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwODYyOA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/druid/pull/9279#discussion_r372208628", "createdAt": "2020-01-29T06:30:05Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/AggregationModule.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.aggregation;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.Multibinder;\n+\n+/**\n+ * Module that provides SQL aggregations.\n+ * To add an aggregation use {@link org.apache.druid.sql.guice.SqlBindings#addAggregator(Binder, Class)}\n+ */\n+public class AggregationModule implements Module", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NTE0OA=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk2Njk3OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/planner/DruidSqlCalcitePlannerModule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo0ODowMlrOFi7K1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjozMDoxN1rOFi90LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NTMzMw==", "bodyText": "IMO CalcitePlannerModule is fine / better. We don't use Calcite for anything other than Druid SQL so it's not ambiguous.", "url": "https://github.com/apache/druid/pull/9279#discussion_r372165333", "createdAt": "2020-01-29T02:48:02Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/planner/DruidSqlCalcitePlannerModule.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.planner;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Scopes;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.JsonConfigProvider;\n+\n+/**\n+ * The module responsible for provide bindings for the Calcite Planner.\n+ */\n+public class DruidSqlCalcitePlannerModule implements Module", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwODY4NQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/druid/pull/9279#discussion_r372208685", "createdAt": "2020-01-29T06:30:17Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/planner/DruidSqlCalcitePlannerModule.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.planner;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Scopes;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.JsonConfigProvider;\n+\n+/**\n+ * The module responsible for provide bindings for the Calcite Planner.\n+ */\n+public class DruidSqlCalcitePlannerModule implements Module", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NTMzMw=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk3MDQ0OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/avatica/AvaticaModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1MDozNVrOFi7M7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1MDozNVrOFi7M7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NTg3MQ==", "bodyText": "I'll only mention this once to avoid clutter in the review, but IMO Javadoc lines are nicer looking when they are punctuated like sentences (end in periods). Even if they're not really sentences.", "url": "https://github.com/apache/druid/pull/9279#discussion_r372165871", "createdAt": "2020-01-29T02:50:35Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/avatica/AvaticaModule.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.avatica;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import org.apache.druid.guice.JsonConfigProvider;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.server.initialization.jetty.JettyBindings;\n+import org.apache.druid.server.metrics.MetricsModule;\n+\n+/**\n+ * The module responsible for providing bindings to Avatica", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk3NDIzOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlModule.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1MzozMFrOFi7PQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDowMzo1MVrOFlENBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NjQ2NQ==", "bodyText": "I'm wondering why you wanted to split these up? It seemed nice to me to have all the core SQL-related bindings in one file.", "url": "https://github.com/apache/druid/pull/9279#discussion_r372166465", "createdAt": "2020-01-29T02:53:30Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlModule.java", "diffHunk": "@@ -63,25 +55,21 @@ public void configure(Binder binder)\n     if (isEnabled()) {\n       Calcites.setSystemProperties();\n \n-      JsonConfigProvider.bind(binder, \"druid.sql.planner\", PlannerConfig.class);\n-      JsonConfigProvider.bind(binder, \"druid.sql.avatica\", AvaticaServerConfig.class);\n-      LifecycleModule.register(binder, DruidSchema.class);\n       binder.bind(ViewManager.class).to(NoopViewManager.class).in(LazySingleton.class);\n \n-      // Add empty SqlAggregator binder.\n-      Multibinder.newSetBinder(binder, SqlAggregator.class);\n+      binder.install(new DruidCalciteSchemaModule());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzNTgxNg==", "bodyText": "I usually like smaller modules because it's easier to rationalize what needs to be installed in that module. Every package has a module that describes how implementations in it's package are provided to the rest of the code. The other advantage of this is you can keep all the implementations package private and only expose interfaces to other packages - which means there's less accidental coupling between packages.\nThis also makes testing each module easier (I realize I haven't written tests for them yet, but they're coming)", "url": "https://github.com/apache/druid/pull/9279#discussion_r372535816", "createdAt": "2020-01-29T17:50:17Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlModule.java", "diffHunk": "@@ -63,25 +55,21 @@ public void configure(Binder binder)\n     if (isEnabled()) {\n       Calcites.setSystemProperties();\n \n-      JsonConfigProvider.bind(binder, \"druid.sql.planner\", PlannerConfig.class);\n-      JsonConfigProvider.bind(binder, \"druid.sql.avatica\", AvaticaServerConfig.class);\n-      LifecycleModule.register(binder, DruidSchema.class);\n       binder.bind(ViewManager.class).to(NoopViewManager.class).in(LazySingleton.class);\n \n-      // Add empty SqlAggregator binder.\n-      Multibinder.newSetBinder(binder, SqlAggregator.class);\n+      binder.install(new DruidCalciteSchemaModule());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NjQ2NQ=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzcyMw==", "bodyText": "The only reason I asked was because I was concerned that having things be too split up would make it hard for people to guess what functionality should be in which file (at least with something named SqlModule it's clear that all the SQL stuff goes in there).\nThe easier testability is nice though, so you convinced me it's worth it. Let's just make sure it's as clear as possible from the namings what stuff goes in what module (or at least from the javadocs).", "url": "https://github.com/apache/druid/pull/9279#discussion_r374407723", "createdAt": "2020-02-03T23:54:05Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlModule.java", "diffHunk": "@@ -63,25 +55,21 @@ public void configure(Binder binder)\n     if (isEnabled()) {\n       Calcites.setSystemProperties();\n \n-      JsonConfigProvider.bind(binder, \"druid.sql.planner\", PlannerConfig.class);\n-      JsonConfigProvider.bind(binder, \"druid.sql.avatica\", AvaticaServerConfig.class);\n-      LifecycleModule.register(binder, DruidSchema.class);\n       binder.bind(ViewManager.class).to(NoopViewManager.class).in(LazySingleton.class);\n \n-      // Add empty SqlAggregator binder.\n-      Multibinder.newSetBinder(binder, SqlAggregator.class);\n+      binder.install(new DruidCalciteSchemaModule());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NjQ2NQ=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMDUwMA==", "bodyText": "A pattern I've used in the past is 1 module per sub package. The source directory structure should already be broken up so that related classes are under the same package.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374410500", "createdAt": "2020-02-04T00:03:51Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlModule.java", "diffHunk": "@@ -63,25 +55,21 @@ public void configure(Binder binder)\n     if (isEnabled()) {\n       Calcites.setSystemProperties();\n \n-      JsonConfigProvider.bind(binder, \"druid.sql.planner\", PlannerConfig.class);\n-      JsonConfigProvider.bind(binder, \"druid.sql.avatica\", AvaticaServerConfig.class);\n-      LifecycleModule.register(binder, DruidSchema.class);\n       binder.bind(ViewManager.class).to(NoopViewManager.class).in(LazySingleton.class);\n \n-      // Add empty SqlAggregator binder.\n-      Multibinder.newSetBinder(binder, SqlAggregator.class);\n+      binder.install(new DruidCalciteSchemaModule());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NjQ2NQ=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk3NTYyOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlBindings.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1NDo0NVrOFi7QFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1NDo0NVrOFi7QFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NjY3OA==", "bodyText": "Maybe do addSchema to be consistent with the others.\nI recognize this isn't consistent with how DruidBindings works, but you can't win 'em all. (Well, I guess you could win them all, if you changed DruidBindings too.)", "url": "https://github.com/apache/druid/pull/9279#discussion_r372166678", "createdAt": "2020-01-29T02:54:45Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/guice/SqlBindings.java", "diffHunk": "@@ -41,4 +45,12 @@ public static void addOperatorConversion(\n   {\n     Multibinder.newSetBinder(binder, SqlOperatorConversion.class).addBinding().to(clazz);\n   }\n+\n+  /**\n+   * Returns a multiBinder that can modules can use to bind {@link DruidCalciteSchema} to be used by the SqlModule\n+   */\n+  public static Multibinder<DruidCalciteSchema> calciteSchemaBinder(final Binder binder)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDk4MTA0OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchema.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMjo1OToxM1rOFi7Tbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzo0NToyMFrOFjRn_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NzUzNA==", "bodyText": "Do you think it makes sense to make this a SchemaProvider and have it return a Schema instead of being one? It always seems weird to me to extend other libraries' interfaces and add methods to them.", "url": "https://github.com/apache/druid/pull/9279#discussion_r372167534", "createdAt": "2020-01-29T02:59:13Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchema.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * A calcite schema that has a name which it should be registered to.\n+ */\n+public interface DruidCalciteSchema extends Schema", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMzI0Nw==", "bodyText": "Yeah I was being lazy and extended a libraries' interface. I've changed it to use composition instead since I need the name and the Schema .", "url": "https://github.com/apache/druid/pull/9279#discussion_r372533247", "createdAt": "2020-01-29T17:45:20Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchema.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * A calcite schema that has a name which it should be registered to.\n+ */\n+public interface DruidCalciteSchema extends Schema", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2NzUzNA=="}, "originalCommit": {"oid": "1b8c613934ec3fe8aad88a13809dc0ec383d8c4d"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTEyNTAzOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/SqlAggregationModule.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo1MDowN1rOFlBLLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzo0MDo1N1rOFldQmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MDg3OA==", "bodyText": "This is (AFAIK) only used by DruidOperatorTable, which is provided by CalcitePlannerModule. I don't think anyone would ever want just one or the other. Would it make sense to combine them?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374360878", "createdAt": "2020-02-03T21:50:07Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/SqlAggregationModule.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.aggregation;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.Multibinder;\n+\n+/**\n+ * Module that provides SQL aggregations.\n+ * To add an aggregation use {@link org.apache.druid.sql.guice.SqlBindings#addAggregator(Binder, Class)}\n+ */\n+public class SqlAggregationModule implements Module\n+{\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    // Add empty SqlAggregator binder.\n+    Multibinder.newSetBinder(binder, SqlAggregator.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxOTQ1Mg==", "bodyText": "I'd like to leave it in this package because of it's proximity to the SqlAggregator interface.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374419452", "createdAt": "2020-02-04T00:36:05Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/SqlAggregationModule.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.aggregation;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.Multibinder;\n+\n+/**\n+ * Module that provides SQL aggregations.\n+ * To add an aggregation use {@link org.apache.druid.sql.guice.SqlBindings#addAggregator(Binder, Class)}\n+ */\n+public class SqlAggregationModule implements Module\n+{\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    // Add empty SqlAggregator binder.\n+    Multibinder.newSetBinder(binder, SqlAggregator.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MDg3OA=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMTAxNw==", "bodyText": "Hmm, it's not what I would have done but I don't think it's a big deal either way. Please proceed with keeping it this way then.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374821017", "createdAt": "2020-02-04T17:40:57Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/aggregation/SqlAggregationModule.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.aggregation;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.multibindings.Multibinder;\n+\n+/**\n+ * Module that provides SQL aggregations.\n+ * To add an aggregation use {@link org.apache.druid.sql.guice.SqlBindings#addAggregator(Binder, Class)}\n+ */\n+public class SqlAggregationModule implements Module\n+{\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    // Add empty SqlAggregator binder.\n+    Multibinder.newSetBinder(binder, SqlAggregator.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MDg3OA=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTEyOTI0OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo1MToyN1rOFlBNlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDozNzozN1rOFlExng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MTQ5NA==", "bodyText": "But which bindings?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374361494", "createdAt": "2020-02-03T21:51:27Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxOTg3MA==", "bodyText": "updated", "url": "https://github.com/apache/druid/pull/9279#discussion_r374419870", "createdAt": "2020-02-04T00:37:37Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MTQ5NA=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM0Mzk4OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzoxMzoyM1rOFlDQYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTozMjo1MVrOFlFnDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM5NDk3OA==", "bodyText": "Extract to a constant?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374394978", "createdAt": "2020-02-03T23:13:23Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings\n+ */\n+public class DruidCalciteSchemaModule implements Module\n+{\n+  private static final String DRUID_SCHEMA_NAME = \"druid\";\n+  static final String INCOMPLETE_SCHEMA = \"INCOMPLETE_SCHEMA\";\n+\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    binder.bind(String.class).annotatedWith(DruidSchemaName.class).toInstance(DRUID_SCHEMA_NAME);\n+\n+    // Should only be used by the information schema\n+    binder.bind(SchemaPlus.class)\n+          .annotatedWith(Names.named(INCOMPLETE_SCHEMA))\n+          .toProvider(RootSchemaProvider.class)\n+          .in(Scopes.SINGLETON);\n+\n+    // DruidSchema needs to listen to changes for incoming segments\n+    LifecycleModule.register(binder, DruidSchema.class);\n+    binder.bind(SystemSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(InformationSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(LookupSchema.class).in(Scopes.SINGLETON);\n+\n+    // Binder to inject different schema to Calcite\n+    SqlBindings.addSchema(binder, DruidSqlSchema.class);\n+    SqlBindings.addSchema(binder, SystemSqlSchema.class);\n+    SqlBindings.addSchema(binder, LookupSqlSchema.class);\n+  }\n+\n+  @Provides\n+  @Singleton\n+  private SchemaPlus getRootSchema(@Named(INCOMPLETE_SCHEMA) SchemaPlus rootSchema, InformationSchema informationSchema)\n+  {\n+    String name = \"INFORMATION_SCHEMA\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQzMzU1MA==", "bodyText": "Done", "url": "https://github.com/apache/druid/pull/9279#discussion_r374433550", "createdAt": "2020-02-04T01:32:51Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings\n+ */\n+public class DruidCalciteSchemaModule implements Module\n+{\n+  private static final String DRUID_SCHEMA_NAME = \"druid\";\n+  static final String INCOMPLETE_SCHEMA = \"INCOMPLETE_SCHEMA\";\n+\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    binder.bind(String.class).annotatedWith(DruidSchemaName.class).toInstance(DRUID_SCHEMA_NAME);\n+\n+    // Should only be used by the information schema\n+    binder.bind(SchemaPlus.class)\n+          .annotatedWith(Names.named(INCOMPLETE_SCHEMA))\n+          .toProvider(RootSchemaProvider.class)\n+          .in(Scopes.SINGLETON);\n+\n+    // DruidSchema needs to listen to changes for incoming segments\n+    LifecycleModule.register(binder, DruidSchema.class);\n+    binder.bind(SystemSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(InformationSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(LookupSchema.class).in(Scopes.SINGLETON);\n+\n+    // Binder to inject different schema to Calcite\n+    SqlBindings.addSchema(binder, DruidSqlSchema.class);\n+    SqlBindings.addSchema(binder, SystemSqlSchema.class);\n+    SqlBindings.addSchema(binder, LookupSqlSchema.class);\n+  }\n+\n+  @Provides\n+  @Singleton\n+  private SchemaPlus getRootSchema(@Named(INCOMPLETE_SCHEMA) SchemaPlus rootSchema, InformationSchema informationSchema)\n+  {\n+    String name = \"INFORMATION_SCHEMA\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM5NDk3OA=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM3NzY4OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzoyODo0MFrOFlDkhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTozMzo0OVrOFlFn-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMDEzMg==", "bodyText": "This is a bit gross. The binding setup and method signatures suggest that the complete root schema is built using an incomplete root schema as input. But this method actually modifies the incomplete schema and they end up being the exact same object. And in fact, that grossness is required for the InformationSchema to work properly, because it needs to be able to see itself in the root schema!\nMaybe we could give the InformationSchema a root schema provider instead of the actual root schema? Would that work? It'd be cleaner, if so.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374400132", "createdAt": "2020-02-03T23:28:40Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings\n+ */\n+public class DruidCalciteSchemaModule implements Module\n+{\n+  private static final String DRUID_SCHEMA_NAME = \"druid\";\n+  static final String INCOMPLETE_SCHEMA = \"INCOMPLETE_SCHEMA\";\n+\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    binder.bind(String.class).annotatedWith(DruidSchemaName.class).toInstance(DRUID_SCHEMA_NAME);\n+\n+    // Should only be used by the information schema\n+    binder.bind(SchemaPlus.class)\n+          .annotatedWith(Names.named(INCOMPLETE_SCHEMA))\n+          .toProvider(RootSchemaProvider.class)\n+          .in(Scopes.SINGLETON);\n+\n+    // DruidSchema needs to listen to changes for incoming segments\n+    LifecycleModule.register(binder, DruidSchema.class);\n+    binder.bind(SystemSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(InformationSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(LookupSchema.class).in(Scopes.SINGLETON);\n+\n+    // Binder to inject different schema to Calcite\n+    SqlBindings.addSchema(binder, DruidSqlSchema.class);\n+    SqlBindings.addSchema(binder, SystemSqlSchema.class);\n+    SqlBindings.addSchema(binder, LookupSqlSchema.class);\n+  }\n+\n+  @Provides\n+  @Singleton\n+  private SchemaPlus getRootSchema(@Named(INCOMPLETE_SCHEMA) SchemaPlus rootSchema, InformationSchema informationSchema)\n+  {\n+    String name = \"INFORMATION_SCHEMA\";\n+    rootSchema.add(name, informationSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQzMzc4Ng==", "bodyText": "Agreed this is gross :( I tried for a while to get this set up correctly. Here's where I landed\nUnfortunately I'd still need to inject 2 SchemaPluses - a Provider to an \"incomplete\" one that is needed by InformationSchema, and a complete one that's used by the PlannerFactory. It's unclear to me if any other classes would ever need to use the \"complete\" schema. So even though this is gross, I think this will prevent someone from accidentally injecting the wrong schema in another class.\nThe grossness is also contained in this one method. I'll add more comments explaining this. Maybe someone else can make this better in a future patch. \ud83e\udd1e", "url": "https://github.com/apache/druid/pull/9279#discussion_r374433786", "createdAt": "2020-02-04T01:33:49Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidCalciteSchemaModule.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Named;\n+import com.google.inject.name.Names;\n+import org.apache.calcite.schema.SchemaPlus;\n+import org.apache.druid.guice.LifecycleModule;\n+import org.apache.druid.sql.guice.SqlBindings;\n+\n+/**\n+ * The module responsible for providing bindings\n+ */\n+public class DruidCalciteSchemaModule implements Module\n+{\n+  private static final String DRUID_SCHEMA_NAME = \"druid\";\n+  static final String INCOMPLETE_SCHEMA = \"INCOMPLETE_SCHEMA\";\n+\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    binder.bind(String.class).annotatedWith(DruidSchemaName.class).toInstance(DRUID_SCHEMA_NAME);\n+\n+    // Should only be used by the information schema\n+    binder.bind(SchemaPlus.class)\n+          .annotatedWith(Names.named(INCOMPLETE_SCHEMA))\n+          .toProvider(RootSchemaProvider.class)\n+          .in(Scopes.SINGLETON);\n+\n+    // DruidSchema needs to listen to changes for incoming segments\n+    LifecycleModule.register(binder, DruidSchema.class);\n+    binder.bind(SystemSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(InformationSchema.class).in(Scopes.SINGLETON);\n+    binder.bind(LookupSchema.class).in(Scopes.SINGLETON);\n+\n+    // Binder to inject different schema to Calcite\n+    SqlBindings.addSchema(binder, DruidSqlSchema.class);\n+    SqlBindings.addSchema(binder, SystemSqlSchema.class);\n+    SqlBindings.addSchema(binder, LookupSqlSchema.class);\n+  }\n+\n+  @Provides\n+  @Singleton\n+  private SchemaPlus getRootSchema(@Named(INCOMPLETE_SCHEMA) SchemaPlus rootSchema, InformationSchema informationSchema)\n+  {\n+    String name = \"INFORMATION_SCHEMA\";\n+    rootSchema.add(name, informationSchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMDEzMg=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM4MjY0OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSchemaName.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozMDo1N1rOFlDnbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozMDo1N1rOFlDnbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMDg3Nw==", "bodyText": "\"schema\" (spelling). And \"Druid\" should be capitalized.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374400877", "createdAt": "2020-02-03T23:30:57Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSchemaName.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.BindingAnnotation;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * An annotation to get the name of the schenma to access druid tables in SQL.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM4NDc4OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozMTo1NlrOFlDooA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozMTo1NlrOFlDooA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTE4NA==", "bodyText": "\"Druid\", \"SQL\" (capitalization)", "url": "https://github.com/apache/druid/pull/9279#discussion_r374401184", "createdAt": "2020-02-03T23:31:56Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM4ODA0OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozMzozOVrOFlDqlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODozOToxMlrOFlfEpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTY4Nw==", "bodyText": "We now have classes DruidSchema, DruidSqlSchema, and DruidCalciteSchema. Their relationships aren't very clear from the names. How about naming them DruidSchema, DruidSchemaProvider, and SchemaProvider respectively?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374401687", "createdAt": "2020-02-03T23:33:39Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.\n+ */\n+class DruidSqlSchema implements DruidCalciteSchema", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0MDc1MQ==", "bodyText": "I don't like Provider because that's a guice thing and I'd expect it to have a method that returns an object, but this interface returns 2 things and it doesn't implement Provider\nHow about\n\n<Druid>Schema which provides the implementation that Calcite needs to get tables\nCalciteSubSchema which is an interface containing a name and a Schema so that it can be registered to a Root Schema(SchemaPlus)\n<System>SubSchema the implementation of the CalciteSubSchema interface for appropriate <System>Schema", "url": "https://github.com/apache/druid/pull/9279#discussion_r374440751", "createdAt": "2020-02-04T02:05:03Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.\n+ */\n+class DruidSqlSchema implements DruidCalciteSchema", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTY4Nw=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNTU3Mg==", "bodyText": "So there'd be both a SystemSchema and SystemSubSchema (and the SystemSubSchema would be how you get a SystemSchema)?\nWho would have thought this would be the hard part.\nHow about DruidSchema, NamedDruidSchema, and NamedSchema?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374815572", "createdAt": "2020-02-04T17:30:00Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.\n+ */\n+class DruidSqlSchema implements DruidCalciteSchema", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTY4Nw=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNjIxMA==", "bodyText": "lol - alright I like that suggestion. Thanks!", "url": "https://github.com/apache/druid/pull/9279#discussion_r374816210", "createdAt": "2020-02-04T17:31:13Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.\n+ */\n+class DruidSqlSchema implements DruidCalciteSchema", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTY4Nw=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MDcyNQ==", "bodyText": ":|", "url": "https://github.com/apache/druid/pull/9279#discussion_r374850725", "createdAt": "2020-02-04T18:39:12Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/DruidSqlSchema.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.schema.Schema;\n+\n+/**\n+ * The schema for druid tables to be accessible via sql.\n+ */\n+class DruidSqlSchema implements DruidCalciteSchema", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMTY4Nw=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTM5NjQzOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/RootSchemaProvider.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzozODoyMFrOFlDwHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTowMzo1NFrOFlFL8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMzEwMQ==", "bodyText": "Would be nice to have something here to check for duplicate schema names. I don't think the base Calcite class does.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374403101", "createdAt": "2020-02-03T23:38:20Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/RootSchemaProvider.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.Provider;\n+import org.apache.calcite.jdbc.CalciteSchema;\n+import org.apache.calcite.schema.SchemaPlus;\n+\n+import java.util.Set;\n+\n+/**\n+ * Provides the RootSchema for calcite with\n+ * - metadata schema disabled because it's not needed\n+ * - caching disabled because druid's caching is better.\n+ *\n+ * All the provided schema are added to the rootSchema.\n+ */\n+public class RootSchemaProvider implements Provider<SchemaPlus>\n+{\n+  private final Set<DruidCalciteSchema> calciteSchemas;\n+\n+  @Inject\n+  RootSchemaProvider(Set<DruidCalciteSchema> calciteSchemas)\n+  {\n+    this.calciteSchemas = calciteSchemas;\n+  }\n+\n+  @Override\n+  public SchemaPlus get()\n+  {\n+    SchemaPlus rootSchema = CalciteSchema.createRootSchema(false, false).plus();\n+    calciteSchemas.forEach(schema -> rootSchema.add(schema.getSchemaName(), schema.getSchema()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyNjYxMA==", "bodyText": "Done.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374426610", "createdAt": "2020-02-04T01:03:54Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/RootSchemaProvider.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.schema;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.Provider;\n+import org.apache.calcite.jdbc.CalciteSchema;\n+import org.apache.calcite.schema.SchemaPlus;\n+\n+import java.util.Set;\n+\n+/**\n+ * Provides the RootSchema for calcite with\n+ * - metadata schema disabled because it's not needed\n+ * - caching disabled because druid's caching is better.\n+ *\n+ * All the provided schema are added to the rootSchema.\n+ */\n+public class RootSchemaProvider implements Provider<SchemaPlus>\n+{\n+  private final Set<DruidCalciteSchema> calciteSchemas;\n+\n+  @Inject\n+  RootSchemaProvider(Set<DruidCalciteSchema> calciteSchemas)\n+  {\n+    this.calciteSchemas = calciteSchemas;\n+  }\n+\n+  @Override\n+  public SchemaPlus get()\n+  {\n+    SchemaPlus rootSchema = CalciteSchema.createRootSchema(false, false).plus();\n+    calciteSchemas.forEach(schema -> rootSchema.add(schema.getSchemaName(), schema.getSchema()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwMzEwMQ=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQwNjUxOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/org/apache/druid/sql/calcite/view/DruidViewMacroFactory.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo0MzoyM1rOFlD2Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzozODowNFrOFldLNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNDY1OQ==", "bodyText": "Is it really worth all this indirection and complexity to avoid having stuff refer to the static string \"druid\"?", "url": "https://github.com/apache/druid/pull/9279#discussion_r374404659", "createdAt": "2020-02-03T23:43:23Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/view/DruidViewMacroFactory.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.view;\n+\n+import org.apache.druid.server.security.Escalator;\n+import org.apache.druid.sql.calcite.planner.PlannerFactory;\n+\n+/**\n+ * A factory to create a {@link DruidViewMacro} that is used by Guice for Assisted injection.\n+ */\n+public interface DruidViewMacroFactory\n+{\n+  /**\n+   * Creates an instance of {@link DruidViewMacro}\n+   */\n+  DruidViewMacro create(PlannerFactory plannerFactory, Escalator escalator, String viewSql);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyNDUyNw==", "bodyText": "If I was doing this again, I probably wouldn't have done it this way just to get rid of a static constant being used across a few packages in the sql sub-module.\nI got carried away with all the guice magic. But it's a bit of a pain to revert this change now.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374424527", "createdAt": "2020-02-04T00:55:09Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/view/DruidViewMacroFactory.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.view;\n+\n+import org.apache.druid.server.security.Escalator;\n+import org.apache.druid.sql.calcite.planner.PlannerFactory;\n+\n+/**\n+ * A factory to create a {@link DruidViewMacro} that is used by Guice for Assisted injection.\n+ */\n+public interface DruidViewMacroFactory\n+{\n+  /**\n+   * Creates an instance of {@link DruidViewMacro}\n+   */\n+  DruidViewMacro create(PlannerFactory plannerFactory, Escalator escalator, String viewSql);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNDY1OQ=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxOTYzNg==", "bodyText": "Well, okay, I'm fine with keeping it this way. It seems a little convoluted but at least I learned something about Guice while reviewing it. Maybe consider adding some comments about what the purpose of all the indirection is, so future code-archaeologists can understand the intent behind it.", "url": "https://github.com/apache/druid/pull/9279#discussion_r374819636", "createdAt": "2020-02-04T17:38:04Z", "author": {"login": "gianm"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/view/DruidViewMacroFactory.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.calcite.view;\n+\n+import org.apache.druid.server.security.Escalator;\n+import org.apache.druid.sql.calcite.planner.PlannerFactory;\n+\n+/**\n+ * A factory to create a {@link DruidViewMacro} that is used by Guice for Assisted injection.\n+ */\n+public interface DruidViewMacroFactory\n+{\n+  /**\n+   * Creates an instance of {@link DruidViewMacro}\n+   */\n+  DruidViewMacro create(PlannerFactory plannerFactory, Escalator escalator, String viewSql);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNDY1OQ=="}, "originalCommit": {"oid": "c80e41b77227c9e69f1ef8c568e76ced57a150c5"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2837, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}