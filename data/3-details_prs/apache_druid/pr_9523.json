{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTc2MzM5", "number": 9523, "title": "Ability to Delete task logs and segments from Azure Storage", "bodyText": "Description\n\n\nimplement ability to delete all tasks logs or all task logs\nwritten before a particular date when written to Azure storage\n\n\nimplement ability to delete all segments from Azure deep storage\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-17T01:46:50Z", "url": "https://github.com/apache/druid/pull/9523", "merged": true, "mergeCommit": {"oid": "b18dd2b7a935b7802a32ca099b5bd771126788fb"}, "closed": true, "closedAt": "2020-03-19T00:59:18Z", "author": {"login": "zachjsh"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOYqGuAH2gAyMzg5NTc2MzM5Ojc1MmE4MTlkM2IxNzg4MzE2NWY4OTNjMDlkN2Y5N2VhYjZkMDkwYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPBLTkAFqTM3NzM0NDkwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/752a819d3b17883165f893c09d7f97eab6d090b7", "committedDate": "2020-03-17T01:44:44Z", "message": "Ability to Delete task logs and segments from Azure Storage\n\n* implement ability to delete all tasks logs or all task logs\n  written before a particular date when written to Azure storage\n\n* implement ability to delete all segments from Azure deep storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjU3Nzc3", "url": "https://github.com/apache/druid/pull/9523#pullrequestreview-376657777", "createdAt": "2020-03-18T08:42:27Z", "commit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0MjoyN1rOF36-oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0NjoxNFrOF37GvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MjMwNA==", "bodyText": "nit: formatting\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                         segmentConfig.getContainer(), segmentConfig.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                    segmentConfig.getContainer(),\n          \n          \n            \n                    segmentConfig.getPrefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182304", "createdAt": "2020-03-18T08:42:27Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mjg1MQ==", "bodyText": "Heh, should probably be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting segment files from Azure. Error: %s\", e.getMessage());", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182851", "createdAt": "2020-03-18T08:43:25Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          segmentConfig.getContainer(),\n+          segmentConfig.getPrefix(),\n+          Predicates.alwaysTrue()\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MzMwNw==", "bodyText": "same wrong cloud\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting task log files from Azure. Error: %s\", e.getMessage());", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183307", "createdAt": "2020-03-18T08:44:11Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          config.getContainer(),\n+          config.getPrefix(),\n+          (object) -> object.getLastModifed().getTime() < timestamp\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mzc1NA==", "bodyText": "same comment about 1 line per arg formatting if spans multiple lines\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix()\n          \n          \n            \n                );", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183754", "createdAt": "2020-03-18T08:45:05Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NDM4MA==", "bodyText": "same formatting nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix(), new Date(timestamp)\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix(),\n          \n          \n            \n                    new Date(timestamp)\n          \n          \n            \n                );\n          \n      \n    \n    \n  \n\nsorry there isn't a style rule for this, last we checked it wasn't possible to do, but it's been a while so it might be worth checking on again...", "url": "https://github.com/apache/druid/pull/9523#discussion_r394184380", "createdAt": "2020-03-18T08:46:14Z", "author": {"login": "clintropolis"}, "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752a819d3b17883165f893c09d7f97eab6d090b7"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92ec5a90038efed64a47a4228d81f80e5b775ebb", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/92ec5a90038efed64a47a4228d81f80e5b775ebb", "committedDate": "2020-03-18T22:40:14Z", "message": "* Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzQ0OTAx", "url": "https://github.com/apache/druid/pull/9523#pullrequestreview-377344901", "createdAt": "2020-03-19T00:57:12Z", "commit": {"oid": "92ec5a90038efed64a47a4228d81f80e5b775ebb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2659, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}