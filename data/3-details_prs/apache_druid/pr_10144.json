{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDQ2OTc2", "number": 10144, "title": "Follow-up for RetryQueryRunner fix", "bodyText": "Description\nAddresses the last comment of #10082 except integration tests. Will add them in a separate PR. This PR also modifies how to check the shouldFailOnTruncatedResponseContext flag; now query servers and the broker use different config initialized by guice. I think this way is more stable and less error-prone than using query context.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-07-06T23:13:04Z", "url": "https://github.com/apache/druid/pull/10144", "merged": true, "mergeCommit": {"oid": "53a25505719f05b7041c35b2cb783dcb1466c7cd"}, "closed": true, "closedAt": "2020-07-08T20:28:12Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyZiEWAH2gAyNDQ1MDQ2OTc2Ojk2NDgzM2U0YWQ2MTg2OGM0MjUzMzU2ZDEzY2E4MjlmNzRlNjJlY2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy_8MqAFqTQ0NTA4MTczNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "964833e4ad61868c4253356d13ca829f74e62ecc", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/964833e4ad61868c4253356d13ca829f74e62ecc", "committedDate": "2020-07-06T23:07:08Z", "message": "address comments; use guice instead of query context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2c929cc884191b49ee751a63de6f5ec7dd4d8b4", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/c2c929cc884191b49ee751a63de6f5ec7dd4d8b4", "committedDate": "2020-07-07T05:24:16Z", "message": "typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebedc17e4f4b272dc0df958c4a3580adab47089", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/2ebedc17e4f4b272dc0df958c4a3580adab47089", "committedDate": "2020-07-07T19:20:45Z", "message": "QueryResource tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjcyOTMw", "url": "https://github.com/apache/druid/pull/10144#pullrequestreview-444272930", "createdAt": "2020-07-07T21:46:12Z", "commit": {"oid": "2ebedc17e4f4b272dc0df958c4a3580adab47089"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTo0NjoxMlrOGuQwmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowOTowM1rOGuRWlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2MjI2NQ==", "bodyText": "Suggested rewording:\n\nAn intermediate response context for the query exceeded the built-in limit of 7KB.The response context is an internal data structure that Druid servers use to share out-of-band information when sending query results to each other. It is serialized in an HTTP header with a maximum length of 7KB. This error occurs when an intermediate response context sent from a data server (like a Historical) to the Broker exceeds this limit.The response context is used for a variety of purposes, but the one most likely to generate a large context is sharing details about segments that move during a query. That means this error can potentially indicate that a very large number of segments moved in between the time a Broker issued a query and the time it was processed on Historicals. This should rarely, if ever, occur during normal operation.", "url": "https://github.com/apache/druid/pull/10144#discussion_r451162265", "createdAt": "2020-07-07T21:46:12Z", "author": {"login": "gianm"}, "path": "docs/querying/querying.md", "diffHunk": "@@ -139,4 +139,5 @@ Possible codes for the *error* field include:\n |`Resource limit exceeded`|The query exceeded a configured resource limit (e.g. groupBy maxResults).|\n |`Unauthorized request.`|The query was denied due to security policy. Either the user was not recognized, or the user was recognized but does not have access to the requested resource.|\n |`Unsupported operation`|The query attempted to perform an unsupported operation. This may occur when using undocumented features or when using an incompletely implemented extension.|\n+|`Truncated response context`|The response context is an internal data structure to store intermediate state during query processing. Some of states are collected from query servers (such as historicals or realtime tasks) and merged in the Broker. To send those states to the Broker, the query servers serialize them in the HTTP header and send it together with the stream of intermediate query result. As the max size of an HTTP header is limited to 7 KB in Druid, this error can occur if JSON-serialized response context is larger than the limit.<br/><br/>This error shouldn't happen in most cases. A possible cause of this error can be too many segments moving (for segment balancing) at the time when a query is issued which reads lots of segments. You should be able to see debug logs about missing segments in the historical logs if you are facing this case.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebedc17e4f4b272dc0df958c4a3580adab47089"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTk4OA==", "bodyText": "It looks like this should work, but why not create a reasonable ResponseContextConfig and bind it directly to ResponseContextConfig.class? Seems like that would be simpler.", "url": "https://github.com/apache/druid/pull/10144#discussion_r451171988", "createdAt": "2020-07-07T22:09:03Z", "author": {"login": "gianm"}, "path": "services/src/main/java/org/apache/druid/cli/CliBroker.java", "diffHunk": "@@ -102,6 +103,12 @@ public CliBroker()\n           binder.bindConstant().annotatedWith(Names.named(\"tlsServicePort\")).to(8282);\n           binder.bindConstant().annotatedWith(PruneLoadSpec.class).to(true);\n           binder.bindConstant().annotatedWith(PruneLastCompactionState.class).to(true);\n+          binder.bindConstant()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebedc17e4f4b272dc0df958c4a3580adab47089"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "278917c85cdcbd61a7aede7cdb66336a6d0044bf", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/278917c85cdcbd61a7aede7cdb66336a6d0044bf", "committedDate": "2020-07-08T03:08:22Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDYxMTQ1", "url": "https://github.com/apache/druid/pull/10144#pullrequestreview-444461145", "createdAt": "2020-07-08T06:58:53Z", "commit": {"oid": "278917c85cdcbd61a7aede7cdb66336a6d0044bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNjo1ODo1M1rOGuamzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNjo1ODo1M1rOGuamzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyMzU5Ng==", "bodyText": "should this be any QueryException?", "url": "https://github.com/apache/druid/pull/10144#discussion_r451323596", "createdAt": "2020-07-08T06:58:53Z", "author": {"login": "clintropolis"}, "path": "server/src/main/java/org/apache/druid/server/QueryResource.java", "diffHunk": "@@ -309,6 +309,11 @@ public void write(OutputStream outputStream) throws WebApplicationException\n             .header(HEADER_RESPONSE_CONTEXT, serializationResult.getResult())\n             .build();\n       }\n+      catch (QueryInterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "278917c85cdcbd61a7aede7cdb66336a6d0044bf"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba858a92047e72a09531dac3694ecc7cf7f9ed4", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/fba858a92047e72a09531dac3694ecc7cf7f9ed4", "committedDate": "2020-07-08T17:22:48Z", "message": "catch queryException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDQwOTc2", "url": "https://github.com/apache/druid/pull/10144#pullrequestreview-445040976", "createdAt": "2020-07-08T18:50:22Z", "commit": {"oid": "fba858a92047e72a09531dac3694ecc7cf7f9ed4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4725cd535ccb95216c0c67d67d2c659dacabf2f4", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4725cd535ccb95216c0c67d67d2c659dacabf2f4", "committedDate": "2020-07-08T18:58:29Z", "message": "fix spell check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDgxNzM1", "url": "https://github.com/apache/druid/pull/10144#pullrequestreview-445081735", "createdAt": "2020-07-08T19:52:04Z", "commit": {"oid": "4725cd535ccb95216c0c67d67d2c659dacabf2f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1807, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}