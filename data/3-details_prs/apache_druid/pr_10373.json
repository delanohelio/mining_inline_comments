{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDc1ODQ5", "number": 10373, "title": "Adding more dimensions to the audit log entry", "bodyText": "Fixes #10372.\nAdding more dimensions to the service metric for audit log\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-09T19:20:17Z", "url": "https://github.com/apache/druid/pull/10373", "merged": true, "mergeCommit": {"oid": "14072d3ab058298033c8928a92799d23ee4b8839"}, "closed": true, "closedAt": "2020-09-18T01:36:29Z", "author": {"login": "mghosh4"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHRJQUAH2gAyNDgzMDc1ODQ5OjVjNWMwOGI4ZmQwZTRmNTYxYWUxODgwYWM0ZTU2YzBhMjdjYjFkYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ7a7fAFqTQ5MTA5MzE0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c5c08b8fd0e4f561ae1880ac4e56c0a27cb1dae", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/5c5c08b8fd0e4f561ae1880ac4e56c0a27cb1dae", "committedDate": "2020-09-09T19:13:12Z", "message": "Adding more dimensions to the audit log entry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDgzMzU5", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-485483359", "createdAt": "2020-09-10T00:14:23Z", "commit": {"oid": "5c5c08b8fd0e4f561ae1880ac4e56c0a27cb1dae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMDoxNDoyM1rOHPebfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMDoxNDoyM1rOHPebfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4OTI0Nw==", "bodyText": "Hmm, do we need to emit comment and payload as metrics? They seem to need to be retrieved via API instead.", "url": "https://github.com/apache/druid/pull/10373#discussion_r485989247", "createdAt": "2020-09-10T00:14:23Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/audit/SQLAuditManager.java", "diffHunk": "@@ -98,6 +98,10 @@ public void doAudit(AuditEntry auditEntry, Handle handle) throws IOException\n             .setDimension(\"key\", auditEntry.getKey())\n             .setDimension(\"type\", auditEntry.getType())\n             .setDimension(\"author\", auditEntry.getAuditInfo().getAuthor())\n+            .setDimension(\"comment\", auditEntry.getAuditInfo().getComment())\n+            .setDimension(\"remote_address\", auditEntry.getAuditInfo().getIp())\n+            .setDimension(\"created_date\", auditEntry.getAuditTime().toString())\n+            .setDimension(\"payload\", auditEntry.getPayload())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5c08b8fd0e4f561ae1880ac4e56c0a27cb1dae"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/7707622bc9b9878acb0c9339248c31fde15f6e86", "committedDate": "2020-09-16T18:05:33Z", "message": "Making adding payload in audit metric optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjczNjAw", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-490273600", "createdAt": "2020-09-17T06:19:33Z", "commit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNjoxOTozM1rOHTTAOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNjoxOTozM1rOHTTAOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk5NjM0NQ==", "bodyText": "nit: how about includePayloadAsDimensionInMetric?", "url": "https://github.com/apache/druid/pull/10373#discussion_r489996345", "createdAt": "2020-09-17T06:19:33Z", "author": {"login": "jihoonson"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -330,6 +330,15 @@ Switching Request Logger routes native query's request logs to one request logge\n |`druid.request.logging.nativeQueryLogger`|request logger for emitting native query's request logs.|none|\n |`druid.request.logging.sqlQueryLogger`|request logger for emitting SQL query's request logs.|none|\n \n+### Audit Logging\n+\n+Coordinator and Overlord log changes to lookups, segment load/drop rules, dynamic configuration changes for auditing\n+\n+|Property|Description|Default|\n+|--------|-----------|-------|\n+|`druid.audit.manager.auditHistoryMillis`|Default duration for querying audit history.|1 week|\n+|`druid.audit.manager.addPayloadToAuditMetricDimension`|Boolean flag on whether to add `payload` column in service metric.|false|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjkyOTk0", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-490692994", "createdAt": "2020-09-17T14:59:24Z", "commit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1OToyNFrOHTm4fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1OToyNFrOHTm4fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyMjA0Ng==", "bodyText": "Can you add a unit test that validates this behavior please", "url": "https://github.com/apache/druid/pull/10373#discussion_r490322046", "createdAt": "2020-09-17T14:59:24Z", "author": {"login": "suneet-s"}, "path": "server/src/main/java/org/apache/druid/server/audit/SQLAuditManager.java", "diffHunk": "@@ -93,13 +93,19 @@ public Void withHandle(Handle handle) throws Exception\n   @Override\n   public void doAudit(AuditEntry auditEntry, Handle handle) throws IOException\n   {\n-    emitter.emit(\n-        new ServiceMetricEvent.Builder()\n-            .setDimension(\"key\", auditEntry.getKey())\n-            .setDimension(\"type\", auditEntry.getType())\n-            .setDimension(\"author\", auditEntry.getAuditInfo().getAuthor())\n-            .build(\"config/audit\", 1)\n-    );\n+    ServiceMetricEvent.Builder builder = new ServiceMetricEvent.Builder()\n+                                                .setDimension(\"key\", auditEntry.getKey())\n+                                                .setDimension(\"type\", auditEntry.getType())\n+                                                .setDimension(\"author\", auditEntry.getAuditInfo().getAuthor())\n+                                                .setDimension(\"comment\", auditEntry.getAuditInfo().getComment())\n+                                                .setDimension(\"remote_address\", auditEntry.getAuditInfo().getIp())\n+                                                .setDimension(\"created_date\", auditEntry.getAuditTime().toString());\n+\n+    if (config.getAddPayloadToAuditMetricDimension()) {\n+      builder.setDimension(\"payload\", auditEntry.getPayload());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjk0MjUz", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-490694253", "createdAt": "2020-09-17T15:00:35Z", "commit": {"oid": "7707622bc9b9878acb0c9339248c31fde15f6e86"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f23228d03478e337b8750ea6e1ccdc1633bcd110", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/f23228d03478e337b8750ea6e1ccdc1633bcd110", "committedDate": "2020-09-17T20:15:38Z", "message": "Changing the name of the parameter to includePayloadAsDimensionInMetric. Adding a unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTU4NTIw", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-490958520", "createdAt": "2020-09-17T20:20:52Z", "commit": {"oid": "f23228d03478e337b8750ea6e1ccdc1633bcd110"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be45d41f8fd256a181c46ff357cd35013380a040", "author": {"user": {"login": "mghosh4", "name": "Mainak Ghosh"}}, "url": "https://github.com/apache/druid/commit/be45d41f8fd256a181c46ff357cd35013380a040", "committedDate": "2020-09-17T21:59:07Z", "message": "Fixing the intellij code introspection issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDkzMTQ5", "url": "https://github.com/apache/druid/pull/10373#pullrequestreview-491093149", "createdAt": "2020-09-18T01:36:22Z", "commit": {"oid": "be45d41f8fd256a181c46ff357cd35013380a040"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3602, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}