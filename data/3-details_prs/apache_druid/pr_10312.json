{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMjY0Mzkw", "number": 10312, "title": "Optimize large InDimFilters", "bodyText": "Description\nFor large InDimFilters, in default mode, the filter does a linear check of the\nset to see if it contains either an empty or null. If it does, the empties are\nconverted to nulls by passing through the entire list again.\nInstead of this, in default mode, we attempt to remove an empty string from the\nvalues that are passed to the InDimFilter. If an empty string was removed, we\nadd null to the set\n\nThis flame graph shows that ~18% of query time was just spent checking if a null or empty string exists in the list of values to the InDimFilter. This happened on a join query where a filter was pushed down to the base table. The limit for filter push down was increased to a very large number so that a very large InDimFilter could be generated.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-08-24T05:16:16Z", "url": "https://github.com/apache/druid/pull/10312", "merged": true, "mergeCommit": {"oid": "707b5aae2b2c92479876212331eedb60b8e453cd"}, "closed": true, "closedAt": "2020-08-24T23:39:28Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB7avbAH2gAyNDcyMjY0MzkwOmExNGYzODA3ZDM0ZWRkMGEwZTIyYzNlMDFiNGZjNjkxNjRkNjM0ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCK22rgFqTQ3Mzk4MzY2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a14f3807d34edd0a0e22c3e01b4fc69164d634e7", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/a14f3807d34edd0a0e22c3e01b4fc69164d634e7", "committedDate": "2020-08-24T05:04:46Z", "message": "Optimize large InDimFilters\n\nFor large InDimFilters, in default mode, the filter does a linear check of the\nset to see if it contains either an empty or null. If it does, the empties are\nconverted to nulls by passing through the entire list again.\n\nInstead of this, in default mode, we attempt to remove an empty string from the\nvalues that are passed to the InDimFilter. If an empty string was removed, we\nadd null to the set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTMxODMz", "url": "https://github.com/apache/druid/pull/10312#pullrequestreview-473131833", "createdAt": "2020-08-24T05:38:19Z", "commit": {"oid": "a14f3807d34edd0a0e22c3e01b4fc69164d634e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTozODoxOVrOHFVP3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTozODoxOVrOHFVP3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1MzA1Mw==", "bodyText": "Nice finding, but this can lead to incorrect result in default mode since null will be always added no matter whether an empty string is in values or not.", "url": "https://github.com/apache/druid/pull/10312#discussion_r475353053", "createdAt": "2020-08-24T05:38:19Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/query/filter/InDimFilter.java", "diffHunk": "@@ -143,10 +142,11 @@ private InDimFilter(\n \n     // The values set can be huge. Try to avoid copying the set if possible.\n     // Note that we may still need to copy values to a list for caching. See getCacheKey().\n-    if ((NullHandling.sqlCompatible() || values.stream().noneMatch(NullHandling::needsEmptyToNull))) {\n+    if (NullHandling.sqlCompatible() || !values.remove(\"\")) {\n       this.values = values;\n     } else {\n-      this.values = values.stream().map(NullHandling::emptyToNullIfNeeded).collect(Collectors.toSet());\n+      values.add(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a14f3807d34edd0a0e22c3e01b4fc69164d634e7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61fe33ebf762764bb89108ddd966937f3313be71", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/61fe33ebf762764bb89108ddd966937f3313be71", "committedDate": "2020-08-24T17:33:59Z", "message": "code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37f79ea984185e572bdbf5e2b7f8e17a9475023", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/e37f79ea984185e572bdbf5e2b7f8e17a9475023", "committedDate": "2020-08-24T18:53:08Z", "message": "Revert \"code review\"\n\nThis reverts commit 61fe33ebf762764bb89108ddd966937f3313be71."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997c038bacb8c4fcdc95cce0b1c5e49e2377005d", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/997c038bacb8c4fcdc95cce0b1c5e49e2377005d", "committedDate": "2020-08-24T18:58:13Z", "message": "code review - less brittle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODc2MzIy", "url": "https://github.com/apache/druid/pull/10312#pullrequestreview-473876322", "createdAt": "2020-08-24T21:40:33Z", "commit": {"oid": "997c038bacb8c4fcdc95cce0b1c5e49e2377005d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczOTgzNjY4", "url": "https://github.com/apache/druid/pull/10312#pullrequestreview-473983668", "createdAt": "2020-08-24T23:04:03Z", "commit": {"oid": "997c038bacb8c4fcdc95cce0b1c5e49e2377005d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3462, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}