{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NjMyMzQ2", "number": 9265, "title": "Improve code quality and unit test coverage of the Azure extension", "bodyText": "Description\n\nUpdate unit tests to increase test coverage for the extension\nClean up any messy code\nEnfore code coverage as part of tests.\n\n\n\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-01-27T18:14:07Z", "url": "https://github.com/apache/druid/pull/9265", "merged": true, "mergeCommit": {"oid": "a085685182d62e5dd1b716f1bbb9bcbbaeb1c661"}, "closed": true, "closedAt": "2020-02-03T17:40:01Z", "author": {"login": "zachjsh"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-TtdYgH2gAyMzY3NjMyMzQ2OjA5MTM3Njg4NTY4N2Y4NzRmNjA2NzY3Mjg5NzliZTcwYzBlNTI0ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_zDLJgH2gAyMzY3NjMyMzQ2OmIzOGY5MGY3NmE4M2EwZTdmMThhMTFhOTgzZGE5MmFlZWVkOGI0YmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "091376885687f874f60676728979be70c0e524df", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/091376885687f874f60676728979be70c0e524df", "committedDate": "2020-01-27T02:56:05Z", "message": "IMPLY-1946: Improve code quality and unit test coverage of the Azure extension\n\n* Update unit tests to increase test coverage for the extension\n* Clean up any messy code\n* Enfore code coverage as part of tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9e4c3b216e37a0292a278072283abdb425030f", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/5b9e4c3b216e37a0292a278072283abdb425030f", "committedDate": "2020-01-27T19:50:09Z", "message": "Merge remote-tracking branch 'origin/master' into IMPLY-1946"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c845f68a0b4fa5b0e90f527b13bf6525660ed353", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/c845f68a0b4fa5b0e90f527b13bf6525660ed353", "committedDate": "2020-01-27T21:10:56Z", "message": "* Update azure extension pom to remove unnecessary things\n* update jacoco thresholds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85aa0a004dd6d544de111c980f1f3507cd7ac429", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/85aa0a004dd6d544de111c980f1f3507cd7ac429", "committedDate": "2020-01-27T22:33:24Z", "message": "* updgrade version of azure-storage library version uses to\n  most upto-date version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85293294d93e4bd7f08efa207e873c49de97d135", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/85293294d93e4bd7f08efa207e873c49de97d135", "committedDate": "2020-01-28T00:08:57Z", "message": "Merge remote-tracking branch 'origin/master' into IMPLY-1946"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5103fb69db63e058b68edfc52dddc33509101d4", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/c5103fb69db63e058b68edfc52dddc33509101d4", "committedDate": "2020-01-28T23:36:02Z", "message": "* exclude common libraries that are included from druid core"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjY0OTI0", "url": "https://github.com/apache/druid/pull/9265#pullrequestreview-349664924", "createdAt": "2020-01-28T20:04:09Z", "commit": {"oid": "85293294d93e4bd7f08efa207e873c49de97d135"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMDowNDowOVrOFiywlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMjowNTowMlrOFj7dlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNzU0Mg==", "bodyText": "Would you change the log level to debug? it doesn't look worth to be the info level.", "url": "https://github.com/apache/druid/pull/9265#discussion_r372027542", "createdAt": "2020-01-28T20:04:09Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -179,4 +151,36 @@ public DataSegment push(final File indexFilesDir, final DataSegment segment, fin\n         uri.toString()\n     );\n   }\n+\n+  @VisibleForTesting\n+  String getAzurePath(final DataSegment segment, final boolean useUniquePath)\n+  {\n+    final String storageDir = this.getStorageDir(segment, useUniquePath);\n+\n+    return StringUtils.format(\"%s/%s\", storageDir, AzureStorageDruidModule.INDEX_ZIP_FILE_NAME);\n+\n+  }\n+\n+  @VisibleForTesting\n+  DataSegment uploadDataSegment(\n+      DataSegment segment,\n+      final int binaryVersion,\n+      final long size,\n+      final File compressedSegmentData,\n+      final String azurePath\n+  )\n+      throws StorageException, IOException, URISyntaxException\n+  {\n+    azureStorage.uploadBlob(compressedSegmentData, config.getContainer(), azurePath);\n+\n+    final DataSegment outSegment = segment\n+        .withSize(size)\n+        .withLoadSpec(this.makeLoadSpec(new URI(azurePath)))\n+        .withBinaryVersion(binaryVersion);\n+\n+    log.info(\"Deleting file [%s]\", compressedSegmentData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85293294d93e4bd7f08efa207e873c49de97d135"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNzYzNA==", "bodyText": "Haha, is this question for the reviewers? I think RuntimeException is enough for now.", "url": "https://github.com/apache/druid/pull/9265#discussion_r373217634", "createdAt": "2020-01-30T22:02:21Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -157,6 +128,7 @@ public DataSegment push(final File indexFilesDir, final DataSegment segment, fin\n       );\n     }\n     catch (Exception e) {\n+      // do we want to throw a specfic exception here? Interface only expects IOExceptions to be thrown.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5103fb69db63e058b68edfc52dddc33509101d4"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxODcwOQ==", "bodyText": "nit: this method not just returns a container, but can create it if it doesn't exist. Maybe better to rename to something more clear such as getOrCreateCloudBlobContainer().", "url": "https://github.com/apache/druid/pull/9265#discussion_r373218709", "createdAt": "2020-01-30T22:05:02Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureStorage.java", "diffHunk": "@@ -95,13 +87,34 @@ public long getBlobLength(final String containerName, final String blobPath)\n \n   public InputStream getBlobInputStream(final String containerName, final String blobPath)\n       throws URISyntaxException, StorageException\n+  {\n+    return getBlobInputStream(0L, containerName, blobPath);\n+  }\n+\n+  public InputStream getBlobInputStream(long offset, final String containerName, final String blobPath)\n+      throws URISyntaxException, StorageException\n   {\n     CloudBlobContainer container = getCloudBlobContainer(containerName);\n-    return container.getBlockBlobReference(blobPath).openInputStream();\n+    return container.getBlockBlobReference(blobPath).openInputStream(offset, null, null, null, null);\n   }\n \n   public boolean getBlobExists(String container, String blobPath) throws URISyntaxException, StorageException\n   {\n     return getCloudBlobContainer(container).getBlockBlobReference(blobPath).exists();\n   }\n+\n+  @VisibleForTesting\n+  CloudBlobClient getCloudBlobClient()\n+  {\n+    return this.cloudBlobClient;\n+  }\n+\n+  private CloudBlobContainer getCloudBlobContainer(final String containerName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5103fb69db63e058b68edfc52dddc33509101d4"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bda1b5f9363b2619006068f3b11262b967850c4a", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/bda1b5f9363b2619006068f3b11262b967850c4a", "committedDate": "2020-01-31T01:19:34Z", "message": "* address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "432136882c43bd4cb568c510d93bdbf032ca67ec", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/432136882c43bd4cb568c510d93bdbf032ca67ec", "committedDate": "2020-01-31T01:19:58Z", "message": "Merge remote-tracking branch 'apache/master' into IMPLY-1946"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjUwNTk2", "url": "https://github.com/apache/druid/pull/9265#pullrequestreview-351250596", "createdAt": "2020-01-31T01:33:22Z", "commit": {"oid": "432136882c43bd4cb568c510d93bdbf032ca67ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMTozMzoyMlrOFj_OmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMTozMzoyMlrOFj_OmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4MDQwOA==", "bodyText": "Thanks for adding it. Even though we disabled coveralls in #8382 because of its flakiness, this test seems to be working based on the CI history of this PR. I think it's better than not having it. We can apply to the entire project later someday.", "url": "https://github.com/apache/druid/pull/9265#discussion_r373280408", "createdAt": "2020-01-31T01:33:22Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/azure-extensions/pom.xml", "diffHunk": "@@ -135,4 +142,66 @@\n         </dependency>\n     </dependencies>\n \n+    <build>\n+        <plugins>\n+            <plugin>\n+                <groupId>org.jacoco</groupId>\n+                <artifactId>jacoco-maven-plugin</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "432136882c43bd4cb568c510d93bdbf032ca67ec"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b38f90f76a83a0e7f18a11a983da92aeeed8b4be", "author": {"user": {"login": "zachjsh", "name": null}}, "url": "https://github.com/apache/druid/commit/b38f90f76a83a0e7f18a11a983da92aeeed8b4be", "committedDate": "2020-01-31T18:00:47Z", "message": "Merge remote-tracking branch 'apache/master' into IMPLY-1946"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3812, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}