{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjM4ODUz", "number": 9165, "title": "Forbid easily misused HashSet and HashMap constructors", "bodyText": "Fixes #8423\n\n\nDescription\n\n\n\nThis PR adds constructors for HashMap, HashSet, and LinkedHashSet that specify an initial size parameter to the forbiddenapi list. It replaces all usage of these constructors with Guava helper methods that take the users parameter for size and create a more optimally sized object for them compared to what they get from the native constructors.\nHashMap, HashSet and LinkedHashSet objects are often created in an inefficient way when the creator specifies a size. Guava has created utilities to take the size desired by the creator and come up with a proper initial size for the underlying object for them. It is explained more clearly here. The same is also true for LinkedHashMap, but unfortunately we are still using Guava 16, and the Guava implementation for LinkedHashMaps did not come about until Guava 19.\nI had to add an ignores item in the pom.xml file for SomeAvroDatum.class because it is generated at build time so it can't have a suppression annotation inline. If there is a better way to exclude that I'm not thinking of, please let me know.\n\n\n\n\n\nThis PR has:\n\n been self-reviewed\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\nMany classes were modified, but the changes are all transparent. Just changing the way Map and Set objects are created in some specific cases.", "createdAt": "2020-01-10T21:59:01Z", "url": "https://github.com/apache/druid/pull/9165", "merged": true, "mergeCommit": {"oid": "53bb45fc9ac1b26c36c0ad172355cbdcddc061f3"}, "closed": true, "closedAt": "2020-02-07T07:44:10Z", "author": {"login": "capistrant"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5FqjYgH2gAyMzYxNjM4ODUzOjMzMTYwYWE2ZmQzZWJlZjU4ZWNlNzQ3NTkwY2UxODkyNjBjYTdiMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB6a2vAFqTM1NDk3NTUwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "33160aa6fd3ebef58ece747590ce189260ca7b1c", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/33160aa6fd3ebef58ece747590ce189260ca7b1c", "committedDate": "2020-01-10T21:44:37Z", "message": "Forbid easily misused HashSet and HashMap constructors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzM0NDcz", "url": "https://github.com/apache/druid/pull/9165#pullrequestreview-343734473", "createdAt": "2020-01-16T08:16:51Z", "commit": {"oid": "33160aa6fd3ebef58ece747590ce189260ca7b1c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODoxNjo1MVrOFeRD8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODoxNjo1MVrOFeRD8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI4MTEzOQ==", "bodyText": "LinkedHashMap should be prohibited, too, even though there is no method ready in Guava. A polyfill method could be added to CollectionUtils.", "url": "https://github.com/apache/druid/pull/9165#discussion_r367281139", "createdAt": "2020-01-16T08:16:51Z", "author": {"login": "leventov"}, "path": "codestyle/druid-forbidden-apis.txt", "diffHunk": "@@ -31,6 +31,12 @@ java.lang.String#replace(java.lang.CharSequence,java.lang.CharSequence) @ Use on\n java.lang.String#replaceAll(java.lang.String,java.lang.String) @ Use one of the appropriate methods in StringUtils instead, or compile and cache a Pattern explicitly\n java.lang.String#replaceFirst(java.lang.String,java.lang.String) @ Use String.indexOf() and substring methods, or compile and cache a Pattern explicitly\n java.nio.file.Files#createTempDirectory(java.lang.String prefix,java.nio.file.FileAttribute...) @ Use org.apache.druid.java.util.common.FileUtils.createTempDir()\n+java.util.HashMap#<init>(int) @ Use com.google.common.collect.Maps#newHashMapWithExpectedSize(int) instead\n+java.util.HashMap#<init>(int, float) @ Use com.google.common.collect.Maps#newHashMapWithExpectedSize(int) instead\n+java.util.HashSet#<init>(int) @ Use com.google.collect.Sets#newHashSetWithExpectedSize(int) instead\n+java.util.HashSet#<init>(int, float) @ Use com.google.collect.Sets#newHashSetWithExpectedSize(int) instead\n+java.util.LinkedHashSet#<init>(int) @ Use com.google.collect.Sets#newLinkedHashSatWithExpectedSize(int) instead\n+java.util.LinkedHashSet#<init>(int, float) @ Use com.google.collect.Sets#newLinkedHashSatWithExpectedSize(int) instead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33160aa6fd3ebef58ece747590ce189260ca7b1c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b10662517f7087e8677cf15ec30805acc8a3905", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/5b10662517f7087e8677cf15ec30805acc8a3905", "committedDate": "2020-01-17T21:43:58Z", "message": "Add two LinkedHashMap constructors to forbidden-apis and create utility method as replacement for them"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTMxNTMw", "url": "https://github.com/apache/druid/pull/9165#pullrequestreview-344931530", "createdAt": "2020-01-18T07:59:44Z", "commit": {"oid": "5b10662517f7087e8677cf15ec30805acc8a3905"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNzo1OTo0NFrOFfJ-Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNzo1OTo0NFrOFfJ-Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxMzU5MQ==", "bodyText": "Nit: should better be private.", "url": "https://github.com/apache/druid/pull/9165#discussion_r368213591", "createdAt": "2020-01-18T07:59:44Z", "author": {"login": "leventov"}, "path": "core/src/main/java/org/apache/druid/utils/CollectionUtils.java", "diffHunk": "@@ -39,6 +41,8 @@\n \n public final class CollectionUtils\n {\n+  public static final int MAX_EXPECTED_SIZE = (1 << 30);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b10662517f7087e8677cf15ec30805acc8a3905"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de5575928cf2353d8d7684e2fa3541bde936f923", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/de5575928cf2353d8d7684e2fa3541bde936f923", "committedDate": "2020-01-18T13:37:46Z", "message": "Fix visibility of constant in CollectionUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f445cdc76b76248dc722dcc74c89887bbcbacc", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/17f445cdc76b76248dc722dcc74c89887bbcbacc", "committedDate": "2020-01-29T19:37:25Z", "message": "Merge remote-tracking branch 'origin/master' into issue-8423"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b54ce15d16d605eacbf50334ec7503d733683f19", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/b54ce15d16d605eacbf50334ec7503d733683f19", "committedDate": "2020-02-06T14:57:42Z", "message": "Merge remote-tracking branch 'origin/master' into issue-8423"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0fde11d6d7840c43202940500e1f1e575d84584", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/b0fde11d6d7840c43202940500e1f1e575d84584", "committedDate": "2020-02-06T16:20:14Z", "message": "Make an exception for an instance of LinkedHashMap#<init>(int) because proper sizing is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42f7b2c0c8df85eb737d766efeef88af6cf2d985", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/42f7b2c0c8df85eb737d766efeef88af6cf2d985", "committedDate": "2020-02-06T16:23:16Z", "message": "revert changes to sql module tests that should be in separate PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c5178dc1913436fe14f8e7e8ba7df7782adffa3", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/2c5178dc1913436fe14f8e7e8ba7df7782adffa3", "committedDate": "2020-02-06T21:15:54Z", "message": "Finish reverting changes to sql module tests that were flagged in checkstyle during CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f", "committedDate": "2020-02-06T22:58:31Z", "message": "Add netty dependency resulting from SupressForbidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTc1NTA3", "url": "https://github.com/apache/druid/pull/9165#pullrequestreview-354975507", "createdAt": "2020-02-07T07:43:50Z", "commit": {"oid": "3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNzo0Mzo1MFrOFm0idQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNzo0Mzo1MFrOFm0idQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI1MDk5Nw==", "bodyText": "I've created https://issues.apache.org/jira/browse/AVRO-2731 and #9331 to track this. FYI @Fokko.\n@capistrant please try to create such issues yourself to close the loops and offload info from the heads of people.", "url": "https://github.com/apache/druid/pull/9165#discussion_r376250997", "createdAt": "2020-02-07T07:43:50Z", "author": {"login": "leventov"}, "path": "pom.xml", "diffHunk": "@@ -1341,6 +1341,9 @@\n                         <signaturesFile>${project.parent.basedir}/codestyle/joda-time-forbidden-apis.txt</signaturesFile>\n                         <signaturesFile>${project.parent.basedir}/codestyle/druid-forbidden-apis.txt</signaturesFile>\n                     </signaturesFiles>\n+                    <excludes>\n+                      <exclude>**/SomeAvroDatum.class</exclude>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3707, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}