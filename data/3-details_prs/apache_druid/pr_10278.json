{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3Njc4ODk1", "number": 10278, "title": "Don't log the entire task spec", "bodyText": "Description\nHttpIndexingServiceClient prints the entire task spec when it fails to issue a task, which could be huge especially in parallel task when lots of segments are shuffled. This could end up causing OOM error in the supervisor task. This PR fixes it by logging only task ID. I also cleaned up some wrong logging in ParallelIndexSupervisorTask.\nThis PR also changes the ID pattern of compaction/kill tasks when they are submitted by the coordinator. After this PR, the ID of compaction and kill tasks will be prefixed by coordinator-issued if they are submitted by coordinator. api-issued prefix will be used when a kill task is issued by calling DataSourcesResource.killUnusedSegmentsInInterval().\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-08-13T23:19:14Z", "url": "https://github.com/apache/druid/pull/10278", "merged": true, "mergeCommit": {"oid": "9a81740281d8ee8eafafbf71ccfdb90cb87e34d6"}, "closed": true, "closedAt": "2020-08-18T18:03:14Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-oYeDgH2gAyNDY3Njc4ODk1OjQ1MjVkMTg1NDBjZjFiYjZjNzM0MjllODhmYzkzNGI3MDdjNTQwNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAK7zAAFqTQ2OTY5ODg0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4525d18540cf1bb6c73429e88fc934b707c5404c", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/4525d18540cf1bb6c73429e88fc934b707c5404c", "committedDate": "2020-08-13T23:12:19Z", "message": "Don't log the entire task spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/3ba91c3dac5521606ae282f7e678c0f61739eade", "committedDate": "2020-08-14T00:32:12Z", "message": "fix lgtm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Mjc4MDM5", "url": "https://github.com/apache/druid/pull/10278#pullrequestreview-467278039", "createdAt": "2020-08-14T03:03:22Z", "commit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMzowMzoyMlrOHAl8Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMzowNDowNFrOHAl87g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MzcwMg==", "bodyText": "Do we pull the ID from the taskQuery anywhere except here? If not, maybe we could just pass in the ID here without adding an ID field to the task query.", "url": "https://github.com/apache/druid/pull/10278#discussion_r470383702", "createdAt": "2020-08-14T03:03:22Z", "author": {"login": "jon-wei"}, "path": "server/src/main/java/org/apache/druid/client/indexing/HttpIndexingServiceClient.java", "diffHunk": "@@ -67,7 +67,8 @@ public HttpIndexingServiceClient(\n   @Override\n   public void killUnusedSegments(String dataSource, Interval interval)\n   {\n-    runTask(new ClientKillUnusedSegmentsTaskQuery(dataSource, interval));\n+    final ClientTaskQuery taskQuery = new ClientKillUnusedSegmentsTaskQuery(null, dataSource, interval);\n+    runTask(taskQuery.getId(), taskQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4Mzg1NA==", "bodyText": "What's the reasoning for removing the more complex logging here? Is it concern from the segment set being too large?", "url": "https://github.com/apache/druid/pull/10278#discussion_r470383854", "createdAt": "2020-08-14T03:04:04Z", "author": {"login": "jon-wei"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/batch/parallel/ParallelIndexSupervisorTask.java", "diffHunk": "@@ -788,18 +785,7 @@ private static void publishSegments(TaskToolbox toolbox, Map<String, PushedSegme\n     if (published) {\n       LOG.info(\"Published [%d] segments\", newSegments.size());\n     } else {\n-      LOG.info(\"Transaction failure while publishing segments, checking if someone else beat us to it.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc9440d22812129202acb7d0a5adb5d7856f75c8", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/fc9440d22812129202acb7d0a5adb5d7856f75c8", "committedDate": "2020-08-14T05:18:33Z", "message": "fix serde"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "839bb47235684564225fdb80576b98dae3bb2f5d", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/839bb47235684564225fdb80576b98dae3bb2f5d", "committedDate": "2020-08-14T21:35:30Z", "message": "address comments and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b18934638d32d3b61d52e87b51021e5a08e73061", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b18934638d32d3b61d52e87b51021e5a08e73061", "committedDate": "2020-08-15T04:11:58Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDAzNTkz", "url": "https://github.com/apache/druid/pull/10278#pullrequestreview-468003593", "createdAt": "2020-08-15T16:27:22Z", "commit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxNjoyNzoyMlrOHBMQBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxNzoxMjoyMlrOHBMfzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTAxMTMzMg==", "bodyText": "nit: ID_JOINER field can be removed from the class.", "url": "https://github.com/apache/druid/pull/10278#discussion_r471011332", "createdAt": "2020-08-15T16:27:22Z", "author": {"login": "abhishekagarwal87"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/AbstractTask.java", "diffHunk": "@@ -175,23 +162,6 @@ public String toString()\n            '}';\n   }\n \n-  /**\n-   * Start helper methods\n-   *\n-   * @param objects objects to join\n-   *\n-   * @return string of joined objects\n-   */\n-  static String joinId(List<Object> objects)\n-  {\n-    return ID_JOINER.join(objects);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ba91c3dac5521606ae282f7e678c0f61739eade"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTAxNTM3Mw==", "bodyText": "naive question: can the IndexingServiceClient used outside druid code? If not, a default method may not be required. If yes, passing null instead of an empty string will be closer to past behavior.", "url": "https://github.com/apache/druid/pull/10278#discussion_r471015373", "createdAt": "2020-08-15T17:12:22Z", "author": {"login": "abhishekagarwal87"}, "path": "server/src/main/java/org/apache/druid/client/indexing/IndexingServiceClient.java", "diffHunk": "@@ -31,11 +31,27 @@\n \n public interface IndexingServiceClient\n {\n-  void killUnusedSegments(String dataSource, Interval interval);\n+  default void killUnusedSegments(String dataSource, Interval interval)\n+  {\n+    killUnusedSegments(\"\", dataSource, interval);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b18934638d32d3b61d52e87b51021e5a08e73061"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODk0NTEw", "url": "https://github.com/apache/druid/pull/10278#pullrequestreview-468894510", "createdAt": "2020-08-17T23:23:39Z", "commit": {"oid": "839bb47235684564225fdb80576b98dae3bb2f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMzoyMzozOVrOHB-Dvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMzoyMzozOVrOHB-Dvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgyNzM5MQ==", "bodyText": "For backwards compatibility, would it be better to allow a null id as before?", "url": "https://github.com/apache/druid/pull/10278#discussion_r471827391", "createdAt": "2020-08-17T23:23:39Z", "author": {"login": "jon-wei"}, "path": "server/src/main/java/org/apache/druid/client/indexing/ClientCompactionTaskQuery.java", "diffHunk": "@@ -43,14 +42,14 @@\n \n   @JsonCreator\n   public ClientCompactionTaskQuery(\n-      @JsonProperty(\"id\") @Nullable String id,\n+      @JsonProperty(\"id\") String id,\n       @JsonProperty(\"dataSource\") String dataSource,\n       @JsonProperty(\"ioConfig\") ClientCompactionIOConfig ioConfig,\n       @JsonProperty(\"tuningConfig\") ClientCompactionTaskQueryTuningConfig tuningConfig,\n       @JsonProperty(\"context\") Map<String, Object> context\n   )\n   {\n-    this.id = id == null ? IdUtils.newTaskId(TYPE, dataSource, null) : id;\n+    this.id = Preconditions.checkNotNull(id, \"id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "839bb47235684564225fdb80576b98dae3bb2f5d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6c1ef7cf1b2d525ae953df0eee901fc9a40d134", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/a6c1ef7cf1b2d525ae953df0eee901fc9a40d134", "committedDate": "2020-08-18T01:46:51Z", "message": "remove unnecessary codes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Njk4ODQ5", "url": "https://github.com/apache/druid/pull/10278#pullrequestreview-469698849", "createdAt": "2020-08-18T18:01:36Z", "commit": {"oid": "a6c1ef7cf1b2d525ae953df0eee901fc9a40d134"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1960, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}