{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDA3NzA0", "number": 9161, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMjo0NDowM1rODXT1nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMToxNDowMVrODZUthw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzY4ODYwOnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/NumericLastBufferAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMjo0NDowM1rOFcj8jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMjo0NDowM1rOFcj8jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MzM5MA==", "bodyText": "Can you add javadocs for these buffer methods?", "url": "https://github.com/apache/druid/pull/9161#discussion_r365493390", "createdAt": "2020-01-11T02:44:03Z", "author": {"login": "jon-wei"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/NumericLastBufferAggregator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.aggregation.last;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.BufferAggregator;\n+import org.apache.druid.query.monomorphicprocessing.RuntimeShapeInspector;\n+import org.apache.druid.segment.BaseLongColumnValueSelector;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+\n+import java.nio.ByteBuffer;\n+\n+public abstract class NumericLastBufferAggregator<TSelector extends BaseNullableColumnValueSelector>\n+    implements BufferAggregator\n+{\n+  static final int NULL_OFFSET = Long.BYTES;\n+  static final int VALUE_OFFSET = NULL_OFFSET + Byte.BYTES;\n+  static byte RHS_NOT_NULL = 0x00;\n+  static byte RHS_NULL = 0x01;\n+\n+  final boolean useDefault = NullHandling.replaceWithDefault();\n+\n+  final BaseLongColumnValueSelector timeSelector;\n+  final TSelector valueSelector;\n+\n+  public NumericLastBufferAggregator(BaseLongColumnValueSelector timeSelector, TSelector valueSelector)\n+  {\n+    this.timeSelector = timeSelector;\n+    this.valueSelector = valueSelector;\n+  }\n+\n+  abstract void initValue(ByteBuffer buf, int position);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzY4OTA5OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/NumericLastBufferAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMjo0NTowNlrOFcj80g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMjo0NTowNlrOFcj80g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MzQ1OA==", "bodyText": "nit: to follow the ordering in the buffer, maybe move putValue call after the null marker setting", "url": "https://github.com/apache/druid/pull/9161#discussion_r365493458", "createdAt": "2020-01-11T02:45:06Z", "author": {"login": "jon-wei"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/NumericLastBufferAggregator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.aggregation.last;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.BufferAggregator;\n+import org.apache.druid.query.monomorphicprocessing.RuntimeShapeInspector;\n+import org.apache.druid.segment.BaseLongColumnValueSelector;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+\n+import java.nio.ByteBuffer;\n+\n+public abstract class NumericLastBufferAggregator<TSelector extends BaseNullableColumnValueSelector>\n+    implements BufferAggregator\n+{\n+  static final int NULL_OFFSET = Long.BYTES;\n+  static final int VALUE_OFFSET = NULL_OFFSET + Byte.BYTES;\n+  static byte RHS_NOT_NULL = 0x00;\n+  static byte RHS_NULL = 0x01;\n+\n+  final boolean useDefault = NullHandling.replaceWithDefault();\n+\n+  final BaseLongColumnValueSelector timeSelector;\n+  final TSelector valueSelector;\n+\n+  public NumericLastBufferAggregator(BaseLongColumnValueSelector timeSelector, TSelector valueSelector)\n+  {\n+    this.timeSelector = timeSelector;\n+    this.valueSelector = valueSelector;\n+  }\n+\n+  abstract void initValue(ByteBuffer buf, int position);\n+\n+  abstract void putValue(ByteBuffer buf, int position);\n+\n+  boolean isValueNull(ByteBuffer buf, int position)\n+  {\n+    return buf.get(position + NULL_OFFSET) == 1;\n+  }\n+\n+  void updateTimeWithValue(ByteBuffer buf, int position, long time)\n+  {\n+    buf.putLong(position, time);\n+    putValue(buf, position);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDgyMzM4OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/NumericFirstBufferAggregator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTozNDoyMlrOFfF08w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjowMDowNVrOFfGVfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NTY1MQ==", "bodyText": "== RHS_NULL?", "url": "https://github.com/apache/druid/pull/9161#discussion_r368145651", "createdAt": "2020-01-17T21:34:22Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/NumericFirstBufferAggregator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.aggregation.first;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.BufferAggregator;\n+import org.apache.druid.query.monomorphicprocessing.RuntimeShapeInspector;\n+import org.apache.druid.segment.BaseLongColumnValueSelector;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+\n+import java.nio.ByteBuffer;\n+\n+public abstract class NumericFirstBufferAggregator<TSelector extends BaseNullableColumnValueSelector>\n+    implements BufferAggregator\n+{\n+  static final int NULL_OFFSET = Long.BYTES;\n+  static final int VALUE_OFFSET = NULL_OFFSET + Byte.BYTES;\n+  static byte RHS_NOT_NULL = 0x00;\n+  static byte RHS_NULL = 0x01;\n+\n+  final boolean useDefault = NullHandling.replaceWithDefault();\n+\n+  final BaseLongColumnValueSelector timeSelector;\n+  final TSelector valueSelector;\n+\n+  public NumericFirstBufferAggregator(BaseLongColumnValueSelector timeSelector, TSelector valueSelector)\n+  {\n+    this.timeSelector = timeSelector;\n+    this.valueSelector = valueSelector;\n+  }\n+\n+  abstract void initValue(ByteBuffer buf, int position);\n+\n+  abstract void putValue(ByteBuffer buf, int position);\n+\n+  boolean isValueNull(ByteBuffer buf, int position)\n+  {\n+    return buf.get(position + NULL_OFFSET) == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1Mzk4Mg==", "bodyText": "switching these to use NullHandling.IS_NULL_BYTE and NullHandling.IS_NOT_NULL_BYTE", "url": "https://github.com/apache/druid/pull/9161#discussion_r368153982", "createdAt": "2020-01-17T22:00:05Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/NumericFirstBufferAggregator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.aggregation.first;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.BufferAggregator;\n+import org.apache.druid.query.monomorphicprocessing.RuntimeShapeInspector;\n+import org.apache.druid.segment.BaseLongColumnValueSelector;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+\n+import java.nio.ByteBuffer;\n+\n+public abstract class NumericFirstBufferAggregator<TSelector extends BaseNullableColumnValueSelector>\n+    implements BufferAggregator\n+{\n+  static final int NULL_OFFSET = Long.BYTES;\n+  static final int VALUE_OFFSET = NULL_OFFSET + Byte.BYTES;\n+  static byte RHS_NOT_NULL = 0x00;\n+  static byte RHS_NULL = 0x01;\n+\n+  final boolean useDefault = NullHandling.replaceWithDefault();\n+\n+  final BaseLongColumnValueSelector timeSelector;\n+  final TSelector valueSelector;\n+\n+  public NumericFirstBufferAggregator(BaseLongColumnValueSelector timeSelector, TSelector valueSelector)\n+  {\n+    this.timeSelector = timeSelector;\n+    this.valueSelector = valueSelector;\n+  }\n+\n+  abstract void initValue(ByteBuffer buf, int position);\n+\n+  abstract void putValue(ByteBuffer buf, int position);\n+\n+  boolean isValueNull(ByteBuffer buf, int position)\n+  {\n+    return buf.get(position + NULL_OFFSET) == 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NTY1MQ=="}, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDg1NjM0OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/DoubleLastAggregatorFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTo1MDo1MVrOFfGKDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjowMDo0NVrOFfGWZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MTA1NQ==", "bodyText": "Byte.BYTES. Or perhaps adding a new variable NULL_SIZE?", "url": "https://github.com/apache/druid/pull/9161#discussion_r368151055", "createdAt": "2020-01-17T21:50:51Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/DoubleLastAggregatorFactory.java", "diffHunk": "@@ -230,7 +248,7 @@ public String getTypeName()\n   @Override\n   public int getMaxIntermediateSize()\n   {\n-    return Long.BYTES + Double.BYTES;\n+    return Long.BYTES + Double.BYTES + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1NDIxMg==", "bodyText": "it seems unlikely to me that the number of bytes in a byte is going to change, but ok :p", "url": "https://github.com/apache/druid/pull/9161#discussion_r368154212", "createdAt": "2020-01-17T22:00:45Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/last/DoubleLastAggregatorFactory.java", "diffHunk": "@@ -230,7 +248,7 @@ public String getTypeName()\n   @Override\n   public int getMaxIntermediateSize()\n   {\n-    return Long.BYTES + Double.BYTES;\n+    return Long.BYTES + Double.BYTES + 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1MTA1NQ=="}, "originalCommit": {"oid": "1f0cd184d5ce1afae92f4a62013b061501c00699"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODY3NTkxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/druid/collections/SerializablePair.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDowMTo0MVrOFfoLhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMjo0NzoxMlrOFftJzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwODQ4Ng==", "bodyText": "looks like this is missing unit tests? Also javadocs since this is a utility that would be used by many other classes", "url": "https://github.com/apache/druid/pull/9161#discussion_r368708486", "createdAt": "2020-01-20T20:01:41Z", "author": {"login": "suneet-s"}, "path": "core/src/main/java/org/apache/druid/collections/SerializablePair.java", "diffHunk": "@@ -45,4 +46,25 @@ public T2 getRhs()\n   {\n     return rhs;\n   }\n+\n+  public static <T1, T2> Comparator<SerializablePair<T1, T2>> createNullHandlingComparator(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4OTk2NQ==", "bodyText": "This is covered by calcite query tests that order by the first/last aggregators; afaik SerializedPair is only used by first/last despite it's generic name, to store a timestamp and value.", "url": "https://github.com/apache/druid/pull/9161#discussion_r368789965", "createdAt": "2020-01-21T02:47:12Z", "author": {"login": "clintropolis"}, "path": "core/src/main/java/org/apache/druid/collections/SerializablePair.java", "diffHunk": "@@ -45,4 +46,25 @@ public T2 getRhs()\n   {\n     return rhs;\n   }\n+\n+  public static <T1, T2> Comparator<SerializablePair<T1, T2>> createNullHandlingComparator(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcwODQ4Ng=="}, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODcxMjA4OnYy", "diffSide": "RIGHT", "path": "docs/querying/aggregations.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoyMjo0MlrOFfog4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoyMjo0MlrOFfog4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMzk1Mg==", "bodyText": "Are you referring to this property - https://github.com/apache/druid/blob/master/docs/configuration/index.md#sql-compatible-null-handling ? Would be nice to link to the configuration here.\nnit: I'd re-phrase slightly\ncomputes the metric value with the minimum timestamp. If no row exists, it will return 0 or `null` if [SQL compatible mode](../configuration/index.md#sql-compatible-null-handling) is enabled", "url": "https://github.com/apache/druid/pull/9161#discussion_r368713952", "createdAt": "2020-01-20T20:22:42Z", "author": {"login": "suneet-s"}, "path": "docs/querying/aggregations.md", "diffHunk": "@@ -136,7 +136,7 @@ Note that queries with first/last aggregators on a segment created with rollup e\n \n #### `doubleFirst` aggregator\n \n-`doubleFirst` computes the metric value with the minimum timestamp or 0 if no row exist\n+`doubleFirst` computes the metric value with the minimum timestamp or 0 in default mode or `null` in SQL compatible mode if no row exist", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODczNDQ2OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregator.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDozNDowNFrOFfotuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMjo0OTowMVrOFftLMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxNzI0Mw==", "bodyText": "Nice abstraction! \ud83c\udf89\nnote to self: can the get call be abstracted into the base class?", "url": "https://github.com/apache/druid/pull/9161#discussion_r368717243", "createdAt": "2020-01-20T20:34:04Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregator.java", "diffHunk": "@@ -20,42 +20,29 @@\n package org.apache.druid.query.aggregation.first;\n \n import org.apache.druid.collections.SerializablePair;\n-import org.apache.druid.query.aggregation.Aggregator;\n import org.apache.druid.segment.BaseDoubleColumnValueSelector;\n import org.apache.druid.segment.BaseLongColumnValueSelector;\n \n-public class DoubleFirstAggregator implements Aggregator\n+public class DoubleFirstAggregator extends NumericFirstAggregator<BaseDoubleColumnValueSelector>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4OTQ3NA==", "bodyText": "Not without boxing the primitive", "url": "https://github.com/apache/druid/pull/9161#discussion_r368789474", "createdAt": "2020-01-21T02:44:32Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregator.java", "diffHunk": "@@ -20,42 +20,29 @@\n package org.apache.druid.query.aggregation.first;\n \n import org.apache.druid.collections.SerializablePair;\n-import org.apache.druid.query.aggregation.Aggregator;\n import org.apache.druid.segment.BaseDoubleColumnValueSelector;\n import org.apache.druid.segment.BaseLongColumnValueSelector;\n \n-public class DoubleFirstAggregator implements Aggregator\n+public class DoubleFirstAggregator extends NumericFirstAggregator<BaseDoubleColumnValueSelector>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxNzI0Mw=="}, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc5MDMyMA==", "bodyText": "Well, I guess that is going to happen anyway in making the pair.. so I guess maybe the on heap version of get could be shared, but not really possible for the buffer aggregator.", "url": "https://github.com/apache/druid/pull/9161#discussion_r368790320", "createdAt": "2020-01-21T02:49:01Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregator.java", "diffHunk": "@@ -20,42 +20,29 @@\n package org.apache.druid.query.aggregation.first;\n \n import org.apache.druid.collections.SerializablePair;\n-import org.apache.druid.query.aggregation.Aggregator;\n import org.apache.druid.segment.BaseDoubleColumnValueSelector;\n import org.apache.druid.segment.BaseLongColumnValueSelector;\n \n-public class DoubleFirstAggregator implements Aggregator\n+public class DoubleFirstAggregator extends NumericFirstAggregator<BaseDoubleColumnValueSelector>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxNzI0Mw=="}, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODc1OTQ0OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregatorFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDo0ODoxNVrOFfo8Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDo0ODoxNVrOFfo8Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMDk5NQ==", "bodyText": "It took me a long time to try and figure out what the comparator was used for. I got wrapped up in the fact that the aggregator was meant compare timestamps, that I didn't realize this was for ordering. I think a javadoc on  #AggregatorFactory#getComparator would have cleared up my confusion pretty quickly", "url": "https://github.com/apache/druid/pull/9161#discussion_r368720995", "createdAt": "2020-01-20T20:48:15Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregatorFactory.java", "diffHunk": "@@ -45,10 +46,34 @@\n import java.util.Map;\n import java.util.Objects;\n \n-public class DoubleFirstAggregatorFactory extends NullableNumericAggregatorFactory<ColumnValueSelector>\n+public class DoubleFirstAggregatorFactory extends AggregatorFactory\n {\n+  private static final Aggregator NIL_AGGREGATOR = new DoubleFirstAggregator(\n+      NilColumnValueSelector.instance(),\n+      NilColumnValueSelector.instance()\n+  )\n+  {\n+    @Override\n+    public void aggregate()\n+    {\n+      // no-op\n+    }\n+  };\n+\n+  private static final BufferAggregator NIL_BUFFER_AGGREGATOR = new DoubleFirstBufferAggregator(\n+      NilColumnValueSelector.instance(),\n+      NilColumnValueSelector.instance()\n+  )\n+  {\n+    @Override\n+    public void aggregate(ByteBuffer buf, int position)\n+    {\n+      // no-op\n+    }\n+  };\n+\n   public static final Comparator<SerializablePair<Long, Double>> VALUE_COMPARATOR =\n-      Comparator.comparingDouble(o -> o.rhs);\n+      SerializablePair.createNullHandlingComparator(Double::compare, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODc3MTYyOnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregatorFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDo1NTozN1rOFfpDxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMjo0MjoyOFrOFftGYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjg4NQ==", "bodyText": "Based on javadocs in makeColumnValueSelector this selector can be NilColumnValueSelector\nin which case selector.getObject() on line 170 would return null and line 171 would throw an NPE?\nsimilar comment for the factorizeBuffered method", "url": "https://github.com/apache/druid/pull/9161#discussion_r368722885", "createdAt": "2020-01-20T20:55:37Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregatorFactory.java", "diffHunk": "@@ -126,35 +158,54 @@ public AggregatorFactory getCombiningFactory()\n     return new DoubleFirstAggregatorFactory(name, name)\n     {\n       @Override\n-      public Aggregator factorize(ColumnSelectorFactory metricFactory, ColumnValueSelector selector)\n+      public Aggregator factorize(ColumnSelectorFactory metricFactory)\n       {\n+        final ColumnValueSelector<SerializablePair<Long, Double>> selector =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4OTA4OQ==", "bodyText": "Since this is for combining, the selector will be of the serialized pair complex objects, which will not be null.", "url": "https://github.com/apache/druid/pull/9161#discussion_r368789089", "createdAt": "2020-01-21T02:42:28Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregatorFactory.java", "diffHunk": "@@ -126,35 +158,54 @@ public AggregatorFactory getCombiningFactory()\n     return new DoubleFirstAggregatorFactory(name, name)\n     {\n       @Override\n-      public Aggregator factorize(ColumnSelectorFactory metricFactory, ColumnValueSelector selector)\n+      public Aggregator factorize(ColumnSelectorFactory metricFactory)\n       {\n+        final ColumnValueSelector<SerializablePair<Long, Double>> selector =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjg4NQ=="}, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODgwMzI3OnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMToxNDowMVrOFfpWWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMjozOTo1MlrOFftEdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyNzY0MQ==", "bodyText": "it looks like these tests will only check useDefaultValuesForNull = true or is there some config I'm not seeing that sets it to false as well in another run?", "url": "https://github.com/apache/druid/pull/9161#discussion_r368727641", "createdAt": "2020-01-20T21:14:01Z", "author": {"login": "suneet-s"}, "path": "processing/src/test/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregationTest.java", "diffHunk": "@@ -30,14 +30,16 @@\n import org.apache.druid.query.aggregation.TestObjectColumnSelector;\n import org.apache.druid.segment.ColumnSelectorFactory;\n import org.apache.druid.segment.column.ColumnHolder;\n+import org.apache.druid.testing.InitializedNullHandlingTest;\n import org.easymock.EasyMock;\n import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n \n import java.nio.ByteBuffer;\n+import java.util.Comparator;\n \n-public class DoubleFirstAggregationTest\n+public class DoubleFirstAggregationTest extends InitializedNullHandlingTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4ODU5OQ==", "bodyText": "travis runs tests in both modes, this is to let tests run in intellij which doesn't get initialized correctly", "url": "https://github.com/apache/druid/pull/9161#discussion_r368788599", "createdAt": "2020-01-21T02:39:52Z", "author": {"login": "clintropolis"}, "path": "processing/src/test/java/org/apache/druid/query/aggregation/first/DoubleFirstAggregationTest.java", "diffHunk": "@@ -30,14 +30,16 @@\n import org.apache.druid.query.aggregation.TestObjectColumnSelector;\n import org.apache.druid.segment.ColumnSelectorFactory;\n import org.apache.druid.segment.column.ColumnHolder;\n+import org.apache.druid.testing.InitializedNullHandlingTest;\n import org.easymock.EasyMock;\n import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n \n import java.nio.ByteBuffer;\n+import java.util.Comparator;\n \n-public class DoubleFirstAggregationTest\n+public class DoubleFirstAggregationTest extends InitializedNullHandlingTest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyNzY0MQ=="}, "originalCommit": {"oid": "94c92b507aeb658adcb17e13a343125b2c926fd0"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2110, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}