{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NzQ1MTk3", "number": 10448, "title": "Added CronScheduler support as a proof to clock drift while emitting metrics", "bodyText": "Fixes #9283.\n\n\nDescription\n\nThis PR fixes the clock drift issue while emitting metrics. ScheduledExecutorService is very much prone to clock drift especially in certain windows platforms (see this: https://stackoverflow.com/questions/56571647/why-does-the-java-scheduler-exhibit-significant-time-drift-on-windows). I have used CronScheduler instead of ScheduledExecutorService, since CronScheduler provides proof against the clock drift issue.\n\nI have changed the startMonitor method in MonitorScheduler class. In this implementation, I have used CronScheduler.scheduleAtFixedRate method for periodically scheduling the monitor with constant rate. This method requires a CronTask which should be non-blocking, so the monitoring inside the cronTask is happening as an async process using executor thread pool.\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in [licenses.yaml]\n(https://github.com/apache/druid/blob/master/licenses.yaml)\n added unit tests to cover new code paths, ensuring the threshold for code coverage is met.", "createdAt": "2020-09-29T11:00:32Z", "url": "https://github.com/apache/druid/pull/10448", "merged": true, "mergeCommit": {"oid": "d0c2ede50c94bef89b72261fe3e553c60e7f0013"}, "closed": true, "closedAt": "2020-11-25T11:31:39Z", "author": {"login": "ayushkul2910"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6QFE9gH2gAyNDk0NzQ1MTk3OjUyNWM2YmQ1M2U5NWUwMDhjYmQxZmE4NDI3Yzg2N2U3YTNhYTlhZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtZJvzAFqTU2MjM0NDI2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "525c6bd53e95e008cbd1fa8427c867e7a3aa9af3", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/525c6bd53e95e008cbd1fa8427c867e7a3aa9af3", "committedDate": "2020-07-31T08:37:43Z", "message": "Added cronScheduler support for MonitorScheduler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c041bd364def78cf2ea1903c9733e4df4f6aed4", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/4c041bd364def78cf2ea1903c9733e4df4f6aed4", "committedDate": "2020-08-03T06:34:36Z", "message": "added javadoc and license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b686da7eef2a262732c96e632a803ca6bd186f", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/24b686da7eef2a262732c96e632a803ca6bd186f", "committedDate": "2020-08-03T12:18:43Z", "message": "Fixed formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aec96cf4fc3dd08ab02df3b8c8902d375f9dc4c", "author": {"user": {"login": "ayushkul2910", "name": "Ayush Kulshrestha"}}, "url": "https://github.com/apache/druid/commit/8aec96cf4fc3dd08ab02df3b8c8902d375f9dc4c", "committedDate": "2020-09-28T07:22:49Z", "message": "Merge pull request #472 from ayushkul2910/cronScheduling\n\nUsing CronScheduler instead of ScheduledExecutorService in MonitorScheduler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "653be2f6a663d1b4c5be29f7836e88cee64b57c5", "author": {"user": {"login": "ayushkul2910", "name": "Ayush Kulshrestha"}}, "url": "https://github.com/apache/druid/commit/653be2f6a663d1b4c5be29f7836e88cee64b57c5", "committedDate": "2020-10-12T10:42:52Z", "message": "Added tests for ScheduledExecutors and MonitorScheduler (#574)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67438be5f03813dda5e7da18d22ffcb33af1f601", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/67438be5f03813dda5e7da18d22ffcb33af1f601", "committedDate": "2020-10-12T11:39:54Z", "message": "Fixed conflicts in MonitorSchedulerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35071c2b904f483fbe6fd6c1d6594d489ca022d2", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/35071c2b904f483fbe6fd6c1d6594d489ca022d2", "committedDate": "2020-10-14T07:41:07Z", "message": "added branch coverage for ScheduledExecutors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "35071c2b904f483fbe6fd6c1d6594d489ca022d2", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/35071c2b904f483fbe6fd6c1d6594d489ca022d2", "committedDate": "2020-10-14T07:41:07Z", "message": "added branch coverage for ScheduledExecutors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20f7fe61551d1f3afeaeb06c245089aa4569f568", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/20f7fe61551d1f3afeaeb06c245089aa4569f568", "committedDate": "2020-10-18T13:21:00Z", "message": "dummy commit for rerunning build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTU4NzA0", "url": "https://github.com/apache/druid/pull/10448#pullrequestreview-511158704", "createdAt": "2020-10-18T16:13:34Z", "commit": {"oid": "20f7fe61551d1f3afeaeb06c245089aa4569f568"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxNjoxMzozNFrOHjr6Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxNjoxMzozNFrOHjr6Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE4MTY2Mg==", "bodyText": "I think this logic: scheduling one-shot task which reschedules itself, is problematic. I think we should remove these methods (together with the Signal enum) because they have negative utility.\nIn particular, for CronScheduler, constant rescheduling is probably prone to some drift. Instead, CronScheduler's methods like scheduleAtFixedRate() should be used directly from MonitorScheduler. The periodic task can be cancelled using the returned Future.", "url": "https://github.com/apache/druid/pull/10448#discussion_r507181662", "createdAt": "2020-10-18T16:13:34Z", "author": {"login": "leventov"}, "path": "core/src/main/java/org/apache/druid/java/util/common/concurrent/ScheduledExecutors.java", "diffHunk": "@@ -167,6 +169,50 @@ public void run()\n     );\n   }\n \n+  public static void scheduleAtFixedRate(CronScheduler exec, Duration rate, Callable<Signal> callable)\n+  {\n+    scheduleAtFixedRate(exec, rate, rate, callable);\n+  }\n+\n+  /**\n+   * Run callable once every period, after the given initial delay. Uses\n+   * {@link CronScheduler} for task scheduling. Exceptions are caught and logged\n+   * as errors.\n+   */\n+  public static void scheduleAtFixedRate(\n+      final CronScheduler exec,\n+      final Duration initialDelay,\n+      final Duration rate,\n+      final Callable<Signal> callable\n+  )\n+  {\n+    log.debug(\"Scheduling periodically: %s with period %s\", callable, rate);\n+    Instant delayInstance = Instant.now().plusMillis(initialDelay.getMillis());\n+    exec.scheduleAt(delayInstance,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f7fe61551d1f3afeaeb06c245089aa4569f568"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0de642c6f75cd378915d19ff6cf5514769e9fb0f", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/0de642c6f75cd378915d19ff6cf5514769e9fb0f", "committedDate": "2020-10-30T14:02:25Z", "message": "added cronScheduler for fixed rate monitoring in MonitorScheduler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a24eacb46a324946adce12edb437fec6ef40a986", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/a24eacb46a324946adce12edb437fec6ef40a986", "committedDate": "2020-11-01T11:14:50Z", "message": "added override annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10ba516b47068b83b1021142fc940c1b788ffce8", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/10ba516b47068b83b1021142fc940c1b788ffce8", "committedDate": "2020-11-01T12:10:51Z", "message": "fixed checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3af13a0e8cc43571969bead1ab787f5b5e2f8a6d", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/3af13a0e8cc43571969bead1ab787f5b5e2f8a6d", "committedDate": "2020-11-01T12:13:40Z", "message": "changed executor to use cachedThreadPool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b3f303826064406db2517adfcef8758202e185", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/62b3f303826064406db2517adfcef8758202e185", "committedDate": "2020-11-02T10:00:18Z", "message": "Merge branch 'master' of https://github.com/miqdigital/druid into cronScheduling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8628ad13629a4a8bbca52e3f6561276be7b5893", "author": {"user": null}, "url": "https://github.com/apache/druid/commit/d8628ad13629a4a8bbca52e3f6561276be7b5893", "committedDate": "2020-11-07T12:58:11Z", "message": "changed number of threads to 64"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTczMjQ1", "url": "https://github.com/apache/druid/pull/10448#pullrequestreview-533173245", "createdAt": "2020-11-18T07:46:29Z", "commit": {"oid": "d8628ad13629a4a8bbca52e3f6561276be7b5893"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Mjg0NTk5", "url": "https://github.com/apache/druid/pull/10448#pullrequestreview-537284599", "createdAt": "2020-11-24T09:15:52Z", "commit": {"oid": "d8628ad13629a4a8bbca52e3f6561276be7b5893"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMzQ0MjY3", "url": "https://github.com/apache/druid/pull/10448#pullrequestreview-562344267", "createdAt": "2021-01-06T06:02:06Z", "commit": {"oid": "d8628ad13629a4a8bbca52e3f6561276be7b5893"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNjowMjowNlrOIOy-PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNjowMjowNlrOIOy-PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM4NjEwOQ==", "bodyText": "This looks like an overkill. What was the rationale for using this many threads?", "url": "https://github.com/apache/druid/pull/10448#discussion_r552386109", "createdAt": "2021-01-06T06:02:06Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/metrics/MetricsModule.java", "diffHunk": "@@ -108,10 +108,10 @@ public MonitorScheduler getMonitorScheduler(\n \n     return new MonitorScheduler(\n         config.get(),\n-        CronScheduler.newBuilder(Duration.ofSeconds(1L)).setThreadName(\"MonitorScheduler-%s\").build(),\n+        CronScheduler.newBuilder(Duration.ofSeconds(1L)).setThreadName(\"MonitorSchedulerThread\").build(),\n         emitter,\n         monitors,\n-        Executors.newCachedThreadPool()\n+        Execs.multiThreaded(64, \"MonitorThread-%d\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8628ad13629a4a8bbca52e3f6561276be7b5893"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3302, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}