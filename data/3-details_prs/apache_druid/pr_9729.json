{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NDE4NzA5", "number": 9729, "title": "Test reading from empty kafka/kinesis partitions", "bodyText": "Add tests for reading from empty kafka/kinesis partitions\nDescription\nAdd tests for reading from empty kafka/kinesis partitions. The new tests discovers that Kafka is working fine when reading from empty kafka partitions, and thus, supervisor shows healthy and tasks are running without failing when one or more partition is empty (as tested in KafkaRecordSupplierTest.java). However, Kinesis supervisor is showing unhealthy and task are not running when one or more partition is empty. This should be fix in a separate PR and subsequently these tests for Kinesis will have to be modify.\nNote that there is no problem when index task is running and polling from kafka/kinesis stream with one or more empty shards (as tested in KafkaIndexTaskTest.java and KinesisIndexTaskTest.java). The problem for Kinesis described above is when we try to get the sequence number in SeekableStreamSupervisor#getOffsetFromStorageForPartition and Kinesis has one or more empty shard (as tested in KinesisRecordSupplierTest.java and SeekableStreamSupervisorStateTest.java). More specifically, this happens for the following conditions:\n\nwe don't have a startingOffset (first run or we had some previous failures and reset the sequences) and don't have offset in metadata store so we retrieve the latest or earliest Kinesis sequence\nwe don't have a startingOffset (first run or we had some previous failures and reset the sequences) and we have offset in metadata store but skipSequenceNumberAvailabilityCheck=False\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-04-21T03:39:59Z", "url": "https://github.com/apache/druid/pull/9729", "merged": true, "mergeCommit": {"oid": "8b78eebdbdab87cd663f3ddf5c5fb7f6e9bcdc34"}, "closed": true, "closedAt": "2020-04-27T17:23:57Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZrJWPgH2gAyNDA2NDE4NzA5OmU3NTUyMmM3MjVjMjY1NTVkMjlhY2E0OGI0OGIzMmU4ZDlhY2E5MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABca1D5IAFqTQwMDE0NDQ3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e75522c725c26555d29aca48b48b32e8d9aca911", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/e75522c725c26555d29aca48b48b32e8d9aca911", "committedDate": "2020-04-21T03:30:19Z", "message": "add test for stream sequence number returns null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b86f083f7048eb952e4965f6047557b9cf4883", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/d8b86f083f7048eb952e4965f6047557b9cf4883", "committedDate": "2020-04-21T21:55:26Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578cac7940c320f033ddc9eb4a719d0c4b243d3c", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/578cac7940c320f033ddc9eb4a719d0c4b243d3c", "committedDate": "2020-04-22T02:43:03Z", "message": "add index test for when stream returns null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae222aadcb28fff86752544297de965fceaba46a", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/ae222aadcb28fff86752544297de965fceaba46a", "committedDate": "2020-04-22T07:28:15Z", "message": "retrigger test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NjE1MTkz", "url": "https://github.com/apache/druid/pull/9729#pullrequestreview-399615193", "createdAt": "2020-04-24T03:25:52Z", "commit": {"oid": "ae222aadcb28fff86752544297de965fceaba46a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwMzoyNTo1MlrOGLEsGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwMzoyNTo1MlrOGLEsGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2NDM0NA==", "bodyText": "This change doesn't seem doing anything. Is there some reason?", "url": "https://github.com/apache/druid/pull/9729#discussion_r414264344", "createdAt": "2020-04-24T03:25:52Z", "author": {"login": "jihoonson"}, "path": "extensions-core/kinesis-indexing-service/src/main/java/org/apache/druid/indexing/kinesis/KinesisRecordSupplier.java", "diffHunk": "@@ -780,15 +780,14 @@ private String getSequenceNumberInternal(StreamPartition<String> partition, Shar\n   private String getSequenceNumberInternal(StreamPartition<String> partition, String shardIterator)\n   {\n     long timeoutMillis = System.currentTimeMillis() + fetchSequenceNumberTimeout;\n+    GetRecordsResult recordsResult = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae222aadcb28fff86752544297de965fceaba46a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTQ0NDc3", "url": "https://github.com/apache/druid/pull/9729#pullrequestreview-400144477", "createdAt": "2020-04-24T17:37:11Z", "commit": {"oid": "ae222aadcb28fff86752544297de965fceaba46a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzozNzoxMVrOGLiM7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzozNzoxMVrOGLiM7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0Nzg4NA==", "bodyText": "Got it. Thanks.", "url": "https://github.com/apache/druid/pull/9729#discussion_r414747884", "createdAt": "2020-04-24T17:37:11Z", "author": {"login": "jihoonson"}, "path": "extensions-core/kinesis-indexing-service/src/main/java/org/apache/druid/indexing/kinesis/KinesisRecordSupplier.java", "diffHunk": "@@ -780,15 +780,14 @@ private String getSequenceNumberInternal(StreamPartition<String> partition, Shar\n   private String getSequenceNumberInternal(StreamPartition<String> partition, String shardIterator)\n   {\n     long timeoutMillis = System.currentTimeMillis() + fetchSequenceNumberTimeout;\n+    GetRecordsResult recordsResult = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2NDM0NA=="}, "originalCommit": {"oid": "ae222aadcb28fff86752544297de965fceaba46a"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2544, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}