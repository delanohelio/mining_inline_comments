{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDMwMzAx", "number": 9181, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMDo1ODowNVrODYIwkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTo1MTowM1rODYsaVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NjM1OTIxOnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/StringFirstLastUtils.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMDo1ODowNVrOFd0kmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMToyMTo1OVrOFen98g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgxNDM2MQ==", "bodyText": "Hmm, it looks to me like this method only returns true if a selector definitely is a SerializablePairLongString . Should this just be returning true if we made it here?\nAlternatively, should needsFoldCheck be rebranded as isFold and the aggregate methods of the first last heap and buffer aggs just be reading a SerializablePairLongString from the value selector directly instead of calling readPairFromSelectors?", "url": "https://github.com/apache/druid/pull/9181#discussion_r366814361", "createdAt": "2020-01-15T10:58:05Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/StringFirstLastUtils.java", "diffHunk": "@@ -33,23 +36,63 @@\n {\n   private static final int NULL_VALUE = -1;\n \n+  /**\n+   * Shorten \"s\" to \"maxBytes\" chars. Fast and loose because these are *chars* not *bytes*. Use\n+   * {@link #chop(String, int)} for slower, but accurate chopping.\n+   */\n+  @Nullable\n+  public static String fastLooseChop(@Nullable final String s, final int maxBytes)\n+  {\n+    if (s == null || s.length() <= maxBytes) {\n+      return s;\n+    } else {\n+      return s.substring(0, maxBytes);\n+    }\n+  }\n+\n+  /**\n+   * Shorten \"s\" to what could fit in \"maxBytes\" bytes as UTF-8.\n+   */\n   @Nullable\n   public static String chop(@Nullable final String s, final int maxBytes)\n   {\n     if (s == null) {\n       return null;\n     } else {\n-      // Shorten firstValue to what could fit in maxBytes as UTF-8.\n       final byte[] bytes = new byte[maxBytes];\n       final int len = StringUtils.toUtf8WithLimit(s, ByteBuffer.wrap(bytes));\n       return new String(bytes, 0, len, StandardCharsets.UTF_8);\n     }\n   }\n \n+  /**\n+   * Returns whether a given value selector *might* contain SerializablePairLongString objects.\n+   */\n+  public static boolean selectorNeedsFoldCheck(\n+      final BaseObjectColumnValueSelector<?> valueSelector,\n+      @Nullable final ColumnCapabilities valueSelectorCapabilities\n+  )\n+  {\n+    if (valueSelectorCapabilities != null && valueSelectorCapabilities.getType() != ValueType.COMPLEX) {\n+      // Known, non-complex type.\n+      return false;\n+    }\n+\n+    if (valueSelector instanceof NilColumnValueSelector) {\n+      // Nil column, definitely no SerializablePairLongStrings.\n+      return false;\n+    }\n+\n+    // Check if the reported class could possibly be SerializablePairLongString.\n+    final Class<?> clazz = valueSelector.classOfObject();\n+    return clazz.isAssignableFrom(SerializablePairLongString.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzNDU2OA==", "bodyText": "Apologies, I was wrong, I think this line + comment just isn't super intuitive on first glance that it is a catch-all that any \u2018unknown\u2019 selector types will also be true (since clazz will be Object.class in that case). Maybe expanding on the comment would make it require less thought?", "url": "https://github.com/apache/druid/pull/9181#discussion_r367234568", "createdAt": "2020-01-16T05:18:13Z", "author": {"login": "clintropolis"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/StringFirstLastUtils.java", "diffHunk": "@@ -33,23 +36,63 @@\n {\n   private static final int NULL_VALUE = -1;\n \n+  /**\n+   * Shorten \"s\" to \"maxBytes\" chars. Fast and loose because these are *chars* not *bytes*. Use\n+   * {@link #chop(String, int)} for slower, but accurate chopping.\n+   */\n+  @Nullable\n+  public static String fastLooseChop(@Nullable final String s, final int maxBytes)\n+  {\n+    if (s == null || s.length() <= maxBytes) {\n+      return s;\n+    } else {\n+      return s.substring(0, maxBytes);\n+    }\n+  }\n+\n+  /**\n+   * Shorten \"s\" to what could fit in \"maxBytes\" bytes as UTF-8.\n+   */\n   @Nullable\n   public static String chop(@Nullable final String s, final int maxBytes)\n   {\n     if (s == null) {\n       return null;\n     } else {\n-      // Shorten firstValue to what could fit in maxBytes as UTF-8.\n       final byte[] bytes = new byte[maxBytes];\n       final int len = StringUtils.toUtf8WithLimit(s, ByteBuffer.wrap(bytes));\n       return new String(bytes, 0, len, StandardCharsets.UTF_8);\n     }\n   }\n \n+  /**\n+   * Returns whether a given value selector *might* contain SerializablePairLongString objects.\n+   */\n+  public static boolean selectorNeedsFoldCheck(\n+      final BaseObjectColumnValueSelector<?> valueSelector,\n+      @Nullable final ColumnCapabilities valueSelectorCapabilities\n+  )\n+  {\n+    if (valueSelectorCapabilities != null && valueSelectorCapabilities.getType() != ValueType.COMPLEX) {\n+      // Known, non-complex type.\n+      return false;\n+    }\n+\n+    if (valueSelector instanceof NilColumnValueSelector) {\n+      // Nil column, definitely no SerializablePairLongStrings.\n+      return false;\n+    }\n+\n+    // Check if the reported class could possibly be SerializablePairLongString.\n+    final Class<?> clazz = valueSelector.classOfObject();\n+    return clazz.isAssignableFrom(SerializablePairLongString.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgxNDM2MQ=="}, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY1NjQzNA==", "bodyText": "I changed it to:\n    // Check if the selector class could possibly be a SerializablePairLongString (either a superclass or subclass).", "url": "https://github.com/apache/druid/pull/9181#discussion_r367656434", "createdAt": "2020-01-16T21:21:59Z", "author": {"login": "gianm"}, "path": "processing/src/main/java/org/apache/druid/query/aggregation/first/StringFirstLastUtils.java", "diffHunk": "@@ -33,23 +36,63 @@\n {\n   private static final int NULL_VALUE = -1;\n \n+  /**\n+   * Shorten \"s\" to \"maxBytes\" chars. Fast and loose because these are *chars* not *bytes*. Use\n+   * {@link #chop(String, int)} for slower, but accurate chopping.\n+   */\n+  @Nullable\n+  public static String fastLooseChop(@Nullable final String s, final int maxBytes)\n+  {\n+    if (s == null || s.length() <= maxBytes) {\n+      return s;\n+    } else {\n+      return s.substring(0, maxBytes);\n+    }\n+  }\n+\n+  /**\n+   * Shorten \"s\" to what could fit in \"maxBytes\" bytes as UTF-8.\n+   */\n   @Nullable\n   public static String chop(@Nullable final String s, final int maxBytes)\n   {\n     if (s == null) {\n       return null;\n     } else {\n-      // Shorten firstValue to what could fit in maxBytes as UTF-8.\n       final byte[] bytes = new byte[maxBytes];\n       final int len = StringUtils.toUtf8WithLimit(s, ByteBuffer.wrap(bytes));\n       return new String(bytes, 0, len, StandardCharsets.UTF_8);\n     }\n   }\n \n+  /**\n+   * Returns whether a given value selector *might* contain SerializablePairLongString objects.\n+   */\n+  public static boolean selectorNeedsFoldCheck(\n+      final BaseObjectColumnValueSelector<?> valueSelector,\n+      @Nullable final ColumnCapabilities valueSelectorCapabilities\n+  )\n+  {\n+    if (valueSelectorCapabilities != null && valueSelectorCapabilities.getType() != ValueType.COMPLEX) {\n+      // Known, non-complex type.\n+      return false;\n+    }\n+\n+    if (valueSelector instanceof NilColumnValueSelector) {\n+      // Nil column, definitely no SerializablePairLongStrings.\n+      return false;\n+    }\n+\n+    // Check if the reported class could possibly be SerializablePairLongString.\n+    final Class<?> clazz = valueSelector.classOfObject();\n+    return clazz.isAssignableFrom(SerializablePairLongString.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgxNDM2MQ=="}, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NjQyOTU3OnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMToyNToxNlrOFd1Png==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMToyMjoxM1rOFen-VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgyNTM3NA==", "bodyText": "nit: typo 'expectec'", "url": "https://github.com/apache/druid/pull/9181#discussion_r366825374", "createdAt": "2020-01-15T11:25:16Z", "author": {"login": "clintropolis"}, "path": "processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java", "diffHunk": "@@ -81,6 +82,43 @@ public void testBufferAggregate()\n \n   }\n \n+  @Test\n+  public void testBufferAggregateWithFoldCheck()\n+  {\n+    final long[] timestamps = {1526724600L, 1526724700L, 1526724800L, 1526725900L, 1526725000L};\n+    final String[] strings = {\"AAAA\", \"BBBB\", \"CCCC\", \"DDDD\", \"EEEE\"};\n+    Integer maxStringBytes = 1024;\n+\n+    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n+    TestObjectColumnSelector<String> objectColumnSelector = new TestObjectColumnSelector<>(strings);\n+\n+    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n+        \"billy\", \"billy\", maxStringBytes\n+    );\n+\n+    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n+        longColumnSelector,\n+        objectColumnSelector,\n+        maxStringBytes,\n+        true\n+    );\n+\n+    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n+    int position = 0;\n+\n+    agg.init(buf, position);\n+    //noinspection ForLoopReplaceableByForEach\n+    for (int i = 0; i < timestamps.length; i++) {\n+      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n+    }\n+\n+    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n+\n+\n+    Assert.assertEquals(\"expectec last string value\", \"DDDD\", sp.rhs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY1NjUzMg==", "bodyText": "Updated.", "url": "https://github.com/apache/druid/pull/9181#discussion_r367656532", "createdAt": "2020-01-16T21:22:13Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java", "diffHunk": "@@ -81,6 +82,43 @@ public void testBufferAggregate()\n \n   }\n \n+  @Test\n+  public void testBufferAggregateWithFoldCheck()\n+  {\n+    final long[] timestamps = {1526724600L, 1526724700L, 1526724800L, 1526725900L, 1526725000L};\n+    final String[] strings = {\"AAAA\", \"BBBB\", \"CCCC\", \"DDDD\", \"EEEE\"};\n+    Integer maxStringBytes = 1024;\n+\n+    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n+    TestObjectColumnSelector<String> objectColumnSelector = new TestObjectColumnSelector<>(strings);\n+\n+    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n+        \"billy\", \"billy\", maxStringBytes\n+    );\n+\n+    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n+        longColumnSelector,\n+        objectColumnSelector,\n+        maxStringBytes,\n+        true\n+    );\n+\n+    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n+    int position = 0;\n+\n+    agg.init(buf, position);\n+    //noinspection ForLoopReplaceableByForEach\n+    for (int i = 0; i < timestamps.length; i++) {\n+      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n+    }\n+\n+    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n+\n+\n+    Assert.assertEquals(\"expectec last string value\", \"DDDD\", sp.rhs);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgyNTM3NA=="}, "originalCommit": {"oid": "ecc43107320489ea1267aed7b2dbd30f440104f9"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjIwMDU0OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/druid/java/util/common/StringUtilsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTo1MTowM1rOFes1ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTo1MTowM1rOFes1ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzczNjE2NQ==", "bodyText": "\ud83d\ude42", "url": "https://github.com/apache/druid/pull/9181#discussion_r367736165", "createdAt": "2020-01-17T01:51:03Z", "author": {"login": "clintropolis"}, "path": "core/src/test/java/org/apache/druid/java/util/common/StringUtilsTest.java", "diffHunk": "@@ -246,4 +246,32 @@ public void testRpad()\n     Assert.assertEquals(s5, null);\n   }\n \n+  @Test\n+  public void testChop()\n+  {\n+    Assert.assertEquals(\"foo\", StringUtils.chop(\"foo\", 5));\n+    Assert.assertEquals(\"fo\", StringUtils.chop(\"foo\", 2));\n+    Assert.assertEquals(\"\", StringUtils.chop(\"foo\", 0));\n+    Assert.assertEquals(\"smile \ud83d\ude42 for\", StringUtils.chop(\"smile \ud83d\ude42 for the camera\", 14));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de0697cb1834f77a2fafc57e5d56673a558c5e83"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2124, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}