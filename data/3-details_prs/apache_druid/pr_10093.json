{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzYyODMz", "number": 10093, "title": "Add groupBy limitSpec to queryCache key", "bodyText": "Description\nThis PR Fixes a bug with groupBy query cache key. The current cache key for groupby queries does not contain limitSpec info. So when a user queries with a given limit lets say 10 and then increase the limit to 100, he would still get the cached results with older limit.\nNote: This only shows up if you have enabled caching for groupby queries, which is enabled by default from 0.13 release.\nThis PR has:\n\n[*] been self-reviewed.\n[*] added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n[*] been tested in a test Druid cluster.", "createdAt": "2020-06-29T12:04:25Z", "url": "https://github.com/apache/druid/pull/10093", "merged": true, "mergeCommit": {"oid": "971d8a353b27bbb61f934978978ea83371651248"}, "closed": true, "closedAt": "2020-07-14T02:15:10Z", "author": {"login": "nishantmonu51"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv-ELYAH2gAyNDQxMzYyODMzOjhlNDdhMDc2MTI4YjA0MDI0Y2MzZTljYjBhYTg1Mjk4MjlkYzU3ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0jMtNAFqTQ0NzM2MTExMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e47a076128b04024cc3e9cb0aa8529829dc5785", "author": {"user": {"login": "nishantmonu51", "name": "Nishant Bangarwa"}}, "url": "https://github.com/apache/druid/commit/8e47a076128b04024cc3e9cb0aa8529829dc5785", "committedDate": "2020-06-29T09:59:12Z", "message": "Add groupBy limitSpec to queryCache key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzQ5NDcy", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-439349472", "createdAt": "2020-06-29T17:20:30Z", "commit": {"oid": "8e47a076128b04024cc3e9cb0aa8529829dc5785"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzU3OTQ2", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-439357946", "createdAt": "2020-06-29T17:32:06Z", "commit": {"oid": "8e47a076128b04024cc3e9cb0aa8529829dc5785"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzozMjowNlrOGqbF3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzozMjowNlrOGqbF3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNzI0NQ==", "bodyText": "Does this also need to consider the havingSpec similar to the ResultLevelCacheKey below?", "url": "https://github.com/apache/druid/pull/10093#discussion_r447137245", "createdAt": "2020-06-29T17:32:06Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQueryQueryToolChest.java", "diffHunk": "@@ -524,6 +524,7 @@ public boolean isCacheable(GroupByQuery query, boolean willMergeRunners)\n             .appendCacheables(query.getAggregatorSpecs())\n             .appendCacheables(query.getDimensions())\n             .appendCacheable(query.getVirtualColumns())\n+            .appendCacheable(query.getLimitSpec())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e47a076128b04024cc3e9cb0aa8529829dc5785"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODI3NTQ3", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-442827547", "createdAt": "2020-07-06T07:18:04Z", "commit": {"oid": "8e47a076128b04024cc3e9cb0aa8529829dc5785"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54c0aee0a98574002dd2b5f8281cc48e623b33af", "author": {"user": {"login": "nishantmonu51", "name": "Nishant Bangarwa"}}, "url": "https://github.com/apache/druid/commit/54c0aee0a98574002dd2b5f8281cc48e623b33af", "committedDate": "2020-07-07T07:58:34Z", "message": "Only add limitSpec to cache key if pushdown is set to true"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTE4Njcw", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-444118670", "createdAt": "2020-07-07T17:48:33Z", "commit": {"oid": "54c0aee0a98574002dd2b5f8281cc48e623b33af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0ODozM1rOGuJSPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0ODozM1rOGuJSPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzOTgwNg==", "bodyText": "Would you please add another query which has the same spec and CTX_KEY_APPLY_LIMIT_PUSH_DOWN of true in the context, and check the equality of the cache key of the query and query1?", "url": "https://github.com/apache/druid/pull/10093#discussion_r451039806", "createdAt": "2020-07-07T17:48:33Z", "author": {"login": "jihoonson"}, "path": "processing/src/test/java/org/apache/druid/query/groupby/GroupByQueryQueryToolChestTest.java", "diffHunk": "@@ -929,6 +930,64 @@ private void doTestCacheStrategy(final ValueType valueType, final Object dimValu\n     Assert.assertEquals(typeAdjustedResult2, fromResultCacheResult);\n   }\n \n+  @Test\n+  public void testQueryCacheKeyWithLimitSpec()\n+  {\n+    final GroupByQuery query1 = GroupByQuery", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c0aee0a98574002dd2b5f8281cc48e623b33af"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODMzMzQz", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-445833343", "createdAt": "2020-07-09T17:40:38Z", "commit": {"oid": "54c0aee0a98574002dd2b5f8281cc48e623b33af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee4572cdf63913a38fe7656a43b9cfed77aa475", "author": {"user": {"login": "nishantmonu51", "name": "Nishant Bangarwa"}}, "url": "https://github.com/apache/druid/commit/aee4572cdf63913a38fe7656a43b9cfed77aa475", "committedDate": "2020-07-13T13:14:38Z", "message": "review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzYxMTEw", "url": "https://github.com/apache/druid/pull/10093#pullrequestreview-447361110", "createdAt": "2020-07-13T15:30:42Z", "commit": {"oid": "aee4572cdf63913a38fe7656a43b9cfed77aa475"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2194, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}