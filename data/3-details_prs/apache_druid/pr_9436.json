{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTc0Nzg2", "number": 9436, "title": "added number of bins parameter", "bodyText": "Description\nThis is to support an alternative way of obtaining a histogram from a Quantiles Sketch using the DoublesSketchToHistogramPostAggregator. The parameter \"splitPoints\" was made optional, and another parameter \"numBins\" was added. The new parameter is optional as well, but it has a default of 10. Therefore if both parameters are omitted, the post agg must produce a histogram with 10 equally-spaced bins between min and max values in the sketch.\nI am not familiar with SQL adaptors, so I did not add this feature there.\n\n[x ] added documentation for new or modified features or behaviors.\n[x ] added unit tests or modified existing tests to cover new code paths.", "createdAt": "2020-02-28T20:12:48Z", "url": "https://github.com/apache/druid/pull/9436", "merged": true, "mergeCommit": {"oid": "844d62673888899a4b7be8b50929adcf057e7808"}, "closed": true, "closedAt": "2020-05-04T23:53:11Z", "author": {"login": "AlexanderSaydakov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI1gBIgH2gAyMzgxNTc0Nzg2OjQyZDI4N2IzZmQ4MjM2YWQyMzRjMGIyOWM0ODc5Y2U5ZjE3NTZlZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceHMeHAFqTQwNTM5MTExNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9", "author": {"user": {"login": "AlexanderSaydakov", "name": "Alexander Saydakov"}}, "url": "https://github.com/apache/druid/commit/42d287b3fd8236ad234c0b29c4879ce9f1756ee9", "committedDate": "2020-02-28T19:57:25Z", "message": "added number of bins parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMTg1NDYz", "url": "https://github.com/apache/druid/pull/9436#pullrequestreview-403185463", "createdAt": "2020-04-30T04:00:02Z", "commit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMDowMlrOGOY1WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowODo1NlrOGOY9Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MDEyMA==", "bodyText": "Since this.numBins will be ignored if splitPoints is set, it'd be best to throw an error in the constructor if both are provided.  Could you please add one (an error message like \"Cannot accept both 'numBins' and 'splitPoints'\").", "url": "https://github.com/apache/druid/pull/9436#discussion_r417740120", "createdAt": "2020-04-30T04:00:02Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -29,45 +29,68 @@\n import org.apache.druid.query.aggregation.PostAggregator;\n import org.apache.druid.query.cache.CacheKeyBuilder;\n \n+import javax.annotation.Nullable;\n import java.util.Arrays;\n import java.util.Comparator;\n import java.util.Map;\n import java.util.Set;\n \n public class DoublesSketchToHistogramPostAggregator implements PostAggregator\n {\n+  static final int DEFAULT_NUM_BINS = 10;\n \n   private final String name;\n   private final PostAggregator field;\n   private final double[] splitPoints;\n+  private final Integer numBins;\n \n   @JsonCreator\n   public DoublesSketchToHistogramPostAggregator(\n       @JsonProperty(\"name\") final String name,\n       @JsonProperty(\"field\") final PostAggregator field,\n-      @JsonProperty(\"splitPoints\") final double[] splitPoints)\n+      @JsonProperty(\"splitPoints\") @Nullable final double[] splitPoints,\n+      @JsonProperty(\"numBins\") @Nullable final Integer numBins)\n   {\n     this.name = Preconditions.checkNotNull(name, \"name is null\");\n     this.field = Preconditions.checkNotNull(field, \"field is null\");\n-    this.splitPoints = Preconditions.checkNotNull(splitPoints, \"array of split points is null\");\n+    this.splitPoints = splitPoints;\n+    this.numBins = numBins;\n   }\n \n   @Override\n   public Object compute(final Map<String, Object> combinedAggregators)\n   {\n     final DoublesSketch sketch = (DoublesSketch) field.compute(combinedAggregators);\n+    final int numBins = splitPoints != null ? splitPoints.length + 1 :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MDYwMw==", "bodyText": "Suggest doing @JsonInclude(JsonInclude.Include.NON_NULL) so the serialized form is cleaner when numBins is null.\n(It would make sense to add this to getSplitPoints too.)", "url": "https://github.com/apache/druid/pull/9436#discussion_r417740603", "createdAt": "2020-04-30T04:02:14Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -87,6 +110,12 @@ public PostAggregator getField()\n     return splitPoints;\n   }\n \n+  @JsonProperty\n+  public Integer getNumBins()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MTQ0NQ==", "bodyText": "Please add an EqualsVerifier test too. We don't have them everywhere yet but we're trying to add them in patches that adjust equals or hashCode implementations. Check out InFilterTest for an example. It looks like this.\n  @Test\n  public void testEquals()\n  {\n    EqualsVerifier.forClass(InFilter.class)\n                  .usingGetClass()\n                  .withNonnullFields(\"dimension\", \"values\")\n                  .withIgnoredFields(\"longPredicateSupplier\", \"floatPredicateSupplier\", \"doublePredicateSupplier\")\n                  .verify();\n  }", "url": "https://github.com/apache/druid/pull/9436#discussion_r417741445", "createdAt": "2020-04-30T04:05:53Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -125,14 +155,26 @@ public boolean equals(final Object o)\n     if (!Arrays.equals(splitPoints, that.splitPoints)) {\n       return false;\n     }\n-    return field.equals(that.field);\n+    if (!field.equals(that.field)) {\n+      return false;\n+    }\n+    if (numBins == null && that.numBins == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MjE2Nw==", "bodyText": "It's suggested, but not explicitly called out, that you aren't allowed to specify both splitPoints and numBins. It'd be better to call it out.", "url": "https://github.com/apache/druid/pull/9436#discussion_r417742167", "createdAt": "2020-04-30T04:08:56Z", "author": {"login": "gianm"}, "path": "docs/development/extensions-core/datasketches-quantiles.md", "diffHunk": "@@ -87,14 +87,15 @@ This returns an array of quantiles corresponding to a given array of fractions\n \n #### Histogram\n \n-This returns an approximation to the histogram given an array of split points that define the histogram bins. An array of <i>m</i> unique, monotonically increasing split points divide the real number line into <i>m+1</i> consecutive disjoint intervals. The definition of an interval is inclusive of the left split point and exclusive of the right split point.\n+This returns an approximation to the histogram given an array of split points that define the histogram bins or a number of bins. An array of <i>m</i> unique, monotonically increasing split points divide the real number line into <i>m+1</i> consecutive disjoint intervals. The definition of an interval is inclusive of the left split point and exclusive of the right split point. If the number of bins is specified instead of split points, the interval between the minimum and maximum values is divided into the given number of equally-spaced bins.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79d9460767cefe90d1f9be50523e7165fccc6435", "author": {"user": {"login": "AlexanderSaydakov", "name": "Alexander Saydakov"}}, "url": "https://github.com/apache/druid/commit/79d9460767cefe90d1f9be50523e7165fccc6435", "committedDate": "2020-05-04T20:44:22Z", "message": "addressed review points"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "303c8bcb726cb1b54f217ee21f56059109068311", "author": {"user": {"login": "AlexanderSaydakov", "name": "Alexander Saydakov"}}, "url": "https://github.com/apache/druid/commit/303c8bcb726cb1b54f217ee21f56059109068311", "committedDate": "2020-05-04T20:46:51Z", "message": "Merge branch 'master' into datasketches_histogram_num_bins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44aed1101adb566b2cafb0b64b2fb2aba0f425fd", "author": {"user": {"login": "AlexanderSaydakov", "name": "Alexander Saydakov"}}, "url": "https://github.com/apache/druid/commit/44aed1101adb566b2cafb0b64b2fb2aba0f425fd", "committedDate": "2020-05-04T21:51:17Z", "message": "test equals"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzkxMTE0", "url": "https://github.com/apache/druid/pull/9436#pullrequestreview-405391114", "createdAt": "2020-05-04T22:26:46Z", "commit": {"oid": "44aed1101adb566b2cafb0b64b2fb2aba0f425fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2970, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}