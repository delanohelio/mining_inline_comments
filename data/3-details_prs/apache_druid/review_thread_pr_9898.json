{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNTI4OTQz", "number": 9898, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1NjozN1rOEGmSsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNTowNjoxOFrOEJ7qOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU0Mjg5OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/data/input/aliyun/OssEntity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1NjozN1rOGlfmAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1NjozN1rOGlfmAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2ODEyOQ==", "bodyText": "s3 -> Aliyun OSS", "url": "https://github.com/apache/druid/pull/9898#discussion_r441968129", "createdAt": "2020-06-18T04:56:37Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/data/input/aliyun/OssEntity.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.GetObjectRequest;\n+import com.aliyun.oss.model.OSSObject;\n+import com.google.common.base.Predicate;\n+import org.apache.druid.data.input.RetryingInputEntity;\n+import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.storage.aliyun.OssStorageDruidModule;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+\n+public class OssEntity extends RetryingInputEntity\n+{\n+  private final OSS ossClient;\n+  private final CloudObjectLocation object;\n+\n+  OssEntity(OSS ossClient, CloudObjectLocation coords)\n+  {\n+    this.ossClient = ossClient;\n+    this.object = coords;\n+  }\n+\n+  @Override\n+  public URI getUri()\n+  {\n+    return object.toUri(OssStorageDruidModule.SCHEME);\n+  }\n+\n+  @Override\n+  protected InputStream readFrom(long offset) throws IOException\n+  {\n+    final GetObjectRequest request = new GetObjectRequest(object.getBucket(), object.getPath());\n+    request.setRange(offset, -1 /*from offset to end*/);\n+\n+    try {\n+      final OSSObject ossObject = ossClient.getObject(request);\n+      if (ossObject == null) {\n+        throw new ISE(\n+            \"Failed to get an s3 object for bucket[%s], key[%s], and start[%d]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU0NjM5OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/firehose/aliyun/StaticOssFirehoseFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1ODo1NVrOGlfoSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1ODo1NVrOGlfoSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2ODcxNQ==", "bodyText": "Suggest making \"aliyun-oss\" a constant", "url": "https://github.com/apache/druid/pull/9898#discussion_r441968715", "createdAt": "2020-06-18T04:58:55Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/firehose/aliyun/StaticOssFirehoseFactory.java", "diffHunk": "@@ -0,0 +1,237 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.firehose.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.GetObjectRequest;\n+import com.aliyun.oss.model.OSSObject;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.fasterxml.jackson.annotation.JacksonInject;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Predicate;\n+import org.apache.druid.data.input.FiniteFirehoseFactory;\n+import org.apache.druid.data.input.InputSplit;\n+import org.apache.druid.data.input.impl.StringInputRowParser;\n+import org.apache.druid.data.input.impl.prefetch.PrefetchableTextFilesFirehoseFactory;\n+import org.apache.druid.java.util.common.IAE;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.logger.Logger;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+import org.apache.druid.utils.CompressionUtils;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Builds firehoses that read from a predefined list of aliyun-oss objects and then dry up.\n+ */\n+public class StaticOssFirehoseFactory extends PrefetchableTextFilesFirehoseFactory<URI>\n+{\n+  private static final Logger log = new Logger(StaticOssFirehoseFactory.class);\n+  private static final int MAX_LISTING_LENGTH = 1024;\n+\n+  private final OSS client;\n+  private final List<URI> uris;\n+  private final List<URI> prefixes;\n+\n+  @JsonCreator\n+  public StaticOssFirehoseFactory(\n+      @JacksonInject OSS client,\n+      @JsonProperty(\"uris\") List<URI> uris,\n+      @JsonProperty(\"prefixes\") List<URI> prefixes,\n+      @JsonProperty(\"maxCacheCapacityBytes\") Long maxCacheCapacityBytes,\n+      @JsonProperty(\"maxFetchCapacityBytes\") Long maxFetchCapacityBytes,\n+      @JsonProperty(\"prefetchTriggerBytes\") Long prefetchTriggerBytes,\n+      @JsonProperty(\"fetchTimeout\") Long fetchTimeout,\n+      @JsonProperty(\"maxFetchRetry\") Integer maxFetchRetry\n+  )\n+  {\n+    super(maxCacheCapacityBytes, maxFetchCapacityBytes, prefetchTriggerBytes, fetchTimeout, maxFetchRetry);\n+    this.client = Preconditions.checkNotNull(client, \"client\");\n+    this.uris = uris == null ? new ArrayList<>() : uris;\n+    this.prefixes = prefixes == null ? new ArrayList<>() : prefixes;\n+\n+    if (!this.uris.isEmpty() && !this.prefixes.isEmpty()) {\n+      throw new IAE(\"uris and prefixes cannot be used together\");\n+    }\n+\n+    if (this.uris.isEmpty() && this.prefixes.isEmpty()) {\n+      throw new IAE(\"uris or prefixes must be specified\");\n+    }\n+\n+    for (final URI inputURI : this.uris) {\n+      Preconditions.checkArgument(\"aliyun-oss\".equals(inputURI.getScheme()), \"input uri scheme == aliyun-oss (%s)\", inputURI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU2MzkzOnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/data/input/aliyun/OssInputSource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNToxMDozMFrOGlfzVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0Mzo1MFrOGo-DDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MTU0Mg==", "bodyText": "I think equals/hashcode should have uris, prefixes, etc.", "url": "https://github.com/apache/druid/pull/9898#discussion_r441971542", "createdAt": "2020-06-18T05:10:30Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/data/input/aliyun/OssInputSource.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.fasterxml.jackson.annotation.JacksonInject;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Suppliers;\n+import org.apache.druid.data.input.InputEntity;\n+import org.apache.druid.data.input.InputFileAttribute;\n+import org.apache.druid.data.input.InputSplit;\n+import org.apache.druid.data.input.SplitHintSpec;\n+import org.apache.druid.data.input.impl.CloudObjectInputSource;\n+import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.data.input.impl.SplittableInputSource;\n+import org.apache.druid.storage.aliyun.OssInputDataConfig;\n+import org.apache.druid.storage.aliyun.OssStorageDruidModule;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+import org.apache.druid.utils.Streams;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class OssInputSource extends CloudObjectInputSource\n+{\n+  private final Supplier<OSS> clientSupplier;\n+  @JsonProperty(\"properties\")\n+  private final OssClientConfig inputSourceConfig;\n+  private final OssInputDataConfig inputDataConfig;\n+\n+  /**\n+   * Constructor for OssInputSource\n+   *\n+   * @param client            The default client built with all default configs\n+   *                          from Guice. This injected singleton client is used when {@param inputSourceConfig}\n+   *                          is not provided and hence\n+   * @param inputDataConfig   Stores the configuration for options related to reading input data\n+   * @param uris              User provided uris to read input data\n+   * @param prefixes          User provided prefixes to read input data\n+   * @param objects           User provided cloud objects values to read input data\n+   * @param inputSourceConfig User provided properties for overriding the default aliyun-oss configuration\n+   */\n+  @JsonCreator\n+  public OssInputSource(\n+      @JacksonInject OSS client,\n+      @JacksonInject OssInputDataConfig inputDataConfig,\n+      @JsonProperty(\"uris\") @Nullable List<URI> uris,\n+      @JsonProperty(\"prefixes\") @Nullable List<URI> prefixes,\n+      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects,\n+      @JsonProperty(\"properties\") @Nullable OssClientConfig inputSourceConfig\n+  )\n+  {\n+    super(OssStorageDruidModule.SCHEME, uris, prefixes, objects);\n+    this.inputDataConfig = Preconditions.checkNotNull(inputDataConfig, \"inputDataConfig\");\n+    Preconditions.checkNotNull(client, \"client\");\n+    this.inputSourceConfig = inputSourceConfig;\n+    this.clientSupplier = Suppliers.memoize(\n+        () -> {\n+          if (inputSourceConfig != null) {\n+            return inputSourceConfig.buildClient();\n+          } else {\n+            return client;\n+          }\n+        }\n+    );\n+  }\n+\n+\n+  @Nullable\n+  @JsonProperty(\"properties\")\n+  public OssClientConfig getOssInputSourceConfig()\n+  {\n+    return inputSourceConfig;\n+  }\n+\n+  @Override\n+  protected InputEntity createEntity(CloudObjectLocation location)\n+  {\n+    return new OssEntity(clientSupplier.get(), location);\n+  }\n+\n+  @Override\n+  protected Stream<InputSplit<List<CloudObjectLocation>>> getPrefixesSplitStream(@Nonnull SplitHintSpec splitHintSpec)\n+  {\n+    final Iterator<List<OSSObjectSummary>> splitIterator = splitHintSpec.split(\n+        getIterableObjectsFromPrefixes().iterator(),\n+        object -> new InputFileAttribute(object.getSize())\n+    );\n+\n+    return Streams.sequentialStreamFrom(splitIterator)\n+                  .map(objects -> objects.stream()\n+                                         .map(OssUtils::summaryToCloudObjectLocation)\n+                                         .collect(Collectors.toList()))\n+                  .map(InputSplit::new);\n+  }\n+\n+  @Override\n+  public SplittableInputSource<List<CloudObjectLocation>> withSplit(InputSplit<List<CloudObjectLocation>> split)\n+  {\n+    return new OssInputSource(\n+        clientSupplier.get(),\n+        inputDataConfig,\n+        null,\n+        null,\n+        split.get(),\n+        getOssInputSourceConfig()\n+    );\n+  }\n+\n+  @Override\n+  public int hashCode()\n+  {\n+    return Objects.hash(super.hashCode(), inputSourceConfig);\n+  }\n+\n+  @Override\n+  public boolean equals(Object o)\n+  {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (o == null || getClass() != o.getClass()) {\n+      return false;\n+    }\n+    if (!super.equals(o)) {\n+      return false;\n+    }\n+    OssInputSource that = (OssInputSource) o;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxMjgxMg==", "bodyText": "it's super.equals which checks uris and prefixes", "url": "https://github.com/apache/druid/pull/9898#discussion_r445612812", "createdAt": "2020-06-25T14:43:50Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/data/input/aliyun/OssInputSource.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.data.input.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.fasterxml.jackson.annotation.JacksonInject;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Suppliers;\n+import org.apache.druid.data.input.InputEntity;\n+import org.apache.druid.data.input.InputFileAttribute;\n+import org.apache.druid.data.input.InputSplit;\n+import org.apache.druid.data.input.SplitHintSpec;\n+import org.apache.druid.data.input.impl.CloudObjectInputSource;\n+import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.data.input.impl.SplittableInputSource;\n+import org.apache.druid.storage.aliyun.OssInputDataConfig;\n+import org.apache.druid.storage.aliyun.OssStorageDruidModule;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+import org.apache.druid.utils.Streams;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class OssInputSource extends CloudObjectInputSource\n+{\n+  private final Supplier<OSS> clientSupplier;\n+  @JsonProperty(\"properties\")\n+  private final OssClientConfig inputSourceConfig;\n+  private final OssInputDataConfig inputDataConfig;\n+\n+  /**\n+   * Constructor for OssInputSource\n+   *\n+   * @param client            The default client built with all default configs\n+   *                          from Guice. This injected singleton client is used when {@param inputSourceConfig}\n+   *                          is not provided and hence\n+   * @param inputDataConfig   Stores the configuration for options related to reading input data\n+   * @param uris              User provided uris to read input data\n+   * @param prefixes          User provided prefixes to read input data\n+   * @param objects           User provided cloud objects values to read input data\n+   * @param inputSourceConfig User provided properties for overriding the default aliyun-oss configuration\n+   */\n+  @JsonCreator\n+  public OssInputSource(\n+      @JacksonInject OSS client,\n+      @JacksonInject OssInputDataConfig inputDataConfig,\n+      @JsonProperty(\"uris\") @Nullable List<URI> uris,\n+      @JsonProperty(\"prefixes\") @Nullable List<URI> prefixes,\n+      @JsonProperty(\"objects\") @Nullable List<CloudObjectLocation> objects,\n+      @JsonProperty(\"properties\") @Nullable OssClientConfig inputSourceConfig\n+  )\n+  {\n+    super(OssStorageDruidModule.SCHEME, uris, prefixes, objects);\n+    this.inputDataConfig = Preconditions.checkNotNull(inputDataConfig, \"inputDataConfig\");\n+    Preconditions.checkNotNull(client, \"client\");\n+    this.inputSourceConfig = inputSourceConfig;\n+    this.clientSupplier = Suppliers.memoize(\n+        () -> {\n+          if (inputSourceConfig != null) {\n+            return inputSourceConfig.buildClient();\n+          } else {\n+            return client;\n+          }\n+        }\n+    );\n+  }\n+\n+\n+  @Nullable\n+  @JsonProperty(\"properties\")\n+  public OssClientConfig getOssInputSourceConfig()\n+  {\n+    return inputSourceConfig;\n+  }\n+\n+  @Override\n+  protected InputEntity createEntity(CloudObjectLocation location)\n+  {\n+    return new OssEntity(clientSupplier.get(), location);\n+  }\n+\n+  @Override\n+  protected Stream<InputSplit<List<CloudObjectLocation>>> getPrefixesSplitStream(@Nonnull SplitHintSpec splitHintSpec)\n+  {\n+    final Iterator<List<OSSObjectSummary>> splitIterator = splitHintSpec.split(\n+        getIterableObjectsFromPrefixes().iterator(),\n+        object -> new InputFileAttribute(object.getSize())\n+    );\n+\n+    return Streams.sequentialStreamFrom(splitIterator)\n+                  .map(objects -> objects.stream()\n+                                         .map(OssUtils::summaryToCloudObjectLocation)\n+                                         .collect(Collectors.toList()))\n+                  .map(InputSplit::new);\n+  }\n+\n+  @Override\n+  public SplittableInputSource<List<CloudObjectLocation>> withSplit(InputSplit<List<CloudObjectLocation>> split)\n+  {\n+    return new OssInputSource(\n+        clientSupplier.get(),\n+        inputDataConfig,\n+        null,\n+        null,\n+        split.get(),\n+        getOssInputSourceConfig()\n+    );\n+  }\n+\n+  @Override\n+  public int hashCode()\n+  {\n+    return Objects.hash(super.hashCode(), inputSourceConfig);\n+  }\n+\n+  @Override\n+  public boolean equals(Object o)\n+  {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (o == null || getClass() != o.getClass()) {\n+      return false;\n+    }\n+    if (!super.equals(o)) {\n+      return false;\n+    }\n+    OssInputSource that = (OssInputSource) o;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MTU0Mg=="}, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 155}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU3NjU5OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNToxNzo1OVrOGlf65Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNToxNzo1OVrOGlf65Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MzQ3Nw==", "bodyText": "Suggest renaming this to avoid having the same name as the S3 version", "url": "https://github.com/apache/druid/pull/9898#discussion_r441973477", "createdAt": "2020-06-18T05:17:59Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import org.apache.druid.java.util.common.RE;\n+\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ * Iterator class used by {@link OssUtils#objectSummaryIterator}.\n+ * <p>\n+ * As required by the specification of that method, this iterator is computed incrementally in batches of\n+ * {@code maxListLength}. The first call is made at the same time the iterator is constructed.\n+ *\n+ */\n+public class ObjectSummaryIterator implements Iterator<OSSObjectSummary>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU4NDE3OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNToyMjo0N1rOGlf_nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMTowMzoyMlrOGpczRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDY4NA==", "bodyText": "This should preserve the original javadoc about being adapted from jets3t code:\n   * Adapted from org.jets3t.service.model.StorageObject.isDirectoryPlaceholder(). Does not include the check for\n   * legacy JetS3t directory placeholder objects, since it is based on content-type, which isn't available in an\n   * S3ObjectSummary.\n\nCan you also add an entry noting the usage here?\nhttps://github.com/apache/druid/blob/master/LICENSE#L276", "url": "https://github.com/apache/druid/pull/9898#discussion_r441974684", "createdAt": "2020-06-18T05:22:47Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import org.apache.druid.java.util.common.RE;\n+\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ * Iterator class used by {@link OssUtils#objectSummaryIterator}.\n+ * <p>\n+ * As required by the specification of that method, this iterator is computed incrementally in batches of\n+ * {@code maxListLength}. The first call is made at the same time the iterator is constructed.\n+ *\n+ */\n+public class ObjectSummaryIterator implements Iterator<OSSObjectSummary>\n+{\n+  private final OSS client;\n+  private final Iterator<URI> prefixesIterator;\n+  private final int maxListingLength;\n+\n+  private ListObjectsRequest request;\n+  private ObjectListing result;\n+  private Iterator<OSSObjectSummary> objectSummaryIterator;\n+  private OSSObjectSummary currentObjectSummary;\n+\n+  ObjectSummaryIterator(\n+      final OSS client,\n+      final Iterable<URI> prefixes,\n+      final int maxListingLength\n+  )\n+  {\n+    this.client = client;\n+    this.prefixesIterator = prefixes.iterator();\n+    this.maxListingLength = maxListingLength;\n+\n+    prepareNextRequest();\n+    fetchNextBatch();\n+    advanceObjectSummary();\n+  }\n+\n+  @Override\n+  public boolean hasNext()\n+  {\n+    return currentObjectSummary != null;\n+  }\n+\n+  @Override\n+  public OSSObjectSummary next()\n+  {\n+    if (currentObjectSummary == null) {\n+      throw new NoSuchElementException();\n+    }\n+\n+    final OSSObjectSummary retVal = currentObjectSummary;\n+    advanceObjectSummary();\n+    return retVal;\n+  }\n+\n+  private void prepareNextRequest()\n+  {\n+    final URI currentUri = prefixesIterator.next();\n+    final String currentBucket = currentUri.getAuthority();\n+    final String currentPrefix = OssUtils.extractKey(currentUri);\n+\n+    request = new ListObjectsRequest(currentBucket, currentPrefix, null, null, maxListingLength);\n+  }\n+\n+  private void fetchNextBatch()\n+  {\n+    try {\n+      result = OssUtils.retry(() -> client.listObjects(request));\n+      request.setMarker(result.getNextMarker());\n+      objectSummaryIterator = result.getObjectSummaries().iterator();\n+    }\n+    catch (OSSException e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]; S3 error: %s\",\n+          request.getBucketName(),\n+          request.getPrefix(),\n+          e.getMessage()\n+      );\n+    }\n+    catch (Exception e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]\",\n+          request.getBucketName(),\n+          request.getPrefix()\n+      );\n+    }\n+  }\n+\n+  /**\n+   * Advance objectSummaryIterator to the next non-placeholder, updating \"currentObjectSummary\".\n+   */\n+  private void advanceObjectSummary()\n+  {\n+    while (objectSummaryIterator.hasNext() || result.isTruncated() || prefixesIterator.hasNext()) {\n+      while (objectSummaryIterator.hasNext()) {\n+        currentObjectSummary = objectSummaryIterator.next();\n+        // skips directories and empty objects\n+        if (!isDirectoryPlaceholder(currentObjectSummary) && currentObjectSummary.getSize() > 0) {\n+          return;\n+        }\n+      }\n+\n+      // Exhausted \"objectSummaryIterator\" without finding a non-placeholder.\n+      if (result.isTruncated()) {\n+        fetchNextBatch();\n+      } else if (prefixesIterator.hasNext()) {\n+        prepareNextRequest();\n+        fetchNextBatch();\n+      }\n+    }\n+\n+    // Truly nothing left to read.\n+    currentObjectSummary = null;\n+  }\n+\n+  /**\n+   * Checks if a given object is a directory placeholder and should be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNTI2Nw==", "bodyText": "There's no directory placeholder in aliyun OSS, so I made change to this function. As a result, there's no need to add a declaration to license", "url": "https://github.com/apache/druid/pull/9898#discussion_r445615267", "createdAt": "2020-06-25T14:47:11Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import org.apache.druid.java.util.common.RE;\n+\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ * Iterator class used by {@link OssUtils#objectSummaryIterator}.\n+ * <p>\n+ * As required by the specification of that method, this iterator is computed incrementally in batches of\n+ * {@code maxListLength}. The first call is made at the same time the iterator is constructed.\n+ *\n+ */\n+public class ObjectSummaryIterator implements Iterator<OSSObjectSummary>\n+{\n+  private final OSS client;\n+  private final Iterator<URI> prefixesIterator;\n+  private final int maxListingLength;\n+\n+  private ListObjectsRequest request;\n+  private ObjectListing result;\n+  private Iterator<OSSObjectSummary> objectSummaryIterator;\n+  private OSSObjectSummary currentObjectSummary;\n+\n+  ObjectSummaryIterator(\n+      final OSS client,\n+      final Iterable<URI> prefixes,\n+      final int maxListingLength\n+  )\n+  {\n+    this.client = client;\n+    this.prefixesIterator = prefixes.iterator();\n+    this.maxListingLength = maxListingLength;\n+\n+    prepareNextRequest();\n+    fetchNextBatch();\n+    advanceObjectSummary();\n+  }\n+\n+  @Override\n+  public boolean hasNext()\n+  {\n+    return currentObjectSummary != null;\n+  }\n+\n+  @Override\n+  public OSSObjectSummary next()\n+  {\n+    if (currentObjectSummary == null) {\n+      throw new NoSuchElementException();\n+    }\n+\n+    final OSSObjectSummary retVal = currentObjectSummary;\n+    advanceObjectSummary();\n+    return retVal;\n+  }\n+\n+  private void prepareNextRequest()\n+  {\n+    final URI currentUri = prefixesIterator.next();\n+    final String currentBucket = currentUri.getAuthority();\n+    final String currentPrefix = OssUtils.extractKey(currentUri);\n+\n+    request = new ListObjectsRequest(currentBucket, currentPrefix, null, null, maxListingLength);\n+  }\n+\n+  private void fetchNextBatch()\n+  {\n+    try {\n+      result = OssUtils.retry(() -> client.listObjects(request));\n+      request.setMarker(result.getNextMarker());\n+      objectSummaryIterator = result.getObjectSummaries().iterator();\n+    }\n+    catch (OSSException e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]; S3 error: %s\",\n+          request.getBucketName(),\n+          request.getPrefix(),\n+          e.getMessage()\n+      );\n+    }\n+    catch (Exception e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]\",\n+          request.getBucketName(),\n+          request.getPrefix()\n+      );\n+    }\n+  }\n+\n+  /**\n+   * Advance objectSummaryIterator to the next non-placeholder, updating \"currentObjectSummary\".\n+   */\n+  private void advanceObjectSummary()\n+  {\n+    while (objectSummaryIterator.hasNext() || result.isTruncated() || prefixesIterator.hasNext()) {\n+      while (objectSummaryIterator.hasNext()) {\n+        currentObjectSummary = objectSummaryIterator.next();\n+        // skips directories and empty objects\n+        if (!isDirectoryPlaceholder(currentObjectSummary) && currentObjectSummary.getSize() > 0) {\n+          return;\n+        }\n+      }\n+\n+      // Exhausted \"objectSummaryIterator\" without finding a non-placeholder.\n+      if (result.isTruncated()) {\n+        fetchNextBatch();\n+      } else if (prefixesIterator.hasNext()) {\n+        prepareNextRequest();\n+        fetchNextBatch();\n+      }\n+    }\n+\n+    // Truly nothing left to read.\n+    currentObjectSummary = null;\n+  }\n+\n+  /**\n+   * Checks if a given object is a directory placeholder and should be ignored.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDY4NA=="}, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1NDI5OA==", "bodyText": "@FrankChen021 The code is still derived from jets3t code, so it must be accounted for in LICENSE.", "url": "https://github.com/apache/druid/pull/9898#discussion_r445754298", "createdAt": "2020-06-25T18:26:50Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import org.apache.druid.java.util.common.RE;\n+\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ * Iterator class used by {@link OssUtils#objectSummaryIterator}.\n+ * <p>\n+ * As required by the specification of that method, this iterator is computed incrementally in batches of\n+ * {@code maxListLength}. The first call is made at the same time the iterator is constructed.\n+ *\n+ */\n+public class ObjectSummaryIterator implements Iterator<OSSObjectSummary>\n+{\n+  private final OSS client;\n+  private final Iterator<URI> prefixesIterator;\n+  private final int maxListingLength;\n+\n+  private ListObjectsRequest request;\n+  private ObjectListing result;\n+  private Iterator<OSSObjectSummary> objectSummaryIterator;\n+  private OSSObjectSummary currentObjectSummary;\n+\n+  ObjectSummaryIterator(\n+      final OSS client,\n+      final Iterable<URI> prefixes,\n+      final int maxListingLength\n+  )\n+  {\n+    this.client = client;\n+    this.prefixesIterator = prefixes.iterator();\n+    this.maxListingLength = maxListingLength;\n+\n+    prepareNextRequest();\n+    fetchNextBatch();\n+    advanceObjectSummary();\n+  }\n+\n+  @Override\n+  public boolean hasNext()\n+  {\n+    return currentObjectSummary != null;\n+  }\n+\n+  @Override\n+  public OSSObjectSummary next()\n+  {\n+    if (currentObjectSummary == null) {\n+      throw new NoSuchElementException();\n+    }\n+\n+    final OSSObjectSummary retVal = currentObjectSummary;\n+    advanceObjectSummary();\n+    return retVal;\n+  }\n+\n+  private void prepareNextRequest()\n+  {\n+    final URI currentUri = prefixesIterator.next();\n+    final String currentBucket = currentUri.getAuthority();\n+    final String currentPrefix = OssUtils.extractKey(currentUri);\n+\n+    request = new ListObjectsRequest(currentBucket, currentPrefix, null, null, maxListingLength);\n+  }\n+\n+  private void fetchNextBatch()\n+  {\n+    try {\n+      result = OssUtils.retry(() -> client.listObjects(request));\n+      request.setMarker(result.getNextMarker());\n+      objectSummaryIterator = result.getObjectSummaries().iterator();\n+    }\n+    catch (OSSException e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]; S3 error: %s\",\n+          request.getBucketName(),\n+          request.getPrefix(),\n+          e.getMessage()\n+      );\n+    }\n+    catch (Exception e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]\",\n+          request.getBucketName(),\n+          request.getPrefix()\n+      );\n+    }\n+  }\n+\n+  /**\n+   * Advance objectSummaryIterator to the next non-placeholder, updating \"currentObjectSummary\".\n+   */\n+  private void advanceObjectSummary()\n+  {\n+    while (objectSummaryIterator.hasNext() || result.isTruncated() || prefixesIterator.hasNext()) {\n+      while (objectSummaryIterator.hasNext()) {\n+        currentObjectSummary = objectSummaryIterator.next();\n+        // skips directories and empty objects\n+        if (!isDirectoryPlaceholder(currentObjectSummary) && currentObjectSummary.getSize() > 0) {\n+          return;\n+        }\n+      }\n+\n+      // Exhausted \"objectSummaryIterator\" without finding a non-placeholder.\n+      if (result.isTruncated()) {\n+        fetchNextBatch();\n+      } else if (prefixesIterator.hasNext()) {\n+        prepareNextRequest();\n+        fetchNextBatch();\n+      }\n+    }\n+\n+    // Truly nothing left to read.\n+    currentObjectSummary = null;\n+  }\n+\n+  /**\n+   * Checks if a given object is a directory placeholder and should be ignored.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDY4NA=="}, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNjY3Ng==", "bodyText": "@jon-wei  LICENSE has been updated in the latest commit, please check it again.", "url": "https://github.com/apache/druid/pull/9898#discussion_r446116676", "createdAt": "2020-06-26T11:03:22Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/ObjectSummaryIterator.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import org.apache.druid.java.util.common.RE;\n+\n+import java.net.URI;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ * Iterator class used by {@link OssUtils#objectSummaryIterator}.\n+ * <p>\n+ * As required by the specification of that method, this iterator is computed incrementally in batches of\n+ * {@code maxListLength}. The first call is made at the same time the iterator is constructed.\n+ *\n+ */\n+public class ObjectSummaryIterator implements Iterator<OSSObjectSummary>\n+{\n+  private final OSS client;\n+  private final Iterator<URI> prefixesIterator;\n+  private final int maxListingLength;\n+\n+  private ListObjectsRequest request;\n+  private ObjectListing result;\n+  private Iterator<OSSObjectSummary> objectSummaryIterator;\n+  private OSSObjectSummary currentObjectSummary;\n+\n+  ObjectSummaryIterator(\n+      final OSS client,\n+      final Iterable<URI> prefixes,\n+      final int maxListingLength\n+  )\n+  {\n+    this.client = client;\n+    this.prefixesIterator = prefixes.iterator();\n+    this.maxListingLength = maxListingLength;\n+\n+    prepareNextRequest();\n+    fetchNextBatch();\n+    advanceObjectSummary();\n+  }\n+\n+  @Override\n+  public boolean hasNext()\n+  {\n+    return currentObjectSummary != null;\n+  }\n+\n+  @Override\n+  public OSSObjectSummary next()\n+  {\n+    if (currentObjectSummary == null) {\n+      throw new NoSuchElementException();\n+    }\n+\n+    final OSSObjectSummary retVal = currentObjectSummary;\n+    advanceObjectSummary();\n+    return retVal;\n+  }\n+\n+  private void prepareNextRequest()\n+  {\n+    final URI currentUri = prefixesIterator.next();\n+    final String currentBucket = currentUri.getAuthority();\n+    final String currentPrefix = OssUtils.extractKey(currentUri);\n+\n+    request = new ListObjectsRequest(currentBucket, currentPrefix, null, null, maxListingLength);\n+  }\n+\n+  private void fetchNextBatch()\n+  {\n+    try {\n+      result = OssUtils.retry(() -> client.listObjects(request));\n+      request.setMarker(result.getNextMarker());\n+      objectSummaryIterator = result.getObjectSummaries().iterator();\n+    }\n+    catch (OSSException e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]; S3 error: %s\",\n+          request.getBucketName(),\n+          request.getPrefix(),\n+          e.getMessage()\n+      );\n+    }\n+    catch (Exception e) {\n+      throw new RE(\n+          e,\n+          \"Failed to get object summaries from S3 bucket[%s], prefix[%s]\",\n+          request.getBucketName(),\n+          request.getPrefix()\n+      );\n+    }\n+  }\n+\n+  /**\n+   * Advance objectSummaryIterator to the next non-placeholder, updating \"currentObjectSummary\".\n+   */\n+  private void advanceObjectSummary()\n+  {\n+    while (objectSummaryIterator.hasNext() || result.isTruncated() || prefixesIterator.hasNext()) {\n+      while (objectSummaryIterator.hasNext()) {\n+        currentObjectSummary = objectSummaryIterator.next();\n+        // skips directories and empty objects\n+        if (!isDirectoryPlaceholder(currentObjectSummary) && currentObjectSummary.getSize() > 0) {\n+          return;\n+        }\n+      }\n+\n+      // Exhausted \"objectSummaryIterator\" without finding a non-placeholder.\n+      if (result.isTruncated()) {\n+        fetchNextBatch();\n+      } else if (prefixesIterator.hasNext()) {\n+        prepareNextRequest();\n+        fetchNextBatch();\n+      }\n+    }\n+\n+    // Truly nothing left to read.\n+    currentObjectSummary = null;\n+  }\n+\n+  /**\n+   * Checks if a given object is a directory placeholder and should be ignored.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDY4NA=="}, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 147}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU5OTMyOnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssDataSegmentPusher.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNTozMDo1MFrOGlgIiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0ODo0MlrOGo-RNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3Njk3MQ==", "bodyText": "Have you tested this with a Hadoop cluster before? If so, cool. If not, that's fine, we can just document that Hadoop is untested with it.", "url": "https://github.com/apache/druid/pull/9898#discussion_r441976971", "createdAt": "2020-06-18T05:30:50Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssDataSegmentPusher.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Inject;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.java.util.emitter.EmittingLogger;\n+import org.apache.druid.segment.SegmentUtils;\n+import org.apache.druid.segment.loading.DataSegmentPusher;\n+import org.apache.druid.timeline.DataSegment;\n+import org.apache.druid.utils.CompressionUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class OssDataSegmentPusher implements DataSegmentPusher\n+{\n+  private static final EmittingLogger log = new EmittingLogger(OssDataSegmentPusher.class);\n+\n+  private final OSS client;\n+  private final OssStorageConfig config;\n+\n+  @Inject\n+  public OssDataSegmentPusher(\n+      OSS client,\n+      OssStorageConfig config\n+  )\n+  {\n+    this.client = client;\n+    this.config = config;\n+  }\n+\n+  @Override\n+  public String getPathForHadoop()\n+  {\n+    return StringUtils.format(\"%s/%s\", config.getBucket(), config.getPrefix());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjQzOQ==", "bodyText": "It has not been tested in hadoop cluster yet, because in our test environment, all data are ingested from kafka.", "url": "https://github.com/apache/druid/pull/9898#discussion_r445616439", "createdAt": "2020-06-25T14:48:42Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssDataSegmentPusher.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Inject;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.java.util.emitter.EmittingLogger;\n+import org.apache.druid.segment.SegmentUtils;\n+import org.apache.druid.segment.loading.DataSegmentPusher;\n+import org.apache.druid.timeline.DataSegment;\n+import org.apache.druid.utils.CompressionUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class OssDataSegmentPusher implements DataSegmentPusher\n+{\n+  private static final EmittingLogger log = new EmittingLogger(OssDataSegmentPusher.class);\n+\n+  private final OSS client;\n+  private final OssStorageConfig config;\n+\n+  @Inject\n+  public OssDataSegmentPusher(\n+      OSS client,\n+      OssStorageConfig config\n+  )\n+  {\n+    this.client = client;\n+    this.config = config;\n+  }\n+\n+  @Override\n+  public String getPathForHadoop()\n+  {\n+    return StringUtils.format(\"%s/%s\", config.getBucket(), config.getPrefix());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3Njk3MQ=="}, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzYxNjg1OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssStorageDruidModule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNTo0MDo1N1rOGlgTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNTo0MDo1N1rOGlgTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3OTgwMQ==", "bodyText": "If there's only one aliyun URI scheme, this binding isn't needed", "url": "https://github.com/apache/druid/pull/9898#discussion_r441979801", "createdAt": "2020-06-18T05:40:57Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssStorageDruidModule.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.fasterxml.jackson.core.Version;\n+import com.fasterxml.jackson.databind.Module;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Binder;\n+import com.google.inject.Provides;\n+import com.google.inject.multibindings.MapBinder;\n+import org.apache.druid.data.SearchableVersionedDataFinder;\n+import org.apache.druid.data.input.aliyun.OssClientConfig;\n+import org.apache.druid.guice.Binders;\n+import org.apache.druid.guice.JsonConfigProvider;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.initialization.DruidModule;\n+\n+import java.util.List;\n+\n+public class OssStorageDruidModule implements DruidModule\n+{\n+  public static final String SCHEME = \"aliyun-oss\";\n+  public static final String SCHEME_S3N = \"aliyun-oss_3n\";\n+  public static final String SCHEME_ZIP = \"aliyun-oss_zip\";\n+\n+  @Override\n+  public List<? extends Module> getJacksonModules()\n+  {\n+    return ImmutableList.of(\n+        new Module()\n+        {\n+          @Override\n+          public String getModuleName()\n+          {\n+            return \"DruidOss-\" + System.identityHashCode(this);\n+          }\n+\n+          @Override\n+          public Version version()\n+          {\n+            return Version.unknownVersion();\n+          }\n+\n+          @Override\n+          public void setupModule(SetupContext context)\n+          {\n+            context.registerSubtypes(OssLoadSpec.class);\n+          }\n+        }\n+    );\n+  }\n+\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    MapBinder.newMapBinder(binder, String.class, SearchableVersionedDataFinder.class)\n+             .addBinding(SCHEME)\n+             .to(OssTimestampVersionedDataFinder.class)\n+             .in(LazySingleton.class);\n+    MapBinder.newMapBinder(binder, String.class, SearchableVersionedDataFinder.class)\n+             .addBinding(SCHEME_S3N)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzYyMDUyOnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNTo0MzowNFrOGlgV6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNTo0MzowNFrOGlgV6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4MDM5NQ==", "bodyText": "Please remove the unused code", "url": "https://github.com/apache/druid/pull/9898#discussion_r441980395", "createdAt": "2020-06-18T05:43:04Z", "author": {"login": "jon-wei"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssUtils.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.AccessControlList;\n+import com.aliyun.oss.model.CannedAccessControlList;\n+import com.aliyun.oss.model.DeleteObjectsRequest;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import com.aliyun.oss.model.PutObjectRequest;\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.druid.data.input.impl.CloudObjectLocation;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.RetryUtils;\n+import org.apache.druid.java.util.common.RetryUtils.Task;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.java.util.common.logger.Logger;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+public class OssUtils\n+{\n+  private static final String SCHEME = OssStorageDruidModule.SCHEME;\n+  private static final Joiner JOINER = Joiner.on(\"/\").skipNulls();\n+  private static final Logger log = new Logger(OssUtils.class);\n+\n+\n+  static boolean isServiceExceptionRecoverable(OSSException ex)\n+  {\n+    final boolean isIOException = ex.getCause() instanceof IOException;\n+    final boolean isTimeout = \"RequestTimeout\".equals(ex.getErrorCode());\n+    final boolean badStatusCode = false; //ex. == 400 || ex.getStatusCode() == 403 || ex.getStatusCode() == 404;\n+    return !badStatusCode && (isIOException || isTimeout);\n+  }\n+\n+  public static final Predicate<Throwable> RETRYABLE = new Predicate<Throwable>()\n+  {\n+    @Override\n+    public boolean apply(Throwable e)\n+    {\n+      if (e == null) {\n+        return false;\n+      } else if (e instanceof IOException) {\n+        return true;\n+      } else if (e instanceof OSSException) {\n+        return isServiceExceptionRecoverable((OSSException) e);\n+      } else {\n+        return apply(e.getCause());\n+      }\n+    }\n+  };\n+\n+  /**\n+   * Retries aliyun-oss operations that fail due to io-related exceptions. Service-level exceptions (access denied, file not\n+   * found, etc) are not retried.\n+   */\n+  static <T> T retry(Task<T> f) throws Exception\n+  {\n+    return RetryUtils.retry(f, RETRYABLE, RetryUtils.DEFAULT_MAX_TRIES);\n+  }\n+\n+  static boolean isObjectInBucketIgnoringPermission(\n+      OSS client,\n+      String bucketName,\n+      String objectKey\n+  )\n+  {\n+    try {\n+      return client.doesObjectExist(bucketName, objectKey);\n+    }\n+    catch (OSSException e) {\n+      if (e.getErrorCode().equals(\"NoSuchKey\")) {\n+        // Object is inaccessible to current user, but does exist.\n+        return true;\n+      }\n+      // Something else has gone wrong\n+      throw e;\n+    }\n+  }\n+\n+  /**\n+   * Create an iterator over a set of aliyun-oss objects specified by a set of prefixes.\n+   * <p>\n+   * For each provided prefix URI, the iterator will walk through all objects that are in the same bucket as the\n+   * provided URI and whose keys start with that URI's path, except for directory placeholders (which will be\n+   * ignored). The iterator is computed incrementally by calling {@link OSS#listObjects} for\n+   * each prefix in batches of {@param maxListLength}. The first call is made at the same time the iterator is\n+   * constructed.\n+   */\n+  public static Iterator<OSSObjectSummary> objectSummaryIterator(\n+      final OSS client,\n+      final Iterable<URI> prefixes,\n+      final int maxListingLength\n+  )\n+  {\n+    return new ObjectSummaryIterator(client, prefixes, maxListingLength);\n+  }\n+\n+  /**\n+   * Create an {@link URI} from the given {@link OSSObjectSummary}. The result URI is composed as below.\n+   *\n+   * <pre>\n+   * {@code aliyun-oss://{BUCKET_NAME}/{OBJECT_KEY}}\n+   * </pre>\n+   */\n+  public static URI summaryToUri(OSSObjectSummary object)\n+  {\n+    return summaryToCloudObjectLocation(object).toUri(SCHEME);\n+  }\n+\n+  public static CloudObjectLocation summaryToCloudObjectLocation(OSSObjectSummary object)\n+  {\n+    return new CloudObjectLocation(object.getBucketName(), object.getKey());\n+  }\n+\n+  static String constructSegmentPath(String baseKey, String storageDir)\n+  {\n+    return JOINER.join(\n+        baseKey.isEmpty() ? null : baseKey,\n+        storageDir\n+    ) + \"/index.zip\";\n+  }\n+\n+  static CannedAccessControlList grantFullControlToBucketOwner(OSS client, String bucket)\n+  {\n+    final AccessControlList acl = client.getBucketAcl(bucket);\n+    return acl.getCannedACL();\n+    //acl.grantAllPermissions(new Grant(new Grantee(acl.getOwner().getId()), Permission.FullControl));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a9e25e5a4397ec0bd43a547d87ba7357af6eb1"}, "originalPosition": 155}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODM1NDgzOnYy", "diffSide": "RIGHT", "path": "integration-tests/src/test/java/org/apache/druid/tests/TestNGGroup.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMzo0NDo0MlrOGqqjCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjozODoyNlrOGrYrFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM5MDQ3Mw==", "bodyText": "nit: azure -> aliyun", "url": "https://github.com/apache/druid/pull/9898#discussion_r447390473", "createdAt": "2020-06-30T03:44:42Z", "author": {"login": "clintropolis"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/TestNGGroup.java", "diffHunk": "@@ -76,6 +76,13 @@\n    */\n   public static final String AZURE_DEEP_STORAGE = \"azure-deep-storage\";\n \n+  /**\n+   * This group is not part of CI. To run this group, azure configs/credentials for your azure must be provided in a file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE0NjE5OA==", "bodyText": "it's been fixed", "url": "https://github.com/apache/druid/pull/9898#discussion_r448146198", "createdAt": "2020-07-01T06:38:26Z", "author": {"login": "FrankChen021"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/TestNGGroup.java", "diffHunk": "@@ -76,6 +76,13 @@\n    */\n   public static final String AZURE_DEEP_STORAGE = \"azure-deep-storage\";\n \n+  /**\n+   * This group is not part of CI. To run this group, azure configs/credentials for your azure must be provided in a file.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM5MDQ3Mw=="}, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODQ3Mzg3OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssTaskLogsTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNDo1MToxNFrOGqrm3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjozODozOFrOGrYrdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzgzNg==", "bodyText": "Should be oss instead of s3.", "url": "https://github.com/apache/druid/pull/9898#discussion_r447407836", "createdAt": "2020-06-30T04:51:14Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssTaskLogsTest.java", "diffHunk": "@@ -0,0 +1,336 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.ClientException;\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.model.AccessControlList;\n+import com.aliyun.oss.model.DeleteObjectsRequest;\n+import com.aliyun.oss.model.Grant;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.Owner;\n+import com.aliyun.oss.model.PutObjectRequest;\n+import com.aliyun.oss.model.PutObjectResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.common.utils.CurrentTimeMillisSupplier;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.easymock.EasyMock;\n+import org.easymock.EasyMockRunner;\n+import org.easymock.EasyMockSupport;\n+import org.easymock.Mock;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@RunWith(EasyMockRunner.class)\n+public class OssTaskLogsTest extends EasyMockSupport\n+{\n+\n+  private static final String KEY_1 = \"key1\";\n+  private static final String KEY_2 = \"key2\";\n+  private static final String TEST_BUCKET = \"test_bucket\";\n+  private static final String TEST_PREFIX = \"test_prefix\";\n+  private static final URI PREFIX_URI = URI.create(StringUtils.format(\"s3://%s/%s\", TEST_BUCKET, TEST_PREFIX));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE0NjI5NQ==", "bodyText": "it's been fixed", "url": "https://github.com/apache/druid/pull/9898#discussion_r448146295", "createdAt": "2020-07-01T06:38:38Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssTaskLogsTest.java", "diffHunk": "@@ -0,0 +1,336 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.ClientException;\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.model.AccessControlList;\n+import com.aliyun.oss.model.DeleteObjectsRequest;\n+import com.aliyun.oss.model.Grant;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.Owner;\n+import com.aliyun.oss.model.PutObjectRequest;\n+import com.aliyun.oss.model.PutObjectResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.common.utils.CurrentTimeMillisSupplier;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.easymock.EasyMock;\n+import org.easymock.EasyMockRunner;\n+import org.easymock.EasyMockSupport;\n+import org.easymock.Mock;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+@RunWith(EasyMockRunner.class)\n+public class OssTaskLogsTest extends EasyMockSupport\n+{\n+\n+  private static final String KEY_1 = \"key1\";\n+  private static final String KEY_2 = \"key2\";\n+  private static final String TEST_BUCKET = \"test_bucket\";\n+  private static final String TEST_PREFIX = \"test_prefix\";\n+  private static final URI PREFIX_URI = URI.create(StringUtils.format(\"s3://%s/%s\", TEST_BUCKET, TEST_PREFIX));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzgzNg=="}, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODQ3NjU4OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssDataSegmentMoverTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNDo1Mjo1NFrOGqrofg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjo0MzozMFrOGrY0CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwODI1NA==", "bodyText": "nit: I see many variable names containing s3. They are all found in only unit tests and don't affect to production code, but would be nice to clean them up.", "url": "https://github.com/apache/druid/pull/9898#discussion_r447408254", "createdAt": "2020-06-30T04:52:54Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssDataSegmentMoverTest.java", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSSClient;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.CopyObjectRequest;\n+import com.aliyun.oss.model.CopyObjectResult;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import com.aliyun.oss.model.PutObjectResult;\n+import com.aliyun.oss.model.StorageClass;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.java.util.common.Intervals;\n+import org.apache.druid.java.util.common.MapUtils;\n+import org.apache.druid.segment.loading.SegmentLoadingException;\n+import org.apache.druid.timeline.DataSegment;\n+import org.apache.druid.timeline.partition.NoneShardSpec;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+public class OssDataSegmentMoverTest\n+{\n+  private static final DataSegment SOURCE_SEGMENT = new DataSegment(\n+      \"test\",\n+      Intervals.of(\"2013-01-01/2013-01-02\"),\n+      \"1\",\n+      ImmutableMap.of(\n+          \"key\",\n+          \"baseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\",\n+          \"bucket\",\n+          \"main\"\n+      ),\n+      ImmutableList.of(\"dim1\", \"dim1\"),\n+      ImmutableList.of(\"metric1\", \"metric2\"),\n+      NoneShardSpec.instance(),\n+      0,\n+      1\n+  );\n+\n+  @Test\n+  public void testMove() throws Exception\n+  {\n+    MockClient mockClient = new MockClient();\n+    OssDataSegmentMover mover = new OssDataSegmentMover(mockClient, new OssStorageConfig());\n+\n+    mockClient.putObject(\n+        \"main\",\n+        \"baseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\"\n+    );\n+\n+    DataSegment movedSegment = mover.move(\n+        SOURCE_SEGMENT,\n+        ImmutableMap.of(\"baseKey\", \"targetBaseKey\", \"bucket\", \"archive\")\n+    );\n+\n+    Map<String, Object> targetLoadSpec = movedSegment.getLoadSpec();\n+    Assert.assertEquals(\n+        \"targetBaseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\",\n+        MapUtils.getString(targetLoadSpec, \"key\")\n+    );\n+    Assert.assertEquals(\"archive\", MapUtils.getString(targetLoadSpec, \"bucket\"));\n+    Assert.assertTrue(mockClient.didMove());\n+  }\n+\n+  @Test\n+  public void testMoveNoop() throws Exception\n+  {\n+    MockClient mockS3Client = new MockClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE0ODQ4OA==", "bodyText": "all s3 in  this extension have been fixed", "url": "https://github.com/apache/druid/pull/9898#discussion_r448148488", "createdAt": "2020-07-01T06:43:30Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/test/java/org/apache/druid/storage/aliyun/OssDataSegmentMoverTest.java", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSSClient;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.CopyObjectRequest;\n+import com.aliyun.oss.model.CopyObjectResult;\n+import com.aliyun.oss.model.ListObjectsRequest;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.aliyun.oss.model.ObjectListing;\n+import com.aliyun.oss.model.PutObjectResult;\n+import com.aliyun.oss.model.StorageClass;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.java.util.common.Intervals;\n+import org.apache.druid.java.util.common.MapUtils;\n+import org.apache.druid.segment.loading.SegmentLoadingException;\n+import org.apache.druid.timeline.DataSegment;\n+import org.apache.druid.timeline.partition.NoneShardSpec;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+public class OssDataSegmentMoverTest\n+{\n+  private static final DataSegment SOURCE_SEGMENT = new DataSegment(\n+      \"test\",\n+      Intervals.of(\"2013-01-01/2013-01-02\"),\n+      \"1\",\n+      ImmutableMap.of(\n+          \"key\",\n+          \"baseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\",\n+          \"bucket\",\n+          \"main\"\n+      ),\n+      ImmutableList.of(\"dim1\", \"dim1\"),\n+      ImmutableList.of(\"metric1\", \"metric2\"),\n+      NoneShardSpec.instance(),\n+      0,\n+      1\n+  );\n+\n+  @Test\n+  public void testMove() throws Exception\n+  {\n+    MockClient mockClient = new MockClient();\n+    OssDataSegmentMover mover = new OssDataSegmentMover(mockClient, new OssStorageConfig());\n+\n+    mockClient.putObject(\n+        \"main\",\n+        \"baseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\"\n+    );\n+\n+    DataSegment movedSegment = mover.move(\n+        SOURCE_SEGMENT,\n+        ImmutableMap.of(\"baseKey\", \"targetBaseKey\", \"bucket\", \"archive\")\n+    );\n+\n+    Map<String, Object> targetLoadSpec = movedSegment.getLoadSpec();\n+    Assert.assertEquals(\n+        \"targetBaseKey/test/2013-01-01T00:00:00.000Z_2013-01-02T00:00:00.000Z/1/0/index.zip\",\n+        MapUtils.getString(targetLoadSpec, \"key\")\n+    );\n+    Assert.assertEquals(\"archive\", MapUtils.getString(targetLoadSpec, \"bucket\"));\n+    Assert.assertTrue(mockClient.didMove());\n+  }\n+\n+  @Test\n+  public void testMoveNoop() throws Exception\n+  {\n+    MockClient mockS3Client = new MockClient();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwODI1NA=="}, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODQ5Njg5OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/firehose/aliyun/StaticOssFirehoseFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNTowNDoxOFrOGqr0jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjo0NzozNlrOGrY6jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxMTM0MQ==", "bodyText": "nit: FiniteFirehoseFactory is deprecated and it's not recommend to implement it. You can keep this implementation if you want, but it can be deleted sooner or later.", "url": "https://github.com/apache/druid/pull/9898#discussion_r447411341", "createdAt": "2020-06-30T05:04:18Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/firehose/aliyun/StaticOssFirehoseFactory.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.firehose.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.GetObjectRequest;\n+import com.aliyun.oss.model.OSSObject;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.fasterxml.jackson.annotation.JacksonInject;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Predicate;\n+import org.apache.druid.data.input.FiniteFirehoseFactory;\n+import org.apache.druid.data.input.InputSplit;\n+import org.apache.druid.data.input.impl.StringInputRowParser;\n+import org.apache.druid.data.input.impl.prefetch.PrefetchableTextFilesFirehoseFactory;\n+import org.apache.druid.java.util.common.IAE;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.logger.Logger;\n+import org.apache.druid.storage.aliyun.OssStorageDruidModule;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+import org.apache.druid.utils.CompressionUtils;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Builds firehoses that read from a predefined list of aliyun OSS objects and then dry up.\n+ */\n+public class StaticOssFirehoseFactory extends PrefetchableTextFilesFirehoseFactory<URI>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE1MDE1OA==", "bodyText": "it's kept for further deletion :)", "url": "https://github.com/apache/druid/pull/9898#discussion_r448150158", "createdAt": "2020-07-01T06:47:36Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/firehose/aliyun/StaticOssFirehoseFactory.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.firehose.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.aliyun.oss.OSSException;\n+import com.aliyun.oss.model.GetObjectRequest;\n+import com.aliyun.oss.model.OSSObject;\n+import com.aliyun.oss.model.OSSObjectSummary;\n+import com.fasterxml.jackson.annotation.JacksonInject;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Predicate;\n+import org.apache.druid.data.input.FiniteFirehoseFactory;\n+import org.apache.druid.data.input.InputSplit;\n+import org.apache.druid.data.input.impl.StringInputRowParser;\n+import org.apache.druid.data.input.impl.prefetch.PrefetchableTextFilesFirehoseFactory;\n+import org.apache.druid.java.util.common.IAE;\n+import org.apache.druid.java.util.common.ISE;\n+import org.apache.druid.java.util.common.logger.Logger;\n+import org.apache.druid.storage.aliyun.OssStorageDruidModule;\n+import org.apache.druid.storage.aliyun.OssUtils;\n+import org.apache.druid.utils.CompressionUtils;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Builds firehoses that read from a predefined list of aliyun OSS objects and then dry up.\n+ */\n+public class StaticOssFirehoseFactory extends PrefetchableTextFilesFirehoseFactory<URI>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxMTM0MQ=="}, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODUwMTA2OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssStorageDruidModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNTowNjoxOFrOGqr2-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjo0NzozOVrOGrY6pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxMTk2Mg==", "bodyText": "nit: hmm, DruidOss sounds like Druid open source software. Maybe DruidAliyunOss is better?", "url": "https://github.com/apache/druid/pull/9898#discussion_r447411962", "createdAt": "2020-06-30T05:06:18Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssStorageDruidModule.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.fasterxml.jackson.core.Version;\n+import com.fasterxml.jackson.databind.Module;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Binder;\n+import com.google.inject.Provides;\n+import com.google.inject.multibindings.MapBinder;\n+import org.apache.druid.data.SearchableVersionedDataFinder;\n+import org.apache.druid.data.input.aliyun.OssClientConfig;\n+import org.apache.druid.guice.Binders;\n+import org.apache.druid.guice.JsonConfigProvider;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.initialization.DruidModule;\n+\n+import java.util.List;\n+\n+public class OssStorageDruidModule implements DruidModule\n+{\n+  public static final String SCHEME = \"oss\";\n+  public static final String SCHEME_ZIP = \"oss_zip\";\n+\n+  @Override\n+  public List<? extends Module> getJacksonModules()\n+  {\n+    return ImmutableList.of(\n+        new Module()\n+        {\n+          @Override\n+          public String getModuleName()\n+          {\n+            return \"DruidOss-\" + System.identityHashCode(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE1MDE4Mg==", "bodyText": "it's been fixed.", "url": "https://github.com/apache/druid/pull/9898#discussion_r448150182", "createdAt": "2020-07-01T06:47:39Z", "author": {"login": "FrankChen021"}, "path": "extensions-contrib/aliyun-oss-extensions/src/main/java/org/apache/druid/storage/aliyun/OssStorageDruidModule.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.storage.aliyun;\n+\n+import com.aliyun.oss.OSS;\n+import com.fasterxml.jackson.core.Version;\n+import com.fasterxml.jackson.databind.Module;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Binder;\n+import com.google.inject.Provides;\n+import com.google.inject.multibindings.MapBinder;\n+import org.apache.druid.data.SearchableVersionedDataFinder;\n+import org.apache.druid.data.input.aliyun.OssClientConfig;\n+import org.apache.druid.guice.Binders;\n+import org.apache.druid.guice.JsonConfigProvider;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.initialization.DruidModule;\n+\n+import java.util.List;\n+\n+public class OssStorageDruidModule implements DruidModule\n+{\n+  public static final String SCHEME = \"oss\";\n+  public static final String SCHEME_ZIP = \"oss_zip\";\n+\n+  @Override\n+  public List<? extends Module> getJacksonModules()\n+  {\n+    return ImmutableList.of(\n+        new Module()\n+        {\n+          @Override\n+          public String getModuleName()\n+          {\n+            return \"DruidOss-\" + System.identityHashCode(this);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxMTk2Mg=="}, "originalCommit": {"oid": "b09263fbfaebe441b40c7287d097436d7b14fa57"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2457, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}