{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjg2MDA2", "number": 10085, "title": "Filter http requests by http method", "bodyText": "Description\nAdd a config that allows a user which http methods to allow against their\nDruid server.\nDruid will only accept http requests with the method: GET, PUT, POST, DELETE\nand OPTIONS.\nIf a Druid admin wants to allow other methods, they can do so by using the\nServerConfig#allowedHttpMethods config.\nIf a Druid user would like to disallow OPTIONS, this can be done by changing\nthe AuthConfig#allowUnauthenticatedHttpOptions config\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.\n\n\nKey changed/added classes in this PR\n\nAllowHttpMethodsResourceFilter", "createdAt": "2020-06-26T16:48:53Z", "url": "https://github.com/apache/druid/pull/10085", "merged": true, "mergeCommit": {"oid": "15a0b4ffe21a39d830504153033529523e3d69c6"}, "closed": true, "closedAt": "2020-06-29T23:59:32Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvGGVGAH2gAyNDQwNjg2MDA2OjAxZTJlZmYyY2VjNDY4MWQ3ZWU3NDFiZTZlNDAwMjIwYzZhMTFhZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwHNcaAH2gAyNDQwNjg2MDA2Ojg1NzQ0Mzg2NmZmNDdmZWIwMzRlZGVhMjMzZGIwNTQ4Y2E4Y2E4Mjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/01e2eff2cec4681d7ee741be6e400220c6a11af7", "committedDate": "2020-06-26T16:46:52Z", "message": "Filter http requests by http method\n\nAdd a config that allows a user which http methods to allow against their\nDruid server.\n\nDruid will only accept http requests with the method: GET, PUT, POST, DELETE\nand OPTIONS.\nIf a Druid admin wants to allow other methods, they can do so by using the\nServerConfig#allowedHttpMethods config.\n\nIf a Druid user would like to disallow OPTIONS, this can be done by changing\nthe AuthConfig#allowUnauthenticatedHttpOptions config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDU4MjI3", "url": "https://github.com/apache/druid/pull/10085#pullrequestreview-438458227", "createdAt": "2020-06-26T17:05:47Z", "commit": {"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzowNTo0N1rOGpoVBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzowODowN1rOGpoZJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNTU0Mw==", "bodyText": "\"HTTP\" should be capitalized when it appears in normal text like this.", "url": "https://github.com/apache/druid/pull/10085#discussion_r446305543", "createdAt": "2020-06-26T17:05:47Z", "author": {"login": "gianm"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1312,6 +1312,7 @@ Druid uses Jetty to serve HTTP requests.\n |`druid.server.http.maxQueryTimeout`|Maximum allowed value (in milliseconds) for `timeout` parameter. See [query-context](../querying/query-context.html) to know more about `timeout`. Query is rejected if the query context `timeout` is greater than this value. |Long.MAX_VALUE|\n |`druid.server.http.maxRequestHeaderSize`|Maximum size of a request header in bytes. Larger headers consume more memory and can make a server more vulnerable to denial of service attacks.|8 * 1024|\n |`druid.server.http.enableForwardedRequestCustomizer`|If enabled, adds Jetty ForwardedRequestCustomizer which reads X-Forwarded-* request headers to manipulate servlet request object when Druid is used behind a proxy.|false|\n+|`druid.server.http.allowedHttpMethods`|List of http methods allowed in addition to the ones needed by Druid. GET, PUT, POST, DELETE and OPTIONS are always allowed. `druid.auth.allowUnauthenticatedHttpOptions` can be used to disable the OPTIONS method.|[]|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNjU5OQ==", "bodyText": "A couple things about the design of the properties:\n\nI don't think Druid itself uses OPTIONS requests. AFAIK, they are only needed for people that are using CORS, which Druid doesn't support innately but can be supported through extensions: #6026. So, OPTIONS shouldn't be part of the \"always allowed\" list.\ndruid.auth.allowUnauthenticatedHttpOptions today can't be used to disable OPTIONS, it only controls whether or not it can be used without authentication.\n\nTaking these into account, I'd suggest designing and documenting them like this:\n\n\n\nProperty\nDescription\nDefault\n\n\n\n\ndruid.server.http.allowedHttpMethods\nList of HTTP methods that should be allowed in addition to the ones required by Druid APIs. Druid APIs require GET, PUT, POST, and DELETE, which are always allowed. This option is not useful unless you have installed an extension that needs these additional HTTP methods or that adds functionality related to CORS. None of Druid's bundled extensions require these methods.\n[]\n\n\ndruid.auth.allowUnauthenticatedHttpOptions\nIf true, allow HTTP OPTIONS requests by unauthenticated users. This is primarily useful for supporting CORS preflight requests, which Druid does not support directly, but which can be enabled using third-party extensions.Note that you must add \"OPTIONS\" to druid.server.http.allowedHttpMethods.Also note that disabling authentication checks for OPTIONS requests will allow unauthenticated users to determine what Druid endpoints are valid (by checking if the OPTIONS request returns a 200 instead of 404). Enabling this option will reveal information about server configuration, including information about what extensions are loaded, to unauthenticated users.\nfalse", "url": "https://github.com/apache/druid/pull/10085#discussion_r446306599", "createdAt": "2020-06-26T17:08:07Z", "author": {"login": "gianm"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1312,6 +1312,7 @@ Druid uses Jetty to serve HTTP requests.\n |`druid.server.http.maxQueryTimeout`|Maximum allowed value (in milliseconds) for `timeout` parameter. See [query-context](../querying/query-context.html) to know more about `timeout`. Query is rejected if the query context `timeout` is greater than this value. |Long.MAX_VALUE|\n |`druid.server.http.maxRequestHeaderSize`|Maximum size of a request header in bytes. Larger headers consume more memory and can make a server more vulnerable to denial of service attacks.|8 * 1024|\n |`druid.server.http.enableForwardedRequestCustomizer`|If enabled, adds Jetty ForwardedRequestCustomizer which reads X-Forwarded-* request headers to manipulate servlet request object when Druid is used behind a proxy.|false|\n+|`druid.server.http.allowedHttpMethods`|List of http methods allowed in addition to the ones needed by Druid. GET, PUT, POST, DELETE and OPTIONS are always allowed. `druid.auth.allowUnauthenticatedHttpOptions` can be used to disable the OPTIONS method.|[]|", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNTU0Mw=="}, "originalCommit": {"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29c2a873635a93da365aba3174101ecfea7b8238", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/29c2a873635a93da365aba3174101ecfea7b8238", "committedDate": "2020-06-27T00:21:42Z", "message": "Exclude OPTIONS from always supported HTTP methods\n\nAdd HEAD as an allowed method for web console e2e tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ee669c0dfa40e17f228c49975899367b4fce0a8", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/8ee669c0dfa40e17f228c49975899367b4fce0a8", "committedDate": "2020-06-27T01:10:33Z", "message": "Merge remote-tracking branch 'upstream/master' into jetty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjY2MDE5", "url": "https://github.com/apache/druid/pull/10085#pullrequestreview-438666019", "createdAt": "2020-06-27T02:43:28Z", "commit": {"oid": "29c2a873635a93da365aba3174101ecfea7b8238"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwMjo0MzoyOFrOGpypww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwMjo0MzoyOFrOGpypww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NDY5MQ==", "bodyText": "nit (since not related to this PR): Can't you do a GET on /status/health?", "url": "https://github.com/apache/druid/pull/10085#discussion_r446474691", "createdAt": "2020-06-27T02:43:28Z", "author": {"login": "maytasm"}, "path": "web-console/script/druid", "diffHunk": "@@ -73,10 +73,12 @@ function _build_distribution() {\n   _log \"Building druid distribution\"\n \n   (\n+    # Add HEAD as an allowed HTTP method since this is how we check when the Druid service is ready.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c2a873635a93da365aba3174101ecfea7b8238"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjY2MDMx", "url": "https://github.com/apache/druid/pull/10085#pullrequestreview-438666031", "createdAt": "2020-06-27T02:43:35Z", "commit": {"oid": "29c2a873635a93da365aba3174101ecfea7b8238"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b257be845a5c13796790bffdaee42210b12182", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/61b257be845a5c13796790bffdaee42210b12182", "committedDate": "2020-06-27T02:54:34Z", "message": "fix docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60f42e68150c328b19a18ef20adadfc75da0486", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/d60f42e68150c328b19a18ef20adadfc75da0486", "committedDate": "2020-06-27T03:03:07Z", "message": "fix security IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "committedDate": "2020-06-27T03:50:48Z", "message": "Actually fix the web console e2e tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8029cf6a4f807f925e5f8367862782392cbb34d", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/f8029cf6a4f807f925e5f8367862782392cbb34d", "committedDate": "2020-06-29T18:03:01Z", "message": "Ignore icode coverage for nitialization classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/4b968ab8559573000de60ebbaa6716976b11c4ef", "committedDate": "2020-06-29T18:03:21Z", "message": "Merge remote-tracking branch 'upstream/master' into jetty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzkwMzQ0", "url": "https://github.com/apache/druid/pull/10085#pullrequestreview-439390344", "createdAt": "2020-06-29T18:18:54Z", "commit": {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxODo1NFrOGqcr1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoyMDowN1rOGqcuaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM1MQ==", "bodyText": "This functionality isn't related to authentication. It would more properly belong in JettyServerInitUtils.", "url": "https://github.com/apache/druid/pull/10085#discussion_r447163351", "createdAt": "2020-06-29T18:18:54Z", "author": {"login": "gianm"}, "path": "server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java", "diffHunk": "@@ -27,6 +27,16 @@\n \n public class AuthenticationUtils\n {\n+  public static void addAllowHttpMethodsFilter(ServletContextHandler root, List<String> allowedHttpMethods)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDAxMQ==", "bodyText": "Very small nit: HttpMethod.OPTIONS is better than the bare string.", "url": "https://github.com/apache/druid/pull/10085#discussion_r447164011", "createdAt": "2020-06-29T18:20:07Z", "author": {"login": "gianm"}, "path": "server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java", "diffHunk": "@@ -51,13 +54,27 @@ public void testSerde() throws Exception\n         defaultConfig.getUnannouncePropagationDelay(),\n         defaultConfig.getInflateBufferSize(),\n         defaultConfig.getCompressionLevel(),\n-        true\n+        true,\n+        ImmutableList.of(\"OPTIONS\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDM4OTk1", "url": "https://github.com/apache/druid/pull/10085#pullrequestreview-439438995", "createdAt": "2020-06-29T19:31:21Z", "commit": {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "857443866ff47feb034edea233db0548ca8ca828", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/857443866ff47feb034edea233db0548ca8ca828", "committedDate": "2020-06-29T20:38:28Z", "message": "code review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2170, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}