{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MTczOTEz", "number": 10135, "title": "Fix avg sql aggregator", "bodyText": "Fixes #10072\n\nWhat does this PR do and why is it necessary?\n\nThis PR fixes a bug with AvgSqlAggregator where it would count nulls toward the average even with druid.generic.useDefaultValueForNull=false\nHow does this PR work?\n\nIntroduced a new helper method in the CountSqlAggregator called createCountAggregatorFactory. This method returns a FilteredAggregatorFactory in the case where the column is nullable and a regular CountAggregatorFactory otherwise.\nThis new helper method is then used in AvgSqlAggregator to get the correct null respecting count in the denominator. In order to implement this i've replaced the parent class of AvgSqlAggregator from SimpleSqlAggregator to a regular SqlAggregator because getAggregation doesn't expose all the information we need.\nWhat should reviewers focus on?\n\nSome areas I would like focus and feedback on:\n\n\nI've switched the simple aggregation test to use the druid.numfoo table which has numeric null columns. I did this to have an explicit case of averaging a numeric dimension with nulls.\n\n\nI've modified query plans in other tests because after this change the avg aggregate on a metric ended up using a FilteredAggregatorFactory. This makes sense to me because you'd have to assume the metric can be null but it also feels weird because the cnt metric can't technically be null. So i'm not sure if this is the expected behaviour or not.\n\n\n\n\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed :\n\n mvn test -Dtest=org.apache.druid.sql.calcite.CalciteQueryTest -Dforbiddenapis.skip -Ddruid.generic.useDefaultValueForNull=false\n mvn test -Dtest=org.apache.druid.sql.calcite.CalciteQueryTest -Dforbiddenapis.skip\n\n\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n tested locally in a micro-quick-start\n\n\n\nKey changed/added classes in this PR\n\nAvgSqlAggregator\nCountSqlAggregator\n\ncc: @gianm", "createdAt": "2020-07-03T19:32:19Z", "url": "https://github.com/apache/druid/pull/10135", "merged": true, "mergeCommit": {"oid": "1b9aacb1cd1d16b23de2f4485e1398640e97f8bd"}, "closed": true, "closedAt": "2020-07-08T15:38:57Z", "author": {"login": "damnMeddlingKid"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxVCqQgH2gAyNDQ0MTczOTEzOmQwZGFjNzhmYzdmNDdiYzIyNzQ0NDNkNzY0ZDFkMjFjMjQ0ZDZhZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy8SoagFqTQ0NDg4OTQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0dac78fc7f47bc2274443d764d1d21c244d6ade", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/d0dac78fc7f47bc2274443d764d1d21c244d6ade", "committedDate": "2020-07-03T15:19:17Z", "message": "new average aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32bf4188d62a7cccd3a23545c0721f5451b7be7c", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/32bf4188d62a7cccd3a23545c0721f5451b7be7c", "committedDate": "2020-07-03T15:19:25Z", "message": "method to create count aggregator factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a573f7e1688045cded9621b2734ef85b019b455", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/0a573f7e1688045cded9621b2734ef85b019b455", "committedDate": "2020-07-03T15:19:35Z", "message": "test everything"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccf36af7410189a455461ba7302241a48b489a2d", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/ccf36af7410189a455461ba7302241a48b489a2d", "committedDate": "2020-07-03T15:19:46Z", "message": "update other usages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5204aa2835754e5902b7500ad1427621a0dc6a9", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/b5204aa2835754e5902b7500ad1427621a0dc6a9", "committedDate": "2020-07-03T15:22:21Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTUwNTMz", "url": "https://github.com/apache/druid/pull/10135#pullrequestreview-442550533", "createdAt": "2020-07-03T20:12:23Z", "commit": {"oid": "b5204aa2835754e5902b7500ad1427621a0dc6a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDoxMjoyM1rOGs3PPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDoxMjoyM1rOGs3PPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTU1MA==", "bodyText": "as mentioned before cnt is considered nullable now so we need these new branches to handle the change in behaviour.", "url": "https://github.com/apache/druid/pull/10135#discussion_r449695550", "createdAt": "2020-07-03T20:12:23Z", "author": {"login": "damnMeddlingKid"}, "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -6801,14 +6823,28 @@ public void testMinMaxAvgDailyCountWithLimit() throws Exception\n                         )\n                         .setInterval(querySegmentSpec(Filtration.eternity()))\n                         .setGranularity(Granularities.ALL)\n-                        .setAggregatorSpecs(aggregators(\n-                            new LongMaxAggregatorFactory(\"_a0\", \"a0\"),\n-                            new LongMinAggregatorFactory(\"_a1\", \"a0\"),\n-                            new LongSumAggregatorFactory(\"_a2:sum\", \"a0\"),\n-                            new CountAggregatorFactory(\"_a2:count\"),\n-                            new LongMaxAggregatorFactory(\"_a3\", \"d0\"),\n-                            new CountAggregatorFactory(\"_a4\")\n-                        ))\n+                        .setAggregatorSpecs(\n+                            useDefault\n+                            ? aggregators(\n+                              new LongMaxAggregatorFactory(\"_a0\", \"a0\"),\n+                              new LongMinAggregatorFactory(\"_a1\", \"a0\"),\n+                              new LongSumAggregatorFactory(\"_a2:sum\", \"a0\"),\n+                              new CountAggregatorFactory(\"_a2:count\"),\n+                              new LongMaxAggregatorFactory(\"_a3\", \"d0\"),\n+                              new CountAggregatorFactory(\"_a4\")\n+                            )\n+                            : aggregators(\n+                                new LongMaxAggregatorFactory(\"_a0\", \"a0\"),\n+                                new LongMinAggregatorFactory(\"_a1\", \"a0\"),\n+                                new LongSumAggregatorFactory(\"_a2:sum\", \"a0\"),\n+                                new FilteredAggregatorFactory(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5204aa2835754e5902b7500ad1427621a0dc6a9"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d66d5e529ec2d7a293adcbd73c8ee9857b8dbaf", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/2d66d5e529ec2d7a293adcbd73c8ee9857b8dbaf", "committedDate": "2020-07-03T20:41:52Z", "message": "fix more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18490a1caaebd89150161127595cf115b80ca4f1", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/18490a1caaebd89150161127595cf115b80ca4f1", "committedDate": "2020-07-03T21:42:11Z", "message": "fix datasketches tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "18490a1caaebd89150161127595cf115b80ca4f1", "author": {"user": {"login": "damnMeddlingKid", "name": "Franklyn Dsouza"}}, "url": "https://github.com/apache/druid/commit/18490a1caaebd89150161127595cf115b80ca4f1", "committedDate": "2020-07-03T21:42:11Z", "message": "fix datasketches tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODkyMTUy", "url": "https://github.com/apache/druid/pull/10135#pullrequestreview-442892152", "createdAt": "2020-07-06T08:54:39Z", "commit": {"oid": "18490a1caaebd89150161127595cf115b80ca4f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODg5NDYy", "url": "https://github.com/apache/druid/pull/10135#pullrequestreview-444889462", "createdAt": "2020-07-08T15:36:57Z", "commit": {"oid": "18490a1caaebd89150161127595cf115b80ca4f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1797, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}