{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NTk5OTM0", "number": 10169, "title": "Fix JettyTest.testNumConnectionsMetricHttp flaky test", "bodyText": "Fix JettyTest.testNumConnectionsMetricHttp flaky test\nDescription\nThe unit test, JettyTest.testNumConnectionsMetricHttp, has been observed to be flaky. Such as in #10027 (comment) and in #9661 (comment)\nThe test waits for number of active connection on the Jetty JettyServerModule to be 0 before running tests. For some unknown reason the active connection is > 0 and even after sleeping/retry is still > 0. This causes the test to fail.\nHowever, this test is very rarely flaky. I have try to run the test job containing the flaky test in equivalent Travis environment over 100 times and could not get it to fail (See: https://travis-ci.com/github/maytasm/druid/builds/175034012).\nThe test is already doing the following:\n\nUsing random port between each retry.\nRetry check of active connection every 10 ms over 10000 ms total.\n\nSince the test rarely fails, this PR aims to achieve the following:\n\nIncrease return check of active connection to every 10 ms over 15000 ms total. Hopefully, this will further reduce the probability of the test failing.\nImprove error message when test fails to indicate the number of active connection and the port that was used.\n\nNote: an alternative is to start the test at the number of open connections instead of 0, and just test for 1 above that and make sure it goes back down to where it started or below. However, as we are not sure how unexpected connections are from, there may as well be connections opening or closing while the test is running (between recording initialize connection number and verifying final connection number).\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-07-10T19:07:37Z", "url": "https://github.com/apache/druid/pull/10169", "merged": true, "mergeCommit": {"oid": "454eed06a872e369e4d2fc2e3b955457ffa081ee"}, "closed": true, "closedAt": "2020-07-14T17:36:47Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczoDaagH2gAyNDQ3NTk5OTM0OjViNDIyYjYzZTVkYzhmMWQ0NTlhZDhjNWZkYzhkY2Y3Y2Q3MzM1Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0s-m0gFqTQ0Nzc0ODYxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b422b63e5dc8f1d459ad8c5fdc8dcf7cd733539", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/5b422b63e5dc8f1d459ad8c5fdc8dcf7cd733539", "committedDate": "2020-07-10T18:36:09Z", "message": "JettyTest.testNumConnectionsMetricHttp is rarely flaky"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NzQ4NjE1", "url": "https://github.com/apache/druid/pull/10169#pullrequestreview-447748615", "createdAt": "2020-07-14T02:52:56Z", "commit": {"oid": "5b422b63e5dc8f1d459ad8c5fdc8dcf7cd733539"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMjo1Mjo1NlrOGxCFBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMjo1Mjo1NlrOGxCFBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA2NzQ2Mg==", "bodyText": "nit: could use\n      throw new RE(\"Connections greater than 0. activeConnections=%s port=%s\", jsm.getActiveConnections(), port);", "url": "https://github.com/apache/druid/pull/10169#discussion_r454067462", "createdAt": "2020-07-14T02:52:56Z", "author": {"login": "clintropolis"}, "path": "server/src/test/java/org/apache/druid/server/initialization/JettyTest.java", "diffHunk": "@@ -511,13 +511,13 @@ private void waitForJettyServerModuleActiveConnectionsZero(JettyServerModule jsm\n   {\n     // it can take a bit to close the connection, so maybe sleep for a while and hope it closes\n     final int sleepTimeMills = 10;\n-    final int totalSleeps = 10_000 / sleepTimeMills;\n+    final int totalSleeps = 15_000 / sleepTimeMills;\n     int count = 0;\n     while (jsm.getActiveConnections() > 0 && count++ < totalSleeps) {\n       Thread.sleep(sleepTimeMills);\n     }\n     if (jsm.getActiveConnections() > 0) {\n-      throw new RuntimeException(\"Connections greater than 0\");\n+      throw new RuntimeException(\"Connections greater than 0. activeConnections=\" + jsm.getActiveConnections() + \" port=\" + port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b422b63e5dc8f1d459ad8c5fdc8dcf7cd733539"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1825, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}