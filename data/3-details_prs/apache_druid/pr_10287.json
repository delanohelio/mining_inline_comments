{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MjEyMjAw", "number": 10287, "title": "Remove legacy code from LogUsedSegments duty", "bodyText": "Update on 01/07/20\nAfter more discussion. We have decided to scrap the ability to disable and instead remove the legacy code that emits alerts for segments with no size. This code is thought to be old debugging code that is safe to remove. Now the LogUsedSegments duty gives a helpful log of # of active segments no matter what. and if debug logging is enabled, used segments are logged. This duty has no performance concerns for non-debug clusters meaning there is no reason to add complexity of new config to disable. In future, it may be beneficial depending on future of this duty. But for now it seems like unnecessary code.\nUpdate on 12/21/20\nAfter analysis of the utility of this duty, we are now considering disabling this duty by default and not documenting the config to enable it. With the idea being that we will remove the duty altogether in the future if it proves that nobody questions it being off by default. Because of this plan, I added a Design Review label to the PR. More input on this plan would be helpful.\n\n\nDescription\n\nAllows cluster admin to disable the LogUsedSegments coordinator duty if they so choose. This duty does not have any impact on successive duties so disabling it does not cause any change to the state of the cluster after coordination duties complete.\nAs an admin for a large enterprise cluster myself, I have been on the hunt for any optimization I can find in the lifecycle of the coordinator. This patch appears to be low hanging fruit in my efforts. This duty takes ~10 seconds to complete on our largest cluster. We have never used debug logging to log our segments and we have never checked the emitters alert stream for alerts on segments with size <0. Therefore, I think it makes sense to give admins the ability to toggle this duty on and off as they see fit.\nNew Config: druid.coordinator.duties.logUsedSegments.enabled ... Default: true\n\nI added a config to the DruidCoordinatorConfig. The naming scheme of this config can be easily change as the community sees fit. I made my choice in the hope that it is self-explanatory and allows for more future duty specific configs to be added following the same scheme.\nThis config defaults to having the LogUsedSegments duty enabled (keeping inline with current functionality). When the coordinator is becoming a leader and creating its duties, it consults the config object to find out if the LogUsedSegments duty should be added to the duty lists for historical segment management and indexing.\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n been tested in a test Druid cluster.\n\n\n\nKey changed/added classes in this PR\n\nDruidCoordinatorConfig\nDruidCoordinator", "createdAt": "2020-08-14T22:43:28Z", "url": "https://github.com/apache/druid/pull/10287", "merged": true, "mergeCommit": {"oid": "aecc9e5e7e009b28f5e7d9b848c5d086622dfc97"}, "closed": true, "closedAt": "2021-01-12T22:09:19Z", "author": {"login": "capistrant"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-8hr0gH2gAyNDY4MjEyMjAwOjIzODkxMjhjNWRlZWFjNDM4ZWUzZTVlNmE0OWE1ZThlNDYzYmYyYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvilT0AFqTU2Njc0MjIzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2389128c5deeac438ee3e5e6a49a5e8e463bf2a7", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/2389128c5deeac438ee3e5e6a49a5e8e463bf2a7", "committedDate": "2020-08-14T22:40:29Z", "message": "allow the LogUsedSegments duty to be skippped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b9a54b7aea2d585626649890480e19c0b5636bd", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/4b9a54b7aea2d585626649890480e19c0b5636bd", "committedDate": "2020-08-15T21:56:25Z", "message": "Fixes for TravisCI coverage checks and documentation spell checking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e16219b79407b31fb9b33a3d8c5f6784f41953d3", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/e16219b79407b31fb9b33a3d8c5f6784f41953d3", "committedDate": "2020-08-16T18:11:31Z", "message": "prameterize DruidCoordinatorTest in order to achieve coverage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDQ2NTE4", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-490046518", "createdAt": "2020-09-16T21:52:58Z", "commit": {"oid": "e16219b79407b31fb9b33a3d8c5f6784f41953d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMTo1Mjo1OFrOHTFiGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMTo1Mjo1OFrOHTFiGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3NTY0MQ==", "bodyText": "We could make the property description friendlier by describing what LogUsedSegments does instead of just mentioning it. Also it would be helpful to add a line or two about when should a cluster operator think about disabling this property.", "url": "https://github.com/apache/druid/pull/10287#discussion_r489775641", "createdAt": "2020-09-16T21:52:58Z", "author": {"login": "a2l007"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -689,6 +689,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.duties.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` Duty|true|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e16219b79407b31fb9b33a3d8c5f6784f41953d3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e7aba5bd8474c0d3f5cc50216aa5d6b17471c9", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/71e7aba5bd8474c0d3f5cc50216aa5d6b17471c9", "committedDate": "2020-10-28T21:46:37Z", "message": "Merge remote-tracking branch 'upstream/master' into logUsedSegmentsDuty-toggle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4", "committedDate": "2020-10-29T00:06:16Z", "message": "update config name to remove duty ref and improve documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzI1NjE4", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-519325618", "createdAt": "2020-10-29T04:31:13Z", "commit": {"oid": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNDozMToxM1rOHqJiWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNDozMjoyMlrOHqJkpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1ODQ5MA==", "bodyText": "typo: it logs then number of > it logs the number of", "url": "https://github.com/apache/druid/pull/10287#discussion_r513958490", "createdAt": "2020-10-29T04:31:13Z", "author": {"login": "ArvinZheng"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle. It gets a snapshot of segments in the cluster and iterates them. While iterating, it will emit an alert if a segment has a size less than 0. If debug logging is enabled, it will also log a string representation of each segment. Lastly, it logs then number of segments in the cluster. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|true|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1OTA3Ng==", "bodyText": "not a comment, just wanted to see if the following sounds good?\nBoolean value for whether or not the coordinator should execute the LogUsedSegments portion of its coordination work. LogUsedSegments is an informational job run by the Coordinator every coordination cycle which logs every segment at DEBUG level and the total number of used segments at INFO level, in addition, it emits an alert if a segment has a size less than 0. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided", "url": "https://github.com/apache/druid/pull/10287#discussion_r513959076", "createdAt": "2020-10-29T04:32:22Z", "author": {"login": "ArvinZheng"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle. It gets a snapshot of segments in the cluster and iterates them. While iterating, it will emit an alert if a segment has a size less than 0. If debug logging is enabled, it will also log a string representation of each segment. Lastly, it logs then number of segments in the cluster. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|true|", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1ODQ5MA=="}, "originalCommit": {"oid": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/60f2067c2b04d75d5e260c4aef0c6009e31a088d", "committedDate": "2020-10-29T13:27:42Z", "message": "refine documentation for new config with reviewer advice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNDY4ODY5", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-561468869", "createdAt": "2021-01-05T02:05:37Z", "commit": {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwMjowNTozN1rOIOHlkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwMjowNzozOVrOIOHnsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTI4MQ==", "bodyText": "The default value column is missing.", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675281", "createdAt": "2021-01-05T02:05:37Z", "author": {"login": "jihoonson"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle which logs every segment at DEBUG level and the total number of used segments at INFO level. In addition to these logs, it emits an alert if a segment has a size less than 0. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTM5Mw==", "bodyText": "Also, did you want to not document it?", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675393", "createdAt": "2021-01-05T02:06:02Z", "author": {"login": "jihoonson"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle which logs every segment at DEBUG level and the total number of used segments at INFO level. In addition to these logs, it emits an alert if a segment has a size less than 0. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTI4MQ=="}, "originalCommit": {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgyNg==", "bodyText": "nit: Collections.unmodifiableList(duties)", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675826", "createdAt": "2021-01-05T02:07:39Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -669,21 +669,31 @@ private void stopBeingLeader()\n \n   private List<CoordinatorDuty> makeHistoricalManagementDuties()\n   {\n-    return ImmutableList.of(\n-        new LogUsedSegments(),\n+    List<CoordinatorDuty> duties = new ArrayList<>();\n+    if (config.isLogUsedSegmentsDutyEnabled()) {\n+      duties.add(new LogUsedSegments());\n+    }\n+    duties.addAll(ImmutableList.of(\n         new UpdateCoordinatorStateAndPrepareCluster(),\n         new RunRules(DruidCoordinator.this),\n         new UnloadUnusedSegments(),\n         new MarkAsUnusedOvershadowedSegments(DruidCoordinator.this),\n         new BalanceSegments(DruidCoordinator.this),\n         new EmitClusterStatsAndMetrics(DruidCoordinator.this)\n+    ));\n+    log.debug(\n+        \"Done making historical management duties %s\",\n+        duties.stream().map(duty -> duty.getClass().getName()).collect(Collectors.toList())\n     );\n+    return duties;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20bd6e244827ca5523ca0504360ffa2aefad6bb8", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/20bd6e244827ca5523ca0504360ffa2aefad6bb8", "committedDate": "2021-01-05T22:08:05Z", "message": "add default column to docs for new config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf750d248802432d52590ec6e0672d3ba25f91e", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/1bf750d248802432d52590ec6e0672d3ba25f91e", "committedDate": "2021-01-06T20:36:16Z", "message": "Merge branch 'master' into logUsedSegmentsDuty-toggle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MDg5NjUz", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-564089653", "createdAt": "2021-01-08T08:47:47Z", "commit": {"oid": "1bf750d248802432d52590ec6e0672d3ba25f91e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e77b3209ec5b068d19d3f04c448489c686986942", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/e77b3209ec5b068d19d3f04c448489c686986942", "committedDate": "2021-01-08T18:24:59Z", "message": "remove legacy code in LogUsedSegments and remove config to disbale duty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6d3ddf59f619079ef89c8a3eb27293bf6b11e12", "author": {"user": {"login": "capistrant", "name": "Lucas Capistrant"}}, "url": "https://github.com/apache/druid/commit/c6d3ddf59f619079ef89c8a3eb27293bf6b11e12", "committedDate": "2021-01-08T18:31:03Z", "message": "fix makeHistoricalMangementDuties now that the returned list is always the same"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0NTA5OTI5", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-564509929", "createdAt": "2021-01-08T19:05:03Z", "commit": {"oid": "c6d3ddf59f619079ef89c8a3eb27293bf6b11e12"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NzQyMjMw", "url": "https://github.com/apache/druid/pull/10287#pullrequestreview-566742230", "createdAt": "2021-01-12T22:09:12Z", "commit": {"oid": "c6d3ddf59f619079ef89c8a3eb27293bf6b11e12"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1984, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}