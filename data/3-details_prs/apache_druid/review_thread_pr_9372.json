{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjE3OTQ3", "number": 9372, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMDozMzowOVrODgpIyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzozODo0NVrODha03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NTU1MDE3OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMDozMzowOVrOFq9N-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwODo0NDoyNlrOFrfVvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw==", "bodyText": "Space prefix ? Maybe you should change \"legendary druid\" to \"\" or rename the variable.", "url": "https://github.com/apache/druid/pull/9372#discussion_r380587513", "createdAt": "2020-02-18T10:33:09Z", "author": {"login": "QiuMM"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "diffHunk": "@@ -32,23 +32,29 @@\n \n public class EventConverterTest\n {\n-  private EventConverter converter;\n+  private EventConverter converterWithPrefix;\n+  private EventConverter converterWithSpacePrefix;\n+  private EventConverter converterWithoutPrefix;\n \n   @Before\n   public void setUp()\n   {\n-    converter = new EventConverter(new ObjectMapper(), null);\n+    converterWithPrefix = new EventConverter(new ObjectMapper(), null, \"druid\");\n+    converterWithSpacePrefix = new EventConverter(new ObjectMapper(), null, \"legendary druid\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNDcyNw==", "bodyText": "You're right, i'll rename the variable to converterWithPrefixContainingSpace, and add another test for converterWithPrefixContainingEmptyString (\"\").\nHow does that sound?", "url": "https://github.com/apache/druid/pull/9372#discussion_r380634727", "createdAt": "2020-02-18T12:14:13Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "diffHunk": "@@ -32,23 +32,29 @@\n \n public class EventConverterTest\n {\n-  private EventConverter converter;\n+  private EventConverter converterWithPrefix;\n+  private EventConverter converterWithSpacePrefix;\n+  private EventConverter converterWithoutPrefix;\n \n   @Before\n   public void setUp()\n   {\n-    converter = new EventConverter(new ObjectMapper(), null);\n+    converterWithPrefix = new EventConverter(new ObjectMapper(), null, \"druid\");\n+    converterWithSpacePrefix = new EventConverter(new ObjectMapper(), null, \"legendary druid\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw=="}, "originalCommit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NjU1Nw==", "bodyText": "Sounds good.", "url": "https://github.com/apache/druid/pull/9372#discussion_r381146557", "createdAt": "2020-02-19T08:44:26Z", "author": {"login": "QiuMM"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "diffHunk": "@@ -32,23 +32,29 @@\n \n public class EventConverterTest\n {\n-  private EventConverter converter;\n+  private EventConverter converterWithPrefix;\n+  private EventConverter converterWithSpacePrefix;\n+  private EventConverter converterWithoutPrefix;\n \n   @Before\n   public void setUp()\n   {\n-    converter = new EventConverter(new ObjectMapper(), null);\n+    converterWithPrefix = new EventConverter(new ObjectMapper(), null, \"druid\");\n+    converterWithSpacePrefix = new EventConverter(new ObjectMapper(), null, \"legendary druid\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw=="}, "originalCommit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODY1MDk0OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNDo0NDoyMFrOFra97w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNjoxMlrOFrjIKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NDkyNw==", "bodyText": "nit: I think this might be a fair bit cleaner to rework this method to take the metric name and do the call to sanitize in here, maybe something like:\nprivate String buildMetric(String metric)\n{\n  final String sanitized = sanitize(metric);\n  if (Strings.isNullOrEmpty(namespacePrefix)) {\n    return sanitized;\n  } else {\n    return StringUtils.format(\"%s.%s\", namespacePrefix, sanitized);\n  }  \n}\n\nthen creating the OpentsdbEvent can just be\n    ...\n    return new OpentsdbEvent(buildMetric(metric), timestamp, value, tags);", "url": "https://github.com/apache/druid/pull/9372#discussion_r381074927", "createdAt": "2020-02-19T04:44:20Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwODYxOQ==", "bodyText": "Makes perfect sense, i've added  buildMetric more or like what you suggested.", "url": "https://github.com/apache/druid/pull/9372#discussion_r381208619", "createdAt": "2020-02-19T10:36:12Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NDkyNw=="}, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODY1NzU3OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNDo0OToyN1rOFrbBzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNzowMFrOFrjJ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NTkxOA==", "bodyText": "can namespacePrefix actually be empty here (other than the unit tests creating an EventConverter directly) since OpentsdbEmitterConfig looks like it will coerce the value to null in its constructor?", "url": "https://github.com/apache/druid/pull/9372#discussion_r381075918", "createdAt": "2020-02-19T04:49:27Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()\n+  {\n+    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwOTA3MA==", "bodyText": "You're right, i've removed the tests for it, since it's the only place where it can happen. And i guess no-one is gonna call EventConverter outside of the extension.", "url": "https://github.com/apache/druid/pull/9372#discussion_r381209070", "createdAt": "2020-02-19T10:37:00Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()\n+  {\n+    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NTkxOA=="}, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MjMzMjM5OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMTozNzo1NlrOFr-NVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowNzoxM1rOFsSl1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1MjMxMA==", "bodyText": "I think this can just check namespacePrefix == null now", "url": "https://github.com/apache/druid/pull/9372#discussion_r381652310", "createdAt": "2020-02-20T01:37:56Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -54,9 +55,14 @@ protected String sanitize(String metric)\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n-  private String buildNamespace()\n+  private String buildMetric(String metric)\n   {\n-    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";\n+    final String sanitized = sanitize(metric);\n+    if (Strings.isNullOrEmpty(namespacePrefix)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NjI2Mw==", "bodyText": "Fixed in latest commit", "url": "https://github.com/apache/druid/pull/9372#discussion_r381986263", "createdAt": "2020-02-20T13:07:13Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -54,9 +55,14 @@ protected String sanitize(String metric)\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n-  private String buildNamespace()\n+  private String buildMetric(String metric)\n   {\n-    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";\n+    final String sanitized = sanitize(metric);\n+    if (Strings.isNullOrEmpty(namespacePrefix)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1MjMxMA=="}, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MzY5MTE4OnYy", "diffSide": "RIGHT", "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzozODo0NVrOFsI3Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowNzoyNFrOFsSmJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ==", "bodyText": "nit: I think rename testSerDeserOpentsdbEmitterConfigWithSpaceNamespace to testSerDeserOpentsdbEmitterConfigWithNamespaceContainingSpace would be better.", "url": "https://github.com/apache/druid/pull/9372#discussion_r381826855", "createdAt": "2020-02-20T07:38:45Z", "author": {"login": "QiuMM"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "diffHunk": "@@ -39,10 +39,41 @@ public void setUp()\n   @Test\n   public void testSerDeserOpentsdbEmitterConfig() throws Exception\n   {\n-    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null);\n+    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null, \"druid\");\n     String opentsdbEmitterConfigString = mapper.writeValueAsString(opentsdbEmitterConfig);\n     OpentsdbEmitterConfig expectedOpentsdbEmitterConfig = mapper.readerFor(OpentsdbEmitterConfig.class)\n                                                                 .readValue(opentsdbEmitterConfigString);\n     Assert.assertEquals(expectedOpentsdbEmitterConfig, opentsdbEmitterConfig);\n   }\n+\n+  @Test\n+  public void testSerDeserOpentsdbEmitterConfigWithSpaceNamespace() throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk1ODQ4NA==", "bodyText": "Well spotted, didn't think much of test names when refactoring. And actually, I should bring all test-names in line with same naming convention, for clarity. In this file the tests were named like <...>Namespace<...>, and in EventConverterTest.java they're called <...>Prefix<...>, they should all be <...>NamespacePrefix<...>. I'll update them all. :)", "url": "https://github.com/apache/druid/pull/9372#discussion_r381958484", "createdAt": "2020-02-20T12:05:56Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "diffHunk": "@@ -39,10 +39,41 @@ public void setUp()\n   @Test\n   public void testSerDeserOpentsdbEmitterConfig() throws Exception\n   {\n-    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null);\n+    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null, \"druid\");\n     String opentsdbEmitterConfigString = mapper.writeValueAsString(opentsdbEmitterConfig);\n     OpentsdbEmitterConfig expectedOpentsdbEmitterConfig = mapper.readerFor(OpentsdbEmitterConfig.class)\n                                                                 .readValue(opentsdbEmitterConfigString);\n     Assert.assertEquals(expectedOpentsdbEmitterConfig, opentsdbEmitterConfig);\n   }\n+\n+  @Test\n+  public void testSerDeserOpentsdbEmitterConfigWithSpaceNamespace() throws Exception", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ=="}, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NjM0MA==", "bodyText": "committed", "url": "https://github.com/apache/druid/pull/9372#discussion_r381986340", "createdAt": "2020-02-20T13:07:24Z", "author": {"login": "bjozet"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "diffHunk": "@@ -39,10 +39,41 @@ public void setUp()\n   @Test\n   public void testSerDeserOpentsdbEmitterConfig() throws Exception\n   {\n-    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null);\n+    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null, \"druid\");\n     String opentsdbEmitterConfigString = mapper.writeValueAsString(opentsdbEmitterConfig);\n     OpentsdbEmitterConfig expectedOpentsdbEmitterConfig = mapper.readerFor(OpentsdbEmitterConfig.class)\n                                                                 .readValue(opentsdbEmitterConfigString);\n     Assert.assertEquals(expectedOpentsdbEmitterConfig, opentsdbEmitterConfig);\n   }\n+\n+  @Test\n+  public void testSerDeserOpentsdbEmitterConfigWithSpaceNamespace() throws Exception", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ=="}, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2768, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}