{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NzE2MTk5", "number": 9287, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NDowM1rODbs1Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyODo1N1rODbz07Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzcyNjc5OnYy", "diffSide": "RIGHT", "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NDowM1rOFjVkbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTozNjoyNlrOFjYWSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzg3MA==", "bodyText": "I'm not sure if it's clear that this method only applies to the equi-conditions. The javadoc explains it but the method name might be misleading? What do you think?\nI don't know if I have a good solution, btw. getRightKeyColumnsForEquiConditions is clear but quite a mouthful. Maybe getRightEquiConditionKeys.", "url": "https://github.com/apache/druid/pull/9287#discussion_r372597870", "createdAt": "2020-01-29T19:54:03Z", "author": {"login": "gianm"}, "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "diffHunk": "@@ -176,6 +179,14 @@ public boolean canHashJoin()\n     return canHashJoin;\n   }\n \n+  /**\n+   * Returns the distinct column keys from the RHS required to evaluate the equi conditions.\n+   */\n+  public List<String> getRightKeyColumns()\n+  {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5OTM2MA==", "bodyText": "Btw, a Set may be more appropriate than a List here.", "url": "https://github.com/apache/druid/pull/9287#discussion_r372599360", "createdAt": "2020-01-29T19:57:14Z", "author": {"login": "gianm"}, "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "diffHunk": "@@ -176,6 +179,14 @@ public boolean canHashJoin()\n     return canHashJoin;\n   }\n \n+  /**\n+   * Returns the distinct column keys from the RHS required to evaluate the equi conditions.\n+   */\n+  public List<String> getRightKeyColumns()\n+  {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzg3MA=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0MzQwMQ==", "bodyText": "I like the suggestion. Done.", "url": "https://github.com/apache/druid/pull/9287#discussion_r372643401", "createdAt": "2020-01-29T21:36:26Z", "author": {"login": "suneet-s"}, "path": "processing/src/main/java/org/apache/druid/segment/join/JoinConditionAnalysis.java", "diffHunk": "@@ -176,6 +179,14 @@ public boolean canHashJoin()\n     return canHashJoin;\n   }\n \n+  /**\n+   * Returns the distinct column keys from the RHS required to evaluate the equi conditions.\n+   */\n+  public List<String> getRightKeyColumns()\n+  {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzg3MA=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzcyNzM4OnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NDoxOFrOFjVk3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzo1MjowMVrOFjbdKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzk4MQ==", "bodyText": "Is this better than Assert.assertEquals?", "url": "https://github.com/apache/druid/pull/9287#discussion_r372597981", "createdAt": "2020-01-29T19:54:18Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -60,6 +61,7 @@ public void test_forExpression_simple()\n         ImmutableList.of(),\n         exprsToStrings(analysis.getNonEquiConditions())\n     );\n+    Assert.assertThat(analysis.getRightKeyColumns(), CoreMatchers.is(ImmutableList.of(\"y\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYyNzU2Mw==", "bodyText": "assertEquals fails because getRightKeyColumns doesn't return an ImmutableList", "url": "https://github.com/apache/druid/pull/9287#discussion_r372627563", "createdAt": "2020-01-29T21:02:08Z", "author": {"login": "suneet-s"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -60,6 +61,7 @@ public void test_forExpression_simple()\n         ImmutableList.of(),\n         exprsToStrings(analysis.getNonEquiConditions())\n     );\n+    Assert.assertThat(analysis.getRightKeyColumns(), CoreMatchers.is(ImmutableList.of(\"y\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzk4MQ=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5MjI4OQ==", "bodyText": "How can that be? CoreMatchers.is is calling actual.equals(expected), with extra steps.", "url": "https://github.com/apache/druid/pull/9287#discussion_r372692289", "createdAt": "2020-01-29T23:45:02Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -60,6 +61,7 @@ public void test_forExpression_simple()\n         ImmutableList.of(),\n         exprsToStrings(analysis.getNonEquiConditions())\n     );\n+    Assert.assertThat(analysis.getRightKeyColumns(), CoreMatchers.is(ImmutableList.of(\"y\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzk4MQ=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NDMxNA==", "bodyText": "I definitely saw the test fail which is why I had to google how to fix this - and I found CoreMatchers.\nhahaha I think I know why now -\nAssert.assertEquals checks expected.equals(actual)\nCoreMatchers.is checks actual.equals(expected)\nThat probably means the equals implementation for one (or both?) of those classes isn't correct according to the javadocs", "url": "https://github.com/apache/druid/pull/9287#discussion_r372694314", "createdAt": "2020-01-29T23:52:01Z", "author": {"login": "suneet-s"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -60,6 +61,7 @@ public void test_forExpression_simple()\n         ImmutableList.of(),\n         exprsToStrings(analysis.getNonEquiConditions())\n     );\n+    Assert.assertThat(analysis.getRightKeyColumns(), CoreMatchers.is(ImmutableList.of(\"y\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzk4MQ=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzczMDY0OnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NTozMFrOFjVnFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NTozMFrOFjVnFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5ODU0OA==", "bodyText": "The comment above is incorrect now. Actually, it was incorrect before too, since some of these fields are based on equiConditions as well.", "url": "https://github.com/apache/druid/pull/9287#discussion_r372598548", "createdAt": "2020-01-29T19:55:30Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -271,7 +283,7 @@ public void test_equals()\n                           // These fields are tightly coupled with originalExpression\n                           \"equiConditions\", \"nonEquiConditions\",\n                           // These fields are calculated from nonEquiConditions\n-                          \"isAlwaysTrue\", \"isAlwaysFalse\", \"canHashJoin\")\n+                          \"isAlwaysTrue\", \"isAlwaysFalse\", \"canHashJoin\", \"rightKeyColumns\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzczMzY1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/join/InlineJoinableFactory.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTo1NjozMFrOFjVo9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzo0NzowOFrOFjbXsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5OTAzMA==", "bodyText": "You could probably do a similar simplification in LookupJoinMatcher (there's a part that checks that all the equikeys are the key column).", "url": "https://github.com/apache/druid/pull/9287#discussion_r372599030", "createdAt": "2020-01-29T19:56:30Z", "author": {"login": "gianm"}, "path": "server/src/main/java/org/apache/druid/segment/join/InlineJoinableFactory.java", "diffHunk": "@@ -39,8 +38,7 @@\n   {\n     if (condition.canHashJoin() && dataSource instanceof InlineDataSource) {\n       final InlineDataSource inlineDataSource = (InlineDataSource) dataSource;\n-      final List<String> rightKeyColumns =\n-          condition.getEquiConditions().stream().map(Equality::getRightColumn).distinct().collect(Collectors.toList());\n+      final List<String> rightKeyColumns = condition.getRightKeyColumns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MzM2Mg==", "bodyText": "It's not immediately obvious to me how other implementations would use what LookupJoinMatcher is doing with the equiConditions. If it's ok with you, I'd like to do that refactoring at a later time", "url": "https://github.com/apache/druid/pull/9287#discussion_r372653362", "createdAt": "2020-01-29T21:57:31Z", "author": {"login": "suneet-s"}, "path": "server/src/main/java/org/apache/druid/segment/join/InlineJoinableFactory.java", "diffHunk": "@@ -39,8 +38,7 @@\n   {\n     if (condition.canHashJoin() && dataSource instanceof InlineDataSource) {\n       final InlineDataSource inlineDataSource = (InlineDataSource) dataSource;\n-      final List<String> rightKeyColumns =\n-          condition.getEquiConditions().stream().map(Equality::getRightColumn).distinct().collect(Collectors.toList());\n+      final List<String> rightKeyColumns = condition.getRightKeyColumns();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5OTAzMA=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5MjkxMg==", "bodyText": "Ah, I just meant replacing this:\n    } else if (!condition.getEquiConditions()\n                         .stream()\n                         .allMatch(eq -> eq.getRightColumn().equals(LookupColumnSelectorFactory.KEY_COLUMN))) {\nWith this:\n    } else if (!condition.getRightEquiConditionKeys().equals(Collections.singletonSet(LookupColumnSelectorFactory.KEY_COLUMN)) {", "url": "https://github.com/apache/druid/pull/9287#discussion_r372692912", "createdAt": "2020-01-29T23:47:08Z", "author": {"login": "gianm"}, "path": "server/src/main/java/org/apache/druid/segment/join/InlineJoinableFactory.java", "diffHunk": "@@ -39,8 +38,7 @@\n   {\n     if (condition.canHashJoin() && dataSource instanceof InlineDataSource) {\n       final InlineDataSource inlineDataSource = (InlineDataSource) dataSource;\n-      final List<String> rightKeyColumns =\n-          condition.getEquiConditions().stream().map(Equality::getRightColumn).distinct().collect(Collectors.toList());\n+      final List<String> rightKeyColumns = condition.getRightKeyColumns();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5OTAzMA=="}, "originalCommit": {"oid": "7f98720bf182a34d05cbdc781bf184e4b5345270"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNDg3MjMyOnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyODo0NlrOFjgiWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyODo0NlrOFjgiWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc3NzU2Mw==", "bodyText": "These are backwards. (I think putting actual before expected is more natural, but JUnit disagrees and who am I to judge?)", "url": "https://github.com/apache/druid/pull/9287#discussion_r372777563", "createdAt": "2020-01-30T06:28:46Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -220,6 +229,7 @@ public void test_forExpression_onlyRight()\n         ImmutableList.of(),\n         exprsToStrings(analysis.getNonEquiConditions())\n     );\n+    Assert.assertEquals(analysis.getRightEquiConditionKeys(), ImmutableSet.of(\"x\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70dca1b9796189273a21c4a8f357b1fb0ff751a"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNDg3Mjc3OnYy", "diffSide": "RIGHT", "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyODo1N1rOFjgilQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyODo1N1rOFjgilQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc3NzYyMQ==", "bodyText": "Typo (other other)", "url": "https://github.com/apache/druid/pull/9287#discussion_r372777621", "createdAt": "2020-01-30T06:28:57Z", "author": {"login": "gianm"}, "path": "processing/src/test/java/org/apache/druid/segment/join/JoinConditionAnalysisTest.java", "diffHunk": "@@ -270,8 +282,8 @@ public void test_equals()\n                   .withIgnoredFields(\n                           // These fields are tightly coupled with originalExpression\n                           \"equiConditions\", \"nonEquiConditions\",\n-                          // These fields are calculated from nonEquiConditions\n-                          \"isAlwaysTrue\", \"isAlwaysFalse\", \"canHashJoin\")\n+                          // These fields are calculated from other other fields in the class", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70dca1b9796189273a21c4a8f357b1fb0ff751a"}, "originalPosition": 102}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2844, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}