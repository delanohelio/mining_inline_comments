{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjEyOTQ3", "number": 10413, "title": "Add last_compaction_state to sys.segments table", "bodyText": "Add last_compaction_state to sys.segments table\nDescription\nSegments being compacted or not compacted have a big impact on query performance.\nCurrently it is not easy to verify questions like:\n\nif performance of query can be improve by compaction\nif a performance of query is bad, was it because segments for that interval was not compacted.\nif a segment was compacted, what was it compacted with? was it compacted with the auto compaction config set?\n\nThis PR expose the lastCompactionState via the sys.segments table (so user can do query with slice/dice, group, time filter, etc) by using the lastCompactionState stored within the segment metadata. If a compactionState exist then the segment was compacted. This PR also change storing lastCompactionState as default for manual compaction in addition to auto compaction.\nFor example, if you want to know if the segment was compacted or not (ANY compaction), you can do WHERE last_compaction_state is not null and if you want to know if the segment was compacted with current auto compaction configs, you can do WHERE last_compaction_state == '{current_auto_compact_config}'\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-21T23:33:30Z", "url": "https://github.com/apache/druid/pull/10413", "merged": true, "mergeCommit": {"oid": "72f1b55f569719b8e0e1920f382bdf98e418924e"}, "closed": true, "closedAt": "2020-09-23T22:29:37Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLL8kfgH2gAyNDkwNjEyOTQ3OmU1YjhjYjE4OWVkYjA3NzBmNmU0MWE0NjAzMDM0OTgzNjYyM2FkMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLweUtAFqTQ5NDkwODYzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5b8cb189edb0770f6e41a46030349836623ad20", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/e5b8cb189edb0770f6e41a46030349836623ad20", "committedDate": "2020-09-21T23:25:31Z", "message": "Add is_compacted to sys.segments table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09b8f9bf4def85911ef8ce18e7bcad12dff89548", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/09b8f9bf4def85911ef8ce18e7bcad12dff89548", "committedDate": "2020-09-22T00:31:34Z", "message": "change is_compacted to last_compaction_state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/33959d2fd5183ebf08c45e1b61a953d4301dc382", "committedDate": "2020-09-22T20:02:54Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODQzNjQx", "url": "https://github.com/apache/druid/pull/10413#pullrequestreview-493843641", "createdAt": "2020-09-22T21:01:18Z", "commit": {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTowMToxOVrOHWMPTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMToxMzoyMlrOHWMmOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTI0NQ==", "bodyText": "super nit - to link to where the default is.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * compaction task (true by default).\n          \n          \n            \n               * compaction task (true by default). {@link org.apache.druid.indexing.common.task.Tasks#DEFAULT_STORE_COMPACTION_STATE}.", "url": "https://github.com/apache/druid/pull/10413#discussion_r493031245", "createdAt": "2020-09-22T21:01:19Z", "author": {"login": "suneet-s"}, "path": "core/src/main/java/org/apache/druid/timeline/DataSegment.java", "diffHunk": "@@ -100,7 +100,7 @@\n   /**\n    * Stores some configurations of the compaction task which created this segment.\n    * This field is filled in the metadata store only when \"storeCompactionState\" is set true in the context of the\n-   * compaction task which is false by default.\n+   * compaction task (true by default).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMjgwMw==", "bodyText": "The PR description talks about being able to identify performance issues where looking at last_compaction_state can help. Should we add some example sql statements below to explain how to identify the 3 issues outlined in the PR description?", "url": "https://github.com/apache/druid/pull/10413#discussion_r493032803", "createdAt": "2020-09-22T21:04:32Z", "author": {"login": "suneet-s"}, "path": "docs/querying/sql.md", "diffHunk": "@@ -1086,6 +1086,7 @@ Segments table provides details on all Druid segments, whether they are publishe\n |shardSpec|STRING|The toString of specific `ShardSpec`|\n |dimensions|STRING|The dimensions of the segment|\n |metrics|STRING|The metrics of the segment|\n+|last_compaction_state|STRING|The configurations of the compaction task which created this segment. May be null if segment was not created by compaction task.|\n \n For example to retrieve all segments for datasource \"wikipedia\", use the query:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNzExNQ==", "bodyText": "CompactionState includes the PartitionsSpec and indexSpec.\nWhat should a caller of the API do with these?\nThe compaction state appears to be an unbounded json object. Do we foresee any issues around serializing the entire json blob every time we need to call the sys table?", "url": "https://github.com/apache/druid/pull/10413#discussion_r493037115", "createdAt": "2020-09-22T21:13:22Z", "author": {"login": "suneet-s"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/SystemSchema.java", "diffHunk": "@@ -311,7 +312,8 @@ public TableType getJdbcTableType()\n                 val.isOvershadowed() ? IS_OVERSHADOWED_TRUE : IS_OVERSHADOWED_FALSE,\n                 segment.getShardSpec(),\n                 segment.getDimensions(),\n-                segment.getMetrics()\n+                segment.getMetrics(),\n+                segment.getLastCompactionState()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c9727e66efd9bcff08893aa4fc021e348dc95bc", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/0c9727e66efd9bcff08893aa4fc021e348dc95bc", "committedDate": "2020-09-22T22:17:26Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTA5NDIx", "url": "https://github.com/apache/druid/pull/10413#pullrequestreview-493909421", "createdAt": "2020-09-22T23:18:42Z", "commit": {"oid": "0c9727e66efd9bcff08893aa4fc021e348dc95bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzoxODo0MlrOHWPkmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzoxODo0MlrOHWPkmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4NTg1MA==", "bodyText": "I think you should use putIfAbsent. That will allow the user to provide a STORE_COMPACTION_STATE_KEY that is different from the default value of true if needed.\nAlso nit: use a constant for the default value", "url": "https://github.com/apache/druid/pull/10413#discussion_r493085850", "createdAt": "2020-09-22T23:18:42Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/CompactionTask.java", "diffHunk": "@@ -422,6 +422,7 @@ ParallelIndexSupervisorTask newTask(String taskId, ParallelIndexIngestionSpec in\n   {\n     final Map<String, Object> newContext = new HashMap<>(getContext());\n     newContext.put(CTX_KEY_APPENDERATOR_TRACKING_TASK_ID, getId());\n+    newContext.put(CompactSegments.STORE_COMPACTION_STATE_KEY, getContextValue(Tasks.STORE_COMPACTION_STATE_KEY, true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c9727e66efd9bcff08893aa4fc021e348dc95bc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "committedDate": "2020-09-23T06:48:27Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTA2MDgw", "url": "https://github.com/apache/druid/pull/10413#pullrequestreview-494906080", "createdAt": "2020-09-23T17:52:03Z", "commit": {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzo1MjowM1rOHW58Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzo1MjowM1rOHW58Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc3OTk3NQ==", "bodyText": "Suggested re-write to talk about the problem an admin would be looking to solve more explicitly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you want to retrieve segment that was compacted (ANY compaction):\n          \n          \n            \n            \n          \n          \n            \n            ```sql\n          \n          \n            \n            SELECT * FROM sys.segments WHERE last_compaction_state is not null\n          \n          \n            \n            ```\n          \n          \n            \n            If you want to know whether segments in the wikipedia table are not compacted, and therefore may be contributing to query slowness, you can run a query like this to tell you how many segments have not been compacted per interval.\n          \n          \n            \n            \n          \n          \n            \n            ```sql\n          \n          \n            \n            SELECT start, end, count(*) FROM sys.segments WHERE datasource = 'wikipedia' and last_compaction_state is not null group by 1, 2\n          \n      \n    \n    \n  \n\nIf you find that queries that hit these intervals are slow - consider enabling compaction to produce more optimal segments.", "url": "https://github.com/apache/druid/pull/10413#discussion_r493779975", "createdAt": "2020-09-23T17:52:03Z", "author": {"login": "suneet-s"}, "path": "docs/querying/sql.md", "diffHunk": "@@ -1108,6 +1108,18 @@ GROUP BY 1\n ORDER BY 2 DESC\n ```\n \n+If you want to retrieve segment that was compacted (ANY compaction):\n+\n+```sql\n+SELECT * FROM sys.segments WHERE last_compaction_state is not null\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTA4NjMx", "url": "https://github.com/apache/druid/pull/10413#pullrequestreview-494908631", "createdAt": "2020-09-23T17:55:27Z", "commit": {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzo1NToyN1rOHW6EBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzo1NToyN1rOHW6EBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MjAyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            or if you want to retrieve segment that was compacted only by a particular compaction spec (such as that of the auto compaction):\n          \n          \n            \n            Sometimes, you may have updated your compaction spec to a more optimal spec. In these cases you can find which segments are using the latest compaction spec using a query like the one below:\n          \n      \n    \n    \n  \n\nCan you also add instructions on how to produce the last_compaction_state blob from the web console. If I'm looking at the compaction config for a datasource - can I copy something to paste in the where clause here?", "url": "https://github.com/apache/druid/pull/10413#discussion_r493782020", "createdAt": "2020-09-23T17:55:27Z", "author": {"login": "suneet-s"}, "path": "docs/querying/sql.md", "diffHunk": "@@ -1108,6 +1108,18 @@ GROUP BY 1\n ORDER BY 2 DESC\n ```\n \n+If you want to retrieve segment that was compacted (ANY compaction):\n+\n+```sql\n+SELECT * FROM sys.segments WHERE last_compaction_state is not null\n+```\n+\n+or if you want to retrieve segment that was compacted only by a particular compaction spec (such as that of the auto compaction):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3668, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}