{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzA0MzI4", "number": 10441, "title": "vectorized group by support for nullable numeric columns", "bodyText": "Description\nThis PR adds support for the vectorized group by engine to group by numeric columns with null values, using a similar approach to the non-vectorized engine of storing an extra byte in the key to hold information about whether the value is null or not. I modified the signature of the methods on VectorColumnProcessorFactory to include ColumnCapabilities for the selector, so that GroupByVectorColumnSelectorFactory methods could check capabilities.hasNulls().isFalse() to continue to use the existing processors, and only use the newly added null handling processors when there are actually null values to deal with.\nIn the process of adding tests for this, I also uncovered another issue with the SpillingGrouper when grouping on double values, where sometimes when making the round trip through serde they end up as floats, resulting in a cast exception when run through the comparator. To fix this issue I modified the comparators in RowBasedGrouperHelper to check for double typed keys and coerce both values to be doubles. A more proper fix would be to rework the SpillingGrouper completely so that the key serde just reads/writes directly instead of going through json generator, but that was too much for this PR, so I shall leave that for follow-up work.\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-27T10:45:15Z", "url": "https://github.com/apache/druid/pull/10441", "merged": true, "mergeCommit": {"oid": "207ef310f221f105e534914cdcb3650748a23c71"}, "closed": true, "closedAt": "2020-10-06T04:53:53Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdM7CRAAH2gAyNDkzNzA0MzI4OjY4OTkwM2ZhYzY5MTQ1NTI0YTlmMWRkNDIwNDJiN2MxNjBjNWMxZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPsn_QAH2gAyNDkzNzA0MzI4OjQ2Yzk5Y2Y0MGQ2NGQ0MGExMmRmZGU2N2NlNzQwZGFmZmU4YWNiMzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "689903fac69145524a9f1dd42042b7c160c5c1e7", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/689903fac69145524a9f1dd42042b7c160c5c1e7", "committedDate": "2020-09-27T08:51:12Z", "message": "vectorized group by support for numeric null columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "311d744267fa8259ac6c30babfcd8a634860d570", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/311d744267fa8259ac6c30babfcd8a634860d570", "committedDate": "2020-09-27T10:37:12Z", "message": "revert unintended change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "486b2f0b17783b075bdad713058e682b33dd47d4", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/486b2f0b17783b075bdad713058e682b33dd47d4", "committedDate": "2020-09-28T06:17:08Z", "message": "adjust"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNDcwNjYz", "url": "https://github.com/apache/druid/pull/10441#pullrequestreview-502470663", "createdAt": "2020-10-05T22:42:55Z", "commit": {"oid": "486b2f0b17783b075bdad713058e682b33dd47d4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjo0Mjo1NlrOHcwLZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjo1MzowOVrOHcwXyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMTUyNQ==", "bodyText": "nit: an error message would help debugging if it really happened.", "url": "https://github.com/apache/druid/pull/10441#discussion_r499911525", "createdAt": "2020-10-05T22:42:56Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/vector/GroupByVectorColumnProcessorFactory.java", "diffHunk": "@@ -39,32 +42,58 @@ public static GroupByVectorColumnProcessorFactory instance()\n   }\n \n   @Override\n-  public GroupByVectorColumnSelector makeSingleValueDimensionProcessor(final SingleValueDimensionVectorSelector selector)\n+  public GroupByVectorColumnSelector makeSingleValueDimensionProcessor(\n+      final ColumnCapabilities capabilities,\n+      final SingleValueDimensionVectorSelector selector\n+  )\n   {\n+    Preconditions.checkArgument(ValueType.STRING == capabilities.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486b2f0b17783b075bdad713058e682b33dd47d4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNDY5Nw==", "bodyText": "nit: Byte.BYTES", "url": "https://github.com/apache/druid/pull/10441#discussion_r499914697", "createdAt": "2020-10-05T22:53:09Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/epinephelinae/vector/NullableDoubleGroupByVectorColumnSelector.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.groupby.epinephelinae.vector;\n+\n+import org.apache.datasketches.memory.Memory;\n+import org.apache.datasketches.memory.WritableMemory;\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.groupby.ResultRow;\n+import org.apache.druid.segment.vector.VectorValueSelector;\n+\n+public class NullableDoubleGroupByVectorColumnSelector implements GroupByVectorColumnSelector\n+{\n+  private final VectorValueSelector selector;\n+\n+  NullableDoubleGroupByVectorColumnSelector(final VectorValueSelector selector)\n+  {\n+    this.selector = selector;\n+  }\n+\n+  @Override\n+  public int getGroupingKeySize()\n+  {\n+    return 1 + Double.BYTES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486b2f0b17783b075bdad713058e682b33dd47d4"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8773568cc0f9e0eb37cdc89a1857508c3fded26f", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/8773568cc0f9e0eb37cdc89a1857508c3fded26f", "committedDate": "2020-10-05T23:45:23Z", "message": "review stuffs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46c99cf40d64d40a12dfde67ce740daffe8acb33", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/46c99cf40d64d40a12dfde67ce740daffe8acb33", "committedDate": "2020-10-05T23:45:36Z", "message": "Merge remote-tracking branch 'upstream/master' into vector-group-by-numeric-null"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3294, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}