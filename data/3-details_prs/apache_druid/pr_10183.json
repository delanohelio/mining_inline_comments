{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NjAzMDMz", "number": 10183, "title": "Fix sys.servers table to not throw NPE and handle brokers/indexers/peons properly for broadcast segments", "bodyText": "Description\nThe servers table can throw NPE if you have a historical that announced its node role, but not itself in the server view (server can be null at here). This PR fixes this NPE and cleans up some unnecessary method calls. It also fixes the servers table to handle optional data servers which can serve broadcast segments. After this PR, the servers table will return all fields properly if they are found in the server view. Otherwise, some fields such as tier, maxSize, and currentSize will be filled with nulls. I reverted the null handling change to not change the current behavior. If we want to fix the null handling, we should fix it for all tables in system schema and information schema. It would be better to do in a separate PR, probably along with #9896.\nThe web console changes are not included in this PR. There will be a follow-up for it.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-07-14T02:24:04Z", "url": "https://github.com/apache/druid/pull/10183", "merged": true, "mergeCommit": {"oid": "26d099f39b8a0c86f16cc434bf997ba26104b6d6"}, "closed": true, "closedAt": "2020-07-22T00:52:51Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0scwzgH2gAyNDQ4NjAzMDMzOjhmZWQ0MWNkNzY1MDI1NzQ5MTM5MDkyZmI3OGE1ZDU4MTA0ZDViZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc26trpgH2gAyNDQ4NjAzMDMzOjhlM2MwNDM2ZTJhODFmM2U3YjM2NDdlZGFkNWJiNGIyZDE4ZmZhNWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8fed41cd765025749139092fb78a5d58104d5bf5", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/8fed41cd765025749139092fb78a5d58104d5bf5", "committedDate": "2020-07-14T02:17:23Z", "message": "Fix sys.servers table to not throw NPE and handle brokers/indexers/peons properly for broadcast segments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ebe45f5f24deeca7fffd6d414da6dfaf84f21ff", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/9ebe45f5f24deeca7fffd6d414da6dfaf84f21ff", "committedDate": "2020-07-14T18:14:52Z", "message": "fix tests and add missing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cc0d5395fdc32ad0593c6488dd355b62b380346", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/3cc0d5395fdc32ad0593c6488dd355b62b380346", "committedDate": "2020-07-16T02:02:27Z", "message": "revert null handling fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b03d206425cef5e697d2b22b185c84470bea50e0", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b03d206425cef5e697d2b22b185c84470bea50e0", "committedDate": "2020-07-16T03:21:27Z", "message": "unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTQxMjIy", "url": "https://github.com/apache/druid/pull/10183#pullrequestreview-451941222", "createdAt": "2020-07-20T20:37:44Z", "commit": {"oid": "b03d206425cef5e697d2b22b185c84470bea50e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTQyMDIx", "url": "https://github.com/apache/druid/pull/10183#pullrequestreview-451942021", "createdAt": "2020-07-20T20:38:57Z", "commit": {"oid": "b03d206425cef5e697d2b22b185c84470bea50e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDozODo1N1rOG0ebuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDozODo1N1rOG0ebuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3Nzc1Mg==", "bodyText": "should this precondition check isDiscoverableDataServer?", "url": "https://github.com/apache/druid/pull/10183#discussion_r457677752", "createdAt": "2020-07-20T20:38:57Z", "author": {"login": "clintropolis"}, "path": "server/src/main/java/org/apache/druid/discovery/DiscoveryDruidNode.java", "diffHunk": "@@ -80,6 +84,16 @@ public DruidNode getDruidNode()\n     return druidNode;\n   }\n \n+  public boolean isDiscoverableDataServer()\n+  {\n+    final DruidService druidService = services.get(DataNodeService.DISCOVERY_SERVICE_KEY);\n+    if (druidService == null) {\n+      return false;\n+    }\n+    final DataNodeService dataNodeService = (DataNodeService) druidService;\n+    return dataNodeService.isDiscoverable();\n+  }\n+\n   public DruidServer toDruidServer()\n   {\n     return new DruidServer(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03d206425cef5e697d2b22b185c84470bea50e0"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e3c0436e2a81f3e7b3647edad5bb4b2d18ffa5e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/8e3c0436e2a81f3e7b3647edad5bb4b2d18ffa5e", "committedDate": "2020-07-21T00:02:23Z", "message": "move out util methods from DiscoveryDruidNode"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1850, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}