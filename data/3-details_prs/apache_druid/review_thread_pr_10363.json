{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMzA4MjY5", "number": 10363, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowMzo1MVrOEhEo_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMToxODo1MlrOEq-cCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE0NDk0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowMzo1MVrOHOL9Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozMDowM1rOHONNBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNzk1OA==", "bodyText": "Please roll back useless code formatting.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484637958", "createdAt": "2020-09-08T04:03:51Z", "author": {"login": "asdf2014"}, "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,11 +34,17 @@\n public class LeastBytesUsedStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n   private static final Ordering<StorageLocation> ORDERING = Ordering.from(Comparator\n-      .comparingLong(StorageLocation::currSizeBytes));\n+                                                                              .comparingLong(StorageLocation::currSizeBytes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1ODQzNg==", "bodyText": "It's accidentally formatted by IDEA. Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484658436", "createdAt": "2020-09-08T05:30:03Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,11 +34,17 @@\n public class LeastBytesUsedStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n   private static final Ordering<StorageLocation> ORDERING = Ordering.from(Comparator\n-      .comparingLong(StorageLocation::currSizeBytes));\n+                                                                              .comparingLong(StorageLocation::currSizeBytes));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNzk1OA=="}, "originalCommit": null, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE0NTUyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/MostAvailableSizeStorageLocationSelectorStrategy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowNDoxM1rOHOL9UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozMDowOVrOHONNIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODAzMw==", "bodyText": "Please roll back useless code formatting.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484638033", "createdAt": "2020-09-08T04:04:13Z", "author": {"login": "asdf2014"}, "path": "server/src/main/java/org/apache/druid/segment/loading/MostAvailableSizeStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,12 +34,18 @@\n public class MostAvailableSizeStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n   private static final Ordering<StorageLocation> ORDERING = Ordering.from(Comparator\n-      .comparingLong(StorageLocation::availableSizeBytes)\n-      .reversed());\n+                                                                              .comparingLong(StorageLocation::availableSizeBytes)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1ODQ2Nw==", "bodyText": "It's accidentally formatted by IDEA. Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484658467", "createdAt": "2020-09-08T05:30:09Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/MostAvailableSizeStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,12 +34,18 @@\n public class MostAvailableSizeStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n   private static final Ordering<StorageLocation> ORDERING = Ordering.from(Comparator\n-      .comparingLong(StorageLocation::availableSizeBytes)\n-      .reversed());\n+                                                                              .comparingLong(StorageLocation::availableSizeBytes)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODAzMw=="}, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE0Nzg4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/RandomStorageLocationSelectorStrategy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowNTo0OVrOHOL-mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozMjo0NlrOHONQmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODM2Mg==", "bodyText": "The default values \u200b\u200bof reference types in Java are all null, so assigning null here should be meaningless.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484638362", "createdAt": "2020-09-08T04:05:49Z", "author": {"login": "asdf2014"}, "path": "server/src/main/java/org/apache/druid/segment/loading/RandomStorageLocationSelectorStrategy.java", "diffHunk": "@@ -31,9 +34,15 @@\n public class RandomStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n \n-  private final List<StorageLocation> storageLocations;\n+  private List<StorageLocation> storageLocations = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1OTM1Mw==", "bodyText": "IDEA reports an assignment of null is required due to some customized check rules. Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484659353", "createdAt": "2020-09-08T05:32:46Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/RandomStorageLocationSelectorStrategy.java", "diffHunk": "@@ -31,9 +34,15 @@\n public class RandomStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n \n-  private final List<StorageLocation> storageLocations;\n+  private List<StorageLocation> storageLocations = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODM2Mg=="}, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE0ODA5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/RoundRobinStorageLocationSelectorStrategy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowNTo1OFrOHOL-uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozMzowNFrOHONQ1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODM5Mw==", "bodyText": "The default values \u200b\u200bof reference types in Java are all null, so assigning null here should be meaningless.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484638393", "createdAt": "2020-09-08T04:05:58Z", "author": {"login": "asdf2014"}, "path": "server/src/main/java/org/apache/druid/segment/loading/RoundRobinStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,19 +35,25 @@\n  */\n public class RoundRobinStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n-\n-  private final List<StorageLocation> storageLocations;\n+  private List<StorageLocation> storageLocations = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1OTQxMg==", "bodyText": "Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484659412", "createdAt": "2020-09-08T05:33:04Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/RoundRobinStorageLocationSelectorStrategy.java", "diffHunk": "@@ -32,19 +35,25 @@\n  */\n public class RoundRobinStorageLocationSelectorStrategy implements StorageLocationSelectorStrategy\n {\n-\n-  private final List<StorageLocation> storageLocations;\n+  private List<StorageLocation> storageLocations = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODM5Mw=="}, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE1MDQ2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowNzo0MFrOHOMAFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozNDozMlrOHONSng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODc0MQ==", "bodyText": "In the newly added test cases, the throw Exception statement needs to be removed to pass the travis CI.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484638741", "createdAt": "2020-09-08T04:07:40Z", "author": {"login": "asdf2014"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +269,75 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig() throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1OTg3MA==", "bodyText": "throws declaration is useless here, maybe is introduced by code copy-paste. Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484659870", "createdAt": "2020-09-08T05:34:32Z", "author": {"login": "FrankChen021"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +269,75 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig() throws Exception", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODc0MQ=="}, "originalCommit": null, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE1NTE4OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDoxMTowM1rOHOMC0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozNToxNFrOHONTmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzOTQ0Mg==", "bodyText": "Although Properties inherits from Hashtable and can call the put method, it is recommended to use the setProperty method. In this way, you can forcibly restrict the incoming Key and Value of the String type to avoid an error when you call store or save again after passing in non-String data.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484639442", "createdAt": "2020-09-08T04:11:03Z", "author": {"login": "asdf2014"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +269,75 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig() throws Exception\n+  {\n+    //no druid.segmentCache.locationSelectorStrategy.type specified\n+    final Properties props = new Properties();\n+    SegmentLoaderConfig loaderConfig = makeInjectorWithProperties(props).getInstance(SegmentLoaderConfig.class);\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        loaderConfig.getStorageLocationSelectorStrategy().getClass());\n+  }\n+\n+  @Test\n+  public void testRoundRobinSelectorStrategyConfig() throws Exception\n+  {\n+    final Properties props = new Properties();\n+    props.put(\"druid.segmentCache.locationSelectorStrategy.type\", \"roundRobin\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2MDEyMg==", "bodyText": "Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484660122", "createdAt": "2020-09-08T05:35:14Z", "author": {"login": "FrankChen021"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +269,75 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig() throws Exception\n+  {\n+    //no druid.segmentCache.locationSelectorStrategy.type specified\n+    final Properties props = new Properties();\n+    SegmentLoaderConfig loaderConfig = makeInjectorWithProperties(props).getInstance(SegmentLoaderConfig.class);\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        loaderConfig.getStorageLocationSelectorStrategy().getClass());\n+  }\n+\n+  @Test\n+  public void testRoundRobinSelectorStrategyConfig() throws Exception\n+  {\n+    final Properties props = new Properties();\n+    props.put(\"druid.segmentCache.locationSelectorStrategy.type\", \"roundRobin\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzOTQ0Mg=="}, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTE1OTAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderLocalCacheManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDoxMzo0OVrOHOMFEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNTozNToxN1rOHONTqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY0MDAxOA==", "bodyText": "Generally, the first letter of the exception information needs to be capitalized. In addition, %s needs to be surrounded by square brackets. So please use Using storage location strategy: [%s].", "url": "https://github.com/apache/druid/pull/10363#discussion_r484640018", "createdAt": "2020-09-08T04:13:49Z", "author": {"login": "asdf2014"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderLocalCacheManager.java", "diffHunk": "@@ -99,7 +99,10 @@ public SegmentLoaderLocalCacheManager(\n           )\n       );\n     }\n-    this.strategy = config.getStorageLocationSelectorStrategy(locations);\n+\n+    this.strategy = config.getStorageLocationSelectorStrategy();\n+    this.strategy.setLocations(locations);\n+    log.info(\"using storage location strategy: %s\", this.strategy.getClass().getSimpleName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2MDEzOQ==", "bodyText": "Been fixed.", "url": "https://github.com/apache/druid/pull/10363#discussion_r484660139", "createdAt": "2020-09-08T05:35:17Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderLocalCacheManager.java", "diffHunk": "@@ -99,7 +99,10 @@ public SegmentLoaderLocalCacheManager(\n           )\n       );\n     }\n-    this.strategy = config.getStorageLocationSelectorStrategy(locations);\n+\n+    this.strategy = config.getStorageLocationSelectorStrategy();\n+    this.strategy.setLocations(locations);\n+    log.info(\"using storage location strategy: %s\", this.strategy.getClass().getSimpleName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY0MDAxOA=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDY4OTkyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDo1MDozMlrOHOtjyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoyMzo0NlrOHO8OfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4ODU1Mg==", "bodyText": "I think this approach is brittle and might break when a new implementation of StorageLocationSelectorStrategy is added. Instead, I think we should make List<StorageLocation> storageLocations injectable instead via a module, something like\n@Provides\n@Singleton\npublic List<StorageLocation> provideStorageLocations(SegmentLoaderConfig config)\n{\n  this.locations = new ArrayList<>();\n  for (StorageLocationConfig locationConfig : config.getLocations()) {\n    locations.add(\n        new StorageLocation(\n            locationConfig.getPath(),\n            locationConfig.getMaxSize(),\n            locationConfig.getFreeSpacePercent()\n        )\n    );\nreturn locations;\n}", "url": "https://github.com/apache/druid/pull/10363#discussion_r485188552", "createdAt": "2020-09-08T20:50:32Z", "author": {"login": "suneet-s"}, "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "diffHunk": "@@ -36,7 +38,13 @@\n \n   private List<StorageLocation> storageLocations;\n \n-  public LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)\n+  @JsonCreator\n+  public LeastBytesUsedStorageLocationSelectorStrategy()\n+  {\n+  }\n+\n+  @VisibleForTesting\n+  LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4Mjg2OQ==", "bodyText": "Good idea.", "url": "https://github.com/apache/druid/pull/10363#discussion_r485282869", "createdAt": "2020-09-09T01:27:00Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "diffHunk": "@@ -36,7 +38,13 @@\n \n   private List<StorageLocation> storageLocations;\n \n-  public LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)\n+  @JsonCreator\n+  public LeastBytesUsedStorageLocationSelectorStrategy()\n+  {\n+  }\n+\n+  @VisibleForTesting\n+  LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4ODU1Mg=="}, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyODg2MQ==", "bodyText": "Hi @suneet-s I check the code and find that this approach is a little bit complex for the existing code.\nStorage selector strategy object is constructed during deserialization of SegmentLoaderConfig,  and only after the construction of SegmentLoaderConfig, could it be possible to inject SegmentLoaderConfig to other objects to get list of StorageLocationConfig inside the object.\nIf we want to inject StorageLocation objects as the way you suggest, the strategy object must be separated from SegmentLoaderConfig into another new config class so that both SegmentLoaderConfig and this new config class can be injected into SegmentLocalCacheManager.  There will be lots of test cases involved to change to meet the new ctor of SegmentLocalCacheManager. So I think these change involve more complexity.\nBack to the concern you mentioned, I think there's no need to worry that new implementation would break the constraints. Because if it breaks,  the problem would be easily detected during unit test or integrated test.\nWhat do you think ?", "url": "https://github.com/apache/druid/pull/10363#discussion_r485428861", "createdAt": "2020-09-09T08:23:46Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/LeastBytesUsedStorageLocationSelectorStrategy.java", "diffHunk": "@@ -36,7 +38,13 @@\n \n   private List<StorageLocation> storageLocations;\n \n-  public LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)\n+  @JsonCreator\n+  public LeastBytesUsedStorageLocationSelectorStrategy()\n+  {\n+  }\n+\n+  @VisibleForTesting\n+  LeastBytesUsedStorageLocationSelectorStrategy(List<StorageLocation> storageLocations)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4ODU1Mg=="}, "originalCommit": null, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDY5OTg1OnYy", "diffSide": "RIGHT", "path": "docs/configuration/index.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDo1Mzo1NVrOHOtqGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMTozMjo1NlrOHOza-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5MDE3MQ==", "bodyText": "Is this a doc fix? I don't see an associated change in the code. Am I missing something?", "url": "https://github.com/apache/druid/pull/10363#discussion_r485190171", "createdAt": "2020-09-08T20:53:55Z", "author": {"login": "suneet-s"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1379,7 +1379,7 @@ These Historical configurations can be defined in the `historical/runtime.proper\n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.segmentCache.locations`|Segments assigned to a Historical process are first stored on the local file system (in a disk cache) and then served by the Historical process. These locations define where that local cache resides. This value cannot be NULL or EMPTY. Here is an example `druid.segmentCache.locations=[{\"path\": \"/mnt/druidSegments\", \"maxSize\": \"10k\", \"freeSpacePercent\": 1.0}]`. \"freeSpacePercent\" is optional, if provided then enforces that much of free disk partition space while storing segments. But, it depends on File.getTotalSpace() and File.getFreeSpace() methods, so enable if only if they work for your File System.| none |\n-|`druid.segmentCache.locationSelectorStrategy`|The strategy used to select a location from the configured `druid.segmentCache.locations` for segment distribution. Possible values are `leastBytesUsed`, `roundRobin`, `random`, or `mostAvailableSize`. |leastBytesUsed|\n+|`druid.segmentCache.locationSelectorStrategy.type`|The strategy used to select a location from the configured `druid.segmentCache.locations` for segment distribution. Possible values are `leastBytesUsed`, `roundRobin`, `random`, or `mostAvailableSize`. |leastBytesUsed|", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4NDYwMQ==", "bodyText": "It's a fix.  According to original code, annotation on StorageLocationSelectorStrategy indicates the name of json property is type.  When using druid.segmentCache.locationSelectorStrategy, jackson tries to find ctor with a String parameter , which causes the issue.", "url": "https://github.com/apache/druid/pull/10363#discussion_r485284601", "createdAt": "2020-09-09T01:32:56Z", "author": {"login": "FrankChen021"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1379,7 +1379,7 @@ These Historical configurations can be defined in the `historical/runtime.proper\n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.segmentCache.locations`|Segments assigned to a Historical process are first stored on the local file system (in a disk cache) and then served by the Historical process. These locations define where that local cache resides. This value cannot be NULL or EMPTY. Here is an example `druid.segmentCache.locations=[{\"path\": \"/mnt/druidSegments\", \"maxSize\": \"10k\", \"freeSpacePercent\": 1.0}]`. \"freeSpacePercent\" is optional, if provided then enforces that much of free disk partition space while storing segments. But, it depends on File.getTotalSpace() and File.getFreeSpace() methods, so enable if only if they work for your File System.| none |\n-|`druid.segmentCache.locationSelectorStrategy`|The strategy used to select a location from the configured `druid.segmentCache.locations` for segment distribution. Possible values are `leastBytesUsed`, `roundRobin`, `random`, or `mostAvailableSize`. |leastBytesUsed|\n+|`druid.segmentCache.locationSelectorStrategy.type`|The strategy used to select a location from the configured `druid.segmentCache.locations` for segment distribution. Possible values are `leastBytesUsed`, `roundRobin`, `random`, or `mostAvailableSize`. |leastBytesUsed|", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5MDE3MQ=="}, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NTc4OTM4OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderConfig.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNTo1MjoyOVrOHTSaGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMTozOToyMFrOHWSXEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NjU4Ng==", "bodyText": "I think the previous implementation is better since you can use the configuration name druid.segmentCache.locationSelectorStrategy without type. Is there a reason that locationSelectorStrategy cannot be here?", "url": "https://github.com/apache/druid/pull/10363#discussion_r489986586", "createdAt": "2020-09-17T05:52:29Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderConfig.java", "diffHunk": "@@ -54,9 +54,6 @@\n   @JsonProperty(\"numBootstrapThreads\")\n   private Integer numBootstrapThreads = null;\n \n-  @JsonProperty(\"locationSelectorStrategy\")\n-  private StorageLocationSelectorStrategy locationSelectorStrategy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE0MTg2NA==", "bodyText": "This is because StorageLocationStrategy depends on SegmentLoaderConfig.locations. If StorageLocationStrategy is placed here, when SegmentLoaderConfig is being deserialized, locations required by StorageLocationStrategy can't be found and injected into it.\nAfter moving this property out of SegmentLoaderConfig, both SegmentLoaderConfig and StorageLocationStrategy are deserialized during construction of SegmentLoaderLocalCacheManager, and jackson could find the locations objects required by strategy object through google guice framework to create strategy object correctly.\nUsing the configuration name without type I think is wrong. Please take a look at this configuration druid.coordinator.balancer.strategy, or the clarification on the change of configuration name I left above.", "url": "https://github.com/apache/druid/pull/10363#discussion_r490141864", "createdAt": "2020-09-17T10:34:50Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderConfig.java", "diffHunk": "@@ -54,9 +54,6 @@\n   @JsonProperty(\"numBootstrapThreads\")\n   private Integer numBootstrapThreads = null;\n \n-  @JsonProperty(\"locationSelectorStrategy\")\n-  private StorageLocationSelectorStrategy locationSelectorStrategy;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NjU4Ng=="}, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ0Mjg4Mg==", "bodyText": "Got it. Then, how about using a similar naming to the coordinator balancer? For example, we can bind StorageLocationSelectorStrategy to druid.segmentCache.locationSelector, and use a strategy property name for StorageLocationSelectorStrategy instead of type.", "url": "https://github.com/apache/druid/pull/10363#discussion_r490442882", "createdAt": "2020-09-17T17:41:46Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderConfig.java", "diffHunk": "@@ -54,9 +54,6 @@\n   @JsonProperty(\"numBootstrapThreads\")\n   private Integer numBootstrapThreads = null;\n \n-  @JsonProperty(\"locationSelectorStrategy\")\n-  private StorageLocationSelectorStrategy locationSelectorStrategy;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NjU4Ng=="}, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEzMTUzOA==", "bodyText": "Sorry for the late reply.\nYour suggestion makes the naming more meaningful. I'll update this PR later this day.", "url": "https://github.com/apache/druid/pull/10363#discussion_r493131538", "createdAt": "2020-09-23T01:39:20Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/segment/loading/SegmentLoaderConfig.java", "diffHunk": "@@ -54,9 +54,6 @@\n   @JsonProperty(\"numBootstrapThreads\")\n   private Integer numBootstrapThreads = null;\n \n-  @JsonProperty(\"locationSelectorStrategy\")\n-  private StorageLocationSelectorStrategy locationSelectorStrategy;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NjU4Ng=="}, "originalCommit": null, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDk3OTMwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/druid/guice/StorageNodeModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMToxNDo0NFrOHdfKhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDoyNjowOFrOHdswfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY4MTM1MA==", "bodyText": "Should this be druid.segmentCache.locationSelector instead?", "url": "https://github.com/apache/druid/pull/10363#discussion_r500681350", "createdAt": "2020-10-07T01:14:44Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/guice/StorageNodeModule.java", "diffHunk": "@@ -52,6 +55,7 @@ public void configure(Binder binder)\n   {\n     JsonConfigProvider.bind(binder, \"druid.server\", DruidServerConfig.class);\n     JsonConfigProvider.bind(binder, \"druid.segmentCache\", SegmentLoaderConfig.class);\n+    JsonConfigProvider.bind(binder, \"druid.segmentCache.locationSelector.strategy\", StorageLocationSelectorStrategy.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkwNDA2MQ==", "bodyText": "Oh sorry, this is a bug. I remember I tested it in my cluster, maybe I missed something then. The code has been updated in the latest commit.", "url": "https://github.com/apache/druid/pull/10363#discussion_r500904061", "createdAt": "2020-10-07T10:26:08Z", "author": {"login": "FrankChen021"}, "path": "server/src/main/java/org/apache/druid/guice/StorageNodeModule.java", "diffHunk": "@@ -52,6 +55,7 @@ public void configure(Binder binder)\n   {\n     JsonConfigProvider.bind(binder, \"druid.server\", DruidServerConfig.class);\n     JsonConfigProvider.bind(binder, \"druid.segmentCache\", SegmentLoaderConfig.class);\n+    JsonConfigProvider.bind(binder, \"druid.segmentCache.locationSelector.strategy\", StorageLocationSelectorStrategy.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY4MTM1MA=="}, "originalCommit": null, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDk4NjM0OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMToxODo1MlrOHdfOxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDoyMzoyNlrOHdsqUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY4MjQzNg==", "bodyText": "This binding is different from what actual module binds. I think this is why we missed the wrong binding. Can we use the same StorageNodeModule here? Or can we add a helper method which does the proper binding for both StorageNodeModule and tests?", "url": "https://github.com/apache/druid/pull/10363#discussion_r500682436", "createdAt": "2020-10-07T01:18:52Z", "author": {"login": "jihoonson"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +270,107 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig()\n+  {\n+    //no druid.segmentCache.locationSelector.strategy specified, the default will be used\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+\n+    StorageLocationSelectorStrategy strategy = makeInjectorWithProperties(props).getInstance(StorageLocationSelectorStrategy.class);\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testRoundRobinSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"roundRobin\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(RoundRobinStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testLeastBytesUsedSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"leastBytesUsed\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testRandomSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"random\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(RandomStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testMostAvailableSizeSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"mostAvailableSize\");\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(MostAvailableSizeStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  private Injector makeInjectorWithProperties(final Properties props)\n+  {\n+    return Guice.createInjector(\n+        new Module()\n+          {\n+            @Override\n+            public void configure(Binder binder)\n+            {\n+              //ObjectMapperModule introduce Guice injector for jackson\n+              binder.install(new ObjectMapperModule()\n+                                 .withObjectMapper(new DefaultObjectMapper()));\n+              binder.install(new DruidGuiceExtensions());\n+\n+              binder.bind(Validator.class).toInstance(Validation.buildDefaultValidatorFactory().getValidator());\n+              binder.bind(JsonConfigurator.class).in(LazySingleton.class);\n+              binder.bind(Properties.class).toInstance(props);\n+\n+              JsonConfigProvider.bind(binder, \"druid.segmentCache\", SegmentLoaderConfig.class);\n+              JsonConfigProvider.bind(binder, \"druid.segmentCache.locationSelector\", StorageLocationSelectorStrategy.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkwMjQ4Mw==", "bodyText": "The reason why StorageModule is not used here is because there're some extra dependencies in StorageModule, which might introduce lots of injection code in test cases. A helper method is extracted to do the correct binding.", "url": "https://github.com/apache/druid/pull/10363#discussion_r500902483", "createdAt": "2020-10-07T10:23:26Z", "author": {"login": "FrankChen021"}, "path": "server/src/test/java/org/apache/druid/segment/loading/StorageLocationSelectorStrategyTest.java", "diffHunk": "@@ -256,4 +270,107 @@ public void testMostAvailableSizeLocationSelectorStrategy() throws Exception\n     Assert.assertEquals(\"The next element of the iterator should point to path local_storage_folder_1\",\n         localStorageFolder1, loc3.getPath());\n   }\n+\n+  @Test\n+  public void testDefaultSelectorStrategyConfig()\n+  {\n+    //no druid.segmentCache.locationSelector.strategy specified, the default will be used\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+\n+    StorageLocationSelectorStrategy strategy = makeInjectorWithProperties(props).getInstance(StorageLocationSelectorStrategy.class);\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testRoundRobinSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"roundRobin\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(RoundRobinStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testLeastBytesUsedSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"leastBytesUsed\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(LeastBytesUsedStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testRandomSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"random\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(RandomStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testMostAvailableSizeSelectorStrategyConfig()\n+  {\n+    final Properties props = new Properties();\n+    props.setProperty(\"druid.segmentCache.locationSelector.strategy\", \"mostAvailableSize\");\n+    props.setProperty(\"druid.segmentCache.locations\", \"[{\\\"path\\\": \\\"/tmp/druid/indexCache\\\"}]\");\n+\n+    Injector injector = makeInjectorWithProperties(props);\n+    StorageLocationSelectorStrategy strategy = injector.getInstance(StorageLocationSelectorStrategy.class);\n+\n+    Assert.assertEquals(MostAvailableSizeStorageLocationSelectorStrategy.class,\n+                        strategy.getClass());\n+    Assert.assertEquals(\"/tmp/druid/indexCache\", strategy.getLocations().next().getPath().getAbsolutePath());\n+  }\n+\n+  private Injector makeInjectorWithProperties(final Properties props)\n+  {\n+    return Guice.createInjector(\n+        new Module()\n+          {\n+            @Override\n+            public void configure(Binder binder)\n+            {\n+              //ObjectMapperModule introduce Guice injector for jackson\n+              binder.install(new ObjectMapperModule()\n+                                 .withObjectMapper(new DefaultObjectMapper()));\n+              binder.install(new DruidGuiceExtensions());\n+\n+              binder.bind(Validator.class).toInstance(Validation.buildDefaultValidatorFactory().getValidator());\n+              binder.bind(JsonConfigurator.class).in(LazySingleton.class);\n+              binder.bind(Properties.class).toInstance(props);\n+\n+              JsonConfigProvider.bind(binder, \"druid.segmentCache\", SegmentLoaderConfig.class);\n+              JsonConfigProvider.bind(binder, \"druid.segmentCache.locationSelector\", StorageLocationSelectorStrategy.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY4MjQzNg=="}, "originalCommit": null, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3177, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}