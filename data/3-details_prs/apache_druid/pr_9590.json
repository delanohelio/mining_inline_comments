{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MDAxNzkx", "number": 9590, "title": "DruidInputSource can add new dimensions during re-ingestion", "bodyText": "Fixes #9593 #9592\nDescription\nAdd integration tests for using transformSpec during ingestion. The tests test transformSpecs that add metrics and dimensions using both a Druid InputSource and the deprecated ingestSegmentFirehose.\nWriting these tests surfaced #9589 #9591 When these issues are fixed, those tests can be re-enabled.", "createdAt": "2020-03-31T01:19:59Z", "url": "https://github.com/apache/druid/pull/9590", "merged": true, "mergeCommit": {"oid": "af3337dac8091d7499a86014de125b26ed90fbdc"}, "closed": true, "closedAt": "2020-04-03T00:32:32Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS4DyCAH2gAyMzk2MDAxNzkxOjZhNGVlODJhOGZjYmU1Y2M3OWQ5NzNhYmU0ODU3ZTMyZmY2ODY0OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT1z-dgFqTM4Njg2NjY5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a4ee82a8fcbe5cc79d973abe4857e32ff686490", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/6a4ee82a8fcbe5cc79d973abe4857e32ff686490", "committedDate": "2020-03-31T00:35:32Z", "message": "WIP integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045584b0f6fbee9ca5c07117bf6f21d6e2815c8b", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/045584b0f6fbee9ca5c07117bf6f21d6e2815c8b", "committedDate": "2020-03-31T01:17:57Z", "message": "Add integration test for ingestion with transformSpec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQ3MjM1", "url": "https://github.com/apache/druid/pull/9590#pullrequestreview-384347235", "createdAt": "2020-03-31T01:41:09Z", "commit": {"oid": "045584b0f6fbee9ca5c07117bf6f21d6e2815c8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTo0MTowOVrOF-CRow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTo0MTowOVrOF-CRow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MzMxNQ==", "bodyText": "typo in expected results\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"added_count_times_ten\" : 9050.0,\n          \n          \n            \n                            \"added_count_times_ten\" : 27150.0,", "url": "https://github.com/apache/druid/pull/9590#discussion_r400593315", "createdAt": "2020-03-31T01:41:09Z", "author": {"login": "suneet-s"}, "path": "integration-tests/src/test/resources/indexer/wikipedia_index_queries_with_transform.json", "diffHunk": "@@ -0,0 +1,54 @@\n+[\n+    {\n+        \"description\":\"having spec on post aggregation\",\n+        \"query\":{\n+            \"queryType\":\"groupBy\",\n+            \"dataSource\":\"%%DATASOURCE%%\",\n+            \"granularity\":\"day\",\n+            \"dimensions\":[\n+                \"page\"\n+            ],\n+            \"filter\":{\n+                \"type\":\"selector\",\n+                \"dimension\":\"language\",\n+                \"value\":\"language-zh\"\n+            },\n+            \"aggregations\":[\n+                {\n+                    \"type\":\"count\",\n+                    \"name\":\"rows\"\n+                },\n+                {\n+                    \"type\":\"longSum\",\n+                    \"fieldName\":\"triple-added\",\n+                    \"name\":\"added_count\"\n+                }\n+            ],\n+            \"postAggregations\": [\n+                {\n+                    \"type\":\"arithmetic\",\n+                    \"name\":\"added_count_times_ten\",\n+                    \"fn\":\"*\",\n+                    \"fields\":[\n+                        {\"type\":\"fieldAccess\", \"name\":\"added_count\", \"fieldName\":\"added_count\"},\n+                        {\"type\":\"constant\", \"name\":\"const\", \"value\":10}\n+                    ]\n+                }\n+            ],\n+            \"having\":{\"type\":\"greaterThan\", \"aggregation\":\"added_count_times_ten\", \"value\":9000},\n+            \"intervals\":[\n+                \"2013-08-31T00:00/2013-09-01T00:00\"\n+            ]\n+        },\n+        \"expectedResults\":[ {\n+            \"version\" : \"v1\",\n+            \"timestamp\" : \"2013-08-31T00:00:00.000Z\",\n+            \"event\" : {\n+                \"added_count_times_ten\" : 9050.0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "045584b0f6fbee9ca5c07117bf6f21d6e2815c8b"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46ae13bb23811b8337025554ef4e0be2bff6e604", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/46ae13bb23811b8337025554ef4e0be2bff6e604", "committedDate": "2020-03-31T03:00:26Z", "message": "WIP almost working tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608e56846d5c419d6e0f38f92ab73b773239c644", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/608e56846d5c419d6e0f38f92ab73b773239c644", "committedDate": "2020-03-31T03:03:53Z", "message": "Add ignored tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7dd96d66daabb322afd8936a7fca101bd54952", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/0f7dd96d66daabb322afd8936a7fca101bd54952", "committedDate": "2020-03-31T03:55:48Z", "message": "checkstyle stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f10aaabcce7d2675b92b5ba92b2fe0cc290648", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/f6f10aaabcce7d2675b92b5ba92b2fe0cc290648", "committedDate": "2020-03-31T03:58:47Z", "message": "remove newPage from index task ingestion spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "013150d4e0f49798c48c8e19e6cad7909ed3f2c6", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/013150d4e0f49798c48c8e19e6cad7909ed3f2c6", "committedDate": "2020-03-31T04:07:53Z", "message": "more test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db4dc280e35d35c4dc4035c61bc4bfdbeaa59283", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/db4dc280e35d35c4dc4035c61bc4bfdbeaa59283", "committedDate": "2020-03-31T04:15:06Z", "message": "still not quite working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d2c471ac91093f46ae292c42fdddc4a22a20f68", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/8d2c471ac91093f46ae292c42fdddc4a22a20f68", "committedDate": "2020-03-31T04:31:15Z", "message": "Actually disable the tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mzk1ODM0", "url": "https://github.com/apache/druid/pull/9590#pullrequestreview-384395834", "createdAt": "2020-03-31T04:33:26Z", "commit": {"oid": "8d2c471ac91093f46ae292c42fdddc4a22a20f68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNDozMzoyNlrOF-E-Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNDozMzoyNlrOF-E-Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzNzUwNg==", "bodyText": "Using a filter on \"newPage\" (the renamed column) fails the test locally. But if I apply the transformation from another datasource it appears to work. Need to verify if this is actually a bug or not", "url": "https://github.com/apache/druid/pull/9590#discussion_r400637506", "createdAt": "2020-03-31T04:33:26Z", "author": {"login": "suneet-s"}, "path": "integration-tests/src/test/resources/indexer/wikipedia_index_queries_with_transform.json", "diffHunk": "@@ -0,0 +1,54 @@\n+[\n+    {\n+        \"description\":\"having spec on post aggregation\",\n+        \"query\":{\n+            \"queryType\":\"groupBy\",\n+            \"dataSource\":\"%%DATASOURCE%%\",\n+            \"granularity\":\"day\",\n+            \"dimensions\":[\n+                \"page\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2c471ac91093f46ae292c42fdddc4a22a20f68"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9da1c534a5046e1d1af9189405d9b787a300f81d", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/9da1c534a5046e1d1af9189405d9b787a300f81d", "committedDate": "2020-03-31T06:29:13Z", "message": "working tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7afad45495820ca7e297a25316fc3de57d3a6f06", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/7afad45495820ca7e297a25316fc3de57d3a6f06", "committedDate": "2020-03-31T06:30:34Z", "message": "fix codestyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65216e3a583e2e1a2f88aebd66ebb9be5fe40535", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/65216e3a583e2e1a2f88aebd66ebb9be5fe40535", "committedDate": "2020-03-31T07:52:04Z", "message": "dont use junit in integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc8feddc1616c9ecc3b251af918a02dcb1924882", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/fc8feddc1616c9ecc3b251af918a02dcb1924882", "committedDate": "2020-03-31T21:18:12Z", "message": "actually fix the bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53433a2623d7669e6ca80bf91bbd4bb1572c391d", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/53433a2623d7669e6ca80bf91bbd4bb1572c391d", "committedDate": "2020-03-31T21:22:44Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/d5ee5ef38e6f706a2e55f12420d0d0409e048bec", "committedDate": "2020-03-31T21:32:25Z", "message": "bring index tests closer to reindex tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjcyMzAw", "url": "https://github.com/apache/druid/pull/9590#pullrequestreview-385272300", "createdAt": "2020-04-01T05:22:31Z", "commit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTUzOTUz", "url": "https://github.com/apache/druid/pull/9590#pullrequestreview-385953953", "createdAt": "2020-04-01T21:14:26Z", "commit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMToxNDoyNlrOF_S2ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMToxNjoxMVrOF_S6Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxMzUzMA==", "bodyText": "Good catch!", "url": "https://github.com/apache/druid/pull/9590#discussion_r401913530", "createdAt": "2020-04-01T21:14:26Z", "author": {"login": "jihoonson"}, "path": "examples/quickstart/tutorial/transform-index.json", "diffHunk": "@@ -55,7 +55,7 @@\n         \"baseDir\" : \"quickstart/tutorial\",\n         \"filter\" : \"transform-data.json\"\n       },\n-      \"inpuFormat\" : {\n+      \"inputFormat\" : {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxNDQwMg==", "bodyText": "nit: please add description for the return value or remove this.", "url": "https://github.com/apache/druid/pull/9590#discussion_r401914402", "createdAt": "2020-04-01T21:16:11Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/ReingestionTimelineUtils.java", "diffHunk": "@@ -101,4 +103,34 @@\n                     .mapToObj(orderedMetrics::get)\n                     .collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Utility function to get dimensions that should be ingested. The preferred order is\n+   * - Explicit dimensions if they are provided.\n+   * - Custom dimensions are provided in the inputSpec.\n+   * - Calculate dimensions from the timeline but exclude any dimension exclusions.\n+   *\n+   * @param explicitDimensions sent as part of the re-ingestion InputSource.\n+   * @param dimensionsSpec from the provided ingestion spec.\n+   * @param timeLineSegments for the datasource that is being read.\n+   * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODY2Njk3", "url": "https://github.com/apache/druid/pull/9590#pullrequestreview-386866697", "createdAt": "2020-04-03T00:32:23Z", "commit": {"oid": "d5ee5ef38e6f706a2e55f12420d0d0409e048bec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2763, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}