{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDUwOTQ5", "number": 9982, "title": "make joinables closeable", "bodyText": "Description\nThis PR makes Joinable, JoinClause, and IndexedTable implement an interface to allow providing a Closeable to callers to capture the reference counting pattern, so that a future PR can add reference counting for IndexedTable that are backed by a Segment described in proposal #9953. HashJoinSegment now wraps a ReferenceCountingSegment, allowing both the segment reference count to be incremented/decremented when used, and also closing the associated list of JoinClause when the references to the segment are released.\nReferenceCountingSegment has been refactored to extend a new base type, ReferenceCountingClosableObject, which handles the actual reference counting part and prepare for ReferenceCountingIndexedTable (which does not exist yet).\nA new interface, ReferenceCountedObject, has been added to capture the increment() and decrementOnceCloseable() pattern of ReferenceCountingCloseableObject in one closeable:\npublic interface ReferenceCountedObject\n{\n  Optional<Closeable> acquireReferences();\n}\n\nAnother new interface, SegmentReference has been added to capture a Segment which also implements ReferenceCountedObject, or in other words, has references which must be acquired and released:\npublic interface SegmentReference extends Segment, ReferenceCountedObject\n{\n}\n\nThe contract of the acquireReferences method is that an object will return a Closeable if reference count could be incremented, and closing the Closeable is expected to be similar/the same as the underlying decrementOnceCloseable().\nReferenceCountingSegment and HashJoinSegment implement this SegmentReference interface, and ReferenceCountingSegmentQueryRunner now operates on this interface instead of directly using Segment and a ReferenceCounter.\nWith the changes in this PR in place, Joinable may now be backed by an implementation of ReferenceCountingCloseableObject to use to fulfill the ReferenceCountedObject contract, allowing them to be safely dropped when not in use, and this should all be correctly wired up to the various QuerySegmentWalker implementations as of this PR.\nFinally, I have marked AbstractSegment as deprecated, and moved it's only functionality into a default method on the interface to make working with Segment a bit easier. I have not deleted AbstractSegment yet, it's just an empty husk that we can remove in a future release on the off chance that any custom extensions are relying on this class.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.\n\n\nKey changed/added classes in this PR\n\nReferenceCountingSegmentQueryRunner\nReferenceCountingClosableObject\nReferenceCountedObject\nReferenceCountingSegment\nHashJoinSegment\nLocalQuerySegmentWalker\nServerManager\nSinkQuerySegmentWalker and FireHydrant", "createdAt": "2020-06-03T20:53:55Z", "url": "https://github.com/apache/druid/pull/9982", "merged": true, "mergeCommit": {"oid": "f8b643ec720bf34acf84fda01a3d876f98e81bb9"}, "closed": true, "closedAt": "2020-06-10T03:12:37Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnvsHPgH2gAyNDI3NDUwOTQ5OmQ3ODk2ZDUzNzE0ZDRkM2ZiN2E3OTUwMzdmOGVmNDQ4NWZhNTdjODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpvdW_gH2gAyNDI3NDUwOTQ5OmVjZjI0YmY4MjI1N2M5YmM1YTMwMzhjNTQ5ZWQyZmU5N2JhZjE3NDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7896d53714d4d3fb7a795037f8ef4485fa57c82", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/d7896d53714d4d3fb7a795037f8ef4485fa57c82", "committedDate": "2020-06-03T20:42:51Z", "message": "make joinables closeable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68ba6ab23c81cccb852e7d1fae5e37ac4043014", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c68ba6ab23c81cccb852e7d1fae5e37ac4043014", "committedDate": "2020-06-04T09:24:51Z", "message": "tests and adjustments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c01963cd7f7d2d6891170f9aceedbfe080e74bec", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c01963cd7f7d2d6891170f9aceedbfe080e74bec", "committedDate": "2020-06-05T11:41:36Z", "message": "refactor to make join stuffs impelement ReferenceCountedObject instead of Closable, more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8236e0dba7da90a6ea03ae6ebfff9a6f2642caea", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/8236e0dba7da90a6ea03ae6ebfff9a6f2642caea", "committedDate": "2020-06-05T20:47:26Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c32c2c27aa546f1e3170c9f88f01b1094d86fd76", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c32c2c27aa546f1e3170c9f88f01b1094d86fd76", "committedDate": "2020-06-06T04:54:58Z", "message": "javadocs and stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4712207608543708b4f5a54adc180cf27ce9cb3", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/b4712207608543708b4f5a54adc180cf27ce9cb3", "committedDate": "2020-06-08T09:47:28Z", "message": "Merge remote-tracking branch 'upstream/master' into closeable-joinable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c52884284f66faec5037221e4078bbb544379f48", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/c52884284f66faec5037221e4078bbb544379f48", "committedDate": "2020-06-08T21:53:59Z", "message": "fix bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c69e1b85fc9b2ca77d33a7f2e2ecf015976343e", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/7c69e1b85fc9b2ca77d33a7f2e2ecf015976343e", "committedDate": "2020-06-09T00:19:05Z", "message": "more test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ac57f1d93106affa09161266d7abdca6ac2042", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/f3ac57f1d93106affa09161266d7abdca6ac2042", "committedDate": "2020-06-09T01:51:34Z", "message": "fix lgtm alert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzE1NTcx", "url": "https://github.com/apache/druid/pull/9982#pullrequestreview-425715571", "createdAt": "2020-06-06T05:27:02Z", "commit": {"oid": "c32c2c27aa546f1e3170c9f88f01b1094d86fd76"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwNToyNzowMlrOGgB_EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwNToyNzowMlrOGgB_EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0MDE0NQ==", "bodyText": "I think Closer should be Closeable here", "url": "https://github.com/apache/druid/pull/9982#discussion_r436240145", "createdAt": "2020-06-06T05:27:02Z", "author": {"login": "jon-wei"}, "path": "processing/src/main/java/org/apache/druid/segment/ReferenceCountedObject.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment;\n+\n+import org.apache.druid.java.util.common.io.Closer;\n+\n+import java.io.Closeable;\n+import java.util.Optional;\n+\n+/**\n+ * Interface for an object that may have a reference acquired in the form of a {@link Closeable}. This is intended to be\n+ * used with an implementation of {@link ReferenceCountingCloseableObject}, or anything else that wishes to provide\n+ * a method to account for the acquire and release of a reference to the object.\n+ */\n+public interface ReferenceCountedObject\n+{\n+  /**\n+   * This method is expected to increment a reference count and provide a {@link Closer} that decrements the reference", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c32c2c27aa546f1e3170c9f88f01b1094d86fd76"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c19a0c29a16eb0864f96be4b2e37d2dacf546d", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/d1c19a0c29a16eb0864f96be4b2e37d2dacf546d", "committedDate": "2020-06-09T04:03:52Z", "message": "simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0606ad52d7b9b3cf33021cf28fc6a4ed5446fda", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/e0606ad52d7b9b3cf33021cf28fc6a4ed5446fda", "committedDate": "2020-06-09T04:07:21Z", "message": "fixup javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/4fd013520210287d8db2b56a7f1e65d62121a094", "committedDate": "2020-06-09T11:33:31Z", "message": "Merge remote-tracking branch 'upstream/master' into closeable-joinable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDAyMTQx", "url": "https://github.com/apache/druid/pull/9982#pullrequestreview-427402141", "createdAt": "2020-06-09T17:49:24Z", "commit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzo0OToyNVrOGhVrfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozMToxMFrOGhXJ9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMTM4OA==", "bodyText": "nit: it's emitting nothing and can be a Logger.", "url": "https://github.com/apache/druid/pull/9982#discussion_r437611388", "createdAt": "2020-06-09T17:49:25Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/segment/ReferenceCountingCloseableObject.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.segment;\n+\n+import org.apache.druid.java.util.common.io.Closer;\n+import org.apache.druid.java.util.emitter.EmittingLogger;\n+\n+import java.io.Closeable;\n+import java.util.Optional;\n+import java.util.concurrent.Phaser;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * ReferenceCountingCloseableObject implements something like automatic reference count-based resource management,\n+ * backed by a {@link Phaser}.\n+ *\n+ * ReferenceCountingCloseableObject allows consumers to call {@link #close()} before some other \"users\", which called\n+ * {@link #increment()} or {@link #incrementReferenceAndDecrementOnceCloseable()}, but have not called\n+ * {@link #decrement()} yet or the closer for {@link #incrementReferenceAndDecrementOnceCloseable()}, and the wrapped\n+ * object won't be actually closed until that all references are released.\n+ */\n+public abstract class ReferenceCountingCloseableObject<BaseObject extends Closeable> implements Closeable\n+{\n+  private static final EmittingLogger log = new EmittingLogger(ReferenceCountingCloseableObject.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxNjg0MA==", "bodyText": "Hmm, should the contract of acquireReferences() clarify that this method should never throw an exception? Otherwise, we should make sure the closer will be safely closed on exceptions.", "url": "https://github.com/apache/druid/pull/9982#discussion_r437616840", "createdAt": "2020-06-09T17:58:52Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/segment/join/HashJoinSegment.java", "diffHunk": "@@ -98,4 +101,30 @@ public void close() throws IOException\n   {\n     baseSegment.close();\n   }\n+\n+  @Override\n+  public Optional<Closeable> acquireReferences()\n+  {\n+    Closer closer = Closer.create();\n+    boolean acquireFailed = baseSegment.acquireReferences().map(closeable -> {\n+      closer.register(closeable);\n+      return false;\n+    }).orElse(true);\n+\n+    for (JoinableClause claws : clauses) {\n+      if (acquireFailed) {\n+        break;\n+      }\n+      acquireFailed |= claws.acquireReferences().map(closeable -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyMjIwMA==", "bodyText": "nit: Javadoc?", "url": "https://github.com/apache/druid/pull/9982#discussion_r437622200", "createdAt": "2020-06-09T18:08:14Z", "author": {"login": "jihoonson"}, "path": "processing/src/main/java/org/apache/druid/segment/join/table/IndexedTable.java", "diffHunk": "@@ -30,8 +31,11 @@\n  *\n  * The main user of this class is {@link IndexedTableJoinable}, and its main purpose is to participate in joins.\n  */\n-public interface IndexedTable\n+public interface IndexedTable extends ReferenceCountedObject\n {\n+  @SuppressWarnings(\"unused\")\n+  String version();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNTU3NQ==", "bodyText": "Probably worth commenting why it should be lazy. Same for other orElseGet().", "url": "https://github.com/apache/druid/pull/9982#discussion_r437635575", "createdAt": "2020-06-09T18:31:10Z", "author": {"login": "jihoonson"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/QueryMaker.java", "diffHunk": "@@ -126,7 +126,7 @@ public ObjectMapper getJsonMapper()\n     return DataSourceAnalysis.forDataSource(query.getDataSource())\n                              .getBaseQuerySegmentSpec()\n                              .map(QuerySegmentSpec::getIntervals)\n-                             .orElse(query.getIntervals());\n+                             .orElseGet(query::getIntervals);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fd013520210287d8db2b56a7f1e65d62121a094"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "631501e1c33b1d1df1495bbfef542da4a771cb03", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/631501e1c33b1d1df1495bbfef542da4a771cb03", "committedDate": "2020-06-09T22:21:47Z", "message": "review stuffs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d299d0e3c79971472c65ef9f79216a0866a435", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/25d299d0e3c79971472c65ef9f79216a0866a435", "committedDate": "2020-06-09T22:27:00Z", "message": "Merge remote-tracking branch 'upstream/master' into closeable-joinable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d53883c99890d2431adeb5ca132739a53f9080d", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/7d53883c99890d2431adeb5ca132739a53f9080d", "committedDate": "2020-06-09T23:02:46Z", "message": "safeguard against exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjAzOTY1", "url": "https://github.com/apache/druid/pull/9982#pullrequestreview-427603965", "createdAt": "2020-06-09T23:04:48Z", "commit": {"oid": "7d53883c99890d2431adeb5ca132739a53f9080d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f08f8660801e669d34248fe40e29f45bc28bc0e3", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/f08f8660801e669d34248fe40e29f45bc28bc0e3", "committedDate": "2020-06-10T01:20:42Z", "message": "i hate this checkstyle rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf24bf82257c9bc5a3038c549ed2fe97baf1741", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/ecf24bf82257c9bc5a3038c549ed2fe97baf1741", "committedDate": "2020-06-10T01:34:35Z", "message": "make IndexedTable extend Closeable"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2013, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}