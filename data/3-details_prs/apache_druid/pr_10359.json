{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMjc2Mjcx", "number": 10359, "title": "Add shuffle metrics for parallel indexing", "bodyText": "Description\nPart of #10352. This PR adds these metrics for middleManagers. These metrics have the supervisorTaskId as their dimension.\n\ningest/shuffle/bytes: Number of bytes shuffled per emissionPeriod.\ningest/shuffle/requests: Number of shuffle requests per emissionPeriod.\n\nI haven't updated document yet, will add them with missing shuffle configurations together in a follow-up PR.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-04T23:32:33Z", "url": "https://github.com/apache/druid/pull/10359", "merged": true, "mergeCommit": {"oid": "ad437dd655ef24d8d9a4120fa8e99885ec353eb3"}, "closed": true, "closedAt": "2020-10-11T02:35:18Z", "author": {"login": "jihoonson"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFtzIZAH2gAyNDgwMjc2MjcxOjdlMGZjMGE5ZWRhNmE0ZTdiYmZjMzkxMjUyNTY3ZjEyNzYxMjcwODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRWC5AgFqTUwNjEzODcyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/7e0fc0a9eda6a4e7bbfc391252567f1276127081", "committedDate": "2020-09-04T23:28:26Z", "message": "Add shuffle metrics for parallel indexing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDQ2MTkz", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-483446193", "createdAt": "2020-09-07T10:31:35Z", "commit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDozMTozNVrOHN6EPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDozMTozNVrOHN6EPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0NDg5Mg==", "bodyText": "should this be renamed to snapshotAndReset or may be just reset ?\npublic Map<String, PerDatasourceShuffleMetrics> reset()\n{\n   return Collections.unmodifiableMap(datasourceMetrics.getAndSet(new ConcurrentHashMap<>()));\n}", "url": "https://github.com/apache/druid/pull/10359#discussion_r484344892", "createdAt": "2020-09-07T10:31:35Z", "author": {"login": "abhishekagarwal87"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class ShuffleMetrics\n+{\n+  private final AtomicReference<ConcurrentHashMap<String, PerDatasourceShuffleMetrics>> datasourceMetrics =\n+      new AtomicReference<>();\n+\n+  public ShuffleMetrics()\n+  {\n+    datasourceMetrics.set(new ConcurrentHashMap<>());\n+  }\n+\n+  public void shuffleRequested(String supervisorTaskId, long fileLength)\n+  {\n+    datasourceMetrics\n+        .get()\n+        .computeIfAbsent(supervisorTaskId, k -> new PerDatasourceShuffleMetrics()).accumulate(fileLength);\n+  }\n+\n+  public Map<String, PerDatasourceShuffleMetrics> snapshot()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDYwMTI3", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-483460127", "createdAt": "2020-09-07T10:51:34Z", "commit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDo1MTozNFrOHN6scA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDo1MTozNFrOHN6scA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM1NTE4NA==", "bodyText": "it's still possible to miss an update in reporting because of race condition, right? Since the reference could be reset while the accumulation is happening.", "url": "https://github.com/apache/druid/pull/10359#discussion_r484355184", "createdAt": "2020-09-07T10:51:34Z", "author": {"login": "abhishekagarwal87"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class ShuffleMetrics\n+{\n+  private final AtomicReference<ConcurrentHashMap<String, PerDatasourceShuffleMetrics>> datasourceMetrics =\n+      new AtomicReference<>();\n+\n+  public ShuffleMetrics()\n+  {\n+    datasourceMetrics.set(new ConcurrentHashMap<>());\n+  }\n+\n+  public void shuffleRequested(String supervisorTaskId, long fileLength)\n+  {\n+    datasourceMetrics\n+        .get()\n+        .computeIfAbsent(supervisorTaskId, k -> new PerDatasourceShuffleMetrics()).accumulate(fileLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b73677ffa0dc9fa11639ceef35b952ae1a1d9dc1", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/b73677ffa0dc9fa11639ceef35b952ae1a1d9dc1", "committedDate": "2020-09-08T19:38:56Z", "message": "javadoc and concurrency test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NzAwNzYz", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-484700763", "createdAt": "2020-09-09T06:38:23Z", "commit": {"oid": "b73677ffa0dc9fa11639ceef35b952ae1a1d9dc1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjozODoyNFrOHO4vYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjozODoyNFrOHO4vYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3MTc0Ng==", "bodyText": "I think this needs to use something like AtomicReference.getAndUpdate so that it isn't racy with the monitor/emitter? Though I'm not sure getAndUpdate or the similar methods are actually appropriate since they are supposed to be side-effect free, so I'm not really sure how exactly to resolve this.\nLike, the potentially problematic scenario I'm thinking of is where shuffleRequested is called \"before\" snapshotAndReset. It seems like once AtomicReference.get has completed, snapshotAndReset can proceed, so now the shuffle monitor has the same concurrent map we are still actively updating, and it is preparing to build the metrics to emit. It seems super unlikely that it would be a problem, but unless I'm missing something it does seem possible.", "url": "https://github.com/apache/druid/pull/10359#discussion_r485371746", "createdAt": "2020-09-09T06:38:24Z", "author": {"login": "clintropolis"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class ShuffleMetrics\n+{\n+  private final AtomicReference<ConcurrentHashMap<String, PerDatasourceShuffleMetrics>> datasourceMetrics =\n+      new AtomicReference<>();\n+\n+  public ShuffleMetrics()\n+  {\n+    datasourceMetrics.set(new ConcurrentHashMap<>());\n+  }\n+\n+  public void shuffleRequested(String supervisorTaskId, long fileLength)\n+  {\n+    datasourceMetrics\n+        .get()\n+        .computeIfAbsent(supervisorTaskId, k -> new PerDatasourceShuffleMetrics()).accumulate(fileLength);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM1NTE4NA=="}, "originalCommit": {"oid": "7e0fc0a9eda6a4e7bbfc391252567f1276127081"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd8cb2cff3333478f2af47340ade08550457ebd", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/fcd8cb2cff3333478f2af47340ade08550457ebd", "committedDate": "2020-09-09T17:25:35Z", "message": "concurrency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzIzMjEz", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-485723213", "createdAt": "2020-09-10T08:54:58Z", "commit": {"oid": "fcd8cb2cff3333478f2af47340ade08550457ebd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODo1NDo1OFrOHPp1yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODo1NDo1OFrOHPp1yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3NjIwMw==", "bodyText": "This comment needs an update after the latest changes.", "url": "https://github.com/apache/druid/pull/10359#discussion_r486176203", "createdAt": "2020-09-10T08:54:58Z", "author": {"login": "abhishekagarwal87"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.errorprone.annotations.concurrent.GuardedBy;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Shuffle metrcis for middleManagers and indexers. This class is thread-safe because shuffle can be performed by\n+ * multiple HTTP threads while a monitoring thread periodically emits the snapshot of metrics.\n+ *\n+ * @see ShuffleResource\n+ * @see org.apache.druid.java.util.metrics.MonitorScheduler\n+ */\n+public class ShuffleMetrics\n+{\n+  /**\n+   * This lock is used to synchronize accesses to the reference to {@link #datasourceMetrics} and the\n+   * {@link PerDatasourceShuffleMetrics} values of the map. This means,\n+   *\n+   * - Any updates on PerDatasourceShuffleMetrics in the map (and thus its key) should be synchronized under this lock.\n+   * - Any updates on the reference to datasourceMetrics should be synchronized under this lock.\n+   */\n+  private final Object lock = new Object();\n+\n+  /**\n+   * A map of (datasource name) -> {@link PerDatasourceShuffleMetrics}. This map is replaced with an empty map\n+   * whenever a snapshot is taken since the map can keep growing over time otherwise. For concurrent access pattern,\n+   * see {@link #shuffleRequested} and {@link #snapshotAndReset()}.\n+   */\n+  @GuardedBy(\"lock\")\n+  private Map<String, PerDatasourceShuffleMetrics> datasourceMetrics = new HashMap<>();\n+\n+  /**\n+   * This method is called whenever a new shuffle is requested. Multiple tasks can request shuffle at the same time,\n+   * while the monitoring thread takes a snapshot of the metrics. There is a happens-before relationship between\n+   * shuffleRequested and {@link #snapshotAndReset()}.\n+   */\n+  public void shuffleRequested(String supervisorTaskId, long fileLength)\n+  {\n+    synchronized (lock) {\n+      datasourceMetrics.computeIfAbsent(supervisorTaskId, k -> new PerDatasourceShuffleMetrics())\n+                       .accumulate(fileLength);\n+    }\n+  }\n+\n+  /**\n+   * This method is called whenever the monitoring thread takes a snapshot of the current metrics. The map inside\n+   * AtomicReference will be reset to an empty map after this call. This is to return the snapshot metrics collected", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd8cb2cff3333478f2af47340ade08550457ebd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzI0NTUy", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-485724552", "createdAt": "2020-09-10T08:56:44Z", "commit": {"oid": "fcd8cb2cff3333478f2af47340ade08550457ebd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/bf23cbc0675e44afbb1ea7d9be4779779e53d45e", "committedDate": "2020-09-10T18:48:03Z", "message": "fix javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjkyNjcy", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-486292672", "createdAt": "2020-09-10T20:38:41Z", "commit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDI0MDYx", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-493024061", "createdAt": "2020-09-21T22:28:29Z", "commit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyODozMFrOHVklMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjozMjozOVrOHVkrAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MTQ5MA==", "bodyText": "Since there is a risk of the locking introducing a slow down here because of contention, can we update this to include a feature flag check?\nThis way, if there are some unforeseen issues with locking, we can disable metric computation and reporting. I think a static feature flag - like a system property would be good enough for this use case.", "url": "https://github.com/apache/druid/pull/10359#discussion_r492381490", "createdAt": "2020-09-21T22:28:30Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.errorprone.annotations.concurrent.GuardedBy;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Shuffle metrcis for middleManagers and indexers. This class is thread-safe because shuffle can be performed by\n+ * multiple HTTP threads while a monitoring thread periodically emits the snapshot of metrics.\n+ *\n+ * @see ShuffleResource\n+ * @see org.apache.druid.java.util.metrics.MonitorScheduler\n+ */\n+public class ShuffleMetrics\n+{\n+  /**\n+   * This lock is used to synchronize accesses to the reference to {@link #datasourceMetrics} and the\n+   * {@link PerDatasourceShuffleMetrics} values of the map. This means,\n+   *\n+   * - Any updates on PerDatasourceShuffleMetrics in the map (and thus its key as well) should be synchronized\n+   * under this lock.\n+   * - Any updates on the reference to datasourceMetrics should be synchronized under this lock.\n+   */\n+  private final Object lock = new Object();\n+\n+  /**\n+   * A map of (datasource name) -> {@link PerDatasourceShuffleMetrics}. This map is replaced with an empty map\n+   * whenever a snapshot is taken since the map can keep growing over time otherwise. For concurrent access pattern,\n+   * see {@link #shuffleRequested} and {@link #snapshotAndReset()}.\n+   */\n+  @GuardedBy(\"lock\")\n+  private Map<String, PerDatasourceShuffleMetrics> datasourceMetrics = new HashMap<>();\n+\n+  /**\n+   * This method is called whenever a new shuffle is requested. Multiple tasks can request shuffle at the same time,\n+   * while the monitoring thread takes a snapshot of the metrics. There is a happens-before relationship between\n+   * shuffleRequested and {@link #snapshotAndReset()}.\n+   */\n+  public void shuffleRequested(String supervisorTaskId, long fileLength)\n+  {\n+    synchronized (lock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MjAxMQ==", "bodyText": "Just curious - why did you choose to use the guarded by pattern instead of a ConcurrentMap?", "url": "https://github.com/apache/druid/pull/10359#discussion_r492382011", "createdAt": "2020-09-21T22:29:58Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMetrics.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.errorprone.annotations.concurrent.GuardedBy;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Shuffle metrcis for middleManagers and indexers. This class is thread-safe because shuffle can be performed by\n+ * multiple HTTP threads while a monitoring thread periodically emits the snapshot of metrics.\n+ *\n+ * @see ShuffleResource\n+ * @see org.apache.druid.java.util.metrics.MonitorScheduler\n+ */\n+public class ShuffleMetrics\n+{\n+  /**\n+   * This lock is used to synchronize accesses to the reference to {@link #datasourceMetrics} and the\n+   * {@link PerDatasourceShuffleMetrics} values of the map. This means,\n+   *\n+   * - Any updates on PerDatasourceShuffleMetrics in the map (and thus its key as well) should be synchronized\n+   * under this lock.\n+   * - Any updates on the reference to datasourceMetrics should be synchronized under this lock.\n+   */\n+  private final Object lock = new Object();\n+\n+  /**\n+   * A map of (datasource name) -> {@link PerDatasourceShuffleMetrics}. This map is replaced with an empty map\n+   * whenever a snapshot is taken since the map can keep growing over time otherwise. For concurrent access pattern,\n+   * see {@link #shuffleRequested} and {@link #snapshotAndReset()}.\n+   */\n+  @GuardedBy(\"lock\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4Mjk3Nw==", "bodyText": "other ingestion related metrics start with \"ingest/\" any thoughts on whether these metrics fall under the ingestion metrics category?\nI was thinking about where the metrics would live in the docs which is why I was asking this question. I thought maybe it belonged here https://druid.apache.org/docs/latest/operations/metrics.html#ingestion-metrics-realtime-process ?", "url": "https://github.com/apache/druid/pull/10359#discussion_r492382977", "createdAt": "2020-09-21T22:32:39Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMonitor.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.inject.Inject;\n+import org.apache.druid.indexing.worker.shuffle.ShuffleMetrics.PerDatasourceShuffleMetrics;\n+import org.apache.druid.java.util.emitter.service.ServiceEmitter;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent.Builder;\n+import org.apache.druid.java.util.metrics.AbstractMonitor;\n+\n+import java.util.Map;\n+\n+public class ShuffleMonitor extends AbstractMonitor\n+{\n+  private static final String SUPERVISOR_TASK_ID_DIMENSION = \"supervisorTaskId\";\n+  private static final String SHUFFLE_BYTES_KEY = \"shuffle/bytes\";\n+  private static final String SHUFFLE_REQUESTS_KEY = \"shuffle/requests\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf23cbc0675e44afbb1ea7d9be4779779e53d45e"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b29498386881c112574aaec207af59b994c7ea", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/80b29498386881c112574aaec207af59b994c7ea", "committedDate": "2020-10-06T21:48:58Z", "message": "Feature flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e258dd32d948b0f3276cd3e49051879d78732775", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/e258dd32d948b0f3276cd3e49051879d78732775", "committedDate": "2020-10-06T21:56:53Z", "message": "doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e205c1df2e4e813938485435dd590b952bc14ca1", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/e205c1df2e4e813938485435dd590b952bc14ca1", "committedDate": "2020-10-06T22:55:12Z", "message": "fix doc and add a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f", "committedDate": "2020-10-07T00:04:56Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTc5NDI4", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-505179428", "createdAt": "2020-10-08T21:28:56Z", "commit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMToyODo1N1rOHexEDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMToyODo1N1rOHexEDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMzE4Mg==", "bodyText": "I see that MonitorScheduler has a removeMonitor method, and ShuffleMetrics is provided as a Singleton. Can someone remove the ShuffleMonitor while Druid is running? If they do that how would it impact ShuffleMetrics being reported", "url": "https://github.com/apache/druid/pull/10359#discussion_r502023182", "createdAt": "2020-10-08T21:28:57Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleModule.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import org.apache.druid.guice.Jerseys;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.java.util.metrics.MonitorScheduler;\n+\n+import java.util.Optional;\n+\n+public class ShuffleModule implements Module\n+{\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    Jerseys.addResource(binder, ShuffleResource.class);\n+  }\n+\n+  /**\n+   * {@link ShuffleMetrics} is used in {@link ShuffleResource} and {@link ShuffleMonitor} to collect metrics\n+   * and report them, respectively. Unlike ShuffleResource, ShuffleMonitor can be created via a user config\n+   * ({@link org.apache.druid.server.metrics.MonitorsConfig}) in potentially any node types, where it is not\n+   * possible to create ShuffleMetrics. This method checks the {@link MonitorScheduler} if ShuffleMonitor is\n+   * registered on it, and sets the proper ShuffleMetrics.\n+   */\n+  @Provides\n+  @LazySingleton\n+  public Optional<ShuffleMetrics> getShuffleMetrics(MonitorScheduler monitorScheduler)\n+  {\n+    // ShuffleMonitor cannot be registered dynamically, but can only via the static configuration (MonitorsConfig).\n+    // As a result, it is safe to check only one time if it is registered in MonitorScheduler.\n+    final Optional<ShuffleMonitor> maybeMonitor = monitorScheduler.findMonitor(ShuffleMonitor.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjkyMjU0", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-505292254", "createdAt": "2020-10-09T01:27:24Z", "commit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMToyNzoyNVrOHe3LOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMTozNjo1MVrOHe3TFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEyMzMyMw==", "bodyText": "Can you add a ModuleTest that validates the ShuffleResource and Optional<ShuffleMetrics>is injectable a. I think I've written AuthorizerMapperModuleTest that would be a similar example", "url": "https://github.com/apache/druid/pull/10359#discussion_r502123323", "createdAt": "2020-10-09T01:27:25Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleModule.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import com.google.inject.Provides;\n+import org.apache.druid.guice.Jerseys;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.java.util.metrics.MonitorScheduler;\n+\n+import java.util.Optional;\n+\n+public class ShuffleModule implements Module\n+{\n+  @Override\n+  public void configure(Binder binder)\n+  {\n+    Jerseys.addResource(binder, ShuffleResource.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEyNTMzNA==", "bodyText": "Should we add unit tests for this function?", "url": "https://github.com/apache/druid/pull/10359#discussion_r502125334", "createdAt": "2020-10-09T01:36:51Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/worker/shuffle/ShuffleMonitor.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import org.apache.druid.indexing.worker.shuffle.ShuffleMetrics.PerDatasourceShuffleMetrics;\n+import org.apache.druid.java.util.emitter.service.ServiceEmitter;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent;\n+import org.apache.druid.java.util.emitter.service.ServiceMetricEvent.Builder;\n+import org.apache.druid.java.util.metrics.AbstractMonitor;\n+import org.checkerframework.checker.nullness.qual.MonotonicNonNull;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+import java.util.Map;\n+\n+public class ShuffleMonitor extends AbstractMonitor\n+{\n+  private static final String SUPERVISOR_TASK_ID_DIMENSION = \"supervisorTaskId\";\n+  private static final String SHUFFLE_BYTES_KEY = \"ingest/shuffle/bytes\";\n+  private static final String SHUFFLE_REQUESTS_KEY = \"ingest/shuffle/requests\";\n+\n+  /**\n+   * ShuffleMonitor can be instantiated in any node types if it is defined in\n+   * {@link org.apache.druid.server.metrics.MonitorsConfig}. Since {@link ShuffleMetrics} is defined\n+   * in the `indexing-service` module, some node types (such as broker) would fail to create it\n+   * if they don't have required dependencies. To avoid this problem, this variable is lazily initialized\n+   * only in the node types which has the {@link ShuffleModule}.\n+   */\n+  @MonotonicNonNull\n+  private ShuffleMetrics shuffleMetrics;\n+\n+  public void setShuffleMetrics(ShuffleMetrics shuffleMetrics)\n+  {\n+    this.shuffleMetrics = shuffleMetrics;\n+  }\n+\n+  @Nullable\n+  public ShuffleMetrics getShuffleMetrics()\n+  {\n+    return shuffleMetrics;\n+  }\n+\n+  @Override\n+  public boolean doMonitor(ServiceEmitter emitter)\n+  {\n+    if (shuffleMetrics != null) {\n+      final Map<String, PerDatasourceShuffleMetrics> snapshot = shuffleMetrics.snapshotAndReset();\n+      snapshot.forEach((supervisorTaskId, perDatasourceShuffleMetrics) -> {\n+        final Builder metricBuilder = ServiceMetricEvent\n+            .builder()\n+            .setDimension(SUPERVISOR_TASK_ID_DIMENSION, supervisorTaskId);\n+        emitter.emit(metricBuilder.build(SHUFFLE_BYTES_KEY, perDatasourceShuffleMetrics.getShuffleBytes()));\n+        emitter.emit(metricBuilder.build(SHUFFLE_REQUESTS_KEY, perDatasourceShuffleMetrics.getShuffleRequests()));\n+      });\n+    }\n+    return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70529d0f0d2a8dd305074aff5cfb7f3f4e8aa2f"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394b4734f01115d11279e38dd3594663bd78df4e", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/394b4734f01115d11279e38dd3594663bd78df4e", "committedDate": "2020-10-09T05:16:07Z", "message": "add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NzY3NjI4", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-505767628", "createdAt": "2020-10-09T15:14:47Z", "commit": {"oid": "394b4734f01115d11279e38dd3594663bd78df4e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxNDo0N1rOHfOMyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxNDo0N1rOHfOMyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMDU1NA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Mockito.when(monitorScheduler.findMonitor(ArgumentMatchers.eq(ShuffleMonitor.class)))\n          \n          \n            \n                Mockito.when(monitorScheduler.findMonitor(ShuffleMonitor.class))", "url": "https://github.com/apache/druid/pull/10359#discussion_r502500554", "createdAt": "2020-10-09T15:14:47Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/test/java/org/apache/druid/indexing/worker/shuffle/ShuffleModuleTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Key;\n+import com.google.inject.Scopes;\n+import com.google.inject.TypeLiteral;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.java.util.metrics.MonitorScheduler;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentMatchers;\n+import org.mockito.Mockito;\n+\n+import java.util.Optional;\n+\n+public class ShuffleModuleTest\n+{\n+  private ShuffleModule shuffleModule;\n+  private Injector injector;\n+\n+  @Before\n+  public void setup()\n+  {\n+    shuffleModule = new ShuffleModule();\n+  }\n+\n+  @Test\n+  public void testGetShuffleMetricsWhenShuffleMonitorExists()\n+  {\n+    final ShuffleMonitor shuffleMonitor = new ShuffleMonitor();\n+    final MonitorScheduler monitorScheduler = Mockito.mock(MonitorScheduler.class);\n+    Mockito.when(monitorScheduler.findMonitor(ArgumentMatchers.eq(ShuffleMonitor.class)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394b4734f01115d11279e38dd3594663bd78df4e"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NzY4NDM4", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-505768438", "createdAt": "2020-10-09T15:15:48Z", "commit": {"oid": "394b4734f01115d11279e38dd3594663bd78df4e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxNTo0OFrOHfOPWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxNTo0OFrOHfOPWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwMTIwOQ==", "bodyText": "nit: you can move this into a @Before method", "url": "https://github.com/apache/druid/pull/10359#discussion_r502501209", "createdAt": "2020-10-09T15:15:48Z", "author": {"login": "suneet-s"}, "path": "indexing-service/src/test/java/org/apache/druid/indexing/worker/shuffle/ShuffleModuleTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.indexing.worker.shuffle;\n+\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Key;\n+import com.google.inject.Scopes;\n+import com.google.inject.TypeLiteral;\n+import org.apache.druid.guice.LazySingleton;\n+import org.apache.druid.java.util.metrics.MonitorScheduler;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentMatchers;\n+import org.mockito.Mockito;\n+\n+import java.util.Optional;\n+\n+public class ShuffleModuleTest\n+{\n+  private ShuffleModule shuffleModule;\n+  private Injector injector;\n+\n+  @Before\n+  public void setup()\n+  {\n+    shuffleModule = new ShuffleModule();\n+  }\n+\n+  @Test\n+  public void testGetShuffleMetricsWhenShuffleMonitorExists()\n+  {\n+    final ShuffleMonitor shuffleMonitor = new ShuffleMonitor();\n+    final MonitorScheduler monitorScheduler = Mockito.mock(MonitorScheduler.class);\n+    Mockito.when(monitorScheduler.findMonitor(ArgumentMatchers.eq(ShuffleMonitor.class)))\n+           .thenReturn(Optional.of(shuffleMonitor));\n+    injector = Guice.createInjector(\n+        binder -> {\n+          binder.bindScope(LazySingleton.class, Scopes.SINGLETON);\n+          binder.bind(MonitorScheduler.class).toInstance(monitorScheduler);\n+          binder.bind(IntermediaryDataManager.class).toInstance(Mockito.mock(IntermediaryDataManager.class));\n+        },\n+        shuffleModule\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394b4734f01115d11279e38dd3594663bd78df4e"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23312bb1ff09302bae1169b2d99bf797b4295f19", "author": {"user": {"login": "jihoonson", "name": "Jihoon Son"}}, "url": "https://github.com/apache/druid/commit/23312bb1ff09302bae1169b2d99bf797b4295f19", "committedDate": "2020-10-09T19:06:19Z", "message": "fix build and address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTM4NzIx", "url": "https://github.com/apache/druid/pull/10359#pullrequestreview-506138721", "createdAt": "2020-10-11T02:35:01Z", "commit": {"oid": "23312bb1ff09302bae1169b2d99bf797b4295f19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3572, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}