{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NzI5MjI2", "number": 10279, "title": "Add SQL \"OFFSET\" clause.", "bodyText": "Under the hood, this uses the new offset features from #10233 (Scan)\nand #10235 (GroupBy). Since Timeseries and TopN queries do not currently\nhave an offset feature, SQL planning will switch from one of those to\nScan or GroupBy if users add an OFFSET.\nIncludes a refactoring to harmonize offset and limit planning using an\nOffsetLimit wrapper class. This is useful because it ensures that the\nvarious places that need to deal with offset and limit collapsing all\nbehave the same way, using its \"andThen\" method.", "createdAt": "2020-08-14T02:22:04Z", "url": "https://github.com/apache/druid/pull/10279", "merged": true, "mergeCommit": {"oid": "0910d22f487ab2ac603708d51a16da0d8bf942dc"}, "closed": true, "closedAt": "2020-08-21T21:11:55Z", "author": {"login": "gianm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-rFpEAH2gAyNDY3NzI5MjI2OmEwNWQ3YTI2Zjc0Mjg2ZWNjMDY4N2Y0NjU5NTFhMGY2MjRkYWU2ZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA1pgCAFqTQ3MTkzNTM4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a05d7a26f74286ecc0687f465951a0f624dae6f3", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/a05d7a26f74286ecc0687f465951a0f624dae6f3", "committedDate": "2020-08-14T02:21:28Z", "message": "Add SQL \"OFFSET\" clause.\n\nUnder the hood, this uses the new offset features from #10233 (Scan)\nand #10235 (GroupBy). Since Timeseries and TopN queries do not currently\nhave an offset feature, SQL planning will switch from one of those to\nScan or GroupBy if users add an OFFSET.\n\nIncludes a refactoring to harmonize offset and limit planning using an\nOffsetLimit wrapper class. This is useful because it ensures that the\nvarious places that need to deal with offset and limit collapsing all\nbehave the same way, using its \"andThen\" method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/891a38952b40e1af876f0b5e233a3dd6c7f635ba", "committedDate": "2020-08-14T14:04:34Z", "message": "Fix test and add another test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDM4ODg1", "url": "https://github.com/apache/druid/pull/10279#pullrequestreview-471438885", "createdAt": "2020-08-20T09:53:57Z", "commit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTo1Mzo1OFrOHD4cpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTo1Mzo1OFrOHD4cpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzMjYxMw==", "bodyText": "Would it be worth pushing a method into OffsetLimit to check that limit is greater than 0 to use for timeseries/group by/scan to use instead of hasLimit?", "url": "https://github.com/apache/druid/pull/10279#discussion_r473832613", "createdAt": "2020-08-20T09:53:58Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQuery.java", "diffHunk": "@@ -762,9 +756,20 @@ public TimeseriesQuery toTimeseriesQuery()\n           Iterables.getOnlyElement(grouping.getDimensions()).toDimensionSpec().getOutputName()\n       );\n       if (sorting != null) {\n-        // If there is sorting, set timeseriesLimit to given value if less than Integer.Max_VALUE\n-        if (sorting.isLimited()) {\n-          timeseriesLimit = Ints.checkedCast(sorting.getLimit());\n+        if (sorting.getOffsetLimit().hasOffset()) {\n+          // Timeseries cannot handle offsets.\n+          return null;\n+        }\n+\n+        if (sorting.getOffsetLimit().hasLimit()) {\n+          final long limit = sorting.getOffsetLimit().getLimit();\n+\n+          if (limit == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTMyMzk4", "url": "https://github.com/apache/druid/pull/10279#pullrequestreview-471932398", "createdAt": "2020-08-20T19:42:51Z", "commit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTo0Mjo1MVrOHEQxNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTo0Mjo1MVrOHEQxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzMTA5NQ==", "bodyText": "can limit be less than 0 here because of the preconditions in OffsetLimit?", "url": "https://github.com/apache/druid/pull/10279#discussion_r474231095", "createdAt": "2020-08-20T19:42:51Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQuery.java", "diffHunk": "@@ -897,6 +906,11 @@ public GroupByQuery toGroupByQuery()\n       return null;\n     }\n \n+    if (sorting != null && sorting.getOffsetLimit().hasLimit() && sorting.getOffsetLimit().getLimit() <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTM1Mzg2", "url": "https://github.com/apache/druid/pull/10279#pullrequestreview-471935386", "createdAt": "2020-08-20T19:47:32Z", "commit": {"oid": "891a38952b40e1af876f0b5e233a3dd6c7f635ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1964, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}