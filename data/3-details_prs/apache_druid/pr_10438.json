{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNDUzNTIw", "number": 10438, "title": "Web console: Display compaction status", "bodyText": "This PR adds a column to display the (new) compaction status API\n\nThis PR also:\n\nAdds suggestion options for the skipOffsetFromLatest parameter\nImproves error cursor placement in the JsonInput\nadds an alt + click option to the ... button allowing for a secret undocumented API option to run compaction immediately. This is very useful for debugging and the copy is made suitably scary to ensure users are dissuade from using this option.", "createdAt": "2020-09-26T00:53:37Z", "url": "https://github.com/apache/druid/pull/10438", "merged": true, "mergeCommit": {"oid": "729bcba7acd7fa4bccd1fd7769bfeb03d29b4011"}, "closed": true, "closedAt": "2020-09-29T05:19:28Z", "author": {"login": "vogievetsky"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL3E_fAH2gAyNDkzNDUzNTIwOmRlNzJiYjFjZjRlZGUxNTg4ZmNiY2M1ZDBhZjY1MzljZTg1ZjY1OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNeEBqAFqTQ5ODAwNDcyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "de72bb1cf4ede1588fcbcc5d0af6539ce85f6597", "author": {"user": {"login": "vogievetsky", "name": "Vadim Ogievetsky"}}, "url": "https://github.com/apache/druid/commit/de72bb1cf4ede1588fcbcc5d0af6539ce85f6597", "committedDate": "2020-09-24T01:40:38Z", "message": "init compaction status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55cfcb14dbc0ebde040dd5507257de1babb33d85", "author": {"user": {"login": "vogievetsky", "name": "Vadim Ogievetsky"}}, "url": "https://github.com/apache/druid/commit/55cfcb14dbc0ebde040dd5507257de1babb33d85", "committedDate": "2020-09-25T15:00:13Z", "message": "% compacted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada", "author": {"user": {"login": "vogievetsky", "name": "Vadim Ogievetsky"}}, "url": "https://github.com/apache/druid/commit/bed21585c041f82df9477b3fdc889e4f1abbcada", "committedDate": "2020-09-26T00:35:04Z", "message": "final UI tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzMyOTYw", "url": "https://github.com/apache/druid/pull/10438#pullrequestreview-497732960", "createdAt": "2020-09-28T17:07:11Z", "commit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzowNzoxMVrOHZH3kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzowNzoxMVrOHZH3kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwNTM2Mg==", "bodyText": "there is no logical change here... just wanted to have less nesting", "url": "https://github.com/apache/druid/pull/10438#discussion_r496105362", "createdAt": "2020-09-28T17:07:11Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/components/json-input/json-input.tsx", "diffHunk": "@@ -80,12 +80,11 @@ export const JsonInput = React.memo(function JsonInput(props: JsonInputProps) {\n   const aceEditor = useRef<Editor | undefined>();\n \n   useEffect(() => {\n-    if (!deepEqual(value, internalValue.value)) {\n-      setInternalValue({\n-        value,\n-        stringified: stringifyJson(value),\n-      });\n-    }\n+    if (deepEqual(value, internalValue.value)) return;\n+    setInternalValue({\n+      value,\n+      stringified: stringifyJson(value),\n+    });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODM4MjMw", "url": "https://github.com/apache/druid/pull/10438#pullrequestreview-497838230", "createdAt": "2020-09-28T19:38:39Z", "commit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTozODozOVrOHZM4-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDoxMzowNlrOHZN-DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4NzY0Mg==", "bodyText": "What do you think about adding another snapshot test that sets the new altExtra prop?", "url": "https://github.com/apache/druid/pull/10438#discussion_r496187642", "createdAt": "2020-09-28T19:38:39Z", "author": {"login": "ccaominh"}, "path": "web-console/src/components/more-button/more-button.tsx", "diffHunk": "@@ -18,14 +18,19 @@\n \n import { Button, Menu, Popover, Position } from '@blueprintjs/core';\n import { IconNames } from '@blueprintjs/icons';\n-import React from 'react';\n+import React, { useState } from 'react';\n+\n+type OpenState = 'open' | 'alt-open';\n \n export interface MoreButtonProps {\n-  children: React.ReactNode;\n+  children: React.ReactNode | React.ReactNode[];\n+  altExtra?: React.ReactNode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODUyNw==", "bodyText": "Missing unit test in general.spec.ts", "url": "https://github.com/apache/druid/pull/10438#discussion_r496188527", "createdAt": "2020-09-28T19:40:20Z", "author": {"login": "ccaominh"}, "path": "web-console/src/utils/general.tsx", "diffHunk": "@@ -231,6 +231,10 @@ export function formatMegabytes(n: number): string {\n   return numeral(n / 1048576).format('0,0.0');\n }\n \n+export function formatPercent(n: number): string {\n+  return (n * 100).toFixed(2) + '%';\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTIyNw==", "bodyText": "May be worth adding unit tests for all these new utility methods", "url": "https://github.com/apache/druid/pull/10438#discussion_r496189227", "createdAt": "2020-09-28T19:41:47Z", "author": {"login": "ccaominh"}, "path": "web-console/src/views/datasource-view/datasource-view.tsx", "diffHunk": "@@ -131,9 +132,70 @@ function twoLines(line1: string, line2: string) {\n   );\n }\n \n+function progress(done: number, awaiting: number): number {\n+  const d = done + awaiting;\n+  if (!d) return 0;\n+  return done / d;\n+}\n+\n+function capitalizeFirst(str: string): string {\n+  return str.slice(0, 1).toUpperCase() + str.slice(1).toLowerCase();\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE5MDMwMQ==", "bodyText": "Currently this is hard to test. The autocompaction E2E test could possibly be modified to use this instead of calling the trigger compaction API directly.", "url": "https://github.com/apache/druid/pull/10438#discussion_r496190301", "createdAt": "2020-09-28T19:43:39Z", "author": {"login": "ccaominh"}, "path": "web-console/src/views/datasource-view/datasource-view.tsx", "diffHunk": "@@ -552,7 +634,32 @@ GROUP BY 1`;\n     );\n   }\n \n-  private saveRules = async (datasource: string, rules: any[], comment: string) => {\n+  renderForceCompactAction() {\n+    const { showForceCompact } = this.state;\n+    if (!showForceCompact) return;\n+\n+    return (\n+      <AsyncActionDialog\n+        action={async () => {\n+          const resp = await axios.post(`/druid/coordinator/v1/compaction/compact`, {});\n+          return resp.data;\n+        }}\n+        confirmButtonText=\"Force compaction run\"\n+        successText=\"Out of band compaction run has been initiated\"\n+        failText=\"Could not force compaction\"\n+        intent={Intent.DANGER}\n+        onClose={() => {\n+          this.setState({ showForceCompact: false });\n+        }}\n+      >\n+        <p>Are you sure you want to force a compaction run?</p>\n+        <p>This functionality only exists for debugging and testing reasons.</p>\n+        <p>If you are running it in production you are doing something wrong.</p>\n+      </AsyncActionDialog>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNTMyNQ==", "bodyText": "This will be hard to unit test since it requires either a real or mock druid cluster. One option to make it more testable is to restructure the code to inject something like a compaction manager dependency via the DatasourcesView constructor. That way, the unit tests can have a compaction manager mock where the API responses are stubbed. #9956 used this approach to test SegmentTimeline with a mock for QueryManager.", "url": "https://github.com/apache/druid/pull/10438#discussion_r496205325", "createdAt": "2020-09-28T20:13:06Z", "author": {"login": "ccaominh"}, "path": "web-console/src/views/datasource-view/datasource-view.tsx", "diffHunk": "@@ -329,18 +393,25 @@ GROUP BY 1`;\n         const rulesResp = await axios.get('/druid/coordinator/v1/rules');\n         const rules = rulesResp.data;\n \n-        const compactionResp = await axios.get('/druid/coordinator/v1/config/compaction');\n-        const compaction = lookupBy(\n-          compactionResp.data.compactionConfigs,\n-          (c: any) => c.dataSource,\n+        const compactionConfigsResp = await axios.get('/druid/coordinator/v1/config/compaction');\n+        const compactionConfigs = lookupBy(\n+          compactionConfigsResp.data.compactionConfigs || [],\n+          (c: CompactionConfig) => c.dataSource,\n+        );\n+\n+        const compactionStatusesResp = await axios.get('/druid/coordinator/v1/compaction/status');\n+        const compactionStatuses = lookupBy(\n+          compactionStatusesResp.data.latestStatus || [],\n+          (c: CompactionStatus) => c.dataSource,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed21585c041f82df9477b3fdc889e4f1abbcada"}, "originalPosition": 192}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82a2ca59f7faac1d9e4552be7dcda92718fb72d1", "author": {"user": {"login": "vogievetsky", "name": "Vadim Ogievetsky"}}, "url": "https://github.com/apache/druid/commit/82a2ca59f7faac1d9e4552be7dcda92718fb72d1", "committedDate": "2020-09-28T21:28:34Z", "message": "extracted utils, added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abfb72397a7b7f07808c8ecf457b07a80c9558de", "author": {"user": {"login": "vogievetsky", "name": "Vadim Ogievetsky"}}, "url": "https://github.com/apache/druid/commit/abfb72397a7b7f07808c8ecf457b07a80c9558de", "committedDate": "2020-09-28T22:42:04Z", "message": "add tests to general foramt functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MDA0NzIz", "url": "https://github.com/apache/druid/pull/10438#pullrequestreview-498004723", "createdAt": "2020-09-29T01:39:48Z", "commit": {"oid": "abfb72397a7b7f07808c8ecf457b07a80c9558de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3290, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}