{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MDY4ODY4", "number": 9492, "title": "add manual laning strategy, integration test", "bodyText": "Description\nThis PR is part of #6993, and a follow-up to #9407 which adds a ManualLaningStrategy that in addition to being useful to make it easy to add an integration test for the query laning functionality, is also well suited for cases where one or more external applications which query Druid are able to manually decide which lane a query belongs to by adding a lane parameter to the query context.\nexample config:\ndruid.query.scheduler.laning.strategy=manual\ndruid.query.scheduler.laning.isLimitPercent=true\ndruid.query.scheduler.laning.lanes.ten=10\ndruid.query.scheduler.laning.lanes.twenty=20\ndruid.query.scheduler.laning.lanes.fifty=50\n\nThe example defines 3 lanes, \"ten\", \"twenty\", and \"fifty\", which if the query context contains that lane name will be allowed to use up to 10%, 20%, or 50% of the total capacity.\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-10T11:05:51Z", "url": "https://github.com/apache/druid/pull/9492", "merged": true, "mergeCommit": {"oid": "69af760a19bfaa9de8dcc1c38d70d03be22d2ecd"}, "closed": true, "closedAt": "2020-03-14T03:06:56Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMPvwrgH2gAyMzg2MDY4ODY4OjY2NTRhNzI0YmRiZWZlYWJiMjhjNmQyZjVlYzVhZmFkZGZlODc1NWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNahKTgFqTM3NDY4NTgwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6654a724bdbefeabb28c6d2f5ec5afaddfe8755f", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/6654a724bdbefeabb28c6d2f5ec5afaddfe8755f", "committedDate": "2020-03-10T10:13:55Z", "message": "add manual laning strategy, integration test, json config test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b187125ce937a053a33116769403cc02a001ab23", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/b187125ce937a053a33116769403cc02a001ab23", "committedDate": "2020-03-10T11:10:13Z", "message": "share percent conversion method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/700e6abc1520bdaacb69f0a2d601ec73104d5b61", "committedDate": "2020-03-10T20:17:01Z", "message": "wrong assert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDQ3ODc2", "url": "https://github.com/apache/druid/pull/9492#pullrequestreview-373047876", "createdAt": "2020-03-11T19:08:45Z", "commit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTowODo0NVrOF1E-zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTo0Mjo0NFrOF1GCOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwMDQ2MA==", "bodyText": "assert this against StringUtils.format(QueryCapacityExceededException.ERROR_MESSAGE_TEMPLATE, \"one\") instead?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391200460", "createdAt": "2020-03-11T19:08:45Z", "author": {"login": "maytasm"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/query/ITWikipediaQueryTest.java", "diffHunk": "@@ -51,15 +69,78 @@ public void before() throws Exception\n     ITRetryUtil.retryUntilTrue(\n         () -> coordinatorClient.areSegmentsLoaded(WIKIPEDIA_DATA_SOURCE), \"wikipedia segment load\"\n     );\n-    coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n-    ITRetryUtil.retryUntilTrue(\n-        () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n-    );\n+    if (!coordinatorClient.areLookupsLoaded(WIKI_LOOKUP)) {\n+      coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n+      ITRetryUtil.retryUntilTrue(\n+          () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n+      );\n+    }\n   }\n \n   @Test\n   public void testWikipediaQueriesFromFile() throws Exception\n   {\n     queryHelper.testQueriesFromFile(WIKIPEDIA_QUERIES_RESOURCE, 2);\n   }\n+\n+  @Test\n+  public void testQueryLaning() throws Exception\n+  {\n+    // the broker is configured with 2 manually defined query lanes, 'one' with limit 1, and 'two' with limit 'two'\n+    //  -Ddruid.query.scheduler.laning.type=manual\n+    //  -Ddruid.query.scheduler.laning.lanes.one=1\n+    //  -Ddruid.query.scheduler.laning.lanes.two=2\n+    // by issuing 50 queries, at least 1 of them will succeed on 'one', and at least 1 of them will overlap enough to\n+    // get limited\n+    final int numQueries = 50;\n+    List<Future<StatusResponseHolder>> futures = new ArrayList<>(numQueries);\n+    for (int i = 0; i < numQueries; i++) {\n+      futures.add(\n+          queryClient.queryAsync(\n+              queryHelper.getQueryURL(config.getBrokerUrl()),\n+              getQueryBuilder().build()\n+          )\n+      );\n+    }\n+\n+    int success = 0;\n+    int limited = 0;\n+\n+    for (Future<StatusResponseHolder> future : futures) {\n+      StatusResponseHolder status = future.get();\n+      if (status.getStatus().getCode() == QueryCapacityExceededException.STATUS_CODE) {\n+        limited++;\n+        Assert.assertTrue(status.getContent().contains(\"one\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwMTkyMA==", "bodyText": "This can be separate into another @test method. Will make understanding each test case easier.", "url": "https://github.com/apache/druid/pull/9492#discussion_r391201920", "createdAt": "2020-03-11T19:11:43Z", "author": {"login": "maytasm"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/query/ITWikipediaQueryTest.java", "diffHunk": "@@ -51,15 +69,78 @@ public void before() throws Exception\n     ITRetryUtil.retryUntilTrue(\n         () -> coordinatorClient.areSegmentsLoaded(WIKIPEDIA_DATA_SOURCE), \"wikipedia segment load\"\n     );\n-    coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n-    ITRetryUtil.retryUntilTrue(\n-        () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n-    );\n+    if (!coordinatorClient.areLookupsLoaded(WIKI_LOOKUP)) {\n+      coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n+      ITRetryUtil.retryUntilTrue(\n+          () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n+      );\n+    }\n   }\n \n   @Test\n   public void testWikipediaQueriesFromFile() throws Exception\n   {\n     queryHelper.testQueriesFromFile(WIKIPEDIA_QUERIES_RESOURCE, 2);\n   }\n+\n+  @Test\n+  public void testQueryLaning() throws Exception\n+  {\n+    // the broker is configured with 2 manually defined query lanes, 'one' with limit 1, and 'two' with limit 'two'\n+    //  -Ddruid.query.scheduler.laning.type=manual\n+    //  -Ddruid.query.scheduler.laning.lanes.one=1\n+    //  -Ddruid.query.scheduler.laning.lanes.two=2\n+    // by issuing 50 queries, at least 1 of them will succeed on 'one', and at least 1 of them will overlap enough to\n+    // get limited\n+    final int numQueries = 50;\n+    List<Future<StatusResponseHolder>> futures = new ArrayList<>(numQueries);\n+    for (int i = 0; i < numQueries; i++) {\n+      futures.add(\n+          queryClient.queryAsync(\n+              queryHelper.getQueryURL(config.getBrokerUrl()),\n+              getQueryBuilder().build()\n+          )\n+      );\n+    }\n+\n+    int success = 0;\n+    int limited = 0;\n+\n+    for (Future<StatusResponseHolder> future : futures) {\n+      StatusResponseHolder status = future.get();\n+      if (status.getStatus().getCode() == QueryCapacityExceededException.STATUS_CODE) {\n+        limited++;\n+        Assert.assertTrue(status.getContent().contains(\"one\"));\n+      } else if (status.getStatus().getCode() == HttpResponseStatus.OK.getCode()) {\n+        success++;\n+      }\n+    }\n+\n+    Assert.assertTrue(success > 0);\n+    Assert.assertTrue(limited > 0);\n+\n+    // test another to make sure we can still issue one query at a time", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwNjkzMQ==", "bodyText": "maybe also test negative case (like lane name \"three\") and see we get NO_CAPACITY?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391206931", "createdAt": "2020-03-11T19:21:31Z", "author": {"login": "maytasm"}, "path": "server/src/test/java/org/apache/druid/server/QuerySchedulerTest.java", "diffHunk": "@@ -399,6 +399,49 @@ public void testMisConfigHiLo()\n   }\n \n \n+  @Test\n+  public void testConfigManual()\n+  {\n+    final Injector injector = createInjector();\n+    final String propertyPrefix = \"druid.query.scheduler\";\n+    final JsonConfigProvider<QuerySchedulerProvider> provider = JsonConfigProvider.of(\n+        propertyPrefix,\n+        QuerySchedulerProvider.class\n+    );\n+    final Properties properties = new Properties();\n+    properties.put(propertyPrefix + \".numThreads\", \"10\");\n+    properties.put(propertyPrefix + \".laning.strategy\", \"manual\");\n+    properties.put(propertyPrefix + \".laning.lanes.one\", \"1\");\n+    properties.put(propertyPrefix + \".laning.lanes.two\", \"2\");\n+    provider.inject(properties, injector.getInstance(JsonConfigurator.class));\n+    final QueryScheduler scheduler = provider.get().get().get();\n+    Assert.assertEquals(10, scheduler.getTotalAvailableCapacity());\n+    Assert.assertEquals(1, scheduler.getLaneAvailableCapacity(\"one\"));\n+    Assert.assertEquals(2, scheduler.getLaneAvailableCapacity(\"two\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIwNjk3NQ==", "bodyText": "maybe also test negative case (like lane name \"three\") and see we get NO_CAPACITY?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391206975", "createdAt": "2020-03-11T19:21:36Z", "author": {"login": "maytasm"}, "path": "server/src/test/java/org/apache/druid/server/QuerySchedulerTest.java", "diffHunk": "@@ -399,6 +399,49 @@ public void testMisConfigHiLo()\n   }\n \n \n+  @Test\n+  public void testConfigManual()\n+  {\n+    final Injector injector = createInjector();\n+    final String propertyPrefix = \"druid.query.scheduler\";\n+    final JsonConfigProvider<QuerySchedulerProvider> provider = JsonConfigProvider.of(\n+        propertyPrefix,\n+        QuerySchedulerProvider.class\n+    );\n+    final Properties properties = new Properties();\n+    properties.put(propertyPrefix + \".numThreads\", \"10\");\n+    properties.put(propertyPrefix + \".laning.strategy\", \"manual\");\n+    properties.put(propertyPrefix + \".laning.lanes.one\", \"1\");\n+    properties.put(propertyPrefix + \".laning.lanes.two\", \"2\");\n+    provider.inject(properties, injector.getInstance(JsonConfigurator.class));\n+    final QueryScheduler scheduler = provider.get().get().get();\n+    Assert.assertEquals(10, scheduler.getTotalAvailableCapacity());\n+    Assert.assertEquals(1, scheduler.getLaneAvailableCapacity(\"one\"));\n+    Assert.assertEquals(2, scheduler.getLaneAvailableCapacity(\"two\"));\n+  }\n+\n+  @Test\n+  public void testConfigManualPercent()\n+  {\n+    final Injector injector = createInjector();\n+    final String propertyPrefix = \"druid.query.scheduler\";\n+    final JsonConfigProvider<QuerySchedulerProvider> provider = JsonConfigProvider.of(\n+        propertyPrefix,\n+        QuerySchedulerProvider.class\n+    );\n+    final Properties properties = new Properties();\n+    properties.put(propertyPrefix + \".numThreads\", \"10\");\n+    properties.put(propertyPrefix + \".laning.strategy\", \"manual\");\n+    properties.put(propertyPrefix + \".laning.isLimitPercent\", \"true\");\n+    properties.put(propertyPrefix + \".laning.lanes.one\", \"1\");\n+    properties.put(propertyPrefix + \".laning.lanes.twenty\", \"20\");\n+    provider.inject(properties, injector.getInstance(JsonConfigurator.class));\n+    final QueryScheduler scheduler = provider.get().get().get();\n+    Assert.assertEquals(10, scheduler.getTotalAvailableCapacity());\n+    Assert.assertEquals(1, scheduler.getLaneAvailableCapacity(\"one\"));\n+    Assert.assertEquals(2, scheduler.getLaneAvailableCapacity(\"twenty\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxMjczOA==", "bodyText": "Just wondering..why does computeLane needs SegmentServerSelector? Doesn't laning or not should just depend on the query context that was given with the query?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391212738", "createdAt": "2020-03-11T19:33:03Z", "author": {"login": "maytasm"}, "path": "server/src/main/java/org/apache/druid/server/scheduling/ManualQueryLaningStrategy.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.scheduling;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import it.unimi.dsi.fastutil.objects.Object2IntArrayMap;\n+import it.unimi.dsi.fastutil.objects.Object2IntMap;\n+import org.apache.druid.client.SegmentServerSelector;\n+import org.apache.druid.query.QueryContexts;\n+import org.apache.druid.query.QueryPlus;\n+import org.apache.druid.server.QueryLaningStrategy;\n+\n+import javax.annotation.Nullable;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public class ManualQueryLaningStrategy implements QueryLaningStrategy\n+{\n+  @JsonProperty\n+  private Map<String, Integer> lanes;\n+\n+  @JsonProperty\n+  private boolean isLimitPercent;\n+\n+  @JsonCreator\n+  public ManualQueryLaningStrategy(\n+      @JsonProperty(\"lanes\") Map<String, Integer> lanes,\n+      @JsonProperty(\"isLimitPercent\") @Nullable Boolean isLimitPercent\n+  )\n+  {\n+    this.lanes = Preconditions.checkNotNull(lanes, \"lanes must be set\");\n+    this.isLimitPercent = isLimitPercent != null ? isLimitPercent : false;\n+    Preconditions.checkArgument(lanes.size() > 0, \"lanes must define at least one lane\");\n+    Preconditions.checkArgument(\n+        lanes.values().stream().allMatch(x -> this.isLimitPercent ? 0 < x && x <= 100 : x > 0),\n+        this.isLimitPercent ? \"All lane limits must be in the range 1 to 100\" : \"All lane limits must be greater than 0\"\n+    );\n+  }\n+\n+  @Override\n+  public Object2IntMap<String> getLaneLimits(int totalLimit)\n+  {\n+\n+    if (isLimitPercent) {\n+      Object2IntMap<String> laneLimits = new Object2IntArrayMap<>(lanes.size());\n+      lanes.forEach((key, value) -> laneLimits.put(key, computeLimitFromPercent(totalLimit, value)));\n+      return laneLimits;\n+    }\n+    return new Object2IntArrayMap<>(lanes);\n+  }\n+\n+  @Override\n+  public <T> Optional<String> computeLane(QueryPlus<T> query, Set<SegmentServerSelector> segments)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxMzYzOA==", "bodyText": "testPercentLaneLimitsMustBeBelowOneHundred?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391213638", "createdAt": "2020-03-11T19:34:47Z", "author": {"login": "maytasm"}, "path": "server/src/test/java/org/apache/druid/server/scheduling/ManualQueryLaningStrategyTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.scheduling;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import it.unimi.dsi.fastutil.objects.Object2IntMap;\n+import org.apache.druid.java.util.common.Intervals;\n+import org.apache.druid.java.util.common.granularity.Granularities;\n+import org.apache.druid.query.Druids;\n+import org.apache.druid.query.QueryContexts;\n+import org.apache.druid.query.QueryPlus;\n+import org.apache.druid.query.aggregation.CountAggregatorFactory;\n+import org.apache.druid.query.timeseries.TimeseriesQuery;\n+import org.apache.druid.server.QueryLaningStrategy;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+@SuppressWarnings(\"ResultOfObjectAllocationIgnored\")\n+public class ManualQueryLaningStrategyTest\n+{\n+  private Druids.TimeseriesQueryBuilder queryBuilder;\n+  private QueryLaningStrategy exactStrategy;\n+  private QueryLaningStrategy percentStrategy;\n+\n+  @Rule\n+  public ExpectedException expectedException = ExpectedException.none();\n+\n+  @Before\n+  public void setup()\n+  {\n+    this.queryBuilder = Druids.newTimeseriesQueryBuilder()\n+                              .dataSource(\"test\")\n+                              .intervals(ImmutableList.of(Intervals.ETERNITY))\n+                              .granularity(Granularities.DAY)\n+                              .aggregators(new CountAggregatorFactory(\"count\"));\n+    this.exactStrategy =\n+        new ManualQueryLaningStrategy(ImmutableMap.of(\"one\", 1, \"ten\", 10), null);\n+    this.percentStrategy =\n+        new ManualQueryLaningStrategy(ImmutableMap.of(\"one\", 1, \"ten\", 10), true);\n+  }\n+\n+  @Test\n+  public void testLanesMustBeSet()\n+  {\n+    expectedException.expect(NullPointerException.class);\n+    expectedException.expectMessage(\"lanes must be set\");\n+    new ManualQueryLaningStrategy(null, null);\n+  }\n+\n+  @Test\n+  public void testMustDefineAtLeast1Lane()\n+  {\n+    expectedException.expect(IllegalArgumentException.class);\n+    expectedException.expectMessage(\"lanes must define at least one lane\");\n+    new ManualQueryLaningStrategy(ImmutableMap.of(), null);\n+  }\n+\n+  @Test\n+  public void testExactLaneLimitsMustBeAboveZero()\n+  {\n+    expectedException.expect(IllegalArgumentException.class);\n+    expectedException.expectMessage(\"All lane limits must be greater than 0\");\n+    new ManualQueryLaningStrategy(ImmutableMap.of(\"zero\", 0, \"one\", 1), null);\n+  }\n+\n+  @Test\n+  public void testPercentLaneLimitsMustBeAboveZero()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNzcyMA==", "bodyText": "Should we also have a test for when the Manual Lane From Context That Arent In Map is given? For example, if lane in query context is \"some-unknown-lane\"", "url": "https://github.com/apache/druid/pull/9492#discussion_r391217720", "createdAt": "2020-03-11T19:42:44Z", "author": {"login": "maytasm"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/query/ITWikipediaQueryTest.java", "diffHunk": "@@ -51,15 +69,78 @@ public void before() throws Exception\n     ITRetryUtil.retryUntilTrue(\n         () -> coordinatorClient.areSegmentsLoaded(WIKIPEDIA_DATA_SOURCE), \"wikipedia segment load\"\n     );\n-    coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n-    ITRetryUtil.retryUntilTrue(\n-        () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n-    );\n+    if (!coordinatorClient.areLookupsLoaded(WIKI_LOOKUP)) {\n+      coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n+      ITRetryUtil.retryUntilTrue(\n+          () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n+      );\n+    }\n   }\n \n   @Test\n   public void testWikipediaQueriesFromFile() throws Exception\n   {\n     queryHelper.testQueriesFromFile(WIKIPEDIA_QUERIES_RESOURCE, 2);\n   }\n+\n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODg5Nzcw", "url": "https://github.com/apache/druid/pull/9492#pullrequestreview-373889770", "createdAt": "2020-03-12T20:48:02Z", "commit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDo0ODowMlrOF1uy_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMTo0NzoyNFrOF1w4_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NTU2Ng==", "bodyText": "numbers must be in the range of 1 to 100.\n\nShould it say the number type is the integer?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391885566", "createdAt": "2020-03-12T20:48:02Z", "author": {"login": "jihoonson"}, "path": "docs/configuration/index.md", "diffHunk": "@@ -1505,7 +1505,16 @@ This strategy can be enabled by setting `druid.query.scheduler.laning.strategy=h\n \n |Property|Description|Default|\n |--------|-----------|-------|\n-|`druid.query.scheduler.laning.maxLowPercent`|Maximum percent of the smaller number of`druid.server.http.numThreads` or `druid.query.scheduler.numThreads`, defining the number of HTTP threads that can be used by queries with a priority lower than 0. Value must be in the range 1 to 100, and will be rounded up|No default, must be set if using this mode|\n+|`druid.query.scheduler.laning.maxLowPercent`|Maximum percent of the smaller number of `druid.server.http.numThreads` or `druid.query.scheduler.numThreads`, defining the number of HTTP threads that can be used by queries with a priority lower than 0. Value must be in the range 1 to 100, and will be rounded up|No default, must be set if using this mode|\n+\n+\n+###### 'Manual' laning strategy\n+This laning strategy is best suited for cases where one or more external applications which query Druid are capable of manually deciding what lane a given query should belong to. Configured with a map of lane names to percent or exact max capacities, queries with a matching `lane` parameter in the [query context](../querying/query-context.md) will be subjected to those limits.\n+\n+|Property|Description|Default|\n+|--------|-----------|-------|\n+|`druid.query.scheduler.laning.lanes.{name}`|Maximum percent or exact limit of queries that can concurrently run in the defined lanes. Any number of lanes may be defined like this.|No default, must define at least one lane with a limit above 0. If `druid.query.scheduler.laning.isLimitPercent` is set to `true`, numbers must be in the range of 1 to 100.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxNzM4Ng==", "bodyText": "Seems the lane 'two' is not used. Perhaps better to remove it for now.", "url": "https://github.com/apache/druid/pull/9492#discussion_r391917386", "createdAt": "2020-03-12T21:43:56Z", "author": {"login": "jihoonson"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/query/ITWikipediaQueryTest.java", "diffHunk": "@@ -51,15 +69,78 @@ public void before() throws Exception\n     ITRetryUtil.retryUntilTrue(\n         () -> coordinatorClient.areSegmentsLoaded(WIKIPEDIA_DATA_SOURCE), \"wikipedia segment load\"\n     );\n-    coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n-    ITRetryUtil.retryUntilTrue(\n-        () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n-    );\n+    if (!coordinatorClient.areLookupsLoaded(WIKI_LOOKUP)) {\n+      coordinatorClient.initializeLookups(WIKIPEDIA_LOOKUP_RESOURCE);\n+      ITRetryUtil.retryUntilTrue(\n+          () -> coordinatorClient.areLookupsLoaded(WIKI_LOOKUP), \"wikipedia lookup load\"\n+      );\n+    }\n   }\n \n   @Test\n   public void testWikipediaQueriesFromFile() throws Exception\n   {\n     queryHelper.testQueriesFromFile(WIKIPEDIA_QUERIES_RESOURCE, 2);\n   }\n+\n+  @Test\n+  public void testQueryLaning() throws Exception\n+  {\n+    // the broker is configured with 2 manually defined query lanes, 'one' with limit 1, and 'two' with limit 'two'\n+    //  -Ddruid.query.scheduler.laning.type=manual\n+    //  -Ddruid.query.scheduler.laning.lanes.one=1\n+    //  -Ddruid.query.scheduler.laning.lanes.two=2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxOTg3MQ==", "bodyText": "Should it check the sum of percents of lanes is less than or equal to 100 when isLimitPercent = true?", "url": "https://github.com/apache/druid/pull/9492#discussion_r391919871", "createdAt": "2020-03-12T21:47:24Z", "author": {"login": "jihoonson"}, "path": "server/src/main/java/org/apache/druid/server/scheduling/ManualQueryLaningStrategy.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.server.scheduling;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.base.Preconditions;\n+import it.unimi.dsi.fastutil.objects.Object2IntArrayMap;\n+import it.unimi.dsi.fastutil.objects.Object2IntMap;\n+import org.apache.druid.client.SegmentServerSelector;\n+import org.apache.druid.query.QueryContexts;\n+import org.apache.druid.query.QueryPlus;\n+import org.apache.druid.server.QueryLaningStrategy;\n+\n+import javax.annotation.Nullable;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public class ManualQueryLaningStrategy implements QueryLaningStrategy\n+{\n+  @JsonProperty\n+  private Map<String, Integer> lanes;\n+\n+  @JsonProperty\n+  private boolean isLimitPercent;\n+\n+  @JsonCreator\n+  public ManualQueryLaningStrategy(\n+      @JsonProperty(\"lanes\") Map<String, Integer> lanes,\n+      @JsonProperty(\"isLimitPercent\") @Nullable Boolean isLimitPercent\n+  )\n+  {\n+    this.lanes = Preconditions.checkNotNull(lanes, \"lanes must be set\");\n+    this.isLimitPercent = isLimitPercent != null ? isLimitPercent : false;\n+    Preconditions.checkArgument(lanes.size() > 0, \"lanes must define at least one lane\");\n+    Preconditions.checkArgument(\n+        lanes.values().stream().allMatch(x -> this.isLimitPercent ? 0 < x && x <= 100 : x > 0),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700e6abc1520bdaacb69f0a2d601ec73104d5b61"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13491bb3f81268a357b27f2d3953e0af31ddcf38", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/13491bb3f81268a357b27f2d3953e0af31ddcf38", "committedDate": "2020-03-13T08:42:43Z", "message": "Merge remote-tracking branch 'upstream/master' into manual-query-laning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05c9fa53c7c83362241092bcbd71d732be837a0", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/a05c9fa53c7c83362241092bcbd71d732be837a0", "committedDate": "2020-03-13T08:58:43Z", "message": "review stuffs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20c10cfedb3d0cc2b28b4a5c7afe0e5ca2e4b929", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/20c10cfedb3d0cc2b28b4a5c7afe0e5ca2e4b929", "committedDate": "2020-03-13T09:01:09Z", "message": "doc adjustments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bf4232d3aa4f4f0d42bd1724aacbdc2a0a971c5", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/0bf4232d3aa4f4f0d42bd1724aacbdc2a0a971c5", "committedDate": "2020-03-13T09:05:13Z", "message": "more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee435add58db2333e2539e904d0d3114f5b2f477", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/ee435add58db2333e2539e904d0d3114f5b2f477", "committedDate": "2020-03-13T09:06:46Z", "message": "test adjustment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdb2d12c73e508c81659dffcc5e220839b43c1e1", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/cdb2d12c73e508c81659dffcc5e220839b43c1e1", "committedDate": "2020-03-14T00:13:11Z", "message": "adjust docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9762699717e50c1297539d25a38af749a289acb", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/d9762699717e50c1297539d25a38af749a289acb", "committedDate": "2020-03-14T01:00:45Z", "message": "Update index.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg1ODA5", "url": "https://github.com/apache/druid/pull/9492#pullrequestreview-374685809", "createdAt": "2020-03-14T01:20:51Z", "commit": {"oid": "d9762699717e50c1297539d25a38af749a289acb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2612, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}