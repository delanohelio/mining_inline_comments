{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzODk0ODMx", "number": 9705, "title": "add joins to column tree menu", "bodyText": "For datasources and dimensions in the lookup schema, the user now has the option to add a LEFT or INNER join to the current query.\nThe added clause will be :\n<JOINTYPE> JOIN lookup.<datasource> ON lookup.<datasource>.<placeholderXXXOrColumn> = <currentDatasource>.XXX", "createdAt": "2020-04-15T17:32:12Z", "url": "https://github.com/apache/druid/pull/9705", "merged": true, "mergeCommit": {"oid": "b7fdb294237eccc39149da3fd7751ddd31e2fc2d"}, "closed": true, "closedAt": "2020-04-17T00:52:00Z", "author": {"login": "mcbrewster"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX7i_5AH2gAyNDAzODk0ODMxOjUwM2YxNjYwZmI2ZmEzNGU2YTBmNmUxNmZmNmUzMDUxYWE0MTY2MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYWeauAFqTM5NTA5MzQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "503f1660fb6fa34e6a0f6e16ff6e3051aa41662d", "author": {"user": {"login": "mcbrewster", "name": null}}, "url": "https://github.com/apache/druid/commit/503f1660fb6fa34e6a0f6e16ff6e3051aa41662d", "committedDate": "2020-04-15T17:28:58Z", "message": "add joins to column tree menu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38580217b705c26224714d1ea17c088e1f129728", "author": {"user": {"login": "mcbrewster", "name": null}}, "url": "https://github.com/apache/druid/commit/38580217b705c26224714d1ea17c088e1f129728", "committedDate": "2020-04-15T20:21:05Z", "message": "fix capitalization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "author": {"user": {"login": "mcbrewster", "name": null}}, "url": "https://github.com/apache/druid/commit/cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "committedDate": "2020-04-16T01:52:51Z", "message": "add keyword, keep columns if replaced"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc0NjU4", "url": "https://github.com/apache/druid/pull/9705#pullrequestreview-394274658", "createdAt": "2020-04-16T03:28:12Z", "commit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzoyODoxMlrOGGTN7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozMjozNVrOGGTSSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTUwMw==", "bodyText": "capitalization", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259503", "createdAt": "2020-04-16T03:28:12Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTU2OA==", "bodyText": "Cap", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259568", "createdAt": "2020-04-16T03:28:28Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+        >\n+          <MenuItem\n+            icon={IconNames.LEFT_JOIN}\n+            text={`Left Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTY2MA==", "bodyText": "ditto", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259660", "createdAt": "2020-04-16T03:28:49Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+        >\n+          <MenuItem\n+            icon={IconNames.LEFT_JOIN}\n+            text={`Left Join`}\n+            onClick={() => {\n+              onQueryChange(\n+                parsedQuery.addJoin(\n+                  'LEFT',\n+                  SqlRef.fromString(table, schema).upgrade(),\n+                  SqlMulti.sqlMultiFactory('=', [\n+                    SqlRef.fromString(columnName, table, 'lookup'),\n+                    SqlRef.fromString(\n+                      lookupColumn === columnName ? originalTableColumn : 'XXX',\n+                      parsedQuery.getTableName(),\n+                    ),\n+                  ]),\n+                ),\n+                false,\n+              );\n+            }}\n+          />\n+          <MenuItem\n+            icon={IconNames.INNER_JOIN}\n+            text={`Inner Join`}\n+            onClick={() => {\n+              onQueryChange(\n+                parsedQuery.addJoin(\n+                  'INNER',\n+                  SqlRef.fromString(table, schema).upgrade(),\n+                  SqlMulti.sqlMultiFactory('=', [\n+                    SqlRef.fromString(columnName, table, 'lookup'),\n+                    SqlRef.fromString(\n+                      lookupColumn === columnName ? originalTableColumn : 'XXX',\n+                      parsedQuery.getTableName(),\n+                    ),\n+                  ]),\n+                ),\n+                false,\n+              );\n+            }}\n+          />\n+        </MenuItem>\n+        {parsedQuery.onExpression &&\n+          parsedQuery.onExpression instanceof SqlMulti &&\n+          parsedQuery.onExpression.containsColumn(columnName) && (\n+            <MenuItem\n+              icon={IconNames.EXCHANGE}\n+              text={`Remove Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDAxNQ==", "bodyText": "Cap", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260015", "createdAt": "2020-04-16T03:30:05Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDE2MQ==", "bodyText": "Sentence case", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260161", "createdAt": "2020-04-16T03:30:43Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'LEFT',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                                <MenuItem\n+                                  icon={IconNames.INNER_JOIN}\n+                                  text={`Inner Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDIwNA==", "bodyText": "Cap", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260204", "createdAt": "2020-04-16T03:30:53Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDIyOA==", "bodyText": "Cap", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260228", "createdAt": "2020-04-16T03:31:02Z", "author": {"login": "vogievetsky"}, "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'LEFT',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                                <MenuItem\n+                                  icon={IconNames.INNER_JOIN}\n+                                  text={`Inner Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'INNER',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                              </MenuItem>\n+                            )}\n+                            {parsedQuery &&\n+                              parsedQuery.joinTable &&\n+                              parsedQuery.joinTable.table === table && (\n+                                <MenuItem\n+                                  icon={IconNames.EXCHANGE}\n+                                  text={`Remove Join`}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDYxOA==", "bodyText": "What about RIGHT? Are there any other keywords that are now supported that should go here?", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260618", "createdAt": "2020-04-16T03:32:35Z", "author": {"login": "vogievetsky"}, "path": "web-console/lib/keywords.js", "diffHunk": "@@ -34,6 +34,10 @@ exports.SQL_KEYWORDS = [\n   'DESC',\n   'LIMIT',\n   'UNION ALL',\n+  'JOIN',\n+  'LEFT',\n+  'INNER',\n+  'ON',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a4e3901c8768c42ab584197d80b2baeb690d62", "author": {"user": {"login": "mcbrewster", "name": null}}, "url": "https://github.com/apache/druid/commit/b0a4e3901c8768c42ab584197d80b2baeb690d62", "committedDate": "2020-04-16T03:41:19Z", "message": "actually fix capitalization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b7772bf1591834f0a031f1a622b9937af7efac4", "author": {"user": {"login": "mcbrewster", "name": null}}, "url": "https://github.com/apache/druid/commit/3b7772bf1591834f0a031f1a622b9937af7efac4", "committedDate": "2020-04-16T03:43:00Z", "message": "add keywords"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDkzNDE2", "url": "https://github.com/apache/druid/pull/9705#pullrequestreview-395093416", "createdAt": "2020-04-17T00:51:24Z", "commit": {"oid": "3b7772bf1591834f0a031f1a622b9937af7efac4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2519, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}