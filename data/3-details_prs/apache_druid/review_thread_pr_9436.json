{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTc0Nzg2", "number": 9436, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMDowMlrOD34Xzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowODo1NlrOD34dEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTIxODcxOnYy", "diffSide": "RIGHT", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMDowMlrOGOY1WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMDowMlrOGOY1WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MDEyMA==", "bodyText": "Since this.numBins will be ignored if splitPoints is set, it'd be best to throw an error in the constructor if both are provided.  Could you please add one (an error message like \"Cannot accept both 'numBins' and 'splitPoints'\").", "url": "https://github.com/apache/druid/pull/9436#discussion_r417740120", "createdAt": "2020-04-30T04:00:02Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -29,45 +29,68 @@\n import org.apache.druid.query.aggregation.PostAggregator;\n import org.apache.druid.query.cache.CacheKeyBuilder;\n \n+import javax.annotation.Nullable;\n import java.util.Arrays;\n import java.util.Comparator;\n import java.util.Map;\n import java.util.Set;\n \n public class DoublesSketchToHistogramPostAggregator implements PostAggregator\n {\n+  static final int DEFAULT_NUM_BINS = 10;\n \n   private final String name;\n   private final PostAggregator field;\n   private final double[] splitPoints;\n+  private final Integer numBins;\n \n   @JsonCreator\n   public DoublesSketchToHistogramPostAggregator(\n       @JsonProperty(\"name\") final String name,\n       @JsonProperty(\"field\") final PostAggregator field,\n-      @JsonProperty(\"splitPoints\") final double[] splitPoints)\n+      @JsonProperty(\"splitPoints\") @Nullable final double[] splitPoints,\n+      @JsonProperty(\"numBins\") @Nullable final Integer numBins)\n   {\n     this.name = Preconditions.checkNotNull(name, \"name is null\");\n     this.field = Preconditions.checkNotNull(field, \"field is null\");\n-    this.splitPoints = Preconditions.checkNotNull(splitPoints, \"array of split points is null\");\n+    this.splitPoints = splitPoints;\n+    this.numBins = numBins;\n   }\n \n   @Override\n   public Object compute(final Map<String, Object> combinedAggregators)\n   {\n     final DoublesSketch sketch = (DoublesSketch) field.compute(combinedAggregators);\n+    final int numBins = splitPoints != null ? splitPoints.length + 1 :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTIyMTc4OnYy", "diffSide": "RIGHT", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMjoxNFrOGOY3Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowMjoxNFrOGOY3Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MDYwMw==", "bodyText": "Suggest doing @JsonInclude(JsonInclude.Include.NON_NULL) so the serialized form is cleaner when numBins is null.\n(It would make sense to add this to getSplitPoints too.)", "url": "https://github.com/apache/druid/pull/9436#discussion_r417740603", "createdAt": "2020-04-30T04:02:14Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -87,6 +110,12 @@ public PostAggregator getField()\n     return splitPoints;\n   }\n \n+  @JsonProperty\n+  public Integer getNumBins()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTIyNzQ0OnYy", "diffSide": "RIGHT", "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowNTo1M1rOGOY6hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDowODowMVrOGQQQAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MTQ0NQ==", "bodyText": "Please add an EqualsVerifier test too. We don't have them everywhere yet but we're trying to add them in patches that adjust equals or hashCode implementations. Check out InFilterTest for an example. It looks like this.\n  @Test\n  public void testEquals()\n  {\n    EqualsVerifier.forClass(InFilter.class)\n                  .usingGetClass()\n                  .withNonnullFields(\"dimension\", \"values\")\n                  .withIgnoredFields(\"longPredicateSupplier\", \"floatPredicateSupplier\", \"doublePredicateSupplier\")\n                  .verify();\n  }", "url": "https://github.com/apache/druid/pull/9436#discussion_r417741445", "createdAt": "2020-04-30T04:05:53Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -125,14 +155,26 @@ public boolean equals(final Object o)\n     if (!Arrays.equals(splitPoints, that.splitPoints)) {\n       return false;\n     }\n-    return field.equals(that.field);\n+    if (!field.equals(that.field)) {\n+      return false;\n+    }\n+    if (numBins == null && that.numBins == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4NzIxNg==", "bodyText": "It seems to me that this EqualsVerifier is not visible in this branch. Perhaps it was added to some pom file later. Would you like me to merge from master or rebase?", "url": "https://github.com/apache/druid/pull/9436#discussion_r419687216", "createdAt": "2020-05-04T19:50:36Z", "author": {"login": "AlexanderSaydakov"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -125,14 +155,26 @@ public boolean equals(final Object o)\n     if (!Arrays.equals(splitPoints, that.splitPoints)) {\n       return false;\n     }\n-    return field.equals(that.field);\n+    if (!field.equals(that.field)) {\n+      return false;\n+    }\n+    if (numBins == null && that.numBins == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MTQ0NQ=="}, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY5NjE0Mg==", "bodyText": "You might need to add this to the datasketches pom:\n    <dependency>\n      <groupId>nl.jqno.equalsverifier</groupId>\n      <artifactId>equalsverifier</artifactId>\n      <scope>test</scope>\n    </dependency>", "url": "https://github.com/apache/druid/pull/9436#discussion_r419696142", "createdAt": "2020-05-04T20:07:04Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -125,14 +155,26 @@ public boolean equals(final Object o)\n     if (!Arrays.equals(splitPoints, that.splitPoints)) {\n       return false;\n     }\n-    return field.equals(that.field);\n+    if (!field.equals(that.field)) {\n+      return false;\n+    }\n+    if (numBins == null && that.numBins == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MTQ0NQ=="}, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY5NjY0MQ==", "bodyText": "Merging from master would be useful too if your branch is old enough that it doesn't have equalsverifier in the master pom.", "url": "https://github.com/apache/druid/pull/9436#discussion_r419696641", "createdAt": "2020-05-04T20:08:01Z", "author": {"login": "gianm"}, "path": "extensions-core/datasketches/src/main/java/org/apache/druid/query/aggregation/datasketches/quantiles/DoublesSketchToHistogramPostAggregator.java", "diffHunk": "@@ -125,14 +155,26 @@ public boolean equals(final Object o)\n     if (!Arrays.equals(splitPoints, that.splitPoints)) {\n       return false;\n     }\n-    return field.equals(that.field);\n+    if (!field.equals(that.field)) {\n+      return false;\n+    }\n+    if (numBins == null && that.numBins == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MTQ0NQ=="}, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTIzMjE3OnYy", "diffSide": "RIGHT", "path": "docs/development/extensions-core/datasketches-quantiles.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowODo1NlrOGOY9Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDowODo1NlrOGOY9Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MjE2Nw==", "bodyText": "It's suggested, but not explicitly called out, that you aren't allowed to specify both splitPoints and numBins. It'd be better to call it out.", "url": "https://github.com/apache/druid/pull/9436#discussion_r417742167", "createdAt": "2020-04-30T04:08:56Z", "author": {"login": "gianm"}, "path": "docs/development/extensions-core/datasketches-quantiles.md", "diffHunk": "@@ -87,14 +87,15 @@ This returns an array of quantiles corresponding to a given array of fractions\n \n #### Histogram\n \n-This returns an approximation to the histogram given an array of split points that define the histogram bins. An array of <i>m</i> unique, monotonically increasing split points divide the real number line into <i>m+1</i> consecutive disjoint intervals. The definition of an interval is inclusive of the left split point and exclusive of the right split point.\n+This returns an approximation to the histogram given an array of split points that define the histogram bins or a number of bins. An array of <i>m</i> unique, monotonically increasing split points divide the real number line into <i>m+1</i> consecutive disjoint intervals. The definition of an interval is inclusive of the left split point and exclusive of the right split point. If the number of bins is specified instead of split points, the interval between the minimum and maximum values is divided into the given number of equally-spaced bins.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d287b3fd8236ad234c0b29c4879ce9f1756ee9"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2802, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}