{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MTQ5NjY1", "number": 9509, "title": "add kinesis lag metric", "bodyText": "Fixes #6739.\nDescription\nThis PR adds an additional set of SeekableStreamSupervisor lag metrics, based on time in millis behind the latest offsets of the stream, allowing the Kinesis indexing service extension to have a lag metric. scheduleReporting  and emitLag were pushed down from KafkaSupervisor into SeekableStreamSupervisor, and two additional abstract methods, getPartitionRecordLag and getPartitionTimeLag which collect the two types of lag metrics per partition of the stream.\nKafka's existing lag metrics are still collected in the same format for backwards compatibility.\ningest/{supervisor type}/lag\ningest/{supervisor type}/maxLag\ningest/{supervisor type}/avgLag\n\nand the new time metrics have a /time suffix.\ningest/{supervisor type}/lag/time\ningest/{supervisor type}/maxLag/time\ningest/{supervisor type}/avgLag/time\n\nCurrently KafkaSupervisor only emits the former set of metrics, and KinesisSupervisor, after this PR, will emit only the latter. It seems possible for KafkaSupervisor to emit both sets of metrics, but I will save that for a follow-up PR.\nLag is also available on the supervisor status reports:\nexample kinesis supervisor status report:\n{\n  \"dataSource\": \"clint-test-kinesis\",\n  \"stream\": \"clint-test\",\n  \"partitions\": 1,\n  \"replicas\": 1,\n  \"durationSeconds\": 3600,\n  \"activeTasks\": [\n    {\n      \"id\": \"index_kinesis_clint-test-kinesis_0dbe7907dfdf424_omdghmmd\",\n      \"startingOffsets\": {\n        \"shardId-000000000000\": \"49605075714895969944729166984744978015226161388004048898\"\n      },\n      \"startTime\": null,\n      \"remainingSeconds\": null,\n      \"type\": \"ACTIVE\",\n      \"currentOffsets\": {},\n      \"lag\": {},\n      \"lagMillis\": {\n        \"shardId-000000000000\": 86244000\n      }\n    }\n  ],\n  \"publishingTasks\": [],\n  \"minimumLagMillis\": {\n    \"shardId-000000000000\": 86243000\n  },\n  \"aggregateLagMillis\": 86243000,\n  \"suspended\": false,\n  \"healthy\": true,\n  \"state\": \"RUNNING\",\n  \"detailedState\": \"RUNNING\",\n  \"recentErrors\": []\n}\n\nexample status report with suspended supervisor:\n{\n  \"dataSource\": \"clint-test-kinesis\",\n  \"stream\": \"clint-test\",\n  \"partitions\": 1,\n  \"replicas\": 1,\n  \"durationSeconds\": 3600,\n  \"activeTasks\": [],\n  \"publishingTasks\": [],\n  \"minimumLagMillis\": {\n    \"shardId-000000000000\": 22463000\n  },\n  \"aggregateLagMillis\": 22463000,\n  \"suspended\": true,\n  \"healthy\": true,\n  \"state\": \"SUSPENDED\",\n  \"detailedState\": \"SUSPENDED\",\n  \"recentErrors\": []\n}\n\n\nThis PR has:\n\n been self-reviewed.\n\n using the concurrency checklist (Remove this item if the PR doesn't have any relation to concurrency.)\n\n\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.\n\n\nKey changed/added classes in this PR\n\nSeekableStreamSupervisor\nKafkaSupervisor\nKinesisSupervisor", "createdAt": "2020-03-12T10:07:10Z", "url": "https://github.com/apache/druid/pull/9509", "merged": true, "mergeCommit": {"oid": "142742f291daaf1ac9afea319cacbbe2a3077952"}, "closed": true, "closedAt": "2020-03-17T04:39:53Z", "author": {"login": "clintropolis"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM4oCFgH2gAyMzg3MTQ5NjY1OjEwMWMyYjM3MjgzNzkzMzJkMjVlNGNkYTM1NmMxZmFjOTg0YjVlNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcObJuigFqTM3NTczNjAzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "101c2b3728379332d25e4cda356c1fac984b5e74", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/101c2b3728379332d25e4cda356c1fac984b5e74", "committedDate": "2020-03-12T09:51:35Z", "message": "add kinesis lag metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646a70bb81cf173efc6198d278febf45dcc0051f", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/646a70bb81cf173efc6198d278febf45dcc0051f", "committedDate": "2020-03-12T11:40:13Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac70fc3abc5c54b634f0410eff082b9089d77a64", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/ac70fc3abc5c54b634f0410eff082b9089d77a64", "committedDate": "2020-03-12T22:47:07Z", "message": "heh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a8904993e677ac521eeda0c37a30bfd4dd30b1", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/19a8904993e677ac521eeda0c37a30bfd4dd30b1", "committedDate": "2020-03-16T10:49:37Z", "message": "Merge remote-tracking branch 'upstream/master' into kinesis-lag-metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e529f2c0a8083cfeba9e12321182b7967d89383b", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/e529f2c0a8083cfeba9e12321182b7967d89383b", "committedDate": "2020-03-17T01:17:32Z", "message": "do it right this time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d116d5fee9a16a6bf02744102b8251f0cefbc1a", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/7d116d5fee9a16a6bf02744102b8251f0cefbc1a", "committedDate": "2020-03-17T01:26:40Z", "message": "more test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Njk2ODA5", "url": "https://github.com/apache/druid/pull/9509#pullrequestreview-375696809", "createdAt": "2020-03-17T02:20:25Z", "commit": {"oid": "7d116d5fee9a16a6bf02744102b8251f0cefbc1a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMjoyMDoyNVrOF3LxJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMjozNToxOVrOF3L_Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQwODgwNA==", "bodyText": "The number of partitions can be on the order of hundreds, would it make sense to avoid streams here for performance (I remember various issues in the past around stream perf)", "url": "https://github.com/apache/druid/pull/9509#discussion_r393408804", "createdAt": "2020-03-17T02:20:25Z", "author": {"login": "jon-wei"}, "path": "extensions-core/kinesis-indexing-service/src/main/java/org/apache/druid/indexing/kinesis/KinesisRecordSupplier.java", "diffHunk": "@@ -637,6 +688,25 @@ public void close()\n     this.closed = true;\n   }\n \n+  @VisibleForTesting\n+  public Map<String, Long> getPartitionTimeLag()\n+  {\n+    return partitionResources.entrySet()\n+                             .stream()\n+                             .collect(\n+                                 Collectors.toMap(k -> k.getKey().getPartitionId(), k -> k.getValue().getPartitionTimeLag())\n+                             );\n+  }\n+\n+  public Map<String, Long> getPartitionTimeLag(Map<String, String> currentOffsets)\n+  {\n+    return partitionResources.entrySet()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d116d5fee9a16a6bf02744102b8251f0cefbc1a"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQwOTg5MQ==", "bodyText": "'lag'of -> 'lag' of", "url": "https://github.com/apache/druid/pull/9509#discussion_r393409891", "createdAt": "2020-03-17T02:25:01Z", "author": {"login": "jon-wei"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/seekablestream/supervisor/SeekableStreamSupervisor.java", "diffHunk": "@@ -3158,18 +3167,35 @@ protected abstract void updateLatestSequenceFromStream(\n       Set<StreamPartition<PartitionIdType>> partitions\n   );\n \n+  /**\n+   * Gets 'lag' of currently processed offset behind latest offset as a measure of difference between offsets.\n+   */\n+  @Nullable\n+  protected abstract Map<PartitionIdType, Long> getPartitionRecordLag();\n+\n+  /**\n+   * Gets 'lag'of currently processed offset behind latest offset as a measure of the difference in time inserted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d116d5fee9a16a6bf02744102b8251f0cefbc1a"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxMjM5OQ==", "bodyText": "behing -> behind", "url": "https://github.com/apache/druid/pull/9509#discussion_r393412399", "createdAt": "2020-03-17T02:35:19Z", "author": {"login": "jon-wei"}, "path": "extensions-core/kinesis-indexing-service/src/main/java/org/apache/druid/indexing/kinesis/KinesisRecordSupplier.java", "diffHunk": "@@ -148,6 +149,53 @@ void stopBackgroundFetch()\n       stopRequested = true;\n     }\n \n+    long getPartitionTimeLag()\n+    {\n+      return currentLagMillis;\n+    }\n+\n+    long getPartitionTimeLag(String offset)\n+    {\n+      // if not started (fetching records in background), fetch lag ourself with a throw-away iterator\n+      if (!started) {\n+        try {\n+          final String iteratorType;\n+          final String offsetToUse;\n+          if (offset == null || KinesisSupervisor.NOT_SET.equals(offset)) {\n+            // this should probably check if will start processing earliest or latest rather than assuming earliest\n+            // if latest we could skip this because latest will not be behing latest so lag is 0.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d116d5fee9a16a6bf02744102b8251f0cefbc1a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f25f41da70e98f72fa09e7d273231489f08e7fbd", "author": {"user": {"login": "clintropolis", "name": "Clint Wylie"}}, "url": "https://github.com/apache/druid/commit/f25f41da70e98f72fa09e7d273231489f08e7fbd", "committedDate": "2020-03-17T03:15:36Z", "message": "split out supervisor report lags into lagMillis, remove latest offsets from kinesis supervisor report since always null, review stuffs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzM2MDMx", "url": "https://github.com/apache/druid/pull/9509#pullrequestreview-375736031", "createdAt": "2020-03-17T04:39:05Z", "commit": {"oid": "f25f41da70e98f72fa09e7d273231489f08e7fbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2635, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}