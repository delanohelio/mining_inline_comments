{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMDkxNzQ0", "number": 9530, "title": "DruidSegmentReader should work if timestamp is specified as a dimension", "bodyText": "DruidInputSource does not support a dimension or metric having the name \"timestamp\", however this was supported by the ingestSegment firehose which was deprecated in favor of the Druid InputSource. If you try, you will see an exception like\norg.apache.druid.indexing.common.task.IndexTask - Encountered exception in BUILD_SEGMENTS.  java.lang.ClassCastException: java.lang.String cannot be cast to org.joda.time.DateTime \nThis change makes it so that you can re-index and compact datasources when a column is explicitly called timestamp and adds integration tests for them.\nThis PR has:\n\n been self-reviewed.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-03-17T21:40:29Z", "url": "https://github.com/apache/druid/pull/9530", "merged": true, "mergeCommit": {"oid": "55c08e07461e773309c3070ea3891ea304b343de"}, "closed": true, "closedAt": "2020-03-25T20:47:35Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO-gj1ABqjMxNDMyOTY2ODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRNzKxgFqTM4MTUyMzU5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ccdbac9df0e716672618d8148282e497c8edf3", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/14ccdbac9df0e716672618d8148282e497c8edf3", "committedDate": "2020-03-25T00:02:57Z", "message": "DruidSegmentReader should work if timestamp is specified as a dimension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/1c98f04c86afa8546586316f5a4c376658db40d3", "committedDate": "2020-03-25T00:19:25Z", "message": "Add integration tests\n\nTests for compaction and re-indexing a datasource with the timestamp column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/1c98f04c86afa8546586316f5a4c376658db40d3", "committedDate": "2020-03-25T00:19:25Z", "message": "Add integration tests\n\nTests for compaction and re-indexing a datasource with the timestamp column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0b9f32f316378cd49b88f38b399f224fd1f2de4", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/b0b9f32f316378cd49b88f38b399f224fd1f2de4", "committedDate": "2020-03-25T03:22:36Z", "message": "Instructions to run integration tests against quickstart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDA3NDk3", "url": "https://github.com/apache/druid/pull/9530#pullrequestreview-381407497", "createdAt": "2020-03-25T18:06:18Z", "commit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxODowNjoxOFrOF7n53w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxODoyNjozM1rOF7otIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2NDA5NQ==", "bodyText": "Could you change this to single-line comments? We don't usually use multi-line comment.", "url": "https://github.com/apache/druid/pull/9530#discussion_r398064095", "createdAt": "2020-03-25T18:06:18Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/input/DruidSegmentReader.java", "diffHunk": "@@ -270,6 +273,17 @@ public boolean hasNext()\n           theEvent.put(metric, value);\n         }\n       }\n+\n+      /*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2NjQ1Ng==", "bodyText": "Hmm, I think this overwriting should never happen, but it could happen for some reason in practice, e.g., user mistake. How about logging a warning if there are duplicate column names? Doc could say some kind of warning messages can be printed if there are duplicates.", "url": "https://github.com/apache/druid/pull/9530#discussion_r398066456", "createdAt": "2020-03-25T18:09:59Z", "author": {"login": "jihoonson"}, "path": "indexing-service/src/main/java/org/apache/druid/indexing/input/DruidSegmentReader.java", "diffHunk": "@@ -270,6 +273,17 @@ public boolean hasNext()\n           theEvent.put(metric, value);\n         }\n       }\n+\n+      /*\n+       * Timestamp is added last because we expect that the time column will always be a date time object.\n+       * If it is added earlier, it can be overwritten by metrics or dimenstions with the same name.\n+       *\n+       * If a user names a metric or dimension `__time` it will be overwritten. This case should be rare since", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NzIxOA==", "bodyText": "Would you open an issue for this instead of TODO?", "url": "https://github.com/apache/druid/pull/9530#discussion_r398077218", "createdAt": "2020-03-25T18:26:33Z", "author": {"login": "jihoonson"}, "path": "integration-tests/src/test/java/org/apache/druid/tests/indexer/ITIndexerTest.java", "diffHunk": "@@ -34,16 +34,25 @@\n   private static final String INDEX_QUERIES_RESOURCE = \"/indexer/wikipedia_index_queries.json\";\n   private static final String INDEX_DATASOURCE = \"wikipedia_index_test\";\n \n+  private static final String INDEX_WITH_TIMESTAMP_TASK = \"/indexer/wikipedia_with_timestamp_index_task.json\";\n+  // TODO: add queries that validate timestamp is different from the __time column since it is a dimension", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c98f04c86afa8546586316f5a4c376658db40d3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f71e8fcb5f24d8e14c8a359c077f5c9a95029a93", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/f71e8fcb5f24d8e14c8a359c077f5c9a95029a93", "committedDate": "2020-03-25T19:12:58Z", "message": "address pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDYyMTcx", "url": "https://github.com/apache/druid/pull/9530#pullrequestreview-381462171", "createdAt": "2020-03-25T19:18:18Z", "commit": {"oid": "f71e8fcb5f24d8e14c8a359c077f5c9a95029a93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTIzNTk1", "url": "https://github.com/apache/druid/pull/9530#pullrequestreview-381523595", "createdAt": "2020-03-25T20:47:27Z", "commit": {"oid": "f71e8fcb5f24d8e14c8a359c077f5c9a95029a93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2673, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}