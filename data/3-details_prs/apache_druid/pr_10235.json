{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDcxNjgx", "number": 10235, "title": "Add \"offset\" parameter to GroupBy query.", "bodyText": "It works by doing the query as normal and then throwing away the first\n\"offset\" number of rows on the broker.", "createdAt": "2020-08-04T01:14:29Z", "url": "https://github.com/apache/druid/pull/10235", "merged": true, "mergeCommit": {"oid": "b6aaf59e8cdc4b2965ec9f54d8b824a51baaa594"}, "closed": true, "closedAt": "2020-08-05T22:39:59Z", "author": {"login": "gianm"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7cIaugH2gAyNDYyNDcxNjgxOjhiNDkyMDFkOTVhYmI0NzU3MTQ1ZDI5MzMyMmEyMzAzZjBjZWVlNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-OsHxgFqTQ2NjExNjcxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b49201d95abb4757145d293322a2303f0ceee72", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/8b49201d95abb4757145d293322a2303f0ceee72", "committedDate": "2020-08-04T01:14:09Z", "message": "Add \"offset\" parameter to GroupBy query.\n\nIt works by doing the query as normal and then throwing away the first\n\"offset\" number of rows on the broker."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc5bf2264ea9dd69cbb3dfe4508493415fd597da", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/dc5bf2264ea9dd69cbb3dfe4508493415fd597da", "committedDate": "2020-08-04T02:36:44Z", "message": "Stabilize GroupBy sorts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d801214fec20afd7b7ee685e75b8836b51854d", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/a6d801214fec20afd7b7ee685e75b8836b51854d", "committedDate": "2020-08-04T02:39:35Z", "message": "Fix inspections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e003dc3421bc495e52b0f549686f175192bd81f9", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/e003dc3421bc495e52b0f549686f175192bd81f9", "committedDate": "2020-08-04T02:43:35Z", "message": "Fix suppression."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384cc4567dee6afa228e1a76a5c84e706872f009", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/384cc4567dee6afa228e1a76a5c84e706872f009", "committedDate": "2020-08-04T04:18:32Z", "message": "Fixups."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb2732aca4e9b43637e46c3ded6b46688b64fb86", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/cb2732aca4e9b43637e46c3ded6b46688b64fb86", "committedDate": "2020-08-04T06:45:58Z", "message": "Move TopNSequence to druid-core."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/219cfa8e5f384a0ec39bba5b762a01b084c20546", "committedDate": "2020-08-04T08:16:28Z", "message": "Addl comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e1107975aa794d731588ceaf9282d2b0c57298e", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/3e1107975aa794d731588ceaf9282d2b0c57298e", "committedDate": "2020-08-04T22:11:48Z", "message": "NumberedElement equals verification."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTk1MTA0", "url": "https://github.com/apache/druid/pull/10235#pullrequestreview-461195104", "createdAt": "2020-08-04T21:42:21Z", "commit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MjoyMVrOG7yhAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMjoxODozNlrOG7zcRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NjgxOQ==", "bodyText": "What does 'least first' mean? Is this referring to .thenComparing by the number?", "url": "https://github.com/apache/druid/pull/10235#discussion_r465346819", "createdAt": "2020-08-04T21:42:21Z", "author": {"login": "clintropolis"}, "path": "core/src/main/java/org/apache/druid/collections/StableLimitingSorter.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.collections;\n+\n+import com.google.common.collect.MinMaxPriorityQueue;\n+import com.google.common.collect.Ordering;\n+\n+import java.util.Comparator;\n+import java.util.Iterator;\n+import java.util.Objects;\n+\n+/**\n+ * Simultaneously sorts and limits its input.\n+ *\n+ * The sort is stable, meaning that equal elements (as determined by the comparator) will not be reordered.\n+ *\n+ * Not thread-safe.\n+ *\n+ * Note: this class doesn't have its own unit tests. It is tested along with\n+ * {@link org.apache.druid.java.util.common.guava.TopNSequence} in \"TopNSequenceTest\".\n+ */\n+public class StableLimitingSorter<T>\n+{\n+  private final MinMaxPriorityQueue<NumberedElement<T>> queue;\n+\n+  private long count = 0;\n+\n+  public StableLimitingSorter(final Comparator<T> comparator, final int limit)\n+  {\n+    this.queue = MinMaxPriorityQueue\n+        .orderedBy(\n+            Ordering.from(\n+                Comparator.<NumberedElement<T>, T>comparing(NumberedElement::getElement, comparator)\n+                    .thenComparing(NumberedElement::getNumber)\n+            )\n+        )\n+        .maximumSize(limit)\n+        .create();\n+  }\n+\n+  /**\n+   * Offer an element to the sorter.\n+   */\n+  public void add(T element)\n+  {\n+    queue.offer(new NumberedElement<>(element, count++));\n+  }\n+\n+  /**\n+   * Drain elements in sorted order (least first).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0Nzk4Nw==", "bodyText": "Any idea on numbers that are too large, or is this a try it and find out what your cluster can handle kind of thing?", "url": "https://github.com/apache/druid/pull/10235#discussion_r465347987", "createdAt": "2020-08-04T21:45:01Z", "author": {"login": "clintropolis"}, "path": "docs/querying/limitspec.md", "diffHunk": "@@ -35,11 +35,23 @@ The default limit spec takes a limit and the list of columns to do an orderBy op\n ```json\n {\n     \"type\"    : \"default\",\n-    \"limit\"   : <integer_value>,\n-    \"columns\" : [list of OrderByColumnSpec],\n+    \"limit\"   : <optional integer>,\n+    \"offset\"  : <optional integer>,\n+    \"columns\" : [<optional list of OrderByColumnSpec>],\n }\n ```\n \n+The \"limit\" parameter is the maximum number of rows to return.\n+\n+The \"offset\" parameter tells Druid to skip this many rows when returning results. If both \"limit\" and \"offset\" are\n+provided, then \"offset\" will be applied first, followed by \"limit\". For example, a spec with limit 100 and offset 10\n+will return 100 rows starting from row number 10. Skipped rows will still need to be generated internally and then\n+discarded, meaning that raising offsets to high values can cause queries to use additional resources.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTcyMw==", "bodyText": "Is the plan to update Sorting to store the offset, and computeSorting to set it when creating it from the calcite Sort in a follow-up so that this works in SQL?", "url": "https://github.com/apache/druid/pull/10235#discussion_r465361723", "createdAt": "2020-08-04T22:17:50Z", "author": {"login": "clintropolis"}, "path": "sql/src/main/java/org/apache/druid/sql/calcite/rel/DruidQuery.java", "diffHunk": "@@ -928,6 +928,7 @@ public GroupByQuery toGroupByQuery()\n         sorting != null\n         ? new DefaultLimitSpec(\n             sorting.getOrderBys(),\n+            0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTk5MA==", "bodyText": "Are these changes from the stabilization?", "url": "https://github.com/apache/druid/pull/10235#discussion_r465361990", "createdAt": "2020-08-04T22:18:36Z", "author": {"login": "clintropolis"}, "path": "processing/src/test/java/org/apache/druid/query/groupby/GroupByQueryRunnerTest.java", "diffHunk": "@@ -3700,7 +3702,7 @@ public void testGroupByWithOrderOnHyperUnique()\n             query,\n             \"1970-01-01T00:00:00.000Z\",\n             \"market\",\n-            \"upfront\",\n+            \"total_market\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219cfa8e5f384a0ec39bba5b762a01b084c20546"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeb52ed1e41cda97ac3ae4d79e3dd20987d92749", "author": {"user": {"login": "gianm", "name": "Gian Merlino"}}, "url": "https://github.com/apache/druid/commit/aeb52ed1e41cda97ac3ae4d79e3dd20987d92749", "committedDate": "2020-08-05T19:51:40Z", "message": "Changes from review."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDMxNTcx", "url": "https://github.com/apache/druid/pull/10235#pullrequestreview-462031571", "createdAt": "2020-08-05T21:18:55Z", "commit": {"oid": "aeb52ed1e41cda97ac3ae4d79e3dd20987d92749"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTE2NzE3", "url": "https://github.com/apache/druid/pull/10235#pullrequestreview-466116717", "createdAt": "2020-08-12T17:16:14Z", "commit": {"oid": "aeb52ed1e41cda97ac3ae4d79e3dd20987d92749"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjoxNVrOG_q48A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjoxNVrOG_q48A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNjE3Ng==", "bodyText": "Should this perhaps be 'Limit for this query...' instead of 'Offset for this query...'?", "url": "https://github.com/apache/druid/pull/10235#discussion_r469416176", "createdAt": "2020-08-12T17:16:15Z", "author": {"login": "abhishekrb19"}, "path": "processing/src/main/java/org/apache/druid/query/groupby/orderby/DefaultLimitSpec.java", "diffHunk": "@@ -113,12 +139,32 @@ public DefaultLimitSpec(\n     return columns;\n   }\n \n+  /**\n+   * Offset for this query; behaves like SQL \"OFFSET\". Zero means no offset. Negative values are invalid.\n+   */\n   @JsonProperty\n+  @JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+  public int getOffset()\n+  {\n+    return offset;\n+  }\n+\n+  /**\n+   * Offset for this query; behaves like SQL \"LIMIT\". Will always be positive. {@link Integer#MAX_VALUE} is used in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeb52ed1e41cda97ac3ae4d79e3dd20987d92749"}, "originalPosition": 100}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1910, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}