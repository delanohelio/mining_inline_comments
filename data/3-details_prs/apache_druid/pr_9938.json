{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzOTM5NTAx", "number": 9938, "title": "Add https to druid-influxdb-emitter extension", "bodyText": "Fixes #9895.\n\n\n\n\n\n\n\n\n\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n been tested in a test Druid cluster.", "createdAt": "2020-05-27T15:40:04Z", "url": "https://github.com/apache/druid/pull/9938", "merged": true, "mergeCommit": {"oid": "a966de5319e833409c9513b6616b2d2e192f7adf"}, "closed": true, "closedAt": "2020-10-27T02:49:27Z", "author": {"login": "awelsh93"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclbBpdgH2gAyNDIzOTM5NTAxOmMwMTVmNzZlODc1NTE2ZjFmODNhYTMzYzkwM2UxMzFjYTA4OGI5OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWbMjXgFqTUxNzE4NzM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c015f76e875516f1f83aa33c903e131ca088b991", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/c015f76e875516f1f83aa33c903e131ca088b991", "committedDate": "2020-05-27T15:30:31Z", "message": "Add https to druid-influxdb-emitter extension"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81260f3d171389e7272b65d40c17bca1f25a6f9b", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/81260f3d171389e7272b65d40c17bca1f25a6f9b", "committedDate": "2020-06-09T15:51:22Z", "message": "address CI failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTk4OTYx", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-428998961", "createdAt": "2020-06-11T15:00:11Z", "commit": {"oid": "81260f3d171389e7272b65d40c17bca1f25a6f9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTowMDoxMlrOGihU3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTowMDoxMlrOGihU3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MDc4Mw==", "bodyText": "Looks like CI is complaining about a lack of test coverage. You can add an EqualsVerifier test to fix that", "url": "https://github.com/apache/druid/pull/9938#discussion_r438850783", "createdAt": "2020-06-11T15:00:12Z", "author": {"login": "suneet-s"}, "path": "extensions-contrib/influxdb-emitter/src/main/java/org/apache/druid/emitter/influxdb/InfluxdbEmitterConfig.java", "diffHunk": "@@ -130,6 +159,10 @@ public int hashCode()\n   {\n     int result = getHostname().hashCode();\n     result = 31 * result + getPort();\n+    result = 31 * result + getProtocol().hashCode();\n+    result = 31 * result + (getTrustStorePath() != null ? getTrustStorePath().hashCode() : 0);\n+    result = 31 * result + (getTrustStoreType() != null ? getTrustStoreType().hashCode() : 0);\n+    result = 31 * result + (getTrustStorePassword() != null ? getTrustStorePassword().hashCode() : 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81260f3d171389e7272b65d40c17bca1f25a6f9b"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDE1MTcw", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-438015170", "createdAt": "2020-06-26T05:04:20Z", "commit": {"oid": "81260f3d171389e7272b65d40c17bca1f25a6f9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTowNDoyMVrOGpTyOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTowNDoyMVrOGpTyOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2ODk1NQ==", "bodyText": "Is there any reason not to use\n    return Objects.hash(\nreturn Objects.hash(\n        hostname,\n        port,\n...", "url": "https://github.com/apache/druid/pull/9938#discussion_r445968955", "createdAt": "2020-06-26T05:04:21Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/influxdb-emitter/src/main/java/org/apache/druid/emitter/influxdb/InfluxdbEmitterConfig.java", "diffHunk": "@@ -130,6 +159,10 @@ public int hashCode()\n   {\n     int result = getHostname().hashCode();\n     result = 31 * result + getPort();\n+    result = 31 * result + getProtocol().hashCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81260f3d171389e7272b65d40c17bca1f25a6f9b"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd00a0027adf09fae6f0cb6f7d012d1111f2a2e4", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/bd00a0027adf09fae6f0cb6f7d012d1111f2a2e4", "committedDate": "2020-07-01T19:00:10Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9214edda4ba02db56c4c9e263d68b8566a47b189", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/9214edda4ba02db56c4c9e263d68b8566a47b189", "committedDate": "2020-07-16T15:12:23Z", "message": "increase test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43f1554c851d0b3ee38636937ac18d6242710a26", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/43f1554c851d0b3ee38636937ac18d6242710a26", "committedDate": "2020-07-16T16:34:40Z", "message": "tests for being unable to load trustStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b79350cecbe37a5c93a6872ce764d2190730bea0", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/b79350cecbe37a5c93a6872ce764d2190730bea0", "committedDate": "2020-07-17T15:14:54Z", "message": "fix EqualsVerifier test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc316e6e9b5a37811b46f9a96a1c796711c6fd5", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/3bc316e6e9b5a37811b46f9a96a1c796711c6fd5", "committedDate": "2020-07-20T08:21:54Z", "message": "fix intellij inspection error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjM4NDQx", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-503238441", "createdAt": "2020-10-06T18:18:00Z", "commit": {"oid": "3bc316e6e9b5a37811b46f9a96a1c796711c6fd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjM4OTQ0", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-503238944", "createdAt": "2020-10-06T18:18:34Z", "commit": {"oid": "3bc316e6e9b5a37811b46f9a96a1c796711c6fd5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoxODozNVrOHdUT5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoyMjozOFrOHdUeUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwMzUyNQ==", "bodyText": "It would be better to use try-with-resources. You will not have to handle the IOException thrown in close() by yourself.", "url": "https://github.com/apache/druid/pull/9938#discussion_r500503525", "createdAt": "2020-10-06T18:18:35Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/influxdb-emitter/src/main/java/org/apache/druid/emitter/influxdb/InfluxdbEmitter.java", "diffHunk": "@@ -211,4 +219,46 @@ public void transformAndSendToInfluxdb(LinkedBlockingQueue<ServiceMetricEvent> e\n     postToInflux(payload.toString());\n   }\n \n+  private HttpClient buildInfluxdbClient()\n+  {\n+    if (\"https\".equals(influxdbEmitterConfig.getProtocol())) {\n+      SSLContext sslContext;\n+      if (influxdbEmitterConfig.getTrustStorePath() == null || influxdbEmitterConfig.getTrustStorePassword() == null) {\n+        String msg = \"Can't load TrustStore. Truststore path or password is not set.\";\n+        log.error(msg);\n+        throw new IllegalStateException(msg);\n+      }\n+\n+      FileInputStream in = null;\n+\n+      try {\n+        in = new FileInputStream(new File(influxdbEmitterConfig.getTrustStorePath()));\n+        KeyStore store = KeyStore.getInstance(influxdbEmitterConfig.getTrustStoreType());\n+        store.load(in, influxdbEmitterConfig.getTrustStorePassword().toCharArray());\n+        TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n+        tmf.init(store);\n+        sslContext = SSLContext.getInstance(\"TLS\");\n+        sslContext.init(null, tmf.getTrustManagers(), null);\n+      }\n+      catch (Exception ex) {\n+        String msg = \"Unable to load TrustStore\";\n+        log.error(msg);\n+        throw new IllegalStateException(msg);\n+      }\n+      finally {\n+        if (in != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bc316e6e9b5a37811b46f9a96a1c796711c6fd5"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNjE5Mg==", "bodyText": "I think this should be thrown.", "url": "https://github.com/apache/druid/pull/9938#discussion_r500506192", "createdAt": "2020-10-06T18:22:38Z", "author": {"login": "jihoonson"}, "path": "extensions-contrib/influxdb-emitter/src/main/java/org/apache/druid/emitter/influxdb/InfluxdbEmitter.java", "diffHunk": "@@ -211,4 +219,46 @@ public void transformAndSendToInfluxdb(LinkedBlockingQueue<ServiceMetricEvent> e\n     postToInflux(payload.toString());\n   }\n \n+  private HttpClient buildInfluxdbClient()\n+  {\n+    if (\"https\".equals(influxdbEmitterConfig.getProtocol())) {\n+      SSLContext sslContext;\n+      if (influxdbEmitterConfig.getTrustStorePath() == null || influxdbEmitterConfig.getTrustStorePassword() == null) {\n+        String msg = \"Can't load TrustStore. Truststore path or password is not set.\";\n+        log.error(msg);\n+        throw new IllegalStateException(msg);\n+      }\n+\n+      FileInputStream in = null;\n+\n+      try {\n+        in = new FileInputStream(new File(influxdbEmitterConfig.getTrustStorePath()));\n+        KeyStore store = KeyStore.getInstance(influxdbEmitterConfig.getTrustStoreType());\n+        store.load(in, influxdbEmitterConfig.getTrustStorePassword().toCharArray());\n+        TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n+        tmf.init(store);\n+        sslContext = SSLContext.getInstance(\"TLS\");\n+        sslContext.init(null, tmf.getTrustManagers(), null);\n+      }\n+      catch (Exception ex) {\n+        String msg = \"Unable to load TrustStore\";\n+        log.error(msg);\n+        throw new IllegalStateException(msg);\n+      }\n+      finally {\n+        if (in != null) {\n+          try {\n+            in.close();\n+          }\n+          catch (IOException ex) {\n+            log.error(\"Unable to load TrustStore\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bc316e6e9b5a37811b46f9a96a1c796711c6fd5"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "219e59658d2ff17ed6ed1ae994a47286d0249107", "author": {"user": {"login": "awelsh93", "name": null}}, "url": "https://github.com/apache/druid/commit/219e59658d2ff17ed6ed1ae994a47286d0249107", "committedDate": "2020-10-13T10:40:59Z", "message": "use try-with-resources when loading trustStore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTg3MDk0", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-517187094", "createdAt": "2020-10-26T21:24:12Z", "commit": {"oid": "219e59658d2ff17ed6ed1ae994a47286d0249107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTg3Mzk0", "url": "https://github.com/apache/druid/pull/9938#pullrequestreview-517187394", "createdAt": "2020-10-26T21:24:43Z", "commit": {"oid": "219e59658d2ff17ed6ed1ae994a47286d0249107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2409, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}