{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3Mzk4MzM5", "number": 10340, "title": "Fix VARIANCE aggregator comparator", "bodyText": "Description\nThe comparator for the variance aggregator used to compare values using the\ncount. This is now fixed to compare values using the variance. If the variance\nis equal, the count and sum are used as tie breakers.\nThis patch also fixes a bug where we assumed that the aggregator could not\nreturn null because Druid did not support sql compatible mode. It appears that\nthis extension was written in 2016 before sql Compatible mode was introduced\n~ 2018\nThis PR has:\n\n been self-reviewed.\n added unit tests or modified existing tests to cover new code paths, ensuring the threshold for code coverage is met.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-09-01T23:56:29Z", "url": "https://github.com/apache/druid/pull/10340", "merged": true, "mergeCommit": {"oid": "a5cd5f1e8404157f1f3ff6bda5ad6bb4cbfa1ff6"}, "closed": true, "closedAt": "2020-09-04T00:38:38Z", "author": {"login": "suneet-s"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEwWTOAH2gAyNDc3Mzk4MzM5OjY4ZDY5OTA5NWYzZmE0YTNkZDNlMTUzYzA4MjgyNTAxOTVhYzE1MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFY0HRAH2gAyNDc3Mzk4MzM5OjIxMTUzMWFjMDQ3MTg2ZWY0ZDc1MDkxYjFiY2I4NDk1ZTQ0ZWY0N2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "68d699095f3fa4a3dd3e153c0828250195ac150a", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/68d699095f3fa4a3dd3e153c0828250195ac150a", "committedDate": "2020-09-01T23:52:44Z", "message": "Fix VARIANCE aggregator comparator\n\nThe comparator for the variance aggregator used to compare values using the\ncount. This is now fixed to compare values using the variance. If the variance\nis equal, the count and sum are used as tie breakers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68e50474d047c1510faca2debc7280c77b362d4d", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/68e50474d047c1510faca2debc7280c77b362d4d", "committedDate": "2020-09-02T04:57:24Z", "message": "fix tests + sql compatible mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzMwNTY4", "url": "https://github.com/apache/druid/pull/10340#pullrequestreview-481330568", "createdAt": "2020-09-02T21:59:11Z", "commit": {"oid": "68e50474d047c1510faca2debc7280c77b362d4d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMTo1OToxMVrOHMKbFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMjowMzoxNVrOHMKnZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxNTczMw==", "bodyText": "Hmm, I wonder if this should be NullHandling.defaultDoubleValue().\nWill this just happen if nothing gets read?", "url": "https://github.com/apache/druid/pull/10340#discussion_r482515733", "createdAt": "2020-09-02T21:59:11Z", "author": {"login": "gianm"}, "path": "extensions-core/stats/src/main/java/org/apache/druid/query/aggregation/variance/VarianceAggregatorFactory.java", "diffHunk": "@@ -239,7 +240,9 @@ public Comparator getComparator()\n   @Override\n   public Object finalizeComputation(@Nullable Object object)\n   {\n-    return object == null ? null : ((VarianceAggregatorCollector) object).getVariance(isVariancePop);\n+    return object == null || ((VarianceAggregatorCollector) object).count == 0\n+           ? null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e50474d047c1510faca2debc7280c77b362d4d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUxODg4NQ==", "bodyText": "Will this sort the same way as getVariance(isVariancePop) in finalizeComputation?", "url": "https://github.com/apache/druid/pull/10340#discussion_r482518885", "createdAt": "2020-09-02T22:03:15Z", "author": {"login": "gianm"}, "path": "extensions-core/stats/src/main/java/org/apache/druid/query/aggregation/variance/VarianceAggregatorCollector.java", "diffHunk": "@@ -60,11 +60,11 @@ public static VarianceAggregatorCollector from(ByteBuffer buffer)\n   }\n \n   public static final Comparator<VarianceAggregatorCollector> COMPARATOR = (o1, o2) -> {\n-    int compare = Longs.compare(o1.count, o2.count);\n+    int compare = Doubles.compare(o1.nvariance, o2.nvariance);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e50474d047c1510faca2debc7280c77b362d4d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d7b4b08275e0cc1766e9a5f3d397397beb9341", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/93d7b4b08275e0cc1766e9a5f3d397397beb9341", "committedDate": "2020-09-03T15:26:37Z", "message": "Merge remote-tracking branch 'upstream/master' into variance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f50ff02d9b1db27e0623d60f46dfb8bee6b3947", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/8f50ff02d9b1db27e0623d60f46dfb8bee6b3947", "committedDate": "2020-09-03T15:31:12Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDc4MzM4", "url": "https://github.com/apache/druid/pull/10340#pullrequestreview-482078338", "createdAt": "2020-09-03T18:00:59Z", "commit": {"oid": "8f50ff02d9b1db27e0623d60f46dfb8bee6b3947"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578a83034b28efdbe4d1a0827910b66267e2fa0f", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/578a83034b28efdbe4d1a0827910b66267e2fa0f", "committedDate": "2020-09-03T22:19:28Z", "message": "more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjU0NTMw", "url": "https://github.com/apache/druid/pull/10340#pullrequestreview-482254530", "createdAt": "2020-09-03T22:55:47Z", "commit": {"oid": "578a83034b28efdbe4d1a0827910b66267e2fa0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "211531ac047186ef4d75091b1bcb8495e44ef47a", "author": {"user": {"login": "suneet-s", "name": "Suneet Saldanha"}}, "url": "https://github.com/apache/druid/commit/211531ac047186ef4d75091b1bcb8495e44ef47a", "committedDate": "2020-09-03T23:01:30Z", "message": "fix last test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3538, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}