{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODM0Nzc4", "number": 9891, "title": "Fix deleting a data node tier causes load rules to display incorrectly", "bodyText": "Fix deleting a data node tier causes load rules to display incorrectly\nDescription\nWhen a tier is removed and that tier is currently being used in a rule, the actual rule in the database does not gets modified (rule stay as-is). However, the UI console stops showing the removed tier from the \"Edit retention rules\" page. Hence, the rules that the user is seeing in the UI will be different than what is actually being run by Druid / stored in the database. This can be very misleading as it hides that the rule is in a bad state (Replicants refers to non-existent tier). We should continue to show the tier even if it does not exist. This will make sure that we are consistent and truthful to the source of truth (a.k.a the metadata store). User can also be aware and change as they realized that the tier that the Replicants is currently set to does not exist.\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added Javadocs for most classes and all non-trivial methods. Linked related entities via Javadoc links.\n added or updated version, license, or notice information in licenses.yaml\n added comments explaining the \"why\" and the intent of the code wherever would not be obvious for an unfamiliar reader.\n added unit tests or modified existing tests to cover new code paths.\n added integration tests.\n been tested in a test Druid cluster.", "createdAt": "2020-05-19T02:14:32Z", "url": "https://github.com/apache/druid/pull/9891", "merged": true, "mergeCommit": {"oid": "f470bcd11fbf1be98e364a7acbb20757d91e6e0b"}, "closed": true, "closedAt": "2020-05-20T23:49:29Z", "author": {"login": "maytasm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciqvMUAH2gAyNDE5ODM0Nzc4OmExM2YzMTk5ZGIzNGEwZjc3N2I0MDQ1NzMzODc4YjEyNjUxYjk3MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjQkSggFqTQxNTc1MDUwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a13f3199db34a0f777b4045733878b12651b9734", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/a13f3199db34a0f777b4045733878b12651b9734", "committedDate": "2020-05-19T02:07:04Z", "message": "Fix Deleting a data node tier causes load rules to malfunction & display incorrectly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NjU4MDk0", "url": "https://github.com/apache/druid/pull/9891#pullrequestreview-414658094", "createdAt": "2020-05-19T17:14:36Z", "commit": {"oid": "a13f3199db34a0f777b4045733878b12651b9734"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzoxNDozNlrOGXqdDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzoxNDozNlrOGXqdDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NTk5Nw==", "bodyText": "Can you add a test for this in rule-editor.spec.tsx?", "url": "https://github.com/apache/druid/pull/9891#discussion_r427465997", "createdAt": "2020-05-19T17:14:36Z", "author": {"login": "ccaominh"}, "path": "web-console/src/components/rule-editor/rule-editor.tsx", "diffHunk": "@@ -102,8 +102,11 @@ export const RuleEditor = React.memo(function RuleEditor(props: RuleEditorProps)\n               onChange(RuleUtil.renameTieredReplicants(rule, tier, e.target.value))\n             }\n           >\n+            <option key={tier} value={tier}>\n+              {tier}\n+            </option>\n             {tiers\n-              .filter(t => t === tier || !tieredReplicants[t])\n+              .filter(t => t !== tier && !tieredReplicants[t])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a13f3199db34a0f777b4045733878b12651b9734"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef33d01d8fe13bc250f1c73ecaf45bf8ebe46a4", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/4ef33d01d8fe13bc250f1c73ecaf45bf8ebe46a4", "committedDate": "2020-05-20T03:09:01Z", "message": "add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTI0OTY2", "url": "https://github.com/apache/druid/pull/9891#pullrequestreview-415524966", "createdAt": "2020-05-20T16:43:04Z", "commit": {"oid": "4ef33d01d8fe13bc250f1c73ecaf45bf8ebe46a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNjo0MzowNVrOGYUraw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNjo0MzowNVrOGYUraw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE1NzgwMw==", "bodyText": "CI is flagging the extra indentation for this test\nhttps://travis-ci.org/github/apache/druid/jobs/689087087#L411", "url": "https://github.com/apache/druid/pull/9891#discussion_r428157803", "createdAt": "2020-05-20T16:43:05Z", "author": {"login": "ccaominh"}, "path": "web-console/src/components/rule-editor/rule-editor.spec.tsx", "diffHunk": "@@ -36,4 +36,64 @@ describe('rule editor', () => {\n     const { container } = render(ruleEditor);\n     expect(container.firstChild).toMatchSnapshot();\n   });\n+\n+  it('matches snapshot with non existing tier in rule', () => {\n+    const ruleEditor = (\n+      <RuleEditor\n+        rule={{\n+          type: 'loadByInterval',\n+          period: '2010-01-01/2015-01-01',\n+          tieredReplicants: { nonexist: 2 },\n+        }}\n+        tiers={['test1', 'test2', 'test3']}\n+        onChange={() => {}}\n+        onDelete={() => {}}\n+        moveUp={null}\n+        moveDown={null}\n+      />\n+    );\n+    const { container } = render(ruleEditor);\n+    expect(container.firstChild).toMatchSnapshot();\n+  });\n+\n+  it('matches snapshot with existing tier in rule', () => {\n+    const ruleEditor = (\n+      <RuleEditor\n+        rule={{\n+          type: 'loadByInterval',\n+          period: '2010-01-01/2015-01-01',\n+          tieredReplicants: { test1: 2 },\n+        }}\n+        tiers={['test1', 'test2', 'test3']}\n+        onChange={() => {}}\n+        onDelete={() => {}}\n+        moveUp={null}\n+        moveDown={null}\n+      />\n+    );\n+    const { container } = render(ruleEditor);\n+    expect(container.firstChild).toMatchSnapshot();\n+  });\n+\n+    it('matches snapshot with existing tier and non existing tier in rule', () => {\n+      const ruleEditor = (\n+        <RuleEditor\n+          rule={{\n+            type: 'loadByInterval',\n+            period: '2010-01-01/2015-01-01',\n+            tieredReplicants: {\n+              test1: 2,\n+              nonexist: 1,\n+            },\n+          }}\n+          tiers={['test1', 'test2', 'test3']}\n+          onChange={() => {}}\n+          onDelete={() => {}}\n+          moveUp={null}\n+          moveDown={null}\n+        />\n+      );\n+      const { container } = render(ruleEditor);\n+      expect(container.firstChild).toMatchSnapshot();\n+    });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ef33d01d8fe13bc250f1c73ecaf45bf8ebe46a4"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcad92d74afa23c4e22f67252d3f5ed172e9179d", "author": {"user": {"login": "maytasm", "name": "Maytas Monsereenusorn"}}, "url": "https://github.com/apache/druid/commit/fcad92d74afa23c4e22f67252d3f5ed172e9179d", "committedDate": "2020-05-20T22:09:26Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzUwNTA3", "url": "https://github.com/apache/druid/pull/9891#pullrequestreview-415750507", "createdAt": "2020-05-20T22:11:33Z", "commit": {"oid": "fcad92d74afa23c4e22f67252d3f5ed172e9179d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2365, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}