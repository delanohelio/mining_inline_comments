{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjE3OTQ3", "number": 9372, "title": "Add config option for namespacePrefix", "bodyText": "opentsdb emitter sends metric names to opentsdb verbatim as what druid\nnames them, for example \"query.count\", this doesn't fit well with a\ncentral opentsdb server which might have namespaced metrics, for example\n\"druid.query.count\". This adds support for adding an optional prefix.\nThe prefix also gets a trailing dot (.), after it, so the metric name\nbecomes .\nconfigureable as \"druid.emitter.opentsdb.namespacePrefix\", as\ndocumented.\nCo-authored-by: Martin Gerholm martin.gerholm@deltaprojects.com\nSigned-off-by: Martin Gerholm martin.gerholm@deltaprojects.com\nSigned-off-by: Bj\u00f6rn Zettergren bjorn.zettergren@deltaprojects.com\n\nThis PR has:\n\n been self-reviewed.\n added documentation for new or modified features or behaviors.\n added unit tests or modified existing tests to cover new code paths.", "createdAt": "2020-02-17T16:12:36Z", "url": "https://github.com/apache/druid/pull/9372", "merged": true, "mergeCommit": {"oid": "30c24df4d33197ec4b0d37f0ec36bc2e64dce56f"}, "closed": true, "closedAt": "2020-02-20T22:01:42Z", "author": {"login": "bjozet"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFPm7cAH2gAyMzc2MjE3OTQ3OmMyNGNmNzdmYTE2OGNkOTUzODU1YWY3YjFiNmJiNjVmNTUxNmYxZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGKkC7gH2gAyMzc2MjE3OTQ3OjAxZTgzZmI1ZTM4ZjE5NGIyNTk5Zjk2MDBkYzkwMDgzYmZhYzU3M2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c24cf77fa168cd953855af7b1b6bb65f5516f1d3", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/c24cf77fa168cd953855af7b1b6bb65f5516f1d3", "committedDate": "2020-02-17T16:06:48Z", "message": "Add config option for namespacePrefix\n\nopentsdb emitter sends metric names to opentsdb verbatim as what druid\nnames them, for example \"query.count\", this doesn't fit well with a\ncentral opentsdb server which might have namespaced metrics, for example\n\"druid.query.count\". This adds support for adding an optional prefix.\n\nThe prefix also gets a trailing dot (.), after it, so the metric name\nbecomes <namespacePrefix>.<metricname>\n\nconfigureable as \"druid.emitter.opentsdb.namespacePrefix\", as\ndocumented.\n\nCo-authored-by: Martin Gerholm <martin.gerholm@deltaprojects.com>\nSigned-off-by: Martin Gerholm <martin.gerholm@deltaprojects.com>\nSigned-off-by: Bj\u00f6rn Zettergren <bjorn.zettergren@deltaprojects.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623", "committedDate": "2020-02-18T08:56:23Z", "message": "Spelling for PR #9372\n\nAdded \"namespacePrefix\" to .spelling exceptions, it's a variable name\nused in documentation for opentsdb-emitter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMjI5MDcx", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-360229071", "createdAt": "2020-02-18T10:33:09Z", "commit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMDozMzowOVrOFq9N-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMDozMzowOVrOFq9N-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw==", "bodyText": "Space prefix ? Maybe you should change \"legendary druid\" to \"\" or rename the variable.", "url": "https://github.com/apache/druid/pull/9372#discussion_r380587513", "createdAt": "2020-02-18T10:33:09Z", "author": {"login": "QiuMM"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "diffHunk": "@@ -32,23 +32,29 @@\n \n public class EventConverterTest\n {\n-  private EventConverter converter;\n+  private EventConverter converterWithPrefix;\n+  private EventConverter converterWithSpacePrefix;\n+  private EventConverter converterWithoutPrefix;\n \n   @Before\n   public void setUp()\n   {\n-    converter = new EventConverter(new ObjectMapper(), null);\n+    converterWithPrefix = new EventConverter(new ObjectMapper(), null, \"druid\");\n+    converterWithSpacePrefix = new EventConverter(new ObjectMapper(), null, \"legendary druid\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ef78e1f96b27254d43bd5d1a02dcc6775ad8840", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/7ef78e1f96b27254d43bd5d1a02dcc6775ad8840", "committedDate": "2020-02-18T14:11:03Z", "message": "fixing tests for PR #9372\n\nchanged naming of variables to be more descriptive\nadded test of prefix being an empty string: \"\".\nadded a conditional to buildNamespacePrefix to check for empty string\nbeing fed if EventConverter called without OpentsdbEmitterConfig\ninstance."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/d0527e0185abf40248ff224c03218a9ca9385353", "committedDate": "2020-02-18T22:23:31Z", "message": "fixing checkstyle errors for PR #9372\n\nused == to compare literal string, should be equals()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODM5NTIy", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-360839522", "createdAt": "2020-02-19T04:44:20Z", "commit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNDo0NDoyMFrOFra97w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNDo0OToyN1rOFrbBzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NDkyNw==", "bodyText": "nit: I think this might be a fair bit cleaner to rework this method to take the metric name and do the call to sanitize in here, maybe something like:\nprivate String buildMetric(String metric)\n{\n  final String sanitized = sanitize(metric);\n  if (Strings.isNullOrEmpty(namespacePrefix)) {\n    return sanitized;\n  } else {\n    return StringUtils.format(\"%s.%s\", namespacePrefix, sanitized);\n  }  \n}\n\nthen creating the OpentsdbEvent can just be\n    ...\n    return new OpentsdbEvent(buildMetric(metric), timestamp, value, tags);", "url": "https://github.com/apache/druid/pull/9372#discussion_r381074927", "createdAt": "2020-02-19T04:44:20Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NTkxOA==", "bodyText": "can namespacePrefix actually be empty here (other than the unit tests creating an EventConverter directly) since OpentsdbEmitterConfig looks like it will coerce the value to null in its constructor?", "url": "https://github.com/apache/druid/pull/9372#discussion_r381075918", "createdAt": "2020-02-19T04:49:27Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()\n+  {\n+    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTI3NTky", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-360927592", "createdAt": "2020-02-19T08:46:30Z", "commit": {"oid": "d0527e0185abf40248ff224c03218a9ca9385353"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "committedDate": "2020-02-19T10:25:08Z", "message": "cleaned up and updated PR #9372\n\nCreated a buildMetric function as suggested by clintropolis, and\nremoved redundant tests for empty strings as they're only used when\ncalling EventConverter directly without going through\nOpentsdbEmitterConfig."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTgyMDg1", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-361582085", "createdAt": "2020-02-20T01:37:55Z", "commit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMTozNzo1NlrOFr-NVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMTozNzo1NlrOFr-NVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1MjMxMA==", "bodyText": "I think this can just check namespacePrefix == null now", "url": "https://github.com/apache/druid/pull/9372#discussion_r381652310", "createdAt": "2020-02-20T01:37:56Z", "author": {"login": "clintropolis"}, "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -54,9 +55,14 @@ protected String sanitize(String metric)\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n-  private String buildNamespace()\n+  private String buildMetric(String metric)\n   {\n-    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";\n+    final String sanitized = sanitize(metric);\n+    if (Strings.isNullOrEmpty(namespacePrefix)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjg0MDE3", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-361684017", "createdAt": "2020-02-20T07:38:45Z", "commit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzozODo0NVrOFsI3Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzozODo0NVrOFsI3Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ==", "bodyText": "nit: I think rename testSerDeserOpentsdbEmitterConfigWithSpaceNamespace to testSerDeserOpentsdbEmitterConfigWithNamespaceContainingSpace would be better.", "url": "https://github.com/apache/druid/pull/9372#discussion_r381826855", "createdAt": "2020-02-20T07:38:45Z", "author": {"login": "QiuMM"}, "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "diffHunk": "@@ -39,10 +39,41 @@ public void setUp()\n   @Test\n   public void testSerDeserOpentsdbEmitterConfig() throws Exception\n   {\n-    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null);\n+    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null, \"druid\");\n     String opentsdbEmitterConfigString = mapper.writeValueAsString(opentsdbEmitterConfig);\n     OpentsdbEmitterConfig expectedOpentsdbEmitterConfig = mapper.readerFor(OpentsdbEmitterConfig.class)\n                                                                 .readValue(opentsdbEmitterConfigString);\n     Assert.assertEquals(expectedOpentsdbEmitterConfig, opentsdbEmitterConfig);\n   }\n+\n+  @Test\n+  public void testSerDeserOpentsdbEmitterConfigWithSpaceNamespace() throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjg0NTI2", "url": "https://github.com/apache/druid/pull/9372#pullrequestreview-361684526", "createdAt": "2020-02-20T07:40:03Z", "commit": {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e83fb5e38f194b2599f9600dc90083bfac573f", "author": {"user": {"login": "bjozet", "name": "Bj\u00f6rn Zettergren"}}, "url": "https://github.com/apache/druid/commit/01e83fb5e38f194b2599f9600dc90083bfac573f", "committedDate": "2020-02-20T12:48:03Z", "message": "consistent naming of tests PR #9372\n\nChanged names of tests in files to match better with what it was\nactually testing\n\nchanged check for Strings.isNullOrEmpty to just check for `null`, as\nempty string valued `namespacePrefix` is handled in\nOpentsdbEmitterConfig."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2918, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}