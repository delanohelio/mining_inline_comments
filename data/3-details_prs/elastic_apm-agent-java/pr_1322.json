{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxODM2Nzk0", "number": 1322, "title": "Silencing log4j StatusLogger during initialization", "bodyText": "What does this PR do?\nFixes #1316\nThe result of the described error (and other similar errors) is falling back to the log4j default, which we expect anyway.\n\nChecklist\n\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\n Added an API method or config option? Document in which version this will be introduced\n I have made corresponding changes to the documentation\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n\n\n This is a new plugin\n\n I have updated CHANGELOG.asciidoc\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? Describe how you made sure that old, non-supported versions are not instrumented by accident.\n\n\n This is something else\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-08-02T17:34:58Z", "url": "https://github.com/elastic/apm-agent-java/pull/1322", "merged": true, "mergeCommit": {"oid": "b4f4a68aab2ff9a733d1b8eead76ee8e9b67f6ba"}, "closed": true, "closedAt": "2020-08-04T05:16:54Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7A7TFgH2gAyNDYxODM2Nzk0OjMzYjIxYjdkZDVjMjNlN2U2ODVhNTljN2Q2MDhlNDY1ZTQxYTlkMWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7TTRyAFqTQ2MDA5NzM0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "33b21b7dd5c23e7e685a59c7d608e465e41a9d1f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/33b21b7dd5c23e7e685a59c7d608e465e41a9d1f", "committedDate": "2020-08-02T17:32:23Z", "message": "Silencing log4j StatusLogger during initialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODA1NTI2", "url": "https://github.com/elastic/apm-agent-java/pull/1322#pullrequestreview-459805526", "createdAt": "2020-08-03T07:30:39Z", "commit": {"oid": "33b21b7dd5c23e7e685a59c7d608e465e41a9d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzozMDozOVrOG6u-FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzozMDozOVrOG6u-FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MDE0OA==", "bodyText": "Reset the system properties to their previous state so that we don't affect the application loggers", "url": "https://github.com/elastic/apm-agent-java/pull/1322#discussion_r464240148", "createdAt": "2020-08-03T07:30:39Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -195,7 +197,23 @@ public void assertValid(Boolean value) {\n         .buildWithDefault(LogFormat.PLAIN_TEXT);\n \n     public static void init(List<ConfigurationSource> sources, String ephemeralId) {\n-        Configurator.initialize(new Log4j2ConfigurationFactory(sources, ephemeralId).getConfiguration());\n+        // The initialization of log4j may produce errors if the traced application uses log4j settings (for\n+        // example - through file in the classpath or System properties) that configures specific properties for\n+        // loading classes by name. Since we shade our usage of log4j, such non-shaded classes may not (and should not)\n+        // be found on the classpath.\n+        // All handled Exceptions should not prevent us from using log4j further, as the system falls back to a default\n+        // which we expect anyway. We take a calculated risk of ignoring such errors only through initialization time,\n+        // assuming that errors that will make the logging system non-usable won't be handled.\n+        System.setProperty(\"log4j2.StatusLogger.level\", \"OFF\");\n+        System.setProperty(\"org.apache.logging.log4j.simplelog.StatusLogger.level\", \"OFF\");\n+        System.setProperty(\"Log4jDefaultStatusLevel\", \"OFF\");\n+        try {\n+            Configurator.initialize(new Log4j2ConfigurationFactory(sources, ephemeralId).getConfiguration());\n+        } catch (Throwable throwable) {\n+            System.err.println(\"Failure during initialization of agent's log4j system: \" + throwable.getMessage());\n+        } finally {\n+            StatusLogger.getLogger().setLevel(Level.ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33b21b7dd5c23e7e685a59c7d608e465e41a9d1f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffc94431acf6fb97344697441ca7227017f2eac7", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ffc94431acf6fb97344697441ca7227017f2eac7", "committedDate": "2020-08-03T13:58:39Z", "message": "Apply review suggestion and add to CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f410acdc58a3669a2ef314b15b306e3697241b4a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f410acdc58a3669a2ef314b15b306e3697241b4a", "committedDate": "2020-08-03T13:59:40Z", "message": "Small fix to CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1862381705f00f68c5e762e71aae74c1c0681c0b", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1862381705f00f68c5e762e71aae74c1c0681c0b", "committedDate": "2020-08-03T14:02:45Z", "message": "Fix access error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDk3MzQ1", "url": "https://github.com/elastic/apm-agent-java/pull/1322#pullrequestreview-460097345", "createdAt": "2020-08-03T14:56:52Z", "commit": {"oid": "1862381705f00f68c5e762e71aae74c1c0681c0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3832, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}