{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDcyODU0", "number": 1275, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozNjo1N1rOEMfdTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDowMzozOVrOEMgPBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNTMzNzczOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/context/Destination.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozNjo1N1rOGuoaWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDo0NDoxMFrOGurhRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0OTc4Ng==", "bodyText": "why?", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451549786", "createdAt": "2020-07-08T13:36:57Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/context/Destination.java", "diffHunk": "@@ -143,7 +143,7 @@ public boolean hasContent() {\n     @Override\n     public void resetState() {\n         address.setLength(0);\n-        port = -1;\n+        port = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "881bb149b23c39e31c00b48ed60d6991a2cad441"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMDcxMQ==", "bodyText": "It made a test fail. In general, when calling resetState, the instance should be in the same state as if it had just been instantiated. The field is initialized with the default value of 0.", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451600711", "createdAt": "2020-07-08T14:44:10Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/context/Destination.java", "diffHunk": "@@ -143,7 +143,7 @@ public boolean hasContent() {\n     @Override\n     public void resetState() {\n         address.setLength(0);\n-        port = -1;\n+        port = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0OTc4Ng=="}, "originalCommit": {"oid": "881bb149b23c39e31c00b48ed60d6991a2cad441"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNTQ2NTAxOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-scheduled-annotation-plugin/src/test/java/co/elastic/apm/agent/spring/scheduled/TimerTaskInstrumentationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDowMzozOVrOGuppDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNTowNjoyOFrOGusiWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU2OTkzNQ==", "bodyText": "Test is failing. Maybe revert to happen before the assertion and wait 20ms before asserting.", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451569935", "createdAt": "2020-07-08T14:03:39Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-scheduled-annotation-plugin/src/test/java/co/elastic/apm/agent/spring/scheduled/TimerTaskInstrumentationTest.java", "diffHunk": "@@ -56,14 +55,13 @@ void testTimerTask_scheduleWithFixedRate() throws InterruptedException {\n \n     @Test\n     void testTimerTask_scheduleWithFixedDelay() throws InterruptedException {\n-        reporter.reset();\n         TestTimerTask timerTask = new TestTimerTask();\n         Timer timer = new Timer(\"Timer\");\n         timer.schedule(timerTask, 1L, 10L);\n \n         reporter.awaitUntilAsserted(1000L, () -> {\n-            timer.cancel();\n             assertThat(reporter.getTransactions()).isNotEmpty();\n+            timer.cancel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "881bb149b23c39e31c00b48ed60d6991a2cad441"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxNzM3MA==", "bodyText": "I rewrote the test a little. It should be much more deterministic and resilient now.", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451617370", "createdAt": "2020-07-08T15:06:28Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-scheduled-annotation-plugin/src/test/java/co/elastic/apm/agent/spring/scheduled/TimerTaskInstrumentationTest.java", "diffHunk": "@@ -56,14 +55,13 @@ void testTimerTask_scheduleWithFixedRate() throws InterruptedException {\n \n     @Test\n     void testTimerTask_scheduleWithFixedDelay() throws InterruptedException {\n-        reporter.reset();\n         TestTimerTask timerTask = new TestTimerTask();\n         Timer timer = new Timer(\"Timer\");\n         timer.schedule(timerTask, 1L, 10L);\n \n         reporter.awaitUntilAsserted(1000L, () -> {\n-            timer.cancel();\n             assertThat(reporter.getTransactions()).isNotEmpty();\n+            timer.cancel();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU2OTkzNQ=="}, "originalCommit": {"oid": "881bb149b23c39e31c00b48ed60d6991a2cad441"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 154, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}