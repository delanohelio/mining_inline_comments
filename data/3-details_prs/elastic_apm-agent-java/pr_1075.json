{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNzI1ODAy", "number": 1075, "title": "Disable agent on early Java 8 versions", "bodyText": "What does this PR do?\nEarly Java 8 versions are known to have bugs that are triggered when used with an agent doing instrumentation. Of course, those flaws might not be visible without the agent, thus agent becomes the obvious culprit whereas in practice we can't really work around those.\nAs a result, using our agent with one of those JVMs will likely result in:\n\na crashed JVM\nlikely some angry ops, because killing, even if it's a computer process is a bad thing.\na lot of back & forth with user/customer and support trying to debug a core dump\nunmet expectations: Java 8 is officially supported.\n\nChecklist\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated CHANGELOG.asciidoc\n\nAuthor's Checklist\n\n  run integration tests to make sure none of our docker images is using one of those JVMs\n  test manually on working / not buggy versions", "createdAt": "2020-03-04T17:28:38Z", "url": "https://github.com/elastic/apm-agent-java/pull/1075", "merged": true, "mergeCommit": {"oid": "addd23907633ca58e125ca74cf8c0104139e2377"}, "closed": true, "closedAt": "2020-03-06T09:23:59Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKZ28hAH2gAyMzgzNzI1ODAyOjAxODZkZWVjOTVmYjYyNTc0OTg4ZjFmYTEyMjBjNjkwMDg1MjcxODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKtMLIgFqTM2OTY2MjU4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0186deec95fb62574988f1fa1220c69008527182", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0186deec95fb62574988f1fa1220c69008527182", "committedDate": "2020-03-04T16:52:58Z", "message": "make java 8 before update 40 not supported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9164a80689d09140a102e7dab660450c2cb2c983", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9164a80689d09140a102e7dab660450c2cb2c983", "committedDate": "2020-03-04T17:13:25Z", "message": "update doc for unsupported early java 8 versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68314c96526dd3c4d0c9ed00bcd78d221032fa44", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/68314c96526dd3c4d0c9ed00bcd78d221032fa44", "committedDate": "2020-03-04T17:31:29Z", "message": "add missing licence in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "committedDate": "2020-03-04T17:33:26Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzM3NzEx", "url": "https://github.com/elastic/apm-agent-java/pull/1075#pullrequestreview-369337711", "createdAt": "2020-03-05T07:14:02Z", "commit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzUxNjY2", "url": "https://github.com/elastic/apm-agent-java/pull/1075#pullrequestreview-369351666", "createdAt": "2020-03-05T07:48:37Z", "commit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo0ODozN1rOFyJOLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo0ODozN1rOFyJOLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNDIwNQ==", "bodyText": "One of our Tomcat tests fails due to the version called: 1.8.0_72-internal \ud83d\ude41", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388124205", "createdAt": "2020-03-05T07:48:37Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -90,6 +98,43 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n         }\n     }\n \n+    /**\n+     * Checks if a given version of the JVM is supported by this agent.\n+     * Supports values provided before and after https://openjdk.java.net/jeps/223\n+     *\n+     * @param javaVersion jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @return true if the version is supported, false otherwise\n+     */\n+    // package-protected for testing\n+    static boolean isJavaVersionSupported(String javaVersion) {\n+        boolean postJsr223 = !javaVersion.startsWith(\"1.\");\n+        // new scheme introduced in java 9, thus we can use it as a shortcut\n+        if (postJsr223) {\n+            return true;\n+        }\n+\n+        char major = javaVersion.charAt(2);\n+        if (major < '7') {\n+            // given code is compiled with java 7, this one is unlikely in practice\n+            return false;\n+        } else if (major == '7' || major > '8') {\n+            return true;\n+        } else {\n+            // java 8\n+            int updateIndex = javaVersion.lastIndexOf(\"_\");\n+            if (updateIndex <= 0) {\n+                return false;\n+            } else {\n+                String updateVersion = javaVersion.substring(updateIndex + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzUyNzY3", "url": "https://github.com/elastic/apm-agent-java/pull/1075#pullrequestreview-369352767", "createdAt": "2020-03-05T07:50:59Z", "commit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo1MDo1OVrOFyJRqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo1MDo1OVrOFyJRqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNTA5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        System.err.println(String.format(\"Failed ot start agent - JVM version not supported: %s\", javaVersion));\n          \n          \n            \n                        System.err.println(String.format(\"Failed to start agent - JVM version not supported: %s\", javaVersion));", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388125096", "createdAt": "2020-03-05T07:50:59Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -72,8 +72,16 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n             // for example, Spring Boot restarts the application in dev mode\n             return;\n         }\n+\n+        String javaVersion = System.getProperty(\"java.version\");\n+        if (!isJavaVersionSupported(javaVersion)) {\n+            // gracefully abort agent startup is better than unexpected failure down the road\n+            System.err.println(String.format(\"Failed ot start agent - JVM version not supported: %s\", javaVersion));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "622cc1cc5d7da9046ea85acdff183d5a97784ec9", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/622cc1cc5d7da9046ea85acdff183d5a97784ec9", "committedDate": "2020-03-05T08:14:38Z", "message": "fix versions with '-xxx' suffix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3309ef91ec98c63182c19c1bff22f19d01410144", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3309ef91ec98c63182c19c1bff22f19d01410144", "committedDate": "2020-03-05T09:10:22Z", "message": "improve a few comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07", "committedDate": "2020-03-05T13:23:40Z", "message": "limit checks to hotspot for now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTY1MjUx", "url": "https://github.com/elastic/apm-agent-java/pull/1075#pullrequestreview-369565251", "createdAt": "2020-03-05T13:27:58Z", "commit": {"oid": "bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyNzo1OFrOFyTbdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyNzo1OFrOFyTbdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MTQ0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // java 8\n          \n          \n            \n                        // HotSpot 8", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388291445", "createdAt": "2020-03-05T13:27:58Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -99,43 +105,52 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n     }\n \n     /**\n-     * Checks if a given version of the JVM is supported by this agent.\n-     * Supports values provided before and after https://openjdk.java.net/jeps/223\n+     * Checks if a given version of the JVM is likely supported by this agent.\n+     * <br/>\n+     * Supports values provided before and after https://openjdk.java.net/jeps/223, in case parsing fails due to an\n+     * unknown version format, we assume it's supported, thus this method might return false positives, but never false\n+     * negatives.\n      *\n-     * @param javaVersion jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @param version jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @param vmName  jvm name, from {@code System.getProperty(\"java.vm.name\")}\n      * @return true if the version is supported, false otherwise\n      */\n     // package-protected for testing\n-    static boolean isJavaVersionSupported(String javaVersion) {\n-        boolean postJsr223 = !javaVersion.startsWith(\"1.\");\n+    static boolean isJavaVersionSupported(String version, String vmName) {\n+        boolean postJsr223 = !version.startsWith(\"1.\");\n         // new scheme introduced in java 9, thus we can use it as a shortcut\n         if (postJsr223) {\n             return true;\n         }\n \n-        char major = javaVersion.charAt(2);\n+        char major = version.charAt(2);\n         if (major < '7') {\n             // given code is compiled with java 7, this one is unlikely in practice\n             return false;\n         } else if (major == '7' || major > '8') {\n             return true;\n+        } else if (!vmName.contains(\"HotSpot(TM)\")) {\n+            // non-hotspot JVMs are not concerned (yet)\n+            return true;\n         } else {\n             // java 8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a3a7756bb692dcd290b063b7da1fef65ef00a3a", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/6a3a7756bb692dcd290b063b7da1fef65ef00a3a", "committedDate": "2020-03-05T14:26:29Z", "message": "Update apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e6d891932adaff48eaf4a2ef70f83f0ace064d6", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8e6d891932adaff48eaf4a2ef70f83f0ace064d6", "committedDate": "2020-03-05T14:47:00Z", "message": "add sample error message when jvm not supported"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjYyNTgx", "url": "https://github.com/elastic/apm-agent-java/pull/1075#pullrequestreview-369662581", "createdAt": "2020-03-05T15:24:21Z", "commit": {"oid": "8e6d891932adaff48eaf4a2ef70f83f0ace064d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3872, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}