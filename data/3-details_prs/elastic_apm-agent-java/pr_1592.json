{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1OTMyMDg0", "number": 1592, "title": "CallTree recycling", "bodyText": "What does this PR do?\nInitial attempt to fix a sampling profiler's memory leak reported at the forum.", "createdAt": "2020-12-28T05:34:56Z", "url": "https://github.com/elastic/apm-agent-java/pull/1592", "merged": true, "mergeCommit": {"oid": "1039db0c84f47493f2ce2b755909e4c4212c27fc"}, "closed": true, "closedAt": "2021-01-07T10:23:39Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqfVnHgH2gAyNTQ1OTMyMDg0OjgzZjY1YjEwYzZmODY5NmY2YzNmNzE2MjZhYWY4ODQ4NWRiNjY3NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtwlHwgBqjQxNzg5NDYyNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83f65b10c6f8696f6c3f71626aaf88485db66763", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/83f65b10c6f8696f6c3f71626aaf88485db66763", "committedDate": "2020-12-28T05:32:43Z", "message": "CallTree recycling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef943d6f9cf099d9039b50e67268df9ae667e612", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ef943d6f9cf099d9039b50e67268df9ae667e612", "committedDate": "2020-12-30T16:13:56Z", "message": "Some recycling refactoring and clear memory when tracer pauses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9afc09f23d3d6fde095f45b14b88ab95baaabd8e", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9afc09f23d3d6fde095f45b14b88ab95baaabd8e", "committedDate": "2020-12-31T04:11:17Z", "message": "Check file channel is open before resetting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef08014856e669743d361783d48d665937e84357", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ef08014856e669743d361783d48d665937e84357", "committedDate": "2020-12-31T14:32:23Z", "message": "Creating a memory leak for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdd0ee05bb6a93ed0358251448b14cb48bdcad61", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/bdd0ee05bb6a93ed0358251448b14cb48bdcad61", "committedDate": "2020-12-31T14:33:01Z", "message": "Reverting memory leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "363f2fb19eef4e70065af9a7472fdccf6a0c76c4", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/363f2fb19eef4e70065af9a7472fdccf6a0c76c4", "committedDate": "2020-12-31T16:39:07Z", "message": "Improve memory leak :)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65faf5c9b8dd9f120d0f8e9668a7ae6651eb4fc7", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/65faf5c9b8dd9f120d0f8e9668a7ae6651eb4fc7", "committedDate": "2020-12-31T16:43:45Z", "message": "Fix memory leak :))"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edaff6e7f8cc92d730633e779803388a7b1defc1", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/edaff6e7f8cc92d730633e779803388a7b1defc1", "committedDate": "2020-12-31T16:45:05Z", "message": " Reverting memory leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b37789c08f09384c4d1a584c45a4dbc160bc4271", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b37789c08f09384c4d1a584c45a4dbc160bc4271", "committedDate": "2021-01-06T12:57:32Z", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602776f93b62729ab4ccb48cb24121785c1e1ec3", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/602776f93b62729ab4ccb48cb24121785c1e1ec3", "committedDate": "2021-01-06T12:59:36Z", "message": "Add to CHANGELOG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyODAxODE4", "url": "https://github.com/elastic/apm-agent-java/pull/1592#pullrequestreview-562801818", "createdAt": "2021-01-06T15:30:55Z", "commit": {"oid": "9f9260594ffcae07bbae33deb5ae01b2826d2002"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxNTozMDo1NVrOIPHMoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxNTozNDoxMVrOIPHU7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxNzQ3Mg==", "bodyText": "why not throw directly an IllegalArgumentException when called on a root node instead of an assertion that might be disabled ?", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552717472", "createdAt": "2021-01-06T15:30:55Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/CallTree.java", "diffHunk": "@@ -436,7 +436,16 @@ private void fillStackTrace(List<StackFrame> stackTrace) {\n         }\n     }\n \n-    public void recycle(ObjectPool<CallTree> pool) {\n+    /**\n+     * Recycles this subtree to the provided pool recursively.\n+     * Note that this method ends by recycling {@code this} node (i.e. - this subtree root), which means that\n+     * <b>the caller of this method should make sure that no reference to this object is held anywhere</b>.\n+     * <p>ALSO NOTE: MAKE SURE NOT TO CALL THIS METHOD FOR {@link CallTree.Root} INSTANCES.</p>\n+     *\n+     * @param pool the pool to which all subtree nodes are to be recycled\n+     */\n+    public final void recycle(ObjectPool<CallTree> pool) {\n+        assert !(this instanceof Root);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9260594ffcae07bbae33deb5ae01b2826d2002"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxOTU5OA==", "bodyText": "leftover TODO ?", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552719598", "createdAt": "2021-01-06T15:34:11Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/CallTree.java", "diffHunk": "@@ -735,6 +754,8 @@ public void resetState() {\n             super.resetState();\n             activeSpan = null;\n             activationTimestamp = -1;\n+            // todo - should we reset activeSpanSerialized?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9260594ffcae07bbae33deb5ae01b2826d2002"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f4f643d3712a415e1abc84a6f9e22fac1afff35", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1f4f643d3712a415e1abc84a6f9e22fac1afff35", "committedDate": "2021-01-07T07:28:13Z", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "committedDate": "2021-01-07T07:31:55Z", "message": "Completion of root recycling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f9260594ffcae07bbae33deb5ae01b2826d2002", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9f9260594ffcae07bbae33deb5ae01b2826d2002", "committedDate": "2021-01-06T13:00:12Z", "message": "Merge branch 'master' into call-tree-memory-leak"}, "afterCommit": {"oid": "c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "committedDate": "2021-01-07T07:31:55Z", "message": "Completion of root recycling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzA1OTMz", "url": "https://github.com/elastic/apm-agent-java/pull/1592#pullrequestreview-563305933", "createdAt": "2021-01-07T08:52:56Z", "commit": {"oid": "caba3d6d0f1e809fdb51a4f18ec0116c503a2ad6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a11e6cbfaf32d222e42548c26f3bec8f012998ea", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a11e6cbfaf32d222e42548c26f3bec8f012998ea", "committedDate": "2021-01-07T09:18:54Z", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f5eab6eca6603ef20deb6e5a9718b406fc38777", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8f5eab6eca6603ef20deb6e5a9718b406fc38777", "committedDate": "2021-01-07T09:19:26Z", "message": "Capital letter again"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caba3d6d0f1e809fdb51a4f18ec0116c503a2ad6", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/caba3d6d0f1e809fdb51a4f18ec0116c503a2ad6", "committedDate": "2021-01-07T07:33:40Z", "message": "Capital letter"}, "afterCommit": {"oid": "8f5eab6eca6603ef20deb6e5a9718b406fc38777", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8f5eab6eca6603ef20deb6e5a9718b406fc38777", "committedDate": "2021-01-07T09:19:26Z", "message": "Capital letter again"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3644, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}