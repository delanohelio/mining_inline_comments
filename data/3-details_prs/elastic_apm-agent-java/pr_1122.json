{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MjY2NzMw", "number": 1122, "title": "Fix flaky gRPC server instrumentation", "bodyText": "What does this PR do?\nA test was qualified as flaky, whereas in practice the implementation was the culprit.\ngRPC server instrumentation was relying on the fact that transaction processing stayed on the same thread. However, even if it is the case most of the time, it is not an absolute truth and produces random failures.\nThus, I've reworked gRPC server instrumentation to store in-flight transaction within helper class in-memory storage (a hash-map), in a similar way as it was done for client instrumentation.\nChecklist\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\nI have made corresponding changes to the documentation\nI have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated CHANGELOG.asciidoc\nI have updated supported-technologies.asciidoc\nAdded an API method or config option? Document in which version this will be introduced\nAdded an instrumentation plugin? How did you make sure that old, non-supported versions are not instrumented by accident?\n\nAuthor's Checklist\n\n Run the tests locally continuously for 10min without any failure\n\nRelated issues\n\nCloses #1106", "createdAt": "2020-04-03T16:21:49Z", "url": "https://github.com/elastic/apm-agent-java/pull/1122", "merged": true, "mergeCommit": {"oid": "a0e0abdcbf73b3a1dcc949a92780c9983e55e8ff"}, "closed": true, "closedAt": "2020-04-06T13:16:05Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUDDIPAH2gAyMzk4MjY2NzMwOmVhZTdlNmQwODlkMWIyNzYwZWVlZjhmZjE0NWFmNWU3MjFiMWRmNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU9qeLAH2gAyMzk4MjY2NzMwOmI2NDIwN2U2ODhjNWM1ZDRhYWQ2ZWZkYmEyY2E0MmQ5NzE2NWY3NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eae7e6d089d1b2760eeef8ff145af5e721b1df46", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/eae7e6d089d1b2760eeef8ff145af5e721b1df46", "committedDate": "2020-04-03T15:57:42Z", "message": "minor test improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3beb9912fd5508cb6cb56c47a498ce286e04bf03", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3beb9912fd5508cb6cb56c47a498ce286e04bf03", "committedDate": "2020-04-03T15:57:54Z", "message": "disable circuit breaker for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7d1ad261ebb40129f1769b3baf8710c624a2881", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a7d1ad261ebb40129f1769b3baf8710c624a2881", "committedDate": "2020-04-03T16:03:43Z", "message": "grpc server without rely on same-thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "930d072739ac7f5dc1e9cc9efd6e5a14b84f9fcb", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/930d072739ac7f5dc1e9cc9efd6e5a14b84f9fcb", "committedDate": "2020-04-03T16:14:24Z", "message": "avoid npe when stopping tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79a13499379d3d7fbea74d0a66a60e228fdd26d8", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/79a13499379d3d7fbea74d0a66a60e228fdd26d8", "committedDate": "2020-04-03T16:25:09Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDI0NDc3", "url": "https://github.com/elastic/apm-agent-java/pull/1122#pullrequestreview-387424477", "createdAt": "2020-04-03T16:54:21Z", "commit": {"oid": "79a13499379d3d7fbea74d0a66a60e228fdd26d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzgzMDcz", "url": "https://github.com/elastic/apm-agent-java/pull/1122#pullrequestreview-387783073", "createdAt": "2020-04-05T05:39:01Z", "commit": {"oid": "79a13499379d3d7fbea74d0a66a60e228fdd26d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQwNTozOTowMlrOGA8-wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQwNTozOTowMlrOGA8-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY1MjI4OA==", "bodyText": "The circuit breaker is off by default (except from the servlet container integration tests). It is enabled through a mock at the beginning of each CircuitBreakerTest test (which uses an isolated tracer and config).", "url": "https://github.com/elastic/apm-agent-java/pull/1122#discussion_r403652288", "createdAt": "2020-04-05T05:39:02Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/test/resources/elasticapm.properties", "diffHunk": "@@ -5,3 +5,6 @@ disable_instrumentations=\n # in unit tests, the agent is loaded by the system class loader so we can't instrument bootstrap classes\n classes_excluded_from_instrumentation=java.*,com.sun.*,sun.*\n application_packages=co.elastic.apm\n+\n+# circuit breaker should be disabled by default, otherwise it is triggered while tests execute\n+circuit_breaker_enabled=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79a13499379d3d7fbea74d0a66a60e228fdd26d8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34c9ed866e490a498780def39cebee74423c4aca", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/34c9ed866e490a498780def39cebee74423c4aca", "committedDate": "2020-04-06T12:06:56Z", "message": "remove useless logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b64207e688c5c5d4aad6efdba2ca42d97165f740", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b64207e688c5c5d4aad6efdba2ca42d97165f740", "committedDate": "2020-04-06T12:15:10Z", "message": "circuit breaker is already disabled by default"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3915, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}