{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMTYzODkz", "number": 1326, "title": "Fix service name caching based on context path", "bodyText": "What does this PR do?\nFixes service name caching.\nContext\nA bug reported in https://discuss.elastic.co/t/apm-agent-not-working-after-updating-war-in-tomcat/239750 - after un-deploying and re-deploying a web app on a Servlet container, the web-app-specific service name (based on auto-discovery) is not used anymore. Instead, events are reported with the generic process service name.\nThe problem is with two inconsistent caches of the service name - it is cached in ServletTransactionHelper based on the context path and then in ElasticApmTracer based on the instrumented class's initiating class loader. When redeploying an app, the same context app is used with a different class loader and this causes the problem.\nNOTE: I am not sure the first caching even worth it, only a few String comparisons. Maybe it's enough to leave only the second (class-loader-based) caching in ElasticApmTracer).\n\nChecklist\n\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\n Added an API method or config option? Document in which version this will be introduced\n I have made corresponding changes to the documentation\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n\n\n This is a new plugin\n\n I have updated CHANGELOG.asciidoc\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? Describe how you made sure that old, non-supported versions are not instrumented by accident.\n\n\n This is something else\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-08-05T05:59:27Z", "url": "https://github.com/elastic/apm-agent-java/pull/1326", "merged": true, "mergeCommit": {"oid": "2fcf4b6bc3d7f5e99048f41297718670ef738717"}, "closed": true, "closedAt": "2020-08-06T11:28:44Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc70wf3gH2gAyNDYzMTYzODkzOjFkNzMwNmE4NjRmNDc3M2U5Y2E2NWI4OWVjMjY0NWYyYzQwOWIzN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc74IvtgH2gAyNDYzMTYzODkzOjYyMzZmZGQ3OTQ3NzkxNmYzOTc4N2ZlM2UzODI5NDhmMGVjZjFiNDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d7306a864f4773e9ca65b89ec2645f2c409b37b", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1d7306a864f4773e9ca65b89ec2645f2c409b37b", "committedDate": "2020-08-05T05:55:39Z", "message": "Fix service name caching based on context path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNDgzMzE5", "url": "https://github.com/elastic/apm-agent-java/pull/1326#pullrequestreview-461483319", "createdAt": "2020-08-05T09:13:55Z", "commit": {"oid": "1d7306a864f4773e9ca65b89ec2645f2c409b37b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOToxMzo1NVrOG8BMMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOToxMzo1NVrOG8BMMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4NzI0OQ==", "bodyText": "Just FYT, in #1303, I've create a WeakMapSupplier.createSet() method.", "url": "https://github.com/elastic/apm-agent-java/pull/1326#discussion_r465587249", "createdAt": "2020-08-05T09:13:55Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletGlobalState.java", "diffHunk": "@@ -33,7 +35,7 @@\n @GlobalState\n public class ServletGlobalState {\n \n-    public static final Set<String> nameInitialized = Collections.newSetFromMap(new ConcurrentHashMap<String, Boolean>());\n+    public static final WeakConcurrentMap<ClassLoader, Boolean> nameInitialized = WeakMapSupplier.createMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d7306a864f4773e9ca65b89ec2645f2c409b37b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6236fdd79477916f39787fe3e382948f0ecf1b41", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/6236fdd79477916f39787fe3e382948f0ecf1b41", "committedDate": "2020-08-05T09:51:51Z", "message": "Add to CHANGELOG"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3838, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}