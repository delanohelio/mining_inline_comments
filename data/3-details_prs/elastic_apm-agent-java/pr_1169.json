{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNjQ0MTc3", "number": 1169, "title": "Use log4j2 for logging", "bodyText": "Uses log4j2 instead of slf4j SimpleLogger as the logging framework\nLog files are now rotated after they reach log_file_max_size.\nThere will always be one history file ${log_file}.1.\nAdd log_format_sout and log_format_file with the options PLAIN_TEXT and JSON.\nThe latter uses ecs-logging-java to format the logs.\nAlso includes the log shipper but the ship_agent_logs configuration option is marked as internal and is off by default.", "createdAt": "2020-04-30T15:36:43Z", "url": "https://github.com/elastic/apm-agent-java/pull/1169", "merged": true, "mergeCommit": {"oid": "46b8626b2e0c6d3ac971eee85fc7cabc61a81ae8"}, "closed": true, "closedAt": "2020-05-15T15:49:06Z", "author": {"login": "felixbarny"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU_nKpAH2gAyNDExNjQ0MTc3OjJjMTEwMjcyNTYwNTNmNzllNzhmMWFkMTYzNTUzNWUxNTkzMDllNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchiGsaAH2gAyNDExNjQ0MTc3OjBjNzcxZmQ4MTliY2VhYzJhOTlmYzJiOWEyMDgyNWQyMTdkMDdiMmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c11027256053f79e78f1ad1635535e159309e41", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/2c11027256053f79e78f1ad1635535e159309e41", "committedDate": "2020-04-06T14:31:22Z", "message": "Tail files and notify FileChangeListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ad565608426e923d8c9ed668f59015e10f7ceb1", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/1ad565608426e923d8c9ed668f59015e10f7ceb1", "committedDate": "2020-04-07T12:57:49Z", "message": "ApmServerLogShipper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd348571f0fc902ff7ce0d7bbeb2b33b3ac2a5d", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/ddd348571f0fc902ff7ce0d7bbeb2b33b3ac2a5d", "committedDate": "2020-04-08T12:24:14Z", "message": "Use log4j2 and ecs-logging-java as opposed to simple-logger\n\nTail that log and send to APM Server to the not yet existing\n/intake/v2/logs endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7677cd9c715ca30a6c9165b785c250429d7919ac", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/7677cd9c715ca30a6c9165b785c250429d7919ac", "committedDate": "2020-04-08T12:24:53Z", "message": "Merge remote-tracking branch 'origin/master' into log-shipper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38b20b1372f0cb918ee920a216d578a9e373300d", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/38b20b1372f0cb918ee920a216d578a9e373300d", "committedDate": "2020-04-08T13:04:40Z", "message": "Set service.name and event.dataset in logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8f954ae969dff538648d410a137e79c78758a4", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/9a8f954ae969dff538648d410a137e79c78758a4", "committedDate": "2020-04-09T07:38:55Z", "message": "Store and restore persistent state about file position"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13b8a2516d9bf067e2dfc0965f7eef04468f6d61", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/13b8a2516d9bf067e2dfc0965f7eef04468f6d61", "committedDate": "2020-04-09T14:27:06Z", "message": "Store and restore persistent state about file position"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c23aee7caf4954966b3b0780c64270c06251474a", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/c23aee7caf4954966b3b0780c64270c06251474a", "committedDate": "2020-04-09T14:27:07Z", "message": "Set rollover policy to size 50M max 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60db4435427c6e59ddce114b34df6abd4635ca24", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/60db4435427c6e59ddce114b34df6abd4635ca24", "committedDate": "2020-04-09T14:27:07Z", "message": "Send file metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52013bbdfa3a48ebbe286d98a0ff45b3ba38abc0", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/52013bbdfa3a48ebbe286d98a0ff45b3ba38abc0", "committedDate": "2020-04-11T07:10:32Z", "message": "Ack/nak state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350440e38c1971f80290345d31e6638781c53476", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/350440e38c1971f80290345d31e6638781c53476", "committedDate": "2020-04-17T07:48:02Z", "message": "Look up file by inode if available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15bc635a15187c8e4d895ff115605bc758c6018e", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/15bc635a15187c8e4d895ff115605bc758c6018e", "committedDate": "2020-04-17T07:48:27Z", "message": "Add log_file_max_size option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "225b38971bc00faaa252d82b7f8c421e0dcbc15e", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/225b38971bc00faaa252d82b7f8c421e0dcbc15e", "committedDate": "2020-04-17T15:54:14Z", "message": "No need to set service.name as it's sent in metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeb4aeb78100396fa65a4c971ed345f49b5633dc", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/eeb4aeb78100396fa65a4c971ed345f49b5633dc", "committedDate": "2020-04-20T06:24:21Z", "message": "When logging to sout, ship temp log file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c162ba4b8acb1c66e9ea9d3b748b26c9f031ed", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/b7c162ba4b8acb1c66e9ea9d3b748b26c9f031ed", "committedDate": "2020-04-20T06:24:46Z", "message": "Merge remote-tracking branch 'origin/master' into log-shipper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2549ffc1c5e9dd24188af700423b6ce2bdc2d60", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/a2549ffc1c5e9dd24188af700423b6ce2bdc2d60", "committedDate": "2020-04-22T06:22:49Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61cbbc8ed853b34cdbbc2afa7723c63596065ed4", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/61cbbc8ed853b34cdbbc2afa7723c63596065ed4", "committedDate": "2020-04-23T15:05:40Z", "message": "Use log.file instead of file\n\nSee also https://github.com/elastic/ecs/pull/802"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e4324cd179cbf45462a5bff9e003d6fd02d8c6", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/05e4324cd179cbf45462a5bff9e003d6fd02d8c6", "committedDate": "2020-04-30T14:12:54Z", "message": "Merge remote-tracking branch 'origin/master' into log-shipper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce0f258ab785e9f2774170b1de06a97cc5785f8", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/9ce0f258ab785e9f2774170b1de06a97cc5785f8", "committedDate": "2020-04-30T14:35:22Z", "message": "Add test for log level OFF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/e859dfae312bc49c96743b090bd459923e54c1d7", "committedDate": "2020-04-30T15:33:29Z", "message": "Prepare to make this mergable now\n\n- Default to PLAIN_TEXT for log_format_file\n- Make `ship_agent_logs` internal and `false` by default\n- Remove System.err logging in ApmServerLogShipper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTc5OTUw", "url": "https://github.com/elastic/apm-agent-java/pull/1169#pullrequestreview-405579950", "createdAt": "2020-05-05T08:19:16Z", "commit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "state": "COMMENTED", "comments": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODoxOToxNlrOGQfCrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDowNzo1OVrOGQiuAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODk4OQ==", "bodyText": "Naming: sout could probably be replaced by console, or even remove the -sout suffix for the standard output.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419938989", "createdAt": "2020-05-05T08:19:16Z", "author": {"login": "SylvainJuge"}, "path": "CHANGELOG.asciidoc", "diffHunk": "@@ -34,7 +34,12 @@ This is not a breaking change, so former\n <<config-disable-instrumentations,`disable_instrumentation`>> configuration containing the `incubating` tag will still be respected - {pull}1123[#1123]\n * Add a `--without-emulated-attach` option for runtime attachment to allow disabling this feature as a workaround.\n * Add workaround for JDK bug JDK-8236039 with TLS 1.3 {pull}1149[#1149]\n-* Add log level `OFF` to silence agent logging\n+* Logging\n+** Add log level `OFF` to silence agent logging\n+** Log files are now rotated after they reach <<config-log-file-max-size>>.\n+  There will always be one history file `${log_file}.1`.\n+** Add <<config-log-format-sout>> and <<config-log-format-file>> with the options `PLAIN_TEXT` and `JSON`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzOTc2MA==", "bodyText": "why does this one does not have the same shadedPattern as others ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419939760", "createdAt": "2020-05-05T08:20:43Z", "author": {"login": "SylvainJuge"}, "path": "elastic-apm-agent/pom.xml", "diffHunk": "@@ -307,6 +318,20 @@\n                                     <pattern>org.slf4j</pattern>\n                                     <shadedPattern>co.elastic.apm.agent.shaded.slf4j</shadedPattern>\n                                 </relocation>\n+                                <relocation>\n+                                    <pattern>co.elastic.logging</pattern>\n+                                    <shadedPattern>co.elastic.apm.agent.shaded.logging</shadedPattern>\n+                                </relocation>\n+                                <relocation>\n+                                    <pattern>org.apache.logging</pattern>\n+                                    <shadedPattern>co.elastic.apm.agent.shaded.apache.logging</shadedPattern>\n+                                </relocation>\n+\n+                                <relocation>\n+                                    <pattern>log4j2</pattern>\n+                                    <shadedPattern>apmlog4j2</shadedPattern>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0MDY0Nw==", "bodyText": "why do we have to exclude this file ? Does it makes log4j not trying to load plugins from classpath or any other type of lookup ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419940647", "createdAt": "2020-05-05T08:22:21Z", "author": {"login": "SylvainJuge"}, "path": "elastic-apm-agent/pom.xml", "diffHunk": "@@ -278,6 +283,12 @@\n                                         <exclude>**/module-info.class</exclude>\n                                     </excludes>\n                                 </filter>\n+                                <filter>\n+                                    <artifact>*:*</artifact>\n+                                    <excludes>\n+                                        <exclude>**/Log4j2Plugins.dat</exclude>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0NzE5Mw==", "bodyText": "does it allows to make log4j plugin management work with relocation ? If yes, it might be a good idea to add a comment to make it a bit more explicit.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419947193", "createdAt": "2020-05-05T08:34:28Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0OTc4MQ==", "bodyText": "probably better to use mkdirs() instead to create parent folders if required.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419949781", "createdAt": "2020-05-05T08:39:07Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());\n+        PluginManager.addPackage(LoggerContext.class.getPackage().getName());\n+    }\n+\n+    private final List<org.stagemonitor.configuration.source.ConfigurationSource> sources;\n+    private final String ephemeralId;\n+\n+    public Log4j2ConfigurationFactory(List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String ephemeralId) {\n+        this.sources = sources;\n+        this.ephemeralId = ephemeralId;\n+    }\n+\n+    /**\n+     * The ConfigurationRegistry uses and thereby initializes a logger,\n+     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n+     */\n+    private static String getValue(String key, List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String defaultValue) {\n+        for (org.stagemonitor.configuration.source.ConfigurationSource source : sources) {\n+            final String value = source.getValue(key);\n+            if (value != null) {\n+                return value;\n+            }\n+        }\n+        return defaultValue;\n+    }\n+\n+    @Nonnull\n+    static String getActualLogFile(@Nullable String agentHome, String logFile) {\n+        if (logFile.equalsIgnoreCase(SYSTEM_OUT)) {\n+            return SYSTEM_OUT;\n+        }\n+        if (logFile.contains(AGENT_HOME_PLACEHOLDER)) {\n+            if (agentHome == null) {\n+                System.err.println(\"Could not resolve \" + AGENT_HOME_PLACEHOLDER + \". Falling back to System.out.\");\n+                return SYSTEM_OUT;\n+            } else {\n+                logFile = logFile.replace(AGENT_HOME_PLACEHOLDER, agentHome);\n+            }\n+        }\n+        logFile = new File(logFile).getAbsolutePath();\n+        final File logDir = new File(logFile).getParentFile();\n+        if (!logDir.exists()) {\n+            logDir.mkdir();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1MTIxMw==", "bodyText": "for those error/warn messages in system out, we should probably have a prefix + severity level to make it obvious to the user that it comes from Elastic agent. Something like [elastic-apm-agent] WARN.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419951213", "createdAt": "2020-05-05T08:41:38Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());\n+        PluginManager.addPackage(LoggerContext.class.getPackage().getName());\n+    }\n+\n+    private final List<org.stagemonitor.configuration.source.ConfigurationSource> sources;\n+    private final String ephemeralId;\n+\n+    public Log4j2ConfigurationFactory(List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String ephemeralId) {\n+        this.sources = sources;\n+        this.ephemeralId = ephemeralId;\n+    }\n+\n+    /**\n+     * The ConfigurationRegistry uses and thereby initializes a logger,\n+     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n+     */\n+    private static String getValue(String key, List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String defaultValue) {\n+        for (org.stagemonitor.configuration.source.ConfigurationSource source : sources) {\n+            final String value = source.getValue(key);\n+            if (value != null) {\n+                return value;\n+            }\n+        }\n+        return defaultValue;\n+    }\n+\n+    @Nonnull\n+    static String getActualLogFile(@Nullable String agentHome, String logFile) {\n+        if (logFile.equalsIgnoreCase(SYSTEM_OUT)) {\n+            return SYSTEM_OUT;\n+        }\n+        if (logFile.contains(AGENT_HOME_PLACEHOLDER)) {\n+            if (agentHome == null) {\n+                System.err.println(\"Could not resolve \" + AGENT_HOME_PLACEHOLDER + \". Falling back to System.out.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1MzYwNQ==", "bodyText": "Probably better to use OS compliant path separator instead of a raw / character.\nAlso, do we need to make path to this file configurable ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419953605", "createdAt": "2020-05-05T08:45:47Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());\n+        PluginManager.addPackage(LoggerContext.class.getPackage().getName());\n+    }\n+\n+    private final List<org.stagemonitor.configuration.source.ConfigurationSource> sources;\n+    private final String ephemeralId;\n+\n+    public Log4j2ConfigurationFactory(List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String ephemeralId) {\n+        this.sources = sources;\n+        this.ephemeralId = ephemeralId;\n+    }\n+\n+    /**\n+     * The ConfigurationRegistry uses and thereby initializes a logger,\n+     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n+     */\n+    private static String getValue(String key, List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String defaultValue) {\n+        for (org.stagemonitor.configuration.source.ConfigurationSource source : sources) {\n+            final String value = source.getValue(key);\n+            if (value != null) {\n+                return value;\n+            }\n+        }\n+        return defaultValue;\n+    }\n+\n+    @Nonnull\n+    static String getActualLogFile(@Nullable String agentHome, String logFile) {\n+        if (logFile.equalsIgnoreCase(SYSTEM_OUT)) {\n+            return SYSTEM_OUT;\n+        }\n+        if (logFile.contains(AGENT_HOME_PLACEHOLDER)) {\n+            if (agentHome == null) {\n+                System.err.println(\"Could not resolve \" + AGENT_HOME_PLACEHOLDER + \". Falling back to System.out.\");\n+                return SYSTEM_OUT;\n+            } else {\n+                logFile = logFile.replace(AGENT_HOME_PLACEHOLDER, agentHome);\n+            }\n+        }\n+        logFile = new File(logFile).getAbsolutePath();\n+        final File logDir = new File(logFile).getParentFile();\n+        if (!logDir.exists()) {\n+            logDir.mkdir();\n+        }\n+        if (!logDir.canWrite()) {\n+            System.err.println(\"Log file \" + logFile + \" is not writable. Falling back to System.out.\");\n+            return SYSTEM_OUT;\n+        }\n+        return logFile;\n+    }\n+\n+    @Override\n+    protected String[] getSupportedTypes() {\n+        return null;\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, String name, URI configLocation) {\n+        return getConfiguration();\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, ConfigurationSource source) {\n+        return getConfiguration();\n+    }\n+\n+    public Configuration getConfiguration() {\n+        ConfigurationBuilder<BuiltConfiguration> builder = newConfigurationBuilder();\n+        builder.setStatusLevel(Level.ERROR)\n+            .setConfigurationName(\"ElasticAPM\");\n+\n+        Level level = Level.valueOf(getValue(LOG_LEVEL_KEY, sources, getValue(DEPRECATED_LOG_LEVEL_KEY, sources, Level.INFO.toString())));\n+        RootLoggerComponentBuilder rootLogger = builder.newRootLogger(level);\n+        List<AppenderComponentBuilder> appenders = createAppenders(builder);\n+        for (AppenderComponentBuilder appender : appenders) {\n+            rootLogger.add(builder.newAppenderRef(appender.getName()));\n+        }\n+        builder.add(rootLogger);\n+        return builder.build();\n+    }\n+\n+    private List<AppenderComponentBuilder> createAppenders(ConfigurationBuilder<BuiltConfiguration> builder) {\n+        List<AppenderComponentBuilder> appenders = new ArrayList<>();\n+        String logFile = getActualLogFile(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources, getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n+        if (logFile.equals(SYSTEM_OUT)) {\n+            appenders.add(createConsoleAppender(builder));\n+            if (Boolean.parseBoolean(getValue(SHIP_AGENT_LOGS, sources, Boolean.TRUE.toString()))) {\n+                File tempLog = getTempLogFile(ephemeralId);\n+                tempLog.deleteOnExit();\n+                File rotatedTempLog = new File(tempLog + \".1\");\n+                rotatedTempLog.deleteOnExit();\n+                appenders.add(createFileAppender(builder, tempLog.getAbsolutePath(), createLayout(builder, LogFormat.JSON)));\n+            }\n+        } else {\n+            appenders.add(createFileAppender(builder, logFile, createLayout(builder, getFileLogFormat())));\n+        }\n+        for (AppenderComponentBuilder appender : appenders) {\n+            builder.add(appender);\n+        }\n+        return appenders;\n+    }\n+\n+    public static File getTempLogFile(String ephemeralId) {\n+        return new File(System.getProperty(\"java.io.tmpdir\") + \"/elasticapm-java-\" + ephemeralId + \".log.json\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1NjQzNw==", "bodyText": "why do we have to create two File instances in the case of shipping logs ? Feels like only one is needed and should be created directly with the .1 suffix.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419956437", "createdAt": "2020-05-05T08:50:52Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());\n+        PluginManager.addPackage(LoggerContext.class.getPackage().getName());\n+    }\n+\n+    private final List<org.stagemonitor.configuration.source.ConfigurationSource> sources;\n+    private final String ephemeralId;\n+\n+    public Log4j2ConfigurationFactory(List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String ephemeralId) {\n+        this.sources = sources;\n+        this.ephemeralId = ephemeralId;\n+    }\n+\n+    /**\n+     * The ConfigurationRegistry uses and thereby initializes a logger,\n+     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n+     */\n+    private static String getValue(String key, List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String defaultValue) {\n+        for (org.stagemonitor.configuration.source.ConfigurationSource source : sources) {\n+            final String value = source.getValue(key);\n+            if (value != null) {\n+                return value;\n+            }\n+        }\n+        return defaultValue;\n+    }\n+\n+    @Nonnull\n+    static String getActualLogFile(@Nullable String agentHome, String logFile) {\n+        if (logFile.equalsIgnoreCase(SYSTEM_OUT)) {\n+            return SYSTEM_OUT;\n+        }\n+        if (logFile.contains(AGENT_HOME_PLACEHOLDER)) {\n+            if (agentHome == null) {\n+                System.err.println(\"Could not resolve \" + AGENT_HOME_PLACEHOLDER + \". Falling back to System.out.\");\n+                return SYSTEM_OUT;\n+            } else {\n+                logFile = logFile.replace(AGENT_HOME_PLACEHOLDER, agentHome);\n+            }\n+        }\n+        logFile = new File(logFile).getAbsolutePath();\n+        final File logDir = new File(logFile).getParentFile();\n+        if (!logDir.exists()) {\n+            logDir.mkdir();\n+        }\n+        if (!logDir.canWrite()) {\n+            System.err.println(\"Log file \" + logFile + \" is not writable. Falling back to System.out.\");\n+            return SYSTEM_OUT;\n+        }\n+        return logFile;\n+    }\n+\n+    @Override\n+    protected String[] getSupportedTypes() {\n+        return null;\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, String name, URI configLocation) {\n+        return getConfiguration();\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, ConfigurationSource source) {\n+        return getConfiguration();\n+    }\n+\n+    public Configuration getConfiguration() {\n+        ConfigurationBuilder<BuiltConfiguration> builder = newConfigurationBuilder();\n+        builder.setStatusLevel(Level.ERROR)\n+            .setConfigurationName(\"ElasticAPM\");\n+\n+        Level level = Level.valueOf(getValue(LOG_LEVEL_KEY, sources, getValue(DEPRECATED_LOG_LEVEL_KEY, sources, Level.INFO.toString())));\n+        RootLoggerComponentBuilder rootLogger = builder.newRootLogger(level);\n+        List<AppenderComponentBuilder> appenders = createAppenders(builder);\n+        for (AppenderComponentBuilder appender : appenders) {\n+            rootLogger.add(builder.newAppenderRef(appender.getName()));\n+        }\n+        builder.add(rootLogger);\n+        return builder.build();\n+    }\n+\n+    private List<AppenderComponentBuilder> createAppenders(ConfigurationBuilder<BuiltConfiguration> builder) {\n+        List<AppenderComponentBuilder> appenders = new ArrayList<>();\n+        String logFile = getActualLogFile(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources, getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n+        if (logFile.equals(SYSTEM_OUT)) {\n+            appenders.add(createConsoleAppender(builder));\n+            if (Boolean.parseBoolean(getValue(SHIP_AGENT_LOGS, sources, Boolean.TRUE.toString()))) {\n+                File tempLog = getTempLogFile(ephemeralId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1NzI3NQ==", "bodyText": "probably rename to console here also for consistency", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419957275", "createdAt": "2020-05-05T08:52:20Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/Log4j2ConfigurationFactory.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.configuration.ServiceNameUtil;\n+import co.elastic.apm.agent.configuration.converter.ByteValue;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.ConsoleAppender;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.ConfigurationFactory;\n+import org.apache.logging.log4j.core.config.ConfigurationSource;\n+import org.apache.logging.log4j.core.config.builder.api.AppenderComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.LayoutComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.api.RootLoggerComponentBuilder;\n+import org.apache.logging.log4j.core.config.builder.impl.BuiltConfiguration;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.stagemonitor.configuration.ConfigurationOption;\n+import org.stagemonitor.configuration.converter.EnumValueConverter;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.AGENT_HOME_PLACEHOLDER;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEFAULT_LOG_FILE;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.DEPRECATED_LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_FILE_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_FORMAT_SOUT_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.LOG_LEVEL_KEY;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SHIP_AGENT_LOGS;\n+import static co.elastic.apm.agent.logging.LoggingConfiguration.SYSTEM_OUT;\n+\n+public class Log4j2ConfigurationFactory extends ConfigurationFactory {\n+\n+    static {\n+        PluginManager.addPackage(EcsLayout.class.getPackage().getName());\n+        PluginManager.addPackage(LoggerContext.class.getPackage().getName());\n+    }\n+\n+    private final List<org.stagemonitor.configuration.source.ConfigurationSource> sources;\n+    private final String ephemeralId;\n+\n+    public Log4j2ConfigurationFactory(List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String ephemeralId) {\n+        this.sources = sources;\n+        this.ephemeralId = ephemeralId;\n+    }\n+\n+    /**\n+     * The ConfigurationRegistry uses and thereby initializes a logger,\n+     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n+     */\n+    private static String getValue(String key, List<org.stagemonitor.configuration.source.ConfigurationSource> sources, String defaultValue) {\n+        for (org.stagemonitor.configuration.source.ConfigurationSource source : sources) {\n+            final String value = source.getValue(key);\n+            if (value != null) {\n+                return value;\n+            }\n+        }\n+        return defaultValue;\n+    }\n+\n+    @Nonnull\n+    static String getActualLogFile(@Nullable String agentHome, String logFile) {\n+        if (logFile.equalsIgnoreCase(SYSTEM_OUT)) {\n+            return SYSTEM_OUT;\n+        }\n+        if (logFile.contains(AGENT_HOME_PLACEHOLDER)) {\n+            if (agentHome == null) {\n+                System.err.println(\"Could not resolve \" + AGENT_HOME_PLACEHOLDER + \". Falling back to System.out.\");\n+                return SYSTEM_OUT;\n+            } else {\n+                logFile = logFile.replace(AGENT_HOME_PLACEHOLDER, agentHome);\n+            }\n+        }\n+        logFile = new File(logFile).getAbsolutePath();\n+        final File logDir = new File(logFile).getParentFile();\n+        if (!logDir.exists()) {\n+            logDir.mkdir();\n+        }\n+        if (!logDir.canWrite()) {\n+            System.err.println(\"Log file \" + logFile + \" is not writable. Falling back to System.out.\");\n+            return SYSTEM_OUT;\n+        }\n+        return logFile;\n+    }\n+\n+    @Override\n+    protected String[] getSupportedTypes() {\n+        return null;\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, String name, URI configLocation) {\n+        return getConfiguration();\n+    }\n+\n+    @Override\n+    public Configuration getConfiguration(LoggerContext loggerContext, ConfigurationSource source) {\n+        return getConfiguration();\n+    }\n+\n+    public Configuration getConfiguration() {\n+        ConfigurationBuilder<BuiltConfiguration> builder = newConfigurationBuilder();\n+        builder.setStatusLevel(Level.ERROR)\n+            .setConfigurationName(\"ElasticAPM\");\n+\n+        Level level = Level.valueOf(getValue(LOG_LEVEL_KEY, sources, getValue(DEPRECATED_LOG_LEVEL_KEY, sources, Level.INFO.toString())));\n+        RootLoggerComponentBuilder rootLogger = builder.newRootLogger(level);\n+        List<AppenderComponentBuilder> appenders = createAppenders(builder);\n+        for (AppenderComponentBuilder appender : appenders) {\n+            rootLogger.add(builder.newAppenderRef(appender.getName()));\n+        }\n+        builder.add(rootLogger);\n+        return builder.build();\n+    }\n+\n+    private List<AppenderComponentBuilder> createAppenders(ConfigurationBuilder<BuiltConfiguration> builder) {\n+        List<AppenderComponentBuilder> appenders = new ArrayList<>();\n+        String logFile = getActualLogFile(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources, getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n+        if (logFile.equals(SYSTEM_OUT)) {\n+            appenders.add(createConsoleAppender(builder));\n+            if (Boolean.parseBoolean(getValue(SHIP_AGENT_LOGS, sources, Boolean.TRUE.toString()))) {\n+                File tempLog = getTempLogFile(ephemeralId);\n+                tempLog.deleteOnExit();\n+                File rotatedTempLog = new File(tempLog + \".1\");\n+                rotatedTempLog.deleteOnExit();\n+                appenders.add(createFileAppender(builder, tempLog.getAbsolutePath(), createLayout(builder, LogFormat.JSON)));\n+            }\n+        } else {\n+            appenders.add(createFileAppender(builder, logFile, createLayout(builder, getFileLogFormat())));\n+        }\n+        for (AppenderComponentBuilder appender : appenders) {\n+            builder.add(appender);\n+        }\n+        return appenders;\n+    }\n+\n+    public static File getTempLogFile(String ephemeralId) {\n+        return new File(System.getProperty(\"java.io.tmpdir\") + \"/elasticapm-java-\" + ephemeralId + \".log.json\");\n+    }\n+\n+    private AppenderComponentBuilder createConsoleAppender(ConfigurationBuilder<BuiltConfiguration> builder) {\n+        return builder.newAppender(\"Stdout\", \"CONSOLE\")\n+            .addAttribute(\"target\", ConsoleAppender.Target.SYSTEM_OUT)\n+            .add(createLayout(builder, getSoutLogFormat()));\n+    }\n+\n+    private LayoutComponentBuilder createLayout(ConfigurationBuilder<BuiltConfiguration> builder, LogFormat logFormat) {\n+        if (logFormat == LogFormat.PLAIN_TEXT) {\n+            return builder\n+                    .newLayout(\"PatternLayout\")\n+                    .addAttribute(\"pattern\", \"%d [%thread] %-5level %logger{36} - %msg%n\");\n+        } else {\n+            String serviceName = getValue(CoreConfiguration.SERVICE_NAME, sources, ServiceNameUtil.getDefaultServiceName());\n+            return builder.newLayout(\"EcsLayout\")\n+                .addAttribute(\"eventDataset\", serviceName + \".apm\");\n+        }\n+    }\n+\n+    private LogFormat getSoutLogFormat() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1ODg4NQ==", "bodyText": "why is it unused ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419958885", "createdAt": "2020-05-05T08:55:16Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -117,67 +122,94 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n-    public static void init(List<ConfigurationSource> sources) {\n-        setLogLevel(getValue(LOG_LEVEL_KEY, sources,\n-            getValue(DEPRECATED_LOG_LEVEL_KEY, sources, LogLevel.INFO.toString())));\n-        setLogFileLocation(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources,\n-            getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n-    }\n+    @SuppressWarnings(\"unused\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2MzY5MQ==", "bodyText": "there is some commented code, probably leftovers.\nAlso, not really sure about the wording, something like agent keeps one history file, thus the amount of storage used by agent logs will be equal to twice this value.\nI feel that we could make this less confusing by using a value that is half of the configured value.\nIMHO it provides the following advantages:\n\nusers expect a limit to be enforced, and using twice the configured value would be seen as a defect, even if it's documented\nit's unlikely that anyone will complain about the agent using less storage than expected, nobody wants a full hard drive\nwe could still document that this limit is shared between the two copies of the log file when using log shipping feature.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419963691", "createdAt": "2020-05-05T09:03:26Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -117,67 +122,94 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n-    public static void init(List<ConfigurationSource> sources) {\n-        setLogLevel(getValue(LOG_LEVEL_KEY, sources,\n-            getValue(DEPRECATED_LOG_LEVEL_KEY, sources, LogLevel.INFO.toString())));\n-        setLogFileLocation(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources,\n-            getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n-    }\n+    @SuppressWarnings(\"unused\")\n+    public ConfigurationOption<ByteValue> logFileMaxSize = ByteValueConverter.byteOption()\n+        .key(LOG_FILE_MAX_SIZE_KEY)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"The max size of the log file.\\n\" +\n+            \"\\n\" +\n+            //\"To support <<config-ship-agent-logs,shipping the logs>> to APM Server,\\n\" +\n+            \"The agent always keeps one history file so that the max total log file size is twice the value of this setting.\\n\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2NDQ0Mw==", "bodyText": "commented code", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419964443", "createdAt": "2020-05-05T09:04:53Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -117,67 +122,94 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n-    public static void init(List<ConfigurationSource> sources) {\n-        setLogLevel(getValue(LOG_LEVEL_KEY, sources,\n-            getValue(DEPRECATED_LOG_LEVEL_KEY, sources, LogLevel.INFO.toString())));\n-        setLogFileLocation(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources,\n-            getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n-    }\n+    @SuppressWarnings(\"unused\")\n+    public ConfigurationOption<ByteValue> logFileMaxSize = ByteValueConverter.byteOption()\n+        .key(LOG_FILE_MAX_SIZE_KEY)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"The max size of the log file.\\n\" +\n+            \"\\n\" +\n+            //\"To support <<config-ship-agent-logs,shipping the logs>> to APM Server,\\n\" +\n+            \"The agent always keeps one history file so that the max total log file size is twice the value of this setting.\\n\")\n+        .dynamic(false)\n+        .tags(\"added[1.16.0]\")\n+        .buildWithDefault(ByteValue.of(DEFAULT_MAX_SIZE));\n \n-    /**\n-     * The ConfigurationRegistry uses and thereby initializes a logger,\n-     * so we can't use it here initialize the {@link ConfigurationOption}s in this class.\n-     */\n-    private static String getValue(String key, List<ConfigurationSource> sources, String defaultValue) {\n-        for (ConfigurationSource source : sources) {\n-            final String value = source.getValue(key);\n-            if (value != null) {\n-                return value;\n-            }\n-        }\n-        return defaultValue;\n-    }\n+    private final ConfigurationOption<Boolean> shipAgentLogs = ConfigurationOption.booleanOption()\n+        .key(SHIP_AGENT_LOGS)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"This helps you to centralize your agent logs by automatically sending them to APM Server (requires APM Server 7.9+).\\n\" +\n+            \"Use the Kibana Logs App to see the logs from all of your agents.\\n\" +\n+            \"\\n\" +\n+            \"If <<config-log-file,`log_file`>> is set to a real file location (as opposed to `System.out`),\\n\" +\n+            \"this file will be shipped to the APM Server by the agent.\\n\" +\n+            \"Note that <<config-log-format-file,`log_format_file`>> needs to be set to `JSON` when this option is enabled.\\n\" +\n+            \"\\n\" +\n+            \"If APM Server is temporarily not available, the agent will resume sending where it left off as soon as the server is back up again.\\n\" +\n+            \"The amount of logs that can be buffered is at least <<config-log-file-max-size,`log_file_max_size`>>.\\n\" +\n+            \"If the application crashes or APM Server is not available when shutting down,\\n\" +\n+            \"the agent will resume shipping the log file when the application restarts.\\n\" +\n+            \"\\n\" +\n+            \"Resume on restart does not work when the log is inside an ephemeral container.\\n\" +\n+            \"Consider mounting the log file to the host or use Filebeat if you need the extra reliability in this case.\\n\" +\n+            \"\\n\" +\n+            \"If <<config-log-file,`log_file`>> is set to `System.out`,\\n\" +\n+            \"the agent will additionally log into a temp file which is then sent to APM Server.\\n\" +\n+            \"This log's size is determined by <<config-log-file-max-size,`log_file_max_size`>> and will be deleted on shutdown.\\n\" +\n+            \"This means that logs that could not be sent before the application terminates are lost.\")\n+        .dynamic(false)\n+        .tags(\"added[not officially added yet]\", \"internal\")\n+        .buildWithDefault(false);\n \n-    private static void setLogLevel(@Nullable String level) {\n-        System.setProperty(SimpleLogger.LOG_KEY_PREFIX + \"co.elastic.apm\", level != null ? level : LogLevel.INFO.toString());\n-        System.setProperty(SimpleLogger.LOG_KEY_PREFIX + \"co.elastic.apm.agent.shaded\", LogLevel.OFF.toString().equals(level) ? level : LogLevel.WARN.toString());\n-        System.setProperty(SimpleLogger.SHOW_DATE_TIME_KEY, Boolean.TRUE.toString());\n-        System.setProperty(SimpleLogger.DATE_TIME_FORMAT_KEY, \"yyyy-MM-dd HH:mm:ss.SSS\");\n+    @SuppressWarnings(\"unused\")\n+    public ConfigurationOption<LogFormat> logFormatSout = ConfigurationOption.enumOption(LogFormat.class)\n+        .key(LOG_FORMAT_SOUT_KEY)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"Defines the log format when logging to `System.out`.\\n\" +\n+            \"\\n\" +\n+            \"When set to `JSON`, the agent will format the logs in an https://github.com/elastic/ecs-logging-java[ECS-compliant JSON format]\\n\" +\n+            \"where each log event is serialized as a single line.\")\n+        .tags(\"added[1.16.0]\")\n+        .buildWithDefault(LogFormat.PLAIN_TEXT);\n+\n+    @SuppressWarnings(\"unused\")\n+    public ConfigurationOption<LogFormat> logFormatFile = ConfigurationOption.enumOption(LogFormat.class)\n+        .key(LOG_FORMAT_FILE_KEY)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"Defines the log format when logging to a file.\\n\" +\n+            \"\\n\" +\n+            \"When set to `JSON`, the agent will format the logs in an https://github.com/elastic/ecs-logging-java[ECS-compliant JSON format]\\n\" +\n+            \"where each log event is serialized as a single line.\\n\"\n+            //+ \"\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2NzY1NQ==", "bodyText": "leftover TODO", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419967655", "createdAt": "2020-05-05T09:10:41Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/AbstractIntakeApiHandler.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.report;\n+\n+import co.elastic.apm.agent.impl.MetaData;\n+import co.elastic.apm.agent.report.serialize.DslJsonSerializer;\n+import co.elastic.apm.agent.report.serialize.PayloadSerializer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.stagemonitor.util.IOUtils;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.TimeUnit;\n+import java.util.zip.Deflater;\n+import java.util.zip.DeflaterOutputStream;\n+\n+public class AbstractIntakeApiHandler {\n+    protected final Logger logger = LoggerFactory.getLogger(getClass());\n+    protected static final int GZIP_COMPRESSION_LEVEL = 1;\n+    private static final Object WAIT_LOCK = new Object();\n+\n+    protected final ReporterConfiguration reporterConfiguration;\n+    protected final PayloadSerializer payloadSerializer;\n+    protected final ApmServerClient apmServerClient;\n+    protected final byte[] metaData;\n+    protected Deflater deflater;\n+    protected long currentlyTransmitting = 0;\n+    protected long reported = 0;\n+    protected long dropped = 0;\n+    @Nullable\n+    protected HttpURLConnection connection;\n+    @Nullable\n+    protected OutputStream os;\n+    protected int errorCount;\n+    protected volatile boolean shutDown;\n+\n+    public AbstractIntakeApiHandler(ReporterConfiguration reporterConfiguration, MetaData metaData, PayloadSerializer payloadSerializer, ApmServerClient apmServerClient) {\n+        this.reporterConfiguration = reporterConfiguration;\n+        this.payloadSerializer = payloadSerializer;\n+        this.apmServerClient = apmServerClient;\n+        this.deflater = new Deflater(GZIP_COMPRESSION_LEVEL);\n+        payloadSerializer.serializeMetaDataNdJson(metaData);\n+        this.metaData = payloadSerializer.toString().getBytes(StandardCharsets.UTF_8);\n+        try {\n+            payloadSerializer.flush();\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    /*\n+     * We add \u00b110% jitter to the calculated grace period in case multiple agents entered the grace period simultaneously.\n+     * This can happen if the APM server queue is full which leads to sending an error response to all connected agents.\n+     * The random jitter makes sure the agents will not all try to reconnect at the same time,\n+     * which would overwhelm the APM server again.\n+     */\n+    static long getRandomJitter(long backoffTimeMillis) {\n+        final long tenPercentOfBackoffTimeMillis = (long) (backoffTimeMillis * 0.1);\n+        return (long) (tenPercentOfBackoffTimeMillis * 2 * Math.random()) - tenPercentOfBackoffTimeMillis;\n+    }\n+\n+    static long getBackoffTimeSeconds(long errorCount) {\n+        return (long) Math.pow(Math.min(errorCount, 6), 2);\n+    }\n+\n+    protected boolean shouldEndRequest() {\n+        final long written = deflater.getBytesWritten() + DslJsonSerializer.BUFFER_SIZE;\n+        final boolean endRequest = written >= reporterConfiguration.getApiRequestSize();\n+        if (endRequest && logger.isDebugEnabled()) {\n+            logger.debug(\"Flushing, because request size limit exceeded {}/{}\", written, reporterConfiguration.getApiRequestSize());\n+        }\n+        return endRequest;\n+    }\n+\n+    protected HttpURLConnection startRequest(String endpoint) throws IOException {\n+        final HttpURLConnection connection = apmServerClient.startRequest(endpoint);\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"Starting new request to {}\", connection.getURL());\n+        }\n+        connection.setRequestMethod(\"POST\");\n+        connection.setDoOutput(true);\n+        connection.setChunkedStreamingMode(DslJsonSerializer.BUFFER_SIZE);\n+        connection.setRequestProperty(\"Content-Encoding\", \"deflate\");\n+        connection.setRequestProperty(\"Content-Type\", \"application/x-ndjson\");\n+        connection.setUseCaches(false);\n+        connection.connect();\n+        os = new DeflaterOutputStream(connection.getOutputStream(), deflater);\n+        os.write(metaData);\n+        return connection;\n+    }\n+\n+    public void endRequest() {\n+        if (connection != null) {\n+            try {\n+                payloadSerializer.flush();\n+                if (os != null) {\n+                    os.close();\n+                }\n+                if (logger.isDebugEnabled()) {\n+                    logger.debug(\"Flushing {} uncompressed {} compressed bytes\", deflater.getBytesRead(), deflater.getBytesWritten());\n+                }\n+                InputStream inputStream = connection.getInputStream();\n+                final int responseCode = connection.getResponseCode();\n+                if (responseCode >= 400) {\n+                    onRequestError(responseCode, inputStream, null);\n+                } else {\n+                    onRequestSuccess();\n+                }\n+            } catch (IOException e) {\n+                try {\n+                    onRequestError(connection.getResponseCode(), connection.getErrorStream(), e);\n+                } catch (IOException e1) {\n+                    onRequestError(-1, connection.getErrorStream(), e);\n+                }\n+            } finally {\n+                HttpUtils.consumeAndClose(connection);\n+                connection = null;\n+                deflater.reset();\n+                currentlyTransmitting = 0;\n+            }\n+        }\n+    }\n+\n+    protected void onRequestError(Integer responseCode, InputStream inputStream, @Nullable IOException e) {\n+        // TODO read accepted, dropped and invalid", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODM4Mw==", "bodyText": "what are the actual units/usage of currentlyTransmitting reported and dropped ? Number of bytes ? For reported and dropped number of success / failures while sending ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419968383", "createdAt": "2020-05-05T09:12:02Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/AbstractIntakeApiHandler.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.report;\n+\n+import co.elastic.apm.agent.impl.MetaData;\n+import co.elastic.apm.agent.report.serialize.DslJsonSerializer;\n+import co.elastic.apm.agent.report.serialize.PayloadSerializer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.stagemonitor.util.IOUtils;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.TimeUnit;\n+import java.util.zip.Deflater;\n+import java.util.zip.DeflaterOutputStream;\n+\n+public class AbstractIntakeApiHandler {\n+    protected final Logger logger = LoggerFactory.getLogger(getClass());\n+    protected static final int GZIP_COMPRESSION_LEVEL = 1;\n+    private static final Object WAIT_LOCK = new Object();\n+\n+    protected final ReporterConfiguration reporterConfiguration;\n+    protected final PayloadSerializer payloadSerializer;\n+    protected final ApmServerClient apmServerClient;\n+    protected final byte[] metaData;\n+    protected Deflater deflater;\n+    protected long currentlyTransmitting = 0;\n+    protected long reported = 0;\n+    protected long dropped = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3MTcyMw==", "bodyText": "Just wondering, do we have this payload defined in server specs ? Might be relevant to have a link to this PR for reference as it's the 1st agent to implement this.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419971723", "createdAt": "2020-05-05T09:18:11Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/serialize/DslJsonSerializer.java", "diffHunk": "@@ -230,6 +231,29 @@ public void serializeMetrics(MetricRegistry metricRegistry) {\n         metricRegistry.report(this);\n     }\n \n+    @Override\n+    public void serializeFileMetaData(File file) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3OTI5MQ==", "bodyText": "does this interface attempts to replicate something currently implemented in beat agents to ship files ? I feel it somehow miss some javadoc to explain how it works.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419979291", "createdAt": "2020-05-05T09:31:43Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/main/java/co/elastic/apm/agent/log/shipper/FileChangeListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import java.io.IOException;\n+\n+public interface FileChangeListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4NTYyOA==", "bodyText": "why do we need to poll just after stop is requested ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419985628", "createdAt": "2020-05-05T09:42:52Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/main/java/co/elastic/apm/agent/log/shipper/FileTailer.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.ThreadFactory;\n+\n+public class FileTailer implements Runnable {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(FileTailer.class);\n+    private final List<TailableFile> tailableFiles;\n+    private final FileChangeListener fileChangeListener;\n+    private final ByteBuffer buffer;\n+    private final int maxLinesPerCycle;\n+    private volatile boolean stopRequested = false;\n+    private final long idleTimeMs;\n+    private final Thread processingThread;\n+\n+    public FileTailer(FileChangeListener fileChangeListener, int bufferSize, int maxLinesPerCycle, long idleTimeMs, ThreadFactory processingThreadFactory) {\n+        this.tailableFiles = new CopyOnWriteArrayList<>();\n+        this.fileChangeListener = fileChangeListener;\n+        this.buffer = ByteBuffer.allocate(bufferSize);\n+        this.maxLinesPerCycle = maxLinesPerCycle;\n+        this.idleTimeMs = idleTimeMs;\n+        this.processingThread = processingThreadFactory.newThread(this);\n+    }\n+\n+    public TailableFile tailFile(File file) throws IOException {\n+        TailableFile tailableFile = new TailableFile(file);\n+        tailableFiles.add(tailableFile);\n+        return tailableFile;\n+    }\n+\n+    public void start() {\n+        processingThread.start();\n+    }\n+\n+    public void stop(long timeout) throws Exception {\n+        stopRequested = true;\n+        fileChangeListener.onShutdownInitiated();\n+        processingThread.join(timeout);\n+    }\n+\n+    @Override\n+    public void run() {\n+        try {\n+            while (!stopRequested) {\n+                int readLines = pollAll();\n+                if (readLines == 0) {\n+                    fileChangeListener.onIdle();\n+                    Thread.sleep(idleTimeMs);\n+                }\n+            }\n+            pollAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4OTAzNg==", "bodyText": "what is the equivalent value for Windows ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419989036", "createdAt": "2020-05-05T09:49:08Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/main/java/co/elastic/apm/agent/log/shipper/TailableFile.java", "diffHunk": "@@ -0,0 +1,357 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import java.io.Closeable;\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.channels.OverlappingFileLockException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import static java.nio.file.StandardOpenOption.CREATE;\n+import static java.nio.file.StandardOpenOption.READ;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+public class TailableFile implements Closeable {\n+    private static final Logger logger = LoggerFactory.getLogger(TailableFile.class);\n+    private static final byte NEW_LINE = (byte) '\\n';\n+    private static final int EOF = -1;\n+    private final File file;\n+    private final File stateFile;\n+    private final FileChannel stateFileChannel;\n+    private final FileLock stateFileLock;\n+    @Nullable\n+    private FileChannel fileChannel;\n+    /**\n+     * The creation date of the file.\n+     * The name of the file might change as its being read due to file rotation.\n+     * The file creation time can help to identify which file to read from when restoring the state.\n+     */\n+    private long fileCreationTime;\n+    private long inode;\n+\n+    public TailableFile(File file) throws IOException {\n+        this.file = file;\n+        stateFile = new File(file + \".state\");\n+        stateFileChannel = FileChannel.open(stateFile.toPath(), CREATE, READ, WRITE);\n+        try {\n+            stateFileLock = stateFileChannel.tryLock();\n+            if (stateFileLock == null) {\n+                throw new IllegalStateException(\"This file is currently locked by another process: \" + stateFile);\n+            }\n+        } catch (OverlappingFileLockException e) {\n+            throw new IllegalStateException(\"This file is currently locked by this process: \" + stateFile, e);\n+        }\n+        Properties state = readState();\n+        if (!state.isEmpty()) {\n+            restoreState(state);\n+        } else {\n+            tryOpenFile();\n+        }\n+    }\n+\n+    private Properties readState() throws IOException {\n+        Properties properties = new Properties();\n+        try (InputStream input = new FileInputStream(stateFile)) {\n+            properties.load(input);\n+        } catch (FileNotFoundException ignore) {\n+        }\n+        return properties;\n+    }\n+\n+    void deleteStateFile() {\n+        new File(file + \".state\").delete();\n+    }\n+\n+    public void deleteStateFileOnExit() {\n+        new File(file + \".state\").deleteOnExit();\n+    }\n+\n+    private void restoreState(Properties state) throws IOException {\n+        long position = Long.parseLong(state.getProperty(\"position\", \"0\"));\n+        long creationTime = Long.parseLong(state.getProperty(\"creationTime\", Long.toString(getCreationTime(file.toPath()))));\n+        long inode = Long.parseLong(state.getProperty(\"inode\", Long.toString(getInode(file.toPath()))));\n+        if (hasRotated(creationTime, inode)) {\n+            openRotatedFile(position, creationTime, inode);\n+        } else {\n+            openExistingFile(position, file.toPath());\n+        }\n+    }\n+\n+    private boolean hasRotated(long creationTime, long inode) throws IOException {\n+        if (inode != -1) {\n+            return getInode(file.toPath()) != inode;\n+        } else {\n+            return getCreationTime(file.toPath()) != creationTime;\n+        }\n+    }\n+\n+    private void openRotatedFile(long position, long creationTime, long inode) throws IOException {\n+        // the file has rotated and is now named differently, maybe something like file-0.log\n+        // let's search in the same directory for a file with the creation time from the state file\n+        File rotatedFile;\n+        if (inode == -1) {\n+            rotatedFile = findFileWithCreationDate(file.getParentFile(), creationTime);\n+        } else {\n+            rotatedFile = findFileWithInode(file.getParentFile(), inode);\n+        }\n+        if (rotatedFile != null && rotatedFile.length() > position) {\n+            openExistingFile(position, rotatedFile.toPath());\n+        }\n+    }\n+\n+    private void saveState(FileChannel fileChannel, long fileCreationTime) throws IOException {\n+        Properties properties = new Properties();\n+        properties.put(\"position\", Long.toString(fileChannel.position()));\n+        properties.put(\"creationTime\", Long.toString(fileCreationTime));\n+        properties.put(\"inode\", Long.toString(inode));\n+        try (FileOutputStream os = new FileOutputStream(stateFile)) {\n+            properties.store(os, null);\n+        }\n+    }\n+\n+    public void ack() {\n+        if (fileChannel == null) {\n+            throw new IllegalStateException(\"Can't acknowledge the state if the file has not been opened yet\");\n+        }\n+        try {\n+            saveState(fileChannel, fileCreationTime);\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);\n+        }\n+    }\n+\n+    public void nak() {\n+        try {\n+            Properties state = readState();\n+            if (!state.isEmpty()) {\n+                restoreState(state);\n+            }\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);\n+        }\n+    }\n+\n+    @Nullable\n+    private File findFileWithCreationDate(File dir, final long creationTime) {\n+        File[] files = dir.listFiles(new FileFilter() {\n+            @Override\n+            public boolean accept(File file) {\n+                try {\n+                    return !file.getName().endsWith(\".state\") && getCreationTime(file.toPath()) == creationTime;\n+                } catch (IOException e) {\n+                    return false;\n+                }\n+            }\n+        });\n+        if (files != null && files.length == 1) {\n+            return files[0];\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    private File findFileWithInode(File dir, final long inode) {\n+        File[] files = dir.listFiles(new FileFilter() {\n+            @Override\n+            public boolean accept(File file) {\n+                return getInode(file.toPath()) == inode;\n+            }\n+        });\n+        if (files != null && files.length == 1) {\n+            return files[0];\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    private long getCreationTime(Path path) throws IOException {\n+        BasicFileAttributes attr = Files.readAttributes(path, BasicFileAttributes.class);\n+        return attr.creationTime().to(TimeUnit.MILLISECONDS);\n+    }\n+\n+    private long getInode(Path path) {\n+        try {\n+            return (Long) Files.getAttribute(path, \"unix:ino\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MjY3MQ==", "bodyText": "maybe making file a Path instead of a File would be a bit better as it avoids conversions and Channel requires it anyway. Also, it's already commonly used in TailableFileTest.java.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419992671", "createdAt": "2020-05-05T09:55:49Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/main/java/co/elastic/apm/agent/log/shipper/TailableFile.java", "diffHunk": "@@ -0,0 +1,357 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import java.io.Closeable;\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.channels.OverlappingFileLockException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import static java.nio.file.StandardOpenOption.CREATE;\n+import static java.nio.file.StandardOpenOption.READ;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+public class TailableFile implements Closeable {\n+    private static final Logger logger = LoggerFactory.getLogger(TailableFile.class);\n+    private static final byte NEW_LINE = (byte) '\\n';\n+    private static final int EOF = -1;\n+    private final File file;\n+    private final File stateFile;\n+    private final FileChannel stateFileChannel;\n+    private final FileLock stateFileLock;\n+    @Nullable\n+    private FileChannel fileChannel;\n+    /**\n+     * The creation date of the file.\n+     * The name of the file might change as its being read due to file rotation.\n+     * The file creation time can help to identify which file to read from when restoring the state.\n+     */\n+    private long fileCreationTime;\n+    private long inode;\n+\n+    public TailableFile(File file) throws IOException {\n+        this.file = file;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MzM1Nw==", "bodyText": "why make this static and provide an instance as first argument ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419993357", "createdAt": "2020-05-05T09:57:03Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/main/java/co/elastic/apm/agent/log/shipper/TailableFile.java", "diffHunk": "@@ -0,0 +1,357 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import java.io.Closeable;\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.channels.OverlappingFileLockException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import static java.nio.file.StandardOpenOption.CREATE;\n+import static java.nio.file.StandardOpenOption.READ;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+public class TailableFile implements Closeable {\n+    private static final Logger logger = LoggerFactory.getLogger(TailableFile.class);\n+    private static final byte NEW_LINE = (byte) '\\n';\n+    private static final int EOF = -1;\n+    private final File file;\n+    private final File stateFile;\n+    private final FileChannel stateFileChannel;\n+    private final FileLock stateFileLock;\n+    @Nullable\n+    private FileChannel fileChannel;\n+    /**\n+     * The creation date of the file.\n+     * The name of the file might change as its being read due to file rotation.\n+     * The file creation time can help to identify which file to read from when restoring the state.\n+     */\n+    private long fileCreationTime;\n+    private long inode;\n+\n+    public TailableFile(File file) throws IOException {\n+        this.file = file;\n+        stateFile = new File(file + \".state\");\n+        stateFileChannel = FileChannel.open(stateFile.toPath(), CREATE, READ, WRITE);\n+        try {\n+            stateFileLock = stateFileChannel.tryLock();\n+            if (stateFileLock == null) {\n+                throw new IllegalStateException(\"This file is currently locked by another process: \" + stateFile);\n+            }\n+        } catch (OverlappingFileLockException e) {\n+            throw new IllegalStateException(\"This file is currently locked by this process: \" + stateFile, e);\n+        }\n+        Properties state = readState();\n+        if (!state.isEmpty()) {\n+            restoreState(state);\n+        } else {\n+            tryOpenFile();\n+        }\n+    }\n+\n+    private Properties readState() throws IOException {\n+        Properties properties = new Properties();\n+        try (InputStream input = new FileInputStream(stateFile)) {\n+            properties.load(input);\n+        } catch (FileNotFoundException ignore) {\n+        }\n+        return properties;\n+    }\n+\n+    void deleteStateFile() {\n+        new File(file + \".state\").delete();\n+    }\n+\n+    public void deleteStateFileOnExit() {\n+        new File(file + \".state\").deleteOnExit();\n+    }\n+\n+    private void restoreState(Properties state) throws IOException {\n+        long position = Long.parseLong(state.getProperty(\"position\", \"0\"));\n+        long creationTime = Long.parseLong(state.getProperty(\"creationTime\", Long.toString(getCreationTime(file.toPath()))));\n+        long inode = Long.parseLong(state.getProperty(\"inode\", Long.toString(getInode(file.toPath()))));\n+        if (hasRotated(creationTime, inode)) {\n+            openRotatedFile(position, creationTime, inode);\n+        } else {\n+            openExistingFile(position, file.toPath());\n+        }\n+    }\n+\n+    private boolean hasRotated(long creationTime, long inode) throws IOException {\n+        if (inode != -1) {\n+            return getInode(file.toPath()) != inode;\n+        } else {\n+            return getCreationTime(file.toPath()) != creationTime;\n+        }\n+    }\n+\n+    private void openRotatedFile(long position, long creationTime, long inode) throws IOException {\n+        // the file has rotated and is now named differently, maybe something like file-0.log\n+        // let's search in the same directory for a file with the creation time from the state file\n+        File rotatedFile;\n+        if (inode == -1) {\n+            rotatedFile = findFileWithCreationDate(file.getParentFile(), creationTime);\n+        } else {\n+            rotatedFile = findFileWithInode(file.getParentFile(), inode);\n+        }\n+        if (rotatedFile != null && rotatedFile.length() > position) {\n+            openExistingFile(position, rotatedFile.toPath());\n+        }\n+    }\n+\n+    private void saveState(FileChannel fileChannel, long fileCreationTime) throws IOException {\n+        Properties properties = new Properties();\n+        properties.put(\"position\", Long.toString(fileChannel.position()));\n+        properties.put(\"creationTime\", Long.toString(fileCreationTime));\n+        properties.put(\"inode\", Long.toString(inode));\n+        try (FileOutputStream os = new FileOutputStream(stateFile)) {\n+            properties.store(os, null);\n+        }\n+    }\n+\n+    public void ack() {\n+        if (fileChannel == null) {\n+            throw new IllegalStateException(\"Can't acknowledge the state if the file has not been opened yet\");\n+        }\n+        try {\n+            saveState(fileChannel, fileCreationTime);\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);\n+        }\n+    }\n+\n+    public void nak() {\n+        try {\n+            Properties state = readState();\n+            if (!state.isEmpty()) {\n+                restoreState(state);\n+            }\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);\n+        }\n+    }\n+\n+    @Nullable\n+    private File findFileWithCreationDate(File dir, final long creationTime) {\n+        File[] files = dir.listFiles(new FileFilter() {\n+            @Override\n+            public boolean accept(File file) {\n+                try {\n+                    return !file.getName().endsWith(\".state\") && getCreationTime(file.toPath()) == creationTime;\n+                } catch (IOException e) {\n+                    return false;\n+                }\n+            }\n+        });\n+        if (files != null && files.length == 1) {\n+            return files[0];\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    private File findFileWithInode(File dir, final long inode) {\n+        File[] files = dir.listFiles(new FileFilter() {\n+            @Override\n+            public boolean accept(File file) {\n+                return getInode(file.toPath()) == inode;\n+            }\n+        });\n+        if (files != null && files.length == 1) {\n+            return files[0];\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    private long getCreationTime(Path path) throws IOException {\n+        BasicFileAttributes attr = Files.readAttributes(path, BasicFileAttributes.class);\n+        return attr.creationTime().to(TimeUnit.MILLISECONDS);\n+    }\n+\n+    private long getInode(Path path) {\n+        try {\n+            return (Long) Files.getAttribute(path, \"unix:ino\");\n+        } catch (Exception e) {\n+            return -1;\n+        }\n+    }\n+\n+    public int tail(ByteBuffer buffer, FileChangeListener listener, int maxLines) throws IOException {\n+        int readLines = 0;\n+        while (readLines < maxLines) {\n+            FileChannel currentFile = getFileChannel();\n+            if (currentFile == null || isFullyRead()) {\n+                return readLines;\n+            }\n+            readLines += readFile(buffer, listener, maxLines - readLines, currentFile);\n+        }\n+        return readLines;\n+    }\n+\n+    private int readFile(ByteBuffer buffer, FileChangeListener listener, int maxLines, FileChannel currentFile) throws IOException {\n+        int readLines = 0;\n+        while (readLines < maxLines) {\n+            buffer.clear();\n+            int read = currentFile.read(buffer);\n+            if (read != EOF) {\n+                buffer.flip();\n+                readLines += readLines(this, buffer, maxLines - readLines, listener);\n+                currentFile.position(currentFile.position() - buffer.remaining());\n+            } else {\n+                // assumes EOF equals EOL\n+                // this might be wrong when another process is in the middle of writing the line\n+                // (when is the new file size visible to other processes?)\n+                return readLines;\n+            }\n+        }\n+        return readLines;\n+    }\n+\n+    @Nullable\n+    private FileChannel getFileChannel() throws IOException {\n+        if (fileChannel == null || (isFullyRead() && hasRotated())) {\n+            tryOpenFile();\n+        }\n+        return fileChannel;\n+    }\n+\n+    private boolean hasRotated() throws IOException {\n+        return fileChannel != null && file.exists() && file.length() < fileChannel.position();\n+    }\n+\n+    private boolean isFullyRead() throws IOException {\n+        return fileChannel != null && fileChannel.position() == fileChannel.size();\n+    }\n+\n+    private void tryOpenFile() throws IOException {\n+        if (!file.exists()) {\n+            return;\n+        }\n+        openExistingFile(0, file.toPath());\n+    }\n+\n+    private void openExistingFile(long position, Path path) throws IOException {\n+        if (this.fileChannel != null) {\n+            this.fileChannel.close();\n+        }\n+        FileChannel fileChannel = FileChannel.open(path);\n+        fileChannel.position(position);\n+        fileCreationTime = getCreationTime(file.toPath());\n+        inode = getInode(file.toPath());\n+        if (this.fileChannel == null) {\n+            saveState(fileChannel, fileCreationTime);\n+        }\n+        this.fileChannel = fileChannel;\n+    }\n+\n+    static int readLines(TailableFile file, ByteBuffer buffer, int maxLines, FileChangeListener listener) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 288}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NTk3OA==", "bodyText": "Buffy the logs slayer \u2122\ufe0f", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419995978", "createdAt": "2020-05-05T10:01:52Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-log-shipper-plugin/src/test/java/co/elastic/apm/agent/log/shipper/TailableFileTest.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shipper;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+\n+class TailableFileTest {\n+\n+    private final ByteBuffer buffy = ByteBuffer.allocate(1024);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5OTIzMw==", "bodyText": "std out > console ?", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r419999233", "createdAt": "2020-05-05T10:07:59Z", "author": {"login": "SylvainJuge"}, "path": "docs/configuration.asciidoc", "diffHunk": "@@ -1486,7 +1489,8 @@ When set to the special value 'System.out',\n the logs are sent to standard out.\n \n NOTE: When logging to a file,\n-it's content is deleted when the application starts.\n+the log will be formatted in new-line-delimited JSON.\n+When logging to std out, the log will be formatted as plain-text.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e12e224ed43f958362b88a1d5b0e1a86b66e0d3", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/2e12e224ed43f958362b88a1d5b0e1a86b66e0d3", "committedDate": "2020-05-05T11:37:21Z", "message": "Fix log4j test dependency conflict with elasticsearch-rest-high-level-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a93be1d0d51f5d9811155f2cff7b2a5ccd0f2bf", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/3a93be1d0d51f5d9811155f2cff7b2a5ccd0f2bf", "committedDate": "2020-05-06T07:54:21Z", "message": "Apply suggestions from review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzQ4NDk3", "url": "https://github.com/elastic/apm-agent-java/pull/1169#pullrequestreview-410748497", "createdAt": "2020-05-13T09:28:01Z", "commit": {"oid": "3a93be1d0d51f5d9811155f2cff7b2a5ccd0f2bf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOToyODowMlrOGUpP0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTozMDozNFrOGUpV5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMwMDQ5OA==", "bodyText": "Then, probably removing the 'max' from the configuration would remove any expectation to be the actual max disk usage by the agent. for example if we name it log_file_buffer_size and then document that disk usage is at most equal to twice this value.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r424300498", "createdAt": "2020-05-13T09:28:02Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -117,67 +122,94 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n-    public static void init(List<ConfigurationSource> sources) {\n-        setLogLevel(getValue(LOG_LEVEL_KEY, sources,\n-            getValue(DEPRECATED_LOG_LEVEL_KEY, sources, LogLevel.INFO.toString())));\n-        setLogFileLocation(ElasticApmAgent.getAgentHome(), getValue(LOG_FILE_KEY, sources,\n-            getValue(DEPRECATED_LOG_FILE_KEY, sources, DEFAULT_LOG_FILE)));\n-    }\n+    @SuppressWarnings(\"unused\")\n+    public ConfigurationOption<ByteValue> logFileMaxSize = ByteValueConverter.byteOption()\n+        .key(LOG_FILE_MAX_SIZE_KEY)\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"The max size of the log file.\\n\" +\n+            \"\\n\" +\n+            //\"To support <<config-ship-agent-logs,shipping the logs>> to APM Server,\\n\" +\n+            \"The agent always keeps one history file so that the max total log file size is twice the value of this setting.\\n\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2MzY5MQ=="}, "originalCommit": {"oid": "e859dfae312bc49c96743b090bd459923e54c1d7"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMwMjA1NQ==", "bodyText": "just wondering, how did you found that there was some log4j files relocated in the packaged agent ? I feel that having a test that enforces allowed resource patterns in the packaged agent jar could help here.", "url": "https://github.com/elastic/apm-agent-java/pull/1169#discussion_r424302055", "createdAt": "2020-05-13T09:30:34Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/pom.xml", "diffHunk": "@@ -28,14 +35,13 @@\n             <groupId>org.elasticsearch.client</groupId>\n             <artifactId>elasticsearch-rest-high-level-client</artifactId>\n             <version>${version.elasticsearch}</version>\n-            <scope>provided</scope>\n-        </dependency>\n-\n-        <!-- Common code where helper is located -->\n-        <dependency>\n-            <groupId>${project.groupId}</groupId>\n-            <artifactId>apm-es-restclient-plugin-common</artifactId>\n-            <version>${project.version}</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a93be1d0d51f5d9811155f2cff7b2a5ccd0f2bf"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a0a72d38e006c88f2d04c6e56fc5dd20f692c9", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/c4a0a72d38e006c88f2d04c6e56fc5dd20f692c9", "committedDate": "2020-05-14T09:04:58Z", "message": "Rename log_file_max_size to log_file_size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c92d980421d0e257494fc86e9372dde5017d6e3", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/7c92d980421d0e257494fc86e9372dde5017d6e3", "committedDate": "2020-05-14T09:07:09Z", "message": "Merge remote-tracking branch 'origin/master' into log-shipper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95726c839e78aa12b8b4e1251cbd2e3dc06219ce", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/95726c839e78aa12b8b4e1251cbd2e3dc06219ce", "committedDate": "2020-05-14T09:15:59Z", "message": "Fix parent pom version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd63334fbcd7100919929b93a32967e31b9ed6a", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/4cd63334fbcd7100919929b93a32967e31b9ed6a", "committedDate": "2020-05-14T10:30:20Z", "message": "Remove multi-version release files for log4j and relocate Log4j- files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17870aa2133300fe889511430c15e1b5db63a541", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/17870aa2133300fe889511430c15e1b5db63a541", "committedDate": "2020-05-15T11:14:21Z", "message": "Fix error on Wildfly start by avoiding MBean server init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c771fd819bceac2a99fc2b9a20825d217d07b2c", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/0c771fd819bceac2a99fc2b9a20825d217d07b2c", "committedDate": "2020-05-15T13:29:40Z", "message": "Avoid log4j2 conflicts in Spring Boot tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3962, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}