{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyNjgzNjU2", "number": 1295, "title": "Allow empty server_urls", "bodyText": "What does this PR do?\n\nFixes #1281\n\nDoes not create arithmetic error of dividing by zero when server url list is empty\nAllows setting server_urls with an empty string, making the agent trace as usual with any sampling rate, but without attempting to communicate with the APM server and:\n\nMetrics are collected as usual with buffers being replaced in the specified interval\nEvents are dropped as long as there is no server URL configured\nLog shipper can resume working when server urls are set\n\n\n\nChecklist for reviewer\nVerify that when server_urls are set to an empty string:\n\n Events do not leak\n No communication with the APM server is attempted, including health check and remote config polling\n File shipper works as expected\n Threads communicating with APM server are backing off properly\n\nChecklist\n\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\n Added an API method or config option? Document in which version this will be introduced\n I have made corresponding changes to the documentation\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n\n\n This is a new plugin\n\n I have updated CHANGELOG.asciidoc\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated CHANGELOG.asciidoc\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? Describe how you made sure that old, non-supported versions are not instrumented by accident.\n\n\n This is something else\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-07-19T17:45:00Z", "url": "https://github.com/elastic/apm-agent-java/pull/1295", "merged": true, "mergeCommit": {"oid": "023d63229cdfdea9879b9e395309e15503555697"}, "closed": true, "closedAt": "2020-07-30T10:29:43Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2ghVhAH2gAyNDUyNjgzNjU2OjRlMGRkNzhkZWQxMDhkMDcwMTEwZDNlMGM2OTM3YjcyYTlhOTcxYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc58JZaAH2gAyNDUyNjgzNjU2OjhhMWUwMTRhYmRiNGRiMDQ0YjA5MDFiMTQ5OGFhNWEzZjAzYzExM2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e0dd78ded108d070110d3e0c6937b72a9a971b5", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4e0dd78ded108d070110d3e0c6937b72a9a971b5", "committedDate": "2020-07-19T17:31:22Z", "message": "Allow empty server_urls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b46994883bf61cad6b885273b6dc69233a469d46", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b46994883bf61cad6b885273b6dc69233a469d46", "committedDate": "2020-07-19T17:34:47Z", "message": "Test two more client methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0e5ac06e29811bb128b4824d38207c795bd538d1", "committedDate": "2020-07-20T07:43:00Z", "message": "Tests, backoff in log shipper, health check change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c29e71171ce47b315fc52d14fbc3ca52bd975a94", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c29e71171ce47b315fc52d14fbc3ca52bd975a94", "committedDate": "2020-07-21T10:14:42Z", "message": "Merge remote-tracking branch 'upstream/master' into client-error-divided-by-zero"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb8c0dbcddfc35321c93239da43c2aa21c1b0c38", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/bb8c0dbcddfc35321c93239da43c2aa21c1b0c38", "committedDate": "2020-07-21T11:06:09Z", "message": "Update documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzUzOTc3", "url": "https://github.com/elastic/apm-agent-java/pull/1295#pullrequestreview-452353977", "createdAt": "2020-07-21T11:12:25Z", "commit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToxMjoyNlrOG0zNtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToxMjoyNlrOG0zNtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ==", "bodyText": "This is called each time any event is processed from the queue when server_urls is empty, correct?\nWhat is the purpose of flipping active and inactive metric sets in this case? Note it doesn't reset the counters and timers as that's only done during serialization. Conflating serialization and metrics resetting is probably a code smell and that's on me. But do we have to reset the metrics at all? If so, I think this also resets even if a span is reported, for example, which doesn't feel right. Or is this serving an entirely different purpose?\nDocumenting the purpose here would help.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458018229", "createdAt": "2020-07-21T11:12:26Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1fb7a46c83416d923df91bf03caa9f19741512f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/d1fb7a46c83416d923df91bf03caa9f19741512f", "committedDate": "2020-07-21T12:01:37Z", "message": "Adding to documentation and CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c47050414f8cdf670152b5d618c912fe45e2fe", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e1c47050414f8cdf670152b5d618c912fe45e2fe", "committedDate": "2020-07-21T13:13:01Z", "message": "Replace metrics buffers with new one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71156e7f960defd505f3dae8145aab055f30f783", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/71156e7f960defd505f3dae8145aab055f30f783", "committedDate": "2020-07-22T06:29:30Z", "message": "Handling metrics reset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMTU5MDk5", "url": "https://github.com/elastic/apm-agent-java/pull/1295#pullrequestreview-453159099", "createdAt": "2020-07-22T09:42:22Z", "commit": {"oid": "71156e7f960defd505f3dae8145aab055f30f783"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo0MjoyMlrOG1a7IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo0MjoyMlrOG1a7IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY2ODgzMw==", "bodyText": "[minor] maybe call it flip phase and report to be consistent with the reader-writer-phaser terminology? the word buffer is not used elsewhere in this class.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458668833", "createdAt": "2020-07-22T09:42:22Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -159,14 +159,30 @@ public DoubleSupplier getGauge(String name, Labels labels) {\n         return null;\n     }\n \n-    public void report(MetricsReporter metricsReporter) {\n+    /**\n+     * Executes the following steps within a single read-operation critical section:\n+     * <ul>\n+     *     <li>Switch between active and inactive MetricSet buffers</li>\n+     *     <li>Report the inactivated buffer (optional)</li>\n+     *     <li>Reset the inactivated buffer</li>\n+     * </ul>\n+     *\n+     * @param metricsReporter a reporter to be used for reporting the inactivated metrics buffer. May be {@code null}\n+     *                        if reporting is not required.\n+     */\n+    public void switchBuffersAndReport(@Nullable MetricsReporter metricsReporter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71156e7f960defd505f3dae8145aab055f30f783"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f935ef13eed7020b9bca6593ec00f5a39bd0e20a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f935ef13eed7020b9bca6593ec00f5a39bd0e20a", "committedDate": "2020-07-26T13:38:07Z", "message": "Change method name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1e014abdb4db044b0901b1498aa5a3f03c113a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8a1e014abdb4db044b0901b1498aa5a3f03c113a", "committedDate": "2020-07-30T09:24:20Z", "message": "Merge remote-tracking branch 'upstream/master' into client-error-divided-by-zero"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3799, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}