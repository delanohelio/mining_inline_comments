{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMzgyNzcy", "number": 1126, "title": "Fix circuit breaker flaky test (race condition)", "bodyText": "What does this PR do?\nFixes a race condition only triggered in tests where tracer state isn't properly updated until circuit breaker polling has been run.\nChecklist\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\nI have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\nI have updated CHANGELOG.asciidoc\nI have updated supported-technologies.asciidoc\nAdded an API method or config option? Document in which version this will be introduced\nAdded an instrumentation plugin? How did you make sure that old, non-supported versions are not instrumented by accident?\n\nAuthor's Checklist\n\n run the failing for a while (>10k executions without a failure)\n\nRelated issues\nFurther improvements on changes introduced with #1109", "createdAt": "2020-04-07T16:43:54Z", "url": "https://github.com/elastic/apm-agent-java/pull/1126", "merged": true, "mergeCommit": {"oid": "f3ee22ab465fb641e6c8d4802bfbc71e065eda7b"}, "closed": true, "closedAt": "2020-04-09T14:30:28Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVT-sbAH2gAyNDAwMzgyNzcyOjdlNjY4YjQ5Nzc4MDlhOWI0OWQzMjg2ZTE0ZDJkZmFiNDg5MTdhZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV8a83AH2gAyNDAwMzgyNzcyOmU1NjgyMjU2MTVjZTg5ZGEzM2JlMmJkMzNiNzE2YTA1MjY5MTBiZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e668b4977809a9b49d3286e14d2dfab48917af1", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/7e668b4977809a9b49d3286e14d2dfab48917af1", "committedDate": "2020-04-07T14:15:10Z", "message": "fix flaky test (tricky race condition)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb851638613f0b9dbbe7bfe0b51f5a1f5c5ab9de", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/fb851638613f0b9dbbe7bfe0b51f5a1f5c5ab9de", "committedDate": "2020-04-07T14:15:39Z", "message": "fix javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "committedDate": "2020-04-07T16:40:08Z", "message": "increase test timeout a bit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzAxOTMy", "url": "https://github.com/elastic/apm-agent-java/pull/1126#pullrequestreview-389301932", "createdAt": "2020-04-07T16:44:46Z", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0NDo0NlrOGCMoXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0NDo0NlrOGCMoXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NzI3Ng==", "bodyText": "cosmetic change, but makes reading a bit easier.", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404957276", "createdAt": "2020-04-07T16:44:46Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -636,29 +636,31 @@ synchronized void start(List<LifecycleListener> lifecycleListeners) {\n \n     public synchronized void onStressDetected() {\n         currentlyUnderStress = true;\n-        pause();\n+        if (tracerState == TracerState.RUNNING) {\n+            pause();\n+        }\n     }\n \n     public synchronized void onStressRelieved() {\n         currentlyUnderStress = false;\n-        if (recordingConfigOptionSet) {\n+        if (tracerState == TracerState.PAUSED && recordingConfigOptionSet) {\n             resume();\n         }\n     }\n \n-    private synchronized void recordingConfigChanged(boolean wasRecording, boolean shouldBeRecording) {\n+    private synchronized void recordingConfigChanged(boolean oldValue, boolean newValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzA0OTA0", "url": "https://github.com/elastic/apm-agent-java/pull/1126#pullrequestreview-389304904", "createdAt": "2020-04-07T16:48:21Z", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0ODoyMVrOGCMxlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0ODoyMVrOGCMxlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1OTYzOA==", "bodyText": "This is the change what fixes the test flakyness, as it will now\n\nwait for all stress monitors to be polled, which will then update tracer state\nwait for all stress monitors to be polled at the beginning of steady paused state.\n\nAs tracer stress status isn't atomic, there is a race condition between \"all stress monitors has been polled\" and \"update tracer stress state\".", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404959638", "createdAt": "2020-04-07T16:48:21Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/circuitbreaker/CircuitBreakerTest.java", "diffHunk": "@@ -190,10 +190,13 @@ void testPauseThroughConfigThenResumeOnlyWhenStressRelieved() throws IOException\n \n         // 3 stress should keep it paused\n         monitor.simulateStress();\n+        // needs to poll all monitors otherwise tracer state might not be up-to-date within tracer (only updated once polling is over)\n+        assertAllMonitorsPolled(()->{}, monitor);\n         assertSteadyState(this::assertPaused, monitor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzA1NjA1", "url": "https://github.com/elastic/apm-agent-java/pull/1126#pullrequestreview-389305605", "createdAt": "2020-04-07T16:49:12Z", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0OToxMlrOGCMz-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0OToxMlrOGCMz-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MDI1MA==", "bodyText": "also, it seems that some failures were due to timeout being too short, a few measurements showed that it sometimes took between 30ms, thus there wasn't a sufficient margin under system load.", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404960250", "createdAt": "2020-04-07T16:49:12Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/circuitbreaker/CircuitBreakerTest.java", "diffHunk": "@@ -274,7 +281,7 @@ private static void awaitAssert(ThrowingRunnable assertion) {\n     private static ConditionFactory doAwait() {\n         return await()\n             .pollInterval(1, TimeUnit.MILLISECONDS)\n-            .timeout(50, TimeUnit.MILLISECONDS);\n+            .timeout(200, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzA2MDk2", "url": "https://github.com/elastic/apm-agent-java/pull/1126#pullrequestreview-389306096", "createdAt": "2020-04-07T16:49:45Z", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0OTo0NVrOGCM1hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo0OTo0NVrOGCM1hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MDY0Ng==", "bodyText": "this change has also already been applied to master directly in the mean time.", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404960646", "createdAt": "2020-04-07T16:49:45Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -42,7 +42,7 @@\n import static net.bytebuddy.matcher.ElementMatchers.named;\n \n /**\n- * Instruments implementations of {@link io.grpc.ServerCall.Listener} for runtime exceptions & transaction activation\n+ * Instruments implementations of {@link io.grpc.ServerCall.Listener} for runtime exceptions and transaction activation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzgwMjU5", "url": "https://github.com/elastic/apm-agent-java/pull/1126#pullrequestreview-390780259", "createdAt": "2020-04-09T13:15:23Z", "commit": {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e568225615ce89da33be2bd33b716a0526910bfd", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e568225615ce89da33be2bd33b716a0526910bfd", "committedDate": "2020-04-09T13:22:14Z", "message": "Merge branch 'master' into fix-flaky-circuit-breaker-season-2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3920, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}