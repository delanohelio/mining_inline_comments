{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MTU5MTk4", "number": 1594, "title": "Adding ability to delay agent initialization on startup", "bodyText": "Adding the ability to delay instrumentation and do that on the background during or after app initialization.\nThe delay includes the loading of the IndyBootstrapDispatcher class, so to avoid loading CallSite on startup.\nChecklist\n\n Add ability to configure delay through System property\n Auto-apply a fix delay on Java 7 and early Java 8 updates\n Test fix on JVMs where it is easily reproducible, namely zulu-7.0.285-linux and oracle-7u80-linux\n Add documentation\n Add to CHANGELOG", "createdAt": "2020-12-28T16:39:59Z", "url": "https://github.com/elastic/apm-agent-java/pull/1594", "merged": true, "mergeCommit": {"oid": "40773036faab70828c16aa0f8da3d39a3c56430a"}, "closed": true, "closedAt": "2021-01-26T17:13:22Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqovPBgH2gAyNTQ2MTU5MTk4OmI3YzJmMTY4MjhmNjZjZTQ1MTMzMjUzZGVkYTVlYzI1NWEwYzM0ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdz9qzWAH2gAyNTQ2MTU5MTk4OmUyMTZiOTg0YTI1YzhmZjBjMTZhNjc0ZTJmOTU2MmZjNzU0ODczMmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7c2f16828f66ce45133253deda5ec255a0c34e3", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b7c2f16828f66ce45133253deda5ec255a0c34e3", "committedDate": "2020-12-28T16:29:51Z", "message": "Adding ability to delay instrumentation on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f655c2123e45befaedb8e47798769e5e7f96e4a5", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f655c2123e45befaedb8e47798769e5e7f96e4a5", "committedDate": "2020-12-28T16:50:27Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0622fa488b3b366f54ffe481e07e73ccf7965045", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0622fa488b3b366f54ffe481e07e73ccf7965045", "committedDate": "2020-12-29T03:26:48Z", "message": "Set GlobalTracer before getting a logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a256974a953bfeaddeb74d1b40629d244ddd2e", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e9a256974a953bfeaddeb74d1b40629d244ddd2e", "committedDate": "2021-01-21T06:36:15Z", "message": "Merge remote-tracking branch 'upstream/master' into delay-instrumentation-in-java-7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83efe64fddca54585dab0ee1424dfe9cc792d96a", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/83efe64fddca54585dab0ee1424dfe9cc792d96a", "committedDate": "2021-01-24T05:20:25Z", "message": "Merge remote-tracking branch 'upstream/master' into delay-instrumentation-in-java-7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5b57ff642cd2c5a6dd54917ca34166342f6c020", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a5b57ff642cd2c5a6dd54917ca34166342f6c020", "committedDate": "2021-01-24T09:05:41Z", "message": "Separating AgenMain from agent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3317a253766f541cea1e54b593d674f4ee00c03f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3317a253766f541cea1e54b593d674f4ee00c03f", "committedDate": "2021-01-24T12:48:31Z", "message": "Delaying by default for early HotSpot VMs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e968136aeee0f502ac13d948305d5d0ec2bb25", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/70e968136aeee0f502ac13d948305d5d0ec2bb25", "committedDate": "2021-01-25T06:20:36Z", "message": "Small update version fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbbead9fa018cb75fea9be7de9ae2ed00207fbcf", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/fbbead9fa018cb75fea9be7de9ae2ed00207fbcf", "committedDate": "2021-01-25T07:12:09Z", "message": "Updating troubleshooting.asciidoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2MTE5NzY3", "url": "https://github.com/elastic/apm-agent-java/pull/1594#pullrequestreview-576119767", "createdAt": "2021-01-26T08:33:34Z", "commit": {"oid": "fbbead9fa018cb75fea9be7de9ae2ed00207fbcf"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQwODozMzozNFrOIaL9PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQwODo0OTozMlrOIaMj1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDMyOTc4OA==", "bodyText": "Is that on purpose that we have two distinct properties ? I'm not sure to get why we would need to split delay for tracer init and the premain execution.\n\ndelay_tracer_start with alias delay_tracer_start_ms which is internal but documented in CoreConfiguration\ndelay_agent_premain_ms property which does not rely on configuration to avoid any dependency.", "url": "https://github.com/elastic/apm-agent-java/pull/1594#discussion_r564329788", "createdAt": "2021-01-26T08:33:34Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/configuration/CoreConfiguration.java", "diffHunk": "@@ -129,12 +129,13 @@\n         .tags(\"added[1.11.0]\")\n         .build();\n \n-    private final ConfigurationOption<TimeDuration> delayInit = TimeDurationValueConverter.durationOption(\"ms\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbbead9fa018cb75fea9be7de9ae2ed00207fbcf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDMzMzU3Nw==", "bodyText": "Removing that constraint on early Java 8 early versions would be really nice !! Do we need to make load-testing able to run tests with forks to validate this ? We could use a temporary branch on the project itself as a work-around.", "url": "https://github.com/elastic/apm-agent-java/pull/1594#discussion_r564333577", "createdAt": "2021-01-26T08:39:41Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-premain/src/main/java/co/elastic/apm/agent/premain/AgentMain.java", "diffHunk": "@@ -101,13 +99,72 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n             if (doDisable) {\n                 return;\n             }\n+        }\n \n+        // workaround for classloader deadlock https://bugs.openjdk.java.net/browse/JDK-8194653\n+        FileSystems.getDefault();\n+\n+        long delayAgentInitMs = -1L;\n+        String delayAgentInitMsProperty = System.getProperty(\"elastic.apm.delay_agent_premain_ms\");\n+        if (delayAgentInitMsProperty != null) {\n+            try {\n+                delayAgentInitMs = Long.parseLong(delayAgentInitMsProperty.trim());\n+            } catch (NumberFormatException numberFormatException) {\n+                System.err.println(\"The value of the \\\"elastic.apm.delay_agent_premain_ms\\\" System property must be a number\");\n+            }\n         }\n+        if (premain && shouldDelayOnPremain()) {\n+            delayAgentInitMs = Math.max(delayAgentInitMs, 3000L);\n+        }\n+        if (delayAgentInitMs > 0) {\n+            delayAndInitAgentAsync(agentArguments, instrumentation, premain, delayAgentInitMs);\n+        } else {\n+            loadAndInitializeAgent(agentArguments, instrumentation, premain);\n+        }\n+    }\n \n-        try {\n-            // workaround for classloader deadlock https://bugs.openjdk.java.net/browse/JDK-8194653\n-            FileSystems.getDefault();\n+    /**\n+     * Returns whether agent initialization should be delayed when occurring through the {@code premain} route.\n+     * This works around a JVM bug (https://bugs.openjdk.java.net/browse/JDK-8041920) causing JIT fatal error if\n+     * agent code causes the loading of MethodHandles prior to JIT compiler initialization.\n+     * @return {@code true} for any Java 7 and early Java 8 HotSpot JVMs, {@code false} for all others", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbbead9fa018cb75fea9be7de9ae2ed00207fbcf"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDMzOTY2OQ==", "bodyText": "\ud83d\ude0d I love being able to link to this paragraph whenever there are multiple agents. Should we do the same for -Xverify:none too ?", "url": "https://github.com/elastic/apm-agent-java/pull/1594#discussion_r564339669", "createdAt": "2021-01-26T08:49:32Z", "author": {"login": "SylvainJuge"}, "path": "docs/troubleshooting.asciidoc", "diffHunk": "@@ -18,6 +18,17 @@ IMPORTANT: If you do so, *please attach your debug logs* so that we can analyze\n Upload the *complete* logs to a service like https://gist.github.com.\n The logs should include everything from the application startup up until the first request has been executed.\n \n+[float]\n+[[trouble-shooting-additional-agent]]\n+=== Running alongside other agents\n+Like many other Java agents, our agent instruments classes by injecting bytecode into them on runtime. Our bytecode\n+instrumentation guarantees to produce only valid bytecode and to never change the class's \"schema\". If you are using\n+other Java agents in addition to ours that have the same guarantees, they should not interfere with each other.\n+However, some Java agents do not conform to these guarantees, in which case there may be issues with using them in\n+parallel to ours. If you encounter errors, one of the first things to do is to remove any additional agent in order to\n+check whether this is indeed a case of agent mismatch. We may still find a way to make them work together, but this\n+information would be cruicial for our ability to assist, so make sure to include it when reporting such issues.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbbead9fa018cb75fea9be7de9ae2ed00207fbcf"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44cfb4bda299266da7149883a1a7ab01d4fd9dd", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f44cfb4bda299266da7149883a1a7ab01d4fd9dd", "committedDate": "2021-01-26T15:48:19Z", "message": "Merge remote-tracking branch 'upstream/master' into delay-instrumentation-in-java-7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e216b984a25c8ff0c16a674e2f9562fc7548732f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e216b984a25c8ff0c16a674e2f9562fc7548732f", "committedDate": "2021-01-26T15:58:20Z", "message": "Adding to CHANGELOG and being backward compatible"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3649, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}