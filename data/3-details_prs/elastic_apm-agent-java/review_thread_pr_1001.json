{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODIwNDYz", "number": 1001, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MToxOVrODZ0SHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozNjoxNFrODa4OhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Mzk3NTk4OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MToxOVrOFgauXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MToxOVrOFgauXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjYwNw==", "bodyText": "NIT https://stackoverflow.com/questions/37056192/which-vs-command-v-in-bash\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            if ! which docker\n          \n          \n            \n            if ! command -v docker", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369536607", "createdAt": "2020-01-22T12:41:19Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Mzk3NzY1OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MTo0NlrOFgavOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MTo0NlrOFgavOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjgyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            elif ! which curl\n          \n          \n            \n            elif ! command -v curl", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369536826", "createdAt": "2020-01-22T12:41:46Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! which curl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDAwMjY4OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MDo1OVrOFga-Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MDo1OVrOFga-Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0MDY3MA==", "bodyText": "Allow passing the GIT_TAG on the environment, by default use the latest TAG\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            readonly GIT_TAG=`git describe --abbrev=0|sed s/^v//`\n          \n          \n            \n            GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n          \n          \n            \n            readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369540670", "createdAt": "2020-01-22T12:50:59Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! which curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+readonly GIT_TAG=`git describe --abbrev=0|sed s/^v//`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDAwNjQ3OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MjowNFrOFgbAWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MjowNFrOFgbAWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0MTIwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            readonly CUR_TAG=`git describe --abbrev=0|sed s/^v//`\n          \n          \n            \n            CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n          \n          \n            \n            readonly CUR_TAG=${CUR_TAG:-$CUR_TAG_DEFAULT}", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369541209", "createdAt": "2020-01-22T12:52:04Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,29 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+readonly CUR_TAG=`git describe --abbrev=0|sed s/^v//`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDA5ODg1OnYy", "diffSide": "RIGHT", "path": "CONTRIBUTING.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyMzoyMlrOFgb3tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzo1NToyMFrOFgc3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NTM4MA==", "bodyText": "IIUC, this step is not for the https://github.com/elastic/apm-agent-java/pull/1001/files#diff-6a3371457528722a734f3c51d9238c13R256 but for another Jenkins instance", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369555380", "createdAt": "2020-01-22T13:23:22Z", "author": {"login": "v1v"}, "path": "CONTRIBUTING.md", "diffHunk": "@@ -251,15 +251,16 @@ and follow [those instructions](https://github.com/elastic/docs#for-a-local-repo\n If you have access to make releases, the process is as follows:\n \n 1. Check if sonatype is up: https://status.maven.org\n-1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`. \n+1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`.\n    1. In case you want to update the version, execute `mvn release:update-versions`\n 1. Execute the release Jenkins job on the internal ci server. This job is same as the snapshot-build job, but it also:\n    1. Removes `-SNAPSHOT` from all `${project.version}` occurrences and makes a commit before build\n    1. Tags this new commit with the version name, e.g. `v1.1.0`\n    1. Advances the version for next development iteration and makes a commit\n    1. Uploads artifacts to maven central\n+   1. (Optional) If the `push_docker` parameter is set, build and push a Docker image for this release to the docker.elastic.co repo.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU3MTYwNA==", "bodyText": "That's true for the time being. We are hoping that soon we can migrate everything over here which is why I left this in but after looking at this, I think it could mislead people. I'll remove it. Thanks!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369571604", "createdAt": "2020-01-22T13:55:20Z", "author": {"login": "cachedout"}, "path": "CONTRIBUTING.md", "diffHunk": "@@ -251,15 +251,16 @@ and follow [those instructions](https://github.com/elastic/docs#for-a-local-repo\n If you have access to make releases, the process is as follows:\n \n 1. Check if sonatype is up: https://status.maven.org\n-1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`. \n+1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`.\n    1. In case you want to update the version, execute `mvn release:update-versions`\n 1. Execute the release Jenkins job on the internal ci server. This job is same as the snapshot-build job, but it also:\n    1. Removes `-SNAPSHOT` from all `${project.version}` occurrences and makes a commit before build\n    1. Tags this new commit with the version name, e.g. `v1.1.0`\n    1. Advances the version for next development iteration and makes a commit\n    1. Uploads artifacts to maven central\n+   1. (Optional) If the `push_docker` parameter is set, build and push a Docker image for this release to the docker.elastic.co repo.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NTM4MA=="}, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEwMzkyOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyNDo1OFrOFgb6yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyNDo1OFrOFgb6yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NjE2OQ==", "bodyText": "Cosmetic change :)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #!/bin/bash\n          \n          \n            \n            #!/usr/bin/env bash", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369556169", "createdAt": "2020-01-22T13:24:58Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEyNzQ1OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozMjo0NlrOFgcJGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzoyODozM1rOFiCm-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1OTgzNA==", "bodyText": "There are different env variable to know the tag name:\n\nTAG_NAME\nBRANCH_NAME\nGIT_BRANCH\n\nSome references:\n\nhttps://apm-ci.elastic.co/pipeline-syntax/globals#env\nhttps://github.com/jenkins-infra/jenkins.io/blob/master/content/doc/book/pipeline/syntax.adoc#when", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369559834", "createdAt": "2020-01-22T13:32:46Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIzODY0OQ==", "bodyText": "I modified it to use TAG_NAME if it is present in the environment. Thanks!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371238649", "createdAt": "2020-01-27T13:28:33Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1OTgzNA=="}, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEzMDY1OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozMzo0OVrOFgcLCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozMzo0OVrOFgcLCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDMyOA==", "bodyText": "Minor suggestion to avoid the download output\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n          \n          \n            \n            curl -L -s -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560328", "createdAt": "2020-01-22T13:33:49Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+echo \"INFO: Downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEzMTk5OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNDoxOVrOFgcL9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo1NTo1MFrOFhiKlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDU2NQ==", "bodyText": "Do we know this runs only when the artifact is available on Sonatype?\nWhy not using the local artifact?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560565", "createdAt": "2020-01-22T13:34:19Z", "author": {"login": "eyalkoren"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+echo \"INFO: Downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNzA5Mw==", "bodyText": "I went ahead and made using the local artifact the default. It is not present, the script presents instructions on how to re-run it with a flag set to use the Sonatype artifact.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370707093", "createdAt": "2020-01-24T15:55:50Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+echo \"INFO: Downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDU2NQ=="}, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEzMjM4OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNDoyN1rOFgcMNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNDoyN1rOFgcMNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDYyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # This script is intended to work in conjunction with the build_docker.#!/bin/sh\n          \n          \n            \n            # This script is intended to work in conjunction with the build_docker", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560629", "createdAt": "2020-01-22T13:34:27Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDEzOTQxOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNjo1MlrOFgcQwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMjozMzowM1rOFhcTRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MTc5Mw==", "bodyText": "Sometimes the docker registry can be offline or got some glitches, a retry with asleep could help?  Something similar to:\n\nhttps://github.com/elastic/apm-agent-java/blob/master/.ci/packer_cache.sh#L6", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369561793", "createdAt": "2020-01-22T13:36:52Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly CUR_TAG=${CUR_TAG:-$CUR_TAG_DEFAULT}\n+\n+# 2. Construct the image:tag that we are working with\n+# This is roughly <repo>/<namespace>/image\n+readonly DOCKER_PUSH_IMAGE=\"docker.elastic.co/apm/apm-agent-java:$CUR_TAG\"\n+\n+# 3. Proceed with pushing to the registry\n+readonly DOCKER_REGISTRY_URL=`echo $DOCKER_PUSH_IMAGE|cut -f1 -d/`\n+echo \"INFO: Pushing image $DOCKER_PUSH_IMAGE to $DOCKER_REGISTRY_URL\"\n+docker push $DOCKER_PUSH_IMAGE || echo \"Push failed. When running in \" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYxMTAxMw==", "bodyText": "Good call! I wasn't aware of the bash_standard_lib.sh inclusion in other places so this is good to know! Thanks!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370611013", "createdAt": "2020-01-24T12:33:03Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly CUR_TAG=${CUR_TAG:-$CUR_TAG_DEFAULT}\n+\n+# 2. Construct the image:tag that we are working with\n+# This is roughly <repo>/<namespace>/image\n+readonly DOCKER_PUSH_IMAGE=\"docker.elastic.co/apm/apm-agent-java:$CUR_TAG\"\n+\n+# 3. Proceed with pushing to the registry\n+readonly DOCKER_REGISTRY_URL=`echo $DOCKER_PUSH_IMAGE|cut -f1 -d/`\n+echo \"INFO: Pushing image $DOCKER_PUSH_IMAGE to $DOCKER_REGISTRY_URL\"\n+docker push $DOCKER_PUSH_IMAGE || echo \"Push failed. When running in \" \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MTc5Mw=="}, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDE0MDkzOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNzoxNlrOFgcRsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNzoxNlrOFgcRsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MjAzNQ==", "bodyText": "Cosmetic preference :)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #!/bin/bash\n          \n          \n            \n            #!/usr/bin/env bash", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369562035", "createdAt": "2020-01-22T13:37:16Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDM4NzI5OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDo0NDozMVrOFgeoow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMjozODowNlrOFhca0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ==", "bodyText": "If the docker registry instance is only for internal usage/access, what do you think to change this stage with 'Generate staging docker image' or something similar?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369600675", "createdAt": "2020-01-22T14:44:31Z", "author": {"login": "v1v"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3OTU3Ng==", "bodyText": "The goal that I believe @eyalkoren is hoping for is to have a Docker image that can be consumed by the public and is not just only for internal usage.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369779576", "createdAt": "2020-01-22T20:14:04Z", "author": {"login": "cachedout"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk1MTg5Nw==", "bodyText": "Yes, it needs to be public. We are going to publish a blog post next week telling users how it can be used as an init container in Kubernetes.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369951897", "createdAt": "2020-01-23T06:39:57Z", "author": {"login": "eyalkoren"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NjA2Ng==", "bodyText": "got it, what about 'Docker image' or Docker push as it does consist of two steps, docker build and docker push, and the aim of this stage is to publish the Docker image,?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370096066", "createdAt": "2020-01-23T12:44:58Z", "author": {"login": "v1v"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYxMjk0Nw==", "bodyText": "I changed it to Docker push per your latest suggestion. Thanks!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370612947", "createdAt": "2020-01-24T12:38:06Z", "author": {"login": "cachedout"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzUzNTEyOnYy", "diffSide": "RIGHT", "path": "Dockerfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0MzoyNlrOFg81Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMjo1OToxMFrOFhc5ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTQ1NA==", "bodyText": "NIT: could it be more accurate with the SHA reference? Just wondering if the alpine:3.9 image might be no deterministic", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370095454", "createdAt": "2020-01-23T12:43:26Z", "author": {"login": "v1v"}, "path": "Dockerfile", "diffHunk": "@@ -0,0 +1,4 @@\n+FROM alpine:3.9", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyMDc3Mg==", "bodyText": "Good idea! I have pinned this to ths SHA of Alpine 3.9. Thank you!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370620772", "createdAt": "2020-01-24T12:59:10Z", "author": {"login": "cachedout"}, "path": "Dockerfile", "diffHunk": "@@ -0,0 +1,4 @@\n+FROM alpine:3.9", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTQ1NA=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTA5NDMyOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNDowNjo0MFrOFherHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNDowOTo0MlrOFhewfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY0OTg4Nw==", "bodyText": "I'm not familiar with this env variable, where is it coming from?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370649887", "createdAt": "2020-01-24T14:06:40Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKERS+x} ]  # We are on a CI worker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2c29715265959dcbcc9b6863cc0dfd3b5609d22"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1MTI2MQ==", "bodyText": "Ugh. This is what happens when I don't get enough sleep. This is supposed to be WORKSPACE. I'll fix.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370651261", "createdAt": "2020-01-24T14:09:42Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKERS+x} ]  # We are on a CI worker", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY0OTg4Nw=="}, "originalCommit": {"oid": "f2c29715265959dcbcc9b6863cc0dfd3b5609d22"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTA5NDc0OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMTo1OFrOFiCtnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozOTozN1rOFiC7XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDM0OA==", "bodyText": "Is this required?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240348", "createdAt": "2020-01-27T13:31:58Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0Mzg2OA==", "bodyText": "Not needed. It is handled in L35 as part of the find command with the -exec flag. I will remove it for the sake of clarity.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371243868", "createdAt": "2020-01-27T13:39:37Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDM0OA=="}, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTA5NTg2OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMjoyNVrOFiCuSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMjoyNVrOFiCuSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDUyMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n          \n          \n            \n            if [ \"$(ls -A  ${PROJECT_ROOT}elastic-apm-agent/target)\" ]", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240523", "createdAt": "2020-01-27T13:32:25Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTA5NzQzOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMjo1NVrOFiCvMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMjo1NVrOFiCvMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDc1Mg==", "bodyText": "PROJECT_ROOT ends with /\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n          \n          \n            \n              find -E ${PROJECT_ROOT}elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} ${PROJECT_ROOT}apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240752", "createdAt": "2020-01-27T13:32:55Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTEwMzUwOnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozNDo0OFrOFiCyzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzo0NTo1NVrOFiDG7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MTY3Ng==", "bodyText": "Cosmetic change, what do you think to . at the very end of the docker build call ?\ndocker build -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\\n             --build-arg JAR_FILE=apm-agent-java.jar .", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371241676", "createdAt": "2020-01-27T13:34:48Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0NjgzMQ==", "bodyText": "I checked the Docker documentation and it looks like they recommend the same form that you do. I will change this to stick with that style. Thanks!", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371246831", "createdAt": "2020-01-27T13:45:55Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MTY3Ng=="}, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTEwNjQ0OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/build_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozNTo0OVrOFiC0kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzo0Mzo1MVrOFiDDIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjEzMQ==", "bodyText": "It might not be required when using the CI ephemeral workers", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371242131", "createdAt": "2020-01-27T13:35:49Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\\n+  --build-arg JAR_FILE=apm-agent-java.jar\n+\n+if [ $? -eq 0 ]\n+then\n+  echo \"INFO: Docker image built succesfully\"\n+else\n+  echo \"ERROR: Problem building Docker image!\"\n+fi\n+\n+function finish {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0NTg1OQ==", "bodyText": "When writing this, I tried to ensure that it could be cleanly run from a workstation as well. I agree that it is not needed on the workers but shouldn't cause any harm to leave it in and it ensures that a local developer's environment remains tidy if executing this script locally.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371245859", "createdAt": "2020-01-27T13:43:51Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\\n+  --build-arg JAR_FILE=apm-agent-java.jar\n+\n+if [ $? -eq 0 ]\n+then\n+  echo \"INFO: Docker image built succesfully\"\n+else\n+  echo \"ERROR: Problem building Docker image!\"\n+fi\n+\n+function finish {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjEzMQ=="}, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTEwNzg4OnYy", "diffSide": "RIGHT", "path": "scripts/jenkins/push_docker.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozNjoxNFrOFiC1Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzo1Njo1NlrOFiDdnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjMzOA==", "bodyText": "Should it use the same approach as the one for building?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371242338", "createdAt": "2020-01-27T13:36:14Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKSPACE+x} ]  # We are on a CI worker\n+then\n+  source /usr/local/bin/bash_standard_lib.sh\n+fi\n+\n+readonly RETRIES=3\n+\n+# This script is intended to work in conjunction with the build_docker\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI1MjYzNw==", "bodyText": "Fixed.", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371252637", "createdAt": "2020-01-27T13:56:56Z", "author": {"login": "cachedout"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKSPACE+x} ]  # We are on a CI worker\n+then\n+  source /usr/local/bin/bash_standard_lib.sh\n+fi\n+\n+readonly RETRIES=3\n+\n+# This script is intended to work in conjunction with the build_docker\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjMzOA=="}, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 400, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}