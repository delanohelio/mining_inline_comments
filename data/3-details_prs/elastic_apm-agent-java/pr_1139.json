{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjI2NDkx", "number": 1139, "title": "Avoid side-effects of calling Statement.getUpdateCount", "bodyText": "What does this PR do?\nCurrent instrumentation of  java.sql.Statement calls Statement.getUpdateCount() just after SQL statement execution in order to retrieve the number of modified rows by the statement.\nWhile there is a warning in Javadoc about calling this method only once, in practice most implementations allow to call it multiple times without any problem. We had integration tests that covered most common databases thus we were confident on that hypothesis.\nHowever, it seems that some database servers (or JDBC drivers) like Oracle strictly follow the specification and just allow for a single call to getUpdateCount. As a result, our agent would capture the first value, and then an invalid value would then be returned.\nImpacted applications would be those for which both statements are true\n\ncall Statement.getUpdateCount()\nuse Oracle database (or one that have similar behavior)\n\nChecklist\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\nI have made corresponding changes to the documentation\n[ x I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated CHANGELOG.asciidoc\nI have updated supported-technologies.asciidoc\nAdded an API method or config option? Document in which version this will be introduced\nAdded an instrumentation plugin? How did you make sure that old, non-supported versions are not instrumented by accident?\n\nAuthor's Checklist\n\n find an usable public oracle DB image for integration tests\n run benchmarks (especially allocation rate) and ensure that there isn't too much extra overhead.", "createdAt": "2020-04-14T14:40:23Z", "url": "https://github.com/elastic/apm-agent-java/pull/1139", "merged": true, "mergeCommit": {"oid": "42a99c2d67e862d5c2bf6abdb7544fb9317df59f"}, "closed": true, "closedAt": "2020-04-16T09:08:12Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXinZugH2gAyNDAzMjI2NDkxOmQ3ZTk5ZTQ5YzljM2Y5ZTQ5NjEwZTk0ZGU0ZTAxZDczNzExMjI1ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYIC6OgH2gAyNDAzMjI2NDkxOmY1YzUzZTk1MjEwNjM1ZThmY2M1NmQ0ZTZlMmMzZjU3MTNiYTFmZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7e99e49c9c3f9e49610e94de4e01d73711225fd", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/d7e99e49c9c3f9e49610e94de4e01d73711225fd", "committedDate": "2020-04-14T12:26:09Z", "message": "make jdbc test compatible with Oracle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b637487eb399f37ec754fd75d04c2afaa6e3e3ce", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b637487eb399f37ec754fd75d04c2afaa6e3e3ce", "committedDate": "2020-04-14T12:36:59Z", "message": "re-enable oracle for jdbc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16846a29f300d63f94b07a71f21c288c1dd447d5", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/16846a29f300d63f94b07a71f21c288c1dd447d5", "committedDate": "2020-04-14T14:19:46Z", "message": "implement & fix getUpdateCount side effect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b39d8e687da81e35ae71d9907a872324ebb986e8", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b39d8e687da81e35ae71d9907a872324ebb986e8", "committedDate": "2020-04-14T14:45:34Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4c6dcc5b4cb52b0c95b70309187823d031bcc0", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/2a4c6dcc5b4cb52b0c95b70309187823d031bcc0", "committedDate": "2020-04-14T15:43:56Z", "message": "disable workaround for idempotent impl."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDAwMDAw", "url": "https://github.com/elastic/apm-agent-java/pull/1139#pullrequestreview-393000000", "createdAt": "2020-04-14T14:45:23Z", "commit": {"oid": "16846a29f300d63f94b07a71f21c288c1dd447d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo0NToyM1rOGFSMrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo0NToyM1rOGFSMrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5NDIyMg==", "bodyText": "Enter advice not needed when moving this to exit advice?", "url": "https://github.com/elastic/apm-agent-java/pull/1139#discussion_r408194222", "createdAt": "2020-04-14T14:45:23Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-jdbc-plugin/src/main/java/co/elastic/apm/agent/jdbc/StatementInstrumentation.java", "diffHunk": "@@ -413,4 +411,47 @@ public static void onAfterExecute(@Advice.This Statement statement,\n         }\n \n     }\n+\n+\n+    /**\n+     * Instruments:\n+     * <ul>\n+     *     <li>{@link Statement#getUpdateCount()}</li>\n+     * </ul>\n+     */\n+    public static class GetUpdateCountInstrumentation extends StatementInstrumentation {\n+\n+        public GetUpdateCountInstrumentation(ElasticApmTracer tracer) {\n+            super(tracer,\n+                named(\"getUpdateCount\")\n+                    .and(takesArguments(0))\n+                    .and(isPublic())\n+            );\n+        }\n+\n+        @Advice.OnMethodEnter(suppress = Throwable.class)\n+        private static int onEnter(@Advice.This Statement statement) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16846a29f300d63f94b07a71f21c288c1dd447d5"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a31cf1be2641d129fa2ef78c40afe0924b0d460", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0a31cf1be2641d129fa2ef78c40afe0924b0d460", "committedDate": "2020-04-15T09:08:26Z", "message": "post-review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c53e95210635e8fcc56d4e6e2c3f5713ba1fd9", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f5c53e95210635e8fcc56d4e6e2c3f5713ba1fd9", "committedDate": "2020-04-16T08:02:41Z", "message": "Merge branch 'master' into avoid-getUpdateCount-side-effects"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3931, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}