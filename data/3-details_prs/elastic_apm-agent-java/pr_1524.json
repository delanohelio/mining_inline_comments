{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0Nzk5OTcz", "number": 1524, "title": "Fix spring resttemplate 3.0 support", "bodyText": "What does this PR do?\nFixes #1519 - ClassNotFoundError thrown when using older spring-web versions and the spring-resttemplate plugin is active.\nClientHttpRequest only has a #getURI method after version 3.0.3, thus we can't support early 3.0.{0,1,2} versions.\n\n3.0.0\n3.0.3\n\nFor the few unsupported versions, the span is not created and a debug message is logged.\nThis also adds integration tests for all the major/minor versions (but not the complete 140+ patch versions).\nFor those, a separate module was required in order to ensure that tested dependencies are in the isolated test classloader.\n\nUpdate:\nSupport will be limited to versions 3.1.1+ as our instrumentation also relies on the getRawStatusCode that is not available before.\nChecklist\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\nAdded an API method or config option? Document in which version this will be introduced\n I have made corresponding changes to the documentation", "createdAt": "2020-11-20T16:03:18Z", "url": "https://github.com/elastic/apm-agent-java/pull/1524", "merged": true, "mergeCommit": {"oid": "8f17345ca724956a567703e332fef9c2a7eddc00"}, "closed": true, "closedAt": "2020-11-25T15:01:52Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeU3GfgH2gAyNTI0Nzk5OTczOjNiYzRiNTkzNDNlMzU1YWE0YjdlODA2YzMxZjBkMDU4NzA3NDcwODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf-W02AH2gAyNTI0Nzk5OTczOmZhMzgyYzkzMTQyNTcxMDg1OTgwMzM1NTY3NmMwNGFkZTIwYzQ4NzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bc4b59343e355aa4b7e806c31f0d05870747083", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3bc4b59343e355aa4b7e806c31f0d05870747083", "committedDate": "2020-11-20T10:33:15Z", "message": "fix springgemplate for spring 3.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2521536cb62b23624dd9e8173fe40cda8446c8d", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b2521536cb62b23624dd9e8173fe40cda8446c8d", "committedDate": "2020-11-20T15:41:16Z", "message": "fix compatibility with old spring-resttemplate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d5ad610d709dee7a7376f1d020180b1ecf83e3", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f9d5ad610d709dee7a7376f1d020180b1ecf83e3", "committedDate": "2020-11-20T15:47:55Z", "message": "junit5-ify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1943d84fa8bd53461e1af43d784cf7eedfe0c1", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4e1943d84fa8bd53461e1af43d784cf7eedfe0c1", "committedDate": "2020-11-20T15:57:50Z", "message": "log debug msg & avoid exception on unsupported version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "committedDate": "2020-11-20T16:13:06Z", "message": "update changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTcwNDMz", "url": "https://github.com/elastic/apm-agent-java/pull/1524#pullrequestreview-535570433", "createdAt": "2020-11-20T16:17:50Z", "commit": {"oid": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNjoxNzo1MFrOH3WZ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNjoxODozOVrOH3Wbyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMDgxOQ==", "bodyText": "Better to make sure we don't instrument Spring RestTemplate < 3.0.3", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r527800819", "createdAt": "2020-11-20T16:17:50Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-restemplate-plugin/src/main/java/co/elastic/apm/agent/resttemplate/SpringRestTemplateAdvice.java", "diffHunk": "@@ -46,11 +47,22 @@\n     @Advice.OnMethodEnter(suppress = Throwable.class, inline = false)\n     public static Object beforeExecute(@Advice.This ClientHttpRequest request) {\n         logger.trace(\"Enter advice for method {}#execute()\", request.getClass().getName());\n-        if (TracerAwareInstrumentation.tracer.getActive() == null) {\n+\n+        final AbstractSpan<?> parent = TracerAwareInstrumentation.tracer.getActive();\n+        if (parent == null) {\n             return null;\n         }\n-        final AbstractSpan<?> parent = TracerAwareInstrumentation.tracer.getActive();\n-        Span span = HttpClientHelper.startHttpClientSpan(parent, Objects.toString(request.getMethod()), request.getURI(), request.getURI().getHost());\n+        URI uri = null;\n+        String host = \"unknown\";\n+        try {\n+            uri = request.getURI();\n+        } catch (NoSuchMethodError ignored) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTI5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |3.0.6+\n          \n          \n            \n            |3.0.3+", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r527801290", "createdAt": "2020-11-20T16:18:39Z", "author": {"login": "felixbarny"}, "path": "docs/supported-technologies.asciidoc", "diffHunk": "@@ -252,7 +252,7 @@ The spans are named after the schema `<method> <host>`, for example `GET elastic\n | 1.6.0\n \n |Spring RestTemplate\n-|4+\n+|3.0.6+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91a19329a603eb2341e1f07a87fa75694695f2af", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/91a19329a603eb2341e1f07a87fa75694695f2af", "committedDate": "2020-11-20T16:27:00Z", "message": "Update docs/supported-technologies.asciidoc\n\nCo-authored-by: Felix Barnsteiner <felixbarny@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e410eb08f775eb136396075152e62f209688c290", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e410eb08f775eb136396075152e62f209688c290", "committedDate": "2020-11-20T17:19:57Z", "message": "only instrument spring 3.0.3+"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjE0MzYz", "url": "https://github.com/elastic/apm-agent-java/pull/1524#pullrequestreview-536214363", "createdAt": "2020-11-23T07:13:55Z", "commit": {"oid": "e410eb08f775eb136396075152e62f209688c290"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzoxMzo1NVrOH4BR5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzoxNjoyMFrOH4BVaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwMzI3MQ==", "bodyText": "Did you manually test 3.0.0 to see that the agent no-ops and does not throw exceptions?", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528503271", "createdAt": "2020-11-23T07:13:55Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-resttemplate-test/src/test/java/co.elastic.apm.agent.resttemplate/SpringRestTemplateVersionsIT.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.resttemplate;\n+\n+import co.elastic.apm.agent.TestClassWithDependencyRunner;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class SpringRestTemplateVersionsIT {\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+        \"3.0.3.RELEASE\", // lower versions are not supported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e410eb08f775eb136396075152e62f209688c290"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwNDE2OA==", "bodyText": "How can we make sure we're always testing against the latest spring version as they get released? Maybe use a version range here or update the spring version via dependabot?", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528504168", "createdAt": "2020-11-23T07:16:20Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-restemplate-plugin/pom.xml", "diffHunk": "@@ -3,16 +3,16 @@\n     <modelVersion>4.0.0</modelVersion>\n \n     <parent>\n-        <artifactId>apm-agent-plugins</artifactId>\n         <groupId>co.elastic.apm</groupId>\n+        <artifactId>apm-spring-resttemplate</artifactId>\n         <version>1.19.1-SNAPSHOT</version>\n     </parent>\n \n     <artifactId>apm-spring-resttemplate-plugin</artifactId>\n     <name>${project.groupId}:${project.artifactId}</name>\n \n     <properties>\n-        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+        <apm-agent-parent.base.dir>${project.basedir}/../../..</apm-agent-parent.base.dir>\n     </properties>\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e410eb08f775eb136396075152e62f209688c290"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6bfb2c85e8ac3fcd79d07a3c34cdb8f2b562643", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e6bfb2c85e8ac3fcd79d07a3c34cdb8f2b562643", "committedDate": "2020-11-23T10:25:56Z", "message": "limit support to Spring 3.1.1+"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "449e1c96fc171a134a87aa4991089288a78baee6", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/449e1c96fc171a134a87aa4991089288a78baee6", "committedDate": "2020-11-23T10:27:09Z", "message": "update documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e200372012bf8bdb8d6f051945023643a1b1b268", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e200372012bf8bdb8d6f051945023643a1b1b268", "committedDate": "2020-11-23T10:33:03Z", "message": "javadoc + cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4ca6bebda3ac7da364ca1b7a74741da6f5022ea1", "committedDate": "2020-11-23T10:54:20Z", "message": "using version range to test latest versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzY3NjUx", "url": "https://github.com/elastic/apm-agent-java/pull/1524#pullrequestreview-536367651", "createdAt": "2020-11-23T11:04:00Z", "commit": {"oid": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Mzc0Mzc2", "url": "https://github.com/elastic/apm-agent-java/pull/1524#pullrequestreview-537374376", "createdAt": "2020-11-24T10:56:50Z", "commit": {"oid": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo1Njo1MFrOH47RFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo1Njo1MFrOH47RFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ1MzMzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <module>apm-spring-restemplate-plugin</module>\n          \n          \n            \n                    <module>apm-spring-resttemplate-plugin</module>", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r529453333", "createdAt": "2020-11-24T10:56:50Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-spring-resttemplate/pom.xml", "diffHunk": "@@ -0,0 +1,24 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>co.elastic.apm</groupId>\n+        <artifactId>apm-agent-plugins</artifactId>\n+        <version>1.19.1-SNAPSHOT</version>\n+    </parent>\n+\n+    <artifactId>apm-spring-resttemplate</artifactId>\n+    <name>${project.groupId}:${project.artifactId}</name>\n+    <packaging>pom</packaging>\n+\n+    <properties>\n+        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+    </properties>\n+\n+    <modules>\n+        <module>apm-spring-restemplate-plugin</module>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22f76f9babc220f46d8ca1c16929a0ba5f3085f", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c22f76f9babc220f46d8ca1c16929a0ba5f3085f", "committedDate": "2020-11-25T08:55:58Z", "message": "naming folders and package is hard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58941c6185d35603c40293a823ab54ec73d926f5", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/58941c6185d35603c40293a823ab54ec73d926f5", "committedDate": "2020-11-25T10:53:00Z", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-springmvc-3.0-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDA2MzY3", "url": "https://github.com/elastic/apm-agent-java/pull/1524#pullrequestreview-538406367", "createdAt": "2020-11-25T11:33:36Z", "commit": {"oid": "58941c6185d35603c40293a823ab54ec73d926f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa382c931425710859803355676c04ade20c4871", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/fa382c931425710859803355676c04ade20c4871", "committedDate": "2020-11-25T13:27:56Z", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-springmvc-3.0-support"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3599, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}