{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NTM4NDI0", "number": 1015, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODoxMjowN1rODb0_dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDo1OFrODfcWQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTA2MzU2OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODoxMjowN1rOFjiUjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo1Njo0N1rOFkm_lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw==", "bodyText": "I don't think we need this API, it doesn't save much to the caller (only extract the ID). The one returning the ErrorCapture is very useful as is.\nI can easily imaging how a caller may want to do lots of other stuff with the ErrorCapture and we wouldn't add an API for each usage.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372806797", "createdAt": "2020-01-30T08:12:07Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -320,7 +321,14 @@ public void captureException(long epochMicros, @Nullable Throwable e, TraceConte\n         captureException(epochMicros, e, parent, null);\n     }\n \n-    public void captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+    @Nullable\n+    public String captureExceptionAndGetErrorId(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTcwMQ==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931701", "createdAt": "2020-02-03T05:55:40Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -320,7 +321,14 @@ public void captureException(long epochMicros, @Nullable Throwable e, TraceConte\n         captureException(epochMicros, e, parent, null);\n     }\n \n-    public void captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+    @Nullable\n+    public String captureExceptionAndGetErrorId(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTkyNw==", "bodyText": "added documentation", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931927", "createdAt": "2020-02-03T05:56:47Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -320,7 +321,14 @@ public void captureException(long epochMicros, @Nullable Throwable e, TraceConte\n         captureException(epochMicros, e, parent, null);\n     }\n \n-    public void captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+    @Nullable\n+    public String captureExceptionAndGetErrorId(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTA3ODA5OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/ElasticApmTracerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODoxNzo1MlrOFjidJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo1NTo0OFrOFkm-4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwODk5Nw==", "bodyText": "Better call transaction.captureException, then you test both added methods.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372808997", "createdAt": "2020-01-30T08:17:52Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/ElasticApmTracerTest.java", "diffHunk": "@@ -489,4 +490,17 @@ void testOverrideServiceNameExplicitServiceName() {\n         tracer.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader()).end();\n         assertThat(reporter.getFirstTransaction().getTraceContext().getServiceName()).isNull();\n     }\n+\n+    @Test\n+    void testCaptureExceptionAndGetErrorId() {\n+        Transaction transaction = tracerImpl.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader());\n+        String errorId = tracerImpl.captureExceptionAndGetErrorId(System.currentTimeMillis() * 1000, new Exception(\"test\"), transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTc0NQ==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931745", "createdAt": "2020-02-03T05:55:48Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/ElasticApmTracerTest.java", "diffHunk": "@@ -489,4 +490,17 @@ void testOverrideServiceNameExplicitServiceName() {\n         tracer.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader()).end();\n         assertThat(reporter.getFirstTransaction().getTraceContext().getServiceName()).isNull();\n     }\n+\n+    @Test\n+    void testCaptureExceptionAndGetErrorId() {\n+        Transaction transaction = tracerImpl.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader());\n+        String errorId = tracerImpl.captureExceptionAndGetErrorId(System.currentTimeMillis() * 1000, new Exception(\"test\"), transaction);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwODk5Nw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTExNzU5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-api-plugin/src/main/java/co/elastic/apm/agent/plugin/api/AbstractSpanInstrumentation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODozNDowNFrOFji1kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo1NjoxMlrOFkm_Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxNTI1MA==", "bodyText": "This probably won't work when a user upgrades the agent and not the API (a very valid scenario)- the agent will instrument the captureException API that returns void and the instrumentation will expect a String being returned.\nWhat you need to do is change the constructor of this class, so that the method matcher is more specific on the return type, probably something like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.VOID)) and add another CaptureExceptionWithReturnIdInstrumentation class that uses a method matcher like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.STRING)) and does what you did here.\nEventually, you must test your branch's agent with an older API jar, and you should test your branch's API jar with an older agent. We don't have automatic tests for that, but should be easy to do manually.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372815250", "createdAt": "2020-01-30T08:34:04Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-api-plugin/src/main/java/co/elastic/apm/agent/plugin/api/AbstractSpanInstrumentation.java", "diffHunk": "@@ -178,8 +178,9 @@ public CaptureExceptionInstrumentation() {\n         @VisibleForAdvice\n         @Advice.OnMethodExit(suppress = Throwable.class)\n         public static void captureException(@Advice.FieldValue(value = \"span\", typing = Assigner.Typing.DYNAMIC) TraceContextHolder<?> context,\n-                                            @Advice.Argument(0) Throwable t) {\n-            context.captureException(t);\n+                                            @Advice.Argument(0) Throwable t,\n+                                            @Advice.Return(readOnly = false) String errorId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTgxMA==", "bodyText": "added new method captureExceptionAndReturnErrorId", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931810", "createdAt": "2020-02-03T05:56:12Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-api-plugin/src/main/java/co/elastic/apm/agent/plugin/api/AbstractSpanInstrumentation.java", "diffHunk": "@@ -178,8 +178,9 @@ public CaptureExceptionInstrumentation() {\n         @VisibleForAdvice\n         @Advice.OnMethodExit(suppress = Throwable.class)\n         public static void captureException(@Advice.FieldValue(value = \"span\", typing = Assigner.Typing.DYNAMIC) TraceContextHolder<?> context,\n-                                            @Advice.Argument(0) Throwable t) {\n-            context.captureException(t);\n+                                            @Advice.Argument(0) Throwable t,\n+                                            @Advice.Return(readOnly = false) String errorId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxNTI1MA=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNjM3NDczOnYy", "diffSide": "RIGHT", "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNToxODo1M1rOFjuzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNTo0MTo0MVrOFlY4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw==", "bodyText": "Technically, this is a breaking change in binary compatibility. When not re-compiling the application and updating the dependency, it would result in an exception when calling the method. That is because methods are linked also based on their return type.\nBut still think we can leave it as-is as most likely, someone would re-compile the application again after updating the dependency to the agent API.\nA more conservative option would be to create a method with a different name, like captureExceptionAndReturnErrorId and leave void captureException(Throwable throwable) as-is.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373011293", "createdAt": "2020-01-30T15:18:53Z", "author": {"login": "felixbarny"}, "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyOTg0NQ==", "bodyText": "Good point!\nI agree it's best to leave as is (meaning - just change the method signature) and not to complicate the API for this corner case.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373829845", "createdAt": "2020-02-02T08:52:17Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTg2MQ==", "bodyText": "added new method", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931861", "createdAt": "2020-02-03T05:56:30Z", "author": {"login": "kananindzya"}, "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc0OTIzMw==", "bodyText": "I think you got us wrong. While there is a corner case for a potential breaking change, just leave captureException as the method name to not clutter the API too much.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r374749233", "createdAt": "2020-02-04T15:41:41Z", "author": {"login": "felixbarny"}, "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mjk2ODAwOnYy", "diffSide": "RIGHT", "path": "docs/public-api.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDoyN1rOFpJghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDoyN1rOFpJghA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5MTcxNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Captures an exception and reports it to the APM server. Returns the id of reported error.\n          \n          \n            \n            Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r378691716", "createdAt": "2020-02-13T07:34:27Z", "author": {"login": "eyalkoren"}, "path": "docs/public-api.asciidoc", "diffHunk": "@@ -382,8 +382,8 @@ transaction.setUser(user.getId(), user.getEmail(), user.getUsername());\n \n [float]\n [[api-transaction-capture-exception]]\n-==== `void captureException(Exception e)`\n-Captures an exception and reports it to the APM server.\n+==== `String captureException(Exception e)`\n+Captures an exception and reports it to the APM server. Returns the id of reported error.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mjk2ODk4OnYy", "diffSide": "RIGHT", "path": "docs/public-api.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDo1OFrOFpJhHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDo1OFrOFpJhHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5MTg3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Captures an exception and reports it to the APM server. Returns the id of reported error.\n          \n          \n            \n            Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r378691871", "createdAt": "2020-02-13T07:34:58Z", "author": {"login": "eyalkoren"}, "path": "docs/public-api.asciidoc", "diffHunk": "@@ -666,8 +666,8 @@ span.addLabel(\"foo\", \"bar\");\n \n [float]\n [[api-span-capture-exception]]\n-==== `void captureException(Exception e)`\n-Captures an exception and reports it to the APM server.\n+==== `String captureException(Exception e)`\n+Captures an exception and reports it to the APM server. Returns the id of reported error.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 410, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}