{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4ODI2NjEw", "number": 1050, "title": "Issue 846 add errorid to mdc", "bodyText": "What does this PR do?\n\ncloses #846\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n\nAuthor's Checklist\n\nRelated issues\n\nUse cases\n\nScreenshots", "createdAt": "2020-02-24T06:14:30Z", "url": "https://github.com/elastic/apm-agent-java/pull/1050", "merged": true, "mergeCommit": {"oid": "b61ba4a2610e52a5625bba934bdf4861af42604c"}, "closed": true, "closedAt": "2020-04-01T11:09:48Z", "author": {"login": "kananindzya"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMJ8rqAH2gAyMzc4ODI2NjEwOmQ2YjcwNDUyNjg3ZmZjZjc2YzVjNDhhNTczNzBiMDIzMmQ0NDIwMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTVtxtgFqTM4NTQ4MzI3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6b70452687ffcf76c5c48a57370b0232d44200c", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/d6b70452687ffcf76c5c48a57370b0232d44200c", "committedDate": "2020-03-10T03:28:36Z", "message": "added preventing the shade plugin from relocating org.slf4j.Logger to *.shaded.slf4j.Logger in error logging instrumentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c28fbc125b26bf204227146f717e187f8480109", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/8c28fbc125b26bf204227146f717e187f8480109", "committedDate": "2020-03-10T03:28:36Z", "message": "local"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1691984ea49685d0a42f153a96b72fe81dbfcf", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/ef1691984ea49685d0a42f153a96b72fe81dbfcf", "committedDate": "2020-03-10T03:28:36Z", "message": "ErrorCapture implement TraceContextHolder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "940d8b0982a01a5db48f59ef7b9321982dd0892f", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/940d8b0982a01a5db48f59ef7b9321982dd0892f", "committedDate": "2020-03-10T03:28:36Z", "message": "feature added error id to mdc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a09971f10c2175c252a9008db9f16c22739988", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/76a09971f10c2175c252a9008db9f16c22739988", "committedDate": "2020-03-10T04:34:28Z", "message": "added IT for mdc actionvation listener for error id capture"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e0ed11da8f5e1e2177c92d4eb0ccab76796ee3e", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/2e0ed11da8f5e1e2177c92d4eb0ccab76796ee3e", "committedDate": "2020-02-24T06:11:52Z", "message": "feature added error id to mdc"}, "afterCommit": {"oid": "76a09971f10c2175c252a9008db9f16c22739988", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/76a09971f10c2175c252a9008db9f16c22739988", "committedDate": "2020-03-10T04:34:28Z", "message": "added IT for mdc actionvation listener for error id capture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/93ab45d725148adeafb9b2ee37b359af0cfa444c", "committedDate": "2020-03-10T06:33:52Z", "message": "deleted jsf snapshot info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODQzNDgw", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-371843480", "createdAt": "2020-03-10T10:43:42Z", "commit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0Mzo0MlrOF0JoNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMTowMDozN1rOF0KLeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODAyMg==", "bodyText": "Actually, the MDC should be empty here. Only within the logger.error, the MDC should be set. This is a bit tricky to test but you could mock the org.slf4j.Logger interface with Mockito:\nLogger logger = mock(Logger.class);\n...\nwhen(logger.error(anyString(), any(Exception.class)).then(invocation -> assertMdcErrorIdIsNotBlank());\n\nAs a return type is expected for the Answer lambda, change the return type form private void assertMdcErrorIdIsEmpty() to Void and return null from this method.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228022", "createdAt": "2020-03-10T10:43:42Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODI0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n          \n          \n            \n               void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228247", "createdAt": "2020-03-10T10:44:07Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODMyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n          \n          \n            \n               void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228325", "createdAt": "2020-03-10T10:44:16Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();\n+        transaction.end();\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMTE5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log4jMdcWorking = true;\n          \n          \n            \n                    Assumptions.assumeTrue(() -> {\n          \n          \n            \n                        org.apache.log4j.MDC.put(\"test\", true);\n          \n          \n            \n                        return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n          \n          \n            \n                    }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390231193", "createdAt": "2020-03-10T10:49:47Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();\n+        transaction.end();\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        log4jMdcWorking = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMTY3OA==", "bodyText": "Remove this. Use assumptions instead. See testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390231678", "createdAt": "2020-03-10T10:50:38Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMzcxOA==", "bodyText": "As ActivationListeners are now called for ErrorCaptures, change ProfilingActivationListener:\n        if (!context.isSampled() || context instanceof ErrorCapture) {\n            return;\n        }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390233718", "createdAt": "2020-03-10T10:54:35Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -37,12 +37,13 @@\n \n import javax.annotation.Nullable;\n import java.util.Collection;\n+import java.util.concurrent.Callable;\n \n \n /**\n  * Data captured by an agent representing an event occurring in a monitored service\n  */\n-public class ErrorCapture implements Recyclable {\n+public class ErrorCapture extends TraceContextHolder<ErrorCapture> implements Recyclable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNDg4NQ==", "bodyText": "tracer cannot be null. It's not annotated with @Nullable and it's a final field, initialized in the constructor from a constructed parameter which is not @Nullable.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (tracer != null && context instanceof ErrorCapture) {\n          \n          \n            \n                                if (context instanceof ErrorCapture) {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390234885", "createdAt": "2020-03-10T10:56:37Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (tracer != null && context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNTUzNA==", "bodyText": "Also add a test for logging errors which are not within a transaction.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390235534", "createdAt": "2020-03-10T10:57:47Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNjcyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new UnsupportedOperationException();\n          \n          \n            \n                    return getTraceContext().isChildOf(other);\n          \n      \n    \n    \n  \n\nThis can also be pulled up to TraceContextHolder", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390236726", "createdAt": "2020-03-10T10:59:59Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    @Nullable\n+    public Span createSpan(long epochMicros) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public boolean isChildOf(TraceContextHolder other) {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNzA1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new UnsupportedOperationException();\n          \n          \n            \n                    throw new UnsupportedOperationException(\"Creating a span as a child of an error is not possible\");", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390237050", "createdAt": "2020-03-10T11:00:37Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a941e9b0ee22c0f5e65c20336888b748f0ef17b", "author": {"user": {"login": "kananindzya", "name": "Nugusbayev Kanagat"}}, "url": "https://github.com/elastic/apm-agent-java/commit/6a941e9b0ee22c0f5e65c20336888b748f0ef17b", "committedDate": "2020-03-11T09:04:21Z", "message": "Update apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09f441be0b050fb93a5448f1ac34f63fa24c1de", "author": {"user": {"login": "kananindzya", "name": "Nugusbayev Kanagat"}}, "url": "https://github.com/elastic/apm-agent-java/commit/d09f441be0b050fb93a5448f1ac34f63fa24c1de", "committedDate": "2020-03-11T09:04:35Z", "message": "Update apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "181126b0712f8ec528d728ad01a5da324f659ce8", "author": {"user": {"login": "kananindzya", "name": "Nugusbayev Kanagat"}}, "url": "https://github.com/elastic/apm-agent-java/commit/181126b0712f8ec528d728ad01a5da324f659ce8", "committedDate": "2020-03-11T09:04:51Z", "message": "Update apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/2ebcdcbe0905335592e3af7907b4908e2f00848f", "committedDate": "2020-03-11T12:06:35Z", "message": "fixed according to comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzA3MjMz", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-372707233", "createdAt": "2020-03-11T12:20:16Z", "commit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyMDoxNlrOF00kug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyMDoxNlrOF00kug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzMTY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Test", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390931642", "createdAt": "2020-03-11T12:20:16Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/test/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchRestClientInstrumentationIT.java", "diffHunk": "@@ -20,6 +20,7 @@\n  * KIND, either express or implied.  See the License for the\n  * specific language governing permissions and limitations\n  * under the License.\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzEyMTE2", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-372712116", "createdAt": "2020-03-11T12:27:53Z", "commit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyNzo1NFrOF00zHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyOTo1MlrOF0027Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNTMyNg==", "bodyText": "to remove the error.id after capturing the error\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (tracer.getActive() == null) {\n          \n          \n            \n                                    remove.invokeExact(TRACE_ID);\n          \n          \n            \n                                    remove.invokeExact(TRANSACTION_ID);\n          \n          \n            \n                                    remove.invokeExact(ERROR_ID);\n          \n          \n            \n                                }\n          \n          \n            \n                                if (context instanceof ErrorCapture) {\n          \n          \n            \n                                    remove.invokeExact(ERROR_ID);\n          \n          \n            \n                                } else if (tracer.getActive() == null) {\n          \n          \n            \n                                    remove.invokeExact(TRACE_ID);\n          \n          \n            \n                                    remove.invokeExact(TRANSACTION_ID);\n          \n          \n            \n                                }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390935326", "createdAt": "2020-03-11T12:27:54Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -173,6 +177,7 @@ public void afterDeactivate(TraceContextHolder<?> deactivatedContext) throws Thr\n                     if (tracer.getActive() == null) {\n                         remove.invokeExact(TRACE_ID);\n                         remove.invokeExact(TRANSACTION_ID);\n+                        remove.invokeExact(ERROR_ID);\n                     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNjMwMQ==", "bodyText": "to support errors that don't happen within a transaction:\n                    if (context instanceof ErrorCapture) {\n                        put.invoke(ERROR_ID, traceContext.getId().toString());\n                    } else if (tracer.getActive() == null) {\n                        TraceContext traceContext = context.getTraceContext();\n                        put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                        put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                    }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390936301", "createdAt": "2020-03-11T12:29:52Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/328277ff8209c9f47f0f826a6504c3081c6d662f", "committedDate": "2020-03-12T05:37:53Z", "message": "fixed according to comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzI1NDAz", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373325403", "createdAt": "2020-03-12T07:26:09Z", "commit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzoyNjowOVrOF1TlGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzozMDozMlrOF1Tq2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n          \n          \n            \n                public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391439642", "createdAt": "2020-03-12T07:26:09Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDU0MQ==", "bodyText": "Just remove that condition \ud83d\ude42\nIt's ok to provide if tracer.getActive() returns null. Just make the parameter @Nullable (see other suggestion in ElasticApmTracer).", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391440541", "createdAt": "2020-03-12T07:28:43Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNTUzNA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDY3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));\n          \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391440671", "createdAt": "2020-03-12T07:29:10Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MTExNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n          \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391441114", "createdAt": "2020-03-12T07:30:32Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzQ5OTMw", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373349930", "createdAt": "2020-03-12T08:18:30Z", "commit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxODozMFrOF1UyVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxODozMFrOF1UyVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTQxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                @Advice.This Object thiz,\n          \n          \n            \n                                                @Advice.Origin Class<?> clazz,", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391459414", "createdAt": "2020-03-12T08:18:30Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzUwMjI2", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373350226", "createdAt": "2020-03-12T08:19:03Z", "commit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxOTowM1rOF1UzOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxOTowM1rOF1UzOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            error = tracer.captureException(exception, tracer.getActive(), thiz.getClass().getClassLoader()).activate();\n          \n          \n            \n                            error = tracer.captureException(exception, tracer.getActive(), clazz.getClassLoader()).activate();", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391459642", "createdAt": "2020-03-12T08:19:03Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,\n+                                    @Advice.Local(\"error\") @Nullable ErrorCapture error) {\n             if (tracer == null || tracer.getActive() == null) {\n                 return;\n             }\n             nested = nestedThreadLocal.get();\n             if (!nested) {\n-                tracer.getActive().captureException(exception);\n+                error = tracer.captureException(exception, tracer.getActive(), thiz.getClass().getClassLoader()).activate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b1ceff98d5664685baa12e2fa24d894ea4b5f25", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/9b1ceff98d5664685baa12e2fa24d894ea4b5f25", "committedDate": "2020-03-12T08:34:15Z", "message": "fixed according to comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/7f3271122e44a769e0100afed94776e0d1eb3cc6", "committedDate": "2020-03-12T08:37:56Z", "message": "fixed accordingto comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDUzMjQy", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373453242", "createdAt": "2020-03-12T10:53:41Z", "commit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo0MVrOF1ZxIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo0MVrOF1ZxIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTAyNg==", "bodyText": "This if can be removed, as we're using assumptions in the test methods now. The way assumptions work is similar to assertions but instead of failing the test, they just skip the test.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541026", "createdAt": "2020-03-12T10:53:41Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDUzMzk0", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373453394", "createdAt": "2020-03-12T10:53:55Z", "commit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo1NVrOF1Zxog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo1NVrOF1Zxog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTE1NA==", "bodyText": "remove this, too", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541154", "createdAt": "2020-03-12T10:53:55Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {\n+            assertThat(org.apache.log4j.MDC.get(\"error.id\")).isNull();\n+        }\n+    }\n+\n+    private Answer<Void> assertMdcErrorIdIsNotEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNotBlank();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDU0MTY0", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373454164", "createdAt": "2020-03-12T10:55:06Z", "commit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1NTowNlrOF1Z0EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1NTowNlrOF1Z0EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTc3Ng==", "bodyText": "Do the  || context instanceof ErrorCapture check on afterDeactivate as well.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541776", "createdAt": "2020-03-12T10:55:06Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/ProfilingActivationListener.java", "diffHunk": "@@ -46,7 +47,7 @@ public ProfilingActivationListener(ElasticApmTracer tracer) {\n \n     @Override\n     public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n-        if (!context.isSampled()) {\n+        if (!context.isSampled() || context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDU0NDk1", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373454495", "createdAt": "2020-03-12T10:55:36Z", "commit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/a3a301a2c101ace712a6a04c87994940f0e72112", "committedDate": "2020-03-12T11:14:46Z", "message": "fixed according to comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDc4NDUx", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-373478451", "createdAt": "2020-03-12T11:34:43Z", "commit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTE5NzU0", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-376919754", "createdAt": "2020-03-18T14:31:19Z", "commit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDozMToxOVrOF4Hq5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0NToyN1rOF4IVOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5MDI0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        reporter.report(errorCapture);\n          \n          \n            \n                        errorCapture.end();\n          \n      \n    \n    \n  \n\nLooks like complicating stuff, but there is a good reason for that: there is an implicit lifecycle effect here, where this object is going to be recycled when reported. It's easy to make lifecycle mistakes when it is managed implicitly, as indeed was the case here (see the comment below).\nIn general, calling reporter.report(errorCapture) should be done from a single location and this code should make it clear that we end the object.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394390245", "createdAt": "2020-03-18T14:31:19Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5ODE1Mg==", "bodyText": "This is a setup for race conditions- once you call report another thread may recycle the ErrorCapture object, so you return an object in an unknown state. There cannot be an API that reports an error AND returns it. You can do this instead:\n    @Nullable\n    public String captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n        String id = null;\n        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n        if (errorCapture != null) {\n            id = errorCapture.getTraceContext().getId().toString();\n            errorCapture.end();\n        }\n        return id;\n    }\n\nI think that would do what you need from it.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394398152", "createdAt": "2020-03-18T14:41:34Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMDIyNg==", "bodyText": "This one can be made private", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394400226", "createdAt": "2020-03-18T14:44:14Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;\n+    }\n+\n+    @Nullable\n+    public ErrorCapture captureException(@Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+        return captureException(System.currentTimeMillis() * 1000, e, parent, initiatingClassLoader);\n     }\n \n     @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMTA4Mw==", "bodyText": "This is a race condition (see above). If you change the method as suggested, it would be safe.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394401083", "createdAt": "2020-03-18T14:45:27Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceContextHolder.java", "diffHunk": "@@ -168,7 +168,7 @@ public T captureException(@Nullable Throwable t) {\n \n     @Nullable\n     public String captureExceptionAndGetErrorId(@Nullable Throwable t) {\n-        ErrorCapture errorCapture = tracer.captureException(getTraceContext().getClock().getEpochMicros(), t, this);\n+        ErrorCapture errorCapture = tracer.captureAndReportException(getTraceContext().getClock().getEpochMicros(), t, this);\n         return errorCapture != null ? errorCapture.getTraceContext().getId().toString() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a98cddfc3a5359ebcf5a85ca5b6d1d8f2ae08f8b", "author": {"user": {"login": "kananindzya", "name": "Nugusbayev Kanagat"}}, "url": "https://github.com/elastic/apm-agent-java/commit/a98cddfc3a5359ebcf5a85ca5b6d1d8f2ae08f8b", "committedDate": "2020-03-31T10:25:51Z", "message": "Update apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e281a024ca8befa6c84281ce263c106fe1512b1", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/7e281a024ca8befa6c84281ce263c106fe1512b1", "committedDate": "2020-03-31T11:13:07Z", "message": "fixed according to comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "130a95896f4eac13b9980a2d06b01943cfcda217", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/130a95896f4eac13b9980a2d06b01943cfcda217", "committedDate": "2020-03-31T11:14:40Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-846-add-errorid-to-mdc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5afcaad3bc2db7261d380ddd3c67f4d5d91f5476", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/5afcaad3bc2db7261d380ddd3c67f4d5d91f5476", "committedDate": "2020-03-31T11:45:15Z", "message": "added info for asciidoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "936ed1a7d4417513c8d0aa780c0504414c266067", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/936ed1a7d4417513c8d0aa780c0504414c266067", "committedDate": "2020-03-31T14:16:34Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-846-add-errorid-to-mdc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a599a45fe3ce1fe5ad3bfa2a6bc51c4d5c64cba", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/9a599a45fe3ce1fe5ad3bfa2a6bc51c4d5c64cba", "committedDate": "2020-03-31T16:16:30Z", "message": "generated configration.asciidoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15d75c9383d7bc85247be38dd10f553518c37d0f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/15d75c9383d7bc85247be38dd10f553518c37d0f", "committedDate": "2020-04-01T09:34:30Z", "message": "Fixing docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc70b91f589a1d6425a24745cf568b5bc56e86d5", "author": {"user": {"login": "kananindzya", "name": "Nugusbayev Kanagat"}}, "url": "https://github.com/elastic/apm-agent-java/commit/fc70b91f589a1d6425a24745cf568b5bc56e86d5", "committedDate": "2020-04-01T10:00:30Z", "message": "Merge pull request #4 from eyalkoren/docs-fixes\n\nFixing docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDgzMjc5", "url": "https://github.com/elastic/apm-agent-java/pull/1050#pullrequestreview-385483279", "createdAt": "2020-04-01T11:08:39Z", "commit": {"oid": "fc70b91f589a1d6425a24745cf568b5bc56e86d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4107, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}