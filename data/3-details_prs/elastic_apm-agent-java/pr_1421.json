{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NzU5NjQ5", "number": 1421, "title": "Enabling disabled_metrics config for Micrometer", "bodyText": "What does this PR do?\nEnabling the disable_metrics config for Micrometer.\nContext - https://discuss.elastic.co/t/failed-to-transform-sample-model-sample/249962.\n\nChecklist\n\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n\n\n This is a new plugin\n\n I have updated CHANGELOG.asciidoc\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? Describe how you made sure that old, non-supported versions are not instrumented by accident.\n\n\n This is something else\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-09-29T11:26:29Z", "url": "https://github.com/elastic/apm-agent-java/pull/1421", "merged": true, "mergeCommit": {"oid": "c609815ea80cc56733e638df8c97cd20249dad4d"}, "closed": true, "closedAt": "2020-09-30T07:52:53Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNmXrDAH2gAyNDk0NzU5NjQ5OmZjNTUxOWM1MmU1YjUwNjE0NmU1YTU3MTNlMTBjZThiNDk0ZjY5NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN3o0igFqTQ5OTE1MjA4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc5519c52e5b506146e5a5713e10ce8b494f6951", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/fc5519c52e5b506146e5a5713e10ce8b494f6951", "committedDate": "2020-09-29T11:20:30Z", "message": "Enabling disabled_metrics config for Micrometer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzY5MzQx", "url": "https://github.com/elastic/apm-agent-java/pull/1421#pullrequestreview-498369341", "createdAt": "2020-09-29T11:27:19Z", "commit": {"oid": "fc5519c52e5b506146e5a5713e10ce8b494f6951"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMToyNzoyMFrOHZomLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMToyNzoyMFrOHZomLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0MTU4MQ==", "bodyText": "You think it worth caching already encountered metrics, so that we don't match a potentially long list of matchers?", "url": "https://github.com/elastic/apm-agent-java/pull/1421#discussion_r496641581", "createdAt": "2020-09-29T11:27:20Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-micrometer-plugin/src/main/java/co/elastic/apm/agent/micrometer/MicrometerMetricsReporter.java", "diffHunk": "@@ -97,11 +99,21 @@ public void run() {\n     }\n \n     private static class MeterMapConsumer implements Consumer<Meter> {\n+\n+        private final List<WildcardMatcher> disabledMetrics;\n+\n+        public MeterMapConsumer(List<WildcardMatcher> disabledMetrics) {\n+            this.disabledMetrics = disabledMetrics;\n+        }\n+\n         final Map<Meter.Id, Meter> meters = new HashMap<>();\n \n         @Override\n         public void accept(Meter meter) {\n-            meters.put(meter.getId(), meter);\n+            Meter.Id meterId = meter.getId();\n+            if (WildcardMatcher.anyMatch(disabledMetrics, meterId.getName()) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5519c52e5b506146e5a5713e10ce8b494f6951"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Mzc3OTk0", "url": "https://github.com/elastic/apm-agent-java/pull/1421#pullrequestreview-498377994", "createdAt": "2020-09-29T11:39:46Z", "commit": {"oid": "fc5519c52e5b506146e5a5713e10ce8b494f6951"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTozOTo0N1rOHZo_cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTozOTo0N1rOHZo_cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0ODA1MA==", "bodyText": "I think compared to the actual serialization of the metrics the matching is not likely to be significant.\nand idea to make it a bit more readable\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (WildcardMatcher.anyMatch(disabledMetrics, meterId.getName()) == null) {\n          \n          \n            \n                        if (WildcardMatcher.isNoneMatch(disabledMetrics, meterId.getName())) {", "url": "https://github.com/elastic/apm-agent-java/pull/1421#discussion_r496648050", "createdAt": "2020-09-29T11:39:47Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-micrometer-plugin/src/main/java/co/elastic/apm/agent/micrometer/MicrometerMetricsReporter.java", "diffHunk": "@@ -97,11 +99,21 @@ public void run() {\n     }\n \n     private static class MeterMapConsumer implements Consumer<Meter> {\n+\n+        private final List<WildcardMatcher> disabledMetrics;\n+\n+        public MeterMapConsumer(List<WildcardMatcher> disabledMetrics) {\n+            this.disabledMetrics = disabledMetrics;\n+        }\n+\n         final Map<Meter.Id, Meter> meters = new HashMap<>();\n \n         @Override\n         public void accept(Meter meter) {\n-            meters.put(meter.getId(), meter);\n+            Meter.Id meterId = meter.getId();\n+            if (WildcardMatcher.anyMatch(disabledMetrics, meterId.getName()) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5519c52e5b506146e5a5713e10ce8b494f6951"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec97ac9f12788dd6e9a290a453e7e5b446f12bf0", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ec97ac9f12788dd6e9a290a453e7e5b446f12bf0", "committedDate": "2020-09-29T11:49:33Z", "message": "Apply review suggestion and add to CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "265b24c70957720a890c5131fd9478b5b878795b", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/265b24c70957720a890c5131fd9478b5b878795b", "committedDate": "2020-09-30T04:21:10Z", "message": "Merge remote-tracking branch 'upstream/master' into disable_micrometer_metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTUyMDg1", "url": "https://github.com/elastic/apm-agent-java/pull/1421#pullrequestreview-499152085", "createdAt": "2020-09-30T07:27:37Z", "commit": {"oid": "265b24c70957720a890c5131fd9478b5b878795b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3677, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}