{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Nzk1NDM5", "number": 1271, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTozNToxOVrOENvSLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoxMToxNlrOEN1g1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODQxNjQ2OnYy", "diffSide": "RIGHT", "path": "integration-tests/external-plugin-test/pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTozNToxOVrOGwgwrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTozNToxOVrOGwgwrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUyMTU4MA==", "bodyText": "[minor] add one blank line between two dependencies to make it more clear that the comment above only applies to the dependency above. Also, adding a small comment to explain why apm-agent-core:test-jar below is required. As we would likely point to this plugin for documentation/reference that might help.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453521580", "createdAt": "2020-07-13T09:35:19Z", "author": {"login": "SylvainJuge"}, "path": "integration-tests/external-plugin-test/pom.xml", "diffHunk": "@@ -0,0 +1,79 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>integration-tests</artifactId>\n+        <groupId>co.elastic.apm</groupId>\n+        <version>1.17.1-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>external-plugin-test</artifactId>\n+    <name>${project.groupId}:${project.artifactId}</name>\n+\n+    <properties>\n+        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+    </properties>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-plugin-sdk</artifactId>\n+            <version>${project.version}</version>\n+            <scope>provided</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-api</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+\n+        <!--\n+        this is needed so that the apm-api-plugin instruments apm-agent-api to inject the actual implementation\n+        not doing this will return noop transactions in the tests\n+        -->\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>elastic-apm-agent</artifactId>\n+            <version>${project.version}</version>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODQ1MDU1OnYy", "diffSide": "RIGHT", "path": "integration-tests/external-plugin-test/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwOTo0MzoyMFrOGwhD5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMTo1OTowMVrOGxQfsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUyNjUwMA==", "bodyText": "[question] do we have to ensure proper include/exclude here ? what about compile-time dependencies that plugin might have and should not be embedded in the final jar ?", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453526500", "createdAt": "2020-07-13T09:43:20Z", "author": {"login": "SylvainJuge"}, "path": "integration-tests/external-plugin-test/pom.xml", "diffHunk": "@@ -0,0 +1,79 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>integration-tests</artifactId>\n+        <groupId>co.elastic.apm</groupId>\n+        <version>1.17.1-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>external-plugin-test</artifactId>\n+    <name>${project.groupId}:${project.artifactId}</name>\n+\n+    <properties>\n+        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+    </properties>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-plugin-sdk</artifactId>\n+            <version>${project.version}</version>\n+            <scope>provided</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-api</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+\n+        <!--\n+        this is needed so that the apm-api-plugin instruments apm-agent-api to inject the actual implementation\n+        not doing this will return noop transactions in the tests\n+        -->\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>elastic-apm-agent</artifactId>\n+            <version>${project.version}</version>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-core</artifactId>\n+            <type>test-jar</type>\n+            <version>${project.version}</version>\n+            <scope>test</scope>\n+        </dependency>\n+    </dependencies>\n+\n+    <build>\n+        <plugins>\n+            <!--", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMwMzY2NA==", "bodyText": "Any compile-time dependency has to be included into the final jar. I've added an example.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454303664", "createdAt": "2020-07-14T11:59:01Z", "author": {"login": "felixbarny"}, "path": "integration-tests/external-plugin-test/pom.xml", "diffHunk": "@@ -0,0 +1,79 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>integration-tests</artifactId>\n+        <groupId>co.elastic.apm</groupId>\n+        <version>1.17.1-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>external-plugin-test</artifactId>\n+    <name>${project.groupId}:${project.artifactId}</name>\n+\n+    <properties>\n+        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+    </properties>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-plugin-sdk</artifactId>\n+            <version>${project.version}</version>\n+            <scope>provided</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-api</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+\n+        <!--\n+        this is needed so that the apm-api-plugin instruments apm-agent-api to inject the actual implementation\n+        not doing this will return noop transactions in the tests\n+        -->\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>elastic-apm-agent</artifactId>\n+            <version>${project.version}</version>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>apm-agent-core</artifactId>\n+            <type>test-jar</type>\n+            <version>${project.version}</version>\n+            <scope>test</scope>\n+        </dependency>\n+    </dependencies>\n+\n+    <build>\n+        <plugins>\n+            <!--", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUyNjUwMA=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTE5NjAyOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzoxNjo1OFrOGwoEFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMToyNjo1MVrOGxPhzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0MTIzOQ==", "bodyText": "[question] Do we enforce/ensure that an instrumentation class is always loaded from the same classloader ? For example if we need to deal with plugin dependencies we might have to deal with cross-plugin classloader visibility instead of having classes loaded in multiple plugin classloaders.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453641239", "createdAt": "2020-07-13T13:16:58Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -161,6 +204,9 @@ private static synchronized void initInstrumentation(final ElasticApmTracer trac\n         if (!tracer.getConfig(CoreConfiguration.class).isEnabled()) {\n             return;\n         }\n+        for (ElasticApmInstrumentation apmInstrumentation : instrumentations) {\n+            pluginClassLoaderByAdviceClass.put(apmInstrumentation.getAdviceClass().getName(), apmInstrumentation.getClass().getClassLoader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI4NzgyMg==", "bodyText": "Not sure I understand. External plugins never depend on any other plugins. All internal plugins are loaded from the same classloader (currently the bootstrap CL). They may only depend on plugins that are always loaded from the bootstrap CL, such as the concurrent plugin, or on plugins that have the same package name (for example apm-kafka-headers-plugin and apm-kafka-base-plugin).", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454287822", "createdAt": "2020-07-14T11:26:51Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -161,6 +204,9 @@ private static synchronized void initInstrumentation(final ElasticApmTracer trac\n         if (!tracer.getConfig(CoreConfiguration.class).isEnabled()) {\n             return;\n         }\n+        for (ElasticApmInstrumentation apmInstrumentation : instrumentations) {\n+            pluginClassLoaderByAdviceClass.put(apmInstrumentation.getAdviceClass().getName(), apmInstrumentation.getClass().getClassLoader());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0MTIzOQ=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTIwMDkzOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzoxODowOFrOGwoHBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMzoyN1rOGxSr3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0MTk5MA==", "bodyText": "[minor] might be relevant to throw/log an error if it's not the case.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453641990", "createdAt": "2020-07-13T13:18:08Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -325,8 +371,10 @@ public boolean matches(TypeDescription typeDescription, ClassLoader classLoader,\n         if (offsetMapping != null) {\n             withCustomMapping = withCustomMapping.bind(offsetMapping);\n         }\n-        if (instrumentation.indyPlugin()) {\n-            validateAdvice(instrumentation.getAdviceClass().getName());\n+        // external plugins are always indy plugins\n+        if (!(instrumentation instanceof TracerAwareInstrumentation)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzOTU0OQ==", "bodyText": "The instrumentation might be an instance of ElasticApmInstrumentation, indicating that it's an external plugin and thus and indy plugin by default.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454339549", "createdAt": "2020-07-14T13:03:27Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -325,8 +371,10 @@ public boolean matches(TypeDescription typeDescription, ClassLoader classLoader,\n         if (offsetMapping != null) {\n             withCustomMapping = withCustomMapping.bind(offsetMapping);\n         }\n-        if (instrumentation.indyPlugin()) {\n-            validateAdvice(instrumentation.getAdviceClass().getName());\n+        // external plugins are always indy plugins\n+        if (!(instrumentation instanceof TracerAwareInstrumentation)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0MTk5MA=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTIyMzE1OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzoyMzoxNlrOGwoUaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMToyMTowNFrOGxPWRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0NTQxNw==", "bodyText": "[question] do we have to deal with concurrent access to this map and list of classloaders ?", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453645417", "createdAt": "2020-07-13T13:23:16Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -114,6 +119,8 @@\n     private static final WeakConcurrentMap<Class<?>, Set<Collection<Class<? extends ElasticApmInstrumentation>>>> dynamicallyInstrumentedClasses = WeakMapSupplier.createMap();\n     @Nullable\n     private static File agentJarFile;\n+    private static final List<ClassLoader> pluginClassLoaders = new ArrayList<>();\n+    private static final Map<String, ClassLoader> pluginClassLoaderByAdviceClass = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI4NDg2OQ==", "bodyText": "Yes, we do, good catch! Seems we can also replace pluginClassLoaders with a local variable.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454284869", "createdAt": "2020-07-14T11:21:04Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/ElasticApmAgent.java", "diffHunk": "@@ -114,6 +119,8 @@\n     private static final WeakConcurrentMap<Class<?>, Set<Collection<Class<? extends ElasticApmInstrumentation>>>> dynamicallyInstrumentedClasses = WeakMapSupplier.createMap();\n     @Nullable\n     private static File agentJarFile;\n+    private static final List<ClassLoader> pluginClassLoaders = new ArrayList<>();\n+    private static final Map<String, ClassLoader> pluginClassLoaderByAdviceClass = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0NTQxNw=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTI3NTM4OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/util/PackageScannerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzozNToxMVrOGwozqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMTo0NDoxMVrOGxQDZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1MzQxNg==", "bodyText": "[minor] probably missing some tests with an isolated classloader to cover usage for external plugins.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453653416", "createdAt": "2020-07-13T13:35:11Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/util/PackageScannerTest.java", "diffHunk": "@@ -33,21 +34,21 @@\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI5NjQyMg==", "bodyText": "External plugins are not package scanned. We're scanning for class files via java.util.jar.JarFile#entries in the constructor of ExternalPluginClassLoader.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454296422", "createdAt": "2020-07-14T11:44:11Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/util/PackageScannerTest.java", "diffHunk": "@@ -33,21 +34,21 @@\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1MzQxNg=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTI5OTQwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0MDo0NFrOGwpCVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0MDo0NFrOGwpCVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NzE3Mw==", "bodyText": "[minor] missing some Javadoc", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453657173", "createdAt": "2020-07-13T13:40:44Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.sdk;\n+\n+import java.util.Collection;\n+import java.util.ServiceLoader;\n+\n+public interface DynamicTransformer {\n+\n+    void ensureInstrumented(Class<?> classToInstrument, Collection<Class<? extends ElasticApmInstrumentation>> instrumentationClasses);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTMwODc4OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0Mjo0NFrOGwpHzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0Mjo0NFrOGwpHzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1ODU3NA==", "bodyText": "[minor] probably worth adding some details what this class provides and why we have a ServiceLoader indirection.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453658574", "createdAt": "2020-07-13T13:42:44Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.sdk;\n+\n+import java.util.Collection;\n+import java.util.ServiceLoader;\n+\n+public interface DynamicTransformer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTMyMzA5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0NTo0N1rOGwpQeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMTo0OToxOFrOGxQNGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MDc5Mg==", "bodyText": "[minor] do we expect to have more than one implementation here ?", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453660792", "createdAt": "2020-07-13T13:45:47Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.sdk;\n+\n+import java.util.Collection;\n+import java.util.ServiceLoader;\n+\n+public interface DynamicTransformer {\n+\n+    void ensureInstrumented(Class<?> classToInstrument, Collection<Class<? extends ElasticApmInstrumentation>> instrumentationClasses);\n+\n+    class Accessor {\n+        private static final DynamicTransformer transformer;\n+\n+        static {\n+            ClassLoader classLoader = Accessor.class.getClassLoader();\n+            if (classLoader == null) {\n+                classLoader = ClassLoader.getSystemClassLoader();\n+            }\n+            transformer = ServiceLoader.load(DynamicTransformer.class, classLoader).iterator().next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI5ODkwNA==", "bodyText": "No, just one but we want to reverse the dependency: This class should not have to know the implementation as it's part of the SDK.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454298904", "createdAt": "2020-07-14T11:49:18Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugin-sdk/src/main/java/co/elastic/apm/agent/sdk/DynamicTransformer.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.sdk;\n+\n+import java.util.Collection;\n+import java.util.ServiceLoader;\n+\n+public interface DynamicTransformer {\n+\n+    void ensureInstrumented(Class<?> classToInstrument, Collection<Class<? extends ElasticApmInstrumentation>> instrumentationClasses);\n+\n+    class Accessor {\n+        private static final DynamicTransformer transformer;\n+\n+        static {\n+            ClassLoader classLoader = Accessor.class.getClassLoader();\n+            if (classLoader == null) {\n+                classLoader = ClassLoader.getSystemClassLoader();\n+            }\n+            transformer = ServiceLoader.load(DynamicTransformer.class, classLoader).iterator().next();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MDc5Mg=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTMzNzgyOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/bci/InstrumentationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0OToxMFrOGwpZqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMTozMDo1MlrOGxPpjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MzE0NQ==", "bodyText": "[question] why override with return false when it's already what parent class implementation does ?", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453663145", "createdAt": "2020-07-13T13:49:10Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/bci/InstrumentationTest.java", "diffHunk": "@@ -487,9 +511,14 @@ public static String onMethodExit() {\n         public Collection<String> getInstrumentationGroupNames() {\n             return List.of(\"test\", \"experimental\");\n         }\n+\n+        @Override\n+        public boolean indyPlugin() {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI4OTgwNQ==", "bodyText": "idk tbh. Might have been caused by an automatic refactoring or an oversight", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454289805", "createdAt": "2020-07-14T11:30:52Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/bci/InstrumentationTest.java", "diffHunk": "@@ -487,9 +511,14 @@ public static String onMethodExit() {\n         public Collection<String> getInstrumentationGroupNames() {\n             return List.of(\"test\", \"experimental\");\n         }\n+\n+        @Override\n+        public boolean indyPlugin() {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2MzE0NQ=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTM1NzgwOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/HelperClassManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo1Mzo0MlrOGwpmFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo1Mzo0MlrOGwpmFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NjMyNQ==", "bodyText": "[minor] final modifier might be avoided for consistency in method signature", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453666325", "createdAt": "2020-07-13T13:53:42Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/HelperClassManager.java", "diffHunk": "@@ -286,7 +285,7 @@ private synchronized T loadAndReferenceHelper(Class<?> classOfTargetClassLoader)\n          * Creates an isolated CL that has two parents: the target class loader and the agent CL.\n          * The agent class loader is currently the bootstrap CL but in the future it will be an isolated CL that is a child of the bootstrap CL.\n          */\n-        public synchronized static ClassLoader getOrCreatePluginClassLoader(@Nullable ClassLoader targetClassLoader, List<String> classesToInject, ElementMatcher<? super TypeDescription> exclusionMatcher) throws Exception {\n+        public synchronized static ClassLoader getOrCreatePluginClassLoader(@Nullable ClassLoader targetClassLoader, List<String> classesToInject, final ClassLoader parent, ElementMatcher<? super TypeDescription> exclusionMatcher) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTQxODg5OnYy", "diffSide": "RIGHT", "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDowNzowOVrOGwqLPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjoyNjo1M1rOGxRYsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTgzOQ==", "bodyText": "[minor] might also be interesting to have an example that extends TracerAwareInstrumentation as relying on API is not the only option.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453675839", "createdAt": "2020-07-13T14:07:09Z", "author": {"login": "SylvainJuge"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMxODI1OQ==", "bodyText": "We explicitly don't want external plugins to depend on internal APIs. While it's not strictly enforced or forbidden, I think we shouldn't promote it and also not list plugins depending on the internal API in the plugin registry/supported technologies page.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454318259", "createdAt": "2020-07-14T12:26:53Z", "author": {"login": "felixbarny"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTgzOQ=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTQyNjU0OnYy", "diffSide": "RIGHT", "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDowODo1OVrOGwqQCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozMDoyMlrOGxRhDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NzA2Ng==", "bodyText": "[minor] if we use this plugin as an example, that's not the canonical way to deal with configuration as it does not provides proper documentation. A comment to explain it's a shortcut might be relevant.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453677066", "createdAt": "2020-07-13T14:08:59Z", "author": {"login": "SylvainJuge"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_class\", \"co.elastic.apm.plugin.PluginInstrumentationTest\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMDM5OA==", "bodyText": "External plugins currently can't plug into the configuration mechanism.\nAllowing that would make stagemonitor-configuration part of our public API which I don't feel confident to do as it's not maintained anymore and the latest version is not Java 7 compatible. So we might consider forking it in the future.\n\nas it does not provides proper documentation\n\nas the plugins are external, we wouldn't have documentation for that on our page anyways", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454320398", "createdAt": "2020-07-14T12:30:22Z", "author": {"login": "felixbarny"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_class\", \"co.elastic.apm.plugin.PluginInstrumentationTest\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NzA2Ng=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTQzNzAyOnYy", "diffSide": "RIGHT", "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoxMToxNlrOGwqWRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozMjozOFrOGxRmUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3ODY2MQ==", "bodyText": "[question] why can't we have Transaction directly in the advice signature ? is that to avoid leaking an extra type in the instrumented class stack frames ?", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r453678661", "createdAt": "2020-07-13T14:11:16Z", "author": {"login": "SylvainJuge"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_class\", \"co.elastic.apm.plugin.PluginInstrumentationTest\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_method\", \"traceMe\"));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singletonList(\"test-plugin\");\n+    }\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class, inline = false)\n+    public static Object onEnter(@Advice.Origin(value = \"#m\") String methodName) {\n+        return ElasticApm.startTransaction().setName(methodName);\n+    }\n+\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class, inline = false)\n+    public static void onExit(@Advice.Thrown Throwable thrown, @Advice.Enter Object transactionObject) {\n+        Transaction transaction = (Transaction) transactionObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMTc0Ng==", "bodyText": "That's correct. The Transaction type is not available form the context of the instrumented class and would throw a NoClassDefFoundError if the signature contained agent types. Not referencing agent types is enforced in co.elastic.apm.agent.bci.ElasticApmAgent#validateAdviceReturnAndParameterTypes.", "url": "https://github.com/elastic/apm-agent-java/pull/1271#discussion_r454321746", "createdAt": "2020-07-14T12:32:38Z", "author": {"login": "felixbarny"}, "path": "integration-tests/external-plugin-test/src/main/java/co/elastic/apm/plugin/PluginInstrumentation.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.plugin;\n+\n+import co.elastic.apm.agent.sdk.ElasticApmInstrumentation;\n+import co.elastic.apm.api.ElasticApm;\n+import co.elastic.apm.api.Transaction;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+public class PluginInstrumentation extends ElasticApmInstrumentation {\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_class\", \"co.elastic.apm.plugin.PluginInstrumentationTest\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+        return named(System.getProperty(\"elastic.apm.plugin.instrumented_method\", \"traceMe\"));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singletonList(\"test-plugin\");\n+    }\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class, inline = false)\n+    public static Object onEnter(@Advice.Origin(value = \"#m\") String methodName) {\n+        return ElasticApm.startTransaction().setName(methodName);\n+    }\n+\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class, inline = false)\n+    public static void onExit(@Advice.Thrown Throwable thrown, @Advice.Enter Object transactionObject) {\n+        Transaction transaction = (Transaction) transactionObject;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3ODY2MQ=="}, "originalCommit": {"oid": "cfe73eec0ea28a6604b42f9da60b15d0ed39b8e0"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 151, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}