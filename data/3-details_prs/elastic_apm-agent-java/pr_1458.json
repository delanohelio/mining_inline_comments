{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNzYyMTUz", "number": 1458, "title": "Bootstrap lookup fix", "bodyText": "What does this PR do?\n\nFixes #1450\nChecklist\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n\n\n\nI've tried creating a test for this (see 9dcaff3) but gave up.\nThe problem is that the instrumented class will be defined by the system class loader which is also a parent of the IndyPluginClassLoader as it\u2019s the agent class loader in unit tests. Thus, the IndyPluginClassLoader will load the instrumented class from the system class loader before trying to load from the custom class loader. That\u2019s because we want to give precedence to load classes in the agent class loader.\nThis results in a linkage error as the class resolved by the IndyPluginClassLoader is not the same as the one from the custom class loader whose parent is the bootstrap class loader.\nThe test also requires that the signature of the advice contains a class that's defined in two different class loader hierarchies. But that class must not be within the package co.elastic.apm.* as these are not available in production in the context of the instrumented methods.", "createdAt": "2020-10-27T13:40:53Z", "url": "https://github.com/elastic/apm-agent-java/pull/1458", "merged": true, "mergeCommit": {"oid": "98707982806d720666c57e60f87c54de46220e93"}, "closed": true, "closedAt": "2020-10-27T16:14:47Z", "author": {"login": "felixbarny"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWo8FaAH2gAyNTEwNzYyMTUzOjlkY2FmZjMwZmMwNzJkNWE5OThhNWQzNzQwNmEwZTYwYzBjMDQzYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWp8uIAFqTUxNzc3NTgyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9dcaff30fc072d5a998a5d37406a0e60c0c043aa", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/9dcaff30fc072d5a998a5d37406a0e60c0c043aa", "committedDate": "2020-10-27T13:25:24Z", "message": "Fix MethodHandle lookup in indy bootstrap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7cc61deaf0062f86a49ce1912257cadb84d8be0", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/f7cc61deaf0062f86a49ce1912257cadb84d8be0", "committedDate": "2020-10-27T13:27:03Z", "message": "Remove non-functioning tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "053be345343a2f1c80a42ac36e480cc51c10b8a2", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/053be345343a2f1c80a42ac36e480cc51c10b8a2", "committedDate": "2020-10-27T13:31:10Z", "message": "Restore throw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3272cd1a67d270eed7cdbb36c0636c4cb99b58c", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/a3272cd1a67d270eed7cdbb36c0636c4cb99b58c", "committedDate": "2020-10-27T13:41:25Z", "message": "Add changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NzMxMTQ3", "url": "https://github.com/elastic/apm-agent-java/pull/1458#pullrequestreview-517731147", "createdAt": "2020-10-27T13:56:43Z", "commit": {"oid": "a3272cd1a67d270eed7cdbb36c0636c4cb99b58c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMzo1Njo0NFrOHo9gtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMzo1NzozM1rOHo9jeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcxMjg4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        pluginClasses.add(LookupExposer.class.getName());\n          \n          \n            \n                        pluginClasses.add(\"co.elastic.apm.agent.bci.classloading.LookupExposer\");\n          \n      \n    \n    \n  \n\nLet's only load it from the plugin class loaders.", "url": "https://github.com/elastic/apm-agent-java/pull/1458#discussion_r512712887", "createdAt": "2020-10-27T13:56:44Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/IndyBootstrap.java", "diffHunk": "@@ -272,12 +274,13 @@ public static ConstantCallSite bootstrap(MethodHandles.Lookup lookup,\n             MethodHandle instrumentedMethod = args.length >= 5 ? (MethodHandle) args[4] : null;\n \n             ClassLoader adviceClassLoader = ElasticApmAgent.getClassLoader(adviceClassName);\n-            List<String> pluginClasses;\n+            List<String> pluginClasses = new ArrayList<>();\n             if (adviceClassLoader instanceof ExternalPluginClassLoader) {\n-                pluginClasses = ((ExternalPluginClassLoader) adviceClassLoader).getClassNames();\n+                pluginClasses.addAll(((ExternalPluginClassLoader) adviceClassLoader).getClassNames());\n             } else {\n-                pluginClasses = getClassNamesFromBundledPlugin(adviceClassName, adviceClassLoader);\n+                pluginClasses.addAll(getClassNamesFromBundledPlugin(adviceClassName, adviceClassLoader));\n             }\n+            pluginClasses.add(LookupExposer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3272cd1a67d270eed7cdbb36c0636c4cb99b58c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcxMzU5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Class<LookupExposer> lookupExposer = (Class<LookupExposer>) pluginClassLoader.loadClass(LookupExposer.class.getName());\n          \n          \n            \n                        Class<LookupExposer> lookupExposer = (Class<LookupExposer>) pluginClassLoader.loadClass(\"co.elastic.apm.agent.bci.classloading.LookupExposer\");", "url": "https://github.com/elastic/apm-agent-java/pull/1458#discussion_r512713594", "createdAt": "2020-10-27T13:57:33Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/IndyBootstrap.java", "diffHunk": "@@ -287,7 +290,10 @@ public static ConstantCallSite bootstrap(MethodHandles.Lookup lookup,\n                     // also, this plugin is used as a dependency in other plugins\n                     .or(nameStartsWith(\"co.elastic.apm.agent.concurrent\")));\n             Class<?> adviceInPluginCL = pluginClassLoader.loadClass(adviceClassName);\n-            MethodHandle methodHandle = MethodHandles.lookup().findStatic(adviceInPluginCL, adviceMethodName, adviceMethodType);\n+            Class<LookupExposer> lookupExposer = (Class<LookupExposer>) pluginClassLoader.loadClass(LookupExposer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3272cd1a67d270eed7cdbb36c0636c4cb99b58c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28869ad5f0bbbd256ff6fdbbf5c1c9de9d324a37", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/28869ad5f0bbbd256ff6fdbbf5c1c9de9d324a37", "committedDate": "2020-10-27T14:09:52Z", "message": "Apply suggestions from code review\n\nCo-authored-by: eyalkoren <41850454+eyalkoren@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Nzc1ODIz", "url": "https://github.com/elastic/apm-agent-java/pull/1458#pullrequestreview-517775823", "createdAt": "2020-10-27T14:36:00Z", "commit": {"oid": "28869ad5f0bbbd256ff6fdbbf5c1c9de9d324a37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3694, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}