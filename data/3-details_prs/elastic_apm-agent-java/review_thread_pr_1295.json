{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyNjgzNjU2", "number": 1295, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToxMjoyNlrOEQk0GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo0MjoyMlrOEQ-MBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODE1ODMyOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToxMjoyNlrOG0zNtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNjozNjo0MlrOG1UqyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ==", "bodyText": "This is called each time any event is processed from the queue when server_urls is empty, correct?\nWhat is the purpose of flipping active and inactive metric sets in this case? Note it doesn't reset the counters and timers as that's only done during serialization. Conflating serialization and metrics resetting is probably a code smell and that's on me. But do we have to reset the metrics at all? If so, I think this also resets even if a span is reported, for example, which doesn't feel right. Or is this serving an entirely different purpose?\nDocumenting the purpose here would help.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458018229", "createdAt": "2020-07-21T11:12:26Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzNjk2OQ==", "bodyText": "This is called each time any event is processed from the queue when server_urls is empty, correct?\n\nNo, every time a metrics event is reported - https://github.com/elastic/apm-agent-java/pull/1295/files#diff-517f2e7d31c3425c5ec7719efd32a06dR151.\nThe purpose is to continue collecting metrics in the right intervals, because the server_urls is a dynamic config.\n\nNote it doesn't reset the counters and timers as that's only done during serialization.\n\nRight. I was going to look into that next. What do you say simply replacing the buffers with new ones, as in:\n    public void resetBuffers() {\n        try {\n            phaser.readerLock();\n            inactiveMetricSets = activeMetricSets;\n            activeMetricSets = new ConcurrentHashMap<>();\n            phaser.flipPhase();\n        } finally {\n            phaser.readerUnlock();\n        }\n    }\n\n\nDocumenting the purpose here would help.\n\n\ud83d\udc4d", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458036969", "createdAt": "2020-07-21T11:50:05Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ=="}, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3MTM2Mw==", "bodyText": "simply replacing the buffers with new ones\n\nThat won't work for gauges that still need to remain in the registry. Having to re-add transaction timers would also increase the allocation rate.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458071363", "createdAt": "2020-07-21T12:52:34Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ=="}, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2NjI2MA==", "bodyText": "@felixbarny check out the last commit. I separated reset from reporting. It costs a bit more because of the additional iteration, but since it is done as a secluded read-lock-operation, I think it's lightweight enough to worth the code simplification (especially now that we need to do that when not reporting as well).\nI would even go further with providing a separate resetState operation for the MetricRegistry, but since it needs to be done on the same read-operation critical section with buffer switch and reporting, I didn't.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458566260", "createdAt": "2020-07-22T06:36:30Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ=="}, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2NjM0NQ==", "bodyText": "Added tests as well", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458566345", "createdAt": "2020-07-22T06:36:42Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -172,6 +172,18 @@ public void report(MetricsReporter metricsReporter) {\n         }\n     }\n \n+    public void resetBuffers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxODIyOQ=="}, "originalCommit": {"oid": "0e5ac06e29811bb128b4824d38207c795bd538d1"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjMxNTU4OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo0MjoyMlrOG1a7IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo0MjoyMlrOG1a7IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY2ODgzMw==", "bodyText": "[minor] maybe call it flip phase and report to be consistent with the reader-writer-phaser terminology? the word buffer is not used elsewhere in this class.", "url": "https://github.com/elastic/apm-agent-java/pull/1295#discussion_r458668833", "createdAt": "2020-07-22T09:42:22Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/metrics/MetricRegistry.java", "diffHunk": "@@ -159,14 +159,30 @@ public DoubleSupplier getGauge(String name, Labels labels) {\n         return null;\n     }\n \n-    public void report(MetricsReporter metricsReporter) {\n+    /**\n+     * Executes the following steps within a single read-operation critical section:\n+     * <ul>\n+     *     <li>Switch between active and inactive MetricSet buffers</li>\n+     *     <li>Report the inactivated buffer (optional)</li>\n+     *     <li>Reset the inactivated buffer</li>\n+     * </ul>\n+     *\n+     * @param metricsReporter a reporter to be used for reporting the inactivated metrics buffer. May be {@code null}\n+     *                        if reporting is not required.\n+     */\n+    public void switchBuffersAndReport(@Nullable MetricsReporter metricsReporter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71156e7f960defd505f3dae8145aab055f30f783"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 160, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}