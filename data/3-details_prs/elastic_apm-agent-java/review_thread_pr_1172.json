{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMTAxNTgx", "number": 1172, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODowNzo1MFrOD5Gpmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo0OTozOVrOD5VJEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjA0Mzc4OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODowNzo1MFrOGQMACg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODowNzo1MFrOGQMACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYyNzAxOA==", "bodyText": "Not sure how to add a proper test making sure the context in the methods are active or not.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419627018", "createdAt": "2020-05-04T18:07:50Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +46,32 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assert(tracer.currentTransaction() != null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzczMDMwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjowOTozNlrOGQbk9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjowOTozNlrOGQbk9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MjIyOA==", "bodyText": "remove from the map and assign to the span paramenter", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419882228", "createdAt": "2020-05-05T06:09:36Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -179,6 +179,14 @@ public AsyncHandlerOnCompletedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n+            final Span span = handlerSpanMap.getIfPresent(asyncHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzczMTM0OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjoxMDoxMlrOGQblng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzoyNTozOVrOGQdZHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MjM5OA==", "bodyText": "Making sure that wrapped AsyncHandlers work as expected (activate and deactivate only in outer-most AsyncHandler\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n          \n          \n            \n                    private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span) {", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419882398", "createdAt": "2020-05-05T06:10:12Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -179,6 +179,14 @@ public AsyncHandlerOnCompletedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg5ODI5Mg==", "bodyText": "Bit unsure on what you mean with activate and deactive in the outer-most AsyncHandler?", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419898292", "createdAt": "2020-05-05T06:52:36Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -179,6 +179,14 @@ public AsyncHandlerOnCompletedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MjM5OA=="}, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMTk2Nw==", "bodyText": "Following the decorator pattern, calling AsyncHandler#onComplete may result in the handler calling another, wrapped/nested AsyncHandler#onComplete. We want to make sure that only the first AsyncHandler activates and deactivates the span.\nIn your first draft, the first AsyncHandler would activate the span but the last AsyncHandler in the chain would deactivate it. This would result in the span not being active in the first AsyncHandler after it called onComplete on its delegate handler.\n    private final AsyncHandler<Response> delegate;\n\n    @Override\n    public Response onCompleted(Response response) {\n        try {\n            return delegate.onCompleted(response);\n        } finally {\n             tracer.getActive() // returns null\n        }\n    }\n\nBy propagating the active span via a @Advice.Local, we have fixed that problem.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419911967", "createdAt": "2020-05-05T07:25:39Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -179,6 +179,14 @@ public AsyncHandlerOnCompletedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MjM5OA=="}, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzczMjg3OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjoxMDo1NlrOGQbmhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjoxMDo1NlrOGQbmhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MjYzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler) {\n          \n          \n            \n                        final Span span = handlerSpanMap.remove(asyncHandler);\n          \n          \n            \n                    private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler, @Nullable @Advice.Local(\"span\") Span span) {", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419882630", "createdAt": "2020-05-05T06:10:56Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -179,6 +179,14 @@ public AsyncHandlerOnCompletedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n+            final Span span = handlerSpanMap.getIfPresent(asyncHandler);\n+            if (span != null) {\n+                span.activate();\n+            }\n+        }\n+\n+        @Advice.OnMethodExit(suppress = Throwable.class)\n+        private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler) {\n             final Span span = handlerSpanMap.remove(asyncHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzc0MTEyOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjoxNDo0NlrOGQbrTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjoxNDo0NlrOGQbrTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4Mzg1Mw==", "bodyText": "Use AssertJ, for consistency\nAdd static import for org.assertj.core.api.Assertions.assertThat\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assert(tracer.currentTransaction() != null);\n          \n          \n            \n                        assertThat(tracer.activeSpan()).isNotNull();\n          \n          \n            \n                        assertThat(tracer.isExit()).isTrue();", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419883853", "createdAt": "2020-05-05T06:14:46Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +46,32 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assert(tracer.currentTransaction() != null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355f20c82c1619ab38d7ab6a7defef1ed3e14986"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzkzMDA2OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "isResolved": false, "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzoyNjo1M1rOGQdbXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDozODoxMFrOGSByag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw==", "bodyText": "To double-check, do the tests fail when doing isNull()?", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419912543", "createdAt": "2020-05-05T07:26:53Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkyNjE0NQ==", "bodyText": "Ill double-check all PR requirements now and make sure the tests make sense :)", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419926145", "createdAt": "2020-05-05T07:54:52Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1NzQ4MA==", "bodyText": "Mmm, the changes make the existing tests fail (even when I remove the newly added customAsyncHandler.\ntestHttpCall[3]  Time elapsed: 0.519 sec  <<< ERROR!\norg.awaitility.core.ConditionTimeoutException:\nAssertion condition defined as a lambda expression in co.elastic.apm.agent.MockReporter\nExpecting actual not to be empty within 500 milliseconds.\n\nSeems to me that is a local problem linked to my laptop. Will try to figure out why it is doing that. Any chance you have a docker-image able to run the tests?", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419957480", "createdAt": "2020-05-05T08:52:42Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1OTUzMg==", "bodyText": "The tests are failing on CI for the same reason. Not sure what causes that \ud83e\udd14", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419959532", "createdAt": "2020-05-05T08:56:17Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODc4MA==", "bodyText": "Oh wow, interesting. Very strange that the new instrumentations make the current tests time-out. Will have a look later today when I have a bit more time :)", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419968780", "createdAt": "2020-05-05T09:12:48Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4OTA3Mg==", "bodyText": "Fixed it :)\nTrying to get the new tests to work now as they currently only pass on the assertion of isNull().\nCould it be that activating the span is not enough and that the tracer needs to set the transaction to active instead?", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419989072", "createdAt": "2020-05-05T09:49:11Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDIwOA==", "bodyText": "hm, strange.. No, activating the span is enough. You don't have to activate the transaction on this thread.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419994208", "createdAt": "2020-05-05T09:58:36Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0NTA5NA==", "bodyText": "I tried to figure it out but tbh, I have no idea.\nOnly thing I could think of was that Im using a new AsyncCompletionHandler<Response> in the test and somehow the methods of this subclass don't get matched properly.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r420045094", "createdAt": "2020-05-05T11:41:15Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ2MTc1Ng==", "bodyText": "@felixbarny I've played around with it a bit more:\n@Advice.OnMethodEnter(suppress = Throwable.class)\n        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span) {\n            span = handlerSpanMap.remove(asyncHandler);\n            if (span != null) {\n                span.activate();\n                System.out.println(tracer.currentTransaction());\n                System.out.println(\"=======================\");\n            }\n        }\n\nThis prints out:\nnull\n=======================\n\nSo it seems that activating the span does not mean I can do assertThat(tracer.currentTransaction()).isNotNull(); in the test.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r421461756", "createdAt": "2020-05-07T12:23:43Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUyNjAwNw==", "bodyText": "Yes, that's true. You should assert that tracer.getActive() is not null instead. I agree that if tracer.getActive() returns non-null, tracer.getTranaction() should do, too. I have an idea how to accomplish that. In the meantime, please assert on tracer.getActive().", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r421526007", "createdAt": "2020-05-07T13:58:50Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMTIyNg==", "bodyText": "See also #1174", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r421531226", "createdAt": "2020-05-07T14:06:05Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU1Njg0Mg==", "bodyText": "Cool, thanks :)\nIve applied the changes and the tests now pass correctly!", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r421556842", "createdAt": "2020-05-07T14:38:10Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/test/java/co/elastic/apm/agent/asynchttpclient/AsyncHttpClientInstrumentationTest.java", "diffHunk": "@@ -49,11 +47,35 @@ public AsyncHttpClientInstrumentationTest(RequestExecutor requestExecutor) {\n         this.requestExecutor = requestExecutor;\n     }\n \n+    public static AsyncHandler<Response> customAsyncHandler = new AsyncCompletionHandler<Response>() {\n+        @Override\n+        public State onStatusReceived(HttpResponseStatus responseStatus) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+            return State.CONTINUE;\n+        }\n+\n+        @Override\n+        public void onThrowable(Throwable t) {\n+            assertThat(tracer.currentTransaction()).isNotNull();\n+            assertThat(tracer.currentTransaction().isExit()).isTrue();\n+        }\n+\n+        @Override\n+        public Response onCompleted(Response response) {\n+            assertThat(tracer.currentTransaction()).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjU0Mw=="}, "originalCommit": {"oid": "09b0479f2e0b9232a3cc4cb454b56dcc14cdb43a"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQxMTI5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo0Nzo0MlrOGQiDIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo0Nzo0MlrOGQiDIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4ODI1OA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419988258", "createdAt": "2020-05-05T09:47:42Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -223,7 +223,7 @@ public AsyncHandlerOnStatusReceivedInstrumentation() {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span, @Advice.Argument(0) HttpResponseStatus status) {\n-            span = handlerSpanMap.remove(asyncHandler);\n+            span = handlerSpanMap.get(asyncHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d088819d431fa254c434defabf23b30860938cf"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQxODA4OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo0OTozOVrOGQiHSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1Nzo0OVrOGQiYrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4OTMyMw==", "bodyText": "Don't forget to deactivate it in all exit advices.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419989323", "createdAt": "2020-05-05T09:49:39Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -178,8 +178,15 @@ public AsyncHandlerOnCompletedInstrumentation() {\n         }\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n-            final Span span = handlerSpanMap.remove(asyncHandler);\n+        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span) {\n+            span = handlerSpanMap.remove(asyncHandler);\n+            if (span != null) {\n+                span.activate();\n+            }\n+        }\n+\n+        @Advice.OnMethodExit(suppress = Throwable.class)\n+        private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler, @Nullable @Advice.Local(\"span\") Span span) {\n             if (span != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d088819d431fa254c434defabf23b30860938cf"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MDk1Mg==", "bodyText": "What is the difference between end and deactivate?", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419990952", "createdAt": "2020-05-05T09:52:42Z", "author": {"login": "milanvdm"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -178,8 +178,15 @@ public AsyncHandlerOnCompletedInstrumentation() {\n         }\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n-            final Span span = handlerSpanMap.remove(asyncHandler);\n+        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span) {\n+            span = handlerSpanMap.remove(asyncHandler);\n+            if (span != null) {\n+                span.activate();\n+            }\n+        }\n+\n+        @Advice.OnMethodExit(suppress = Throwable.class)\n+        private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler, @Nullable @Advice.Local(\"span\") Span span) {\n             if (span != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4OTMyMw=="}, "originalCommit": {"oid": "3d088819d431fa254c434defabf23b30860938cf"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5Mzc3NA==", "bodyText": "end sets the end timestamp and schedules the span to be reported. deactivate removes the span from the thread local which avoids the span from being leaked into different executions.", "url": "https://github.com/elastic/apm-agent-java/pull/1172#discussion_r419993774", "createdAt": "2020-05-05T09:57:49Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-asynchttpclient-plugin/src/main/java/co/elastic/apm/agent/asynchttpclient/AbstractAsyncHttpClientInstrumentation.java", "diffHunk": "@@ -178,8 +178,15 @@ public AsyncHandlerOnCompletedInstrumentation() {\n         }\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler) {\n-            final Span span = handlerSpanMap.remove(asyncHandler);\n+        private static void onMethodEnter(@Advice.This AsyncHandler<?> asyncHandler, @Advice.Local(\"span\") Span span) {\n+            span = handlerSpanMap.remove(asyncHandler);\n+            if (span != null) {\n+                span.activate();\n+            }\n+        }\n+\n+        @Advice.OnMethodExit(suppress = Throwable.class)\n+        private static void onMethodExit(@Advice.This AsyncHandler<?> asyncHandler, @Nullable @Advice.Local(\"span\") Span span) {\n             if (span != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4OTMyMw=="}, "originalCommit": {"oid": "3d088819d431fa254c434defabf23b30860938cf"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 316, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}