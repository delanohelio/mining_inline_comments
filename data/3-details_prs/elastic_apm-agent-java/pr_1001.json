{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODIwNDYz", "number": 1001, "title": "Add Docker build and push to release stage of build", "bodyText": "What does this PR do?\nThis PR modifies the release pipeline for the APM Java agent project and instructs it to create and publish a Docker image on each release to the public repository. For the time being, this behavior happens if-and-only-if the push_docker parameter is set when the job is run. In this PR, the default value for push_docker is set to false.\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? How did you make sure that old, non-supported versions are not instrumented by accident?\n\nAuthor's Checklist\n\nRelated issues\n\nRelates #997\nUse cases\n\nScreenshots", "createdAt": "2020-01-22T12:09:59Z", "url": "https://github.com/elastic/apm-agent-java/pull/1001", "merged": true, "mergeCommit": {"oid": "1920f2bb7148ed07bfa2d8efd543ae921e30164c"}, "closed": true, "closedAt": "2020-01-28T10:38:30Z", "author": {"login": "cachedout"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb80rcXABqjI5Njk4MTIyMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-s9RfgBqjI5ODQ2NjI4ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "574844a6217cf1c25d57a70c11467bc8e5ef88a2", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/574844a6217cf1c25d57a70c11467bc8e5ef88a2", "committedDate": "2020-01-22T11:12:18Z", "message": "Add Docker build and push to release stage of build"}, "afterCommit": {"oid": "b69e7cc4f50a093caea70695b4442c598a4d035b", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b69e7cc4f50a093caea70695b4442c598a4d035b", "committedDate": "2020-01-22T12:12:30Z", "message": "Fix typo in Jenkinsfile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTU2OTkw", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346556990", "createdAt": "2020-01-22T12:41:19Z", "commit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MToxOVrOFgauXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MToxOVrOFgauXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjYwNw==", "bodyText": "NIT https://stackoverflow.com/questions/37056192/which-vs-command-v-in-bash\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            if ! which docker\n          \n          \n            \n            if ! command -v docker", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369536607", "createdAt": "2020-01-22T12:41:19Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTU3MjEw", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346557210", "createdAt": "2020-01-22T12:41:45Z", "commit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MTo0NlrOFgavOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo0MTo0NlrOFgavOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjgyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            elif ! which curl\n          \n          \n            \n            elif ! command -v curl", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369536826", "createdAt": "2020-01-22T12:41:46Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! which curl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTYyMjE1", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346562215", "createdAt": "2020-01-22T12:50:59Z", "commit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MDo1OVrOFga-Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MDo1OVrOFga-Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0MDY3MA==", "bodyText": "Allow passing the GIT_TAG on the environment, by default use the latest TAG\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            readonly GIT_TAG=`git describe --abbrev=0|sed s/^v//`\n          \n          \n            \n            GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n          \n          \n            \n            readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369540670", "createdAt": "2020-01-22T12:50:59Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,39 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! which docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! which curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+readonly GIT_TAG=`git describe --abbrev=0|sed s/^v//`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTYyODI0", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346562824", "createdAt": "2020-01-22T12:52:04Z", "commit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MjowNFrOFgbAWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjo1MjowNFrOFgbAWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0MTIwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            readonly CUR_TAG=`git describe --abbrev=0|sed s/^v//`\n          \n          \n            \n            CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n          \n          \n            \n            readonly CUR_TAG=${CUR_TAG:-$CUR_TAG_DEFAULT}", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369541209", "createdAt": "2020-01-22T12:52:04Z", "author": {"login": "kuisathaverat"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,29 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+readonly CUR_TAG=`git describe --abbrev=0|sed s/^v//`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "791a4ec8d8b725f022b84edc9a7b86c2493621f7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTgxMzUz", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346581353", "createdAt": "2020-01-22T13:23:21Z", "commit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyMzoyMlrOFgb3tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNzoxNlrOFgcRsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NTM4MA==", "bodyText": "IIUC, this step is not for the https://github.com/elastic/apm-agent-java/pull/1001/files#diff-6a3371457528722a734f3c51d9238c13R256 but for another Jenkins instance", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369555380", "createdAt": "2020-01-22T13:23:22Z", "author": {"login": "v1v"}, "path": "CONTRIBUTING.md", "diffHunk": "@@ -251,15 +251,16 @@ and follow [those instructions](https://github.com/elastic/docs#for-a-local-repo\n If you have access to make releases, the process is as follows:\n \n 1. Check if sonatype is up: https://status.maven.org\n-1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`. \n+1. Review project version. The release version will be `${project.version}` without the `-SNAPSHOT`.\n    1. In case you want to update the version, execute `mvn release:update-versions`\n 1. Execute the release Jenkins job on the internal ci server. This job is same as the snapshot-build job, but it also:\n    1. Removes `-SNAPSHOT` from all `${project.version}` occurrences and makes a commit before build\n    1. Tags this new commit with the version name, e.g. `v1.1.0`\n    1. Advances the version for next development iteration and makes a commit\n    1. Uploads artifacts to maven central\n+   1. (Optional) If the `push_docker` parameter is set, build and push a Docker image for this release to the docker.elastic.co repo.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NjE2OQ==", "bodyText": "Cosmetic change :)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #!/bin/bash\n          \n          \n            \n            #!/usr/bin/env bash", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369556169", "createdAt": "2020-01-22T13:24:58Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1OTgzNA==", "bodyText": "There are different env variable to know the tag name:\n\nTAG_NAME\nBRANCH_NAME\nGIT_BRANCH\n\nSome references:\n\nhttps://apm-ci.elastic.co/pipeline-syntax/globals#env\nhttps://github.com/jenkins-infra/jenkins.io/blob/master/content/doc/book/pipeline/syntax.adoc#when", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369559834", "createdAt": "2020-01-22T13:32:46Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDMyOA==", "bodyText": "Minor suggestion to avoid the download output\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n          \n          \n            \n            curl -L -s -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560328", "createdAt": "2020-01-22T13:33:49Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+echo \"INFO: Downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDYyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # This script is intended to work in conjunction with the build_docker.#!/bin/sh\n          \n          \n            \n            # This script is intended to work in conjunction with the build_docker", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560629", "createdAt": "2020-01-22T13:34:27Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MTc5Mw==", "bodyText": "Sometimes the docker registry can be offline or got some glitches, a retry with asleep could help?  Something similar to:\n\nhttps://github.com/elastic/apm-agent-java/blob/master/.ci/packer_cache.sh#L6", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369561793", "createdAt": "2020-01-22T13:36:52Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+# This script is intended to work in conjunction with the build_docker.#!/bin/sh\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly CUR_TAG=${CUR_TAG:-$CUR_TAG_DEFAULT}\n+\n+# 2. Construct the image:tag that we are working with\n+# This is roughly <repo>/<namespace>/image\n+readonly DOCKER_PUSH_IMAGE=\"docker.elastic.co/apm/apm-agent-java:$CUR_TAG\"\n+\n+# 3. Proceed with pushing to the registry\n+readonly DOCKER_REGISTRY_URL=`echo $DOCKER_PUSH_IMAGE|cut -f1 -d/`\n+echo \"INFO: Pushing image $DOCKER_PUSH_IMAGE to $DOCKER_REGISTRY_URL\"\n+docker push $DOCKER_PUSH_IMAGE || echo \"Push failed. When running in \" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MjAzNQ==", "bodyText": "Cosmetic preference :)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #!/bin/bash\n          \n          \n            \n            #!/usr/bin/env bash", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369562035", "createdAt": "2020-01-22T13:37:16Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTg4MjM5", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346588239", "createdAt": "2020-01-22T13:34:19Z", "commit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNDoxOVrOFgcL9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzozNDoxOVrOFgcL9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDU2NQ==", "bodyText": "Do we know this runs only when the artifact is available on Sonatype?\nWhy not using the local artifact?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369560565", "createdAt": "2020-01-22T13:34:19Z", "author": {"login": "eyalkoren"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,40 @@\n+#!/bin/bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+echo \"INFO: Downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+curl -L  -o apm-agent-java.jar \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7eaabb0d9f7b73a991033c04b33b51d3ca9600"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjQwNjQx", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346640641", "createdAt": "2020-01-22T14:44:31Z", "commit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDo0NDozMVrOFgeoow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDo0NDozMVrOFgeoow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ==", "bodyText": "If the docker registry instance is only for internal usage/access, what do you think to change this stage with 'Generate staging docker image' or something similar?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r369600675", "createdAt": "2020-01-22T14:44:31Z", "author": {"login": "v1v"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjUyMjM2", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-346652236", "createdAt": "2020-01-22T14:58:43Z", "commit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjY3MDk0", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-347267094", "createdAt": "2020-01-23T12:43:26Z", "commit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0MzoyNlrOFg81Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0NDo1OFrOFg83wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NTQ1NA==", "bodyText": "NIT: could it be more accurate with the SHA reference? Just wondering if the alpine:3.9 image might be no deterministic", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370095454", "createdAt": "2020-01-23T12:43:26Z", "author": {"login": "v1v"}, "path": "Dockerfile", "diffHunk": "@@ -0,0 +1,4 @@\n+FROM alpine:3.9", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NjA2Ng==", "bodyText": "got it, what about 'Docker image' or Docker push as it does consist of two steps, docker build and docker push, and the aim of this stage is to publish the Docker image,?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370096066", "createdAt": "2020-01-23T12:44:58Z", "author": {"login": "v1v"}, "path": "Jenkinsfile", "diffHunk": "@@ -286,6 +288,18 @@ pipeline {\n         tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n       }\n       stages {\n+        stage('Docker build') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwMDY3NQ=="}, "originalCommit": {"oid": "413a6518cac3fea3141aee9a137395fca46d606f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3OTczNzQ5", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-347973749", "createdAt": "2020-01-24T14:06:40Z", "commit": {"oid": "f2c29715265959dcbcc9b6863cc0dfd3b5609d22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNDowNjo0MFrOFherHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNDowNjo0MFrOFherHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY0OTg4Nw==", "bodyText": "I'm not familiar with this env variable, where is it coming from?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r370649887", "createdAt": "2020-01-24T14:06:40Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKERS+x} ]  # We are on a CI worker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2c29715265959dcbcc9b6863cc0dfd3b5609d22"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjYyMDU4", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-348662058", "createdAt": "2020-01-27T13:31:58Z", "commit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMTo1OFrOFiCtnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozNjoxNFrOFiC1Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDM0OA==", "bodyText": "Is this required?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240348", "createdAt": "2020-01-27T13:31:58Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDUyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n          \n          \n            \n            if [ \"$(ls -A  ${PROJECT_ROOT}elastic-apm-agent/target)\" ]", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240523", "createdAt": "2020-01-27T13:32:25Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDc1Mg==", "bodyText": "PROJECT_ROOT ends with /\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n          \n          \n            \n              find -E ${PROJECT_ROOT}elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} ${PROJECT_ROOT}apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371240752", "createdAt": "2020-01-27T13:32:55Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MTY3Ng==", "bodyText": "Cosmetic change, what do you think to . at the very end of the docker build call ?\ndocker build -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\\n             --build-arg JAR_FILE=apm-agent-java.jar .", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371241676", "createdAt": "2020-01-27T13:34:48Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjEzMQ==", "bodyText": "It might not be required when using the CI ephemeral workers", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371242131", "createdAt": "2020-01-27T13:35:49Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/build_docker.sh", "diffHunk": "@@ -0,0 +1,68 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+if ! command -v docker\n+then\n+  echo \"ERROR: Building Docker image requires Docker binary to be installed\" && exit 1\n+elif ! docker version\n+then\n+  echo \"ERROR: Building Docker image requires Docker daemon to be running\" && exit 1\n+elif ! command -v curl\n+then\n+  echo \"ERROR: Building Docker image requires cURL to be installed\" && exit 1\n+fi\n+\n+echo \"INFO: Determining latest tag\"\n+if [ ! -z ${TAG_NAME+x} ]\n+then\n+  echo \"INFO: Detected TAG_NAME variable. Probably a Jenkins instance.\"\n+  readonly GIT_TAG_DEFAULT=$(echo $TAG_NAME|sed s/^v//)\n+else\n+  echo \"INFO: Did not detect TAG_NAME. Examining git log for latest tag\"\n+  readonly GIT_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)\n+fi\n+\n+readonly GIT_TAG=${GIT_TAG:-$GIT_TAG_DEFAULT}\n+\n+readonly SCRIPT_PATH=\"$( cd \"$(dirname \"$0\")\" ; pwd -P )\"\n+readonly PROJECT_ROOT=$SCRIPT_PATH/../../\n+readonly NAMESPACE=\"observability\"\n+\n+if [ \"$(ls -A  $SCRIPT_PATH/../../elastic-apm-agent/target)\" ]\n+then\n+  # We have build files to use\n+  echo \"INFO: Found local build artifact. Using locally built for Docker build\"\n+  find -E $PROJECT_ROOT/elastic-apm-agent/target -regex '.*/elastic-apm-agent-[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?.jar' -exec cp {} $PROJECT_ROOT/apm-agent-java.jar \\; || echo \"INFO: No locally built image found\"\n+  # cp $SCRIPT_PATH/../../elastic-apm-agent/target/elastic-apm-agent-.*!('-javadoc'|'-sources').jar $SCRIPT_PATH/../../apm-agent-java.jar\n+elif [ ! -z ${SONATYPE_FALLBACK+x} ]\n+then\n+  echo \"INFO: No local build artifact and SONATYPE_FALLBACK. Falling back to downloading artifact from Sonatype Nexus repository for version $GIT_TAG\"\n+  curl -L -s -o apm-agent-java.jar \\\n+    \"http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=co.elastic.apm&a=elastic-apm-agent&v=$GIT_TAG\"\n+  else\n+    echo \"ERROR: No suitable build artifact was found. Re-running this script with the SONATYPE_FALLBACK variable set to true will try to use the Sonatype artifact for the latest tag\"\n+    exit 1\n+fi\n+\n+echo \"INFO: Starting Docker build for version $GIT_TAG\"\n+\n+docker build . -t docker.elastic.co/$NAMESPACE/apm-agent-java:$GIT_TAG \\\n+  --build-arg JAR_FILE=apm-agent-java.jar\n+\n+if [ $? -eq 0 ]\n+then\n+  echo \"INFO: Docker image built succesfully\"\n+else\n+  echo \"ERROR: Problem building Docker image!\"\n+fi\n+\n+function finish {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjMzOA==", "bodyText": "Should it use the same approach as the one for building?", "url": "https://github.com/elastic/apm-agent-java/pull/1001#discussion_r371242338", "createdAt": "2020-01-27T13:36:14Z", "author": {"login": "v1v"}, "path": "scripts/jenkins/push_docker.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+set -euxo pipefail\n+\n+# This script is present on workers but may not be present in a development\n+# environment.\n+\n+if [ ${WORKSPACE+x} ]  # We are on a CI worker\n+then\n+  source /usr/local/bin/bash_standard_lib.sh\n+fi\n+\n+readonly RETRIES=3\n+\n+# This script is intended to work in conjunction with the build_docker\n+# script. It assumes that build_docker.sh has been run at least once, thereby\n+# creating a Docker image to push. If this script does not detect an image\n+# to be uploaded, it will fail.\n+\n+# This script is intended to be run from a CI job and will not work if run in\n+# standalone manner unless certain envrionment variables are set.\n+\n+# 1. Grab the tag we are working with\n+\n+#FIXME DRY between Docker scripts\n+echo \"INFO: Fetching latest tag\"\n+#TODO Move this into apm-pipeline-library\n+CUR_TAG_DEFAULT=$(git describe --abbrev=0|sed s/^v//)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94ecea715633ad78b63d1ef99d30e5492f4b0800"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjkxMzk5", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-348691399", "createdAt": "2020-01-27T14:14:57Z", "commit": {"oid": "79d8f15ed5bcccf474c158ddc9d806f15fcea9d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NzQwMDE2", "url": "https://github.com/elastic/apm-agent-java/pull/1001#pullrequestreview-348740016", "createdAt": "2020-01-27T15:16:22Z", "commit": {"oid": "79d8f15ed5bcccf474c158ddc9d806f15fcea9d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a9699836326c38948ccafb7b7eb49006516fef0", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/2a9699836326c38948ccafb7b7eb49006516fef0", "committedDate": "2020-01-28T08:20:41Z", "message": "Add Docker build and push to release stage of build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0b05e8f858f4a0e64b4cdbec0eba9a55f26eabe", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e0b05e8f858f4a0e64b4cdbec0eba9a55f26eabe", "committedDate": "2020-01-28T08:20:41Z", "message": "Fix typo in Jenkinsfile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7209f81156610d1f6fcb4a708ec11f161681d6", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/cc7209f81156610d1f6fcb4a708ec11f161681d6", "committedDate": "2020-01-28T08:20:41Z", "message": "Add docs for Docker build and correct whitespace issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6def99d45de080306062c062ef9ab3df44af85e7", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/6def99d45de080306062c062ef9ab3df44af85e7", "committedDate": "2020-01-28T08:20:41Z", "message": "Typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994a6af219096377d028908e00ab5570829c7df1", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/994a6af219096377d028908e00ab5570829c7df1", "committedDate": "2020-01-28T08:20:41Z", "message": "Typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff05fc7f7f4c18412f347eba143593b63018812", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/bff05fc7f7f4c18412f347eba143593b63018812", "committedDate": "2020-01-28T08:20:41Z", "message": "Quotes for secret"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf81db19c7872c8ae884b19a0f6dab86aeb71747", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/cf81db19c7872c8ae884b19a0f6dab86aeb71747", "committedDate": "2020-01-28T08:20:41Z", "message": "Typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27f376cf5acce26f18382698a17eb81fac1ddfb6", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/27f376cf5acce26f18382698a17eb81fac1ddfb6", "committedDate": "2020-01-28T08:20:41Z", "message": "Review suggestion to remove documentation for this for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b861ceea5958bc717ae4087d4297763b1516fb", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/61b861ceea5958bc717ae4087d4297763b1516fb", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Ivan Fernandez Calvo <kuisathaverat@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63c7911727f4dfee49120f46b9ab516ad1e938e0", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/63c7911727f4dfee49120f46b9ab516ad1e938e0", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Ivan Fernandez Calvo <kuisathaverat@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c4454ed002911244b5acceb335179c9c7825a5", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e8c4454ed002911244b5acceb335179c9c7825a5", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Ivan Fernandez Calvo <kuisathaverat@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de7107b299b2c72cba66125e22f0351cab00224d", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/de7107b299b2c72cba66125e22f0351cab00224d", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/push_docker.sh\n\nCo-Authored-By: Ivan Fernandez Calvo <kuisathaverat@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cee50b489d635f604ea46ea0100ed5952bb7615", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8cee50b489d635f604ea46ea0100ed5952bb7615", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1bb39c783f25744269c3cb5d979e06c8caa437", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/2b1bb39c783f25744269c3cb5d979e06c8caa437", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2d0de1bb2e0d7de66a9babfc5fc175a60d2190", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/cf2d0de1bb2e0d7de66a9babfc5fc175a60d2190", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/push_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0029cbae4fa10ed800fab5406314843569b031", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/2c0029cbae4fa10ed800fab5406314843569b031", "committedDate": "2020-01-28T08:20:41Z", "message": "Update scripts/jenkins/push_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81ec68dbd4ceb5e8a4a928df31c0c3e02eee6a21", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/81ec68dbd4ceb5e8a4a928df31c0c3e02eee6a21", "committedDate": "2020-01-28T08:20:41Z", "message": "Implement retry for Docker push when running in CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c60d554fa2c2b9c5c41e90d12d0eb2c8fb86be21", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c60d554fa2c2b9c5c41e90d12d0eb2c8fb86be21", "committedDate": "2020-01-28T08:20:41Z", "message": "Change name of stage per review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf26194ad23a2eb22b357c8f4aea8ed9b4838f02", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/bf26194ad23a2eb22b357c8f4aea8ed9b4838f02", "committedDate": "2020-01-28T08:20:41Z", "message": "Pin to SHA hash for Alpine 3.9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "591986bac55400b578cb7546eb62d437a66f4c28", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/591986bac55400b578cb7546eb62d437a66f4c28", "committedDate": "2020-01-28T08:20:42Z", "message": "Make Sonatype optional with env flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a299781456e58c036d3eb2b6e5f639be09e2ad47", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a299781456e58c036d3eb2b6e5f639be09e2ad47", "committedDate": "2020-01-28T08:20:42Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f9b5bdd343c229549cb3fa8157f0bb0713758d", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/28f9b5bdd343c229549cb3fa8157f0bb0713758d", "committedDate": "2020-01-28T08:20:42Z", "message": "Better handling for image checking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ce6d4367aed309e68486aacaf37ec5b732e4b8", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/d0ce6d4367aed309e68486aacaf37ec5b732e4b8", "committedDate": "2020-01-28T08:20:42Z", "message": "Swing over to observability namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b17b676b2534bf669f89b5b5219683d6f330622", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9b17b676b2534bf669f89b5b5219683d6f330622", "committedDate": "2020-01-28T08:20:42Z", "message": "Get tag name from Jenkins if possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b370ae2a609a1a7ba093a493f031c2e747d92b09", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b370ae2a609a1a7ba093a493f031c2e747d92b09", "committedDate": "2020-01-28T08:20:42Z", "message": "Remove commented line that is no longer needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b214e905c842253b2e485f5b15722322c33f6d1", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9b214e905c842253b2e485f5b15722322c33f6d1", "committedDate": "2020-01-28T08:20:42Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aac33434817f5666c52ab089f55a0f9781149f3", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8aac33434817f5666c52ab089f55a0f9781149f3", "committedDate": "2020-01-28T08:20:42Z", "message": "Update scripts/jenkins/build_docker.sh\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fcd32a4998471678e355da75d8da36cda3d916d", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4fcd32a4998471678e355da75d8da36cda3d916d", "committedDate": "2020-01-28T08:20:42Z", "message": "Check for all jars and style change for Docker build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "228cc71a343005abc9ec7176dc57229b6b23e857", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/228cc71a343005abc9ec7176dc57229b6b23e857", "committedDate": "2020-01-28T08:20:42Z", "message": "Use same git tag lookup strategy between scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79d8f15ed5bcccf474c158ddc9d806f15fcea9d6", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/79d8f15ed5bcccf474c158ddc9d806f15fcea9d6", "committedDate": "2020-01-27T13:56:38Z", "message": "Use same git tag lookup strategy between scripts"}, "afterCommit": {"oid": "228cc71a343005abc9ec7176dc57229b6b23e857", "author": {"user": {"login": "cachedout", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/228cc71a343005abc9ec7176dc57229b6b23e857", "committedDate": "2020-01-28T08:20:42Z", "message": "Use same git tag lookup strategy between scripts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4054, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}