{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNjMyNjgx", "number": 1391, "title": "Fix HttpUrlConnection instrumentation", "bodyText": "Currently our instrumentation only looks at the java.net.URLConnection#connected field and not the sun.net.www.protocol.http.HttpURLConnection#connecting when trying to add the header.\nSince the connecting field was only introduced in Java 8, we are doing something instead.\nIn addition - removing the restriction for using ThreadLocal within advice classes.", "createdAt": "2020-09-09T08:08:28Z", "url": "https://github.com/elastic/apm-agent-java/pull/1391", "merged": true, "mergeCommit": {"oid": "53e6ea431dd6a196a13dc3dd917df104a462328e"}, "closed": true, "closedAt": "2020-09-09T14:32:10Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHHl6VgH2gAyNDgyNjMyNjgxOjcxMjA1YTA3OTRlYTI4ZGY4ZDg5NWJhZDRhZTVjYzExNDViZjk3YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHMNVkAH2gAyNDgyNjMyNjgxOjg2NDk1N2I1ODI4NGExMDA3YzA3MGJkNDAyMGZkNTk0OTE1NzU5ZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "71205a0794ea28df8d895bad4ae5cc1145bf97b2", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/71205a0794ea28df8d895bad4ae5cc1145bf97b2", "committedDate": "2020-09-09T08:05:27Z", "message": "Fix HttpUrlConnection instrumentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NzY4NTkw", "url": "https://github.com/elastic/apm-agent-java/pull/1391#pullrequestreview-484768590", "createdAt": "2020-09-09T08:18:34Z", "commit": {"oid": "71205a0794ea28df8d895bad4ae5cc1145bf97b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxODozNFrOHO8Bcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxODozNFrOHO8Bcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNTUyMw==", "bodyText": "Creating a subclass of ThreadLocal causes leaks. See also https://cwiki.apache.org/confluence/display/TOMCAT/MemoryLeakProtection#MemoryLeakProtection-customThreadLocal.\nEither use no initial value or use CallDepth which seems to be applicable to this case.", "url": "https://github.com/elastic/apm-agent-java/pull/1391#discussion_r485425523", "createdAt": "2020-09-09T08:18:34Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-urlconnection-plugin/src/main/java/co/elastic/apm/agent/urlconnection/HttpUrlConnectionInstrumentation.java", "diffHunk": "@@ -51,8 +50,15 @@\n \n public abstract class HttpUrlConnectionInstrumentation extends TracerAwareInstrumentation {\n \n-    @VisibleForAdvice\n-    public static final WeakConcurrentMap<HttpURLConnection, Span> inFlightSpans = WeakMapSupplier.createMap();\n+    private static final WeakConcurrentMap<HttpURLConnection, Span> inFlightSpans = WeakMapSupplier.createMap();\n+\n+    // Used instead of inspecting sun.net.www.protocol.http.HttpURLConnection.connecting which was added in Java 8\n+    private static final ThreadLocal<Boolean> connecting = new ThreadLocal<>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71205a0794ea28df8d895bad4ae5cc1145bf97b2"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7768a0406b25358f76783e55778d782ccea576c2", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/7768a0406b25358f76783e55778d782ccea576c2", "committedDate": "2020-09-09T08:52:18Z", "message": "Replacing ThreadLocal with CallDepth"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODE2NTM5", "url": "https://github.com/elastic/apm-agent-java/pull/1391#pullrequestreview-484816539", "createdAt": "2020-09-09T09:15:08Z", "commit": {"oid": "7768a0406b25358f76783e55778d782ccea576c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODIxNzUz", "url": "https://github.com/elastic/apm-agent-java/pull/1391#pullrequestreview-484821753", "createdAt": "2020-09-09T09:21:21Z", "commit": {"oid": "7768a0406b25358f76783e55778d782ccea576c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81caaa1c1970f6bfeac7561f267a48f0756ba90", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c81caaa1c1970f6bfeac7561f267a48f0756ba90", "committedDate": "2020-09-09T11:54:25Z", "message": "Merge remote-tracking branch 'upstream/master' into HttpUrlConnection-instr-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1741848ae2406104d03ba3c0ee103d513ecd218c", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1741848ae2406104d03ba3c0ee103d513ecd218c", "committedDate": "2020-09-09T12:51:33Z", "message": "Restore ThreadLocal loading restriction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b07190424ba3327872520bc7a69827a1a29946b4", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b07190424ba3327872520bc7a69827a1a29946b4", "committedDate": "2020-09-09T13:25:33Z", "message": "Re-remove ThreadLocal and corresponding test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "864957b58284a1007c070bd4020fd594915759fb", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/864957b58284a1007c070bd4020fd594915759fb", "committedDate": "2020-09-09T13:28:08Z", "message": "Removing UsingThreadLocal class from test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3665, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}