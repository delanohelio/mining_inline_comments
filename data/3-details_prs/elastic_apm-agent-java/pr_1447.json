{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NjQ0MDU3", "number": 1447, "title": "Avoid instrumenting HttpsURLConnectionImpl", "bodyText": "What does this PR do?\n\nFixes a problem with the instrumentation of HttpUrlConnection: sun.net.www.protocol.https.HttpsURLConnectionImpl uses a delegate UrlConnection. It's own responseCode field is not updated, instead its getResponseCode() delegates. Since our instrumentation relies on the field's value in order to end the HTTP span, it fails to end it.\nChecklist\n\n\n This is an enhancement of existing features, or a new feature in existing plugins\n\n I have updated CHANGELOG.asciidoc\n I have added tests that prove my fix is effective or that my feature works\n Added an API method or config option? Document in which version this will be introduced\n I have made corresponding changes to the documentation\n\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix\n I have have tested manually that this scenario (using HTTPS calls though UrlConnection without calling java.net.HttpURLConnection#disconnect would fail without this fix\n\n\n This is a new plugin\n\n I have updated CHANGELOG.asciidoc\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n I have updated supported-technologies.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n Added an instrumentation plugin? Describe how you made sure that old, non-supported versions are not instrumented by accident.\n\n\n This is something else\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-10-20T09:46:45Z", "url": "https://github.com/elastic/apm-agent-java/pull/1447", "merged": true, "mergeCommit": {"oid": "1a888fda7905b39ea7b93dc22e61bc9f0aa2bbb1"}, "closed": true, "closedAt": "2020-10-21T14:25:20Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUVjXEgH2gAyNTA2NjQ0MDU3OjgyYTFiMzg0ZjM5MDc0YjI1NWRkZmU2MjQ5ZDI4YWY3ZmRjNDIxZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUtPx2gH2gAyNTA2NjQ0MDU3OmFkMDJkYzYyZTUxZDAzYzI4YWI3YWYzMmFlZWQ2MTQ0ODgxZTRmNGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82a1b384f39074b255ddfe6249d28af7fdc421f1", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/82a1b384f39074b255ddfe6249d28af7fdc421f1", "committedDate": "2020-10-20T09:42:21Z", "message": "Avoid instrumenting HttpsURLConnectionImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTQxNzM5", "url": "https://github.com/elastic/apm-agent-java/pull/1447#pullrequestreview-512541739", "createdAt": "2020-10-20T10:05:02Z", "commit": {"oid": "82a1b384f39074b255ddfe6249d28af7fdc421f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowNTowMlrOHk0qmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowNTowMlrOHk0qmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MzY1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return hasSuperType(is(HttpURLConnection.class)).and(not(named(\"sun.net.www.protocol.https.HttpsURLConnectionImpl\")));\n          \n          \n            \n                    return hasSuperType(is(HttpURLConnection.class))\n          \n          \n            \n                        .and(not(named(\"sun.net.www.protocol.https.HttpsURLConnectionImpl\")))\n          \n          \n            \n                        .and(declaresField(named(\"connected\")));", "url": "https://github.com/elastic/apm-agent-java/pull/1447#discussion_r508373658", "createdAt": "2020-10-20T10:05:02Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-urlconnection-plugin/src/main/java/co/elastic/apm/agent/urlconnection/HttpUrlConnectionInstrumentation.java", "diffHunk": "@@ -64,7 +65,7 @@\n \n     @Override\n     public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n-        return hasSuperType(is(HttpURLConnection.class));\n+        return hasSuperType(is(HttpURLConnection.class)).and(not(named(\"sun.net.www.protocol.https.HttpsURLConnectionImpl\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82a1b384f39074b255ddfe6249d28af7fdc421f1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzUxODIw", "url": "https://github.com/elastic/apm-agent-java/pull/1447#pullrequestreview-513351820", "createdAt": "2020-10-21T06:45:30Z", "commit": {"oid": "82a1b384f39074b255ddfe6249d28af7fdc421f1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjo0NTozMVrOHlciAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjo0NTozMVrOHlciAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyNjgxNg==", "bodyText": "Yes, forget what I said. @Advice.FieldValue(\"connected\") boolean connected is guaranteed to work as the connected field is always accessible as we're searching for sub-types of HttpUrlConnection that are also sub-types of URLConnection", "url": "https://github.com/elastic/apm-agent-java/pull/1447#discussion_r509026816", "createdAt": "2020-10-21T06:45:31Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-urlconnection-plugin/src/main/java/co/elastic/apm/agent/urlconnection/HttpUrlConnectionInstrumentation.java", "diffHunk": "@@ -64,7 +65,7 @@\n \n     @Override\n     public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n-        return hasSuperType(is(HttpURLConnection.class));\n+        return hasSuperType(is(HttpURLConnection.class)).and(not(named(\"sun.net.www.protocol.https.HttpsURLConnectionImpl\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MzY1OA=="}, "originalCommit": {"oid": "82a1b384f39074b255ddfe6249d28af7fdc421f1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d40f6fb9af343957f1e3cc3e6cd5391b323d2f18", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/d40f6fb9af343957f1e3cc3e6cd5391b323d2f18", "committedDate": "2020-10-21T13:16:32Z", "message": "Merge remote-tracking branch 'upstream/master' into HttpUrlConnection-new-instr-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad02dc62e51d03c28ab7af32aeed6144881e4f4c", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ad02dc62e51d03c28ab7af32aeed6144881e4f4c", "committedDate": "2020-10-21T13:18:41Z", "message": "Adding to CHANGELOG"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3684, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}