{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4ODI2NjEw", "number": 1050, "reviewThreads": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0Mzo0MlrODmoI7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0NToyN1rODpJD0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMwMTI3OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0Mzo0MlrOF0JoNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjowNzoyOFrOF00Nyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODAyMg==", "bodyText": "Actually, the MDC should be empty here. Only within the logger.error, the MDC should be set. This is a bit tricky to test but you could mock the org.slf4j.Logger interface with Mockito:\nLogger logger = mock(Logger.class);\n...\nwhen(logger.error(anyString(), any(Exception.class)).then(invocation -> assertMdcErrorIdIsNotBlank());\n\nAs a return type is expected for the Answer lambda, change the return type form private void assertMdcErrorIdIsEmpty() to Void and return null from this method.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228022", "createdAt": "2020-03-10T10:43:42Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTc3MA==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390925770", "createdAt": "2020-03-11T12:07:28Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODAyMg=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMwMjgwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0NDowN1rOF0JpFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0NDowN1rOF0JpFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODI0Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n          \n          \n            \n               void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228247", "createdAt": "2020-03-10T10:44:07Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMwMzMwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0NDoxNlrOF0JpZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0NDoxNlrOF0JpZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyODMyNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n          \n          \n            \n               void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390228325", "createdAt": "2020-03-10T10:44:16Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();\n+        transaction.end();\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMyMDYxOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0OTo0N1rOF0J0mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0OTo0N1rOF0J0mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMTE5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log4jMdcWorking = true;\n          \n          \n            \n                    Assumptions.assumeTrue(() -> {\n          \n          \n            \n                        org.apache.log4j.MDC.put(\"test\", true);\n          \n          \n            \n                        return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n          \n          \n            \n                    }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390231193", "createdAt": "2020-03-10T10:49:47Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        log4jMdcWorking = true;\n+        assertMdcErrorIdIsEmpty();\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsNotBlank();\n+        transaction.end();\n+    }\n+\n+    @Test\n+    public void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        log4jMdcWorking = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMyMzgxOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo1MDozOFrOF0J2fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjowNzo0MFrOF00ONw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMTY3OA==", "bodyText": "Remove this. Use assumptions instead. See testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390231678", "createdAt": "2020-03-10T10:50:38Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTg3OQ==", "bodyText": "removed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390925879", "createdAt": "2020-03-11T12:07:40Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMTY3OA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODMzNjU2OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo1NDozNVrOF0J-dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoxNzo1N1rOF00gnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMzcxOA==", "bodyText": "As ActivationListeners are now called for ErrorCaptures, change ProfilingActivationListener:\n        if (!context.isSampled() || context instanceof ErrorCapture) {\n            return;\n        }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390233718", "createdAt": "2020-03-10T10:54:35Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -37,12 +37,13 @@\n \n import javax.annotation.Nullable;\n import java.util.Collection;\n+import java.util.concurrent.Callable;\n \n \n /**\n  * Data captured by an agent representing an event occurring in a monitored service\n  */\n-public class ErrorCapture implements Recyclable {\n+public class ErrorCapture extends TraceContextHolder<ErrorCapture> implements Recyclable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNjYyNw==", "bodyText": "added\nin afterDeactivate I added this condition, or Is it not necessary here?\n        if (!deactivatedContext.isSampled() || deactivatedContext instanceof ErrorCapture) {\n            return;\n        }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390926627", "createdAt": "2020-03-11T12:09:24Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -37,12 +37,13 @@\n \n import javax.annotation.Nullable;\n import java.util.Collection;\n+import java.util.concurrent.Callable;\n \n \n /**\n  * Data captured by an agent representing an event occurring in a monitored service\n  */\n-public class ErrorCapture implements Recyclable {\n+public class ErrorCapture extends TraceContextHolder<ErrorCapture> implements Recyclable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMzcxOA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzMDU5MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390930591", "createdAt": "2020-03-11T12:17:57Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -37,12 +37,13 @@\n \n import javax.annotation.Nullable;\n import java.util.Collection;\n+import java.util.concurrent.Callable;\n \n \n /**\n  * Data captured by an agent representing an event occurring in a monitored service\n  */\n-public class ErrorCapture implements Recyclable {\n+public class ErrorCapture extends TraceContextHolder<ErrorCapture> implements Recyclable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzMzcxOA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODM0Mzk5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo1NjozN1rOF0KDBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjowOTo0MFrOF00RoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNDg4NQ==", "bodyText": "tracer cannot be null. It's not annotated with @Nullable and it's a final field, initialized in the constructor from a constructed parameter which is not @Nullable.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (tracer != null && context instanceof ErrorCapture) {\n          \n          \n            \n                                if (context instanceof ErrorCapture) {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390234885", "createdAt": "2020-03-10T10:56:37Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (tracer != null && context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNjc1Mw==", "bodyText": "deleted", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390926753", "createdAt": "2020-03-11T12:09:40Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (tracer != null && context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNDg4NQ=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODM0ODIzOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo1Nzo0N1rOF0KFjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzoyODo0M1rOF1TonQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNTUzNA==", "bodyText": "Also add a test for logging errors which are not within a transaction.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390235534", "createdAt": "2020-03-10T10:57:47Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxOTkyMg==", "bodyText": "We can't test this, because AbstractLoggingInstrumentation#logEnter will exit with condition tracer.getActive() == null", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391419922", "createdAt": "2020-03-12T06:17:26Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNTUzNA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDU0MQ==", "bodyText": "Just remove that condition \ud83d\ude42\nIt's ok to provide if tracer.getActive() returns null. Just make the parameter @Nullable (see other suggestion in ElasticApmTracer).", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391440541", "createdAt": "2020-03-12T07:28:43Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(MdcActivationListenerIT.class);\n+    private static final org.apache.logging.log4j.Logger apacheLogger = LogManager.getLogger(MdcActivationListenerIT.class);\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    private Boolean log4jMdcWorking;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNTUzNA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODM1NTQ2OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo1OTo1OVrOF0KKNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoxMDowMFrOF00SJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNjcyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new UnsupportedOperationException();\n          \n          \n            \n                    return getTraceContext().isChildOf(other);\n          \n      \n    \n    \n  \n\nThis can also be pulled up to TraceContextHolder", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390236726", "createdAt": "2020-03-10T10:59:59Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    @Nullable\n+    public Span createSpan(long epochMicros) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public boolean isChildOf(TraceContextHolder other) {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNjg4NQ==", "bodyText": "added", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390926885", "createdAt": "2020-03-11T12:10:00Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    @Nullable\n+    public Span createSpan(long epochMicros) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public boolean isChildOf(TraceContextHolder other) {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNjcyNg=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODM1NzQzOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMTowMDozN1rOF0KLeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozODo0NFrOF1RzYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNzA1MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new UnsupportedOperationException();\n          \n          \n            \n                    throw new UnsupportedOperationException(\"Creating a span as a child of an error is not possible\");", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390237050", "createdAt": "2020-03-10T11:00:37Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNjk0NQ==", "bodyText": "added message", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390926945", "createdAt": "2020-03-11T12:10:07Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNzA1MA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzMDkzMA==", "bodyText": "Also, add similar messages to the other methods", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390930930", "createdAt": "2020-03-11T12:18:41Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNzA1MA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDUzMQ==", "bodyText": "added", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391410531", "createdAt": "2020-03-12T05:38:44Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/error/ErrorCapture.java", "diffHunk": "@@ -146,6 +146,32 @@ public TraceContext getTraceContext() {\n         return traceContext;\n     }\n \n+    @Override\n+    public Span createSpan() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNzA1MA=="}, "originalCommit": {"oid": "93ab45d725148adeafb9b2ee37b359af0cfa444c"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjc1MzI2OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/test/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchRestClientInstrumentationIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyMDoxNlrOF00kug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozODozMlrOF1RzLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzMTY0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Test", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390931642", "createdAt": "2020-03-11T12:20:16Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/test/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchRestClientInstrumentationIT.java", "diffHunk": "@@ -20,6 +20,7 @@\n  * KIND, either express or implied.  See the License for the\n  * specific language governing permissions and limitations\n  * under the License.\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDQ3Nw==", "bodyText": "deleted", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391410477", "createdAt": "2020-03-12T05:38:32Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/test/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchRestClientInstrumentationIT.java", "diffHunk": "@@ -20,6 +20,7 @@\n  * KIND, either express or implied.  See the License for the\n  * specific language governing permissions and limitations\n  * under the License.\n+    @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzMTY0Mg=="}, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjc3NjcwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyNzo1NFrOF00zHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozODo1NVrOF1Rzlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNTMyNg==", "bodyText": "to remove the error.id after capturing the error\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (tracer.getActive() == null) {\n          \n          \n            \n                                    remove.invokeExact(TRACE_ID);\n          \n          \n            \n                                    remove.invokeExact(TRANSACTION_ID);\n          \n          \n            \n                                    remove.invokeExact(ERROR_ID);\n          \n          \n            \n                                }\n          \n          \n            \n                                if (context instanceof ErrorCapture) {\n          \n          \n            \n                                    remove.invokeExact(ERROR_ID);\n          \n          \n            \n                                } else if (tracer.getActive() == null) {\n          \n          \n            \n                                    remove.invokeExact(TRACE_ID);\n          \n          \n            \n                                    remove.invokeExact(TRANSACTION_ID);\n          \n          \n            \n                                }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390935326", "createdAt": "2020-03-11T12:27:54Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -173,6 +177,7 @@ public void afterDeactivate(TraceContextHolder<?> deactivatedContext) throws Thr\n                     if (tracer.getActive() == null) {\n                         remove.invokeExact(TRACE_ID);\n                         remove.invokeExact(TRANSACTION_ID);\n+                        remove.invokeExact(ERROR_ID);\n                     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDU4Mw==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391410583", "createdAt": "2020-03-12T05:38:55Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -173,6 +177,7 @@ public void afterDeactivate(TraceContextHolder<?> deactivatedContext) throws Thr\n                     if (tracer.getActive() == null) {\n                         remove.invokeExact(TRACE_ID);\n                         remove.invokeExact(TRANSACTION_ID);\n+                        remove.invokeExact(ERROR_ID);\n                     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNTMyNg=="}, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjc4Mjg5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoyOTo1MlrOF0027Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozOTozNlrOF1R0Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNjMwMQ==", "bodyText": "to support errors that don't happen within a transaction:\n                    if (context instanceof ErrorCapture) {\n                        put.invoke(ERROR_ID, traceContext.getId().toString());\n                    } else if (tracer.getActive() == null) {\n                        TraceContext traceContext = context.getTraceContext();\n                        put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                        put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                    }", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r390936301", "createdAt": "2020-03-11T12:29:52Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDcxNA==", "bodyText": "added", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391410714", "createdAt": "2020-03-12T05:39:36Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/mdc/MdcActivationListener.java", "diffHunk": "@@ -158,6 +159,9 @@ public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n                         put.invoke(TRACE_ID, traceContext.getTraceId().toString());\n                         put.invoke(TRANSACTION_ID, traceContext.getTransactionId().toString());\n                     }\n+                    if (context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkzNjMwMQ=="}, "originalCommit": {"oid": "2ebcdcbe0905335592e3af7907b4908e2f00848f"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTk0OTc0OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzoyNjowOVrOF1TlGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozNToxNFrOF1VPrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n          \n          \n            \n                public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391439642", "createdAt": "2020-03-12T07:26:09Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjkyNg==", "bodyText": "added", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391466926", "createdAt": "2020-03-12T08:35:14Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0Mg=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTk1NjI5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzoyOToxMFrOF1TpHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozOTowN1rOF1VWvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDY3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));\n          \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391440671", "createdAt": "2020-03-12T07:29:10Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjYyOQ==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391466629", "createdAt": "2020-03-12T08:34:31Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDY3MQ=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODczNQ==", "bodyText": "removed condition", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391468735", "createdAt": "2020-03-12T08:39:07Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(logger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MDY3MQ=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 149}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTk1ODg5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNzozMDozMlrOF1Tq2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozODozNFrOF1VVwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MTExNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n          \n          \n            \n                    doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391441114", "createdAt": "2020-03-12T07:30:32Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODQ4MA==", "bodyText": "done", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391468480", "createdAt": "2020-03-12T08:38:34Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0MTExNA=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjA3Nzg5OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxODozMFrOF1UyVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozODoxN1rOF1VVLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTQxNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                @Advice.This Object thiz,\n          \n          \n            \n                                                @Advice.Origin Class<?> clazz,", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391459414", "createdAt": "2020-03-12T08:18:30Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODMzNA==", "bodyText": "done", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391468334", "createdAt": "2020-03-12T08:38:17Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTQxNA=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjA3OTIzOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoxOTowM1rOF1UzOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozODoxMVrOF1VU_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTY0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            error = tracer.captureException(exception, tracer.getActive(), thiz.getClass().getClassLoader()).activate();\n          \n          \n            \n                            error = tracer.captureException(exception, tracer.getActive(), clazz.getClassLoader()).activate();", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391459642", "createdAt": "2020-03-12T08:19:03Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,\n+                                    @Advice.Local(\"error\") @Nullable ErrorCapture error) {\n             if (tracer == null || tracer.getActive() == null) {\n                 return;\n             }\n             nested = nestedThreadLocal.get();\n             if (!nested) {\n-                tracer.getActive().captureException(exception);\n+                error = tracer.captureException(exception, tracer.getActive(), thiz.getClass().getClassLoader()).activate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODI4NQ==", "bodyText": "done", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391468285", "createdAt": "2020-03-12T08:38:11Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-error-logging-plugin/src/main/java/co/elastic/apm/agent/error/logging/AbstractLoggingInstrumentation.java", "diffHunk": "@@ -57,19 +59,26 @@ protected Boolean initialValue() {\n     public static class LoggingAdvice {\n \n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static void logEnter(@Advice.Argument(1) Throwable exception, @Advice.Local(\"nested\") boolean nested) {\n+        public static void logEnter(@Advice.Argument(1) Throwable exception,\n+                                    @Advice.Local(\"nested\") boolean nested,\n+                                    @Advice.This Object thiz,\n+                                    @Advice.Local(\"error\") @Nullable ErrorCapture error) {\n             if (tracer == null || tracer.getActive() == null) {\n                 return;\n             }\n             nested = nestedThreadLocal.get();\n             if (!nested) {\n-                tracer.getActive().captureException(exception);\n+                error = tracer.captureException(exception, tracer.getActive(), thiz.getClass().getClassLoader()).activate();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1OTY0Mg=="}, "originalCommit": {"oid": "328277ff8209c9f47f0f826a6504c3081c6d662f"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjU5MTA4OnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo0MVrOF1ZxIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxNToxM1rOF1acNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTAyNg==", "bodyText": "This if can be removed, as we're using assumptions in the test methods now. The way assumptions work is similar to assertions but instead of failing the test, they just skip the test.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541026", "createdAt": "2020-03-12T10:53:41Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MjA1NA==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391552054", "createdAt": "2020-03-12T11:15:13Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTAyNg=="}, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjU5MTkwOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1Mzo1NVrOF1Zxog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxNToxOFrOF1acWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTE1NA==", "bodyText": "remove this, too", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541154", "createdAt": "2020-03-12T10:53:55Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {\n+            assertThat(org.apache.log4j.MDC.get(\"error.id\")).isNull();\n+        }\n+    }\n+\n+    private Answer<Void> assertMdcErrorIdIsNotEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNotBlank();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MjA5MQ==", "bodyText": "removed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391552091", "createdAt": "2020-03-12T11:15:18Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/mdc/MdcActivationListenerIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.mdc;\n+\n+import co.elastic.apm.agent.MockReporter;\n+import co.elastic.apm.agent.bci.ElasticApmAgent;\n+import co.elastic.apm.agent.configuration.SpyConfiguration;\n+import co.elastic.apm.agent.error.logging.Log4jLoggingInstrumentation;\n+import co.elastic.apm.agent.error.logging.Slf4jLoggingInstrumentation;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.ElasticApmTracerBuilder;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import net.bytebuddy.agent.ByteBuddyAgent;\n+import org.apache.logging.log4j.ThreadContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.stubbing.Answer;\n+import org.slf4j.Logger;\n+import org.slf4j.MDC;\n+import org.stagemonitor.configuration.ConfigurationRegistry;\n+\n+import java.util.Arrays;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class MdcActivationListenerIT {\n+\n+    protected static ElasticApmTracer tracer;\n+    protected static MockReporter reporter;\n+    protected static ConfigurationRegistry config;\n+    private LoggingConfiguration loggingConfiguration;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        reporter = new MockReporter();\n+        config = SpyConfiguration.createSpyConfig();\n+        tracer = new ElasticApmTracerBuilder()\n+            .configurationRegistry(config)\n+            .reporter(reporter)\n+            .build();\n+        ElasticApmAgent.initInstrumentation(tracer, ByteBuddyAgent.install(), Arrays.asList(new Slf4jLoggingInstrumentation(), new Log4jLoggingInstrumentation()));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        ElasticApmAgent.reset();\n+    }\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        MDC.clear();\n+        org.apache.log4j.MDC.clear();\n+        ThreadContext.clearAll();\n+        loggingConfiguration = config.getConfig(LoggingConfiguration.class);\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4j() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithSlf4jNotInTransaction() {\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        Logger mockedLogger = mock(Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(mockedLogger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        mockedLogger.error(\"Some slf4j exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4j() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        Transaction transaction = tracer.startRootTransaction(getClass().getClassLoader()).withType(\"request\").withName(\"test\");\n+        transaction.activate();\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+        assertMdcErrorIdIsEmpty();\n+        transaction.deactivate().end();\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    @Test\n+    void testVerifyThatWithEnabledCorrelationAndLoggedErrorMdcErrorIdIsNotBlankWithLog4jNotInTransaction() {\n+        Assumptions.assumeTrue(() -> {\n+            org.apache.log4j.MDC.put(\"test\", true);\n+            return org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE;\n+        }, \"Log4j MDC is not working, this happens with some versions of Java 10 where log4j thinks it's Java 1\");\n+        when(loggingConfiguration.isLogCorrelationEnabled()).thenReturn(true);\n+        org.apache.logging.log4j.Logger logger = mock(org.apache.logging.log4j.Logger.class);\n+        doAnswer(invocation -> assertMdcErrorIdIsNotEmpty()).when(logger).error(anyString(), any(Exception.class));\n+\n+        assertMdcErrorIdIsEmpty();\n+\n+        logger.error(\"Some apache logger exception\", new RuntimeException(\"Hello exception\"));\n+\n+        assertMdcErrorIdIsEmpty();\n+    }\n+\n+    private void assertMdcErrorIdIsEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNull();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {\n+            assertThat(org.apache.log4j.MDC.get(\"error.id\")).isNull();\n+        }\n+    }\n+\n+    private Answer<Void> assertMdcErrorIdIsNotEmpty() {\n+        assertThat(MDC.get(\"error.id\")).isNotBlank();\n+        if (org.apache.log4j.MDC.get(\"test\") == Boolean.TRUE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTE1NA=="}, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjU5NTgyOnYy", "diffSide": "RIGHT", "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/ProfilingActivationListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo1NTowNlrOF1Z0EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxNToyNVrOF1aclQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTc3Ng==", "bodyText": "Do the  || context instanceof ErrorCapture check on afterDeactivate as well.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391541776", "createdAt": "2020-03-12T10:55:06Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/ProfilingActivationListener.java", "diffHunk": "@@ -46,7 +47,7 @@ public ProfilingActivationListener(ElasticApmTracer tracer) {\n \n     @Override\n     public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n-        if (!context.isSampled()) {\n+        if (!context.isSampled() || context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MjE0OQ==", "bodyText": "done", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r391552149", "createdAt": "2020-03-12T11:15:25Z", "author": {"login": "kananindzya"}, "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/ProfilingActivationListener.java", "diffHunk": "@@ -46,7 +47,7 @@ public ProfilingActivationListener(ElasticApmTracer tracer) {\n \n     @Override\n     public void beforeActivate(TraceContextHolder<?> context) throws Throwable {\n-        if (!context.isSampled()) {\n+        if (!context.isSampled() || context instanceof ErrorCapture) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0MTc3Ng=="}, "originalCommit": {"oid": "7f3271122e44a769e0100afed94776e0d1eb3cc6"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NDYwMjI4OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDozMToxOVrOF4Hq5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDozMToxOVrOF4Hq5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5MDI0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        reporter.report(errorCapture);\n          \n          \n            \n                        errorCapture.end();\n          \n      \n    \n    \n  \n\nLooks like complicating stuff, but there is a good reason for that: there is an implicit lifecycle effect here, where this object is going to be recycled when reported. It's easy to make lifecycle mistakes when it is managed implicitly, as indeed was the case here (see the comment below).\nIn general, calling reporter.report(errorCapture) should be done from a single location and this code should make it clear that we end the object.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394390245", "createdAt": "2020-03-18T14:31:19Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NDY0OTUyOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0MTozNFrOF4IJyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMToxMjozNFrOF-QtkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5ODE1Mg==", "bodyText": "This is a setup for race conditions- once you call report another thread may recycle the ErrorCapture object, so you return an object in an unknown state. There cannot be an API that reports an error AND returns it. You can do this instead:\n    @Nullable\n    public String captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n        String id = null;\n        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n        if (errorCapture != null) {\n            id = errorCapture.getTraceContext().getId().toString();\n            errorCapture.end();\n        }\n        return id;\n    }\n\nI think that would do what you need from it.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394398152", "createdAt": "2020-03-18T14:41:34Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyOTg0MA==", "bodyText": "fixed", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r400829840", "createdAt": "2020-03-31T11:12:34Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5ODE1Mg=="}, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NDY2MTQ5OnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0NDoxNFrOF4IR4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo1MTowOVrOF-QA1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMDIyNg==", "bodyText": "This one can be made private", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394400226", "createdAt": "2020-03-18T14:44:14Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;\n+    }\n+\n+    @Nullable\n+    public ErrorCapture captureException(@Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+        return captureException(System.currentTimeMillis() * 1000, e, parent, initiatingClassLoader);\n     }\n \n     @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwNzAwMw==", "bodyText": "Method\n public ErrorCapture captureException(@Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n        return captureException(System.currentTimeMillis() * 1000, e, parent, initiatingClassLoader);\n    }\n\nused by AbstractLoggingInstrumentation$LoggingAdvice#logEnter .\nDou you mean made as private\nprivate ErrorCapture captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader)", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r400807003", "createdAt": "2020-03-31T10:29:52Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;\n+    }\n+\n+    @Nullable\n+    public ErrorCapture captureException(@Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+        return captureException(System.currentTimeMillis() * 1000, e, parent, initiatingClassLoader);\n     }\n \n     @Nullable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMDIyNg=="}, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxODM4OQ==", "bodyText": "Yes.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r400818389", "createdAt": "2020-03-31T10:51:09Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -419,13 +419,25 @@ private boolean isTransactionSpanLimitReached(Transaction transaction) {\n      * @param e                     the exception to capture\n      * @param initiatingClassLoader the class\n      */\n-    public void captureException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n-        captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+    public void captureAndReportException(@Nullable Throwable e, ClassLoader initiatingClassLoader) {\n+        ErrorCapture errorCapture = captureException(System.currentTimeMillis() * 1000, e, getActive(), initiatingClassLoader);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n     }\n \n     @Nullable\n-    public ErrorCapture captureException(long epochMicros, @Nullable Throwable e, TraceContextHolder<?> parent) {\n-        return captureException(epochMicros, e, parent, null);\n+    public ErrorCapture captureAndReportException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {\n+        ErrorCapture errorCapture = captureException(epochMicros, e, parent, null);\n+        if (errorCapture != null) {\n+            reporter.report(errorCapture);\n+        }\n+        return errorCapture;\n+    }\n+\n+    @Nullable\n+    public ErrorCapture captureException(@Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+        return captureException(System.currentTimeMillis() * 1000, e, parent, initiatingClassLoader);\n     }\n \n     @Nullable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMDIyNg=="}, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NDY2NjQyOnYy", "diffSide": "RIGHT", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceContextHolder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0NToyN1rOF4IVOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMToxMzozMFrOF-Qvmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMTA4Mw==", "bodyText": "This is a race condition (see above). If you change the method as suggested, it would be safe.", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r394401083", "createdAt": "2020-03-18T14:45:27Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceContextHolder.java", "diffHunk": "@@ -168,7 +168,7 @@ public T captureException(@Nullable Throwable t) {\n \n     @Nullable\n     public String captureExceptionAndGetErrorId(@Nullable Throwable t) {\n-        ErrorCapture errorCapture = tracer.captureException(getTraceContext().getClock().getEpochMicros(), t, this);\n+        ErrorCapture errorCapture = tracer.captureAndReportException(getTraceContext().getClock().getEpochMicros(), t, this);\n         return errorCapture != null ? errorCapture.getTraceContext().getId().toString() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgzMDM2Mw==", "bodyText": "changed as suggested", "url": "https://github.com/elastic/apm-agent-java/pull/1050#discussion_r400830363", "createdAt": "2020-03-31T11:13:30Z", "author": {"login": "kananindzya"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceContextHolder.java", "diffHunk": "@@ -168,7 +168,7 @@ public T captureException(@Nullable Throwable t) {\n \n     @Nullable\n     public String captureExceptionAndGetErrorId(@Nullable Throwable t) {\n-        ErrorCapture errorCapture = tracer.captureException(getTraceContext().getClock().getEpochMicros(), t, this);\n+        ErrorCapture errorCapture = tracer.captureAndReportException(getTraceContext().getClock().getEpochMicros(), t, this);\n         return errorCapture != null ? errorCapture.getTraceContext().getId().toString() : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQwMTA4Mw=="}, "originalCommit": {"oid": "a3a301a2c101ace712a6a04c87994940f0e72112"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 458, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}