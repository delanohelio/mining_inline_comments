{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTM1MTA1", "number": 1464, "title": "Fix spring app name startup exception", "bodyText": "What does this PR do?\nDeploying https://github.com/spring-petclinic/spring-framework-petclinic application on a Tomcat server 9.0.x produces the following exception on startup:\njava.lang.UnsupportedOperationException\n\njava.lang.UnsupportedOperationException: Section 4.4 of the Servlet 3.0 specification does not permit this method to be called from a ServletContextListener that was not defined in web.xml, a web-fragment.xml file\n nor annotated with @WebListener                                                                          \n        at org.apache.catalina.core.StandardContext$NoPluggabilityServletContext.getClassLoader(StandardContext.java:6675)\n        at co.elastic.apm.agent.springwebmvc.SpringServiceNameInstrumentation$SpringServiceNameAdvice.afterInitPropertySources(SpringServiceNameInstrumentation.java:75)\n        at org.springframework.web.context.support.AbstractRefreshableWebApplicationContext.initPropertySources(AbstractRefreshableWebApplicationContext.java:214)\n        at org.springframework.context.support.AbstractApplicationContext.prepareRefresh(AbstractApplicationContext.java:600)\n        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:519)\n        at org.springframework.web.context.ContextLoader.configureAndRefreshWebApplicationContext(ContextLoader.java:401)\n        at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:292) \n        at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:103)\n        at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4676)\n        at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5139)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:717)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:690)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:706)        \n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:978)                \n        at org.apache.catalina.startup.HostConfig$DeployWar.run(HostConfig.java:1848)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)      \n        at org.apache.tomcat.util.threads.InlineExecutorService.execute(InlineExecutorService.java:75)                                                                                                               \n        at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:112)                                                                                                                             at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:773)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:427)                                                                                                                                    \n        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1576)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:309)\n        at org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:123)\n        at org.apache.catalina.util.LifecycleBase.setStateInternal(LifecycleBase.java:423)\n        at org.apache.catalina.util.LifecycleBase.setState(LifecycleBase.java:366)\n        at org.apache.catalina.core.ContainerBase.startInternal(ContainerBase.java:936)                                                                                                                              \n        at org.apache.catalina.core.StandardHost.startInternal(StandardHost.java:843)                                                                                                                                \n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)\n        at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1384)\n        at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1374)                                                                                                                           \n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at org.apache.tomcat.util.threads.InlineExecutorService.execute(InlineExecutorService.java:75)\n\n\n\nOn top of that, we can already initialize the application name with getApplicationName() method on the application context.\nChecklist\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix", "createdAt": "2020-10-30T16:48:07Z", "url": "https://github.com/elastic/apm-agent-java/pull/1464", "merged": true, "mergeCommit": {"oid": "7eeda8805e0296a40dc37dbbc5acf5980912a1e0"}, "closed": true, "closedAt": "2020-11-03T13:25:02Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpdlfgH2gAyNTEzMTM1MTA1OjA3MGVjZjZjMDA4MjkwZjM3ZWVjN2I5MWQyMmMwOGJhMmNhYjM5NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY2KRvgH2gAyNTEzMTM1MTA1Ojg3ZTZjYWMzZDBiOTJjZjEyMzI4NzJjNzBkMmI2MTI1M2M1OWUzNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "070ecf6c008290f37eec7b91d22c08ba2cab3950", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/070ecf6c008290f37eec7b91d22c08ba2cab3950", "committedDate": "2020-10-30T16:35:55Z", "message": "fix set app name on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3187fb0ca4364a1b79ff34cd89ebb71e400f4942", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3187fb0ca4364a1b79ff34cd89ebb71e400f4942", "committedDate": "2020-10-30T16:36:14Z", "message": "fix other debug statements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODU2NzYy", "url": "https://github.com/elastic/apm-agent-java/pull/1464#pullrequestreview-520856762", "createdAt": "2020-10-30T16:55:10Z", "commit": {"oid": "3187fb0ca4364a1b79ff34cd89ebb71e400f4942"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1NToxMFrOHrXuJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1NToxMFrOHrXuJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzOTQ2Mg==", "bodyText": "Better guard against null. I've seen servletContext.getContextPath() return null on some application servers.", "url": "https://github.com/elastic/apm-agent-java/pull/1464#discussion_r515239462", "createdAt": "2020-10-30T16:55:10Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-spring-webmvc-plugin/src/main/java/co/elastic/apm/agent/springwebmvc/SpringServiceNameInstrumentation.java", "diffHunk": "@@ -71,9 +71,19 @@\n \n         @Advice.OnMethodExit(suppress = Throwable.class, inline = false)\n         public static void afterInitPropertySources(@Advice.This WebApplicationContext applicationContext) {\n-            if (applicationContext.getServletContext() != null) {\n-                tracer.overrideServiceNameForClassLoader(applicationContext.getServletContext().getClassLoader(), applicationContext.getEnvironment().getProperty(\"spring.application.name\"));\n+\n+            String appName = applicationContext.getEnvironment().getProperty(\"spring.application.name\", \"\");\n+\n+            // fallback when application name isn't set through an environment property\n+            if (appName.isEmpty()) {\n+                appName = applicationContext.getApplicationName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3187fb0ca4364a1b79ff34cd89ebb71e400f4942"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2c8b55b0d246005bfd091838d283d2d5bbdad3", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/eb2c8b55b0d246005bfd091838d283d2d5bbdad3", "committedDate": "2020-11-02T14:46:16Z", "message": "fix using servlet classloader when available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f08a319ac3d5d64b973fbb3058e11a871b4198", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/79f08a319ac3d5d64b973fbb3058e11a871b4198", "committedDate": "2020-11-02T14:55:04Z", "message": "improve comment about double invocation for tomcat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f51ae605548824ed2d4a05f7347cfad4a16b76b", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/6f51ae605548824ed2d4a05f7347cfad4a16b76b", "committedDate": "2020-11-02T14:59:45Z", "message": "defensively avoid null classloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fae41629aee6c04fe754bd072e4814dabfa583c", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/5fae41629aee6c04fe754bd072e4814dabfa583c", "committedDate": "2020-11-03T08:25:59Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e6cac3d0b92cf1232872c70d2b61253c59e368", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/87e6cac3d0b92cf1232872c70d2b61253c59e368", "committedDate": "2020-11-03T09:57:31Z", "message": "Merge branch 'master' into fix-spring-app-name-startup-exception"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3699, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}