{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NTM4NDI0", "number": 1015, "title": "return error id with captureException in public api", "bodyText": "What does this PR do?\n\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc\n Added an API method or config option? Document in which version this will be introduced\n\nAuthor's Checklist\n\nRelated issues\n\nCloses #813\nUse cases\n\nScreenshots", "createdAt": "2020-01-29T12:48:08Z", "url": "https://github.com/elastic/apm-agent-java/pull/1015", "merged": true, "mergeCommit": {"oid": "8c492ec2510bade9d7a03bd9a04b9afe6170b37e"}, "closed": true, "closedAt": "2020-02-13T12:41:58Z", "author": {"login": "kananindzya"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_Hjc8gBqjI5ODk5MjM5ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD4VEUgBqjMwMzQyNjI5ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0df9e7dbb06ce7e671df582f0135292f1b9cc253", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/0df9e7dbb06ce7e671df582f0135292f1b9cc253", "committedDate": "2020-01-29T15:07:03Z", "message": "added tests."}, "afterCommit": {"oid": "d1ee5b0ba6b715ef47333bf062e12127d1ca00e9", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/d1ee5b0ba6b715ef47333bf062e12127d1ca00e9", "committedDate": "2020-01-29T15:19:41Z", "message": "miss imports removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjM5ODI2", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-350639826", "createdAt": "2020-01-30T08:12:07Z", "commit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODoxMjowN1rOFjiUjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODozNDowNFrOFji1kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw==", "bodyText": "I don't think we need this API, it doesn't save much to the caller (only extract the ID). The one returning the ErrorCapture is very useful as is.\nI can easily imaging how a caller may want to do lots of other stuff with the ErrorCapture and we wouldn't add an API for each usage.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372806797", "createdAt": "2020-01-30T08:12:07Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -320,7 +321,14 @@ public void captureException(long epochMicros, @Nullable Throwable e, TraceConte\n         captureException(epochMicros, e, parent, null);\n     }\n \n-    public void captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+    @Nullable\n+    public String captureExceptionAndGetErrorId(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwODk5Nw==", "bodyText": "Better call transaction.captureException, then you test both added methods.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372808997", "createdAt": "2020-01-30T08:17:52Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/ElasticApmTracerTest.java", "diffHunk": "@@ -489,4 +490,17 @@ void testOverrideServiceNameExplicitServiceName() {\n         tracer.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader()).end();\n         assertThat(reporter.getFirstTransaction().getTraceContext().getServiceName()).isNull();\n     }\n+\n+    @Test\n+    void testCaptureExceptionAndGetErrorId() {\n+        Transaction transaction = tracerImpl.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader());\n+        String errorId = tracerImpl.captureExceptionAndGetErrorId(System.currentTimeMillis() * 1000, new Exception(\"test\"), transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxNTI1MA==", "bodyText": "This probably won't work when a user upgrades the agent and not the API (a very valid scenario)- the agent will instrument the captureException API that returns void and the instrumentation will expect a String being returned.\nWhat you need to do is change the constructor of this class, so that the method matcher is more specific on the return type, probably something like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.VOID)) and add another CaptureExceptionWithReturnIdInstrumentation class that uses a method matcher like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.STRING)) and does what you did here.\nEventually, you must test your branch's agent with an older API jar, and you should test your branch's API jar with an older agent. We don't have automatic tests for that, but should be easy to do manually.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372815250", "createdAt": "2020-01-30T08:34:04Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-api-plugin/src/main/java/co/elastic/apm/agent/plugin/api/AbstractSpanInstrumentation.java", "diffHunk": "@@ -178,8 +178,9 @@ public CaptureExceptionInstrumentation() {\n         @VisibleForAdvice\n         @Advice.OnMethodExit(suppress = Throwable.class)\n         public static void captureException(@Advice.FieldValue(value = \"span\", typing = Assigner.Typing.DYNAMIC) TraceContextHolder<?> context,\n-                                            @Advice.Argument(0) Throwable t) {\n-            context.captureException(t);\n+                                            @Advice.Argument(0) Throwable t,\n+                                            @Advice.Return(readOnly = false) String errorId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTA0MjM4", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-350904238", "createdAt": "2020-01-30T15:18:52Z", "commit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNToxODo1M1rOFjuzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNToxODo1M1rOFjuzXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw==", "bodyText": "Technically, this is a breaking change in binary compatibility. When not re-compiling the application and updating the dependency, it would result in an exception when calling the method. That is because methods are linked also based on their return type.\nBut still think we can leave it as-is as most likely, someone would re-compile the application again after updating the dependency to the agent API.\nA more conservative option would be to create a method with a different name, like captureExceptionAndReturnErrorId and leave void captureException(Throwable throwable) as-is.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373011293", "createdAt": "2020-01-30T15:18:53Z", "author": {"login": "felixbarny"}, "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a596e908dfe1ff405c9e16404fe0ae29859ee873"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDc5NjA1", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-353079605", "createdAt": "2020-02-04T15:42:23Z", "commit": {"oid": "56933a35333a850d162619440a6ba8c984fdc914"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDMzMTkz", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-357433193", "createdAt": "2020-02-12T13:03:55Z", "commit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDAyNDM3", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-358002437", "createdAt": "2020-02-13T07:32:39Z", "commit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDAzMjA2", "url": "https://github.com/elastic/apm-agent-java/pull/1015#pullrequestreview-358003206", "createdAt": "2020-02-13T07:34:27Z", "commit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDoyN1rOFpJghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzozNDo1OFrOFpJhHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5MTcxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Captures an exception and reports it to the APM server. Returns the id of reported error.\n          \n          \n            \n            Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r378691716", "createdAt": "2020-02-13T07:34:27Z", "author": {"login": "eyalkoren"}, "path": "docs/public-api.asciidoc", "diffHunk": "@@ -382,8 +382,8 @@ transaction.setUser(user.getId(), user.getEmail(), user.getUsername());\n \n [float]\n [[api-transaction-capture-exception]]\n-==== `void captureException(Exception e)`\n-Captures an exception and reports it to the APM server.\n+==== `String captureException(Exception e)`\n+Captures an exception and reports it to the APM server. Returns the id of reported error.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5MTg3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Captures an exception and reports it to the APM server. Returns the id of reported error.\n          \n          \n            \n            Captures an exception and reports it to the APM server. Since version 1.14.0 - returns the id of reported error.", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r378691871", "createdAt": "2020-02-13T07:34:58Z", "author": {"login": "eyalkoren"}, "path": "docs/public-api.asciidoc", "diffHunk": "@@ -666,8 +666,8 @@ span.addLabel(\"foo\", \"bar\");\n \n [float]\n [[api-span-capture-exception]]\n-==== `void captureException(Exception e)`\n-Captures an exception and reports it to the APM server.\n+==== `String captureException(Exception e)`\n+Captures an exception and reports it to the APM server. Returns the id of reported error.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63480ba1e096ffd9ef9b92be839569f867c98200"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20a0487b1c324d55cef3ac2d45d082808dbf8532", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/20a0487b1c324d55cef3ac2d45d082808dbf8532", "committedDate": "2020-02-13T10:23:28Z", "message": "return error id with captureException in public api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656f715830ad1fa053bce0e64b50238e1572559a", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/656f715830ad1fa053bce0e64b50238e1572559a", "committedDate": "2020-02-13T10:23:28Z", "message": "added tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0afc44ccb9a54338c664efcb0965aaba88e12715", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/0afc44ccb9a54338c664efcb0965aaba88e12715", "committedDate": "2020-02-13T10:23:28Z", "message": "miss imports removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd87fd63c21451a34ed9a50e0850254c6a505ddf", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/dd87fd63c21451a34ed9a50e0850254c6a505ddf", "committedDate": "2020-02-13T10:23:28Z", "message": "added nullable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "148c5f6e8a38817f70620dd90b65dcdfc3283c00", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/148c5f6e8a38817f70620dd90b65dcdfc3283c00", "committedDate": "2020-02-13T10:23:28Z", "message": "minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a20f31db6df2f2bc38fdaa9960e4eb9577d7a7e2", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/a20f31db6df2f2bc38fdaa9960e4eb9577d7a7e2", "committedDate": "2020-02-13T10:23:28Z", "message": "fix styles and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33dc26662237468ce86a7f334eadd65fb55a5f5", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/f33dc26662237468ce86a7f334eadd65fb55a5f5", "committedDate": "2020-02-13T10:23:32Z", "message": "minor fixes. added doccumentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f332d4f4808b8f65fb0191eb6b53826d29ea35b", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/7f332d4f4808b8f65fb0191eb6b53826d29ea35b", "committedDate": "2020-02-13T10:23:32Z", "message": "deleted captureExceptionAndReturnErrorId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b5c3efe480867b514b9b717cee3470832317f17", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0b5c3efe480867b514b9b717cee3470832317f17", "committedDate": "2020-02-13T10:23:32Z", "message": "use assertj matcher for consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5eb7f08deae7b2073c6397c64d12a55b3e0506b", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c5eb7f08deae7b2073c6397c64d12a55b3e0506b", "committedDate": "2020-02-13T10:23:32Z", "message": "ensure compatibility with previous API versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d20376279f4d8bc834eee088e36de43820ed0fa", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/8d20376279f4d8bc834eee088e36de43820ed0fa", "committedDate": "2020-02-13T10:23:32Z", "message": "add minor javadoc + rename as 'legacy'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7fa926728ed5c0977ae7f1f4638fd34958e5a70", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a7fa926728ed5c0977ae7f1f4638fd34958e5a70", "committedDate": "2020-02-13T10:23:32Z", "message": "Update docs/public-api.asciidoc\r\n\r\ndocument API change in 1.14.0\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dfdccd5005b500e62fdc7f0240adf5577bb7760", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4dfdccd5005b500e62fdc7f0240adf5577bb7760", "committedDate": "2020-02-13T10:23:32Z", "message": "Update docs/public-api.asciidoc\r\n\r\ndocument API change in 1.14.0\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2249da6d5fc9aa58327af5b3702cef678f2b9417", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/2249da6d5fc9aa58327af5b3702cef678f2b9417", "committedDate": "2020-02-13T10:25:00Z", "message": "added feature to changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db9662add12257fe151e9b2fb5ca8af802dc5a02", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/db9662add12257fe151e9b2fb5ca8af802dc5a02", "committedDate": "2020-02-13T08:03:01Z", "message": "Merge branch 'issue-813-return-span-error-id' of github.com:kananindzya/apm-agent-java into issue-813-return-span-error-id"}, "afterCommit": {"oid": "2249da6d5fc9aa58327af5b3702cef678f2b9417", "author": {"user": null}, "url": "https://github.com/elastic/apm-agent-java/commit/2249da6d5fc9aa58327af5b3702cef678f2b9417", "committedDate": "2020-02-13T10:25:00Z", "message": "added feature to changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4063, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}