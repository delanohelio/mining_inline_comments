{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODYzMTQ3", "number": 1020, "title": "Add log correlation for log4j and log4j2", "bodyText": "What does this PR do?\n\ncloses #922\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc\n I have updated supported-technologies.asciidoc\n- [ ] Added an API method or config option? Document in which version this will be introduced\n- [ ] Added an instrumentation plugin? How did you make sure that old, non-supported versions are not instrumented by accident?", "createdAt": "2020-02-04T14:19:56Z", "url": "https://github.com/elastic/apm-agent-java/pull/1020", "merged": true, "mergeCommit": {"oid": "d72477426c55682b8b1f6ea3d48ffe86526a0858"}, "closed": true, "closedAt": "2020-02-10T08:36:40Z", "author": {"login": "felixbarny"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBCQbxAH2gAyMzcwODYzMTQ3OmE3ZjZmNmQ2NWIxNjkxZjJkYjIxNDU4MDNmNjE3ZjlhYjdlNjg0NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC4sgxAFqTM1NTc0ODc3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7f6f6d65b1691f2db2145803f617f9ab7e68463", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/a7f6f6d65b1691f2db2145803f617f9ab7e68463", "committedDate": "2020-02-04T14:17:46Z", "message": "Add log correlation for log4j and log4j2\n\ncloses #922"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Njg2NDYy", "url": "https://github.com/elastic/apm-agent-java/pull/1020#pullrequestreview-355686462", "createdAt": "2020-02-10T04:29:31Z", "commit": {"oid": "a7f6f6d65b1691f2db2145803f617f9ab7e68463"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNDoyOTozMVrOFnZ-vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNDozNjo1NFrOFnaDAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2NDQ0Nw==", "bodyText": "The returned message is not really used, but change it to something generic so that it won't be misleading (same for the comment)", "url": "https://github.com/elastic/apm-agent-java/pull/1020#discussion_r376864447", "createdAt": "2020-02-10T04:29:31Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/main/java/co/elastic/apm/agent/slf4j/Slf4JMdcActivationListener.java", "diffHunk": "@@ -41,44 +41,101 @@\n \n public class Slf4JMdcActivationListener implements ActivationListener {\n \n-    // the string concatenation prevents the shade plugin from relocating org.slf4j.MDC to co.elastic.apm.agent.shaded.slf4j.MDC\n-    // the toString prevents constant folding, which would also make the shade plugin relocate\n-    private static final String ORG_SLF4J_MDC = \"org.\" + \"slf4j.MDC\".toString();\n+    // prevents the shade plugin from relocating org.slf4j.MDC to co.elastic.apm.agent.shaded.slf4j.MDC\n+    private static final String SLF4J_MDC = \"org!slf4j!MDC\".replace('!', '.');\n+    private static final String LOG4J_MDC = \"org.apache.log4j.MDC\";\n+    private static final String LOG4J2_MDC = \"org.apache.logging.log4j.ThreadContext\";\n+\n     private static final String TRACE_ID = \"trace.id\";\n     private static final String TRANSACTION_ID = \"transaction.id\";\n     private static final Logger logger = LoggerFactory.getLogger(Slf4JMdcActivationListener.class);\n \n     // Never invoked- only used for caching ClassLoaders that can't load the slf4j MDC class\n     private static final MethodHandle NOOP = MethodHandles.constant(String.class, \"ClassLoader cannot load slf4j API\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f6f6d65b1691f2db2145803f617f9ab7e68463"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2NTUzNw==", "bodyText": "What is this?", "url": "https://github.com/elastic/apm-agent-java/pull/1020#discussion_r376865537", "createdAt": "2020-02-10T04:36:54Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-plugins/apm-log-correlation-plugin/src/test/java/co/elastic/apm/agent/slf4j/Slf4JMdcActivationListenerTest.java", "diffHunk": "@@ -49,12 +53,25 @@\n \n     private LoggingConfiguration loggingConfiguration;\n     private CoreConfiguration coreConfiguration;\n+    private Boolean log4jMdcWorking;\n+    private ExecutorService executorService = Executors.newSingleThreadExecutor();\n \n     @BeforeEach\n-    void setUp() {\n+    void setUp() throws Exception {\n+        org.apache.log4j.MDC.put(\"test\", true);\n+        log4jMdcWorking = (Boolean) org.apache.log4j.MDC.get(\"test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f6f6d65b1691f2db2145803f617f9ab7e68463"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f2c99ecf57fa88042cd87fd09ae1e2d12cc86f2", "author": {"user": {"login": "felixbarny", "name": "Felix Barnsteiner"}}, "url": "https://github.com/elastic/apm-agent-java/commit/7f2c99ecf57fa88042cd87fd09ae1e2d12cc86f2", "committedDate": "2020-02-10T07:54:27Z", "message": "Apply suggestions from code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzQ4Nzcx", "url": "https://github.com/elastic/apm-agent-java/pull/1020#pullrequestreview-355748771", "createdAt": "2020-02-10T08:17:14Z", "commit": {"oid": "7f2c99ecf57fa88042cd87fd09ae1e2d12cc86f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4070, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}