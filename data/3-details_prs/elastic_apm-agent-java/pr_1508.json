{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTk3MzA4", "number": 1508, "title": "remove useless allocation in TraceState.copyOf()", "bodyText": "What does this PR do?\nFixes #1503\nChecklist\n\n This is a bugfix\n\n I have updated CHANGELOG.asciidoc\n I have added tests that would fail without this fix tested locally with async-profiler", "createdAt": "2020-11-12T16:19:26Z", "url": "https://github.com/elastic/apm-agent-java/pull/1508", "merged": true, "mergeCommit": {"oid": "1cbed060b6fcd2bdd3f77f93264f7123b012085f"}, "closed": true, "closedAt": "2020-11-24T19:19:20Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb0u_lgH2gAyNTE5OTk3MzA4OjNjYjM0NDRiNDY0YzVjMjIwZTZlZTJhYTVhMzIyODI5NjMwYmRmZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfrN8RAH2gAyNTE5OTk3MzA4Ojc2ZTYxNjVhOTUyZmE5MzA4ZTlhMGQ0ODQ1NTZiZDliODRkNGZlNmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3cb3444b464c5c220e6ee2aa5a322829630bdfeb", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3cb3444b464c5c220e6ee2aa5a322829630bdfeb", "committedDate": "2020-11-12T15:59:35Z", "message": "remove useless copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41fcc9d9a0bd16e58fe846804b241c654d568942", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/41fcc9d9a0bd16e58fe846804b241c654d568942", "committedDate": "2020-11-12T16:19:57Z", "message": "more efficient array copy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNzY5NjI5", "url": "https://github.com/elastic/apm-agent-java/pull/1508#pullrequestreview-530769629", "createdAt": "2020-11-15T06:07:55Z", "commit": {"oid": "41fcc9d9a0bd16e58fe846804b241c654d568942"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQwNjowNzo1NVrOHzc6hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQwNjowNzo1NVrOHzc6hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcxMzE1OQ==", "bodyText": "We cannot do that - this leaks one TraceState's member (the header field) to another. Given that these are recyclable (reused) objects means it can be a mess.", "url": "https://github.com/elastic/apm-agent-java/pull/1508#discussion_r523713159", "createdAt": "2020-11-15T06:07:55Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceState.java", "diffHunk": "@@ -65,10 +65,15 @@ public void copyFrom(TraceState other) {\n         sampleRate = other.sampleRate;\n         sizeLimit = other.sizeLimit;\n         tracestate.clear();\n-        // copy and make sure we have the immutable variant\n+\n+        // While this is not a deep-copy and we don't explicitly make it immutable by using CharSequence.\n+        // It's not required as entries are never modified once added.\n+        // Doing so allows to bypass any copy for String/StringBuilder in the collection\n         for (int i = 0; i < other.tracestate.size(); i++) {\n-            tracestate.add(other.tracestate.get(i).toString());\n+            //noinspection UseBulkOperation\n+            tracestate.add(other.tracestate.get(i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41fcc9d9a0bd16e58fe846804b241c654d568942"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07950380fe1a7a03321d89f609cbdab085e87a7f", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/07950380fe1a7a03321d89f609cbdab085e87a7f", "committedDate": "2020-11-18T09:31:40Z", "message": "use full header to minimize allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "043679b782da83fe205792b30a910fd7b1ba81e3", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/043679b782da83fe205792b30a910fd7b1ba81e3", "committedDate": "2020-11-18T12:36:18Z", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-tracestate-extra-allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1662e1236a4932d519d2ae7133e799d7004a1956", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1662e1236a4932d519d2ae7133e799d7004a1956", "committedDate": "2020-11-19T19:10:01Z", "message": "Merge branch 'master' into fix-tracestate-extra-allocation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDc2MjQ3", "url": "https://github.com/elastic/apm-agent-java/pull/1508#pullrequestreview-536476247", "createdAt": "2020-11-23T13:35:13Z", "commit": {"oid": "043679b782da83fe205792b30a910fd7b1ba81e3"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzozNToxM1rOH4Nr3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzo0MDozOFrOH4N5Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwNjUyNA==", "bodyText": "We can remove this one I guess\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String rateString;", "url": "https://github.com/elastic/apm-agent-java/pull/1508#discussion_r528706524", "createdAt": "2020-11-23T13:35:13Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/sampling/ConstantSampler.java", "diffHunk": "@@ -36,12 +37,15 @@\n \n     private final boolean decision;\n     private final double rate;\n+\n     private final String rateString;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "043679b782da83fe205792b30a910fd7b1ba81e3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwODY5OQ==", "bodyText": "I didn't get this comment", "url": "https://github.com/elastic/apm-agent-java/pull/1508#discussion_r528708699", "createdAt": "2020-11-23T13:38:42Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/sampling/ProbabilitySampler.java", "diffHunk": "@@ -56,16 +56,16 @@\n     private final double sampleRate;\n \n     // Because header value only contains sampling rate, we can cache it here\n-    private final String rateString;\n+    private final String traceStateHeader;\n \n     private ProbabilitySampler(double samplingRate) {\n-        higherBound = (long) (Long.MAX_VALUE * samplingRate);\n-        lowerBound = -higherBound;\n+        this.higherBound = (long) (Long.MAX_VALUE * samplingRate);\n+        this.lowerBound = -higherBound;\n         this.sampleRate = samplingRate;\n-        rateString = Double.toString(samplingRate);\n+        this.traceStateHeader = TraceState.getHeaderValue(samplingRate);\n     }\n \n-    public static Sampler of(double samplingRate) {\n+    public static Sampler of(double samplingRate) { // use 'Double' here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "043679b782da83fe205792b30a910fd7b1ba81e3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwOTkwNw==", "bodyText": "\ud83d\udc4d  Can be added to the javadoc", "url": "https://github.com/elastic/apm-agent-java/pull/1508#discussion_r528709907", "createdAt": "2020-11-23T13:40:38Z", "author": {"login": "eyalkoren"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/sampling/Sampler.java", "diffHunk": "@@ -57,8 +57,10 @@\n      */\n     double getSampleRate();\n \n+    // While header is not related to sampler itself, putting this here allows to reuse the same\n+    // String instance as long as the sample rate does not change to minimize allocation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "043679b782da83fe205792b30a910fd7b1ba81e3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d996b8b0778bee0f68c39152d48e8914d340330e", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/d996b8b0778bee0f68c39152d48e8914d340330e", "committedDate": "2020-11-23T19:00:46Z", "message": "cleanup PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48ed43808bd26a3fde46495fdb1a27a431f77b09", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/48ed43808bd26a3fde46495fdb1a27a431f77b09", "committedDate": "2020-11-24T15:08:23Z", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-tracestate-extra-allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76e6165a952fa9308e9a0d484556bd9b84d4fe6b", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/76e6165a952fa9308e9a0d484556bd9b84d4fe6b", "committedDate": "2020-11-24T15:10:02Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3592, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}