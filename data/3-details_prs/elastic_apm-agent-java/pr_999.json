{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NzI5NDU0", "number": 999, "title": "JMS fix: transfer header on non-sampled traces", "bodyText": "What does this PR do?\n\nOur distributed tracing sampling relies on context propagation. Currently, context propagation doesn't work in traces using JMS. This PR fixes that.\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc", "createdAt": "2020-01-22T08:39:44Z", "url": "https://github.com/elastic/apm-agent-java/pull/999", "merged": true, "mergeCommit": {"oid": "6a02aeb4a135241530323c709f3595b02106e823"}, "closed": true, "closedAt": "2020-01-23T07:26:54Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8xil3gH2gAyMzY1NzI5NDU0OjVhZWViN2YzZjI2YzEwYjRlNDg5ODZhZmUzMDNmNWNiMmMzZTFkN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9FJG7gH2gAyMzY1NzI5NDU0OmJlMGE0ZmYxMjRlZTg5ZDliNDMwZDczMjJkMzAzYmRhZmNlMmEwNGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5aeeb7f3f26c10b4e48986afe303f5cb2c3e1d7b", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/5aeeb7f3f26c10b4e48986afe303f5cb2c3e1d7b", "committedDate": "2020-01-22T08:33:31Z", "message": "Transfer JMS header on non-sampled traces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "committedDate": "2020-01-22T12:11:15Z", "message": "Remove public setSampled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjU2ODc4", "url": "https://github.com/elastic/apm-agent-java/pull/999#pullrequestreview-346656878", "createdAt": "2020-01-22T15:04:33Z", "commit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjM1NzE1", "url": "https://github.com/elastic/apm-agent-java/pull/999#pullrequestreview-346635715", "createdAt": "2020-01-22T14:38:04Z", "commit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDozODowNFrOFgeaCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNToxMzo1N1rOFgfwHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5NjkzOQ==", "bodyText": "does it means that we will provide tracing headers even if the transaction itself is not being sampled ?\nIf so, does it means that we need to make sure that all instrumentations that might propagate context should still work even if sampling is not enabled ?", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369596939", "createdAt": "2020-01-22T14:38:04Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-jms-plugin/src/main/java/co/elastic/apm/agent/jms/JmsInstrumentationHelperImpl.java", "diffHunk": "@@ -97,8 +97,8 @@ public Span startJmsSendSpan(Destination destination, Message message) {\n             .activate();\n \n         try {\n+            message.setStringProperty(JMS_TRACE_PARENT_PROPERTY, span.getTraceContext().getOutgoingTraceParentHeader().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxNjI5Nw==", "bodyText": "why do we need to reset the reporter here ?", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369616297", "createdAt": "2020-01-22T15:09:30Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-jms-plugin/src/test/java/co/elastic/apm/agent/jms/JmsInstrumentationIT.java", "diffHunk": "@@ -208,6 +219,25 @@ public void testQueueSendReceiveOnNonTracedThread() throws Exception {\n         doTestSendReceiveOnNonTracedThread(() -> brokerFacade.receive(queue, 10), queue, false);\n     }\n \n+    @SuppressWarnings(\"ConstantConditions\")\n+    @Test\n+    public void testQueueSendReceiveOnNonTracedThread_NonSampledTransaction() throws Exception {\n+        final Queue queue = createTestQueue();\n+\n+        // End current transaction and start a non-sampled one\n+        tracer.currentTransaction().deactivate().end();\n+        reporter.reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxODk3Mg==", "bodyText": "what about having the annotation directly on isSampled method in order to avoid duplicates of //noinspection ConstantConditions ?", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369618972", "createdAt": "2020-01-22T15:13:57Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-jms-plugin/src/test/java/co/elastic/apm/agent/jms/JmsInstrumentationIT.java", "diffHunk": "@@ -386,7 +416,10 @@ private void verifyQueueSendReceiveOnNonTracedThread(Queue queue)\n         Message incomingMessage = resultQ.poll(2, TimeUnit.SECONDS);\n         assertThat(incomingMessage).isNotNull();\n         verifyMessage(message, incomingMessage);\n-        verifySendReceiveOnNonTracedThread(queue.getQueueName(), outgoingMessage);\n+        //noinspection ConstantConditions\n+        if (tracer.currentTransaction().isSampled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af31f574b0942aaee4f7318df6bb2fae049211f", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9af31f574b0942aaee4f7318df6bb2fae049211f", "committedDate": "2020-01-23T07:21:00Z", "message": "Merge remote-tracking branch 'upstream/master' into jms-context-transfer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be0a4ff124ee89d9b430d7322d303bdafce2a04c", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/be0a4ff124ee89d9b430d7322d303bdafce2a04c", "committedDate": "2020-01-23T07:23:47Z", "message": "Add to CHANGELOG"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4050, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}