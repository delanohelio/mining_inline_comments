{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMzM0NTAy", "number": 1196, "title": "gRPC memory leak fix + bench test app", "bodyText": "Fixes #1191 .\nThis PR contains:\n\na fix for the memory leak instrumentation implementation\na \"benchmark mode\" for test applications that we can use from CLI, which helps to reproduce similar errors (and could be used later to measure performance impact).\na simplification of existing implementation thanks to @felixbarny that makes memory leaks harder to create.", "createdAt": "2020-05-21T12:49:45Z", "url": "https://github.com/elastic/apm-agent-java/pull/1196", "merged": true, "mergeCommit": {"oid": "c2629677a9393ba3412d5c75154abde87078c0fd"}, "closed": true, "closedAt": "2020-06-15T15:30:36Z", "author": {"login": "SylvainJuge"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjdFg1AH2gAyNDIxMzM0NTAyOmVjOTRlYjYyM2M5ODgyMmYyZmE5MTAyODU4ZTVmYjFjNWIyM2VmY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrhi-tAH2gAyNDIxMzM0NTAyOjA5ZGRjNGFjNjg0ODBlNWI1N2FkOWRhNTc5NTgwYjE5ZDVmNzE1YWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ec94eb623c98822f2fa9102858e5fb1c5b23efcd", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/ec94eb623c98822f2fa9102858e5fb1c5b23efcd", "committedDate": "2020-05-21T12:46:42Z", "message": "remove servercall leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc40538e4c86a1496a7f1dffa729d98a48371fc9", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/fc40538e4c86a1496a7f1dffa729d98a48371fc9", "committedDate": "2020-05-27T15:39:37Z", "message": "add benchmark to test app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0197a0e8cdfbb1b91e1b4ce6484f13536476f2f", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a0197a0e8cdfbb1b91e1b4ce6484f13536476f2f", "committedDate": "2020-05-27T15:42:49Z", "message": "update test app readme with new options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5540834404db59d569344c846b579323b40b74a", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/b5540834404db59d569344c846b579323b40b74a", "committedDate": "2020-05-27T16:09:22Z", "message": "add wait option for interactive start/end"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3263c94cff0b106c1f9c880731e6f04e7d2f6323", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/3263c94cff0b106c1f9c880731e6f04e7d2f6323", "committedDate": "2020-05-27T16:30:16Z", "message": "init server with limited pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "921071fd53a00311a19ae4f31868510f659c637f", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/921071fd53a00311a19ae4f31868510f659c637f", "committedDate": "2020-05-29T08:13:13Z", "message": "avoid infinite nested calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eadbbfad6dee0c96800c7999970edebdbe57d771", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/eadbbfad6dee0c96800c7999970edebdbe57d771", "committedDate": "2020-05-29T18:40:50Z", "message": "add deadline and fix too deep nested calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71891016830d6f6dcbdf1844b57e98ddf2704adf", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/71891016830d6f6dcbdf1844b57e98ddf2704adf", "committedDate": "2020-06-03T14:18:23Z", "message": "fix memory leak by terminating at 'onHalfClose'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81dd85afe98c3abe9ab498f8da9d655540e65aa", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c81dd85afe98c3abe9ab498f8da9d655540e65aa", "committedDate": "2020-06-05T13:20:54Z", "message": "relax deadline for CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79a09878e46e562ae4efc02ba0fca0ce808569e", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/c79a09878e46e562ae4efc02ba0fca0ce808569e", "committedDate": "2020-06-08T08:37:23Z", "message": "use random port for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4cf5cce44e4cff71877846a422182b1b3d9efd", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/df4cf5cce44e4cff71877846a422182b1b3d9efd", "committedDate": "2020-06-08T09:10:04Z", "message": "move random port to core module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9ebd149e6725ce921467cf2c3d41db5f09b956e7", "committedDate": "2020-06-08T16:25:26Z", "message": "avoid using all server threads in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTM0MzY5", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-426534369", "createdAt": "2020-06-08T19:02:22Z", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowMjoyMlrOGgr88A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowMjoyMlrOGgr88A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNzcyOA==", "bodyText": "this change was the one that fixed the memory leak, as it seems that some calls to onComplete are not always executed at all, or are executed in an unexpected order.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436927728", "createdAt": "2020-06-08T19:02:22Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -151,7 +148,14 @@ public FinalMethodCall(ElasticApmTracer tracer) {\n                 //\n                 // call complete (but client not guaranteed to get all messages)\n                 // --> end of unary call (success)\n-                .or(named(\"onComplete\"));\n+                .or(named(\"onComplete\"))\n+                //\n+                // client completed all message sending, but can still cancel the call\n+                // --> for unary calls, actual method invocation is done within 'onHalfClose' method, and there is no\n+                // call to 'onComplete', thus consider it as 'final' allows to properly perform cleanup as it's the last\n+                // method that will be invoked on the listener.\n+                //\n+                .or(named(\"onHalfClose\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTM0OTQz", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-426534943", "createdAt": "2020-06-08T19:03:09Z", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowMzowOVrOGgr_tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowMzowOVrOGgr_tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyODQzOQ==", "bodyText": "this allows to have more than one test running on the same host without conflict.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436928439", "createdAt": "2020-06-08T19:03:09Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/GrpcTest.java", "diffHunk": "@@ -26,10 +26,11 @@\n \n import co.elastic.apm.agent.grpc.testapp.GrpcApp;\n import co.elastic.apm.agent.grpc.testapp.GrpcAppProvider;\n+import co.elastic.apm.agent.testutils.TestPort;\n \n public class GrpcTest {\n \n-    private static final int PORT = 50051;\n+    private static final int PORT = TestPort.getAvailableRandomPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTM3NDI4", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-426537428", "createdAt": "2020-06-08T19:05:06Z", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowNTowNlrOGgsF5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowNTowNlrOGgsF5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzMDAyMw==", "bodyText": "this one deserves a facepalm and was the cause of the failure on CI, as CI server has less cores than a decent laptop (likely 4), thus server was running with 2 threads in thread pool, which makes the 3rd nested call fail with a missed deadline.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436930023", "createdAt": "2020-06-08T19:05:06Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/AbstractGrpcAppTest.java", "diffHunk": "@@ -86,9 +87,15 @@ void simpleErrorCall() {\n     @Test\n     void nestedChecks() {\n         for (SendAndCheckMessageStrategy strategy : STRATEGIES) {\n-            strategy.sendAndCheckMessage(app, \"joe\", 0, \"hello(joe)\");\n-            strategy.sendAndCheckMessage(app, \"bob\", 1, \"nested(1)->hello(bob)\");\n-            strategy.sendAndCheckMessage(app, \"rob\", 2, \"nested(2)->nested(1)->hello(rob)\");\n+            // because nested call is done with a blocking call, we have to make sure that we don't use all sever\n+            // threads otherwise we get exceeded deadlines\n+            for (int depth = 0; depth < HelloServer.POOL_SIZE; depth++) {\n+                StringBuilder prefix = new StringBuilder();\n+                for (int i = 1; i <= depth; i++) {\n+                    prefix.insert(0, String.format(\"nested(%d)->\", i));\n+                }\n+                strategy.sendAndCheckMessage(app, \"joe\", depth, prefix + \"hello(joe)\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTM4MjQw", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-426538240", "createdAt": "2020-06-08T19:05:39Z", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowNTozOVrOGgsH4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTowNTozOVrOGgsH4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkzMDUzMA==", "bodyText": "adding a deadline makes remote calls fail with timeout instead of waiting forever.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r436930530", "createdAt": "2020-06-08T19:05:39Z", "author": {"login": "SylvainJuge"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/test/java/co/elastic/apm/agent/grpc/testapp/HelloClient.java", "diffHunk": "@@ -37,17 +38,23 @@\n import java.util.concurrent.Future;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.atomic.AtomicReference;\n import java.util.stream.Collectors;\n \n public abstract class HelloClient<Req, Rep> {\n \n     private static final Logger logger = LoggerFactory.getLogger(HelloClient.class);\n-\n     private final ManagedChannel channel;\n+    private final AtomicLong errorCount;\n \n     protected HelloClient(ManagedChannel channel) {\n         this.channel = channel;\n+        this.errorCount = new AtomicLong(0);\n+    }\n+\n+    protected static Deadline getDeadline() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTIxNjQy", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-426921642", "createdAt": "2020-06-09T08:49:41Z", "commit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODo0OTo0MVrOGg_IMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODo0OTo0NlrOGg_IVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTkwNA==", "bodyText": "You can also use port 0 which makes it open a random free port, without you having to manually try port after port.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r437241904", "createdAt": "2020-06-09T08:49:41Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/testutils/TestPort.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.testutils;\n+\n+import javax.net.ServerSocketFactory;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.util.Random;\n+\n+public class TestPort {\n+\n+    private static final Random rand = new Random(System.currentTimeMillis());\n+\n+    private static final int MIN_PORT = 1024;\n+    private static final int MAX_PORT = 65536;\n+\n+    /**\n+     * @return random available TCP port\n+     */\n+    public static int getAvailableRandomPort() {\n+        int port;\n+        do {\n+            port = MIN_PORT + rand.nextInt(MAX_PORT - MIN_PORT + 1);\n+        } while (!isAvailablePort(port));\n+        return port;\n+    }\n+\n+    private static boolean isAvailablePort(int port) {\n+        try {\n+            ServerSocket serverSocket = ServerSocketFactory.getDefault().createServerSocket(port, 1, InetAddress.getByName(\"localhost\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI0MTk0Mw==", "bodyText": "I don't think that's the issue. The problem is that we're only instrumenting server call listeners, that contain Unary in the class name. The UnaryServerCallListener doesn't override the noop onComplete callback.\nAnother issue is that the transaction is ended in co.elastic.apm.agent.grpc.ServerCallInstrumentation#onExit (on ServerCall#close). The effect is that even when instrumenting io.grpc.ServerCall.Listener#onComplete, the helper is not called, because the transaction has already ended.\nFurthermore, the fact that inFlightServerListeners is of type WeakConcurrentMap<ServerCall.Listener<?>, ServerCall<?, ?>> imposes a risk of a memory leak as ServerCall is not a weak reference. Have you considered mapping directly to the transaction (WeakConcurrentMap<ServerCall.Listener<?>, Transaction>)?\nSimilar story for client instrumentation. Changing the signature to WeakConcurrentMap<ClientCall.Listener<?>, Span> inFlightClientListeners would eliminate the chance of leaks and allows direct lookup of a span given a listener.\nAnother simplification of the client instrumentation could be done by removing co.elastic.apm.agent.grpc.ClientCallImplInstrumentation.Constructor and doing that inside co.elastic.apm.agent.grpc.ChannelInstrumentation (which instruments io.grpc.Channel#newCall). That would be more in line with the server instrumentation in co.elastic.apm.agent.grpc.ServerCallHandlerInstrumentation (instrumenting io.grpc.ServerCallHandler#startCall). And allows you to start the span before the constructor is invoked. In the exit advice you can then use the return value.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r437241943", "createdAt": "2020-06-09T08:49:46Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -151,7 +148,14 @@ public FinalMethodCall(ElasticApmTracer tracer) {\n                 //\n                 // call complete (but client not guaranteed to get all messages)\n                 // --> end of unary call (success)\n-                .or(named(\"onComplete\"));\n+                .or(named(\"onComplete\"))\n+                //\n+                // client completed all message sending, but can still cancel the call\n+                // --> for unary calls, actual method invocation is done within 'onHalfClose' method, and there is no\n+                // call to 'onComplete', thus consider it as 'final' allows to properly perform cleanup as it's the last\n+                // method that will be invoked on the listener.\n+                //\n+                .or(named(\"onHalfClose\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNzcyOA=="}, "originalCommit": {"oid": "9ebd149e6725ce921467cf2c3d41db5f09b956e7"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5855f0e268cb41d84d3cd06489c5679a0813502", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/e5855f0e268cb41d84d3cd06489c5679a0813502", "committedDate": "2020-06-10T09:59:07Z", "message": "implement changes suggested by felix after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "569bc0adf1ef83a4acdae1f3cc060509f86ddddc", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/569bc0adf1ef83a4acdae1f3cc060509f86ddddc", "committedDate": "2020-06-10T09:59:33Z", "message": "code update after latest version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94fc24316e438d07c975191f5a9bb7d8e3bb184", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/a94fc24316e438d07c975191f5a9bb7d8e3bb184", "committedDate": "2020-06-10T15:43:06Z", "message": "simplify client side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73eb77623999292a8ff054057b459deb019e344b", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/73eb77623999292a8ff054057b459deb019e344b", "committedDate": "2020-06-10T19:22:47Z", "message": "make client part similar to server & simpler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/9532e73ca53b5c3ba131d4682104b10474182f9f", "committedDate": "2020-06-10T19:37:06Z", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-grpc-leak"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjI0Mzky", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-428624392", "createdAt": "2020-06-11T06:27:32Z", "commit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNjoyNzozMlrOGiQGDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNjo0NjoxMlrOGiQhMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2ODQ2MA==", "bodyText": "Why do we only support unary calls?", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438568460", "createdAt": "2020-06-11T06:27:32Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java", "diffHunk": "@@ -69,35 +67,25 @@ public ServerCallHandlerInstrumentation(ElasticApmTracer tracer) {\n         return named(\"startCall\");\n     }\n \n-    @Advice.OnMethodEnter(suppress = Throwable.class)\n-    private static void onEnter(@Advice.Origin Class<?> clazz,\n-                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                                @Advice.Argument(1) Metadata headers,\n-                                @Advice.Local(\"transaction\") Transaction transaction) {\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n+    private static void onExit(@Advice.Origin Class<?> clazz,\n+                               @Advice.Thrown @Nullable Throwable thrown,\n+                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                               @Advice.Argument(1) Metadata headers,\n+                               @Advice.Return ServerCall.Listener<?> listener) {\n \n-        if (tracer == null || grpcHelperManager == null) {\n+        if (tracer == null || grpcHelperManager == null || thrown != null) {\n             return;\n         }\n \n-        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n-        if (helper != null) {\n-            transaction = helper.startTransaction(tracer, clazz.getClassLoader(), serverCall, headers);\n-        }\n-    }\n-\n-    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n-    private static void onExit(@Advice.Thrown Throwable thrown,\n-                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                               @Advice.Return ServerCall.Listener<?> listener,\n-                               @Advice.Local(\"transaction\") @Nullable Transaction transaction) {\n-\n-        if (tracer == null || grpcHelperManager == null || transaction == null) {\n+        if (serverCall.getMethodDescriptor().getType() != MethodDescriptor.MethodType.UNARY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2OTA2Ng==", "bodyText": "Why are we not starting the transaction onEnter anymore? That's what we also do for client calls. It also ensures we measure the time spent when preparing the call, including listener executions.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438569066", "createdAt": "2020-06-11T06:29:09Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallHandlerInstrumentation.java", "diffHunk": "@@ -69,35 +67,25 @@ public ServerCallHandlerInstrumentation(ElasticApmTracer tracer) {\n         return named(\"startCall\");\n     }\n \n-    @Advice.OnMethodEnter(suppress = Throwable.class)\n-    private static void onEnter(@Advice.Origin Class<?> clazz,\n-                                @Advice.Argument(0) ServerCall<?, ?> serverCall,\n-                                @Advice.Argument(1) Metadata headers,\n-                                @Advice.Local(\"transaction\") Transaction transaction) {\n+    @Advice.OnMethodExit(suppress = Throwable.class, onThrowable = Throwable.class)\n+    private static void onExit(@Advice.Origin Class<?> clazz,\n+                               @Advice.Thrown @Nullable Throwable thrown,\n+                               @Advice.Argument(0) ServerCall<?, ?> serverCall,\n+                               @Advice.Argument(1) Metadata headers,\n+                               @Advice.Return ServerCall.Listener<?> listener) {\n \n-        if (tracer == null || grpcHelperManager == null) {\n+        if (tracer == null || grpcHelperManager == null || thrown != null) {\n             return;\n         }\n \n-        GrpcHelper helper = grpcHelperManager.getForClassLoaderOfClass(ServerCall.class);\n-        if (helper != null) {\n-            transaction = helper.startTransaction(tracer, clazz.getClassLoader(), serverCall, headers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3MTQyNQ==", "bodyText": "Also instrument onReady to propagate context and to end the span if an exception occurs.", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438571425", "createdAt": "2020-06-11T06:35:29Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -90,7 +88,7 @@ public NonFinalMethodCall(ElasticApmTracer tracer) {\n             return named(\"onMessage\")\n                 //\n                 // client completed all message sending, but can still cancel the call\n-                // --> for unary calls, actual method invocation is done here (but it's an impl. detail)\n+                // --> for unary calls, actual method invocation is done within 'onHalfClose' method.\n                 .or(named(\"onHalfClose\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDI3Mg==", "bodyText": "don't we have to end the transaction in case of an exception?", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438574272", "createdAt": "2020-06-11T06:43:11Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java", "diffHunk": "@@ -185,22 +158,21 @@ public void exitServerListenerMethod(@Nullable Throwable thrown, ServerCall.List\n         if (null != thrown) {\n             // when there is a runtime exception thrown in one of the listener methods the calling code will catch it\n             // and set 'unknown' status, we just replicate this behavior as we don't instrument the part that does this\n-            endTransaction(Status.UNKNOWN, thrown, transaction);\n-\n-            // listener won't be called anymore\n-            inFlightServerListeners.remove(listener);\n+            setTransactionStatus(Status.UNKNOWN, thrown, transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NTQxMQ==", "bodyText": "Do we have a test that checks if other callbacks and/or io.grpc.ServerCall#close is called if an exception happens?", "url": "https://github.com/elastic/apm-agent-java/pull/1196#discussion_r438575411", "createdAt": "2020-06-11T06:46:12Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java", "diffHunk": "@@ -185,22 +158,21 @@ public void exitServerListenerMethod(@Nullable Throwable thrown, ServerCall.List\n         if (null != thrown) {\n             // when there is a runtime exception thrown in one of the listener methods the calling code will catch it\n             // and set 'unknown' status, we just replicate this behavior as we don't instrument the part that does this\n-            endTransaction(Status.UNKNOWN, thrown, transaction);\n-\n-            // listener won't be called anymore\n-            inFlightServerListeners.remove(listener);\n+            setTransactionStatus(Status.UNKNOWN, thrown, transaction);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3NDI3Mg=="}, "originalCommit": {"oid": "9532e73ca53b5c3ba131d4682104b10474182f9f"}, "originalPosition": 171}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1fdab0f7f66b45e8e69fa482006ca8c11d4128ce", "committedDate": "2020-06-12T08:46:43Z", "message": "another round of post-review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4411e82ac9bfca3d9a632b3516c634c978ea75c7", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/4411e82ac9bfca3d9a632b3516c634c978ea75c7", "committedDate": "2020-06-12T12:29:58Z", "message": "add more tests for listener + no nested tx"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1156b4821208e54af7fde663c0d2a15f9f430fd3", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1156b4821208e54af7fde663c0d2a15f9f430fd3", "committedDate": "2020-06-12T16:43:15Z", "message": "add client listener + more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37b37e6308475f27c25712f61bf4fd398d0ada16", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/37b37e6308475f27c25712f61bf4fd398d0ada16", "committedDate": "2020-06-15T13:07:19Z", "message": "add log4j2.xml to avoid log4j from complaining"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29057998e0c4565e1648190cc6767e22a356e6f3", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/29057998e0c4565e1648190cc6767e22a356e6f3", "committedDate": "2020-06-15T13:21:57Z", "message": "minor javadoc/style fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjkxNzk5", "url": "https://github.com/elastic/apm-agent-java/pull/1196#pullrequestreview-430691799", "createdAt": "2020-06-15T14:21:39Z", "commit": {"oid": "29057998e0c4565e1648190cc6767e22a356e6f3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09ddc4ac68480e5b57ad9da579580b19d5f715aa", "author": {"user": {"login": "SylvainJuge", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/09ddc4ac68480e5b57ad9da579580b19d5f715aa", "committedDate": "2020-06-15T14:29:54Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3986, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}