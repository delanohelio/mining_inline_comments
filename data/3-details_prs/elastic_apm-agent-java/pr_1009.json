{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MjU0NTYx", "number": 1009, "title": "Implement Binary TraceParent", "bodyText": "What does this PR do?\nImplementing the binary header format spec\nChecklist\n\n\n My code follows the style guidelines of this project\n I have rebased my changes on top of the latest master branch\n\n\n\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\n\n\n I have updated CHANGELOG.asciidoc\n\nUse cases\n\nDistributed tracing support for Kafka.", "createdAt": "2020-01-26T19:52:47Z", "url": "https://github.com/elastic/apm-agent-java/pull/1009", "merged": true, "mergeCommit": {"oid": "1b19484ed5a32f3561273ac7ae8eb14ec4a2924b"}, "closed": true, "closedAt": "2020-01-29T13:00:22Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-NnF_AH2gAyMzY3MjU0NTYxOjA3NjhiODEzN2Q1YWY0ODViMjQ5YmQzOWQzZDJhYzJiZTViZTZkMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_FidFgH2gAyMzY3MjU0NTYxOjk5OGFiYzJlZTQzOTY4YmQzMDI2OTUwYTQwOGYwYmZlY2E3ZThiYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0768b8137d5af485b249bd39d3d2ac2be5be6d07", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/0768b8137d5af485b249bd39d3d2ac2be5be6d07", "committedDate": "2020-01-26T19:49:42Z", "message": "Implement Binary TraceParent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ad3b9f50cba0ae56861c3729d189f098ca4fa0", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/21ad3b9f50cba0ae56861c3729d189f098ca4fa0", "committedDate": "2020-01-27T02:34:33Z", "message": "Cosmetic changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NTc4ODk1", "url": "https://github.com/elastic/apm-agent-java/pull/1009#pullrequestreview-348578895", "createdAt": "2020-01-27T10:58:14Z", "commit": {"oid": "21ad3b9f50cba0ae56861c3729d189f098ca4fa0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMDo1ODoxNVrOFh-vfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMTowMjo1N1rOFh-3Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE3NTI5Mw==", "bodyText": "Is there a chance that the header gets written after the TraceContext has been recycled?", "url": "https://github.com/elastic/apm-agent-java/pull/1009#discussion_r371175293", "createdAt": "2020-01-27T10:58:15Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-kafka-plugin/apm-kafka-headers-plugin/src/main/java/co/elastic/apm/agent/kafka/KafkaProducerHeadersInstrumentation.java", "diffHunk": "@@ -103,7 +103,7 @@ public static Span beforeSend(@Advice.FieldValue(\"apiVersions\") final ApiVersion\n             // https://kafka.apache.org/0110/documentation.html#messageformat\n             if (apiVersions.maxUsableProduceMagic() >= RecordBatch.MAGIC_VALUE_V2 && headersSupported) {\n                 try {\n-                    record.headers().add(TraceContext.TRACE_PARENT_HEADER,\n+                    record.headers().add(TraceContext.TRACE_PARENT_BINARY_HEADER_NAME,\n                         span.getTraceContext().getOutgoingTraceParentBinaryHeader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ad3b9f50cba0ae56861c3729d189f098ca4fa0"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE3NzI5OA==", "bodyText": "The use of binary headers is relatively rare but adding the outgoingBinaryHeader variable increases the memory consumption of each object in the pool.\nAny chance to use write the value to thread-local-buffered byte arrays? Caching in outgoingBinaryHeader does not seem to have much benefit, as I don't see how the same TraceContext would be injected multiple times in its binary form.\npublic void fillOutgoingTraceParentBinaryHeader(byte[] header) {", "url": "https://github.com/elastic/apm-agent-java/pull/1009#discussion_r371177298", "createdAt": "2020-01-27T11:02:57Z", "author": {"login": "felixbarny"}, "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/TraceContext.java", "diffHunk": "@@ -384,11 +451,29 @@ private void fillTraceParentHeader(StringBuilder sb, Id spanId) {\n         spanId.writeAsHex(sb);\n         sb.append('-');\n         HexUtils.writeByteAsHex(flags, sb);\n+    }\n \n-        // todo: traceparent header- apply agreed binary format\n-        for (int i = 0; i < sb.length(); i++) {\n-            outgoingBinaryHeader[i] = (byte) sb.charAt(i);\n+    /**\n+     * Returns a binary representation of the {@code traceparent} header for downstream services.\n+     * <p>\n+     * NOTE: CALLER MAY NOT KEEP A REFERENCE TO THE RETURNED BYTE ARRAY, AS IT BELONGS TO THE TRACE CONTEXT INSTANCE\n+     */\n+    public byte[] getOutgoingTraceParentBinaryHeader() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ad3b9f50cba0ae56861c3729d189f098ca4fa0"}, "originalPosition": 348}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODc3OTI1", "url": "https://github.com/elastic/apm-agent-java/pull/1009#pullrequestreview-348877925", "createdAt": "2020-01-27T18:25:12Z", "commit": {"oid": "21ad3b9f50cba0ae56861c3729d189f098ca4fa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b16bceb3b30f73a3e22ab6f2be42e10e69a2268", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/1b16bceb3b30f73a3e22ab6f2be42e10e69a2268", "committedDate": "2020-01-29T09:50:21Z", "message": "Apply review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDU3NzIx", "url": "https://github.com/elastic/apm-agent-java/pull/1009#pullrequestreview-350057721", "createdAt": "2020-01-29T12:07:41Z", "commit": {"oid": "1b16bceb3b30f73a3e22ab6f2be42e10e69a2268"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "998abc2ee43968bd3026950a408f0bfeca7e8bae", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/998abc2ee43968bd3026950a408f0bfeca7e8bae", "committedDate": "2020-01-29T12:59:19Z", "message": "Added to CHANGELOG.asciidoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4059, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}