{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDU2NjM2", "number": 1531, "title": "Fix NPE when async ES client is nested within Hibernate search", "bodyText": "Closes #1528\nWhen ES client is used within Hibernate search, the helper code produces a null span as we don't allow nested exit spans.", "createdAt": "2020-11-24T12:50:38Z", "url": "https://github.com/elastic/apm-agent-java/pull/1531", "merged": true, "mergeCommit": {"oid": "0c5f924e42219ec0fb74299edb29619dea5a329a"}, "closed": true, "closedAt": "2020-11-25T04:27:10Z", "author": {"login": "eyalkoren"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfpK-bgH2gAyNTI2NDU2NjM2OmY4MGRkM2U3NGU1MzZiNTQ4YTI1NWY1ODQ1NmE5OTIzMWQzNDRkZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf2l7FgH2gAyNTI2NDU2NjM2Ojc4ODM1M2M1ZjllZTdmOTBkNTM3MDhjYWI0YmY1MDYxYjMzYjU1ZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f80dd3e74e536b548a255f58456a99231d344ded", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f80dd3e74e536b548a255f58456a99231d344ded", "committedDate": "2020-11-24T12:46:59Z", "message": "Fix NPE when async ES client is nested within Hibernate search"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDg1NDgz", "url": "https://github.com/elastic/apm-agent-java/pull/1531#pullrequestreview-537485483", "createdAt": "2020-11-24T13:23:09Z", "commit": {"oid": "f80dd3e74e536b548a255f58456a99231d344ded"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMzowOVrOH5AmsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMzowOVrOH5AmsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MDc4NQ==", "bodyText": "[minor] The best practice would be to return an Object[] instead of using GlobalThreadLocal", "url": "https://github.com/elastic/apm-agent-java/pull/1531#discussion_r529540785", "createdAt": "2020-11-24T13:23:09Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/main/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchClientAsyncInstrumentation.java", "diffHunk": "@@ -79,6 +79,7 @@ public ElasticsearchClientAsyncInstrumentation(ElasticApmTracer tracer) {\n     public static class ElasticsearchRestClientAsyncAdvice {\n         @VisibleForAdvice\n         public static final GlobalThreadLocal<Span> spanTls = GlobalThreadLocal.get(ElasticsearchRestClientAsyncAdvice.class, \"spanTls\");\n+\n         @AssignTo.Argument(5)\n         @Advice.OnMethodEnter(suppress = Throwable.class)\n         public static ResponseListener onBeforeExecute(@Advice.Argument(0) String method,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80dd3e74e536b548a255f58456a99231d344ded"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9701c3afb1065048bcbb4bf1eb7f8e6e59326a8", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/f9701c3afb1065048bcbb4bf1eb7f8e6e59326a8", "committedDate": "2020-11-24T13:48:15Z", "message": "Adding to CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c5751feb31cee98e168bd3b0db801576dd6f3e", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/50c5751feb31cee98e168bd3b0db801576dd6f3e", "committedDate": "2020-11-24T14:43:15Z", "message": "Applying review suggestion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTg0Nzg1", "url": "https://github.com/elastic/apm-agent-java/pull/1531#pullrequestreview-537584785", "createdAt": "2020-11-24T15:06:14Z", "commit": {"oid": "50c5751feb31cee98e168bd3b0db801576dd6f3e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTowNjoxNFrOH5FKzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTowNjoxNFrOH5FKzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYxNTU2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Object[] ret = new Object[2];\n          \n          \n            \n                                ret[0] = span;\n          \n          \n            \n                                ret[1] = helper.<ResponseListener>wrapResponseListener(responseListener, span);\n          \n          \n            \n                                return ret;\n          \n          \n            \n                                return new Object[]{span, helper.<ResponseListener>wrapResponseListener(responseListener, span)};\n          \n      \n    \n    \n  \n\nfeel free to ignore if you like yours better", "url": "https://github.com/elastic/apm-agent-java/pull/1531#discussion_r529615565", "createdAt": "2020-11-24T15:06:14Z", "author": {"login": "felixbarny"}, "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-5_6/src/main/java/co/elastic/apm/agent/es/restclient/v5_6/ElasticsearchClientAsyncInstrumentation.java", "diffHunk": "@@ -77,32 +75,37 @@ public ElasticsearchClientAsyncInstrumentation(ElasticApmTracer tracer) {\n \n \n     public static class ElasticsearchRestClientAsyncAdvice {\n-        @VisibleForAdvice\n-        public static final GlobalThreadLocal<Span> spanTls = GlobalThreadLocal.get(ElasticsearchRestClientAsyncAdvice.class, \"spanTls\");\n-        @AssignTo.Argument(5)\n+\n+        @Nullable\n+        @AssignTo.Argument(index = 1, value = 5)\n         @Advice.OnMethodEnter(suppress = Throwable.class)\n-        public static ResponseListener onBeforeExecute(@Advice.Argument(0) String method,\n-                                                       @Advice.Argument(1) String endpoint,\n-                                                       @Advice.Argument(3) @Nullable HttpEntity entity,\n-                                                       @Advice.Argument(5) ResponseListener responseListener) {\n+        public static Object[] onBeforeExecute(@Advice.Argument(0) String method,\n+                                               @Advice.Argument(1) String endpoint,\n+                                               @Advice.Argument(3) @Nullable HttpEntity entity,\n+                                               @Advice.Argument(5) ResponseListener responseListener) {\n \n             ElasticsearchRestClientInstrumentationHelper<HttpEntity, Response, ResponseListener> helper = esClientInstrHelperManager.getForClassLoaderOfClass(Response.class);\n             if (helper != null) {\n                 Span span = helper.createClientSpan(method, endpoint, entity);\n-                spanTls.set(span);\n                 if (span != null) {\n-                    return helper.<ResponseListener>wrapResponseListener(responseListener, span);\n+                    Object[] ret = new Object[2];\n+                    ret[0] = span;\n+                    ret[1] = helper.<ResponseListener>wrapResponseListener(responseListener, span);\n+                    return ret;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50c5751feb31cee98e168bd3b0db801576dd6f3e"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "788353c5f9ee7f90d53708cab4bf5061b33b55fd", "author": {"user": {"login": "eyalkoren", "name": null}}, "url": "https://github.com/elastic/apm-agent-java/commit/788353c5f9ee7f90d53708cab4bf5061b33b55fd", "committedDate": "2020-11-25T04:25:11Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-npe-es-async-client-instr"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3610, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}