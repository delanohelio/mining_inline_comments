{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5ODgzMTcy", "number": 2125, "title": "[Feature] Silver bullet", "bodyText": "", "createdAt": "2020-04-28T04:59:58Z", "url": "https://github.com/mercadopago/px-android/pull/2125", "merged": true, "mergeCommit": {"oid": "121cfa359d4668bf3271618cd8fb6f738d4895f7"}, "closed": true, "closedAt": "2020-04-30T16:24:26Z", "author": {"login": "guchito9"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVTHkGgH2gAyNDA5ODgzMTcyOmU2OTJhMDMwZDM1ZjY5Y2Q1Y2NiNjZlN2E4YTZmYmMzZWMwZjczZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccviqxAFqTQwMzY3NjkxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e692a030d35f69cd5ccb66e7a8a6fbc3ec0f73e9", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/e692a030d35f69cd5ccb66e7a8a6fbc3ec0f73e9", "committedDate": "2020-04-07T13:14:57Z", "message": "new models"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b56aa0c10dbff0ee51bc0f8d59c5ffb2dfe394", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/29b56aa0c10dbff0ee51bc0f8d59c5ffb2dfe394", "committedDate": "2020-04-08T20:11:22Z", "message": "merge with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b68bc401f4b1ee5b3fc45b7c49be5832c7d4f753", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/b68bc401f4b1ee5b3fc45b7c49be5832c7d4f753", "committedDate": "2020-04-09T20:52:05Z", "message": "InitService in congratsrepository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7659b30040f1bf504a4c38981b14b3d30e4522db", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/7659b30040f1bf504a4c38981b14b3d30e4522db", "committedDate": "2020-04-16T11:47:24Z", "message": "add alternative payer payment methods for silver bullet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d9c1da18fbb73a2f3e4136928b8c73d14c45d3", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/d8d9c1da18fbb73a2f3e4136928b8c73d14c45d3", "committedDate": "2020-04-24T15:51:14Z", "message": "refactor new models silverbullet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0567ec8f63fc3745f3fc00854c04918a25eaf30", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/d0567ec8f63fc3745f3fc00854c04918a25eaf30", "committedDate": "2020-04-24T16:04:42Z", "message": "Merge branch 'master' into feature/new-models-added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c28e6fc00ea2b0e10e5864742467eecd3771a551", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/c28e6fc00ea2b0e10e5864742467eecd3771a551", "committedDate": "2020-04-24T16:26:43Z", "message": "change data map list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a7a46681b02bffda389ba540f291e44441dc6f9", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/1a7a46681b02bffda389ba540f291e44441dc6f9", "committedDate": "2020-04-24T21:34:52Z", "message": "add more data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7d0939c8a6ad305d3f8d9588bb8abee5a3ecc6", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/df7d0939c8a6ad305d3f8d9588bb8abee5a3ecc6", "committedDate": "2020-04-27T14:38:32Z", "message": "Bottom description alignment for new card drawer design"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5608af499dc6837e1cff2dbc6ab2ac91f8007216", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/5608af499dc6837e1cff2dbc6ab2ac91f8007216", "committedDate": "2020-04-27T14:39:49Z", "message": "Added suggested payment method remedy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d9ab1067d46aeb18f86af5ab87814ff74625f2b", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/4d9ab1067d46aeb18f86af5ab87814ff74625f2b", "committedDate": "2020-04-28T04:59:13Z", "message": "wip"}, "afterCommit": {"oid": "6d065997e5c6857e500e8240d196ed2a3d24e512", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/6d065997e5c6857e500e8240d196ed2a3d24e512", "committedDate": "2020-04-28T06:38:54Z", "message": "wip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTM3NDA1", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401537405", "createdAt": "2020-04-28T06:40:11Z", "commit": {"oid": "6d065997e5c6857e500e8240d196ed2a3d24e512"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo0MDoxMlrOGNE8lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo0MDoxMlrOGNE8lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM2NTcxNg==", "bodyText": "OJOTA", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416365716", "createdAt": "2020-04-28T06:40:12Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/CongratsRepositoryImpl.kt", "diffHunk": "@@ -42,60 +46,101 @@ class CongratsRepositoryImpl(\n                 paymentRewardCache.containsKey(paymentId) -> paymentRewardCache[paymentId]!!\n                 else -> getPaymentReward(payment, paymentResult).apply { paymentRewardCache[paymentId] = this }\n             }\n-            val remediesResponse = when {\n+            val remediesDataModel = when {\n                 hasToReturnEmptyResponse || isSuccess -> RemediesResponse.EMPTY\n                 remediesCache.containsKey(paymentId) -> remediesCache[paymentId]!!\n-                else -> getRemedies(payment, paymentResult.paymentData).apply { remediesCache[paymentId] = this }\n+                else -> {\n+                    getRemedies(payment, paymentResult.paymentData).apply { remediesCache[paymentId] = this }\n+                }\n             }\n             withContext(Dispatchers.Main) {\n-                handleResult(payment, paymentResult, paymentReward, remediesResponse, paymentSetting.currency, callback)\n+                handleResult(payment, paymentResult, paymentReward, remediesDataModel, paymentSetting.currency, callback)\n             }\n         }\n     }\n \n     private suspend fun getPaymentReward(payment: IPaymentDescriptor, paymentResult: PaymentResult) =\n-        try {\n-            val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n-            val joinedPaymentMethodsIds = paymentResult.paymentDataList\n-                .joinToString(TextUtil.CSV_DELIMITER) { p -> (p.paymentMethod.id) }\n-            val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n-            val response = congratsService.getCongrats(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n-                joinedPaymentIds, platform, campaignId, payerComplianceRepository.turnedIFPECompliant(),\n-                joinedPaymentMethodsIds, flow).await()\n-            if (response.isSuccessful) {\n-                response.body()!!\n-            } else {\n+            try {\n+                val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n+                val joinedPaymentMethodsIds = paymentResult.paymentDataList\n+                        .joinToString(TextUtil.CSV_DELIMITER) { p -> (p.paymentMethod.id) }\n+                val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n+                val response = congratsService.getCongrats(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n+                        joinedPaymentIds, platform, campaignId, payerComplianceRepository.turnedIFPECompliant(),\n+                        joinedPaymentMethodsIds, flow).await()\n+                if (response.isSuccessful) {\n+                    response.body()!!\n+                } else {\n+                    CongratsResponse.EMPTY\n+                }\n+            } catch (e: Exception) {\n                 CongratsResponse.EMPTY\n             }\n-        } catch (e: Exception) {\n-            CongratsResponse.EMPTY\n-        }\n+\n+    private fun getPayerPaymentMethods(response: InitResponse?) =\n+            mutableListOf<Triple<SecurityCode?, String, CustomSearchItem>>()\n+                    .also { mapPayerPaymentMethods ->\n+                        response?.run {\n+                            customSearchItems.forEach { customSearchItem ->\n+                                express.find { it.customOptionId == customSearchItem.id }?.let { expressMetadata ->\n+                                    mapPayerPaymentMethods.add(\n+                                            Triple(getCardById(customSearchItem.id)?.securityCode,\n+                                                    expressMetadata.customOptionId,\n+                                                    customSearchItem)\n+                                    )\n+                                }\n+                            }\n+                        }\n+                    }\n+\n+    private suspend fun loadInitResponse() =\n+            when (val callbackResult = initService.init().awaitCallback<InitResponse>()) {\n+                is Response.Success<*> -> callbackResult.result as InitResponse\n+                is Response.Failure<*> -> null\n+            }\n \n     private suspend fun getRemedies(payment: IPaymentDescriptor, paymentData: PaymentData) =\n-        try {\n-            val body = RemediesBodyMapper(userSelectionRepository).map(paymentData)\n+            try {\n+                val initResponse = loadInitResponse()\n+                val payerPaymentMethods = getPayerPaymentMethods(initResponse)\n+                val hasOneTap = initResponse?.hasExpressCheckoutMetadata() ?: false\n+                val customOptionId = paymentData.token?.cardId ?: paymentData.paymentMethod.id\n+                val escCardIds = escManagerBehaviour.escCardIds\n+                val body = RemediesBodyMapper(\n+                        userSelectionRepository,\n+                        amountRepository,\n+                        customOptionId,\n+                        escCardIds.contains(customOptionId),\n+                        AlternativePayerPaymentMethodsMapper(escCardIds).map(payerPaymentMethods.filter { it.second != customOptionId })\n+                ).map(paymentData)\n+                val response = congratsService.getRemedies(\n+                        \"alpha\",\n+                        \"5148018960\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d065997e5c6857e500e8240d196ed2a3d24e512"}, "originalPosition": 135}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d065997e5c6857e500e8240d196ed2a3d24e512", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/6d065997e5c6857e500e8240d196ed2a3d24e512", "committedDate": "2020-04-28T06:38:54Z", "message": "wip"}, "afterCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/4ba7e10068d5125e28e4e2537aa1cc28b0cf0029", "committedDate": "2020-04-28T06:42:27Z", "message": "wip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ0MzYy", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401544362", "createdAt": "2020-04-28T06:53:18Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1MzoxOFrOGNFU3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1MzoxOFrOGNFU3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3MTkzMw==", "bodyText": "Se puede sacar el express metadata de ac\u00e1", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416371933", "createdAt": "2020-04-28T06:53:18Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/RemedyState.kt", "diffHunk": "@@ -1,11 +1,12 @@\n package com.mercadopago.android.px.internal.features.payment_result.remedies\n \n-import com.mercadopago.android.px.internal.features.payment_result.remedies.view.CvvRemedy\n+import com.mercadopago.android.px.internal.features.payment_result.remedies.view.RetryPaymentFragment\n import com.mercadopago.android.px.internal.features.payment_result.remedies.view.HighRiskRemedy\n import com.mercadopago.android.px.internal.viewmodel.PaymentModel\n+import com.mercadopago.android.px.model.ExpressMetadata\n \n internal sealed class RemedyState {\n-    internal data class ShowCvvRemedy(val model: CvvRemedy.Model): RemedyState()\n+    internal data class ShowRetryPaymentRemedy(val data: Pair<RetryPaymentFragment.Model, ExpressMetadata?>): RemedyState()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ1MTkw", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401545190", "createdAt": "2020-04-28T06:54:47Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1NDo0N1rOGNFX3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1NDo0N1rOGNFX3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3MjcwMg==", "bodyText": "Trillereada", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416372702", "createdAt": "2020-04-28T06:54:47Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/view/RetryPaymentFragment.kt", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.mercadopago.android.px.internal.features.payment_result.remedies.view\n+\n+import android.os.Bundle\n+import android.os.Parcel\n+import android.os.Parcelable\n+import android.support.v4.app.Fragment\n+import android.view.LayoutInflater\n+import android.view.View\n+import android.view.ViewGroup\n+import android.widget.TextView\n+import com.mercadopago.android.px.R\n+import com.mercadopago.android.px.internal.di.MapperProvider\n+import com.mercadopago.android.px.internal.extensions.gone\n+import com.mercadopago.android.px.internal.extensions.visible\n+import com.mercadopago.android.px.internal.features.express.slider.PaymentMethodFragment\n+import com.mercadopago.android.px.internal.features.express.slider.PaymentMethodLowResDrawer\n+import com.mercadopago.android.px.internal.features.payment_result.remedies.RemediesPayerCost\n+import com.mercadopago.android.px.internal.view.PaymentMethodDescriptorView\n+import com.mercadopago.android.px.model.ExpressMetadata\n+\n+internal class RetryPaymentFragment : Fragment(), PaymentMethodFragment.DisabledDetailDialogLauncher {\n+\n+    private lateinit var message: TextView\n+    private lateinit var cvvRemedy: CvvRemedy\n+    private lateinit var paymentMethodDescriptor: PaymentMethodDescriptorView\n+    private lateinit var paymentMethodTitle: TextView\n+\n+    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {\n+        return inflater.inflate(R.layout.px_remedies_retry_payment, container, false)\n+    }\n+\n+    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {\n+        super.onViewCreated(view, savedInstanceState)\n+        message = view.findViewById(R.id.message)\n+        cvvRemedy = view.findViewById(R.id.cvv_remedy)\n+        paymentMethodDescriptor = view.findViewById(R.id.payment_method_descriptor)\n+        paymentMethodTitle = view.findViewById(R.id.payment_method_title)\n+    }\n+\n+    fun init(model: Model, methodData: ExpressMetadata?) {\n+        message.text = model.message\n+        methodData?.let {\n+            addCard(it)\n+            if (model.isAnotherMethod) {\n+                showPaymentMethodDescriptor(it, model.payerCost)\n+            }\n+        }\n+        model.cvvModel?.let { cvvRemedy.init(it) } ?: cvvRemedy.gone()\n+    }\n+\n+    fun setListener(listener: CvvRemedy.Listener) {\n+        cvvRemedy.listener = listener\n+    }\n+\n+    private fun addCard(methodData: ExpressMetadata) {\n+        childFragmentManager.beginTransaction().apply {\n+            val drawableFragmentItem = MapperProvider.getPaymentMethodDrawableItemMapper().map(methodData)!!\n+            replace(R.id.card_container, drawableFragmentItem.draw(PaymentMethodLowResDrawer()))\n+            commitAllowingStateLoss()\n+        }\n+    }\n+\n+    private fun showPaymentMethodDescriptor(methodData: ExpressMetadata, payerCost: RemediesPayerCost?) {\n+        paymentMethodDescriptor.visible()\n+        paymentMethodTitle.visible()\n+        if (!paymentMethodTitle.text.contains(\":\")) paymentMethodTitle.append(\":\") // FIXME", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ3MjY1", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401547265", "createdAt": "2020-04-28T06:58:31Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1ODozMVrOGNFftw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo1ODozMVrOGNFftw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NDcxMQ==", "bodyText": "Turbina es poco", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416374711", "createdAt": "2020-04-28T06:58:31Z", "author": {"login": "guchito9"}, "path": "px-services/src/main/java/com/mercadopago/android/px/model/PayerCost.java", "diffHunk": "@@ -20,7 +20,6 @@\n     private static final String CFT = \"CFT\";\n     private static final String TEA = \"TEA\";\n     private List<String> labels;\n-    private String recommendedMessage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ4MjI0", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401548224", "createdAt": "2020-04-28T07:00:08Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDowOVrOGNFjKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDowOVrOGNFjKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NTU5NA==", "bodyText": "Qued\u00f3 en firma p\u00fablica esto", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416375594", "createdAt": "2020-04-28T07:00:09Z", "author": {"login": "guchito9"}, "path": "px-services/src/main/java/com/mercadopago/android/px/services/CallbackFunctions.kt", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.mercadopago.android.px.services\n+\n+import com.mercadopago.android.px.internal.callbacks.MPCall\n+import com.mercadopago.android.px.model.exceptions.ApiException\n+import kotlinx.coroutines.suspendCancellableCoroutine\n+import kotlin.coroutines.resume\n+\n+suspend fun <T> MPCall<T>.awaitCallback(): Response =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ4MzYy", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401548362", "createdAt": "2020-04-28T07:00:24Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDoyNFrOGNFjmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDoyNFrOGNFjmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NTcwNg==", "bodyText": "Qued\u00f3 en firma p\u00fablica esto", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416375706", "createdAt": "2020-04-28T07:00:24Z", "author": {"login": "guchito9"}, "path": "px-services/src/main/java/com/mercadopago/android/px/services/Response.kt", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.mercadopago.android.px.services\n+\n+sealed class Response {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQ4NTk2", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-401548596", "createdAt": "2020-04-28T07:00:48Z", "commit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDo0OFrOGNFkew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzowMDo0OFrOGNFkew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM3NTkzMQ==", "bodyText": "Error involuntario", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r416375931", "createdAt": "2020-04-28T07:00:48Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/test/java/com/mercadopago/android/px/internal/features/payment_result/components/FooterPaymentResponseTest.java", "diffHunk": "@@ -23,7 +23,7 @@\n import static org.mockito.Mockito.when;\n \n @RunWith(MockitoJUnitRunner.class)\n-public class FooterPaymentResultTest {\n+public class FooterPaymentResponseTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ba7e10068d5125e28e4e2537aa1cc28b0cf0029", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/4ba7e10068d5125e28e4e2537aa1cc28b0cf0029", "committedDate": "2020-04-28T06:42:27Z", "message": "wip"}, "afterCommit": {"oid": "f871d0f852ddf143cab97b02692bd01f35b404a8", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/f871d0f852ddf143cab97b02692bd01f35b404a8", "committedDate": "2020-04-28T15:41:27Z", "message": "wip"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f871d0f852ddf143cab97b02692bd01f35b404a8", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/f871d0f852ddf143cab97b02692bd01f35b404a8", "committedDate": "2020-04-28T15:41:27Z", "message": "wip"}, "afterCommit": {"oid": "9aaeec23ac40fc9ba6705398301d54916d76b814", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/9aaeec23ac40fc9ba6705398301d54916d76b814", "committedDate": "2020-04-28T20:27:23Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "892899f603f1bfcadb02f09528873ad7b93101d0", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/892899f603f1bfcadb02f09528873ad7b93101d0", "committedDate": "2020-04-28T21:23:17Z", "message": "wip"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9aaeec23ac40fc9ba6705398301d54916d76b814", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/9aaeec23ac40fc9ba6705398301d54916d76b814", "committedDate": "2020-04-28T20:27:23Z", "message": "wip"}, "afterCommit": {"oid": "892899f603f1bfcadb02f09528873ad7b93101d0", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/892899f603f1bfcadb02f09528873ad7b93101d0", "committedDate": "2020-04-28T21:23:17Z", "message": "wip"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aebbeee1af9b33b3c3696a8177c54cc1f3e12a24", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/aebbeee1af9b33b3c3696a8177c54cc1f3e12a24", "committedDate": "2020-04-29T00:58:37Z", "message": "Change congrats color for remedies"}, "afterCommit": {"oid": "a8d0728262d1817739a47da4bd58aec6c5ee1576", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/a8d0728262d1817739a47da4bd58aec6c5ee1576", "committedDate": "2020-04-29T01:02:53Z", "message": "Change congrats color for remedies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8d0728262d1817739a47da4bd58aec6c5ee1576", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/a8d0728262d1817739a47da4bd58aec6c5ee1576", "committedDate": "2020-04-29T01:02:53Z", "message": "Change congrats color for remedies"}, "afterCommit": {"oid": "460c68007014b48d807b5c2506d509032471cfc7", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/460c68007014b48d807b5c2506d509032471cfc7", "committedDate": "2020-04-29T18:19:44Z", "message": "Change congrats color for remedies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "460c68007014b48d807b5c2506d509032471cfc7", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/460c68007014b48d807b5c2506d509032471cfc7", "committedDate": "2020-04-29T18:19:44Z", "message": "Change congrats color for remedies"}, "afterCommit": {"oid": "775c7445ff4611762362dfb7770a846791ee5eaa", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/775c7445ff4611762362dfb7770a846791ee5eaa", "committedDate": "2020-04-29T18:45:29Z", "message": "Change congrats color for remedies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "775c7445ff4611762362dfb7770a846791ee5eaa", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/775c7445ff4611762362dfb7770a846791ee5eaa", "committedDate": "2020-04-29T18:45:29Z", "message": "Change congrats color for remedies"}, "afterCommit": {"oid": "456ddd985196e0cf17a905e6dfe0b4a00f3bafe6", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/456ddd985196e0cf17a905e6dfe0b4a00f3bafe6", "committedDate": "2020-04-29T18:49:31Z", "message": "Change congrats color for remedies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff7d4cf874e636db2b6739048806bc7946f49f23", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/ff7d4cf874e636db2b6739048806bc7946f49f23", "committedDate": "2020-04-29T18:54:39Z", "message": "Change congrats color for remedies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "456ddd985196e0cf17a905e6dfe0b4a00f3bafe6", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/456ddd985196e0cf17a905e6dfe0b4a00f3bafe6", "committedDate": "2020-04-29T18:49:31Z", "message": "Change congrats color for remedies"}, "afterCommit": {"oid": "ff7d4cf874e636db2b6739048806bc7946f49f23", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/ff7d4cf874e636db2b6739048806bc7946f49f23", "committedDate": "2020-04-29T18:54:39Z", "message": "Change congrats color for remedies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c400e8526c04193890daac930e6631f25b17a89", "author": {"user": {"login": "jorGonzalez291292", "name": "Jorge Daniel Gonzalez"}}, "url": "https://github.com/mercadopago/px-android/commit/7c400e8526c04193890daac930e6631f25b17a89", "committedDate": "2020-04-29T19:05:12Z", "message": "silverbullet track added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cbe5adf9d00fef47aa85e6c6a75d713df9ef673", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/6cbe5adf9d00fef47aa85e6c6a75d713df9ef673", "committedDate": "2020-04-29T19:59:23Z", "message": "Fixed payment method id for silver bullet tracking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/777532872e07a1b31e01addc66b290427d6c66cc", "committedDate": "2020-04-29T20:01:24Z", "message": "Merge pull request #2126 from mercadopago/feature/track-silver-bullet\n\nsilverbullet track added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDE1NjEy", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403015612", "createdAt": "2020-04-29T20:31:39Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMDozMTozOVrOGOP2ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMDozMTozOVrOGOP2ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU5MjkzMg==", "bodyText": "pol\u00e9mico", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r417592932", "createdAt": "2020-04-29T20:31:39Z", "author": {"login": "cgaggino"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/CongratsRepositoryImpl.kt", "diffHunk": "@@ -54,48 +60,87 @@ class CongratsRepositoryImpl(\n     }\n \n     private suspend fun getPaymentReward(payment: IPaymentDescriptor, paymentResult: PaymentResult) =\n-        try {\n-            val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n-            val joinedPaymentMethodsIds = paymentResult.paymentDataList\n-                .joinToString(TextUtil.CSV_DELIMITER) { p -> (p.paymentMethod.id) }\n-            val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n-            val response = congratsService.getCongrats(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n-                joinedPaymentIds, platform, campaignId, payerComplianceRepository.turnedIFPECompliant(),\n-                joinedPaymentMethodsIds, flow).await()\n-            if (response.isSuccessful) {\n-                response.body()!!\n-            } else {\n+            try {\n+                val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n+                val joinedPaymentMethodsIds = paymentResult.paymentDataList\n+                        .joinToString(TextUtil.CSV_DELIMITER) { p -> (p.paymentMethod.id) }\n+                val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n+                val response = congratsService.getCongrats(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n+                        joinedPaymentIds, platform, campaignId, payerComplianceRepository.turnedIFPECompliant(),\n+                        joinedPaymentMethodsIds, flow).await()\n+                if (response.isSuccessful) {\n+                    response.body()!!\n+                } else {\n+                    CongratsResponse.EMPTY\n+                }\n+            } catch (e: Exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDE2NjU2", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403016656", "createdAt": "2020-04-29T20:33:12Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMDozMzoxM1rOGOP5pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMDozMzoxM1rOGOP5pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU5Mzc2Nw==", "bodyText": "cambio de 4 a 8 la tabulaci\u00f3n?", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r417593767", "createdAt": "2020-04-29T20:33:13Z", "author": {"login": "cgaggino"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/CongratsRepositoryImpl.kt", "diffHunk": "@@ -54,48 +60,87 @@ class CongratsRepositoryImpl(\n     }\n \n     private suspend fun getPaymentReward(payment: IPaymentDescriptor, paymentResult: PaymentResult) =\n-        try {\n-            val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n-            val joinedPaymentMethodsIds = paymentResult.paymentDataList\n-                .joinToString(TextUtil.CSV_DELIMITER) { p -> (p.paymentMethod.id) }\n-            val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n-            val response = congratsService.getCongrats(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n-                joinedPaymentIds, platform, campaignId, payerComplianceRepository.turnedIFPECompliant(),\n-                joinedPaymentMethodsIds, flow).await()\n-            if (response.isSuccessful) {\n-                response.body()!!\n-            } else {\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDQwMDky", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403040092", "createdAt": "2020-04-29T21:07:31Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMTowNzozMVrOGORCGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMTowNzozMVrOGORCGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMjMxNQ==", "bodyText": "se trackea otra cosa al confirmar el remedy?", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r417612315", "createdAt": "2020-04-29T21:07:31Z", "author": {"login": "cgaggino"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/pay_button/PayButton.kt", "diffHunk": "@@ -34,7 +34,7 @@ interface PayButton {\n     }\n \n     interface OnReadyForPaymentCallback {\n-        fun call(paymentConfiguration: PaymentConfiguration, confirmTrackerData: ConfirmData?)\n+        fun call(paymentConfiguration: PaymentConfiguration, confirmTrackerData: ConfirmData? = null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDgxNTI5", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403081529", "createdAt": "2020-04-29T22:21:26Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjoyMToyN1rOGOTJ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjoyMToyN1rOGOTJ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0NzA2Nw==", "bodyText": "Revisar los types del mapper, con estos types podriamos mapper una lista de lista de triples", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r417647067", "createdAt": "2020-04-29T22:21:27Z", "author": {"login": "cgaggino"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/AlternativePayerPaymentMethodsMapper.kt", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.mercadopago.android.px.internal.features.payment_result.remedies\n+\n+import com.mercadopago.android.px.internal.model.EscStatus\n+import com.mercadopago.android.px.internal.viewmodel.mappers.Mapper\n+import com.mercadopago.android.px.model.CustomSearchItem\n+import com.mercadopago.android.px.model.SecurityCode\n+import com.mercadopago.android.px.model.internal.remedies.Installment\n+import com.mercadopago.android.px.model.internal.remedies.RemedyPaymentMethod\n+\n+class AlternativePayerPaymentMethodsMapper(\n+        private val escCardIds: Set<String>\n+) : Mapper<List<Triple<SecurityCode?, String, CustomSearchItem>>, List<RemedyPaymentMethod>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3951d0927d8397584021e809b007e355ff612e04", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/3951d0927d8397584021e809b007e355ff612e04", "committedDate": "2020-04-29T22:36:01Z", "message": "Alternative payment method mapper refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDkwOTk3", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403090997", "createdAt": "2020-04-29T22:42:26Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjo0MjoyNlrOGOTpRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjo0MjoyNlrOGOTpRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NTExMQ==", "bodyText": "Este loadInitResponse lo vi en varios lados, lo podremos poner dentro de initService?", "url": "https://github.com/mercadopago/px-android/pull/2125#discussion_r417655111", "createdAt": "2020-04-29T22:42:26Z", "author": {"login": "cgaggino"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/RemediesViewModel.kt", "diffHunk": "@@ -5,51 +5,155 @@ import android.os.Bundle\n import com.mercadopago.android.px.addons.ESCManagerBehaviour\n import com.mercadopago.android.px.internal.base.BaseViewModel\n import com.mercadopago.android.px.internal.features.pay_button.PayButton\n-import com.mercadopago.android.px.internal.repository.CardTokenRepository\n-import com.mercadopago.android.px.internal.repository.CongratsRepository\n+import com.mercadopago.android.px.internal.repository.*\n import com.mercadopago.android.px.internal.repository.CongratsRepository.PostPaymentCallback\n-import com.mercadopago.android.px.internal.repository.PaymentRepository\n-import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n import com.mercadopago.android.px.internal.util.CVVRecoveryWrapper\n+import com.mercadopago.android.px.internal.util.TokenCreationWrapper\n import com.mercadopago.android.px.internal.viewmodel.PaymentModel\n+import com.mercadopago.android.px.model.Card\n import com.mercadopago.android.px.model.IPaymentDescriptor\n+import com.mercadopago.android.px.model.PayerCost\n+import com.mercadopago.android.px.model.internal.InitResponse\n+import com.mercadopago.android.px.model.internal.PaymentConfiguration\n+import com.mercadopago.android.px.internal.services.Response\n+import com.mercadopago.android.px.internal.services.awaitCallback\n+import com.mercadopago.android.px.model.PaymentData\n+import com.mercadopago.android.px.model.internal.remedies.RemedyPaymentMethod\n import com.mercadopago.android.px.tracking.internal.events.RemedyEvent\n import com.mercadopago.android.px.tracking.internal.model.RemedyTrackData\n import kotlinx.coroutines.CoroutineScope\n import kotlinx.coroutines.Dispatchers\n import kotlinx.coroutines.launch\n import kotlinx.coroutines.withContext\n+import java.lang.Exception\n import java.util.*\n \n internal class RemediesViewModel(\n     private val remediesModel: RemediesModel,\n+    paymentModel: PaymentModel,\n     private val paymentRepository: PaymentRepository,\n     private val paymentSettingRepository: PaymentSettingRepository,\n     private val cardTokenRepository: CardTokenRepository,\n     private val escManagerBehaviour: ESCManagerBehaviour,\n     private val congratsRepository: CongratsRepository,\n-    private val paymentMethodType: String,\n-    private val paymentMethodId: String\n+    private val initRepository: InitRepository,\n+    private val amountConfigurationRepository: AmountConfigurationRepository\n ) : BaseViewModel(), Remedies.ViewModel {\n \n     val remedyState: MutableLiveData<RemedyState> = MutableLiveData()\n+    private val isSilverBullet = remediesModel.retryPayment?.isAnotherMethod == true\n+    private val methodIds: MethodIds\n     private var cvv = \"\"\n+    private var paymentConfiguration: PaymentConfiguration? = null\n+    private var card: Card? = null\n \n     init {\n-        remediesModel.cvvRemedyModel?.let {\n-            remedyState.value = RemedyState.ShowCvvRemedy(it)\n-        }\n-        remediesModel.highRiskRemedyModel?.let {\n-            remedyState.value = RemedyState.ShowKyCRemedy(it)\n+        methodIds = getMethodIds(paymentModel)!!\n+        val customOptionId = methodIds.customOptionId\n+        CoroutineScope(Dispatchers.IO).launch {\n+            loadInitResponse()?.let {initResponse ->\n+                val methodData = initResponse.express.find { it.customOptionId == customOptionId }\n+                val isCard = methodData?.isCard == true\n+                if (isCard) {\n+                    card = initResponse.getCardById(customOptionId)\n+                }\n+                paymentConfiguration = PaymentConfiguration(methodIds.methodId, customOptionId, isCard, false,\n+                    getPayerCost(customOptionId, paymentModel))\n+                withContext(Dispatchers.Main) {\n+                    remediesModel.retryPayment?.let {\n+                        remedyState.value = RemedyState.ShowRetryPaymentRemedy(Pair(it, methodData))\n+                    }\n+                    remediesModel.highRisk?.let {\n+                        remedyState.value = RemedyState.ShowKyCRemedy(it)\n+                    }\n+                }\n+            }\n         }\n     }\n \n     private fun getExtraInfoTrackForPaymentMethodSuggestion() = mapOf(\n-            \"payment_method_type\" to paymentMethodType,\n-            \"payment_method_id\" to paymentMethodId\n+        \"payment_method_type\" to methodIds.typeId,\n+        \"payment_method_id\" to methodIds.methodId\n     )\n \n     override fun onPayButtonPressed(callback: PayButton.OnEnqueueResolvedCallback) {\n+        if (isSilverBullet) {\n+            startPayment(callback)\n+        } else {\n+            startCvvRecovery(callback)\n+        }\n+    }\n+\n+    override fun onPrePayment(callback: PayButton.OnReadyForPaymentCallback) {\n+        callback.call(paymentConfiguration!!)\n+    }\n+\n+    private fun getMethodIds(paymentModel: PaymentModel): MethodIds? {\n+        return paymentModel.run {\n+            if (isSilverBullet) {\n+                remedies.suggestedPaymentMethod?.alternativePaymentMethod?.let {\n+                    MethodIds.with(it)\n+                }\n+            } else {\n+                MethodIds.with(paymentResult.paymentData)\n+            }\n+        }\n+    }\n+\n+    private fun getPayerCost(customOptionId: String, paymentModel: PaymentModel): PayerCost? {\n+        return paymentModel.run {\n+            if (isSilverBullet) {\n+                remedies.suggestedPaymentMethod?.alternativePaymentMethod?.installmentsList?.run {\n+                    if (isNotEmpty()) {\n+                        get(0).let {\n+                            amountConfigurationRepository.getConfigurationFor(customOptionId)?.run {\n+                                for (i in 0 until payerCosts.size) {\n+                                    val payerCost = payerCosts[i]\n+                                    if (payerCost.installments == it.installments) {\n+                                        remediesModel.retryPayment?.payerCost = RemediesPayerCost(i, it.installments)\n+                                        return payerCost\n+                                    }\n+                                }\n+                            }\n+                        }\n+                    }\n+                    return null\n+                }\n+            } else {\n+                paymentResult.paymentData.payerCost\n+            }\n+        }\n+    }\n+\n+    private suspend fun loadInitResponse() =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "originalPosition": 137}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "158bec3149e7ec19b7515c8fbad573c2d566270d", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/158bec3149e7ec19b7515c8fbad573c2d566270d", "committedDate": "2020-04-29T23:21:57Z", "message": "Fixed tests"}, "afterCommit": {"oid": "dff46ac2656c653ffb8f994739b5a8ac18085bd2", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/dff46ac2656c653ffb8f994739b5a8ac18085bd2", "committedDate": "2020-04-29T23:23:24Z", "message": "Fixed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccab1720c344c6a336509a2db75218f04fe678e0", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/ccab1720c344c6a336509a2db75218f04fe678e0", "committedDate": "2020-04-29T23:27:56Z", "message": "Fixed tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dff46ac2656c653ffb8f994739b5a8ac18085bd2", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/dff46ac2656c653ffb8f994739b5a8ac18085bd2", "committedDate": "2020-04-29T23:23:24Z", "message": "Fixed tests"}, "afterCommit": {"oid": "ccab1720c344c6a336509a2db75218f04fe678e0", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/ccab1720c344c6a336509a2db75218f04fe678e0", "committedDate": "2020-04-29T23:27:56Z", "message": "Fixed tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMTEyMTAw", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403112100", "createdAt": "2020-04-29T23:37:51Z", "commit": {"oid": "ccab1720c344c6a336509a2db75218f04fe678e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d8c43c2c03b34cf3eb19e9ae1b8a58a8e7697b", "author": {"user": {"login": "guchito9", "name": "Guche Mantuano"}}, "url": "https://github.com/mercadopago/px-android/commit/39d8c43c2c03b34cf3eb19e9ae1b8a58a8e7697b", "committedDate": "2020-04-30T04:49:57Z", "message": "Fixed cvv visibility on high risk remedy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjc2OTEw", "url": "https://github.com/mercadopago/px-android/pull/2125#pullrequestreview-403676910", "createdAt": "2020-04-30T16:19:22Z", "commit": {"oid": "777532872e07a1b31e01addc66b290427d6c66cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3847, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}