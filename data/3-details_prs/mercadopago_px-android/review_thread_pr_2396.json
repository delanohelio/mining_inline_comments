{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNTk5NjE5", "number": 2396, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjo1NDo0NVrOE_mwaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzoxMjozMFrOE_nMsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTMwNzI5OnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/business_result/BusinessPaymentResultPresenter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjo1NDo0NVrOH9ZmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDo1MzozOFrOH9evSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0NDU3NA==", "bodyText": "Te parece guardar model.getPaymentCongratsResponse() en una variable?", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534144574", "createdAt": "2020-12-02T12:54:45Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/business_result/BusinessPaymentResultPresenter.java", "diffHunk": "@@ -71,7 +71,8 @@ public void onStop() {\n     @Override\n     public void onAbort() {\n         new AbortEvent(viewTracker).track();\n-        getView().processCustomExit();\n+        getView().processCustomExit(model.getPaymentCongratsResponse().getBackUrl(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIyODgwOQ==", "bodyText": "Me parece", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534228809", "createdAt": "2020-12-02T14:53:38Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/business_result/BusinessPaymentResultPresenter.java", "diffHunk": "@@ -71,7 +71,8 @@ public void onStop() {\n     @Override\n     public void onAbort() {\n         new AbortEvent(viewTracker).track();\n-        getView().processCustomExit();\n+        getView().processCustomExit(model.getPaymentCongratsResponse().getBackUrl(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0NDU3NA=="}, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTMwODI0OnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/business_result/BusinessPaymentResultPresenter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjo1NDo1OVrOH9Zm0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjo1NDo1OVrOH9Zm0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0NDcyMw==", "bodyText": "idem anterior", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534144723", "createdAt": "2020-12-02T12:54:59Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/business_result/BusinessPaymentResultPresenter.java", "diffHunk": "@@ -84,7 +85,8 @@ public void onClick(@NonNull final ExitAction action) {\n                 } else if (action instanceof SecondaryExitAction) {\n                     new SecondaryActionEvent(viewTracker).track();\n                 }\n-                getView().processCustomExit(action);\n+                getView().processCustomExit(action, model.getPaymentCongratsResponse().getBackUrl(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTMyNzgwOnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/CheckoutActivity.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjo1OTozOVrOH9ZyYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDo1NDo0MFrOH9eyqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0NzY4Mg==", "bodyText": "De la forma que estaba antes ten\u00edamos una sola llamada para un Normal exit - Result screen. Cual es la diferencia ahora?", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534147682", "createdAt": "2020-12-02T12:59:39Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/CheckoutActivity.java", "diffHunk": "@@ -273,18 +277,26 @@ private void handleCancel() {\n     }\n \n     private void handleCustomExit(final Intent data) {\n-        if (data != null && data.hasExtra(EXTRA_CLIENT_RES_CODE)) {\n-            //Business custom exit\n-            final int resCode = data.getIntExtra(EXTRA_CLIENT_RES_CODE, RESULT_OK);\n-            presenter.onPaymentResultResponse(resCode);\n-        } else if (data != null && data.hasExtra(EXTRA_RESULT_CODE)) {\n-            //Custom exit  - Result screen.\n-            final Integer finalResultCode = data.getIntExtra(EXTRA_RESULT_CODE, PAYMENT_RESULT_CODE);\n-            customDataBundle = data;\n-            presenter.onPaymentResultResponse(finalResultCode);\n+        if (data != null) {\n+            final String backUrl = data.getStringExtra(Constants.EXTRA_BACK_URL);\n+            final String redirectUrl = data.getStringExtra(Constants.EXTRA_REDIRECT_URL);\n+\n+            if (data.hasExtra(EXTRA_CLIENT_RES_CODE)) {\n+                //Business custom exit\n+                final int resCode = data.getIntExtra(EXTRA_CLIENT_RES_CODE, RESULT_OK);\n+                presenter.onPaymentResultResponse(resCode, backUrl, redirectUrl);\n+            } else if (data != null && data.hasExtra(EXTRA_RESULT_CODE)) {\n+                //Custom exit  - Result screen.\n+                final Integer finalResultCode = data.getIntExtra(EXTRA_RESULT_CODE, PAYMENT_RESULT_CODE);\n+                customDataBundle = data;\n+                presenter.onPaymentResultResponse(finalResultCode, backUrl, redirectUrl);\n+            } else {\n+                //Normal exit - Result screen.\n+                presenter.onPaymentResultResponse(null, backUrl, redirectUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIyOTY3NQ==", "bodyText": "Antes no importaba si el intent era null o no. Yo ahora si el intent no es nulo levanto backUrl y sino no. El intent no deber\u00eda ser nunca nulo pero bueno, por las dudas", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534229675", "createdAt": "2020-12-02T14:54:40Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/CheckoutActivity.java", "diffHunk": "@@ -273,18 +277,26 @@ private void handleCancel() {\n     }\n \n     private void handleCustomExit(final Intent data) {\n-        if (data != null && data.hasExtra(EXTRA_CLIENT_RES_CODE)) {\n-            //Business custom exit\n-            final int resCode = data.getIntExtra(EXTRA_CLIENT_RES_CODE, RESULT_OK);\n-            presenter.onPaymentResultResponse(resCode);\n-        } else if (data != null && data.hasExtra(EXTRA_RESULT_CODE)) {\n-            //Custom exit  - Result screen.\n-            final Integer finalResultCode = data.getIntExtra(EXTRA_RESULT_CODE, PAYMENT_RESULT_CODE);\n-            customDataBundle = data;\n-            presenter.onPaymentResultResponse(finalResultCode);\n+        if (data != null) {\n+            final String backUrl = data.getStringExtra(Constants.EXTRA_BACK_URL);\n+            final String redirectUrl = data.getStringExtra(Constants.EXTRA_REDIRECT_URL);\n+\n+            if (data.hasExtra(EXTRA_CLIENT_RES_CODE)) {\n+                //Business custom exit\n+                final int resCode = data.getIntExtra(EXTRA_CLIENT_RES_CODE, RESULT_OK);\n+                presenter.onPaymentResultResponse(resCode, backUrl, redirectUrl);\n+            } else if (data != null && data.hasExtra(EXTRA_RESULT_CODE)) {\n+                //Custom exit  - Result screen.\n+                final Integer finalResultCode = data.getIntExtra(EXTRA_RESULT_CODE, PAYMENT_RESULT_CODE);\n+                customDataBundle = data;\n+                presenter.onPaymentResultResponse(finalResultCode, backUrl, redirectUrl);\n+            } else {\n+                //Normal exit - Result screen.\n+                presenter.onPaymentResultResponse(null, backUrl, redirectUrl);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0NzY4Mg=="}, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTMzNTAwOnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/PostCongratsDriver.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzowMToyM1rOH9Z2nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzowMToyM1rOH9Z2nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE0ODc2NA==", "bodyText": "en todo caso usar\u00eda un apply, el run devuelve el resultado del bloque.", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534148764", "createdAt": "2020-12-02T13:01:23Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/PostCongratsDriver.kt", "diffHunk": "@@ -1,43 +1,56 @@\n package com.mercadopago.android.px.internal.features.checkout\n \n-import com.mercadopago.android.px.internal.features.dummy_result.RedirectHelper\n+import com.mercadopago.android.px.internal.extensions.isNotNullNorEmpty\n import com.mercadopago.android.px.internal.repository.PaymentRepository\n import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n+import com.mercadopago.android.px.model.IPaymentDescriptor\n import com.mercadopago.android.px.model.Payment\n import com.mercadopago.android.px.preferences.CheckoutPreference\n \n-class PostCongratsDriver(builder: Builder) {\n+internal class PostCongratsDriver(builder: Builder) {\n \n     private val paymentSettingRepository = builder.paymentSettingRepository\n     private val paymentRepository = builder.paymentRepository\n+    private val postPaymentUrlsMapper = builder.postPaymentUrlsMapper\n+    private val backUrl = builder.backUrl\n+    private val redirectUrl = builder.redirectUrl\n     private val action = builder.action!!\n     private val customResponseCode = builder.customResponseCode\n \n     fun execute() {\n         val payment = paymentRepository.payment\n         paymentSettingRepository.checkoutPreference?.let { preference ->\n-            payment?.let { resolveRedirectUrls(preference, it.paymentStatus) }\n+            payment?.let { payment -> resolveRedirectUrls(preference, payment) }\n         }\n         //We only return the Payment object to respect our signature\n         action.exitWith(customResponseCode, if (payment is Payment) payment else null)\n     }\n \n-    private fun resolveRedirectUrls(preference: CheckoutPreference, paymentStatus: String) {\n-        RedirectHelper.resolveRedirect(paymentStatus,\n-            Pair(preference.redirectUrls, action::openInWebView),\n-            Pair(preference.backUrls, action::goToLink)\n-        )\n+    private fun resolveRedirectUrls(preference: CheckoutPreference, payment: IPaymentDescriptor) {\n+        postPaymentUrlsMapper.map(PostPaymentUrlsMapper.Model(\n+            backUrl, redirectUrl, payment, preference, paymentSettingRepository.site.id\n+        )).run {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTM2MTkyOnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/PostCongratsDriver.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzowODoxNVrOH9aG4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzowODoxNVrOH9aG4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE1MjkzMA==", "bodyText": "Po si te tenes ganas. Estoy viendo que solo usamos la preferencia y el siteId del paymentSettingRepository. Porque no solo pasamos estos dos datos? Creo que nos puede ayudar a emprolijar el c\u00f3digo, por ejemplo mover el postPaymentUrlsMapper.", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534152930", "createdAt": "2020-12-02T13:08:15Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/PostCongratsDriver.kt", "diffHunk": "@@ -1,43 +1,56 @@\n package com.mercadopago.android.px.internal.features.checkout\n \n-import com.mercadopago.android.px.internal.features.dummy_result.RedirectHelper\n+import com.mercadopago.android.px.internal.extensions.isNotNullNorEmpty\n import com.mercadopago.android.px.internal.repository.PaymentRepository\n import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n+import com.mercadopago.android.px.model.IPaymentDescriptor\n import com.mercadopago.android.px.model.Payment\n import com.mercadopago.android.px.preferences.CheckoutPreference\n \n-class PostCongratsDriver(builder: Builder) {\n+internal class PostCongratsDriver(builder: Builder) {\n \n     private val paymentSettingRepository = builder.paymentSettingRepository", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTM3OTY4OnYy", "diffSide": "RIGHT", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/PaymentResultPresenter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzoxMjozMFrOH9aRbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNTowMToxOFrOH9fJSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE1NTYzMQ==", "bodyText": "Si pasamos paymentModel.getCongratsResponse() en una variable?", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534155631", "createdAt": "2020-12-02T13:12:30Z", "author": {"login": "jorGonzalez291292"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/PaymentResultPresenter.java", "diffHunk": "@@ -284,4 +284,9 @@ public void onClickMoneySplit() {\n             getView().launchDeepLink(deepLink);\n         }\n     }\n+\n+    private void finishWithResult(final int resultCode) {\n+        getView().finishWithResult(resultCode, paymentModel.getCongratsResponse().getBackUrl(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzNTQ2NA==", "bodyText": "De una", "url": "https://github.com/mercadopago/px-android/pull/2396#discussion_r534235464", "createdAt": "2020-12-02T15:01:18Z", "author": {"login": "guchito9"}, "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/PaymentResultPresenter.java", "diffHunk": "@@ -284,4 +284,9 @@ public void onClickMoneySplit() {\n             getView().launchDeepLink(deepLink);\n         }\n     }\n+\n+    private void finishWithResult(final int resultCode) {\n+        getView().finishWithResult(resultCode, paymentModel.getCongratsResponse().getBackUrl(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE1NTYzMQ=="}, "originalCommit": {"oid": "ec5dc94aad5597cc18b4edde3ac72a12bbaaf8ca"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1744, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}