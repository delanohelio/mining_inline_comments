{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MjAxODkw", "number": 1476, "title": "Support task provider strategy", "bodyText": "What does this PR change?\nThis PR supports PlacementStrategyType and PlacementStrategyField at EcsClientConfig and EcsCommandExecutor\nBackground\nAWS ECS supports Task Placement Strategies option to specify a container instance at where an ECS task will run. https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-placement-strategies.html\nThis PR enables user to specify TaskPlacementStrategy and TaskPlacementField for each ECS task.", "createdAt": "2020-11-04T07:51:13Z", "url": "https://github.com/treasure-data/digdag/pull/1476", "merged": true, "mergeCommit": {"oid": "75316bf19e4476825fea1cd5c20bbeadc5095d9b"}, "closed": true, "closedAt": "2020-11-05T10:20:48Z", "author": {"login": "serihiro"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZHYU_gH2gAyNTE1MjAxODkwOjQyM2YwZjA2NDJjMTgxMzg4YjgwYTYwODAwNzM1ZTNlOWQ2MmRkMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZfPbXgFqTUyNDA4OTYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "423f0f0642c181388b80a60800735e3e9d62dd05", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/423f0f0642c181388b80a60800735e3e9d62dd05", "committedDate": "2020-11-04T06:01:15Z", "message": "Add placementStrategyType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "904ec20c2d3fd9544ed487cdf87ff413a6545ab9", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/904ec20c2d3fd9544ed487cdf87ff413a6545ab9", "committedDate": "2020-11-04T06:08:28Z", "message": "Add placementStrategyField"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103a55fe487ab9a698ad9f0af82e14422ebcae74", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/103a55fe487ab9a698ad9f0af82e14422ebcae74", "committedDate": "2020-11-04T07:39:24Z", "message": "Support specifying `PlacementStrategy`\non EcsCommandExecutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/f2906e9d8104dcd573f3304bc12ed1dc6f31b076", "committedDate": "2020-11-04T07:41:43Z", "message": "Add a validation for `PlacementStrategy`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTIzNjA2", "url": "https://github.com/treasure-data/digdag/pull/1476#pullrequestreview-523923606", "createdAt": "2020-11-05T04:50:12Z", "commit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNDo1MDoxMlrOHtzc7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNDo1MzoxNVrOHtzfuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5MDk1OA==", "bodyText": "[minor] invalidReason sounds a bit weird since this is a just exception here. If you extracted a pure reason-like object from an exception like with Reason invalidReason = ex.getReason(), it would be good.", "url": "https://github.com/treasure-data/digdag/pull/1476#discussion_r517790958", "createdAt": "2020-11-05T04:50:12Z", "author": {"login": "komamitsu"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -530,9 +532,31 @@ RunTaskRequest buildRunTaskRequest(\n         setEcsTaskStartedBy(clientConfig, runTaskRequest);\n         setEcsNetworkConfiguration(clientConfig, runTaskRequest);\n         setCapacityProviderStrategy(clientConfig, runTaskRequest);\n+        setPlacementStrategy(clientConfig, runTaskRequest);\n         return runTaskRequest;\n     }\n \n+    private void setPlacementStrategy(EcsClientConfig clientConfig, RunTaskRequest runTaskRequest) throws ConfigException\n+    {\n+        if (clientConfig.getPlacementStrategyType().isPresent()) {\n+            final PlacementStrategyType placementStrategyType;\n+            try {\n+                placementStrategyType = PlacementStrategyType.fromValue(clientConfig.getPlacementStrategyType().get());\n+            }\n+            catch (IllegalArgumentException invalidReason) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5MTY3Mw==", "bodyText": "Don't we need to check the other case like placementStrategyType.isPresent() && !placementStrategyField.isPresent()?", "url": "https://github.com/treasure-data/digdag/pull/1476#discussion_r517791673", "createdAt": "2020-11-05T04:53:15Z", "author": {"login": "komamitsu"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -31,6 +32,12 @@ public EcsClientConfig(EcsClientConfigBuilder builder)\n         this.memory = builder.getMemory();\n         this.startedBy = builder.getStartedBy();\n         this.assignPublicIp = builder.isAssignPublicIp();\n+        this.placementStrategyType = builder.getPlacementStrategyType();\n+        this.placementStrategyField = builder.getPlacementStrategyField();\n+\n+        if (!placementStrategyType.isPresent() && placementStrategyField.isPresent()) {\n+            throw new ConfigException(\"PlacementStrategyField must be set with PlacementStrategyType\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTMyMTMx", "url": "https://github.com/treasure-data/digdag/pull/1476#pullrequestreview-523932131", "createdAt": "2020-11-05T05:19:08Z", "commit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToxOTowOFrOHtz4-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToxOTowOFrOHtz4-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5ODEzNw==", "bodyText": "throws should be at next line", "url": "https://github.com/treasure-data/digdag/pull/1476#discussion_r517798137", "createdAt": "2020-11-05T05:19:08Z", "author": {"login": "komamitsu"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -530,9 +532,31 @@ RunTaskRequest buildRunTaskRequest(\n         setEcsTaskStartedBy(clientConfig, runTaskRequest);\n         setEcsNetworkConfiguration(clientConfig, runTaskRequest);\n         setCapacityProviderStrategy(clientConfig, runTaskRequest);\n+        setPlacementStrategy(clientConfig, runTaskRequest);\n         return runTaskRequest;\n     }\n \n+    private void setPlacementStrategy(EcsClientConfig clientConfig, RunTaskRequest runTaskRequest) throws ConfigException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2906e9d8104dcd573f3304bc12ed1dc6f31b076"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffdd603586098d472b371b78fb080e523311bca9", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/ffdd603586098d472b371b78fb080e523311bca9", "committedDate": "2020-11-05T06:25:42Z", "message": "Rename the exception object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a274d6684934b01fbd0396779dcf25083152476a", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/a274d6684934b01fbd0396779dcf25083152476a", "committedDate": "2020-11-05T06:27:09Z", "message": "Fix format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69865e39e975d19ec570e90c586d0cfc886ebd59", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/69865e39e975d19ec570e90c586d0cfc886ebd59", "committedDate": "2020-11-05T06:37:42Z", "message": "Leave the description about placement strategy specification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDg5NjI0", "url": "https://github.com/treasure-data/digdag/pull/1476#pullrequestreview-524089624", "createdAt": "2020-11-05T09:49:15Z", "commit": {"oid": "69865e39e975d19ec570e90c586d0cfc886ebd59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4075, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}