{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTU5NjMy", "number": 1430, "title": "Configurable Limits.", "bodyText": "To be configurable, introduce two config parameters as follows\nexecutor.task_max_run\nexecutor.attempt_max_run", "createdAt": "2020-07-03T09:37:35Z", "url": "https://github.com/treasure-data/digdag/pull/1430", "merged": true, "mergeCommit": {"oid": "cefde0d80a6f2a573ac800454da8b4fa7f3e87ad"}, "closed": true, "closedAt": "2020-07-07T08:59:08Z", "author": {"login": "yoyama"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyHtTjgBqjM1MTM5NjgyMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyfZNIgH2gAyNDQzOTU5NjMyOmFmZjI1NmQwNWZiYTEwODg4OTE1NDgwNjg3M2Y4OTc0NjdkYzFiYjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5238ce3c5b3558f5760ac0e5e529a7053e872000", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/5238ce3c5b3558f5760ac0e5e529a7053e872000", "committedDate": "2020-07-03T09:33:38Z", "message": "Configurable Limits.\n\nexecutor.task_max_run\nexecutor.attempt_max_run"}, "afterCommit": {"oid": "c15b7380ca06b8e9c10c1382a7ff382f79da8104", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/c15b7380ca06b8e9c10c1382a7ff382f79da8104", "committedDate": "2020-07-06T02:19:12Z", "message": "Configurable Limits.\n\nexecutor.task_max_run\nexecutor.attempt_max_run"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODkxMzEw", "url": "https://github.com/treasure-data/digdag/pull/1430#pullrequestreview-442891310", "createdAt": "2020-07-06T08:53:30Z", "commit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODo1MzozMVrOGtOldA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODo1MzozMVrOGtOldA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA3ODA2OA==", "bodyText": "[minor] How about memoization of this value in terms of performance? Do you think we need to memoize this value in terms of performance?", "url": "https://github.com/treasure-data/digdag/pull/1430#discussion_r450078068", "createdAt": "2020-07-06T08:53:31Z", "author": {"login": "komamitsu"}, "path": "digdag-core/src/main/java/io/digdag/core/Limits.java", "diffHunk": "@@ -8,15 +12,21 @@\n     private static final long MAX_ATTEMPTS = Long.valueOf(\n             System.getProperty(\"io.digdag.limits.maxAttempts\", \"100\"));\n \n-    // TODO (dano): this should be configurable by config file etc and not just system property\n+    private final Config systemConfig;\n+\n+    @Inject\n+    public Limits(Config systemConfig)\n+    {\n+        this.systemConfig = systemConfig;\n+    }\n \n-    public static long maxWorkflowTasks()\n+    public long maxWorkflowTasks()\n     {\n-        return MAX_WORKFLOW_TASKS;\n+        return systemConfig.get(\"executor.task_max_run\", long.class, MAX_WORKFLOW_TASKS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTAyMTM3", "url": "https://github.com/treasure-data/digdag/pull/1430#pullrequestreview-442902137", "createdAt": "2020-07-06T09:07:59Z", "commit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwOTowNzo1OVrOGtPG8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwOTowNzo1OVrOGtPG8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA4NjY0MQ==", "bodyText": "Is it possible to extend OperatorContext to have limits field instead?", "url": "https://github.com/treasure-data/digdag/pull/1430#discussion_r450086641", "createdAt": "2020-07-06T09:07:59Z", "author": {"login": "komamitsu"}, "path": "digdag-core/src/test/java/io/digdag/core/workflow/ForEachOperatorFactory.java", "diffHunk": "@@ -41,17 +45,19 @@ public String getType()\n     @Override\n     public ForEachOperator newOperator(OperatorContext context)\n     {\n-        return new ForEachOperator(context);\n+        return new ForEachOperator(context, limits);\n     }\n \n     static class ForEachOperator\n             implements Operator\n     {\n         private final TaskRequest request;\n+        private final Limits limits;\n \n-        public ForEachOperator(OperatorContext context)\n+        public ForEachOperator(OperatorContext context, Limits limits)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTA2Njg1", "url": "https://github.com/treasure-data/digdag/pull/1430#pullrequestreview-442906685", "createdAt": "2020-07-06T09:14:16Z", "commit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwOToxNDoxN1rOGtPUqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwOToxNDoxN1rOGtPUqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA5MDE1Mw==", "bodyText": "How about adding term at once or in concurrently in the description?", "url": "https://github.com/treasure-data/digdag/pull/1430#discussion_r450090153", "createdAt": "2020-07-06T09:14:17Z", "author": {"login": "komamitsu"}, "path": "digdag-docs/src/command_reference.rst", "diffHunk": "@@ -386,7 +386,9 @@ In the config file, following parameters are available\n * log-server.local.split_size (long. default: 0  (not splitted))\n * digdag.secret-encryption-key = (base64 encoded 128-bit AES encryption key)\n * executor.task_ttl (string. default: 1d. A task is killed if it is running longer than this period.)\n+* executor.task_max_run (integer. default: 1000. Max number of tasks in workflow.)\n * executor.attempt_ttl (string. default: 7d. An attempt is killed if it is running longer than this period.)\n+* executor.attempt_max_run (integer. default: 100. Max number of running attempts per each site_id.)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTA3MDYx", "url": "https://github.com/treasure-data/digdag/pull/1430#pullrequestreview-442907061", "createdAt": "2020-07-06T09:14:46Z", "commit": {"oid": "65a4d80334b1827f122bd277ae5e12c940107cc9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a0658e31de6ef2dcd72a08b34dfcc3e74753fc8", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/0a0658e31de6ef2dcd72a08b34dfcc3e74753fc8", "committedDate": "2020-07-07T04:04:53Z", "message": "Configurable Limits.\n\nexecutor.task_max_run\nexecutor.attempt_max_run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ab6c39f8dd4ebbeb3f97131064152fc7b2d618c", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/5ab6c39f8dd4ebbeb3f97131064152fc7b2d618c", "committedDate": "2020-07-07T04:04:53Z", "message": "Add document"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb3761cb931a857b748b81be7b70b00b12f85c9a", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/eb3761cb931a857b748b81be7b70b00b12f85c9a", "committedDate": "2020-07-07T04:04:53Z", "message": "Add tests in AttemptLimitIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a2a9c3d7b4e04aca1f026c604586a6c6c267b0d", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/7a2a9c3d7b4e04aca1f026c604586a6c6c267b0d", "committedDate": "2020-07-07T04:04:53Z", "message": "Add tests for task limit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9ef89d1b96e42a4bd5aafd374d5ed5a36342c9", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/5d9ef89d1b96e42a4bd5aafd374d5ed5a36342c9", "committedDate": "2020-07-07T04:04:53Z", "message": "Fix some issues based on the review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41379120a8463ab967796cd96bb49e5f6404571a", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/41379120a8463ab967796cd96bb49e5f6404571a", "committedDate": "2020-07-07T04:14:05Z", "message": "Change support Limits based on the review."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c6319b3e3078c69d7252996e8c5516c2bb33d3a", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/4c6319b3e3078c69d7252996e8c5516c2bb33d3a", "committedDate": "2020-07-06T10:02:38Z", "message": "Change support Limits based on the review."}, "afterCommit": {"oid": "41379120a8463ab967796cd96bb49e5f6404571a", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/41379120a8463ab967796cd96bb49e5f6404571a", "committedDate": "2020-07-07T04:14:05Z", "message": "Change support Limits based on the review."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTU0OTcx", "url": "https://github.com/treasure-data/digdag/pull/1430#pullrequestreview-443554971", "createdAt": "2020-07-07T04:32:39Z", "commit": {"oid": "41379120a8463ab967796cd96bb49e5f6404571a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNDozMjozOVrOGtuwFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNDozMjozOVrOGtuwFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNTA3Nw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/treasure-data/digdag/pull/1430#discussion_r450605077", "createdAt": "2020-07-07T04:32:39Z", "author": {"login": "komamitsu"}, "path": "digdag-core/src/main/java/io/digdag/core/Limits.java", "diffHunk": "@@ -8,15 +12,23 @@\n     private static final long MAX_ATTEMPTS = Long.valueOf(\n             System.getProperty(\"io.digdag.limits.maxAttempts\", \"100\"));\n \n-    // TODO (dano): this should be configurable by config file etc and not just system property\n+    private final long numOfMaxWorkflowTasks;\n+    private final long numOfMaxAttempts;\n+\n+    @Inject\n+    public Limits(Config systemConfig)\n+    {\n+        this.numOfMaxWorkflowTasks =  systemConfig.get(\"executor.task_max_run\", long.class, MAX_WORKFLOW_TASKS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41379120a8463ab967796cd96bb49e5f6404571a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aff256d05fba108889154806873f897467dc1bb2", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/aff256d05fba108889154806873f897467dc1bb2", "committedDate": "2020-07-07T05:56:53Z", "message": "Change getMaxWorkflowTasks() in OperatorContext to default to fix tests."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4036, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}