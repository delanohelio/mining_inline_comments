{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0Mjk1ODI0", "number": 1495, "title": "Improve the error handling of invalid `sla` definition in SessionMonitorExecutor", "bodyText": "Digdag basically validates a workflow when it's pushed, but there is lack of validation to dynamically generated tasks by sla.\nSo Digdag users can push invalid workflow like this (+mail>: is invalid)\nsla:\n  duration: 01:00:00\n  alert: true\n  +notice:\n    +mail>:\n      data: FOO BAR\n\nand it'll finally be handled as an unexpected system error here https://github.com/treasure-data/digdag/blob/v0_10/digdag-core/src/main/java/io/digdag/core/session/SessionMonitorExecutor.java#L104-L108.\nCurrent implementation causes 2 problems.\n\n\nWhen an invalid sla definition is evaluated, the deterministic exception is repeatedly thrown and the session monitor is retried until the attempt finishes and other session monitors aren't evaluated for a while. It means an invalid sla causes the delay of other workflows sla.\n\n\nInvalid sla definition shouldn't be handled as unexpected system error. Digdag has some extension points like io.digdag.core.ErrorReporter and io.digdag.spi.metrics.DigdagMetrics and they may be integrated with alerting and monitoring systems in production environment. Current implementation of the error handling could cause confusing alerts and/or metrics.\n\n\nThis PR addresses the 2 problems.", "createdAt": "2020-12-08T09:03:26Z", "url": "https://github.com/treasure-data/digdag/pull/1495", "merged": true, "mergeCommit": {"oid": "ba4cbaad74325e373f96ae0c499d13ab864be307"}, "closed": true, "closedAt": "2020-12-10T03:24:10Z", "author": {"login": "komamitsu"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkDwfFgH2gAyNTM0Mjk1ODI0OjFiMWQ0NzhjOWNkY2U0ZTFiNzI3ODg3NjdhNjMxYWUwMTg5NzgzYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkqQafgFqTU0ODc4MDE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b1d478c9cdce4e1b72788767a631ae0189783c2", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/1b1d478c9cdce4e1b72788767a631ae0189783c2", "committedDate": "2020-12-08T06:01:11Z", "message": "Take care of workflow config error gracefully in SessionMonitorExecutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41a6d2d3145f732f4af4a6a6a54ae87bc4963758", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/41a6d2d3145f732f4af4a6a6a54ae87bc4963758", "committedDate": "2020-12-08T08:07:57Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d18901c939b05562fd085e686033dd704bbde198", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/d18901c939b05562fd085e686033dd704bbde198", "committedDate": "2020-12-08T12:45:53Z", "message": "Avoid delaying other monitors and retrying a lot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjEwOTU4", "url": "https://github.com/treasure-data/digdag/pull/1495#pullrequestreview-547210958", "createdAt": "2020-12-08T13:01:10Z", "commit": {"oid": "d18901c939b05562fd085e686033dd704bbde198"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMzowMToxMFrOIBZudA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMzowMToxMFrOIBZudA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0MDk4MA==", "bodyText": "Returning Optional.absent() prevents retries.", "url": "https://github.com/treasure-data/digdag/pull/1495#discussion_r538340980", "createdAt": "2020-12-08T13:01:10Z", "author": {"login": "komamitsu"}, "path": "digdag-core/src/main/java/io/digdag/core/session/SessionMonitorExecutor.java", "diffHunk": "@@ -94,8 +96,15 @@ public void run()\n         try {\n             tm.begin(() -> {\n                 sm.lockReadySessionMonitors(Instant.now(), (storedMonitor) -> {\n-                    // runMonitor needs to return next runtime if this monitor should run again later\n-                    return runMonitor(storedMonitor);\n+                    try {\n+                        // runMonitor needs to return next runtime if this monitor should run again later\n+                        return runMonitor(storedMonitor);\n+                    }\n+                    catch (ModelValidationException | ConfigException e) {\n+                        logger.error(\n+                                \"Failed to schedule a session monitor task due to deterministic error. This won't be retried.\", e);\n+                        return Optional.absent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18901c939b05562fd085e686033dd704bbde198"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Nzc3OTA3", "url": "https://github.com/treasure-data/digdag/pull/1495#pullrequestreview-548777907", "createdAt": "2020-12-10T02:45:41Z", "commit": {"oid": "d18901c939b05562fd085e686033dd704bbde198"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzgwMTcy", "url": "https://github.com/treasure-data/digdag/pull/1495#pullrequestreview-548780172", "createdAt": "2020-12-10T02:52:27Z", "commit": {"oid": "d18901c939b05562fd085e686033dd704bbde198"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4091, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}