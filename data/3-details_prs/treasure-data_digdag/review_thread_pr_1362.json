{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MDgzNTI3", "number": 1362, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTo1NjozMlrODhCvxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1MTozMVrODjs9qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTc0NTk4OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTo1NjozMlrOFrla7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMjoxODozMVrOFrl_Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0NjE4OQ==", "bodyText": "Will it be better to use httpstatus code instead of 400 ~ 500 ? because not all 4xx are authentication failure", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r381246189", "createdAt": "2020-02-19T11:56:32Z", "author": {"login": "LeenSun"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -408,17 +415,27 @@ private static int exponentialBackoffInterval(DurationInterval pollInterval, int\n     static boolean isDeterministicClientException(Exception ex)\n     {\n         if (ex instanceof TDClientHttpException) {\n-            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n-            switch (statusCode) {\n-                case HttpStatus.TOO_MANY_REQUESTS_429:\n-                case HttpStatus.REQUEST_TIMEOUT_408:\n-                    return false;\n-                default:\n-                    // return true if 4xx\n-                    return statusCode >= 400 && statusCode < 500;\n-            }\n+            return isAuthenticationErrorException((TDClientHttpException)ex);\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isAuthenticationErrorException(TDClientHttpException ex)\n+    {\n+        int statusCode = ex.getStatusCode();\n+        switch (statusCode) {\n+            case HttpStatus.TOO_MANY_REQUESTS_429:\n+            case HttpStatus.REQUEST_TIMEOUT_408:\n+                return false;\n+            default:\n+                // return true if 4xx\n+                return statusCode >= 400 && statusCode < 500;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f088a50929492186a893e32e07b08a5364cba671"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI1NTQ5OQ==", "bodyText": "Thanks for pointing out! I fixed here. 73cdc06", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r381255499", "createdAt": "2020-02-19T12:18:31Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -408,17 +415,27 @@ private static int exponentialBackoffInterval(DurationInterval pollInterval, int\n     static boolean isDeterministicClientException(Exception ex)\n     {\n         if (ex instanceof TDClientHttpException) {\n-            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n-            switch (statusCode) {\n-                case HttpStatus.TOO_MANY_REQUESTS_429:\n-                case HttpStatus.REQUEST_TIMEOUT_408:\n-                    return false;\n-                default:\n-                    // return true if 4xx\n-                    return statusCode >= 400 && statusCode < 500;\n-            }\n+            return isAuthenticationErrorException((TDClientHttpException)ex);\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isAuthenticationErrorException(TDClientHttpException ex)\n+    {\n+        int statusCode = ex.getStatusCode();\n+        switch (statusCode) {\n+            case HttpStatus.TOO_MANY_REQUESTS_429:\n+            case HttpStatus.REQUEST_TIMEOUT_408:\n+                return false;\n+            default:\n+                // return true if 4xx\n+                return statusCode >= 400 && statusCode < 500;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0NjE4OQ=="}, "originalCommit": {"oid": "f088a50929492186a893e32e07b08a5364cba671"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NzU3MTY0OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo0MTowM1rOFsuBgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo0MTowM1rOFsuBgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNTcxNQ==", "bodyText": "I am not sure 401 and 403 are only authentication errors.\nBut you have investigated it and as result you set condition, it is ok.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r382435715", "createdAt": "2020-02-21T07:41:03Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -418,7 +442,43 @@ static boolean isDeterministicClientException(Exception ex)\n                     return statusCode >= 400 && statusCode < 500;\n             }\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isNeedNotRetryException(Exception ex)\n+    {\n+        if (ex instanceof TDClientHttpException) {\n+            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n+            switch (statusCode) {\n+                case HttpStatus.TOO_MANY_REQUESTS_429:\n+                case HttpStatus.REQUEST_TIMEOUT_408:\n+                case HttpStatus.UNAUTHORIZED_401:\n+                case HttpStatus.FORBIDDEN_403:\n+                    return false;\n+                default:\n+                    // return true if 4xx\n+                    return statusCode >= 400 && statusCode < 500;\n+            }\n+        }\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isAuthenticationErrorException(TDClientHttpException ex)\n+    {\n+        int statusCode = ex.getStatusCode();\n+        switch (statusCode) {\n+            case HttpStatus.UNAUTHORIZED_401:\n+            // This is not for authentication basically, but it may be 403 for auth token error. https://tools.ietf.org/html/rfc6750\n+            case HttpStatus.FORBIDDEN_403:\n+                return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NzU4MTE2OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo0NjowMVrOFsuHaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjowMDoxNFrOFt2RNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNzIyNw==", "bodyText": "Not serious, but method name may be difficult to understand. If possible rename is better.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r382437227", "createdAt": "2020-02-21T07:46:01Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -418,7 +442,43 @@ static boolean isDeterministicClientException(Exception ex)\n                     return statusCode >= 400 && statusCode < 500;\n             }\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isNeedNotRetryException(Exception ex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxOTM4Mw==", "bodyText": "I fixed to isDeterministicException opposite to isDeterministicClientException because it includes non-client(authentication) but deterministic. Please tell me if you have better idea.\n972d0b7", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r383619383", "createdAt": "2020-02-25T02:00:14Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -418,7 +442,43 @@ static boolean isDeterministicClientException(Exception ex)\n                     return statusCode >= 400 && statusCode < 500;\n             }\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isNeedNotRetryException(Exception ex)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNzIyNw=="}, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NzU4Nzg1OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo0OToyN1rOFsuLqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo0OToyN1rOFsuLqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzODMxNA==", "bodyText": "I am not sure this condition is correct or not.\nIf this behavior is different from original, we should clarify the change.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r382438314", "createdAt": "2020-02-21T07:49:27Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -418,7 +442,43 @@ static boolean isDeterministicClientException(Exception ex)\n                     return statusCode >= 400 && statusCode < 500;\n             }\n         }\n-        else if (ex instanceof TDClientException) {\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isNeedNotRetryException(Exception ex)\n+    {\n+        if (ex instanceof TDClientHttpException) {\n+            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n+            switch (statusCode) {\n+                case HttpStatus.TOO_MANY_REQUESTS_429:\n+                case HttpStatus.REQUEST_TIMEOUT_408:\n+                case HttpStatus.UNAUTHORIZED_401:\n+                case HttpStatus.FORBIDDEN_403:\n+                    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 148}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NzczOTMxOnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwODo1MzowMlrOFsvn9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMTo1Nzo1M1rOFt2O7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2MTk0MQ==", "bodyText": "This defaultRetryExecutor is still used in TDJobOperator. Is this OK?", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r382461941", "createdAt": "2020-02-21T08:53:02Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -67,7 +67,13 @@ public static TDOperator fromConfig(BaseTDClientFactory clientFactory, SystemDef\n \n         TDClient client = clientFactory.createClient(systemDefaultConfig, env, config, secrets);\n \n-        return new TDOperator(client, database);\n+        return new TDOperator(client, database, secrets);\n+    }\n+\n+    public void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n     }\n \n     static final RetryExecutor defaultRetryExecutor = retryExecutor()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODc5Nw==", "bodyText": "Thanks, I fixed TDJobOperator also here.\n87cf2ba", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r383618797", "createdAt": "2020-02-25T01:57:53Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDOperator.java", "diffHunk": "@@ -67,7 +67,13 @@ public static TDOperator fromConfig(BaseTDClientFactory clientFactory, SystemDef\n \n         TDClient client = clientFactory.createClient(systemDefaultConfig, env, config, secrets);\n \n-        return new TDOperator(client, database);\n+        return new TDOperator(client, database, secrets);\n+    }\n+\n+    public void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n     }\n \n     static final RetryExecutor defaultRetryExecutor = retryExecutor()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2MTk0MQ=="}, "originalCommit": {"oid": "5773201eee873d74491f2d790a3fd8710157ba9a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mzg1OTQ3OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoxMDowMVrOFvGP0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwODoyNzoxMlrOFvI-Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTc0NA==", "bodyText": "This method is similar to TDOperator.authenticatinRetryExecutor().\nBut some options are not set.\nCould you explain difference between them ?\nCan't we merge and reuse same logic?", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384929744", "createdAt": "2020-02-27T06:10:01Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzOTU5OA==", "bodyText": "updateApikey update client member in each TDOperator and TDJobOperator, and td-client doesn't have overwrite method for itself, and there is only withApiKey which returns new client, I thought I have to update each client member in each class, so I couldn't merge this method with passing client.\nSorry if I'm wrong.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384939598", "createdAt": "2020-02-27T06:47:51Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTc0NA=="}, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3NDM2Ng==", "bodyText": "Got it.  There is a possibility to fix by using base class. But anyway I understand.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384974366", "createdAt": "2020-02-27T08:27:12Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTc0NA=="}, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mzg2MTU1OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoxMToxMlrOFvGRAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjo0OTo1NFrOFvG4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMDA0OA==", "bodyText": "Ditto. It seems complet same logic in TDOperator.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384930048", "createdAt": "2020-02-27T06:11:12Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {\n+        return defaultRetryExecutor\n+            .withRetryLimit(AUTH_MAX_RETRY_LIMIT)\n+            .onRetry((exception, retryCount, retryLimit, retryWait) -> {\n+                logger.warn(\"apikey will be tried to update by retrying\");\n+                updateApikey(secrets);\n+            })\n+            .retryIf((exception) -> isAuthenticationErrorException(exception));\n     }\n \n     String getJobId()\n     {\n         return jobId;\n     }\n \n-    TDJobSummary getJobStatus()\n+    private <T> T callWithRetry(Callable<T> op)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDA4NQ==", "bodyText": "I couldn't make authenticatinRetryExecutor static or merged with above reason, so I couldn't make this like that also.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384940085", "createdAt": "2020-02-27T06:49:54Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {\n+        return defaultRetryExecutor\n+            .withRetryLimit(AUTH_MAX_RETRY_LIMIT)\n+            .onRetry((exception, retryCount, retryLimit, retryWait) -> {\n+                logger.warn(\"apikey will be tried to update by retrying\");\n+                updateApikey(secrets);\n+            })\n+            .retryIf((exception) -> isAuthenticationErrorException(exception));\n     }\n \n     String getJobId()\n     {\n         return jobId;\n     }\n \n-    TDJobSummary getJobStatus()\n+    private <T> T callWithRetry(Callable<T> op)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMDA0OA=="}, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mzg2NjEyOnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoxNDowOVrOFvGTwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjo1MDoxMFrOFvG4ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMDc1Mg==", "bodyText": "Logging is good. But warn is the best? In my understand it is not problem so debug or info may be better.", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384930752", "createdAt": "2020-02-27T06:14:09Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {\n+        return defaultRetryExecutor\n+            .withRetryLimit(AUTH_MAX_RETRY_LIMIT)\n+            .onRetry((exception, retryCount, retryLimit, retryWait) -> {\n+                logger.warn(\"apikey will be tried to update by retrying\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDE1NQ==", "bodyText": "I fixed here. f824f2e", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r384940155", "createdAt": "2020-02-27T06:50:10Z", "author": {"login": "naritta"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/TDJobOperator.java", "diffHunk": "@@ -7,59 +7,92 @@\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientHttpException;\n import com.treasuredata.client.model.TDJob;\n import com.treasuredata.client.model.TDJobSummary;\n import com.treasuredata.client.model.TDResultFormat;\n+import io.digdag.spi.SecretProvider;\n import io.digdag.spi.TaskExecutionException;\n+import io.digdag.util.RetryExecutor;\n import io.digdag.util.RetryExecutor.RetryGiveupException;\n import org.msgpack.core.MessagePack;\n import org.msgpack.core.MessageUnpacker;\n import org.msgpack.value.ArrayValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.UncheckedIOException;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n import java.util.zip.GZIPInputStream;\n \n+import static io.digdag.standards.operator.td.TDOperator.AUTH_MAX_RETRY_LIMIT;\n import static io.digdag.standards.operator.td.TDOperator.defaultRetryExecutor;\n+import static io.digdag.standards.operator.td.TDOperator.isAuthenticationErrorException;\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n \n class TDJobOperator\n {\n-    private final TDClient client;\n+    private TDClient client;\n     private final String jobId;\n+    private final SecretProvider secrets;\n \n-    TDJobOperator(TDClient client, String jobId)\n+    private static final Logger logger = LoggerFactory.getLogger(TDJobOperator.class);\n+\n+    TDJobOperator(TDClient client, String jobId, SecretProvider secrets)\n     {\n         this.client = client;\n         this.jobId = jobId;\n+        this.secrets = secrets;\n+    }\n+\n+    void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    RetryExecutor authenticatinRetryExecutor() {\n+        return defaultRetryExecutor\n+            .withRetryLimit(AUTH_MAX_RETRY_LIMIT)\n+            .onRetry((exception, retryCount, retryLimit, retryWait) -> {\n+                logger.warn(\"apikey will be tried to update by retrying\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMDc1Mg=="}, "originalCommit": {"oid": "30d6334dd253e238631d5f3ea0c54103fa9a7fc8"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzYzNDM0OnYy", "diffSide": "RIGHT", "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/BaseTDOperator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1MTozMVrOFvqLiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1MTozMVrOFvqLiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUxODQ3NQ==", "bodyText": "No new line?", "url": "https://github.com/treasure-data/digdag/pull/1362#discussion_r385518475", "createdAt": "2020-02-28T05:51:31Z", "author": {"login": "yoyama"}, "path": "digdag-standards/src/main/java/io/digdag/standards/operator/td/BaseTDOperator.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package io.digdag.standards.operator.td;\n+\n+import com.google.common.base.Throwables;\n+import com.treasuredata.client.TDClient;\n+import com.treasuredata.client.TDClientException;\n+import com.treasuredata.client.TDClientHttpException;\n+import io.digdag.spi.SecretProvider;\n+import io.digdag.util.RetryExecutor;\n+import io.digdag.util.RetryExecutor.RetryGiveupException;\n+import org.eclipse.jetty.http.HttpStatus;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.Callable;\n+\n+import static io.digdag.util.RetryExecutor.retryExecutor;\n+\n+public class BaseTDOperator\n+{\n+    private static final Logger logger = LoggerFactory.getLogger(BaseTDOperator.class);\n+\n+    private static final int INITIAL_RETRY_WAIT = 500;\n+    private static final int MAX_RETRY_WAIT = 2000;\n+    private static final int MAX_RETRY_LIMIT = 3;\n+    public static final int AUTH_MAX_RETRY_LIMIT = 1;\n+\n+    TDClient client;\n+    SecretProvider secrets;\n+\n+    static final RetryExecutor defaultRetryExecutor = retryExecutor()\n+            .withInitialRetryWait(INITIAL_RETRY_WAIT)\n+            .withMaxRetryWait(MAX_RETRY_WAIT)\n+            .withRetryLimit(MAX_RETRY_LIMIT)\n+            .retryIf((exception) -> !isDeterministicClientException(exception));\n+\n+    public void updateApikey(SecretProvider secrets)\n+    {\n+        String apikey = TDClientFactory.getApikey(secrets);\n+        client = client.withApiKey(apikey);\n+    }\n+\n+    public RetryExecutor authenticatinRetryExecutor() {\n+        return retryExecutor()\n+                .withInitialRetryWait(INITIAL_RETRY_WAIT)\n+                .withMaxRetryWait(MAX_RETRY_WAIT)\n+                .withRetryLimit(AUTH_MAX_RETRY_LIMIT)\n+                .onRetry((exception, retryCount, retryLimit, retryWait) -> {\n+                    logger.debug(\"apikey will be tried to update by retrying\");\n+                    updateApikey(secrets);\n+                })\n+                .retryIf((exception) -> isAuthenticationErrorException(exception));\n+    }\n+\n+    public <T> T callWithRetry(Callable<T> op)\n+    {\n+        try {\n+            return defaultRetryExecutor.run(() -> {\n+                try {\n+                    return authenticatinRetryExecutor().run(() -> op.call());\n+                } catch (RetryGiveupException ex) {\n+                    throw Throwables.propagate(ex.getCause());\n+                }\n+            });\n+        }\n+        catch (RetryGiveupException ex) {\n+            throw Throwables.propagate(ex.getCause());\n+        }\n+    }\n+\n+    static boolean isDeterministicClientException(Exception ex)\n+    {\n+        if (ex instanceof TDClientHttpException) {\n+            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n+            switch (statusCode) {\n+                case HttpStatus.TOO_MANY_REQUESTS_429:\n+                case HttpStatus.REQUEST_TIMEOUT_408:\n+                    return false;\n+                default:\n+                    // return true if 4xx\n+                    return statusCode >= 400 && statusCode < 500;\n+            }\n+        }\n+        return isFailedBeforeSendClientException(ex);\n+    }\n+\n+    static boolean isFailedBeforeSendClientException(Exception ex)\n+    {\n+        if (ex instanceof TDClientException) {\n+            // failed before sending HTTP request or receiving HTTP response\n+            TDClientException.ErrorType errorType = ((TDClientException) ex).getErrorType();\n+            switch (errorType) {\n+                case INVALID_CONFIGURATION:  // failed to read td.conf, failed to pares integer in properties set to TDClientBuilder, etc.\n+                case INVALID_INPUT:          // early table name validation fails, failed to format request body in json, etc.\n+                    return true;\n+                default:\n+                    // other cases such as PROXY_AUTHENTICATION_FAILURE, SSL_ERROR, REQUEST_TIMEOUT, INTERRUPTED, etc.\n+                    break;  // pass-through\n+            }\n+        }\n+        return false;\n+    }\n+\n+    static boolean isAuthenticationErrorException(Exception ex)\n+    {\n+        if (ex instanceof TDClientHttpException) {\n+            int statusCode = ((TDClientHttpException) ex).getStatusCode();\n+            switch (statusCode) {\n+                case HttpStatus.UNAUTHORIZED_401:\n+                    // This is not for authentication basically, but it may be 403 for auth token error. https://tools.ietf.org/html/rfc6750\n+                case HttpStatus.FORBIDDEN_403:\n+                    return true;\n+                default:\n+                    return false;\n+            }\n+        }\n+        else {\n+            return false;\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a59c888ef5840f776d8e696c80a39c361c2cf12"}, "originalPosition": 120}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1184, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}