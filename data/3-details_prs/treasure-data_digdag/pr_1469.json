{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MjczNjcx", "number": 1469, "title": "Support creating EcsClientConfig from taskConfig", "bodyText": "What does this PR change?\nThis PR introduces\n\na support to create an EcsClientConfig instance from taskConfig\nnew properties which can be specified from EcsClientConfig\n\n\na support to specify capacityProvider on a RunTaskRequest\na support to specify cpu on a ContainerOverride\na support to specify memory on a ContainerOverride\n\nBackground\nIn the current implementation, we can not create EcsClientConfig instances from taskConfig (we can create them only from systemConfig).\nSo it is difficult to execute Ecs tasks with different configurations for each Ecs task.", "createdAt": "2020-10-22T13:01:16Z", "url": "https://github.com/treasure-data/digdag/pull/1469", "merged": true, "mergeCommit": {"oid": "fd6f84e46e49ae1983a5b2d06825c1a8cea416e2"}, "closed": true, "closedAt": "2020-10-26T05:35:51Z", "author": {"login": "serihiro"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVBkLcAH2gAyNTA4MjczNjcxOjg1OWE1MDA1ZDlkNjM0ZWM2NmVmZTg3ZTY5YWMwNzEwMjMxNGFjOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWMEt9gH2gAyNTA4MjczNjcxOjE5MTU0N2MxNThmNzJkNGY5NjRhY2M2MDZhZjhkMTFlNGI3ZTJmNzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "859a5005d9d634ec66efe87e69ac07102314ac95", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/859a5005d9d634ec66efe87e69ac07102314ac95", "committedDate": "2020-10-22T12:59:04Z", "message": "Support creating EcsClientConfig from taskConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc75d66eb30ccf6c87313046fd189d4efbc4da3d", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/fc75d66eb30ccf6c87313046fd189d4efbc4da3d", "committedDate": "2020-10-23T00:18:20Z", "message": "Unify to the builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5296a9574b4c7ae0cc42a199c0d0ad21d1d96519", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/5296a9574b4c7ae0cc42a199c0d0ad21d1d96519", "committedDate": "2020-10-23T02:26:09Z", "message": "Support specify CPU and Memory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92e7e377b0d08942dbec60f8c63c080d75f739a5", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/92e7e377b0d08942dbec60f8c63c080d75f739a5", "committedDate": "2020-10-23T02:35:22Z", "message": "Refactor the check logic\nto check whether a property is specified or not"}, "afterCommit": {"oid": "c6c439ec127a2a6272bdecfd1e455e7e84e095f4", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/c6c439ec127a2a6272bdecfd1e455e7e84e095f4", "committedDate": "2020-10-23T02:36:13Z", "message": "Refactor the check logic\nto check whether a property is specified or not"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/3fc880c1ba607c6de674f8a82bac5fa7193abcbd", "committedDate": "2020-10-23T02:57:04Z", "message": "Refactor the check logic\nto check whether a property is specified or not"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6c439ec127a2a6272bdecfd1e455e7e84e095f4", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/c6c439ec127a2a6272bdecfd1e455e7e84e095f4", "committedDate": "2020-10-23T02:36:13Z", "message": "Refactor the check logic\nto check whether a property is specified or not"}, "afterCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/3fc880c1ba607c6de674f8a82bac5fa7193abcbd", "committedDate": "2020-10-23T02:57:04Z", "message": "Refactor the check logic\nto check whether a property is specified or not"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjU2NTY3", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515256567", "createdAt": "2020-10-23T03:44:23Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0NDoyM1rOHm7Jlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0NDoyM1rOHm7Jlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NzA0Nw==", "bodyText": "The reason why this const value  is public is that this is assumed to be used to set the nested config for ecs client config at taskConfig as follows.\ntaskConfig.set(EcsClientConfig.TASK_CONFIG_ECS_KEY, ecsClientConfig)", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510577047", "createdAt": "2020-10-23T03:44:23Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -2,36 +2,71 @@\n \n import com.google.common.base.Optional;\n import io.digdag.client.config.Config;\n-import io.digdag.client.config.ConfigException;\n import io.digdag.core.storage.StorageManager;\n \n-import java.util.Arrays;\n import java.util.List;\n \n public class EcsClientConfig\n {\n     private static final String SYSTEM_CONFIG_PREFIX = \"agent.command_executor.ecs.\";\n+    public static final String TASK_CONFIG_ECS_KEY = \"agent.command_executor.ecs\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjU3MjY2", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515257266", "createdAt": "2020-10-23T03:47:28Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0NzoyOFrOHm7MSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0NzoyOFrOHm7MSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NzczOQ==", "bodyText": "I hired builder pattern so that we can easily add new arguments in the future.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510577739", "createdAt": "2020-10-23T03:47:28Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -47,40 +82,36 @@ private static EcsClientConfig createFromSystemConfig(final Optional<String> clu\n \n         final String extractedPrefix = SYSTEM_CONFIG_PREFIX + name + \".\";\n         final Config extracted = StorageManager.extractKeyPrefix(systemConfig, extractedPrefix);\n-        return new EcsClientConfig(name,\n-                extracted.get(\"launch_type\", String.class),\n-                extracted.get(\"access_key_id\", String.class),\n-                extracted.get(\"secret_access_key\", String.class),\n-                extracted.get(\"region\", String.class),\n-                extracted.get(\"subnets\", String.class),\n-                extracted.get(\"max_retries\", int.class, 3)\n-        );\n+\n+        return buildEcsClientConfig(name, extracted);\n+    }\n+\n+    private static EcsClientConfig buildEcsClientConfig(String clusterName, Config ecsConfig)\n+    {\n+        return EcsClientConfig.builder()\n+                .withClusterName(clusterName)\n+                .withLaunchType(ecsConfig.get(\"launch_type\", String.class))\n+                .withAccessKeyId(ecsConfig.get(\"access_key_id\", String.class))\n+                .withSecretAccessKey(ecsConfig.get(\"secret_access_key\", String.class))\n+                .withRegion(ecsConfig.get(\"region\", String.class))\n+                .withSubnets(ecsConfig.getOptional(\"subnets\", String.class))\n+                .withMaxRetries(ecsConfig.get(\"max_retries\", int.class, DEFAULT_MAX_TRIES))\n+                .withCapacityProviderName(ecsConfig.getOptional(\"capacity_provider_name\", String.class))\n+                .withCpu(ecsConfig.getOptional(\"cpu\", Integer.class))\n+                .withCpu(ecsConfig.getOptional(\"memory\", Integer.class))\n+                .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjU3NDMy", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515257432", "createdAt": "2020-10-23T03:48:16Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODoxN1rOHm7M5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODoxN1rOHm7M5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3Nzg5Mg==", "bodyText": "I deleted current Constructor because this Constructor has a lot of arguments and in the future the number of this parameter is considered to increase.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510577892", "createdAt": "2020-10-23T03:48:17Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -47,40 +82,36 @@ private static EcsClientConfig createFromSystemConfig(final Optional<String> clu\n \n         final String extractedPrefix = SYSTEM_CONFIG_PREFIX + name + \".\";\n         final Config extracted = StorageManager.extractKeyPrefix(systemConfig, extractedPrefix);\n-        return new EcsClientConfig(name,\n-                extracted.get(\"launch_type\", String.class),\n-                extracted.get(\"access_key_id\", String.class),\n-                extracted.get(\"secret_access_key\", String.class),\n-                extracted.get(\"region\", String.class),\n-                extracted.get(\"subnets\", String.class),\n-                extracted.get(\"max_retries\", int.class, 3)\n-        );\n+\n+        return buildEcsClientConfig(name, extracted);\n+    }\n+\n+    private static EcsClientConfig buildEcsClientConfig(String clusterName, Config ecsConfig)\n+    {\n+        return EcsClientConfig.builder()\n+                .withClusterName(clusterName)\n+                .withLaunchType(ecsConfig.get(\"launch_type\", String.class))\n+                .withAccessKeyId(ecsConfig.get(\"access_key_id\", String.class))\n+                .withSecretAccessKey(ecsConfig.get(\"secret_access_key\", String.class))\n+                .withRegion(ecsConfig.get(\"region\", String.class))\n+                .withSubnets(ecsConfig.getOptional(\"subnets\", String.class))\n+                .withMaxRetries(ecsConfig.get(\"max_retries\", int.class, DEFAULT_MAX_TRIES))\n+                .withCapacityProviderName(ecsConfig.getOptional(\"capacity_provider_name\", String.class))\n+                .withCpu(ecsConfig.getOptional(\"cpu\", Integer.class))\n+                .withCpu(ecsConfig.getOptional(\"memory\", Integer.class))\n+                .build();\n     }\n \n     private final String clusterName;\n     private final String launchType;\n     private final String accessKeyId;\n     private final String secretAccessKey;\n     private final String region;\n-    private final List<String> subnets;\n+    private final Optional<List<String>> subnets;\n     private final int maxRetries;\n-\n-    private EcsClientConfig(final String clusterName,\n-            final String launchType,\n-            final String accessKeyId,\n-            final String secretAccessKey,\n-            final String region,\n-            final String subnets,\n-            final int maxRetries)\n-    {\n-        this.clusterName = clusterName;\n-        this.launchType = launchType;\n-        this.accessKeyId = accessKeyId;\n-        this.secretAccessKey = secretAccessKey;\n-        this.region = region;\n-        this.subnets = Arrays.asList(subnets.split(\",\")); // TODO more robust\n-        this.maxRetries = maxRetries;\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 139}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjU3NTA0", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515257504", "createdAt": "2020-10-23T03:48:32Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODozMlrOHm7NJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODozMlrOHm7NJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3Nzk1OQ==", "bodyText": "These parameters are not mandatory. So I defined them as Optional fields.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510577959", "createdAt": "2020-10-23T03:48:32Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -47,40 +82,36 @@ private static EcsClientConfig createFromSystemConfig(final Optional<String> clu\n \n         final String extractedPrefix = SYSTEM_CONFIG_PREFIX + name + \".\";\n         final Config extracted = StorageManager.extractKeyPrefix(systemConfig, extractedPrefix);\n-        return new EcsClientConfig(name,\n-                extracted.get(\"launch_type\", String.class),\n-                extracted.get(\"access_key_id\", String.class),\n-                extracted.get(\"secret_access_key\", String.class),\n-                extracted.get(\"region\", String.class),\n-                extracted.get(\"subnets\", String.class),\n-                extracted.get(\"max_retries\", int.class, 3)\n-        );\n+\n+        return buildEcsClientConfig(name, extracted);\n+    }\n+\n+    private static EcsClientConfig buildEcsClientConfig(String clusterName, Config ecsConfig)\n+    {\n+        return EcsClientConfig.builder()\n+                .withClusterName(clusterName)\n+                .withLaunchType(ecsConfig.get(\"launch_type\", String.class))\n+                .withAccessKeyId(ecsConfig.get(\"access_key_id\", String.class))\n+                .withSecretAccessKey(ecsConfig.get(\"secret_access_key\", String.class))\n+                .withRegion(ecsConfig.get(\"region\", String.class))\n+                .withSubnets(ecsConfig.getOptional(\"subnets\", String.class))\n+                .withMaxRetries(ecsConfig.get(\"max_retries\", int.class, DEFAULT_MAX_TRIES))\n+                .withCapacityProviderName(ecsConfig.getOptional(\"capacity_provider_name\", String.class))\n+                .withCpu(ecsConfig.getOptional(\"cpu\", Integer.class))\n+                .withCpu(ecsConfig.getOptional(\"memory\", Integer.class))\n+                .build();\n     }\n \n     private final String clusterName;\n     private final String launchType;\n     private final String accessKeyId;\n     private final String secretAccessKey;\n     private final String region;\n-    private final List<String> subnets;\n+    private final Optional<List<String>> subnets;\n     private final int maxRetries;\n-\n-    private EcsClientConfig(final String clusterName,\n-            final String launchType,\n-            final String accessKeyId,\n-            final String secretAccessKey,\n-            final String region,\n-            final String subnets,\n-            final int maxRetries)\n-    {\n-        this.clusterName = clusterName;\n-        this.launchType = launchType;\n-        this.accessKeyId = accessKeyId;\n-        this.secretAccessKey = secretAccessKey;\n-        this.region = region;\n-        this.subnets = Arrays.asList(subnets.split(\",\")); // TODO more robust\n-        this.maxRetries = maxRetries;\n-    }\n+    private final Optional<String> capacityProviderName;\n+    private final Optional<Integer> cpu;\n+    private final Optional<Integer> memory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjU3NjA1", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515257605", "createdAt": "2020-10-23T03:48:49Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODo1MFrOHm7NeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMzo0ODo1MFrOHm7NeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3ODA0MA==", "bodyText": "Subnets is not necessary for some use cases. So I defined this files as Optional.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510578040", "createdAt": "2020-10-23T03:48:50Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfigBuilder.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package io.digdag.standards.command.ecs;\n+\n+import com.google.common.base.Optional;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class EcsClientConfigBuilder\n+{\n+    private String clusterName;\n+    private String launchType;\n+    private String accessKeyId;\n+    private String secretAccessKey;\n+    private String region;\n+    private Optional<List<String>> subnets;\n+    private int maxRetries;\n+    private Optional<String> capacityProviderName;\n+    private Optional<Integer> cpu;\n+    private Optional<Integer> memory;\n+\n+    public EcsClientConfig build()\n+    {\n+        return new EcsClientConfig(this);\n+    }\n+\n+    public EcsClientConfigBuilder withClusterName(String clusterName)\n+    {\n+        this.clusterName = clusterName;\n+        return this;\n+    }\n+\n+    public EcsClientConfigBuilder withLaunchType(String launchType)\n+    {\n+        this.launchType = launchType;\n+        return this;\n+    }\n+\n+    public EcsClientConfigBuilder withAccessKeyId(String accessKeyId)\n+    {\n+        this.accessKeyId = accessKeyId;\n+        return this;\n+    }\n+\n+    public EcsClientConfigBuilder withSecretAccessKey(String secretAccessKey)\n+    {\n+        this.secretAccessKey = secretAccessKey;\n+        return this;\n+    }\n+\n+    public EcsClientConfigBuilder withRegion(String region)\n+    {\n+        this.region = region;\n+        return this;\n+    }\n+\n+    public EcsClientConfigBuilder withSubnets(Optional<String> subnets)\n+    {\n+        if (subnets.isPresent()) {\n+            this.subnets = Optional.of(Arrays.asList(subnets.get().split(\",\")));\n+        }\n+        else {\n+            this.subnets = Optional.absent();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Mzg0MTEw", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515384110", "createdAt": "2020-10-23T06:43:27Z", "commit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjo0MzoyN1rOHnArOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjo0MzoyN1rOHnArOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2NzU3Nw==", "bodyText": "EcsClientConfig.of is an entry point of this PR's change.\nCurrently, EcsClientConfig.of always creates EcsClientConfig object from systemConfig.\nIn this PR, if taskConfig has key of agent.command_executor.ecs, EcsClientConfig.of will be created from taskConfig.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510667577", "createdAt": "2020-10-23T06:43:27Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -2,36 +2,71 @@\n \n import com.google.common.base.Optional;\n import io.digdag.client.config.Config;\n-import io.digdag.client.config.ConfigException;\n import io.digdag.core.storage.StorageManager;\n \n-import java.util.Arrays;\n import java.util.List;\n \n public class EcsClientConfig\n {\n     private static final String SYSTEM_CONFIG_PREFIX = \"agent.command_executor.ecs.\";\n+    public static final String TASK_CONFIG_ECS_KEY = \"agent.command_executor.ecs\";\n+    private static final int DEFAULT_MAX_TRIES = 3;\n \n     public static EcsClientConfig of(final Optional<String> clusterName, final Config systemConfig, final Config taskConfig)\n     {\n-        return EcsClientConfig.createFromSystemConfig(clusterName, systemConfig);\n-        /**\n-        if (config.has(\"ecs\")) {\n+        if (taskConfig.has(TASK_CONFIG_ECS_KEY)) {\n             // from task config\n-            return createFromTaskConfig(clusterName, config); // TODO\n+            return createFromTaskConfig(clusterName, taskConfig);\n         }\n         else {\n             // from system config\n-            return EcsClientConfig.createFromSystemConfig(clusterName, systemConfig);\n+            return createFromSystemConfig(clusterName, systemConfig);\n         }\n-         */\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc880c1ba607c6de674f8a82bac5fa7193abcbd"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a5772110125f5dd3fdbcfc22f94cb02d40caf09", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/0a5772110125f5dd3fdbcfc22f94cb02d40caf09", "committedDate": "2020-10-23T08:11:21Z", "message": "Fix typos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4faf4b08f1756c3c523b0765a55ba6e84e209c12", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/4faf4b08f1756c3c523b0765a55ba6e84e209c12", "committedDate": "2020-10-23T08:17:14Z", "message": "Refactor EcsClientConfig.of"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MzY2NTAz", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-515366503", "createdAt": "2020-10-23T06:02:38Z", "commit": {"oid": "859a5005d9d634ec66efe87e69ac07102314ac95"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjowMjozOFrOHm_Ndg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjoxMjozNVrOHm_zhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0MzU3NA==", "bodyText": "I think we don't need to assign public ip. Launch template does not assign it.\nhttps://github.com/treasure-data/tf_svc_custom-scripts/blob/master/profiles/main/accounts/ecs/asg.tf#L112\nI know why Fargate assigned public IP though. For backward compatibility, we can make as it is for Fargate but would like to disable it for EC2.\n@muga Could you explain reason why you enabled public IP?", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510643574", "createdAt": "2020-10-23T06:02:38Z", "author": {"login": "myui"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -746,11 +751,13 @@ protected void setEcsTaskLaunchType(final EcsClientConfig clientConfig, final Ru\n \n     protected void setEcsNetworkConfiguration(final EcsClientConfig clientConfig, final RunTaskRequest request)\n     {\n-        request.withNetworkConfiguration(new NetworkConfiguration().withAwsvpcConfiguration(\n-                new AwsVpcConfiguration()\n-                        .withSubnets(clientConfig.getSubnets())\n-                        .withAssignPublicIp(AssignPublicIp.ENABLED) // TODO should be extracted\n-                ));\n+        if (!clientConfig.getSubnets().isEmpty()) {\n+            request.withNetworkConfiguration(new NetworkConfiguration().withAwsvpcConfiguration(\n+                    new AwsVpcConfiguration()\n+                            .withSubnets(clientConfig.getSubnets())\n+                            .withAssignPublicIp(AssignPublicIp.ENABLED) // TODO should be extracted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859a5005d9d634ec66efe87e69ac07102314ac95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY1MzMxNw==", "bodyText": "Could we set startedBy as well?\nhttps://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/ecs/model/RunTaskRequest.html#setStartedBy-java.lang.String-\nSetting digdag session attempt ID and task id (commandContext.getTaskRequest().getTaskID() and getAttemptId()) would be beneficial upon orphan ECS tasks. I assume search ECS task from https://digdag-admin-production.treasuredata.com/admin/session_attempts/150536306/ in AWS console.", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r510653317", "createdAt": "2020-10-23T06:12:35Z", "author": {"login": "myui"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -516,6 +521,7 @@ RunTaskRequest buildRunTaskRequest(\n         setEcsTaskOverride(commandContext, commandRequest, td, runTaskRequest); // RuntimeException,ConfigException\n         setEcsTaskLaunchType(clientConfig, runTaskRequest);\n         setEcsNetworkConfiguration(clientConfig, runTaskRequest);\n+        setCapacityProviderStrategy(clientConfig, runTaskRequest);\n         return runTaskRequest;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859a5005d9d634ec66efe87e69ac07102314ac95"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c47e4f09a734ba3140f218c3cd6f22b8b0e009a7", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/c47e4f09a734ba3140f218c3cd6f22b8b0e009a7", "committedDate": "2020-10-26T01:09:16Z", "message": "Support `startedBy` option"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDI0NTYz", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-516424563", "createdAt": "2020-10-26T01:32:04Z", "commit": {"oid": "c47e4f09a734ba3140f218c3cd6f22b8b0e009a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDMxMDU2", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-516431056", "createdAt": "2020-10-26T02:06:01Z", "commit": {"oid": "c47e4f09a734ba3140f218c3cd6f22b8b0e009a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMjowNjowMVrOHn-3tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMjowNjowMVrOHn-3tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4NjU4MQ==", "bodyText": "@serihiro let's introduce a option boolean EcsClientConfig.assignPublicIp()", "url": "https://github.com/treasure-data/digdag/pull/1469#discussion_r511686581", "createdAt": "2020-10-26T02:06:01Z", "author": {"login": "myui"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -746,11 +751,13 @@ protected void setEcsTaskLaunchType(final EcsClientConfig clientConfig, final Ru\n \n     protected void setEcsNetworkConfiguration(final EcsClientConfig clientConfig, final RunTaskRequest request)\n     {\n-        request.withNetworkConfiguration(new NetworkConfiguration().withAwsvpcConfiguration(\n-                new AwsVpcConfiguration()\n-                        .withSubnets(clientConfig.getSubnets())\n-                        .withAssignPublicIp(AssignPublicIp.ENABLED) // TODO should be extracted\n-                ));\n+        if (!clientConfig.getSubnets().isEmpty()) {\n+            request.withNetworkConfiguration(new NetworkConfiguration().withAwsvpcConfiguration(\n+                    new AwsVpcConfiguration()\n+                            .withSubnets(clientConfig.getSubnets())\n+                            .withAssignPublicIp(AssignPublicIp.ENABLED) // TODO should be extracted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0MzU3NA=="}, "originalCommit": {"oid": "859a5005d9d634ec66efe87e69ac07102314ac95"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDQyMDAw", "url": "https://github.com/treasure-data/digdag/pull/1469#pullrequestreview-516442000", "createdAt": "2020-10-26T02:55:19Z", "commit": {"oid": "c47e4f09a734ba3140f218c3cd6f22b8b0e009a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "191547c158f72d4f964acc606af8d11e4b7e2f74", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/191547c158f72d4f964acc606af8d11e4b7e2f74", "committedDate": "2020-10-26T03:47:35Z", "message": "Extract `assignPublicIp` as a option"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4063, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}