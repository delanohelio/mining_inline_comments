{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwOTA0MDQ4", "number": 1503, "title": "Set target_session_id and target_attempt_id when require op is called", "bodyText": "I want to know which attempt and which session is required by a require operator to understand my attempt dependency. Currently, digdag doesn't have such information. What I can is guessing it by using time.\nWith this patch, two values, target_session_id and target_attempt_id, are stored to state param of require operator. Then I can use them to find the session and the attempt that were required.", "createdAt": "2020-12-16T05:38:26Z", "url": "https://github.com/treasure-data/digdag/pull/1503", "merged": true, "mergeCommit": {"oid": "0c784429c3c82366d3687c0b8426228625821d16"}, "closed": true, "closedAt": "2021-02-16T04:10:17Z", "author": {"login": "hkdnet"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdohaf6gH2gAyNTQwOTA0MDQ4OmZjY2NlZGM3ZDU0ODcwZDg1NzkxNmU3NzVlM2UyNDUyZWE5OWQ3Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvR93RAFqTU2NTg5ODU0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcccedc7d54870d857916e775e3e2452ea99d737", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/fcccedc7d54870d857916e775e3e2452ea99d737", "committedDate": "2020-12-22T02:50:01Z", "message": "Set target_session_id and target_attempt_id when require op kicks a new attempt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fee062b2ed0a7415f3d7399d873e1a1f32f4406c", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/fee062b2ed0a7415f3d7399d873e1a1f32f4406c", "committedDate": "2020-12-16T05:25:09Z", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt"}, "afterCommit": {"oid": "e16e7bd336599308c27dd5606eb89bd90eea1349", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/e16e7bd336599308c27dd5606eb89bd90eea1349", "committedDate": "2020-12-22T02:50:01Z", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a9836631335ccf2387577fbe9eaae7b68740148", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/6a9836631335ccf2387577fbe9eaae7b68740148", "committedDate": "2020-12-22T02:51:13Z", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e16e7bd336599308c27dd5606eb89bd90eea1349", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/e16e7bd336599308c27dd5606eb89bd90eea1349", "committedDate": "2020-12-22T02:50:01Z", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt"}, "afterCommit": {"oid": "6a9836631335ccf2387577fbe9eaae7b68740148", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/6a9836631335ccf2387577fbe9eaae7b68740148", "committedDate": "2020-12-22T02:51:13Z", "message": "Set target_session_id and target_attempt_id when require op waits for an attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "committedDate": "2020-12-23T05:02:03Z", "message": "Add tests for StateParams of require task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bbb877df72f07fc24b1ecb08aa50c2cd3af9347", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/0bbb877df72f07fc24b1ecb08aa50c2cd3af9347", "committedDate": "2020-12-23T04:52:30Z", "message": "Add tests for StateParams of require task"}, "afterCommit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/e2e73566806a8390c4ff021dd5d38e025bf8eaa0", "committedDate": "2020-12-23T05:02:03Z", "message": "Add tests for StateParams of require task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Njc1MjEy", "url": "https://github.com/treasure-data/digdag/pull/1503#pullrequestreview-557675212", "createdAt": "2020-12-23T06:55:07Z", "commit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NTowOFrOIKWipA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NTowOFrOIKWipA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNTk4OA==", "bodyText": "May be attemptId.toString() or attemptId.get() is enough ?", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547725988", "createdAt": "2020-12-23T06:55:08Z", "author": {"login": "yoyama"}, "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -115,6 +118,27 @@ public void testRequire()\n \n         // Verify that the file created by the child workflow is there\n         assertThat(Files.exists(childOutFile), is(true));\n+\n+        CommandStatus attemptTasks = main(\"tasks\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(attemptId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Njc1MzE1", "url": "https://github.com/treasure-data/digdag/pull/1503#pullrequestreview-557675315", "createdAt": "2020-12-23T06:55:23Z", "commit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NToyM1rOIKWjtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NToyM1rOIKWjtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNjI2MQ==", "bodyText": "ditto", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547726261", "createdAt": "2020-12-23T06:55:23Z", "author": {"login": "yoyama"}, "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -115,6 +118,27 @@ public void testRequire()\n \n         // Verify that the file created by the child workflow is there\n         assertThat(Files.exists(childOutFile), is(true));\n+\n+        CommandStatus attemptTasks = main(\"tasks\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(attemptId));\n+\n+        List<Config> stateParams = getStateParams(attemptTasks);\n+\n+        // It has 2 tasks, +parent and +parent+require.\n+        assertThat(stateParams.size(), is(2));\n+        Config requireOperatorStateParams = stateParams.get(1);\n+\n+        Id targetAttemptId = requireOperatorStateParams.get(\"target_attempt_id\", Id.class);\n+        CommandStatus targetAttemptStatus = main(\"attempts\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                String.valueOf(targetAttemptId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Njc5OTYx", "url": "https://github.com/treasure-data/digdag/pull/1503#pullrequestreview-557679961", "createdAt": "2020-12-23T07:08:07Z", "commit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNzowODowOFrOIKXLww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNzowODowOFrOIKXLww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzczNjUxNQ==", "bodyText": "Increase the maximum wait to 60 may be better. We sometimes faces timeout because of CI performance.", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547736515", "createdAt": "2020-12-23T07:08:08Z", "author": {"login": "yoyama"}, "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -425,4 +449,85 @@ private void prepareForChildWF(Path childOutFile)\n             Files.write(projectDir.resolve(\"child.dig\"), child.getBytes(\"UTF-8\"));\n         }\n     }\n+\n+    @Test\n+    public void testRequireHasTargetSessionIdEvenWhenJustWaiting()\n+            throws Exception\n+    {\n+        // Create new project\n+        CommandStatus initStatus = main(\"init\",\n+                \"-c\", config.toString(),\n+                projectDir.toString());\n+        assertThat(initStatus.errUtf8(), initStatus.code(), is(0));\n+\n+        Path childOutFile = projectDir.resolve(\"child.out\").toAbsolutePath().normalize();\n+        prepareForChildWF(childOutFile);\n+        copyResource(\"acceptance/require/parent.dig\", projectDir.resolve(\"parent.dig\"));\n+\n+        // Push the project\n+        CommandStatus pushStatus = main(\"push\",\n+                \"--project\", projectDir.toString(),\n+                \"require\",\n+                \"-c\", config.toString(),\n+                \"-e\", server.endpoint(),\n+                \"-r\", \"4711\");\n+        assertThat(pushStatus.errUtf8(), pushStatus.code(), is(0));\n+\n+        // Start the child workflow first.\n+        String session = \"2016-01-01\";\n+\n+        Id targetAttemptId;\n+        Id targetSessionId;\n+        {\n+            CommandStatus startStatus = main(\"start\",\n+                    \"-c\", config.toString(),\n+                    \"-e\", server.endpoint(),\n+                    \"require\", \"child\",\n+                    \"--session\", session);\n+            assertThat(startStatus.code(), is(0));\n+            targetAttemptId = getAttemptId(startStatus);\n+            targetSessionId = getSessionId(startStatus);\n+        }\n+\n+        // Start the workflow\n+        Id attemptId;\n+        {\n+            CommandStatus startStatus = main(\"start\",\n+                    \"-c\", config.toString(),\n+                    \"-e\", server.endpoint(),\n+                    \"require\", \"parent\",\n+                    \"--session\", session);\n+            assertThat(startStatus.code(), is(0));\n+            attemptId = getAttemptId(startStatus);\n+        }\n+\n+        // Wait for the attempt to complete\n+        boolean success = false;\n+        for (int i = 0; i < 30; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2e73566806a8390c4ff021dd5d38e025bf8eaa0"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f00f7002c6049bb42f6cac2a64dfec59a0f4665d", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/f00f7002c6049bb42f6cac2a64dfec59a0f4665d", "committedDate": "2020-12-23T07:48:06Z", "message": "Update timeout value to make CI stable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19de2e155de25ddd34f1e45e75c40457567bac36", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/19de2e155de25ddd34f1e45e75c40457567bac36", "committedDate": "2020-12-23T07:51:21Z", "message": "Simplify Id to String conversion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NzE0MTA1", "url": "https://github.com/treasure-data/digdag/pull/1503#pullrequestreview-557714105", "createdAt": "2020-12-23T08:27:24Z", "commit": {"oid": "19de2e155de25ddd34f1e45e75c40457567bac36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwODoyNzoyNFrOIKbFOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwODoyNzoyNFrOIKbFOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgwMDM3OQ==", "bodyText": "I guess the purpose of this test is that we can get correct session_id and attempt_id when the session of the child already exists and require> will not kick by itself. So change the test name may be better.\nIn addition, this implementation does not assure parent will wait for child or not. Because the child workflow is very short and it is not certain whether the status of child is running or stopped when the parent session starts.\nSo 'waiting' is not correct in my understand.", "url": "https://github.com/treasure-data/digdag/pull/1503#discussion_r547800379", "createdAt": "2020-12-23T08:27:24Z", "author": {"login": "yoyama"}, "path": "digdag-tests/src/test/java/acceptance/RequireIT.java", "diffHunk": "@@ -425,4 +449,85 @@ private void prepareForChildWF(Path childOutFile)\n             Files.write(projectDir.resolve(\"child.dig\"), child.getBytes(\"UTF-8\"));\n         }\n     }\n+\n+    @Test\n+    public void testRequireHasTargetSessionIdEvenWhenJustWaiting()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19de2e155de25ddd34f1e45e75c40457567bac36"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a136ba7c377fb64bbfd57333cda7216aa287894", "author": {"user": {"login": "hkdnet", "name": "hkdnet"}}, "url": "https://github.com/treasure-data/digdag/commit/1a136ba7c377fb64bbfd57333cda7216aa287894", "committedDate": "2020-12-25T01:59:12Z", "message": "Rename a test case\n\nbecause if the child finishes earlier than the require operation,\nthe parent doesn't wait for the child's completion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1ODk4NTQ3", "url": "https://github.com/treasure-data/digdag/pull/1503#pullrequestreview-565898547", "createdAt": "2021-01-12T02:47:38Z", "commit": {"oid": "1a136ba7c377fb64bbfd57333cda7216aa287894"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4093, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}