{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyOTM5NjI2", "number": 1381, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODo1NDoyNVrODtqcOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTozMzo1MFrODvRmUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjA3ODY3OnYy", "diffSide": "RIGHT", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODo1NDoyNVrOF_OOHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzowOToxNVrOF_1Aww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNzU5OQ==", "bodyText": "You don't need these if statements. You can use following instead:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (param.equals(\"skip_on_overtime\"))\n          \n          \n            \n                        usedKeys.add(param);", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401837599", "createdAt": "2020-04-01T18:54:25Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3MzE1NQ==", "bodyText": "Thanks, I fixed to use that.\ne974010", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402473155", "createdAt": "2020-04-02T17:09:15Z", "author": {"login": "naritta"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNzU5OQ=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjA5OTcyOnYy", "diffSide": "RIGHT", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOTowMDoxMlrOF_ObiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzowODo0N1rOF_0_rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg==", "bodyText": "Throwing exception here is dangerous because:\n\nSchedules already saved in DB might already have unused keys. Those schedules are currently running in production.\nIf here throws an exception, such schedules will stop working (ScheduleExecutor.runSchedule is calling SchedulerManager.getScheduler).\nFrom user's point of view, they can't notice that their schedules have stopped (because there are no notifications). It's unexpected from the users.\nFrom our point of view, ScheduleExecutor.runSchedule starts logging exceptions. It's not UncaughtException, but almost.\n\nSo, unused keys checking must be done only when a new workflow is uploaded. And that's good enough.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401841032", "createdAt": "2020-04-01T19:00:12Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))\n+                c.get(\"skip_on_overtime\", boolean.class, false);\n+            else if (param.equals(\"skip_delayed_by\"))\n+                c.getOptional(\"skip_delayed_by\", DurationParam.class);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                warnUnusedKeys(shouldBeUsedKeys, usedKeys);\n+            }\n+        }\n+\n         return factory.newScheduler(c, workflowTimeZone);\n     }\n+\n+    private void warnUnusedKeys(Set<String> shouldBeUsedButNotUsedKeys, Collection<String> candidateKeys)\n+    {\n+        // throw for only first unused key\n+        for (String key : shouldBeUsedButNotUsedKeys) {\n+            StringBuilder buf = new StringBuilder();\n+            buf.append(\"Parameter '\");\n+            buf.append(key);\n+            buf.append(\"' is not used at schedule. \");\n+\n+            List<String> suggestions = EditDistance.suggest(key, candidateKeys, 0.50);\n+            if (suggestions.isEmpty()) {\n+                throw new ConfigException(buf.toString());\n+            }\n+            else {\n+                buf.append(\"> Did you mean '\");\n+                buf.append(suggestions);\n+                buf.append(\"'\");\n+                throw new ConfigException(buf.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzM3Nw==", "bodyText": "To make it possible, unused keys checking in this getScheduler method needs to be optional.\nA possible way is adding boolean checkUnusedKeys argument to this getScheduler method. Alternative way is adding Optional<Consumer<Map<String, List<String>>>> unusedKeysCallback argument to this getScheduler method (do the unused keys checking if unusedKeysCallback.isPresent()).\nEither way works. boolean checkUnusedKeys is simple but can't tell whether a ConfigException is thrown due to unused keys or due to other reasons. Optional<Consumer<...>> can distinguish them but more complicated.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401843377", "createdAt": "2020-04-01T19:04:20Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))\n+                c.get(\"skip_on_overtime\", boolean.class, false);\n+            else if (param.equals(\"skip_delayed_by\"))\n+                c.getOptional(\"skip_delayed_by\", DurationParam.class);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                warnUnusedKeys(shouldBeUsedKeys, usedKeys);\n+            }\n+        }\n+\n         return factory.newScheduler(c, workflowTimeZone);\n     }\n+\n+    private void warnUnusedKeys(Set<String> shouldBeUsedButNotUsedKeys, Collection<String> candidateKeys)\n+    {\n+        // throw for only first unused key\n+        for (String key : shouldBeUsedButNotUsedKeys) {\n+            StringBuilder buf = new StringBuilder();\n+            buf.append(\"Parameter '\");\n+            buf.append(key);\n+            buf.append(\"' is not used at schedule. \");\n+\n+            List<String> suggestions = EditDistance.suggest(key, candidateKeys, 0.50);\n+            if (suggestions.isEmpty()) {\n+                throw new ConfigException(buf.toString());\n+            }\n+            else {\n+                buf.append(\"> Did you mean '\");\n+                buf.append(suggestions);\n+                buf.append(\"'\");\n+                throw new ConfigException(buf.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0NDkyMw==", "bodyText": "Another way I came up right now is adding a class like UnusedConfigExceptions extends ConfigException.\n...either way works.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401844923", "createdAt": "2020-04-01T19:07:00Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))\n+                c.get(\"skip_on_overtime\", boolean.class, false);\n+            else if (param.equals(\"skip_delayed_by\"))\n+                c.getOptional(\"skip_delayed_by\", DurationParam.class);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                warnUnusedKeys(shouldBeUsedKeys, usedKeys);\n+            }\n+        }\n+\n         return factory.newScheduler(c, workflowTimeZone);\n     }\n+\n+    private void warnUnusedKeys(Set<String> shouldBeUsedButNotUsedKeys, Collection<String> candidateKeys)\n+    {\n+        // throw for only first unused key\n+        for (String key : shouldBeUsedButNotUsedKeys) {\n+            StringBuilder buf = new StringBuilder();\n+            buf.append(\"Parameter '\");\n+            buf.append(key);\n+            buf.append(\"' is not used at schedule. \");\n+\n+            List<String> suggestions = EditDistance.suggest(key, candidateKeys, 0.50);\n+            if (suggestions.isEmpty()) {\n+                throw new ConfigException(buf.toString());\n+            }\n+            else {\n+                buf.append(\"> Did you mean '\");\n+                buf.append(suggestions);\n+                buf.append(\"'\");\n+                throw new ConfigException(buf.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3Mjg3Ng==", "bodyText": "I fixed to use unusedKeysCallback and UnusedConfigExceptions, but it seems like same as boolean checkUnusedKeys, so sorry if I'm misunderstanding your intension.\ndb6f943", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402472876", "createdAt": "2020-04-02T17:08:47Z", "author": {"login": "naritta"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))\n+                c.get(\"skip_on_overtime\", boolean.class, false);\n+            else if (param.equals(\"skip_delayed_by\"))\n+                c.getOptional(\"skip_delayed_by\", DurationParam.class);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                warnUnusedKeys(shouldBeUsedKeys, usedKeys);\n+            }\n+        }\n+\n         return factory.newScheduler(c, workflowTimeZone);\n     }\n+\n+    private void warnUnusedKeys(Set<String> shouldBeUsedButNotUsedKeys, Collection<String> candidateKeys)\n+    {\n+        // throw for only first unused key\n+        for (String key : shouldBeUsedButNotUsedKeys) {\n+            StringBuilder buf = new StringBuilder();\n+            buf.append(\"Parameter '\");\n+            buf.append(key);\n+            buf.append(\"' is not used at schedule. \");\n+\n+            List<String> suggestions = EditDistance.suggest(key, candidateKeys, 0.50);\n+            if (suggestions.isEmpty()) {\n+                throw new ConfigException(buf.toString());\n+            }\n+            else {\n+                buf.append(\"> Did you mean '\");\n+                buf.append(suggestions);\n+                buf.append(\"'\");\n+                throw new ConfigException(buf.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjE0NDc4OnYy", "diffSide": "RIGHT", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxMzoyM1rOF_O4OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo1NDo1NVrOGBeiiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw==", "bodyText": "can you add some more tests?:\n\nA test that verifies REST API response code. I think API response code should be 400 (same with ModelValidationException and IllegalArgumentException) or 422. It's very bad if it's 5xx. If API response code is unexpected, additional code will be necessary around ProjectResource.validateWorkflowAndSchedule.\nwhat if unknown scheduler type is set (like no_such_scheduler>: abc)", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401848377", "createdAt": "2020-04-01T19:13:23Z", "author": {"login": "frsyuki"}, "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +44,30 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'wrong>' is not used at schedule.\"));\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTE0Nw==", "bodyText": "you can copy testing mechanism from ServerErrorStatusCodeIT to this SchedulerIT.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401851147", "createdAt": "2020-04-01T19:18:21Z", "author": {"login": "frsyuki"}, "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +44,30 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'wrong>' is not used at schedule.\"));\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwMjEyMA==", "bodyText": "I added tests for them here.\ncca6e1f", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404202120", "createdAt": "2020-04-06T15:54:55Z", "author": {"login": "naritta"}, "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +44,30 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'wrong>' is not used at schedule.\"));\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw=="}, "originalCommit": {"oid": "01fad80a078f12b011729622391cfbf14ec0b682"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5ODM5MTk5OnYy", "diffSide": "RIGHT", "path": "digdag-core/src/main/java/io/digdag/core/repository/ProjectControl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoyMzoyMVrOGAKizQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNTo1NTo0OFrOGBek8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNTkzMw==", "bodyText": "if we throw UnusedConfigException, this doesn't have to be a callback. A boolean flag is good enough.\nCallback is useful if ProjectResource.putProject creates a callback object because ProjectResource.putProject can decide the type of the exception class to throw.\nI think boolean flag is good enough.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402825933", "createdAt": "2020-04-03T08:23:21Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/repository/ProjectControl.java", "diffHunk": "@@ -101,7 +103,7 @@ private void updateSchedules(\n     {\n         ImmutableList.Builder<ScheduleWithScheduler> schedules = ImmutableList.builder();\n         for (StoredWorkflowDefinition def : defs) {\n-            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def);\n+            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def, Optional.of(getUnusedKeysCallback()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6f9434eea7980ff8fafdc3da1f04ac5359ab3b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwMjczOQ==", "bodyText": "I see, thanks, then I fixed to use boolean for that.\n74d9f4e", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404202739", "createdAt": "2020-04-06T15:55:48Z", "author": {"login": "naritta"}, "path": "digdag-core/src/main/java/io/digdag/core/repository/ProjectControl.java", "diffHunk": "@@ -101,7 +103,7 @@ private void updateSchedules(\n     {\n         ImmutableList.Builder<ScheduleWithScheduler> schedules = ImmutableList.builder();\n         for (StoredWorkflowDefinition def : defs) {\n-            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def);\n+            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def, Optional.of(getUnusedKeysCallback()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNTkzMw=="}, "originalCommit": {"oid": "db6f9434eea7980ff8fafdc3da1f04ac5359ab3b"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODk2NjEyOnYy", "diffSide": "RIGHT", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToyOTo1MlrOGBms5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToyOTo1MlrOGBms5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNTg0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Throwable ie) {\n          \n          \n            \n                    }\n          \n          \n            \n                    catch (Throwable ie) {", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404335846", "createdAt": "2020-04-06T19:29:52Z", "author": {"login": "frsyuki"}, "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +54,71 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca6e1f7ee3f7507b0948448ae5212676acf0e19"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODk2NjU3OnYy", "diffSide": "RIGHT", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTozMDowMFrOGBmtMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTozMDowMFrOGBmtMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNTkyMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Throwable ie) {\n          \n          \n            \n                    }\n          \n          \n            \n                    catch (Throwable ie) {", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404335921", "createdAt": "2020-04-06T19:30:00Z", "author": {"login": "frsyuki"}, "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +54,71 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca6e1f7ee3f7507b0948448ae5212676acf0e19"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODk4MDAwOnYy", "diffSide": "RIGHT", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTozMzo1MFrOGBm1pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTozMzo1MFrOGBm1pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzODA4NQ==", "bodyText": "Showing logging in this loop is good (it's consistent with OperatorManager) but throwing exception has a downside. Because throwing an exception will leave from this loop, users can know only one unused key at a time.\nHow about moving throw before the loop if throwUnusedKeys is set? We can concatenate messages of getWarnUnusedKey with \\n as the message of UnusedConfigException.", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404338085", "createdAt": "2020-04-06T19:33:50Z", "author": {"login": "frsyuki"}, "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +114,44 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            usedKeys.add(param);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                for (String key: shouldBeUsedKeys) {\n+                    if (throwUnusedKeys)\n+                        throw new UnusedConfigException(getWarnUnusedKey(key, usedKeys));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca6e1f7ee3f7507b0948448ae5212676acf0e19"}, "originalPosition": 105}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1193, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}