{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDc2MDM1", "number": 1477, "title": "Enhance py> operator error handling", "bodyText": "Some of errors does not handling in runner.py of py>. And it cause no generation of output.json and users cannot get information of errors.\nTo mitigate it, change error handling in runner.py as follows:\n\ncatch exception in whole main code\nhandle SystemExit exception because it only show exit code and not kind to users.", "createdAt": "2020-11-06T03:50:33Z", "url": "https://github.com/treasure-data/digdag/pull/1477", "merged": true, "mergeCommit": {"oid": "623f697347f0c8e09675e8d4ae4603e2c44e891b"}, "closed": true, "closedAt": "2020-11-12T02:40:38Z", "author": {"login": "yoyama"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbA0qrgFqTUyNjgxMzEwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbZzTLgBqjM5ODI3Mzg5MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODEzMTAy", "url": "https://github.com/treasure-data/digdag/pull/1477#pullrequestreview-526813102", "createdAt": "2020-11-10T02:48:51Z", "commit": {"oid": "337fa22d493d775627f864c4f55a2d17e1ca7bd1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMjo0ODo1MVrOHwJqOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzozMDowMFrOHwKYDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1MTk2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                # SystemExit only show exit code and it is not kind to user. So create specific error message.\n          \n          \n            \n                # SystemExit only shows an exit code and it is not kind to users. So this block creates a specific error message.", "url": "https://github.com/treasure-data/digdag/pull/1477#discussion_r520251963", "createdAt": "2020-11-10T02:48:51Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/resources/digdag/standards/py/runner.py", "diffHunk": "@@ -140,32 +140,37 @@ def digdag_inspect_arguments(callable_type, exclude_self, params):\n     else:\n         return args\n \n-callable_type, method_name = digdag_inspect_command(command)\n error = None\n+error_message = None\n error_value = None\n error_traceback = None\n+callable_type = None\n+method_name = None\n \n-if method_name:\n-    init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n-    instance = callable_type(**init_args)\n+try:\n+    callable_type, method_name = digdag_inspect_command(command)\n+    if method_name:\n+        init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n+        instance = callable_type(**init_args)\n \n-    method = getattr(instance, method_name)\n-    method_args = digdag_inspect_arguments(method, True, params)\n-    try:\n+        method = getattr(instance, method_name)\n+        method_args = digdag_inspect_arguments(method, True, params)\n         result = method(**method_args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n-\n-else:\n-    args = digdag_inspect_arguments(callable_type, False, params)\n-    try:\n+    else:\n+        args = digdag_inspect_arguments(callable_type, False, params)\n         result = callable_type(**args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n+except SystemExit as e:\n+    # SystemExit only show exit code and it is not kind to user. So create specific error message.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "337fa22d493d775627f864c4f55a2d17e1ca7bd1"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2MzY5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                # This error will happen if called python module name and method name are equal to standard module. (e.g tokenize.main)\n          \n          \n            \n                # This error will happen if called python module name and method name are equal to those of the standard library module. (e.g. tokenize.main)", "url": "https://github.com/treasure-data/digdag/pull/1477#discussion_r520263693", "createdAt": "2020-11-10T03:30:00Z", "author": {"login": "serihiro"}, "path": "digdag-standards/src/main/resources/digdag/standards/py/runner.py", "diffHunk": "@@ -140,32 +140,37 @@ def digdag_inspect_arguments(callable_type, exclude_self, params):\n     else:\n         return args\n \n-callable_type, method_name = digdag_inspect_command(command)\n error = None\n+error_message = None\n error_value = None\n error_traceback = None\n+callable_type = None\n+method_name = None\n \n-if method_name:\n-    init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n-    instance = callable_type(**init_args)\n+try:\n+    callable_type, method_name = digdag_inspect_command(command)\n+    if method_name:\n+        init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n+        instance = callable_type(**init_args)\n \n-    method = getattr(instance, method_name)\n-    method_args = digdag_inspect_arguments(method, True, params)\n-    try:\n+        method = getattr(instance, method_name)\n+        method_args = digdag_inspect_arguments(method, True, params)\n         result = method(**method_args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n-\n-else:\n-    args = digdag_inspect_arguments(callable_type, False, params)\n-    try:\n+    else:\n+        args = digdag_inspect_arguments(callable_type, False, params)\n         result = callable_type(**args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n+except SystemExit as e:\n+    # SystemExit only show exit code and it is not kind to user. So create specific error message.\n+    # This error will happen if called python module name and method name are equal to standard module. (e.g tokenize.main)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "337fa22d493d775627f864c4f55a2d17e1ca7bd1"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODg2MjQ2", "url": "https://github.com/treasure-data/digdag/pull/1477#pullrequestreview-526886246", "createdAt": "2020-11-10T06:13:53Z", "commit": {"oid": "9e81727feb3fb79a2ffa56b944c140076c8ecb98"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNjoxMzo1NFrOHwNXRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNjoxNDoxOFrOHwNYZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMxMjY0NA==", "bodyText": "As of Python 3.6, f-string enables writing string format shorter. (also, Python 3.5 has been deprecated)\nhttps://docs.python.org/3/tutorial/inputoutput.html#formatted-string-literals\nIf we need to support Python 2.7 (while it is EOL), it'd be common to use format rather than %.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                error = Exception(\"Failed to call python command with code:%d\" % e.code, \"Possible cause: Ivalid python module call, duplicae module name with standard library\")\n          \n          \n            \n                error = Exception(\"Failed to call python command with code:{}\".format(e.code), \"Possible cause: Invalid python module call, duplicate module name with standard library\")\n          \n      \n    \n    \n  \n\nOr, if we can drop Python 3.5 support, we can leverage f-string like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                error = Exception(\"Failed to call python command with code:%d\" % e.code, \"Possible cause: Ivalid python module call, duplicae module name with standard library\")\n          \n          \n            \n                error = Exception(f\"Failed to call python command with code:{e.code}\", \"Possible cause: Invalid python module call, duplicate module name with standard library\")", "url": "https://github.com/treasure-data/digdag/pull/1477#discussion_r520312644", "createdAt": "2020-11-10T06:13:54Z", "author": {"login": "chezou"}, "path": "digdag-standards/src/main/resources/digdag/standards/py/runner.py", "diffHunk": "@@ -140,32 +140,37 @@ def digdag_inspect_arguments(callable_type, exclude_self, params):\n     else:\n         return args\n \n-callable_type, method_name = digdag_inspect_command(command)\n error = None\n+error_message = None\n error_value = None\n error_traceback = None\n+callable_type = None\n+method_name = None\n \n-if method_name:\n-    init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n-    instance = callable_type(**init_args)\n+try:\n+    callable_type, method_name = digdag_inspect_command(command)\n+    if method_name:\n+        init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n+        instance = callable_type(**init_args)\n \n-    method = getattr(instance, method_name)\n-    method_args = digdag_inspect_arguments(method, True, params)\n-    try:\n+        method = getattr(instance, method_name)\n+        method_args = digdag_inspect_arguments(method, True, params)\n         result = method(**method_args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n-\n-else:\n-    args = digdag_inspect_arguments(callable_type, False, params)\n-    try:\n+    else:\n+        args = digdag_inspect_arguments(callable_type, False, params)\n         result = callable_type(**args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n+except SystemExit as e:\n+    # SystemExit only shows an exit code and it is not kind to users. So this block creates a specific error message.\n+    # This error will happen if called python module name and method name are equal to those of the standard library module. (e.g. tokenize.main)\n+    error = Exception(\"Failed to call python command with code:%d\" % e.code, \"Possible cause: Ivalid python module call, duplicae module name with standard library\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e81727feb3fb79a2ffa56b944c140076c8ecb98"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMxMjkzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                error_message = \"%s %s\" % (error.args[0], error.args[1])\n          \n          \n            \n                error_message = \"{} {}\".format(error.args[0], error.args[1])\n          \n      \n    \n    \n  \n\nOr,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                error_message = \"%s %s\" % (error.args[0], error.args[1])\n          \n          \n            \n                error_message = f\"{error.args[0]} {error.args[1]}\"", "url": "https://github.com/treasure-data/digdag/pull/1477#discussion_r520312932", "createdAt": "2020-11-10T06:14:18Z", "author": {"login": "chezou"}, "path": "digdag-standards/src/main/resources/digdag/standards/py/runner.py", "diffHunk": "@@ -140,32 +140,37 @@ def digdag_inspect_arguments(callable_type, exclude_self, params):\n     else:\n         return args\n \n-callable_type, method_name = digdag_inspect_command(command)\n error = None\n+error_message = None\n error_value = None\n error_traceback = None\n+callable_type = None\n+method_name = None\n \n-if method_name:\n-    init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n-    instance = callable_type(**init_args)\n+try:\n+    callable_type, method_name = digdag_inspect_command(command)\n+    if method_name:\n+        init_args = digdag_inspect_arguments(callable_type.__init__, True, params)\n+        instance = callable_type(**init_args)\n \n-    method = getattr(instance, method_name)\n-    method_args = digdag_inspect_arguments(method, True, params)\n-    try:\n+        method = getattr(instance, method_name)\n+        method_args = digdag_inspect_arguments(method, True, params)\n         result = method(**method_args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n-\n-else:\n-    args = digdag_inspect_arguments(callable_type, False, params)\n-    try:\n+    else:\n+        args = digdag_inspect_arguments(callable_type, False, params)\n         result = callable_type(**args)\n-    except Exception as e:\n-        error = e\n-        error_type, error_value, _tb = sys.exc_info()\n-        error_traceback = traceback.format_exception(error_type, error_value, _tb)\n+except SystemExit as e:\n+    # SystemExit only shows an exit code and it is not kind to users. So this block creates a specific error message.\n+    # This error will happen if called python module name and method name are equal to those of the standard library module. (e.g. tokenize.main)\n+    error = Exception(\"Failed to call python command with code:%d\" % e.code, \"Possible cause: Ivalid python module call, duplicae module name with standard library\")\n+    error_type, error_value, _tb = sys.exc_info()\n+    error_message = \"%s %s\" % (error.args[0], error.args[1])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e81727feb3fb79a2ffa56b944c140076c8ecb98"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e8ef9d1a2af52c8ca761c1befeecd5384bf0856", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/5e8ef9d1a2af52c8ca761c1befeecd5384bf0856", "committedDate": "2020-11-11T08:00:17Z", "message": "Enhance error handling of py operator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cbf7f3841491ec0c369ce701ffb27dbf70292df", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/9cbf7f3841491ec0c369ce701ffb27dbf70292df", "committedDate": "2020-11-11T08:00:17Z", "message": "Add a test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8d7b2ae500a298913edea0f2a600cbdc4a4c8ff", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/c8d7b2ae500a298913edea0f2a600cbdc4a4c8ff", "committedDate": "2020-11-11T08:00:17Z", "message": "Add missing files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dc36a517b7ef65465f4e7c087a1ccb381ee7a72", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/6dc36a517b7ef65465f4e7c087a1ccb381ee7a72", "committedDate": "2020-11-11T08:00:54Z", "message": "Add a test and refactoring in PyIT."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ae2e7175704f741a297d0c12a4efe6800e696a", "author": {"user": {"login": "yoyama", "name": "yoyama"}}, "url": "https://github.com/treasure-data/digdag/commit/a0ae2e7175704f741a297d0c12a4efe6800e696a", "committedDate": "2020-11-11T08:01:15Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Kazuhiro Serizawa <nserihiro@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf488964c5cd191d52bad5cc4db9e16c5a0f64b8", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/cf488964c5cd191d52bad5cc4db9e16c5a0f64b8", "committedDate": "2020-11-11T08:34:23Z", "message": "Fix tests caused by rebase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44dd8415a3716108091724a2baa901eb9deab3cc", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/44dd8415a3716108091724a2baa901eb9deab3cc", "committedDate": "2020-11-11T07:40:34Z", "message": "Mitigate CI error."}, "afterCommit": {"oid": "cf488964c5cd191d52bad5cc4db9e16c5a0f64b8", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/cf488964c5cd191d52bad5cc4db9e16c5a0f64b8", "committedDate": "2020-11-11T08:34:23Z", "message": "Fix tests caused by rebase."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4077, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}