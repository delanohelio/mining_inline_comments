{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NDg0Mjkx", "number": 1436, "title": "WM-867: Introduce retrying logic on curl commands on temporary network outage and/or S3 errors", "bodyText": "We found the following error can be caused due to transient failures (such as temporary network outage and/or S3 errors) on curl command used in the ECS task command (See CS-5095 for detail).\njava.lang.RuntimeException: io.digdag.spi.StorageFileNotFoundException: S3 file not found\nat com.google.common.base.Throwables.propagate(Throwables.java:240)\nat io.digdag.standards.command.ecs.TemporalProjectArchiveStorage.getContentInputStream(TemporalProjectArchiveStorage.java:55)\nat io.digdag.standards.command.EcsCommandExecutor.createNextCommandStatus(EcsCommandExecutor.java:302)\nat io.digdag.standards.command.EcsCommandExecutor.poll(EcsCommandExecutor.java:272)\nat com.treasuredata.digdag.command.TdEcsCommandExecutor.pollSuper(TdEcsCommandExecutor.java:130)\nat com.treasuredata.digdag.command.TdEcsCommandExecutor.poll(TdEcsCommandExecutor.java:108)\nat io.digdag.standards.operator.PyOperatorFactory$PyOperator.runCode(PyOperatorFactory.java:143)\nat io.digdag.standards.operator.PyOperatorFactory$PyOperator.runTask(PyOperatorFactory.java:114)\nat io.digdag.util.BaseOperator.run(BaseOperator.java:35)\nat io.digdag.core.agent.OperatorManager.callExecutor(OperatorManager.java:330)\nat com.treasuredata.digdag.TdOperatorManager.callExecutor(TdOperatorManager.java:56)\nat io.digdag.core.agent.OperatorManager.runWithWorkspace(OperatorManager.java:271)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invokeMain(DigdagTimedMethodInterceptor.java:58)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invoke(DigdagTimedMethodInterceptor.java:31)\nat io.digdag.core.agent.OperatorManager.lambda$runWithHeartbeat$2(OperatorManager.java:144)\nat io.digdag.core.agent.ExtractArchiveWorkspaceManager.withExtractedArchive(ExtractArchiveWorkspaceManager.java:77)\nat io.digdag.core.agent.OperatorManager.runWithHeartbeat(OperatorManager.java:142)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invokeMain(DigdagTimedMethodInterceptor.java:58)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invoke(DigdagTimedMethodInterceptor.java:31)\nat io.digdag.core.agent.OperatorManager.run(OperatorManager.java:125)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invokeMain(DigdagTimedMethodInterceptor.java:58)\nat io.digdag.server.metrics.DigdagTimedMethodInterceptor.invoke(DigdagTimedMethodInterceptor.java:31)\nat io.digdag.core.agent.MultiThreadAgent.lambda$null$0(MultiThreadAgent.java:131)\nat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\nat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\nat java.base/java.lang.Thread.run(Thread.java:834)\nCaused by: io.digdag.spi.StorageFileNotFoundException: S3 file not found\nat io.digdag.storage.s3.S3Storage.getWithRetry(S3Storage.java:244)\nat io.digdag.storage.s3.S3Storage.open(S3Storage.java:89)\nat io.digdag.standards.command.ecs.TemporalProjectArchiveStorage.getContentInputStream(TemporalProjectArchiveStorage.java:52)\n... 26 common frames omitted\nCaused by: com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; \n\nThis PR introduce retry using exponential backoff in curl.\nI verified the retrying logic of curl command as follows:\n$ curl --retry 7 --fail https://instability.now.sh?errorRate=99\nWarning: Transient problem: HTTP error Will retry in 1 seconds. 7 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 2 seconds. 6 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 4 seconds. 5 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 8 seconds. 4 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 16 seconds. 3 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 32 seconds. 2 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 64 seconds. 1 retries \nWarning: left.\ncurl: (22) The requested URL returned error: 500 \n\n$ curl --retry 8 --fail https://instability.now.sh?errorRate=99\nWarning: Transient problem: HTTP error Will retry in 1 seconds. 7 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 2 seconds. 6 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 4 seconds. 5 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 8 seconds. 4 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 16 seconds. 3 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 32 seconds. 2 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 64 seconds. 1 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 128 seconds. 1 retries \nWarning: left.\ncurl: (22) The requested URL returned error: 500 \n\n$ curl --retry 7 --fail --retry-connrefused https://instability.now.sh?errorRate=70\nWarning: Transient problem: HTTP error Will retry in 1 seconds. 7 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 2 seconds. 6 retries \nWarning: left.\nWarning: Transient problem: HTTP error Will retry in 4 seconds. 5 retries \nWarning: left.\n{\"status\":200,\"message\":\"OK\"}", "createdAt": "2020-07-10T14:50:57Z", "url": "https://github.com/treasure-data/digdag/pull/1436", "merged": true, "mergeCommit": {"oid": "347d6692b69653aeb4ad131fdc358dcf17b9a543"}, "closed": true, "closedAt": "2020-07-22T08:16:28Z", "author": {"login": "myui"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczkrLjAH2gAyNDQ3NDg0MjkxOjI2NTkwMjExMGRkYzA0NGU0YjQxZjVmYmM1OWVhZWM0YzBkNTMyY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3Ud-3AFqTQ1MzAxNjg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "265902110ddc044e4b41f5fbc59eaec4c0d532cf", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/265902110ddc044e4b41f5fbc59eaec4c0d532cf", "committedDate": "2020-07-10T14:39:58Z", "message": "Introduce retrying on temporary network outage and/or S3 errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42f762054d33efd40b6f10cf85a801458c823ad3", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/42f762054d33efd40b6f10cf85a801458c823ad3", "committedDate": "2020-07-10T15:15:29Z", "message": "Fixed a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzY3Mzg5", "url": "https://github.com/treasure-data/digdag/pull/1436#pullrequestreview-451367389", "createdAt": "2020-07-20T07:43:17Z", "commit": {"oid": "42f762054d33efd40b6f10cf85a801458c823ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNzo0MzoxOFrOGz9lfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNzo0MzoxOFrOGz9lfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzOTU4MA==", "bodyText": "isn't --fail option unnecessary? digdag server maintainer and workflow user are different. basically the server maintainer doesn't want to include error message details like S3 file path or pre-signed URL to the user.\nwhat do you think we could extract the retry count as parameters? because that's depending on the use case. probably some cases, server maintainer don't want to give up the retry because the script command succeeds but the workflow task fails.", "url": "https://github.com/treasure-data/digdag/pull/1436#discussion_r457139580", "createdAt": "2020-07-20T07:43:18Z", "author": {"login": "muga"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -659,7 +661,9 @@ protected void setEcsContainerOverrideCommand(\n             bashArguments.add(s(\"popd\"));\n         }\n         bashArguments.add(s(\"tar -zcf %s  --exclude %s --exclude %s .digdag/tmp/\", outputProjectArchivePathName, relativeProjectArchivePath.toString(), outputProjectArchivePathName));\n-        bashArguments.add(s(\"curl -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n+        // retry by exponential backoff 1+2+4+8+16+32+64=127 seconds\n+        // Note that it's intended to curl exit 0 on http errors since it's only for LogWatch logging\n+        bashArguments.add(s(\"curl --retry 7 --retry-connrefused -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42f762054d33efd40b6f10cf85a801458c823ad3"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd531ca5e0e50c9a46ac7bea1bd4610baf713b50", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/cd531ca5e0e50c9a46ac7bea1bd4610baf713b50", "committedDate": "2020-07-21T08:07:58Z", "message": "Add a system config to control times curl retrying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b80a8a8ec4e2a48210778d0e0cc16fe002da658d", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/b80a8a8ec4e2a48210778d0e0cc16fe002da658d", "committedDate": "2020-07-22T01:51:19Z", "message": "Added a system config to control curl fail option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8531cc9e4223ea6339297474059555ce7c55852f", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/8531cc9e4223ea6339297474059555ce7c55852f", "committedDate": "2020-07-22T01:56:45Z", "message": "Fixed disable_curl_fail_opt option handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c75c2880c29a65b716c6cde726c894fa8191c05", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/3c75c2880c29a65b716c6cde726c894fa8191c05", "committedDate": "2020-07-22T01:55:23Z", "message": "Fixed disable_curl_fail_opt option handling"}, "afterCommit": {"oid": "8531cc9e4223ea6339297474059555ce7c55852f", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/8531cc9e4223ea6339297474059555ce7c55852f", "committedDate": "2020-07-22T01:56:45Z", "message": "Fixed disable_curl_fail_opt option handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d07e4bbcdfe34e04982b4bad0998d36753f3dc77", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/d07e4bbcdfe34e04982b4bad0998d36753f3dc77", "committedDate": "2020-07-22T05:41:36Z", "message": "Fixed to apply curl --fail option handling only for uploading outputs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDEzMzk3", "url": "https://github.com/treasure-data/digdag/pull/1436#pullrequestreview-453013397", "createdAt": "2020-07-22T05:53:44Z", "commit": {"oid": "d07e4bbcdfe34e04982b4bad0998d36753f3dc77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "846f6212fe76d3e9dcc56753f564a82eb767212c", "author": {"user": {"login": "myui", "name": "Makoto YUI"}}, "url": "https://github.com/treasure-data/digdag/commit/846f6212fe76d3e9dcc56753f564a82eb767212c", "committedDate": "2020-07-22T06:00:44Z", "message": "Fixed config key name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDE2ODg5", "url": "https://github.com/treasure-data/digdag/pull/1436#pullrequestreview-453016889", "createdAt": "2020-07-22T06:02:46Z", "commit": {"oid": "846f6212fe76d3e9dcc56753f564a82eb767212c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4040, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}