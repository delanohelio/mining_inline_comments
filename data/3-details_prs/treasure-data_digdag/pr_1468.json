{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NzM4OTQ5", "number": 1468, "title": "Fix a bug that failed tasks with java.lang.Error retry infinitely", "bodyText": "Current OperatorManager#runWithHeartbeat doesn't catch java.lang.Error derived objects including java.lang.OutOfMemoryError. If a task always fails due to OOM (e.g. internally parse a huge JSON object), the task will be retried infinitely and the task TTL (default: 24 hours) won't work.\nThis PR fixes the bug by checking if the task is already requested to be canceled by WorkflowExecutionTimeoutEnforcer and cancels the task if needed.", "createdAt": "2020-10-20T12:08:31Z", "url": "https://github.com/treasure-data/digdag/pull/1468", "merged": true, "mergeCommit": {"oid": "9827bc6c45b7ea8080a143b476c2531c87048663"}, "closed": true, "closedAt": "2020-10-23T07:23:50Z", "author": {"login": "komamitsu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUT9ghAH2gAyNTA2NzM4OTQ5OjhiYWExZTdkYjM5NWQzYTJkNDQxZWYxMjQzYzFmMWRhNjQ0ZjNjMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVQjRRgFqTUxNTM3NjM4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8baa1e7db395d3a2d441ef1243c1f1da644f3c35", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/8baa1e7db395d3a2d441ef1243c1f1da644f3c35", "committedDate": "2020-10-20T07:51:06Z", "message": "Cancel failed task if it's requested to be canceled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61fc8c2f84201ee11803bd658e36783b5b3772f7", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/61fc8c2f84201ee11803bd658e36783b5b3772f7", "committedDate": "2020-10-21T05:24:45Z", "message": "Fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd0cb44e515fc587b91593c3384a9b265500f6f", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/4bd0cb44e515fc587b91593c3384a9b265500f6f", "committedDate": "2020-10-21T07:58:20Z", "message": "Adding test cases for OperatorManager#runWithHeartbeat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99141dc3b30be7b47a5d0081529aaddbcc525aa4", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/99141dc3b30be7b47a5d0081529aaddbcc525aa4", "committedDate": "2020-10-21T09:01:28Z", "message": "Add error test case to OperatorManagerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8dbd5a59afd8f4748e38dc9620e2f47fc714548", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/a8dbd5a59afd8f4748e38dc9620e2f47fc714548", "committedDate": "2020-10-21T10:04:30Z", "message": "Add a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0aeb560f9fcd5e16594f1266c7e7dfe2e165272", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/f0aeb560f9fcd5e16594f1266c7e7dfe2e165272", "committedDate": "2020-10-21T11:20:40Z", "message": "Add some test cases in OperatorManagerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59", "author": {"user": {"login": "komamitsu", "name": "Mitsunori Komatsu"}}, "url": "https://github.com/treasure-data/digdag/commit/49e8345c9224935dda94e4a808ad3cbada528f59", "committedDate": "2020-10-21T11:28:25Z", "message": "Refactor import statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjQ0ODEy", "url": "https://github.com/treasure-data/digdag/pull/1468#pullrequestreview-515244812", "createdAt": "2020-10-23T02:58:20Z", "commit": {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMjo1ODoyMVrOHm6g4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMjo1ODoyMVrOHm6g4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU2NjYyNw==", "bodyText": "In this implementation, only when cancel is requested, task will finish with failure.\nIf canceling request is not set to the task, the task will continue to run with failure until TTL.\nIs my understanding correct ? If so, is there any reason to wait for TTL ?", "url": "https://github.com/treasure-data/digdag/pull/1468#discussion_r510566627", "createdAt": "2020-10-23T02:58:21Z", "author": {"login": "yoyama"}, "path": "digdag-core/src/main/java/io/digdag/core/agent/OperatorManager.java", "diffHunk": "@@ -177,6 +177,19 @@ protected void runWithHeartbeat(TaskRequest request)\n                     }\n                     callback.taskFailed(request, agentId, buildExceptionErrorConfig(ex).toConfig(cf));  // no retry\n                 }\n+                catch (Throwable ex) {\n+                    logger.error(\n+                            LogMarkers.UNEXPECTED_SERVER_ERROR,\n+                            \"Task failed with unexpected error: {}\", ex.getMessage(), ex);\n+\n+                    // This block catches OutOfMemoryError and its cause can be either deterministic or non-deterministic.\n+                    // So, OperatorManager can't always cancel the failed task.\n+                    if (request.isCancelRequested()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Mzc1ODM2", "url": "https://github.com/treasure-data/digdag/pull/1468#pullrequestreview-515375836", "createdAt": "2020-10-23T06:25:27Z", "commit": {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Mzc2Mzg3", "url": "https://github.com/treasure-data/digdag/pull/1468#pullrequestreview-515376387", "createdAt": "2020-10-23T06:26:39Z", "commit": {"oid": "49e8345c9224935dda94e4a808ad3cbada528f59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4061, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}