{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MDQyNzYy", "number": 1345, "title": "Continue [Fix #1131 group retry degradation.]", "bodyText": "This PR will replace #1220 .\nI added tests for only if retry.\nFor checking backward-compatibility, there is already tests in \n  \n    \n      digdag/digdag-core/src/test/java/io/digdag/core/workflow/WorkflowExecutorTest.java\n    \n    \n        Lines 165 to 197\n      in\n      6ebb623\n    \n    \n    \n    \n\n        \n          \n           @Test \n        \n\n        \n          \n           public void retryInCall() \n        \n\n        \n          \n                   throws Exception \n        \n\n        \n          \n           { \n        \n\n        \n          \n               String childContent = Resources.toString(WorkflowExecutorTest.class.getResource(\"/io/digdag/core/workflow/retry_in_call_child.dig\"), UTF_8); \n        \n\n        \n          \n               Path childPath = folder.getRoot().toPath().resolve(\"retry_in_call_child.dig\"); \n        \n\n        \n          \n               System.out.println(childPath.toAbsolutePath().toString()); \n        \n\n        \n          \n               Files.write(childPath, childContent.getBytes(UTF_8)); \n        \n\n        \n          \n            \n        \n\n        \n          \n               String parentBase = Resources.toString(WorkflowExecutorTest.class.getResource(\"/io/digdag/core/workflow/retry_in_call_parent.dig\"), UTF_8); \n        \n\n        \n          \n            \n        \n\n        \n          \n               //Full path not work in AppVeyor \n        \n\n        \n          \n               //String parentContent = parentBase.replaceFirst(\"child_path: dummy\", \"child_path: \" + childPath.toString()); \n        \n\n        \n          \n               String parentContent = parentBase.replaceFirst(\"child_path: dummy\", \"child_path: \" +  \"retry_in_call_child.dig\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               Config parent = new YamlConfigLoader().loadString(parentContent).toConfig(ConfigUtils.configFactory); \n        \n\n        \n          \n               runWorkflow(\"retry_in_call\", parent); \n        \n\n        \n          \n               Path outPath = folder.getRoot().toPath().resolve(\"out\"); \n        \n\n        \n          \n               assertThat(new String(Files.readAllBytes(outPath), UTF_8), is(\"try1try2try1try2try1try2\")); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n            \n        \n\n        \n          \n           @Test \n        \n\n        \n          \n           public void retryInLoop() \n        \n\n        \n          \n                   throws Exception \n        \n\n        \n          \n           { \n        \n\n        \n          \n               String content = Resources.toString(WorkflowExecutorTest.class.getResource(\"/io/digdag/core/workflow/retry_in_loop.dig\"), UTF_8); \n        \n\n        \n          \n               Config config = new YamlConfigLoader().loadString(content).toConfig(ConfigUtils.configFactory); \n        \n\n        \n          \n               runWorkflow(\"retry_in_loop\", config); \n        \n\n        \n          \n               Path outPath = folder.getRoot().toPath().resolve(\"out\"); \n        \n\n        \n          \n               String out = new String(Files.readAllBytes(outPath), UTF_8); \n        \n\n        \n          \n               assertThat(new String(Files.readAllBytes(outPath), UTF_8), is(\"loop0:try1try2succeeded.loop1:try1try2succeeded.loop2:try1try2try1try2try1try2\")); \n        \n\n        \n          \n           } \n        \n    \n  \n\n , so we should check if it succeeds or not.", "createdAt": "2020-01-28T14:25:32Z", "url": "https://github.com/treasure-data/digdag/pull/1345", "merged": true, "mergeCommit": {"oid": "f218d4ef0313f0470cc1a4a6d4a4ec44c22ee3f7"}, "closed": true, "closedAt": "2020-02-03T02:11:31Z", "author": {"login": "naritta"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-yJbTgH2gAyMzY4MDQyNzYyOjNkOWE4YzY3NmY1ZDQzMDU4NDJlZWI0MzAxNjMxMDdiYTY5ZDM1NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_q-6IgFqTM1MTM1NTA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d9a8c676f5d4305842eeb430163107ba69d3558", "author": {"user": null}, "url": "https://github.com/treasure-data/digdag/commit/3d9a8c676f5d4305842eeb430163107ba69d3558", "committedDate": "2020-01-28T14:23:47Z", "message": "Fix #1131 group retry degradation.\n\nThis PR will replace #1153."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebb6230fb9be08f362e9eaad72349d9be79e0d5", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/6ebb6230fb9be08f362e9eaad72349d9be79e0d5", "committedDate": "2020-01-29T08:49:00Z", "message": "Add integration tests for if fail retry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTQ3MzA2", "url": "https://github.com/treasure-data/digdag/pull/1345#pullrequestreview-349947306", "createdAt": "2020-01-29T09:00:41Z", "commit": {"oid": "6ebb6230fb9be08f362e9eaad72349d9be79e0d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTowMDo0MVrOFjA3Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTowMDo0MVrOFjA3Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI1ODY0Mg==", "bodyText": "These code may be better to remove.", "url": "https://github.com/treasure-data/digdag/pull/1345#discussion_r372258642", "createdAt": "2020-01-29T09:00:41Z", "author": {"login": "yoyama"}, "path": "digdag-core/src/main/java/io/digdag/core/database/DatabaseSessionStoreManager.java", "diffHunk": "@@ -905,16 +906,50 @@ public void addResumingTasks(long attemptId, List<ResumingTask> tasks)\n         }\n \n         @DigdagTimed(value = \"dtcst_\", category = \"db\", appendMethodName = true)\n+        /**\n+         * Filter the child task if it is generated sub task.\n+         * Check the child task full name has '^sub' position later the parent full name.\n+         * @param parentFullName\n+         * @return\n+         */\n+        @VisibleForTesting\n+        public Predicate<StoredTask> funcFilterGeneratedSubtasks(Optional<String>parentFullName)\n+        {\n+            Predicate<StoredTask> filterGeneratedSubtasks = (s) -> {\n+                if (!parentFullName.isPresent()) {\n+                    return true;\n+                }\n+                String pfname = parentFullName.get();\n+                String chfname = s.getFullName();\n+                int pfnameLen = pfname.length();\n+                int chfnameLen = chfname.length();\n+\n+                if (chfname.startsWith(pfname)\n+                        && chfname.substring(pfnameLen).contains(\"^sub\")) {\n+                    // && chfnameLen > pfnameLen + \"^sub\".length()) {\n+                    logger.debug(\"Exclude generated task:{} from retry target\", chfname);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ebb6230fb9be08f362e9eaad72349d9be79e0d5"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1071cbf07425d0ddd1049138d0e696fcac9705c9", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/1071cbf07425d0ddd1049138d0e696fcac9705c9", "committedDate": "2020-01-29T12:14:43Z", "message": "Delete needless lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9e868aa1d642050fc938f43aa092b217cdf9fe", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/fb9e868aa1d642050fc938f43aa092b217cdf9fe", "committedDate": "2020-01-29T12:56:52Z", "message": "Add tests for for_each"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c50592b18c00eabd4ac8835dffbe13697add21c", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/5c50592b18c00eabd4ac8835dffbe13697add21c", "committedDate": "2020-01-29T16:31:41Z", "message": "Add tests for call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d936ed414d8a22b634d72027b6722f2910dd5eb", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/7d936ed414d8a22b634d72027b6722f2910dd5eb", "committedDate": "2020-01-30T09:12:09Z", "message": "Add new line end"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "244c327cc486e4991e642f2bf41551a48875f70c", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/244c327cc486e4991e642f2bf41551a48875f70c", "committedDate": "2020-01-30T09:54:37Z", "message": "Fix to output echo for failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9051d8d54241b02c34d4e88c17f01859f478993d", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/9051d8d54241b02c34d4e88c17f01859f478993d", "committedDate": "2020-01-30T11:53:33Z", "message": "Add tests for nested call"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7da9022d4d70b28b4a5e36681a6849552e9c8e7", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/a7da9022d4d70b28b4a5e36681a6849552e9c8e7", "committedDate": "2020-01-30T10:40:08Z", "message": "Add tests for nested call"}, "afterCommit": {"oid": "9051d8d54241b02c34d4e88c17f01859f478993d", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/9051d8d54241b02c34d4e88c17f01859f478993d", "committedDate": "2020-01-30T11:53:33Z", "message": "Add tests for nested call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzU1MDg3", "url": "https://github.com/treasure-data/digdag/pull/1345#pullrequestreview-351355087", "createdAt": "2020-01-31T08:36:53Z", "commit": {"oid": "9051d8d54241b02c34d4e88c17f01859f478993d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4113, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}