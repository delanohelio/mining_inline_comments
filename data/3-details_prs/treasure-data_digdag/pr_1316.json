{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMzUwMTE4", "number": 1316, "title": "Fix EcsCommandExecutor to use finish marker to know if logging is finished or not", "bodyText": "Currently we cannot get all ECS logs sometimes.\nWe need to know when task and logging is finished, and after that we should finish logs manipulation.", "createdAt": "2020-01-10T09:19:06Z", "url": "https://github.com/treasure-data/digdag/pull/1316", "merged": true, "mergeCommit": {"oid": "d6eefb83df40f5a7dfeab7c06c1f342444e9bd75"}, "closed": true, "closedAt": "2020-02-03T06:14:19Z", "author": {"login": "naritta"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb469awAH2gAyMzYxMzUwMTE4OmI3MzA0ZDhmMDM2NzRjMTY2YmVjMjRhNTMyM2ExNDk1YTVjZjU3Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-fZ-qABqjI5ODI1MTMyNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7304d8f03674c166bec24a5323a1495a5cf5767", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/b7304d8f03674c166bec24a5323a1495a5cf5767", "committedDate": "2020-01-10T09:16:16Z", "message": "Fix EcsCommandExecutor to use finish marker to know if task is finished or not"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "committedDate": "2020-01-14T08:22:13Z", "message": "Add timeout and refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7756710a1d6c3815baed2c1866bfe37207207668", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/7756710a1d6c3815baed2c1866bfe37207207668", "committedDate": "2020-01-14T08:19:25Z", "message": "Add timeout and refactor"}, "afterCommit": {"oid": "a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "committedDate": "2020-01-14T08:22:13Z", "message": "Add timeout and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed8b398e30344c79a92046311d4418e05656dc6", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/1ed8b398e30344c79a92046311d4418e05656dc6", "committedDate": "2020-01-14T09:02:24Z", "message": "move log uploading to after marker is checked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "committedDate": "2020-01-15T08:53:41Z", "message": "Fix to use contain for checking finish marker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2888b169576b8f4b0026d81973656e2373632e28", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/2888b169576b8f4b0026d81973656e2373632e28", "committedDate": "2020-01-15T09:36:21Z", "message": "Add sleep in loop to avoid limit exceed"}, "afterCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "committedDate": "2020-01-15T08:53:41Z", "message": "Fix to use contain for checking finish marker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MjQwNzQ1", "url": "https://github.com/treasure-data/digdag/pull/1316#pullrequestreview-348240745", "createdAt": "2020-01-24T21:41:03Z", "commit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMTo0MTowNFrOFhrMAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMjoxMTozOFrOFhr0ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NDkxNA==", "bodyText": "We can make this happen earlier. As soon as a task finishes, right before // always return false to check if ... comment, we can set status_code.", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370854914", "createdAt": "2020-01-24T21:41:04Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -287,8 +288,39 @@ CommandStatus createNextCommandStatus(\n         }\n \n         final EcsTaskStatus taskStatus = EcsTaskStatus.of(task.getLastStatus());\n-        final ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n-        final ObjectNode nextExecutorStatus;\n+        ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n+        ObjectNode nextExecutorStatus;\n+\n+        // To fetch log until all logs is written in CloudWatch, it should wait until getting finish marker in end of task.\n+        // (finished previous poll once considering risk of crushing while running previous actual poll.)\n+        final Optional<Long> taskFinishedAt = !previousStatus.has(\"task_finished_at\") ?\n+                Optional.absent() : Optional.of(previousStatus.get(\"task_finished_at\").asLong());\n+        if (taskFinishedAt.isPresent()) {\n+            long timeout = taskFinishedAt.get() + 60;\n+            do {\n+                previousExecutorStatus = fetchLogEvents(client, task, previousStatus, previousExecutorStatus);\n+                if (previousExecutorStatus.get(\"logging_finished\") != null) {\n+                    break;\n+                }\n+            } while (Instant.now().getEpochSecond() < timeout);\n+\n+            final String outputArchivePathName = \"archive-output.tar.gz\";\n+            final String outputArchiveKey = createStorageKey(commandContext.getTaskRequest(), outputArchivePathName); // url format\n+            // Download output config archive\n+            final TemporalProjectArchiveStorage temporalStorage = createTemporalProjectArchiveStorage(commandContext.getTaskRequest().getConfig());\n+            try (final InputStream in = temporalStorage.getContentInputStream(outputArchiveKey)) {\n+                ProjectArchives.extractTarArchive(commandContext.getLocalProjectPath(), in); // IOException\n+            }\n+\n+            final ObjectNode nextStatus = previousStatus.deepCopy();\n+            nextStatus.set(\"executor_state\", previousExecutorStatus);\n+\n+            // Set exit code of container finished to nextStatus\n+            nextStatus.put(\"status_code\", task.getContainers().get(0).getExitCode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MDMwMQ==", "bodyText": "After 1., if you feel you have energy (meaning it's optional to do), it's better to do a refactoring around execution status data:\n\n\ntoLogStreamName is formatting a string but it's unnecessary if previousStatus includes the pre-built string. As like toLogGroupName is doing. If toLogStreamName simply uses previousStatus.get(\"awslogs\").get(\"awslogs-stream\").asText() then, we can do as following:\nrun calls createCurrentStatus to set awslogs to the status. It's calling getAwsLogsConfiguration(td), which copies all of the logConfig.getOptions().entrySet() to the executor status. This becomes unnecessary. Instead, it simply needs to copy awslogs.awslogs-group and format&set awslogs.awslogs-stream only.\nBecause toLogStreamName gets pre-formatted text from the executor status, it doesn't need TaskDefinition td any more. It also means that fetchLogEvents doesn't need Task task. It means that createNextCommandStatus doesn't have to pass Task task to fetchLogEvents. Therefore, you can move this entire block (if (taskFinishedAt.isPresent()) { ... }) right before client.getTask call. It means that EcsCommandExecutor doesn't have to call ECS API when it's waiting for logs.\n\nThis is helpful to mitigate API call rate limit of ECS API.", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370860301", "createdAt": "2020-01-24T21:56:26Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -287,8 +288,39 @@ CommandStatus createNextCommandStatus(\n         }\n \n         final EcsTaskStatus taskStatus = EcsTaskStatus.of(task.getLastStatus());\n-        final ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n-        final ObjectNode nextExecutorStatus;\n+        ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n+        ObjectNode nextExecutorStatus;\n+\n+        // To fetch log until all logs is written in CloudWatch, it should wait until getting finish marker in end of task.\n+        // (finished previous poll once considering risk of crushing while running previous actual poll.)\n+        final Optional<Long> taskFinishedAt = !previousStatus.has(\"task_finished_at\") ?\n+                Optional.absent() : Optional.of(previousStatus.get(\"task_finished_at\").asLong());\n+        if (taskFinishedAt.isPresent()) {\n+            long timeout = taskFinishedAt.get() + 60;\n+            do {\n+                previousExecutorStatus = fetchLogEvents(client, task, previousStatus, previousExecutorStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTMwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            } else {\n          \n          \n            \n                            }\n          \n          \n            \n                            else {", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370861302", "createdAt": "2020-01-24T21:59:25Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -361,7 +386,12 @@ ObjectNode fetchLogEvents(final EcsClient client,\n         }\n         else {\n             for (final OutputLogEvent logEvent : logEvents) {\n-                log(logEvent.getMessage() + \"\\n\", clog);\n+                String log = logEvent.getMessage();\n+                if (log.contains(ECS_TASK_FINISHED)) {\n+                    nextExecutorStatus.set(\"logging_finished\", JsonNodeFactory.instance.textNode(\"true\"));\n+                } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTU4Ng==", "bodyText": "It's better to use a self-explaining name:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String ECS_TASK_FINISHED = \"ECS_TASK_FINISHED\";\n          \n          \n            \n                private static final String ECS_END_OF_TASK_LOG_MARK = \"ECS_TASK_FINISHED\";", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370861586", "createdAt": "2020-01-24T22:00:20Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -66,6 +66,7 @@\n \n     private static final String ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX = \"agent.command_executor.ecs.\";\n     private static final String DEFAULT_COMMAND_TASK_TTL = ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX + \"default_command_task_ttl\";\n+    private static final String ECS_TASK_FINISHED = \"ECS_TASK_FINISHED\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2Mjk3OA==", "bodyText": "I recommend to use logging_finished_at and set timestamp instead of true because we can know when waiting logging has finished without much overhead. It helps us to investigate problems if some happened.", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370862978", "createdAt": "2020-01-24T22:04:26Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -361,7 +386,12 @@ ObjectNode fetchLogEvents(final EcsClient client,\n         }\n         else {\n             for (final OutputLogEvent logEvent : logEvents) {\n-                log(logEvent.getMessage() + \"\\n\", clog);\n+                String log = logEvent.getMessage();\n+                if (log.contains(ECS_TASK_FINISHED)) {\n+                    nextExecutorStatus.set(\"logging_finished\", JsonNodeFactory.instance.textNode(\"true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MzM5Nw==", "bodyText": "This needs escaping:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bashArguments.add(s(\"echo %s\", ECS_TASK_FINISHED));\n          \n          \n            \n                    bashArguments.add(s(\"echo \\\"%s\\\"\", ECS_TASK_FINISHED));", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370863397", "createdAt": "2020-01-24T22:05:45Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -618,6 +648,7 @@ protected void setEcsContainerOverrideCommand(\n         }\n         bashArguments.add(s(\"tar -zcf %s  --exclude %s --exclude %s .digdag/tmp/\", outputProjectArchivePathName, relativeProjectArchivePath.toString(), outputProjectArchivePathName));\n         bashArguments.add(s(\"curl -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n+        bashArguments.add(s(\"echo %s\", ECS_TASK_FINISHED));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2NTI5MA==", "bodyText": "I think the value (\"ECS_TASK_FINISHED\") needs to be something more unlike because log stream finishes unexpectedly if a script outputs this message.\nHow about using \"--RWNzQ29tbWFuZEV4ZWN1dG9y--\"  // base64(\"EcsCommandExecutor\") for example? Idea is partially taken from https://www.w3.org/Protocols/rfc1341/7_2_Multipart.html", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370865290", "createdAt": "2020-01-24T22:11:38Z", "author": {"login": "frsyuki"}, "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -66,6 +66,7 @@\n \n     private static final String ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX = \"agent.command_executor.ecs.\";\n     private static final String DEFAULT_COMMAND_TASK_TTL = ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX + \"default_command_task_ttl\";\n+    private static final String ECS_TASK_FINISHED = \"ECS_TASK_FINISHED\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTU4Ng=="}, "originalCommit": {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c57f438030abfbb3c95c6fd4b960f9e291f96561", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/c57f438030abfbb3c95c6fd4b960f9e291f96561", "committedDate": "2020-01-27T05:23:50Z", "message": "Fix task finished marker name and value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b45c5fb60f7480a6ad6c21f9d71d90ed663ae23b", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/b45c5fb60f7480a6ad6c21f9d71d90ed663ae23b", "committedDate": "2020-01-27T05:39:10Z", "message": "Fix logging finished status to use time for investigation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8a0ac626ea82458e90db004fddb885208c3ea77", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/c8a0ac626ea82458e90db004fddb885208c3ea77", "committedDate": "2020-01-27T05:40:07Z", "message": "Fix code indent for else"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec0e18ecc8a2133b5efbd17e26fddb6ccb21bb04", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/ec0e18ecc8a2133b5efbd17e26fddb6ccb21bb04", "committedDate": "2020-01-27T05:42:46Z", "message": "Fix to escape"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c6c3dc7afe0e488d1767018c0894fdb89a7b03a", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/3c6c3dc7afe0e488d1767018c0894fdb89a7b03a", "committedDate": "2020-01-27T06:00:43Z", "message": "Move status_code setting right after task is finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8de229d1475895705fd39658cc4d4fcccb129e6", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/d8de229d1475895705fd39658cc4d4fcccb129e6", "committedDate": "2020-01-27T16:33:31Z", "message": "Refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "811037406b514cdb27dc50b4b54c14da81294b35", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/811037406b514cdb27dc50b4b54c14da81294b35", "committedDate": "2020-01-27T15:33:00Z", "message": "Refactor"}, "afterCommit": {"oid": "d8de229d1475895705fd39658cc4d4fcccb129e6", "author": {"user": {"login": "naritta", "name": "Ritta Narita"}}, "url": "https://github.com/treasure-data/digdag/commit/d8de229d1475895705fd39658cc4d4fcccb129e6", "committedDate": "2020-01-27T16:33:31Z", "message": "Refactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4109, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}