{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTkxNzEx", "number": 734, "title": "Participant Manager Service [POST]  Setup account endpoint implementation", "bodyText": "Participant Manager Service [POST]  Setup account endpoint implementation without integration test cases. LOC for this PR is more than 700 lines, so removed integration tests and created new PR #735 with integration tests", "createdAt": "2020-08-10T16:01:58Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734", "merged": true, "mergeCommit": {"oid": "64181c75a29939d378c28b938a75398906fe9ee9"}, "closed": true, "closedAt": "2020-08-11T21:30:13Z", "author": {"login": "Kantharajut-btc"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9kZD0gH2gAyNDY1NTkxNzExOjBhZTNmZjg1YWNmMWNiNjVkYTQ1MGRmOTE1ODExYTFiNTcwMTk2ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc99uG5AFqTQ2NTQ0Mjc0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ae3ff85acf1cb65da450df915811a1b570196fe", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0ae3ff85acf1cb65da450df915811a1b570196fe", "committedDate": "2020-08-10T15:59:25Z", "message": "POST Setup account end point implementation with integration test cases\n\nPOST Setup account end point implementation with integration test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf", "committedDate": "2020-08-10T16:08:12Z", "message": "Removed test cases to reduce LOC\n\nRemoved test cases to reduce LOC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjA1NDM3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#pullrequestreview-464605437", "createdAt": "2020-08-10T21:36:49Z", "commit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMTozNjo1MFrOG-gqsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzoxMzoyOVrOG-i10w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMDExMw==", "bodyText": "emailId->email", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#discussion_r468200113", "createdAt": "2020-08-10T21:36:50Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -110,13 +108,26 @@\n \n   CUSTOM_ID_EXISTS(400, \"EC_883\", Constants.BAD_REQUEST, \"customId already exists\"),\n \n-  USER_NOT_ACTIVE(400, \"EC_93\", Constants.BAD_REQUEST, \"User not Active\");\n+  USER_NOT_ACTIVE(400, \"EC_93\", Constants.BAD_REQUEST, \"User not Active\"),\n+\n+  USER_NOT_INVITED(\n+      400, \"EC-869\", Constants.BAD_REQUEST, \"Provided emailId not exists or user not invited\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwOTU4Mg==", "bodyText": "you have too many extra backslash that are not needed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\\\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\\\\\\\\\\\\\[\\\\\\\\\\\\\\\\]^_`{|}~]).{8,64}$\";\n          \n          \n            \n                       \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\[\\\\]^_`{|}~]).{8,64}$\";", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#discussion_r468209582", "createdAt": "2020-08-10T21:58:50Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/SetUpAccountRequest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.google.cloud.healthcare.fdamystudies.beans;\n+\n+import javax.validation.constraints.Email;\n+import javax.validation.constraints.NotBlank;\n+import javax.validation.constraints.NotNull;\n+import javax.validation.constraints.Pattern;\n+import javax.validation.constraints.Size;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+\n+@Getter\n+@Setter\n+@ToString\n+@Component\n+@Scope(value = \"prototype\")\n+public class SetUpAccountRequest {\n+\n+  private static final String PASSWORD_REGEX =\n+      \"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[!\\\\\\\\\\\\\\\"#$%&'()*+,-.:;<=>?@\\\\\\\\\\\\\\\\[\\\\\\\\\\\\\\\\]^_`{|}~]).{8,64}$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMTU4OQ==", "bodyText": "Don't you have to call setErrorHandler on restTemplate to make sure your custom RestResponseErrorHandler above will work to catch all the exceptions by restTemplate?\nRefer to the answer in: https://stackoverflow.com/questions/46367039/how-to-handle-httpclientexception-properly/46368179#46368179", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#discussion_r468231589", "createdAt": "2020-08-10T23:00:13Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.AuthUserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.SetUpAccountRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.SetUpAccountResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.common.UserAccountStatus;\n+import com.google.cloud.healthcare.fdamystudies.common.UserStatus;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+import java.util.Optional;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpEntity;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.web.client.RestTemplate;\n+\n+@Service\n+public class UserProfileServiceImpl implements UserProfileService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserProfileServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userRegAdminRepository;\n+\n+  @Autowired private AppPropertyConfig appPropertyConfig;\n+\n+  @Autowired private RestTemplate restTemplate;\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Override\n+  @Transactional\n+  public SetUpAccountResponse saveUser(SetUpAccountRequest setUpAccountRequest) {\n+    logger.entry(\"saveUser\");\n+\n+    Optional<UserRegAdminEntity> optUsers =\n+        userRegAdminRepository.findByEmail(setUpAccountRequest.getEmail());\n+    if (!optUsers.isPresent()) {\n+      return new SetUpAccountResponse(ErrorCode.USER_NOT_INVITED);\n+    }\n+\n+    // Bad request and errors handled in RestResponseErrorHandler class\n+    UserResponse authRegistrationResponse = registerUserInAuthServer(setUpAccountRequest);\n+\n+    UserRegAdminEntity userRegAdminUser = optUsers.get();\n+    userRegAdminUser.setUrAdminAuthId(authRegistrationResponse.getUserId());\n+    userRegAdminUser.setFirstName(setUpAccountRequest.getFirstName());\n+    userRegAdminUser.setLastName(setUpAccountRequest.getLastName());\n+    userRegAdminUser.setStatus(UserStatus.ACTIVE.getValue());\n+    userRegAdminUser = userRegAdminRepository.saveAndFlush(userRegAdminUser);\n+\n+    SetUpAccountResponse setUpAccountResponse =\n+        new SetUpAccountResponse(\n+            userRegAdminUser.getId(),\n+            authRegistrationResponse.getTempRegId(),\n+            authRegistrationResponse.getUserId(),\n+            MessageCode.SET_UP_ACCOUNT_SUCCESS);\n+\n+    logger.exit(MessageCode.SET_UP_ACCOUNT_SUCCESS);\n+    return setUpAccountResponse;\n+  }\n+\n+  private UserResponse registerUserInAuthServer(SetUpAccountRequest setUpAccountRequest) {\n+    logger.entry(\"registerUserInAuthServer()\");\n+\n+    AuthUserRequest userRequest =\n+        new AuthUserRequest(\n+            \"PARTICIPANT MANAGER\",\n+            setUpAccountRequest.getEmail(),\n+            setUpAccountRequest.getPassword(),\n+            UserAccountStatus.ACTIVE.getStatus());\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(\"Authorization\", \"Bearer \" + oauthService.getAccessToken());\n+\n+    HttpEntity<AuthUserRequest> requestEntity = new HttpEntity<>(userRequest, headers);\n+\n+    ResponseEntity<UserResponse> response =\n+        restTemplate.postForEntity(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNDcwNw==", "bodyText": "just a small suggestion, these changes should be in the integration test PR next time if you do split the PRs.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#discussion_r468234707", "createdAt": "2020-08-10T23:10:15Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -43,6 +44,12 @@\n \n   public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n \n+  public static final String ADMIN_LAST_NAME = \"mockito_last_name\";\n+\n+  public static final String ADMIN_FIRST_NAME = \"mockito\";\n+\n+  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNTczMQ==", "bodyText": "nit: Move these to TestConstants.java and have TestDataHelper only have functions for generating test entity objects, etc.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#discussion_r468235731", "createdAt": "2020-08-10T23:13:29Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -43,6 +44,12 @@\n \n   public static final String EMAIL_VALUE = \"mockit_email@grr.la\";\n \n+  public static final String ADMIN_LAST_NAME = \"mockito_last_name\";\n+\n+  public static final String ADMIN_FIRST_NAME = \"mockito\";\n+\n+  protected static final String VALID_BEARER_TOKEN = \"Bearer 7fd50c2c-d618-493c-89d6-f1887e3e4bb8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef39ad5dbc02fb5d186fbfe8cdf9e035d4960cf"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89d1e5b35dd9053c73fe79b5157c690766fdcfbe", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/89d1e5b35dd9053c73fe79b5157c690766fdcfbe", "committedDate": "2020-08-11T06:10:16Z", "message": "Fixed PR comments\n\nFixed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDgzMDQ0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#pullrequestreview-465083044", "createdAt": "2020-08-11T13:49:17Z", "commit": {"oid": "89d1e5b35dd9053c73fe79b5157c690766fdcfbe"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b851e06327b3db00a8975c07df730fbae01b3f2e", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b851e06327b3db00a8975c07df730fbae01b3f2e", "committedDate": "2020-08-11T14:18:26Z", "message": "Merge branch 'develop' into participant-manager-setup-account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c405e38491ee120c6b39e1cbfe6d9a2fac578d1", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1c405e38491ee120c6b39e1cbfe6d9a2fac578d1", "committedDate": "2020-08-11T14:19:15Z", "message": "Merge branch 'develop' into participant-manager-setup-account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead17eb5bc39f77c1a066826382fd72acda512fd", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ead17eb5bc39f77c1a066826382fd72acda512fd", "committedDate": "2020-08-11T14:29:53Z", "message": "Resolved merge conflicts\n\nResolved merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff329fbdba390f6aa59f60b24e7978f78ed714c", "author": {"user": {"login": "saminguyen", "name": "Sami Nguyen"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fff329fbdba390f6aa59f60b24e7978f78ed714c", "committedDate": "2020-08-11T18:15:52Z", "message": "Merge branch 'develop' into participant-manager-setup-account"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzEzODk1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#pullrequestreview-465313895", "createdAt": "2020-08-11T18:16:10Z", "commit": {"oid": "fff329fbdba390f6aa59f60b24e7978f78ed714c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10896ff61ea3034526b173c6801fe25bfd599dec", "author": {"user": {"login": "saminguyen", "name": "Sami Nguyen"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/10896ff61ea3034526b173c6801fe25bfd599dec", "committedDate": "2020-08-11T21:20:48Z", "message": "fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDQyNzQy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/734#pullrequestreview-465442742", "createdAt": "2020-08-11T21:30:02Z", "commit": {"oid": "10896ff61ea3034526b173c6801fe25bfd599dec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 630, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}