{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMzc5MTI4", "number": 899, "title": "OAuth Scim Service - Audit Log Implementation with integration tests", "bodyText": "Audit Log Implementation with integration tests\nCode Format + Organize Imports", "createdAt": "2020-09-07T13:13:49Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899", "merged": true, "mergeCommit": {"oid": "43a8e78e99bb8c0e4b8cb6d8efccf757ce3c1eca"}, "closed": true, "closedAt": "2020-09-25T17:59:12Z", "author": {"login": "harisboston"}, "timelineItems": {"totalCount": 47, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFlo6hAH2gAyNDgxMzc5MTI4OjQyZTUyMWNlOTFhMTkwNjZmZjliOGI5MTgwMzZmYzk2NGM1MTM5NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMZiYBAH2gAyNDgxMzc5MTI4Ojc1MmQwMGRiY2RmMjU4NTAyNzVlMTk3N2YzZDdlZjVkYzA0NWIwNGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42e521ce91a19066ff9b8b918036fc964c513945", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/42e521ce91a19066ff9b8b918036fc964c513945", "committedDate": "2020-09-04T13:58:02Z", "message": "oauth service audit log\n\noauth service audit log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d83cbd658f534230309dc257e8a6e32de37ee48", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5d83cbd658f534230309dc257e8a6e32de37ee48", "committedDate": "2020-09-06T07:26:20Z", "message": "audit\n\naudit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19507adea27c1aef0d1b94523a86e30e2e75ebe0", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/19507adea27c1aef0d1b94523a86e30e2e75ebe0", "committedDate": "2020-09-06T11:12:11Z", "message": "updated audit logs\n\nupdated audit logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12ad566e1616e0ed0d138addf3131530625a9e43", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/12ad566e1616e0ed0d138addf3131530625a9e43", "committedDate": "2020-09-06T11:50:27Z", "message": "Updated audit logs\n\nUpdated audit logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ccec6366c757ecce9f95328c7639a16cff5700", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/97ccec6366c757ecce9f95328c7639a16cff5700", "committedDate": "2020-09-06T14:16:09Z", "message": "audit log test updated\n\naudit log test updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2567472c48f49aaa6b58185967627a4772e9b061", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2567472c48f49aaa6b58185967627a4772e9b061", "committedDate": "2020-09-06T14:38:08Z", "message": "audit logs update\n\naudit logs update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8fa4dbc1a44ff0f6650b6a0bcce66711e48979", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/da8fa4dbc1a44ff0f6650b6a0bcce66711e48979", "committedDate": "2020-09-06T15:17:30Z", "message": "audit log update\n\naudit log update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c27e203dd6eac3eb2d85af5f476d1d3491cc488", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1c27e203dd6eac3eb2d85af5f476d1d3491cc488", "committedDate": "2020-09-06T20:08:42Z", "message": "update\n\nupdate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "312c6dc5dabd0bccc2c46053f2cad038c33a2778", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/312c6dc5dabd0bccc2c46053f2cad038c33a2778", "committedDate": "2020-09-07T04:29:21Z", "message": "audit logs update\n\naudit logs update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0be070e49601cf1eb11102bd60d0093a354ee66", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c0be070e49601cf1eb11102bd60d0093a354ee66", "committedDate": "2020-09-07T04:36:18Z", "message": "audit log updates\n\naudit log updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e44c72651710d2f6b740b4bd4b39db538a863725", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e44c72651710d2f6b740b4bd4b39db538a863725", "committedDate": "2020-09-07T06:45:04Z", "message": "audit log test case\n\naudit log test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcf034c9c219ade5eba1d56005c4ae2a8c52a281", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dcf034c9c219ade5eba1d56005c4ae2a8c52a281", "committedDate": "2020-09-07T08:17:12Z", "message": "updated test case\n\nupdated test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99bfd9cb2bb42bf47971ffe76be8e618109055f4", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/99bfd9cb2bb42bf47971ffe76be8e618109055f4", "committedDate": "2020-09-07T09:54:58Z", "message": "Audit Log Implementation for OAuth Scim Service\n\nAudit Log Implementation for OAuth Scim Service\n\nRemoved <scope> for guava library to fix:\nCaused by: java.lang.ClassNotFoundException: com.google.common.base.Ascii"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe057f07ab0fce4ddde4fd2be68e9dbcdd70b04", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dfe057f07ab0fce4ddde4fd2be68e9dbcdd70b04", "committedDate": "2020-09-07T10:06:32Z", "message": "Audit log test case update\n\nAudit log test case  update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f21ef981a4feb208894e5719c2742a8472f6d09", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4f21ef981a4feb208894e5719c2742a8472f6d09", "committedDate": "2020-09-07T11:22:11Z", "message": "Update AuthScimEvent\n\nUpdate AuthScimEvent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92ba443573d64ac753e60e2c9d8809f2ab5b9d3d", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/92ba443573d64ac753e60e2c9d8809f2ab5b9d3d", "committedDate": "2020-09-07T11:46:58Z", "message": "Added test for SIGNIN_FAILED, Code Format + Organize Imports\n\nAdded test for SIGNIN_FAILED, Code Format + Organize Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b591a8348b1eea2271b45ff3f14b136872a0a24", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3b591a8348b1eea2271b45ff3f14b136872a0a24", "committedDate": "2020-09-07T13:09:49Z", "message": "Added Audit log test cases\n\nAdded Audit log test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f7fc91a1df1139e152dde98feff615a57cb278f7", "committedDate": "2020-09-07T13:19:07Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDYxMTYx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#pullrequestreview-486061161", "createdAt": "2020-09-10T15:33:28Z", "commit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTozMzoyOFrOHP53RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMDo0NFrOHP7CoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzODcyNA==", "bodyText": "remove please", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486438724", "createdAt": "2020-09-10T15:33:28Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -279,21 +293,27 @@ private String redirectToLoginOrAutoLoginPage(\n     if (StringUtils.isNotEmpty(tempRegId)) {\n       Optional<UserEntity> optUser = userService.findUserByTempRegId(tempRegId);\n       if (optUser.isPresent()) {\n+        // log TEMPORARY_PASSWORD_SUCCEEDED audit log event", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzOTQyMA==", "bodyText": "this looks out of scope, shouldn't it be moved to line 304?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486439420", "createdAt": "2020-09-10T15:34:28Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -279,21 +293,27 @@ private String redirectToLoginOrAutoLoginPage(\n     if (StringUtils.isNotEmpty(tempRegId)) {\n       Optional<UserEntity> optUser = userService.findUserByTempRegId(tempRegId);\n       if (optUser.isPresent()) {\n+        // log TEMPORARY_PASSWORD_SUCCEEDED audit log event\n+\n         UserEntity user = optUser.get();\n         logger.exit(\"tempRegId is valid, return to auto login page\");\n         cookieHelper.addCookie(response, USER_ID_COOKIE, user.getUserId());\n         cookieHelper.addCookie(response, TEMP_REG_ID_COOKIE, tempRegId);\n         return AUTO_LOGIN_VIEW_NAME;\n       }\n-\n       logger.exit(\"tempRegId is invalid, return to login page\");\n       return LOGIN_VIEW_NAME;\n     }\n+    auditHelper.logEvent(SIGNIN_FAILED_INVALID_TEMPORARY_PASSWORD, auditRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1MzE4Ng==", "bodyText": "put Instant.now().toEpochMilli() in a variable and use it for audit log.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486453186", "createdAt": "2020-09-10T15:53:46Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -360,31 +401,29 @@ private AuthenticationResponse updateInvalidLoginAttempts(\n       sendAccountLockedEmail(userEntity, tempPassword);\n       userEntity.setStatus(UserAccountStatus.ACCOUNT_LOCKED.getStatus());\n       userInfo.put(ACCOUNT_LOCK_EMAIL_TIMESTAMP, Instant.now().toEpochMilli());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NTE1OQ==", "bodyText": "why was this part removed?\nAnything other than audit log integration is outside of the scope of this PR and should be remove to a separate PR with proper description and test coverage.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486455159", "createdAt": "2020-09-10T15:56:35Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -360,31 +401,29 @@ private AuthenticationResponse updateInvalidLoginAttempts(\n       sendAccountLockedEmail(userEntity, tempPassword);\n       userEntity.setStatus(UserAccountStatus.ACCOUNT_LOCKED.getStatus());\n       userInfo.put(ACCOUNT_LOCK_EMAIL_TIMESTAMP, Instant.now().toEpochMilli());\n+\n+      Map<String, String> placeHolders = new HashMap<>();\n+      placeHolders.put(\"lock_time\", Instant.now().toString());\n+      placeHolders.put(\"failed_attempts\", String.valueOf(loginAttempts));\n+      auditHelper.logEvent(ACCOUNT_LOCKED, auditRequest, placeHolders);\n     }\n \n     userEntity.setUserInfo(userInfo);\n     userEntity = repository.saveAndFlush(userEntity);\n \n-    errorCode =\n+    ErrorCode errorCode =\n         UserAccountStatus.ACCOUNT_LOCKED.equals(UserAccountStatus.valueOf(userEntity.getStatus()))\n             ? ErrorCode.ACCOUNT_LOCKED\n-            : errorCode;\n+            : ErrorCode.INVALID_LOGIN_CREDENTIALS;\n \n     throw new ErrorCodeException(errorCode);\n   }\n \n   private AuthenticationResponse updateLoginAttemptsAndAuthenticationTime(\n-      UserEntity userEntity, JsonNode userInfoJsonNode) {\n+      UserEntity userEntity, JsonNode userInfoJsonNode, AuditLogEventRequest auditRequest) {\n+    int accountStatus = userEntity.getStatus();\n     ObjectNode passwordNode = (ObjectNode) userInfoJsonNode.get(PASSWORD);\n-    UserAccountStatus status = UserAccountStatus.valueOf(userEntity.getStatus());\n     passwordNode.remove(EXPIRE_TIMESTAMP);\n-    if (UserAccountStatus.PASSWORD_RESET.equals(status)\n-        || UserAccountStatus.ACCOUNT_LOCKED.equals(status)) {\n-      passwordNode.remove(EXPIRE_TIMESTAMP);\n-      passwordNode.put(OTP_USED, true);\n-    } else {\n-      passwordNode.remove(OTP_USED);\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 222}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NjIwOQ==", "bodyText": "why is this related to signin with temporary password?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486456209", "createdAt": "2020-09-10T15:58:08Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -395,26 +434,40 @@ private AuthenticationResponse updateLoginAttemptsAndAuthenticationTime(\n     userEntity.setUserInfo(userInfo);\n     userEntity = repository.saveAndFlush(userEntity);\n \n+    if (UserAccountStatus.ACTIVE.getStatus() != accountStatus) {\n+      auditHelper.logEvent(SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED, auditRequest);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 232}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NjkwMQ==", "bodyText": "code change is out of scope of this PR, please move to a separate PR with detailed description + test coverage.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486456901", "createdAt": "2020-09-10T15:59:04Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -395,26 +434,40 @@ private AuthenticationResponse updateLoginAttemptsAndAuthenticationTime(\n     userEntity.setUserInfo(userInfo);\n     userEntity = repository.saveAndFlush(userEntity);\n \n+    if (UserAccountStatus.ACTIVE.getStatus() != accountStatus) {\n+      auditHelper.logEvent(SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED, auditRequest);\n+    }\n+\n     AuthenticationResponse authenticationResponse = new AuthenticationResponse();\n     authenticationResponse.setUserId(userEntity.getUserId());\n     authenticationResponse.setAccountStatus(userEntity.getStatus());\n     authenticationResponse.setHttpStatusCode(HttpStatus.OK.value());\n     return authenticationResponse;\n   }\n \n-  private ErrorCode validatePasswordExpiryAndAccountStatus(\n-      UserEntity userEntity, JsonNode userInfo) {\n+  private void validatePasswordExpiryAndAccountStatus(\n+      UserEntity userEntity, JsonNode userInfo, AuditLogEventRequest auditRequest) {\n     JsonNode passwordNode = userInfo.get(PASSWORD);\n+    boolean passwordExpired = isPasswordExpired(passwordNode);\n     UserAccountStatus accountStatus = UserAccountStatus.valueOf(userEntity.getStatus());\n     switch (accountStatus) {\n       case DEACTIVATED:\n-        return ErrorCode.ACCOUNT_DEACTIVATED;\n+        throw new ErrorCodeException(ErrorCode.ACCOUNT_DEACTIVATED);\n       case ACCOUNT_LOCKED:\n-        return isPasswordExpired(passwordNode) ? ErrorCode.TEMP_PASSWORD_EXPIRED : null;\n+        if (passwordExpired) {\n+          auditHelper.logEvent(SIGNIN_FAILED_EXPIRED_TEMPORARY_PASSWORD, auditRequest);\n+          throw new ErrorCodeException(ErrorCode.TEMP_PASSWORD_EXPIRED);\n+        }\n       case PASSWORD_RESET:\n-        return isPasswordExpired(passwordNode) ? ErrorCode.TEMP_PASSWORD_EXPIRED : null;\n+        if (passwordExpired) {\n+          auditHelper.logEvent(SIGNIN_FAILED_EXPIRED_TEMPORARY_PASSWORD, auditRequest);\n+          throw new ErrorCodeException(ErrorCode.TEMP_PASSWORD_EXPIRED);\n+        }\n       default:\n-        return isPasswordExpired(passwordNode) ? ErrorCode.PASSWORD_EXPIRED : null;\n+        if (passwordExpired) {\n+          auditHelper.logEvent(SIGNIN_FAILED_EXPIRED_PASSWORD, auditRequest);\n+          throw new ErrorCodeException(ErrorCode.PASSWORD_EXPIRED);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 269}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1ODAxNg==", "bodyText": "Is there no validation that these values match our components?\nplease file a bug to add proper validation for enum values.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r486458016", "createdAt": "2020-09-10T16:00:44Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/ConsentControllerTest.java", "diffHunk": "@@ -65,9 +73,37 @@ public void shouldReturnLoginPage() throws Exception {\n         .andReturn();\n   }\n \n+  @Test\n+  public void shouldReturnErrorPage() throws Exception {\n+    MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.CONSENT_PAGE.getPath())\n+                .headers(getCommonHeaders())\n+                .contextPath(getContextPath())\n+                .queryParams(queryParams))\n+        .andDo(print())\n+        .andExpect(view().name(ERROR_VIEW_NAME));\n+\n+    verifyAuditEventCall(SIGNIN_FAILED);\n+  }\n+\n   private MultiValueMap<String, String> getConsentQSParams() {\n     MultiValueMap<String, String> requestParams = new LinkedMultiValueMap<>();\n     requestParams.add(CONSENT_CHALLENGE, CONSENT_CHALLENGE_VALUE);\n     return requestParams;\n   }\n+\n+  private HttpHeaders getCommonHeaders() {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+    headers.set(\"Content-Type\", \"application/x-www-form-urlencoded;charset=UTF-8\");\n+    headers.add(AUTHORIZATION, VALID_BEARER_TOKEN);\n+    headers.add(\"appVersion\", \"1.0\");\n+    headers.add(\"appId\", \"GCPMS001\");\n+    headers.add(\"studyId\", \"MyStudies\");\n+    headers.add(\"source\", \"IntegrationTests\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7fc91a1df1139e152dde98feff615a57cb278f7"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48e7d4544b58fc75b4e77bbe7b2d19010d3f43fa", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/48e7d4544b58fc75b4e77bbe7b2d19010d3f43fa", "committedDate": "2020-09-18T09:10:15Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34bb2c82525ab220a18fea2bae0a7b7965c1f8cf", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/34bb2c82525ab220a18fea2bae0a7b7965c1f8cf", "committedDate": "2020-09-18T09:20:32Z", "message": "Added systemTime\n\nsystemTime variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8678e744678450e8750a9f1a242b186235e5c7f6", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8678e744678450e8750a9f1a242b186235e5c7f6", "committedDate": "2020-09-21T14:39:36Z", "message": "Modified as per PR 899, comment\n\nModified as per PR 899, comment.\nModified appid,\nRemoved duplicate event,\nSetting all required header values in one common method getCommonHeaders();"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e130ba3506f8fc6d016831508fbd7c7501468cf", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9e130ba3506f8fc6d016831508fbd7c7501468cf", "committedDate": "2020-09-21T14:46:23Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b873375b90d3341ff8c43c194985aa1d85b8c3d3", "committedDate": "2020-09-21T14:54:17Z", "message": "Added import MvcResult\n\nAdded import MvcResult"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODY3MzE1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#pullrequestreview-492867315", "createdAt": "2020-09-21T18:17:17Z", "commit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODoxNzoxN1rOHVc9cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODoyMjoxNlrOHVdIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1NjYyNA==", "bodyText": "description seems redundant", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r492256624", "createdAt": "2020-09-21T18:17:17Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimEvent.java", "diffHunk": "@@ -18,19 +18,111 @@\n \n @Getter\n public enum AuthScimEvent implements AuditLogEvent {\n-  PASSWORD_RESET_SUCCESS(\n+  SIGNIN_SUCCEEDED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_SUCCEEDED\"),\n+\n+  SIGNIN_FAILED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED\"),\n+\n+  SIGNIN_FAILED_UNREGISTERED_USER(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"Sign-in failure due to unregistered username.\",\n+      \"SIGNIN_FAILED_UNREGISTERED_USER\"),\n+\n+  SIGNIN_FAILED_INVALID_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_INVALID_PASSWORD\"),\n+\n+  SIGNIN_FAILED_EXPIRED_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_EXPIRED_PASSWORD\"),\n+\n+  PASSWORD_HELP_REQUESTED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_REQUESTED\"),\n+\n+  PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME(\n+      null,\n+      SCIM_AUTH_SERVER,\n       PARTICIPANT_DATASTORE,\n+      null,\n+      \"PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME\"),\n+\n+  PASSWORD_HELP_EMAIL_SENT(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_SENT\"),\n+\n+  PASSWORD_HELP_EMAIL_FAILED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_FAILED\"),\n+\n+  SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"User signed in with temporary password.\",\n+      \"SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED\"),\n+\n+  SIGNIN_WITH_TEMPORARY_PASSWORD_FAILED(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"Sign-in with temporary password failed.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1Njc1OA==", "bodyText": "description seems redundant.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r492256758", "createdAt": "2020-09-21T18:17:32Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimEvent.java", "diffHunk": "@@ -18,19 +18,111 @@\n \n @Getter\n public enum AuthScimEvent implements AuditLogEvent {\n-  PASSWORD_RESET_SUCCESS(\n+  SIGNIN_SUCCEEDED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_SUCCEEDED\"),\n+\n+  SIGNIN_FAILED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED\"),\n+\n+  SIGNIN_FAILED_UNREGISTERED_USER(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"Sign-in failure due to unregistered username.\",\n+      \"SIGNIN_FAILED_UNREGISTERED_USER\"),\n+\n+  SIGNIN_FAILED_INVALID_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_INVALID_PASSWORD\"),\n+\n+  SIGNIN_FAILED_EXPIRED_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_EXPIRED_PASSWORD\"),\n+\n+  PASSWORD_HELP_REQUESTED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_REQUESTED\"),\n+\n+  PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME(\n+      null,\n+      SCIM_AUTH_SERVER,\n       PARTICIPANT_DATASTORE,\n+      null,\n+      \"PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME\"),\n+\n+  PASSWORD_HELP_EMAIL_SENT(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_SENT\"),\n+\n+  PASSWORD_HELP_EMAIL_FAILED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_FAILED\"),\n+\n+  SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"User signed in with temporary password.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1NjkyMg==", "bodyText": "description is redundant.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r492256922", "createdAt": "2020-09-21T18:17:48Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimEvent.java", "diffHunk": "@@ -18,19 +18,111 @@\n \n @Getter\n public enum AuthScimEvent implements AuditLogEvent {\n-  PASSWORD_RESET_SUCCESS(\n+  SIGNIN_SUCCEEDED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_SUCCEEDED\"),\n+\n+  SIGNIN_FAILED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED\"),\n+\n+  SIGNIN_FAILED_UNREGISTERED_USER(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      \"Sign-in failure due to unregistered username.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1OTEzMw==", "bodyText": "to me it seems like PASSWORD_RESET_SUCCEEDED should only be posted when a password has been reset successfully by the user. from the code it seems like we are logging this event when the account is still locked and/or not properly setup.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r492259133", "createdAt": "2020-09-21T18:21:43Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -193,17 +212,26 @@ public ResetPasswordResponse resetPassword(\n     EmailResponse emailResponse = sendPasswordResetEmail(resetPasswordRequest, tempPassword);\n \n     if (HttpStatus.ACCEPTED.value() == emailResponse.getHttpStatusCode()) {\n-\n       ObjectNode userInfo = (ObjectNode) userEntity.getUserInfo();\n       setPasswordAndPasswordHistoryFields(tempPassword, userInfo, userEntity.getStatus());\n       userEntity.setUserInfo(userInfo);\n       repository.saveAndFlush(userEntity);\n+      auditHelper.logEvent(PASSWORD_HELP_EMAIL_SENT, auditRequest);\n+      if (userEntity.getStatus() == UserAccountStatus.ACCOUNT_LOCKED.getStatus()) {\n+        auditHelper.logEvent(PASSWORD_RESET_EMAIL_SENT_FOR_LOCKED_ACCOUNT, auditRequest);\n+      }\n+\n+      auditHelper.logEvent(PASSWORD_RESET_SUCCEEDED, auditRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1OTQ3NA==", "bodyText": "remove redundant comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r492259474", "createdAt": "2020-09-21T18:22:16Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -291,13 +322,16 @@ private ErrorCode validateChangePasswordRequest(\n \n   @Override\n   @Transactional(noRollbackFor = ErrorCodeException.class)\n-  public AuthenticationResponse authenticate(UserRequest user) throws JsonProcessingException {\n+  public AuthenticationResponse authenticate(UserRequest user, AuditLogEventRequest auditRequest)\n+      throws JsonProcessingException {\n     logger.entry(\"begin authenticate(user)\");\n     // check if the email present in the database\n     Optional<UserEntity> optUserEntity =\n         repository.findByAppIdAndEmail(user.getAppId(), user.getEmail());\n \n     if (!optUserEntity.isPresent()) {\n+      // log SIGNIN_FAILED_UNREGISTERED_USER event", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b873375b90d3341ff8c43c194985aa1d85b8c3d3"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa4fed52122a98c34425862f486641d51e005011", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aa4fed52122a98c34425862f486641d51e005011", "committedDate": "2020-09-22T10:31:46Z", "message": "Removed Redundant description and commented lines\n\nRemoved Redundant description and commented lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2196534a2143a23af3bbccd4c09409b003928685", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2196534a2143a23af3bbccd4c09409b003928685", "committedDate": "2020-09-24T09:11:48Z", "message": "Added validation for mobilePlatform and source component value\n\nAdded validation for mobilePlatform and source component value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f46d9ee0dc8df4f930bc0e475d14d05e4ce131", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/00f46d9ee0dc8df4f930bc0e475d14d05e4ce131", "committedDate": "2020-09-24T09:52:42Z", "message": "Fixed build issue\n\nFixed build issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a91858d81d26f0456c3f3bbaa3ba5f401ba94c", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/30a91858d81d26f0456c3f3bbaa3ba5f401ba94c", "committedDate": "2020-09-24T10:09:38Z", "message": "Merge branch 'oauth-service-audit-log-impl' of https://github.com/GoogleCloudPlatform/fda-mystudies into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6167934943ada197bb1032c2c42270e361ead1e8", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6167934943ada197bb1032c2c42270e361ead1e8", "committedDate": "2020-09-24T11:48:30Z", "message": "Fixed build issues for OAuth Scim Service\n\nFixed build issues for OAuth Scim Service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41eeba0717508e3a8033b3b4fb3dc06781b264a3", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/41eeba0717508e3a8033b3b4fb3dc06781b264a3", "committedDate": "2020-09-24T11:58:30Z", "message": "Merge branch 'oauth-service-audit-log-impl' of https://github.com/GoogleCloudPlatform/fda-mystudies into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257756ea117ee73ef27e97408f1934b2d5af2428", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/257756ea117ee73ef27e97408f1934b2d5af2428", "committedDate": "2020-09-24T12:14:37Z", "message": "Moved audit log event to usercontroller\n\nMoved audit log event to usercontroller\n+ modified source of different modules."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd728d4f59b29f9507c55464eb1a8c6da29b4982", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cd728d4f59b29f9507c55464eb1a8c6da29b4982", "committedDate": "2020-09-24T13:22:29Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46fb239ad3f5cd9853f702ebfb3e112d37d64a6", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f46fb239ad3f5cd9853f702ebfb3e112d37d64a6", "committedDate": "2020-09-24T14:10:55Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0b20b73e90bb6b6fa1adf5bf26873caa15ce95d", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f0b20b73e90bb6b6fa1adf5bf26873caa15ce95d", "committedDate": "2020-09-24T15:47:56Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a949b1c6e93086bf5619ac93d4cfa93cb938d4ac", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a949b1c6e93086bf5619ac93d4cfa93cb938d4ac", "committedDate": "2020-09-24T16:07:30Z", "message": "Updated correct source for response server\n\nUpdated correct source for response server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c09955e39871980761bbb846f31cea1a7f02a9d", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1c09955e39871980761bbb846f31cea1a7f02a9d", "committedDate": "2020-09-25T07:08:59Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1522c2be5a45fac676ed8ca3c5e7141b1d2a0b12", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1522c2be5a45fac676ed8ca3c5e7141b1d2a0b12", "committedDate": "2020-09-25T10:48:27Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTU1NTc1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#pullrequestreview-496555575", "createdAt": "2020-09-25T16:04:54Z", "commit": {"oid": "1522c2be5a45fac676ed8ca3c5e7141b1d2a0b12"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjowNDo1NFrOHYJwpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxMDoxMFrOHYJ8MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4Nzc4Mg==", "bodyText": "description is redundant.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r495087782", "createdAt": "2020-09-25T16:04:54Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimEvent.java", "diffHunk": "@@ -18,19 +18,103 @@\n \n @Getter\n public enum AuthScimEvent implements AuditLogEvent {\n-  PASSWORD_RESET_SUCCESS(\n+  SIGNIN_SUCCEEDED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_SUCCEEDED\"),\n+\n+  SIGNIN_FAILED(null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED\"),\n+\n+  SIGNIN_FAILED_UNREGISTERED_USER(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_UNREGISTERED_USER\"),\n+\n+  SIGNIN_FAILED_INVALID_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_INVALID_PASSWORD\"),\n+\n+  SIGNIN_FAILED_EXPIRED_PASSWORD(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_FAILED_EXPIRED_PASSWORD\"),\n+\n+  PASSWORD_HELP_REQUESTED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_REQUESTED\"),\n+\n+  PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME(\n+      null,\n+      SCIM_AUTH_SERVER,\n+      PARTICIPANT_DATASTORE,\n+      null,\n+      \"PASSWORD_HELP_REQUESTED_FOR_UNREGISTERED_USERNAME\"),\n+\n+  PASSWORD_HELP_EMAIL_SENT(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_SENT\"),\n+\n+  PASSWORD_HELP_EMAIL_FAILED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"PASSWORD_HELP_EMAIL_FAILED\"),\n+\n+  SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED(\n+      null,\n+      SCIM_AUTH_SERVER,\n       PARTICIPANT_DATASTORE,\n+      null,\n+      \"SIGNIN_WITH_TEMPORARY_PASSWORD_SUCCEEDED\"),\n+\n+  SIGNIN_WITH_TEMPORARY_PASSWORD_FAILED(\n+      null, SCIM_AUTH_SERVER, PARTICIPANT_DATASTORE, null, \"SIGNIN_WITH_TEMPORARY_PASSWORD_FAILED\"),\n+\n+  SIGNIN_FAILED_EXPIRED_TEMPORARY_PASSWORD(\n+      null,\n       SCIM_AUTH_SERVER,\n       PARTICIPANT_DATASTORE,\n-      \"Password reset successful.\",\n-      \"PASSWORD_RESET_SUCCESS\"),\n+      \"Sign-in failure due to expired temporary password.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1522c2be5a45fac676ed8ca3c5e7141b1d2a0b12"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MDczNw==", "bodyText": "do we need to log both PASSWORD_HELP_EMAIL_FAILED and PASSWORD_HELP_EMAIL_FAILED for this case?\nand similarly for the success, do we need to log both PASSWORD_HELP_EMAIL_SENT and PASSWORD_RESET_EMAIL_SENT_FOR_LOCKED_ACCOUNT when account is locked?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#discussion_r495090737", "createdAt": "2020-09-25T16:10:10Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -193,17 +211,25 @@ public ResetPasswordResponse resetPassword(\n     EmailResponse emailResponse = sendPasswordResetEmail(resetPasswordRequest, tempPassword);\n \n     if (HttpStatus.ACCEPTED.value() == emailResponse.getHttpStatusCode()) {\n-\n       ObjectNode userInfo = (ObjectNode) userEntity.getUserInfo();\n       setPasswordAndPasswordHistoryFields(tempPassword, userInfo, userEntity.getStatus());\n       userEntity.setUserInfo(userInfo);\n       repository.saveAndFlush(userEntity);\n+      auditHelper.logEvent(PASSWORD_HELP_EMAIL_SENT, auditRequest);\n+      if (userEntity.getStatus() == UserAccountStatus.ACCOUNT_LOCKED.getStatus()) {\n+        auditHelper.logEvent(PASSWORD_RESET_EMAIL_SENT_FOR_LOCKED_ACCOUNT, auditRequest);\n+      }\n+\n       logger.exit(MessageCode.PASSWORD_RESET_SUCCESS);\n-      auditHelper.logEvent(PASSWORD_RESET_SUCCESS, auditRequest);\n       return new ResetPasswordResponse(MessageCode.PASSWORD_RESET_SUCCESS);\n-    } else {\n-      auditHelper.logEvent(PASSWORD_RESET_FAILED, auditRequest);\n     }\n+\n+    auditHelper.logEvent(PASSWORD_HELP_EMAIL_FAILED, auditRequest);\n+    auditHelper.logEvent(PASSWORD_RESET_FAILED, auditRequest);\n+    if (userEntity.getStatus() == UserAccountStatus.ACCOUNT_LOCKED.getStatus()) {\n+      auditHelper.logEvent(PASSWORD_RESET_EMAIL_FAILED_FOR_LOCKED_ACCOUNT, auditRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1522c2be5a45fac676ed8ca3c5e7141b1d2a0b12"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23bfe64f18d93ac12e16d848e1b616df26a1870f", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/23bfe64f18d93ac12e16d848e1b616df26a1870f", "committedDate": "2020-09-25T16:14:58Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3de6e819fd414f0725ba0c739eb8c66d9ac635c6", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3de6e819fd414f0725ba0c739eb8c66d9ac635c6", "committedDate": "2020-09-25T16:48:25Z", "message": "added validation for (PASSWORD_HELP_EMAIL_SENT\n\nadded validation for ( (PASSWORD_HELP_EMAIL_SENT,\nand test cases."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8613254e23da74ae7404edbc11eff90c62417f3e", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8613254e23da74ae7404edbc11eff90c62417f3e", "committedDate": "2020-09-25T17:01:43Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31c85863e83998006a684d47b2d82ff290f365cc", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/31c85863e83998006a684d47b2d82ff290f365cc", "committedDate": "2020-09-25T17:09:40Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjAyMzkz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/899#pullrequestreview-496602393", "createdAt": "2020-09-25T17:12:07Z", "commit": {"oid": "31c85863e83998006a684d47b2d82ff290f365cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c3e95ca9ff74b39263d8ef8ed402bc1ef2850a5", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c3e95ca9ff74b39263d8ef8ed402bc1ef2850a5", "committedDate": "2020-09-25T17:23:35Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb822a3f2e2f09979dd7f7ff239272bf71e9683c", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bb822a3f2e2f09979dd7f7ff239272bf71e9683c", "committedDate": "2020-09-25T17:42:26Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752d00dbcdf25850275e1977f3d7ef5dc045b04f", "author": {"user": {"login": "harisboston", "name": "Haris Hasan"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/752d00dbcdf25850275e1977f3d7ef5dc045b04f", "committedDate": "2020-09-25T17:49:30Z", "message": "Merge branch 'develop' into oauth-service-audit-log-impl"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 460, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}