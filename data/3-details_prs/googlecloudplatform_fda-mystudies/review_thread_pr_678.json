{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTk2NTMx", "number": 678, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoxMTowN1rOETfgwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyOTozNFrOETftMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc0NjkwOnYy", "diffSide": "RIGHT", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoxMTowN1rOG5QhXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowMTo1MVrOG5YT8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5MjcwMQ==", "bodyText": "Reactivate", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462692701", "createdAt": "2020-07-30T02:11:07Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -135,7 +135,19 @@\n       \"EC_885\",\n       Constants.BAD_REQUEST,\n       \"This Site is associated with active and enrolled participants\"\n-          + \" and cannot be decomissioned\");\n+          + \" and cannot be decomissioned\"),\n+\n+  NOT_SUPER_ADMIN_ACCESS(\n+      403,\n+      \"EC_870\",\n+      HttpStatus.FORBIDDEN.toString(),\n+      \"You are not authorized to access this information\"),\n+\n+  PERMISSION_MISSING(\n+      400, \"EC_978\", Constants.BAD_REQUEST, \"Admin should have atleast one permission\"),\n+\n+  CANNOT_REACTIVE(\n+      400, \"EC_887\", Constants.BAD_REQUEST, \"Can't reactive an already active location\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMDMzNw==", "bodyText": "removed CANNOT_REACTIVE and used CANNOT_REACTIVATE.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462820337", "createdAt": "2020-07-30T08:01:51Z", "author": {"login": "chiranjibi009"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -135,7 +135,19 @@\n       \"EC_885\",\n       Constants.BAD_REQUEST,\n       \"This Site is associated with active and enrolled participants\"\n-          + \" and cannot be decomissioned\");\n+          + \" and cannot be decomissioned\"),\n+\n+  NOT_SUPER_ADMIN_ACCESS(\n+      403,\n+      \"EC_870\",\n+      HttpStatus.FORBIDDEN.toString(),\n+      \"You are not authorized to access this information\"),\n+\n+  PERMISSION_MISSING(\n+      400, \"EC_978\", Constants.BAD_REQUEST, \"Admin should have atleast one permission\"),\n+\n+  CANNOT_REACTIVE(\n+      400, \"EC_887\", Constants.BAD_REQUEST, \"Can't reactive an already active location\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5MjcwMQ=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc1MDIwOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/LocationServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoxMzowOVrOG5QjVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowMzoxOVrOG5YWyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5MzIwNw==", "bodyText": "Why this change", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462693207", "createdAt": "2020-07-30T02:13:09Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/LocationServiceImpl.java", "diffHunk": "@@ -159,7 +156,7 @@ private ErrorCode validateUpdateLocationRequest(\n \n     if (ACTIVE_STATUS.equals(locationRequest.getStatus())\n         && ACTIVE_STATUS.equals(locationEntity.getStatus())) {\n-      return ErrorCode.CANNOT_REACTIVATE;\n+      return ErrorCode.CANNOT_REACTIVE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMTA2Ng==", "bodyText": "test cases were failing, hence changed to CANNOT_REACTIVE.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462821066", "createdAt": "2020-07-30T08:03:19Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/LocationServiceImpl.java", "diffHunk": "@@ -159,7 +156,7 @@ private ErrorCode validateUpdateLocationRequest(\n \n     if (ACTIVE_STATUS.equals(locationRequest.getStatus())\n         && ACTIVE_STATUS.equals(locationEntity.getStatus())) {\n-      return ErrorCode.CANNOT_REACTIVATE;\n+      return ErrorCode.CANNOT_REACTIVE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5MzIwNw=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc1NzEzOnYy", "diffSide": "LEFT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoxNzowNlrOG5QnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowNjo1MVrOG5YeYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NDIzNA==", "bodyText": "any reason for this change here?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462694234", "createdAt": "2020-07-30T02:17:06Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -126,7 +122,6 @@ public LocationEntity createLocation() {\n     LocationEntity locationEntity = newLocationEntity();\n     SiteEntity siteEntity = newSiteEntity();\n     locationEntity.addSiteEntity(siteEntity);\n-    siteEntity.setStudy(newStudyEntity());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzAwOQ==", "bodyText": "siteEntity is already set at line number 124, hence there is no point of setting values for siteEntity.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823009", "createdAt": "2020-07-30T08:06:51Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -126,7 +122,6 @@ public LocationEntity createLocation() {\n     LocationEntity locationEntity = newLocationEntity();\n     SiteEntity siteEntity = newSiteEntity();\n     locationEntity.addSiteEntity(siteEntity);\n-    siteEntity.setStudy(newStudyEntity());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NDIzNA=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc2NzI1OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyMjo1OVrOG5QtSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowNzoxN1rOG5YfSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NTc1Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UserRegAdminEntity superAdminDeatils =\n          \n          \n            \n                UserRegAdminEntity superAdminDetails =", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462695753", "createdAt": "2020-07-30T02:22:59Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzI0MA==", "bodyText": "typo fixed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823240", "createdAt": "2020-07-30T08:07:17Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NTc1Mw=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 148}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3MTE4OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyNTowNVrOG5Qviw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowNzozMVrOG5YfzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjMzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  UserRequest user, UserRegAdminEntity superAdminDeatils) {\n          \n          \n            \n                  UserRequest user, UserRegAdminEntity superAdminDetails) {", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462696331", "createdAt": "2020-07-30T02:25:05Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzM3Mw==", "bodyText": "typo fixed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823373", "createdAt": "2020-07-30T08:07:31Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjMzMQ=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 170}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3MTU2OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyNToxOVrOG5QvxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowNzo0N1rOG5YgXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjM4OA==", "bodyText": "typo here too", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462696388", "createdAt": "2020-07-30T02:25:19Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getSitePermissisonsForSuperAdmin()\");\n+    List<SiteEntity> sites =\n+        (List<SiteEntity>) CollectionUtils.emptyIfNull(siteRepository.findAll());\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    for (SiteEntity siteInfo : sites) {\n+      SitePermissionEntity sitePermission =\n+          UserMapper.newSitePermissionEntity(user, null, superAdminDeatils, siteInfo);\n+      sitePermissions.add(sitePermission);\n+    }\n+\n+    logger.exit(String.format(\"total site permissions=%d\", sitePermissions.size()));\n+    return sitePermissions;\n+  }\n+\n+  private List<StudyPermissionEntity> getStudyPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 186}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzUxNg==", "bodyText": "typo fixed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823516", "createdAt": "2020-07-30T08:07:47Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getSitePermissisonsForSuperAdmin()\");\n+    List<SiteEntity> sites =\n+        (List<SiteEntity>) CollectionUtils.emptyIfNull(siteRepository.findAll());\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    for (SiteEntity siteInfo : sites) {\n+      SitePermissionEntity sitePermission =\n+          UserMapper.newSitePermissionEntity(user, null, superAdminDeatils, siteInfo);\n+      sitePermissions.add(sitePermission);\n+    }\n+\n+    logger.exit(String.format(\"total site permissions=%d\", sitePermissions.size()));\n+    return sitePermissions;\n+  }\n+\n+  private List<StudyPermissionEntity> getStudyPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjM4OA=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 186}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3MTc4OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyNToyNVrOG5Qv5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowODowMVrOG5Yg5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjQyMg==", "bodyText": "typo here too", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462696422", "createdAt": "2020-07-30T02:25:25Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getSitePermissisonsForSuperAdmin()\");\n+    List<SiteEntity> sites =\n+        (List<SiteEntity>) CollectionUtils.emptyIfNull(siteRepository.findAll());\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    for (SiteEntity siteInfo : sites) {\n+      SitePermissionEntity sitePermission =\n+          UserMapper.newSitePermissionEntity(user, null, superAdminDeatils, siteInfo);\n+      sitePermissions.add(sitePermission);\n+    }\n+\n+    logger.exit(String.format(\"total site permissions=%d\", sitePermissions.size()));\n+    return sitePermissions;\n+  }\n+\n+  private List<StudyPermissionEntity> getStudyPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getStudyPermissisonsForSuperAdmin()\");\n+    List<StudyEntity> studies =\n+        (List<StudyEntity>) CollectionUtils.emptyIfNull(studyRepository.findAll());\n+    List<StudyPermissionEntity> studyPermissions = new ArrayList<>();\n+    for (StudyEntity studyInfo : studies) {\n+      StudyPermissionEntity studyPermission =\n+          UserMapper.newStudyPermissionEntity(user, superAdminDeatils, null, studyInfo);\n+      studyPermissions.add(studyPermission);\n+    }\n+\n+    logger.exit(String.format(\"total study permissions=%d\", studyPermissions.size()));\n+    return studyPermissions;\n+  }\n+\n+  private List<AppPermissionEntity> getAppPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 202}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzY1Mw==", "bodyText": "typo fixed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823653", "createdAt": "2020-07-30T08:08:01Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+import com.google.cloud.healthcare.fdamystudies.beans.AdminUserResponse;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.config.AppPropertyConfig;\n+import com.google.cloud.healthcare.fdamystudies.mapper.UserMapper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.AppRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserRegAdminRepository;\n+\n+@Service\n+public class ManageUserServiceImpl implements ManageUserService {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(ManageUserServiceImpl.class.getName());\n+\n+  @Autowired private UserRegAdminRepository userAdminRepository;\n+\n+  @Autowired private AppRepository appRepository;\n+\n+  @Autowired private StudyRepository studyRepository;\n+\n+  @Autowired private SiteRepository siteRepository;\n+\n+  @Autowired private AppPropertyConfig appConfig;\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse createUser(UserRequest user) {\n+    logger.entry(String.format(\"createUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUserRequest(user);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin() ? saveSuperAdminDetails(user) : saveAdminDetails(user);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUserRequest(UserRequest user) {\n+    logger.entry(\"validateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails =\n+        userAdminRepository.findById(user.getSuperAdminUserId());\n+    if (!optAdminDetails.isPresent()) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin()\n+        && (CollectionUtils.isEmpty(user.getApps()) || !hasAtleastOnePermission(user))) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+\n+    Optional<UserRegAdminEntity> optUsers = userAdminRepository.findByEmail(user.getEmail());\n+    logger.exit(\"Successfully validated user request\");\n+    return optUsers.isPresent() ? ErrorCode.EMAIL_EXISTS : null;\n+  }\n+\n+  private boolean hasAtleastOnePermission(UserRequest user) {\n+    logger.entry(\"hasAtleastOnePermission()\");\n+    Predicate<UserAppPermissionRequest> appPredicate = app -> app.isSelected();\n+    Predicate<UserStudyPermissionRequest> studyPredicate = study -> study.isSelected();\n+    Predicate<UserSitePermissionRequest> sitePredicate = site -> site.isSelected();\n+\n+    List<UserAppPermissionRequest> selectedApps =\n+        user.getApps().stream().filter(appPredicate).collect(Collectors.toList());\n+    if (CollectionUtils.isNotEmpty(selectedApps)) {\n+      return true;\n+    }\n+\n+    for (UserAppPermissionRequest appPermission : user.getApps()) {\n+      List<UserStudyPermissionRequest> selectedStudies =\n+          CollectionUtils.emptyIfNull(appPermission.getStudies())\n+              .stream()\n+              .filter(studyPredicate)\n+              .collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(selectedStudies)) {\n+        return true;\n+      }\n+\n+      for (UserStudyPermissionRequest studyPermission : appPermission.getStudies()) {\n+        List<UserSitePermissionRequest> selectedSites =\n+            CollectionUtils.emptyIfNull(studyPermission.getSites())\n+                .stream()\n+                .filter(sitePredicate)\n+                .collect(Collectors.toList());\n+        if (CollectionUtils.isNotEmpty(selectedSites)) {\n+          return true;\n+        }\n+      }\n+    }\n+\n+    logger.exit(\"No permissions found, return false\");\n+    return false;\n+  }\n+\n+  private AdminUserResponse saveAdminDetails(UserRequest user) {\n+    logger.entry(\"saveAdminDetails()\");\n+    UserRegAdminEntity adminDetails =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+    adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+    logger.exit(\"Successfully saved admin details.\");\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n+    logger.entry(\"saveSuperAdminDetails()\");\n+    UserRegAdminEntity superAdminDeatils =\n+        UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n+\n+    List<AppPermissionEntity> appPermissions =\n+        getAppPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, superAdminDeatils);\n+    superAdminDeatils.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.saveAndFlush(superAdminDeatils);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.ADD_NEW_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, superAdminDeatils.getId());\n+  }\n+\n+  private List<SitePermissionEntity> getSitePermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getSitePermissisonsForSuperAdmin()\");\n+    List<SiteEntity> sites =\n+        (List<SiteEntity>) CollectionUtils.emptyIfNull(siteRepository.findAll());\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    for (SiteEntity siteInfo : sites) {\n+      SitePermissionEntity sitePermission =\n+          UserMapper.newSitePermissionEntity(user, null, superAdminDeatils, siteInfo);\n+      sitePermissions.add(sitePermission);\n+    }\n+\n+    logger.exit(String.format(\"total site permissions=%d\", sitePermissions.size()));\n+    return sitePermissions;\n+  }\n+\n+  private List<StudyPermissionEntity> getStudyPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {\n+    logger.entry(\"getStudyPermissisonsForSuperAdmin()\");\n+    List<StudyEntity> studies =\n+        (List<StudyEntity>) CollectionUtils.emptyIfNull(studyRepository.findAll());\n+    List<StudyPermissionEntity> studyPermissions = new ArrayList<>();\n+    for (StudyEntity studyInfo : studies) {\n+      StudyPermissionEntity studyPermission =\n+          UserMapper.newStudyPermissionEntity(user, superAdminDeatils, null, studyInfo);\n+      studyPermissions.add(studyPermission);\n+    }\n+\n+    logger.exit(String.format(\"total study permissions=%d\", studyPermissions.size()));\n+    return studyPermissions;\n+  }\n+\n+  private List<AppPermissionEntity> getAppPermissisonsForSuperAdmin(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjQyMg=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 202}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3MzYyOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/LocationControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyNjoyM1rOG5Qw8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODowODozOVrOG5YiNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjY4OQ==", "bodyText": "Again why is this being changed in this PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462696689", "createdAt": "2020-07-30T02:26:23Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/LocationControllerTest.java", "diffHunk": "@@ -13,7 +13,7 @@\n import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.USER_ID_HEADER;\n import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.YES;\n import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.ALREADY_DECOMMISSIONED;\n-import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.CANNOT_REACTIVATE;\n+import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.CANNOT_REACTIVE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyMzk5MA==", "bodyText": "test cases were failing, hence changed to CANNOT_REACTIVE.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462823990", "createdAt": "2020-07-30T08:08:39Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/LocationControllerTest.java", "diffHunk": "@@ -13,7 +13,7 @@\n import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.USER_ID_HEADER;\n import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.YES;\n import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.ALREADY_DECOMMISSIONED;\n-import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.CANNOT_REACTIVATE;\n+import static com.google.cloud.healthcare.fdamystudies.common.ErrorCode.CANNOT_REACTIVE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjY4OQ=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3ODAxOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyOToxMFrOG5Qzug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODoxMToxMVrOG5Ynuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NzQwMg==", "bodyText": "Do we have Permission enums/CommonConstants for this", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462697402", "createdAt": "2020-07-30T02:29:10Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.mapper;\n+\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.commons.collections4.CollectionUtils;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+\n+public final class UserMapper {\n+\n+  private UserMapper() {}\n+\n+  public static UserRegAdminEntity fromUserRequest(\n+      UserRequest userRequest, long securityCodeExpireTime) {\n+    UserRegAdminEntity admin = new UserRegAdminEntity();\n+    admin.setEmail(userRequest.getEmail());\n+    admin.setFirstName(userRequest.getFirstName());\n+    admin.setLastName(userRequest.getLastName());\n+    admin.setCreatedBy(userRequest.getSuperAdminUserId());\n+    admin.setEmailChanged(false);\n+    admin.setStatus(CommonConstants.INVITED_STATUS); // 2-> Invited, 0-> Deactivated, 1-> Active\n+    admin.setSuperAdmin(userRequest.isSuperAdmin());\n+    admin.setSecurityCode(IdGenerator.id());\n+    admin.setSecurityCodeExpireDate(\n+        new Timestamp(\n+            Instant.now().plus(securityCodeExpireTime, ChronoUnit.MINUTES).toEpochMilli()));\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    admin.setEditPermission(manageLocation);\n+    return admin;\n+  }\n+\n+  public static UserRegAdminEntity fromUpdateUserRequest(\n+      UserRequest userRequest, UserRegAdminEntity adminDetails) {\n+    adminDetails.setEmail(userRequest.getEmail());\n+    adminDetails.setFirstName(userRequest.getFirstName());\n+    adminDetails.setLastName(userRequest.getLastName());\n+    adminDetails.setSuperAdmin(userRequest.isSuperAdmin());\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    adminDetails.setEditPermission(manageLocation);\n+    return adminDetails;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserSitePermissionRequest site,\n+      UserRegAdminEntity superAdminDeatils,\n+      SiteEntity siteDetails) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(siteDetails.getStudy().getAppInfo());\n+    sitePermission.setStudy(siteDetails.getStudy());\n+    sitePermission.setSite(siteDetails);\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = site != null && site.getPermission() == 1 ? 0 : 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyNTQwMw==", "bodyText": "Added Permission enum and CommonConstants for this.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462825403", "createdAt": "2020-07-30T08:11:11Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.mapper;\n+\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.commons.collections4.CollectionUtils;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+\n+public final class UserMapper {\n+\n+  private UserMapper() {}\n+\n+  public static UserRegAdminEntity fromUserRequest(\n+      UserRequest userRequest, long securityCodeExpireTime) {\n+    UserRegAdminEntity admin = new UserRegAdminEntity();\n+    admin.setEmail(userRequest.getEmail());\n+    admin.setFirstName(userRequest.getFirstName());\n+    admin.setLastName(userRequest.getLastName());\n+    admin.setCreatedBy(userRequest.getSuperAdminUserId());\n+    admin.setEmailChanged(false);\n+    admin.setStatus(CommonConstants.INVITED_STATUS); // 2-> Invited, 0-> Deactivated, 1-> Active\n+    admin.setSuperAdmin(userRequest.isSuperAdmin());\n+    admin.setSecurityCode(IdGenerator.id());\n+    admin.setSecurityCodeExpireDate(\n+        new Timestamp(\n+            Instant.now().plus(securityCodeExpireTime, ChronoUnit.MINUTES).toEpochMilli()));\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    admin.setEditPermission(manageLocation);\n+    return admin;\n+  }\n+\n+  public static UserRegAdminEntity fromUpdateUserRequest(\n+      UserRequest userRequest, UserRegAdminEntity adminDetails) {\n+    adminDetails.setEmail(userRequest.getEmail());\n+    adminDetails.setFirstName(userRequest.getFirstName());\n+    adminDetails.setLastName(userRequest.getLastName());\n+    adminDetails.setSuperAdmin(userRequest.isSuperAdmin());\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    adminDetails.setEditPermission(manageLocation);\n+    return adminDetails;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserSitePermissionRequest site,\n+      UserRegAdminEntity superAdminDeatils,\n+      SiteEntity siteDetails) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(siteDetails.getStudy().getAppInfo());\n+    sitePermission.setStudy(siteDetails.getStudy());\n+    sitePermission.setSite(siteDetails);\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = site != null && site.getPermission() == 1 ? 0 : 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NzQwMg=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODc3ODcyOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyOTozNFrOG5Q0KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODoxMToyNlrOG5YoRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NzUxMw==", "bodyText": "CAN_EDIT CommonConstants?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462697513", "createdAt": "2020-07-30T02:29:34Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.mapper;\n+\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.commons.collections4.CollectionUtils;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+\n+public final class UserMapper {\n+\n+  private UserMapper() {}\n+\n+  public static UserRegAdminEntity fromUserRequest(\n+      UserRequest userRequest, long securityCodeExpireTime) {\n+    UserRegAdminEntity admin = new UserRegAdminEntity();\n+    admin.setEmail(userRequest.getEmail());\n+    admin.setFirstName(userRequest.getFirstName());\n+    admin.setLastName(userRequest.getLastName());\n+    admin.setCreatedBy(userRequest.getSuperAdminUserId());\n+    admin.setEmailChanged(false);\n+    admin.setStatus(CommonConstants.INVITED_STATUS); // 2-> Invited, 0-> Deactivated, 1-> Active\n+    admin.setSuperAdmin(userRequest.isSuperAdmin());\n+    admin.setSecurityCode(IdGenerator.id());\n+    admin.setSecurityCodeExpireDate(\n+        new Timestamp(\n+            Instant.now().plus(securityCodeExpireTime, ChronoUnit.MINUTES).toEpochMilli()));\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    admin.setEditPermission(manageLocation);\n+    return admin;\n+  }\n+\n+  public static UserRegAdminEntity fromUpdateUserRequest(\n+      UserRequest userRequest, UserRegAdminEntity adminDetails) {\n+    adminDetails.setEmail(userRequest.getEmail());\n+    adminDetails.setFirstName(userRequest.getFirstName());\n+    adminDetails.setLastName(userRequest.getLastName());\n+    adminDetails.setSuperAdmin(userRequest.isSuperAdmin());\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    adminDetails.setEditPermission(manageLocation);\n+    return adminDetails;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserSitePermissionRequest site,\n+      UserRegAdminEntity superAdminDeatils,\n+      SiteEntity siteDetails) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(siteDetails.getStudy().getAppInfo());\n+    sitePermission.setStudy(siteDetails.getStudy());\n+    sitePermission.setSite(siteDetails);\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = site != null && site.getPermission() == 1 ? 0 : 1;\n+    sitePermission.setCanEdit(edit);\n+    sitePermission.setUrAdminUser(superAdminDeatils);\n+    return sitePermission;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserStudyPermissionRequest study,\n+      StudyEntity studyDetails,\n+      SiteEntity site) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(studyDetails.getAppInfo());\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = study.getPermission() == 1 ? 0 : 1;\n+    sitePermission.setCanEdit(edit);\n+    sitePermission.setStudy(studyDetails);\n+    sitePermission.setSite(site);\n+    sitePermission.setUrAdminUser(superAdminDeatils);\n+    return sitePermission;\n+  }\n+\n+  public static List<SitePermissionEntity> newSitePermissionList(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserAppPermissionRequest app,\n+      AppEntity appDetails,\n+      List<SiteEntity> sites) {\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    if (CollectionUtils.isNotEmpty(sites)) {\n+      for (SiteEntity siteEntity : sites) {\n+        SitePermissionEntity sitePermission = new SitePermissionEntity();\n+        sitePermission.setAppInfo(appDetails);\n+        sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+        int edit = app != null && app.getPermission() == 1 ? 0 : 1;\n+        sitePermission.setCanEdit(edit);\n+        sitePermission.setStudy(siteEntity.getStudy());\n+        sitePermission.setSite(siteEntity);\n+        sitePermission.setUrAdminUser(superAdminDeatils);\n+        sitePermissions.add(sitePermission);\n+      }\n+    }\n+\n+    return sitePermissions;\n+  }\n+\n+  public static StudyPermissionEntity newStudyPermissionEntity(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserStudyPermissionRequest study,\n+      StudyEntity studyDetails) {\n+    StudyPermissionEntity studyPermission = new StudyPermissionEntity();\n+    studyPermission.setAppInfo(studyDetails.getAppInfo());\n+    studyPermission.setStudy(studyDetails);\n+    studyPermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = study != null && study.getPermission() == 1 ? 0 : 1;\n+    studyPermission.setEdit(edit);\n+    studyPermission.setUrAdminUser(superAdminDeatils);\n+    return studyPermission;\n+  }\n+\n+  public static List<StudyPermissionEntity> newStudyPermissionList(\n+      UserRequest userRequest,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserAppPermissionRequest appRequest,\n+      AppEntity appDetails,\n+      List<StudyEntity> studies) {\n+    List<StudyPermissionEntity> studyPermissions = new ArrayList<>();\n+    if (CollectionUtils.isNotEmpty(studies)) {\n+      for (StudyEntity studyEntity : studies) {\n+        StudyPermissionEntity studyPermission = new StudyPermissionEntity();\n+        studyPermission.setAppInfo(appDetails);\n+        studyPermission.setCreatedBy(userRequest.getSuperAdminUserId());\n+        int edit = appRequest != null && appRequest.getPermission() == 1 ? 0 : 1;\n+        studyPermission.setEdit(edit);\n+        studyPermission.setStudy(studyEntity);\n+        studyPermission.setUrAdminUser(superAdminDeatils);\n+        studyPermissions.add(studyPermission);\n+      }\n+    }\n+    return studyPermissions;\n+  }\n+\n+  public static AppPermissionEntity newAppPermissionEntity(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils, AppEntity app) {\n+    AppPermissionEntity appPermission = new AppPermissionEntity();\n+    appPermission.setAppInfo(app);\n+    appPermission.setCreatedBy(user.getSuperAdminUserId());\n+    appPermission.setEdit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyNTU0MQ==", "bodyText": "Added CommonConstants for this.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/678#discussion_r462825541", "createdAt": "2020-07-30T08:11:26Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/UserMapper.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.mapper;\n+\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.commons.collections4.CollectionUtils;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserAppPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserSitePermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserStudyPermissionRequest;\n+import com.google.cloud.healthcare.fdamystudies.common.CommonConstants;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.AppPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+\n+public final class UserMapper {\n+\n+  private UserMapper() {}\n+\n+  public static UserRegAdminEntity fromUserRequest(\n+      UserRequest userRequest, long securityCodeExpireTime) {\n+    UserRegAdminEntity admin = new UserRegAdminEntity();\n+    admin.setEmail(userRequest.getEmail());\n+    admin.setFirstName(userRequest.getFirstName());\n+    admin.setLastName(userRequest.getLastName());\n+    admin.setCreatedBy(userRequest.getSuperAdminUserId());\n+    admin.setEmailChanged(false);\n+    admin.setStatus(CommonConstants.INVITED_STATUS); // 2-> Invited, 0-> Deactivated, 1-> Active\n+    admin.setSuperAdmin(userRequest.isSuperAdmin());\n+    admin.setSecurityCode(IdGenerator.id());\n+    admin.setSecurityCodeExpireDate(\n+        new Timestamp(\n+            Instant.now().plus(securityCodeExpireTime, ChronoUnit.MINUTES).toEpochMilli()));\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    admin.setEditPermission(manageLocation);\n+    return admin;\n+  }\n+\n+  public static UserRegAdminEntity fromUpdateUserRequest(\n+      UserRequest userRequest, UserRegAdminEntity adminDetails) {\n+    adminDetails.setEmail(userRequest.getEmail());\n+    adminDetails.setFirstName(userRequest.getFirstName());\n+    adminDetails.setLastName(userRequest.getLastName());\n+    adminDetails.setSuperAdmin(userRequest.isSuperAdmin());\n+    int manageLocation = userRequest.isSuperAdmin() ? 2 : userRequest.getManageLocations();\n+    adminDetails.setEditPermission(manageLocation);\n+    return adminDetails;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserSitePermissionRequest site,\n+      UserRegAdminEntity superAdminDeatils,\n+      SiteEntity siteDetails) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(siteDetails.getStudy().getAppInfo());\n+    sitePermission.setStudy(siteDetails.getStudy());\n+    sitePermission.setSite(siteDetails);\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = site != null && site.getPermission() == 1 ? 0 : 1;\n+    sitePermission.setCanEdit(edit);\n+    sitePermission.setUrAdminUser(superAdminDeatils);\n+    return sitePermission;\n+  }\n+\n+  public static SitePermissionEntity newSitePermissionEntity(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserStudyPermissionRequest study,\n+      StudyEntity studyDetails,\n+      SiteEntity site) {\n+    SitePermissionEntity sitePermission = new SitePermissionEntity();\n+    sitePermission.setAppInfo(studyDetails.getAppInfo());\n+    sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = study.getPermission() == 1 ? 0 : 1;\n+    sitePermission.setCanEdit(edit);\n+    sitePermission.setStudy(studyDetails);\n+    sitePermission.setSite(site);\n+    sitePermission.setUrAdminUser(superAdminDeatils);\n+    return sitePermission;\n+  }\n+\n+  public static List<SitePermissionEntity> newSitePermissionList(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserAppPermissionRequest app,\n+      AppEntity appDetails,\n+      List<SiteEntity> sites) {\n+    List<SitePermissionEntity> sitePermissions = new ArrayList<>();\n+    if (CollectionUtils.isNotEmpty(sites)) {\n+      for (SiteEntity siteEntity : sites) {\n+        SitePermissionEntity sitePermission = new SitePermissionEntity();\n+        sitePermission.setAppInfo(appDetails);\n+        sitePermission.setCreatedBy(user.getSuperAdminUserId());\n+        int edit = app != null && app.getPermission() == 1 ? 0 : 1;\n+        sitePermission.setCanEdit(edit);\n+        sitePermission.setStudy(siteEntity.getStudy());\n+        sitePermission.setSite(siteEntity);\n+        sitePermission.setUrAdminUser(superAdminDeatils);\n+        sitePermissions.add(sitePermission);\n+      }\n+    }\n+\n+    return sitePermissions;\n+  }\n+\n+  public static StudyPermissionEntity newStudyPermissionEntity(\n+      UserRequest user,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserStudyPermissionRequest study,\n+      StudyEntity studyDetails) {\n+    StudyPermissionEntity studyPermission = new StudyPermissionEntity();\n+    studyPermission.setAppInfo(studyDetails.getAppInfo());\n+    studyPermission.setStudy(studyDetails);\n+    studyPermission.setCreatedBy(user.getSuperAdminUserId());\n+    int edit = study != null && study.getPermission() == 1 ? 0 : 1;\n+    studyPermission.setEdit(edit);\n+    studyPermission.setUrAdminUser(superAdminDeatils);\n+    return studyPermission;\n+  }\n+\n+  public static List<StudyPermissionEntity> newStudyPermissionList(\n+      UserRequest userRequest,\n+      UserRegAdminEntity superAdminDeatils,\n+      UserAppPermissionRequest appRequest,\n+      AppEntity appDetails,\n+      List<StudyEntity> studies) {\n+    List<StudyPermissionEntity> studyPermissions = new ArrayList<>();\n+    if (CollectionUtils.isNotEmpty(studies)) {\n+      for (StudyEntity studyEntity : studies) {\n+        StudyPermissionEntity studyPermission = new StudyPermissionEntity();\n+        studyPermission.setAppInfo(appDetails);\n+        studyPermission.setCreatedBy(userRequest.getSuperAdminUserId());\n+        int edit = appRequest != null && appRequest.getPermission() == 1 ? 0 : 1;\n+        studyPermission.setEdit(edit);\n+        studyPermission.setStudy(studyEntity);\n+        studyPermission.setUrAdminUser(superAdminDeatils);\n+        studyPermissions.add(studyPermission);\n+      }\n+    }\n+    return studyPermissions;\n+  }\n+\n+  public static AppPermissionEntity newAppPermissionEntity(\n+      UserRequest user, UserRegAdminEntity superAdminDeatils, AppEntity app) {\n+    AppPermissionEntity appPermission = new AppPermissionEntity();\n+    appPermission.setAppInfo(app);\n+    appPermission.setCreatedBy(user.getSuperAdminUserId());\n+    appPermission.setEdit(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NzUxMw=="}, "originalCommit": {"oid": "9cbe97836f5661995bcc7ce3acc0e9aa5abfce12"}, "originalPosition": 164}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2025, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}