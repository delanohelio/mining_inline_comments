{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTQ4MDcy", "number": 669, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMzo0MzowN1rOESo6QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNDowOTo1NlrOESpL-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTgwMDk2OnYy", "diffSide": "RIGHT", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMzo0MzowN1rOG37d6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNTowODo0NlrOG38z4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5OTE3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  403, \"EC-989\", HttpStatus.FORBIDDEN.toString(), \"Can not add participant to open study\"),\n          \n          \n            \n                  403, \"EC-989\", HttpStatus.FORBIDDEN.toString(), \"Cannot add participant to open study\"),", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461299177", "createdAt": "2020-07-28T03:43:07Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -107,7 +107,19 @@\n       403, \"EC-882\", \"Forbidden\", \"You do not have permission to update the location\"),\n \n   STUDY_PERMISSION_ACCESS_DENIED(\n-      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"Does not have study permission\");\n+      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"Does not have study permission\"),\n+\n+  MANAGE_SITE_PERMISSION_ACCESS_DENIED(\n+      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"You do not have permission to manage site\"),\n+\n+  OPEN_STUDY(\n+      403, \"EC-989\", HttpStatus.FORBIDDEN.toString(), \"Can not add participant to open study\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyMTE4Ng==", "bodyText": "changes done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461321186", "createdAt": "2020-07-28T05:08:46Z", "author": {"login": "navya-BTC"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/ErrorCode.java", "diffHunk": "@@ -107,7 +107,19 @@\n       403, \"EC-882\", \"Forbidden\", \"You do not have permission to update the location\"),\n \n   STUDY_PERMISSION_ACCESS_DENIED(\n-      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"Does not have study permission\");\n+      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"Does not have study permission\"),\n+\n+  MANAGE_SITE_PERMISSION_ACCESS_DENIED(\n+      403, \"EC-105\", HttpStatus.FORBIDDEN.toString(), \"You do not have permission to manage site\"),\n+\n+  OPEN_STUDY(\n+      403, \"EC-989\", HttpStatus.FORBIDDEN.toString(), \"Can not add participant to open study\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5OTE3Nw=="}, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTgyNzI2OnYy", "diffSide": "RIGHT", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMzo1NzoyMVrOG37sVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNTowOTowNVrOG380Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwMjg3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfull\"),\n          \n          \n            \n                  HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfully\"),", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461302871", "createdAt": "2020-07-28T03:57:21Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "diffHunk": "@@ -41,7 +41,9 @@\n   LOCATION_UPDATE_SUCCESS(HttpStatus.OK, \"MSG-0004\", \"Location updated successfully\"),\n \n   GET_PARTICIPANT_REGISTRY_SUCCESS(\n-      HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfull\");\n+      HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfull\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyMTI2Mg==", "bodyText": "changed to successfully", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461321262", "createdAt": "2020-07-28T05:09:05Z", "author": {"login": "navya-BTC"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "diffHunk": "@@ -41,7 +41,9 @@\n   LOCATION_UPDATE_SUCCESS(HttpStatus.OK, \"MSG-0004\", \"Location updated successfully\"),\n \n   GET_PARTICIPANT_REGISTRY_SUCCESS(\n-      HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfull\");\n+      HttpStatus.OK, \"MSG-0008\", \"Get participant registry successfull\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwMjg3MQ=="}, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTg0NDE3OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNDowODozOFrOG372XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNToxMToyN1rOG382yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNTQzNw==", "bodyText": "throw new Exception here", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461305437", "createdAt": "2020-07-28T04:08:38Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -155,4 +173,70 @@ private void addSitePermissions(\n       site.addSitePermissionEntity(sitePermission);\n     }\n   }\n+\n+  @Override\n+  @Transactional\n+  public ParticipantResponse addNewParticipant(ParticipantDetail participant, String userId) {\n+    logger.entry(\"begin addNewParticipant()\");\n+\n+    Optional<SiteEntity> optSite = siteRepository.findById(participant.getSiteId());\n+\n+    if (!optSite.isPresent() || !optSite.get().getStatus().equals(ACTIVE_STATUS)) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new ParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyMTkyOQ==", "bodyText": "This will be addressed in following PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461321929", "createdAt": "2020-07-28T05:11:27Z", "author": {"login": "navya-BTC"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -155,4 +173,70 @@ private void addSitePermissions(\n       site.addSitePermissionEntity(sitePermission);\n     }\n   }\n+\n+  @Override\n+  @Transactional\n+  public ParticipantResponse addNewParticipant(ParticipantDetail participant, String userId) {\n+    logger.entry(\"begin addNewParticipant()\");\n+\n+    Optional<SiteEntity> optSite = siteRepository.findById(participant.getSiteId());\n+\n+    if (!optSite.isPresent() || !optSite.get().getStatus().equals(ACTIVE_STATUS)) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new ParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNTQzNw=="}, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTg0NjMyOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNDowOTo1NlrOG373nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNToxNDo0N1rOG386JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNTc1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private ErrorCode validationForAddNewParticipant(\n          \n          \n            \n              private ErrorCode validateNewParticipant(", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461305759", "createdAt": "2020-07-28T04:09:56Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -155,4 +173,70 @@ private void addSitePermissions(\n       site.addSitePermissionEntity(sitePermission);\n     }\n   }\n+\n+  @Override\n+  @Transactional\n+  public ParticipantResponse addNewParticipant(ParticipantDetail participant, String userId) {\n+    logger.entry(\"begin addNewParticipant()\");\n+\n+    Optional<SiteEntity> optSite = siteRepository.findById(participant.getSiteId());\n+\n+    if (!optSite.isPresent() || !optSite.get().getStatus().equals(ACTIVE_STATUS)) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new ParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+    }\n+\n+    SiteEntity site = optSite.get();\n+    ErrorCode errorCode = validationForAddNewParticipant(participant, userId, site);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new ParticipantResponse(errorCode);\n+    }\n+\n+    ParticipantRegistrySiteEntity participantRegistrySite =\n+        ParticipantMapper.fromParticipantRequest(participant, site);\n+    participantRegistrySite.setCreatedBy(userId);\n+    participantRegistrySite =\n+        participantRegistrySiteRepository.saveAndFlush(participantRegistrySite);\n+    ParticipantResponse response =\n+        new ParticipantResponse(\n+            MessageCode.ADD_PARTICIPANT_SUCCESS, participantRegistrySite.getId());\n+\n+    logger.exit(String.format(\"participantRegistrySiteId=%s\", participantRegistrySite.getId()));\n+    return response;\n+  }\n+\n+  private ErrorCode validationForAddNewParticipant(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNjcyMg==", "bodyText": "Also since we do not want to handle errors in the service layer we should probably have this method return void and throws Exceptions", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461306722", "createdAt": "2020-07-28T04:13:59Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -155,4 +173,70 @@ private void addSitePermissions(\n       site.addSitePermissionEntity(sitePermission);\n     }\n   }\n+\n+  @Override\n+  @Transactional\n+  public ParticipantResponse addNewParticipant(ParticipantDetail participant, String userId) {\n+    logger.entry(\"begin addNewParticipant()\");\n+\n+    Optional<SiteEntity> optSite = siteRepository.findById(participant.getSiteId());\n+\n+    if (!optSite.isPresent() || !optSite.get().getStatus().equals(ACTIVE_STATUS)) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new ParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+    }\n+\n+    SiteEntity site = optSite.get();\n+    ErrorCode errorCode = validationForAddNewParticipant(participant, userId, site);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new ParticipantResponse(errorCode);\n+    }\n+\n+    ParticipantRegistrySiteEntity participantRegistrySite =\n+        ParticipantMapper.fromParticipantRequest(participant, site);\n+    participantRegistrySite.setCreatedBy(userId);\n+    participantRegistrySite =\n+        participantRegistrySiteRepository.saveAndFlush(participantRegistrySite);\n+    ParticipantResponse response =\n+        new ParticipantResponse(\n+            MessageCode.ADD_PARTICIPANT_SUCCESS, participantRegistrySite.getId());\n+\n+    logger.exit(String.format(\"participantRegistrySiteId=%s\", participantRegistrySite.getId()));\n+    return response;\n+  }\n+\n+  private ErrorCode validationForAddNewParticipant(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNTc1OQ=="}, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyMjc4OA==", "bodyText": "Changed to validateNewParticipant.\nExceptions will be addressed in following PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/669#discussion_r461322788", "createdAt": "2020-07-28T05:14:47Z", "author": {"login": "navya-BTC"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -155,4 +173,70 @@ private void addSitePermissions(\n       site.addSitePermissionEntity(sitePermission);\n     }\n   }\n+\n+  @Override\n+  @Transactional\n+  public ParticipantResponse addNewParticipant(ParticipantDetail participant, String userId) {\n+    logger.entry(\"begin addNewParticipant()\");\n+\n+    Optional<SiteEntity> optSite = siteRepository.findById(participant.getSiteId());\n+\n+    if (!optSite.isPresent() || !optSite.get().getStatus().equals(ACTIVE_STATUS)) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new ParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+    }\n+\n+    SiteEntity site = optSite.get();\n+    ErrorCode errorCode = validationForAddNewParticipant(participant, userId, site);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new ParticipantResponse(errorCode);\n+    }\n+\n+    ParticipantRegistrySiteEntity participantRegistrySite =\n+        ParticipantMapper.fromParticipantRequest(participant, site);\n+    participantRegistrySite.setCreatedBy(userId);\n+    participantRegistrySite =\n+        participantRegistrySiteRepository.saveAndFlush(participantRegistrySite);\n+    ParticipantResponse response =\n+        new ParticipantResponse(\n+            MessageCode.ADD_PARTICIPANT_SUCCESS, participantRegistrySite.getId());\n+\n+    logger.exit(String.format(\"participantRegistrySiteId=%s\", participantRegistrySite.getId()));\n+    return response;\n+  }\n+\n+  private ErrorCode validationForAddNewParticipant(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwNTc1OQ=="}, "originalCommit": {"oid": "6dfa4280b5fe566ca4fa66bc821edf46d3e2d330"}, "originalPosition": 89}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2327, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}