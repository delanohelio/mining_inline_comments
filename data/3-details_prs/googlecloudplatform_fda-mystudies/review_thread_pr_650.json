{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyNDc3ODU2", "number": 650, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNjowMTowN1rOER4QQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOTo0Nzo1N1rOEWVbIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTgyOTEyOnYy", "diffSide": "RIGHT", "path": "common-modules/common-tests/src/main/resources/__files/hydra/auth_requests_consent_response.json", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNjowMTowN1rOG21AuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjowODo0M1rOG399NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ==", "bodyText": "these two files, seem to be out of the scope of this PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460144825", "createdAt": "2020-07-24T16:01:07Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-tests/src/main/resources/__files/hydra/auth_requests_consent_response.json", "diffHunk": "@@ -0,0 +1,57 @@\n+{\n+  \"challenge\": \"c11e62a0-5555-4b0e-b498-c878f5e4bd85\",\n+  \"requested_scope\": [\n+    \"offline_access\"\n+  ],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzNzk0Nw==", "bodyText": "I implemented complete functionality, but later decided to split into 2 PR to reduce the size so I kept these files in this PR because LOC <500. I've removed the consent related JSON files.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461337947", "createdAt": "2020-07-28T06:02:20Z", "author": {"login": "dhanyak-btc"}, "path": "common-modules/common-tests/src/main/resources/__files/hydra/auth_requests_consent_response.json", "diffHunk": "@@ -0,0 +1,57 @@\n+{\n+  \"challenge\": \"c11e62a0-5555-4b0e-b498-c878f5e4bd85\",\n+  \"requested_scope\": [\n+    \"offline_access\"\n+  ],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzOTk1Ng==", "bodyText": "Created an issue #688  Please also remove OrgID from other modules, WCP, mobile apps. And also update the db scripts accordingly.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461339956", "createdAt": "2020-07-28T06:08:43Z", "author": {"login": "dhanyak-btc"}, "path": "common-modules/common-tests/src/main/resources/__files/hydra/auth_requests_consent_response.json", "diffHunk": "@@ -0,0 +1,57 @@\n+{\n+  \"challenge\": \"c11e62a0-5555-4b0e-b498-c878f5e4bd85\",\n+  \"requested_scope\": [\n+    \"offline_access\"\n+  ],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTgzMDk2OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNjowMTozNVrOG21B2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNzowMzo0OVrOG7825w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ==", "bodyText": "out of scope of this PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460145115", "createdAt": "2020-07-24T16:01:35Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "diffHunk": "@@ -86,4 +84,10 @@ private AuthScimConstants() {}\n   public static final String OTP_USED = \"otp_used\";\n \n   public static final String ACCOUNT_LOCK_EMAIL_TIMESTAMP = \"account_lock_email_timestamp\";\n+\n+  public static final String CONSENT_CHALLENGE = \"consent_challenge\";\n+\n+  public static final String FORGOT_PASSWORD_LINK = \"forgot_password_link\";\n+\n+  public static final String SIGNUP_LINK = \"signup_link\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzODU3MA==", "bodyText": "I mentioned what is covered in this PR in description. Kindly review.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461338570", "createdAt": "2020-07-28T06:04:19Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "diffHunk": "@@ -86,4 +84,10 @@ private AuthScimConstants() {}\n   public static final String OTP_USED = \"otp_used\";\n \n   public static final String ACCOUNT_LOCK_EMAIL_TIMESTAMP = \"account_lock_email_timestamp\";\n+\n+  public static final String CONSENT_CHALLENGE = \"consent_challenge\";\n+\n+  public static final String FORGOT_PASSWORD_LINK = \"forgot_password_link\";\n+\n+  public static final String SIGNUP_LINK = \"signup_link\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwMzYxNQ==", "bodyText": "my bad.\nStill, in future please keep each PR centered around one main change and move these smaller changes to a separate PR; for one, they do not need to be included in a long chain of dependent PRs.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461703615", "createdAt": "2020-07-28T16:13:01Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "diffHunk": "@@ -86,4 +84,10 @@ private AuthScimConstants() {}\n   public static final String OTP_USED = \"otp_used\";\n \n   public static final String ACCOUNT_LOCK_EMAIL_TIMESTAMP = \"account_lock_email_timestamp\";\n+\n+  public static final String CONSENT_CHALLENGE = \"consent_challenge\";\n+\n+  public static final String FORGOT_PASSWORD_LINK = \"forgot_password_link\";\n+\n+  public static final String SIGNUP_LINK = \"signup_link\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNjI2Mw==", "bodyText": "I've informed the team to keep the PR focused on one feature/issue. I've noted this point, will avoid adding multiple things into single PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465516263", "createdAt": "2020-08-05T07:03:49Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "diffHunk": "@@ -86,4 +84,10 @@ private AuthScimConstants() {}\n   public static final String OTP_USED = \"otp_used\";\n \n   public static final String ACCOUNT_LOCK_EMAIL_TIMESTAMP = \"account_lock_email_timestamp\";\n+\n+  public static final String CONSENT_CHALLENGE = \"consent_challenge\";\n+\n+  public static final String FORGOT_PASSWORD_LINK = \"forgot_password_link\";\n+\n+  public static final String SIGNUP_LINK = \"signup_link\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTgzMTkyOnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNjowMTo0OFrOG21CcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMzowMDoyNVrOG_MEVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ==", "bodyText": "out of scope", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460145265", "createdAt": "2020-07-24T16:01:48Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzODY2OQ==", "bodyText": "I mentioned what is covered in this PR in description. Kindly review.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461338669", "createdAt": "2020-07-28T06:04:37Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNzYzMg==", "bodyText": "I don't see why these should be included here. Please keep all participantManager related changes together. It is very hard. to review unrelated changes out of their context.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461707632", "createdAt": "2020-07-28T16:19:06Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1NzkyMw==", "bodyText": "@zohrehj In PR #615 you added a review comment \"so why is it returning string \"error\"? not a meaningful string, and/or an exception?\"\nMy reply was  \"error\" - is a placeholder. I need to configure error urls for android/ios/participant manager and redirect to respective error url.\nI've configured the redirect URLs in this PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466857923", "createdAt": "2020-08-07T06:59:43Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMTE4OA==", "bodyText": "makes sense. But does not answer why it is included in this PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468911188", "createdAt": "2020-08-11T23:00:25Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, "originalCommit": {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQwNjAzOnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoxNjoxMFrOG4USAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNzowNjo1NVrOG788qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTcyOQ==", "bodyText": "why not just check for error status code?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461705729", "createdAt": "2020-07-28T16:16:10Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "diffHunk": "@@ -78,31 +79,32 @@\n   public void shouldReturnLoginPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n     queryParams.add(LOGIN_CHALLENGE, LOGIN_CHALLENGE_VALUE);\n-\n+    String forgotPasswordRedirectUrl =\n+        redirectConfig.getForgotPasswordUrl(DevicePlatform.UNKNOWN.getValue());\n+    String signupRedirectUrl = redirectConfig.getSignupUrl(DevicePlatform.UNKNOWN.getValue());\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n         .andExpect(status().isOk())\n+        .andExpect(model().attribute(FORGOT_PASSWORD_LINK, forgotPasswordRedirectUrl))\n+        .andExpect(model().attribute(SIGNUP_LINK, signupRedirectUrl))\n         .andExpect(content().string(containsString(\"<title>Login</title>\")))\n         .andReturn();\n   }\n \n   @Test\n   public void shouldReturnErrorPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n-\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n-        .andExpect(status().isOk())\n-        .andExpect(content().string(containsString(\"<title>Error</title>\")))\n-        .andReturn();\n+        .andExpect(view().name(\"http://localhost:8003/participant-manager/error\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNzczOQ==", "bodyText": "Controller tries to redirect to the error url and then throws below error as this url not implemented in this service. So comparing the expected url with the view name.\nError resolving template [http://localhost:8003/participant-manager/error], template might not exist or might not be accessible by any of the configured Template Resolvers", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465517739", "createdAt": "2020-08-05T07:06:55Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "diffHunk": "@@ -78,31 +79,32 @@\n   public void shouldReturnLoginPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n     queryParams.add(LOGIN_CHALLENGE, LOGIN_CHALLENGE_VALUE);\n-\n+    String forgotPasswordRedirectUrl =\n+        redirectConfig.getForgotPasswordUrl(DevicePlatform.UNKNOWN.getValue());\n+    String signupRedirectUrl = redirectConfig.getSignupUrl(DevicePlatform.UNKNOWN.getValue());\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n         .andExpect(status().isOk())\n+        .andExpect(model().attribute(FORGOT_PASSWORD_LINK, forgotPasswordRedirectUrl))\n+        .andExpect(model().attribute(SIGNUP_LINK, signupRedirectUrl))\n         .andExpect(content().string(containsString(\"<title>Login</title>\")))\n         .andReturn();\n   }\n \n   @Test\n   public void shouldReturnErrorPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n-\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n-        .andExpect(status().isOk())\n-        .andExpect(content().string(containsString(\"<title>Error</title>\")))\n-        .andReturn();\n+        .andExpect(view().name(\"http://localhost:8003/participant-manager/error\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTcyOQ=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQwODY0OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/resources/application-local.properties", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoxNjo1MlrOG4UTtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNzowMjoxMFrOG9Ozzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjE2Ng==", "bodyText": "participant manager URLs are out of scope of this PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461706166", "createdAt": "2020-07-28T16:16:52Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/resources/application-local.properties", "diffHunk": "@@ -60,9 +62,21 @@ spring.mail.properties.mail.smtp.starttls.enable=true\n spring.mail.properties.mail.smtp.ssl.enable = true\n \n # audit log endpoints\n-auditlog.events_endpoint=http://localhost:8001/audit-log-service/v1/events\n+auditlog.events_endpoint=http://localhost:8001/audit-log-service/events\n \n # Redirect URL's\n participant.manager.callback-url=http://localhost:8003/participant-manager/callback\n-mystudies.ios.app.callback-url=\n-mystudies.android.app.callback-url=\n\\ No newline at end of file\n+mystudies.ios.app.callback-url=http://localhost:8005/ios/deeplinks/callback\n+mystudies.android.app.callback-url=http://localhost:8006/android/deeplinks/callback\n+\n+participant.manager.forgot-password-url=http://localhost:8003/participant-manager/forgot-password", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1ODk1OQ==", "bodyText": "I've answered to this in above review comment.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466858959", "createdAt": "2020-08-07T07:02:10Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/resources/application-local.properties", "diffHunk": "@@ -60,9 +62,21 @@ spring.mail.properties.mail.smtp.starttls.enable=true\n spring.mail.properties.mail.smtp.ssl.enable = true\n \n # audit log endpoints\n-auditlog.events_endpoint=http://localhost:8001/audit-log-service/v1/events\n+auditlog.events_endpoint=http://localhost:8001/audit-log-service/events\n \n # Redirect URL's\n participant.manager.callback-url=http://localhost:8003/participant-manager/callback\n-mystudies.ios.app.callback-url=\n-mystudies.android.app.callback-url=\n\\ No newline at end of file\n+mystudies.ios.app.callback-url=http://localhost:8005/ios/deeplinks/callback\n+mystudies.android.app.callback-url=http://localhost:8006/android/deeplinks/callback\n+\n+participant.manager.forgot-password-url=http://localhost:8003/participant-manager/forgot-password", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjE2Ng=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQxMTYxOnYy", "diffSide": "RIGHT", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoxNzozN1rOG4UVlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNzowMjo1OFrOG9O1Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ==", "bodyText": "nit: this is out of scope, and I have seen it in your other auth PR. Is there an issue with the base of this PR?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461706645", "createdAt": "2020-07-28T16:17:37Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjQxNw==", "bodyText": "I replaced DigestUtils.sha3_512Hex() method with DigestUtils.sha512Hex() as it was throwing NoSuchAlgorithmException .This error was happening for other developers, I was able to reproduce this by changing IDE build path to java-1.8.0-openjdk-1.8.0.252.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465522417", "createdAt": "2020-08-05T07:16:51Z", "author": {"login": "dhanyak-btc"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMjU1OQ==", "bodyText": "ok, but it could have been fixed in a separate independent PR. It would have probably been merged a lot faster that way.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465702559", "createdAt": "2020-08-05T12:50:48Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwNTEzMQ==", "bodyText": "still out of scope. I am letting one slide in order to save us some time, but please in future move small fixes into separate PRs. That way they can be merged in quickly and unblock other devs without the need to wait for a chain of dependent PRs to go in.\nIt will also make your PRs more straight forward and easier to review.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465705131", "createdAt": "2020-08-05T12:54:55Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1OTI5OA==", "bodyText": "Thanks @zohrehj", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466859298", "createdAt": "2020-08-07T07:02:58Z", "author": {"login": "dhanyak-btc"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQyNDE5OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyMDozNlrOG4UdVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyMDozNlrOG4UdVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwODYzMQ==", "bodyText": "\ud83d\udc4d on the thorough comment here", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461708631", "createdAt": "2020-07-28T16:20:36Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -74,6 +73,16 @@\n \n   @Autowired private AppPropertyConfig appConfig;\n \n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQ1MDcwOnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyNjo1NlrOG4UuDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjo1MTo0NVrOG8IQ5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA==", "bodyText": "I am not clear as to why you are returning the redirect URL with redirect: prefix.\nWhy is that? and where is it handled?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461712908", "createdAt": "2020-07-28T16:26:56Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -240,6 +262,14 @@ private String redirect(HttpServletResponse response, String redirectUrl) {\n     return \"redirect:\" + redirectUrl;\n   }\n \n+  private String redirectToError(HttpServletRequest request, HttpServletResponse response) {\n+    String devicePlatform = WebUtils.getCookie(request, DEVICE_PLATFORM).getValue();\n+    String redirectUrl = redirectConfig.getErrorUrl(devicePlatform);\n+    response.setHeader(\"Location\", redirectUrl);\n+    response.setStatus(HttpStatus.FOUND.value());\n+    return \"redirect:\" + redirectUrl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNDc1Mw==", "bodyText": "Please refer https://www.logicbig.com/tutorials/spring-framework/spring-web-mvc/redirect-prefix.html", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465524753", "createdAt": "2020-08-05T07:21:38Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -240,6 +262,14 @@ private String redirect(HttpServletResponse response, String redirectUrl) {\n     return \"redirect:\" + redirectUrl;\n   }\n \n+  private String redirectToError(HttpServletRequest request, HttpServletResponse response) {\n+    String devicePlatform = WebUtils.getCookie(request, DEVICE_PLATFORM).getValue();\n+    String redirectUrl = redirectConfig.getErrorUrl(devicePlatform);\n+    response.setHeader(\"Location\", redirectUrl);\n+    response.setStatus(HttpStatus.FOUND.value());\n+    return \"redirect:\" + redirectUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMzE0Mw==", "bodyText": "I see. thanks for the link.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465703143", "createdAt": "2020-08-05T12:51:45Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -240,6 +262,14 @@ private String redirect(HttpServletResponse response, String redirectUrl) {\n     return \"redirect:\" + redirectUrl;\n   }\n \n+  private String redirectToError(HttpServletRequest request, HttpServletResponse response) {\n+    String devicePlatform = WebUtils.getCookie(request, DEVICE_PLATFORM).getValue();\n+    String redirectUrl = redirectConfig.getErrorUrl(devicePlatform);\n+    response.setHeader(\"Location\", redirectUrl);\n+    response.setStatus(HttpStatus.FOUND.value());\n+    return \"redirect:\" + redirectUrl;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 173}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQ1NDU0OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyNzo1N1rOG4UwjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTo0Nzo0NFrOG_dpSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA==", "bodyText": "out of scope of this PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461713548", "createdAt": "2020-07-28T16:27:57Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwOTA1NQ==", "bodyText": "Please remove these out of scope code out of the PR.\nIf you disagree, please provide why they need to stay, and provide enough context for me to review. Without proper context I am not able to review the code. where is it being tested, etc\ni.e. what is the purpose of this code, what part of the code uses it.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465709055", "createdAt": "2020-08-05T13:01:08Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2ODcxNQ==", "bodyText": "Sorry for the confusion, let me explain what went wrong here. This PR was raised ~2 weeks ago. We used to raise PR's with more than 500 LOC that discussion came during technical catch up meetings. I remember, it was OK to split the code into multiple PRs. So If you see my commit history above, I split the implementation into 2 PR's #650 and #651 just to keep the PR below around 500 LOC. Follow up PR #651\nI agree with you it's very difficult for reviewers with this approach but each week we are learning something new about the review processes and the team is quickly aligning to new suggestions. This is the first time I got \"out of scope\" review comment, so I've informed the team about keeping the PR focused on one feature/issue. Kindly review this PR and approve.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466868715", "createdAt": "2020-08-07T07:25:41Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzODU4MQ==", "bodyText": "I assumed this was the case. Still my initial comment stands, if you can't remove it, which seems to be the case here, please provide context for this code.\ni.e. what is the purpose of this code, what part of the code uses it.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467238581", "createdAt": "2020-08-07T19:50:05Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzOTkxNA==", "bodyText": "I am also not seeing any tests covering these methods. Please add tests.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467239914", "createdAt": "2020-08-07T19:53:22Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc1MzUxMw==", "bodyText": "In ORY HYDRA REST API documentation, request body is not required but API invocation returns an error if request body is null. Below error message was not useful to fix the issue, so during POC I prepared the request body as per the documentation with dummy values. I removed the dummy values, passing empty JSON fixed the issue and tests are successful. ConsentControllerTest is in PR #651 so I fixed this comment in PR #651\nPUT /oauth2/auth/requests/consent/accept?consent_challenge=0ab55b85d7f8408eb9eb1260fa3e58b3\n{\"error\":\"error\",\"error_description\":\"The error is unrecognizable.\",\"status_code\":500,\"error_debug\":\"EOF\",\"request_id\":\"\"}", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468753513", "createdAt": "2020-08-11T17:41:35Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMTQ3Nw==", "bodyText": "Please move the code to PR 651 if the tests are in there. I would prefer all code + tests to be merged together.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468911477", "createdAt": "2020-08-11T23:01:15Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5OTE3OQ==", "bodyText": "PR 651 created from PR 650 branch, so code already present in that branch. I'm making changes directly in PR 651.\nI agree with you, it's better to keep the code+tests together, this saves time for developers and makes it easy to test the review fixes. Sometimes, PR may exceed 500 LOC.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r469199179", "createdAt": "2020-08-12T11:47:44Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjQ1OTI2OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyOTowN1rOG4Uzlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNzoyODo1MVrOG9PfnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg==", "bodyText": "Not sure how these are related to the orgID and version removal and needed to be included here.\nIf they can be removed, please move them into a separate PR.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461714326", "createdAt": "2020-07-28T16:29:07Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "diffHunk": "@@ -27,4 +27,8 @@\n   public ResponseEntity<JsonNode> requestLogin(MultiValueMap<String, String> paramMap);\n \n   public ResponseEntity<JsonNode> loginAccept(String email, String loginChallenge);\n+\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap);\n+\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODk3Nw==", "bodyText": "Sorry, I was trying to complete multiple things (provided<500 LOC)  so that Participant Manager & Mobile Apps can start the integration with new auth server. Now, I learnt it's a bad approach, so I'll try to keep the future PR's focused on one feature/issue.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465528977", "createdAt": "2020-08-05T07:30:00Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "diffHunk": "@@ -27,4 +27,8 @@\n   public ResponseEntity<JsonNode> requestLogin(MultiValueMap<String, String> paramMap);\n \n   public ResponseEntity<JsonNode> loginAccept(String email, String loginChallenge);\n+\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap);\n+\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwOTYxNg==", "bodyText": "same as my previous comment, I can't review code out of context. either remove or provide context.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465709616", "createdAt": "2020-08-05T13:02:14Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "diffHunk": "@@ -27,4 +27,8 @@\n   public ResponseEntity<JsonNode> requestLogin(MultiValueMap<String, String> paramMap);\n \n   public ResponseEntity<JsonNode> loginAccept(String email, String loginChallenge);\n+\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap);\n+\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg3MDE3Mw==", "bodyText": "Please see above comment reply.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466870173", "createdAt": "2020-08-07T07:28:51Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "diffHunk": "@@ -27,4 +27,8 @@\n   public ResponseEntity<JsonNode> requestLogin(MultiValueMap<String, String> paramMap);\n \n   public ResponseEntity<JsonNode> loginAccept(String email, String loginChallenge);\n+\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap);\n+\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}, "originalCommit": {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxODU1MTM2OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOTo0Nzo1N1rOG9l7Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTo1NToxMlrOG_d3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA==", "bodyText": "what is this feature referring to? can you please point me to how this functionality works and where it is used?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467237678", "createdAt": "2020-08-07T19:47:57Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -124,11 +138,15 @@ public void init() {\n     StringBuilder url = new StringBuilder(loginAcceptEndpoint);\n     url.append(\"?\").append(LOGIN_CHALLENGE).append(\"=\").append(loginChallenge);\n \n-    ObjectNode requestParams = JsonUtils.getObjectNode();\n+    ObjectNode requestParams = getObjectNode();\n     requestParams.put(\"subject\", email);\n-    requestParams.put(\"remember\", true);\n-    requestParams.put(\"remember_for\", REMEMBER_FOR_SECONDS);\n \n+    // if ORY Hydra should remember the subject's subject agent for future authentication attempts\n+    // by setting a cookie.\n+    requestParams.put(\"remember\", remember);\n+    if (remember) {\n+      requestParams.put(\"remember_for\", rememberForSeconds);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0NDU5MA==", "bodyText": "In ORY REST API documentation, the request body is not required but API invocation returns status code 500 if request body is empty or null.\nPUT /oauth2/auth/requests/login/accept?login_challenge=bcf381e940644757a09ed1f31b982ebc\n{\"error\":\"error\",\"error_description\":\"The error is unrecognizable.\",\"status_code\":500,\"error_debug\":\"Subject from payload can not be empty\",\"request_id\":\"\"}\n\nRemember, if set to true, tells ORY Hydra to remember this user by telling the user agent (browser) to store a cookie with authentication data. If the same user performs another OAuth 2.0 Authorization Request, he/she will not be asked to log in again. The default value is set to FALSE so we are not using this functionality.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468744590", "createdAt": "2020-08-11T17:26:02Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -124,11 +138,15 @@ public void init() {\n     StringBuilder url = new StringBuilder(loginAcceptEndpoint);\n     url.append(\"?\").append(LOGIN_CHALLENGE).append(\"=\").append(loginChallenge);\n \n-    ObjectNode requestParams = JsonUtils.getObjectNode();\n+    ObjectNode requestParams = getObjectNode();\n     requestParams.put(\"subject\", email);\n-    requestParams.put(\"remember\", true);\n-    requestParams.put(\"remember_for\", REMEMBER_FOR_SECONDS);\n \n+    // if ORY Hydra should remember the subject's subject agent for future authentication attempts\n+    // by setting a cookie.\n+    requestParams.put(\"remember\", remember);\n+    if (remember) {\n+      requestParams.put(\"remember_for\", rememberForSeconds);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}, "originalCommit": {"oid": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMDk2Ng==", "bodyText": "What is the remember_for parameter then? why not use cookie expiration instead?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468910966", "createdAt": "2020-08-11T22:59:47Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -124,11 +138,15 @@ public void init() {\n     StringBuilder url = new StringBuilder(loginAcceptEndpoint);\n     url.append(\"?\").append(LOGIN_CHALLENGE).append(\"=\").append(loginChallenge);\n \n-    ObjectNode requestParams = JsonUtils.getObjectNode();\n+    ObjectNode requestParams = getObjectNode();\n     requestParams.put(\"subject\", email);\n-    requestParams.put(\"remember\", true);\n-    requestParams.put(\"remember_for\", REMEMBER_FOR_SECONDS);\n \n+    // if ORY Hydra should remember the subject's subject agent for future authentication attempts\n+    // by setting a cookie.\n+    requestParams.put(\"remember\", remember);\n+    if (remember) {\n+      requestParams.put(\"remember_for\", rememberForSeconds);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}, "originalCommit": {"oid": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwMjczOA==", "bodyText": "I referred the ORY Hydra REST API documentation, remember and remember_for both are optional fields hence removed from request body.\nIn ORY Hydra documentation, Subject is the user ID of the end-user that authenticated. I was passing email instead of userId, I fixed this issue in PR #651 . Please review and approve.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r469202738", "createdAt": "2020-08-12T11:55:12Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -124,11 +138,15 @@ public void init() {\n     StringBuilder url = new StringBuilder(loginAcceptEndpoint);\n     url.append(\"?\").append(LOGIN_CHALLENGE).append(\"=\").append(loginChallenge);\n \n-    ObjectNode requestParams = JsonUtils.getObjectNode();\n+    ObjectNode requestParams = getObjectNode();\n     requestParams.put(\"subject\", email);\n-    requestParams.put(\"remember\", true);\n-    requestParams.put(\"remember_for\", REMEMBER_FOR_SECONDS);\n \n+    // if ORY Hydra should remember the subject's subject agent for future authentication attempts\n+    // by setting a cookie.\n+    requestParams.put(\"remember\", remember);\n+    if (remember) {\n+      requestParams.put(\"remember_for\", rememberForSeconds);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}, "originalCommit": {"oid": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2312, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}