{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMTc5NDY0", "number": 711, "title": "Participant manager service - POST /sites/{siteId}/participants/invite API endpoint implementation.", "bodyText": "Participant manager service - POST /sites/{siteId}/participants/invite API endpoint implementation.", "createdAt": "2020-07-31T14:07:19Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711", "merged": true, "mergeCommit": {"oid": "fea5404dff8517ce8c7bc55329747966f3ff7322"}, "closed": true, "closedAt": "2020-08-19T14:16:50Z", "author": {"login": "madhurya-btc"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6UAQKAH2gAyNDYwMTc5NDY0OmY1MDNiZWRlYzZmYzhkNzA2OTYxODczYmY2MTRmZmZhYmMyMmM5MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAcSKegH2gAyNDYwMTc5NDY0OjdmNGZlYWNhZDI4ODJkMjc5MWMwOGI3ZjBiNjQxY2U0MjY0OTZiZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f503bedec6fc8d706961873bf614fffabc22c91a", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f503bedec6fc8d706961873bf614fffabc22c91a", "committedDate": "2020-07-31T13:12:04Z", "message": "Participant manager POST /sites/{siteId}/participants/invite api endpoint implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f73c1d40309b7677b84812ff8effb574f91bad99", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f73c1d40309b7677b84812ff8effb574f91bad99", "committedDate": "2020-07-31T13:30:14Z", "message": "Code rafactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "759511eba17671a62138e8115aca8528669b4544", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/759511eba17671a62138e8115aca8528669b4544", "committedDate": "2020-07-31T14:29:18Z", "message": "test cases failure fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92442bf12608b31a925b51d28cca2f213fb18b4d", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/92442bf12608b31a925b51d28cca2f213fb18b4d", "committedDate": "2020-07-31T14:32:44Z", "message": "Test cases failure fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5fa2a6fd154c998076abfa2296da09fd59ccabd9", "committedDate": "2020-07-31T15:11:09Z", "message": "equals check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTA5MTU5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#pullrequestreview-459509159", "createdAt": "2020-07-31T22:32:31Z", "commit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjozMjozMlrOG6Yk-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMzozNDozN1rOG6ZaMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzI3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"participants are invited\"),\n          \n          \n            \n              PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"Participants are invited\"),", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463873275", "createdAt": "2020-07-31T22:32:32Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "diffHunk": "@@ -64,7 +67,12 @@\n       HttpStatus.OK, \"MSG-0023\", \"Get user profile with security code successfully\"),\n \n   GET_PARTICIPANT_DETAILS_SUCCESS(\n-      HttpStatus.OK, \"MSG-0019\", \"Get participant details successfully\");\n+      HttpStatus.OK, \"MSG-0019\", \"Get participant details successfully\"),\n+\n+  PARTICIPANTS_INVITED_SUCCESS(HttpStatus.OK, \"MSG-0016\", \"participants are invited\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTUyOA==", "bodyText": "Can you just use the built in isEmpty for this? I think even when CC and BCC are empty these ArrayLists should not be null, just empty right?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463875528", "createdAt": "2020-07-31T22:42:08Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/EmailServiceImpl.java", "diffHunk": "@@ -34,23 +40,30 @@\n   @Autowired private JavaMailSender emailSender;\n \n   @Override\n-  public EmailResponse sendSimpleMail(EmailRequest emailRequest) {\n-    logger.entry(\"Begin sendSimpleMail()\");\n+  public EmailResponse sendMimeMail(EmailRequest emailRequest) {\n+    logger.entry(\"Begin sendMimeMail()\");\n     try {\n-      SimpleMailMessage message = new SimpleMailMessage();\n-      message.setFrom(emailRequest.getFrom());\n-      message.setBcc(emailRequest.getBcc());\n-      message.setCc(emailRequest.getCc());\n-      message.setTo(emailRequest.getTo());\n+      MimeMessage message = emailSender.createMimeMessage();\n+      MimeMessageHelper helper = new MimeMessageHelper(message, true);\n+      helper.setFrom(emailRequest.getFrom());\n+      helper.setTo(emailRequest.getTo());\n+\n+      if (ArrayUtils.isNotEmpty(emailRequest.getCc())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTk3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Integer enrollmentTokenExpiryinHours;\n          \n          \n            \n              private Integer enrollmentTokenExpiryInHours;", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463875979", "createdAt": "2020-07-31T22:44:03Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/config/AppPropertyConfig.java", "diffHunk": "@@ -23,4 +25,28 @@\n \n   @Value(\"${securityCodeExpireDate}\")\n   private String securityCodeExpireDate;\n+\n+  @Value(\"${enrollmentTokenExpiryinHours}\")\n+  private Integer enrollmentTokenExpiryinHours;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MDMyOQ==", "bodyText": "participantsList", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463880329", "createdAt": "2020-07-31T23:03:00Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -564,4 +580,113 @@ private ErrorCode validateParticipantDetailsRequest(\n     }\n     return null;\n   }\n+\n+  @Override\n+  @Transactional\n+  public InviteParticipantResponse inviteParticipants(\n+      InviteParticipantRequest inviteParticipantRequest) {\n+    logger.entry(\"begin inviteParticipants()\");\n+\n+    Optional<SiteEntity> optSiteEntity =\n+        siteRepository.findById(inviteParticipantRequest.getSiteId());\n+\n+    if (!optSiteEntity.isPresent() || !ACTIVE_STATUS.equals(optSiteEntity.get().getStatus())) {\n+      logger.exit(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+      return new InviteParticipantResponse(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE);\n+    }\n+\n+    Optional<SitePermissionEntity> optSitePermissionEntity =\n+        sitePermissionRepository.findSitePermissionByUserIdAndSiteId(\n+            inviteParticipantRequest.getUserId(), inviteParticipantRequest.getSiteId());\n+    if (!optSitePermissionEntity.isPresent()\n+        || Permission.READ_EDIT\n+            != Permission.fromValue(optSitePermissionEntity.get().getCanEdit())) {\n+      logger.exit(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+      return new InviteParticipantResponse(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED);\n+    }\n+\n+    List<ParticipantRegistrySiteEntity> listOfparticipants =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4NDY4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              INVITE_PARTICIPANT(\n          \n          \n            \n              INVITE_PARTICIPANTS(", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463884680", "createdAt": "2020-07-31T23:23:50Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/common/ApiEndpoint.java", "diffHunk": "@@ -51,7 +51,10 @@\n   GET_USER_DETAILS(\"http://localhost:8080/participant-manager-service/users\"),\n \n   GET_PARTICIPANT_DETAILS(\n-      \"http://localhost:8080/participant-manager-service/sites/{participantRegistrySite}/participant\");\n+      \"http://localhost:8080/participant-manager-service/sites/{participantRegistrySite}/participant\"),\n+\n+  INVITE_PARTICIPANT(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4Njg5Nw==", "bodyText": "We should have more success cases in test, requests with multiple Ids, with some failed participantIds being returned", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#discussion_r463886897", "createdAt": "2020-07-31T23:34:37Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SitesControllerTest.java", "diffHunk": "@@ -661,6 +663,73 @@ public void shouldReturnAccessDeniedForGetParticipantDetails() throws Exception\n                 is(ErrorCode.MANAGE_SITE_PERMISSION_ACCESS_DENIED.getDescription())));\n   }\n \n+  @Test\n+  public void shouldReturnSiteNotFoundForInviteParticipant() throws Exception {\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    InviteParticipantRequest inviteParticipantRequest = new InviteParticipantRequest();\n+    inviteParticipantRequest.setIds(Arrays.asList(participantRegistrySiteEntity.getId()));\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.INVITE_PARTICIPANT.getPath(), IdGenerator.id())\n+                .content(asJsonString(inviteParticipantRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(\n+            jsonPath(\n+                \"$.error_description\", is(ErrorCode.SITE_NOT_EXIST_OR_INACTIVE.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldInviteParticipant() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fa2a6fd154c998076abfa2296da09fd59ccabd9"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8ee601740cc9e30dca16be7d73107a8d3db9c2", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e8ee601740cc9e30dca16be7d73107a8d3db9c2", "committedDate": "2020-08-03T05:52:39Z", "message": "PR comment fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzYyODYx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#pullrequestreview-461762861", "createdAt": "2020-08-05T15:13:05Z", "commit": {"oid": "4e8ee601740cc9e30dca16be7d73107a8d3db9c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "323e1d868cdfbd097ced5a6b25fb93910efb8680", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/323e1d868cdfbd097ced5a6b25fb93910efb8680", "committedDate": "2020-08-14T05:56:37Z", "message": "1) fetching placeholder of orgName for email from property file.\n2) invitation count incrementing for NEW and INVITE also"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzQwOTg3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#pullrequestreview-467740987", "createdAt": "2020-08-14T17:17:04Z", "commit": {"oid": "323e1d868cdfbd097ced5a6b25fb93910efb8680"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b047c38001d9fe105348e4608c1827feeb8dc9ee", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b047c38001d9fe105348e4608c1827feeb8dc9ee", "committedDate": "2020-08-18T16:07:01Z", "message": "Merge branch 'develop' into participant-manager-invite-participants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d33c163f7d1a5b521a0b0d0c6e78b307e04b75a0", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d33c163f7d1a5b521a0b0d0c6e78b307e04b75a0", "committedDate": "2020-08-19T13:15:14Z", "message": "resolved merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a190055a1d36dcf66141469fa70be6c0573d1a", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/74a190055a1d36dcf66141469fa70be6c0573d1a", "committedDate": "2020-08-19T13:43:27Z", "message": "Fixed test failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNTAwMDUw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/711#pullrequestreview-470500050", "createdAt": "2020-08-19T14:13:17Z", "commit": {"oid": "74a190055a1d36dcf66141469fa70be6c0573d1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4feacad2882d2791c08b7f0b641ce426496be6", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7f4feacad2882d2791c08b7f0b641ce426496be6", "committedDate": "2020-08-19T14:14:25Z", "message": "Merge branch 'develop' into participant-manager-invite-participants"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 591, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}