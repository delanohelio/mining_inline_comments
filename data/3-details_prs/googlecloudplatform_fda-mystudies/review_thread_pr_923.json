{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyOTA0NzYz", "number": 923, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1NDozMVrOEiUdoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoxNjowNFrOEiUvNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDIyMzA1OnYy", "diffSide": "LEFT", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/EnrollmentManagementUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1NDozMVrOHQIcAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTozMTozMFrOHQjrMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NzUwNQ==", "bodyText": "keep this log event if required - catch and rethrow the error", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r486677505", "createdAt": "2020-09-10T22:54:31Z", "author": {"login": "saminguyen"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/EnrollmentManagementUtil.java", "diffHunk": "@@ -144,95 +138,63 @@ public String getParticipantId(\n       String applicationId,\n       String hashedTokenValue,\n       String studyId,\n-      AuditLogEventRequest auditRequest)\n-      throws InvalidRequestException, UnAuthorizedRequestException, SystemException {\n+      AuditLogEventRequest auditRequest) {\n     logger.info(\"EnrollmentManagementUtil getParticipantId() - starts \");\n     HttpHeaders headers = null;\n     EnrollmentBodyProvider bodyProvider = null;\n     HttpEntity<EnrollmentBodyProvider> requestBody = null;\n     ResponseEntity<?> responseEntity = null;\n     String participantId = \"\";\n-    try {\n-      headers = new HttpHeaders();\n-      headers.setContentType(MediaType.APPLICATION_JSON);\n-      headers.set(\"applicationId\", applicationId);\n-      headers.set(\"Authorization\", \"Bearer \" + oAuthService.getAccessToken());\n-      bodyProvider = new EnrollmentBodyProvider();\n-      bodyProvider.setTokenIdentifier(hashedTokenValue);\n-      bodyProvider.setCustomStudyId(studyId);\n-      requestBody = new HttpEntity<>(bodyProvider, headers);\n-      responseEntity =\n-          restTemplate.postForEntity(appConfig.getAddParticipantId(), requestBody, String.class);\n-      if (responseEntity.getStatusCode() == HttpStatus.OK) {\n-        participantId = (String) responseEntity.getBody();\n-        auditRequest.setParticipantId(participantId);\n-\n-        enrollAuditEventHelper.logEvent(PARTICIPANT_ID_RECEIVED, auditRequest);\n-      }\n-\n-    } catch (RestClientResponseException e) {\n-\n-      if (e.getRawStatusCode() == 401) {\n-        throw new UnAuthorizedRequestException();\n-      } else if (e.getRawStatusCode() == 400) {\n-        throw new InvalidRequestException();\n-      } else {\n-        throw new SystemException();\n-      }\n-    } catch (Exception e) {\n-\n-      enrollAuditEventHelper.logEvent(PARTICIPANT_ID_NOT_RECEIVED, auditRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMzc2MA==", "bodyText": "Added this audit log in catch and rethrowing the error.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r487123760", "createdAt": "2020-09-11T15:31:30Z", "author": {"login": "harisboston"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/util/EnrollmentManagementUtil.java", "diffHunk": "@@ -144,95 +138,63 @@ public String getParticipantId(\n       String applicationId,\n       String hashedTokenValue,\n       String studyId,\n-      AuditLogEventRequest auditRequest)\n-      throws InvalidRequestException, UnAuthorizedRequestException, SystemException {\n+      AuditLogEventRequest auditRequest) {\n     logger.info(\"EnrollmentManagementUtil getParticipantId() - starts \");\n     HttpHeaders headers = null;\n     EnrollmentBodyProvider bodyProvider = null;\n     HttpEntity<EnrollmentBodyProvider> requestBody = null;\n     ResponseEntity<?> responseEntity = null;\n     String participantId = \"\";\n-    try {\n-      headers = new HttpHeaders();\n-      headers.setContentType(MediaType.APPLICATION_JSON);\n-      headers.set(\"applicationId\", applicationId);\n-      headers.set(\"Authorization\", \"Bearer \" + oAuthService.getAccessToken());\n-      bodyProvider = new EnrollmentBodyProvider();\n-      bodyProvider.setTokenIdentifier(hashedTokenValue);\n-      bodyProvider.setCustomStudyId(studyId);\n-      requestBody = new HttpEntity<>(bodyProvider, headers);\n-      responseEntity =\n-          restTemplate.postForEntity(appConfig.getAddParticipantId(), requestBody, String.class);\n-      if (responseEntity.getStatusCode() == HttpStatus.OK) {\n-        participantId = (String) responseEntity.getBody();\n-        auditRequest.setParticipantId(participantId);\n-\n-        enrollAuditEventHelper.logEvent(PARTICIPANT_ID_RECEIVED, auditRequest);\n-      }\n-\n-    } catch (RestClientResponseException e) {\n-\n-      if (e.getRawStatusCode() == 401) {\n-        throw new UnAuthorizedRequestException();\n-      } else if (e.getRawStatusCode() == 400) {\n-        throw new InvalidRequestException();\n-      } else {\n-        throw new SystemException();\n-      }\n-    } catch (Exception e) {\n-\n-      enrollAuditEventHelper.logEvent(PARTICIPANT_ID_NOT_RECEIVED, auditRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NzUwNQ=="}, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDI0MTQ4OnYy", "diffSide": "LEFT", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/tests/StudyStateControllerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzowMzoyMFrOHQIm9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTozMzo0OVrOHQjwkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4MDMwOA==", "bodyText": "if you do add back the audit log event, make sure to re-include this as well", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r486680308", "createdAt": "2020-09-10T23:03:20Z", "author": {"login": "saminguyen"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/tests/StudyStateControllerTest.java", "diffHunk": "@@ -233,9 +224,7 @@ public void getStudyStateUnauthorizedUserId() throws Exception {\n                 .headers(headers)\n                 .contextPath(getContextPath()))\n         .andDo(print())\n-        .andExpect(status().isUnauthorized());\n-\n-    verifyAuditEventCall(READ_OPERATION_FAILED_FOR_STUDY_INFO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyNTEzNg==", "bodyText": "Added this event in test case.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r487125136", "createdAt": "2020-09-11T15:33:49Z", "author": {"login": "harisboston"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/tests/StudyStateControllerTest.java", "diffHunk": "@@ -233,9 +224,7 @@ public void getStudyStateUnauthorizedUserId() throws Exception {\n                 .headers(headers)\n                 .contextPath(getContextPath()))\n         .andDo(print())\n-        .andExpect(status().isUnauthorized());\n-\n-    verifyAuditEventCall(READ_OPERATION_FAILED_FOR_STUDY_INFO);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4MDMwOA=="}, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDI2ODA3OnYy", "diffSide": "LEFT", "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoxNjowNFrOHQI2vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTo0MTo1M1rOHQkD-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NDM1MA==", "bodyText": "Is this due to a change in the list of audit log events? Why deleting this here?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r486684350", "createdAt": "2020-09-10T23:16:04Z", "author": {"login": "saminguyen"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "diffHunk": "@@ -308,34 +284,9 @@ else if (enrollmentTokenfService.enrollmentTokenRequired(enrollmentBean.getStudy\n           ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n           ErrorResponseUtil.ErrorCodes.INVALID_INPUT_ERROR_MSG.getValue(),\n           response);\n-\n-      enrollAuditEventHelper.logEvent(STUDY_ENROLLMENT_FAILED, auditRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 369}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMDEwNg==", "bodyText": "Previously we were removing events which were logged in catch or failure case.\nReverted the changes for the same.\nAdded this audit-log event.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/923#discussion_r487130106", "createdAt": "2020-09-11T15:41:53Z", "author": {"login": "harisboston"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "diffHunk": "@@ -308,34 +284,9 @@ else if (enrollmentTokenfService.enrollmentTokenRequired(enrollmentBean.getStudy\n           ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n           ErrorResponseUtil.ErrorCodes.INVALID_INPUT_ERROR_MSG.getValue(),\n           response);\n-\n-      enrollAuditEventHelper.logEvent(STUDY_ENROLLMENT_FAILED, auditRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NDM1MA=="}, "originalCommit": {"oid": "3ed6cd8d5da1218258161dcaa80361ea20a8cf28"}, "originalPosition": 369}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1978, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}