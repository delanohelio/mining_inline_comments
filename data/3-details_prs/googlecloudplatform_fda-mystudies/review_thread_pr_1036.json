{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMjExMTg1", "number": 1036, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTo0MDo0OVrOEoJcYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo1MjoyMlrOEpnIeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTMzMjE2OnYy", "diffSide": "RIGHT", "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyInfoActivity.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTo0MDo0OVrOHZEc-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozNzo1MFrOHbWjLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0OTQwMw==", "bodyText": "The changes in this file do not seem to be related to the auth server integration, please remove all unrelated changes. Maybe add them to a follow up PR", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r496049403", "createdAt": "2020-09-28T15:40:49Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyInfoActivity.java", "diffHunk": "@@ -220,9 +223,61 @@ public void onClick(View view) {\n                 .readPreference(\n                     StudyInfoActivity.this, getResources().getString(R.string.userid), \"\")\n                 .equalsIgnoreCase(\"\")) {\n-              Intent intent = new Intent(StudyInfoActivity.this, SignInActivity.class);\n-              intent.putExtra(\"from\", \"StudyInfo\");\n-              startActivityForResult(intent, JOIN_ACTION_SIGIN);\n+              SharedPreferenceHelper.writePreference(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MzA1NQ==", "bodyText": "This is part of auth server integration because user can signin even they try to join the study.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498443055", "createdAt": "2020-10-01T18:37:50Z", "author": {"login": "naveenr-btc"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyInfoActivity.java", "diffHunk": "@@ -220,9 +223,61 @@ public void onClick(View view) {\n                 .readPreference(\n                     StudyInfoActivity.this, getResources().getString(R.string.userid), \"\")\n                 .equalsIgnoreCase(\"\")) {\n-              Intent intent = new Intent(StudyInfoActivity.this, SignInActivity.class);\n-              intent.putExtra(\"from\", \"StudyInfo\");\n-              startActivityForResult(intent, JOIN_ACTION_SIGIN);\n+              SharedPreferenceHelper.writePreference(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0OTQwMw=="}, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTM0NDQ3OnYy", "diffSide": "RIGHT", "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyFragment.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTo0Mzo1MVrOHZEkrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo0MDoxM1rOHbWn2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1MTM3Mg==", "bodyText": "can this be moved to a shared method?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r496051372", "createdAt": "2020-09-28T15:43:51Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyFragment.java", "diffHunk": "@@ -855,17 +850,14 @@ private void callGetStudyListWebservice() {\n         } else {\n           HashMap<String, String> header = new HashMap();\n           header.put(\n-              \"accessToken\",\n-              AppController.getHelperSharedPreference()\n-                  .readPreference(context, getResources().getString(R.string.auth), \"\"));\n+              \"Authorization\",\n+              \"Bearer \"\n+                  + AppController.getHelperSharedPreference()\n+                      .readPreference(context, getResources().getString(R.string.auth), \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0NDI1MA==", "bodyText": "Not all the auth server apis requires this header so we're are passing like this.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498444250", "createdAt": "2020-10-01T18:40:13Z", "author": {"login": "naveenr-btc"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/StudyFragment.java", "diffHunk": "@@ -855,17 +850,14 @@ private void callGetStudyListWebservice() {\n         } else {\n           HashMap<String, String> header = new HashMap();\n           header.put(\n-              \"accessToken\",\n-              AppController.getHelperSharedPreference()\n-                  .readPreference(context, getResources().getString(R.string.auth), \"\"));\n+              \"Authorization\",\n+              \"Bearer \"\n+                  + AppController.getHelperSharedPreference()\n+                      .readPreference(context, getResources().getString(R.string.auth), \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1MTM3Mg=="}, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTM4MDczOnYy", "diffSide": "RIGHT", "path": "Android/app/src/main/java/com/harvard/studyappmodule/consent/CustomConsentViewTaskActivity.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTo1MjowN1rOHZE6_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NzozNVrOHbYnaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NzA4Nw==", "bodyText": "This code is repeated all through the android code. Consider extracting setting common headers into a shared method?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r496057087", "createdAt": "2020-09-28T15:52:07Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/consent/CustomConsentViewTaskActivity.java", "diffHunk": "@@ -988,22 +980,18 @@ private String convertFileToString(String filepath) throws IOException {\n   private void getStudySate() {\n     HashMap<String, String> header = new HashMap();\n     header.put(\n-        \"accessToken\",\n-        AppController.getHelperSharedPreference()\n-            .readPreference(\n-                CustomConsentViewTaskActivity.this, getResources().getString(R.string.auth), \"\"));\n+        \"Authorization\",\n+        \"Bearer \"\n+            + AppController.getHelperSharedPreference()\n+                .readPreference(\n+                    CustomConsentViewTaskActivity.this,\n+                    getResources().getString(R.string.auth),\n+                    \"\"));\n     header.put(\n         \"userId\",\n         AppController.getHelperSharedPreference()\n             .readPreference(\n                 CustomConsentViewTaskActivity.this, getResources().getString(R.string.userid), \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NjkwNA==", "bodyText": "not addressed yet", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498476904", "createdAt": "2020-10-01T19:47:35Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/studyappmodule/consent/CustomConsentViewTaskActivity.java", "diffHunk": "@@ -988,22 +980,18 @@ private String convertFileToString(String filepath) throws IOException {\n   private void getStudySate() {\n     HashMap<String, String> header = new HashMap();\n     header.put(\n-        \"accessToken\",\n-        AppController.getHelperSharedPreference()\n-            .readPreference(\n-                CustomConsentViewTaskActivity.this, getResources().getString(R.string.auth), \"\"));\n+        \"Authorization\",\n+        \"Bearer \"\n+            + AppController.getHelperSharedPreference()\n+                .readPreference(\n+                    CustomConsentViewTaskActivity.this,\n+                    getResources().getString(R.string.auth),\n+                    \"\"));\n     header.put(\n         \"userId\",\n         AppController.getHelperSharedPreference()\n             .readPreference(\n                 CustomConsentViewTaskActivity.this, getResources().getString(R.string.userid), \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NzA4Nw=="}, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTM5Mzk0OnYy", "diffSide": "RIGHT", "path": "Android/app/src/main/java/com/harvard/webservicemodule/apihelper/ApiCall.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTo1NTowMFrOHZFC8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo0MTowNVrOHbWpcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTEyMA==", "bodyText": "why is client_id a url?\nshouldn't it be coming from the build configs instead?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r496059120", "createdAt": "2020-09-28T15:55:00Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/webservicemodule/apihelper/ApiCall.java", "diffHunk": "@@ -280,7 +280,7 @@ protected final String doInBackground(T... params) {\n               SharedPreferenceHelper.readPreference(\n                   context, context.getString(R.string.userid), \"\"));\n           refreshTokenJsonData.put(\"redirect_uri\", Urls.AUTH_SERVER_REDIRECT_URL);\n-          refreshTokenJsonData.put(\"client_id\", \"oauth-scim-client-id\");\n+          refreshTokenJsonData.put(\"client_id\", Urls.AUTH_CLIENT_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0NDY1OQ==", "bodyText": "I've addressed it in Pr #1110", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498444659", "createdAt": "2020-10-01T18:41:05Z", "author": {"login": "naveenr-btc"}, "path": "Android/app/src/main/java/com/harvard/webservicemodule/apihelper/ApiCall.java", "diffHunk": "@@ -280,7 +280,7 @@ protected final String doInBackground(T... params) {\n               SharedPreferenceHelper.readPreference(\n                   context, context.getString(R.string.userid), \"\"));\n           refreshTokenJsonData.put(\"redirect_uri\", Urls.AUTH_SERVER_REDIRECT_URL);\n-          refreshTokenJsonData.put(\"client_id\", \"oauth-scim-client-id\");\n+          refreshTokenJsonData.put(\"client_id\", Urls.AUTH_CLIENT_ID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTEyMA=="}, "originalCommit": {"oid": "4b3c946548fd99428a693e6bb47a50d00f2dfcc2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDY0MjI3OnYy", "diffSide": "RIGHT", "path": "Android/app/src/androidTest/java/com/harvard/usermodule/AuthServerWebServiceTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTozNzo0NlrOHbYV6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTozNzo0NlrOHbYV6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MjQyNQ==", "bodyText": "typo?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498472425", "createdAt": "2020-10-01T19:37:46Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/androidTest/java/com/harvard/usermodule/AuthServerWebServiceTest.java", "diffHunk": "@@ -0,0 +1,312 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.harvard.usermodule;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+\n+import android.support.test.InstrumentationRegistry;\n+import android.support.test.runner.AndroidJUnit4;\n+import com.google.gson.Gson;\n+import com.harvard.usermodule.webservicemodel.ChangePasswordData;\n+import com.harvard.usermodule.webservicemodel.LoginData;\n+import com.harvard.usermodule.webservicemodel.TokenData;\n+import com.harvard.webservicemodule.apihelper.ApiCall;\n+import com.harvard.webservicemodule.apihelper.ApiCallSyncronizer;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.HashMap;\n+import okhttp3.mockwebserver.Dispatcher;\n+import okhttp3.mockwebserver.MockResponse;\n+import okhttp3.mockwebserver.MockWebServer;\n+import okhttp3.mockwebserver.RecordedRequest;\n+import org.jetbrains.annotations.NotNull;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class AuthServerWebServiceTest {\n+  private ApiCallSyncronizer async = null;\n+  private static final int RESULT_CODE = 100;\n+  private static final String RESPONSE_CODE = \"200\";\n+  private static final String PARAMS_EMAIL_KEY = \"email\";\n+  private static final String PARAMS_EMAIL_VALUE = \"test@grr.la\";\n+  private static final String PARAMS_APPID_KEY = \"appId\";\n+  private static final String PARAMS_APPID_VALUE = \"GCPMS001\";\n+  private static final String SERVER_TYPE_AUTH_SERVER = \"AuthServer\";\n+  private static final String PARAMS_CURRENT_PASS_KEY = \"currentPassword\";\n+  private static final String PARAMS_CURRENT_PASS_VALUE = \"$r04T!3tEkD%\";\n+  private static final String PARAMS_NEW_PASS_KEY = \"newPassword\";\n+  private static final String PARAMS_NEW_PASS_VALUE = \"Test@b0ston_2\";\n+  private static final String PARAMS_AOUTH_GRANT_TYPE_KEY = \"grant_type\";\n+  private static final String PARAMS_AOUTH_REDIRECT_URL_KEY = \"redirect_uri\";\n+  private static final String PARAMS_AOUTH_CLIENT_ID_KEY = \"client_id\";\n+  private static final String PARAMS_AOUTH_REFRESH_TOKEN_KEY = \"refresh_token\";\n+  private static final String PARAMS_AOUTH_USERID_KEY = \"userId\";\n+  private static final String PARAMS_AOUTH_GRANT_TYPE_VALUE = \"refresh_token\";\n+  private static final String PARAMS_AOUTH_REDIRECT_URL_VALUE =\n+      \"https://localhost:8085/qa/oauth-scim-service/login\";\n+  private static final String PARAMS_AOUTH_CLIENT_ID_VALUE = \"oauth-scimefre-cliente-id\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a07ef4c15db0cb90461553e17908794740ef1ca5"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDY4MjE2OnYy", "diffSide": "RIGHT", "path": "Android/app/src/main/java/com/harvard/usermodule/VerificationStepActivity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo1MjoyMlrOHbYwIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo1MjoyMlrOHbYwIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3OTEzNw==", "bodyText": "should the code fail if getIntent is null? or invalid?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1036#discussion_r498479137", "createdAt": "2020-10-01T19:52:22Z", "author": {"login": "zohrehj"}, "path": "Android/app/src/main/java/com/harvard/usermodule/VerificationStepActivity.java", "diffHunk": "@@ -247,50 +247,28 @@ protected void onDestroy() {\n     AppController.getHelperProgressDialog().dismissDialog();\n     if (responseCode == CONFIRM_REGISTER_USER_RESPONSE) {\n       LoginData loginData = (LoginData) response;\n-      if (from != null && from.equalsIgnoreCase(ForgotPasswordActivity.FROM)) {\n-        Toast.makeText(\n-                this, getResources().getString(R.string.account_verification), Toast.LENGTH_SHORT)\n-            .show();\n-        Intent intent = new Intent();\n-        setResult(RESULT_OK, intent);\n-        finish();\n-      } else if (from != null && from.equalsIgnoreCase(\"StudyInfo\")) {\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.userid), \"\" + userId);\n-        AppController.getHelperSharedPreference()\n-            .writePreference(VerificationStepActivity.this, getString(R.string.auth), \"\" + auth);\n-        AppController.getHelperSharedPreference()\n-            .writePreference(VerificationStepActivity.this, getString(R.string.verified), \"true\");\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.email), \"\" + emailId);\n-\n-        Intent intent = new Intent(VerificationStepActivity.this, NewPasscodeSetupActivity.class);\n-        intent.putExtra(\"from\", \"StudyInfo\");\n-        startActivityForResult(intent, JOIN_STUDY_RESPONSE);\n-\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.initialpasscodeset), \"NO\");\n-      } else {\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.userid), \"\" + userId);\n-        AppController.getHelperSharedPreference()\n-            .writePreference(VerificationStepActivity.this, getString(R.string.auth), \"\" + auth);\n-        AppController.getHelperSharedPreference()\n-            .writePreference(VerificationStepActivity.this, getString(R.string.verified), \"true\");\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.email), \"\" + emailId);\n-\n-        Intent intent = new Intent(VerificationStepActivity.this, NewPasscodeSetupActivity.class);\n-        startActivity(intent);\n-        AppController.getHelperSharedPreference()\n-            .writePreference(\n-                VerificationStepActivity.this, getString(R.string.initialpasscodeset), \"NO\");\n+      SharedPreferenceHelper.writePreference(\n+          VerificationStepActivity.this, getString(R.string.logintype), \"signUp\");\n+      CustomTabsIntent customTabsIntent =\n+          new CustomTabsIntent.Builder()\n+              .setToolbarColor(getResources().getColor(R.color.colorAccent))\n+              .setShowTitle(true)\n+              .setCloseButtonIcon(\n+                  BitmapFactory.decodeResource(getResources(), R.drawable.backeligibility))\n+              .setStartAnimations(\n+                  VerificationStepActivity.this, R.anim.slide_in_right, R.anim.slide_out_left)\n+              .setExitAnimations(\n+                  VerificationStepActivity.this, R.anim.slide_in_left, R.anim.slide_out_right)\n+              .build();\n+      StringBuilder loginUrl = new StringBuilder();\n+      loginUrl.append(Urls.LOGIN_URL);\n+      if (getIntent().getStringExtra(\"type\") != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a07ef4c15db0cb90461553e17908794740ef1ca5"}, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1825, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}