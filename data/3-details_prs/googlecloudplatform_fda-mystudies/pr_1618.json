{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDI4NzU4", "number": 1618, "title": "Add script to register applications in hydra", "bodyText": "", "createdAt": "2020-10-22T16:52:05Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618", "merged": true, "mergeCommit": {"oid": "c8a0e544ba968653bb5da7cc9368f16be3aee63a"}, "closed": true, "closedAt": "2020-10-26T15:55:07Z", "author": {"login": "zohrehj"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVE2I8AH2gAyNTA4NDI4NzU4OjZlNWQ2NzA1MTIzNTJiMWFhODcxZjc0YjAxZGE3MjVlMmUxMjVmMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWWG-dAFqTUxNjg5Nzk0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e5d670512352b1aa871f74b01da725e2e125f18", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6e5d670512352b1aa871f74b01da725e2e125f18", "committedDate": "2020-10-22T16:48:24Z", "message": "Add script to register applications in hydra"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b329665e3521e7fa76f65a3c955e2ac02108e58d", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b329665e3521e7fa76f65a3c955e2ac02108e58d", "committedDate": "2020-10-22T16:51:27Z", "message": "Fix mixed up steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/150442937ff87fd622fe5595422e43f5f86517d7", "committedDate": "2020-10-22T19:38:12Z", "message": "Merge branch 'develop' into hydra-script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTczOTk3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#pullrequestreview-515973997", "createdAt": "2020-10-23T19:57:44Z", "commit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1Nzo0NFrOHncwqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1Nzo0NFrOHncwqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzcyMA==", "bodyText": "remove trailing space", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127720", "createdAt": "2020-10-23T19:57:44Z", "author": {"login": "xingao267"}, "path": "deployment.md", "diffHunk": "@@ -301,14 +301,16 @@ regenerating the Terraform configs several times.\n \n ### Step 9: Secrets setup\n \n-1. Modify [copy_client_info_to_sql.sh](./scripts/copy_client_info_to_sql.sh) to\n-    reflect proper {PREFIX} and {ENV}, and run to copy client info from secrets\n-    into CloudSQL.\n+1. Run\n+   [register_clients_in_hydra.sh $PREFIX $ENV](./scripts/register_clients_in_hydra.sh.sh), \n+   passing your deployment PREFIX and ENV as parameters. \n+   This script will register each application in hydra using the generated \n+   client id and secret keys.\n \n 1. Modify\n-    [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n-    to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from\n-    secrets into CloudSQL.\n+   [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n+   to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTc0MTY2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#pullrequestreview-515974166", "createdAt": "2020-10-23T19:58:02Z", "commit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1ODowM1rOHncxEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1ODowM1rOHncxEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw==", "bodyText": "license header", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127827", "createdAt": "2020-10-23T19:58:03Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTc1MzIz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#pullrequestreview-515975323", "createdAt": "2020-10-23T20:00:13Z", "commit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMDoxM1rOHnc02Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMDoxM1rOHnc02Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyODc5Mw==", "bodyText": "remove the second empty line", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511128793", "createdAt": "2020-10-23T20:00:13Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\\n+--header \"Accept: application/json\" \\\n+--data-raw \"{\n+  \\\"client_id\\\": \\\"${CLIENT_ID}\\\",\n+  \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+  \\\"client_secret\\\": \\\"${CLIENT_SECRET}\\\",\n+  \\\"client_secret_expires_at\\\": 0,\n+  \\\"created_at\\\": \\\"${DATETIME}\\\",\n+  \\\"grant_types\\\": [\\\"client_credentials\\\"],\n+  \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+  \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+\n+  echo \"${OUTPUT}\"\n+done\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTc1ODA3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#pullrequestreview-515975807", "createdAt": "2020-10-23T20:01:10Z", "commit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMToxMFrOHnc2ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMToxMFrOHnc2ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTE4OQ==", "bodyText": "nit: indentation", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511129189", "createdAt": "2020-10-23T20:01:10Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81677ebf916081358dfca74276e52aca03bad025", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/81677ebf916081358dfca74276e52aca03bad025", "committedDate": "2020-10-26T14:22:43Z", "message": "Merge branch 'develop' into hydra-script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a4f9efc567d1ddd5cc9694603104295535909d", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7a4f9efc567d1ddd5cc9694603104295535909d", "committedDate": "2020-10-26T14:35:13Z", "message": "Add copyright header to all scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5275b8ee5074b023fe8f5a44f2ed28ed59a87be3", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5275b8ee5074b023fe8f5a44f2ed28ed59a87be3", "committedDate": "2020-10-26T14:36:40Z", "message": "Fix indentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODk3OTQy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#pullrequestreview-516897942", "createdAt": "2020-10-26T15:29:06Z", "commit": {"oid": "5275b8ee5074b023fe8f5a44f2ed28ed59a87be3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 169, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}