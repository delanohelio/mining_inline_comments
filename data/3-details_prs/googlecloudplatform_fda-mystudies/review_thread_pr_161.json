{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjYyNzEy", "number": 161, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1MDozMFrODypseg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDowNTo0M1rODyp_2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDM4NTIyOnYy", "diffSide": "RIGHT", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/main.tf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1MDozMFrOGG0xnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDoxMjoxMlrOGG1dxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTMxMQ==", "bodyText": "nit: do we need the -sa suffix?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409809311", "createdAt": "2020-04-16T19:50:30Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/main.tf", "diffHunk": "@@ -31,3 +31,22 @@ module \"heroes_hat_cluster\" {\n   # Need to either disable private endpoint, or enable master auth networks.\n   enable_private_endpoint = false\n }\n+\n+# Create a separate service account for each app.\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+\n+resource \"google_service_account\" \"apps_service_accounts\" {\n+  for_each = toset(local.apps)\n+\n+  account_id  = \"${each.key}-gke-sa\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMDYxNQ==", "bodyText": "I guess not.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409820615", "createdAt": "2020-04-16T20:12:12Z", "author": {"login": "MartinPetkov"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/main.tf", "diffHunk": "@@ -31,3 +31,22 @@ module \"heroes_hat_cluster\" {\n   # Need to either disable private endpoint, or enable master auth networks.\n   enable_private_endpoint = false\n }\n+\n+# Create a separate service account for each app.\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+\n+resource \"google_service_account\" \"apps_service_accounts\" {\n+  for_each = toset(local.apps)\n+\n+  account_id  = \"${each.key}-gke-sa\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTMxMQ=="}, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDQwNTE4OnYy", "diffSide": "RIGHT", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1NjozN1rOGG0-Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1NjozN1rOGG0-Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMjUyMw==", "bodyText": "can we move this to a new file secrets.tf or something?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409812523", "createdAt": "2020-04-16T19:56:37Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDQyOTIyOnYy", "diffSide": "RIGHT", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDowMzo0NVrOGG1NHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDoxNjozMlrOGG1mZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjM1MQ==", "bodyText": "add new line", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816351", "createdAt": "2020-04-16T20:03:45Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+resource \"random_password\" \"db_passwords\" {\n+  for_each = toset(local.apps)\n+\n+  length  = 16\n+  special = true\n+}\n+resource \"google_sql_user\" \"db_users\" {\n+  for_each = toset(local.apps)\n+\n+  name     = \"${each.key}-db-user\"\n+  instance = module.my_studies_cloudsql.instance_name\n+  host     = \"%\"\n+  password = random_password.db_passwords[each.key].result\n+}\n+\n+resource \"google_secret_manager_secret\" \"db_passwords_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-password\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+resource \"google_secret_manager_secret\" \"db_users_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-user\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+\n+resource \"google_secret_manager_secret_version\" \"db_passwords_secrets_values\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret      = google_secret_manager_secret.db_passwords_secrets[each.key].id\n+  secret_data = random_password.db_passwords[each.key].result\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMjgyMw==", "bodyText": "Done.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409822823", "createdAt": "2020-04-16T20:16:32Z", "author": {"login": "MartinPetkov"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+resource \"random_password\" \"db_passwords\" {\n+  for_each = toset(local.apps)\n+\n+  length  = 16\n+  special = true\n+}\n+resource \"google_sql_user\" \"db_users\" {\n+  for_each = toset(local.apps)\n+\n+  name     = \"${each.key}-db-user\"\n+  instance = module.my_studies_cloudsql.instance_name\n+  host     = \"%\"\n+  password = random_password.db_passwords[each.key].result\n+}\n+\n+resource \"google_secret_manager_secret\" \"db_passwords_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-password\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+resource \"google_secret_manager_secret\" \"db_users_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-user\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+\n+resource \"google_secret_manager_secret_version\" \"db_passwords_secrets_values\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret      = google_secret_manager_secret.db_passwords_secrets[each.key].id\n+  secret_data = random_password.db_passwords[each.key].result\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjM1MQ=="}, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDQzMzExOnYy", "diffSide": "RIGHT", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/outputs.tf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDowNTowNlrOGG1Plg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDoxNzoyOVrOGG1oRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjk4Mg==", "bodyText": "we shouldn't output password as it will show up when someone runs terraform apply", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816982", "createdAt": "2020-04-16T20:05:06Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/outputs.tf", "diffHunk": "@@ -0,0 +1,12 @@\n+output \"instance_name\" {\n+  value = module.my_studies_cloudsql.instance_name\n+}\n+\n+# This is not outputted by the safer_sql module, but allow dependents to treat\n+# it like it is.\n+output \"instance_user\" {\n+  value = \"default\"\n+}\n+output \"instance_user_password\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMzMwMw==", "bodyText": "Done.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409823303", "createdAt": "2020-04-16T20:17:29Z", "author": {"login": "MartinPetkov"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/outputs.tf", "diffHunk": "@@ -0,0 +1,12 @@\n+output \"instance_name\" {\n+  value = module.my_studies_cloudsql.instance_name\n+}\n+\n+# This is not outputted by the safer_sql module, but allow dependents to treat\n+# it like it is.\n+output \"instance_user\" {\n+  value = \"default\"\n+}\n+output \"instance_user_password\" {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjk4Mg=="}, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDQzNDgzOnYy", "diffSide": "RIGHT", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/iam/terragrunt.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDowNTo0M1rOGG1Qrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDoxODo0NFrOGG1qow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNzI2Mg==", "bodyText": "maybe fill in with a dummy value?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409817262", "createdAt": "2020-04-16T20:05:43Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/iam/terragrunt.hcl", "diffHunk": "@@ -11,7 +11,8 @@ dependency \"apps\" {\n   config_path = \"../../project.heroes-hat-dev-apps/apps\"\n \n   mock_outputs = {\n-    service_account = \"mock-gke-service-account\"\n+    service_account       = \"mock-gke-service-account\"\n+    apps_service_accounts = {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMzkwNw==", "bodyText": "Done.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409823907", "createdAt": "2020-04-16T20:18:44Z", "author": {"login": "MartinPetkov"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/iam/terragrunt.hcl", "diffHunk": "@@ -11,7 +11,8 @@ dependency \"apps\" {\n   config_path = \"../../project.heroes-hat-dev-apps/apps\"\n \n   mock_outputs = {\n-    service_account = \"mock-gke-service-account\"\n+    service_account       = \"mock-gke-service-account\"\n+    apps_service_accounts = {}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNzI2Mg=="}, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1327, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}