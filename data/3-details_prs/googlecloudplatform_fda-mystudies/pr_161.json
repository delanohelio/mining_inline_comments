{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjYyNzEy", "number": 161, "title": "Add multiple DB credentials and roles/cloudsql.client for the GKE SAs", "bodyText": "In support of using different credentials for each GKE app.", "createdAt": "2020-04-16T19:49:13Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161", "merged": true, "mergeCommit": {"oid": "188b6531831d4edd4a58925a0c8cf2722e984e92"}, "closed": true, "closedAt": "2020-04-17T14:52:43Z", "author": {"login": "MartinPetkov"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYSInbAH2gAyNDA0NjYyNzEyOjQ1NGQ4YzYxNmIyY2FhM2JjYTNjYjdmMDY2ZTRmOTJjZDk4MTE1NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYiZncgH2gAyNDA0NjYyNzEyOmU4NzU2YjIwZTM4ZWNmNmFjMmM5MWMwMWQ2MzJmNmU0OGE3MzZiZGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/454d8c616b2caa3bca3cb7f066e4f92cd981156e", "committedDate": "2020-04-16T19:47:58Z", "message": "Add multiple GKE service accounts and DB creds\n\nIn support of using different credentials for each GKE app."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTUwNTE0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#pullrequestreview-394950514", "createdAt": "2020-04-16T19:50:30Z", "commit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1MDozMFrOGG0xnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDowNTo0M1rOGG1Qrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTMxMQ==", "bodyText": "nit: do we need the -sa suffix?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409809311", "createdAt": "2020-04-16T19:50:30Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/main.tf", "diffHunk": "@@ -31,3 +31,22 @@ module \"heroes_hat_cluster\" {\n   # Need to either disable private endpoint, or enable master auth networks.\n   enable_private_endpoint = false\n }\n+\n+# Create a separate service account for each app.\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+\n+resource \"google_service_account\" \"apps_service_accounts\" {\n+  for_each = toset(local.apps)\n+\n+  account_id  = \"${each.key}-gke-sa\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMjUyMw==", "bodyText": "can we move this to a new file secrets.tf or something?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409812523", "createdAt": "2020-04-16T19:56:37Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjM1MQ==", "bodyText": "add new line", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816351", "createdAt": "2020-04-16T20:03:45Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+resource \"random_password\" \"db_passwords\" {\n+  for_each = toset(local.apps)\n+\n+  length  = 16\n+  special = true\n+}\n+resource \"google_sql_user\" \"db_users\" {\n+  for_each = toset(local.apps)\n+\n+  name     = \"${each.key}-db-user\"\n+  instance = module.my_studies_cloudsql.instance_name\n+  host     = \"%\"\n+  password = random_password.db_passwords[each.key].result\n+}\n+\n+resource \"google_secret_manager_secret\" \"db_passwords_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-password\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+resource \"google_secret_manager_secret\" \"db_users_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-user\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+\n+resource \"google_secret_manager_secret_version\" \"db_passwords_secrets_values\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret      = google_secret_manager_secret.db_passwords_secrets[each.key].id\n+  secret_data = random_password.db_passwords[each.key].result\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjk4Mg==", "bodyText": "we shouldn't output password as it will show up when someone runs terraform apply", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816982", "createdAt": "2020-04-16T20:05:06Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/outputs.tf", "diffHunk": "@@ -0,0 +1,12 @@\n+output \"instance_name\" {\n+  value = module.my_studies_cloudsql.instance_name\n+}\n+\n+# This is not outputted by the safer_sql module, but allow dependents to treat\n+# it like it is.\n+output \"instance_user\" {\n+  value = \"default\"\n+}\n+output \"instance_user_password\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNzI2Mg==", "bodyText": "maybe fill in with a dummy value?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409817262", "createdAt": "2020-04-16T20:05:43Z", "author": {"login": "umairidris"}, "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/iam/terragrunt.hcl", "diffHunk": "@@ -11,7 +11,8 @@ dependency \"apps\" {\n   config_path = \"../../project.heroes-hat-dev-apps/apps\"\n \n   mock_outputs = {\n-    service_account = \"mock-gke-service-account\"\n+    service_account       = \"mock-gke-service-account\"\n+    apps_service_accounts = {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4ed3680bd64ecb237c45d652cfde0bda722a7b0", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d4ed3680bd64ecb237c45d652cfde0bda722a7b0", "committedDate": "2020-04-16T20:21:00Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d512d1962cb986db576974788181ca8fb09e4f", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29d512d1962cb986db576974788181ca8fb09e4f", "committedDate": "2020-04-17T13:35:52Z", "message": "Merge branch 'terraform' into add-multiple-gke-sas-and-db-creds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493f634fd157d22c8d0de8938d55d55db3c7770a", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/493f634fd157d22c8d0de8938d55d55db3c7770a", "committedDate": "2020-04-17T13:52:26Z", "message": "Move GKE SAs out, they're a separate PR now\n\nPR: https://github.com/GoogleCloudPlatform/fda-mystudies/pull/168"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTE0NDI2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#pullrequestreview-395514426", "createdAt": "2020-04-17T14:40:44Z", "commit": {"oid": "493f634fd157d22c8d0de8938d55d55db3c7770a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8756b20e38ecf6ac2c91c01d632f6e48a736bdd", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e8756b20e38ecf6ac2c91c01d632f6e48a736bdd", "committedDate": "2020-04-17T14:45:01Z", "message": "Merge branch 'terraform' into add-multiple-gke-sas-and-db-creds"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1319, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}