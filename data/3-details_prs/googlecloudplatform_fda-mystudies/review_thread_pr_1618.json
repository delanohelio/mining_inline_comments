{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDI4NzU4", "number": 1618, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1Nzo0NFrOExW3yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMToxMFrOExW7ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTkwNDA4OnYy", "diffSide": "RIGHT", "path": "deployment.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1Nzo0NFrOHncwqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDozNToyN1rOHoSfjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzcyMA==", "bodyText": "remove trailing space", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127720", "createdAt": "2020-10-23T19:57:44Z", "author": {"login": "xingao267"}, "path": "deployment.md", "diffHunk": "@@ -301,14 +301,16 @@ regenerating the Terraform configs several times.\n \n ### Step 9: Secrets setup\n \n-1. Modify [copy_client_info_to_sql.sh](./scripts/copy_client_info_to_sql.sh) to\n-    reflect proper {PREFIX} and {ENV}, and run to copy client info from secrets\n-    into CloudSQL.\n+1. Run\n+   [register_clients_in_hydra.sh $PREFIX $ENV](./scripts/register_clients_in_hydra.sh.sh), \n+   passing your deployment PREFIX and ENV as parameters. \n+   This script will register each application in hydra using the generated \n+   client id and secret keys.\n \n 1. Modify\n-    [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n-    to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from\n-    secrets into CloudSQL.\n+   [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n+   to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwODA3Ng==", "bodyText": "fixed.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512008076", "createdAt": "2020-10-26T14:35:27Z", "author": {"login": "zohrehj"}, "path": "deployment.md", "diffHunk": "@@ -301,14 +301,16 @@ regenerating the Terraform configs several times.\n \n ### Step 9: Secrets setup\n \n-1. Modify [copy_client_info_to_sql.sh](./scripts/copy_client_info_to_sql.sh) to\n-    reflect proper {PREFIX} and {ENV}, and run to copy client info from secrets\n-    into CloudSQL.\n+1. Run\n+   [register_clients_in_hydra.sh $PREFIX $ENV](./scripts/register_clients_in_hydra.sh.sh), \n+   passing your deployment PREFIX and ENV as parameters. \n+   This script will register each application in hydra using the generated \n+   client id and secret keys.\n \n 1. Modify\n-    [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n-    to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from\n-    secrets into CloudSQL.\n+   [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n+   to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzcyMA=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTkwNDgwOnYy", "diffSide": "RIGHT", "path": "scripts/register_clients_in_hydra.sh", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOTo1ODowM1rOHncxEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNToyNToxMlrOHoU66Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw==", "bodyText": "license header", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127827", "createdAt": "2020-10-23T19:58:03Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwODIwOQ==", "bodyText": "added to all scripts.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512008209", "createdAt": "2020-10-26T14:35:37Z", "author": {"login": "zohrehj"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAzMzMyOQ==", "bodyText": "just curious why MIT license is used here? Apache 2.0 is usually the default.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512033329", "createdAt": "2020-10-26T15:06:51Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA0Nzg0OQ==", "bodyText": "MIT is the repository's default license (all Google generated code is in MIT), only the terraform assets are in Apache 2.0 and I assumed that was because a decision on the DPT side.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512047849", "createdAt": "2020-10-26T15:25:12Z", "author": {"login": "zohrehj"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTkxMTE1OnYy", "diffSide": "RIGHT", "path": "scripts/register_clients_in_hydra.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMDoxM1rOHnc02Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDozNjo1MlrOHoSkHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyODc5Mw==", "bodyText": "remove the second empty line", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511128793", "createdAt": "2020-10-23T20:00:13Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\\n+--header \"Accept: application/json\" \\\n+--data-raw \"{\n+  \\\"client_id\\\": \\\"${CLIENT_ID}\\\",\n+  \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+  \\\"client_secret\\\": \\\"${CLIENT_SECRET}\\\",\n+  \\\"client_secret_expires_at\\\": 0,\n+  \\\"created_at\\\": \\\"${DATETIME}\\\",\n+  \\\"grant_types\\\": [\\\"client_credentials\\\"],\n+  \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+  \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+\n+  echo \"${OUTPUT}\"\n+done\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwOTI0Ng==", "bodyText": "fixed.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512009246", "createdAt": "2020-10-26T14:36:52Z", "author": {"login": "zohrehj"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\\n+--header \"Accept: application/json\" \\\n+--data-raw \"{\n+  \\\"client_id\\\": \\\"${CLIENT_ID}\\\",\n+  \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+  \\\"client_secret\\\": \\\"${CLIENT_SECRET}\\\",\n+  \\\"client_secret_expires_at\\\": 0,\n+  \\\"created_at\\\": \\\"${DATETIME}\\\",\n+  \\\"grant_types\\\": [\\\"client_credentials\\\"],\n+  \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+  \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+\n+  echo \"${OUTPUT}\"\n+done\n+\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyODc5Mw=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTkxMzcwOnYy", "diffSide": "RIGHT", "path": "scripts/register_clients_in_hydra.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDowMToxMFrOHnc2ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDozNjo1N1rOHoSkaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTE4OQ==", "bodyText": "nit: indentation", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511129189", "createdAt": "2020-10-23T20:01:10Z", "author": {"login": "xingao267"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwOTMyMA==", "bodyText": "done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512009320", "createdAt": "2020-10-26T14:36:57Z", "author": {"login": "zohrehj"}, "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTE4OQ=="}, "originalCommit": {"oid": "150442937ff87fd622fe5595422e43f5f86517d7"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1712, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}