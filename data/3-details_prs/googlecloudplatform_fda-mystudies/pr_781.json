{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODMxMTcx", "number": 781, "title": "User Management Service - Audit Log Implementation", "bodyText": "Removed old audit log implementation methods - createActivityLog() from commonService\nRemoved ActivityLog and ActivityLogRepository\nImplemented audit log events listed in HIPAA-grade Audit Logs - FDA MyStudies on Google Cloud -EAP V3.1-2020-08-01 - UserMgmt(Participant Datastore)", "createdAt": "2020-08-20T10:57:29Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781", "merged": true, "mergeCommit": {"oid": "81dc8e1bd517355c90855439d47a39883f3493ee"}, "closed": true, "closedAt": "2020-08-26T14:00:20Z", "author": {"login": "navya-BTC"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAt-PmgH2gAyNDcwODMxMTcxOjdlNTdlMzAyOGM2NTk2NTZkZjIzYjljMDI2YmU1YjA1Y2Y0NzMzMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCsNUJgFqTQ3NTUxMzk3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e57e3028c659656df23b9c026be5b05cf473316", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7e57e3028c659656df23b9c026be5b05cf473316", "committedDate": "2020-08-20T10:50:57Z", "message": "Audit Log Implementation for User Management\n\nAudit Log Implementation for User Management"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5de6b5ea4c93a717c8840f262edb4b94c61668aa", "committedDate": "2020-08-20T13:03:04Z", "message": "Merge branch 'develop' into user-mgmt-auditlog-with-commons"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjY2NTUw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#pullrequestreview-472666550", "createdAt": "2020-08-21T17:29:14Z", "commit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzoyOToxNVrOHE1ccw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMDowMjo1MVrOHE61bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMTk4Nw==", "bodyText": "missing copyright header", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474831987", "createdAt": "2020-08-21T17:29:15Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/common/UserMgmntAuditHelper.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.google.cloud.healthcare.fdamystudies.common;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMjQxNw==", "bodyText": "please remove if not needed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474832417", "createdAt": "2020-08-21T17:30:07Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/config/BeanConfig.java", "diffHunk": "@@ -46,8 +45,8 @@ public void addCorsMappings(CorsRegistry registry) {\n     return authenticationBean;\n   }\n \n-  @Bean\n+  /* @Bean\n   public RestTemplate restTemplate() {\n     return new RestTemplate();\n-  }\n+  }*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkwMjczOA==", "bodyText": "shouldn't this be  isAfter?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474902738", "createdAt": "2020-08-21T19:41:22Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/VerifyEmailIdController.java", "diffHunk": "@@ -76,20 +97,36 @@\n         participantDetails = getParticipantDetails(verificationForm, appOrgInfoBean);\n       }\n       if (participantDetails == null) {\n+        userMgmntAuditHelper.logEvent(\n+            ACCOUNT_ACTIVATION_USER_EMAIL_VERIFICATION_FAILED, auditRequest);\n+\n         ResponseBean responseBean =\n             ResponseUtil.prepareBadRequestResponse(response, AppConstants.EMAIL_NOT_EXISTS);\n         return new ResponseEntity<>(responseBean, HttpStatus.BAD_REQUEST);\n       }\n       boolean verifyEmailCodeResponse =\n           userDetailsService.verifyCode(verificationForm.getCode().trim(), participantDetails);\n \n+      if (!verificationForm.getCode().trim().equals(participantDetails.getEmailCode())) {\n+        userMgmntAuditHelper.logEvent(\n+            ACCOUNT_ACTIVATION_USER_EMAIL_VERIFICATION_FAILED_WRONG_CODE, auditRequest);\n+      } else if (LocalDateTime.now().isBefore(participantDetails.getCodeExpireDate())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxMjkwMQ==", "bodyText": "move these values into contants, enum probably", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474912901", "createdAt": "2020-08-21T19:53:44Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -254,21 +268,64 @@ public String deActivateAcct(\n             studyBean.setDelete(studyReqBean.getDelete());\n             studyBean.setStudyId(studyReqBean.getStudyId());\n             deleteData.add(studyReqBean.getStudyId());\n+\n+            auditRequest.setStudyId(studyBean.getStudyId());\n+            auditRequest.setParticipantId(studyBean.getParticipantId());\n+\n             retVal =\n                 userManagementUtil.withdrawParticipantFromStudy(\n-                    studyBean.getParticipantId(), studyBean.getStudyId(), studyBean.getDelete());\n+                    studyBean.getParticipantId(),\n+                    studyBean.getStudyId(),\n+                    studyBean.getDelete(),\n+                    auditRequest);\n+\n+            if (Boolean.valueOf(studyReqBean.getDelete())) {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"delete\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxNTE1NA==", "bodyText": "this looks like an overkill for a small map with one element", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474915154", "createdAt": "2020-08-21T19:56:33Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -254,21 +268,64 @@ public String deActivateAcct(\n             studyBean.setDelete(studyReqBean.getDelete());\n             studyBean.setStudyId(studyReqBean.getStudyId());\n             deleteData.add(studyReqBean.getStudyId());\n+\n+            auditRequest.setStudyId(studyBean.getStudyId());\n+            auditRequest.setParticipantId(studyBean.getParticipantId());\n+\n             retVal =\n                 userManagementUtil.withdrawParticipantFromStudy(\n-                    studyBean.getParticipantId(), studyBean.getStudyId(), studyBean.getDelete());\n+                    studyBean.getParticipantId(),\n+                    studyBean.getStudyId(),\n+                    studyBean.getDelete(),\n+                    auditRequest);\n+\n+            if (Boolean.valueOf(studyReqBean.getDelete())) {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"delete\"},\n+                          })\n+                      .collect(Collectors.toMap(data -> data[0], data -> data[1]));\n+\n+              userMgmntAuditHelper.logEvent(\n+                  DATA_RETENTION_SETTING_CAPTURED_ON_WITHDRAWAL, auditRequest, map);\n+\n+              AuditLogEvent auditEvent =\n+                  retVal.equalsIgnoreCase(MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue())\n+                      ? PARTICIPANT_DATA_DELETED\n+                      : PARTICIPANT_DATA_DELETION_FAILED;\n+              userMgmntAuditHelper.logEvent(auditEvent, auditRequest);\n+\n+            } else {\n+              Map<String, String> map =\n+                  Stream.of(\n+                          new String[][] {\n+                            {\"delete_or_retain\", \"retain\"},\n+                          })\n+                      .collect(Collectors.toMap(data -> data[0], data -> data[1]));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkxOTMwNQ==", "bodyText": "same here, this is a couple of lines without use of stream and collectors", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474919305", "createdAt": "2020-08-21T20:01:39Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserSupportServiceImpl.java", "diffHunk": "@@ -40,6 +52,18 @@ public boolean feedback(String subject, String body) {\n       isEmailSent =\n           emailNotification.sendEmailNotification(\n               feedbackSubject, dynamicContent, appConfig.getFeedbackToEmail(), null, null);\n+\n+      Map<String, String> map =\n+          Stream.of(\n+                  new String[][] {\n+                    {\"feedback_destination_email_address\", appConfig.getFeedbackToEmail()},\n+                  })\n+              .collect(Collectors.toMap(data -> data[0], data -> data[1]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyMDMwMQ==", "bodyText": "appVersion should be read from the config value, not hardcoded here.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r474920301", "createdAt": "2020-08-21T20:02:51Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/testutils/TestUtils.java", "diffHunk": "@@ -12,15 +13,14 @@ public static HttpHeaders getCommonHeaders(String... addOptionalHeaderNames) {\n     headers.add(Constants.ACCESS_TOKEN_HEADER, Constants.ACCESS_TOKEN_VALUE);\n     headers.add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n     headers.add(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON);\n+    headers.add(\"correlationId\", IdGenerator.id());\n+    headers.add(\"appVersion\", \"1.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de6b5ea4c93a717c8840f262edb4b94c61668aa"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98352cf17d81d40cb062eb921f4e7a772f93afa0", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/98352cf17d81d40cb062eb921f4e7a772f93afa0", "committedDate": "2020-08-23T10:22:06Z", "message": "Fixed PR Comments\n\nFixed PR Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ed5d726f4d44860464be5ca4a7cdf5e4e9776c", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b0ed5d726f4d44860464be5ca4a7cdf5e4e9776c", "committedDate": "2020-08-23T15:58:17Z", "message": "Added TestCase for auditLog events\n\nAdded TestCase for auditLog events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7b776c7d030ba37854b1821b636be824589108d", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7b776c7d030ba37854b1821b636be824589108d", "committedDate": "2020-08-25T07:13:22Z", "message": "Audit event TestCases\n\nAudit event TestCases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTI5ODEz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#pullrequestreview-474529813", "createdAt": "2020-08-25T14:19:31Z", "commit": {"oid": "e7b776c7d030ba37854b1821b636be824589108d"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoxOTozMVrOHGaaMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoyMjo1NVrOHGakWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NjE5Mg==", "bodyText": "this looks unrelated to this cl", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r476486192", "createdAt": "2020-08-25T14:19:31Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-tests/src/main/resources/mappings/oauth-scim-service/auth-server-register2.json", "diffHunk": "@@ -0,0 +1,18 @@\n+{\n+\t\"request\": {\n+\t\t\"method\": \"POST\",\n+\t\t\"url\": \"/AuthServer/register\",\n+\t\t\"bodyPatterns\": [\n+\t\t\t{\n+\t\t\t\t\"contains\": \"Passs@*1234\"\n+\t\t\t}\n+\t\t]\n+\t},\n+\t\"response\": {\n+\t\t\"status\": 200,\n+\t\t\"headers\": {\n+\t\t\t\"Content-Type\": \"application/json;charset=UTF-8\"\n+\t\t},\n+\t\t\"bodyFileName\": \"oauth-scim-service/auth-server-register-response2.json\"\n+\t}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b776c7d030ba37854b1821b636be824589108d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NjcxNQ==", "bodyText": "same here, this is an auth server change and unrelated to the audit log integration", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r476486715", "createdAt": "2020-08-25T14:20:11Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-tests/src/main/resources/mappings/response-service/response-server-deactivate.json", "diffHunk": "@@ -1,7 +1,7 @@\n {\n \t\"request\": {\n \t\t\"method\": \"POST\",\n-\t\t\"url\": \"/mystudies-response-server/participant/withdraw?studyId=studyId1&participantId=1&deleteResponses=delete\"\n+\t\t\"url\": \"/mystudies-response-server/participant/withdraw?studyId=studyId1&participantId=1&deleteResponses=true\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b776c7d030ba37854b1821b636be824589108d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4ODc5Mw==", "bodyText": "might be out of scope of this PR but tests should not have order", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#discussion_r476488793", "createdAt": "2020-08-25T14:22:55Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserRegistrationControllerTest.java", "diffHunk": "@@ -168,6 +192,98 @@ public void shouldRegisterUser() throws Exception {\n         1,\n         postRequestedFor(urlEqualTo(\"/AuthServer/register\"))\n             .withRequestBody(new ContainsPattern(Constants.PASSWORD)));\n+\n+    AuditLogEventRequest auditRequest = new AuditLogEventRequest();\n+    auditRequest.setAppId(Constants.APP_ID_VALUE);\n+    auditRequest.setUserId(daoResp.getUserId());\n+\n+    Map<String, AuditLogEventRequest> auditEventMap = new HashedMap<>();\n+    auditEventMap.put(USER_CREATED.getEventCode(), auditRequest);\n+    auditEventMap.put(VERIFICATION_EMAIL_FAILED.getEventCode(), auditRequest);\n+\n+    verifyAuditEventCall(auditEventMap, USER_CREATED, VERIFICATION_EMAIL_FAILED);\n+  }\n+\n+  @Order(4)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b776c7d030ba37854b1821b636be824589108d"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c7b305de74878fbc6e22ef61f9103f0c66b6b24", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8c7b305de74878fbc6e22ef61f9103f0c66b6b24", "committedDate": "2020-08-26T07:36:32Z", "message": "Merge branch 'develop' into user-mgmt-auditlog-with-commons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbc03faf7d462961e69249467f0ecc40aeff60ac", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fbc03faf7d462961e69249467f0ecc40aeff60ac", "committedDate": "2020-08-26T07:51:03Z", "message": "Source Format and Fixed Test failure\n\nSource Format and Fixed Test failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTEzOTcw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/781#pullrequestreview-475513970", "createdAt": "2020-08-26T13:55:27Z", "commit": {"oid": "fbc03faf7d462961e69249467f0ecc40aeff60ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 706, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}