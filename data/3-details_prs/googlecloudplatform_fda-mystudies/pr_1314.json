{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjMxNDU2", "number": 1314, "title": "Particpant manager webapp refresh token implementation", "bodyText": "Particpant manager webapp refresh token implementation", "createdAt": "2020-10-12T14:55:28Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314", "merged": true, "mergeCommit": {"oid": "992e2549efdc5532b821dd99021a0e962cd4b2f8"}, "closed": true, "closedAt": "2020-10-15T17:04:06Z", "author": {"login": "prakashm181"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPYUB_AH2gAyNTAxNjMxNDU2OjM4ZDdmNzdjM2EwMWUxODhmZDk4MzI4OThhZGY4NmQ0Y2E1YWQwNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS03DUAH2gAyNTAxNjMxNDU2OmNlMDYyNDZiODg3MmMwNzJhMDA0MGM5MDQ1Njc3YzEyYzFlZTU4ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "38d7f77c3a01e188fd9832898adf86d4ca5ad049", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/38d7f77c3a01e188fd9832898adf86d4ca5ad049", "committedDate": "2020-10-05T00:05:42Z", "message": "Refresh token-implementation\n\nRefresh token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ed312bc46c326733128e42a01f9448a3076ccc", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c2ed312bc46c326733128e42a01f9448a3076ccc", "committedDate": "2020-10-05T04:33:26Z", "message": "modification of refresh token header\n\nmodification of refresh token header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb3ab6652c582240753e9a8f8c19764a5e40ed4b", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cb3ab6652c582240753e9a8f8c19764a5e40ed4b", "committedDate": "2020-10-06T03:13:22Z", "message": "lint build fix\n\nlint build fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75a420f89d5e6b1b3c22006719868d4ce4222243", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/75a420f89d5e6b1b3c22006719868d4ce4222243", "committedDate": "2020-10-06T01:49:18Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b00fcc80cf1885a445347c1b586e5716bf72d885", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b00fcc80cf1885a445347c1b586e5716bf72d885", "committedDate": "2020-10-08T12:35:17Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adbbb7762670a2a4d2568986076be900e6be8840", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/adbbb7762670a2a4d2568986076be900e6be8840", "committedDate": "2020-10-12T13:09:36Z", "message": "header issue fix\n\nheader issue fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b2858c576b223747eb380677aeaea7142d20b04", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7b2858c576b223747eb380677aeaea7142d20b04", "committedDate": "2020-10-12T14:48:59Z", "message": "removed-work-arround code\n\nremoved-work-arround code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef629d73fc5ff8e798d2469a5fe6babc4488a81", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cef629d73fc5ff8e798d2469a5fe6babc4488a81", "committedDate": "2020-10-12T14:56:15Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e74f189d91a118d5f6fe2ff40b160e66e7bde6d", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9e74f189d91a118d5f6fe2ff40b160e66e7bde6d", "committedDate": "2020-10-12T16:14:35Z", "message": "header issue fix PR 1100\n\nheader issue fix PR 1100"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDI5MjI5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314#pullrequestreview-507429229", "createdAt": "2020-10-13T13:23:27Z", "commit": {"oid": "9e74f189d91a118d5f6fe2ff40b160e66e7bde6d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyMzoyN1rOHgmhEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyNjowNFrOHgmogg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0NzUzNw==", "bodyText": "Please use a type for error instead of disabling the linter.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314#discussion_r503947537", "createdAt": "2020-10-13T13:23:27Z", "author": {"login": "nikklassen"}, "path": "participant-manager/src/app/http-interceptors/auth.interceptor.ts", "diffHunk": "@@ -33,56 +40,104 @@ export class AuthInterceptor implements HttpInterceptor {\n \n     if (!this.authService.hasCredentials()) {\n       return next.handle(req).pipe(\n-        this.handleError(),\n+        this.handleError(req, next),\n         finalize(() => {\n           void this.spinner.hide();\n         }),\n       );\n     }\n+\n+    return next.handle(this.setHeaders(req)).pipe(\n+      this.handleError(req, next),\n+      finalize(() => {\n+        void this.spinner.hide();\n+      }),\n+    );\n+  }\n+  private handle401Error(request: HttpRequest<unknown>, next: HttpHandler) {\n+    this.isRefreshing = true;\n+    this.refreshTokenSubject.next(null);\n+    return this.authService.refreshToken().subscribe(\n+      (authServerResponse: AccessToken) => {\n+        this.refreshTokenSubject.next(authServerResponse);\n+        sessionStorage.setItem('accessToken', authServerResponse.access_token);\n+        sessionStorage.setItem(\n+          'refreshToken',\n+          authServerResponse.refresh_token,\n+        );\n+        return next.handle(this.setHeaders(request)).pipe(\n+          catchError((error) => {\n+            return throwError(error);\n+          }),\n+        );\n+      },\n+      (error) => {\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e74f189d91a118d5f6fe2ff40b160e66e7bde6d"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0NzkyMw==", "bodyText": "If you're only ever passing emitting null then make the type null.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314#discussion_r503947923", "createdAt": "2020-10-13T13:23:58Z", "author": {"login": "nikklassen"}, "path": "participant-manager/src/app/http-interceptors/auth.interceptor.ts", "diffHunk": "@@ -8,21 +8,28 @@ import {\n   HttpErrorResponse,\n } from '@angular/common/http';\n import {finalize} from 'rxjs/operators';\n-import {Observable, OperatorFunction, throwError} from 'rxjs';\n+import {BehaviorSubject, Observable, OperatorFunction, throwError} from 'rxjs';\n import {catchError} from 'rxjs/operators';\n import {ToastrService} from 'ngx-toastr';\n import {getMessage} from '../shared/error.codes.enum';\n import {AuthService} from '../service/auth.service';\n import {ApiResponse} from '../entity/api.response.model';\n import {environment} from 'src/environments/environment';\n import {CookieService} from 'ngx-cookie-service';\n+import {AccessToken} from '../entity/access-token';\n+import {Router} from '@angular/router';\n @Injectable()\n export class AuthInterceptor implements HttpInterceptor {\n+  private isRefreshing = false;\n+  private readonly refreshTokenSubject: BehaviorSubject<\n+    unknown\n+  > = new BehaviorSubject<unknown>(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e74f189d91a118d5f6fe2ff40b160e66e7bde6d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0OTQ0Mg==", "bodyText": "Can you use a more descriptive name than skip? People reading this code aren't going to be able to tell how it's used, or why it's a header. Ideally this isn't a header at all (headers are supposed to be passed to the server).", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314#discussion_r503949442", "createdAt": "2020-10-13T13:26:04Z", "author": {"login": "nikklassen"}, "path": "participant-manager/src/app/http-interceptors/auth.interceptor.ts", "diffHunk": "@@ -33,56 +40,104 @@ export class AuthInterceptor implements HttpInterceptor {\n \n     if (!this.authService.hasCredentials()) {\n       return next.handle(req).pipe(\n-        this.handleError(),\n+        this.handleError(req, next),\n         finalize(() => {\n           void this.spinner.hide();\n         }),\n       );\n     }\n+\n+    return next.handle(this.setHeaders(req)).pipe(\n+      this.handleError(req, next),\n+      finalize(() => {\n+        void this.spinner.hide();\n+      }),\n+    );\n+  }\n+  private handle401Error(request: HttpRequest<unknown>, next: HttpHandler) {\n+    this.isRefreshing = true;\n+    this.refreshTokenSubject.next(null);\n+    return this.authService.refreshToken().subscribe(\n+      (authServerResponse: AccessToken) => {\n+        this.refreshTokenSubject.next(authServerResponse);\n+        sessionStorage.setItem('accessToken', authServerResponse.access_token);\n+        sessionStorage.setItem(\n+          'refreshToken',\n+          authServerResponse.refresh_token,\n+        );\n+        return next.handle(this.setHeaders(request)).pipe(\n+          catchError((error) => {\n+            return throwError(error);\n+          }),\n+        );\n+      },\n+      (error) => {\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n+        const customError = error.error as ApiResponse;\n+        if (getMessage(customError.error_code)) {\n+          this.toasterService.error(getMessage(customError.error_code));\n+        }\n+        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n+        if (error.status === 401) {\n+          sessionStorage.clear();\n+          void this.router.navigate(['/']);\n+        }\n+      },\n+    );\n+  }\n+  private setHeaders(req: HttpRequest<unknown>) {\n     if (req.url.includes(`${environment.authServerUrl}`)) {\n-      const headers = req.headers\n+      let headers = req.headers\n         .set('Accept', 'application/json')\n         .set('correlationId', sessionStorage.getItem('correlationId') || '')\n         .set('appId', this.authService.appId)\n         .set('mobilePlatform', this.authService.mobilePlatform)\n+        .set('Access-Control-Allow-Origin', '*')\n+        .set(\n+          'Access-Control-Allow-Headers',\n+          'Origin, X-Requested-With, Content-Type, Accept',\n+        )\n         .set(\n           'Authorization',\n           `Bearer ${sessionStorage.getItem('accessToken') || ''} `,\n         );\n       if (!req.headers.has('Content-Type')) {\n-        headers.set('Content-Type', 'application/x-www-form-urlencoded');\n+        headers = headers.append(\n+          'Content-Type',\n+          'application/x-www-form-urlencoded',\n+        );\n       }\n-      const authReq = req.clone({headers});\n-      return next.handle(authReq).pipe(\n-        this.handleError(),\n-        finalize(() => {\n-          void this.spinner.hide();\n-        }),\n-      );\n+      return req.clone({headers});\n     } else {\n-      const headers = req.headers\n+      let headers = req.headers\n         .set('userId', sessionStorage.getItem('userId') || '')\n+        .set('Access-Control-Allow-Origin', '*')\n+        .set(\n+          'Access-Control-Allow-Headers',\n+          'Origin, X-Requested-With, Content-Type, Accept',\n+        )\n         .set(\n           'Authorization',\n           `Bearer ${sessionStorage.getItem('accessToken') || ''} `,\n         );\n-      if (!req.headers.has('Content-Type')) {\n-        req.headers.set('Content-Type', 'application/json');\n+\n+      if (!req.headers.get('skip')) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e74f189d91a118d5f6fe2ff40b160e66e7bde6d"}, "originalPosition": 128}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d2aedb7f35b9f5c4e56d6e5bcc0dd27a0029113", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1d2aedb7f35b9f5c4e56d6e5bcc0dd27a0029113", "committedDate": "2020-10-14T18:24:45Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb03b387ff7ed22a29412d859b3682e3c465bec", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6bb03b387ff7ed22a29412d859b3682e3c465bec", "committedDate": "2020-10-14T18:25:36Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca8dc32ce648fc723822807a11f932e132b9147", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/eca8dc32ce648fc723822807a11f932e132b9147", "committedDate": "2020-10-14T18:38:35Z", "message": "client comment fix\n\nclient comment fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "444fc80a8b5b2b3c8b4b55778bd842993a7494d9", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/444fc80a8b5b2b3c8b4b55778bd842993a7494d9", "committedDate": "2020-10-14T18:45:41Z", "message": "client comment fix\n\nclient comment fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15fc0194ce6cbfa451145967296dbf0349fda501", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/15fc0194ce6cbfa451145967296dbf0349fda501", "committedDate": "2020-10-14T19:00:53Z", "message": "lint command run\n\nlint command run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff63c3eff95be7d57847d07f839f85abf04a123d", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ff63c3eff95be7d57847d07f839f85abf04a123d", "committedDate": "2020-10-14T19:01:03Z", "message": "Merge branch 'particpant-manager-webapp-refresh-token-implementation' of https://github.com/GoogleCloudPlatform/fda-mystudies into particpant-manager-webapp-refresh-token-implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDAwNzYz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1314#pullrequestreview-509400763", "createdAt": "2020-10-15T13:50:22Z", "commit": {"oid": "ff63c3eff95be7d57847d07f839f85abf04a123d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce06246b8872c072a0040c9045677c12c1ee5882", "author": {"user": {"login": "prakashm181", "name": "Prakashm"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ce06246b8872c072a0040c9045677c12c1ee5882", "committedDate": "2020-10-15T17:03:04Z", "message": "Merge branch 'develop' into particpant-manager-webapp-refresh-token-implementation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 207, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}