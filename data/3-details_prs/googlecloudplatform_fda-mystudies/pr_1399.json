{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjY5Mjc2", "number": 1399, "title": "add initial incomplete set of k8s secrets", "bodyText": "", "createdAt": "2020-10-14T21:40:47Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399", "merged": true, "mergeCommit": {"oid": "4f44a166bd2b0d714cee394c322a3d3d180410f4"}, "closed": true, "closedAt": "2020-10-15T19:13:39Z", "author": {"login": "xingao267"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSlrBWgFqTUwODgzMzI4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS2uZ_AFqTUwOTY5MDYxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODMzMjgy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#pullrequestreview-508833282", "createdAt": "2020-10-14T23:11:32Z", "commit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxMTozMlrOHhqCNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxOToyOFrOHhqX0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1Mzc1MA==", "bodyText": "missing participant-manager-datastore", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505053750", "createdAt": "2020-10-14T23:11:32Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NjA2MQ==", "bodyText": "participant-manager does need db access credentials, but participant-manager-datastore needs access", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505056061", "createdAt": "2020-10-14T23:14:48Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTI4MQ==", "bodyText": "I think this is no longer needed. Now each app (except hydra) has a client id and secret, that will be later registered in hydra.\nAUTH SERVER, PARTICIPANT MANAGER AND MOBILE APPS (end user facing) should share the same CLIENT_ID and SECRET_KEY.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505059281", "createdAt": "2020-10-14T23:19:28Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"\n+  }\n+  # App codes for auth server authentication.\n+  auth_server_app_codes = [\n+    \"ma\",       # Mobile App\n+    \"urs\",      # User Registration Server\n+    \"rs\",       # Response Server\n+    \"builder\",  # Study Builder\n+  ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6beba1a35551655ff6a77cdd5768d3c34d4e0571", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6beba1a35551655ff6a77cdd5768d3c34d4e0571", "committedDate": "2020-10-15T17:33:06Z", "message": "add initial incomplete set of k8s secrets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941310f8552f9e8c39e4a40edbff2513698d9107", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/941310f8552f9e8c39e4a40edbff2513698d9107", "committedDate": "2020-10-15T17:38:51Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e186fefc4caf2c32882f2ead4336a9cf8250754", "committedDate": "2020-10-15T17:38:55Z", "message": "fix key"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dffbfdf0f51dd245c97994fc0b829eab55eb27f5", "committedDate": "2020-10-15T17:17:46Z", "message": "fix key"}, "afterCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e186fefc4caf2c32882f2ead4336a9cf8250754", "committedDate": "2020-10-15T17:38:55Z", "message": "fix key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjEwNzYy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#pullrequestreview-509610762", "createdAt": "2020-10-15T17:29:05Z", "commit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzoyOTowNVrOHiSfnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0MzowN1rOHiTA-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjYzOQ==", "bodyText": "what is the purpose of this password? and where is its corresponding user?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505716639", "createdAt": "2020-10-15T17:29:05Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -162,12 +162,8 @@ template \"project_secrets\" {\n           secret_id = \"manual-ios-certificate-password\"\n         },\n         {\n-          secret_id   = \"auto-auth-server-db-password\"\n-          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n-        },\n-        {\n-          secret_id   = \"auto-auth-server-db-user\"\n-          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n+          secret_id   = \"auto-mystudies-sql-default-user-password\"\n+          secret_data = \"$${random_password.passwords[\\\"mystudies_sql_default_user_password\\\"].result}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjI5NA==", "bodyText": "maybe these should be renamed to include db in the name?\ne.g. dbusername and dbpassword", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505722294", "createdAt": "2020-10-15T17:38:18Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 332}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMzY2Mg==", "bodyText": "smtp_hostname, from_email_domain and smtp_use_ip_whitelist\nthe values should come from 'manual-' secrets.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505723662", "createdAt": "2020-10-15T17:40:34Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"\n+  }\n+}\n+\n+# Email credentials.\n+resource \"kubernetes_secret\" \"email_credentials\" {\n+  metadata {\n+    name = \"email-credentials\"\n+  }\n+\n+  data = {\n+    email_address         = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-address\"].secret_data\n+    email_password        = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-password\"].secret_data\n+    contact_email_address = \"?\"\n+    from_email_address    = \"?\"\n+    smtp_host             = \"?\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 365}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTE3OQ==", "bodyText": "auth server client-id and secret-key are shared with participant-manager and mobile apps", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505725179", "createdAt": "2020-10-15T17:43:07Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -182,96 +178,132 @@ template \"project_secrets\" {\n           secret_data = \"$${random_password.system_secrets[\\\"hydra_system_secret\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_ma_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_ma_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_rs_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-client-id\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_client_id\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_rs_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-secret-key\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_secret_key\\\"].result}\"\n         },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5Njc0ODkx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#pullrequestreview-509674891", "createdAt": "2020-10-15T18:51:04Z", "commit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODo1MTowNFrOHiVm8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODo1MTowNFrOHiVm8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NzY2NQ==", "bodyText": "can you please include system_secret for hydra in here as well?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505767665", "createdAt": "2020-10-15T18:51:04Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 350}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9", "committedDate": "2020-10-15T19:05:01Z", "message": "add client side credentials"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5Njg2Nzg3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#pullrequestreview-509686787", "createdAt": "2020-10-15T19:07:56Z", "commit": {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzo1NlrOHiWKmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzo1NlrOHiWKmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3Njc5Mw==", "bodyText": "dbusername and dbpassword", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776793", "createdAt": "2020-10-15T19:07:56Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,161 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    dbusername  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    dbpassword  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname      = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Client-side credentials.\n+resource \"kubernetes_secret\" \"client_side_credentials\" {\n+\n+  metadata {\n+    name = \"client-side-credentials\"\n+  }\n+\n+  data = {\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-secret-key\"].secret_data\n+  }\n+}\n+\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9"}, "originalPosition": 363}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d2abebdd0ddb99c008e2c413723ae737ee22e6", "author": {"user": {"login": "xingao267", "name": "Xin Gao"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b5d2abebdd0ddb99c008e2c413723ae737ee22e6", "committedDate": "2020-10-15T19:10:22Z", "message": "minor naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjkwNjEx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#pullrequestreview-509690611", "createdAt": "2020-10-15T19:13:26Z", "commit": {"oid": "b5d2abebdd0ddb99c008e2c413723ae737ee22e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 242, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}