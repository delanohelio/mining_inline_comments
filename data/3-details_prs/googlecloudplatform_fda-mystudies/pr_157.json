{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NDI2Njk5", "number": 157, "title": "Update k8s deployments and add cluster-wide configs", "bodyText": "Changes:\n\nUpdate all services to use NodePort and Container-Native Load Balancing.\nUpdate all deployments to refer to services by name, not IP address.\nUpdate all deployments to use their own SAs, gcloud keys, and DB creds.\nMove the ingress and cert configs to a separate folder \"kubernetes/\".\nAdd Pod Security Policies for the cluster and Istio.\nAdd helper script for applying the k8s configs.\nAdd helper script for moving Docker images from the main registry.", "createdAt": "2020-04-16T14:44:38Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157", "merged": true, "mergeCommit": {"oid": "ec0ffa46d32a19dd15cb8f618423d285de84791c"}, "closed": true, "closedAt": "2020-04-17T20:05:14Z", "author": {"login": "MartinPetkov"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYNvQlgH2gAyNDA0NDI2Njk5OmFmZjIzZWMxOGU0NDY4NGVhNzQwMzdkY2Y0NTEzMTY0OTUyMjE4Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYm80KgFqTM5NTczODI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aff23ec18e44684ea74037dcf451316495221827", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aff23ec18e44684ea74037dcf451316495221827", "committedDate": "2020-04-16T14:40:39Z", "message": "Update k8s deployments and add cluster-wide configs\n\nChanges:\n* Update all services to use NodePort and Container-Native Load Balancing.\n* Update all deployments to refer to services by name, not IP address.\n* Move the ingress and cert configs to a separate folder \"kubernetes/\".\n* Add Pod Security Policies for the cluster and Istio.\n* Add helper script for applying the k8s configs.\n* Add helper script for moving Docker images from the main registry."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzIyNTcw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#pullrequestreview-394722570", "createdAt": "2020-04-16T15:00:00Z", "commit": {"oid": "aff23ec18e44684ea74037dcf451316495221827"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowMDowMVrOGGppZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowMDowMVrOGGppZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNjk4MQ==", "bodyText": "Is it possible to keep this branch deployment neutral? i.e. pick these values from configs or leave as generic names?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r409626981", "createdAt": "2020-04-16T15:00:01Z", "author": {"login": "zohrehj"}, "path": "kubernetes/heroes-hat-cert.yaml", "diffHunk": "@@ -0,0 +1,7 @@\n+apiVersion: networking.gke.io/v1beta1\n+kind: ManagedCertificate\n+metadata:\n+  name: heroes-hat-cert\n+spec:\n+  domains:\n+    - heroes-hat.rocketturtle.net", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aff23ec18e44684ea74037dcf451316495221827"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c38d0f0fba45d0f0510893d928c78e88a4fea4a", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c38d0f0fba45d0f0510893d928c78e88a4fea4a", "committedDate": "2020-04-16T16:33:21Z", "message": "Remove the response-server-ws-gcloud-key user-registration-server-ws-gcloud-key secrets\n\nThese aren't needed, as these apps can use the GKE credentials.\nSee https://cloud.google.com/docs/authentication/production"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "607de0b2be3adc44a920617c7778153d593d4403", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/607de0b2be3adc44a920617c7778153d593d4403", "committedDate": "2020-04-16T17:05:20Z", "message": "Revert \"Remove the response-server-ws-gcloud-key user-registration-server-ws-gcloud-key secrets\"\n\nThis reverts commit 6c38d0f0fba45d0f0510893d928c78e88a4fea4a."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4927cffc9eedc2d63442863c4cc19912d62e30b4", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4927cffc9eedc2d63442863c4cc19912d62e30b4", "committedDate": "2020-04-17T17:24:55Z", "message": "Make apps use separate SAs, gcloud keys, and DB creds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7dc1c024caea4315ec650d477fb5e5deae57107", "committedDate": "2020-04-17T17:28:28Z", "message": "Merge branch 'terraform' into add-kubernetes-yamls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjQ0ODcw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#pullrequestreview-395644870", "createdAt": "2020-04-17T17:33:08Z", "commit": {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzozMzowOFrOGHW92A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzozNToyNVrOGHXCaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2OTQ5Ng==", "bodyText": "We updated ingress.yaml to include most services now. Can you update this file as well?\nhttps://github.com/GoogleCloudPlatform/fda-mystudies/blob/early-access/ingress.yaml", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410369496", "createdAt": "2020-04-17T17:33:08Z", "author": {"login": "kuoyuchi"}, "path": "kubernetes/ingress.yaml", "diffHunk": "@@ -0,0 +1,15 @@\n+apiVersion: networking.k8s.io/v1beta1\n+kind: Ingress\n+metadata:\n+  name: heroes-hat-dev\n+  annotations:\n+    kubernetes.io/ingress.global-static-ip-name: heroes-hat\n+    networking.gke.io/managed-certificates: heroes-hat-cert\n+spec:\n+  rules:\n+    - http:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw==", "bodyText": "I thought the image management would be part of CI/CD. What is this script for?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410370667", "createdAt": "2020-04-17T17:35:25Z", "author": {"login": "kuoyuchi"}, "path": "kubernetes/push_images.sh", "diffHunk": "@@ -0,0 +1,8 @@\n+#!/usr/bin/env bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba0451b0f0a743d41885286caa29081f6b5dc7a", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2ba0451b0f0a743d41885286caa29081f6b5dc7a", "committedDate": "2020-04-17T18:09:01Z", "message": "Include changes to ingress.yaml from early-access"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Njc5MDQw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#pullrequestreview-395679040", "createdAt": "2020-04-17T18:24:51Z", "commit": {"oid": "2ba0451b0f0a743d41885286caa29081f6b5dc7a"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyNDo1MVrOGHYnFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyNDo1MVrOGHYnFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5NjQzNg==", "bodyText": "this seems to be different from the previous instance, both database name and region are changed. Is that intentional?\nnit: would be great if we could extract all these values out of the yaml files and make the deployment configurable.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410396436", "createdAt": "2020-04-17T18:24:51Z", "author": {"login": "zohrehj"}, "path": "WCP/deployment.yaml", "diffHunk": "@@ -1,54 +1,60 @@\n-apiVersion: apps/v1 \n-kind: Deployment \n-metadata: \n-  name: study-designer \n-  labels: \n-    app: study-designer \n-spec: \n-  replicas: 1 \n-  selector: \n-    matchLabels: \n-      app: study-designer \n-  template: \n-    metadata: \n-      labels: \n-        app: study-designer \n-    spec: \n-      containers: \n-        - name: study-designer \n-          image: gcr.io/heroes-hat-dev/study-designer:latest\n-          env: \n-            - name: DB_USER \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: username \n-            - name: DB_PASS \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: password \n-            - name: DB_NAME \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: dbname \n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  name: study-designer\n+  labels:\n+    app: study-designer\n+spec:\n+  replicas: 1\n+  selector:\n+    matchLabels:\n+      app: study-designer\n+  template:\n+    metadata:\n+      labels:\n+        app: study-designer\n+    spec:\n+      containers:\n+        - name: study-designer\n+          image: gcr.io/heroes-hat-dev-apps/study-designer:latest\n+          env:\n+            - name: DB_USER\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: username\n+            - name: DB_PASS\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: password\n+            - name: DB_NAME\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: dbname\n             - name: REGISTRATION_SERVER_URL\n-              value: \"35.196.79.108:60000\"\n+              value: \"user-registration-server-np:60000\"\n             - name: RESPONSE_SERVER_URL\n-              value: \"35.196.119.71:60000\"\n+              value: \"response-server-np:50000\"\n+            - name: GOOGLE_APPLICATION_CREDENTIALS\n+              value: \"/secrets/gcloud_key/key.json\"\n           ports:\n           - containerPort: 8080\n-        - name: cloudsql-proxy \n-          image: gcr.io/cloudsql-docker/gce-proxy:latest \n-          command: [\"/cloud_sql_proxy\", \n-            \"-instances=heroes-hat-dev:us-east1:my-studies2=tcp:3306\", \n-            \"-credential_file=/secrets/cloudsql/sql_credentials.json\"] \n-          volumeMounts: \n-            - name: my-secrets-volume \n-              mountPath: /secrets/cloudsql \n-              readOnly: true \n-      volumes: \n-        - name: my-secrets-volume \n-          secret: \n-            secretName: cloudsql-instance-credentials\n+          volumeMounts:\n+          - name: gcloud-key-volume\n+            mountPath: /secrets/gcloud_key\n+            readOnly: true\n+        - name: cloudsql-proxy\n+          image: gcr.io/cloudsql-docker/gce-proxy:latest\n+          command: [\"/cloud_sql_proxy\",\n+            \"-instances=heroes-hat-dev-data:us-central1:my-studies-1=tcp:3306\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ba0451b0f0a743d41885286caa29081f6b5dc7a"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjkwNzM5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#pullrequestreview-395690739", "createdAt": "2020-04-17T18:43:22Z", "commit": {"oid": "2ba0451b0f0a743d41885286caa29081f6b5dc7a"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODo0MzoyMlrOGHZKjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODo0MzoyMlrOGHZKjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNTUxNg==", "bodyText": "SGTM to keep it for now. Can you add some file-level comments to explain how to use this? We've been manually running docker and cloud build commands.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410405516", "createdAt": "2020-04-17T18:43:22Z", "author": {"login": "kuoyuchi"}, "path": "kubernetes/push_images.sh", "diffHunk": "@@ -0,0 +1,8 @@\n+#!/usr/bin/env bash", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw=="}, "originalCommit": {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a20f3ff3641329337830d806964d79a1ef8d2d8", "author": {"user": {"login": "MartinPetkov", "name": "Martin Petkov"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8a20f3ff3641329337830d806964d79a1ef8d2d8", "committedDate": "2020-04-17T19:03:53Z", "message": "Add usage and args to the push_images.sh script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzM4Mjgw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#pullrequestreview-395738280", "createdAt": "2020-04-17T20:03:06Z", "commit": {"oid": "8a20f3ff3641329337830d806964d79a1ef8d2d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1313, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}