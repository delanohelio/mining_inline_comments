{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjY3NjM3", "number": 586, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1NToxOVrOELsiGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjowMTowOVrOELv7lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNjk5NDE3OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1NToxOVrOGtYTKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzoxNToyN1rOGtx6cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzNzIyNQ==", "bodyText": "This should be a POST. PUT is used to set the state on the server, whereas this API requests a server action (sending an email).", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450237225", "createdAt": "2020-07-06T13:55:19Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -81,7 +87,31 @@\n             ? HttpStatus.OK.value()\n             : userResponse.getHttpStatusCode();\n \n-    logger.exit(String.format(\"status=%d\", status));\n+    logger.exit(String.format(STATUS_LOG, status));\n+    return ResponseEntity.status(status).body(userResponse);\n+  }\n+\n+  @PutMapping(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY1Njg4Mw==", "bodyText": "Used @PostMapping for this endpoint", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450656883", "createdAt": "2020-07-07T07:15:27Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -81,7 +87,31 @@\n             ? HttpStatus.OK.value()\n             : userResponse.getHttpStatusCode();\n \n-    logger.exit(String.format(\"status=%d\", status));\n+    logger.exit(String.format(STATUS_LOG, status));\n+    return ResponseEntity.status(status).body(userResponse);\n+  }\n+\n+  @PutMapping(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzNzIyNQ=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzAwNzUzOnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1ODoxNlrOGtYbWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODo0NzoyNlrOGuLP8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzOTMyMw==", "bodyText": "If userResponse has a status code you should always be using that instead of setting the OK case yourself.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450239323", "createdAt": "2020-07-06T13:58:16Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -81,7 +87,31 @@\n             ? HttpStatus.OK.value()\n             : userResponse.getHttpStatusCode();\n \n-    logger.exit(String.format(\"status=%d\", status));\n+    logger.exit(String.format(STATUS_LOG, status));\n+    return ResponseEntity.status(status).body(userResponse);\n+  }\n+\n+  @PutMapping(\n+      value = \"/user/reset_password\",\n+      produces = MediaType.APPLICATION_JSON_VALUE,\n+      consumes = MediaType.APPLICATION_JSON_VALUE)\n+  public ResponseEntity<?> resetPassword(\n+      @Valid @RequestBody UpdateUserRequest userRequest, HttpServletRequest request)\n+      throws JsonProcessingException {\n+    logger.entry(String.format(BEGIN_S_REQUEST_LOG, request.getRequestURI()));\n+    ValidationErrorResponse validationResult = UserValidator.validate(userRequest);\n+    if (validationResult.hasErrors()) {\n+      logger.exit(String.format(VALIDATION_ERROS_LOG, validationResult));\n+      return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(validationResult);\n+    }\n+\n+    UpdateUserResponse userResponse = userService.resetPassword(userRequest);\n+    int status =\n+        StringUtils.isEmpty(userResponse.getErrorDescription())\n+            ? HttpStatus.OK.value()\n+            : userResponse.getHttpStatusCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNzUxMw==", "bodyText": "Refactored the code to fix the review comment. Added MessageCode enum for success messages. Please share your thoughts so that I can request the team to use the MessageCode enum for success messages.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450707513", "createdAt": "2020-07-07T08:48:19Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -81,7 +87,31 @@\n             ? HttpStatus.OK.value()\n             : userResponse.getHttpStatusCode();\n \n-    logger.exit(String.format(\"status=%d\", status));\n+    logger.exit(String.format(STATUS_LOG, status));\n+    return ResponseEntity.status(status).body(userResponse);\n+  }\n+\n+  @PutMapping(\n+      value = \"/user/reset_password\",\n+      produces = MediaType.APPLICATION_JSON_VALUE,\n+      consumes = MediaType.APPLICATION_JSON_VALUE)\n+  public ResponseEntity<?> resetPassword(\n+      @Valid @RequestBody UpdateUserRequest userRequest, HttpServletRequest request)\n+      throws JsonProcessingException {\n+    logger.entry(String.format(BEGIN_S_REQUEST_LOG, request.getRequestURI()));\n+    ValidationErrorResponse validationResult = UserValidator.validate(userRequest);\n+    if (validationResult.hasErrors()) {\n+      logger.exit(String.format(VALIDATION_ERROS_LOG, validationResult));\n+      return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(validationResult);\n+    }\n+\n+    UpdateUserResponse userResponse = userService.resetPassword(userRequest);\n+    int status =\n+        StringUtils.isEmpty(userResponse.getErrorDescription())\n+            ? HttpStatus.OK.value()\n+            : userResponse.getHttpStatusCode();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzOTMyMw=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MTk4Nw==", "bodyText": "Yes, this looks better.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r451071987", "createdAt": "2020-07-07T18:47:26Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -81,7 +87,31 @@\n             ? HttpStatus.OK.value()\n             : userResponse.getHttpStatusCode();\n \n-    logger.exit(String.format(\"status=%d\", status));\n+    logger.exit(String.format(STATUS_LOG, status));\n+    return ResponseEntity.status(status).body(userResponse);\n+  }\n+\n+  @PutMapping(\n+      value = \"/user/reset_password\",\n+      produces = MediaType.APPLICATION_JSON_VALUE,\n+      consumes = MediaType.APPLICATION_JSON_VALUE)\n+  public ResponseEntity<?> resetPassword(\n+      @Valid @RequestBody UpdateUserRequest userRequest, HttpServletRequest request)\n+      throws JsonProcessingException {\n+    logger.entry(String.format(BEGIN_S_REQUEST_LOG, request.getRequestURI()));\n+    ValidationErrorResponse validationResult = UserValidator.validate(userRequest);\n+    if (validationResult.hasErrors()) {\n+      logger.exit(String.format(VALIDATION_ERROS_LOG, validationResult));\n+      return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(validationResult);\n+    }\n+\n+    UpdateUserResponse userResponse = userService.resetPassword(userRequest);\n+    int status =\n+        StringUtils.isEmpty(userResponse.getErrorDescription())\n+            ? HttpStatus.OK.value()\n+            : userResponse.getHttpStatusCode();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzOTMyMw=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzUzMjU4OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNTo1NjozMFrOGtdYXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwOTowNjo0NFrOGt1rMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMDQ3OQ==", "bodyText": "Please invert this condition", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450320479", "createdAt": "2020-07-06T15:56:30Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -109,13 +119,61 @@ private void setPasswordAndPasswordHistoryFields(String password, ObjectNode use\n   public UpdateUserResponse updateUser(UpdateUserRequest userRequest)\n       throws JsonProcessingException {\n     logger.entry(String.format(\"begin updateUser() for %s action\", userRequest.getAction()));\n-    if (\"change_password\".equalsIgnoreCase(userRequest.getAction())) {\n+    if (CHANGE_PASSWORD.equalsIgnoreCase(userRequest.getAction())) {\n       return changePassword(userRequest);\n     }\n \n     return new UpdateUserResponse(ErrorCode.APPLICATION_ERROR);\n   }\n \n+  public UpdateUserResponse resetPassword(UpdateUserRequest userRequest)\n+      throws JsonProcessingException {\n+    logger.entry(\"begin resetPassword()\");\n+    Optional<UserEntity> entity =\n+        repository.findByAppIdAndOrgIdAndEmail(\n+            userRequest.getAppId(), userRequest.getOrgId(), userRequest.getEmail());\n+    if (entity.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxODUxMg==", "bodyText": "Inverted the condition", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450718512", "createdAt": "2020-07-07T09:06:44Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -109,13 +119,61 @@ private void setPasswordAndPasswordHistoryFields(String password, ObjectNode use\n   public UpdateUserResponse updateUser(UpdateUserRequest userRequest)\n       throws JsonProcessingException {\n     logger.entry(String.format(\"begin updateUser() for %s action\", userRequest.getAction()));\n-    if (\"change_password\".equalsIgnoreCase(userRequest.getAction())) {\n+    if (CHANGE_PASSWORD.equalsIgnoreCase(userRequest.getAction())) {\n       return changePassword(userRequest);\n     }\n \n     return new UpdateUserResponse(ErrorCode.APPLICATION_ERROR);\n   }\n \n+  public UpdateUserResponse resetPassword(UpdateUserRequest userRequest)\n+      throws JsonProcessingException {\n+    logger.entry(\"begin resetPassword()\");\n+    Optional<UserEntity> entity =\n+        repository.findByAppIdAndOrgIdAndEmail(\n+            userRequest.getAppId(), userRequest.getOrgId(), userRequest.getEmail());\n+    if (entity.isPresent()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMDQ3OQ=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzU0MjY5OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/validator/UserValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNTo1OToxNFrOGtdesQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwOToyODo1MlrOGt2ekQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMjA5Nw==", "bodyText": "We shouldn't be using the same request for two different actions. I would prefer different request types so that this validation can be done with annotations.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450322097", "createdAt": "2020-07-06T15:59:14Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/validator/UserValidator.java", "diffHunk": "@@ -48,6 +49,19 @@ public static ValidationErrorResponse validate(UpdateUserRequest request) {\n       }\n     }\n \n+    // validate fields required for forgot password action\n+    if (FORGOT_PASSWORD.equalsIgnoreCase(request.getAction())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMTY2NQ==", "bodyText": "Created ResetPasswordRequest with validation annotations and ResetPasswordResponse bean. Refactored the code & tests to fix compilation errors.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450731665", "createdAt": "2020-07-07T09:28:52Z", "author": {"login": "dhanyak-btc"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/validator/UserValidator.java", "diffHunk": "@@ -48,6 +49,19 @@ public static ValidationErrorResponse validate(UpdateUserRequest request) {\n       }\n     }\n \n+    // validate fields required for forgot password action\n+    if (FORGOT_PASSWORD.equalsIgnoreCase(request.getAction())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMjA5Nw=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzU1MDkzOnYy", "diffSide": "RIGHT", "path": "common-modules/common-tests/src/main/resources/application-mockit-common.properties", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjowMTowOVrOGtdjfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODo1MDoyNFrOGuLV9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMzMyNQ==", "bodyText": "This matches the local props file? You definitely don't want to be committing passwords to version control.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450323325", "createdAt": "2020-07-06T16:01:09Z", "author": {"login": "nikklassen"}, "path": "common-modules/common-tests/src/main/resources/application-mockit-common.properties", "diffHunk": "@@ -26,4 +26,17 @@ logging.level.org.hibernate.stat=ERROR\n \n # oauth configuration\n security.oauth2.health_endpoint=http://localhost:8080/oauth-scim-service/v1/health\n-security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n\\ No newline at end of file\n+security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n+\n+# mail smtp configs\n+spring.mail.default-encoding=UTF-8\n+spring.mail.host=smtp.gmail.com\n+spring.mail.username=apps@boston-technology.com\n+spring.mail.password=Btc@app@123", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMjM2MA==", "bodyText": "Created AppConfigTest to mock the JavaMailSender bean. Removed the email credentials from property files.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r450732360", "createdAt": "2020-07-07T09:29:59Z", "author": {"login": "dhanyak-btc"}, "path": "common-modules/common-tests/src/main/resources/application-mockit-common.properties", "diffHunk": "@@ -26,4 +26,17 @@ logging.level.org.hibernate.stat=ERROR\n \n # oauth configuration\n security.oauth2.health_endpoint=http://localhost:8080/oauth-scim-service/v1/health\n-security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n\\ No newline at end of file\n+security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n+\n+# mail smtp configs\n+spring.mail.default-encoding=UTF-8\n+spring.mail.host=smtp.gmail.com\n+spring.mail.username=apps@boston-technology.com\n+spring.mail.password=Btc@app@123", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMzMyNQ=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MzUyNg==", "bodyText": "These values will still exist in the commit history. I recommend force pushing to erase the commits that introduced these, or change your email password.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/586#discussion_r451073526", "createdAt": "2020-07-07T18:50:24Z", "author": {"login": "nikklassen"}, "path": "common-modules/common-tests/src/main/resources/application-mockit-common.properties", "diffHunk": "@@ -26,4 +26,17 @@ logging.level.org.hibernate.stat=ERROR\n \n # oauth configuration\n security.oauth2.health_endpoint=http://localhost:8080/oauth-scim-service/v1/health\n-security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n\\ No newline at end of file\n+security.oauth2.introspection_endpoint=http://localhost:8080/oauth-scim-service/v1/oauth2/introspect\n+\n+# mail smtp configs\n+spring.mail.default-encoding=UTF-8\n+spring.mail.host=smtp.gmail.com\n+spring.mail.username=apps@boston-technology.com\n+spring.mail.password=Btc@app@123", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMzMyNQ=="}, "originalCommit": {"oid": "61c1378165962b37a0438356a117c4f1bc8c5fbf"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2236, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}