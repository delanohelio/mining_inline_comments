{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2Mjk1NDE2", "number": 673, "title": "Participant Manager Service: PUT /sites/{siteId}/decommission endpoint implementation", "bodyText": "PUT /sites/{siteId}/decommission endpoint implementation", "createdAt": "2020-07-24T13:43:59Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673", "merged": true, "mergeCommit": {"oid": "5a8bbf8edb7215bc7697310507eb2208fc2576a6"}, "closed": true, "closedAt": "2020-08-13T16:29:57Z", "author": {"login": "Kantharajut-btc"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4ELPEAH2gAyNDU2Mjk1NDE2OmY4NWQxZTc4NWNhODNmYTM5MjU4YTMxZWIxZDJkYmI4ZmE3ZDVhZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-inSIAFqTQ2NjkyNTI2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed", "committedDate": "2020-07-24T13:37:44Z", "message": "PUT //sites/{siteId}/decommission endpoint implementation\n\nPUT //sites/{siteId}/decommission endpoint implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjQwMDcz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#pullrequestreview-457240073", "createdAt": "2020-07-29T06:52:36Z", "commit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo1MjozNlrOG4q85A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowOTo1OFrOG4taOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3NzE1Ng==", "bodyText": "\"Yet to Join\" ?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462077156", "createdAt": "2020-07-29T06:52:36Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/CommonConstants.java", "diffHunk": "@@ -38,4 +38,10 @@ private CommonConstants() {}\n   public static final String ENROLLED_STATUS = \"Enrolled\";\n \n   public static final String YET_TO_ENROLL = \"Yet to Enroll\";\n+\n+  public static final String YET_TO_JOIN = \"yetToJoin\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3NzMxMQ==", "bodyText": "typo - successfully", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462077311", "createdAt": "2020-07-29T06:52:59Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java", "diffHunk": "@@ -45,7 +45,11 @@\n \n   ADD_PARTICIPANT_SUCCESS(HttpStatus.CREATED, \"MSG-0016\", \"Participant added successfully\"),\n \n-  GET_APPS_DETAILS_SUCCESS(HttpStatus.OK, \"MSG-0018\", \"Get App Details successfull\");\n+  GET_APPS_DETAILS_SUCCESS(HttpStatus.OK, \"MSG-0018\", \"Get App Details successfull\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjYyNQ==", "bodyText": "TODO: throw Exceptions here", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462102625", "createdAt": "2020-07-29T07:43:18Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -337,4 +343,152 @@ private void addRegistryParticipants(\n       participantRegistry.getRegistryParticipants().add(participant);\n     }\n   }\n+\n+  private boolean isEditPermissionAllowed(String studyId, String userId) {\n+    logger.entry(\"isEditPermissionAllowed(siteRequest)\");\n+    Optional<StudyPermissionEntity> optStudyPermissionEntity =\n+        studyPermissionRepository.findByStudyIdAndUserId(studyId, userId);\n+\n+    if (optStudyPermissionEntity.isPresent()) {\n+      StudyPermissionEntity studyPermission = optStudyPermissionEntity.get();\n+      String appInfoId = studyPermission.getAppInfo().getId();\n+      Optional<AppPermissionEntity> optAppPermissionEntity =\n+          appPermissionRepository.findByUserIdAndAppId(userId, appInfoId);\n+      if (optAppPermissionEntity.isPresent()) {\n+        AppPermissionEntity appPermission = optAppPermissionEntity.get();\n+        logger.exit(String.format(\"editValue=%d\", Permission.READ_EDIT.value()));\n+        return studyPermission.getEdit() == Permission.READ_EDIT.value()\n+            || appPermission.getEdit() == Permission.READ_EDIT.value();\n+      }\n+    }\n+    logger.exit(\"default permission is edit, return true\");\n+    return true;\n+  }\n+\n+  @Override\n+  @Transactional\n+  public SiteStatusResponse toggleSiteStatus(String userId, String siteId) {\n+    logger.entry(\"toggleSiteStatus()\");\n+\n+    ErrorCode errorCode = validateDecommissionSiteRequest(userId, siteId);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new SiteStatusResponse(errorCode);\n+    }\n+\n+    Optional<SiteEntity> optSiteEntity = siteRepository.findById(siteId);\n+\n+    SiteEntity site = optSiteEntity.get();\n+    if (SiteStatus.DEACTIVE == SiteStatus.fromValue(site.getStatus())) {\n+      site.setStatus(SiteStatus.ACTIVE.value());\n+      site = siteRepository.saveAndFlush(site);\n+\n+      logger.exit(String.format(\" Site status changed to ACTIVE for siteId=%s\", site.getId()));\n+      return new SiteStatusResponse(\n+          site.getId(), site.getStatus(), MessageCode.RECOMMISSION_SITE_SUCCESS);\n+    }\n+\n+    site.setStatus(SiteStatus.DEACTIVE.value());\n+    siteRepository.saveAndFlush(site);\n+    setPermissions(siteId);\n+\n+    logger.exit(String.format(\"Site status changed to DEACTIVE for siteId=%s\", site.getId()));\n+    return new SiteStatusResponse(\n+        site.getId(), site.getStatus(), MessageCode.DECOMMISSION_SITE_SUCCESS);\n+  }\n+\n+  private ErrorCode validateDecommissionSiteRequest(String userId, String siteId) {\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+    if (!optSitePermission.isPresent()) {\n+      return ErrorCode.SITE_NOT_FOUND;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNTg0NA==", "bodyText": "Please rename this method. This is more of a general clean up of site permissions and participant - site registry, right? Not sure what best to call it but please make some suggestions in the comment reply", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462115844", "createdAt": "2020-07-29T08:07:06Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -337,4 +343,152 @@ private void addRegistryParticipants(\n       participantRegistry.getRegistryParticipants().add(participant);\n     }\n   }\n+\n+  private boolean isEditPermissionAllowed(String studyId, String userId) {\n+    logger.entry(\"isEditPermissionAllowed(siteRequest)\");\n+    Optional<StudyPermissionEntity> optStudyPermissionEntity =\n+        studyPermissionRepository.findByStudyIdAndUserId(studyId, userId);\n+\n+    if (optStudyPermissionEntity.isPresent()) {\n+      StudyPermissionEntity studyPermission = optStudyPermissionEntity.get();\n+      String appInfoId = studyPermission.getAppInfo().getId();\n+      Optional<AppPermissionEntity> optAppPermissionEntity =\n+          appPermissionRepository.findByUserIdAndAppId(userId, appInfoId);\n+      if (optAppPermissionEntity.isPresent()) {\n+        AppPermissionEntity appPermission = optAppPermissionEntity.get();\n+        logger.exit(String.format(\"editValue=%d\", Permission.READ_EDIT.value()));\n+        return studyPermission.getEdit() == Permission.READ_EDIT.value()\n+            || appPermission.getEdit() == Permission.READ_EDIT.value();\n+      }\n+    }\n+    logger.exit(\"default permission is edit, return true\");\n+    return true;\n+  }\n+\n+  @Override\n+  @Transactional\n+  public SiteStatusResponse toggleSiteStatus(String userId, String siteId) {\n+    logger.entry(\"toggleSiteStatus()\");\n+\n+    ErrorCode errorCode = validateDecommissionSiteRequest(userId, siteId);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new SiteStatusResponse(errorCode);\n+    }\n+\n+    Optional<SiteEntity> optSiteEntity = siteRepository.findById(siteId);\n+\n+    SiteEntity site = optSiteEntity.get();\n+    if (SiteStatus.DEACTIVE == SiteStatus.fromValue(site.getStatus())) {\n+      site.setStatus(SiteStatus.ACTIVE.value());\n+      site = siteRepository.saveAndFlush(site);\n+\n+      logger.exit(String.format(\" Site status changed to ACTIVE for siteId=%s\", site.getId()));\n+      return new SiteStatusResponse(\n+          site.getId(), site.getStatus(), MessageCode.RECOMMISSION_SITE_SUCCESS);\n+    }\n+\n+    site.setStatus(SiteStatus.DEACTIVE.value());\n+    siteRepository.saveAndFlush(site);\n+    setPermissions(siteId);\n+\n+    logger.exit(String.format(\"Site status changed to DEACTIVE for siteId=%s\", site.getId()));\n+    return new SiteStatusResponse(\n+        site.getId(), site.getStatus(), MessageCode.DECOMMISSION_SITE_SUCCESS);\n+  }\n+\n+  private ErrorCode validateDecommissionSiteRequest(String userId, String siteId) {\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+    if (!optSitePermission.isPresent()) {\n+      return ErrorCode.SITE_NOT_FOUND;\n+    }\n+\n+    SitePermissionEntity sitePermission = optSitePermission.get();\n+    if (OPEN.equalsIgnoreCase(sitePermission.getStudy().getType())) {\n+      return ErrorCode.CANNOT_DECOMMISSION_SITE_FOR_OPEN_STUDY;\n+    }\n+\n+    String studyId = sitePermission.getStudy().getId();\n+    boolean canEdit = isEditPermissionAllowed(studyId, userId);\n+    if (!canEdit) {\n+      return ErrorCode.SITE_PERMISSION_ACEESS_DENIED;\n+    }\n+\n+    List<String> status = Arrays.asList(ENROLLED_STATUS, STATUS_ACTIVE);\n+    Optional<Long> optParticipantStudyCount =\n+        participantStudyRepository.findByStudyIdAndStatus(status, studyId);\n+\n+    if (optParticipantStudyCount.isPresent() && optParticipantStudyCount.get() > 0) {\n+      return ErrorCode.CANNOT_DECOMMISSION_SITE_FOR_ENROLLED_ACTIVE_STATUS;\n+    }\n+\n+    return null;\n+  }\n+\n+  private void setPermissions(String siteId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNzI1NA==", "bodyText": "Typo here. Please update the error code name", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462117254", "createdAt": "2020-07-29T08:09:42Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -337,4 +343,152 @@ private void addRegistryParticipants(\n       participantRegistry.getRegistryParticipants().add(participant);\n     }\n   }\n+\n+  private boolean isEditPermissionAllowed(String studyId, String userId) {\n+    logger.entry(\"isEditPermissionAllowed(siteRequest)\");\n+    Optional<StudyPermissionEntity> optStudyPermissionEntity =\n+        studyPermissionRepository.findByStudyIdAndUserId(studyId, userId);\n+\n+    if (optStudyPermissionEntity.isPresent()) {\n+      StudyPermissionEntity studyPermission = optStudyPermissionEntity.get();\n+      String appInfoId = studyPermission.getAppInfo().getId();\n+      Optional<AppPermissionEntity> optAppPermissionEntity =\n+          appPermissionRepository.findByUserIdAndAppId(userId, appInfoId);\n+      if (optAppPermissionEntity.isPresent()) {\n+        AppPermissionEntity appPermission = optAppPermissionEntity.get();\n+        logger.exit(String.format(\"editValue=%d\", Permission.READ_EDIT.value()));\n+        return studyPermission.getEdit() == Permission.READ_EDIT.value()\n+            || appPermission.getEdit() == Permission.READ_EDIT.value();\n+      }\n+    }\n+    logger.exit(\"default permission is edit, return true\");\n+    return true;\n+  }\n+\n+  @Override\n+  @Transactional\n+  public SiteStatusResponse toggleSiteStatus(String userId, String siteId) {\n+    logger.entry(\"toggleSiteStatus()\");\n+\n+    ErrorCode errorCode = validateDecommissionSiteRequest(userId, siteId);\n+    if (errorCode != null) {\n+      logger.exit(errorCode);\n+      return new SiteStatusResponse(errorCode);\n+    }\n+\n+    Optional<SiteEntity> optSiteEntity = siteRepository.findById(siteId);\n+\n+    SiteEntity site = optSiteEntity.get();\n+    if (SiteStatus.DEACTIVE == SiteStatus.fromValue(site.getStatus())) {\n+      site.setStatus(SiteStatus.ACTIVE.value());\n+      site = siteRepository.saveAndFlush(site);\n+\n+      logger.exit(String.format(\" Site status changed to ACTIVE for siteId=%s\", site.getId()));\n+      return new SiteStatusResponse(\n+          site.getId(), site.getStatus(), MessageCode.RECOMMISSION_SITE_SUCCESS);\n+    }\n+\n+    site.setStatus(SiteStatus.DEACTIVE.value());\n+    siteRepository.saveAndFlush(site);\n+    setPermissions(siteId);\n+\n+    logger.exit(String.format(\"Site status changed to DEACTIVE for siteId=%s\", site.getId()));\n+    return new SiteStatusResponse(\n+        site.getId(), site.getStatus(), MessageCode.DECOMMISSION_SITE_SUCCESS);\n+  }\n+\n+  private ErrorCode validateDecommissionSiteRequest(String userId, String siteId) {\n+    Optional<SitePermissionEntity> optSitePermission =\n+        sitePermissionRepository.findByUserIdAndSiteId(userId, siteId);\n+    if (!optSitePermission.isPresent()) {\n+      return ErrorCode.SITE_NOT_FOUND;\n+    }\n+\n+    SitePermissionEntity sitePermission = optSitePermission.get();\n+    if (OPEN.equalsIgnoreCase(sitePermission.getStudy().getType())) {\n+      return ErrorCode.CANNOT_DECOMMISSION_SITE_FOR_OPEN_STUDY;\n+    }\n+\n+    String studyId = sitePermission.getStudy().getId();\n+    boolean canEdit = isEditPermissionAllowed(studyId, userId);\n+    if (!canEdit) {\n+      return ErrorCode.SITE_PERMISSION_ACEESS_DENIED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNzQzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Step 2: call API and expect SITE_PERMISSION_ACEESS_DENIED error\n          \n          \n            \n                // Step 2: call API and expect SITE_PERMISSION_ACCESS_DENIED error", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#discussion_r462117433", "createdAt": "2020-07-29T08:09:58Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SitesControllerTest.java", "diffHunk": "@@ -422,6 +428,155 @@ public void shouldReturnSiteParticipantsRegistry() throws Exception {\n             jsonPath(\"$.message\", is(MessageCode.GET_PARTICIPANT_REGISTRY_SUCCESS.getMessage())));\n   }\n \n+  @Test\n+  public void shouldReturnNotFoundForDecomissionSite() throws Exception {\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    // Call API and expect SITE_NOT_FOUND error\n+    mockMvc\n+        .perform(\n+            put(ApiEndpoint.DECOMISSION_SITE.getPath(), IdGenerator.id())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andExpect(status().isNotFound())\n+        .andExpect(jsonPath(\"$.error_description\", is(ErrorCode.SITE_NOT_FOUND.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldRecomissionSite() throws Exception {\n+    // Step 1: Set the status to DEACTIVE\n+    siteEntity.setStatus(SiteStatus.DEACTIVE.value());\n+    siteEntity = testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+\n+    // Step 2: call API and expect RECOMMISSION_SITE_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+    result =\n+        mockMvc\n+            .perform(\n+                put(ApiEndpoint.DECOMISSION_SITE.getPath(), siteEntity.getId())\n+                    .headers(headers)\n+                    .contextPath(getContextPath()))\n+            .andExpect(status().isOk())\n+            .andExpect(jsonPath(\"$.siteId\", notNullValue()))\n+            .andExpect(\n+                jsonPath(\"$.message\", is(MessageCode.RECOMMISSION_SITE_SUCCESS.getMessage())))\n+            .andExpect(jsonPath(\"$.status\", is(SiteStatus.ACTIVE.value())))\n+            .andReturn();\n+\n+    String siteId = JsonPath.read(result.getResponse().getContentAsString(), \"$.siteId\");\n+\n+    // Step 3: verify updated values\n+    Optional<SiteEntity> optSiteEntity = siteRepository.findById(siteId);\n+    SiteEntity siteEntity = optSiteEntity.get();\n+    assertNotNull(siteEntity);\n+    assertEquals(DECOMMISSION_SITE_NAME, siteEntity.getName());\n+  }\n+\n+  @Test\n+  public void shouldDecomissionSite() throws Exception {\n+    // Step 1: set status to ACTIVE\n+    siteEntity.setStatus(SiteStatus.ACTIVE.value());\n+    siteEntity = testDataHelper.getSiteRepository().saveAndFlush(siteEntity);\n+\n+    // Step 2: Call API and expect DECOMMISSION_SITE_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+    result =\n+        mockMvc\n+            .perform(\n+                put(ApiEndpoint.DECOMISSION_SITE.getPath(), siteEntity.getId())\n+                    .headers(headers)\n+                    .contextPath(getContextPath()))\n+            .andExpect(status().isOk())\n+            .andExpect(jsonPath(\"$.siteId\", notNullValue()))\n+            .andExpect(jsonPath(\"$.status\", is(SiteStatus.DEACTIVE.value())))\n+            .andExpect(\n+                jsonPath(\"$.message\", is(MessageCode.DECOMMISSION_SITE_SUCCESS.getMessage())))\n+            .andReturn();\n+\n+    String siteId = JsonPath.read(result.getResponse().getContentAsString(), \"$.siteId\");\n+\n+    // Step 3: verify updated values\n+    Optional<SiteEntity> optSiteEntity = siteRepository.findById(siteId);\n+    SiteEntity siteEntity = optSiteEntity.get();\n+    assertNotNull(siteEntity);\n+    assertEquals(DECOMMISSION_SITE_NAME, siteEntity.getName());\n+  }\n+\n+  @Test\n+  public void shouldReturnCannotDecommissionSiteForOpenStudyError() throws Exception {\n+    // Step 1: set studyType to open\n+    studyEntity.setType(OPEN);\n+    studyEntity = testDataHelper.getStudyRepository().saveAndFlush(studyEntity);\n+\n+    // Step 2: call API and expect CANNOT_DECOMMISSION_SITE_FOR_OPEN_STUDY error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            put(ApiEndpoint.DECOMISSION_SITE.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andExpect(status().isBadRequest())\n+        .andExpect(\n+            jsonPath(\n+                \"$.error_description\",\n+                is(ErrorCode.CANNOT_DECOMMISSION_SITE_FOR_OPEN_STUDY.getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldReturnCannotDecomissionSiteForEnrolledAndActiveStatus() throws Exception {\n+    // Step 1: Set status to enrolled\n+    participantStudyEntity.setStatus(ENROLLED_STATUS);\n+    testDataHelper.getParticipantStudyRepository().saveAndFlush(participantStudyEntity);\n+\n+    // Step 2: call API and expect CANNOT_DECOMMISSION_SITE_FOR_ENROLLED_ACTIVE_STATUS error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.set(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            put(ApiEndpoint.DECOMISSION_SITE.getPath(), siteEntity.getId())\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andExpect(status().isBadRequest())\n+        .andExpect(\n+            jsonPath(\n+                \"$.error_description\",\n+                is(\n+                    ErrorCode.CANNOT_DECOMMISSION_SITE_FOR_ENROLLED_ACTIVE_STATUS\n+                        .getDescription())));\n+  }\n+\n+  @Test\n+  public void shouldReturnSitePermissionAccessDeniedForDecommissionSite() throws Exception {\n+    // Step 1: Set permission to read only\n+    StudyPermissionEntity studyPermissionEntity = studyEntity.getStudyPermissions().get(0);\n+    studyPermissionEntity.setEdit(Permission.READ_VIEW.value());\n+    studyEntity = testDataHelper.getStudyRepository().saveAndFlush(studyEntity);\n+\n+    AppPermissionEntity appPermissionEntity = appEntity.getAppPermissions().get(0);\n+    appPermissionEntity.setEdit(Permission.READ_VIEW.value());\n+    appEntity = testDataHelper.getAppRepository().saveAndFlush(appEntity);\n+\n+    // Step 2: call API and expect SITE_PERMISSION_ACEESS_DENIED error", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85d1e785ca83fa39258a31eb1d2dbb8fa7d5aed"}, "originalPosition": 178}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9430d11880d7a9552399dbb30f152a6578a5d47d", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9430d11880d7a9552399dbb30f152a6578a5d47d", "committedDate": "2020-07-29T11:00:47Z", "message": "Fixed PR comments\n\nFixed PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c2a3d3973a38f0db86e7a342df4a465219f735", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/86c2a3d3973a38f0db86e7a342df4a465219f735", "committedDate": "2020-07-29T11:07:36Z", "message": "Merge branch 'participant-manager-site-getParticipant-endpoint' into participant-manager-decommission-endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTQxOTg0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#pullrequestreview-457941984", "createdAt": "2020-07-29T22:28:05Z", "commit": {"oid": "86c2a3d3973a38f0db86e7a342df4a465219f735"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f804695ca4a3365a417e0e88d8bb58d50ed639", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c3f804695ca4a3365a417e0e88d8bb58d50ed639", "committedDate": "2020-08-13T16:14:02Z", "message": "Merge branch 'develop' into participant-manager-decommission-endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b2c5d765e47459c282a3453278ba247557aea84", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0b2c5d765e47459c282a3453278ba247557aea84", "committedDate": "2020-08-13T16:23:59Z", "message": "Resolved merge conflicts\n\nResolved merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTI1MjYx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/673#pullrequestreview-466925261", "createdAt": "2020-08-13T16:29:04Z", "commit": {"oid": "0b2c5d765e47459c282a3453278ba247557aea84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 529, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}