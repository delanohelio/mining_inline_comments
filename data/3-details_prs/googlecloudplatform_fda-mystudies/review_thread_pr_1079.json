{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0OTc0Nzky", "number": 1079, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoxOTo1NVrOEosDhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjo1Mjo0OVrOEpjvww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTAwMjkyOnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoxOTo1NVrOHZ7K8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNzozOToyNVrOHaogLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NTkwNA==", "bodyText": "nit: deactivateAcct", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496945904", "createdAt": "2020-09-29T18:19:55Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java", "diffHunk": "@@ -36,5 +36,7 @@ public ErrorBean updateUserProfile(\n \n   public UserDetailsEntity getParticipantDetails(String id);\n \n-  public boolean deActivateAcct(String userId, List<String> deleteData, String userDetailsId);\n+  public void deActivateAcct(String userId, List<String> deleteData, String userDetailsId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4ODYyMg==", "bodyText": "Fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497688622", "createdAt": "2020-09-30T17:39:25Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDao.java", "diffHunk": "@@ -36,5 +36,7 @@ public ErrorBean updateUserProfile(\n \n   public UserDetailsEntity getParticipantDetails(String id);\n \n-  public boolean deActivateAcct(String userId, List<String> deleteData, String userDetailsId);\n+  public void deActivateAcct(String userId, List<String> deleteData, String userDetailsId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NTkwNA=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTA0OTEyOnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODozMjoxOFrOHZ7nig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjowNzoyMVrOHbReng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg==", "bodyText": "why set the userId to null? userId which is the primary key should not be nullable anyway, so I am not sure what the reasoning is here.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496953226", "createdAt": "2020-09-29T18:32:18Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4MDAzNQ==", "bodyText": "userId is not PK in UserDetailsEntity class.\npublic class UserDetailsEntity implements Serializable {\n\n  private static final long serialVersionUID = -6971868842609206885L;\n\n  @ToString.Exclude\n  @Id\n  @GeneratedValue(generator = \"system-uuid\")\n  @GenericGenerator(name = \"system-uuid\", strategy = \"uuid\")\n  @Column(name = \"id\", updatable = false, nullable = false)\n  private String id;\n\n}", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497280035", "createdAt": "2020-09-30T06:53:10Z", "author": {"login": "dhanyak-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNTAyMA==", "bodyText": "true, though I still don't understand what we gain from saving a null value for this user?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497735020", "createdAt": "2020-09-30T19:02:07Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczOTEwOA==", "bodyText": "This is generally not a good practice.\nby turning the user_id to null, we are losing valuable information, e.g. if we later on decide to find user associated with an audit log we will not be able to because the user_id captured in the log no longer exists.\nIt also introduces potential future bug, since another user can now have this user_id, and if we have any assets that are still pointing to this user_id, we could accidentally expose the first user's information to the second one.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497739108", "createdAt": "2020-09-30T19:09:43Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTk2Ng==", "bodyText": "Fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359966", "createdAt": "2020-10-01T16:07:21Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +329,13 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    userDetailsEntity.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userDetailsEntity.setUserId(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MzIyNg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTA2MTE3OnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODozNjowMVrOHZ7vNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjowNzoxMlrOHbReUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ==", "bodyText": "looks like you can move userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());  outside the try catch.\nplease add comment as to why you are ignoring exception in the auth server call.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496955191", "createdAt": "2020-09-29T18:36:01Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODI1MQ==", "bodyText": "Please refer Step 3 and Step 4 in PR description. If Step 3 is success but Step 4 failed, then the user status will remain with DEACTIVATE_PENDING. This record will be picked by the scheduler task and tries to delete the user from oauth-scim server, this service returns USER_NOT_FOUND, so we need to catch the ErrorCodeException and call the userProfileManagementDao.deactivateUserAccount(userDetails.getUserId()); if the ErrorCode is USER_NOT_FOUND. We ignore other exceptions such 5XX series as this record will be picked up again by the scheduler task.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497278251", "createdAt": "2020-09-30T06:49:05Z", "author": {"login": "dhanyak-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI3ODkwMA==", "bodyText": "@madhurya-btc  please add another catch block for Exception  class and log the exception.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497278900", "createdAt": "2020-09-30T06:50:36Z", "author": {"login": "dhanyak-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4ODU2OQ==", "bodyText": "Fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497688569", "createdAt": "2020-09-30T17:39:20Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNzEzNg==", "bodyText": "other errors are still getting ignored here, and there is a chance that a user will get stuck in this step forever and we never get notified.\nPlease add a log statement (warning) that includes the the exception message, but also mentions that this will be retried.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497737136", "createdAt": "2020-09-30T19:06:04Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTg4OA==", "bodyText": "Fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359888", "createdAt": "2020-10-01T16:07:12Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserManagementProfileServiceImpl.java", "diffHunk": "@@ -223,89 +224,114 @@ public UserDetailsEntity saveParticipant(UserDetailsEntity participant) {\n     return userDetails;\n   }\n \n+  @Override\n+  public void processDeactivatePendingRequests() {\n+    // findUsers With Status DEACTIVATE_PENDING\n+    List<UserDetailsEntity> listOfUserDetails =\n+        (List<UserDetailsEntity>)\n+            CollectionUtils.emptyIfNull(\n+                userDetailsRepository.findByStatus(UserStatus.DEACTIVATE_PENDING.getValue()));\n+\n+    // call deactivateUserAccount() for each userID's\n+    listOfUserDetails.forEach(\n+        userDetails -> {\n+          try {\n+            userManagementUtil.deleteUserInfoInAuthServer(userDetails.getUserId());\n+            userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());\n+          } catch (ErrorCodeException e) {\n+            if (e.getErrorCode() == ErrorCode.USER_NOT_FOUND) {\n+              userProfileManagementDao.deactivateUserAccount(userDetails.getUserId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTE5MQ=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTEwMTk4OnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODo0NzoxOVrOHZ8Ifg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjo0NToxMFrOHbS14g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg==", "bodyText": "might be a good idea to move these values into application.properties", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r496961662", "createdAt": "2020-09-29T18:47:19Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY4NjQ4OQ==", "bodyText": "When i tried to change this to application.properties, i am getting compilation error as below\nThe value for annotation attribute Scheduled.fixedDelay must be a constant expression\nThe value for annotation attribute Scheduled.initialDelay must be a constant expression", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497686489", "createdAt": "2020-09-30T17:35:45Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc0NTYxNA==", "bodyText": "see https://stackoverflow.com/questions/45192373/how-to-assign-a-value-from-application-properties-to-a-static-variable", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r497745614", "createdAt": "2020-09-30T19:22:05Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1OTcxNg==", "bodyText": "see https://stackoverflow.com/questions/45192373/how-to-assign-a-value-from-application-properties-to-a-static-variable\n\nI tried with the above approach, but still i am getting same compilation error.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498359716", "createdAt": "2020-10-01T16:06:56Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2MzQ4OQ==", "bodyText": "ok. let's leave it for now. Please file a bug to address this in future.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498363489", "createdAt": "2020-10-01T16:13:10Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4MjMwNg==", "bodyText": "Created issue #1104 and added TODO in DeactivateAccountScheduledTask", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498382306", "createdAt": "2020-10-01T16:45:10Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/task/DeactivateAccountScheduledTask.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.google.cloud.healthcare.fdamystudies.task;\n+\n+import com.google.cloud.healthcare.fdamystudies.service.UserManagementProfileService;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeactivateAccountScheduledTask {\n+\n+  private static final int INITIAL_DELAY_MILLI_SEC = 10000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MTY2Mg=="}, "originalCommit": {"oid": "862c3a38b90be98487a2d9f3441497c7fc565fd0"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTk5NjQyOnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoxNDo0MVrOHbRwIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjo0NTo0NFrOHbS3GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDQ1MA==", "bodyText": "please add test to cover this functionality", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498364450", "createdAt": "2020-10-01T16:14:41Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +331,18 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    String alteredEmail =\n+        userDetailsEntity.getEmail() + \"_DEACTIVATED_\" + Instant.now().toEpochMilli();\n+    if (alteredEmail.length() > CommonConstants.EMAIL_LENGTH) {\n+      alteredEmail = alteredEmail.substring(0, CommonConstants.EMAIL_LENGTH);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f22b19c1aefe8ebb7c19ffb49c1c98bf9e9fcb58"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4MjYxNg==", "bodyText": "Fixed review comment.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498382616", "createdAt": "2020-10-01T16:45:44Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/dao/UserProfileManagementDaoImpl.java", "diffHunk": "@@ -342,4 +331,18 @@ public AppEntity getAppPropertiesDetailsByAppId(String appId) {\n     }\n     return appPropertiesDetails;\n   }\n+\n+  @Override\n+  public void deactivateUserAccount(String userId) {\n+    Optional<UserDetailsEntity> optUserDetails = userDetailsRepository.findByUserId(userId);\n+    UserDetailsEntity userDetailsEntity = optUserDetails.get();\n+    String alteredEmail =\n+        userDetailsEntity.getEmail() + \"_DEACTIVATED_\" + Instant.now().toEpochMilli();\n+    if (alteredEmail.length() > CommonConstants.EMAIL_LENGTH) {\n+      alteredEmail = alteredEmail.substring(0, CommonConstants.EMAIL_LENGTH);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDQ1MA=="}, "originalCommit": {"oid": "f22b19c1aefe8ebb7c19ffb49c1c98bf9e9fcb58"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDEyNzM5OnYy", "diffSide": "RIGHT", "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjo1Mjo0OVrOHbTGYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowMTowOVrOHbTYaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NjUyOA==", "bodyText": "can you assert that email has been updated and contains \"DEACTIVATED\" after account is deactivated?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498386528", "createdAt": "2020-10-01T16:52:49Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -205,20 +215,21 @@ public void deactivateAccountSuccess() throws Exception {\n \n     verifyTokenIntrospectRequest(1);\n \n-    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.VALID_USER_ID);\n-    assertEquals(3, daoResp.getStatus());\n+    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.USER_ID);\n+    assertNotNull(daoResp);\n+    assertTrue(daoResp.getEmail().length() == CommonConstants.EMAIL_LENGTH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07d383ce1ef52e529420803401d11cfe6fba20a6"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MTE0NA==", "bodyText": "Fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1079#discussion_r498391144", "createdAt": "2020-10-01T17:01:09Z", "author": {"login": "madhurya-btc"}, "path": "user-registration-server-ws/user-mgmt-module/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -205,20 +215,21 @@ public void deactivateAccountSuccess() throws Exception {\n \n     verifyTokenIntrospectRequest(1);\n \n-    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.VALID_USER_ID);\n-    assertEquals(3, daoResp.getStatus());\n+    UserDetailsEntity daoResp = service.loadUserDetailsByUserId(Constants.USER_ID);\n+    assertNotNull(daoResp);\n+    assertTrue(daoResp.getEmail().length() == CommonConstants.EMAIL_LENGTH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4NjUyOA=="}, "originalCommit": {"oid": "07d383ce1ef52e529420803401d11cfe6fba20a6"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1846, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}