{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzOTE0MTM4", "number": 2094, "title": "[participant-manager-datastore] : Fixed Performance Issue in GET /apps/{appId}/participants endpoint", "bodyText": "Fixed Performance Issue #1932 in GET /apps/{appId}/participants endpoint", "createdAt": "2020-11-19T12:25:32Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094", "merged": true, "mergeCommit": {"oid": "b955918b41d6cde35a34c442d9990653cceaf01e"}, "closed": true, "closedAt": "2020-11-24T15:50:34Z", "author": {"login": "monica-BTC"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeB0gQgH2gAyNTIzOTE0MTM4OjBmNTE1YjE4MzNhNTA1NDE4MmJkYzBhOTg1MzViMDkzM2JlMjhkNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfrwE1gH2gAyNTIzOTE0MTM4OjZmNDczOTdiMWFlMjI4YzQzY2M4MDUxMjIyOTk0YjJmNDU1YjY3NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f515b1833a5054182bdc0a98535b0933be28d4b", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0f515b1833a5054182bdc0a98535b0933be28d4b", "committedDate": "2020-11-19T12:22:13Z", "message": "Fixed Issue #1932 in /apps/{appId}/participants endpoint\n\nFixed Issue #1932 in /apps/{appId}/participants endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c226dd56e9de0cf6fbd01c81f7ee79cee9d026", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c5c226dd56e9de0cf6fbd01c81f7ee79cee9d026", "committedDate": "2020-11-19T13:25:51Z", "message": "Merge branch 'develop' into app-participants-performance-issue-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dade94738f7bb5bea3075f307ed41e3c5c92685d", "committedDate": "2020-11-23T07:27:28Z", "message": "Merge branch 'develop' into app-participants-performance-issue-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTU2NjY3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#pullrequestreview-536556667", "createdAt": "2020-11-23T15:02:42Z", "commit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNTowMjo0M1rOH4RXsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNToxMjozOFrOH4R1EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2Njg5Nw==", "bodyText": "nit: keep each line shorter.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528766897", "createdAt": "2020-11-23T15:02:43Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -125,4 +127,49 @@\n               + \"GROUP BY appId\",\n       nativeQuery = true)\n   public List<AppCount> findEnrolledWithoutTarget();\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n+      String appId, String[] excludeParticipantStudyStatus);\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppId(String appId);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc2OTYwOQ==", "bodyText": "writing query manually is more prone to error, please add tests to cover every single method that you added here. It can be unit tests at the repository level to simply verify that they do not fail and return the expected results.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528769609", "createdAt": "2020-11-23T15:06:18Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -125,4 +127,49 @@\n               + \"GROUP BY appId\",\n       nativeQuery = true)\n   public List<AppCount> findEnrolledWithoutTarget();\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n+      String appId, String[] excludeParticipantStudyStatus);\n+\n+  @Query(\n+      value =\n+          \"SELECT DISTINCT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"FROM user_details ud \"\n+              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"WHERE ud.app_info_id=:appId \"\n+              + \"ORDER BY ud.verification_time,ud.id DESC \",\n+      nativeQuery = true)\n+  public List<AppParticipantsInfo> findUserDetailsByAppId(String appId);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+              + \"FROM participant_study_info psi, locations loc, sites s, user_details ud \"\n+              + \"WHERE ud.id=psi.user_details_id AND psi.study_info_id=s.study_id AND psi.site_id=s.id AND loc.id=s.location_id AND \"\n+              + \"ud.app_info_id=:appId AND psi.status NOT IN (:excludeParticipantStudyStatus) \"\n+              + \"AND ud.id IN (:userIds)\",\n+      nativeQuery = true)\n+  public List<AppSiteInfo> findSitesByAppIdAndStudyStatusAndUserIds(\n+      String appId, String[] excludeParticipantStudyStatus, List<String> userIds);\n+\n+  @Query(\n+      value =\n+          \"SELECT ud.id AS userDetailsId, psi.site_id as siteId, psi.study_info_id AS studyId, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+              + \"FROM participant_study_info psi, locations loc, sites s, user_details ud \"\n+              + \"WHERE ud.id=psi.user_details_id AND psi.study_info_id=s.study_id AND psi.site_id=s.id AND loc.id=s.location_id AND \"\n+              + \"ud.app_info_id=:appId AND ud.id IN (:userIds) \",\n+      nativeQuery = true)\n+  public List<AppSiteInfo> findSitesByAppIdAndUserIds(String appId, List<String> userIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTI4Mw==", "bodyText": "site and location are two different concepts, please keep the naming consistent.\nas it is, this looks like an error to me.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528771283", "createdAt": "2020-11-23T15:08:32Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MTYwOA==", "bodyText": "same here. please rename, if they are indeed the same thing.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528771608", "createdAt": "2020-11-23T15:08:58Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());\n+    appSiteDetails.setSiteName(appSiteInfo.getLocationName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3MjQyOA==", "bodyText": "why is siteStatus set to studyStatus? if they are supposed to hold the same value, they should be named the same.\nWe do not need to store site status, if it will always be the same as study status.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528772428", "createdAt": "2020-11-23T15:10:04Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/SiteMapper.java", "diffHunk": "@@ -43,33 +39,20 @@ public static AppSiteResponse toAppSiteResponse(SiteEntity site) {\n     return appSiteResponse;\n   }\n \n-  public static List<AppSiteDetails> toParticipantSiteList(\n-      Entry<StudyEntity, List<ParticipantStudyEntity>> entry, String[] excludeSiteStatus) {\n-    List<AppSiteDetails> sites = new ArrayList<>();\n-    for (ParticipantStudyEntity enrollment : entry.getValue()) {\n-      if (ArrayUtils.contains(excludeSiteStatus, enrollment.getStatus())) {\n-        continue;\n-      }\n+  public static AppSiteDetails toAppSiteDetails(\n+      AppSiteInfo appSiteInfo, AppParticipantsInfo appParticipantsInfo) {\n+    AppSiteDetails appSiteDetails = new AppSiteDetails();\n+    appSiteDetails.setSiteId(appSiteInfo.getSiteId());\n+    appSiteDetails.setCustomSiteId(appSiteInfo.getLocationCustomId());\n+    appSiteDetails.setSiteName(appSiteInfo.getLocationName());\n+    appSiteDetails.setSiteStatus(appParticipantsInfo.getParticipantStudyStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NDQxNw==", "bodyText": "are these changes covered by existing tests? if not, please add test coverage.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#discussion_r528774417", "createdAt": "2020-11-23T15:12:38Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/AppServiceImpl.java", "diffHunk": "@@ -376,16 +384,86 @@ public AppParticipantsResponse getAppParticipants(\n               .getApp();\n     }\n \n-    List<UserDetailsEntity> userDetails = userDetailsRepository.findByAppId(app.getId());\n-    List<StudyEntity> studyEntity = studyRepository.findByAppId(app.getId());\n-    List<ParticipantDetail> participants = new ArrayList<>();\n+    List<AppParticipantsInfo> appParticipantsInfoList = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dade94738f7bb5bea3075f307ed41e3c5c92685d"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05d7b7f26d73a2082441f236dbb14baf37950ca1", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/05d7b7f26d73a2082441f236dbb14baf37950ca1", "committedDate": "2020-11-23T16:31:10Z", "message": "fixed review comments\n\nfixed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODQ4MTQ0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#pullrequestreview-536848144", "createdAt": "2020-11-23T21:11:41Z", "commit": {"oid": "05d7b7f26d73a2082441f236dbb14baf37950ca1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODUzMTIy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#pullrequestreview-536853122", "createdAt": "2020-11-23T21:18:11Z", "commit": {"oid": "05d7b7f26d73a2082441f236dbb14baf37950ca1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1558b23a4cf4a7b7042f596733e4ea23c310940", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e1558b23a4cf4a7b7042f596733e4ea23c310940", "committedDate": "2020-11-24T05:06:48Z", "message": "Merge branch 'develop' into app-participants-performance-issue-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6cd4f29d3802436dc050a6d79f17bc64ee49b88", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c6cd4f29d3802436dc050a6d79f17bc64ee49b88", "committedDate": "2020-11-24T06:09:00Z", "message": "Merge branch 'develop' into app-participants-performance-issue-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjQ1MTY1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2094#pullrequestreview-537645165", "createdAt": "2020-11-24T15:44:03Z", "commit": {"oid": "c6cd4f29d3802436dc050a6d79f17bc64ee49b88"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f47397b1ae228c43cc8051222994b2f455b6774", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6f47397b1ae228c43cc8051222994b2f455b6774", "committedDate": "2020-11-24T15:47:19Z", "message": "Merge branch 'develop' into app-participants-performance-issue-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1227, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}