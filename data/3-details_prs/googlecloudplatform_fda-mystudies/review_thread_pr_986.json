{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MDgwNTg5", "number": 986, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzo1Mzo0OVrOEk-uIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzo1Mzo0OVrOEk-uIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MjExODA5OnYy", "diffSide": "RIGHT", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzo1Mzo0OVrOHUOJ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzo1Mzo0OVrOHUOJ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk2NTQ5Mw==", "bodyText": "nit: rename to params", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/986#discussion_r490965493", "createdAt": "2020-09-18T13:53:49Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "diffHunk": "@@ -197,16 +200,91 @@ public void shouldReturnAutoLoginPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n     queryParams.add(LOGIN_CHALLENGE, AUTO_LOGIN_LOGIN_CHALLENGE_VALUE);\n \n+    MvcResult result =\n+        mockMvc\n+            .perform(\n+                get(ApiEndpoint.LOGIN_PAGE.getPath())\n+                    .contextPath(getContextPath())\n+                    .queryParams(queryParams))\n+            .andDo(print())\n+            .andExpect(status().isOk())\n+            .andExpect(view().name(AUTO_LOGIN_VIEW_NAME))\n+            .andExpect(content().string(containsString(\"<title>Please wait</title>\")))\n+            .andReturn();\n+\n+    String accountStatus = result.getResponse().getCookie(ACCOUNT_STATUS_COOKIE).getValue();\n+    assertTrue(UserAccountStatus.ACTIVE.getStatus() == Integer.parseInt(accountStatus));\n+  }\n+\n+  @Test\n+  public void shouldRedirectToConsentPageForAutoSignIn() throws Exception {\n+    // Step-1 user registration\n+    UserEntity user = new UserEntity();\n+    user.setEmail(\"mockit_email@grr.la\");\n+    user.setAppId(\"MyStudies\");\n+    user.setStatus(UserAccountStatus.ACTIVE.getStatus());\n+    user.setTempRegId(TEMP_REG_ID_VALUE);\n+    // UserInfo JSON contains password hash & salt, password history etc\n+    ObjectNode userInfo = JsonUtils.getObjectNode().put(\"password\", PasswordGenerator.generate(12));\n+    user.setUserInfo(userInfo);\n+    userRepository.saveAndFlush(user);\n+\n+    // Step-2 redirect to auto login page after signup\n+    MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n+\n+    Cookie appIdCookie = new Cookie(APP_ID_COOKIE, \"MyStudies\");\n+    Cookie loginChallenge = new Cookie(LOGIN_CHALLENGE_COOKIE, LOGIN_CHALLENGE_VALUE);\n+    Cookie mobilePlatformCookie =\n+        new Cookie(MOBILE_PLATFORM_COOKIE, MobilePlatform.UNKNOWN.getValue());\n+    Cookie tempRegId = new Cookie(TEMP_REG_ID_COOKIE, TEMP_REG_ID_VALUE);\n+\n+    MvcResult result =\n+        mockMvc\n+            .perform(\n+                post(ApiEndpoint.LOGIN_PAGE.getPath())\n+                    .contextPath(getContextPath())\n+                    .params(queryParams)\n+                    .cookie(appIdCookie, loginChallenge, mobilePlatformCookie, tempRegId))\n+            .andDo(print())\n+            .andExpect(status().is3xxRedirection())\n+            .andExpect(redirectedUrl(ApiEndpoint.CONSENT_PAGE.getUrl()))\n+            .andReturn();\n+\n+    String accountStatus = result.getResponse().getCookie(ACCOUNT_STATUS_COOKIE).getValue();\n+    assertTrue(UserAccountStatus.ACTIVE.getStatus() == Integer.parseInt(accountStatus));\n+  }\n+\n+  @Test\n+  public void shouldRedirectToLoginPageForInvalidTempRegIdForAutoSignIn() throws Exception {\n+    // Step-1 user registration\n+    UserEntity user = new UserEntity();\n+    user.setEmail(\"mockit_email@grr.la\");\n+    user.setAppId(\"MyStudies\");\n+    user.setStatus(UserAccountStatus.ACTIVE.getStatus());\n+    user.setTempRegId(IdGenerator.id());\n+    // UserInfo JSON contains password hash & salt, password history etc\n+    ObjectNode userInfo = JsonUtils.getObjectNode().put(\"password\", PasswordGenerator.generate(12));\n+    user.setUserInfo(userInfo);\n+    userRepository.saveAndFlush(user);\n+\n+    // Step-2 redirect to auto login page after signup\n+    MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n+\n+    Cookie appIdCookie = new Cookie(APP_ID_COOKIE, \"MyStudies\");\n+    Cookie loginChallenge = new Cookie(LOGIN_CHALLENGE_COOKIE, LOGIN_CHALLENGE_VALUE);\n+    Cookie mobilePlatformCookie =\n+        new Cookie(MOBILE_PLATFORM_COOKIE, MobilePlatform.UNKNOWN.getValue());\n+    Cookie tempRegId = new Cookie(TEMP_REG_ID_COOKIE, TEMP_REG_ID_VALUE);\n+\n     mockMvc\n         .perform(\n-            get(ApiEndpoint.LOGIN_PAGE.getPath())\n+            post(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n-                .queryParams(queryParams))\n+                .params(queryParams)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59510ffe271234ef7d9af42843af8d19a16e1a49"}, "originalPosition": 110}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1790, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}