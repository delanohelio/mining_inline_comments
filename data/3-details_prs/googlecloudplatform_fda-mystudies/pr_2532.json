{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MTk5MDg4", "number": 2532, "title": "Enroll Management Service: Server side validation", "bodyText": "", "createdAt": "2020-12-22T15:38:05Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2532", "merged": true, "mergeCommit": {"oid": "fc0a244b04f20317c8e319efb0cefceb085d28d3"}, "closed": true, "closedAt": "2020-12-28T08:11:24Z", "author": {"login": "navya-BTC"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdosWISAH2gAyNTQ0MTk5MDg4OjUwZmJkNjVhNDY0NGQ2YjVkZTM2OWRhYTYwYmYwYmY2N2E2NThmNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqhkvRgH2gAyNTQ0MTk5MDg4OmQ2OTdjOTAyZTM3MDFhYjUyNTMzNmNlNDgyZWM4NTk5ZjYzZjA2ZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50fbd65a4644d6b5de369daa60bf0bf67a658f64", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/50fbd65a4644d6b5de369daa60bf0bf67a658f64", "committedDate": "2020-12-22T15:34:12Z", "message": "enroll-server-side-validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MTcwMjIz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2532#pullrequestreview-557170223", "createdAt": "2020-12-22T15:38:49Z", "commit": {"oid": "50fbd65a4644d6b5de369daa60bf0bf67a658f64"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNTozODo0OVrOIJ_bWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNTozODo1MFrOIJ_bXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NzI4OQ==", "bodyText": "[enroll-mgmt Checks] reported by reviewdog \ud83d\udc36\n'}' at column 5 should be on the same line as the next part of a multi-block statement (one that directly contains multiple blocks: if/else-if/else, do/while or try/catch/finally).", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2532#discussion_r547347289", "createdAt": "2020-12-22T15:38:49Z", "author": {"login": "github-actions"}, "path": "participant-datastore/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/EnrollmentTokenController.java", "diffHunk": "@@ -61,76 +62,61 @@\n   @PostMapping(value = \"/validateEnrollmentToken\", produces = MediaType.APPLICATION_JSON_VALUE)\n   public ResponseEntity<?> validateEnrollmentToken(\n       @RequestHeader(\"userId\") String userId,\n-      @RequestBody EnrollmentBean enrollmentBean,\n+      @Valid @RequestBody EnrollmentBean enrollmentBean,\n       @Context HttpServletResponse response,\n       @Context HttpServletRequest request) {\n     logger.info(\"ValidateEnrollmentTokenController validateEnrollmentToken() - Starts \");\n     ErrorBean errorBean = null;\n     AuditLogEventRequest auditRequest = AuditEventMapper.fromHttpServletRequest(request);\n     auditRequest.setUserId(userId);\n \n-    if (enrollmentBean != null) {\n-      if (StringUtils.isEmpty(enrollmentBean.getStudyId())) {\n+    if (!enrollmentTokenfService.studyExists(enrollmentBean.getStudyId())) {\n+      ErrorResponseUtil.getFailureResponse(\n+          ErrorResponseUtil.ErrorCodes.STATUS_103.getValue(),\n+          ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n+          ErrorResponseUtil.ErrorCodes.STUDYID_NOT_EXIST.getValue(),\n+          response);\n+      return null;\n+    } else if (!StringUtils.isEmpty(enrollmentBean.getToken())) {\n+      if (enrollmentTokenfService.hasParticipant(\n+          enrollmentBean.getStudyId(), enrollmentBean.getToken())) {\n         ErrorResponseUtil.getFailureResponse(\n-            ErrorResponseUtil.ErrorCodes.STATUS_102.getValue(),\n+            ErrorResponseUtil.ErrorCodes.STATUS_103.getValue(),\n             ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-            ErrorResponseUtil.ErrorCodes.ERROR_REQUIRED.getValue(),\n+            ErrorResponseUtil.ErrorCodes.TOKEN_ALREADY_USE.getValue(),\n             response);\n         return null;\n-      } else if (!enrollmentTokenfService.studyExists(enrollmentBean.getStudyId())) {\n+      } else if (!enrollManagementUtil.isChecksumValid(enrollmentBean.getToken())) {\n         ErrorResponseUtil.getFailureResponse(\n-            ErrorResponseUtil.ErrorCodes.STATUS_103.getValue(),\n+            ErrorResponseUtil.ErrorCodes.STATUS_102.getValue(),\n             ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-            ErrorResponseUtil.ErrorCodes.STUDYID_NOT_EXIST.getValue(),\n+            ErrorResponseUtil.ErrorCodes.INVALID_TOKEN.getValue(),\n             response);\n+        enrollAuditEventHelper.logEvent(ENROLLMENT_TOKEN_FOUND_INVALID, auditRequest);\n         return null;\n-      } else if (!StringUtils.isEmpty(enrollmentBean.getToken())) {\n-        if (enrollmentTokenfService.hasParticipant(\n-            enrollmentBean.getStudyId(), enrollmentBean.getToken())) {\n-          ErrorResponseUtil.getFailureResponse(\n-              ErrorResponseUtil.ErrorCodes.STATUS_103.getValue(),\n-              ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-              ErrorResponseUtil.ErrorCodes.TOKEN_ALREADY_USE.getValue(),\n-              response);\n-          return null;\n-        } else if (!enrollManagementUtil.isChecksumValid(enrollmentBean.getToken())) {\n-          ErrorResponseUtil.getFailureResponse(\n-              ErrorResponseUtil.ErrorCodes.STATUS_102.getValue(),\n-              ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-              ErrorResponseUtil.ErrorCodes.INVALID_TOKEN.getValue(),\n-              response);\n-          enrollAuditEventHelper.logEvent(ENROLLMENT_TOKEN_FOUND_INVALID, auditRequest);\n-          return null;\n-        } else if (!enrollmentTokenfService.isValidStudyToken(\n-            enrollmentBean.getToken(), enrollmentBean.getStudyId(), userId)) {\n-          ErrorResponseUtil.getFailureResponse(\n-              ErrorResponseUtil.ErrorCodes.STATUS_102.getValue(),\n-              ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-              ErrorResponseUtil.ErrorCodes.UNKNOWN_TOKEN.getValue(),\n-              response);\n-\n-          enrollAuditEventHelper.logEvent(ENROLLMENT_TOKEN_FOUND_INVALID, auditRequest);\n-          return null;\n-        }\n-      }\n-      // Allow for the possibility that someone can enroll without using an enrollment\n-      // token\n-      else if (enrollmentTokenfService.enrollmentTokenRequired(enrollmentBean.getStudyId())) {\n+      } else if (!enrollmentTokenfService.isValidStudyToken(\n+          enrollmentBean.getToken(), enrollmentBean.getStudyId(), userId)) {\n         ErrorResponseUtil.getFailureResponse(\n             ErrorResponseUtil.ErrorCodes.STATUS_102.getValue(),\n             ErrorResponseUtil.ErrorCodes.INVALID_INPUT.getValue(),\n-            ErrorResponseUtil.ErrorCodes.TOKEN_REQUIRED.getValue(),\n+            ErrorResponseUtil.ErrorCodes.UNKNOWN_TOKEN.getValue(),\n             response);\n+\n+        enrollAuditEventHelper.logEvent(ENROLLMENT_TOKEN_FOUND_INVALID, auditRequest);\n         return null;\n       }\n-    } else {\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fbd65a4644d6b5de369daa60bf0bf67a658f64"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NzI5NA==", "bodyText": "[enroll-mgmt Checks] reported by reviewdog \ud83d\udc36\nAbbreviation in name 'participantStudiesBO' must contain no more than '1' consecutive capital letters.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2532#discussion_r547347294", "createdAt": "2020-12-22T15:38:50Z", "author": {"login": "github-actions"}, "path": "participant-datastore/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyStateServiceImpl.java", "diffHunk": "@@ -208,43 +208,41 @@ public StudyStateRespBean saveParticipantStudies(\n \n     List<StudyStateBean> serviceResponseList = new ArrayList<>();\n \n-    if (userId != null) {\n-      UserDetailsEntity userDetailsEntity = userRegAdminUserDao.getRecord(userId);\n-      if (userDetailsEntity == null) {\n-        throw new ErrorCodeException(ErrorCode.USER_NOT_FOUND);\n-      }\n+    UserDetailsEntity userDetailsEntity = userRegAdminUserDao.getRecord(userId);\n+    if (userDetailsEntity == null) {\n+      throw new ErrorCodeException(ErrorCode.USER_NOT_FOUND);\n+    }\n \n-      List<ParticipantStudyEntity> participantStudiesList =\n-          participantStudiesInfoDao.getParticipantStudiesInfo(userDetailsEntity.getUserId());\n-      if (participantStudiesList != null && !participantStudiesList.isEmpty()) {\n-        for (ParticipantStudyEntity participantStudiesBO : participantStudiesList) {\n-          StudyStateBean studyStateBean = BeanUtil.getBean(StudyStateBean.class);\n-          if (participantStudiesBO.getParticipantRegistrySite() != null) {\n-            String enrolledTokenVal =\n-                studyStateDao.getEnrollTokenForParticipant(\n-                    participantStudiesBO.getParticipantRegistrySite().getId());\n-            studyStateBean.setHashedToken(\n-                EnrollmentManagementUtil.getHashedValue(enrolledTokenVal.toUpperCase()));\n-          }\n-          if (participantStudiesBO.getStudy() != null) {\n-            studyStateBean.setStudyId(participantStudiesBO.getStudy().getCustomId());\n-          }\n-          studyStateBean.setStatus(participantStudiesBO.getStatus());\n-          if (participantStudiesBO.getParticipantId() != null) {\n-            studyStateBean.setParticipantId(participantStudiesBO.getParticipantId());\n-          }\n-          studyStateBean.setCompletion(participantStudiesBO.getCompletion());\n-          studyStateBean.setBookmarked(participantStudiesBO.getBookmark());\n-          studyStateBean.setAdherence(participantStudiesBO.getAdherence());\n-          if (participantStudiesBO.getEnrolledDate() != null) {\n-            studyStateBean.setEnrolledDate(\n-                MyStudiesUserRegUtil.getIsoDateFormat(participantStudiesBO.getEnrolledDate()));\n-          }\n-          if (participantStudiesBO.getSite() != null) {\n-            studyStateBean.setSiteId(participantStudiesBO.getSite().getId().toString());\n-          }\n-          serviceResponseList.add(studyStateBean);\n+    List<ParticipantStudyEntity> participantStudiesList =\n+        participantStudiesInfoDao.getParticipantStudiesInfo(userDetailsEntity.getUserId());\n+    if (participantStudiesList != null && !participantStudiesList.isEmpty()) {\n+      for (ParticipantStudyEntity participantStudiesBO : participantStudiesList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fbd65a4644d6b5de369daa60bf0bf67a658f64"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c08cf480305d246e662da5fd068fb676e77385", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b1c08cf480305d246e662da5fd068fb676e77385", "committedDate": "2020-12-22T15:44:03Z", "message": "Fixed the comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "399aab9d84e4d3bc692ac5c270905e0615b0508f", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/399aab9d84e4d3bc692ac5c270905e0615b0508f", "committedDate": "2020-12-23T04:57:01Z", "message": "Merge branch 'develop' into enroll-server-side-validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "903255944f6e5bd74a961f36670c1dd28223a5c1", "author": {"user": {"login": "navya-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/903255944f6e5bd74a961f36670c1dd28223a5c1", "committedDate": "2020-12-23T05:06:04Z", "message": "Resolved conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MDg3NjM4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2532#pullrequestreview-558087638", "createdAt": "2020-12-23T16:49:30Z", "commit": {"oid": "903255944f6e5bd74a961f36670c1dd28223a5c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d697c902e3701ab525336ce482ec8599f63f06ea", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d697c902e3701ab525336ce482ec8599f63f06ea", "committedDate": "2020-12-28T08:09:03Z", "message": "Merge branch 'develop' into enroll-server-side-validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 992, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}