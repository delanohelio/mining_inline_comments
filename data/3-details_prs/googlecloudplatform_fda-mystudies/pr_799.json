{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNjI2MjA2", "number": 799, "title": "Enroll Mgmt Module: Audit log implementation with test cases", "bodyText": "Audit log implementation with test cases", "createdAt": "2020-08-24T16:18:52Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799", "merged": true, "mergeCommit": {"oid": "8a2eb7ba93c85d5893a331d8964ebd7da606981a"}, "closed": true, "closedAt": "2020-08-27T16:51:27Z", "author": {"login": "Kantharajut-btc"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCE9TmAH2gAyNDcyNjI2MjA2OmNiNWZjMWY2MGRjYjJhNzc5YTg2NzFhNDk4NTI3MjdiYTcxMjE5YTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDDTNHAH2gAyNDcyNjI2MjA2OjI5ZTU3Y2EzMWIxYTNhNzEyZTM2NWIzMGYzNjkxYTY1ZDZlMGY1MDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb5fc1f60dcb2a779a8671a49852727ba71219a0", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cb5fc1f60dcb2a779a8671a49852727ba71219a0", "committedDate": "2020-08-24T16:11:40Z", "message": "Audit log implementation with test cases\n\nAudit log implementation with test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/18731f9aed65cae9f8f957fd29a7ed0859774dbd", "committedDate": "2020-08-24T16:17:33Z", "message": "Removed old audit log code\n\nRemoved old audit log code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTk2NTY2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#pullrequestreview-474596566", "createdAt": "2020-08-25T15:26:56Z", "commit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNToyNjo1NlrOHGdibQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNTo1MzozOVrOHGeqfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzNzQ1Mw==", "bodyText": "nit: remove empty comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476537453", "createdAt": "2020-08-25T15:26:56Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/AuditLogEventRequest.java", "diffHunk": "@@ -19,7 +20,10 @@\n @Getter\n @Setter\n @ToString\n-public class AuditLogEventRequest {\n+public class AuditLogEventRequest implements Serializable {\n+\n+  /** */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzOTY0Ng==", "bodyText": "nit: move to constant", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476539646", "createdAt": "2020-08-25T15:30:02Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/StudyStateController.java", "diffHunk": "@@ -111,7 +124,10 @@\n \n   @GetMapping(value = \"/studyState\", produces = MediaType.APPLICATION_JSON_VALUE)\n   public ResponseEntity<?> getStudyState(\n-      @RequestHeader(\"userId\") String userId, @Context HttpServletResponse response) {\n+      @RequestHeader(\"userId\") String userId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MDgwMA==", "bodyText": "please make sure the sql script for this module is also updated.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476540800", "createdAt": "2020-08-25T15:31:38Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/enroll/model/ActivityLogBO.java", "diffHunk": "@@ -1,46 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Use of this source code is governed by an MIT-style\n- * license that can be found in the LICENSE file or at\n- * https://opensource.org/licenses/MIT.\n- */\n-\n-package com.google.cloud.healthcare.fdamystudies.enroll.model;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ==", "bodyText": "Looks like this is saving a list of studies, and each of these studies may have a different state; Is that correct?\nIf yes, then I don't think adding the state_value of a single study into the audit log makes. sense", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476547719", "createdAt": "2020-08-25T15:41:23Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyStateServiceImpl.java", "diffHunk": "@@ -165,28 +179,12 @@ public StudyStateRespBean saveParticipantStudies(\n         studyStateRespBean = new StudyStateRespBean();\n         studyStateRespBean.setMessage(\n             MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue().toLowerCase());\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_NAME, activityDescList);\n-      } else {\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(\n-                            AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_NAME, activityDescList);\n+        placeHolder.put(\"study_state_value\", addParticipantStudiesList.get(0).getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1MzIzNA==", "bodyText": "this appId column was removed from the final audit columns", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476553234", "createdAt": "2020-08-25T15:49:47Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/testutils/TestUtils.java", "diffHunk": "@@ -10,6 +11,9 @@ public static HttpHeaders getCommonHeaders() {\n     HttpHeaders headers = new HttpHeaders();\n     headers.add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n     headers.add(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON);\n+    headers.add(\"correlationId\", IdGenerator.id());\n+    headers.add(\"appVersion\", \"1.0\");\n+    headers.add(\"appId\", \"GCPMS001\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU1NTkwMw==", "bodyText": "remove debug log", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r476555903", "createdAt": "2020-08-25T15:53:39Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-tests/src/main/java/com/google/cloud/healthcare/fdamystudies/common/BaseMockIT.java", "diffHunk": "@@ -149,9 +170,95 @@ protected MvcResult performPost(\n         .andReturn();\n   }\n \n+  /**\n+   * @param assertOptionalFieldsForEvent is a {@link Map} collection that contains {@link eventCode}\n+   *     as key and {@link AuditLogEventRequest} with optional field values as value.\n+   * @param auditEvents audit event enums\n+   */\n+  protected void verifyAuditEventCall(\n+      Map<String, AuditLogEventRequest> assertOptionalFieldsForEvent,\n+      AuditLogEvent... auditEvents) {\n+\n+    verifyAuditEventCall(auditEvents);\n+\n+    Map<String, AuditLogEventRequest> auditRequestByEventCode =\n+        auditRequests\n+            .stream()\n+            .collect(Collectors.toMap(AuditLogEventRequest::getEventCode, Function.identity()));\n+\n+    assertOptionalFieldsForEvent.forEach(\n+        (eventCode, expectedAuditRequest) -> {\n+          AuditLogEventRequest auditRequest = auditRequestByEventCode.get(eventCode);\n+          assertEquals(expectedAuditRequest.getUserId(), auditRequest.getUserId());\n+          assertEquals(expectedAuditRequest.getParticipantId(), auditRequest.getParticipantId());\n+          assertEquals(expectedAuditRequest.getStudyId(), auditRequest.getStudyId());\n+          assertEquals(expectedAuditRequest.getStudyVersion(), auditRequest.getStudyVersion());\n+        });\n+  }\n+\n+  protected void verifyAuditEventCall(AuditLogEvent... auditEvents) {\n+    ArgumentCaptor<AuditLogEventRequest> argument =\n+        ArgumentCaptor.forClass(AuditLogEventRequest.class);\n+    verify(mockAuditService, atLeastOnce()).postAuditLogEvent(argument.capture());\n+\n+    Map<String, AuditLogEventRequest> auditRequestByEventCode =\n+        auditRequests\n+            .stream()\n+            .collect(Collectors.toMap(AuditLogEventRequest::getEventCode, Function.identity()));\n+\n+    for (AuditLogEvent auditEvent : auditEvents) {\n+      AuditLogEventRequest auditRequest = auditRequestByEventCode.get(auditEvent.getEventCode());\n+      logger.debug(auditRequest.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7019e78c7d01850ae6ca3f5f18756ca2c480f8c4", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7019e78c7d01850ae6ca3f5f18756ca2c480f8c4", "committedDate": "2020-08-26T08:43:14Z", "message": "Fixed PR comments\n\nFixed PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acc7804985a3e29ae30560e0405ab8a782e69f1", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0acc7804985a3e29ae30560e0405ab8a782e69f1", "committedDate": "2020-08-26T08:48:42Z", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTIyMzkz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#pullrequestreview-475522393", "createdAt": "2020-08-26T14:03:44Z", "commit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNDowMzo0NFrOHHNtCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNDowMzo0NFrOHHNtCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNjYwMA==", "bodyText": "I am not seeing any changes. Also this comment questions the audit log definition for this case and addressing it may require further discussion.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#discussion_r477326600", "createdAt": "2020-08-26T14:03:44Z", "author": {"login": "zohrehj"}, "path": "user-registration-server-ws/enroll-mgmt-module/enroll-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyStateServiceImpl.java", "diffHunk": "@@ -165,28 +179,12 @@ public StudyStateRespBean saveParticipantStudies(\n         studyStateRespBean = new StudyStateRespBean();\n         studyStateRespBean.setMessage(\n             MyStudiesUserRegUtil.ErrorCodes.SUCCESS.getValue().toLowerCase());\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_NAME, activityDescList);\n-      } else {\n-        List<String> activityDescList =\n-            customStudyIdList\n-                .stream()\n-                .map(\n-                    studyId ->\n-                        String.format(\n-                            AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_DESC, studyId))\n-                .collect(Collectors.toList());\n-        commonService.createActivityLogList(\n-            userId, AppConstants.AUDIT_EVENT_UPDATE_STUDY_STATE_FAILED_NAME, activityDescList);\n+        placeHolder.put(\"study_state_value\", addParticipantStudiesList.get(0).getStatus());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0NzcxOQ=="}, "originalCommit": {"oid": "18731f9aed65cae9f8f957fd29a7ed0859774dbd"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18a7844e8e3aa2fcc0bcd9eb5548261f9d158055", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/18a7844e8e3aa2fcc0bcd9eb5548261f9d158055", "committedDate": "2020-08-27T07:13:04Z", "message": "Updated sql script and added appId\n\nUpdated sql script and added appId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0735b2732d52b9ffe8512f67884a4e204523577e", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0735b2732d52b9ffe8512f67884a4e204523577e", "committedDate": "2020-08-27T07:20:30Z", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODE5Mjc4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/799#pullrequestreview-476819278", "createdAt": "2020-08-27T15:10:05Z", "commit": {"oid": "0735b2732d52b9ffe8512f67884a4e204523577e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29e57ca31b1a3a712e365b30f3691a65d6e0f502", "author": {"user": {"login": "Kantharajut-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29e57ca31b1a3a712e365b30f3691a65d6e0f502", "committedDate": "2020-08-27T16:49:42Z", "message": "Merge branch 'develop' into enroll-mgmt-auditlog-events"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 726, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}