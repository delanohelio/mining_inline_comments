{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MjQxOTkz", "number": 686, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzozODoxMFrOETgbzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzozODoxMFrOETgbzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODg5ODA1OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzozODoxMFrOG5R5Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo1NTowMFrOG5kG0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNTE0Mw==", "bodyText": "\"Details\"", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/686#discussion_r462715143", "createdAt": "2020-07-30T03:38:10Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -139,10 +149,108 @@ private AdminUserResponse saveAdminDetails(UserRequest user) {\n     UserRegAdminEntity adminDetails =\n         UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n     adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+\n+    Map<Boolean, List<UserAppPermissionRequest>> groupBySelectedAppMap =\n+        user.getApps()\n+            .stream()\n+            .collect(Collectors.groupingBy(UserAppPermissionRequest::isSelected));\n+\n+    // save permissions for selected apps\n+    for (UserAppPermissionRequest app :\n+        CollectionUtils.emptyIfNull(groupBySelectedAppMap.get(CommonConstants.SELECTED))) {\n+      saveAppStudySitePermissions(user, adminDetails, app);\n+    }\n+\n+    // save permissions for unselected apps\n+    for (UserAppPermissionRequest app :\n+        CollectionUtils.emptyIfNull(groupBySelectedAppMap.get(CommonConstants.UNSELECTED))) {\n+      for (UserStudyPermissionRequest study : CollectionUtils.emptyIfNull(app.getStudies())) {\n+        if (study.isSelected()) {\n+          saveStudySitePermissions(user, adminDetails, study);\n+        } else if (CollectionUtils.isNotEmpty(study.getSites())) {\n+          saveSitePermissions(user, adminDetails, study);\n+        }\n+      }\n+    }\n     logger.exit(\"Successfully saved admin details.\");\n     return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n   }\n \n+  private void saveAppStudySitePermissions(\n+      UserRequest user, UserRegAdminEntity adminDeatils, UserAppPermissionRequest app) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c39158123585cbba466e7a6129e8da59c790f12d"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxMzU4Ng==", "bodyText": "typo fixed", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/686#discussion_r463013586", "createdAt": "2020-07-30T13:55:00Z", "author": {"login": "chiranjibi009"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -139,10 +149,108 @@ private AdminUserResponse saveAdminDetails(UserRequest user) {\n     UserRegAdminEntity adminDetails =\n         UserMapper.fromUserRequest(user, Long.valueOf(appConfig.getSecurityCodeExpireDate()));\n     adminDetails = userAdminRepository.saveAndFlush(adminDetails);\n+\n+    Map<Boolean, List<UserAppPermissionRequest>> groupBySelectedAppMap =\n+        user.getApps()\n+            .stream()\n+            .collect(Collectors.groupingBy(UserAppPermissionRequest::isSelected));\n+\n+    // save permissions for selected apps\n+    for (UserAppPermissionRequest app :\n+        CollectionUtils.emptyIfNull(groupBySelectedAppMap.get(CommonConstants.SELECTED))) {\n+      saveAppStudySitePermissions(user, adminDetails, app);\n+    }\n+\n+    // save permissions for unselected apps\n+    for (UserAppPermissionRequest app :\n+        CollectionUtils.emptyIfNull(groupBySelectedAppMap.get(CommonConstants.UNSELECTED))) {\n+      for (UserStudyPermissionRequest study : CollectionUtils.emptyIfNull(app.getStudies())) {\n+        if (study.isSelected()) {\n+          saveStudySitePermissions(user, adminDetails, study);\n+        } else if (CollectionUtils.isNotEmpty(study.getSites())) {\n+          saveSitePermissions(user, adminDetails, study);\n+        }\n+      }\n+    }\n     logger.exit(\"Successfully saved admin details.\");\n     return new AdminUserResponse(MessageCode.ADD_NEW_USER_SUCCESS, adminDetails.getId());\n   }\n \n+  private void saveAppStudySitePermissions(\n+      UserRequest user, UserRegAdminEntity adminDeatils, UserAppPermissionRequest app) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNTE0Mw=="}, "originalCommit": {"oid": "c39158123585cbba466e7a6129e8da59c790f12d"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2044, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}