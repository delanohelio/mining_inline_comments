{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NjAwOTQx", "number": 615, "title": "Display Login or Auto Sign-in page implementation with integration tests", "bodyText": "Note: I added below dependency to pom.xml but 2 space indentation caused 358 LOC modified hence the PR size 851, excluding this 2 space indentation PR size is below 500 LOC. Please review and approve the PR.\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-thymeleaf</artifactId>\n</dependency>\n\nsignin.html, login.html and error.html contains dummy implementation. I'll replace the file content once the UI design & development is completed.", "createdAt": "2020-07-10T19:10:19Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615", "merged": true, "mergeCommit": {"oid": "bbfd50f059a864eecf2550e054f0e85215c1a1d8"}, "closed": true, "closedAt": "2020-08-02T05:02:17Z", "author": {"login": "dhanyak-btc"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczn6r0gH2gAyNDQ3NjAwOTQxOjNlZDc4NWExNGU1MmQ3YmI4ZDdjMzMwYjA3ZDAwODI4ZjI3MTNkYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc62K-WgH2gAyNDQ3NjAwOTQxOjczOTNiOGM1ZjdmY2RlZTRlNGRhZjJjNTYzYzI4MzI0ZjcyNzMyNGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3ed785a14e52d7bb8d7c330b07d00828f2713da7", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3ed785a14e52d7bb8d7c330b07d00828f2713da7", "committedDate": "2020-07-10T18:26:37Z", "message": "Display Login or Auto Signin page implementation with integration tests\n\nDisplay Login or Auto Signin page implementation with integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b10ec4a66bcbb21cdff9ab9aa6d2f4e14afb4783", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b10ec4a66bcbb21cdff9ab9aa6d2f4e14afb4783", "committedDate": "2020-07-10T18:45:28Z", "message": "Removed Signup & Forgot password redirect urls, will be added in next PR\n\nRemoved Signup & Forgot password redirect urls, will be added in next PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d019d4cef83c27fc695fb0ff41b9ad9871c66ea1", "committedDate": "2020-07-10T19:00:37Z", "message": "Formatted JSON files using JSON Editor\n\nFormatted JSON files using JSON Editor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDk4MTYx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#pullrequestreview-448498161", "createdAt": "2020-07-14T22:02:54Z", "commit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMjowMjo1NFrOGxm96w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzozMzowNFrOGxo7Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY3MTg1MQ==", "bodyText": "use numerical value. We are not saving any space if the value of the enum takes the same space as its name.\nunless this is not the value that ends up in the audit log database?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454671851", "createdAt": "2020-07-14T22:02:54Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/DevicePlatform.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+@Getter\n+@RequiredArgsConstructor\n+public enum DevicePlatform {\n+  IOS(\"IOS\", \"Represents an apple platform\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MTYzNw==", "bodyText": "maybe move this code to the DevicePlatform? e.g.\nDevicePlatform.fromString(devicePlatform) == ANDROID", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454691637", "createdAt": "2020-07-14T22:56:03Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.config;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.DevicePlatform.ANDROID;\n+import static com.google.cloud.healthcare.fdamystudies.common.DevicePlatform.IOS;\n+\n+import java.io.Serializable;\n+import lombok.Getter;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+@Getter\n+public class RedirectConfig implements Serializable {\n+\n+  private static final long serialVersionUID = 2189883675260389666L;\n+\n+  @Value(\"${participant.manager.callback-url}\")\n+  private String participantManagerCallbackUrl;\n+\n+  @Value(\"${mystudies.ios.app.callback-url}\")\n+  private String myStudiesIosAppCallbackUrl;\n+\n+  @Value(\"${mystudies.android.app.callback-url}\")\n+  private String myStudiesAndroidAppCallbackUrl;\n+\n+  public String getCallbackUrl(String devicePlatform) {\n+    if (ANDROID.getValue().equalsIgnoreCase(devicePlatform)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MjcyOQ==", "bodyText": "Looks like loginChallenge should be required then?\nAlso why is it returning string \"error\"? not a meaningful string, and/or an exception?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454692729", "createdAt": "2020-07-14T22:59:25Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDE5MA==", "bodyText": "should this be named loginResponse instead of requestLoginResponse?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454694190", "createdAt": "2020-07-14T23:03:42Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5NDQ5NA==", "bodyText": "nit: change to login to follow our usual naming pattern", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454694494", "createdAt": "2020-07-14T23:04:39Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5Nzg0MQ==", "bodyText": "I would prefer this to be set to true by default, or to be set as a config param and set to false for dev environments only.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454697841", "createdAt": "2020-07-14T23:14:20Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/CookieUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.MultiValueMap;\n+\n+public final class CookieUtils {\n+\n+  private CookieUtils() {}\n+\n+  public static void addCookies(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      MultiValueMap<String, String> params,\n+      String... cookieNames) {\n+    for (String cookieName : cookieNames) {\n+      addCookie(request, response, cookieName, params.getFirst(cookieName));\n+    }\n+  }\n+\n+  public static void addCookie(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      String cookieName,\n+      String cookieValue) {\n+    Cookie cookie = new Cookie(cookieName, cookieValue);\n+    cookie.setMaxAge(600);\n+    if (StringUtils.equalsIgnoreCase(\"https\", request.getScheme())) {\n+      cookie.setSecure(true);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODI0OA==", "bodyText": "no reason to add ORG_ID since it will be removed.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454698248", "createdAt": "2020-07-14T23:15:36Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5ODk4OA==", "bodyText": "why do we need all these details?\nCookie will be bound to the browser/device it was planted in, so It's not likely that we would get the same cookie coming from another device etc", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454698988", "createdAt": "2020-07-14T23:17:44Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,\n+        CORRELATION_ID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTA4Ng==", "bodyText": "why is this needed?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454699086", "createdAt": "2020-07-14T23:17:58Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";\n+  }\n+\n+  private boolean skipLogin(JsonNode responseBody) {\n+    return responseBody.has(SKIP) && responseBody.get(SKIP).booleanValue();\n+  }\n+\n+  private String redirectToLoginOrSigninPage(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      JsonNode responseBody,\n+      Model model,\n+      String loginChallenge) {\n+\n+    String requestUrl = responseBody.get(\"request_url\").textValue();\n+    MultiValueMap<String, String> qsParams =\n+        UriComponentsBuilder.fromUriString(requestUrl).build().getQueryParams();\n+\n+    addCookie(request, response, LOGIN_CHALLENGE, loginChallenge);\n+    addCookies(\n+        request,\n+        response,\n+        qsParams,\n+        APP_ID,\n+        ORG_ID,\n+        CORRELATION_ID,\n+        CLIENT_APP_VERSION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5OTc5OQ==", "bodyText": "this is pretty short for a normal cookie; Considering your cookieUtil has a generic name and signature, I suggest you either:\n\npass cookie's age as an input\nrename the class to signal that this is for a spacial usecase, i.e. loginCookie", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454699799", "createdAt": "2020-07-14T23:20:11Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/CookieUtils.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.common;\n+\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.util.MultiValueMap;\n+\n+public final class CookieUtils {\n+\n+  private CookieUtils() {}\n+\n+  public static void addCookies(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      MultiValueMap<String, String> params,\n+      String... cookieNames) {\n+    for (String cookieName : cookieNames) {\n+      addCookie(request, response, cookieName, params.getFirst(cookieName));\n+    }\n+  }\n+\n+  public static void addCookie(\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      String cookieName,\n+      String cookieValue) {\n+    Cookie cookie = new Cookie(cookieName, cookieValue);\n+    cookie.setMaxAge(600);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMTY2Mw==", "bodyText": "I am guessing these pages will be replaced by proper forms?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454701663", "createdAt": "2020-07-14T23:25:41Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/resources/templates/signin.html", "diffHunk": "@@ -0,0 +1,11 @@\n+<!DOCTYPE html>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMTk0Ng==", "bodyText": "why is there an html page for error? considering auth server is not a front facing service I would expect errors to be returned via json.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454701946", "createdAt": "2020-07-14T23:26:44Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/resources/templates/error.html", "diffHunk": "@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"\"\n+  xmlns:th=\"https://www.thymeleaf.org\"\n+  xmlns:sec=\"https://www.thymeleaf.org/thymeleaf-extras-springsecurity3\">\n+<head>\n+<title>Error</title>\n+</head>\n+<body>\n+  <p>Sorry, an error has occurred and your request could not be\n+    processed. Please try again later.</p>\n+</body>\n+</html>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMzg3OA==", "bodyText": "I am finding this approach a bit confusing; wouldn't it make sense to return a proper json error string and just display that instead?\nConsidering Auth server is not directly client facing, I don't think having an error page makes a lot of sense anyway.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#discussion_r454703878", "createdAt": "2020-07-14T23:33:04Z", "author": {"login": "zohrehj"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookie;\n+import static com.google.cloud.healthcare.fdamystudies.common.CookieUtils.addCookies;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.APP_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CLIENT_APP_VERSION;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.CORRELATION_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_PLATFORM;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.DEVICE_TYPE;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.ORG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.SKIP;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.TEMP_REG_ID;\n+import static com.google.cloud.healthcare.fdamystudies.oauthscim.common.AuthScimConstants.USER_ID;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.config.RedirectConfig;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.model.UserEntity;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.OAuthService;\n+import com.google.cloud.healthcare.fdamystudies.oauthscim.service.UserService;\n+import java.util.Optional;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.util.UriComponentsBuilder;\n+import org.springframework.web.util.WebUtils;\n+\n+@Controller\n+public class LoginController {\n+\n+  private XLogger logger = XLoggerFactory.getXLogger(UserController.class.getName());\n+\n+  private static final String LOGIN = \"login\";\n+\n+  private static final String LOGIN_CHALLENGE = \"login_challenge\";\n+\n+  @Autowired private OAuthService oauthService;\n+\n+  @Autowired private UserService userService;\n+\n+  @Autowired private RedirectConfig redirectConfig;\n+\n+  @GetMapping(value = \"/login\")\n+  public String authorize(\n+      @RequestParam(name = LOGIN_CHALLENGE, required = false) String loginChallenge,\n+      @RequestParam(required = false) String code,\n+      HttpServletRequest request,\n+      HttpServletResponse response,\n+      Model model) {\n+    logger.entry(String.format(\"%s request\", request.getRequestURI()));\n+\n+    if (StringUtils.isNotBlank(code)) {\n+      logger.exit(\n+          \"login/consent flow completed, redirect to callbackUrl with auth code and userId\");\n+      return redirectToCallbackUrl(request, code, response);\n+    }\n+\n+    if (StringUtils.isEmpty(loginChallenge)) {\n+      return \"error\";\n+    }\n+\n+    // show or skip login page\n+    MultiValueMap<String, String> paramMap = new LinkedMultiValueMap<>();\n+    paramMap.add(LOGIN_CHALLENGE, loginChallenge);\n+    ResponseEntity<JsonNode> requestLoginResponse = oauthService.requestLogin(paramMap);\n+    if (requestLoginResponse.getStatusCode().is2xxSuccessful()) {\n+      JsonNode responseBody = requestLoginResponse.getBody();\n+      if (skipLogin(responseBody)) {\n+        logger.exit(\"skip login, return to callback URL\");\n+        return redirectToCallbackUrl(request, code, response);\n+      }\n+      return redirectToLoginOrSigninPage(request, response, responseBody, model, loginChallenge);\n+    }\n+\n+    return \"error\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d019d4cef83c27fc695fb0ff41b9ad9871c66ea1"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faf83f30764c78c44a58723377d16d1c8b495620", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/faf83f30764c78c44a58723377d16d1c8b495620", "committedDate": "2020-07-17T16:28:18Z", "message": "Fixed PR#615 review comments\n\nFixed PR#615 review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd9e56f539410efaf50e9d37e2ca366f4129d80f", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dd9e56f539410efaf50e9d37e2ca366f4129d80f", "committedDate": "2020-07-19T05:48:50Z", "message": "addCookie and addCookies methods moved to LoginController\n\naddCookie and addCookies methods moved to LoginController hence this file is removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjc4Njk4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#pullrequestreview-451678698", "createdAt": "2020-07-20T14:47:45Z", "commit": {"oid": "dd9e56f539410efaf50e9d37e2ca366f4129d80f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f55b1abf4b3912e198f495fa72703a71ebacb5", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f3f55b1abf4b3912e198f495fa72703a71ebacb5", "committedDate": "2020-07-21T06:43:57Z", "message": "Added TODO comments with Issue/PR number in HTML files\n\nAdded TODO comments with Issue/PR number in HTML files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "395a2c1af1b14ebcadac2d8c0d832ebe470e3d77", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/395a2c1af1b14ebcadac2d8c0d832ebe470e3d77", "committedDate": "2020-07-31T16:00:09Z", "message": "Merge branch 'develop' into oauth_scim_login"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MzU1NzUz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/615#pullrequestreview-459355753", "createdAt": "2020-07-31T17:52:54Z", "commit": {"oid": "395a2c1af1b14ebcadac2d8c0d832ebe470e3d77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7393b8c5f7fcdee4e4daf2c563c28324f727324e", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7393b8c5f7fcdee4e4daf2c563c28324f727324e", "committedDate": "2020-08-02T05:00:33Z", "message": "Merge branch 'develop' into oauth_scim_login"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 810, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}