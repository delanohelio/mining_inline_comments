{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NzQ0NzYy", "number": 2384, "title": "[participant-manager-datastore] [participant-datastore]: Enrollment history implementation", "bodyText": "This PR contains the issue fixes for issue #1454 and #2225\n1: EnrollmentStatus correted.\n2: ParticipantStatusHistoryMapper added in common service.\n3: ParticipantEnrollmentHistoryEntity introduced for enrollment history.\n4: \"/sites/{participantRegistrySiteId}/participant\" and \"/{appId}/participants\" end point implementation changed.\n5: \"/enroll\" and \"/withdrawfromstudy\" end point implementation changed.", "createdAt": "2020-12-14T19:22:33Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384", "merged": true, "mergeCommit": {"oid": "e9c2abee8415fd3bec0eddb35d4a71a01d16a1c0"}, "closed": true, "closedAt": "2020-12-16T16:29:04Z", "author": {"login": "chiranjibi009"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmKXI-gH2gAyNTM5NzQ0NzYyOmRmZDM5ZmNmYTZmMzllOThkMDg1OGM1ZDI4NTE2YzljNWFiMWY3ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmxbwCgH2gAyNTM5NzQ0NzYyOjM0ZjFjYTA4NjM0Y2ViMGNmNWNlNDJjZTg1Y2Q4NzYwMmYyMTE2ZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dfd39fcfa6f39e98d0858c5d28516c9c5ab1f7ec", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dfd39fcfa6f39e98d0858c5d28516c9c5ab1f7ec", "committedDate": "2020-12-14T18:50:41Z", "message": "App Participant and Participant Detail API changes\n\nApp Participant and Participant Detail API changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "author": {"user": {"login": "chiranjibi009", "name": "Chiranjibi Dash"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/382c88f8fe69d245e2d3234fe6d1d2b7d18208a1", "committedDate": "2020-12-14T19:18:00Z", "message": "enrollment history added for enroll and withdrawal flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODMzODI5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#pullrequestreview-551833829", "createdAt": "2020-12-14T19:42:33Z", "commit": {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTo0MjozM1rOIFjo4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTo0NzoxM1rOIFj7wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5NzY5Nw==", "bodyText": "same comment as previous PR, using a more readable format could make future debugs easier. e.g. use \"-\" or similar", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542697697", "createdAt": "2020-12-14T19:42:33Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantEnrollmentHistory.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.model;\n+\n+import java.sql.Timestamp;\n+\n+public interface ParticipantEnrollmentHistory {\n+  String getLocationCustomId();\n+\n+  String getLocationName();\n+\n+  String getStudyId();\n+\n+  String getSiteId();\n+\n+  String getUserDetailsId();\n+\n+  String getEnrollmentStatus();\n+\n+  Timestamp getCreated();\n+\n+  default String getUserIdStudyIdKey() {\n+    return getUserDetailsId() + getStudyId();\n+  }\n+\n+  default String getUserIdStudyIdSiteIdKey() {\n+    return getUserDetailsId() + getStudyId() + getSiteId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMDI3MQ==", "bodyText": "why is sortBy and sortDirection getting combined?\nthey would need to get separated before they can be applied, so why combine them in the first place?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542700271", "createdAt": "2020-12-14T19:45:03Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/controller/AppController.java", "diffHunk": "@@ -97,14 +96,7 @@\n \n     AppParticipantsResponse appParticipantsResponse =\n         appService.getAppParticipants(\n-            appId,\n-            userId,\n-            auditRequest,\n-            excludeParticipantStudyStatus,\n-            limit,\n-            offset,\n-            sortBy + \"_\" + sortDirection,\n-            searchTerm);\n+            appId, userId, auditRequest, limit, offset, sortBy + \"_\" + sortDirection, searchTerm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjcwMjUyOQ==", "bodyText": "looks like you are not handling anything but ASC, so you might as well remove sort direction from inputs and only pass the order by value here.\nalso your SQL is generating two ASC back to back", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r542702529", "createdAt": "2020-12-14T19:47:13Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -135,31 +134,10 @@\n   @Query(\n       value =\n           \"SELECT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n-              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n+              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType \"\n               + \"FROM user_details ud \"\n-              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n-              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id  AND ps.status NOT IN (:excludeParticipantStudyStatus) \"\n-              + \"WHERE ud.app_info_id=:appId AND ud.id IN (:userDetailIds) \"\n-              + \"ORDER BY CASE :orderByCondition WHEN 'email_asc' THEN ud.email END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationDate_asc' THEN ud.verification_time END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationStatus_asc' THEN ud.status END ASC, \"\n-              + \"         CASE :orderByCondition WHEN 'email_desc' THEN ud.email END DESC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationDate_desc' THEN ud.verification_time END DESC, \"\n-              + \"         CASE :orderByCondition WHEN 'registrationStatus_desc' THEN ud.status END DESC \",\n-      nativeQuery = true)\n-  public List<AppParticipantsInfo> findUserDetailsByAppIdAndStudyStatus(\n-      String appId,\n-      String[] excludeParticipantStudyStatus,\n-      List<String> userDetailIds,\n-      String orderByCondition);\n-\n-  @Query(\n-      value =\n-          \"SELECT ud.id AS userDetailsId, ud.email AS email,ud.status AS registrationStatus, ud.verification_time AS registrationDate, \"\n-              + \"st.name AS studyName, st.id AS studyId, st.custom_id AS customStudyId, st.type AS studyType,ps.status AS participantStudyStatus, ps.withdrawal_time AS withdrawalTime,ps.enrolled_time AS enrolledTime \"\n-              + \"FROM user_details ud \"\n-              + \"LEFT JOIN participant_study_info ps ON ud.id = ps.user_details_id \"\n-              + \"LEFT JOIN study_info st ON st.id=ps.study_info_id \"\n+              + \"LEFT JOIN participant_enrollment_history peh ON ud.id = peh.user_details_id \"\n+              + \"LEFT JOIN study_info st ON st.id=peh.study_info_id \"\n               + \"WHERE ud.app_info_id=:appId AND ud.id IN (:userDetailIds) \"\n               + \"ORDER BY CASE :orderByCondition WHEN 'email_asc' THEN ud.email END ASC, \"\n               + \"         CASE :orderByCondition WHEN 'registrationDate_asc' THEN ud.verification_time END ASC, \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382c88f8fe69d245e2d3234fe6d1d2b7d18208a1"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48bada15b059c19bc510709f0c0950efefa29960", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/48bada15b059c19bc510709f0c0950efefa29960", "committedDate": "2020-12-15T04:30:36Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "990e58208c3c899ff1134e657510394ed653358b", "author": {"user": {"login": "chiranjibi009", "name": "Chiranjibi Dash"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/990e58208c3c899ff1134e657510394ed653358b", "committedDate": "2020-12-15T07:01:50Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3537f604de8c555c0111da68a6e3f57643e9546", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e3537f604de8c555c0111da68a6e3f57643e9546", "committedDate": "2020-12-15T07:04:12Z", "message": "Fixed Review Comment\n\nFixed Review Comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98a0fdcb682bb6d4685ce1b73518b25d3ab52f7", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d98a0fdcb682bb6d4685ce1b73518b25d3ab52f7", "committedDate": "2020-12-15T07:05:42Z", "message": "Merge branch 'enrollment-changes' of https://github.com/GoogleCloudPlatform/fda-mystudies into enrollment-changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTE1NTQ4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#pullrequestreview-552515548", "createdAt": "2020-12-15T14:29:26Z", "commit": {"oid": "d98a0fdcb682bb6d4685ce1b73518b25d3ab52f7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a85a18d6861757de90eb8085468e4234dd5341f", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1a85a18d6861757de90eb8085468e4234dd5341f", "committedDate": "2020-12-15T14:47:49Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daa26232a39fee6e2b79054ca45b7af0ec35eba9", "author": {"user": {"login": "chiranjibi009", "name": "Chiranjibi Dash"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/daa26232a39fee6e2b79054ca45b7af0ec35eba9", "committedDate": "2020-12-15T15:25:26Z", "message": "currect enrollment status, date and withdrawal date added to getParticipantDetails api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d8e209f1b6c0db6ebaa085072c7f389ef04f1bb", "author": {"user": {"login": "chiranjibi009", "name": "Chiranjibi Dash"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9d8e209f1b6c0db6ebaa085072c7f389ef04f1bb", "committedDate": "2020-12-15T15:30:46Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06618a1f2fad61fcac68fd95dece2ba7cff42e26", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/06618a1f2fad61fcac68fd95dece2ba7cff42e26", "committedDate": "2020-12-15T16:15:57Z", "message": "/enroll flow changes\n\n/enroll flow changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8696f648a984252bb71f380d8986d2bd4cd9c724", "author": {"user": {"login": "madhurya-btc", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8696f648a984252bb71f380d8986d2bd4cd9c724", "committedDate": "2020-12-15T16:20:09Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e94edb9f567143ef5ebbab805fc0d551bbd8881", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3e94edb9f567143ef5ebbab805fc0d551bbd8881", "committedDate": "2020-12-15T16:31:21Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ae09c4d5506e6d571b9b19ca81ffe1eab1491c", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c7ae09c4d5506e6d571b9b19ca81ffe1eab1491c", "committedDate": "2020-12-15T17:12:10Z", "message": "Enrollment Status Changes in ParticipantDetails, App Participants, withrawFromStudy and deactivateAccnt\n\nEnrollment Status Changes in ParticipantDetails, App Participants, withrawFromStudy and deactivateAccnt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4", "committedDate": "2020-12-15T17:16:13Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzEzMDUx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#pullrequestreview-552713051", "createdAt": "2020-12-15T17:46:05Z", "commit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNzo0NjowNVrOIGX8cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNzo1NTowM1rOIGYWCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NDY3Mw==", "bodyText": "what if this value is already set?\nIt should come from the database and only be set in enroll/withdraw action where the status is being changed.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543554673", "createdAt": "2020-12-15T17:46:05Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/mapper/ParticipantStatusHistoryMapper.java", "diffHunk": "@@ -29,6 +31,12 @@ public static ParticipantEnrollmentHistoryEntity toParticipantStatusHistoryEntit\n     participantStatusEntity.setStudy(participantRegistrySiteEntity.getStudy());\n     participantStatusEntity.setParticipantRegistrySite(participantRegistrySiteEntity);\n     participantStatusEntity.setUserDetails(userDetails);\n+    Timestamp now = new Timestamp(Instant.now().toEpochMilli());\n+    if (EnrollmentStatus.ENROLLED.equals(enrollment)) {\n+      participantStatusEntity.setEnrolledDate(now);\n+    } else if (EnrollmentStatus.WITHDRAWN.equals(enrollment)) {\n+      participantStatusEntity.setWithdrawalDate(now);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTU5MA==", "bodyText": "keep the names consistent, is it a date, time or timestamp?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543555590", "createdAt": "2020-12-15T17:47:18Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/model/ParticipantEnrollmentHistoryEntity.java", "diffHunk": "@@ -66,6 +66,12 @@\n   @CreationTimestamp\n   private Timestamp created;\n \n+  @Column(name = \"withdrawal_time\")\n+  private Timestamp withdrawalDate;\n+\n+  @Column(name = \"enrolled_time\")\n+  private Timestamp enrolledDate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NTg0NA==", "bodyText": "why change the order?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543555844", "createdAt": "2020-12-15T17:47:36Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/ParticipantEnrollmentHistoryRepository.java", "diffHunk": "@@ -25,24 +27,44 @@\n     extends JpaRepository<ParticipantEnrollmentHistoryEntity, String> {\n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n-              + \"peh.status AS enrollmentStatus, peh.created_time AS created, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+          \"SELECT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n+              + \"peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n               + \"FROM participant_enrollment_history peh, locations loc, sites s \"\n               + \"WHERE peh.site_id=s.id AND s.location_id=loc.id AND peh.status IN ('enrolled','withdrawn') AND \"\n               + \"peh.user_details_id IN (:userIds) AND peh.app_info_id=:appId \"\n-              + \"ORDER BY peh.user_details_id, peh.study_info_id, peh.site_id, peh.created_time DESC\",\n+              + \"ORDER BY loc.name DESC\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NzUzNQ==", "bodyText": "why do you have an OR here?\nare you expecting to pass an incorrect value to userId or participantRegistryId?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543557535", "createdAt": "2020-12-15T17:49:58Z", "author": {"login": "zohrehj"}, "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/ParticipantEnrollmentHistoryRepository.java", "diffHunk": "@@ -25,24 +27,44 @@\n     extends JpaRepository<ParticipantEnrollmentHistoryEntity, String> {\n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n-              + \"peh.status AS enrollmentStatus, peh.created_time AS created, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n+          \"SELECT peh.site_id AS siteId, peh.user_details_id AS userDetailsId, peh.study_info_id AS studyId, \"\n+              + \"peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate, loc.custom_id AS locationCustomId, loc.name AS locationName \"\n               + \"FROM participant_enrollment_history peh, locations loc, sites s \"\n               + \"WHERE peh.site_id=s.id AND s.location_id=loc.id AND peh.status IN ('enrolled','withdrawn') AND \"\n               + \"peh.user_details_id IN (:userIds) AND peh.app_info_id=:appId \"\n-              + \"ORDER BY peh.user_details_id, peh.study_info_id, peh.site_id, peh.created_time DESC\",\n+              + \"ORDER BY loc.name DESC\",\n       nativeQuery = true)\n   public List<ParticipantEnrollmentHistory> findParticipantEnrollmentHistoryByAppId(\n       String appId, List<String> userIds);\n \n   @Query(\n       value =\n-          \"SELECT DISTINCT peh.status AS enrollmentStatus, peh.created_time AS created \"\n+          \"SELECT peh.status AS enrollmentStatus, peh.withdrawal_time AS withdrawalDate,  peh.enrolled_time AS enrolledDate \"\n               + \"FROM participant_enrollment_history peh \"\n               + \"WHERE peh.site_id=:siteId AND peh.study_info_id=:studyId AND \"\n               + \"peh.participant_registry_site_id=:participantRegistryId AND peh.app_info_id=:appId \"\n               + \"ORDER BY peh.created_time DESC\",\n       nativeQuery = true)\n   public List<ParticipantEnrollmentHistory> findByAppIdSiteIdAndStudyId(\n       String appId, String studyId, String siteId, String participantRegistryId);\n+\n+  @Modifying\n+  @Transactional\n+  @Query(\n+      value =\n+          \"UPDATE participant_enrollment_history SET status=:status, withdrawal_time= now() WHERE \"\n+              + \"withdrawal_time IS NULL AND study_info_id=:studyId AND \"\n+              + \"(user_details_id =:userId OR participant_registry_site_id=:participantRegistryId)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MDU1OQ==", "bodyText": "comment is not needed.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543560559", "createdAt": "2020-12-15T17:54:07Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/AppServiceImpl.java", "diffHunk": "@@ -447,48 +448,33 @@ public AppParticipantsResponse getAppParticipants(\n         participantEnrollmentHistoryRepository.findParticipantEnrollmentHistoryByAppId(\n             app.getId(), userIds);\n \n-    Map<String, AppSiteDetails> enrollmentHistoryMap = new HashMap<>();\n     Map<String, List<AppSiteDetails>> sitesByUserIdStudyIdMap = new HashMap<>();\n \n     List<AppSiteDetails> appSites = null;\n     AppSiteDetails appSiteDetails = null;\n-    String createdDate = null;\n     for (ParticipantEnrollmentHistory enrollmentHistory : enrollmentHistoryEntities) {\n-      createdDate = DateTimeUtils.format(enrollmentHistory.getCreated());\n       if (!sitesByUserIdStudyIdMap.containsKey(enrollmentHistory.getUserIdStudyIdKey())) {\n         appSites = new ArrayList<>();\n         sitesByUserIdStudyIdMap.put(enrollmentHistory.getUserIdStudyIdKey(), appSites);\n       }\n       appSites = sitesByUserIdStudyIdMap.get(enrollmentHistory.getUserIdStudyIdKey());\n-      if (!enrollmentHistoryMap.containsKey(enrollmentHistory.getUserIdStudyIdSiteIdKey())) {\n-        appSiteDetails = prepareAppSiteDetails(createdDate, enrollmentHistory);\n-        enrollmentHistoryMap.put(enrollmentHistory.getUserIdStudyIdSiteIdKey(), appSiteDetails);\n-        appSites.add(appSiteDetails);\n-        continue;\n-      }\n-\n-      appSiteDetails = enrollmentHistoryMap.get(enrollmentHistory.getUserIdStudyIdSiteIdKey());\n-\n-      if (StringUtils.isEmpty(appSiteDetails.getWithdrawlDate())\n-          && EnrollmentStatus.WITHDRAWN\n-              .getStatus()\n-              .equals(enrollmentHistory.getEnrollmentStatus())) {\n-        appSiteDetails.setWithdrawlDate(StringUtils.defaultIfEmpty(createdDate, NOT_APPLICABLE));\n-      } else if (StringUtils.isEmpty(appSiteDetails.getEnrollmentDate())\n-          && EnrollmentStatus.ENROLLED\n-              .getStatus()\n-              .equals(enrollmentHistory.getEnrollmentStatus())) {\n-        appSiteDetails.setEnrollmentDate(StringUtils.defaultIfEmpty(createdDate, NOT_APPLICABLE));\n-      }\n+      appSiteDetails = prepareAppSiteDetails(enrollmentHistory);\n+      appSites.add(appSiteDetails);\n     }\n \n+    // H2 Database throws error ORDER_BY_NOT_IN_RESULT Order by expression ID must be in the result\n+    // list in this case when DISTINCT is added to the SQL query so removing duplicates using\n+    // HashSet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MTIyNA==", "bodyText": "if user is enrolled, then withdrawal date should be empty, no?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#discussion_r543561224", "createdAt": "2020-12-15T17:55:03Z", "author": {"login": "zohrehj"}, "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/SiteControllerTest.java", "diffHunk": "@@ -1452,6 +1455,12 @@ public void shouldReturnParticipantDetailsForEnrollmentHistory() throws Exceptio\n         .andExpect(jsonPath(\"$.participantDetails.consentHistory\").isArray())\n         .andExpect(jsonPath(\"$.participantDetails.consentHistory\", hasSize(1)))\n         .andExpect(jsonPath(\"$.participantDetails.invitationDate\").isNotEmpty())\n+        .andExpect(jsonPath(\"$.participantDetails.enrollmentDate\").isNotEmpty())\n+        .andExpect(jsonPath(\"$.participantDetails.withdrawalDate\").isNotEmpty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76c6f2f3dc6705cc9eb2c12b8ba64cd7d8047b4"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be3d19e5684683f60d3e1ea2632e2ef7c069791", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3be3d19e5684683f60d3e1ea2632e2ef7c069791", "committedDate": "2020-12-16T06:12:35Z", "message": "Fixed Review comment\n\nFixed Review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f3374b618947e9d7b152a6d9808240ee82f357", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d0f3374b618947e9d7b152a6d9808240ee82f357", "committedDate": "2020-12-16T06:16:45Z", "message": "Merge branch 'develop' into enrollment-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "311bb3764d581c0ab664d80c2b1d3928b562b8d1", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/311bb3764d581c0ab664d80c2b1d3928b562b8d1", "committedDate": "2020-12-16T12:40:22Z", "message": "Issue fixes and comment fixes\n\nIssue fixes and comment fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96352f89c8bbea18ba184cde459e29e871807c8d", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/96352f89c8bbea18ba184cde459e29e871807c8d", "committedDate": "2020-12-16T15:03:59Z", "message": "Update mystudies_participant_datastore_db_script.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODUzNjUz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#pullrequestreview-553853653", "createdAt": "2020-12-16T16:18:35Z", "commit": {"oid": "96352f89c8bbea18ba184cde459e29e871807c8d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODU1Nzkw", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/2384#pullrequestreview-553855790", "createdAt": "2020-12-16T16:20:44Z", "commit": {"oid": "96352f89c8bbea18ba184cde459e29e871807c8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f1ca08634ceb0cf5ce42ce85cd87602f2116fd", "author": {"user": {"login": "monica-BTC", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/34f1ca08634ceb0cf5ce42ce85cd87602f2116fd", "committedDate": "2020-12-16T16:22:01Z", "message": "Merge branch 'develop' into enrollment-changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1054, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}