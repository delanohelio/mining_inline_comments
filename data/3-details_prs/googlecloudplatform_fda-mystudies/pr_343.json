{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTkyOTY4", "number": 343, "title": "iOS - Share PDFs and HTML content as PDFs with other supported Apps.", "bodyText": "Fixes #131", "createdAt": "2020-05-05T15:35:42Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343", "merged": true, "mergeCommit": {"oid": "c9c5a03bb2febf142273976f1fcf6b0181ba80eb"}, "closed": true, "closedAt": "2020-05-07T20:41:30Z", "author": {"login": "tushar-boston"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceVvwpgH2gAyNDEzNTkyOTY4OjJmZjAwYmMxMWVlOTM5MDQ1M2I5ZGNjMTIzODUwOWNlNjQ1NmVmMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfDOjqgH2gAyNDEzNTkyOTY4OmNhMmIwNzBiOGQ4ZDQ4ODEwNWUxNjc2MWIwYjU4YWJhYjM4ODA3ZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ff00bc11ee9390453b9dcc1238509ce6456ef0d", "author": {"user": {"login": "tushar-boston", "name": "Tushar Katyal"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2ff00bc11ee9390453b9dcc1238509ce6456ef0d", "committedDate": "2020-05-05T15:23:59Z", "message": "- Share PDFs and HTML content as PDFs with other supported Apps.\n- Remove unused code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "413adaf3c15cebb447fd889ba307faa86af08831", "author": {"user": {"login": "tushar-boston", "name": "Tushar Katyal"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/413adaf3c15cebb447fd889ba307faa86af08831", "committedDate": "2020-05-05T15:35:52Z", "message": "Merge branch 'early-access' into ios-ui-update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NjMwNjI4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343#pullrequestreview-406630628", "createdAt": "2020-05-06T13:48:41Z", "commit": {"oid": "413adaf3c15cebb447fd889ba307faa86af08831"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzo0ODo0MVrOGRT5VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzo1Mzo1MlrOGRUJZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwNDk0OA==", "bodyText": "can these rules be generalized?\nsame with the previous rules, they should not be written in a way that only applies to a single user.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343#discussion_r420804948", "createdAt": "2020-05-06T13:48:41Z", "author": {"login": "zohrehj"}, "path": "iOS/.gitignore", "diffHunk": "@@ -3,3 +3,10 @@ HPHC/HPHC.xcworkspace/xcuserdata/tusharkatyal.xcuserdatad/UserInterfaceState.xcu\n HPHC/HPHC.xcworkspace/xcuserdata/tusharkatyal.xcuserdatad/xcdebugger/Breakpoints_v2.xcbkptlist\n HPHC/Pods/Pods.xcodeproj/xcuserdata/tusharkatyal.xcuserdatad/xcschemes/xcschememanagement.plist\n HPHC/ResearchKit.xcodeproj/xcuserdata/tusharkatyal.xcuserdatad/xcschemes/xcschememanagement.plist\n+iOS/HPHC/HPHC.xcworkspace/xcshareddata\n+HPHC/HPHC.xcworkspace/xcuserdata\n+HPHC/ResearchKit.xcodeproj/xcshareddata\n+HPHC/Pods/Pods.xcodeproj/xcshareddata\n+HPHC/HPHC/Dev.xcconfig\n+HPHC/HPHC/QA.xcconfig\n+HPHC/HPHC.xcodeproj/xcshareddata", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413adaf3c15cebb447fd889ba307faa86af08831"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwNTc5Mg==", "bodyText": "isn't HPHC/HPHC/QA.xcconfig being excluded via gitignore?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343#discussion_r420805792", "createdAt": "2020-05-06T13:49:40Z", "author": {"login": "zohrehj"}, "path": "iOS/HPHC/HPHC.xcodeproj/project.pbxproj", "diffHunk": "@@ -664,6 +669,7 @@\n \t\t6E7D2D581E433E8700763D4C /* HPHC */ = {\n \t\t\tisa = PBXGroup;\n \t\t\tchildren = (\n+\t\t\t\t6F589EAC246185A50014FE20 /* QA.xcconfig */,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413adaf3c15cebb447fd889ba307faa86af08831"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwOTA2Mw==", "bodyText": "what happens if fileTitle is empty? does it even work in that case?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343#discussion_r420809063", "createdAt": "2020-05-06T13:53:52Z", "author": {"login": "zohrehj"}, "path": "iOS/HPHC/HPHC/Controllers/StudyUI/ResourceUI/GatewayResourceDetailViewController.swift", "diffHunk": "@@ -194,83 +194,49 @@ extension GatewayResourceDetailViewController: WKNavigationDelegate {\n   }\n }\n \n-extension GatewayResourceDetailViewController: MFMailComposeViewControllerDelegate {\n+extension GatewayResourceDetailViewController {\n \n-  func sendEmail() {\n-    let composeVC = MFMailComposeViewController()\n-    composeVC.mailComposeDelegate = self\n-    // Configure the fields of the interface.\n+  func shareResource() {\n \n-    composeVC.setSubject(\"Resources\")\n+    var resourcePdfData: Data?\n+    let resourceLink = self.resource?.file?.link\n+    var resourcesPath: URL?\n \n-    if resource?.file?.localPath != nil {\n-\n-      if self.resource?.file?.localPath == \"BundlePath\" {\n-\n-        do {\n-          let file = Bundle.main.url(\n-            forResource: self.resource?.file?.link!,\n-            withExtension: \"pdf\"\n-          )\n-          let data = try Data(contentsOf: file!)\n-          composeVC.addAttachmentData(\n-            data,\n-            mimeType: \"application/pdf\",\n-            fileName: (resource?.file?.name)!\n-          )\n-        } catch {\n-          Logger.sharedInstance.error(\"Resource file content error: \", error.localizedDescription)\n-        }\n-      } else {\n-\n-        let fullPath = resourcesDownloadPath + \"/\" + (self.resource?.file?.localPath)!\n-\n-        let data = FileDownloadManager.decrytFile(pathURL: URL.init(string: fullPath))\n-\n-        composeVC.addAttachmentData(\n-          data!,\n-          mimeType: \"application/pdf\",\n-          fileName: (resource?.file?.name)!\n-        )\n+    if let pathType = self.resource?.file?.localPath,\n+      pathType == \"BundlePath\",\n+      let path = resourceLink\n+    {\n+      if let fileURL = Bundle.main.url(\n+        forResource: path,\n+        withExtension: \"pdf\"\n+      ) {\n+        resourcesPath = fileURL\n+      }\n+    } else if let path = resourceLink {\n+      let fullPath = resourcesDownloadPath + \"/\" + path\n+      if let url = URL(string: fullPath) {\n+        resourcePdfData = FileDownloadManager.decrytFile(pathURL: url)\n       }\n-\n-    } else {\n-      composeVC.setMessageBody((resource?.file?.link)!, isHTML: true)\n     }\n \n-    if MFMailComposeViewController.canSendMail() {\n-      self.present(composeVC, animated: true, completion: nil)\n-\n-    } else {\n-      let alert = UIAlertController(\n-        title: NSLocalizedString(kTitleError, comment: \"\"),\n-        message: \"\",\n-        preferredStyle: UIAlertController.Style.alert\n-      )\n-\n-      alert.addAction(\n-        UIAlertAction.init(\n-          title: NSLocalizedString(\"OK\", comment: \"\"),\n-          style: .default,\n-          handler: { (_) in\n-\n-            self.dismiss(animated: true, completion: nil)\n-\n-          }\n-        )\n-      )\n+    var items: [Any] = []\n+    if let pdfData = resourcePdfData {\n+      items = [pdfData]\n+    } else if let localPath = resourcesPath {\n+      items = [localPath]\n+    } else if let resourceHTML = resourceLink {\n+      items = [self.webView.renderSelfToPdfData(htmlString: resourceHTML)]\n     }\n-  }\n \n-  func mailComposeController(\n-    _ controller: MFMailComposeViewController,\n-    didFinishWith result: MFMailComposeResult,\n-    error: Error?\n-  ) {\n-    self.isEmailComposerPresented = true\n-    controller.dismiss(animated: true, completion: nil)\n+    guard !items.isEmpty else {\n+      self.view.makeToast(kResourceShareError)\n+      return\n+    }\n+    let fileTitle = self.resource?.title ?? \"\"  // TODO: Update the name of PDF to title.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "413adaf3c15cebb447fd889ba307faa86af08831"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8490b51370066f230cad93cdcf58d4d2cf68143d", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8490b51370066f230cad93cdcf58d4d2cf68143d", "committedDate": "2020-05-06T19:20:27Z", "message": "Merge branch 'early-access' into ios-ui-update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTczNzI4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/343#pullrequestreview-407573728", "createdAt": "2020-05-07T15:13:55Z", "commit": {"oid": "8490b51370066f230cad93cdcf58d4d2cf68143d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0521bf5f6e69e043d2767657d4bbc88ebc780090", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0521bf5f6e69e043d2767657d4bbc88ebc780090", "committedDate": "2020-05-07T19:43:44Z", "message": "Merge branch 'early-access' into ios-ui-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43d0b2d52ab78fb14cef95a4d88aa385342af76a", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/43d0b2d52ab78fb14cef95a4d88aa385342af76a", "committedDate": "2020-05-07T19:57:45Z", "message": "Merge branch 'early-access' into ios-ui-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca2b070b8d8d488105e16761b0b58abab38807f2", "author": {"user": {"login": "zohrehj", "name": "Zohreh Jabbari"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ca2b070b8d8d488105e16761b0b58abab38807f2", "committedDate": "2020-05-07T20:23:21Z", "message": "Merge branch 'early-access' into ios-ui-update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1005, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}