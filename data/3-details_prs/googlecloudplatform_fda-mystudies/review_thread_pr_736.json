{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NjA5Nzk3", "number": 736, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMDo1Nzo0MVrOEW9huQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjoxNjowM1rOEXs0oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTEyMTg1OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMDo1Nzo0MVrOG-fi3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjoyMzowMlrOG-p8aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTcyNQ==", "bodyText": "since this Response is not used you can just make it a void method.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468181725", "createdAt": "2020-08-10T20:57:41Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -97,4 +102,51 @@ private UserResponse registerUserInAuthServer(SetUpAccountRequest setUpAccountRe\n     logger.exit(String.format(\"status=%d\", response.getStatusCodeValue()));\n     return response.getBody();\n   }\n+\n+  @Override\n+  public DeactivateAccountResponse deactivateAccount(String userId) {\n+    logger.entry(\"deactivateAccount()\");\n+\n+    Optional<UserRegAdminEntity> optUserRegAdmin = userRegAdminRepository.findById(userId);\n+    if (!optUserRegAdmin.isPresent()) {\n+      return new DeactivateAccountResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity userRegAdmin = optUserRegAdmin.get();\n+\n+    deactivateUserInAuthServer(userRegAdmin.getUrAdminAuthId());\n+\n+    userRegAdmin.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userRegAdminRepository.saveAndFlush(userRegAdmin);\n+\n+    logger.exit(MessageCode.DEACTIVATE_USER_SUCCESS);\n+    return new DeactivateAccountResponse(MessageCode.DEACTIVATE_USER_SUCCESS);\n+  }\n+\n+  private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1MjEwNA==", "bodyText": "fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468352104", "createdAt": "2020-08-11T06:23:02Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -97,4 +102,51 @@ private UserResponse registerUserInAuthServer(SetUpAccountRequest setUpAccountRe\n     logger.exit(String.format(\"status=%d\", response.getStatusCodeValue()));\n     return response.getBody();\n   }\n+\n+  @Override\n+  public DeactivateAccountResponse deactivateAccount(String userId) {\n+    logger.entry(\"deactivateAccount()\");\n+\n+    Optional<UserRegAdminEntity> optUserRegAdmin = userRegAdminRepository.findById(userId);\n+    if (!optUserRegAdmin.isPresent()) {\n+      return new DeactivateAccountResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity userRegAdmin = optUserRegAdmin.get();\n+\n+    deactivateUserInAuthServer(userRegAdmin.getUrAdminAuthId());\n+\n+    userRegAdmin.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userRegAdminRepository.saveAndFlush(userRegAdmin);\n+\n+    logger.exit(MessageCode.DEACTIVATE_USER_SUCCESS);\n+    return new DeactivateAccountResponse(MessageCode.DEACTIVATE_USER_SUCCESS);\n+  }\n+\n+  private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTcyNQ=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTE5MTg2OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMToyMDozNlrOG-gNbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjozMzowMFrOG-qKqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MjYyMQ==", "bodyText": "UpdateEmailStatusRequest is created in UserProfileService. Why setting it the the patch req content here?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468192621", "createdAt": "2020-08-10T21:20:36Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1NTc1Mw==", "bodyText": "Removed UpdateEmailStatusRequest", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468355753", "createdAt": "2020-08-11T06:33:00Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MjYyMQ=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTE5ODY2OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMToyMjo1OFrOG-gRkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzoxOToxNVrOG-rYqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MzY4MA==", "bodyText": "similar to the above comment. Can we just remove this var?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468193680", "createdAt": "2020-08-10T21:22:58Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\").value(MessageCode.DEACTIVATE_USER_SUCCESS.getMessage()))\n+        .andReturn();\n+\n+    // Step 3: verify updated values\n+    Optional<UserRegAdminEntity> optUser =\n+        userRegAdminRepository.findById(userRegAdminEntity.getId());\n+    UserRegAdminEntity user = optUser.get();\n+    // assertEquals(request.getEmail(), user.getEmail());\n+    assertEquals(UserStatus.DEACTIVATED.getValue(), user.getStatus());\n+\n+    // verify external API call\n+    verify(\n+        1,\n+        putRequestedFor(\n+            urlEqualTo(\n+                \"/oauth-scim-service/users/TuKUeFdyWz4E2A1-LqQcoYKBpMsfLnl-KjiuRFuxWcM3sQg\")));\n+  }\n+\n+  @Test\n+  public void shouldReturnUserNotFoundForDeactivateUser() throws Exception {\n+    // Step 2: Call the API and expect USER_NOT_FOUND error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3NTcyMQ==", "bodyText": "Removed UpdateEmailStatusRequest", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468375721", "createdAt": "2020-08-11T07:19:15Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\").value(MessageCode.DEACTIVATE_USER_SUCCESS.getMessage()))\n+        .andReturn();\n+\n+    // Step 3: verify updated values\n+    Optional<UserRegAdminEntity> optUser =\n+        userRegAdminRepository.findById(userRegAdminEntity.getId());\n+    UserRegAdminEntity user = optUser.get();\n+    // assertEquals(request.getEmail(), user.getEmail());\n+    assertEquals(UserStatus.DEACTIVATED.getValue(), user.getStatus());\n+\n+    // verify external API call\n+    verify(\n+        1,\n+        putRequestedFor(\n+            urlEqualTo(\n+                \"/oauth-scim-service/users/TuKUeFdyWz4E2A1-LqQcoYKBpMsfLnl-KjiuRFuxWcM3sQg\")));\n+  }\n+\n+  @Test\n+  public void shouldReturnUserNotFoundForDeactivateUser() throws Exception {\n+    // Step 2: Call the API and expect USER_NOT_FOUND error\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MzY4MA=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTIxODUyOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMToyOToyMlrOG-gdTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjozMzoyOVrOG-qLQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5NjY4NA==", "bodyText": "format the string with TestDataHelper.ADMIN_AUTH_ID_VALUE or userRegAdminEntity.getId()", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468196684", "createdAt": "2020-08-10T21:29:22Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\").value(MessageCode.DEACTIVATE_USER_SUCCESS.getMessage()))\n+        .andReturn();\n+\n+    // Step 3: verify updated values\n+    Optional<UserRegAdminEntity> optUser =\n+        userRegAdminRepository.findById(userRegAdminEntity.getId());\n+    UserRegAdminEntity user = optUser.get();\n+    // assertEquals(request.getEmail(), user.getEmail());\n+    assertEquals(UserStatus.DEACTIVATED.getValue(), user.getStatus());\n+\n+    // verify external API call\n+    verify(\n+        1,\n+        putRequestedFor(\n+            urlEqualTo(\n+                \"/oauth-scim-service/users/TuKUeFdyWz4E2A1-LqQcoYKBpMsfLnl-KjiuRFuxWcM3sQg\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM1NTkwNw==", "bodyText": "fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468355907", "createdAt": "2020-08-11T06:33:29Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test\n+  public void shouldDeactivateUserAccount() throws Exception {\n+    // Step 1: Setting up the request for deactivate account\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    // Step 2: Call the API and expect DEACTIVATE_USER_SUCCESS message\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            patch(ApiEndpoint.DEACTIVATE_ACCOUNT.getPath(), userRegAdminEntity.getId())\n+                .content(asJsonString(emailStatusRequest))\n+                .headers(headers)\n+                .contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\").value(MessageCode.DEACTIVATE_USER_SUCCESS.getMessage()))\n+        .andReturn();\n+\n+    // Step 3: verify updated values\n+    Optional<UserRegAdminEntity> optUser =\n+        userRegAdminRepository.findById(userRegAdminEntity.getId());\n+    UserRegAdminEntity user = optUser.get();\n+    // assertEquals(request.getEmail(), user.getEmail());\n+    assertEquals(UserStatus.DEACTIVATED.getValue(), user.getStatus());\n+\n+    // verify external API call\n+    verify(\n+        1,\n+        putRequestedFor(\n+            urlEqualTo(\n+                \"/oauth-scim-service/users/TuKUeFdyWz4E2A1-LqQcoYKBpMsfLnl-KjiuRFuxWcM3sQg\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5NjY4NA=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTQ1MTMxOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzowMTozOVrOG-inhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjo0NDozOVrOG-qctQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMjA2OQ==", "bodyText": "Don't you have to call setErrorHandler on restTemplate to make sure your custom RestResponseErrorHandler above will work to catch all the exceptions by restTemplate?\nRefer to the answer in: https://stackoverflow.com/questions/46367039/how-to-handle-httpclientexception-properly/46368179#46368179", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468232069", "createdAt": "2020-08-10T23:01:39Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -97,4 +102,51 @@ private UserResponse registerUserInAuthServer(SetUpAccountRequest setUpAccountRe\n     logger.exit(String.format(\"status=%d\", response.getStatusCodeValue()));\n     return response.getBody();\n   }\n+\n+  @Override\n+  public DeactivateAccountResponse deactivateAccount(String userId) {\n+    logger.entry(\"deactivateAccount()\");\n+\n+    Optional<UserRegAdminEntity> optUserRegAdmin = userRegAdminRepository.findById(userId);\n+    if (!optUserRegAdmin.isPresent()) {\n+      return new DeactivateAccountResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity userRegAdmin = optUserRegAdmin.get();\n+\n+    deactivateUserInAuthServer(userRegAdmin.getUrAdminAuthId());\n+\n+    userRegAdmin.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userRegAdminRepository.saveAndFlush(userRegAdmin);\n+\n+    logger.exit(MessageCode.DEACTIVATE_USER_SUCCESS);\n+    return new DeactivateAccountResponse(MessageCode.DEACTIVATE_USER_SUCCESS);\n+  }\n+\n+  private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId) {\n+    logger.entry(\"updateUserInfoInAuthServer()\");\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.add(\"Authorization\", \"Bearer \" + oauthService.getAccessToken());\n+\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    HttpEntity<UpdateEmailStatusRequest> request = new HttpEntity<>(emailStatusRequest, headers);\n+\n+    ResponseEntity<UpdateEmailStatusResponse> responseEntity =\n+        restTemplate.exchange(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2MDM3Mw==", "bodyText": "Added below line in CommonModuleConfiguration\nrestTemplate.setErrorHandler(new RestResponseErrorHandler());", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468360373", "createdAt": "2020-08-11T06:44:39Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -97,4 +102,51 @@ private UserResponse registerUserInAuthServer(SetUpAccountRequest setUpAccountRe\n     logger.exit(String.format(\"status=%d\", response.getStatusCodeValue()));\n     return response.getBody();\n   }\n+\n+  @Override\n+  public DeactivateAccountResponse deactivateAccount(String userId) {\n+    logger.entry(\"deactivateAccount()\");\n+\n+    Optional<UserRegAdminEntity> optUserRegAdmin = userRegAdminRepository.findById(userId);\n+    if (!optUserRegAdmin.isPresent()) {\n+      return new DeactivateAccountResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity userRegAdmin = optUserRegAdmin.get();\n+\n+    deactivateUserInAuthServer(userRegAdmin.getUrAdminAuthId());\n+\n+    userRegAdmin.setStatus(UserStatus.DEACTIVATED.getValue());\n+    userRegAdminRepository.saveAndFlush(userRegAdmin);\n+\n+    logger.exit(MessageCode.DEACTIVATE_USER_SUCCESS);\n+    return new DeactivateAccountResponse(MessageCode.DEACTIVATE_USER_SUCCESS);\n+  }\n+\n+  private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId) {\n+    logger.entry(\"updateUserInfoInAuthServer()\");\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.add(\"Authorization\", \"Bearer \" + oauthService.getAccessToken());\n+\n+    UpdateEmailStatusRequest emailStatusRequest = new UpdateEmailStatusRequest();\n+    emailStatusRequest.setStatus(UserAccountStatus.DEACTIVATED.getStatus());\n+\n+    HttpEntity<UpdateEmailStatusRequest> request = new HttpEntity<>(emailStatusRequest, headers);\n+\n+    ResponseEntity<UpdateEmailStatusResponse> responseEntity =\n+        restTemplate.exchange(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMjA2OQ=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTQ2MDk5OnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzowNjoyOFrOG-itWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzoxNDowNFrOG-rOrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMzU2MQ==", "bodyText": "Should add tests for when the /oauth-scim-service/users/ endpoint returns an error also, to verify that it is handled in RestResponseErrorHandler class", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468233561", "createdAt": "2020-08-10T23:06:28Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MzE2Nw==", "bodyText": "Added shouldReturnAuthServerApplicationErrorForDeactivateUser() test case", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468373167", "createdAt": "2020-08-11T07:14:04Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserProfileControllerTest.java", "diffHunk": "@@ -156,6 +161,57 @@ public void shouldReturnAuthServerBadRequestError() throws Exception {\n         .andExpect(status().isBadRequest());\n   }\n \n+  @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMzU2MQ=="}, "originalCommit": {"oid": "2e0987c8a7f29134c82f8d24568f8c788144cb4e"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyOTYzMjgzOnYy", "diffSide": "LEFT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMTo0MToxM1rOG_KN8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNTowNTo1NlrOG_R7iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg4MDg4MA==", "bodyText": "updateEmailResponse is not used, please remove this var", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468880880", "createdAt": "2020-08-11T21:41:13Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -147,6 +147,5 @@ private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId)\n     UpdateEmailStatusResponse updateEmailResponse = responseEntity.getBody();\n \n     logger.exit(String.format(\"status=%d\", updateEmailResponse.getHttpStatusCode()));\n-    return updateEmailResponse;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc8c277645ef590bf36c4255d2cc6da22a951f3f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzI0MA==", "bodyText": "fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r469007240", "createdAt": "2020-08-12T05:05:56Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -147,6 +147,5 @@ private UpdateEmailStatusResponse deactivateUserInAuthServer(String authUserId)\n     UpdateEmailStatusResponse updateEmailResponse = responseEntity.getBody();\n \n     logger.exit(String.format(\"status=%d\", updateEmailResponse.getHttpStatusCode()));\n-    return updateEmailResponse;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg4MDg4MA=="}, "originalCommit": {"oid": "bc8c277645ef590bf36c4255d2cc6da22a951f3f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyOTY5NDczOnYy", "diffSide": "RIGHT", "path": "common-modules/common-tests/src/main/resources/__files/oauth-scim-service/auth-server-deactivate-account-response-error.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMjowMzo0MlrOG_Ky9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNToxNDozMVrOG_SD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg5MDM1OA==", "bodyText": "What is the usage of these added json files?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r468890358", "createdAt": "2020-08-11T22:03:42Z", "author": {"login": "saminguyen"}, "path": "common-modules/common-tests/src/main/resources/__files/oauth-scim-service/auth-server-deactivate-account-response-error.json", "diffHunk": "@@ -0,0 +1,4 @@\n+{\n+   \"tempRegId\":null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc8c277645ef590bf36c4255d2cc6da22a951f3f"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwOTM4MQ==", "bodyText": "Json files are used to mock external API calls", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r469009381", "createdAt": "2020-08-12T05:14:31Z", "author": {"login": "Kantharajut-btc"}, "path": "common-modules/common-tests/src/main/resources/__files/oauth-scim-service/auth-server-deactivate-account-response-error.json", "diffHunk": "@@ -0,0 +1,4 @@\n+{\n+   \"tempRegId\":null,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg5MDM1OA=="}, "originalCommit": {"oid": "bc8c277645ef590bf36c4255d2cc6da22a951f3f"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjg3MDcyOnYy", "diffSide": "RIGHT", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjoxNjowM1rOG_osaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNTowNTozMlrOG_8I3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MDIwMw==", "bodyText": "I think you should still keep the UpdateEmailStatusResponse class in here. Removing the unused response var is enough", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r469380203", "createdAt": "2020-08-12T16:16:03Z", "author": {"login": "saminguyen"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -135,7 +136,7 @@ private void deactivateUserInAuthServer(String authUserId) {\n \n     HttpEntity<UpdateEmailStatusRequest> request = new HttpEntity<>(emailStatusRequest, headers);\n \n-    ResponseEntity<UpdateEmailStatusResponse> responseEntity =\n+    ResponseEntity<?> responseEntity =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1252cd6588605cb66a6fe38ecae5bb0366d00c20"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5ODc4MQ==", "bodyText": "fixed review comment", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/736#discussion_r469698781", "createdAt": "2020-08-13T05:05:32Z", "author": {"login": "Kantharajut-btc"}, "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/UserProfileServiceImpl.java", "diffHunk": "@@ -135,7 +136,7 @@ private void deactivateUserInAuthServer(String authUserId) {\n \n     HttpEntity<UpdateEmailStatusRequest> request = new HttpEntity<>(emailStatusRequest, headers);\n \n-    ResponseEntity<UpdateEmailStatusResponse> responseEntity =\n+    ResponseEntity<?> responseEntity =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MDIwMw=="}, "originalCommit": {"oid": "1252cd6588605cb66a6fe38ecae5bb0366d00c20"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2113, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}