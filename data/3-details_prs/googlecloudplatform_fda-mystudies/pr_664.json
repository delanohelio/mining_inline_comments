{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NDY2ODYz", "number": 664, "title": "OAuth Scim Service: POST /users/{userId}/logout implementation with integration tests", "bodyText": "POST /users/{userId}/logout implementation with integration tests\nAdded new redirect URLs\nAdded Jasypt (Apache 2.0 license) maven dependency and used it for encrypt/decrypt refresh token", "createdAt": "2020-07-21T12:36:09Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664", "merged": true, "mergeCommit": {"oid": "b109b56c8374f4bf72faf7420d2eab5805d766f5"}, "closed": true, "closedAt": "2020-08-14T16:03:25Z", "author": {"login": "dhanyak-btc"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3Fdt1AH2gAyNDU0NDY2ODYzOmM4MjE2NmNkZDZjZGM0NWI5MTRlOTk2Y2MyMjc2NDEwYmI2ZDE4NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-216kgFqTQ2NzY5NDIyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c82166cdd6cdc45b914e996cc2276410bb6d1848", "committedDate": "2020-07-21T12:33:54Z", "message": "POST /users/{userId}/logout implementation with integration tests\n\n1. POST /users/{userId}/logout implementation with integration tests\n2. Added new redirect URLs\n3. Added Jasypt (Apache 2.0 license)  maven dependency and used it for encrypt/decrypt refresh token"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjc2ODEz", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#pullrequestreview-452676813", "createdAt": "2020-07-21T17:27:19Z", "commit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzoyOTowMlrOG1CdFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzozNjozNFrOG1Cung==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NzkyNw==", "bodyText": "Can this be done in the service? It's not really the job of a Controller to do this kind of logic. Generally Controller classes should have very little logic in MVC, they serve mainly to provide a translation from API semantics to business layer semantics.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458267927", "createdAt": "2020-07-21T17:29:02Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/OAuthController.java", "diffHunk": "@@ -82,6 +89,17 @@\n \n     // get token from hydra\n     ResponseEntity<JsonNode> response = oauthService.getToken(paramMap, headers);\n+\n+    if ((REFRESH_TOKEN.equals(grantType) || AUTHORIZATION_CODE.equals(grantType))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2ODg0MA==", "bodyText": "ResponseEntity<UserResponse>?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458268840", "createdAt": "2020-07-21T17:30:24Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserController.java", "diffHunk": "@@ -116,4 +117,18 @@\n     logger.exit(String.format(STATUS_LOG, status));\n     return ResponseEntity.status(status).body(userResponse);\n   }\n+\n+  @PostMapping(value = \"/users/{userId}/logout\", produces = MediaType.APPLICATION_JSON_VALUE)\n+  public ResponseEntity<?> logout(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2OTEwMw==", "bodyText": "throw UserNotFound exception?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458269103", "createdAt": "2020-07-21T17:30:52Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -422,4 +435,59 @@ public void removeExpiredTempRegIds() {\n             .toEpochMilli();\n     repository.updateTempRegId(new Timestamp(timeInMillis));\n   }\n+\n+  @Override\n+  public UserResponse logout(String userId) throws JsonProcessingException {\n+    Optional<UserEntity> optUserEntity = repository.findByUserId(userId);\n+\n+    if (!optUserEntity.isPresent()) {\n+      return new UserResponse(ErrorCode.USER_NOT_FOUND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2OTI3MA==", "bodyText": "same here", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458269270", "createdAt": "2020-07-21T17:31:08Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/UserServiceImpl.java", "diffHunk": "@@ -422,4 +435,59 @@ public void removeExpiredTempRegIds() {\n             .toEpochMilli();\n     repository.updateTempRegId(new Timestamp(timeInMillis));\n   }\n+\n+  @Override\n+  public UserResponse logout(String userId) throws JsonProcessingException {\n+    Optional<UserEntity> optUserEntity = repository.findByUserId(userId);\n+\n+    if (!optUserEntity.isPresent()) {\n+      return new UserResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    return revokeAndReplaceRefreshToken(userId, null);\n+  }\n+\n+  @Override\n+  public UserResponse revokeAndReplaceRefreshToken(String userId, String refreshToken)\n+      throws JsonProcessingException {\n+    logger.entry(\"revokeAndReplaceRefreshToken(userId, refreshToken)\");\n+    Optional<UserEntity> optUserEntity = repository.findByUserId(userId);\n+    if (!optUserEntity.isPresent()) {\n+      return new UserResponse(ErrorCode.USER_NOT_FOUND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3MjQxNA==", "bodyText": "Each test should create the user", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458272414", "createdAt": "2020-07-21T17:36:34Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserControllerTest.java", "diffHunk": "@@ -539,6 +545,41 @@ public void shouldSaveTheAuditEventInDatabase()\n \n   @Test\n   @Order(13)\n+  public void shouldLogout() throws MalformedURLException, JsonProcessingException, Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82166cdd6cdc45b914e996cc2276410bb6d1848"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7226503114863f6036968f0cf817de26846696dc", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7226503114863f6036968f0cf817de26846696dc", "committedDate": "2020-07-22T09:34:43Z", "message": "Fixed PR 664 review comments\n\nFixed PR 664 review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581ffc68d24bafb9d6aa97775f9fb0b8de24b52d", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/581ffc68d24bafb9d6aa97775f9fb0b8de24b52d", "committedDate": "2020-07-22T10:42:39Z", "message": "Fixed 2 issues - NoSuchAlgorithmException in EncryptionUtils and Wiremock verify\n\nFixed below issues:\n\n1. java.security.NoSuchAlgorithmException: SHA3-512 MessageDigest not available\n2. OAuthControllerTest.shouldRevokeTheToken:315 Expected exactly 1 requests matching the following pattern but received 2:"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMzk2OTE2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#pullrequestreview-453396916", "createdAt": "2020-07-22T14:52:00Z", "commit": {"oid": "581ffc68d24bafb9d6aa97775f9fb0b8de24b52d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDo1MjowMFrOG1mLDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDo1MjowMFrOG1mLDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1MzEzNQ==", "bodyText": "Can you remove the test order annotations now?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r458853135", "createdAt": "2020-07-22T14:52:00Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserControllerTest.java", "diffHunk": "@@ -91,6 +93,11 @@\n \n   private static String saltAfterChangePassword;\n \n+  @BeforeEach\n+  public void init() {\n+    WireMock.resetAllRequests();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "581ffc68d24bafb9d6aa97775f9fb0b8de24b52d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc", "committedDate": "2020-07-28T09:08:46Z", "message": "Fixed PR 664 review comments, removed @Order for tests\n\nFixed PR 664 review comments, removed @Order for tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjI5NDI3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#pullrequestreview-456629427", "createdAt": "2020-07-28T13:28:13Z", "commit": {"oid": "1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzoyODoxM1rOG4MhxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozNDowM1rOG4Myyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3ODY5Mw==", "bodyText": "You can do this in the afterEach if you want", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r461578693", "createdAt": "2020-07-28T13:28:13Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/OAuthControllerTest.java", "diffHunk": "@@ -210,17 +205,69 @@ public void shouldReturnNewTokensForRefreshTokenGrant() throws Exception {\n             .andExpect(jsonPath(\"$.refresh_token\").isNotEmpty())\n             .andReturn();\n \n-    accessToken = JsonPath.read(result.getResponse().getContentAsString(), \"$.access_token\");\n+    String refreshToken =\n+        JsonPath.read(result.getResponse().getContentAsString(), \"$.refresh_token\");\n+\n+    // Step-3 check refresh token saved in database\n+    user = userRepository.findByUserId(user.getUserId()).get();\n+    ObjectNode userInfo = (ObjectNode) toJsonNode(user.getUserInfo());\n+    assertEquals(refreshToken, encryptor.decrypt(getTextValue(userInfo, REFRESH_TOKEN)));\n+\n+    // Step-4 delete the user\n+    userRepository.deleteByUserId(user.getUserId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4MTIxMQ==", "bodyText": "This could go in the BeforeEach if you want", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r461581211", "createdAt": "2020-07-28T13:31:30Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/OAuthControllerTest.java", "diffHunk": "@@ -163,40 +178,20 @@ public void shouldReturnAccessTokenForClientCredentialsGrant() throws Exception\n   }\n \n   @Test\n-  @Order(5)\n   public void shouldReturnRefreshTokenForAuthorizationCodeGrant() throws Exception {\n+    UserEntity user = newUserEntity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4MzA1MQ==", "bodyText": "You're already cleaning up all the users in the AfterEach, this isn't necessary", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#discussion_r461583051", "createdAt": "2020-07-28T13:34:03Z", "author": {"login": "nikklassen"}, "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/UserControllerTest.java", "diffHunk": "@@ -169,19 +189,21 @@ public void shouldCreateANewUser() throws Exception {\n     assertTrue(userInfo.get(PASSWORD_HISTORY).isArray());\n \n     verify(\n-        2,\n+        1,\n         postRequestedFor(urlEqualTo(\"/oauth-scim-service/oauth2/introspect\"))\n             .withRequestBody(new ContainsPattern(VALID_TOKEN)));\n+\n+    // Step 3: delete the user\n+    userRepository.deleteByUserId(userId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bfa2c0282dbc1c5ff5a5e5ee070c021976b0edc"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f94530c150bbea9cfe8cf6e883b4cdfa7fd4edd", "author": {"user": {"login": "aswinijena100", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2f94530c150bbea9cfe8cf6e883b4cdfa7fd4edd", "committedDate": "2020-07-29T06:09:28Z", "message": "common-module implementaion with latest common service code changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a49d98016a36a356f8c311aea68d348898ed2a7", "author": {"user": {"login": "aswinijena100", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6a49d98016a36a356f8c311aea68d348898ed2a7", "committedDate": "2020-07-30T05:09:01Z", "message": "formated pom.xml file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37575a9ac5ba11f11692038e8b30bcffe8698062", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/37575a9ac5ba11f11692038e8b30bcffe8698062", "committedDate": "2020-07-30T14:22:38Z", "message": "Fixed PR 664 review comments\n\nFixed PR 664 review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "310eb9e727b247be2c5503b1342e3fcfb00acaa0", "author": {"user": {"login": "aswinijena100", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/310eb9e727b247be2c5503b1342e3fcfb00acaa0", "committedDate": "2020-08-11T04:19:32Z", "message": "Merge pull request #701 from GoogleCloudPlatform/user-reg-server-module\n\ncommon-module impl for user reg server with latest common service code changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "708b94d39644703f5160e5dcd66838b683c97d1c", "author": {"user": {"login": "aswinijena100", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/708b94d39644703f5160e5dcd66838b683c97d1c", "committedDate": "2020-08-11T04:41:24Z", "message": "Revert \"Merge pull request #701 from GoogleCloudPlatform/user-reg-server-module\"\n\nThis reverts commit 310eb9e727b247be2c5503b1342e3fcfb00acaa0, reversing\nchanges made to 37575a9ac5ba11f11692038e8b30bcffe8698062."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54332ea009733367c5a3c73b9bbb5e4b8a561c5a", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/54332ea009733367c5a3c73b9bbb5e4b8a561c5a", "committedDate": "2020-08-14T15:22:26Z", "message": "Merge branch 'develop' into oauth_scim_logout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80d8dfc658886510ec1bb730a83a512176edce92", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/80d8dfc658886510ec1bb730a83a512176edce92", "committedDate": "2020-08-14T15:22:59Z", "message": "Resolved code conflicts and fixed compilation issues\n\nResolved code conflicts and fixed compilation issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cfb802086545810c80c036a4c28a9a95b206350", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6cfb802086545810c80c036a4c28a9a95b206350", "committedDate": "2020-08-14T15:49:31Z", "message": "Fixed test failures\n\nFixed test failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aea788f46df35a95a4b8cfae322e5a429cc9ed8a", "author": {"user": {"login": "dhanyak-btc", "name": "Dhanya Kumar KV"}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aea788f46df35a95a4b8cfae322e5a429cc9ed8a", "committedDate": "2020-08-14T15:51:38Z", "message": "Merge branch 'develop' into oauth_scim_logout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Njk0MjIx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/664#pullrequestreview-467694221", "createdAt": "2020-08-14T16:03:09Z", "commit": {"oid": "aea788f46df35a95a4b8cfae322e5a429cc9ed8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 894, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}