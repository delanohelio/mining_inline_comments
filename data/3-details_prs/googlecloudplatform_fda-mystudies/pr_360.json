{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0OTk2NzEz", "number": 360, "title": "Create user_institution table. Keyed by user_details_id rather than u\u2026", "bodyText": "\u2026ser_id (user_id is not a primary key in this table).", "createdAt": "2020-05-08T01:22:47Z", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360", "merged": true, "mergeCommit": {"oid": "b6bf831e9c4fbf345a9c2f5bab9e33d7ffaecd3f"}, "closed": true, "closedAt": "2020-05-09T15:56:58Z", "author": {"login": "wamills"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfJAqMAFqTQwNzk2Nzc2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfoaDwAH2gAyNDE0OTk2NzEzOjU3ZmU5ZjI3MDk1NmRkYzBmZDc2MmY0NmNkNDFlOGE5ZTZlYTEzMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTY3NzY5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#pullrequestreview-407967769", "createdAt": "2020-05-08T03:07:36Z", "commit": {"oid": "8fb8fb9e9c4e994ede91c768668197051fd1fe52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTk1MTAx", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#pullrequestreview-407995101", "createdAt": "2020-05-08T04:56:07Z", "commit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNDo1NjowN1rOGSZByw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNTowNjowMlrOGSZL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzYxMQ==", "bodyText": "nit: I assume we want to explicitly import each lib instead of import *?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#discussion_r421937611", "createdAt": "2020-05-08T04:56:07Z", "author": {"login": "kuoyuchi"}, "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CloudStorageService.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.UUID;\n+import javax.annotation.PostConstruct;\n+\n+import com.google.api.gax.paging.Page;\n+import com.google.cloud.storage.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MDE5OA==", "bodyText": "I think we want to add a prefix(institutionId+\"/\") as argument of list (which, on cloud console UI, would look like each institution having a directory in the singleton InstitutionBucket).", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#discussion_r421940198", "createdAt": "2020-05-08T05:06:02Z", "author": {"login": "kuoyuchi"}, "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CloudStorageService.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.UUID;\n+import javax.annotation.PostConstruct;\n+\n+import com.google.api.gax.paging.Page;\n+import com.google.cloud.storage.*;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import com.google.cloud.WriteChannel;\n+import com.google.cloud.healthcare.fdamystudies.config.ApplicationPropertyConfiguration;\n+\n+@Service\n+public class CloudStorageService {\n+\n+    private Storage storageService;\n+\n+    @Autowired\n+    private ApplicationPropertyConfiguration appConfig;\n+\n+    @PostConstruct\n+    private void init() {\n+        storageService = StorageOptions.getDefaultInstance().getService();\n+    }\n+\n+    public List<ByteArrayOutputStream> getAllInstitutionResources(String institutionId) {\n+        Bucket bucket = storageService.get(appConfig.getInstitutionBucketName());\n+        Page<Blob> blobs = bucket.list();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDkzMDY4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#pullrequestreview-408093068", "createdAt": "2020-05-08T08:42:50Z", "commit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0Mjo1MVrOGSePMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0NToyMlrOGSeTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMjk2MQ==", "bodyText": "user_details_id is the primary key for the user_details table, right? I don't think you need to set referencedColumnName explicitly, I think it will pick that automatically.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#discussion_r422022961", "createdAt": "2020-05-08T08:42:51Z", "author": {"login": "karepker"}, "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/model/UserInstitution.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.healthcare.fdamystudies.model;\n+\n+import lombok.*;\n+import org.hibernate.annotations.OnDelete;\n+import org.hibernate.annotations.OnDeleteAction;\n+\n+import javax.persistence.*;\n+import javax.validation.constraints.NotNull;\n+\n+@Setter\n+@Getter\n+@Entity\n+@AllArgsConstructor\n+@Builder\n+@NoArgsConstructor\n+@Table(name = \"user_institution\")\n+public class UserInstitution {\n+    @Id\n+    @Column(name = \"user_institution_id\")\n+    @GeneratedValue(strategy = GenerationType.AUTO)\n+    private Long userInstitutionId;\n+\n+    @OneToOne(fetch = FetchType.EAGER)\n+    @JoinColumn(name = \"user_id\", referencedColumnName = \"user_details_id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyNDA4OQ==", "bodyText": "nit: You can remove ().", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#discussion_r422024089", "createdAt": "2020-05-08T08:45:22Z", "author": {"login": "karepker"}, "path": "user-registration-server-ws/user-mgmt/src/test/java/com/google/cloud/healthcare/fdamystudies/util/GetUserInstitutionResourcesTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package com.google.cloud.healthcare.fdamystudies.util;\n+\n+import com.google.cloud.healthcare.fdamystudies.TestApplicationContextInitializer;\n+import com.google.cloud.healthcare.fdamystudies.beans.UserInstitutionResources;\n+import com.google.cloud.healthcare.fdamystudies.model.UserInstitution;\n+import com.google.cloud.healthcare.fdamystudies.repository.UserInstitutionRepository;\n+import com.google.cloud.healthcare.fdamystudies.service.CloudStorageService;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.test.context.ActiveProfiles;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.DataOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Optional;\n+\n+import static junit.framework.TestCase.assertTrue;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.Assert.assertFalse;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.internal.verification.VerificationModeFactory.times;\n+\n+@RunWith(SpringRunner.class)\n+@SpringBootTest()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d81a901135a686f10ae7d974a822c32deac48a42"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NDE4NjQy", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#pullrequestreview-408418642", "createdAt": "2020-05-08T18:01:51Z", "commit": {"oid": "1bbdf603c516fbe20442d3b4b90251c1e76c31ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODowMTo1MVrOGSuYAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODowMTo1MVrOGSuYAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4NzM2MA==", "bodyText": "Also we might want to change the return type here because the name of the blob (removing institutionId prefix) would be the resource title displayed, so we might want to change the return type to something like a pair<string,string>.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/360#discussion_r422287360", "createdAt": "2020-05-08T18:01:51Z", "author": {"login": "kuoyuchi"}, "path": "user-registration-server-ws/user-mgmt/src/main/java/com/google/cloud/healthcare/fdamystudies/service/CloudStorageService.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.PostConstruct;\n+\n+import com.google.api.gax.paging.Page;\n+import com.google.cloud.storage.Blob;\n+import com.google.cloud.storage.Bucket;\n+import com.google.cloud.storage.Storage;\n+import com.google.cloud.storage.StorageException;\n+import com.google.cloud.storage.StorageOptions;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import com.google.cloud.healthcare.fdamystudies.config.ApplicationPropertyConfiguration;\n+\n+@Service\n+public class CloudStorageService {\n+    private static Logger logger = LoggerFactory.getLogger(CloudStorageService.class);\n+\n+    private Storage storageService;\n+\n+    @Autowired\n+    private ApplicationPropertyConfiguration appConfig;\n+\n+    @PostConstruct\n+    private void init() {\n+        storageService = StorageOptions.getDefaultInstance().getService();\n+    }\n+\n+    public List<ByteArrayOutputStream> getAllInstitutionResources(String institutionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bbdf603c516fbe20442d3b4b90251c1e76c31ec"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a965b5c75eb94750d6616328814b91005b452d2", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6a965b5c75eb94750d6616328814b91005b452d2", "committedDate": "2020-05-08T20:01:56Z", "message": "Create user_institution table. Keyed by user_details_id rather than user_id (user_id is not a primary key in this table)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9505318d7a800ce236d0c2248fc06c2cf666af51", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9505318d7a800ce236d0c2248fc06c2cf666af51", "committedDate": "2020-05-08T20:02:02Z", "message": "When UserDetailsBO is deleted UserInstitution is deleted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d148cff478109fd68f6c40ff18f1f5c11067c5", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/25d148cff478109fd68f6c40ff18f1f5c11067c5", "committedDate": "2020-05-08T20:02:02Z", "message": "Add component to read from the user_institution table and look up an institutions data from GCS."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7798ad4654834fee7f0a92cac82da70c8882d02e", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7798ad4654834fee7f0a92cac82da70c8882d02e", "committedDate": "2020-05-08T20:02:02Z", "message": "Add more detailed test to show we can lookup UserInstitution by UserId."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f794697574736b33b81602d8fe0cdd4af6ca6e23", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f794697574736b33b81602d8fe0cdd4af6ca6e23", "committedDate": "2020-05-08T20:02:02Z", "message": "Use institution_id in Cloud bucket lookup. Also some other cleanups, no wildcard imports, spring boot cleanups."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4c459ee7589144630a38245c0b5429e88af1e5", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cb4c459ee7589144630a38245c0b5429e88af1e5", "committedDate": "2020-05-08T20:02:02Z", "message": "Use institutionId as a prefix for lookup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c56895aa438dbde210be9ce78798a1ed3167405", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c56895aa438dbde210be9ce78798a1ed3167405", "committedDate": "2020-05-08T20:02:02Z", "message": "Add user_institution make table command to sql startup script."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15be63245813f7f750d49ef32e91ff768c5b7c62", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/15be63245813f7f750d49ef32e91ff768c5b7c62", "committedDate": "2020-05-08T20:02:02Z", "message": "Make it obvious that the foreign key is the user_details_id column in user_details column."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73fffdd9a9b725c21c1dff76bd163b37e12a04a5", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/73fffdd9a9b725c21c1dff76bd163b37e12a04a5", "committedDate": "2020-05-08T20:32:47Z", "message": "Return content title from CloudStorageService and use the UserResourceBean as the return value of GetUserInstitutionResources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fed60c1bbe7cbbe47ed68bb10efe365072de42b9", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fed60c1bbe7cbbe47ed68bb10efe365072de42b9", "committedDate": "2020-05-08T21:13:38Z", "message": "Fix merge conflicts."}, "afterCommit": {"oid": "73fffdd9a9b725c21c1dff76bd163b37e12a04a5", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/73fffdd9a9b725c21c1dff76bd163b37e12a04a5", "committedDate": "2020-05-08T20:32:47Z", "message": "Return content title from CloudStorageService and use the UserResourceBean as the return value of GetUserInstitutionResources."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37cbd86a4178f69c3336fab70f69dc9fff58f155", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/37cbd86a4178f69c3336fab70f69dc9fff58f155", "committedDate": "2020-05-08T22:29:35Z", "message": "Remove institutionId directory prefix from title and skip placeholder GCS files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57fe9f270956ddc0fd762f46cd41e8a9e6ea1304", "author": {"user": {"login": "wamills", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/57fe9f270956ddc0fd762f46cd41e8a9e6ea1304", "committedDate": "2020-05-09T15:42:24Z", "message": "Use AUTO_INCREMENT for key of user_institution table."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1011, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}