{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjY5Mjc2", "number": 1399, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxMTozMlrOEttVxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzo1NlrOEuInnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzY0MjI4OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxMTozMlrOHhqCNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDozNjo0MFrOHhsumQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1Mzc1MA==", "bodyText": "missing participant-manager-datastore", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505053750", "createdAt": "2020-10-14T23:11:32Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5Nzg4MQ==", "bodyText": "The secret is actually called auto-participant-manager-db-password and auto-participant-manager-db-user, should we change those to be auto-participant-manager-datastore-db-user/password?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505097881", "createdAt": "2020-10-15T00:36:40Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1Mzc1MA=="}, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzY1NTU2OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxNDo0OFrOHhqLPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxNDo0OFrOHhqLPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NjA2MQ==", "bodyText": "participant-manager does need db access credentials, but participant-manager-datastore needs access", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505056061", "createdAt": "2020-10-14T23:14:48Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzY3NDAwOnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoxOToyOFrOHhqX0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo1MDo0OFrOHiOmIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTI4MQ==", "bodyText": "I think this is no longer needed. Now each app (except hydra) has a client id and secret, that will be later registered in hydra.\nAUTH SERVER, PARTICIPANT MANAGER AND MOBILE APPS (end user facing) should share the same CLIENT_ID and SECRET_KEY.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505059281", "createdAt": "2020-10-14T23:19:28Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"\n+  }\n+  # App codes for auth server authentication.\n+  auth_server_app_codes = [\n+    \"ma\",       # Mobile App\n+    \"urs\",      # User Registration Server\n+    \"rs\",       # Response Server\n+    \"builder\",  # Study Builder\n+  ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1Mjc3MA==", "bodyText": "One suggestion is to group them into client-side-secrets", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505652770", "createdAt": "2020-10-15T15:50:48Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"\n+  }\n+  # App codes for auth server authentication.\n+  auth_server_app_codes = [\n+    \"ma\",       # Mobile App\n+    \"urs\",      # User Registration Server\n+    \"rs\",       # Response Server\n+    \"builder\",  # Study Builder\n+  ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTI4MQ=="}, "originalCommit": {"oid": "b8d644712cb60e8057a478961ca3462427897960"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc0MjQyOnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzoyOTowNVrOHiSfnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzoyMVrOHiWJYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjYzOQ==", "bodyText": "what is the purpose of this password? and where is its corresponding user?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505716639", "createdAt": "2020-10-15T17:29:05Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -162,12 +162,8 @@ template \"project_secrets\" {\n           secret_id = \"manual-ios-certificate-password\"\n         },\n         {\n-          secret_id   = \"auto-auth-server-db-password\"\n-          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n-        },\n-        {\n-          secret_id   = \"auto-auth-server-db-user\"\n-          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n+          secret_id   = \"auto-mystudies-sql-default-user-password\"\n+          secret_data = \"$${random_password.passwords[\\\"mystudies_sql_default_user_password\\\"].result}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjQ4MQ==", "bodyText": "addressed offline", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776481", "createdAt": "2020-10-15T19:07:21Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -162,12 +162,8 @@ template \"project_secrets\" {\n           secret_id = \"manual-ios-certificate-password\"\n         },\n         {\n-          secret_id   = \"auto-auth-server-db-password\"\n-          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n-        },\n-        {\n-          secret_id   = \"auto-auth-server-db-user\"\n-          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n+          secret_id   = \"auto-mystudies-sql-default-user-password\"\n+          secret_data = \"$${random_password.passwords[\\\"mystudies_sql_default_user_password\\\"].result}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjYzOQ=="}, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc3NjI0OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzozODoxOFrOHiS1tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzoxMVrOHiWI-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjI5NA==", "bodyText": "maybe these should be renamed to include db in the name?\ne.g. dbusername and dbpassword", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505722294", "createdAt": "2020-10-15T17:38:18Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 332}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjM3Ng==", "bodyText": "done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776376", "createdAt": "2020-10-15T19:07:11Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjI5NA=="}, "originalCommit": {"oid": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5"}, "originalPosition": 332}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc4NDYzOnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0MDozNFrOHiS7Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzowNlrOHiWIug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMzY2Mg==", "bodyText": "smtp_hostname, from_email_domain and smtp_use_ip_whitelist\nthe values should come from 'manual-' secrets.", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505723662", "createdAt": "2020-10-15T17:40:34Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"\n+  }\n+}\n+\n+# Email credentials.\n+resource \"kubernetes_secret\" \"email_credentials\" {\n+  metadata {\n+    name = \"email-credentials\"\n+  }\n+\n+  data = {\n+    email_address         = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-address\"].secret_data\n+    email_password        = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-password\"].secret_data\n+    contact_email_address = \"?\"\n+    from_email_address    = \"?\"\n+    smtp_host             = \"?\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 365}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjMxNA==", "bodyText": "Added a TODO to add those secrets and fill in references", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776314", "createdAt": "2020-10-15T19:07:06Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"\n+  }\n+}\n+\n+# Email credentials.\n+resource \"kubernetes_secret\" \"email_credentials\" {\n+  metadata {\n+    name = \"email-credentials\"\n+  }\n+\n+  data = {\n+    email_address         = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-address\"].secret_data\n+    email_password        = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-password\"].secret_data\n+    contact_email_address = \"?\"\n+    from_email_address    = \"?\"\n+    smtp_host             = \"?\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMzY2Mg=="}, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 365}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc5NDA0OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0MzowN1rOHiTA-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNjo0N1rOHiWIGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTE3OQ==", "bodyText": "auth server client-id and secret-key are shared with participant-manager and mobile apps", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505725179", "createdAt": "2020-10-15T17:43:07Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -182,96 +178,132 @@ template \"project_secrets\" {\n           secret_data = \"$${random_password.system_secrets[\\\"hydra_system_secret\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_ma_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_ma_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_rs_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-client-id\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_client_id\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_rs_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-secret-key\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_secret_key\\\"].result}\"\n         },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjE1Mw==", "bodyText": "done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776153", "createdAt": "2020-10-15T19:06:47Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -182,96 +178,132 @@ template \"project_secrets\" {\n           secret_data = \"$${random_password.system_secrets[\\\"hydra_system_secret\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_ma_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_ma_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_rs_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-client-id\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_client_id\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_rs_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-secret-key\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_secret_key\\\"].result}\"\n         },", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTE3OQ=="}, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODA1NDE5OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODo1MTowNFrOHiVm8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNjozMFrOHiWHoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NzY2NQ==", "bodyText": "can you please include system_secret for hydra in here as well?", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505767665", "createdAt": "2020-10-15T18:51:04Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 350}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjAzMg==", "bodyText": "done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776032", "createdAt": "2020-10-15T19:06:30Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NzY2NQ=="}, "originalCommit": {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754"}, "originalPosition": 350}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODExMTY1OnYy", "diffSide": "RIGHT", "path": "deployment.hcl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTowNzo1NlrOHiWKmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOToxMjo0MFrOHiWUdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3Njc5Mw==", "bodyText": "dbusername and dbpassword", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776793", "createdAt": "2020-10-15T19:07:56Z", "author": {"login": "zohrehj"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,161 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    dbusername  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    dbpassword  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname      = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Client-side credentials.\n+resource \"kubernetes_secret\" \"client_side_credentials\" {\n+\n+  metadata {\n+    name = \"client-side-credentials\"\n+  }\n+\n+  data = {\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-secret-key\"].secret_data\n+  }\n+}\n+\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9"}, "originalPosition": 363}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3OTMxNg==", "bodyText": "done", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505779316", "createdAt": "2020-10-15T19:12:40Z", "author": {"login": "xingao267"}, "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,161 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    dbusername  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    dbpassword  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname      = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Client-side credentials.\n+resource \"kubernetes_secret\" \"client_side_credentials\" {\n+\n+  metadata {\n+    name = \"client-side-credentials\"\n+  }\n+\n+  data = {\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-secret-key\"].secret_data\n+  }\n+}\n+\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3Njc5Mw=="}, "originalCommit": {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9"}, "originalPosition": 363}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1771, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}