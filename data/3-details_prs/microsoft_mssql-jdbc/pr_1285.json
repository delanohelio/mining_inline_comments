{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTU1NjIx", "number": 1285, "title": "Provide an option to configure trusted Azure Key Vault endpoints", "bodyText": "The driver will read from mssql-jdbc.properties file from the current working directory.\nSet AKVTrustedEndpoints property to a semicolon-delimeted list. If the value begins with a semicolon, it extends the default list; otherwise, it replaces it.", "createdAt": "2020-03-18T01:01:13Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285", "merged": true, "mergeCommit": {"oid": "f73943110c64a522b17b642433dacd533516292c"}, "closed": true, "closedAt": "2020-03-19T04:10:24Z", "author": {"login": "ulvii"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOsjDeAH2gAyMzkwMTU1NjIxOjg5ZjllZmQ1NDMyN2M5ZTA1NzA2ODEwYWY0ODY5OWEyZjY4OWExYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPAKPgAFqTM3NzMxNDMwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89f9efd54327c9e05706810af48699a2f689a1c0", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/89f9efd54327c9e05706810af48699a2f689a1c0", "committedDate": "2020-03-18T00:55:08Z", "message": "Provide an option to configure trusted AKV endpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEyNjc0", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-376512674", "createdAt": "2020-03-18T01:45:53Z", "commit": {"oid": "89f9efd54327c9e05706810af48699a2f689a1c0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0NTo1M1rOF3zsSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0NTo1M1rOF3zsSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MjkyMw==", "bodyText": "remove this", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#discussion_r394062923", "createdAt": "2020-03-18T01:45:53Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -628,4 +633,58 @@ public boolean verifyColumnMasterKeyMetadata(String masterKeyPath, boolean allow\n             throw new SQLServerException(SQLServerException.getErrString(\"R_NoSHA256Algorithm\"), e);\n         }\n     }\n+\n+    private static List<String> getTrustedEndpoints() {\n+        Properties mssqlJdbcProperties = getMssqlJdbcProperties();\n+        List<String> trustedEndpoints = new ArrayList<String>();\n+        boolean append = true;\n+        if (null != mssqlJdbcProperties) {\n+            String endpoints = mssqlJdbcProperties.getProperty(AKV_TRUSTED_ENDPOINTS_KEYWORD);\n+            if (null != endpoints && !endpoints.isBlank()) {\n+                endpoints = endpoints.trim();\n+                // Append if the list starts with a semicolon.\n+                if (';' != endpoints.charAt(0)) {\n+                    append = false;\n+                } else {\n+                    endpoints = endpoints.substring(1);\n+                }\n+                String[] entries = endpoints.split(\";\");\n+                for (String entry : entries) {\n+                    if (null != entry && !entry.isBlank()) {\n+                        trustedEndpoints.add(entry.trim());\n+                    }\n+                }\n+            }\n+        }\n+        /*\n+         * List of Azure trusted endpoints\n+         * https://docs.microsoft.com/en-us/azure/key-vault/key-vault-secure-your-key-vault\n+         */\n+        if (append) {\n+            trustedEndpoints.add(\"vault.azure.net\");\n+            trustedEndpoints.add(\"vault.azure.cn\");\n+            trustedEndpoints.add(\"vault.usgovcloudapi.net\");\n+            trustedEndpoints.add(\"vault.microsoftazure.de\");\n+        }\n+        System.out.println(trustedEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89f9efd54327c9e05706810af48699a2f689a1c0"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563ee0168f8fe011adec4fef0878ca9220fe06d3", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/563ee0168f8fe011adec4fef0878ca9220fe06d3", "committedDate": "2020-03-18T02:17:53Z", "message": "Fix | Remove debug line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTk2Nzk5", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-376996799", "createdAt": "2020-03-18T15:49:20Z", "commit": {"oid": "563ee0168f8fe011adec4fef0878ca9220fe06d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNTo0OToyMVrOF4LWjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNTo0OToyMVrOF4LWjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ1MDU3NQ==", "bodyText": "What path are we loading the file from here? Is this a potential attack vector?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#discussion_r394450575", "createdAt": "2020-03-18T15:49:21Z", "author": {"login": "David-Engel"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -628,4 +633,57 @@ public boolean verifyColumnMasterKeyMetadata(String masterKeyPath, boolean allow\n             throw new SQLServerException(SQLServerException.getErrString(\"R_NoSHA256Algorithm\"), e);\n         }\n     }\n+\n+    private static List<String> getTrustedEndpoints() {\n+        Properties mssqlJdbcProperties = getMssqlJdbcProperties();\n+        List<String> trustedEndpoints = new ArrayList<String>();\n+        boolean append = true;\n+        if (null != mssqlJdbcProperties) {\n+            String endpoints = mssqlJdbcProperties.getProperty(AKV_TRUSTED_ENDPOINTS_KEYWORD);\n+            if (null != endpoints && !endpoints.isBlank()) {\n+                endpoints = endpoints.trim();\n+                // Append if the list starts with a semicolon.\n+                if (';' != endpoints.charAt(0)) {\n+                    append = false;\n+                } else {\n+                    endpoints = endpoints.substring(1);\n+                }\n+                String[] entries = endpoints.split(\";\");\n+                for (String entry : entries) {\n+                    if (null != entry && !entry.isBlank()) {\n+                        trustedEndpoints.add(entry.trim());\n+                    }\n+                }\n+            }\n+        }\n+        /*\n+         * List of Azure trusted endpoints\n+         * https://docs.microsoft.com/en-us/azure/key-vault/key-vault-secure-your-key-vault\n+         */\n+        if (append) {\n+            trustedEndpoints.add(\"vault.azure.net\");\n+            trustedEndpoints.add(\"vault.azure.cn\");\n+            trustedEndpoints.add(\"vault.usgovcloudapi.net\");\n+            trustedEndpoints.add(\"vault.microsoftazure.de\");\n+        }\n+        return trustedEndpoints;\n+    }\n+\n+    /**\n+     * Attempt to read MSSQL_JDBC_PROPERTIES.\n+     *\n+     * @return corresponding Properties object or null if failed to read the file.\n+     */\n+    private static Properties getMssqlJdbcProperties() {\n+        Properties props = null;\n+        try (FileInputStream in = new FileInputStream(MSSQL_JDBC_PROPERTIES)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563ee0168f8fe011adec4fef0878ca9220fe06d3"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372ea3f962584fb6d9a0f2f4ed50968b75142747", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/372ea3f962584fb6d9a0f2f4ed50968b75142747", "committedDate": "2020-03-18T23:22:09Z", "message": "Testing scenario when appending endpoint from properties file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzA3NTEw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-377307510", "createdAt": "2020-03-18T23:27:02Z", "commit": {"oid": "372ea3f962584fb6d9a0f2f4ed50968b75142747"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzA3ODg3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-377307887", "createdAt": "2020-03-18T23:28:00Z", "commit": {"oid": "372ea3f962584fb6d9a0f2f4ed50968b75142747"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMzoyODowMFrOF4aWxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMzoyODowMFrOF4aWxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY5NjM5MQ==", "bodyText": "Why did we define MSSQL_JDBC_PROPERTIES and AKV_TRUSTED_ENDPOINTS_KEYWORD as constants and not use them?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#discussion_r394696391", "createdAt": "2020-03-18T23:28:00Z", "author": {"login": "peterbae"}, "path": "src/test/java/com/microsoft/sqlserver/testframework/AbstractTest.java", "diffHunk": "@@ -145,8 +148,22 @@ public static void setup() throws Exception {\n         }\n \n         if (null == akvProvider) {\n-            akvProvider = new SQLServerColumnEncryptionAzureKeyVaultProvider(applicationClientID, applicationKey);\n-            map.put(Constants.AZURE_KEY_VAULT_NAME, akvProvider);\n+            File file = null;\n+            try {\n+                file = new File(\"mssql-jdbc.properties\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "372ea3f962584fb6d9a0f2f4ed50968b75142747"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9808a13c0429bd34efb9a1f88ac50c0802768701", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/9808a13c0429bd34efb9a1f88ac50c0802768701", "committedDate": "2020-03-18T23:30:56Z", "message": "User constants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzA5NDUx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-377309451", "createdAt": "2020-03-18T23:31:57Z", "commit": {"oid": "9808a13c0429bd34efb9a1f88ac50c0802768701"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzE0MzA3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1285#pullrequestreview-377314307", "createdAt": "2020-03-18T23:46:08Z", "commit": {"oid": "9808a13c0429bd34efb9a1f88ac50c0802768701"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2692, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}