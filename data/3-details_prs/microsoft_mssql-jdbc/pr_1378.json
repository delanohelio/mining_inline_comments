{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNjUyNTc1", "number": 1378, "title": "Fix | Fix batch insert failing when AE is turned on", "bodyText": "Fixes issue #1301. Testing shows it also fixes #1360, but will need to confirm from user.\nContinues from PR #1334. Testing has been carried over, but the fix is different.\nThe problem was coming from executing sp_describe_parameter_encryption. This statement is executed when AE is turned on to retrieve the encryption parameter. Code was currently written in such a way that sp_describe_paramter_encryption was being executed twice (or multiple times) if AE was enabled, which caused the driver to think that the current request was completed, which caused the driver to error out during the actual execution of the batch statement (and a plethora of other problems). Adding logic to only run param fetch once and save the encryption metadata for the subsequent batches as well solves this problem.\nBefore: (PrecisionScaleTest::testMultiBatch)\n\nAfter:\n\nTesting was done against with both AE and AEv2 enabled.", "createdAt": "2020-07-02T17:26:37Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1378", "merged": true, "mergeCommit": {"oid": "6f5ecb767d170a8256bc78e70fec830d7bb1ce59"}, "closed": true, "closedAt": "2020-07-03T23:38:54Z", "author": {"login": "peterbae"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwY63eAH2gAyNDQzNjUyNTc1OmM3MmNmNWI2NWMxMWQxZGRhZGNiNzc2YzY4MDk0YzlkNGRiZjc1Y2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxbCT-AFqTQ0MjU2ODU4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c72cf5b65c11d1ddadcb776c68094c9d4dbf75cf", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/c72cf5b65c11d1ddadcb776c68094c9d4dbf75cf", "committedDate": "2020-06-30T17:16:28Z", "message": "1301 fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee83f5f1816cf61c89eb63d3496fdf9b4d50a28", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/aee83f5f1816cf61c89eb63d3496fdf9b4d50a28", "committedDate": "2020-06-30T20:22:24Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1582c5d70df71f317ddafaf03715f1073ef3083", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/c1582c5d70df71f317ddafaf03715f1073ef3083", "committedDate": "2020-06-30T20:40:05Z", "message": "semeicolon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTAwNDM1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1378#pullrequestreview-442500435", "createdAt": "2020-07-03T16:26:03Z", "commit": {"oid": "c1582c5d70df71f317ddafaf03715f1073ef3083"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNjoyNjowM1rOGs0mwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNjoyNjowM1rOGs0mwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY1MjQxNw==", "bodyText": "Multi-line, also can we remove the 'on Connection' part.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1378#discussion_r449652417", "createdAt": "2020-07-03T16:26:03Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerPreparedStatement.java", "diffHunk": "@@ -2720,14 +2721,14 @@ final void doExecutePreparedStatementBatch(PrepStmtBatchExecCmd batchCommand) th\n             boolean hasExistingTypeDefinitions = preparedTypeDefinitions != null;\n             boolean hasNewTypeDefinitions = buildPreparedStrings(batchParam, false);\n \n-            if ((0 == numBatchesExecuted) && !isInternalEncryptionQuery && connection.isAEv2()) {\n+            if ((0 == numBatchesExecuted) && !isInternalEncryptionQuery && connection.isAEv2()\n+                    && !encryptionMetadataIsRetrieved) {\n                 this.enclaveCEKs = connection.initEnclaveParameters(preparedSQL, preparedTypeDefinitions, batchParam,\n                         parameterNames);\n                 encryptionMetadataIsRetrieved = true;\n \n                 // fix an issue when inserting unicode into non-encrypted nchar column using setString() and AE is\n-                // on on\n-                // Connection\n+                // on on Connection", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1582c5d70df71f317ddafaf03715f1073ef3083"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778a50e05256b204f5bbb51f661ea765dbfd6607", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/778a50e05256b204f5bbb51f661ea765dbfd6607", "committedDate": "2020-07-03T20:48:51Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTY3NzE3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1378#pullrequestreview-442567717", "createdAt": "2020-07-03T22:10:02Z", "commit": {"oid": "778a50e05256b204f5bbb51f661ea765dbfd6607"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTY4NTgy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1378#pullrequestreview-442568582", "createdAt": "2020-07-03T22:18:20Z", "commit": {"oid": "778a50e05256b204f5bbb51f661ea765dbfd6607"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2589, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}