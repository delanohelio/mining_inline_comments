{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMzkxNzYx", "number": 1357, "title": "Feature | Introduced support for Azure SQL DNS Caching", "bodyText": "", "createdAt": "2020-06-11T23:53:17Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357", "merged": true, "mergeCommit": {"oid": "99138fa1fe4b5277d8f758a53f10d197ec41b54b"}, "closed": true, "closedAt": "2020-06-24T21:26:23Z", "author": {"login": "ulvii"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaR-LigH2gAyNDMzMzkxNzYxOjZkNGYwZmM2NjIxMzQ1ZjFmYmZlM2U2YjA4NThlZGI4OGVhNDZmMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuewQ2AFqTQzNjkyMTQxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d4f0fc6621345f1fbfe3e6b0858edb88ea46f07", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/6d4f0fc6621345f1fbfe3e6b0858edb88ea46f07", "committedDate": "2020-04-23T00:44:25Z", "message": "Feature | initial commit for DNS cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "827ffb13ea3c07a11f1e64b157c9f77b32d62094", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/827ffb13ea3c07a11f1e64b157c9f77b32d62094", "committedDate": "2020-05-06T01:20:44Z", "message": "Handle the case when server doesnt support DNS cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ca5f68c4bfbead4fc638f371d79c27424bc651", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/99ca5f68c4bfbead4fc638f371d79c27424bc651", "committedDate": "2020-05-06T01:40:33Z", "message": "Merge remote-tracking branch 'upstream/dev' into DNSCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6430fe05b73917fac3280d85921f90e77289116", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e6430fe05b73917fac3280d85921f90e77289116", "committedDate": "2020-05-06T02:05:41Z", "message": "Fixed issue with removing DNS entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7129088cc66fc8c8e360874dc03678d9a3528350", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/7129088cc66fc8c8e360874dc03678d9a3528350", "committedDate": "2020-05-06T22:31:23Z", "message": "Fix | Use ternary if"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/f36fa50b94d528668f5eb4cc9ebd4e89f480c603", "committedDate": "2020-06-11T23:51:07Z", "message": "Update from dev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjAwMjY0", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-435200264", "createdAt": "2020-06-22T19:09:24Z", "commit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxOTowOToyNFrOGnNgeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxOTowOToyNFrOGnNgeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2ODk1Mg==", "bodyText": "I know it was like this originally, but we might as well add brackets to this if statement as well.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#discussion_r443768952", "createdAt": "2020-06-22T19:09:24Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -2665,12 +2681,13 @@ private void connectHelper(ServerPortPlaceHolder serverInfo, int timeOutSliceInM\n \n         // if the timeout is infinite slices are infinite too.\n         tdsChannel = new TDSChannel(this);\n+        InetSocketAddress inetSocketAddress;\n         if (0 == timeOutFullInSeconds)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzA4MDAy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-435308002", "createdAt": "2020-06-22T22:09:33Z", "commit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjowOTozM1rOGnSqtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjowOTozM1rOGnSqtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1MzQ5Mw==", "bodyText": "Can you add brackets around the boolean expression just for readability.\naddr = (null != cacheEntry) ? cacheEntry : addr;", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#discussion_r443853493", "createdAt": "2020-06-22T22:09:33Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -2645,6 +2650,14 @@ private Socket getDefaultSocket(String hostName, int portNumber, int timeoutInMi\n         // cannot be resolved, but that InetSocketAddress(host, port) does not - it sets\n         // the returned InetSocketAddress as unresolved.\n         InetSocketAddress addr = new InetSocketAddress(hostName, portNumber);\n+        if (addr.isUnresolved()) {\n+            if (logger.isLoggable(Level.FINER)) {\n+                logger.finer(this.toString() + \"Failed to resolve host name: \" + hostName\n+                        + \". Using IP address from DNS cache.\");\n+            }\n+            InetSocketAddress cacheEntry = SQLServerConnection.getDNSEntry(hostName);\n+            addr = null != cacheEntry ? cacheEntry : addr;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzExOTQ1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-435311945", "createdAt": "2020-06-22T22:18:06Z", "commit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjoxODowNlrOGnS3Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjoxODowNlrOGnS3Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1NjY1MA==", "bodyText": "I know this might be a readability issue, but it's possible to format well and change this to a ternary since it's an if condition attempting to assign a variable.\nInetSocketAddress inetSocketAddress = (0 == timeOutFullInSeconds) ? tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), 0, useParallel,useTnir, isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);\n                                                                  : tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), timeOutSliceInMillis, useParallel, useTnir, isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);\n\nMight be even better to use an if statement to determine the effective timeout since it's the only parameter changed.\nint effectiveTimeoutValue = (0 == timeOutFullInSeconds) ? 0 : timeOutSliceInMillis;\nInetSocketAddress inetSocketAddress = tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), effectiveTimeoutValue, useParallel,useTnir, isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#discussion_r443856650", "createdAt": "2020-06-22T22:18:06Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -2665,12 +2681,13 @@ private void connectHelper(ServerPortPlaceHolder serverInfo, int timeOutSliceInM\n \n         // if the timeout is infinite slices are infinite too.\n         tdsChannel = new TDSChannel(this);\n+        InetSocketAddress inetSocketAddress;\n         if (0 == timeOutFullInSeconds)\n-            tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), 0, useParallel, useTnir,\n-                    isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);\n-        else\n-            tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), timeOutSliceInMillis, useParallel,\n+            inetSocketAddress = tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(), 0, useParallel,\n                     useTnir, isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);\n+        else\n+            inetSocketAddress = tdsChannel.open(serverInfo.getServerName(), serverInfo.getPortNumber(),\n+                    timeOutSliceInMillis, useParallel, useTnir, isTnirFirstAttempt, timeOutsliceInMillisForFullTimeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzE0Mzgw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-435314380", "createdAt": "2020-06-22T22:23:16Z", "commit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjoyMzoxN1rOGnS-Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjoyMzoxN1rOGnS-Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1ODQzOA==", "bodyText": "Same readability suggestion as above for boolean expression in ternary.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#discussion_r443858438", "createdAt": "2020-06-22T22:23:17Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -685,6 +687,13 @@ boolean getServerSupportsDataClassification() {\n         return serverSupportsDataClassification;\n     }\n \n+    private boolean serverSupportsDNSCaching = false;\n+    private static ConcurrentHashMap<String, InetSocketAddress> dnsCache = null;\n+\n+    static InetSocketAddress getDNSEntry(String key) {\n+        return null != dnsCache ? dnsCache.get(key) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f36fa50b94d528668f5eb4cc9ebd4e89f480c603"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a4ca11c55e28149dd7d5c9d26f88d2b40dcef1", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/70a4ca11c55e28149dd7d5c9d26f88d2b40dcef1", "committedDate": "2020-06-23T21:55:18Z", "message": "Applied review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjI0ODA0", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-436224804", "createdAt": "2020-06-23T23:22:54Z", "commit": {"oid": "70a4ca11c55e28149dd7d5c9d26f88d2b40dcef1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODI5MjYy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-436829262", "createdAt": "2020-06-24T16:49:09Z", "commit": {"oid": "70a4ca11c55e28149dd7d5c9d26f88d2b40dcef1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODU3MTI1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-436857125", "createdAt": "2020-06-24T17:26:21Z", "commit": {"oid": "70a4ca11c55e28149dd7d5c9d26f88d2b40dcef1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66df9ed6a9c80c3c001f9d24aaee2c6e3a4264c3", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/66df9ed6a9c80c3c001f9d24aaee2c6e3a4264c3", "committedDate": "2020-06-24T18:01:58Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODg0NTg5", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-436884589", "createdAt": "2020-06-24T18:03:44Z", "commit": {"oid": "66df9ed6a9c80c3c001f9d24aaee2c6e3a4264c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTIxNDEz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1357#pullrequestreview-436921413", "createdAt": "2020-06-24T18:56:28Z", "commit": {"oid": "66df9ed6a9c80c3c001f9d24aaee2c6e3a4264c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2567, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}