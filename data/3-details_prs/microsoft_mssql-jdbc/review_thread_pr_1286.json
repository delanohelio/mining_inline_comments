{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTczMDgx", "number": 1286, "reviewThreads": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyMjo0OVrODqB5RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMzo1NjoyOVrODtVCIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1Mzk3ODI4OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyMjo0OVrOF5kvIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyMjo0OVrOF5kvIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNTA0Mg==", "bodyText": "Please check how version is specified for other dependencies.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r395915042", "createdAt": "2020-03-20T22:22:49Z", "author": {"login": "ulvii"}, "path": "pom.xml", "diffHunk": "@@ -94,6 +95,11 @@\n \t\t\t<version>${azure.adal4j.version}</version>\n \t\t\t<optional>true</optional>\n \t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>com.microsoft.azure</groupId>\n+\t\t\t<artifactId>azure-client-authentication</artifactId>\n+\t\t\t<version>1.7.2</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b6efc6138ec631d2c237aaeb2b2f463a0c984e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDI3MDI5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMzoxNToxMFrOF6fpJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODoyMzo0N1rOF69irw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg4MDE2Nw==", "bodyText": "Why are we wrapping the exception into a RuntimeException here? Shouldn't we wrap the exception into a SQLServerException instead?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r396880167", "createdAt": "2020-03-24T03:15:10Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -37,11 +55,19 @@\n     }\n \n     public String doAuthenticate(String authorization, String resource, String scope) {\n-        String accessToken;\n+        String accessToken = null;\n         if (null == authenticationCallback) {\n-            AuthenticationResult token = getAccessTokenFromClientCredentials(authorization, resource, clientId,\n-                    clientKey);\n-            accessToken = token.getAccessToken();\n+            if (null != msiCred) {\n+                try {\n+                    accessToken = msiCred.getToken(resource);\n+                } catch (IOException e) {\n+                    throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e69b3572a523405912f0f0e038a3bb10baf1023"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1ODQxMQ==", "bodyText": "should we? I used RuntimeException to be consistent with what we're currently doing already.  getAccessTokenFromClientCredentials throws RuntimeException which just gets passed up to the caller here", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r397358411", "createdAt": "2020-03-24T18:04:57Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -37,11 +55,19 @@\n     }\n \n     public String doAuthenticate(String authorization, String resource, String scope) {\n-        String accessToken;\n+        String accessToken = null;\n         if (null == authenticationCallback) {\n-            AuthenticationResult token = getAccessTokenFromClientCredentials(authorization, resource, clientId,\n-                    clientKey);\n-            accessToken = token.getAccessToken();\n+            if (null != msiCred) {\n+                try {\n+                    accessToken = msiCred.getToken(resource);\n+                } catch (IOException e) {\n+                    throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg4MDE2Nw=="}, "originalCommit": {"oid": "7e69b3572a523405912f0f0e038a3bb10baf1023"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM3MDAzMQ==", "bodyText": "ok, I see that it's being done in the other method as well...but I think we usually wrap any exception into SQLServerException. But I'm ok with following the previous code.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r397370031", "createdAt": "2020-03-24T18:23:47Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -37,11 +55,19 @@\n     }\n \n     public String doAuthenticate(String authorization, String resource, String scope) {\n-        String accessToken;\n+        String accessToken = null;\n         if (null == authenticationCallback) {\n-            AuthenticationResult token = getAccessTokenFromClientCredentials(authorization, resource, clientId,\n-                    clientKey);\n-            accessToken = token.getAccessToken();\n+            if (null != msiCred) {\n+                try {\n+                    accessToken = msiCred.getToken(resource);\n+                } catch (IOException e) {\n+                    throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg4MDE2Nw=="}, "originalCommit": {"oid": "7e69b3572a523405912f0f0e038a3bb10baf1023"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQwNTcxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMToyODowMVrOF7vCGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMToyODowMVrOF7vCGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4MDg4OQ==", "bodyText": "Add license header", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r398180889", "createdAt": "2020-03-25T21:28:01Z", "author": {"login": "peterbae"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e662fe741ae99b5c629bdcbab04d691f86c03ab"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODY4MDI3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/AECommon.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzowNjoxOVrOF7xq6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzowNjoxOVrOF7xq6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIyNDEwNg==", "bodyText": "put license header here", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r398224106", "createdAt": "2020-03-25T23:06:19Z", "author": {"login": "peterbae"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/AECommon.java", "diffHunk": "@@ -0,0 +1,302 @@\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e662fe741ae99b5c629bdcbab04d691f86c03ab"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODY5MjEwOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzoxMTowM1rOF7xxzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzoxMTowM1rOF7xxzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIyNTg3MQ==", "bodyText": "needs @test tag", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r398225871", "createdAt": "2020-03-25T23:11:03Z", "author": {"login": "peterbae"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test MSI auth using datasource\r\n+     */\r\n+    @Test\r\n+    public void testDSAuth() throws SQLException {\r\n+        SQLServerDataSource ds = new SQLServerDataSource();\r\n+        AbstractTest.updateDataSource(connectionString, ds);\r\n+\r\n+        try (Connection con = ds.getConnection(); Statement stmt = con.createStatement()) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with credentials\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        AETestConnectionString = TestUtils.addOrOverrideProperty(AETestConnectionString,\r\n+                Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r\n+        AETestConnectionString = TestUtils.addOrOverrideProperty(AETestConnectionString, Constants.KEYSTORE_PRINCIPALID,\r\n+                keyStorePrincipalId);\r\n+        AETestConnectionString = TestUtils.addOrOverrideProperty(AETestConnectionString, Constants.KEYSTORE_SECRET,\r\n+                keyStoreSecret);\r\n+        testCharAkv();\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with MSI\r\n+     */\r\n+    public void testCharAkvWithMSI() throws SQLException {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e662fe741ae99b5c629bdcbab04d691f86c03ab"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzMyMDMxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzo0NToyOVrOF8eZxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzo0NToyOVrOF8eZxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1Njk5Ng==", "bodyText": "I think currently your testing might not be testing the correct inputs from the user. This AETestConnectionString is a static variable that keeps getting added more parameters as individual tests get executed, resulting in latter tests having the same connection property defined multiple times. You should reset this variable to the base connection string at the beginning of each test run.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r398956996", "createdAt": "2020-03-26T23:45:29Z", "author": {"login": "peterbae"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test MSI auth using datasource\r\n+     */\r\n+    @Test\r\n+    public void testDSAuth() throws SQLException {\r\n+        SQLServerDataSource ds = new SQLServerDataSource();\r\n+        AbstractTest.updateDataSource(connectionString, ds);\r\n+\r\n+        try (Connection con = ds.getConnection(); Statement stmt = con.createStatement()) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with credentials\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        AETestConnectionString = TestUtils.addOrOverrideProperty(AETestConnectionString,\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54832b81645c811844ff2ea117fbc567c7c417fa"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3ODQ5NDg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwMToxNDo1NVrOF9NlXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNTo1MTo1NFrOF9aecg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczMDAxNQ==", "bodyText": "Aren't you adding 2 new connection properties?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r399730015", "createdAt": "2020-03-29T01:14:55Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d14f398f955e27214a5665150be2f7b20905609d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk0MTIzNA==", "bodyText": "not anymore, latest discussion with Jakub we're aligning with ODBC so using keyStorePrincipalId (new) and keyStoreSecret (existing)", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r399941234", "createdAt": "2020-03-30T05:51:54Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczMDAxNQ=="}, "originalCommit": {"oid": "d14f398f955e27214a5665150be2f7b20905609d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDExNjQ3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOTo0NlrOF-BOtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOTo0NlrOF-BOtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjE4Mg==", "bodyText": "This is not necessarily AKV user principal ID. Please align the docs with ODBC connection property documentation.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r400576182", "createdAt": "2020-03-31T00:39:46Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**\n+     * Sets the Azure Key Vault (AKV) Provider user principal id.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff179c14be160f612d70e3102c4a4ed8e85dd628"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDExNjc1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOTo1NVrOF-BO6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDozOTo1NVrOF-BO6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjIzMg==", "bodyText": "Same here.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r400576232", "createdAt": "2020-03-31T00:39:55Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**\n+     * Sets the Azure Key Vault (AKV) Provider user principal id.\n+     * \n+     * @param keyVaultPrincipalId\n+     *        principal Id of Azure Key Vault (AKV) Provider to be used for column encryption.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff179c14be160f612d70e3102c4a4ed8e85dd628"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzAxMTA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowMzoyMFrOF-dFgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowMzoyMFrOF-dFgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAzMjU3Ng==", "bodyText": "Please do not call class.getName() in logger, it traverses the stack and is extremely costly performance-wise. I also recommend checking the logging level before calling these entering/exiting methods, although I'm not sure if the intent here is to always log. As for the class.getName(), just use a static string, so SQLServerConnection.class.getName() would be \"com.microsoft.sqlserver.jdbc.SQLServerConnection\".", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401032576", "createdAt": "2020-03-31T16:03:20Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -720,6 +722,23 @@ public static synchronized void registerColumnEncryptionKeyStoreProviders(\n                         + globalCustomColumnEncryptionKeyStoreProviders.size());\n     }\n \n+    /**\n+     * Unregisters the custom key store providers from the globalCustomColumnEncryptionKeyStoreProviders.\n+     */\n+    public static synchronized void unregisterColumnEncryptionKeyStoreProviders() {\n+        loggerExternal.entering(SQLServerConnection.class.getName(), \"unregisterColumnEncryptionKeyStoreProviders\",\n+                \"Removing Column Encryption Key Store Provider\");\n+\n+        if (null != globalCustomColumnEncryptionKeyStoreProviders) {\n+            globalCustomColumnEncryptionKeyStoreProviders.clear();\n+        }\n+\n+        loggerExternal.exiting(SQLServerConnection.class.getName(), \"unregisterColumnEncryptionKeyStoreProviders\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzAyMjkwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowNjowN1rOF-dNAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowNjowN1rOF-dNAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAzNDQ5Nw==", "bodyText": "Feels like a waste to create a hash-map w/ 1 entry just to conform to the existing constructor. Maybe this can be done better?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401034497", "createdAt": "2020-03-31T16:06:07Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -1291,7 +1316,30 @@ private void registerKeyStoreProviderOnConnection(String keyStoreAuth, String ke\n                         systemColumnEncryptionKeyStoreProvider.put(provider.getName(), provider);\n                     }\n                     break;\n-\n+                case KeyVaultClientSecret:\n+                    // need a secret use use the secret method\n+                    if (null == keyStoreSecret) {\n+                        throw new SQLServerException(\n+                                SQLServerException.getErrString(\"R_keyStoreSecretOrLocationNotSet\"), null);\n+                    } else {\n+                        SQLServerColumnEncryptionAzureKeyVaultProvider provider = new SQLServerColumnEncryptionAzureKeyVaultProvider(\n+                                keyStorePrincipalId, keyStoreSecret);\n+                        Map<String, SQLServerColumnEncryptionKeyStoreProvider> keyStoreMap = new HashMap<String, SQLServerColumnEncryptionKeyStoreProvider>();\n+                        keyStoreMap.put(provider.getName(), provider);\n+                        registerColumnEncryptionKeyStoreProviders(keyStoreMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzAzMzQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerSecurityUtility.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowODozMVrOF-dT2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjowODozMVrOF-dT2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAzNjI0OA==", "bodyText": "Response codes shouldn't be magic numbers, better to create constants and document a little of their meaning in comments. I think this part of the code is just moved though so please document/create a work item.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401036248", "createdAt": "2020-03-31T16:08:31Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerSecurityUtility.java", "diffHunk": "@@ -215,4 +234,164 @@ static void verifyColumnMasterKeyMetadata(SQLServerConnection connection, String\n             throw new SQLServerException(SQLServerException.getErrString(\"R_VerifySignature\"), null);\r\n         }\r\n     }\r\n+\r\n+    /**\r\n+     * Get Managed Identity Authentication token\r\n+     * \r\n+     * @param resource\r\n+     *        token resource\r\n+     * @param msiClientId\r\n+     *        Managed Identity or User Assigned Managed Identity\r\n+     * @return fedauth token\r\n+     * @throws SQLServerException\r\n+     */\r\n+    static SqlFedAuthToken getMSIAuthToken(String resource, String msiClientId) throws SQLServerException {\r\n+        // IMDS upgrade time can take up to 70s\r\n+        final int imdsUpgradeTimeInMs = 70 * 1000;\r\n+        final List<Integer> retrySlots = new ArrayList<>();\r\n+        final String msiEndpoint = System.getenv(\"MSI_ENDPOINT\");\r\n+        final String msiSecret = System.getenv(\"MSI_SECRET\");\r\n+\r\n+        StringBuilder urlString = new StringBuilder();\r\n+        int retry = 1, maxRetry = 1;\r\n+\r\n+        /*\r\n+         * isAzureFunction is used for identifying if the current client application is running in a Virtual Machine\r\n+         * (without MSI environment variables) or App Service/Function (with MSI environment variables) as the APIs to\r\n+         * be called for acquiring MSI Token are different for both cases.\r\n+         */\r\n+        boolean isAzureFunction = null != msiEndpoint && !msiEndpoint.isEmpty() && null != msiSecret\r\n+                && !msiSecret.isEmpty();\r\n+\r\n+        if (isAzureFunction) {\r\n+            urlString.append(msiEndpoint).append(\"?api-version=2017-09-01&resource=\").append(resource);\r\n+        } else {\r\n+            urlString.append(ActiveDirectoryAuthentication.AZURE_REST_MSI_URL).append(\"&resource=\").append(resource);\r\n+            // Retry acquiring access token upto 20 times due to possible IMDS upgrade (Applies to VM only)\r\n+            maxRetry = 20;\r\n+            // Simplified variant of Exponential BackOff\r\n+            for (int x = 0; x < maxRetry; x++) {\r\n+                retrySlots.add(500 * ((2 << 1) - 1) / 1000);\r\n+            }\r\n+        }\r\n+\r\n+        // Append Client Id if available\r\n+        if (null != msiClientId && !msiClientId.isEmpty()) {\r\n+            if (isAzureFunction) {\r\n+                urlString.append(\"&clientid=\").append(msiClientId);\r\n+            } else {\r\n+                urlString.append(\"&client_id=\").append(msiClientId);\r\n+            }\r\n+        }\r\n+\r\n+        // Loop while maxRetry reaches its limit\r\n+        while (retry <= maxRetry) {\r\n+            HttpURLConnection connection = null;\r\n+\r\n+            try {\r\n+                connection = (HttpURLConnection) new URL(urlString.toString()).openConnection();\r\n+                connection.setRequestMethod(\"GET\");\r\n+\r\n+                if (isAzureFunction) {\r\n+                    connection.setRequestProperty(\"Secret\", msiSecret);\r\n+                    if (connectionlogger.isLoggable(Level.FINER)) {\r\n+                        connectionlogger.finer(\"Using Azure Function/App Service MSI auth: \" + urlString);\r\n+                    }\r\n+                } else {\r\n+                    connection.setRequestProperty(\"Metadata\", \"true\");\r\n+                    if (connectionlogger.isLoggable(Level.FINER)) {\r\n+                        connectionlogger.finer(\"Using Azure MSI auth: \" + urlString);\r\n+                    }\r\n+                }\r\n+\r\n+                connection.connect();\r\n+\r\n+                try (InputStream stream = connection.getInputStream()) {\r\n+\r\n+                    BufferedReader reader = new BufferedReader(new InputStreamReader(stream, UTF_8), 100);\r\n+                    String result = reader.readLine();\r\n+\r\n+                    int startIndex_AT = result.indexOf(ActiveDirectoryAuthentication.ACCESS_TOKEN_IDENTIFIER)\r\n+                            + ActiveDirectoryAuthentication.ACCESS_TOKEN_IDENTIFIER.length();\r\n+\r\n+                    String accessToken = result.substring(startIndex_AT, result.indexOf(\"\\\"\", startIndex_AT + 1));\r\n+\r\n+                    Calendar cal = new Calendar.Builder().setInstant(new Date()).build();\r\n+\r\n+                    if (isAzureFunction) {\r\n+                        // Fetch expires_on\r\n+                        int startIndex_ATX = result\r\n+                                .indexOf(ActiveDirectoryAuthentication.ACCESS_TOKEN_EXPIRES_ON_IDENTIFIER)\r\n+                                + ActiveDirectoryAuthentication.ACCESS_TOKEN_EXPIRES_ON_IDENTIFIER.length();\r\n+                        String accessTokenExpiry = result.substring(startIndex_ATX,\r\n+                                result.indexOf(\"\\\"\", startIndex_ATX + 1));\r\n+                        if (connectionlogger.isLoggable(Level.FINER)) {\r\n+                            connectionlogger.finer(\"MSI auth token expires on: \" + accessTokenExpiry);\r\n+                        }\r\n+\r\n+                        DateFormat df = new SimpleDateFormat(\r\n+                                ActiveDirectoryAuthentication.ACCESS_TOKEN_EXPIRES_ON_DATE_FORMAT);\r\n+                        cal = new Calendar.Builder().setInstant(df.parse(accessTokenExpiry)).build();\r\n+                    } else {\r\n+                        // Fetch expires_in\r\n+                        int startIndex_ATX = result\r\n+                                .indexOf(ActiveDirectoryAuthentication.ACCESS_TOKEN_EXPIRES_IN_IDENTIFIER)\r\n+                                + ActiveDirectoryAuthentication.ACCESS_TOKEN_EXPIRES_IN_IDENTIFIER.length();\r\n+                        String accessTokenExpiry = result.substring(startIndex_ATX,\r\n+                                result.indexOf(\"\\\"\", startIndex_ATX + 1));\r\n+                        cal.add(Calendar.SECOND, Integer.parseInt(accessTokenExpiry));\r\n+                    }\r\n+\r\n+                    return new SqlFedAuthToken(accessToken, cal.getTime());\r\n+                }\r\n+            } catch (Exception e) {\r\n+                retry++;\r\n+                // Below code applicable only when !isAzureFunctcion (VM)\r\n+                if (retry > maxRetry) {\r\n+                    // Do not retry if maxRetry limit has been reached.\r\n+                    break;\r\n+                } else {\r\n+                    try {\r\n+                        int responseCode = connection.getResponseCode();\r\n+                        // Check Error Response Code from Connection\r\n+                        if (410 == responseCode || 429 == responseCode || 404 == responseCode\r\n+                                || (500 <= responseCode && 599 >= responseCode)) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 166}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzMwOTc1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoxNzowM1rOF-gDuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxOToxNjowMlrOF-keZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MTI3Mg==", "bodyText": "From ODBC docs, keyStorePrincipalId description:\nWhen KeyStoreAuthentication = KeyVaultPassword, set this value to a valid Azure Active Directory User Principal Name.\nWhen KeyStoreAuthetication = KeyVaultClientSecret set this value to a valid Azure Active Directory Application Client ID", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401081272", "createdAt": "2020-03-31T17:17:03Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**\n+     * Sets the Azure Active Directory Application Client ID.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE1MzYzOQ==", "bodyText": "Please set Javadoc to this\n    /**\n     * Sets the value for the connection property 'keyStorePrincipalId'.\n     * \n     * @param keyStorePrincipalId\n     * \n     *        <pre>\n     *        When keyStoreAuthentication = keyVaultPassword, set this value to a valid Azure Active Directory User Principal Name.\n     *        When keyStoreAuthentication = keyVaultClientSecret, set this value to a valid Azure Active Directory Application Client ID.\n     *        When keyStoreAuthentication = keyVaultManagedIdentity, set this value to a valid Azure Active Directory Application Object ID (optional, for user-assigned only).\n     *        </pre>\n     */", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401153639", "createdAt": "2020-03-31T19:16:02Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -821,6 +821,21 @@\n      */\n     String getMSIClientId();\n \n+    /**\n+     * Sets the Azure Active Directory Application Client ID.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MTI3Mg=="}, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzM1MTUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoyNzoyOVrOF-gdkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoyNzoyOVrOF-gdkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4Nzg5MA==", "bodyText": "Please add proper javadoc, this is a public API.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401087890", "createdAt": "2020-03-31T17:27:29Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -720,6 +722,23 @@ public static synchronized void registerColumnEncryptionKeyStoreProviders(\n                         + globalCustomColumnEncryptionKeyStoreProviders.size());\n     }\n \n+    /**\n+     * Unregisters the custom key store providers from the globalCustomColumnEncryptionKeyStoreProviders.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a55d5b70b3dc899ddee573e04564d0ee6647c00"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzkzNDcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDowNDo1NlrOF-mI4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDowNDo1NlrOF-mI4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4MDg5Nw==", "bodyText": "R_keyStoreSecretOrLocationNotSet message does not make sense for this future.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401180897", "createdAt": "2020-03-31T20:04:56Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -1291,7 +1301,30 @@ private void registerKeyStoreProviderOnConnection(String keyStoreAuth, String ke\n                         systemColumnEncryptionKeyStoreProvider.put(provider.getName(), provider);\n                     }\n                     break;\n-\n+                case KeyVaultClientSecret:\n+                    // need a secret use use the secret method\n+                    if (null == keyStoreSecret) {\n+                        throw new SQLServerException(\n+                                SQLServerException.getErrString(\"R_keyStoreSecretOrLocationNotSet\"), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91639a5bc7eb9bf5ce36972f3a254376a3077b1c"}, "originalPosition": 218}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4Nzk5NjUxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyMTozMlrOF-mubg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyMTozMlrOF-mubg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MDUxMA==", "bodyText": "How is this testing MSI auth? You are using the global connection stirng.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401190510", "createdAt": "2020-03-31T20:21:32Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddd56156e31b863bb36352cc6c5015059e13380"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4Nzk5NzY2OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyMTo0OVrOF-mvHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyMTo0OVrOF-mvHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MDY4NQ==", "bodyText": "Same here, how is this testing MSI auth?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401190685", "createdAt": "2020-03-31T20:21:49Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test MSI auth using datasource\r\n+     */\r\n+    @Test\r\n+    public void testDSAuth() throws SQLException {\r\n+        SQLServerDataSource ds = new SQLServerDataSource();\r\n+        AbstractTest.updateDataSource(connectionString, ds);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddd56156e31b863bb36352cc6c5015059e13380"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODAyMTY4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyODoxN1rOF-m9tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyODoxN1rOF-m9tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5NDQyMw==", "bodyText": "Login failed? This catch block implies that, the only exception that can happen inside try block is due to a login failure. Just remove the catch block and let the test throw the original exception.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401194423", "createdAt": "2020-03-31T20:28:17Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test MSI auth using datasource\r\n+     */\r\n+    @Test\r\n+    public void testDSAuth() throws SQLException {\r\n+        SQLServerDataSource ds = new SQLServerDataSource();\r\n+        AbstractTest.updateDataSource(connectionString, ds);\r\n+\r\n+        try (Connection con = ds.getConnection(); Statement stmt = con.createStatement()) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with credentials\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_PRINCIPALID, keyStorePrincipalId);\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_SECRET, keyStoreSecret);\r\n+        testCharAkv(connStr);\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with MSI\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithMSI() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // set to use Managed Identity for keystore auth\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION,\r\n+                \"KeyVaultManagedIdentity\");\r\n+        testCharAkv(connStr);\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with bad credentials\r\n+     */\r\n+    @Test\r\n+    public void testNumericAkvWithBadCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_PRINCIPALID, \"bad\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_SECRET, \"bad\");\r\n+        try {\r\n+            testNumericAKV(connStr);\r\n+            fail(TestResource.getResource(\"R_expectedFailPassed\"));\r\n+        } catch (Exception e) {\r\n+            assert (e.getMessage().contains(\"AuthenticationException\"));\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with credentials\r\n+     */\r\n+    @Test\r\n+    public void testNumericAkvWithCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_PRINCIPALID, keyStorePrincipalId);\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_SECRET, keyStoreSecret);\r\n+        testNumericAKV(connStr);\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with MSI\r\n+     */\r\n+    @Test\r\n+    public void testNumericAkvWithMSI() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // set to use Managed Identity for keystore auth\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION,\r\n+                \"KeyVaultManagedIdentity\");\r\n+        testNumericAKV(connStr);\r\n+    }\r\n+\r\n+    private void testCharAkv(String connStr) throws SQLException {\r\n+        String sql = \"select * from \" + CHAR_TABLE_AE;\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connStr);\r\n+                SQLServerStatement stmt = (SQLServerStatement) con.createStatement();\r\n+                SQLServerPreparedStatement pstmt = (SQLServerPreparedStatement) TestUtils.getPreparedStmt(con, sql,\r\n+                        stmtColEncSetting)) {\r\n+            TestUtils.dropTableIfExists(CHAR_TABLE_AE, stmt);\r\n+            createTable(CHAR_TABLE_AE, cekAkv, charTable);\r\n+            String[] values = createCharValues(false);\r\n+            populateCharNormalCase(values);\r\n+\r\n+            try (ResultSet rs = (null == stmt) ? pstmt.executeQuery() : stmt.executeQuery(sql)) {\r\n+                int numberOfColumns = rs.getMetaData().getColumnCount();\r\n+                while (rs.next()) {\r\n+                    AECommon.testGetString(rs, numberOfColumns, values);\r\n+                    AECommon.testGetObject(rs, numberOfColumns, values);\r\n+                }\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    private void testNumericAKV(String connStr) throws SQLException {\r\n+        String sql = \"select * from \" + NUMERIC_TABLE_AE;\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connStr);\r\n+                SQLServerStatement stmt = (SQLServerStatement) con.createStatement();\r\n+                SQLServerPreparedStatement pstmt = (SQLServerPreparedStatement) TestUtils.getPreparedStmt(con, sql,\r\n+                        stmtColEncSetting)) {\r\n+            TestUtils.dropTableIfExists(NUMERIC_TABLE_AE, stmt);\r\n+            createTable(NUMERIC_TABLE_AE, cekAkv, numericTable);\r\n+            String[] values = createNumericValues(false);\r\n+            populateNumeric(values);\r\n+\r\n+            try (SQLServerResultSet rs = (null == stmt) ? (SQLServerResultSet) pstmt.executeQuery()\r\n+                                                        : (SQLServerResultSet) stmt.executeQuery(sql)) {\r\n+                int numberOfColumns = rs.getMetaData().getColumnCount();\r\n+                while (rs.next()) {\r\n+                    AECommon.testGetString(rs, numberOfColumns, values);\r\n+                    AECommon.testGetObject(rs, numberOfColumns, values);\r\n+                    AECommon.testGetBigDecimal(rs, numberOfColumns, values);\r\n+                    AECommon.testWithSpecifiedtype(rs, numberOfColumns, values);\r\n+                }\r\n+            } catch (Exception e) {\r\n+                fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddd56156e31b863bb36352cc6c5015059e13380"}, "originalPosition": 185}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODA2MDkzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDozOToyMFrOF-nWIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDozOToyMFrOF-nWIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIwMDY3Mw==", "bodyText": "I would prefer to use KeyVaultManagedIdentity here, that is what the feature is about.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401200673", "createdAt": "2020-03-31T20:39:20Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+    /*\r\n+     * Test basic MSI auth\r\n+     */\r\n+    @Test\r\n+    public void testAuth() throws SQLException {\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test MSI auth using datasource\r\n+     */\r\n+    @Test\r\n+    public void testDSAuth() throws SQLException {\r\n+        SQLServerDataSource ds = new SQLServerDataSource();\r\n+        AbstractTest.updateDataSource(connectionString, ds);\r\n+\r\n+        try (Connection con = ds.getConnection(); Statement stmt = con.createStatement()) {} catch (Exception e) {\r\n+            fail(TestResource.getResource(\"R_loginFailed\") + e.getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with credentials\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_PRINCIPALID, keyStorePrincipalId);\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_SECRET, keyStoreSecret);\r\n+        testCharAkv(connStr);\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with MSI\r\n+     */\r\n+    @Test\r\n+    public void testCharAkvWithMSI() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // set to use Managed Identity for keystore auth\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION,\r\n+                \"KeyVaultManagedIdentity\");\r\n+        testCharAkv(connStr);\r\n+    }\r\n+\r\n+    /*\r\n+     * Test AKV with with bad credentials\r\n+     */\r\n+    @Test\r\n+    public void testNumericAkvWithBadCred() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        // add credentials to connection string\r\n+        String connStr = AETestConnectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.KEYSTORE_AUTHENTICATION, \"KeyVaultClientSecret\");\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddd56156e31b863bb36352cc6c5015059e13380"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODIyODI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerSecurityUtility.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozMTo0NVrOF-o_2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozMTo0NVrOF-o_2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNzczNg==", "bodyText": "Requests", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401227736", "createdAt": "2020-03-31T21:31:45Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerSecurityUtility.java", "diffHunk": "@@ -5,21 +5,46 @@\n \r\n package com.microsoft.sqlserver.jdbc;\r\n \r\n+import static java.nio.charset.StandardCharsets.UTF_8;\r\n+\r\n+import java.io.BufferedReader;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.InputStreamReader;\r\n+import java.net.HttpURLConnection;\r\n+import java.net.URL;\r\n import java.security.InvalidKeyException;\r\n import java.security.NoSuchAlgorithmException;\r\n+import java.text.DateFormat;\r\n import java.text.MessageFormat;\r\n+import java.text.SimpleDateFormat;\r\n+import java.util.ArrayList;\r\n+import java.util.Calendar;\r\n+import java.util.Date;\r\n import java.util.Iterator;\r\n import java.util.List;\r\n+import java.util.concurrent.ThreadLocalRandom;\r\n+import java.util.logging.Level;\r\n \r\n import javax.crypto.Mac;\r\n import javax.crypto.spec.SecretKeySpec;\r\n \r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection.ActiveDirectoryAuthentication;\r\n+\r\n \r\n /**\r\n  * Various SQLServer security utilities.\r\n  *\r\n  */\r\n class SQLServerSecurityUtility {\r\n+    static final private java.util.logging.Logger connectionlogger = java.util.logging.Logger\r\n+            .getLogger(\"com.microsoft.sqlserver.jdbc.internals.SQLServerConnection\");\r\n+\r\n+    static final int GONE = 410;\r\n+    static final int TOO_MANY_RESQUESTS = 429;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee0a1fbf0e356627076da3cda6b520bbb8c61f54"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODQxNjQ3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjo0MTo1NlrOF-q0YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjo0MTo1NlrOF-q0YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI1NzU2OQ==", "bodyText": "Please also add similar tests that test ActiveDirectoryMSI along with msiClientId", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401257569", "createdAt": "2020-03-31T22:41:56Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,257 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.aad.adal4j.AuthenticationException;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+import static org.junit.jupiter.api.Assertions.assertTrue;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+\r\n+    /*\r\n+     * Test MSI auth\r\n+     */\r\n+    @Tag(Constants.xSQLv12)\r\n+    @Tag(Constants.xSQLv14)\r\n+    @Tag(Constants.xSQLv15)\r\n+    @Test\r\n+    public void testMSIAuth() throws SQLException {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b0d70d10810320422c1b359acb304ff9cf639fd"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODUzNTU4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMzozOToyMFrOF-r8ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMzozOToyMFrOF-r8ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3NjAyNw==", "bodyText": "There are unused imports here", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401276027", "createdAt": "2020-03-31T23:39:20Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,307 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.aad.adal4j.AuthenticationException;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19a582e1d8750ecc746f334c0a7f43cb66121a6a"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODU3MTIwOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMzo1NjoyOVrOF-sRMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMzo1NjoyOVrOF-sRMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4MTMyOQ==", "bodyText": "aren't you supposed to use connStr ?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1286#discussion_r401281329", "createdAt": "2020-03-31T23:56:29Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -0,0 +1,307 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.jdbc.AlwaysEncrypted;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.fail;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.aad.adal4j.AuthenticationException;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerConnection;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerResultSet;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerStatement;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+import com.microsoft.sqlserver.testframework.PrepUtil;\r\n+import static org.junit.jupiter.api.Assertions.assertTrue;\r\n+\r\n+\r\n+/**\r\n+ * Tests involving MSI authentication\r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.MSI)\r\n+public class MSITest extends AESetup {\r\n+\r\n+    /*\r\n+     * Test MSI auth\r\n+     */\r\n+    @Tag(Constants.xSQLv12)\r\n+    @Tag(Constants.xSQLv14)\r\n+    @Tag(Constants.xSQLv15)\r\n+    @Test\r\n+    public void testMSIAuth() throws SQLException {\r\n+        // unregister the custom providers registered in AESetup\r\n+        SQLServerConnection.unregisterColumnEncryptionKeyStoreProviders();\r\n+\r\n+        String connStr = connectionString;\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.USER, \"\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.PASSWORD, \"\");\r\n+        connStr = TestUtils.addOrOverrideProperty(connStr, Constants.AUTHENTICATION, \"ActiveDirectoryMSI\");\r\n+\r\n+        try (SQLServerConnection con = PrepUtil.getConnection(connectionString)) {} catch (Exception e) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19a582e1d8750ecc746f334c0a7f43cb66121a6a"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1043, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}