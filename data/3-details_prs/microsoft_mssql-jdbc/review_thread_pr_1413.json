{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTAyODQx", "number": 1413, "reviewThreads": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjozODoyNlrOEcxa_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMjowNVrOEtLCCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NjA1MzA5OnYy", "diffSide": "RIGHT", "path": "azure-pipelines.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjozODoyNlrOHHgGSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjozODoyNlrOHHgGSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYyNzk3OA==", "bodyText": "I don't think we need any changes to this file anymore since tenantID is gone", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r477627978", "createdAt": "2020-08-26T22:38:26Z", "author": {"login": "lilgreenbird"}, "path": "azure-pipelines.yml", "diffHunk": "@@ -38,8 +38,8 @@ jobs:\n     displayName: 'Maven build jre14'\n     inputs:\n       mavenPomFile: 'pom.xml'\n-      goals: 'clean dependency:purge-local-repository -Dmssql_jdbc_test_connection_properties=jdbc:sqlserver://$(Target_SQL)$(server_domain);$(database);$(user);$(password); install -Pjre14 -DuserNTLM=$(userNTLM) -DpasswordNTLM=$(passwordNTLM) -DdomainNTLM=$(domainNTLM) -DexcludedGroups=$(Ex_Groups) -Dpkcs12_truststore_password=$(pkcs12_truststore_password) -Dpkcs12_truststore=$(pkcs12_truststore.secureFilePath) \n--DapplicationClientID=$(applicationClientID) -DapplicationKey=$(applicationKey) -DkeyID=$(keyID) -DwindowsKeyPath=$(windowsKeyPath) -DenclaveAttestationUrl=$(enclaveAttestationUrl) -DenclaveAttestationProtocol=$(enclaveAttestationProtocol) -DenclaveServer=$(enclaveServer)'\n+      goals: 'clean dependency:purge-local-repository -Dmssql_jdbc_test_connection_properties=jdbc:sqlserver://$(Target_SQL)$(server_domain);$(database);$(user);$(password); install -Pjre14 -DuserNTLM=$(userNTLM) -DpasswordNTLM=$(passwordNTLM) -DdomainNTLM=$(domainNTLM) -DexcludedGroups=$(Ex_Groups) -Dpkcs12_truststore_password=$(pkcs12_truststore_password) -Dpkcs12_truststore=$(pkcs12_truststore.secureFilePath)\n+-DapplicationClientID=$(applicationClientID) -DapplicationKey=$(applicationKey) -DkeyID=$(keyID) -DwindowsKeyPath=$(windowsKeyPath) -DenclaveAttestationUrl=$(enclaveAttestationUrl) -DenclaveAttestationProtocol=$(enclaveAttestationProtocol) -DenclaveServer=$(enclaveServer) -DtenantID=$(tenantID)'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7c44b59affd57d3bb1c96557cc3711f7d99266d"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5Mjc2MDQxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjozOToxOVrOHIjmYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjozOToxOVrOHIjmYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczMzkyMQ==", "bodyText": "remove, no longer needed", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r478733921", "createdAt": "2020-08-27T22:39:19Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -669,6 +669,8 @@ boolean getSendTemporalDataTypesAsStringForBulkCopy() {\n     String keyStoreLocation = null;\n     String keyStorePrincipalId = null;\n \n+    String keyVaultProviderTenantId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0953145cc7b3e61444fe92e372e57bc2b855c5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5Mjc3NDY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjo0NToyMVrOHIjuiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjo0NToyMVrOHIjuiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNjAxMQ==", "bodyText": "[WARNING] Javadoc Warnings\n[WARNING] C:\\mssql-jdbc\\src\\main\\java\\com\\microsoft\\sqlserver\\jdbc\\SQLServerColumnEncryptionAzureKeyVaultProvider.java:145: warning: no @throws for com.microsoft.sqlserver.jdbc.SQLServerException\n[WARNING] public SQLServerColumnEncryptionAzureKeyVaultProvider(TokenCredential tokenCredential)\n[WARNING] ^", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r478736011", "createdAt": "2020-08-27T22:45:21Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -49,668 +53,682 @@\n  */\n public class SQLServerColumnEncryptionAzureKeyVaultProvider extends SQLServerColumnEncryptionKeyStoreProvider {\n \n-    private final static java.util.logging.Logger akvLogger = java.util.logging.Logger\n-            .getLogger(\"com.microsoft.sqlserver.jdbc.SQLServerColumnEncryptionAzureKeyVaultProvider\");\n-    /**\n-     * Column Encryption Key Store Provider string\n-     */\n-    String name = \"AZURE_KEY_VAULT\";\n-\n-    private final String baseUrl = \"https://{vaultBaseUrl}\";\n-\n-    private static final String MSSQL_JDBC_PROPERTIES = \"mssql-jdbc.properties\";\n-    private static final String AKV_TRUSTED_ENDPOINTS_KEYWORD = \"AKVTrustedEndpoints\";\n-    private static final List<String> akvTrustedEndpoints;\n-    static {\n-        akvTrustedEndpoints = getTrustedEndpoints();\n-    }\n-    private final String rsaEncryptionAlgorithmWithOAEPForAKV = \"RSA-OAEP\";\n-\n-    /**\n-     * Algorithm version\n-     */\n-    private final byte[] firstVersion = new byte[] {0x01};\n-\n-    private KeyVaultClient keyVaultClient;\n-\n-    private KeyVaultCredential credentials;\n-\n-    public void setName(String name) {\n-        this.name = name;\n-    }\n-\n-    public String getName() {\n-        return this.name;\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a client id and client key to authenticate to\n-     * AAD. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n-     * @param clientId\n-     *        Identifier of the client requesting the token.\n-     * @param clientKey\n-     *        Key of the client requesting the token.\n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId, String clientKey) throws SQLServerException {\n-        credentials = new KeyVaultCredential(clientId, clientKey);\n-        keyVaultClient = new KeyVaultClient(credentials);\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD and\n-     * an executor service.. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n-     * This constructor is present to maintain backwards compatibility with 6.0 version of the driver. Deprecated for\n-     * removal in next stable release.\n-     * \n-     * @param authenticationCallback\n-     *        - Callback function used for authenticating to AAD.\n-     * @param executorService\n-     *        - The ExecutorService, previously used to create the keyVaultClient, but not in use anymore. - This\n-     *        parameter can be passed as 'null'\n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    @Deprecated\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(\n-            SQLServerKeyVaultAuthenticationCallback authenticationCallback,\n-            ExecutorService executorService) throws SQLServerException {\n-        this(authenticationCallback);\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD. This\n-     * is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n-     * @param authenticationCallback\n-     *        - Callback function used for authenticating to AAD.\n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(\n-            SQLServerKeyVaultAuthenticationCallback authenticationCallback) throws SQLServerException {\n-        if (null == authenticationCallback) {\n-            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n-            Object[] msgArgs1 = {\"SQLServerKeyVaultAuthenticationCallback\"};\n-            throw new SQLServerException(form.format(msgArgs1), null);\n+        private final static java.util.logging.Logger akvLogger = java.util.logging.Logger\n+                .getLogger(\"com.microsoft.sqlserver.jdbc.SQLServerColumnEncryptionAzureKeyVaultProvider\");\n+        private HttpPipeline keyVaultPipeline;\n+        private KeyVaultCredential keyVaultCredential;\n+        /**\n+         * Column Encryption Key Store Provider string\n+         */\n+        String name = \"AZURE_KEY_VAULT\";\n+\n+        private static final String MSSQL_JDBC_PROPERTIES = \"mssql-jdbc.properties\";\n+        private static final String AKV_TRUSTED_ENDPOINTS_KEYWORD = \"AKVTrustedEndpoints\";\n+        private static final String RSA_ENCRYPTION_ALGORITHM_WITH_OAEP_FOR_AKV = \"RSA-OAEP\";\n+\n+        private static final List<String> akvTrustedEndpoints;\n+        /**\n+         * Algorithm version\n+         */\n+        private final byte[] firstVersion = new byte[] {0x01};\n+\n+        private Map<String, KeyClient> cachedKeyClients = new ConcurrentHashMap<>();\n+        private Map<String, CryptographyClient> cachedCryptographyClients = new ConcurrentHashMap<>();\n+        private TokenCredential credential;\n+\n+        static {\n+                akvTrustedEndpoints = getTrustedEndpoints();\n         }\n-        credentials = new KeyVaultCredential(authenticationCallback);\n-        RestClient restClient = new RestClient.Builder(new OkHttpClient.Builder(), new Retrofit.Builder())\n-                .withBaseUrl(baseUrl).withCredentials(credentials).withSerializerAdapter(new AzureJacksonAdapter())\n-                .withResponseBuilderFactory(new AzureResponseBuilder.Factory()).build();\n-        keyVaultClient = new KeyVaultClient(restClient);\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by\n-     * KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    SQLServerColumnEncryptionAzureKeyVaultProvider() throws SQLServerException {\n-        credentials = new KeyVaultCredential();\n-        keyVaultClient = new KeyVaultClient(credentials);\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by\n-     * KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     *\n-     * @param clientId\n-     *        Identifier of the client requesting the token.\n-     * \n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId) throws SQLServerException {\n-        credentials = new KeyVaultCredential(clientId);\n-        keyVaultClient = new KeyVaultClient(credentials);\n-    }\n-\n-    /**\n-     * Decrypts an encrypted CEK with RSA encryption algorithm using the asymmetric key specified by the key path\n-     * \n-     * @param masterKeyPath\n-     *        - Complete path of an asymmetric key in AKV\n-     * @param encryptionAlgorithm\n-     *        - Asymmetric Key Encryption Algorithm\n-     * @param encryptedColumnEncryptionKey\n-     *        - Encrypted Column Encryption Key\n-     * @return Plain text column encryption key\n-     */\n-    @Override\n-    public byte[] decryptColumnEncryptionKey(String masterKeyPath, String encryptionAlgorithm,\n-            byte[] encryptedColumnEncryptionKey) throws SQLServerException {\n-\n-        // Validate the input parameters\n-        this.ValidateNonEmptyAKVPath(masterKeyPath);\n-\n-        if (null == encryptedColumnEncryptionKey) {\n-            throw new SQLServerException(SQLServerException.getErrString(\"R_NullEncryptedColumnEncryptionKey\"), null);\n+\n+        public void setName(String name) {\n+                this.name = name;\n         }\n \n-        if (0 == encryptedColumnEncryptionKey.length) {\n-            throw new SQLServerException(SQLServerException.getErrString(\"R_EmptyEncryptedColumnEncryptionKey\"), null);\n+        public String getName() {\n+                return this.name;\n         }\n \n-        // Validate encryptionAlgorithm\n-        encryptionAlgorithm = this.validateEncryptionAlgorithm(encryptionAlgorithm);\n-\n-        // Validate whether the key is RSA one or not and then get the key size\n-        int keySizeInBytes = getAKVKeySize(masterKeyPath);\n-\n-        // Validate and decrypt the EncryptedColumnEncryptionKey\n-        // Format is\n-        // version + keyPathLength + ciphertextLength + keyPath + ciphertext + signature\n-        //\n-        // keyPath is present in the encrypted column encryption key for identifying the original source of the\n-        // asymmetric key pair and\n-        // we will not validate it against the data contained in the CMK metadata (masterKeyPath).\n-\n-        // Validate the version byte\n-        if (encryptedColumnEncryptionKey[0] != firstVersion[0]) {\n-            MessageFormat form = new MessageFormat(\n-                    SQLServerException.getErrString(\"R_InvalidEcryptionAlgorithmVersion\"));\n-            Object[] msgArgs = {String.format(\"%02X \", encryptedColumnEncryptionKey[0]),\n-                    String.format(\"%02X \", firstVersion[0])};\n-            throw new SQLServerException(this, form.format(msgArgs), null, 0, false);\n+        /**\n+         * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD using the client id and\n+         * client key. This is used by KeyVault client at runtime to authenticate to Azure Key Vault.\n+         * @param clientId Identifier of the client requesting the token.\n+         * @param clientKey Secret key of the client requesting the token.\n+         * @throws SQLServerException If either {@code clientId} or {@code clientKey} are {@code null}.\n+         */\n+        public SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId, String clientKey)\n+                throws SQLServerException {\n+                if (null == clientId || clientId.isEmpty()) {\n+                        MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+                        Object[] msgArgs1 = {\"Client ID\"};\n+                        throw new SQLServerException(form.format(msgArgs1), null);\n+                }\n+                if (null == clientKey || clientKey.isEmpty()) {\n+                        MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+                        Object[] msgArgs1 = {\"Client Key\"};\n+                        throw new SQLServerException(form.format(msgArgs1), null);\n+                }\n+\n+                keyVaultCredential = new KeyVaultCredential(clientId, clientKey);\n+                keyVaultPipeline = new KeyVaultHttpPipelineBuilder().credential(keyVaultCredential)\n+                        .buildPipeline();\n         }\n \n-        // Get key path length\n-        int currentIndex = firstVersion.length;\n-        short keyPathLength = convertTwoBytesToShort(encryptedColumnEncryptionKey, currentIndex);\n-        // We just read 2 bytes\n-        currentIndex += 2;\n-\n-        // Get ciphertext length\n-        short cipherTextLength = convertTwoBytesToShort(encryptedColumnEncryptionKey, currentIndex);\n-        currentIndex += 2;\n-\n-        // Skip KeyPath\n-        // KeyPath exists only for troubleshooting purposes and doesnt need validation.\n-        currentIndex += keyPathLength;\n-\n-        // validate the ciphertext length\n-        if (cipherTextLength != keySizeInBytes) {\n-            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_AKVKeyLengthError\"));\n-            Object[] msgArgs = {cipherTextLength, keySizeInBytes, masterKeyPath};\n-            throw new SQLServerException(this, form.format(msgArgs), null, 0, false);\n+        /**\n+         * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by\n+         * KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+         */\n+        SQLServerColumnEncryptionAzureKeyVaultProvider() throws SQLServerException {\n+                createKeyvaultClients(new ManagedIdentityCredentialBuilder().build());\n         }\n \n-        // Validate the signature length\n-        int signatureLength = encryptedColumnEncryptionKey.length - currentIndex - cipherTextLength;\n+        /**\n+         * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by\n+         * KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+         *\n+         * @param clientId Identifier of the client requesting the token.\n+         */\n+        SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId) throws SQLServerException {\n+                if (null == clientId || clientId.isEmpty()) {\n+                        MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+                        Object[] msgArgs1 = {\"Client ID\"};\n+                        throw new SQLServerException(form.format(msgArgs1), null);\n+                }\n+                createKeyvaultClients(new ManagedIdentityCredentialBuilder().clientId(clientId).build());\n+        }\n \n-        if (signatureLength != keySizeInBytes) {\n-            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_AKVSignatureLengthError\"));\n-            Object[] msgArgs = {signatureLength, keySizeInBytes, masterKeyPath};\n-            throw new SQLServerException(this, form.format(msgArgs), null, 0, false);\n+        /**\n+         * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider using the provided TokenCredential to\n+         * authenticate to AAD. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+         *\n+         * @param tokenCredential The TokenCredential to use to authenticate to Azure Key Vault.\n+         */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0953145cc7b3e61444fe92e372e57bc2b855c5"}, "originalPosition": 336}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDYwMDUzOnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzoyMDo0MFrOHLLfPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzo0NToxM1rOHL6a1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4NDYwNA==", "bodyText": "Could you confirm that these are production release versions?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481484604", "createdAt": "2020-09-01T23:20:40Z", "author": {"login": "ulvii"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.1.4</azure.keyvault.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5MDc5OQ==", "bodyText": "They appear to be:\nhttps://azure.github.io/azure-sdk-for-java/keyvault.html\nhttps://azure.github.io/azure-sdk-for-java/identity.html\nBut why not start with the latest versions?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481490799", "createdAt": "2020-09-01T23:40:11Z", "author": {"login": "David-Engel"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.1.4</azure.keyvault.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4NDYwNA=="}, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1MzUyNQ==", "bodyText": "Yes, these are production release versions but since we had made these changes a while ago, the versions were from a previous release. We now have new releases and I will update the PR to use the latest versions.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r482253525", "createdAt": "2020-09-02T17:45:13Z", "author": {"login": "srnagar"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.1.4</azure.keyvault.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4NDYwNA=="}, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDY1MjU2OnYy", "diffSide": "LEFT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0NToxOVrOHLL9mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0NToxOVrOHLL9mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5MjM3OA==", "bodyText": "We'll need to doc this. Since it's been deprecated for prior major version bumps, do we need to bump the major version for this change? I'm leaning towards yes.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481492378", "createdAt": "2020-09-01T23:45:19Z", "author": {"login": "David-Engel"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -84,76 +90,38 @@ public String getName() {\n     }\n \n     /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a client id and client key to authenticate to\n-     * AAD. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD using the client id and client\n+     * key. This is used by KeyVault client at runtime to authenticate to Azure Key Vault.\n      * \n      * @param clientId\n      *        Identifier of the client requesting the token.\n      * @param clientKey\n-     *        Key of the client requesting the token.\n+     *        Secret key of the client requesting the token.\n      * @throws SQLServerException\n-     *         when an error occurs\n+     *         If either {@code clientId} or {@code clientKey} are {@code null}.\n      */\n     public SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId, String clientKey) throws SQLServerException {\n-        credentials = new KeyVaultCredential(clientId, clientKey);\n-        keyVaultClient = new KeyVaultClient(credentials);\n-    }\n-\n-    /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD and\n-     * an executor service.. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n-     * This constructor is present to maintain backwards compatibility with 6.0 version of the driver. Deprecated for\n-     * removal in next stable release.\n-     * \n-     * @param authenticationCallback\n-     *        - Callback function used for authenticating to AAD.\n-     * @param executorService\n-     *        - The ExecutorService, previously used to create the keyVaultClient, but not in use anymore. - This\n-     *        parameter can be passed as 'null'\n-     * @throws SQLServerException\n-     *         when an error occurs\n-     */\n-    @Deprecated\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDY1NjEzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0NzowMVrOHLL_ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0NzowMVrOHLL_ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5Mjg5OQ==", "bodyText": "@lilgreenbird\nThis is not how we handle exception messages. Error messages need to be localized and also make sure to throw SQLServerException. Please make sure to change this in all occurrences.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481492899", "createdAt": "2020-09-01T23:47:01Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -5,86 +5,118 @@\n \n package com.microsoft.sqlserver.jdbc;\n \n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-\n-import com.microsoft.aad.adal4j.AuthenticationContext;\n-import com.microsoft.aad.adal4j.AuthenticationResult;\n-import com.microsoft.aad.adal4j.ClientCredential;\n-import com.microsoft.azure.keyvault.authentication.KeyVaultCredentials;\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n \n \n /**\n- * \n- * An implementation of ServiceClientCredentials that supports automatic bearer token refresh.\n- *\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n  */\n-class KeyVaultCredential extends KeyVaultCredentials {\n-\n-    SQLServerKeyVaultAuthenticationCallback authenticationCallback = null;\n-    String clientId = null;\n-    String clientKey = null;\n-    String accessToken = null;\n+@Immutable\n+class KeyVaultCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n \n-    KeyVaultCredential(String clientId) throws SQLServerException {\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application.\n+     */\n+    KeyVaultCredential(String clientId, String clientSecret) {\n+        Objects.requireNonNull(clientSecret, \"'clientSecret' cannot be null.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDY1OTQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0ODozNlrOHLMBjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo0ODozNlrOHLMBjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5MzM4OQ==", "bodyText": ". at the end.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481493389", "createdAt": "2020-09-01T23:48:36Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -5,86 +5,118 @@\n \n package com.microsoft.sqlserver.jdbc;\n \n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-\n-import com.microsoft.aad.adal4j.AuthenticationContext;\n-import com.microsoft.aad.adal4j.AuthenticationResult;\n-import com.microsoft.aad.adal4j.ClientCredential;\n-import com.microsoft.azure.keyvault.authentication.KeyVaultCredentials;\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n \n \n /**\n- * \n- * An implementation of ServiceClientCredentials that supports automatic bearer token refresh.\n- *\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n  */\n-class KeyVaultCredential extends KeyVaultCredentials {\n-\n-    SQLServerKeyVaultAuthenticationCallback authenticationCallback = null;\n-    String clientId = null;\n-    String clientKey = null;\n-    String accessToken = null;\n+@Immutable\n+class KeyVaultCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n \n-    KeyVaultCredential(String clientId) throws SQLServerException {\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDY2MjkzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ScopeTokenCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo1MDoyNlrOHLMDpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzo1MDoyNlrOHLMDpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5MzkyNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package com.microsoft.sqlserver.jdbc;\n          \n          \n            \n            /*\n          \n          \n            \n             * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n          \n          \n            \n             * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n          \n          \n            \n             */\n          \n          \n            \n            \n          \n          \n            \n            package com.microsoft.sqlserver.jdbc;", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481493924", "createdAt": "2020-09-01T23:50:26Z", "author": {"login": "David-Engel"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ScopeTokenCache.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.sqlserver.jdbc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDcwMjA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoxMDo0OFrOHLMaog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoxMDo0OFrOHLMaog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5OTgxMA==", "bodyText": "This is not how exception are handled in the driver, @lilgreenbird please make sure to follow the guidelines.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481499810", "createdAt": "2020-09-02T00:10:48Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -5,86 +5,118 @@\n \n package com.microsoft.sqlserver.jdbc;\n \n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-\n-import com.microsoft.aad.adal4j.AuthenticationContext;\n-import com.microsoft.aad.adal4j.AuthenticationResult;\n-import com.microsoft.aad.adal4j.ClientCredential;\n-import com.microsoft.azure.keyvault.authentication.KeyVaultCredentials;\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n \n \n /**\n- * \n- * An implementation of ServiceClientCredentials that supports automatic bearer token refresh.\n- *\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n  */\n-class KeyVaultCredential extends KeyVaultCredentials {\n-\n-    SQLServerKeyVaultAuthenticationCallback authenticationCallback = null;\n-    String clientId = null;\n-    String clientKey = null;\n-    String accessToken = null;\n+@Immutable\n+class KeyVaultCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n \n-    KeyVaultCredential(String clientId) throws SQLServerException {\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application.\n+     */\n+    KeyVaultCredential(String clientId, String clientSecret) {\n+        Objects.requireNonNull(clientSecret, \"'clientSecret' cannot be null.\");\n+        Objects.requireNonNull(clientSecret, \"'clientId' cannot be null.\");\n         this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n     }\n \n-    KeyVaultCredential() {}\n-\n-    KeyVaultCredential(String clientId, String clientKey) {\n-        this.clientId = clientId;\n-        this.clientKey = clientKey;\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        return authenticateWithConfidentialClientCache(request).onErrorResume(t -> Mono.empty())\n+                .switchIfEmpty(Mono.defer(() -> authenticateWithConfidentialClient(request)));\n     }\n \n-    KeyVaultCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n-        this.authenticationCallback = authenticationCallback;\n+    public KeyVaultCredential setAuthorization(String authorization) {\n+        if (null != this.authorization && this.authorization.equals(authorization)) {\n+            return this;\n+        }\n+        this.authorization = authorization;\n+        confidentialClientApplication = getConfidentialClientApplication();\n+        return this;\n     }\n \n-    public String doAuthenticate(String authorization, String resource, String scope) {\n-        String accessToken = null;\n-        if (null == authenticationCallback) {\n-            if (null == clientKey) {\n-                try {\n-                    SqlFedAuthToken token = SQLServerSecurityUtility.getMSIAuthToken(resource, clientId);\n-                    accessToken = (null != token) ? token.accessToken : null;\n-                } catch (Exception e) {\n-                    throw new RuntimeException(e);\n-                }\n-            } else {\n-                AuthenticationResult token = getAccessTokenFromClientCredentials(authorization, resource, clientId,\n-                        clientKey);\n-                accessToken = token.getAccessToken();\n-            }\n+    private ConfidentialClientApplication getConfidentialClientApplication() {\n+        if (null == clientId) {\n+            throw logger.logExceptionAsError(new IllegalArgumentException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDcyODQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyNDoxMFrOHLMqKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyNDoxMFrOHLMqKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMzc4Ng==", "bodyText": "Please pay attention  to public APIs. We don't want to create public APIs unless it is by design.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481503786", "createdAt": "2020-09-02T00:24:10Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCredential.java", "diffHunk": "@@ -5,86 +5,118 @@\n \n package com.microsoft.sqlserver.jdbc;\n \n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-\n-import com.microsoft.aad.adal4j.AuthenticationContext;\n-import com.microsoft.aad.adal4j.AuthenticationResult;\n-import com.microsoft.aad.adal4j.ClientCredential;\n-import com.microsoft.azure.keyvault.authentication.KeyVaultCredentials;\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n \n \n /**\n- * \n- * An implementation of ServiceClientCredentials that supports automatic bearer token refresh.\n- *\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n  */\n-class KeyVaultCredential extends KeyVaultCredentials {\n-\n-    SQLServerKeyVaultAuthenticationCallback authenticationCallback = null;\n-    String clientId = null;\n-    String clientKey = null;\n-    String accessToken = null;\n+@Immutable\n+class KeyVaultCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n \n-    KeyVaultCredential(String clientId) throws SQLServerException {\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application.\n+     */\n+    KeyVaultCredential(String clientId, String clientSecret) {\n+        Objects.requireNonNull(clientSecret, \"'clientSecret' cannot be null.\");\n+        Objects.requireNonNull(clientSecret, \"'clientId' cannot be null.\");\n         this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n     }\n \n-    KeyVaultCredential() {}\n-\n-    KeyVaultCredential(String clientId, String clientKey) {\n-        this.clientId = clientId;\n-        this.clientKey = clientKey;\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDgxOTgxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTowMzoyOVrOHLNjiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTowMzoyOVrOHLNjiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUxODQ3Mw==", "bodyText": "Driver should not throw a NullPointerException . Better add a null check to the constructor and throw SQLServerException .", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481518473", "createdAt": "2020-09-02T01:03:29Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "diffHunk": "@@ -134,10 +126,10 @@ public void testBadAkv(String serverName, String url, String protocol) throws Ex\n \n         try {\n             SQLServerColumnEncryptionAzureKeyVaultProvider akv = new SQLServerColumnEncryptionAzureKeyVaultProvider(\n-                    (SQLServerKeyVaultAuthenticationCallback) null);\n+                    (TokenCredential) null);\n             fail(TestResource.getResource(\"R_expectedExceptionNotThrown\"));\n-        } catch (SQLServerException e) {\n-            assertTrue(e.getMessage().matches(TestUtils.formatErrorMsg(\"R_NullValue\")));\n+        } catch (NullPointerException exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDgyMTEwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ScopeTokenCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTowNDoxNFrOHLNkSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTowNDoxNFrOHLNkSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUxODY2Nw==", "bodyText": "Need to add license header here.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481518667", "createdAt": "2020-09-02T01:04:14Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ScopeTokenCache.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.sqlserver.jdbc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDg3Njk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMToyODoyNVrOHLOGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMToyODoyNVrOHLOGmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUyNzQ1MQ==", "bodyText": "CamelCase here", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481527451", "createdAt": "2020-09-02T01:28:25Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -198,7 +182,7 @@ public SQLServerColumnEncryptionAzureKeyVaultProvider(\n         }\n \n         // Validate encryptionAlgorithm\n-        encryptionAlgorithm = this.validateEncryptionAlgorithm(encryptionAlgorithm);\n+        KeyWrapAlgorithm _encryptionAlgorithm = this.validateEncryptionAlgorithm(encryptionAlgorithm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 233}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDkwMjE4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultHttpPipelineBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTozNDo1M1rOHLOW4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzo0Njo1OFrOHL6ekQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUzMTYxNw==", "bodyText": "The methods in this class should probably not be public.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481531617", "createdAt": "2020-09-02T01:34:53Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultHttpPipelineBuilder.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.http.HttpPipeline;\n+import com.azure.core.http.HttpPipelineBuilder;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLoggingPolicy;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.HttpPolicyProviders;\n+import com.azure.core.http.policy.RetryPolicy;\n+import com.azure.core.http.policy.UserAgentPolicy;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+final class KeyVaultHttpPipelineBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1NDQ4MQ==", "bodyText": "I will change the visibility of these methods to package-private.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r482254481", "createdAt": "2020-09-02T17:46:58Z", "author": {"login": "srnagar"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultHttpPipelineBuilder.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.http.HttpPipeline;\n+import com.azure.core.http.HttpPipelineBuilder;\n+import com.azure.core.http.policy.HttpLogOptions;\n+import com.azure.core.http.policy.HttpLoggingPolicy;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.HttpPolicyProviders;\n+import com.azure.core.http.policy.RetryPolicy;\n+import com.azure.core.http.policy.UserAgentPolicy;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+final class KeyVaultHttpPipelineBuilder {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUzMTYxNw=="}, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDkwNDgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTozNTozNFrOHLOYgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTozNTozNFrOHLOYgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUzMjAzNQ==", "bodyText": "The methods in this class should probably not be public.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r481532035", "createdAt": "2020-09-02T01:35:34Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc675535eb3db983b094164a2b898855e6b57a7"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODk2Mzc0OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo0OToyNVrOHclhbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo0OToyNVrOHclhbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjk0MQ==", "bodyText": "There is a newer version of azure-identity available. 1.1.3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499736941", "createdAt": "2020-10-05T16:49:25Z", "author": {"login": "ulvii"}, "path": "build.gradle", "diffHunk": "@@ -127,15 +125,14 @@ dependencies {\n \t\t\t'org.junit.jupiter:junit-jupiter-api:5.6.0',\n \t\t\t'org.junit.jupiter:junit-jupiter-engine:5.6.0',\n \t\t\t'org.junit.jupiter:junit-jupiter-params:5.6.0',\n-\t\t\t'com.zaxxer:HikariCP:3.4.1',\n-\t\t\t'org.apache.commons:commons-dbcp2:2.6.0',\n+\t\t\t'com.zaxxer:HikariCP:3.4.2',\n+\t\t\t'org.apache.commons:commons-dbcp2:2.7.0',\n \t\t\t'org.slf4j:slf4j-nop:1.7.29',\n \t\t\t'org.antlr:antlr4-runtime:4.7.2',\n \t\t\t'org.eclipse.gemini.blueprint:gemini-blueprint-mock:2.1.0.RELEASE',\n \t\t\t'com.google.code.gson:gson:2.8.6',\n-\t\t\t'org.bouncycastle:bcprov-jdk15on:1.64',\n-\t\t\t'com.microsoft.azure:adal4j:1.6.4',\n-\t\t\t'com.microsoft.azure:azure-keyvault:1.2.2',\n-\t\t\t'com.microsoft.azure:azure-keyvault-webkey:1.2.1',\n+\t\t\t'org.bouncycastle:bcprov-jdk15on:1.65',\n+\t\t\t'com.azure:azure-security-keyvault-keys:4.2.0',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODk2NzY1OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1MDoyN1rOHcljyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1MDoyN1rOHcljyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNzU0NQ==", "bodyText": "There is a newer version of azure-security-keyvault-keys available: 4.2.1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499737545", "createdAt": "2020-10-05T16:50:27Z", "author": {"login": "ulvii"}, "path": "build.gradle", "diffHunk": "@@ -110,14 +110,12 @@ repositories {\n dependencies {\n \tcompile 'org.osgi:org.osgi.core:6.0.0',\n \t\t\t'org.osgi:org.osgi.compendium:5.0.0'\n-\tcompileOnly 'com.microsoft.azure:azure-keyvault:1.2.2',\n-\t\t\t'com.microsoft.azure:azure-keyvault-webkey:1.2.1',\n-\t\t\t'com.microsoft.rest:client-runtime:1.7.0',\n-\t\t\t'com.microsoft.azure:adal4j:1.6.4',\n+\tcompileOnly 'com.azure:azure-security-keyvault-keys:4.2.0',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODk3MzgxOnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1MjowNVrOHclnlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1MjowNVrOHclnlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczODUxNw==", "bodyText": "There is a newer version of azure-identity available. 1.1.3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499738517", "createdAt": "2020-10-05T16:52:05Z", "author": {"login": "ulvii"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.2.1</azure.keyvault.version>\n+\t\t<azure.identity.version>1.1.2</azure.identity.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAzNDQyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowOTozNlrOHcmNpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNjozOTo1OVrOHenKQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODI2MA==", "bodyText": "Can the url be HTTP? Also please add a . to the end of the error message.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499748260", "createdAt": "2020-10-05T17:09:36Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "diffHunk": "@@ -648,5 +648,6 @@ static String getResource(String key) {\n             {\"R_clientCertError\", \"Reading client certificate failed. Please verify the location of the certificate.\"},\n             {\"R_unassignableError\", \"The class specified by the {0} property must be assignable to {1}.\"},\n             {\"R_InvalidCSVQuotes\",\n-                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},};\n+                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},\n+            {\"R_TokenRequireUrl\", \"Token credentials require a URL using the HTTPS protocol scheme\"},};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1NDkyNA==", "bodyText": "I figured HTTP is not supported, so the question can be ignored.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499754924", "createdAt": "2020-10-05T17:21:29Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "diffHunk": "@@ -648,5 +648,6 @@ static String getResource(String key) {\n             {\"R_clientCertError\", \"Reading client certificate failed. Please verify the location of the certificate.\"},\n             {\"R_unassignableError\", \"The class specified by the {0} property must be assignable to {1}.\"},\n             {\"R_InvalidCSVQuotes\",\n-                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},};\n+                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},\n+            {\"R_TokenRequireUrl\", \"Token credentials require a URL using the HTTPS protocol scheme\"},};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODI2MA=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MDkzMQ==", "bodyText": "@lilgreenbird  please add . to the end of the error message.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r501860931", "createdAt": "2020-10-08T16:39:59Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "diffHunk": "@@ -648,5 +648,6 @@ static String getResource(String key) {\n             {\"R_clientCertError\", \"Reading client certificate failed. Please verify the location of the certificate.\"},\n             {\"R_unassignableError\", \"The class specified by the {0} property must be assignable to {1}.\"},\n             {\"R_InvalidCSVQuotes\",\n-                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},};\n+                    \"Failed to parse the CSV file, verify that the fields are correctly enclosed in double quotes.\"},\n+            {\"R_TokenRequireUrl\", \"Token credentials require a URL using the HTTPS protocol scheme\"},};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODI2MA=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTA2MjA0OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxNzoyNlrOHcmemw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODo1OToxN1rOHdV0mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjYwMw==", "bodyText": "When I load the project in Eclipse, I get  dependency conflicts. @lilgreenbird  I thought you had a fix for it, but can't see it on the PR?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499752603", "createdAt": "2020-10-05T17:17:26Z", "author": {"login": "ulvii"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.2.1</azure.keyvault.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyODI4MQ==", "bodyText": "It will still show some dependency conflicts, that happens when 2 libs depend on the same lib but diff versions. Maven resolves that in order of import, we see this in other libs as well unrelated to this PR. The issue that I fixed is an actual error caused by the azure-identity transitive dependency stax-api lib which caused a problem cos it accesses javax.xml and resulted in this \"javax.xml is accessible from more than one module\" error", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r500528281", "createdAt": "2020-10-06T18:59:17Z", "author": {"login": "lilgreenbird"}, "path": "pom.xml", "diffHunk": "@@ -60,9 +60,8 @@\n \t\t<releaseExt>-preview</releaseExt>\n \n \t\t<!-- Driver Dependencies -->\n-\t\t<azure.keyvault.version>1.2.4</azure.keyvault.version>\n-\t\t<azure.adal4j.version>1.6.5</azure.adal4j.version>\n-\t\t<rest.client.version>1.7.4</rest.client.version>\n+\t\t<azure.keyvault.version>4.2.1</azure.keyvault.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjYwMw=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTMyMDY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozNTowNVrOHcpBMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozNTowNVrOHcpBMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5NDIyNg==", "bodyText": "If only HTTPS supported lets change this to  if (!\"https\".equals(context.getHttpRequest().getUrl().getProtocol())) {", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499794226", "createdAt": "2020-10-05T18:35:05Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.http.HttpPipelineCallContext;\n+import com.azure.core.http.HttpPipelineNextPolicy;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.util.CoreUtils;\n+\n+import java.text.MessageFormat;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * A policy that authenticates requests with Azure Key Vault service.\n+ */\n+class KeyVaultCustomCredentialPolicy implements HttpPipelinePolicy {\n+    private static final String WWW_AUTHENTICATE = \"WWW-Authenticate\";\n+    private static final String BEARER_TOKEN_PREFIX = \"Bearer \";\n+    private static final String AUTHORIZATION = \"Authorization\";\n+    private final ScopeTokenCache cache;\n+    private final KeyVaultTokenCredential keyVaultTokenCredential;\n+\n+    /**\n+     * Creates KeyVaultCustomCredentialPolicy.\n+     *\n+     * @param credential\n+     *        the token credential to authenticate the request\n+     * @throws SQLServerException\n+     */\n+    KeyVaultCustomCredentialPolicy(KeyVaultTokenCredential credential) throws SQLServerException {\n+        if (null == credential) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Credential\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.cache = new ScopeTokenCache(credential::getToken);\n+        this.keyVaultTokenCredential = credential;\n+    }\n+\n+    /**\n+     * Adds the required header to authenticate a request to Azure Key Vault service.\n+     *\n+     * @param context\n+     *        The request context\n+     * @param next\n+     *        The next HTTP pipeline policy to process the {@code context's} request after this policy completes.\n+     * @return A {@link Mono} representing the HTTP response that will arrive asynchronously.\n+     */\n+    @Override\n+    public Mono<HttpResponse> process(HttpPipelineCallContext context, HttpPipelineNextPolicy next) {\n+        if (\"http\".equals(context.getHttpRequest().getUrl().getProtocol())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTM2MTcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODo0Nzo0MlrOHcpbIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoyMToxM1rOHdUawA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwMDg2NA==", "bodyText": "Please change this to multi-line comment.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499800864", "createdAt": "2020-10-05T18:47:42Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application\n+     * @throws SQLServerException\n+     */\n+    KeyVaultTokenCredential(String clientId, String clientSecret) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret || clientSecret.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n+        this.authenticationCallback = null;\n+    }\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param authenticationCallback The authentication callback that gets invoked when an access token is requested.\n+     */\n+    KeyVaultTokenCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n+        this.authenticationCallback = authenticationCallback;\n+        this.clientId = null;\n+        this.clientSecret = null;\n+    }\n+\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        if (null != authenticationCallback) {\n+            // If the callback is not null, invoke the callback to get the token. This gets invoked each time", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDg1OQ==", "bodyText": "Not resolved.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499904859", "createdAt": "2020-10-05T22:23:31Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application\n+     * @throws SQLServerException\n+     */\n+    KeyVaultTokenCredential(String clientId, String clientSecret) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret || clientSecret.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n+        this.authenticationCallback = null;\n+    }\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param authenticationCallback The authentication callback that gets invoked when an access token is requested.\n+     */\n+    KeyVaultTokenCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n+        this.authenticationCallback = authenticationCallback;\n+        this.clientId = null;\n+        this.clientSecret = null;\n+    }\n+\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        if (null != authenticationCallback) {\n+            // If the callback is not null, invoke the callback to get the token. This gets invoked each time", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwMDg2NA=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNTI4MA==", "bodyText": "sorry you're right, this change isn't merged to this PR yet..", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r500505280", "createdAt": "2020-10-06T18:21:13Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application\n+     * @throws SQLServerException\n+     */\n+    KeyVaultTokenCredential(String clientId, String clientSecret) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret || clientSecret.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n+        this.authenticationCallback = null;\n+    }\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param authenticationCallback The authentication callback that gets invoked when an access token is requested.\n+     */\n+    KeyVaultTokenCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n+        this.authenticationCallback = authenticationCallback;\n+        this.clientId = null;\n+        this.clientSecret = null;\n+    }\n+\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        if (null != authenticationCallback) {\n+            // If the callback is not null, invoke the callback to get the token. This gets invoked each time", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwMDg2NA=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTM5NjQyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODo1ODoxMVrOHcpxLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODo1ODoxMVrOHcpxLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwNjUxMQ==", "bodyText": "For consistency, please change this to use the driver's logger.  You can take a look at KerbAuthentication.java for reference usage.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499806511", "createdAt": "2020-10-05T18:58:11Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTY3Mzc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDoyMzo1NlrOHcseiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxMjowMFrOHcvhQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MDg4OQ==", "bodyText": "Could you explain why we log a warning here instead of an exception?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499850889", "createdAt": "2020-10-05T20:23:56Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application\n+     * @throws SQLServerException\n+     */\n+    KeyVaultTokenCredential(String clientId, String clientSecret) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret || clientSecret.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n+        this.authenticationCallback = null;\n+    }\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param authenticationCallback The authentication callback that gets invoked when an access token is requested.\n+     */\n+    KeyVaultTokenCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n+        this.authenticationCallback = authenticationCallback;\n+        this.clientId = null;\n+        this.clientSecret = null;\n+    }\n+\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        if (null != authenticationCallback) {\n+            // If the callback is not null, invoke the callback to get the token. This gets invoked each time\n+            // this method is called and will not cache the token. It's the callback's responsibility to return a valid\n+            // token each time it's invoked.\n+            String accessToken = authenticationCallback.getAccessToken(this.authorization, this.resource, this.scope);\n+            return Mono.just(new AccessToken(accessToken, OffsetDateTime.MIN));\n+        }\n+\n+        // gets the token from MSAL\n+        return authenticateWithConfidentialClientCache(request).onErrorResume(t -> Mono.empty())\n+                .switchIfEmpty(Mono.defer(() -> authenticateWithConfidentialClient(request)));\n+    }\n+\n+    /**\n+     * Sets the authority that will be used for authentication.\n+     *\n+     * @param authorization The name of the authorization.\n+     * @return The updated {@link KeyVaultTokenCredential} instance.\n+     */\n+    KeyVaultTokenCredential setAuthorization(String authorization) {\n+        if (null != this.authorization && this.authorization.equals(authorization)) {\n+            return this;\n+        }\n+        this.authorization = authorization;\n+        confidentialClientApplication = getConfidentialClientApplication();\n+        return this;\n+    }\n+\n+    /**\n+     * Creates an instance of {@link ConfidentialClientApplication} using the provided client id and secret.\n+     *\n+     * @return An instance of {@link ConfidentialClientApplication}.\n+     */\n+    private ConfidentialClientApplication getConfidentialClientApplication() {\n+        if (null == clientId) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == authorization) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Authorization\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        // Create the credential using the MSAL factory method.\n+        IClientCredential credential;\n+        credential = ClientCredentialFactory.createFromSecret(clientSecret);\n+        ConfidentialClientApplication.Builder applicationBuilder = ConfidentialClientApplication.builder(clientId,\n+                credential);\n+        try {\n+            applicationBuilder = applicationBuilder.authority(authorization);\n+        } catch (MalformedURLException e) {\n+            throw logger.logExceptionAsWarning(new IllegalStateException(e));\n+        }\n+        return applicationBuilder.build();\n+    }\n+\n+    /**\n+     * Attempts to get the access token from the client cache if it's not expired. If it's expired this returns an\n+     * empty response.\n+     * @param request The context for requesting the token including the scope.\n+     * @return The cached access token if it's not expired.\n+     */\n+    private Mono<AccessToken> authenticateWithConfidentialClientCache(TokenRequestContext request) {\n+        return Mono.fromFuture(() -> {\n+            SilentParameters.SilentParametersBuilder parametersBuilder = SilentParameters\n+                    .builder(new HashSet<>(request.getScopes()));\n+            try {\n+                return confidentialClientApplication.acquireTokenSilently(parametersBuilder.build());\n+            } catch (MalformedURLException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMDczOA==", "bodyText": "it doesn't it's actually throwing a RuntimeException and doesn't need to be logged as that's a fatal error", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499900738", "createdAt": "2020-10-05T22:12:00Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final ClientLogger logger = new ClientLogger(KeyVaultTokenCredential.class);\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param clientId\n+     *        the client ID of the application\n+     * @param clientSecret\n+     *        the secret value of the AAD application\n+     * @throws SQLServerException\n+     */\n+    KeyVaultTokenCredential(String clientId, String clientSecret) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret || clientSecret.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.clientId = clientId;\n+        this.clientSecret = clientSecret;\n+        this.authenticationCallback = null;\n+    }\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.\n+     *\n+     * @param authenticationCallback The authentication callback that gets invoked when an access token is requested.\n+     */\n+    KeyVaultTokenCredential(SQLServerKeyVaultAuthenticationCallback authenticationCallback) {\n+        this.authenticationCallback = authenticationCallback;\n+        this.clientId = null;\n+        this.clientSecret = null;\n+    }\n+\n+    @Override\n+    public Mono<AccessToken> getToken(TokenRequestContext request) {\n+        if (null != authenticationCallback) {\n+            // If the callback is not null, invoke the callback to get the token. This gets invoked each time\n+            // this method is called and will not cache the token. It's the callback's responsibility to return a valid\n+            // token each time it's invoked.\n+            String accessToken = authenticationCallback.getAccessToken(this.authorization, this.resource, this.scope);\n+            return Mono.just(new AccessToken(accessToken, OffsetDateTime.MIN));\n+        }\n+\n+        // gets the token from MSAL\n+        return authenticateWithConfidentialClientCache(request).onErrorResume(t -> Mono.empty())\n+                .switchIfEmpty(Mono.defer(() -> authenticateWithConfidentialClient(request)));\n+    }\n+\n+    /**\n+     * Sets the authority that will be used for authentication.\n+     *\n+     * @param authorization The name of the authorization.\n+     * @return The updated {@link KeyVaultTokenCredential} instance.\n+     */\n+    KeyVaultTokenCredential setAuthorization(String authorization) {\n+        if (null != this.authorization && this.authorization.equals(authorization)) {\n+            return this;\n+        }\n+        this.authorization = authorization;\n+        confidentialClientApplication = getConfidentialClientApplication();\n+        return this;\n+    }\n+\n+    /**\n+     * Creates an instance of {@link ConfidentialClientApplication} using the provided client id and secret.\n+     *\n+     * @return An instance of {@link ConfidentialClientApplication}.\n+     */\n+    private ConfidentialClientApplication getConfidentialClientApplication() {\n+        if (null == clientId) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == authorization) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Authorization\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        if (null == clientSecret) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Secret\"};\n+            throw new IllegalArgumentException(form.format(msgArgs1), null);\n+        }\n+\n+        // Create the credential using the MSAL factory method.\n+        IClientCredential credential;\n+        credential = ClientCredentialFactory.createFromSecret(clientSecret);\n+        ConfidentialClientApplication.Builder applicationBuilder = ConfidentialClientApplication.builder(clientId,\n+                credential);\n+        try {\n+            applicationBuilder = applicationBuilder.authority(authorization);\n+        } catch (MalformedURLException e) {\n+            throw logger.logExceptionAsWarning(new IllegalStateException(e));\n+        }\n+        return applicationBuilder.build();\n+    }\n+\n+    /**\n+     * Attempts to get the access token from the client cache if it's not expired. If it's expired this returns an\n+     * empty response.\n+     * @param request The context for requesting the token including the scope.\n+     * @return The cached access token if it's not expired.\n+     */\n+    private Mono<AccessToken> authenticateWithConfidentialClientCache(TokenRequestContext request) {\n+        return Mono.fromFuture(() -> {\n+            SilentParameters.SilentParametersBuilder parametersBuilder = SilentParameters\n+                    .builder(new HashSet<>(request.getScopes()));\n+            try {\n+                return confidentialClientApplication.acquireTokenSilently(parametersBuilder.build());\n+            } catch (MalformedURLException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MDg4OQ=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 159}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTY4OTgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDoyODoyM1rOHcsoAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDoyODoyM1rOHcsoAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MzMxMw==", "bodyText": "These variables shouldn't be public.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499853313", "createdAt": "2020-10-05T20:28:23Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -51,29 +56,35 @@\n \n     private final static java.util.logging.Logger akvLogger = java.util.logging.Logger\n             .getLogger(\"com.microsoft.sqlserver.jdbc.SQLServerColumnEncryptionAzureKeyVaultProvider\");\n+    public static final int KEY_NAME_INDEX = 4;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTcxNDgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerKeyVaultAuthenticationCallback.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDozNTo1NVrOHcs3CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDozNTo1NVrOHcs3CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1NzE2MQ==", "bodyText": "Please revert the changes to this file.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499857161", "createdAt": "2020-10-05T20:35:55Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerKeyVaultAuthenticationCallback.java", "diffHunk": "@@ -1,26 +1,26 @@\n-/*\n- * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n- * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n- */\n-\n-package com.microsoft.sqlserver.jdbc;\n-\n-/**\n- * Provides a callback delegate which is to be implemented by the client code\n- * \n- */\n-public interface SQLServerKeyVaultAuthenticationCallback {\n-\n-    /**\n-     * Returns the acesss token of the authentication request\n-     * \n-     * @param authority\n-     *        - Identifier of the authority, a URL.\n-     * @param resource\n-     *        - Identifier of the target resource that is the recipient of the requested token, a URL.\n-     * @param scope\n-     *        - The scope of the authentication request.\n-     * @return access token\n-     */\n-    String getAccessToken(String authority, String resource, String scope);\n-}\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+/**\r\n+ * Provides a callback delegate which is to be implemented by the client code\r\n+ *\r\n+ */\r\n+public interface SQLServerKeyVaultAuthenticationCallback {\r\n+\r\n+        /**\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTg0NjQxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMToxODozNlrOHcuJFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxMzowMFrOHcvixA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3ODE2NQ==", "bodyText": "Do we need to deprecate this public interface? If so, why?\nI do recall the previous discussion about removing it because we thought we couldn't support it via MSAL. But since we can support it, is there a compelling reason to push applications to the new interface?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499878165", "createdAt": "2020-10-05T21:18:36Z", "author": {"login": "David-Engel"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -124,56 +198,43 @@ public SQLServerColumnEncryptionAzureKeyVaultProvider(\n     /**\n      * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD. This\n      * is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n+     *\n      * @param authenticationCallback\n      *        - Callback function used for authenticating to AAD.\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTEyNA==", "bodyText": "no it doesn't anymore, I've removed that", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499901124", "createdAt": "2020-10-05T22:13:00Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -124,56 +198,43 @@ public SQLServerColumnEncryptionAzureKeyVaultProvider(\n     /**\n      * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD. This\n      * is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n+     *\n      * @param authenticationCallback\n      *        - Callback function used for authenticating to AAD.\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3ODE2NQ=="}, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTg1MzcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMToyMTowM1rOHcuNoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMToyMTowM1rOHcuNoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3OTMyOA==", "bodyText": "No need to deprecate this constructor anymore, because authenticationCallback works with MSAL now.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499879328", "createdAt": "2020-10-05T21:21:03Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -124,56 +198,43 @@ public SQLServerColumnEncryptionAzureKeyVaultProvider(\n     /**\n      * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD. This\n      * is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n-     * \n+     *\n      * @param authenticationCallback\n      *        - Callback function used for authenticating to AAD.\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c28d9844c1e30f210f1b685859396653a5d7363"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTk5MDkzOnYy", "diffSide": "LEFT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/fedauth/FedauthWithAE.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxMjowOVrOHcvhig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxMjowOVrOHcvhig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMDgxMA==", "bodyText": "This test should not be removed, it is the only test thats actually using SQLServerColumnEncryptionAzureKeyVaultProvider(authenticationCallback).", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499900810", "createdAt": "2020-10-05T22:12:09Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/fedauth/FedauthWithAE.java", "diffHunk": "@@ -128,7 +121,7 @@ public void testFedAuthWithAE_AKV() throws SQLException {\n             dropCMK(stmt, cmkName3);\r\n             setupCMK_AKVOld(cmkName3, stmt);\r\n \r\n-            createCEK(cmkName3, setupKeyStoreProvider_AKVOld(), stmt, keyIDs[0]);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDAwOTI4OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxOTo0NVrOHcvsLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxOTo0NVrOHcvsLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMzUzMg==", "bodyText": "In pom file azure-security-keyvault-keys version is 4.2.1, its 4.2.0 here.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499903532", "createdAt": "2020-10-05T22:19:45Z", "author": {"login": "ulvii"}, "path": "build.gradle", "diffHunk": "@@ -127,15 +125,14 @@ dependencies {\n \t\t\t'org.junit.jupiter:junit-jupiter-api:5.6.0',\n \t\t\t'org.junit.jupiter:junit-jupiter-engine:5.6.0',\n \t\t\t'org.junit.jupiter:junit-jupiter-params:5.6.0',\n-\t\t\t'com.zaxxer:HikariCP:3.4.1',\n-\t\t\t'org.apache.commons:commons-dbcp2:2.6.0',\n+\t\t\t'com.zaxxer:HikariCP:3.4.2',\n+\t\t\t'org.apache.commons:commons-dbcp2:2.7.0',\n \t\t\t'org.slf4j:slf4j-nop:1.7.29',\n \t\t\t'org.antlr:antlr4-runtime:4.7.2',\n \t\t\t'org.eclipse.gemini.blueprint:gemini-blueprint-mock:2.1.0.RELEASE',\n \t\t\t'com.google.code.gson:gson:2.8.6',\n-\t\t\t'org.bouncycastle:bcprov-jdk15on:1.64',\n-\t\t\t'com.microsoft.azure:adal4j:1.6.4',\n-\t\t\t'com.microsoft.azure:azure-keyvault:1.2.2',\n-\t\t\t'com.microsoft.azure:azure-keyvault-webkey:1.2.1',\n+\t\t\t'org.bouncycastle:bcprov-jdk15on:1.65',\n+\t\t\t'com.azure:azure-security-keyvault-keys:4.2.0',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDAzMDI2OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoyODo1M1rOHcv4jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoyODo1M1rOHcv4jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNjcwMw==", "bodyText": "What is the actual exception type here? is it being thrown as SQLServerException?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499906703", "createdAt": "2020-10-05T22:28:53Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/MSITest.java", "diffHunk": "@@ -299,7 +300,9 @@ public void testNumericAkvWithBadCred() throws SQLException {\n             testNumericAKV(connStr);\r\n             fail(TestResource.getResource(\"R_expectedFailPassed\"));\r\n         } catch (Exception e) {\r\n-            assert (e.getMessage().contains(\"AuthenticationException\"));\r\n+            assertTrue(e.getCause() instanceof MsalServiceException);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDA5MTY2OnYy", "diffSide": "LEFT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjo1Nzo1OFrOHcwdoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNzozNjoyN1rOHfS-kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNjE5Mg==", "bodyText": "Please do not remove this test, it is still valid.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499916192", "createdAt": "2020-10-05T22:57:58Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "diffHunk": "@@ -91,18 +92,15 @@ public void testJksName(String serverName, String url, String protocol) throws E\n      */\n     @ParameterizedTest\n     @MethodSource(\"enclaveParams\")\n+    @Tag(Constants.reqExternalSetup)\n     public void testAkvName(String serverName, String url, String protocol) throws Exception {\n         setAEConnectionString(serverName, url, protocol);\n \n-        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3ODgzMw==", "bodyText": "this is not removed, it's been renamed to testAkvNameWithAuthCallback", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r502578833", "createdAt": "2020-10-09T17:36:27Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "diffHunk": "@@ -91,18 +92,15 @@ public void testJksName(String serverName, String url, String protocol) throws E\n      */\n     @ParameterizedTest\n     @MethodSource(\"enclaveParams\")\n+    @Tag(Constants.reqExternalSetup)\n     public void testAkvName(String serverName, String url, String protocol) throws Exception {\n         setAEConnectionString(serverName, url, protocol);\n \n-        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNjE5Mg=="}, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDA5ODc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzowMToxM1rOHcwhww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzowMToxM1rOHcwhww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNzI1MQ==", "bodyText": "There is no tests for this constructor, please add a few tests. I could only find one test, which only tests bad AKV name.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499917251", "createdAt": "2020-10-05T23:01:13Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -84,96 +95,126 @@ public String getName() {\n     }\n \n     /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a client id and client key to authenticate to\n-     * AAD. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD using the client id and client\n+     * key. This is used by KeyVault client at runtime to authenticate to Azure Key Vault.\n      * \n      * @param clientId\n      *        Identifier of the client requesting the token.\n      * @param clientKey\n-     *        Key of the client requesting the token.\n+     *        Secret key of the client requesting the token.\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n     public SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId, String clientKey) throws SQLServerException {\n-        credentials = new KeyVaultCredential(clientId, clientKey);\n-        keyVaultClient = new KeyVaultClient(credentials);\n+        if (null == clientId || clientId.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client ID\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+        if (null == clientKey || clientKey.isEmpty()) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Client Key\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        // create a token credential with given client id and secret which internally identifies the tenant id.\n+        keyVaultTokenCredential = new KeyVaultTokenCredential(clientId, clientKey);\n+        // create the pipeline with the custom Key Vault credential\n+        keyVaultPipeline = new KeyVaultHttpPipelineBuilder().credential(keyVaultTokenCredential).buildPipeline();\n     }\n \n     /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD and\n-     * an executor service.. This is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by KeyVault\n+     * client at runtime to authenticate to Azure Key Vault.\n      * \n-     * This constructor is present to maintain backwards compatibility with 6.0 version of the driver. Deprecated for\n-     * removal in next stable release.\n-     * \n-     * @param authenticationCallback\n-     *        - Callback function used for authenticating to AAD.\n-     * @param executorService\n-     *        - The ExecutorService, previously used to create the keyVaultClient, but not in use anymore. - This\n-     *        parameter can be passed as 'null'\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n-    @Deprecated\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(\n-            SQLServerKeyVaultAuthenticationCallback authenticationCallback,\n-            ExecutorService executorService) throws SQLServerException {\n-        this(authenticationCallback);\n+    SQLServerColumnEncryptionAzureKeyVaultProvider() throws SQLServerException {\n+        setCredential(new ManagedIdentityCredentialBuilder().build());\n     }\n \n     /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider with a callback function to authenticate to AAD. This\n-     * is used by KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by KeyVault\n+     * client at runtime to authenticate to Azure Key Vault.\n+     *\n+     * @param clientId\n+     *        Identifier of the client requesting the token.\n      * \n-     * @param authenticationCallback\n-     *        - Callback function used for authenticating to AAD.\n      * @throws SQLServerException\n      *         when an error occurs\n      */\n-    public SQLServerColumnEncryptionAzureKeyVaultProvider(\n-            SQLServerKeyVaultAuthenticationCallback authenticationCallback) throws SQLServerException {\n-        if (null == authenticationCallback) {\n+    SQLServerColumnEncryptionAzureKeyVaultProvider(String clientId) throws SQLServerException {\n+        if (null == clientId || clientId.isEmpty()) {\n             MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n-            Object[] msgArgs1 = {\"SQLServerKeyVaultAuthenticationCallback\"};\n+            Object[] msgArgs1 = {\"Client ID\"};\n             throw new SQLServerException(form.format(msgArgs1), null);\n         }\n-        credentials = new KeyVaultCredential(authenticationCallback);\n-        RestClient restClient = new RestClient.Builder(new OkHttpClient.Builder(), new Retrofit.Builder())\n-                .withBaseUrl(baseUrl).withCredentials(credentials).withSerializerAdapter(new AzureJacksonAdapter())\n-                .withResponseBuilderFactory(new AzureResponseBuilder.Factory()).build();\n-        keyVaultClient = new KeyVaultClient(restClient);\n+        setCredential(new ManagedIdentityCredentialBuilder().clientId(clientId).build());\n     }\n \n     /**\n-     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider to authenticate to AAD. This is used by\n-     * KeyVaultClient at runtime to authenticate to Azure Key Vault.\n+     * Constructs a SQLServerColumnEncryptionAzureKeyVaultProvider using the provided TokenCredential to authenticate to\n+     * AAD. This is used by KeyVault client at runtime to authenticate to Azure Key Vault.\n+     *\n+     * @param tokenCredential\n+     *        The TokenCredential to use to authenticate to Azure Key Vault.\n      * \n      * @throws SQLServerException\n      *         when an error occurs\n      */\n-    SQLServerColumnEncryptionAzureKeyVaultProvider() throws SQLServerException {\n-        credentials = new KeyVaultCredential();\n-        keyVaultClient = new KeyVaultClient(credentials);\n+    public SQLServerColumnEncryptionAzureKeyVaultProvider(TokenCredential tokenCredential) throws SQLServerException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDE2NjI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozNDoxOVrOHcxJCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozNDoxOVrOHcxJCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyNzMwNg==", "bodyText": "This is very interesting syntax but can we either link a source for a spec detailing why we want these specific fields or add some comments to explain. The string field names should also be changed to constants incase it changes in the future.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499927306", "createdAt": "2020-10-05T23:34:19Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultCustomCredentialPolicy.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.http.HttpPipelineCallContext;\n+import com.azure.core.http.HttpPipelineNextPolicy;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.util.CoreUtils;\n+\n+import java.text.MessageFormat;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * A policy that authenticates requests with Azure Key Vault service.\n+ */\n+class KeyVaultCustomCredentialPolicy implements HttpPipelinePolicy {\n+    private static final String WWW_AUTHENTICATE = \"WWW-Authenticate\";\n+    private static final String BEARER_TOKEN_PREFIX = \"Bearer \";\n+    private static final String AUTHORIZATION = \"Authorization\";\n+    private final ScopeTokenCache cache;\n+    private final KeyVaultTokenCredential keyVaultTokenCredential;\n+\n+    /**\n+     * Creates KeyVaultCustomCredentialPolicy.\n+     *\n+     * @param credential\n+     *        the token credential to authenticate the request\n+     * @throws SQLServerException\n+     */\n+    KeyVaultCustomCredentialPolicy(KeyVaultTokenCredential credential) throws SQLServerException {\n+        if (null == credential) {\n+            MessageFormat form = new MessageFormat(SQLServerException.getErrString(\"R_NullValue\"));\n+            Object[] msgArgs1 = {\"Credential\"};\n+            throw new SQLServerException(form.format(msgArgs1), null);\n+        }\n+\n+        this.cache = new ScopeTokenCache(credential::getToken);\n+        this.keyVaultTokenCredential = credential;\n+    }\n+\n+    /**\n+     * Adds the required header to authenticate a request to Azure Key Vault service.\n+     *\n+     * @param context\n+     *        The request context\n+     * @param next\n+     *        The next HTTP pipeline policy to process the {@code context's} request after this policy completes.\n+     * @return A {@link Mono} representing the HTTP response that will arrive asynchronously.\n+     */\n+    @Override\n+    public Mono<HttpResponse> process(HttpPipelineCallContext context, HttpPipelineNextPolicy next) {\n+        if (\"http\".equals(context.getHttpRequest().getUrl().getProtocol())) {\n+            return Mono.error(new RuntimeException(SQLServerException.getErrString(\"R_TokenRequireUrl\")));\n+        }\n+\n+        return next.clone().process()\n+                // Ignore body\n+                .doOnNext(HttpResponse::close).map(res -> res.getHeaderValue(WWW_AUTHENTICATE))\n+                .map(header -> extractChallenge(header, BEARER_TOKEN_PREFIX)).flatMap(map -> {\n+                    keyVaultTokenCredential.setAuthorization(map.get(\"authorization\"));\n+                    keyVaultTokenCredential.setResource(map.get(\"resource\"));\n+                    keyVaultTokenCredential.setScope(map.get(\"scope\"));\n+                    cache.setRequest(new TokenRequestContext().addScopes(map.get(\"resource\") + \"/.default\"));\n+                    return cache.getToken();\n+                }).flatMap(token -> {\n+                    context.getHttpRequest().setHeader(AUTHORIZATION, BEARER_TOKEN_PREFIX + token.getToken());\n+                    return next.process();\n+                });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDE3MTQ4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozNzoxMVrOHcxMGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozNzoxMVrOHcxMGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyODA4OA==", "bodyText": "None of these new tests seem to actually test authenticationCallback .As far as I understand, driver applications will be able to implement  SQLServerKeyVaultAuthenticationCallback.getAccessToken() API in 2 ways:\n\nUsing adal4j library, see the sample here.\nUsing msal4j library, as implemented below.\nRegardless of which method the application chooses to use, the driver needs to be able to handle both. Please add appropriate tests for both scenarios. Make sure to use actual CEKs/CMK to encrypt/decrypt instead of using empty CEK.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499928088", "createdAt": "2020-10-05T23:37:11Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "diffHunk": "@@ -2244,22 +2234,69 @@ void testNumerics(SQLServerStatement stmt, String cekName, String[][] table, Str\n         }\n     }\n \n-    SQLServerKeyVaultAuthenticationCallback authenticationCallback = new SQLServerKeyVaultAuthenticationCallback() {\n-        // @Override\n-        ExecutorService service = Executors.newFixedThreadPool(2);\n+    @ParameterizedTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDE3NTA4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozOTozOFrOHcxOdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzozOTozOFrOHcxOdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyODY5Mw==", "bodyText": "Again, we are not removing the SQLServerKeyVaultAuthenticationCallback anymore, so keep this test as it is and add a test for TokenCredential separately.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499928693", "createdAt": "2020-10-05T23:39:38Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/AlwaysEncrypted/JDBCEncryptionDecryptionTest.java", "diffHunk": "@@ -134,7 +132,7 @@ public void testBadAkv(String serverName, String url, String protocol) throws Ex\n \n         try {\n             SQLServerColumnEncryptionAzureKeyVaultProvider akv = new SQLServerColumnEncryptionAzureKeyVaultProvider(\n-                    (SQLServerKeyVaultAuthenticationCallback) null);\n+                    (TokenCredential) null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDYzNjE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDoyNDowNVrOHc1dXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDoyNDowNVrOHc1dXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5ODA0Ng==", "bodyText": "Shouldn't the comment here and below for the constructors say \"Creates a KeyVaultTokenCredential\" instead of \"Creates  a KeyVaultCredential\"?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r499998046", "createdAt": "2020-10-06T04:24:05Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/KeyVaultTokenCredential.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\n+ */\n+\n+package com.microsoft.sqlserver.jdbc;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.microsoft.aad.msal4j.ClientCredentialFactory;\n+import com.microsoft.aad.msal4j.ClientCredentialParameters;\n+import com.microsoft.aad.msal4j.ConfidentialClientApplication;\n+import com.microsoft.aad.msal4j.IAuthenticationResult;\n+import com.microsoft.aad.msal4j.IClientCredential;\n+import com.microsoft.aad.msal4j.SilentParameters;\n+import java.net.MalformedURLException;\n+import java.text.MessageFormat;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneOffset;\n+import java.util.HashSet;\n+import java.util.concurrent.CompletableFuture;\n+import reactor.core.publisher.Mono;\n+\n+\n+/**\n+ * An AAD credential that acquires a token with a client secret for an AAD application.\n+ */\n+@Immutable\n+class KeyVaultTokenCredential implements TokenCredential {\n+    private final String clientId;\n+    private final String clientSecret;\n+    private final SQLServerKeyVaultAuthenticationCallback authenticationCallback;\n+    private String authorization;\n+    private ConfidentialClientApplication confidentialClientApplication;\n+    private String resource;\n+    private String scope;\n+\n+    /**\n+     * Creates a KeyVaultCredential with the given identity client options.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d509af9f2c34faf3eb5636654af974d1e5528f5"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDYyOTc2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMjoyMDozMVrOHdb8hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMjoyMDozMVrOHdb8hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYyODYxMw==", "bodyText": "Can just declare private static final List<String> akvTrustedEndpoints = getTrustedEndpoints(); since getTrustedEndpoints is static.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r500628613", "createdAt": "2020-10-06T22:20:31Z", "author": {"login": "rene-ye"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerColumnEncryptionAzureKeyVaultProvider.java", "diffHunk": "@@ -51,29 +55,35 @@\n \n     private final static java.util.logging.Logger akvLogger = java.util.logging.Logger\n             .getLogger(\"com.microsoft.sqlserver.jdbc.SQLServerColumnEncryptionAzureKeyVaultProvider\");\n+    private static final int KEY_NAME_INDEX = 4;\n+    private static final int KEY_URL_SPLIT_LENGTH_WITH_VERSION = 6;\n+    private static final String KEY_URL_DELIMITER = \"/\";\n+    private HttpPipeline keyVaultPipeline;\n+    private KeyVaultTokenCredential keyVaultTokenCredential;\n+\n     /**\n      * Column Encryption Key Store Provider string\n      */\n     String name = \"AZURE_KEY_VAULT\";\n \n-    private final String baseUrl = \"https://{vaultBaseUrl}\";\n-\n     private static final String MSSQL_JDBC_PROPERTIES = \"mssql-jdbc.properties\";\n     private static final String AKV_TRUSTED_ENDPOINTS_KEYWORD = \"AKVTrustedEndpoints\";\n+    private static final String RSA_ENCRYPTION_ALGORITHM_WITH_OAEP_FOR_AKV = \"RSA-OAEP\";\n+\n     private static final List<String> akvTrustedEndpoints;\n-    static {\n-        akvTrustedEndpoints = getTrustedEndpoints();\n-    }\n-    private final String rsaEncryptionAlgorithmWithOAEPForAKV = \"RSA-OAEP\";\n \n     /**\n      * Algorithm version\n      */\n     private final byte[] firstVersion = new byte[] {0x01};\n \n-    private KeyVaultClient keyVaultClient;\n+    private Map<String, KeyClient> cachedKeyClients = new ConcurrentHashMap<>();\n+    private Map<String, CryptographyClient> cachedCryptographyClients = new ConcurrentHashMap<>();\n+    private TokenCredential credential;\n \n-    private KeyVaultCredential credentials;\n+    static {\n+        akvTrustedEndpoints = getTrustedEndpoints();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38cc336d505b58956d9674881763d5b9b70937"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzYwNjAxOnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0NTowMlrOHgwQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0NTowMlrOHgwQQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzA3Mg==", "bodyText": "This is supposed to be 1.1.3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r504107072", "createdAt": "2020-10-13T16:45:02Z", "author": {"login": "ulvii"}, "path": "build.gradle", "diffHunk": "@@ -110,14 +110,12 @@ repositories {\n dependencies {\n \tcompile 'org.osgi:org.osgi.core:6.0.0',\n \t\t\t'org.osgi:org.osgi.compendium:5.0.0'\n-\tcompileOnly 'com.microsoft.azure:azure-keyvault:1.2.2',\n-\t\t\t'com.microsoft.azure:azure-keyvault-webkey:1.2.1',\n-\t\t\t'com.microsoft.rest:client-runtime:1.7.0',\n-\t\t\t'com.microsoft.azure:adal4j:1.6.4',\n+\tcompileOnly 'com.azure:azure-security-keyvault-keys:4.2.1',\n+\t\t\t'com.azure:azure-identity:1.1.0',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a011ea785fa37b356746671fa1d06ae99f5274f4"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1ODAyMTIyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMjowNVrOHg0Q7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMjowNVrOHg0Q7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3Mjc4Mg==", "bodyText": "Please search for ADAL in SQLServerResource and make similar changes to the error messages that mentioned ADAL.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1413#discussion_r504172782", "createdAt": "2020-10-13T18:32:05Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java", "diffHunk": "@@ -404,7 +404,7 @@ static String getResource(String key) {\n                     \"FEDAUTHINFO token stream is not long enough ({0}) to contain the data it claims to.\"},\n             {\"R_FedAuthInfoDoesNotContainStsurlAndSpn\",\n                     \"FEDAUTHINFO token stream does not contain both STSURL and SPN.\"},\n-            {\"R_ADALExecution\", \"Failed to authenticate the user {0} in Active Directory (Authentication={1}).\"},\n+            {\"R_MSALExecution\", \"Failed to authenticate the user {0} in Active Directory (Authentication={1}).\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a011ea785fa37b356746671fa1d06ae99f5274f4"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1153, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}