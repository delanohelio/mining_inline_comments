{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NDk2OTMz", "number": 1371, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzozOToyMVrOEJwzug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDo0OTozM1rOELU36A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjcyMzE0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzozOToyMVrOGqbV4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MToxMVrOGqndyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0MTM0Ng==", "bodyText": "It's not a real concern as it's a scenario that'd happen if someone really wanted to break this logic, but our driver takes the last instance of the value. So if you declare columnEncryptionSetting=enabled;columnEncryptionSetting=disabled, this logic would detect it's on even though it's off.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447141346", "createdAt": "2020-06-29T17:39:21Z", "author": {"login": "rene-ye"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -224,7 +224,18 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.execute();\n             } catch (SQLException e) {\n                 if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n-                    fail(e.getMessage());\n+                    // diff error msg if AE enabled\n+                    int start = connectionString.toUpperCase().indexOf(Constants.COLUMN_ENCRYPTION_SETTING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzOTk3Ng==", "bodyText": "Looks like you are trying to check if AE is enabled. You can simply use ds.getColumnEncryptionSetting().", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447339976", "createdAt": "2020-06-30T00:41:11Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -224,7 +224,18 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.execute();\n             } catch (SQLException e) {\n                 if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n-                    fail(e.getMessage());\n+                    // diff error msg if AE enabled\n+                    int start = connectionString.toUpperCase().indexOf(Constants.COLUMN_ENCRYPTION_SETTING);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0MTM0Ng=="}, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODAxMjgzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/unit/statement/PreparedStatementTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MTozNFrOGqnePA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MTozNFrOGqnePA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDA5Mg==", "bodyText": "Same here, use  ds.getColumnEncryptionSetting()", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447340092", "createdAt": "2020-06-30T00:41:34Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/unit/statement/PreparedStatementTest.java", "diffHunk": "@@ -647,6 +648,17 @@ private void testStatementPoolingInternal(String mode) throws Exception {\n                 assertNotSame(0, handle);\n             }\n \n+            // AE has 1 more prepared statement handle as it calls sp_describe_parameter_encryption\n+            int start = connectionString.toUpperCase().indexOf(Constants.COLUMN_ENCRYPTION_SETTING);\n+            if (-1 != start) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODAxNDA3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MjoyMVrOGqne9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MjoyMVrOGqne9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDI3OA==", "bodyText": "Different error message if AE is enabled.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447340278", "createdAt": "2020-06-30T00:42:21Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -224,7 +224,18 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.execute();\n             } catch (SQLException e) {\n                 if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n-                    fail(e.getMessage());\n+                    // diff error msg if AE enabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODAxNDk3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/preparedStatement/BatchExecutionWithBulkCopyTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0Mjo0OFrOGqnfcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMDoyMzowM1rOGsgWFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDQwMg==", "bodyText": "Can you explain why you have to do this?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447340402", "createdAt": "2020-06-30T00:42:48Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/preparedStatement/BatchExecutionWithBulkCopyTest.java", "diffHunk": "@@ -570,7 +571,7 @@ public void testIllegalNumberOfArgNoColumnList() throws Exception {\n \n             pstmt.executeBatch();\n             fail(TestResource.getResource(\"R_expectedExceptionNotThrown\"));\n-        } catch (BatchUpdateException e) {\n+        } catch (BatchUpdateException | SQLServerException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyMDQ2OQ==", "bodyText": "fails thru a different code path for AE", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r449320469", "createdAt": "2020-07-03T00:23:03Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/preparedStatement/BatchExecutionWithBulkCopyTest.java", "diffHunk": "@@ -570,7 +571,7 @@ public void testIllegalNumberOfArgNoColumnList() throws Exception {\n \n             pstmt.executeBatch();\n             fail(TestResource.getResource(\"R_expectedExceptionNotThrown\"));\n-        } catch (BatchUpdateException e) {\n+        } catch (BatchUpdateException | SQLServerException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDQwMg=="}, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4ODAxNjIwOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0MzoyM1rOGqngJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQyMzo1NDozNlrOGsf9cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDU4Mg==", "bodyText": "Can you explain why this error message is thrown?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r447340582", "createdAt": "2020-06-30T00:43:23Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -224,7 +224,18 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.execute();\n             } catch (SQLException e) {\n                 if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n-                    fail(e.getMessage());\n+                    // diff error msg if AE enabled\n+                    int start = connectionString.toUpperCase().indexOf(Constants.COLUMN_ENCRYPTION_SETTING);\n+                    if (-1 != start) {\n+                        int end = connectionString.indexOf(\";\", start);\n+                        String value = connectionString.substring(\n+                                start + Constants.COLUMN_ENCRYPTION_SETTING.length() + 1,\n+                                (-1 != end) ? end : connectionString.length());\n+                        if (value.equalsIgnoreCase(Constants.ENABLED)\n+                                && !e.getMessage().contains(TestResource.getResource(\"R_incorrectSyntaxP0\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxNDE2MA==", "bodyText": "that's the error returned by sql server when columns are encrypted", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r449314160", "createdAt": "2020-07-02T23:54:36Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -224,7 +224,18 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.execute();\n             } catch (SQLException e) {\n                 if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n-                    fail(e.getMessage());\n+                    // diff error msg if AE enabled\n+                    int start = connectionString.toUpperCase().indexOf(Constants.COLUMN_ENCRYPTION_SETTING);\n+                    if (-1 != start) {\n+                        int end = connectionString.indexOf(\";\", start);\n+                        String value = connectionString.substring(\n+                                start + Constants.COLUMN_ENCRYPTION_SETTING.length() + 1,\n+                                (-1 != end) ? end : connectionString.length());\n+                        if (value.equalsIgnoreCase(Constants.ENABLED)\n+                                && !e.getMessage().contains(TestResource.getResource(\"R_incorrectSyntaxP0\"))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MDU4Mg=="}, "originalCommit": {"oid": "1a3a3435ec11b7816dc1dcd24d0e41340b87ea24"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMzExNzg0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDo0OTozM1rOGs3lbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDo0OTozM1rOGs3lbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwMTIzMA==", "bodyText": "Will this ever pass ? Don't you need to || (or)?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1371#discussion_r449701230", "createdAt": "2020-07-03T20:49:33Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/tvp/TVPResultSetCursorTest.java", "diffHunk": "@@ -223,12 +223,14 @@ public void testInvalidStoredProcedureName() throws SQLException {\n                 pstmt.setStructured(1, tvpName, rs);\n                 pstmt.execute();\n             } catch (SQLException e) {\n-                if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))) {\n+                if (!e.getMessage().contains(TestResource.getResource(\"R_StoredProcedureNotFound\"))\n+                        && !(ds.getColumnEncryptionSetting().equalsIgnoreCase(Constants.ENABLED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1e7ab11b9503a2bba5e8c42ebe074db7921160"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1119, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}