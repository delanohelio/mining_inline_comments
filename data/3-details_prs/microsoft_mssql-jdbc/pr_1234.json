{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDM2Mzk3", "number": 1234, "title": "Release | Fixed issued reported by SonarQube ", "bodyText": "", "createdAt": "2020-01-20T23:30:58Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234", "merged": true, "mergeCommit": {"oid": "f5f582d422a4a430fa9340799913225f4ec82feb"}, "closed": true, "closedAt": "2020-01-23T19:20:11Z", "author": {"login": "rene-ye"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8VIICAH2gAyMzY1MDM2Mzk3OjVjMjc2MjE2ZmMwNDcyNWM2OWI2MzcxNjNjNmYzZTcyNTJmNjUwMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9PYE5gFqTM0NzU0NTc4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c276216fc04725c69b637163c6f3e7252f65015", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/5c276216fc04725c69b637163c6f3e7252f65015", "committedDate": "2020-01-20T23:27:16Z", "message": "SonarQube fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTcyNzM2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-345572736", "createdAt": "2020-01-20T23:38:11Z", "commit": {"oid": "5c276216fc04725c69b637163c6f3e7252f65015"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMzozODoxMlrOFfrPqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMzozODoxMlrOFfrPqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc1ODY5Ng==", "bodyText": "shouldn't this be !\"\".equals(sql)?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r368758696", "createdAt": "2020-01-20T23:38:12Z", "author": {"login": "peterbae"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -6202,7 +6202,7 @@ void writeRPCReaderUnicode(String sName, Reader re, long reLength, boolean bOut,\n \n     void sendEnclavePackage(String sql, ArrayList<byte[]> enclaveCEKs) throws SQLServerException {\n         if (null != con && con.isAEv2()) {\n-            if (null != sql && \"\" != sql && null != enclaveCEKs && 0 < enclaveCEKs.size() && con.enclaveEstablished()) {\n+            if (null != sql && \"\".equals(sql) && null != enclaveCEKs && 0 < enclaveCEKs.size() && con.enclaveEstablished()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c276216fc04725c69b637163c6f3e7252f65015"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/427911c408873f5c6d67c940e12a00232502c60b", "committedDate": "2020-01-21T17:28:58Z", "message": "Fix resource leak in AE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODU5NTU5", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346859559", "createdAt": "2020-01-22T19:52:58Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTUzNzAy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346953702", "createdAt": "2020-01-22T22:37:39Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozNzozOVrOFgtesg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozNzozOVrOFgtesg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Mzg5MA==", "bodyText": "!connection.enclaveEstablished() is removed, is that intentional?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r369843890", "createdAt": "2020-01-22T22:37:39Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerVSMEnclaveProvider.java", "diffHunk": "@@ -139,33 +140,27 @@ private VSMAttestationResponse validateAttestationResponse(VSMAttestationRespons\n             String preparedTypeDefinitions, Parameter[] params,\n             ArrayList<String> parameterNames) throws SQLServerException {\n         ArrayList<byte[]> enclaveRequestedCEKs = new ArrayList<>();\n-        ResultSet rs = null;\n         try (PreparedStatement stmt = connection.prepareStatement(connection.enclaveEstablished() ? SDPE1 : SDPE2)) {\n-            if (connection.enclaveEstablished()) {\n-                rs = executeSDPEv1(stmt, userSql, preparedTypeDefinitions);\n-            } else {\n-                rs = executeSDPEv2(stmt, userSql, preparedTypeDefinitions, vsmParams);\n-            }\n-            if (null == rs) {\n-                // No results. Meaning no parameter.\n-                // Should never happen.\n-                return enclaveRequestedCEKs;\n-            }\n-            processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n-                    enclaveRequestedCEKs);\n-            // Process the third resultset.\n-            if (connection.isAEv2() && stmt.getMoreResults()) {\n-                rs = (SQLServerResultSet) stmt.getResultSet();\n-                while (rs.next()) {\n-                    hgsResponse = new VSMAttestationResponse(rs.getBytes(1));\n-                    // This validates and establishes the enclave session if valid\n-                    if (!connection.enclaveEstablished()) {\n-                        hgsResponse = validateAttestationResponse(hgsResponse);\n+            try (ResultSet rs = connection.enclaveEstablished() ? executeSDPEv1(stmt, userSql,\n+                    preparedTypeDefinitions) : executeSDPEv2(stmt, userSql, preparedTypeDefinitions, vsmParams)) {\n+                if (null == rs) {\n+                    // No results. Meaning no parameter.\n+                    // Should never happen.\n+                    return enclaveRequestedCEKs;\n+                }\n+                processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n+                        enclaveRequestedCEKs);\n+                // Process the third resultset.\n+                if (connection.isAEv2() && stmt.getMoreResults()) {\n+                    try (ResultSet hgsRs = (SQLServerResultSet) stmt.getResultSet()) {\n+                        if (hgsRs.next()) {\n+                            hgsResponse = new VSMAttestationResponse(hgsRs.getBytes(1));\n+                            // This validates and establishes the enclave session if valid\n+                            validateAttestationResponse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTUzNzEw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346953710", "createdAt": "2020-01-22T22:37:40Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozNzo0MFrOFgteug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozNzo0MFrOFgteug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Mzg5OA==", "bodyText": "looks funny, use isEmpty instead?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r369843898", "createdAt": "2020-01-22T22:37:40Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -6202,7 +6202,7 @@ void writeRPCReaderUnicode(String sName, Reader re, long reLength, boolean bOut,\n \n     void sendEnclavePackage(String sql, ArrayList<byte[]> enclaveCEKs) throws SQLServerException {\n         if (null != con && con.isAEv2()) {\n-            if (null != sql && \"\" != sql && null != enclaveCEKs && 0 < enclaveCEKs.size() && con.enclaveEstablished()) {\n+            if (null != sql && !\"\".equals(sql) && null != enclaveCEKs && 0 < enclaveCEKs.size() && con.enclaveEstablished()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTU0Mjcw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346954270", "createdAt": "2020-01-22T22:38:49Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozODo0OVrOFgtgdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjozODo0OVrOFgtgdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NDM0Mw==", "bodyText": "same - isEmpty?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r369844343", "createdAt": "2020-01-22T22:38:49Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerDatabaseMetaData.java", "diffHunk": "@@ -1047,9 +1047,9 @@ private ResultSet executeSPFkeys(String[] procParams) throws SQLException, SQLTi\n                 cstmt.setString(i + 1, procParams[i]);\n             }\n             String currentDB = null;\n-            if (null != procParams[2] && procParams[2] != \"\") {// pktable_qualifier\n+            if (null != procParams[2] && !\"\".equals(procParams[2])) {// pktable_qualifier\n                 currentDB = switchCatalogs(procParams[2]);\n-            } else if (null != procParams[5] && procParams[5] != \"\") {// fktable_qualifier\n+            } else if (null != procParams[5] && !\"\".equals(procParams[5])) {// fktable_qualifier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTU2MDgz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346956083", "createdAt": "2020-01-22T22:42:31Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjo0MjozMVrOFgtmaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjo0MjozMVrOFgtmaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NTg2Nw==", "bodyText": "Is it possible that the resultset is empty here? If it is, should we throw an exception or it is a legit scenario?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r369845867", "createdAt": "2020-01-22T22:42:31Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerVSMEnclaveProvider.java", "diffHunk": "@@ -139,33 +140,27 @@ private VSMAttestationResponse validateAttestationResponse(VSMAttestationRespons\n             String preparedTypeDefinitions, Parameter[] params,\n             ArrayList<String> parameterNames) throws SQLServerException {\n         ArrayList<byte[]> enclaveRequestedCEKs = new ArrayList<>();\n-        ResultSet rs = null;\n         try (PreparedStatement stmt = connection.prepareStatement(connection.enclaveEstablished() ? SDPE1 : SDPE2)) {\n-            if (connection.enclaveEstablished()) {\n-                rs = executeSDPEv1(stmt, userSql, preparedTypeDefinitions);\n-            } else {\n-                rs = executeSDPEv2(stmt, userSql, preparedTypeDefinitions, vsmParams);\n-            }\n-            if (null == rs) {\n-                // No results. Meaning no parameter.\n-                // Should never happen.\n-                return enclaveRequestedCEKs;\n-            }\n-            processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n-                    enclaveRequestedCEKs);\n-            // Process the third resultset.\n-            if (connection.isAEv2() && stmt.getMoreResults()) {\n-                rs = (SQLServerResultSet) stmt.getResultSet();\n-                while (rs.next()) {\n-                    hgsResponse = new VSMAttestationResponse(rs.getBytes(1));\n-                    // This validates and establishes the enclave session if valid\n-                    if (!connection.enclaveEstablished()) {\n-                        hgsResponse = validateAttestationResponse(hgsResponse);\n+            try (ResultSet rs = connection.enclaveEstablished() ? executeSDPEv1(stmt, userSql,\n+                    preparedTypeDefinitions) : executeSDPEv2(stmt, userSql, preparedTypeDefinitions, vsmParams)) {\n+                if (null == rs) {\n+                    // No results. Meaning no parameter.\n+                    // Should never happen.\n+                    return enclaveRequestedCEKs;\n+                }\n+                processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n+                        enclaveRequestedCEKs);\n+                // Process the third resultset.\n+                if (connection.isAEv2() && stmt.getMoreResults()) {\n+                    try (ResultSet hgsRs = (SQLServerResultSet) stmt.getResultSet()) {\n+                        if (hgsRs.next()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTU2NTg4", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-346956588", "createdAt": "2020-01-22T22:43:38Z", "commit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjo0MzozOFrOFgtoFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjo0MzozOFrOFgtoFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NjI5Mw==", "bodyText": "The questions for VSM provider applies here too.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#discussion_r369846293", "createdAt": "2020-01-22T22:43:38Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerAASEnclaveProvider.java", "diffHunk": "@@ -102,47 +102,42 @@ public EnclaveSession getEnclaveSession() {\n         return enclaveSession;\n     }\n \n-    private AASAttestationResponse validateAttestationResponse(AASAttestationResponse ar) throws SQLServerException {\n-        try {\n-            ar.validateToken(attestationURL, aasParams.getNonce());\n-            ar.validateDHPublicKey(aasParams.getNonce());\n-        } catch (GeneralSecurityException e) {\n-            SQLServerException.makeFromDriverError(null, this, e.getLocalizedMessage(), \"0\", false);\n+    private void validateAttestationResponse() throws SQLServerException {\n+        if (null != hgsResponse) {\n+            try {\n+                hgsResponse.validateToken(attestationURL, aasParams.getNonce());\n+                hgsResponse.validateDHPublicKey(aasParams.getNonce());\n+            } catch (GeneralSecurityException e) {\n+                SQLServerException.makeFromDriverError(null, this, e.getLocalizedMessage(), \"0\", false);\n+            }\n         }\n-        return ar;\n     }\n \n     private ArrayList<byte[]> describeParameterEncryption(SQLServerConnection connection, String userSql,\n             String preparedTypeDefinitions, Parameter[] params,\n             ArrayList<String> parameterNames) throws SQLServerException {\n         ArrayList<byte[]> enclaveRequestedCEKs = new ArrayList<>();\n-        ResultSet rs = null;\n         try (PreparedStatement stmt = connection.prepareStatement(connection.enclaveEstablished() ? SDPE1 : SDPE2)) {\n-            if (connection.enclaveEstablished()) {\n-                rs = executeSDPEv1(stmt, userSql, preparedTypeDefinitions);\n-            } else {\n-                rs = executeSDPEv2(stmt, userSql, preparedTypeDefinitions, aasParams);\n-            }\n-            if (null == rs) {\n-                // No results. Meaning no parameter.\n-                // Should never happen.\n-                return enclaveRequestedCEKs;\n-            }\n-            processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n-                    enclaveRequestedCEKs);\n-            // Process the third resultset.\n-            if (connection.isAEv2() && stmt.getMoreResults()) {\n-                rs = (SQLServerResultSet) stmt.getResultSet();\n-                while (rs.next()) {\n-                    hgsResponse = new AASAttestationResponse(rs.getBytes(1));\n-                    // This validates and establishes the enclave session if valid\n-                    if (!connection.enclaveEstablished()) {\n-                        hgsResponse = validateAttestationResponse(hgsResponse);\n+            try (ResultSet rs = connection.enclaveEstablished() ? executeSDPEv1(stmt, userSql,\n+                    preparedTypeDefinitions) : executeSDPEv2(stmt, userSql, preparedTypeDefinitions, aasParams)) {\n+                if (null == rs) {\n+                    // No results. Meaning no parameter.\n+                    // Should never happen.\n+                    return enclaveRequestedCEKs;\n+                }\n+                processSDPEv1(userSql, preparedTypeDefinitions, params, parameterNames, connection, stmt, rs,\n+                        enclaveRequestedCEKs);\n+                // Process the third resultset.\n+                if (connection.isAEv2() && stmt.getMoreResults()) {\n+                    try (ResultSet hgsRs = (SQLServerResultSet) stmt.getResultSet()) {\n+                        if (hgsRs.next()) {\n+                            hgsResponse = new AASAttestationResponse(hgsRs.getBytes(1));\n+                            // This validates and establishes the enclave session if valid\n+                            validateAttestationResponse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "427911c408873f5c6d67c940e12a00232502c60b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69c79d592f811d987c2ba7c07a88545a8958a49", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/d69c79d592f811d987c2ba7c07a88545a8958a49", "committedDate": "2020-01-23T00:03:00Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "698df7dcb446df9d0630302353cd870ad54fa293", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/698df7dcb446df9d0630302353cd870ad54fa293", "committedDate": "2020-01-23T00:05:34Z", "message": "throw exception if 3rd resultset is empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTQ1MTEx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-347545111", "createdAt": "2020-01-23T19:18:05Z", "commit": {"oid": "698df7dcb446df9d0630302353cd870ad54fa293"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTQ1Nzgy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1234#pullrequestreview-347545782", "createdAt": "2020-01-23T19:19:12Z", "commit": {"oid": "698df7dcb446df9d0630302353cd870ad54fa293"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2663, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}