{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjQyODcw", "number": 1320, "title": "Fix issue with cast exception from sql_variant", "bodyText": "Fixes issue #1302.\nEven though the code has remained this way for a long time, I think the current behavior of sql_variant is incorrect. The jdbcType variable in dtv.java is the JDBC type that the user specifies when they try to retrieve the data. This variable is telling the driver what the user wants to retrieve the data as, but this variable was getting modified to become the base type of the server's column type when retrieving sql_variant data, causing this issue (this effectively ignores the data type that the user was asking to retrieve sql_variant as). Leaving jdbcType as it is (which we should, since that's what the user wants) solves the issue.\nHowever, when the driver performs bulk copy on a sql_variant column, the driver does need to designate jdbcType as the underlying data type to perform datatype-specific conversions. This made it difficult for applying my changes to all datatypes (for the scope of this PR), and for now only the datatypes that do not require any specific conversions from going from one another (for example, numeric values and String values) have the fixes applied.", "createdAt": "2020-04-28T16:57:21Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320", "merged": true, "mergeCommit": {"oid": "4208532f31cab8657aab9e555518c58e8e6e8436"}, "closed": true, "closedAt": "2020-05-12T00:46:51Z", "author": {"login": "peterbae"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbyioXgH2gAyNDEwMjQyODcwOmIyOTVmN2YyNGRlN2UyMjhiOGJmNTM4OTAwNDRlZjFjODc4OWQ5NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgZTNYAFqTQwOTYyNDA2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b295f7f24de7e228b8bf53890044ef1c8789d975", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/b295f7f24de7e228b8bf53890044ef1c8789d975", "committedDate": "2020-04-27T17:15:07Z", "message": "Fix issue 1302"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87fb2c4d7aff182f111ed3becc167f2d7ffbb4c7", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/87fb2c4d7aff182f111ed3becc167f2d7ffbb4c7", "committedDate": "2020-04-27T17:48:22Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9fff7b3b35466547d9d4220b82b1d66acafdd8", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/df9fff7b3b35466547d9d4220b82b1d66acafdd8", "committedDate": "2020-04-28T16:44:56Z", "message": "1302 fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "545ecb8500654940e3d8991bf26aa44eeff816b7", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/545ecb8500654940e3d8991bf26aa44eeff816b7", "committedDate": "2020-04-28T22:20:36Z", "message": "test adjustments / no longer returning string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c806d1de919e51fe2a2f9f23dd9ff303329fe56", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/1c806d1de919e51fe2a2f9f23dd9ff303329fe56", "committedDate": "2020-04-28T22:55:36Z", "message": "more changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/b5e88ce353fd00842333d0b21237383e1d128751", "committedDate": "2020-04-28T23:04:11Z", "message": "add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODA0NjUx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-407804651", "createdAt": "2020-05-07T20:17:45Z", "commit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDoxNzo0NVrOGSOsVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDoxNzo0NVrOGSOsVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2ODI3Nw==", "bodyText": "ResultSet in try block.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#discussion_r421768277", "createdAt": "2020-05-07T20:17:45Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/datatypes/SQLVariantResultSetTest.java", "diffHunk": "@@ -1061,6 +1061,16 @@ public void testTimeClassAsSqlVariant() throws SQLException {\n             assertEquals(object.getClass(), java.sql.Time.class);;\n         }\n     }\n+    \n+    @Test\n+    public void testCastThenGetNumeric() throws SQLException {\n+        try (Connection con = getConnection(); Statement stmt = con.createStatement();) {\n+            SQLServerResultSet rs = (SQLServerResultSet) stmt.executeQuery(\"select cast(123 as sql_variant) as c1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODA0ODA2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-407804806", "createdAt": "2020-05-07T20:17:59Z", "commit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDoxNzo1OVrOGSOsyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDoxNzo1OVrOGSOsyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2ODM5Mw==", "bodyText": "Expected value first.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#discussion_r421768393", "createdAt": "2020-05-07T20:17:59Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/datatypes/SQLVariantResultSetTest.java", "diffHunk": "@@ -1061,6 +1061,16 @@ public void testTimeClassAsSqlVariant() throws SQLException {\n             assertEquals(object.getClass(), java.sql.Time.class);;\n         }\n     }\n+    \n+    @Test\n+    public void testCastThenGetNumeric() throws SQLException {\n+        try (Connection con = getConnection(); Statement stmt = con.createStatement();) {\n+            SQLServerResultSet rs = (SQLServerResultSet) stmt.executeQuery(\"select cast(123 as sql_variant) as c1\");\n+            rs.next();\n+            long longValue = rs.getLong(\"c1\");\n+            assertEquals(longValue, 123L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODE0NzY2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-407814766", "createdAt": "2020-05-07T20:32:59Z", "commit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDozMjo1OVrOGSPLPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDozMjo1OVrOGSPLPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc3NjE5MA==", "bodyText": "Please add test cases for rest of the datatypes this PR applies to.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#discussion_r421776190", "createdAt": "2020-05-07T20:32:59Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/jdbc/datatypes/SQLVariantResultSetTest.java", "diffHunk": "@@ -1061,6 +1061,16 @@ public void testTimeClassAsSqlVariant() throws SQLException {\n             assertEquals(object.getClass(), java.sql.Time.class);;\n         }\n     }\n+    \n+    @Test\n+    public void testCastThenGetNumeric() throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODU4MjQz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-407858243", "createdAt": "2020-05-07T21:42:41Z", "commit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMTo0Mjo0MVrOGSRWNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMTo0Mjo0MVrOGSRWNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxMTc2Ng==", "bodyText": "can you add a comment here on why these 2 values?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#discussion_r421811766", "createdAt": "2020-05-07T21:42:41Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/DDC.java", "diffHunk": "@@ -72,6 +72,17 @@ static final Object convertIntegerToObject(int intValue, int valueLength, JDBCTy\n                 return (float) intValue;\n             case BINARY:\n                 return convertIntToBytes(intValue, valueLength);\n+            case SQL_VARIANT:\n+                // return short or bit if the underlying datatype of sql_variant is tinyint, smallint or bit\n+                // otherwise, return integer\n+                // Longer datatypes such as double and float are handled by convertLongToObject instead.\n+                if (valueLength == 1) {\n+                    return 0 != intValue;\n+                } else if (valueLength == 3 || valueLength == 4) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e88ce353fd00842333d0b21237383e1d128751"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778400076a9331f7b0498790ba17b14d5b5f4bdc", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/778400076a9331f7b0498790ba17b14d5b5f4bdc", "committedDate": "2020-05-08T20:20:52Z", "message": "update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da113804eea22739c907ec7199b19f41f697ecee", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/da113804eea22739c907ec7199b19f41f697ecee", "committedDate": "2020-05-08T23:45:12Z", "message": "remove unreachable code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NTg1NzE4", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-408585718", "createdAt": "2020-05-09T00:06:00Z", "commit": {"oid": "da113804eea22739c907ec7199b19f41f697ecee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MzY0NjY2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-409364666", "createdAt": "2020-05-11T17:08:44Z", "commit": {"oid": "da113804eea22739c907ec7199b19f41f697ecee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNzowODo0NFrOGTlcdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNzowODo0NFrOGTlcdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE4OTYyMw==", "bodyText": "1 == valueLength, same in line 81", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#discussion_r423189623", "createdAt": "2020-05-11T17:08:44Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/DDC.java", "diffHunk": "@@ -72,6 +72,17 @@ static final Object convertIntegerToObject(int intValue, int valueLength, JDBCTy\n                 return (float) intValue;\n             case BINARY:\n                 return convertIntToBytes(intValue, valueLength);\n+            case SQL_VARIANT:\n+                // return short or bit if the underlying datatype of sql_variant is tinyint, smallint or bit\n+                // otherwise, return integer\n+                // Longer datatypes such as double and float are handled by convertLongToObject instead.\n+                if (valueLength == 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da113804eea22739c907ec7199b19f41f697ecee"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NjI0MDYz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1320#pullrequestreview-409624063", "createdAt": "2020-05-12T00:40:16Z", "commit": {"oid": "da113804eea22739c907ec7199b19f41f697ecee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2527, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}