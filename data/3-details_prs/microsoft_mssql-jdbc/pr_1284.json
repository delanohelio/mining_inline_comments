{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NDU3MDAw", "number": 1284, "title": "Feature | client certificate authentication", "bodyText": "The JDBC driver will add three connection properties for this feature:\nclientCertificate \u2013 specifies the certificate to be used for authentication. The JDBC driver will support PFX, PEM, DER and CER file extensions. Format:\n\u2022\tclientCertificate=<file_location>\nThe driver uses a certificate file. For certificates in PEM, DER and CER formats clientKey attribute is required.\nclientKey \u2013 specifies a file location of the private key for PEM, DER and CER certificates specified by the clientCertificate attribute. Format:\n\u2022\tclientKey=<file_location>\nSpecifies location of the private key file. In case if private key file is password protected then password keyword is required.\nclientKeyPassword \u2013 optional password string provided to access the clientKey file\u2019s private key.", "createdAt": "2020-03-16T19:36:51Z", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284", "merged": true, "mergeCommit": {"oid": "9732e1bbc6ec44166fda2cddab31ce1c86c873dd"}, "closed": true, "closedAt": "2020-03-27T23:38:40Z", "author": {"login": "peterbae"}, "timelineItems": {"totalCount": 88, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBa8qiAH2gAyMzg5NDU3MDAwOmM5N2I4NjNjOTUzODViZGNkMWFmYzg5N2VmMzljYmViYWY0OTU1Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR4o2jAFqTM4MzIzODU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c97b863c95385bdcd1afc897ef39cbebaf495578", "author": {"user": {"login": "lilgreenbird", "name": "lilgreenbird"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/c97b863c95385bdcd1afc897ef39cbebaf495578", "committedDate": "2020-02-05T19:03:48Z", "message": "Fix AEv2 tests exclude for reqExternalSetup and cleanup (#1247)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54b5a194e5d46552419c86e0d1f8c800f42d3de8", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/54b5a194e5d46552419c86e0d1f8c800f42d3de8", "committedDate": "2020-02-08T00:19:05Z", "message": "Fix | Add null check for getObject() with LocalTime and LocalDate (#1250)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "672b7d67caae75250c53f82a760e8d3880e62a37", "author": {"user": {"login": "lilgreenbird", "name": "lilgreenbird"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/672b7d67caae75250c53f82a760e8d3880e62a37", "committedDate": "2020-02-10T19:04:22Z", "message": "added all AKV tests to use reqExternalSetup tag so they will be skipped by default (#1254)\n\n* skip AKV test properly\r\n\r\n* removed enclave properties string to failed errors as enclave tests could be skipped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f006c4eb7daf92211d90bdb5f0c088eb50969914", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/f006c4eb7daf92211d90bdb5f0c088eb50969914", "committedDate": "2020-02-24T20:22:09Z", "message": "Added new Azure endpoints to the list of trusted endpoints (#1264)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f33c574906313ecd45694a9e3638d12c23bf837", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/5f33c574906313ecd45694a9e3638d12c23bf837", "committedDate": "2020-02-24T20:31:36Z", "message": "Release | Changes for 8.2.1 HotFix release (#1260)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f973767ce0f6e6c2cbf9b2432f93e00f899883", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/10f973767ce0f6e6c2cbf9b2432f93e00f899883", "committedDate": "2020-02-27T20:58:49Z", "message": "Sync master with dev for 8.2.1 Release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77d25cb6b8729b98d3605b11681f319c9a75e951", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/77d25cb6b8729b98d3605b11681f319c9a75e951", "committedDate": "2020-02-27T21:28:10Z", "message": "Release | 8.3.0-SNAPSHOT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166add5529f1af3c17fe2dfa160f61bd3ef7dece", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/166add5529f1af3c17fe2dfa160f61bd3ef7dece", "committedDate": "2020-02-27T21:29:07Z", "message": "Sync dev with master for 8.2.1 Release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3346b3a17f92d6ad2c9ddd3593f04d52e6ed65cd", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/3346b3a17f92d6ad2c9ddd3593f04d52e6ed65cd", "committedDate": "2020-02-27T22:47:48Z", "message": "Release | Add snapshot to pom file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef72c52169edd02f7794ace32a684be1e4c0a7f", "author": {"user": {"login": "ulvii", "name": null}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/bef72c52169edd02f7794ace32a684be1e4c0a7f", "committedDate": "2020-02-28T00:14:23Z", "message": "Release | Update version to 8.3.0-SNAPSHOT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "560be4ce0675adb7b2826220977bf85aa87d63d3", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/560be4ce0675adb7b2826220977bf85aa87d63d3", "committedDate": "2020-03-04T20:40:23Z", "message": "initial stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcc4a03b4433bb32bce008464ec438030b9d8abf", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/bcc4a03b4433bb32bce008464ec438030b9d8abf", "committedDate": "2020-03-09T20:43:21Z", "message": "Merge branch 'dev' of https://github.com/Microsoft/mssql-jdbc into clientcertauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2508f53e3bd79be0de1cba07d9bc6da529d3258c", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/2508f53e3bd79be0de1cba07d9bc6da529d3258c", "committedDate": "2020-03-10T16:37:21Z", "message": "Add support for PKCS8 and PKCS1 private keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15293afaecf17371b1a9016875d0684c14c15b00", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/15293afaecf17371b1a9016875d0684c14c15b00", "committedDate": "2020-03-10T16:41:36Z", "message": "Remove imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e7c428bdb5211113e4329f76aae9f70c390f16", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e1e7c428bdb5211113e4329f76aae9f70c390f16", "committedDate": "2020-03-10T16:41:55Z", "message": "Remove imports from iobuffer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2013654ce486e6f899d8b74965006eedbbdd44", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/9d2013654ce486e6f899d8b74965006eedbbdd44", "committedDate": "2020-03-10T16:42:25Z", "message": "more import cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d5f88f7aeccd7ace88fb5261e2feb36ebc97e5", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e2d5f88f7aeccd7ace88fb5261e2feb36ebc97e5", "committedDate": "2020-03-10T16:43:20Z", "message": "Merge pull request #11 from rene-ye/clientcertauth\n\nAdd support for PKCS8 and PKCS1 private keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa15950f8424791d9551ee3e51956d88d167c0f4", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/fa15950f8424791d9551ee3e51956d88d167c0f4", "committedDate": "2020-03-10T16:45:10Z", "message": "change logic for decryptprovider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45a7a259820dff620773f496e7289326d7b82abe", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/45a7a259820dff620773f496e7289326d7b82abe", "committedDate": "2020-03-10T17:06:52Z", "message": "Add PVK support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b51d9b9a4b1578d5d945b0c51c11501dafcc4fad", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/b51d9b9a4b1578d5d945b0c51c11501dafcc4fad", "committedDate": "2020-03-10T17:07:21Z", "message": "changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a743065132e87a02b954cbfbbbe8362041afe9aa", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/a743065132e87a02b954cbfbbbe8362041afe9aa", "committedDate": "2020-03-10T17:08:14Z", "message": "Merge branch 'clientcertauth' of https://github.com/peterbae/mssql-jdbc into clientcertauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13db00239144c5d9e019284c08ae5cead5ef716d", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/13db00239144c5d9e019284c08ae5cead5ef716d", "committedDate": "2020-03-10T17:11:08Z", "message": "Merge pull request #12 from rene-ye/clientcertauth\n\nchange logic for decryptprovider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb19534292ca0da882ef3c2c407a3f801ee6497d", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/fb19534292ca0da882ef3c2c407a3f801ee6497d", "committedDate": "2020-03-12T19:52:37Z", "message": "hw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f94a3da0859a8186fe1a6020c75cfc75fcfaa926", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/f94a3da0859a8186fe1a6020c75cfc75fcfaa926", "committedDate": "2020-03-12T20:00:04Z", "message": "Merge pull request #13 from rene-ye/clientcertauth\n\nhw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f5a9585835875481f7d41acdd06a0fd359776cb", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/3f5a9585835875481f7d41acdd06a0fd359776cb", "committedDate": "2020-03-16T16:46:23Z", "message": "initial changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58fb495ae8fd93c4a0d95559d420b89f9258a92e", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/58fb495ae8fd93c4a0d95559d420b89f9258a92e", "committedDate": "2020-03-16T19:20:53Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e521b6000f5fcbd2c31787274685503c26d42168", "committedDate": "2020-03-16T19:33:11Z", "message": "try"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTU1NTI2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-375555526", "createdAt": "2020-03-16T20:22:40Z", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyMjo0MVrOF3Eccw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyMjo0MVrOF3Eccw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI4ODgxOQ==", "bodyText": "Does this need any sort of open source approval?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r393288819", "createdAt": "2020-03-16T20:22:41Z", "author": {"login": "saurabh500"}, "path": "pom.xml", "diffHunk": "@@ -122,6 +122,13 @@\n \t\t\t<version>1.64</version>\n \t\t\t<optional>true</optional>\n \t\t</dependency>\n+\t\t\n+\t\t<!-- dependencies for Client Certificate Authentication -->\n+\t\t<dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTU2OTk3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-375556997", "createdAt": "2020-03-16T20:25:01Z", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyNTowMlrOF3Egzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyNTowMlrOF3Egzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI4OTkzNA==", "bodyText": "Can \"PKCS12\" be turned into a constant string? Or is there a constant in JDK that can be used instead?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r393289934", "createdAt": "2020-03-16T20:25:02Z", "author": {"login": "saurabh500"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,276 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.Security;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.jce.provider.BouncyCastleProvider;\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTU4NTEx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-375558511", "createdAt": "2020-03-16T20:27:35Z", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyNzozNVrOF3ElVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyNzozNVrOF3ElVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5MTA5Mg==", "bodyText": "Is it possible to use the StringBuilder to do these manipulations on the key?\nThe current code will create new instances of String since String is immutable. Can we optimize a bit for memory?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r393291092", "createdAt": "2020-03-16T20:27:35Z", "author": {"login": "saurabh500"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,276 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.Security;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.jce.provider.BouncyCastleProvider;\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r\n+        keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\"SunX509\");\r\n+        keyManagerFactory.init(keystore, keyPassword.toCharArray());\r\n+        return keyManagerFactory.getKeyManagers();\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS8Certificate(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        Certificate clientCertificate = loadCertificate(certPath);\r\n+        PrivateKey privateKey = loadPrivateKey(keyPath, keyPassword);\r\n+\r\n+        KeyStore keyStore = KeyStore.getInstance(\"JKS\");\r\n+        keyStore.load(null, null);\r\n+        keyStore.setCertificateEntry(\"client-cert\", clientCertificate);\r\n+        keyStore.setKeyEntry(\"client-key\", privateKey, keyPassword.toCharArray(),\r\n+                new Certificate[] {clientCertificate});\r\n+\r\n+        KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\r\n+        kmf.init(keyStore, keyPassword.toCharArray());\r\n+        return kmf.getKeyManagers();\r\n+    }\r\n+\r\n+    private static Certificate loadCertificate(String certificatePem) throws IOException, GeneralSecurityException {\r\n+        CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\r\n+        InputStream certstream = fileToStream(certificatePem);\r\n+        return certificateFactory.generateCertificate(certstream);\r\n+    }\r\n+\r\n+    // PKCS#8 format\r\n+    private static final String PEM_PRIVATE_START = \"-----BEGIN PRIVATE KEY-----\";\r\n+    private static final String PEM_PRIVATE_END = \"-----END PRIVATE KEY-----\";\r\n+    // PKCS#1 format\r\n+    private static final String PEM_RSA_PRIVATE_START = \"-----BEGIN RSA PRIVATE KEY-----\";\r\n+    // PVK format\r\n+    private static final long PVK_MAGIC = 0xB0B5F11EL;\r\n+    private static final byte[] RSA2_MAGIC = {82, 83, 65, 50};\r\n+    private static final String RC4_ALG = \"RC4\";\r\n+    private static final String RSA_ALG = \"RSA\";\r\n+\r\n+    private static PrivateKey loadPrivateKey(String privateKeyPemPath,\r\n+            String privateKeyPassword) throws GeneralSecurityException, IOException, SQLServerException {\r\n+        String privateKeyPem = getStringFromFile(privateKeyPemPath);\r\n+\r\n+        if (privateKeyPem.contains(PEM_PRIVATE_START)) { // PKCS#8 format\r\n+            return loadPrivateKeyFromPKCS8(privateKeyPem);\r\n+        } else if (privateKeyPem.contains(PEM_RSA_PRIVATE_START)) { // PKCS#1 format\r\n+            return loadPrivateKeyFromPKCS1(privateKeyPem, privateKeyPassword);\r\n+        } else {\r\n+            return loadPrivateKeyFromPVK(privateKeyPemPath, privateKeyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS8(\r\n+            String key) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        key = key.replace(PEM_PRIVATE_START, \"\").replace(PEM_PRIVATE_END, \"\");\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "originalPosition": 123}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTU4ODc1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-375558875", "createdAt": "2020-03-16T20:28:14Z", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyODoxNFrOF3EmfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyODoxNFrOF3EmfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5MTM4OQ==", "bodyText": "Instead of relying on empty exception handling, is there a way to check if the provider is loaded, and use that ?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r393291389", "createdAt": "2020-03-16T20:28:14Z", "author": {"login": "saurabh500"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,276 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.Security;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.jce.provider.BouncyCastleProvider;\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r\n+        keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\"SunX509\");\r\n+        keyManagerFactory.init(keystore, keyPassword.toCharArray());\r\n+        return keyManagerFactory.getKeyManagers();\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS8Certificate(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        Certificate clientCertificate = loadCertificate(certPath);\r\n+        PrivateKey privateKey = loadPrivateKey(keyPath, keyPassword);\r\n+\r\n+        KeyStore keyStore = KeyStore.getInstance(\"JKS\");\r\n+        keyStore.load(null, null);\r\n+        keyStore.setCertificateEntry(\"client-cert\", clientCertificate);\r\n+        keyStore.setKeyEntry(\"client-key\", privateKey, keyPassword.toCharArray(),\r\n+                new Certificate[] {clientCertificate});\r\n+\r\n+        KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\r\n+        kmf.init(keyStore, keyPassword.toCharArray());\r\n+        return kmf.getKeyManagers();\r\n+    }\r\n+\r\n+    private static Certificate loadCertificate(String certificatePem) throws IOException, GeneralSecurityException {\r\n+        CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\r\n+        InputStream certstream = fileToStream(certificatePem);\r\n+        return certificateFactory.generateCertificate(certstream);\r\n+    }\r\n+\r\n+    // PKCS#8 format\r\n+    private static final String PEM_PRIVATE_START = \"-----BEGIN PRIVATE KEY-----\";\r\n+    private static final String PEM_PRIVATE_END = \"-----END PRIVATE KEY-----\";\r\n+    // PKCS#1 format\r\n+    private static final String PEM_RSA_PRIVATE_START = \"-----BEGIN RSA PRIVATE KEY-----\";\r\n+    // PVK format\r\n+    private static final long PVK_MAGIC = 0xB0B5F11EL;\r\n+    private static final byte[] RSA2_MAGIC = {82, 83, 65, 50};\r\n+    private static final String RC4_ALG = \"RC4\";\r\n+    private static final String RSA_ALG = \"RSA\";\r\n+\r\n+    private static PrivateKey loadPrivateKey(String privateKeyPemPath,\r\n+            String privateKeyPassword) throws GeneralSecurityException, IOException, SQLServerException {\r\n+        String privateKeyPem = getStringFromFile(privateKeyPemPath);\r\n+\r\n+        if (privateKeyPem.contains(PEM_PRIVATE_START)) { // PKCS#8 format\r\n+            return loadPrivateKeyFromPKCS8(privateKeyPem);\r\n+        } else if (privateKeyPem.contains(PEM_RSA_PRIVATE_START)) { // PKCS#1 format\r\n+            return loadPrivateKeyFromPKCS1(privateKeyPem, privateKeyPassword);\r\n+        } else {\r\n+            return loadPrivateKeyFromPVK(privateKeyPemPath, privateKeyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS8(\r\n+            String key) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        key = key.replace(PEM_PRIVATE_START, \"\").replace(PEM_PRIVATE_END, \"\");\r\n+        key = key.replaceAll(\"\\\\s\", \"\");\r\n+        byte[] pkcs8EncodedKey = Base64.getDecoder().decode(key);\r\n+\r\n+        KeyFactory factory = KeyFactory.getInstance(RSA_ALG);\r\n+        return factory.generatePrivate(new PKCS8EncodedKeySpec(pkcs8EncodedKey));\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS1(String key,\r\n+            String keyPass) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        try {\r\n+            Security.addProvider(new BouncyCastleProvider());\r\n+        } catch (SecurityException se) {\r\n+            // fall through, provider already loaded\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTU5NTg3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-375559587", "createdAt": "2020-03-16T20:29:29Z", "commit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyOToyOVrOF3EooQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDoyOToyOVrOF3EooQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5MTkzNw==", "bodyText": "Magic number 4. can you create a constant out of it?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r393291937", "createdAt": "2020-03-16T20:29:29Z", "author": {"login": "saurabh500"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,276 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.Security;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.jce.provider.BouncyCastleProvider;\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r\n+        keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\"SunX509\");\r\n+        keyManagerFactory.init(keystore, keyPassword.toCharArray());\r\n+        return keyManagerFactory.getKeyManagers();\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS8Certificate(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        Certificate clientCertificate = loadCertificate(certPath);\r\n+        PrivateKey privateKey = loadPrivateKey(keyPath, keyPassword);\r\n+\r\n+        KeyStore keyStore = KeyStore.getInstance(\"JKS\");\r\n+        keyStore.load(null, null);\r\n+        keyStore.setCertificateEntry(\"client-cert\", clientCertificate);\r\n+        keyStore.setKeyEntry(\"client-key\", privateKey, keyPassword.toCharArray(),\r\n+                new Certificate[] {clientCertificate});\r\n+\r\n+        KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\r\n+        kmf.init(keyStore, keyPassword.toCharArray());\r\n+        return kmf.getKeyManagers();\r\n+    }\r\n+\r\n+    private static Certificate loadCertificate(String certificatePem) throws IOException, GeneralSecurityException {\r\n+        CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\r\n+        InputStream certstream = fileToStream(certificatePem);\r\n+        return certificateFactory.generateCertificate(certstream);\r\n+    }\r\n+\r\n+    // PKCS#8 format\r\n+    private static final String PEM_PRIVATE_START = \"-----BEGIN PRIVATE KEY-----\";\r\n+    private static final String PEM_PRIVATE_END = \"-----END PRIVATE KEY-----\";\r\n+    // PKCS#1 format\r\n+    private static final String PEM_RSA_PRIVATE_START = \"-----BEGIN RSA PRIVATE KEY-----\";\r\n+    // PVK format\r\n+    private static final long PVK_MAGIC = 0xB0B5F11EL;\r\n+    private static final byte[] RSA2_MAGIC = {82, 83, 65, 50};\r\n+    private static final String RC4_ALG = \"RC4\";\r\n+    private static final String RSA_ALG = \"RSA\";\r\n+\r\n+    private static PrivateKey loadPrivateKey(String privateKeyPemPath,\r\n+            String privateKeyPassword) throws GeneralSecurityException, IOException, SQLServerException {\r\n+        String privateKeyPem = getStringFromFile(privateKeyPemPath);\r\n+\r\n+        if (privateKeyPem.contains(PEM_PRIVATE_START)) { // PKCS#8 format\r\n+            return loadPrivateKeyFromPKCS8(privateKeyPem);\r\n+        } else if (privateKeyPem.contains(PEM_RSA_PRIVATE_START)) { // PKCS#1 format\r\n+            return loadPrivateKeyFromPKCS1(privateKeyPem, privateKeyPassword);\r\n+        } else {\r\n+            return loadPrivateKeyFromPVK(privateKeyPemPath, privateKeyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS8(\r\n+            String key) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        key = key.replace(PEM_PRIVATE_START, \"\").replace(PEM_PRIVATE_END, \"\");\r\n+        key = key.replaceAll(\"\\\\s\", \"\");\r\n+        byte[] pkcs8EncodedKey = Base64.getDecoder().decode(key);\r\n+\r\n+        KeyFactory factory = KeyFactory.getInstance(RSA_ALG);\r\n+        return factory.generatePrivate(new PKCS8EncodedKeySpec(pkcs8EncodedKey));\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS1(String key,\r\n+            String keyPass) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        try {\r\n+            Security.addProvider(new BouncyCastleProvider());\r\n+        } catch (SecurityException se) {\r\n+            // fall through, provider already loaded\r\n+        }\r\n+        PEMParser pemParser = null;\r\n+        try {\r\n+            pemParser = new PEMParser(new StringReader(key));\r\n+            Object object = pemParser.readObject();\r\n+            JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\r\n+            KeyPair kp;\r\n+            if (object instanceof PEMEncryptedKeyPair && keyPass != null) {\r\n+                PEMDecryptorProvider decProv = new JcePEMDecryptorProviderBuilder().build(keyPass.toCharArray());\r\n+                kp = converter.getKeyPair(((PEMEncryptedKeyPair) object).decryptKeyPair(decProv));\r\n+            } else {\r\n+                kp = converter.getKeyPair((PEMKeyPair) object);\r\n+            }\r\n+            return kp.getPrivate();\r\n+        } finally {\r\n+            pemParser.close();\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPVK(String keyPath,\r\n+            String keyPass) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        File f = new File(keyPath);\r\n+        ByteBuffer buffer = ByteBuffer.allocate((int) f.length());\r\n+        try (FileInputStream in = new FileInputStream(f)) {\r\n+            in.getChannel().read(buffer);\r\n+            buffer.order(ByteOrder.LITTLE_ENDIAN).rewind();\r\n+\r\n+            long magic = buffer.getInt() & 0xFFFFFFFFL;\r\n+            if (PVK_MAGIC != magic) {\r\n+                SQLServerException.makeFromDriverError(null, magic, SQLServerResource.getResource(\"R_pvkHeaderError\"),\r\n+                        \"\", false);\r\n+            }\r\n+\r\n+            buffer.position(buffer.position() + 8); // skip reserved and keytype\r\n+            boolean encrypted = buffer.getInt() != 0;\r\n+            int saltLength = buffer.getInt();\r\n+            int keyLength = buffer.getInt();\r\n+            byte[] salt = new byte[saltLength];\r\n+            buffer.get(salt);\r\n+\r\n+            buffer.position(buffer.position() + 8); // skip btype(1b), version(1b), reserved(2b), and keyalg(4b)\r\n+\r\n+            byte[] key = new byte[keyLength - 8];\r\n+            buffer.get(key);\r\n+\r\n+            if (encrypted) {\r\n+                MessageDigest digest = MessageDigest.getInstance(\"SHA1\");\r\n+                digest.update(salt);\r\n+                if (keyPass != null) {\r\n+                    digest.update(keyPass.getBytes());\r\n+                }\r\n+                byte[] hash = digest.digest();\r\n+                key = getSecretKeyFromHash(key, hash);\r\n+            }\r\n+\r\n+            ByteBuffer keyBuff = ByteBuffer.wrap(key).order(ByteOrder.LITTLE_ENDIAN);\r\n+            keyBuff.position(RSA2_MAGIC.length); // skip the header\r\n+\r\n+            int byteLength = keyBuff.getInt() / 8;\r\n+            BigInteger publicExponent = BigInteger.valueOf(keyBuff.getInt());\r\n+            BigInteger modulus = getBigInteger(keyBuff, byteLength);\r\n+            BigInteger prime1 = getBigInteger(keyBuff, byteLength / 2);\r\n+            BigInteger prime2 = getBigInteger(keyBuff, byteLength / 2);\r\n+            BigInteger primeExponent1 = getBigInteger(keyBuff, byteLength / 2);\r\n+            BigInteger primeExponent2 = getBigInteger(keyBuff, byteLength / 2);\r\n+            BigInteger crtCoefficient = getBigInteger(keyBuff, byteLength / 2);\r\n+            BigInteger privateExponent = getBigInteger(keyBuff, byteLength);\r\n+\r\n+            RSAPrivateCrtKeySpec spec = new RSAPrivateCrtKeySpec(modulus, publicExponent, privateExponent, prime1,\r\n+                    prime2, primeExponent1, primeExponent2, crtCoefficient);\r\n+            KeyFactory factory = KeyFactory.getInstance(RSA_ALG);\r\n+            return factory.generatePrivate(spec);\r\n+        }\r\n+    }\r\n+\r\n+    private static boolean startsWithMagic(byte[] b) {\r\n+        for (int i = 0; i < 4; i++) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521b6000f5fcbd2c31787274685503c26d42168"}, "originalPosition": 213}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36be2b40b0d14ca94689870b6995136511985ef", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e36be2b40b0d14ca94689870b6995136511985ef", "committedDate": "2020-03-16T20:39:13Z", "message": "statically load BC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32ed914a84c1a51a049a472b09b42ef6cf3d2b14", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/32ed914a84c1a51a049a472b09b42ef6cf3d2b14", "committedDate": "2020-03-16T22:06:34Z", "message": "update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd353311e0994f478517e6ec811edb254a3bbd0e", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/fd353311e0994f478517e6ec811edb254a3bbd0e", "committedDate": "2020-03-16T23:33:25Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceca02beb53b3c5c8f9b7bb8d9ca152f1e060957", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/ceca02beb53b3c5c8f9b7bb8d9ca152f1e060957", "committedDate": "2020-03-17T19:59:13Z", "message": "update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4621c879bb6bea6ec9b3151e0579b45feb012ae", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e4621c879bb6bea6ec9b3151e0579b45feb012ae", "committedDate": "2020-03-18T17:58:49Z", "message": "add null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565c16d5063bb3140e5a6beb6980a76de03c4b79", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/565c16d5063bb3140e5a6beb6980a76de03c4b79", "committedDate": "2020-03-18T20:53:27Z", "message": "logic change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db3d040b41d3fe44a60a096076941919244a5dd0", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/db3d040b41d3fe44a60a096076941919244a5dd0", "committedDate": "2020-03-18T23:08:16Z", "message": "test change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e802213277d0e443fc327c946954a0e75a48e806", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/e802213277d0e443fc327c946954a0e75a48e806", "committedDate": "2020-03-20T15:33:09Z", "message": "test update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bae1e045e5ba01f8e13898f3c0a4cd9de21f42ba", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/bae1e045e5ba01f8e13898f3c0a4cd9de21f42ba", "committedDate": "2020-03-20T16:16:33Z", "message": "Fix some issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee991c2d4f6dc729c23fe62b50cb5cae59b72f9", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/bee991c2d4f6dc729c23fe62b50cb5cae59b72f9", "committedDate": "2020-03-20T16:34:46Z", "message": "Add resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a791523ad7b63679dbdf3ca60bf6dd2df148fc77", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/a791523ad7b63679dbdf3ca60bf6dd2df148fc77", "committedDate": "2020-03-20T16:44:29Z", "message": "Merge branch 'clientcertauth' of https://github.com/peterbae/mssql-jdbc into clientcertauth\n\n# Conflicts:\n#\tsrc/main/java/com/microsoft/sqlserver/jdbc/SQLServerResource.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/887fbdfb8cc7e787ddd119d88f3732a1fce7667a", "committedDate": "2020-03-20T20:25:47Z", "message": "Merge branch 'dev' of https://github.com/Microsoft/mssql-jdbc into clientcertauth"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTA2Njcy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380906672", "createdAt": "2020-03-25T07:30:04Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzozMDowNFrOF7Oxhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzozMDowNFrOF7Oxhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1MjM1OA==", "bodyText": "are these tabs?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397652358", "createdAt": "2020-03-25T07:30:04Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -1774,13 +1782,31 @@ else if (con.getTrustManagerClass() != null) {\n             if (logger.isLoggable(Level.FINEST))\n                 logger.finest(toString() + \" Getting TLS or better SSL context\");\n \n-            sslContext = SSLContext.getInstance(sslProtocol);\n-            sslContextProvider = sslContext.getProvider();\n+            if (null != clientCertificate) {\n+                try {\n+                    KeyManager[] km = SQLServerCertificateUtils.getKeyManagerFromFile(clientCertificate, clientKey,\n+                            clientKeyPassword);\n+                    \n+                    sslContext = SSLContext.getInstance(sslProtocol);\n+                    sslContextProvider = sslContext.getProvider();\n \n-            if (logger.isLoggable(Level.FINEST))\n-                logger.finest(toString() + \" Initializing SSL context\");\n+                    if (logger.isLoggable(Level.FINEST))\n+                        logger.finest(toString() + \" Initializing SSL context\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTA3ODQ3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380907847", "createdAt": "2020-03-25T07:32:46Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzozMjo0NlrOF7O1Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzozMjo0NlrOF7O1Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1MzM0Mg==", "bodyText": "should we have this? we don't usually have getters for passwords", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397653342", "createdAt": "2020-03-25T07:32:46Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerDataSource.java", "diffHunk": "@@ -903,5 +903,50 @@\n      *        Enclave attestation protocol.\n      */\n     void setEnclaveAttestationProtocol(String protocol);\n+    \n+    /**\n+     * Returns client certificate path for client certificate authentication.\n+     * \n+     * @return Client certificate path.\n+     */\n+    String getClientCertificate();\n+\n+    /**\n+     * Sets client certificate path for client certificate authentication.\n+     * \n+     * @param certPath\n+     *        Client certificate path.\n+     */\n+    void setClientCertificate(String certPath);\n+    \n+    /**\n+     * Returns Private key file path for client certificate authentication.\n+     * \n+     * @return Private key file path.\n+     */\n+    String getClientKey();\n+\n+    /**\n+     * Sets Private key file path for client certificate authentication.\n+     * \n+     * @param keyPath\n+     *        Private key file path.\n+     */\n+    void setClientKey(String keyPath);\n+    \n+    /**\n+     * Returns the password to be used for Private key provided by the user for client certificate authentication.\n+     * \n+     * @return Private key password.\n+     */\n+    String getClientKeyPassword();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTExOTU3", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380911957", "createdAt": "2020-03-25T07:41:30Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0MTozMFrOF7PC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0MTozMFrOF7PC1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1Njc4OA==", "bodyText": "are these hardcoded aliases defined in the specs? can we define them somewhere else?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397656788", "createdAt": "2020-03-25T07:41:30Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,274 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r\n+        keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\"SunX509\");\r\n+        keyManagerFactory.init(keystore, keyPassword.toCharArray());\r\n+        return keyManagerFactory.getKeyManagers();\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS8Certificate(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        Certificate clientCertificate = loadCertificate(certPath);\r\n+        PrivateKey privateKey = loadPrivateKey(keyPath, keyPassword);\r\n+\r\n+        KeyStore keyStore = KeyStore.getInstance(\"JKS\");\r\n+        keyStore.load(null, null);\r\n+        keyStore.setCertificateEntry(\"client-cert\", clientCertificate);\r\n+        keyStore.setKeyEntry(\"client-key\", privateKey, keyPassword.toCharArray(),\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTE0MTkz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380914193", "createdAt": "2020-03-25T07:46:08Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0NjowOFrOF7PKBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0NjowOFrOF7PKBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1ODYyOQ==", "bodyText": "null !=", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397658629", "createdAt": "2020-03-25T07:46:08Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerCertificateUtils.java", "diffHunk": "@@ -0,0 +1,274 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+\r\n+package com.microsoft.sqlserver.jdbc;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.DataInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import java.io.StringReader;\r\n+import java.math.BigInteger;\r\n+import java.nio.ByteBuffer;\r\n+import java.nio.ByteOrder;\r\n+import java.nio.file.Files;\r\n+import java.nio.file.Paths;\r\n+import java.security.GeneralSecurityException;\r\n+import java.security.KeyFactory;\r\n+import java.security.KeyPair;\r\n+import java.security.KeyStore;\r\n+import java.security.KeyStoreException;\r\n+import java.security.MessageDigest;\r\n+import java.security.NoSuchAlgorithmException;\r\n+import java.security.PrivateKey;\r\n+import java.security.UnrecoverableKeyException;\r\n+import java.security.cert.Certificate;\r\n+import java.security.cert.CertificateException;\r\n+import java.security.cert.CertificateFactory;\r\n+import java.security.spec.InvalidKeySpecException;\r\n+import java.security.spec.PKCS8EncodedKeySpec;\r\n+import java.security.spec.RSAPrivateCrtKeySpec;\r\n+import java.util.Arrays;\r\n+import java.util.Base64;\r\n+\r\n+import javax.crypto.Cipher;\r\n+import javax.crypto.SecretKey;\r\n+import javax.crypto.spec.SecretKeySpec;\r\n+import javax.net.ssl.KeyManager;\r\n+import javax.net.ssl.KeyManagerFactory;\r\n+\r\n+import org.bouncycastle.openssl.PEMDecryptorProvider;\r\n+import org.bouncycastle.openssl.PEMEncryptedKeyPair;\r\n+import org.bouncycastle.openssl.PEMKeyPair;\r\n+import org.bouncycastle.openssl.PEMParser;\r\n+import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;\r\n+import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;\r\n+\r\n+\r\n+final class SQLServerCertificateUtils {\r\n+\r\n+    static KeyManager[] getKeyManagerFromFile(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        if (keyPath != null && keyPath.length() > 0) {\r\n+            return readPKCS8Certificate(certPath, keyPath, keyPassword);\r\n+        } else {\r\n+            return readPKCS12Certificate(certPath, keyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS12Certificate(String certPath,\r\n+            String keyPassword) throws NoSuchAlgorithmException, CertificateException, FileNotFoundException, IOException, UnrecoverableKeyException, KeyStoreException {\r\n+        KeyStore keystore = KeyStore.getInstance(\"PKCS12\");\r\n+        keystore.load(new FileInputStream(certPath), keyPassword.toCharArray());\r\n+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\"SunX509\");\r\n+        keyManagerFactory.init(keystore, keyPassword.toCharArray());\r\n+        return keyManagerFactory.getKeyManagers();\r\n+    }\r\n+\r\n+    private static KeyManager[] readPKCS8Certificate(String certPath, String keyPath,\r\n+            String keyPassword) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        Certificate clientCertificate = loadCertificate(certPath);\r\n+        PrivateKey privateKey = loadPrivateKey(keyPath, keyPassword);\r\n+\r\n+        KeyStore keyStore = KeyStore.getInstance(\"JKS\");\r\n+        keyStore.load(null, null);\r\n+        keyStore.setCertificateEntry(\"client-cert\", clientCertificate);\r\n+        keyStore.setKeyEntry(\"client-key\", privateKey, keyPassword.toCharArray(),\r\n+                new Certificate[] {clientCertificate});\r\n+\r\n+        KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\r\n+        kmf.init(keyStore, keyPassword.toCharArray());\r\n+        return kmf.getKeyManagers();\r\n+    }\r\n+\r\n+    private static Certificate loadCertificate(String certificatePem) throws IOException, GeneralSecurityException {\r\n+        CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\r\n+        InputStream certstream = fileToStream(certificatePem);\r\n+        return certificateFactory.generateCertificate(certstream);\r\n+    }\r\n+\r\n+    // PKCS#8 format\r\n+    private static final String PEM_PRIVATE_START = \"-----BEGIN PRIVATE KEY-----\";\r\n+    private static final String PEM_PRIVATE_END = \"-----END PRIVATE KEY-----\";\r\n+    // PKCS#1 format\r\n+    private static final String PEM_RSA_PRIVATE_START = \"-----BEGIN RSA PRIVATE KEY-----\";\r\n+    // PVK format\r\n+    private static final long PVK_MAGIC = 0xB0B5F11EL;\r\n+    private static final byte[] RSA2_MAGIC = {82, 83, 65, 50};\r\n+    private static final String RC4_ALG = \"RC4\";\r\n+    private static final String RSA_ALG = \"RSA\";\r\n+\r\n+    private static PrivateKey loadPrivateKey(String privateKeyPemPath,\r\n+            String privateKeyPassword) throws GeneralSecurityException, IOException, SQLServerException {\r\n+        String privateKeyPem = getStringFromFile(privateKeyPemPath);\r\n+\r\n+        if (privateKeyPem.contains(PEM_PRIVATE_START)) { // PKCS#8 format\r\n+            return loadPrivateKeyFromPKCS8(privateKeyPem);\r\n+        } else if (privateKeyPem.contains(PEM_RSA_PRIVATE_START)) { // PKCS#1 format\r\n+            return loadPrivateKeyFromPKCS1(privateKeyPem, privateKeyPassword);\r\n+        } else {\r\n+            return loadPrivateKeyFromPVK(privateKeyPemPath, privateKeyPassword);\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS8(\r\n+            String key) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        key = key.replace(PEM_PRIVATE_START, \"\").replace(PEM_PRIVATE_END, \"\");\r\n+        key = key.replaceAll(\"\\\\s\", \"\");\r\n+        byte[] pkcs8EncodedKey = Base64.getDecoder().decode(key);\r\n+\r\n+        KeyFactory factory = KeyFactory.getInstance(RSA_ALG);\r\n+        return factory.generatePrivate(new PKCS8EncodedKeySpec(pkcs8EncodedKey));\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPKCS1(String key,\r\n+            String keyPass) throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {\r\n+        try {\r\n+            SQLServerBouncyCastleLoader.loadBouncyCastle();\r\n+        } catch (SecurityException se) {\r\n+            // fall through, provider already loaded\r\n+        }\r\n+        PEMParser pemParser = null;\r\n+        try {\r\n+            pemParser = new PEMParser(new StringReader(key));\r\n+            Object object = pemParser.readObject();\r\n+            JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\r\n+            KeyPair kp;\r\n+            if (object instanceof PEMEncryptedKeyPair && keyPass != null) {\r\n+                PEMDecryptorProvider decProv = new JcePEMDecryptorProviderBuilder().build(keyPass.toCharArray());\r\n+                kp = converter.getKeyPair(((PEMEncryptedKeyPair) object).decryptKeyPair(decProv));\r\n+            } else {\r\n+                kp = converter.getKeyPair((PEMKeyPair) object);\r\n+            }\r\n+            return kp.getPrivate();\r\n+        } finally {\r\n+            pemParser.close();\r\n+        }\r\n+    }\r\n+\r\n+    private static PrivateKey loadPrivateKeyFromPVK(String keyPath,\r\n+            String keyPass) throws IOException, GeneralSecurityException, SQLServerException {\r\n+        File f = new File(keyPath);\r\n+        ByteBuffer buffer = ByteBuffer.allocate((int) f.length());\r\n+        try (FileInputStream in = new FileInputStream(f)) {\r\n+            in.getChannel().read(buffer);\r\n+            buffer.order(ByteOrder.LITTLE_ENDIAN).rewind();\r\n+\r\n+            long magic = buffer.getInt() & 0xFFFFFFFFL;\r\n+            if (PVK_MAGIC != magic) {\r\n+                SQLServerException.makeFromDriverError(null, magic, SQLServerResource.getResource(\"R_pvkHeaderError\"),\r\n+                        \"\", false);\r\n+            }\r\n+\r\n+            buffer.position(buffer.position() + 8); // skip reserved and keytype\r\n+            boolean encrypted = buffer.getInt() != 0;\r\n+            int saltLength = buffer.getInt();\r\n+            int keyLength = buffer.getInt();\r\n+            byte[] salt = new byte[saltLength];\r\n+            buffer.get(salt);\r\n+\r\n+            buffer.position(buffer.position() + 8); // skip btype(1b), version(1b), reserved(2b), and keyalg(4b)\r\n+\r\n+            byte[] key = new byte[keyLength - 8];\r\n+            buffer.get(key);\r\n+\r\n+            if (encrypted) {\r\n+                MessageDigest digest = MessageDigest.getInstance(\"SHA1\");\r\n+                digest.update(salt);\r\n+                if (keyPass != null) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTE1MTg2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380915186", "createdAt": "2020-03-25T07:48:14Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0ODoxNFrOF7PNgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0ODoxNFrOF7PNgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1OTUyMA==", "bodyText": "null ==\nmultiple occurences", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397659520", "createdAt": "2020-03-25T07:48:14Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -4960,7 +4985,7 @@ final boolean complete(LogonCommand logonCommand, TDSReader tdsReader) throws SQ\n                 + 4; // AE is always on;\n \n         // only add lengths of password and username if not using SSPI or requesting federated authentication info\n-        if (!integratedSecurity && !(federatedAuthenticationInfoRequested || federatedAuthenticationRequested)) {\n+        if (!integratedSecurity && !(federatedAuthenticationInfoRequested || federatedAuthenticationRequested) && clientCertificate == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTE2ODM2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380916836", "createdAt": "2020-03-25T07:51:36Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo1MTozNlrOF7PS-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo1MTozNlrOF7PS-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY2MDkyMA==", "bodyText": "no test for datasource getters and setters\nI think you also need to update AbstractTest.updateDataSource()", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397660920", "createdAt": "2020-03-25T07:51:36Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs1.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pkcs8Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs8.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs8EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs8.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxEncrytedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \"-encrypted.pfx;\" + \"clientKeyPassword=\"\r\n+                + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pvkTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".cer;\" + \"clientKey=\"\r\n+                + clientKey + \".pvk;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCert() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=invalid_path;\" + \"clientKeyPassword=\" + clientKeyPassword\r\n+                + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_invalidPath\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCertPassword() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\"\r\n+                + \"clientKeyPassword=invalid_password;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_keystorePassword\")));\r\n+        }\r\n+    }\r\n+}\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 133}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTE3OTAx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-380917901", "createdAt": "2020-03-25T07:53:48Z", "commit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo1Mzo0OFrOF7PWrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo1Mzo0OFrOF7PWrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY2MTg3MQ==", "bodyText": "? why are we only checking if it contains the string Microsoft?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r397661871", "createdAt": "2020-03-25T07:53:48Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887fbdfb8cc7e787ddd119d88f3732a1fce7667a"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64828f3b3c985cd0fa46195704a91fe5795417d", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/f64828f3b3c985cd0fa46195704a91fe5795417d", "committedDate": "2020-03-25T16:46:04Z", "message": "Merge pull request #14 from rene-ye/clientcertauth\n\nClientcertauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a426136032358d95011cf8ebbf3783732c95cfb9", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/a426136032358d95011cf8ebbf3783732c95cfb9", "committedDate": "2020-03-25T17:08:04Z", "message": "test update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b42090b39b132a39df29e97d134f563afb8dd59", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/6b42090b39b132a39df29e97d134f563afb8dd59", "committedDate": "2020-03-25T19:35:45Z", "message": "disable clientcertauth on CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/de3f1755cbf15c9f18dc31a8214907438c906e4b", "committedDate": "2020-03-25T21:31:40Z", "message": "make it optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjI4ODY4", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-381628868", "createdAt": "2020-03-26T00:28:24Z", "commit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMDoyODoyNFrOF7zRRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMDoyODoyNFrOF7zRRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI1MDMwOQ==", "bodyText": "create a variable for the version and use it for both bcpkix-jdk15on and bcprov-jdk15on", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398250309", "createdAt": "2020-03-26T00:28:24Z", "author": {"login": "ulvii"}, "path": "pom.xml", "diffHunk": "@@ -122,6 +123,14 @@\n \t\t\t<version>1.64</version>\n \t\t\t<optional>true</optional>\n \t\t</dependency>\n+\t\t\n+\t\t<!-- dependencies for Client Certificate Authentication -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.bouncycastle</groupId>\n+\t\t\t<artifactId>bcpkix-jdk15on</artifactId>\n+\t\t\t<version>1.64</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjQzMjYz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-381643263", "createdAt": "2020-03-26T01:18:29Z", "commit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMToxODozMFrOF70Frg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMToxODozMFrOF70Frg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI2MzcyNg==", "bodyText": "Catching NullPointerException ???", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398263726", "createdAt": "2020-03-26T01:18:30Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -1774,13 +1782,31 @@ else if (con.getTrustManagerClass() != null) {\n             if (logger.isLoggable(Level.FINEST))\n                 logger.finest(toString() + \" Getting TLS or better SSL context\");\n \n-            sslContext = SSLContext.getInstance(sslProtocol);\n-            sslContextProvider = sslContext.getProvider();\n+            if (null != clientCertificate) {\n+                try {\n+                    KeyManager[] km = SQLServerCertificateUtils.getKeyManagerFromFile(clientCertificate, clientKey,\n+                            clientKeyPassword);\n \n-            if (logger.isLoggable(Level.FINEST))\n-                logger.finest(toString() + \" Initializing SSL context\");\n+                    sslContext = SSLContext.getInstance(sslProtocol);\n+                    sslContextProvider = sslContext.getProvider();\n+\n+                    if (logger.isLoggable(Level.FINEST))\n+                        logger.finest(toString() + \" Initializing SSL context\");\n+\n+                    sslContext.init(km, tm, null);\n+                } catch (NullPointerException | FileNotFoundException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjQ0NTYx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-381644561", "createdAt": "2020-03-26T01:22:51Z", "commit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMToyMjo1MVrOF70KHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMToyMjo1MVrOF70KHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI2NDg2Mw==", "bodyText": "The code in if/else are almost the same. You just need to initialize km to null and have km = SQLServerCertificateUtils.getKeyManagerFromFile(clientCertificate, clientKey,clientKeyPassword); inside if block.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398264863", "createdAt": "2020-03-26T01:22:51Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -1774,13 +1782,31 @@ else if (con.getTrustManagerClass() != null) {\n             if (logger.isLoggable(Level.FINEST))\n                 logger.finest(toString() + \" Getting TLS or better SSL context\");\n \n-            sslContext = SSLContext.getInstance(sslProtocol);\n-            sslContextProvider = sslContext.getProvider();\n+            if (null != clientCertificate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de3f1755cbf15c9f18dc31a8214907438c906e4b"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c03a69f4a83bc67a3fc591f1cf51a3f0b3fa01cb", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/c03a69f4a83bc67a3fc591f1cf51a3f0b3fa01cb", "committedDate": "2020-03-26T17:02:13Z", "message": "add null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "898feca0c08f251d3d9d43789f16b506240e5a03", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/898feca0c08f251d3d9d43789f16b506240e5a03", "committedDate": "2020-03-26T17:04:14Z", "message": "Fix pkcs8 and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85a8ad8bd83f301ff7521ad4ac128c30e4a4b4ee", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/85a8ad8bd83f301ff7521ad4ac128c30e4a4b4ee", "committedDate": "2020-03-26T17:06:13Z", "message": "Remove uneeded import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee8f08b61c33f466a7b92d09df54b32b5b38cfdf", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/ee8f08b61c33f466a7b92d09df54b32b5b38cfdf", "committedDate": "2020-03-26T17:07:59Z", "message": "Merge pull request #15 from rene-ye/clientcertauth\n\nFix pkcs8 and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7482c8eaec3d09783646262216dceb77d0b6740b", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/7482c8eaec3d09783646262216dceb77d0b6740b", "committedDate": "2020-03-26T17:26:06Z", "message": "changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198b97d76a99f8353c01bf53e356797c520339b3", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/198b97d76a99f8353c01bf53e356797c520339b3", "committedDate": "2020-03-26T17:31:18Z", "message": "Make some changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13b27a4ec2358b73d1c7c79a01fca38a0f3f0e6b", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/13b27a4ec2358b73d1c7c79a01fca38a0f3f0e6b", "committedDate": "2020-03-26T17:34:34Z", "message": "Merge branch 'clientcertauth' of https://github.com/peterbae/mssql-jdbc into clientcertauth\n\n# Conflicts:\n#\tsrc/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7a6f9b8a349681e740a6e9f01207cf276a8d0b4", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/b7a6f9b8a349681e740a6e9f01207cf276a8d0b4", "committedDate": "2020-03-26T17:37:39Z", "message": "Add file not found catching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ada35398836d584d706a620e9bc0d397f87630", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/15ada35398836d584d706a620e9bc0d397f87630", "committedDate": "2020-03-26T17:45:15Z", "message": "Merge pull request #16 from rene-ye/clientcertauth\n\nClientcertauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4868fecda835757ed2ac1c7affca641c02945f8", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/a4868fecda835757ed2ac1c7affca641c02945f8", "committedDate": "2020-03-26T21:43:37Z", "message": "test changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDkxOTEy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382491912", "createdAt": "2020-03-26T23:37:44Z", "commit": {"oid": "a4868fecda835757ed2ac1c7affca641c02945f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzozNzo0NFrOF8ePwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzozNzo0NFrOF8ePwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1NDQzNA==", "bodyText": "This exception should be handled from the method that reads from the file, not here.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398954434", "createdAt": "2020-03-26T23:37:44Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -1880,6 +1891,8 @@ else if (con.getTrustManagerClass() != null) {\n                     && (SQLServerException.getErrString(\"R_truncatedServerResponse\").equals(errMsg)\n                             || SQLServerException.getErrString(\"R_truncatedServerResponse\").equals(causeErrMsg))) {\n                 con.terminate(SQLServerException.DRIVER_ERROR_INTERMITTENT_TLS_FAILED, form.format(msgArgs), e);\n+            } else if (e instanceof FileNotFoundException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4868fecda835757ed2ac1c7affca641c02945f8"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30b989dd92aa1781da43a6a4cc0fb279c62905a1", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/30b989dd92aa1781da43a6a4cc0fb279c62905a1", "committedDate": "2020-03-26T23:49:12Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce", "committedDate": "2020-03-27T00:22:37Z", "message": "handle exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTE4MTI5", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382518129", "createdAt": "2020-03-27T01:00:34Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMTowMDozNFrOF8ftHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMTowMDozNFrOF8ftHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3ODMzMw==", "bodyText": "Is this absolute path? Can applications also provide relative path?", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398978333", "createdAt": "2020-03-27T01:00:34Z", "author": {"login": "ulvii"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "diffHunk": "@@ -1597,9 +1598,16 @@ private void validateServerNameInCertificate(X509Certificate cert) throws Certif\n      *        Server Host Name for SSL Handshake\n      * @param port\n      *        Server Port for SSL Handshake\n+     * @param clientCertificate\n+     *        Client certificate path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTM2NjAw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382536600", "createdAt": "2020-03-27T02:04:14Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjowNDoxNFrOF8gtdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjowNDoxNFrOF8gtdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NDgwNg==", "bodyText": "You can use R_clientCertError from SQLServerResource.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398994806", "createdAt": "2020-03-27T02:04:14Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs1.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pkcs8Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs8.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs8EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs8.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxEncrytedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \"-encrypted.pfx;\" + \"clientKeyPassword=\"\r\n+                + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pvkTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".cer;\" + \"clientKey=\"\r\n+                + clientKey + \".pvk;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCert() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=invalid_path;\" + \"clientKeyPassword=\" + clientKeyPassword\r\n+                + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_invalidPath\")));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTM3MDkx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382537091", "createdAt": "2020-03-27T02:06:00Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjowNjowMFrOF8gvHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjowNjowMFrOF8gvHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NTIyOQ==", "bodyText": "We should not be hardcoding the file names like this. Please use config properties file and specify full file names in it.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398995229", "createdAt": "2020-03-27T02:06:00Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs1.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTM5MzU2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382539356", "createdAt": "2020-03-27T02:14:32Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjoxNDozMlrOF8g3WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjoxNDozMlrOF8g3WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NzMzNw==", "bodyText": "Why aren't you using new DataSource APIs? setClientCertificate(), setClientKey(), setClientKeyPassword", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398997337", "createdAt": "2020-03-27T02:14:32Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs1.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pkcs8Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs8.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs8EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs8.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxEncrytedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \"-encrypted.pfx;\" + \"clientKeyPassword=\"\r\n+                + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pvkTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".cer;\" + \"clientKey=\"\r\n+                + clientKey + \".pvk;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCert() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=invalid_path;\" + \"clientKeyPassword=\" + clientKeyPassword\r\n+                + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_invalidPath\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCertPassword() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\"\r\n+                + \"clientKeyPassword=invalid_password;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_keystorePassword\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void testDataSource() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTM5Njcy", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382539672", "createdAt": "2020-03-27T02:15:51Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjoxNTo1MVrOF8g4kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjoxNTo1MVrOF8g4kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NzY0OA==", "bodyText": "Use R_pvkParseError from SQLServerResource instead.", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r398997648", "createdAt": "2020-03-27T02:15:51Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs1.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs1.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pkcs8Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-pkcs8.key;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pkcs8EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pem;\" + \"clientKey=\"\r\n+                + clientKey + \"-encrypted-pkcs8.key;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void pfxEncrytedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \"-encrypted.pfx;\" + \"clientKeyPassword=\"\r\n+                + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void pvkTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".cer;\" + \"clientKey=\"\r\n+                + clientKey + \".pvk;\" + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            ResultSet rs = stmt.executeQuery(\"SELECT @@VERSION AS 'SQL Server Version'\");\r\n+            rs.next();\r\n+            assertTrue(rs.getString(1).contains(TestResource.getResource(\"R_microsoft\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCert() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=invalid_path;\" + \"clientKeyPassword=\" + clientKeyPassword\r\n+                + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_invalidPath\")));\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void invalidCertPassword() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + \".pfx;\"\r\n+                + \"clientKeyPassword=invalid_password;\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr)) {\r\n+        } catch (SQLServerException e) {\r\n+            assertTrue(e.getMessage().contains(TestResource.getResource(\"R_keystorePassword\")));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTk3NjY2", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382597666", "createdAt": "2020-03-27T06:02:37Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowMjozN1rOF8kKPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowMjozN1rOF8kKPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1MTMyNg==", "bodyText": "define this constant", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r399051326", "createdAt": "2020-03-27T06:02:37Z", "author": {"login": "lilgreenbird"}, "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -2629,7 +2654,7 @@ void Prelogin(String serverName, int portNumber) throws SQLServerException {\n                 0, 0, 0, 0, 0, 0,\n \n                 // - Encryption -\n-                requestedEncryptionLevel,\n+                (null == clientCertificate) ? requestedEncryptionLevel : (byte) (requestedEncryptionLevel | (byte) 0x80),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTk5NzAz", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-382599703", "createdAt": "2020-03-27T06:09:40Z", "commit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowOTo0MFrOF8kRLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowOTo0MFrOF8kRLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1MzEwMg==", "bodyText": "add description of what the tests are testing", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r399053102", "createdAt": "2020-03-27T06:09:40Z", "author": {"login": "lilgreenbird"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    @Test\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a2978f862c3307d09ec9f242b5ee7bdb45ba1ce"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d6b19d06e0001146924bdbfe135126b73c1a5f", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/b6d6b19d06e0001146924bdbfe135126b73c1a5f", "committedDate": "2020-03-27T16:36:31Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51596474568003c5aa7754b7b76711f336505c3a", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/51596474568003c5aa7754b7b76711f336505c3a", "committedDate": "2020-03-27T17:02:24Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTEzNjYx", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-383113661", "createdAt": "2020-03-27T18:40:37Z", "commit": {"oid": "51596474568003c5aa7754b7b76711f336505c3a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODo0MDozN1rOF89oSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODo0MDozN1rOF89oSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2ODYxNg==", "bodyText": "No need to create a statement", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#discussion_r399468616", "createdAt": "2020-03-27T18:40:37Z", "author": {"login": "ulvii"}, "path": "src/test/java/com/microsoft/sqlserver/clientcertauth/ClientCertificateAuthenticationTest.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\r\n+ * Microsoft JDBC Driver for SQL Server Copyright(c) Microsoft Corporation All rights reserved. This program is made\r\n+ * available under the terms of the MIT License. See the LICENSE file in the project root for more information.\r\n+ */\r\n+package com.microsoft.sqlserver.clientcertauth;\r\n+\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.DriverManager;\r\n+import java.sql.ResultSet;\r\n+import java.sql.Statement;\r\n+\r\n+import org.junit.jupiter.api.Tag;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.platform.runner.JUnitPlatform;\r\n+import org.junit.runner.RunWith;\r\n+\r\n+import com.microsoft.sqlserver.jdbc.SQLServerDataSource;\r\n+import com.microsoft.sqlserver.jdbc.SQLServerException;\r\n+import com.microsoft.sqlserver.jdbc.TestResource;\r\n+import com.microsoft.sqlserver.jdbc.TestUtils;\r\n+import com.microsoft.sqlserver.testframework.AbstractTest;\r\n+import com.microsoft.sqlserver.testframework.Constants;\r\n+\r\n+\r\n+/**\r\n+ * Tests client certificate authentication feature\r\n+ * The feature is only supported against SQL Server Linux CU2 or higher.\r\n+ * \r\n+ */\r\n+@RunWith(JUnitPlatform.class)\r\n+@Tag(Constants.xSQLv12)\r\n+@Tag(Constants.xSQLv14)\r\n+@Tag(Constants.xAzureSQLDW)\r\n+@Tag(Constants.xAzureSQLDB)\r\n+@Tag(Constants.clientCertAuth)\r\n+public class ClientCertificateAuthenticationTest extends AbstractTest {\r\n+\r\n+    static final String PEM_SUFFIX = \".pem;\";\r\n+    static final String CER_SUFFIX = \".cer;\";\r\n+    static final String PVK_SUFFIX = \".pvk;\";\r\n+\r\n+    static final String PKCS1_KEY_SUFFIX = \"-pkcs1.key;\";\r\n+    static final String ENCRYPTED_PKCS1_KEY_SUFFIX = \"-encrypted-pkcs1.key;\";\r\n+    static final String PKCS8_KEY_SUFFIX = \"-pkcs8.key;\";\r\n+    static final String ENCRYPTED_PKCS8_KEY_SUFFIX = \"-encrypted-pkcs8.key;\";\r\n+    static final String PFX_KEY_SUFFIX = \".pfx;\";\r\n+    static final String ENCRYPTED_PFX_KEY_SUFFIX = \"-encrypted.pfx;\";\r\n+\r\n+    /**\r\n+     * Tests client certificate authentication feature with PKCS1 private key.\r\n+     * \r\n+     * @throws Exception\r\n+     */\r\n+    @Test\r\n+    public void pkcs1Test() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + PEM_SUFFIX + \"clientKey=\"\r\n+                + clientKey + PKCS1_KEY_SUFFIX;\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r\n+            assertTrue(conn.isValid(1));\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n+     * Tests client certificate authentication feature with PKCS1 private key that has been encrypted with a password.\r\n+     * \r\n+     * @throws Exception\r\n+     */\r\n+    @Test\r\n+    public void pkcs1EncryptedTest() throws Exception {\r\n+        String conStr = connectionString + \";clientCertificate=\" + clientCertificate + PEM_SUFFIX + \"clientKey=\"\r\n+                + clientKey + ENCRYPTED_PKCS1_KEY_SUFFIX + \"clientKeyPassword=\" + clientKeyPassword + \";\";\r\n+        try (Connection conn = DriverManager.getConnection(conStr); Statement stmt = conn.createStatement()) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51596474568003c5aa7754b7b76711f336505c3a"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d223e039cc99f41f4e6abff9566a6db7e550535", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/5d223e039cc99f41f4e6abff9566a6db7e550535", "committedDate": "2020-03-27T18:58:00Z", "message": "dont need statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49ed48782f1538717321a73656dbfd475b08ed6e", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/49ed48782f1538717321a73656dbfd475b08ed6e", "committedDate": "2020-03-27T19:13:31Z", "message": "use datasoure api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0533b48be8560e0dd2d1f24f2cd0e60ee0218eda", "author": {"user": {"login": "rene-ye", "name": "v-reye"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/0533b48be8560e0dd2d1f24f2cd0e60ee0218eda", "committedDate": "2020-03-27T20:11:42Z", "message": "String match provider name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c347a2905d33172731871696989c790b62ca8596", "author": {"user": {"login": "peterbae", "name": "Peter Bae"}}, "url": "https://github.com/microsoft/mssql-jdbc/commit/c347a2905d33172731871696989c790b62ca8596", "committedDate": "2020-03-27T20:27:50Z", "message": "Merge pull request #17 from rene-ye/clientcertauth\n\nString match provider name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTg0MzI1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-383184325", "createdAt": "2020-03-27T20:38:25Z", "commit": {"oid": "c347a2905d33172731871696989c790b62ca8596"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTkxNzgw", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-383191780", "createdAt": "2020-03-27T20:51:37Z", "commit": {"oid": "c347a2905d33172731871696989c790b62ca8596"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjM4NTg1", "url": "https://github.com/microsoft/mssql-jdbc/pull/1284#pullrequestreview-383238585", "createdAt": "2020-03-27T22:42:06Z", "commit": {"oid": "c347a2905d33172731871696989c790b62ca8596"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2689, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}