{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NjI1ODEw", "number": 599, "title": "Add support for explicit sparse lists and maps", "bodyText": "The vast majority of all lists and maps in use today are dense, meaning\nthey cannot contain null values. However, we have historically had no\nway to indicate that a list or map (value) supports nulls, so we had to\nassume that all lists and maps are sparse. This change makes it so that\nall lists and maps are considered dense by default, but services can\nopt-in to sparse lists using the sparse trait. This matters because it\nnow allows languages that bake \"null\" into their type systems to provide\nbetter generated types.\nIssue #, if available:\nDescription of changes:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-08T03:06:45Z", "url": "https://github.com/awslabs/smithy/pull/599", "merged": true, "mergeCommit": {"oid": "8c07e24ca336be43a5514babbbc06de22d05633d"}, "closed": true, "closedAt": "2020-10-13T17:18:02Z", "author": {"login": "mtdowling"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQYtRwAFqTUwNDM5ODUwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSL296AFqTUwNzY2NTA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0Mzk4NTA4", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-504398508", "createdAt": "2020-10-08T03:07:11Z", "commit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMzowNzoxMlrOHeMYBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMzowNzoxMlrOHeMYBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMjA4Ng==", "bodyText": "I wasn't sure if this should be a \"constraint trait\" or a \"type refinement trait\"...", "url": "https://github.com/awslabs/smithy/pull/599#discussion_r501422086", "createdAt": "2020-10-08T03:07:12Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/spec/core/constraint-traits.rst", "diffHunk": "@@ -556,6 +556,48 @@ in a response.\n         }\n \n \n+.. _sparse-trait:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTkzNjE2", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-505993616", "createdAt": "2020-10-09T21:15:56Z", "commit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToxNTo1N1rOHfY02A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToyNzoxNFrOHfZEwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDY0OA==", "bodyText": "Feels like this should be a \"type refinement trait\" as it's dealing in the same realm as @box which lives there as well.", "url": "https://github.com/awslabs/smithy/pull/599#discussion_r502674648", "createdAt": "2020-10-09T21:15:57Z", "author": {"login": "kstich"}, "path": "docs/source/1.0/spec/core/constraint-traits.rst", "diffHunk": "@@ -556,6 +556,48 @@ in a response.\n         }\n \n \n+.. _sparse-trait:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMjA4Ng=="}, "originalCommit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3ODcyMQ==", "bodyText": "Needs to close with \"The following example defines a sparse map:\"", "url": "https://github.com/awslabs/smithy/pull/599#discussion_r502678721", "createdAt": "2020-10-09T21:27:14Z", "author": {"login": "kstich"}, "path": "docs/source/1.0/spec/core/model.rst", "diffHunk": "@@ -823,12 +863,55 @@ The following example defines a map of strings to integers:\n             }\n         }\n \n-.. rubric:: Providing keys for a map\n+.. rubric:: Map keys MUST NOT be ``null``\n \n Map keys are not permitted to be ``null``. Not all protocol serialization\n formats have a way to define ``null`` map keys, and map implementations\n across programming languages often do not allow ``null`` keys in maps.\n \n+.. rubric:: Map value member nullability\n+\n+Maps values are considered *dense* by default, meaning they MAY NOT contain\n+``null`` values. A map MAY be made *sparse* by applying the\n+:ref:`sparse-trait`. The :ref:`box-trait` is not used to determine if a map\n+is dense or sparse; a map with no ``@sparse`` trait is always considered\n+dense.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800"}, "originalPosition": 108}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc280fa113d67e59ef7e20acddcfa1cb6abd3800", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/cc280fa113d67e59ef7e20acddcfa1cb6abd3800", "committedDate": "2020-10-08T03:03:09Z", "message": "Add support for explicit sparse lists and maps\n\nThe vast majority of all lists and maps in use today are dense, meaning\nthey cannot contain null values. However, we have historically had no\nway to indicate that a list or map (value) supports nulls, so we had to\nassume that all lists and maps are sparse. This change makes it so that\nall lists and maps are considered dense by default, but services can\nopt-in to sparse lists using the `sparse` trait. This matters because it\nnow allows languages that bake \"null\" into their type systems to provide\nbetter generated types."}, "afterCommit": {"oid": "c831eb25a1ed164d555d8e3b497abcaa05fb3b46", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/c831eb25a1ed164d555d8e3b497abcaa05fb3b46", "committedDate": "2020-10-12T19:10:46Z", "message": "Add support for explicit sparse lists and maps\n\nThe vast majority of all lists and maps in use today are dense, meaning\nthey cannot contain null values. However, we have historically had no\nway to indicate that a list or map (value) supports nulls, so we had to\nassume that all lists and maps are sparse. This change makes it so that\nall lists and maps are considered dense by default, but services can\nopt-in to sparse lists using the `sparse` trait. This matters because it\nnow allows languages that bake \"null\" into their type systems to provide\nbetter generated types."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODY5NzM2", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-506869736", "createdAt": "2020-10-12T19:39:20Z", "commit": {"oid": "c831eb25a1ed164d555d8e3b497abcaa05fb3b46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTE3NjQx", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-506917641", "createdAt": "2020-10-12T21:07:38Z", "commit": {"oid": "c831eb25a1ed164d555d8e3b497abcaa05fb3b46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTkzMzQx", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-506993341", "createdAt": "2020-10-13T00:24:56Z", "commit": {"oid": "c831eb25a1ed164d555d8e3b497abcaa05fb3b46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/ac17950bbb9d19b8478c163134c2fc6f93c47780", "committedDate": "2020-10-13T00:58:13Z", "message": "Add support for explicit sparse lists and maps\n\nThe vast majority of all lists and maps in use today are dense, meaning\nthey cannot contain null values. However, we have historically had no\nway to indicate that a list or map (value) supports nulls, so we had to\nassume that all lists and maps are sparse. This change makes it so that\nall lists and maps are considered dense by default, but services can\nopt-in to sparse lists using the `sparse` trait. This matters because it\nnow allows languages that bake \"null\" into their type systems to provide\nbetter generated types.\n\nGiven that nullability is now more abstract than just the box trait, I\nthink that deprecating BoxIndex in favor of NullableIndex makes the\nconcept more clear. BoxIndex still exists and can be used, but extends\nfrom NullableIndex."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "059fd3a787b03eccca0658f9104e02f9d0ea8a89", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/059fd3a787b03eccca0658f9104e02f9d0ea8a89", "committedDate": "2020-10-13T00:54:17Z", "message": "Add BC note about sparse trait to guides"}, "afterCommit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/ac17950bbb9d19b8478c163134c2fc6f93c47780", "committedDate": "2020-10-13T00:58:13Z", "message": "Add support for explicit sparse lists and maps\n\nThe vast majority of all lists and maps in use today are dense, meaning\nthey cannot contain null values. However, we have historically had no\nway to indicate that a list or map (value) supports nulls, so we had to\nassume that all lists and maps are sparse. This change makes it so that\nall lists and maps are considered dense by default, but services can\nopt-in to sparse lists using the `sparse` trait. This matters because it\nnow allows languages that bake \"null\" into their type systems to provide\nbetter generated types.\n\nGiven that nullability is now more abstract than just the box trait, I\nthink that deprecating BoxIndex in favor of NullableIndex makes the\nconcept more clear. BoxIndex still exists and can be used, but extends\nfrom NullableIndex."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjM5Njgz", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-507639683", "createdAt": "2020-10-13T16:45:28Z", "commit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0NToyOFrOHgwRZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzowMzoyOFrOHgw8bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzM2Nw==", "bodyText": "Nit: use shape.isMemberShape() or store the optional.", "url": "https://github.com/awslabs/smithy/pull/599#discussion_r504107367", "createdAt": "2020-10-13T16:45:28Z", "author": {"login": "kstich"}, "path": "smithy-model/src/main/java/software/amazon/smithy/model/knowledge/NullableIndex.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.model.knowledge;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.shapes.MemberShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.shapes.ShapeType;\n+import software.amazon.smithy.model.shapes.ToShapeId;\n+import software.amazon.smithy.model.traits.BoxTrait;\n+import software.amazon.smithy.model.traits.SparseTrait;\n+import software.amazon.smithy.utils.SetUtils;\n+\n+/**\n+ * An index that checks if a shape can be set to null.\n+ */\n+public class NullableIndex implements KnowledgeIndex {\n+\n+    private static final Set<ShapeType> INHERENTLY_BOXED = SetUtils.of(\n+            ShapeType.STRING,\n+            ShapeType.BLOB,\n+            ShapeType.TIMESTAMP,\n+            ShapeType.BIG_DECIMAL,\n+            ShapeType.BIG_INTEGER,\n+            ShapeType.LIST,\n+            ShapeType.SET,\n+            ShapeType.MAP,\n+            ShapeType.STRUCTURE,\n+            ShapeType.UNION);\n+\n+    private final Set<ShapeId> nullableShapes = new HashSet<>();\n+\n+    public NullableIndex(Model model) {\n+        for (Shape shape : model.toSet()) {\n+            if (shape.asMemberShape().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExODM4MQ==", "bodyText": "This should state that it's the members of the sparse lists and maps.", "url": "https://github.com/awslabs/smithy/pull/599#discussion_r504118381", "createdAt": "2020-10-13T17:03:28Z", "author": {"login": "kstich"}, "path": "smithy-model/src/main/java/software/amazon/smithy/model/knowledge/NullableIndex.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.model.knowledge;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.shapes.MemberShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.shapes.ShapeType;\n+import software.amazon.smithy.model.shapes.ToShapeId;\n+import software.amazon.smithy.model.traits.BoxTrait;\n+import software.amazon.smithy.model.traits.SparseTrait;\n+import software.amazon.smithy.utils.SetUtils;\n+\n+/**\n+ * An index that checks if a shape can be set to null.\n+ */\n+public class NullableIndex implements KnowledgeIndex {\n+\n+    private static final Set<ShapeType> INHERENTLY_BOXED = SetUtils.of(\n+            ShapeType.STRING,\n+            ShapeType.BLOB,\n+            ShapeType.TIMESTAMP,\n+            ShapeType.BIG_DECIMAL,\n+            ShapeType.BIG_INTEGER,\n+            ShapeType.LIST,\n+            ShapeType.SET,\n+            ShapeType.MAP,\n+            ShapeType.STRUCTURE,\n+            ShapeType.UNION);\n+\n+    private final Set<ShapeId> nullableShapes = new HashSet<>();\n+\n+    public NullableIndex(Model model) {\n+        for (Shape shape : model.toSet()) {\n+            if (shape.asMemberShape().isPresent()) {\n+                if (isMemberNullable(model, shape.asMemberShape().get())) {\n+                    nullableShapes.add(shape.getId());\n+                }\n+            } else if (isShapeBoxed(shape)) {\n+                nullableShapes.add(shape.getId());\n+            }\n+        }\n+    }\n+\n+    public static NullableIndex of(Model model) {\n+        return model.getKnowledge(NullableIndex.class, NullableIndex::new);\n+    }\n+\n+    private static boolean isMemberNullable(Model model, MemberShape member) {\n+        Shape container = model.getShape(member.getContainer()).orElse(null);\n+\n+        // Ignore broken models in this index. Other validators handle these checks.\n+        if (container == null) {\n+            return false;\n+        }\n+\n+        switch (container.getType()) {\n+            case STRUCTURE:\n+                // Only structure shapes look at the box trait.\n+                return member.hasTrait(BoxTrait.class)\n+                       || model.getShape(member.getTarget()).filter(NullableIndex::isShapeBoxed).isPresent();\n+            case MAP:\n+                // Map keys can never be null.\n+                if (member.getMemberName().equals(\"key\")) {\n+                    return false;\n+                } // fall-through\n+            case LIST:\n+                // Sparse lists and maps are considered nullable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjY1MDQz", "url": "https://github.com/awslabs/smithy/pull/599#pullrequestreview-507665043", "createdAt": "2020-10-13T17:16:52Z", "commit": {"oid": "ac17950bbb9d19b8478c163134c2fc6f93c47780"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2150, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}