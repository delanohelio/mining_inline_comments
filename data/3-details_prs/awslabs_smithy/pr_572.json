{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4ODQzMzc3", "number": 572, "title": "Add flattenNamespaces transformer", "bodyText": "Adds flattenNamespaces transformer that flattens the namespaces of shapes connected to a specified service in a model into a target namespace.  Shapes that are not connected to the service will not be flattened, unless they have been tagged with a tag that has been included in the includeTagged configuration list.  Tagged shapes that conflict with an existing shape within the service closure will not be flattened.\nExample configuration:\n{\n    \"version\": \"1.0\",\n    \"projections\": {\n        \"exampleProjection\": {\n            \"transforms\": [\n                {\n                    \"name\": \"flattenNamespaces\",\n                    \"args\": {\n                        \"namespace\": \"ns.foo\",\n                        \"service\": \"ns.foo#MyService,\n                        \"includeTagged\": [\"include\", \"conflict\"],\n                    }\n                }\n            ]\n        }\n    }\n}\n\nInput model:\n{\n  \"smithy\": \"1.0\",\n  \"shapes\": {\n    \"ns.foo#MyService\": {\n      \"type\": \"service\",\n      \"version\": \"2017-01-19\",\n      \"operations\": [\n        {\n          \"target\": \"ns.bar#MyOperation\"\n        }\n      ]\n    },\n    \"ns.bar#MyOperation\": {\n      \"type\": \"operation\",\n      \"output\": {\n        \"target\": \"ns.baz#MyOperationOutput\"\n      }\n    },\n    \"ns.baz#MyOperationOutput\": {\n      \"type\": \"structure\",\n      \"members\": {\n        \"foo\": {\n          \"target\": \"smithy.api#String\"\n        }\n      }\n    },\n    \"ns.corge#UnconnectedFromService\": {\n      \"type\": \"string\",\n      \"traits\": {\n        \"smithy.api#tags\": [\"include\"]\n      }\n    },\n    \"ns.corge#MyOperationOutput\": {\n      \"type\": \"string\",\n      \"traits\": {\n        \"smithy.api#tags\": [\"conflict\"]\n      }\n    },\n    \"ns.corge#AnotherString\": {\n      \"type\": \"string\",\n      \"traits\": {\n        \"smithy.api#tags\": [\"ignored\"]\n      }\n    }\n  }\n}\n\n\nTransformed model:\n{\n  \"smithy\": \"1.0\",\n  \"shapes\": {\n    \"ns.foo#MyService\": {\n      \"type\": \"service\",\n      \"version\": \"2017-01-19\",\n      \"operations\": [\n        {\n          \"target\": \"ns.foo#MyOperation\"\n        }\n      ]\n    },\n    \"ns.foo#MyOperation\": {\n      \"type\": \"operation\",\n      \"output\": {\n        \"target\": \"ns.foo#MyOperationOutput\"\n      }\n    },\n    \"ns.foo#MyOperationOutput\": {\n      \"type\": \"structure\",\n      \"members\": {\n        \"foo\": {\n          \"target\": \"smithy.api#String\"\n        }\n      }\n    },\n    \"ns.foo#UnconnectedFromService\": {\n      \"traits\": {\n        \"smithy.api#tags\": [\"include\"]\n      }\n    }\n  }\n}\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-09-17T18:10:02Z", "url": "https://github.com/awslabs/smithy/pull/572", "merged": true, "mergeCommit": {"oid": "2b4e4c95bf8f240ed609ce96167bb86921bfd9f1"}, "closed": true, "closedAt": "2020-09-29T17:59:44Z", "author": {"login": "srchase"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLKo_3AFqTQ5MzAwNzA0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNrX3PAFqTQ5ODcwNTM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDA3MDQ1", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-493007045", "createdAt": "2020-09-21T21:53:49Z", "commit": {"oid": "736c00e6ae52c72fd5e264b9f8f6f0e8404a594d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTo1Mzo0OVrOHVjuHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTo1Mzo0OVrOHVjuHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NzM4OQ==", "bodyText": "I don't see how this would work if there are multiple services in a semantic model. They'd all be flattened into a single namespace? Can we instead require that a service property` is provided?\nCan we also add the ability to \"export\" shapes? It could be done by selector or by tags.", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r492367389", "createdAt": "2020-09-21T21:53:49Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -862,6 +862,49 @@ key is not in the provided ``keys`` list.\n             }\n         }\n \n+.. _flattenNamespaces:\n+\n+flattenNamespaces", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "736c00e6ae52c72fd5e264b9f8f6f0e8404a594d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/8d32b185b6eaf12c6457528f980397cbff15f4cd", "committedDate": "2020-09-22T16:20:33Z", "message": "Add flattenNamespaces transformer\n\nAdd license header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "736c00e6ae52c72fd5e264b9f8f6f0e8404a594d", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/736c00e6ae52c72fd5e264b9f8f6f0e8404a594d", "committedDate": "2020-09-17T20:48:46Z", "message": "Add license header"}, "afterCommit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/8d32b185b6eaf12c6457528f980397cbff15f4cd", "committedDate": "2020-09-22T16:20:33Z", "message": "Add flattenNamespaces transformer\n\nAdd license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODM4OTIy", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-493838922", "createdAt": "2020-09-22T20:54:29Z", "commit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo1NDozMFrOHWMA1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo1OToyNFrOHWMLLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNzU0Mw==", "bodyText": "Can you state that this is a shape ID?", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493027543", "createdAt": "2020-09-22T20:54:30Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -862,6 +862,62 @@ key is not in the provided ``keys`` list.\n             }\n         }\n \n+.. _flattenNamespaces:\n+\n+flattenNamespaces\n+-----------------\n+\n+Flattens namespaces of any shapes connected to a service into a target\n+namespace. Shapes not connected to a service will not be flattened.\n+\n+.. list-table::\n+    :header-rows: 1\n+    :widths: 10 20 70\n+\n+    * - Property\n+      - Type\n+      - Description\n+    * - namespace\n+      - ``string``\n+      - The target namespace.\n+    * - service\n+      - ``string``\n+      - The service to be flattened.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNzg3Nw==", "bodyText": "Does the original shape get removed, or is it copied into the new namespace? If the shape is replaced with the renamed version, then that means the ModelTransformer will rename all references to that shape, even references that might be in the closure of other services. That could be surprising if a shape is reused across multiple services. So we either need to explicitly call this out, or make it somehow only rename references to the shape that are part of the closure (i.e., service closure + tagged shapes).", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493027877", "createdAt": "2020-09-22T20:55:03Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -862,6 +862,62 @@ key is not in the provided ``keys`` list.\n             }\n         }\n \n+.. _flattenNamespaces:\n+\n+flattenNamespaces\n+-----------------\n+\n+Flattens namespaces of any shapes connected to a service into a target\n+namespace. Shapes not connected to a service will not be flattened.\n+\n+.. list-table::\n+    :header-rows: 1\n+    :widths: 10 20 70\n+\n+    * - Property\n+      - Type\n+      - Description\n+    * - namespace\n+      - ``string``\n+      - The target namespace.\n+    * - service\n+      - ``string``\n+      - The service to be flattened.\n+    * - includeTagged\n+      - ``[string]``\n+      - The set of tags that, if found on a shape not connected to the service,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyODI5OA==", "bodyText": "can you link to https://awslabs.github.io/smithy/1.0/spec/core/model.html#service-closure from \"service closure\"?", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493028298", "createdAt": "2020-09-22T20:55:50Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -862,6 +862,62 @@ key is not in the provided ``keys`` list.\n             }\n         }\n \n+.. _flattenNamespaces:\n+\n+flattenNamespaces\n+-----------------\n+\n+Flattens namespaces of any shapes connected to a service into a target\n+namespace. Shapes not connected to a service will not be flattened.\n+\n+.. list-table::\n+    :header-rows: 1\n+    :widths: 10 20 70\n+\n+    * - Property\n+      - Type\n+      - Description\n+    * - namespace\n+      - ``string``\n+      - The target namespace.\n+    * - service\n+      - ``string``\n+      - The service to be flattened.\n+    * - includeTagged\n+      - ``[string]``\n+      - The set of tags that, if found on a shape not connected to the service,\n+        forces the shape to have its namespace flattened into the target\n+        namespace.\n+\n+\n+The following example will flatten the namespaces of the shapes connected to\n+the ``ns.bar#MyService`` service into the target namespace, ``ns.foo``. Shapes\n+tagged with ``baz`` or ``qux`` will also be flattened into the ``ns.foo``\n+namespace, so long as they don't conflict with a shape within the service closure.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMDE5MA==", "bodyText": "This should at least log, but ideally throw, right?", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493030190", "createdAt": "2020-09-22T20:59:24Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.build.transforms;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.build.TransformContext;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.knowledge.NeighborProviderIndex;\n+import software.amazon.smithy.model.loader.Prelude;\n+import software.amazon.smithy.model.neighbor.Walker;\n+import software.amazon.smithy.model.shapes.ServiceShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.transform.ModelTransformer;\n+import software.amazon.smithy.utils.FunctionalUtils;\n+import software.amazon.smithy.utils.Pair;\n+\n+/**\n+ * {@code flattenNamespaces} updates a model by flattening the namespaces of\n+ * shapes connected to a service into a single, target namespace. When\n+ * configuring the transformer, a service and target namespace must be\n+ * specified. Optionally, tags can be specified for including any additional\n+ * shapes that should be flattened into the the target namespace. Any shape\n+ * from outside the service closure that is included via the application of a\n+ * tag will not be included if it conflicts with a shape in the service closure.\n+ */\n+public final class FlattenNamespaces extends ConfigurableProjectionTransformer<FlattenNamespaces.Config> {\n+\n+    /**\n+     * {@code removeTraitShapes} configuration settings.\n+     */\n+    public static final class Config {\n+\n+        private String namespace;\n+        private ShapeId service;\n+        private Set<String> tags = Collections.emptySet();\n+\n+        /**\n+         * Sets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @param namespace The target namespace to use in the model.\n+         */\n+        public void setNamespace(String namespace) {\n+            this.namespace = namespace;\n+        }\n+\n+        /**\n+         * Gets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @return the target namespace to be used in the model.\n+         */\n+        public String getNamespace() {\n+            return namespace;\n+        }\n+\n+        /**\n+         * Sets the service ShapeId that will be flattened into the target\n+         * namespace.\n+         *\n+         * @param service The ID of the service.\n+         */\n+        public void setService(ShapeId service) {\n+            this.service = service;\n+        }\n+\n+        /**\n+         * @return Gets the service shape ID of the service that will have\n+         * its shape namespaces updated.\n+         */\n+        public ShapeId getService() {\n+            return service;\n+        }\n+\n+        /**\n+         * Sets the set of tags that are retained in the model.\n+         *\n+         * @param tags The tags to retain in the model.\n+         */\n+        public void setIncludeTagged(Set<String> tags) {\n+            this.tags = tags;\n+        }\n+\n+        /**\n+         * Gets the set of tags that are retained in the model.\n+         *\n+         * @return Returns the tags to retain.\n+         */\n+        public Set<String> getIncludeTagged() {\n+            return tags;\n+        }\n+    }\n+\n+    @Override\n+    public Class<Config> getConfigType() {\n+        return Config.class;\n+    }\n+\n+    @Override\n+    protected Model transformWithConfig(TransformContext context, Config config) {\n+        Model model = context.getModel();\n+        Map<ShapeId, ShapeId> shapesToRename = getRenamedShapes(config, model);\n+        return ModelTransformer.create().renameShapes(model, shapesToRename);\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return \"flattenNamespaces\";\n+    }\n+\n+    private Map<ShapeId, ShapeId> getRenamedShapes(Config config, Model model) {\n+        // If no service has been specified, or the service is not present in\n+        // the model, return an empty map.\n+        if (config.service == null || !model.getShape(config.getService()).isPresent()) {\n+            return Collections.emptyMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d32b185b6eaf12c6457528f980397cbff15f4cd"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/33259f847331b0527042eecc6324fb8264657e4c", "committedDate": "2020-09-22T22:25:10Z", "message": "Throw on invalid config, update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTA1ODU0", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-495105854", "createdAt": "2020-09-23T23:03:03Z", "commit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzowMzowM1rOHXD0wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzowMzo0MlrOHXD1jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MTk1Mw==", "bodyText": "This might need a minor clarification. It's not just the additional shapes that are replaced, right? It's any shape that's considered part of the closure of the provided service.", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493941953", "createdAt": "2020-09-23T23:03:03Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -879,21 +879,23 @@ namespace. Shapes not connected to a service will not be flattened.\n       - Description\n     * - namespace\n       - ``string``\n-      - The target namespace.\n+      - **REQUIRED** The target namespace.\n     * - service\n-      - ``string``\n-      - The service to be flattened.\n+      - ``shapeId``\n+      - **REQUIRED** The service to be flattened.\n     * - includeTagged\n       - ``[string]``\n       - The set of tags that, if found on a shape not connected to the service,\n         forces the shape to have its namespace flattened into the target\n-        namespace.\n+        namespace. When additional shapes are included, the shapes are replaced", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MjAwNQ==", "bodyText": "nit: extra newline", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493942005", "createdAt": "2020-09-23T23:03:14Z", "author": {"login": "mtdowling"}, "path": "docs/source/1.0/guides/building-models/build-config.rst", "diffHunk": "@@ -879,21 +879,23 @@ namespace. Shapes not connected to a service will not be flattened.\n       - Description\n     * - namespace\n       - ``string``\n-      - The target namespace.\n+      - **REQUIRED** The target namespace.\n     * - service\n-      - ``string``\n-      - The service to be flattened.\n+      - ``shapeId``\n+      - **REQUIRED** The service to be flattened.\n     * - includeTagged\n       - ``[string]``\n       - The set of tags that, if found on a shape not connected to the service,\n         forces the shape to have its namespace flattened into the target\n-        namespace.\n+        namespace. When additional shapes are included, the shapes are replaced\n+        entirely, along with any references to the shapes which may exist within\n+        separate :ref:`service closure <service-closure>`.\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MjE1Nw==", "bodyText": "need space after 'service'", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493942157", "createdAt": "2020-09-23T23:03:42Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -115,6 +116,10 @@ public void setIncludeTagged(Set<String> tags) {\n \n     @Override\n     protected Model transformWithConfig(TransformContext context, Config config) {\n+        if (config.getService() == null || config.getNamespace() == null) {\n+            throw new SmithyBuildException(\n+                    \"'namespace' and 'service'properties must be set on flattenNamespace transformer.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTExOTM5", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-495111939", "createdAt": "2020-09-23T23:10:41Z", "commit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzoxMDo0MVrOHXEGmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzoxMjoxNlrOHXEKLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NjUyMA==", "bodyText": "model.getKnowledge(NeighborProviderIndex.class, NeighborProviderIndex::new) should be NeighborProviderIndex.of(model).", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493946520", "createdAt": "2020-09-23T23:10:41Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.build.transforms;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.build.SmithyBuildException;\n+import software.amazon.smithy.build.TransformContext;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.knowledge.NeighborProviderIndex;\n+import software.amazon.smithy.model.loader.Prelude;\n+import software.amazon.smithy.model.neighbor.Walker;\n+import software.amazon.smithy.model.shapes.ServiceShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.transform.ModelTransformer;\n+import software.amazon.smithy.utils.FunctionalUtils;\n+import software.amazon.smithy.utils.Pair;\n+\n+/**\n+ * {@code flattenNamespaces} updates a model by flattening the namespaces of\n+ * shapes connected to a service into a single, target namespace. When\n+ * configuring the transformer, a service and target namespace must be\n+ * specified. Optionally, tags can be specified for including any additional\n+ * shapes that should be flattened into the the target namespace. Any shape\n+ * from outside the service closure that is included via the application of a\n+ * tag will not be included if it conflicts with a shape in the service closure.\n+ */\n+public final class FlattenNamespaces extends ConfigurableProjectionTransformer<FlattenNamespaces.Config> {\n+\n+    /**\n+     * {@code removeTraitShapes} configuration settings.\n+     */\n+    public static final class Config {\n+\n+        private String namespace;\n+        private ShapeId service;\n+        private Set<String> tags = Collections.emptySet();\n+\n+        /**\n+         * Sets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @param namespace The target namespace to use in the model.\n+         */\n+        public void setNamespace(String namespace) {\n+            this.namespace = namespace;\n+        }\n+\n+        /**\n+         * Gets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @return the target namespace to be used in the model.\n+         */\n+        public String getNamespace() {\n+            return namespace;\n+        }\n+\n+        /**\n+         * Sets the service ShapeId that will be flattened into the target\n+         * namespace.\n+         *\n+         * @param service The ID of the service.\n+         */\n+        public void setService(ShapeId service) {\n+            this.service = service;\n+        }\n+\n+        /**\n+         * @return Gets the service shape ID of the service that will have\n+         * its shape namespaces updated.\n+         */\n+        public ShapeId getService() {\n+            return service;\n+        }\n+\n+        /**\n+         * Sets the set of tags that are retained in the model.\n+         *\n+         * @param tags The tags to retain in the model.\n+         */\n+        public void setIncludeTagged(Set<String> tags) {\n+            this.tags = tags;\n+        }\n+\n+        /**\n+         * Gets the set of tags that are retained in the model.\n+         *\n+         * @return Returns the tags to retain.\n+         */\n+        public Set<String> getIncludeTagged() {\n+            return tags;\n+        }\n+    }\n+\n+    @Override\n+    public Class<Config> getConfigType() {\n+        return Config.class;\n+    }\n+\n+    @Override\n+    protected Model transformWithConfig(TransformContext context, Config config) {\n+        if (config.getService() == null || config.getNamespace() == null) {\n+            throw new SmithyBuildException(\n+                    \"'namespace' and 'service'properties must be set on flattenNamespace transformer.\");\n+        }\n+        Model model = context.getModel();\n+        Map<ShapeId, ShapeId> shapesToRename = getRenamedShapes(config, model);\n+        return ModelTransformer.create().renameShapes(model, shapesToRename);\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return \"flattenNamespaces\";\n+    }\n+\n+    private Map<ShapeId, ShapeId> getRenamedShapes(Config config, Model model) {\n+        if (!model.getShape(config.getService()).isPresent()) {\n+            throw new SmithyBuildException(\"Service not found in model when performing flattenNamespaces transform.\");\n+        }\n+\n+        Map<ShapeId, ShapeId> shapesToRename = getRenamedShapesConnectedToService(config, model);\n+        Set<ShapeId> taggedShapesToInclude = getTaggedShapesToInclude(config.getIncludeTagged(), model);\n+\n+        for (ShapeId id : taggedShapesToInclude) {\n+            ShapeId updatedShapeId = updateNamespace(id, config.getNamespace());\n+            // If new shape ID already exists in map of shapes to rename, skip\n+            // including the additional shape to avoid a conflict.\n+            if (!shapesToRename.containsValue(updatedShapeId)) {\n+                shapesToRename.put(id, updatedShapeId);\n+            }\n+        }\n+\n+        return shapesToRename;\n+    }\n+\n+    private ShapeId updateNamespace(ShapeId shapeId, String namespace) {\n+        if (shapeId.getMember().isPresent()) {\n+            return ShapeId.fromParts(namespace, shapeId.getName(), shapeId.getMember().get());\n+        }\n+        return ShapeId.fromParts(namespace, shapeId.getName());\n+    }\n+\n+    private Map<ShapeId, ShapeId> getRenamedShapesConnectedToService(Config config, Model model) {\n+        Walker shapeWalker = new Walker(model.getKnowledge(NeighborProviderIndex.class, NeighborProviderIndex::new)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NzQzOA==", "bodyText": "We should probably validate that the shape is a service too. We might end up broadening support of this transform in the future to support other shapes, but may need different logic.", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r493947438", "createdAt": "2020-09-23T23:12:16Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.build.transforms;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.build.SmithyBuildException;\n+import software.amazon.smithy.build.TransformContext;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.knowledge.NeighborProviderIndex;\n+import software.amazon.smithy.model.loader.Prelude;\n+import software.amazon.smithy.model.neighbor.Walker;\n+import software.amazon.smithy.model.shapes.ServiceShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.transform.ModelTransformer;\n+import software.amazon.smithy.utils.FunctionalUtils;\n+import software.amazon.smithy.utils.Pair;\n+\n+/**\n+ * {@code flattenNamespaces} updates a model by flattening the namespaces of\n+ * shapes connected to a service into a single, target namespace. When\n+ * configuring the transformer, a service and target namespace must be\n+ * specified. Optionally, tags can be specified for including any additional\n+ * shapes that should be flattened into the the target namespace. Any shape\n+ * from outside the service closure that is included via the application of a\n+ * tag will not be included if it conflicts with a shape in the service closure.\n+ */\n+public final class FlattenNamespaces extends ConfigurableProjectionTransformer<FlattenNamespaces.Config> {\n+\n+    /**\n+     * {@code removeTraitShapes} configuration settings.\n+     */\n+    public static final class Config {\n+\n+        private String namespace;\n+        private ShapeId service;\n+        private Set<String> tags = Collections.emptySet();\n+\n+        /**\n+         * Sets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @param namespace The target namespace to use in the model.\n+         */\n+        public void setNamespace(String namespace) {\n+            this.namespace = namespace;\n+        }\n+\n+        /**\n+         * Gets the target namespace that existing namespaces will be flattened\n+         * into.\n+         *\n+         * @return the target namespace to be used in the model.\n+         */\n+        public String getNamespace() {\n+            return namespace;\n+        }\n+\n+        /**\n+         * Sets the service ShapeId that will be flattened into the target\n+         * namespace.\n+         *\n+         * @param service The ID of the service.\n+         */\n+        public void setService(ShapeId service) {\n+            this.service = service;\n+        }\n+\n+        /**\n+         * @return Gets the service shape ID of the service that will have\n+         * its shape namespaces updated.\n+         */\n+        public ShapeId getService() {\n+            return service;\n+        }\n+\n+        /**\n+         * Sets the set of tags that are retained in the model.\n+         *\n+         * @param tags The tags to retain in the model.\n+         */\n+        public void setIncludeTagged(Set<String> tags) {\n+            this.tags = tags;\n+        }\n+\n+        /**\n+         * Gets the set of tags that are retained in the model.\n+         *\n+         * @return Returns the tags to retain.\n+         */\n+        public Set<String> getIncludeTagged() {\n+            return tags;\n+        }\n+    }\n+\n+    @Override\n+    public Class<Config> getConfigType() {\n+        return Config.class;\n+    }\n+\n+    @Override\n+    protected Model transformWithConfig(TransformContext context, Config config) {\n+        if (config.getService() == null || config.getNamespace() == null) {\n+            throw new SmithyBuildException(\n+                    \"'namespace' and 'service'properties must be set on flattenNamespace transformer.\");\n+        }\n+        Model model = context.getModel();\n+        Map<ShapeId, ShapeId> shapesToRename = getRenamedShapes(config, model);\n+        return ModelTransformer.create().renameShapes(model, shapesToRename);\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return \"flattenNamespaces\";\n+    }\n+\n+    private Map<ShapeId, ShapeId> getRenamedShapes(Config config, Model model) {\n+        if (!model.getShape(config.getService()).isPresent()) {\n+            throw new SmithyBuildException(\"Service not found in model when performing flattenNamespaces transform.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33259f847331b0527042eecc6324fb8264657e4c"}, "originalPosition": 135}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTYzNzAz", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-497963703", "createdAt": "2020-09-28T23:24:57Z", "commit": {"oid": "1ec1787d77e507731770974721521ea1f0d51ed6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMzoyNDo1N1rOHZTE1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMzoyNToxMFrOHZTFLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4ODk4MQ==", "bodyText": "This could be model.expectShape(config.getService(), ServiceShape.class())", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r496288981", "createdAt": "2020-09-28T23:24:57Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -158,9 +158,13 @@ private ShapeId updateNamespace(ShapeId shapeId, String namespace) {\n     }\n \n     private Map<ShapeId, ShapeId> getRenamedShapesConnectedToService(Config config, Model model) {\n-        Walker shapeWalker = new Walker(model.getKnowledge(NeighborProviderIndex.class, NeighborProviderIndex::new)\n-                .getProvider());\n-        ServiceShape service = model.expectShape(config.getService(), ServiceShape.class);\n+        Walker shapeWalker = new Walker(NeighborProviderIndex.of(model).getProvider());\n+        Shape service = model.expectShape(config.getService());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec1787d77e507731770974721521ea1f0d51ed6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4OTA2OQ==", "bodyText": "You don't need toString in string concatenation", "url": "https://github.com/awslabs/smithy/pull/572#discussion_r496289069", "createdAt": "2020-09-28T23:25:10Z", "author": {"login": "mtdowling"}, "path": "smithy-build/src/main/java/software/amazon/smithy/build/transforms/FlattenNamespaces.java", "diffHunk": "@@ -158,9 +158,13 @@ private ShapeId updateNamespace(ShapeId shapeId, String namespace) {\n     }\n \n     private Map<ShapeId, ShapeId> getRenamedShapesConnectedToService(Config config, Model model) {\n-        Walker shapeWalker = new Walker(model.getKnowledge(NeighborProviderIndex.class, NeighborProviderIndex::new)\n-                .getProvider());\n-        ServiceShape service = model.expectShape(config.getService(), ServiceShape.class);\n+        Walker shapeWalker = new Walker(NeighborProviderIndex.of(model).getProvider());\n+        Shape service = model.expectShape(config.getService());\n+        if (!service.isServiceShape()) {\n+            throw new SmithyBuildException(\"Configured service, \" + config.getService().toString()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec1787d77e507731770974721521ea1f0d51ed6"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2c03da6f8aede0627f0d97ee2773495935596f", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/fe2c03da6f8aede0627f0d97ee2773495935596f", "committedDate": "2020-09-28T23:46:48Z", "message": "Throw when service is invalid"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ec1787d77e507731770974721521ea1f0d51ed6", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/1ec1787d77e507731770974721521ea1f0d51ed6", "committedDate": "2020-09-24T16:28:22Z", "message": "Throw when service is invalid"}, "afterCommit": {"oid": "fe2c03da6f8aede0627f0d97ee2773495935596f", "author": {"user": {"login": "srchase", "name": "Chase Coalwell"}}, "url": "https://github.com/awslabs/smithy/commit/fe2c03da6f8aede0627f0d97ee2773495935596f", "committedDate": "2020-09-28T23:46:48Z", "message": "Throw when service is invalid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NzA1Mzk5", "url": "https://github.com/awslabs/smithy/pull/572#pullrequestreview-498705399", "createdAt": "2020-09-29T17:10:14Z", "commit": {"oid": "fe2c03da6f8aede0627f0d97ee2773495935596f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2136, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}