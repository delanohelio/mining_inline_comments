{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5OTEyNzIy", "number": 645, "title": "Ensure waiter names are unique across a service", "bodyText": "Issue #, if available:\nDescription of changes:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-01T01:32:28Z", "url": "https://github.com/awslabs/smithy/pull/645", "merged": true, "mergeCommit": {"oid": "c82e37975782fef3cccfd5e38e48f481e4bf1aec"}, "closed": true, "closedAt": "2020-12-01T22:55:35Z", "author": {"login": "mtdowling"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh8eyUAFqTU0MjA1NzMxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh__7fgFqTU0MjI3MTEyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDU3MzEx", "url": "https://github.com/awslabs/smithy/pull/645#pullrequestreview-542057311", "createdAt": "2020-12-01T16:07:36Z", "commit": {"oid": "a0e74721f2c6ac8590d4ffa964eeea47a4572a04"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjowNzozN1rOH80QmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjowNzozN1rOH80QmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzMjgyNQ==", "bodyText": "This toLowerCase() call should have Locale.US set.", "url": "https://github.com/awslabs/smithy/pull/645#discussion_r533532825", "createdAt": "2020-12-01T16:07:37Z", "author": {"login": "kstich"}, "path": "smithy-waiters/src/main/java/software/amazon/smithy/waiters/UniqueWaiterNamesValidator.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.smithy.waiters;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+import software.amazon.smithy.model.Model;\n+import software.amazon.smithy.model.knowledge.TopDownIndex;\n+import software.amazon.smithy.model.shapes.OperationShape;\n+import software.amazon.smithy.model.shapes.ServiceShape;\n+import software.amazon.smithy.model.shapes.Shape;\n+import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.model.validation.AbstractValidator;\n+import software.amazon.smithy.model.validation.ValidationEvent;\n+import software.amazon.smithy.utils.SmithyInternalApi;\n+\n+/**\n+ * Ensures that no two waiters use the same case-insensitive name in the\n+ * closure of a service.\n+ */\n+@SmithyInternalApi\n+public final class UniqueWaiterNamesValidator extends AbstractValidator {\n+    @Override\n+    public List<ValidationEvent> validate(Model model) {\n+        return model.shapes(ServiceShape.class)\n+                .flatMap(service -> validateService(model, service).stream())\n+                .collect(Collectors.toList());\n+    }\n+\n+    private List<ValidationEvent> validateService(Model model, ServiceShape service) {\n+        Map<String, Set<OperationShape>> waiterNamesToOperations = computeWaiterNamesToOperations(model, service);\n+        List<ValidationEvent> events = new ArrayList<>();\n+\n+        for (Map.Entry<String, Set<OperationShape>> entry : waiterNamesToOperations.entrySet()) {\n+            if (entry.getValue().size() > 1) {\n+                for (OperationShape operation : entry.getValue()) {\n+                    Set<ShapeId> conflicts = entry.getValue().stream()\n+                            .filter(o -> !o.equals(operation))\n+                            .map(Shape::getId)\n+                            .collect(Collectors.toCollection(TreeSet::new));\n+                    events.add(error(operation, operation.expectTrait(WaitableTrait.class), String.format(\n+                            \"`%s` trait waiter name `%s` case-insensitively conflicts with waiters on other \"\n+                            + \"operations in the closure of service, `%s`: %s\",\n+                            WaitableTrait.ID,\n+                            entry.getKey(),\n+                            service.getId(),\n+                            conflicts)));\n+                }\n+            }\n+        }\n+\n+        return events;\n+    }\n+\n+    private Map<String, Set<OperationShape>> computeWaiterNamesToOperations(Model model, ServiceShape service) {\n+        TopDownIndex index = TopDownIndex.of(model);\n+        Map<String, Set<OperationShape>> waiterNamesToOperations = new TreeMap<>();\n+\n+        for (OperationShape operation : index.getContainedOperations(service)) {\n+            operation.getTrait(WaitableTrait.class).ifPresent(trait -> {\n+                for (String name : trait.getWaiters().keySet()) {\n+                    waiterNamesToOperations.computeIfAbsent(name.toLowerCase(), n -> new HashSet<>()).add(operation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0e74721f2c6ac8590d4ffa964eeea47a4572a04"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e0cd217165104ce992c514a11956161a62af45", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/e1e0cd217165104ce992c514a11956161a62af45", "committedDate": "2020-12-01T17:01:13Z", "message": "Ensure waiter names are unique across a service"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0e74721f2c6ac8590d4ffa964eeea47a4572a04", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/a0e74721f2c6ac8590d4ffa964eeea47a4572a04", "committedDate": "2020-12-01T01:30:49Z", "message": "Ensure waiter names are unique across a service"}, "afterCommit": {"oid": "e1e0cd217165104ce992c514a11956161a62af45", "author": {"user": {"login": "mtdowling", "name": "Michael Dowling"}}, "url": "https://github.com/awslabs/smithy/commit/e1e0cd217165104ce992c514a11956161a62af45", "committedDate": "2020-12-01T17:01:13Z", "message": "Ensure waiter names are unique across a service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjcxMTIz", "url": "https://github.com/awslabs/smithy/pull/645#pullrequestreview-542271123", "createdAt": "2020-12-01T20:30:35Z", "commit": {"oid": "e1e0cd217165104ce992c514a11956161a62af45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2170, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}