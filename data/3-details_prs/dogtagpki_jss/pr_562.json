{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNDExODg5", "number": 562, "title": "Remove JSSSocket wait-on-close, fix session cache creation", "bodyText": "There's two bugs found by #558:\n\nJSSSocket waiting-on-close takes a long time and doesn't work in all scenarios (e.g., wget won't send closure notifications so the socket will remain open forever). This also happens, e.g., with siege.\nSession cache creation can race, causing the JVM to segfault in NSS code. We use an AtomicBoolean to avoid this potential and ensure we only initialize the session cache once.\n\nWe also add one refactoring commit:\n\nThrow SSLExceptions instead of RuntimeExceptions during JSSEngine initialization.\n\nWe should probably merge this ahead of #558 merging.", "createdAt": "2020-05-21T15:16:38Z", "url": "https://github.com/dogtagpki/jss/pull/562", "merged": true, "mergeCommit": {"oid": "b01412ad28358a75b0f8bf9fd5900cf44d005b20"}, "closed": true, "closedAt": "2020-05-22T15:33:20Z", "author": {"login": "cipherboy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjelDFgH2gAyNDIxNDExODg5OjMxOGI2ZGNlZTdlMDNmM2Y0ZTllY2IxZTczMTBhYWUzMDYwN2RlZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjz0XLgBqjMzNjUxMjc4NjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "318b6dcee7e03f3f4e9ecb1e7310aae30607ded2", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/318b6dcee7e03f3f4e9ecb1e7310aae30607ded2", "committedDate": "2020-05-21T14:31:03Z", "message": "Don't wait for peer close confirmation\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5104c71909a9e50ff0b388cc93ae9613cc220f61", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/5104c71909a9e50ff0b388cc93ae9613cc220f61", "committedDate": "2020-05-21T14:54:05Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}, "afterCommit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/f0682ecb1630be759965ca104223c4b460ff7e77", "committedDate": "2020-05-21T15:18:34Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjU2OTgz", "url": "https://github.com/dogtagpki/jss/pull/562#pullrequestreview-416256983", "createdAt": "2020-05-21T15:35:29Z", "commit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTozNToyOVrOGY3vuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTo1MDozN1rOGY4ewA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczMjM0NQ==", "bodyText": "Could we throw an SSLException instead and declare it in this method? The JSSEngineReferenceImpl.beginHandshake() should have declared an SSLException so we can just let it bubble up.\nGenerally I'd rather not create a RuntimeException as the initial exception unless we can't declare the exception in the method.", "url": "https://github.com/dogtagpki/jss/pull/562#discussion_r428732345", "createdAt": "2020-05-21T15:35:29Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngine.java", "diffHunk": "@@ -249,6 +259,20 @@ protected static String errorText(int error) {\n         }\n     }\n \n+    /**\n+     * Safely initializes the session cache if not already initialized.\n+     */\n+    public static void initializeSessionCache(\n+        int maxCacheEntries, long timeout, String directory)\n+    {\n+        if (sessionCacheInitialized.compareAndSet(false, true)) {\n+            if (SSL.ConfigServerSessionIDCache(maxCacheEntries, timeout, timeout, directory) == SSL.SECFailure) {\n+                String msg = \"Unable to configure server session cache: \";\n+                msg += errorText(PR.GetError());\n+                throw new RuntimeException(msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNTU0MA==", "bodyText": "I think this should catch SSLException. See my other comment.", "url": "https://github.com/dogtagpki/jss/pull/562#discussion_r428735540", "createdAt": "2020-05-21T15:40:47Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/SSLServerSocket.java", "diffHunk": "@@ -266,9 +267,21 @@ public void close() throws IOException {\n      *  will contain the session cache. If null is passed, the server default\n      *  is used: <code>/tmp</code> on Unix and <code>\\\\temp</code> on Windows.\n      */\n-    public static native void configServerSessionIDCache(int maxSidEntries,\n-        int ssl2EntryTimeout, int ssl3EntryTimeout, String cacheFileDirectory)\n-        throws SocketException;\n+    public static void configServerSessionIDCache(int maxSidEntries,\n+        int ssl2EntryTimeout, int ssl3EntryTimeout, String cacheFileDirectory) throws SocketException {\n+        try {\n+            JSSEngine.initializeSessionCache(maxSidEntries, ssl3EntryTimeout, cacheFileDirectory);\n+        } catch (RuntimeException re) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc0NDM4NA==", "bodyText": "The AtomicBoolean should work fine, but a regular boolean sessionCacheInitialized and a synchronized initializeSessionCache() probably would work as well. It's up to you, whichever simpler.", "url": "https://github.com/dogtagpki/jss/pull/562#discussion_r428744384", "createdAt": "2020-05-21T15:50:37Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngine.java", "diffHunk": "@@ -176,6 +177,15 @@\n      */\n     protected static HashMap<PK11Cert, SSLFDProxy> serverTemplates = new HashMap<PK11Cert, SSLFDProxy>();\n \n+    /**\n+     * Whether or not the session cache has been initialized already.\n+     *\n+     * A session cache must always be created in order to utilize a\n+     * server-side JSSEngine. However, NSS isn't threadsafe when creating\n+     * such a cache, so synchronize it within JSSEngine.\n+     */\n+    private final static AtomicBoolean sessionCacheInitialized = new AtomicBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0682ecb1630be759965ca104223c4b460ff7e77", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/f0682ecb1630be759965ca104223c4b460ff7e77", "committedDate": "2020-05-21T15:18:34Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}, "afterCommit": {"oid": "ae4d6da1c9cf61d4031bbf53d60f02fc30720096", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/ae4d6da1c9cf61d4031bbf53d60f02fc30720096", "committedDate": "2020-05-21T17:01:01Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDU5NzM3", "url": "https://github.com/dogtagpki/jss/pull/562#pullrequestreview-416459737", "createdAt": "2020-05-21T20:16:32Z", "commit": {"oid": "ae4d6da1c9cf61d4031bbf53d60f02fc30720096"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDoxNjozMlrOGZBXRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDoxNzo1NFrOGZBZ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4OTkyNA==", "bodyText": "IllegalArgumentException is a RuntimeException so it doesn't have to be declared.", "url": "https://github.com/dogtagpki/jss/pull/562#discussion_r428889924", "createdAt": "2020-05-21T20:16:32Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -196,31 +196,31 @@ private void createBufferFD() {\n         // Turn on SSL Alert Logging for the ssl_fd object.\n         int ret = SSL.EnableAlertLogging(ssl_fd);\n         if (ret == SSL.SECFailure) {\n-            throw new RuntimeException(\"JSSEngine.init(): Unable to enable SSL Alert Logging on this SSLFDProxy instance.\");\n+            throw new SSLException(\"Unable to enable SSL Alert Logging on this SSLFDProxy instance.\");\n         }\n \n         ret = SSL.EnableHandshakeCallback(ssl_fd);\n         if (ret == SSL.SECFailure) {\n-            throw new RuntimeException(\"JSSEngine.init(): Unable to enable SSL Handshake Callback on this SSLFDProxy instance.\");\n+            throw new SSLException(\"Unable to enable SSL Handshake Callback on this SSLFDProxy instance.\");\n         }\n \n         // Pass this ssl_fd to the session object so that we can use\n         // SSL methods to invalidate the session.\n     }\n \n-    private void initClient() {\n+    private void initClient() throws SSLException {\n         debug(\"JSSEngine: initClient()\");\n \n         if (cert != null && key != null) {\n             debug(\"JSSEngine.initClient(): Enabling client auth: \" + cert);\n             ssl_fd.SetClientCert(cert);\n             if (SSL.AttachClientCertCallback(ssl_fd) != SSL.SECSuccess) {\n-                throw new RuntimeException(\"JSSEngine.init(): Unable to attach client certificate auth callback.\");\n+                throw new SSLException(\"Unable to attach client certificate auth callback.\");\n             }\n         }\n     }\n \n-    private void initServer() {\n+    private void initServer() throws SSLException, IllegalArgumentException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4d6da1c9cf61d4031bbf53d60f02fc30720096"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDU3Ng==", "bodyText": "It should say SSLException instead.", "url": "https://github.com/dogtagpki/jss/pull/562#discussion_r428890576", "createdAt": "2020-05-21T20:17:54Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/SSLServerSocket.java", "diffHunk": "@@ -266,9 +269,21 @@ public void close() throws IOException {\n      *  will contain the session cache. If null is passed, the server default\n      *  is used: <code>/tmp</code> on Unix and <code>\\\\temp</code> on Windows.\n      */\n-    public static native void configServerSessionIDCache(int maxSidEntries,\n-        int ssl2EntryTimeout, int ssl3EntryTimeout, String cacheFileDirectory)\n-        throws SocketException;\n+    public static void configServerSessionIDCache(int maxSidEntries,\n+        int ssl2EntryTimeout, int ssl3EntryTimeout, String cacheFileDirectory) throws SocketException {\n+        try {\n+            JSSEngine.initializeSessionCache(maxSidEntries, ssl3EntryTimeout, cacheFileDirectory);\n+        } catch (SSLException parent) {\n+            // Because JSSEngine.initializeSessionCache is utilized during\n+            // init of JSSengine implementations, it can only throw a\n+            // RuntimeException. However, in the event it fails, we should", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4d6da1c9cf61d4031bbf53d60f02fc30720096"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48f2f58d74f3e54e2ca4a0b0dcb2a0ccf310d2cb", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/48f2f58d74f3e54e2ca4a0b0dcb2a0ccf310d2cb", "committedDate": "2020-05-22T15:14:47Z", "message": "Throw SSLException in JSSEngineReferenceImpl.init\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb7400619eabb0ec78224de5f23a15af9436941f", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/bb7400619eabb0ec78224de5f23a15af9436941f", "committedDate": "2020-05-22T15:15:35Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae4d6da1c9cf61d4031bbf53d60f02fc30720096", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/ae4d6da1c9cf61d4031bbf53d60f02fc30720096", "committedDate": "2020-05-21T17:01:01Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}, "afterCommit": {"oid": "bb7400619eabb0ec78224de5f23a15af9436941f", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/bb7400619eabb0ec78224de5f23a15af9436941f", "committedDate": "2020-05-22T15:15:35Z", "message": "Fix race in configuring session cache\n\nWhen multiple JSSSockets and/or JSSEngines are started concurrently,\nthey will race to configure the session cache. However, the cache can\nonly be created by one thread at a time and only needs to be done once\nin the lifetime of JSS. Make JSSEngine take ownership of cache creation\nand utilize this within the legacy SSLSocket as well.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1518, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}