{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MzA4MDQ5", "number": 602, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToyODo0MlrOERMCnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoyM1rOERMWVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDU4NTI3OnYy", "diffSide": "RIGHT", "path": "org/mozilla/jss/provider/javax/crypto/JSSTokenKeyManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToyODo0MlrOG1xEPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MjozM1rOG1xhuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMTYxNA==", "bodyText": "Does it mean we need to do this in PKI as well? Or will PK11Cert.close() get called automatically when it's garbage collected?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459031614", "createdAt": "2020-07-22T19:28:42Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/provider/javax/crypto/JSSTokenKeyManager.java", "diffHunk": "@@ -118,8 +118,10 @@ public PrivateKey getPrivateKey(String alias) {\n \n         try {\n             if (jks == null) {\n-                org.mozilla.jss.crypto.X509Certificate cert = cm.findCertByNickname(alias);\n-                return cm.findPrivKeyByCert(cert);\n+                try (PK11Cert cert = (PK11Cert) cm.findCertByNickname(alias)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTE2MQ==", "bodyText": "No, this isn't strictly necessary. It'll get called automatically when it is garbage collected. However, because the scope is small here, it is good to use the try-with-resources pattern to ensure it gets closed and freed quickly. This means the GC pass will just clean up the destroyed Java objects (PK11Cert, CertProxy, and TokenProxy instances), and not need to call into the JNI layer to free NSS stuff.", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039161", "createdAt": "2020-07-22T19:42:33Z", "author": {"login": "cipherboy"}, "path": "org/mozilla/jss/provider/javax/crypto/JSSTokenKeyManager.java", "diffHunk": "@@ -118,8 +118,10 @@ public PrivateKey getPrivateKey(String alias) {\n \n         try {\n             if (jks == null) {\n-                org.mozilla.jss.crypto.X509Certificate cert = cm.findCertByNickname(alias);\n-                return cm.findPrivKeyByCert(cert);\n+                try (PK11Cert cert = (PK11Cert) cm.findCertByNickname(alias)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMTYxNA=="}, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDU5MTU2OnYy", "diffSide": "RIGHT", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozMDoyN1rOG1xICw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoxMlrOG1xjJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMjU4Nw==", "bodyText": "Do we need to call fd.clear() if ssl_fd == null?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459032587", "createdAt": "2020-07-22T19:30:27Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTUyNw==", "bodyText": "We should probably close it, not clear it in that case. I'll update it.", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039527", "createdAt": "2020-07-22T19:43:12Z", "author": {"login": "cipherboy"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMjU4Nw=="}, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDYzNTc1OnYy", "diffSide": "RIGHT", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoyM1rOG1xjew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0NTo1NVrOG1xooQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTYxMQ==", "bodyText": "fd is a local variable, and usually it's not necessary to nullify a local variable, but do you think it's necessary here?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039611", "createdAt": "2020-07-22T19:43:23Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();\n+        fd = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0MDkyOQ==", "bodyText": "It isn't necessary to nullify a local variable to trigger the GC, I agree.\nHowever, it just ensures that if we were to use fd again later without thinking about it, we'd get a NPE rather than a segfault (if we tried to call into the JNI layer using fd again and something didn't adequately defend against a cleared pointer).\nIMO this is preferable so I nulled it.", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459040929", "createdAt": "2020-07-22T19:45:55Z", "author": {"login": "cipherboy"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();\n+        fd = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTYxMQ=="}, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2588, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}