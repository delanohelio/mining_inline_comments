{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MzA4MDQ5", "number": 602, "title": "Fix SSLEngine memory leaks", "bodyText": "This fixes two memory leaks in SSLEngine, and reduces memory pressure by handling certain other cases.\n\nLeaked PRFDProxy in JSSEngineReferenceImpl.createBufferFD().\nWhen SSL_ImportFD is called, NSS merges the second argument into the return value, by way of pushing a NSPR on top of the argument. This layer is the SSL layer and the second argument is \"consumed\" by the SSL PRFileDesc *. Java doesn't know about this, so we need to manually clear (not close!!) the PRFDProxy instance and set it to null to avoid leaking it. (Otherwise, NativeProxy retains a reference to it, preventing the Java object from being garbage collected).\nLeaked TokenProxy in JSSTokenKeyManager.\nWhen the CryptoManager returns the new PK11Cert instance, it contains a CertProxy and a TokenProxy; the latter wasn't explicitly cleared/freed by PK11Cert. This meant NativeProxy still had a reference to it, preventing the TokenProxy Java object from being garbage collected. As the comment indicates, this isn't a memory leak in NSS, because Tokens (er, Slots) are long-term, reference-counted objects with the same pointer value. NSS presumably remains initialized throughout the lifetime of the program, so no leak really occurs until shutdown (if CryptoManager.shutdown() is actually called).\n\nAdditionally, we:\n\nHandle null return from SSL_ImportFD correctly,\nAllow SSLSessions to \"close\", allowing us to release their resources. Note that invalidating a session is separate from closing a session. This gives us more control over when a session's certificates are freed, than leaving it to the garbage collector.\nEnsure JSSSocketChannel closes the inbound side of the wrapped JSSEngine.\nEnsure JSSSocket isn't used after being closed.", "createdAt": "2020-07-22T19:20:49Z", "url": "https://github.com/dogtagpki/jss/pull/602", "merged": true, "mergeCommit": {"oid": "f426d2e452587649e67afcdf9889b5500d9e3178"}, "closed": true, "closedAt": "2020-07-22T20:18:55Z", "author": {"login": "cipherboy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3cGS0AH2gAyNDU1MzA4MDQ5OjFiNTEwOWM3MzBiNzM5NzFmZmZiNGQ0NDE3YzhlOWRhNTE4NzYxODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3geCIgBqjM1NzczNDc4NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b5109c730b73971fffb4d4417c8e9da51876184", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/1b5109c730b73971fffb4d4417c8e9da51876184", "committedDate": "2020-07-22T14:56:08Z", "message": "Handle NULL return from SSL_ImportFD\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098899a5c70575e0eb220fd023d17206081e953a", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/098899a5c70575e0eb220fd023d17206081e953a", "committedDate": "2020-07-22T14:56:27Z", "message": "Close SSLEngine inbound during socket close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a3decbff23a233e7adfe9cdd0ba21d8998ef1dc", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/3a3decbff23a233e7adfe9cdd0ba21d8998ef1dc", "committedDate": "2020-07-22T14:57:15Z", "message": "Track SSLSocket close, inform user on re-use\n\nSockets in Java cannot be reused, per javadocs:\n\n    Once a socket has been closed, it is not available for\n    further networking use (i.e. can't be reconnected or\n    rebound). A new socket needs to be created.\n\nPrevent this use in JSSSocket.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "433ab6bd11c53f1261033f92fb9afec246493a4f", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/433ab6bd11c53f1261033f92fb9afec246493a4f", "committedDate": "2020-07-22T18:01:22Z", "message": "Fix TokenProxy leak\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3e2e8adba8939ebdeca41e3de272905bfe99e09", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/e3e2e8adba8939ebdeca41e3de272905bfe99e09", "committedDate": "2020-07-22T18:01:43Z", "message": "Allow sessions to clear PK11Cert instances\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjE5OTkx", "url": "https://github.com/dogtagpki/jss/pull/602#pullrequestreview-453619991", "createdAt": "2020-07-22T19:28:41Z", "commit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToyODo0MlrOG1xEPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozMDoyN1rOG1xICw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMTYxNA==", "bodyText": "Does it mean we need to do this in PKI as well? Or will PK11Cert.close() get called automatically when it's garbage collected?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459031614", "createdAt": "2020-07-22T19:28:42Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/provider/javax/crypto/JSSTokenKeyManager.java", "diffHunk": "@@ -118,8 +118,10 @@ public PrivateKey getPrivateKey(String alias) {\n \n         try {\n             if (jks == null) {\n-                org.mozilla.jss.crypto.X509Certificate cert = cm.findCertByNickname(alias);\n-                return cm.findPrivKeyByCert(cert);\n+                try (PK11Cert cert = (PK11Cert) cm.findCertByNickname(alias)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMjU4Nw==", "bodyText": "Do we need to call fd.clear() if ssl_fd == null?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459032587", "createdAt": "2020-07-22T19:30:27Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjI5NzM3", "url": "https://github.com/dogtagpki/jss/pull/602#pullrequestreview-453629737", "createdAt": "2020-07-22T19:43:23Z", "commit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoyM1rOG1xjew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoyM1rOG1xjew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTYxMQ==", "bodyText": "fd is a local variable, and usually it's not necessary to nullify a local variable, but do you think it's necessary here?", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039611", "createdAt": "2020-07-22T19:43:23Z", "author": {"login": "edewata"}, "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();\n+        fd = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "committedDate": "2020-07-22T20:01:25Z", "message": "Clear PRFDProxy after import, session on close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b93e6580be8427aa8175cf8eba3e4f05675b477b", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/b93e6580be8427aa8175cf8eba3e4f05675b477b", "committedDate": "2020-07-22T18:02:05Z", "message": "Clear PRFDProxy after import, session on close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}, "afterCommit": {"oid": "bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "author": {"user": {"login": "cipherboy", "name": "Alexander Scheel"}}, "url": "https://github.com/dogtagpki/jss/commit/bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "committedDate": "2020-07-22T20:01:25Z", "message": "Clear PRFDProxy after import, session on close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1446, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}