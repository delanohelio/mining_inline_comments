{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjA3OTMy", "number": 3157, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MToyNlrODxAkOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTowNTozOFrODxJC5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzE2MDkwOnYy", "diffSide": "RIGHT", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MToyNlrOGER6rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwNDoyNToyNFrOGESGGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTAzNw==", "bodyText": "This is definitely the wrong thing to run here.\nShould instead be user.cleanup() - user.dispose() will create an async task to eventually call user.cleanup, which will throw an exception. (Or should, since the server is shutting down).", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141037", "createdAt": "2020-04-12T03:41:26Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0Mzk2MA==", "bodyText": "Ah okay, got confused on what did what :P", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407143960", "createdAt": "2020-04-12T04:25:24Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTAzNw=="}, "originalCommit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzE2MTQwOnYy", "diffSide": "RIGHT", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MjowOFrOGER64Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MjowOFrOGER64Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTA4OQ==", "bodyText": "Wrap in else and remove continue - helps convey flow.", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141089", "createdAt": "2020-04-12T03:42:08Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();\n+                continue;\n+            }\n             user.stopTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyODU1MDEyOnYy", "diffSide": "RIGHT", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTowNTozOFrOGEc2mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODowMjo1MlrOGEfvMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyMDIxOA==", "bodyText": "@md678685 shouldn't this be called anyways (regardless of shutdown)? Could see instances where this isn't called on Disable due to a /reload or plugman bullshit where we lose data.", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407320218", "createdAt": "2020-04-13T05:05:38Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,12 +373,29 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n-            user.stopTransaction();\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.cleanup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def752e4db6c69406464fcf33723ff57c5250814"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2NzQ3Mg==", "bodyText": "stopTransaction and cleanup both run a save task on another thread, but cleanup waits for that task to complete. Running cleanup during a reload means the server will hang up while saving data for everyone, which isn't necessary. I'm pretty sure loading the user data would wait for the save task regardless, if we actually are reloading.", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407367472", "createdAt": "2020-04-13T08:02:52Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,12 +373,29 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n-            user.stopTransaction();\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.cleanup();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyMDIxOA=="}, "originalCommit": {"oid": "def752e4db6c69406464fcf33723ff57c5250814"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4660, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}