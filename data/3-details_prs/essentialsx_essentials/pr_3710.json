{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NTg3ODgy", "number": 3710, "title": "Rework Mail System", "bodyText": "New /mail sendtemp <time diff> <message> command to send mail that will self-destruct after time diff.\nNew /mail clear <number> command to clear a specific mail item.\n/mail read now tracks which mails you read and won't nag you about them.\nA bunch of other flexibility since we store actual data instead of strings\n\n\n  No longer relavant json format since new format will serialize to YAML using configurate object mappers\nMail Schema:\n{\n  \"mail\": [\n    {\n      \"read\": false, //bool which if true will show the mail item as gray italic to the user when read otherwise white\n      \"sender\": \"JRoy\", //String because fetching User objects sounds like a bad idea\n      \"uuid\": \"abcde-abcd-acd12-12334\", // Not currently used but stored for possible future use of for a server admin's reference\n      \"timestamp\": 1234567890, //Epoch allows timestamp format to be changed (or per-player timezones in the future)\n      \"expire\": 1234567890, //Epoch at which this mail should be deleted and not shown to the user or 0 if it does not expire\n      \"message\": \"Cool message, yo\" //Actual message, possibly with color codes\n    },\n    {\n      \"read\": false, //bool which if true will show the mail item as gray italic to the user when read otherwise white\n      \"legacy\": true, //bool but Value of this doesn't matter as it just instructs the parser to not expect the other *unknown* values\n      \"message\": \"JRoy: this is a message that was sent before fancy system\" //Actual message\n    }\n  ]\n}\n\nCloses #364\nCloses #1527\nCloses #1860\nCloses #3097", "createdAt": "2020-10-05T05:18:15Z", "url": "https://github.com/EssentialsX/Essentials/pull/3710", "merged": true, "mergeCommit": {"oid": "9c451271e0a9d29cb689e02e34302172e063ddd6"}, "closed": true, "closedAt": "2021-07-01T15:23:33Z", "author": {"login": "JRoy"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPc8ijAFqTUwMTcyODcyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABemKmGzgH2gAyNDk3NTg3ODgyOjE4MmZkM2VkMzIxZmUzMDBjNTkwNTQzODMyNzQ5NmNiMmQxYWEwZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzI4NzIz", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-501728723", "createdAt": "2020-10-05T05:23:13Z", "commit": {"oid": "28aaec3edf025cb7db4624cbe9a89dcf948c5697"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNToyMzoxNFrOHcN-cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNToyMzoxNFrOHcN-cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1MTE1Mw==", "bodyText": "No space before ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);\n          \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean() ? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r499351153", "createdAt": "2020-10-05T05:23:14Z", "author": {"login": "l1ttleO"}, "path": "Essentials/src/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    @Deprecated\n+    public void sendLegacyMail(IUser user, String message) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"legacy\", true);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    public String getMailLine(JsonObject mail) {\n+        String message = mail.get(\"message\").getAsString();\n+        if (mail.has(\"legacy\")) {\n+            return tl(\"mailMessage\", message);\n+        }\n+        return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28aaec3edf025cb7db4624cbe9a89dcf948c5697"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a8b53e852ae5362b301298c5c63e15df63e8500", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/5a8b53e852ae5362b301298c5c63e15df63e8500", "committedDate": "2020-11-25T21:39:43Z", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java"}, "afterCommit": {"oid": "86c39144e3eedf25516bf379686456f6b7a54975", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/86c39144e3eedf25516bf379686456f6b7a54975", "committedDate": "2020-11-25T21:45:42Z", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86c39144e3eedf25516bf379686456f6b7a54975", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/86c39144e3eedf25516bf379686456f6b7a54975", "committedDate": "2020-11-25T21:45:42Z", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java"}, "afterCommit": {"oid": "fe1fef9fd08bdead56977065ceeb09584cdd2130", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/fe1fef9fd08bdead56977065ceeb09584cdd2130", "committedDate": "2020-11-25T21:46:53Z", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc0ODU3Njc0", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-574857674", "createdAt": "2021-01-23T16:13:47Z", "commit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "state": "DISMISSED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxMzo0N1rOIZFKEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozNDoyNFrOIZFSdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE2OTgxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563169811", "createdAt": "2021-01-23T16:13:47Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Console.java", "diffHunk": "@@ -46,6 +48,11 @@ public String getName() {\n         return Console.NAME;\n     }\n \n+    @Override\n+    public UUID getUuid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA4OA==", "bodyText": "Gson should not be a part of the API.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170088", "createdAt": "2021-01-23T16:16:19Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA5Mw==", "bodyText": "Ditto", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170093", "createdAt": "2021-01-23T16:16:24Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();\n+\n+    int getMailAmount();\n+\n+    void setMailArray(JsonArray mailArray);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDY3OA==", "bodyText": "I'd prefer we avoid IMessageRecipient - it's part of a messaging abstraction that was never actually implemented and should probably be phased out. I'd rather we just use IUser, or if absolutely necessary, add our own MailRecipient interface (not sure what the benefit is when all message recipients will be users though).", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170678", "createdAt": "2021-01-23T16:21:48Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDkwOQ==", "bodyText": "Would much prefer we used a plain/immutable MailMessage/Mail.Message class for individual mails' data. This would let us object map + expose a much nicer mails API. Also, I'm not a huge fan of shoving JSON inside a string in another YAML file; may want to consider storing mails in a mails.json or something similar instead.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170909", "createdAt": "2021-01-23T16:24:29Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTM5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171393", "createdAt": "2021-01-23T16:28:30Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/User.java", "diffHunk": "@@ -917,6 +916,11 @@ public String getName() {\n         return this.getBase().getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and should not be used.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171700", "createdAt": "2021-01-23T16:31:34Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and will fail at runtime.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171723", "createdAt": "2021-01-23T16:32:00Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTc5MQ==", "bodyText": "I'm not sure why this isn't still just implemented in UserData?", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171791", "createdAt": "2021-01-23T16:32:34Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated\n+    abstract void addMail(String mail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTk1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UUID getUuid();\n          \n          \n            \n                UUID getUUID();", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171959", "createdAt": "2021-01-23T16:34:24Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "diffHunk": "@@ -48,6 +50,13 @@\n      */\n     String getName();\n \n+    /**\n+     * Returns the UUID of this recipient. If the recipient is the console, null is returned.\n+     *\n+     * @return UUID of the this recipient or null if its console.\n+     */\n+    UUID getUuid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc0ODgyNjEz", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-574882613", "createdAt": "2021-01-23T22:57:46Z", "commit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1Nzo0NlrOIZHmQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1Nzo0NlrOIZHmQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTc5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n          \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUUID() == null ? \"null\" : sender.getUUID().toString());", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209794", "createdAt": "2021-01-23T22:57:46Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc0ODgyNjQ3", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-574882647", "createdAt": "2021-01-23T22:58:36Z", "commit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1ODozNlrOIZHmfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1ODozNlrOIZHmfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTg1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                    return this.parent.getUuid();\n          \n          \n            \n                public UUID getUUID() {\n          \n          \n            \n                    return this.parent.getUUID();", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209854", "createdAt": "2021-01-23T22:58:36Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/SimpleMessageRecipient.java", "diffHunk": "@@ -60,6 +61,11 @@ public String getName() {\n         return this.parent.getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {\n+        return this.parent.getUuid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc1MTAwMTA0", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-575100104", "createdAt": "2021-01-25T06:42:56Z", "commit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mjo1NlrOIZYyQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mzo0MVrOIZYzJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTM5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String sender;\n          \n          \n            \n                private final String senderName;", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491392", "createdAt": "2021-01-25T06:42:56Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTQxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final UUID uuid;\n          \n          \n            \n                private final UUID senderId;", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491412", "createdAt": "2021-01-25T06:42:58Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;\n+    private final UUID uuid;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTU1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    object.get(\"sender\").getAsString(),\n          \n          \n            \n                                    object.get(\"senderName\").getAsString(),", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491552", "createdAt": "2021-01-25T06:43:29Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTYyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    UUID.fromString(object.get(\"uuid\").getAsString()),\n          \n          \n            \n                                    UUID.fromString(object.get(\"senderId\").getAsString()),", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491620", "createdAt": "2021-01-25T06:43:41Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),\n+                        UUID.fromString(object.get(\"uuid\").getAsString()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 167}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82308364205c0d75569b866d89617adc36abf735", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/82308364205c0d75569b866d89617adc36abf735", "committedDate": "2021-06-03T11:39:54Z", "message": "Merge branch '2.x' into feature/mail-revamp"}, "afterCommit": {"oid": "03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "committedDate": "2021-06-09T15:57:22Z", "message": "Add rich mail messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06926a060036a8dd86627873e73ab8b42fb8a7de", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/06926a060036a8dd86627873e73ab8b42fb8a7de", "committedDate": "2021-06-09T16:00:44Z", "message": "Add rich mail messages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/03ebcbbbd1a45b6ff044c2086b451cdb29ae3811", "committedDate": "2021-06-09T15:57:22Z", "message": "Add rich mail messages"}, "afterCommit": {"oid": "06926a060036a8dd86627873e73ab8b42fb8a7de", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/06926a060036a8dd86627873e73ab8b42fb8a7de", "committedDate": "2021-06-09T16:00:44Z", "message": "Add rich mail messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067c6847835456ec0396e27f469c3c9587534d02", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/067c6847835456ec0396e27f469c3c9587534d02", "committedDate": "2021-06-09T21:36:27Z", "message": "Merge branch '2.x' into feature/mail-revamp\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/UserData.java\n#\tEssentials/src/main/java/com/earth2me/essentials/config/holders/UserConfigHolder.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2da0c73ffaec25107955a0b9eec2ec5b64d1dcd", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/f2da0c73ffaec25107955a0b9eec2ec5b64d1dcd", "committedDate": "2021-06-10T02:21:20Z", "message": "Don't use bukkit configs :("}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30706b92fa7f8132f7ef551802b65d60eaa93a67", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/30706b92fa7f8132f7ef551802b65d60eaa93a67", "committedDate": "2021-06-11T15:15:07Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjgyMDk0MDM3", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-682094037", "createdAt": "2021-06-11T17:58:00Z", "commit": {"oid": "30706b92fa7f8132f7ef551802b65d60eaa93a67"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xMVQxNzo1ODowMFrOJsDYrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xMVQxNzo1ODowMFrOJsDYrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDE3MjU4OQ==", "bodyText": "you need to pass the element type of the list through to configurate here somehow -- .set(Object) doesn't properly unwrap included values\ncould be .set(TypeToken<List<MailMessage>>, messages), or .setList(MailMessage.class, messages)", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r650172589", "createdAt": "2021-06-11T17:58:00Z", "author": {"login": "zml2008"}, "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpgrade.java", "diffHunk": "@@ -146,6 +147,45 @@ public static void uuidFileConvert(final IEssentials ess, final Boolean ignoreUF\n         ess.getLogger().info(\"To rerun the conversion type /essentials uuidconvert\");\n     }\n \n+    public void convertMailList() {\n+        if (doneFile.getBoolean(\"updateUsersMailList\", false)) {\n+            return;\n+        }\n+\n+        final File userdataFolder = new File(ess.getDataFolder(), \"userdata\");\n+        if (!userdataFolder.exists() || !userdataFolder.isDirectory()) {\n+            return;\n+        }\n+        final File[] userFiles = userdataFolder.listFiles();\n+        for (File file : userFiles) {\n+            if (!file.isFile() || !file.getName().endsWith(\".yml\")) {\n+                continue;\n+            }\n+            final EssentialsConfiguration config = new EssentialsConfiguration(file);\n+            try {\n+                config.load();\n+                if (config.hasProperty(\"mail\") && config.isList(\"mail\")) {\n+                    final ArrayList<MailMessage> messages = new ArrayList<>();\n+                    for (String mailStr : Collections.synchronizedList(config.getList(\"mail\", String.class))) {\n+                        if (mailStr == null) {\n+                            continue;\n+                        }\n+                        messages.add(new MailMessage(false, true, null, null, 0L, 0L, mailStr));\n+                    }\n+                    config.removeProperty(\"mail\");\n+                    config.setProperty(\"mail\", messages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30706b92fa7f8132f7ef551802b65d60eaa93a67"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1b8488f51b1dfcdc0dc254825ebd51f70fe7d5", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/3b1b8488f51b1dfcdc0dc254825ebd51f70fe7d5", "committedDate": "2021-06-11T18:20:54Z", "message": "Fix mail conversions\n\nthanks zml :))"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9312646cbc462a414adf9aaad6bd71a327e1f3f1", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/9312646cbc462a414adf9aaad6bd71a327e1f3f1", "committedDate": "2021-06-11T18:22:46Z", "message": "lmfao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c33159805ca91cc55b6ffc6bd862e3508fdf1b9", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/7c33159805ca91cc55b6ffc6bd862e3508fdf1b9", "committedDate": "2021-06-12T20:53:36Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06bd22d1a2d14fb371ea92a166d00f861b56aa0", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/d06bd22d1a2d14fb371ea92a166d00f861b56aa0", "committedDate": "2021-06-12T21:10:44Z", "message": "Don't use vanilla handler here, player names are cringe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8e2c4f60e3e4efab23f0d4ac4d5a60de956364a", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/a8e2c4f60e3e4efab23f0d4ac4d5a60de956364a", "committedDate": "2021-06-14T11:31:34Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3902795bad5aae6d0eb10bf091e2ddea269555b9", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/3902795bad5aae6d0eb10bf091e2ddea269555b9", "committedDate": "2021-06-18T01:34:16Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "439cdbba84c934296e1b69807b36982e424b9eac", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/439cdbba84c934296e1b69807b36982e424b9eac", "committedDate": "2021-06-26T22:35:39Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/e4b777d3807d37ea08db7bc1eb30108068aa7c03", "committedDate": "2021-06-27T03:36:01Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk1MzY3NjY1", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-695367665", "createdAt": "2021-06-29T18:23:37Z", "commit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQxODoyMzozN1rOJ2P2wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQyMTo0MzozOVrOJ2XU3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg2MjY1Nw==", "bodyText": "Shouldn't this include the sender name to be consistent with the old format? I can imagine some janky plugin somewhere trying to parse this.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660862657", "createdAt": "2021-06-29T18:23:37Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -313,17 +314,58 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n+    /**\n+     * @deprecated Mails are no longer just strings, this method is therefore misleading.\n+     */\n+    @Deprecated\n     public List<String> getMails() {\n-        return holder.mail();\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (MailMessage mail : getMailMessages()) {\n+                list.add(mail.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDk4NTA1NQ==", "bodyText": "MailService", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660985055", "createdAt": "2021-06-29T21:43:39Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/Mail.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import net.ess3.api.IUser;\n+\n+/**\n+ * This interface provides access to core Essentials mailing functions, allowing API users to send messages to {@link IUser IUser's }.\n+ */\n+public interface Mail {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1040e4ad675ea117655752225358dd19a9d861b", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/a1040e4ad675ea117655752225358dd19a9d861b", "committedDate": "2021-06-29T22:02:00Z", "message": "Kill me"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1e33dff5afa5b8a72b4c5b8bfe3a1cadf37f58", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/8b1e33dff5afa5b8a72b4c5b8bfe3a1cadf37f58", "committedDate": "2021-06-29T22:02:49Z", "message": "Mail -> MailService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/51ebbe21d88b0589cbee2c4993dbcf3311b37091", "committedDate": "2021-06-30T12:28:20Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk3MDg1NDI1", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-697085425", "createdAt": "2021-07-01T10:33:14Z", "commit": {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMVQxMDozMzoxNVrOJ3f_IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMVQxMDozMzoxNVrOJ3f_IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjE3NTUyMQ==", "bodyText": "...after my previous review I realised this would've returned a translated string in the past.\nNot sure if it's worth doing the mailFormat translation, keeping this hardcoded as it is now, or undoing this change entirely\nYes I'm indecisive shh", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r662175521", "createdAt": "2021-07-01T10:33:15Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -322,7 +323,8 @@ public void setJail(final String jail) {\n         final List<String> list = new ArrayList<>();\n         if (getMailAmount() != 0) {\n             for (MailMessage mail : getMailMessages()) {\n-                list.add(mail.getMessage());\n+                // I hate this code btw\n+                list.add(mail.isLegacy() ? mail.getMessage() : ChatColor.GOLD + \"[\" + ChatColor.RESET + mail.getSenderUsername() + ChatColor.GOLD + \"] \" + ChatColor.RESET + mail.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff633f21873688e7efac6429e065633b97ba0f0", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/bff633f21873688e7efac6429e065633b97ba0f0", "committedDate": "2021-07-01T13:46:53Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00a670096775555c7864a4bc977652c25d8d6b0e", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/00a670096775555c7864a4bc977652c25d8d6b0e", "committedDate": "2021-07-01T13:59:00Z", "message": "Add missing methods from DiscordMessageRecipient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk3MzA5Mzc1", "url": "https://github.com/EssentialsX/Essentials/pull/3710#pullrequestreview-697309375", "createdAt": "2021-07-01T14:23:03Z", "commit": {"oid": "00a670096775555c7864a4bc977652c25d8d6b0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "182fd3ed321fe300c5905438327496cb2d1aa0df", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/182fd3ed321fe300c5905438327496cb2d1aa0df", "committedDate": "2021-07-01T15:18:11Z", "message": "Merge branch '2.x' into feature/mail-revamp"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4391, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}