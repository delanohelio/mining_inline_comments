{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTc1ODYz", "number": 3239, "title": "Fix spawner delay feature", "bodyText": "Closes #1332\nThe spawner delay feature has been broken in Essentials for as long as anyone can remember. The reasons for this are mentioned in the issue above.\nThis PR fixes this by changing the command to utilize new API for setting the minimum and maximum spawn delay on spawners. This API was added in 1.12.2, so all supported versions before that (1.8.8 thru 1.12.1) require NMS to function properly. I'm aware that Essentials avoids NMS for maintainability reasons, however that should not be of much concern here since all versions 1.12.2 and later are going to be using the Bukkit API. Hence, no NMS updates will be necessary.\nAlso let me know if you want the NMS code refactored somewhere else. I saw the net.ess3.nms packages, but I wasn't sure where this would fit into the organisation of that.\nTested on:\n1.8.8, 1.9.4, 1.10.2, 1.11.2 (NMS)\n1.12.2, 1.15.2 (Bukkit API)", "createdAt": "2020-05-07T09:46:14Z", "url": "https://github.com/EssentialsX/Essentials/pull/3239", "merged": true, "mergeCommit": {"oid": "14c6c2a055e8c123d63e3ee5140a5583f6744fab"}, "closed": true, "closedAt": "2020-08-05T19:47:43Z", "author": {"login": "pop4959"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce5t4lgH2gAyNDE0NTc1ODYzOmIwYzk3ZjBmZTkyYTgyMDRjN2U2ZGJlZWRjODhkNDhmYTQyODM5NGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8An2gAFqTQ2MTk3MDkxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0c97f0fe92a8204c7e6dbeedc88d48fa428394b", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/b0c97f0fe92a8204c7e6dbeedc88d48fa428394b", "committedDate": "2020-05-07T09:18:31Z", "message": "Fix spawner delay feature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTE1OTgw", "url": "https://github.com/EssentialsX/Essentials/pull/3239#pullrequestreview-407515980", "createdAt": "2020-05-07T14:15:44Z", "commit": {"oid": "b0c97f0fe92a8204c7e6dbeedc88d48fa428394b"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoxNTo0NFrOGSAq-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoxNTo0NFrOGSAq-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzODU1Mg==", "bodyText": "All of the Class and Field objects should be stored as a private static final field. Additionally, the Method objects should be stored as a MethodHandle.\nSee https://github.com/EssentialsX/Essentials/pull/3157/files#diff-d515c857ac85b710ac67491e3dd1779aR121-R148 for an example.", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r421538552", "createdAt": "2020-05-07T14:15:44Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/commands/Commandspawner.java", "diffHunk": "@@ -57,8 +62,31 @@ protected void run(final Server server, final User user, final String commandLab\n         final Trade charge = new Trade(\"spawner-\" + mob.name.toLowerCase(Locale.ENGLISH), ess);\n         charge.isAffordableFor(user);\n         try {\n-            CreatureSpawner spawner = (CreatureSpawner) target.getBlock().getState();\n+            Block block = target.getBlock();\n+            CreatureSpawner spawner = (CreatureSpawner) block.getState();\n             spawner.setSpawnedType(mob.getType());\n+            if (delay > 0) {\n+                if (VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_12_2_R01)) {\n+                    spawner.setMinSpawnDelay(0);\n+                    spawner.setMaxSpawnDelay(Integer.MAX_VALUE);\n+                    spawner.setMinSpawnDelay(delay);\n+                    spawner.setMaxSpawnDelay(delay);\n+                } else {\n+                    Class<?> craftWorld = ReflUtil.getOBCClass(\"CraftWorld\");\n+                    Class<?> tileEntityMobSpawner = ReflUtil.getNMSClass(\"TileEntityMobSpawner\");\n+                    Class<?> mobSpawnerAbstract = ReflUtil.getNMSClass(\"MobSpawnerAbstract\");\n+                    Method getSpawner = tileEntityMobSpawner.getDeclaredMethod(\"getSpawner\");\n+                    Method getTileEntityAt = craftWorld.getDeclaredMethod(\"getTileEntityAt\", int.class, int.class, int.class);\n+                    Object craftTileEntity = getTileEntityAt.invoke(block.getWorld(), block.getX(), block.getY(), block.getZ());\n+                    Object nmsSpawner = getSpawner.invoke(craftTileEntity);\n+                    Field minSpawnDelay = ReflUtil.getFieldCached(mobSpawnerAbstract, \"minSpawnDelay\");\n+                    Field maxSpawnDelay = ReflUtil.getFieldCached(mobSpawnerAbstract, \"maxSpawnDelay\");\n+                    if (minSpawnDelay != null && maxSpawnDelay != null) {\n+                        minSpawnDelay.setInt(nmsSpawner, delay);\n+                        maxSpawnDelay.setInt(nmsSpawner, delay);\n+                    }\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0c97f0fe92a8204c7e6dbeedc88d48fa428394b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6af584217a51b252f27232d7155e34e7e4f2ac", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/8a6af584217a51b252f27232d7155e34e7e4f2ac", "committedDate": "2020-06-13T18:37:13Z", "message": "Update branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d7dca61316f1bedb004b07d85f860b06a04f3d", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/98d7dca61316f1bedb004b07d85f860b06a04f3d", "committedDate": "2020-06-14T03:42:45Z", "message": "Spawner block provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e63a8eda2f118ab4834908b387c235746aea32", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/34e63a8eda2f118ab4834908b387c235746aea32", "committedDate": "2020-06-14T03:54:19Z", "message": "Revert \"Spawner block provider\"\n\nThis reverts commit 98d7dca61316f1bedb004b07d85f860b06a04f3d."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "259de82770e142a91a9ddb599d5cd884a4b9a90a", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/259de82770e142a91a9ddb599d5cd884a4b9a90a", "committedDate": "2020-06-14T03:54:35Z", "message": "Revert \"Update branch\"\n\nThis reverts commit 8a6af584217a51b252f27232d7155e34e7e4f2ac."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4c757aa79ad2907a51184628af7008d9aeeee3b", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/c4c757aa79ad2907a51184628af7008d9aeeee3b", "committedDate": "2020-06-14T03:57:12Z", "message": "Merge branch '2.x' into spawner-delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4134362d4a9424889b98d70751e7a7c8fb0608e3", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/4134362d4a9424889b98d70751e7a7c8fb0608e3", "committedDate": "2020-06-14T03:59:13Z", "message": "Spawner block provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5", "committedDate": "2020-06-14T04:12:02Z", "message": "remove unnecessary import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjE1NDcz", "url": "https://github.com/EssentialsX/Essentials/pull/3239#pullrequestreview-430615473", "createdAt": "2020-06-15T12:55:49Z", "commit": {"oid": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjE3MjA4", "url": "https://github.com/EssentialsX/Essentials/pull/3239#pullrequestreview-430617208", "createdAt": "2020-06-15T12:58:02Z", "commit": {"oid": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjo1ODowM1rOGjxA-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjo1ODowM1rOGjxA-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1NjQwOA==", "bodyText": "tryProvider should be implemented by the abstract provider class and should attempt to call one of the provider's methods. Otherwise we don't know for certain that this provider actually does what it's supposed to in a consistent fashion.", "url": "https://github.com/EssentialsX/Essentials/pull/3239#discussion_r440156408", "createdAt": "2020-06-15T12:58:03Z", "author": {"login": "mdcfe"}, "path": "nms/UpdatedMetaProvider/src/net/ess3/nms/updatedmeta/BukkitSpawnerBlockProvider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package net.ess3.nms.updatedmeta;\n+\n+import net.ess3.nms.SpawnerBlockProvider;\n+import org.bukkit.block.CreatureSpawner;\n+\n+public class BukkitSpawnerBlockProvider extends SpawnerBlockProvider {\n+    @Override\n+    public void setMaxSpawnDelay(CreatureSpawner spawner, int delay) {\n+        spawner.setMaxSpawnDelay(delay);\n+    }\n+\n+    @Override\n+    public void setMinSpawnDelay(CreatureSpawner spawner, int delay) {\n+        spawner.setMinSpawnDelay(delay);\n+    }\n+\n+    @Override\n+    public boolean tryProvider() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b090fc982fe0270f0e13d6c8e3b9dabe9455f4d5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db40224a6576f8bf2b529f1eabbb8d2f03b5ca9f", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/db40224a6576f8bf2b529f1eabbb8d2f03b5ca9f", "committedDate": "2020-08-03T22:28:09Z", "message": "Merge branch '2.x' into spawner-delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7da5e9a0afe8e7104717afa4fe9d3ddfa9947f8", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/d7da5e9a0afe8e7104717afa4fe9d3ddfa9947f8", "committedDate": "2020-08-03T23:16:32Z", "message": "Refactor everything"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6588b679c68b01a0da35276bef566c650aec3eb8", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/6588b679c68b01a0da35276bef566c650aec3eb8", "committedDate": "2020-08-03T23:19:19Z", "message": "Remove old files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b525d28278fcdf0427bb5538086df8381fe10c49", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/b525d28278fcdf0427bb5538086df8381fe10c49", "committedDate": "2020-08-03T23:23:19Z", "message": "Remove unused provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTcwOTE2", "url": "https://github.com/EssentialsX/Essentials/pull/3239#pullrequestreview-461970916", "createdAt": "2020-08-05T19:45:04Z", "commit": {"oid": "b525d28278fcdf0427bb5538086df8381fe10c49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4673, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}