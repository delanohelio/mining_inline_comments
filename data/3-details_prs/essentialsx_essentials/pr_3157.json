{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjA3OTMy", "number": 3157, "title": "Save player logout times on shutdown", "bodyText": "Properly save userdata and mark the player's last logout time when the server is shutting down.\nNote: This method was added in Paper 1.15.2 and won't support lower versions unless we use reflection.\nFixes #2764", "createdAt": "2020-04-11T15:45:30Z", "url": "https://github.com/EssentialsX/Essentials/pull/3157", "merged": true, "mergeCommit": {"oid": "fc2b7b63a2336b2e9995ea9274e6dc5e0153221f"}, "closed": true, "closedAt": "2020-05-11T13:53:06Z", "author": {"login": "JRoy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWnopvgH2gAyNDAyMjA3OTMyOjk0OTdkYzE1YzNiZGI3MTU2M2UyNzYzZDQ2NDZhZTdjMGY3ZDZhMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgQBv7gFqTQwOTE5MjI2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "committedDate": "2020-04-11T15:43:07Z", "message": "Add isStopping support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODE4OTI5", "url": "https://github.com/EssentialsX/Essentials/pull/3157#pullrequestreview-391818929", "createdAt": "2020-04-12T03:41:26Z", "commit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MToyNlrOGER6rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzo0MjowOFrOGER64Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTAzNw==", "bodyText": "This is definitely the wrong thing to run here.\nShould instead be user.cleanup() - user.dispose() will create an async task to eventually call user.cleanup, which will throw an exception. (Or should, since the server is shutting down).", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141037", "createdAt": "2020-04-12T03:41:26Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTA4OQ==", "bodyText": "Wrap in else and remove continue - helps convey flow.", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141089", "createdAt": "2020-04-12T03:42:08Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();\n+                continue;\n+            }\n             user.stopTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "def752e4db6c69406464fcf33723ff57c5250814", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/def752e4db6c69406464fcf33723ff57c5250814", "committedDate": "2020-04-12T04:25:02Z", "message": "Review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTU5MzU2", "url": "https://github.com/EssentialsX/Essentials/pull/3157#pullrequestreview-391959356", "createdAt": "2020-04-13T05:05:38Z", "commit": {"oid": "def752e4db6c69406464fcf33723ff57c5250814"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTowNTozOFrOGEc2mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTowNTozOFrOGEc2mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyMDIxOA==", "bodyText": "@md678685 shouldn't this be called anyways (regardless of shutdown)? Could see instances where this isn't called on Disable due to a /reload or plugman bullshit where we lose data.", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407320218", "createdAt": "2020-04-13T05:05:38Z", "author": {"login": "Ichbinjoe"}, "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,12 +373,29 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n-            user.stopTransaction();\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.cleanup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def752e4db6c69406464fcf33723ff57c5250814"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b419da49e65339abf86c81e0724fc827552ee2c1", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/b419da49e65339abf86c81e0724fc827552ee2c1", "committedDate": "2020-04-13T21:00:54Z", "message": "Merge branch '2.x' into feature/2764\n\n# Conflicts:\n#\tEssentials/src/com/earth2me/essentials/Essentials.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3c4e552851f99d210ed25ea66389ab2b276baa", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/2a3c4e552851f99d210ed25ea66389ab2b276baa", "committedDate": "2020-04-13T21:01:42Z", "message": "Reduce diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e60e7bd8abfadbacdc647290a45c238d527a9c0", "author": {"user": {"login": "JRoy", "name": "Josh Roy"}}, "url": "https://github.com/EssentialsX/Essentials/commit/9e60e7bd8abfadbacdc647290a45c238d527a9c0", "committedDate": "2020-04-13T22:18:26Z", "message": "Add support for legacy and non-paper forks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTY3ODMw", "url": "https://github.com/EssentialsX/Essentials/pull/3157#pullrequestreview-404567830", "createdAt": "2020-05-02T23:20:32Z", "commit": {"oid": "9e60e7bd8abfadbacdc647290a45c238d527a9c0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd650a1a78477f86782a616d4b7bc1d514e459af", "author": {"user": {"login": "mdcfe", "name": "MD"}}, "url": "https://github.com/EssentialsX/Essentials/commit/dd650a1a78477f86782a616d4b7bc1d514e459af", "committedDate": "2020-05-11T13:39:47Z", "message": "Move isRunning/isStopping code to separate class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTkyMjYx", "url": "https://github.com/EssentialsX/Essentials/pull/3157#pullrequestreview-409192261", "createdAt": "2020-05-11T13:52:03Z", "commit": {"oid": "dd650a1a78477f86782a616d4b7bc1d514e459af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4656, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}