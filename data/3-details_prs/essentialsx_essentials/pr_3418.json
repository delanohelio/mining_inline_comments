{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODQ0Mjc3", "number": 3418, "title": "Implement random teleport command", "bodyText": "Adds /tpr and /settpr commands, which respectively allow you to teleport randomly or set teleportation parameters.\nServer owners are expected to set the center with /settpr before players can use /tpr. They can also set the minimum and maximum range to be teleported from the center (default 0-1000).\nAlso includes an event where plugins can adjust or cancel the teleport.\nCloses #3154.", "createdAt": "2020-06-27T01:48:45Z", "url": "https://github.com/EssentialsX/Essentials/pull/3418", "merged": true, "mergeCommit": {"oid": "76e511a774bbb013b28bee9ad715e02ff762fb71"}, "closed": true, "closedAt": "2020-07-06T18:53:44Z", "author": {"login": "pop4959"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvNo9xAH2gAyNDQwODQ0Mjc3OmQ5OWVmNmJlZjVhOGYzOWQ4YjI1ZmFiMjI2OTIyMzI2NTcwYzlhZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyV4hFAFqTQ0MzMyODY1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/d99ef6bef5a8f39d8b25fab226922326570c9afc", "committedDate": "2020-06-27T01:34:02Z", "message": "Implement random teleport command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjcwMTk0", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-438670194", "createdAt": "2020-06-27T04:02:11Z", "commit": {"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwNDowMjoxMVrOGpzCvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwNDoxNzozMVrOGpzHZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MTA4NQ==", "bodyText": "random seems like an odd name. Something like rtp, randomtp, or randomteleport", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446481085", "createdAt": "2020-06-27T04:02:11Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/RandomTeleport.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.InvalidWorldException;\n+import org.bukkit.Location;\n+\n+import java.io.File;\n+\n+public class RandomTeleport implements IConf {\n+    private final IEssentials essentials;\n+    private final EssentialsConf config;\n+\n+    public RandomTeleport(final IEssentials essentials) {\n+        this.essentials = essentials;\n+        File file = new File(essentials.getDataFolder(), \"random.yml\");\n+        config = new EssentialsConf(file);\n+        config.setTemplateName(\"/random.yml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MTIwMg==", "bodyText": "English literals ruin the point of translation :P", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446481202", "createdAt": "2020-06-27T04:03:46Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/commands/Commandsettpr.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.User;\n+import org.bukkit.Server;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandsettpr extends EssentialsCommand {\n+    public Commandsettpr() {\n+        super(\"settpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        if (args.length == 0 || \"center\".equalsIgnoreCase(args[0])) {\n+            randomTeleport.setCenter(user.getLocation());\n+            user.sendMessage(tl(\"settpr\", \"center\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MjI3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    config = new EssentialsConf(file);\n          \n          \n            \n                    config = new EssentialsConf(file);\n          \n          \n            \n                    config.options().header(\"this is a string stringy xdxdxd\");", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446482278", "createdAt": "2020-06-27T04:17:31Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/RandomTeleport.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.earth2me.essentials;\n+\n+import net.ess3.api.InvalidWorldException;\n+import org.bukkit.Location;\n+\n+import java.io.File;\n+\n+public class RandomTeleport implements IConf {\n+    private final IEssentials essentials;\n+    private final EssentialsConf config;\n+\n+    public RandomTeleport(final IEssentials essentials) {\n+        this.essentials = essentials;\n+        File file = new File(essentials.getDataFolder(), \"random.yml\");\n+        config = new EssentialsConf(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d99ef6bef5a8f39d8b25fab226922326570c9afc"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf019292b272b9e036258f65e207308b29e1c8e5", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/bf019292b272b9e036258f65e207308b29e1c8e5", "committedDate": "2020-06-27T05:34:02Z", "message": "rename file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9bc22c7b9d5c7da05c2a755fa9df17294c8d0e6", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/c9bc22c7b9d5c7da05c2a755fa9df17294c8d0e6", "committedDate": "2020-06-27T05:35:50Z", "message": "tl fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23af2e42fc61317f82ff08bb567ba1c9ecae58e0", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/23af2e42fc61317f82ff08bb567ba1c9ecae58e0", "committedDate": "2020-06-27T05:46:38Z", "message": "improve config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9428168dc516bae1d9364471b9cf5c7899c96f6", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/d9428168dc516bae1d9364471b9cf5c7899c96f6", "committedDate": "2020-06-27T08:07:36Z", "message": "Add biome blocking (no more oceans!) and location finding / caching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd6e07111020c77776a91057dbe715849e0482d6", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/bd6e07111020c77776a91057dbe715849e0482d6", "committedDate": "2020-06-27T19:58:32Z", "message": "optimisation - makes command significantly faster on spigot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4748e2e3c9bb27ccdbc3fd395ab7395866ccf3ec", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/4748e2e3c9bb27ccdbc3fd395ab7395866ccf3ec", "committedDate": "2020-06-27T21:50:01Z", "message": "Merge branch '2.x' into command-tpr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c580c5ec3ba4a08aaee477d8111cba09657c88d", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/7c580c5ec3ba4a08aaee477d8111cba09657c88d", "committedDate": "2020-06-28T00:38:55Z", "message": "Default to worldborder center if none set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODI2NTYy", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-438826562", "createdAt": "2020-06-29T00:05:26Z", "commit": {"oid": "7c580c5ec3ba4a08aaee477d8111cba09657c88d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwMDowNToyNlrOGqBYEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwMDoxMDoxOFrOGqBakA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNTkyMQ==", "bodyText": "would rather this be inlined", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446715921", "createdAt": "2020-06-29T00:05:26Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpr.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.Trade;\n+import com.earth2me.essentials.User;\n+import com.earth2me.essentials.utils.VersionUtil;\n+import io.papermc.lib.PaperLib;\n+import net.ess3.api.events.UserRandomTeleportEvent;\n+import org.bukkit.Location;\n+import org.bukkit.Server;\n+import org.bukkit.event.player.PlayerTeleportEvent;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.Random;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandtpr extends EssentialsCommand {\n+    private static final Random RANDOM = new Random();\n+    private static final int HIGHEST_BLOCK_Y_OFFSET = VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_15_R01) ? 1 : 0;\n+\n+    public Commandtpr() {\n+        super(\"tpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        final Trade charge = new Trade(this.getName(), ess);\n+        charge.isAffordableFor(user);\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        UserRandomTeleportEvent event = new UserRandomTeleportEvent(user, randomTeleport.getCenter(), randomTeleport.getMinRange(), randomTeleport.getMaxRange());\n+        server.getPluginManager().callEvent(event);\n+        if (event.isCancelled()) {\n+            return;\n+        }\n+        Location center = event.getCenter();\n+        double minRange = event.getMinRange();\n+        double maxRange = event.getMaxRange();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c580c5ec3ba4a08aaee477d8111cba09657c88d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjU2MA==", "bodyText": "i n l i n e", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r446716560", "createdAt": "2020-06-29T00:10:18Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpr.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.earth2me.essentials.commands;\n+\n+import com.earth2me.essentials.RandomTeleport;\n+import com.earth2me.essentials.Trade;\n+import com.earth2me.essentials.User;\n+import com.earth2me.essentials.utils.VersionUtil;\n+import io.papermc.lib.PaperLib;\n+import net.ess3.api.events.UserRandomTeleportEvent;\n+import org.bukkit.Location;\n+import org.bukkit.Server;\n+import org.bukkit.event.player.PlayerTeleportEvent;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.Random;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class Commandtpr extends EssentialsCommand {\n+    private static final Random RANDOM = new Random();\n+    private static final int HIGHEST_BLOCK_Y_OFFSET = VersionUtil.getServerBukkitVersion().isHigherThanOrEqualTo(VersionUtil.v1_15_R01) ? 1 : 0;\n+\n+    public Commandtpr() {\n+        super(\"tpr\");\n+    }\n+\n+    @Override\n+    protected void run(Server server, User user, String commandLabel, String[] args) throws Exception {\n+        final Trade charge = new Trade(this.getName(), ess);\n+        charge.isAffordableFor(user);\n+        RandomTeleport randomTeleport = ess.getRandomTeleport();\n+        UserRandomTeleportEvent event = new UserRandomTeleportEvent(user, randomTeleport.getCenter(), randomTeleport.getMinRange(), randomTeleport.getMaxRange());\n+        server.getPluginManager().callEvent(event);\n+        if (event.isCancelled()) {\n+            return;\n+        }\n+        Location center = event.getCenter();\n+        double minRange = event.getMinRange();\n+        double maxRange = event.getMaxRange();\n+        getRandomLocation(randomTeleport, center, minRange, maxRange).thenAccept(location -> {\n+            CompletableFuture<Boolean> future = getNewExceptionFuture(user.getSource(), commandLabel);\n+            user.getAsyncTeleport().teleport(location, charge, PlayerTeleportEvent.TeleportCause.COMMAND, future);\n+            future.thenAccept(success -> {\n+                if (success) {\n+                    user.sendMessage(tl(\"tprSuccess\"));\n+                }\n+            });\n+        });\n+    }\n+\n+    // Get a random location; cached if possible. Otherwise on demand.\n+    private CompletableFuture<Location> getRandomLocation(RandomTeleport randomTeleport, Location center, double minRange, double maxRange) {\n+        int findAttempts = randomTeleport.getFindAttempts();\n+        Queue<Location> cachedLocations = randomTeleport.getCachedLocations();\n+        // Try to build up the cache if it is below the threshold\n+        if (cachedLocations.size() < randomTeleport.getCacheThreshold()) {\n+            ess.getServer().getScheduler().scheduleSyncDelayedTask(ess, () -> {\n+                for (int i = 0; i < findAttempts; ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c580c5ec3ba4a08aaee477d8111cba09657c88d"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7290629bc4bfed1dd0633f520ebe923ded959e3", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/f7290629bc4bfed1dd0633f520ebe923ded959e3", "committedDate": "2020-06-29T00:51:37Z", "message": "i n l i n e"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODQyMDUw", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-438842050", "createdAt": "2020-06-29T01:46:37Z", "commit": {"oid": "f7290629bc4bfed1dd0633f520ebe923ded959e3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "251667d44aa63f86bedcfb8112f01ca9bd5f236a", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/251667d44aa63f86bedcfb8112f01ca9bd5f236a", "committedDate": "2020-06-30T22:51:25Z", "message": "More sensible ddefault max range"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f78a410d9dc514b292f175fadd5a0829f1db89", "author": {"user": {"login": "pop4959", "name": null}}, "url": "https://github.com/EssentialsX/Essentials/commit/79f78a410d9dc514b292f175fadd5a0829f1db89", "committedDate": "2020-07-01T00:34:24Z", "message": "Refactor + add pre-caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjAzNzM3", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-441203737", "createdAt": "2020-07-01T21:19:22Z", "commit": {"oid": "79f78a410d9dc514b292f175fadd5a0829f1db89"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjA0NjA0", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-441204604", "createdAt": "2020-07-01T21:21:05Z", "commit": {"oid": "79f78a410d9dc514b292f175fadd5a0829f1db89"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMToyMTowNVrOGr1veA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMToyMTowNVrOGr1veA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyMjQ1Ng==", "bodyText": "Shouldn't this file include all the available config options (ie pre-cache, max-range)?", "url": "https://github.com/EssentialsX/Essentials/pull/3418#discussion_r448622456", "createdAt": "2020-07-01T21:21:05Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/tpr.yml", "diffHunk": "@@ -0,0 +1,16 @@\n+# Configuration for the random teleport command.\n+# Some settings may be defaulted, and can be changed via the /settpr command in-game.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f78a410d9dc514b292f175fadd5a0829f1db89"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dffb6818a59f01ffd511c3dde5979535a37a8663", "author": {"user": {"login": "mdcfe", "name": "MD"}}, "url": "https://github.com/EssentialsX/Essentials/commit/dffb6818a59f01ffd511c3dde5979535a37a8663", "committedDate": "2020-07-06T18:51:42Z", "message": "Merge branch '2.x' into command-tpr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzI4NjU1", "url": "https://github.com/EssentialsX/Essentials/pull/3418#pullrequestreview-443328655", "createdAt": "2020-07-06T18:52:02Z", "commit": {"oid": "dffb6818a59f01ffd511c3dde5979535a37a8663"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4537, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}