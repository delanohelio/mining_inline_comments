{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NTg3ODgy", "number": 3710, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNToyMzoxNFrOEqKjcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMVQxMDozMzoxNVrOGRIWLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjQ4NTYyOnYy", "diffSide": "RIGHT", "path": "Essentials/src/com/earth2me/essentials/Mail.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNToyMzoxNFrOHcN-cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNTozNzo0N1rOHcOK3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1MTE1Mw==", "bodyText": "No space before ?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);\n          \n          \n            \n                    return tl(mail.get(\"read\").getAsBoolean() ? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r499351153", "createdAt": "2020-10-05T05:23:14Z", "author": {"login": "l1ttleO"}, "path": "Essentials/src/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    @Deprecated\n+    public void sendLegacyMail(IUser user, String message) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"legacy\", true);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    public String getMailLine(JsonObject mail) {\n+        String message = mail.get(\"message\").getAsString();\n+        if (mail.has(\"legacy\")) {\n+            return tl(\"mailMessage\", message);\n+        }\n+        return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28aaec3edf025cb7db4624cbe9a89dcf948c5697"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1NDMzNQ==", "bodyText": "working on merge conflicts along with new style constraints give me a few", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r499354335", "createdAt": "2020-10-05T05:37:47Z", "author": {"login": "JRoy"}, "path": "Essentials/src/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    @Deprecated\n+    public void sendLegacyMail(IUser user, String message) {\n+        JsonArray jsonArray = new JsonArray();\n+        JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"legacy\", true);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);\n+        if (user.getMailAmount() != 0) {\n+            jsonArray.addAll(user.getMailArray());\n+        }\n+        user.setMailArray(jsonArray);\n+    }\n+\n+    public String getMailLine(JsonObject mail) {\n+        String message = mail.get(\"message\").getAsString();\n+        if (mail.has(\"legacy\")) {\n+            return tl(\"mailMessage\", message);\n+        }\n+        return tl(mail.get(\"read\").getAsBoolean()? \"mailFormatNewRead\" : \"mailFormatNew\", df.get().format(new Date(mail.get(\"timestamp\").getAsLong())), mail.get(\"sender\").getAsString(), message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM1MTE1Mw=="}, "originalCommit": {"oid": "28aaec3edf025cb7db4624cbe9a89dcf948c5697"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU2OTYxOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/Console.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxMzo0N1rOIZFKEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxMzo0N1rOIZFKEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE2OTgxMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563169811", "createdAt": "2021-01-23T16:13:47Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Console.java", "diffHunk": "@@ -46,6 +48,11 @@ public String getName() {\n         return Console.NAME;\n     }\n \n+    @Override\n+    public UUID getUuid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU3MTk4OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxNjoxOVrOIZFLKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxNjoxOVrOIZFLKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA4OA==", "bodyText": "Gson should not be a part of the API.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170088", "createdAt": "2021-01-23T16:16:19Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU3MjAxOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxNjoyNFrOIZFLLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoxNjoyNFrOIZFLLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDA5Mw==", "bodyText": "Ditto", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170093", "createdAt": "2021-01-23T16:16:24Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -149,6 +151,16 @@\n \n     void addMail(String mail);\n \n+    void sendMail(IMessageRecipient sender, String message);\n+\n+    void sendMail(IMessageRecipient sender, String message, long expireAt);\n+\n+    JsonArray getMailArray();\n+\n+    int getMailAmount();\n+\n+    void setMailArray(JsonArray mailArray);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU3Njg5OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoyMTo0OFrOIZFNdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNFQxNToyODozOFrOIZNoYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDY3OA==", "bodyText": "I'd prefer we avoid IMessageRecipient - it's part of a messaging abstraction that was never actually implemented and should probably be phased out. I'd rather we just use IUser, or if absolutely necessary, add our own MailRecipient interface (not sure what the benefit is when all message recipients will be users though).", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170678", "createdAt": "2021-01-23T16:21:48Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzMwODY0Mg==", "bodyText": "not sure what the benefit is when all message recipients will be users though\n\nConsole, while they cannot receive mail, can still send it, So IUser isn't acceptable here. I'll convert this to a custom interface tho", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563308642", "createdAt": "2021-01-24T15:28:38Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDY3OA=="}, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU3ODg1OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoyNDoyOVrOIZFOXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoyNDoyOVrOIZFOXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MDkwOQ==", "bodyText": "Would much prefer we used a plain/immutable MailMessage/Mail.Message class for individual mails' data. This would let us object map + expose a much nicer mails API. Also, I'm not a huge fan of shoving JSON inside a string in another YAML file; may want to consider storing mails in a mails.json or something similar instead.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563170909", "createdAt": "2021-01-23T16:24:29Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n+        mail.addProperty(\"timestamp\", System.currentTimeMillis());\n+        mail.addProperty(\"expire\", expireAt);\n+        mail.addProperty(\"message\", message);\n+        jsonArray.add(mail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU4MzAzOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/User.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoyODozMFrOIZFQQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjoyODozMFrOIZFQQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTM5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                public UUID getUUID() {", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171393", "createdAt": "2021-01-23T16:28:30Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/User.java", "diffHunk": "@@ -917,6 +916,11 @@ public String getName() {\n         return this.getBase().getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU4NTYzOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozMTozNFrOIZFRdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozMTozNFrOIZFRdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcwMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and should not be used.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171700", "createdAt": "2021-01-23T16:31:34Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU4NTc5OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozMjowMFrOIZFRiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozMjowMFrOIZFRiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTcyMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Deprecated\n          \n          \n            \n                /**\n          \n          \n            \n                 * @deprecated This method does not support the new mail system and will fail at runtime.\n          \n          \n            \n                 */\n          \n          \n            \n                @Deprecated", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171723", "createdAt": "2021-01-23T16:32:00Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU4NjM3OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozMjozNFrOIZFRzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNDoyMzo0OFrOIZWoAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTc5MQ==", "bodyText": "I'm not sure why this isn't still just implemented in UserData?", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171791", "createdAt": "2021-01-23T16:32:34Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated\n+    abstract void addMail(String mail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ1NjAwMA==", "bodyText": "Due to the way the system works, we need an IUser, something UserData isn't. Doesn't cause any side effects so /shrug.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563456000", "createdAt": "2021-01-25T04:23:48Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -441,30 +444,63 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n-    private List<String> _getMails() {\n-        return config.getStringList(\"mail\");\n+    private JsonArray _getMails() {\n+        return ess.getMail().getMailArray(config.getString(\"mail\"));\n     }\n \n+    @Deprecated\n     public List<String> getMails() {\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (JsonElement mail : getMailArray()) {\n+                list.add(mail.getAsJsonObject().get(\"message\").getAsString());\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public JsonArray getMailArray() {\n         return mails;\n     }\n \n-    public void setMails(List<String> mails) {\n-        if (mails == null) {\n+    public int getMailAmount() {\n+        return mails == null ? 0 : mails.size();\n+    }\n+\n+    public int getUnreadMailAmount() {\n+        if (mails == null || mails.size() == 0) {\n+            return 0;\n+        }\n+\n+        int unread = 0;\n+        for (JsonElement element : mails) {\n+            if (!element.getAsJsonObject().get(\"read\").getAsBoolean()) {\n+                unread++;\n+            }\n+        }\n+        return unread;\n+    }\n+\n+    public void setMailArray(JsonArray mailArray) {\n+        final JsonObject obj = ess.getMail().getMailObject(mailArray);\n+        if (obj == null) {\n             config.removeProperty(\"mail\");\n-            mails = _getMails();\n+            mails = null;\n         } else {\n-            config.setProperty(\"mail\", mails);\n+            config.setProperty(\"mail\", obj.toString());\n+            mails = _getMails();\n         }\n-        this.mails = mails;\n         config.save();\n     }\n \n-    public void addMail(final String mail) {\n-        mails.add(mail);\n-        setMails(mails);\n+    @Deprecated\n+    public void setMails(final List<String> mails) {\n+        throw new UnsupportedOperationException(\"UserData#setMails is deprecated and can no longer be used. Please tell the plugin author to update this!\");\n     }\n \n+    @Deprecated\n+    abstract void addMail(String mail);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTc5MQ=="}, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjU4NzY1OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozNDoyNFrOIZFSdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QxNjozNDoyNFrOIZFSdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE3MTk1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UUID getUuid();\n          \n          \n            \n                UUID getUUID();", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563171959", "createdAt": "2021-01-23T16:34:24Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/IMessageRecipient.java", "diffHunk": "@@ -48,6 +50,13 @@\n      */\n     String getName();\n \n+    /**\n+     * Returns the UUID of this recipient. If the recipient is the console, null is returned.\n+     *\n+     * @return UUID of the this recipient or null if its console.\n+     */\n+    UUID getUuid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjkwNDcyOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1Nzo0NlrOIZHmQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1Nzo0NlrOIZHmQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTc5NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());\n          \n          \n            \n                    mail.addProperty(\"uuid\", sender.getUUID() == null ? \"null\" : sender.getUUID().toString());", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209794", "createdAt": "2021-01-23T22:57:46Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/Mail.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.messaging.IMessageRecipient;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public class Mail {\n+    private final transient IEssentials ess;\n+    private final transient JsonParser jsonParser = new JsonParser();\n+    private final transient ThreadLocal<SimpleDateFormat> df = ThreadLocal.withInitial(() -> new SimpleDateFormat(\"yyyy/MM/dd HH:mm\"));\n+\n+    public Mail(IEssentials ess) {\n+        this.ess = ess;\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message) {\n+        sendMail(user, sender, message, 0);\n+    }\n+\n+    public void sendMail(IUser user, IMessageRecipient sender, String message, long expireAt) {\n+        final JsonArray jsonArray = new JsonArray();\n+        final JsonObject mail = new JsonObject();\n+        mail.addProperty(\"read\", false);\n+        mail.addProperty(\"sender\", sender.getName());\n+        mail.addProperty(\"uuid\", sender.getUuid() == null ? \"null\" : sender.getUuid().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0NjkwNTI1OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/SimpleMessageRecipient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1ODozNlrOIZHmfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjo1ODozNlrOIZHmfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwOTg1NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public UUID getUuid() {\n          \n          \n            \n                    return this.parent.getUuid();\n          \n          \n            \n                public UUID getUUID() {\n          \n          \n            \n                    return this.parent.getUUID();", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563209854", "createdAt": "2021-01-23T22:58:36Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/messaging/SimpleMessageRecipient.java", "diffHunk": "@@ -60,6 +61,11 @@ public String getName() {\n         return this.parent.getName();\n     }\n \n+    @Override\n+    public UUID getUuid() {\n+        return this.parent.getUuid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfb39af0fd0172563a609e37d1e95dc72aaae931"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0OTAxNzUwOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mjo1NlrOIZYyQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mjo1NlrOIZYyQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTM5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String sender;\n          \n          \n            \n                private final String senderName;", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491392", "createdAt": "2021-01-25T06:42:56Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0OTAxNzY4OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mjo1OFrOIZYyVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mjo1OFrOIZYyVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTQxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final UUID uuid;\n          \n          \n            \n                private final UUID senderId;", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491412", "createdAt": "2021-01-25T06:42:58Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/MailMessage.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import java.util.UUID;\n+\n+/**\n+ * An immutable representation of a message sent as mail.\n+ */\n+public class MailMessage {\n+    private final boolean read;\n+    private final boolean legacy;\n+    private final String sender;\n+    private final UUID uuid;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0OTAxODUxOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0MzoyOVrOIZYy4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0MzoyOVrOIZYy4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTU1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    object.get(\"sender\").getAsString(),\n          \n          \n            \n                                    object.get(\"senderName\").getAsString(),", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491552", "createdAt": "2021-01-25T06:43:29Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 166}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0OTAxODk4OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mzo0MVrOIZYzJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQwNjo0Mzo0MVrOIZYzJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzQ5MTYyMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    UUID.fromString(object.get(\"uuid\").getAsString()),\n          \n          \n            \n                                    UUID.fromString(object.get(\"senderId\").getAsString()),", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r563491620", "createdAt": "2021-01-25T06:43:41Z", "author": {"login": "kashike"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -1042,4 +1101,34 @@ public void startTransaction() {\n     public void stopTransaction() {\n         config.stopTransaction();\n     }\n+\n+    private static class MailMessageDeserializer implements JsonDeserializer<MailMessage> {\n+        @Override\n+        public MailMessage deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n+            if (!json.isJsonObject()) {\n+                throw new JsonParseException(\"MailMessage must be a json object\");\n+            }\n+\n+            final JsonObject object = json.getAsJsonObject();\n+            if (object.has(\"legacy\") && object.get(\"legacy\").getAsBoolean()) {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        true,\n+                        null,\n+                        null,\n+                        0L,\n+                        0L,\n+                        object.get(\"message\").getAsString());\n+            } else {\n+                return new MailMessage(\n+                        object.get(\"read\").getAsBoolean(),\n+                        false,\n+                        object.get(\"sender\").getAsString(),\n+                        UUID.fromString(object.get(\"uuid\").getAsString()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2062c058757984ffa6076610d8f7b6c6570c8b93"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDEyNjM3NjExOnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpgrade.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xMVQxNzo1ODowMFrOJsDYrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xMVQxNzo1ODowMFrOJsDYrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDE3MjU4OQ==", "bodyText": "you need to pass the element type of the list through to configurate here somehow -- .set(Object) doesn't properly unwrap included values\ncould be .set(TypeToken<List<MailMessage>>, messages), or .setList(MailMessage.class, messages)", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r650172589", "createdAt": "2021-06-11T17:58:00Z", "author": {"login": "zml2008"}, "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpgrade.java", "diffHunk": "@@ -146,6 +147,45 @@ public static void uuidFileConvert(final IEssentials ess, final Boolean ignoreUF\n         ess.getLogger().info(\"To rerun the conversion type /essentials uuidconvert\");\n     }\n \n+    public void convertMailList() {\n+        if (doneFile.getBoolean(\"updateUsersMailList\", false)) {\n+            return;\n+        }\n+\n+        final File userdataFolder = new File(ess.getDataFolder(), \"userdata\");\n+        if (!userdataFolder.exists() || !userdataFolder.isDirectory()) {\n+            return;\n+        }\n+        final File[] userFiles = userdataFolder.listFiles();\n+        for (File file : userFiles) {\n+            if (!file.isFile() || !file.getName().endsWith(\".yml\")) {\n+                continue;\n+            }\n+            final EssentialsConfiguration config = new EssentialsConfiguration(file);\n+            try {\n+                config.load();\n+                if (config.hasProperty(\"mail\") && config.isList(\"mail\")) {\n+                    final ArrayList<MailMessage> messages = new ArrayList<>();\n+                    for (String mailStr : Collections.synchronizedList(config.getList(\"mail\", String.class))) {\n+                        if (mailStr == null) {\n+                            continue;\n+                        }\n+                        messages.add(new MailMessage(false, true, null, null, 0L, 0L, mailStr));\n+                    }\n+                    config.removeProperty(\"mail\");\n+                    config.setProperty(\"mail\", messages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30706b92fa7f8132f7ef551802b65d60eaa93a67"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE5NzY0ODE5OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQxODoyMzozN1rOJ2P2wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQyMTo1NzozNVrOJ2Xukw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg2MjY1Nw==", "bodyText": "Shouldn't this include the sender name to be consistent with the old format? I can imagine some janky plugin somewhere trying to parse this.", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660862657", "createdAt": "2021-06-29T18:23:37Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -313,17 +314,58 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n+    /**\n+     * @deprecated Mails are no longer just strings, this method is therefore misleading.\n+     */\n+    @Deprecated\n     public List<String> getMails() {\n-        return holder.mail();\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (MailMessage mail : getMailMessages()) {\n+                list.add(mail.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDk5MTYzNQ==", "bodyText": "sadge", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660991635", "createdAt": "2021-06-29T21:57:35Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -313,17 +314,58 @@ public void setJail(final String jail) {\n         config.save();\n     }\n \n+    /**\n+     * @deprecated Mails are no longer just strings, this method is therefore misleading.\n+     */\n+    @Deprecated\n     public List<String> getMails() {\n-        return holder.mail();\n+        final List<String> list = new ArrayList<>();\n+        if (getMailAmount() != 0) {\n+            for (MailMessage mail : getMailMessages()) {\n+                list.add(mail.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg2MjY1Nw=="}, "originalCommit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE5ODQzNzE2OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/Mail.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQyMTo0MzozOVrOJ2XU3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQyMTo0MzozOVrOJ2XU3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDk4NTA1NQ==", "bodyText": "MailService", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r660985055", "createdAt": "2021-06-29T21:43:39Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/net/essentialsx/api/v2/services/mail/Mail.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package net.essentialsx.api.v2.services.mail;\n+\n+import net.ess3.api.IUser;\n+\n+/**\n+ * This interface provides access to core Essentials mailing functions, allowing API users to send messages to {@link IUser IUser's }.\n+ */\n+public interface Mail {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b777d3807d37ea08db7bc1eb30108068aa7c03"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDIwNjE1NzI2OnYy", "diffSide": "RIGHT", "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMVQxMDozMzoxNVrOJ3f_IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMVQxMzo0NToyM1rOJ3nymA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjE3NTUyMQ==", "bodyText": "...after my previous review I realised this would've returned a translated string in the past.\nNot sure if it's worth doing the mailFormat translation, keeping this hardcoded as it is now, or undoing this change entirely\nYes I'm indecisive shh", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r662175521", "createdAt": "2021-07-01T10:33:15Z", "author": {"login": "mdcfe"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -322,7 +323,8 @@ public void setJail(final String jail) {\n         final List<String> list = new ArrayList<>();\n         if (getMailAmount() != 0) {\n             for (MailMessage mail : getMailMessages()) {\n-                list.add(mail.getMessage());\n+                // I hate this code btw\n+                list.add(mail.isLegacy() ? mail.getMessage() : ChatColor.GOLD + \"[\" + ChatColor.RESET + mail.getSenderUsername() + ChatColor.GOLD + \"] \" + ChatColor.RESET + mail.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjMwMzM4NA==", "bodyText": "hardcoded, people need to move off this api", "url": "https://github.com/EssentialsX/Essentials/pull/3710#discussion_r662303384", "createdAt": "2021-07-01T13:45:23Z", "author": {"login": "JRoy"}, "path": "Essentials/src/main/java/com/earth2me/essentials/UserData.java", "diffHunk": "@@ -322,7 +323,8 @@ public void setJail(final String jail) {\n         final List<String> list = new ArrayList<>();\n         if (getMailAmount() != 0) {\n             for (MailMessage mail : getMailMessages()) {\n-                list.add(mail.getMessage());\n+                // I hate this code btw\n+                list.add(mail.isLegacy() ? mail.getMessage() : ChatColor.GOLD + \"[\" + ChatColor.RESET + mail.getSenderUsername() + ChatColor.GOLD + \"] \" + ChatColor.RESET + mail.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjE3NTUyMQ=="}, "originalCommit": {"oid": "51ebbe21d88b0589cbee2c4993dbcf3311b37091"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4448, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}