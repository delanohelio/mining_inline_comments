{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NjY0MTk5", "number": 1276, "title": "Use react-markdown as it is more XSS resilient", "bodyText": "Summary\nFix for #1275\nThe current marked + post-sanitization approach is not safe. Furthermore, it relies on nodejs libs, which requires large polyfills for the browser.\nThis PR fixes that by using react-markdown.", "createdAt": "2020-12-14T16:58:44Z", "url": "https://github.com/cucumber/common/pull/1276", "merged": true, "mergeCommit": {"oid": "6532b0348129f87a5792e835d47e19a288355590"}, "closed": true, "closedAt": "2020-12-17T12:16:47Z", "author": {"login": "aslakhellesoy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmIsZ7AH2gAyNTM5NjY0MTk5OjdkZTBhNWNkNDE5YmFiMmFhNGU1ZTllNzkzMWQ4NjQ3NmI5OGI2MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnChLiAH2gAyNTM5NjY0MTk5OjMxZjgxNzg5Y2Y3NjQyMWUzMmUxMGM4ODdiZDMzZjIwYzI3NDY4NGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7de0a5cd419bab2aa4e5e9e7931d86476b98b620", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/7de0a5cd419bab2aa4e5e9e7931d86476b98b620", "committedDate": "2020-12-14T16:54:06Z", "message": "Use react-markdown as it is more XSS resilient. Fixes #1275"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzU5OTgz", "url": "https://github.com/cucumber/common/pull/1276#pullrequestreview-551759983", "createdAt": "2020-12-14T18:14:07Z", "commit": {"oid": "7de0a5cd419bab2aa4e5e9e7931d86476b98b620"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODoxNDowN1rOIFds_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODoxNToxN1rOIFdv9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMDQ0Nw==", "bodyText": "Assume you didn't mean to leave this console call in?", "url": "https://github.com/cucumber/common/pull/1276#discussion_r542600447", "createdAt": "2020-12-14T18:14:07Z", "author": {"login": "davidjgoss"}, "path": "react/javascript/test/HighlightTest.tsx", "diffHunk": "@@ -74,74 +77,18 @@ describe('HighLight', () => {\n     ])\n   })\n \n-  context('when htmlContent is not set', () => {\n-    it('escapes HTML characters', () => {\n-      const document = renderHighlight(\n-        '<span>Given</span> a passed step',\n-        'step'\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n-\n-      assert.equal(\n-        highlighted,\n-        '<span>&lt;span&gt;Given&lt;/span&gt; a passed </span><mark>step</mark>'\n-      )\n-    })\n-\n-    it('also highlight the tags', () => {\n-      const document = renderHighlight(\n-        '<strong>Given</strong> a strong step',\n-        'strong'\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n-\n-      assert.equal(\n-        highlighted,\n-        '<span>&lt;</span><mark>strong</mark><span>&gt;Given&lt;/</span><mark>strong</mark><span>&gt; a </span><mark>strong</mark><span> step</span>'\n-      )\n-    })\n-  })\n-\n-  context('when htmlContent is set to true', () => {\n-    it('keeps the HTML content', () => {\n-      const document = renderHighlight(\n-        '<em>Given</em> a passed step',\n-        'step',\n-        true\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n-\n-      assert.equal(highlighted, '<em>Given</em> a passed <mark>step</mark>')\n-    })\n+  it('puts <mark> around matches in markdown', () => {\n+    const document = renderHighlight(\n+      '* This is\\n* a bullet list',\n+      'bullet',\n+      true\n+    )\n+    const highlighted = Array.from(\n+      document.querySelectorAll('#content mark')\n+    ).map((span) => span.textContent)\n \n-    it('does not highlight the tags', () => {\n-      const document = renderHighlight(\n-        '<strong>Given</strong> a strong step',\n-        'strong',\n-        true\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n+    console.log(document.body.innerHTML)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0a5cd419bab2aa4e5e9e7931d86476b98b620"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMTIwNQ==", "bodyText": "We now won't have a test that proves the XSS protection, is that okay?", "url": "https://github.com/cucumber/common/pull/1276#discussion_r542601205", "createdAt": "2020-12-14T18:15:17Z", "author": {"login": "davidjgoss"}, "path": "react/javascript/test/HighlightTest.tsx", "diffHunk": "@@ -74,74 +77,18 @@ describe('HighLight', () => {\n     ])\n   })\n \n-  context('when htmlContent is not set', () => {\n-    it('escapes HTML characters', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0a5cd419bab2aa4e5e9e7931d86476b98b620"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ac5de3f2d5a931eac1dc8c074d82daeb94b7c1", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/99ac5de3f2d5a931eac1dc8c074d82daeb94b7c1", "committedDate": "2020-12-14T18:17:40Z", "message": "Remove logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa6df794ea5fa1202718113d33b88b576e14186", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/cfa6df794ea5fa1202718113d33b88b576e14186", "committedDate": "2020-12-15T08:23:44Z", "message": "Add a test for XSS and tweak sanitisation a bit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "401472620e1866de2dd6cc05ff0b323482249058", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/401472620e1866de2dd6cc05ff0b323482249058", "committedDate": "2020-12-15T10:28:50Z", "message": "Merge branch 'master' into react-fix-xss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eecc1f9dd7c47b1c7337df47b1deb509b01beaa", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/4eecc1f9dd7c47b1c7337df47b1deb509b01beaa", "committedDate": "2020-12-15T11:28:29Z", "message": "Merge branch 'master' into react-fix-xss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2951ac0e10962f585ce3e7f7f806fbc580514087", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/2951ac0e10962f585ce3e7f7f806fbc580514087", "committedDate": "2020-12-15T15:59:22Z", "message": "Merge branch 'master' into react-fix-xss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7252133756800e2b93fc0885254346b39edb9ab", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/c7252133756800e2b93fc0885254346b39edb9ab", "committedDate": "2020-12-15T16:03:57Z", "message": "Add test verifying that onclick is removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjE3MDYy", "url": "https://github.com/cucumber/common/pull/1276#pullrequestreview-552617062", "createdAt": "2020-12-15T16:05:32Z", "commit": {"oid": "c7252133756800e2b93fc0885254346b39edb9ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjowNTozMlrOIGTH4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjowNTozMlrOIGTH4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3NTY4MQ==", "bodyText": "@vincent-psarga does this address your concern about javascript injection in element event handlers?\nI assume it's more thoroughly tested in react-markdown...", "url": "https://github.com/cucumber/common/pull/1276#discussion_r543475681", "createdAt": "2020-12-15T16:05:32Z", "author": {"login": "aslakhellesoy"}, "path": "react/javascript/test/HighlightTest.tsx", "diffHunk": "@@ -74,74 +77,47 @@ describe('HighLight', () => {\n     ])\n   })\n \n-  context('when htmlContent is not set', () => {\n-    it('escapes HTML characters', () => {\n-      const document = renderHighlight(\n-        '<span>Given</span> a passed step',\n-        'step'\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n-\n-      assert.equal(\n-        highlighted,\n-        '<span>&lt;span&gt;Given&lt;/span&gt; a passed </span><mark>step</mark>'\n-      )\n-    })\n-\n-    it('also highlight the tags', () => {\n-      const document = renderHighlight(\n-        '<strong>Given</strong> a strong step',\n-        'strong'\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n+  it('puts <mark> around matches in markdown', () => {\n+    const document = renderHighlight(\n+      '* This is\\n* a bullet list',\n+      'bullet',\n+      true\n+    )\n+    const highlighted = Array.from(\n+      document.querySelectorAll('#content mark')\n+    ).map((span) => span.textContent)\n \n-      assert.equal(\n-        highlighted,\n-        '<span>&lt;</span><mark>strong</mark><span>&gt;Given&lt;/</span><mark>strong</mark><span>&gt; a </span><mark>strong</mark><span> step</span>'\n-      )\n-    })\n+    assert.deepStrictEqual(highlighted, ['bullet'])\n   })\n \n-  context('when htmlContent is set to true', () => {\n-    it('keeps the HTML content', () => {\n-      const document = renderHighlight(\n-        '<em>Given</em> a passed step',\n-        'step',\n-        true\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n-\n-      assert.equal(highlighted, '<em>Given</em> a passed <mark>step</mark>')\n-    })\n+  it('does not render <script> tags in markdown', () => {\n+    const document = renderHighlight(\n+      'Failed XSS: <script>alert(\"hello\")</script>',\n+      'alert hello',\n+      true\n+    )\n+    const html = document.querySelector('#content').innerHTML\n+    // Script tags will be removed (rather than escaped). Ideally we'd *escape* them to &lt;script&gt;.\n+    assert.deepStrictEqual(html, '<div class=\"highlight\"><p>Failed XSS: <mark>alert</mark>(\"<mark>hello</mark>\")</p></div>')\n+  })\n \n-    it('does not highlight the tags', () => {\n-      const document = renderHighlight(\n-        '<strong>Given</strong> a strong step',\n-        'strong',\n-        true\n-      )\n-      const highlighted = Array.from(\n-        document.querySelectorAll('#content .highlight')\n-      )\n-        .map((span) => span.innerHTML)\n-        .join('')\n+  it('renders <section> tags in markdown', () => {\n+    const document = renderHighlight(\n+      'We *like* other HTML tags:\\n\\n<section>hello</section>',\n+      null,\n+      true\n+    )\n+    const html = document.querySelector('#content').innerHTML\n+    assert.deepStrictEqual(html, '<div class=\"highlight\"><p>We <em>like</em> other HTML tags:</p><section>hello</section></div>')\n+  })\n \n-      assert.equal(\n-        highlighted,\n-        '<strong>Given</strong> a <mark>strong</mark> step'\n-      )\n-    })\n+  it('does not render JavaScript event handlers on tags in markdown', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7252133756800e2b93fc0885254346b39edb9ab"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjUwNzQ3", "url": "https://github.com/cucumber/common/pull/1276#pullrequestreview-552650747", "createdAt": "2020-12-15T16:38:51Z", "commit": {"oid": "c7252133756800e2b93fc0885254346b39edb9ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f81789cf76421e32e10c887bd33f20c274684f", "author": {"user": {"login": "aslakhellesoy", "name": "Aslak Helles\u00f8y"}}, "url": "https://github.com/cucumber/common/commit/31f81789cf76421e32e10c887bd33f20c274684f", "committedDate": "2020-12-17T12:16:20Z", "message": "Attribution. Closes #1275"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2999, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}