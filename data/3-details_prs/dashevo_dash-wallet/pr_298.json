{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMTYxMjU1", "number": 298, "title": "Redesign: Set Default Currency [NMA-243]", "bodyText": "Several Issues are being address:\n\nSpecial case of BYR (old currency for Belarus-BY that is still in the locale information of older devices before 2017) did not exist in the price sources and this resulted in a crash after sending a transaction.  This crash was a result of the currency not being found in the price source list, which could also happen if the price sources were not available for a new user who just installed the app.  Code was added to treat BYR as BYN to successfully get an exchange rate.\nAdd a list of currency names for non ISO 4217 currencies that are returned by the price sources\nAdd a list of currency codes that should be treated as other codes for the purposes of getting the name.  This applies to non ISO 4218 currency codes that will have the same name as the one that is in ISO 4217.  Example:  CNH vs CNY.\nLastly this will set the default currency based on the locale of the device if there is no Sim Card instead of using USD.  The risk with this change is that a locale may specify a currency that is not in the price sources.  In this case the user would have to select a different currency.  This code was added to resolve the first problem above, but it didn't.  This can be removed if we don't want this behavior.\nLogging is added to the detectUserCountry() code to help diagnose errors that may occur with users.", "createdAt": "2020-01-09T21:09:20Z", "url": "https://github.com/dashevo/dash-wallet/pull/298", "merged": true, "mergeCommit": {"oid": "fea984ac1e041fbcd0d747f465a1933d82519833"}, "closed": true, "closedAt": "2020-01-21T21:59:28Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb305WSAH2gAyMzYxMTYxMjU1OjA3YzJmYjU0NDJjZGE1NDliMjlkYjk4NjdkYWQ3NTliYzMwY2FkOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8oZ4-AH2gAyMzYxMTYxMjU1OjY1ZjFhYjQ2ZDA3ODA3OTlmMmM2ZTE1ZDEyNmU0Y2YwMmU0ZGY1OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07c2fb5442cda549b29db9867dad759bc30cad8d", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/07c2fb5442cda549b29db9867dad759bc30cad8d", "committedDate": "2020-01-06T23:38:28Z", "message": "Add logs for locale detection exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bdc15f1e7ffce09b818c04a8861f9fc10e46e1", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/f7bdc15f1e7ffce09b818c04a8861f9fc10e46e1", "committedDate": "2020-01-09T20:47:01Z", "message": "Add CurrencyInfo class to handle obsolete and non ISO 4217 currencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5da791fe590e460c77a3b2c518ded21e044696b4", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/5da791fe590e460c77a3b2c518ded21e044696b4", "committedDate": "2020-01-09T20:48:02Z", "message": "Handle the case of exchangeRate==null when displaying the tx confirm dlg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd", "committedDate": "2020-01-09T20:49:50Z", "message": "Add more logging, set default currency based on locale for devices that\ndon't have sim cards.\n\nThis does not handle the case where a currency does not exist in the\nprice source list, but the previous commit prevents the crash."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDEzNzcz", "url": "https://github.com/dashevo/dash-wallet/pull/298#pullrequestreview-341013773", "createdAt": "2020-01-10T08:33:24Z", "commit": {"oid": "d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwODozMzoyNVrOFcNI_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwODozMzoyNVrOFcNI_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA==", "bodyText": "Should we put USDC here as well?", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r365119740", "createdAt": "2020-01-10T08:33:25Z", "author": {"login": "dn-l"}, "path": "common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 2019 Dash Core Group\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.dash.wallet.common.data;\n+\n+import android.annotation.TargetApi;\n+import android.os.Build;\n+\n+import java.util.Currency;\n+import java.util.HashMap;\n+\n+/**\n+    @author: Eric Britten\n+ */\n+\n+public class CurrencyInfo {\n+\n+    /*\n+        Older android devices will have obsolete currency codes\n+        that do not match what the prices sources currently used.\n+\n+        e.g. in Belarus (BY), the currency changed from BYR to BYN\n+        at the end of 2016.  Older phones have BYR.\n+\n+        This app will read BYR from the device and then query BYN\n+        in the exchange rates list, but must get the name of BYR\n+        from the device.\n+     */\n+    private static HashMap<String, String> obsoleteCurrencyMap;\n+\n+    /*\n+        These currencies are listed in the price data, but are not\n+        ISO 4217 currency codes.  This will map those codes to the\n+        currency names.\n+     */\n+    private static HashMap<String, String> otherCurrencyMap;\n+\n+    /*\n+        These currencies are listed in the price data and have the\n+        same name as a different currency.  This differs from\n+        obsoleteCurrencyMap because both of these codes exist in the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bbe2883f06ee72dad74873aef5f4f3a692211fd", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/0bbe2883f06ee72dad74873aef5f4f3a692211fd", "committedDate": "2020-01-13T19:53:55Z", "message": "Add name for USDC from bitpay"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzE3NjE2", "url": "https://github.com/dashevo/dash-wallet/pull/298#pullrequestreview-342317616", "createdAt": "2020-01-14T06:46:47Z", "commit": {"oid": "0bbe2883f06ee72dad74873aef5f4f3a692211fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/afc6bd3719960f8810489950a47e0c3b0026e5ec", "committedDate": "2020-01-16T01:23:28Z", "message": "Add other currency names.  Prevent crash on 4 digit code.  Handle MRO->MRU"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzEwNTcz", "url": "https://github.com/dashevo/dash-wallet/pull/298#pullrequestreview-343710573", "createdAt": "2020-01-16T07:16:35Z", "commit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwNzoxNjozNVrOFeP6fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwNzoxNjozNVrOFeP6fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI2MjMzNQ==", "bodyText": "Will not be used I suppose? afc6bd3#diff-d59db2bdbe7841e4cb222c288bc4e156R76", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r367262335", "createdAt": "2020-01-16T07:16:35Z", "author": {"login": "dn-l"}, "path": "common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java", "diffHunk": "@@ -60,15 +60,20 @@\n \n     static {\n         obsoleteCurrencyMap = new HashMap<>();\n-        obsoleteCurrencyMap.put(\"BYR\", \"BYN\");\n+        obsoleteCurrencyMap.put(\"BYR\", \"BYN\"); // Belarus Ruble, changed in 2016\n+        obsoleteCurrencyMap.put(\"MRO\", \"MRU\"); // Mauritania Ouguiya, changed in 2018\n \n         otherCurrencyMap = new HashMap<>();\n         otherCurrencyMap.put(\"VES\", \"Venezuelan Bol\u00edvar\");\n         otherCurrencyMap.put(\"GGP\", \"Guernsey Pound\");\n         otherCurrencyMap.put(\"JEP\", \"Jersey Pound\");\n         otherCurrencyMap.put(\"IMP\", \"Isle of Man Pound\");\n         otherCurrencyMap.put(\"USDC\", \"USD Coin\");\n-\n+        otherCurrencyMap.put(\"LTC\", \"Litecoin\");\n+        otherCurrencyMap.put(\"ETH\", \"Etherium\");\n+        otherCurrencyMap.put(\"BTC\", \"Bitcoin\");\n+        otherCurrencyMap.put(\"PAX\", \"Paxos Standard\");\n+        otherCurrencyMap.put(\"GUSD\", \"Gemini Dollar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTM2MjE5", "url": "https://github.com/dashevo/dash-wallet/pull/298#pullrequestreview-346136219", "createdAt": "2020-01-21T19:32:49Z", "commit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTozMjo1MFrOFgGNSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTozMjo1MFrOFgGNSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwMDQ1Ng==", "bodyText": "Please remove empty spaces.", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r369200456", "createdAt": "2020-01-21T19:32:50Z", "author": {"login": "sambarboza"}, "path": "wallet/src/de/schildbach/wallet/ui/WalletActivity.java", "diffHunk": "@@ -1080,24 +1082,70 @@ private void detectUserCountry() {\n         try {\n             final TelephonyManager tm = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);\n             final String simCountry = tm.getSimCountryIso();\n+\n+            log.info(\"Detecting currency based on device, mobile network or locale:\");\n             if (simCountry != null && simCountry.length() == 2) { // SIM country code is available\n+                log.info(\"Device Sim Country: \" + simCountry);\n                 updateCurrencyExchange(simCountry.toUpperCase());\n             } else if (tm.getPhoneType() != TelephonyManager.PHONE_TYPE_CDMA) { // device is not 3G (would be unreliable)\n                 String networkCountry = tm.getNetworkCountryIso();\n+                log.info(\"Network Country: \" + simCountry);\n                 if (networkCountry != null && networkCountry.length() == 2) { // network country code is available\n                     updateCurrencyExchange(networkCountry.toUpperCase());\n                 } else {\n                     //Couldn't obtain country code - Use Default\n                     if (config.getExchangeCurrencyCode() == null)\n-                        config.setExchangeCurrencyCode(Constants.DEFAULT_EXCHANGE_CURRENCY);\n+                        setDefaultCurrency();\n                 }\n             } else {\n                 //No cellular network - Wifi Only\n                 if (config.getExchangeCurrencyCode() == null)\n-                    config.setExchangeCurrencyCode(Constants.DEFAULT_EXCHANGE_CURRENCY);\n+                    setDefaultCurrency();\n             }\n         } catch (Exception e) {\n             //fail safe\n+            log.info(\"NMA-243:  Exception thrown obtaining Locale information: \", e);\n+            if (config.getExchangeCurrencyCode() == null)\n+                setDefaultCurrency();\n+        }\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTYwNjU0", "url": "https://github.com/dashevo/dash-wallet/pull/298#pullrequestreview-346160654", "createdAt": "2020-01-21T20:13:10Z", "commit": {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65f1ab46d0780799f2c6e15d126e4cf02e4df594", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/65f1ab46d0780799f2c6e15d126e4cf02e4df594", "committedDate": "2020-01-21T21:54:52Z", "message": "remove extra spaces"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2957, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}