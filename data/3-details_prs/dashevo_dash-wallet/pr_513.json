{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNTUzMzgx", "number": 513, "title": "Restore Identity from First Public Key", "bodyText": "Issue being fixed or feature implemented\n\n\n\nNMA-590\nDue to the changes made, the identity, username and contacts will be loaded at 30%, instead of the normal 90-100 percent which results in missing transactions and requires a blockchain rescan.\nThis resolves some causes of missing payments from contacts after restoring a wallet from a recovery phrase.\nRelated PR's and Dependencies\n\ndashevo/android-dashpay#24\nScreenshots / Videos\n\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-09-24T16:10:18Z", "url": "https://github.com/dashevo/dash-wallet/pull/513", "merged": true, "mergeCommit": {"oid": "a3d48e743a71e81eacbbd22f4a9b1c9c3c8bd19d"}, "closed": true, "closedAt": "2020-10-06T23:16:21Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKJ-4_gH2gAyNDkyNTUzMzgxOjFlZDY3ZjJjOTYyYWY2MGUwOTJkMDI0M2JhYmNlMmNlMTU0YmNkZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP80LqAFqTUwMzI1NDA0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ed67f2c962af60e092d0243babce2ce154bcdf0", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/1ed67f2c962af60e092d0243babce2ce154bcdf0", "committedDate": "2020-09-18T18:34:19Z", "message": "Use 0.15-SNAPSHOT for dpp, dashpay, dapi-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1354fcad8fdb06104a5303fe84ce25ed9b42bd2a", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/1354fcad8fdb06104a5303fe84ce25ed9b42bd2a", "committedDate": "2020-09-19T01:58:36Z", "message": "Update for DPP 0.15, new dpns/dashpay contracts, database tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d262ea38241110aca09e3b5d25206154fa6f46", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/f9d262ea38241110aca09e3b5d25206154fa6f46", "committedDate": "2020-09-19T17:14:07Z", "message": "Set unique property on username"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1deafa3b404b19722ab479bda10ac489492ec1ff", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/1deafa3b404b19722ab479bda10ac489492ec1ff", "committedDate": "2020-09-22T22:19:02Z", "message": "Handle updated profiles from Platform and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "090df0b4bd6fb6d3964fa5c8404f63af66b27d87", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/090df0b4bd6fb6d3964fa5c8404f63af66b27d87", "committedDate": "2020-09-24T15:58:49Z", "message": "BlockchainIdentityData:  Add userId field\n\nThis allows loading an identity before the credit funding\ntransaction is found."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5601c2525486b8b0ae8b2d07b29dc4a9c82af81", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/e5601c2525486b8b0ae8b2d07b29dc4a9c82af81", "committedDate": "2020-09-24T15:58:50Z", "message": "BlockchainState: Notification shows sync percentage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff9b5a7e42de88a5a8197f874c80744b21490613", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/ff9b5a7e42de88a5a8197f874c80744b21490613", "committedDate": "2020-09-24T15:58:50Z", "message": "BlockchainState: Notification shows sync percentage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db91501fa06211eca89dc7e7bb9d7aa44cef3892", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/db91501fa06211eca89dc7e7bb9d7aa44cef3892", "committedDate": "2020-09-24T15:58:50Z", "message": "Refactor database clear when restarting/wiping the app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "927595c9418a37bce0d6d6630224e2d1652de695", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/927595c9418a37bce0d6d6630224e2d1652de695", "committedDate": "2020-09-24T16:02:55Z", "message": "Check for identity before syncing chain."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289be3cf59ae3d4417b2b310b54256a87cd2cf68", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/289be3cf59ae3d4417b2b310b54256a87cd2cf68", "committedDate": "2020-09-24T16:03:45Z", "message": "Add database json file and handle the cftx after the fact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b5b1c88f387dd4c2fc19d3e184806fdac8b923d", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/4b5b1c88f387dd4c2fc19d3e184806fdac8b923d", "committedDate": "2020-09-25T18:33:47Z", "message": "catch profile fetching exception and fix getIdentityByPublicKey"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36b7be6b44b24a506783648c4eeeb58fb942c023", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/36b7be6b44b24a506783648c4eeeb58fb942c023", "committedDate": "2020-09-25T18:34:35Z", "message": "Change method of submitting bloom filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a8d002665d6365f421b5b67cf29dd9cb7a3d69", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/c1a8d002665d6365f421b5b67cf29dd9cb7a3d69", "committedDate": "2020-09-29T16:23:40Z", "message": "Fix recovery of passphrase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc9449946f8dfd05c38212706579e6d22a14952a", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/cc9449946f8dfd05c38212706579e6d22a14952a", "committedDate": "2020-09-29T16:37:21Z", "message": "Refactor DashPayProfile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5964f05eb56c7d42d01f1e1b5d4d084f4f6d1c50", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/5964f05eb56c7d42d01f1e1b5d4d084f4f6d1c50", "committedDate": "2020-09-29T18:21:39Z", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dpp-0.15"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f7ef210c3b2a4b710726c52c6f46a0350f60da", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/15f7ef210c3b2a4b710726c52c6f46a0350f60da", "committedDate": "2020-09-29T18:45:40Z", "message": "Merge branch 'dpp-0.15' of https://github.com/dashevo/dash-wallet into chain-sync-phase-3a"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "858f89f01c04abec252b520b13ffd642d7c7f46e", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/858f89f01c04abec252b520b13ffd642d7c7f46e", "committedDate": "2020-09-30T15:25:44Z", "message": "CreateIdentityService: remove commented code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bbc6bf4fb3f25285938415403ae3386297e3658", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/5bbc6bf4fb3f25285938415403ae3386297e3658", "committedDate": "2020-09-30T15:27:02Z", "message": "PlatformRepo: Fix loading of blockchainIdentity from Database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66f955eca73ab75af529904f6b80e91a799994e5", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/66f955eca73ab75af529904f6b80e91a799994e5", "committedDate": "2020-09-30T15:27:56Z", "message": "ReceiveInfoView: Use observer to get profile information\n\nFixes crash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b86ba48be297898cb5cee2e7d97971394f4fb20", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/1b86ba48be297898cb5cee2e7d97971394f4fb20", "committedDate": "2020-09-30T22:33:25Z", "message": "MoreFragment: Show the user profile only if the user has registered on PlatformRepo.kt\n\nThis resolves a crash when accessing the More menu before registring a username"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67bc825f3c23af4148ea4a932cabcec43150b9cc", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/67bc825f3c23af4148ea4a932cabcec43150b9cc", "committedDate": "2020-09-30T22:34:42Z", "message": "PlatformRepo: Modify blockchainIdentity creation depending user registration state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/983529e01a4381dc89932979bb018a948a197c03", "committedDate": "2020-09-30T22:47:04Z", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into chain-sync-phase-3a"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODg0MTk3", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499884197", "createdAt": "2020-09-30T23:42:03Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0MjowNFrOHay8HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0MjowNFrOHay8HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1OTYxMw==", "bodyText": "I needed a way to get the LifeCycleOwner of a View that is derived from a ConstraintLayout for an observer.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497859613", "createdAt": "2020-09-30T23:42:04Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/Extensions.kt", "diffHunk": "@@ -0,0 +1,35 @@\n+package de.schildbach.wallet\n+\n+import android.content.Context\n+import android.content.ContextWrapper\n+import androidx.fragment.app.FragmentActivity\n+import androidx.lifecycle.LifecycleOwner\n+\n+//\n+// https://stackoverflow.com/questions/49075413/easy-way-to-get-current-activity-fragment-lifecycleowner-from-within-view\n+//\n+\n+fun Context.fragmentActivity(): FragmentActivity? {\n+    var curContext = this\n+    var maxDepth = 20\n+    while (--maxDepth > 0 && curContext !is FragmentActivity) {\n+        curContext = (curContext as ContextWrapper).baseContext\n+    }\n+    return if(curContext is FragmentActivity)\n+        curContext\n+    else\n+        null\n+}\n+\n+fun Context.lifecycleOwner(): LifecycleOwner? {\n+    var curContext = this\n+    var maxDepth = 20\n+    while (maxDepth-- > 0 && curContext !is LifecycleOwner) {\n+        curContext = (curContext as ContextWrapper).baseContext\n+    }\n+    return if (curContext is LifecycleOwner) {\n+        curContext as LifecycleOwner\n+    } else {\n+        null\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODg1NDMz", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499885433", "createdAt": "2020-09-30T23:43:34Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0MzozNFrOHay9nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0MzozNFrOHay9nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1OTk5Ng==", "bodyText": "Not sure if FORCE_SEND_FOR_REFRESH is required vs SEND_IF_CHANGED, but that is how most of the testing was done.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497859996", "createdAt": "2020-09-30T23:43:34Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -904,7 +904,7 @@ public int onStartCommand(final Intent intent, final int flags, final int startI\n             } else if(BlockchainService.ACTION_RESET_BLOOMFILTERS.equals(action)) {\n                 if (peerGroup != null) {\n                     log.info(\"recalculating bloom filters\");\n-                    peerGroup.recalculateFastCatchupAndFilter(PeerGroup.FilterRecalculateMode.SEND_IF_CHANGED);\n+                    peerGroup.recalculateFastCatchupAndFilter(PeerGroup.FilterRecalculateMode.FORCE_SEND_FOR_REFRESH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODg2NTk2", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499886596", "createdAt": "2020-09-30T23:44:16Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NDoxNlrOHay-YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NDoxNlrOHay-YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MDE5Mg==", "bodyText": "This is used by the Notification for the foreground service.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497860192", "createdAt": "2020-09-30T23:44:16Z", "author": {"login": "HashEngineering"}, "path": "wallet/res/values/strings.xml", "diffHunk": "@@ -8,7 +8,7 @@\n     <string name=\"blockchain_state_progress_days\">%1$s, %2$d days behind</string>\n     <string name=\"blockchain_state_progress_weeks\">%1$s, %2$d weeks behind</string>\n     <string name=\"blockchain_state_progress_months\">%1$s, %2$d months behind</string>\n-    <string name=\"blockchain_state_progress_downloading\">Synchronizing with network</string>\n+    <string name=\"blockchain_state_progress_downloading\">Synchronizing with network (%1$s%%)</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODg5MDU2", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499889056", "createdAt": "2020-09-30T23:45:45Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NTo0NlrOHazALQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NTo0NlrOHazALQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MDY1Mw==", "bodyText": "We need to store the userId because if we are restoring a recovery phrase, we won't have the credit funding transaction until later in the sync process.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497860653", "createdAt": "2020-09-30T23:45:46Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/data/BlockchainIdentityData.kt", "diffHunk": "@@ -31,6 +31,7 @@ import org.dashevo.dpp.identity.IdentityPublicKey\n data class BlockchainIdentityData(var creationState: CreationState = CreationState.NONE,\n                                   var creationStateErrorMessage: String?,\n                                   var username: String?,\n+                                  var userId: String?,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODg5ODY2", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499889866", "createdAt": "2020-09-30T23:46:14Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NjoxNFrOHazA2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NjoxNFrOHazA2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MDgyNw==", "bodyText": "Prevents crash if no user is registered on the More Screen.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497860827", "createdAt": "2020-09-30T23:46:14Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/MoreFragment.kt", "diffHunk": "@@ -66,7 +67,7 @@ class MoreFragment : Fragment(R.layout.activity_more) {\n         }\n \n         val blockchainIdentity = PlatformRepo.getInstance().getBlockchainIdentity()\n-        if (blockchainIdentity != null) {\n+        if (blockchainIdentity != null && blockchainIdentity.registrationStatus == BlockchainIdentity.RegistrationStatus.REGISTERED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODkxNzQw", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499891740", "createdAt": "2020-09-30T23:47:22Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NzoyMlrOHazCIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0NzoyMlrOHazCIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTE1Mg==", "bodyText": "since the userId is saved in the database, we don't need to load it from the wallet.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497861152", "createdAt": "2020-09-30T23:47:22Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -180,14 +187,13 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n      * @param text The beginning of a username to search for\n      * @return\n      */\n+\n     @Throws(Exception::class)\n     suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false): List<UsernameSearchResult> {\n         val wallet = walletApplication.wallet\n         val blockchainIdentityData = blockchainIdentityDataDao.load()!!\n-        //We don't check for nullity here because if it's null, it'll be thrown, captured below\n-        //and sent as a Resource.error\n-        val creditFundingTx = wallet.getCreditFundingTransaction(wallet.getTransaction(blockchainIdentityData.creditFundingTxId))\n-        val userId = creditFundingTx.creditBurnIdentityIdentifier.toStringBase58()\n+        val userId = blockchainIdentity.uniqueIdString", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODk0MTE5", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499894119", "createdAt": "2020-09-30T23:48:52Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0ODo1MlrOHazDdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0ODo1MlrOHazDdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTQ5Mw==", "bodyText": "we return the blockchainIdentity because this is during the registration process and there is no other data to load.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497861493", "createdAt": "2020-09-30T23:48:52Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -576,8 +583,20 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n \n     fun initBlockchainIdentity(blockchainIdentityData: BlockchainIdentityData, wallet: Wallet): BlockchainIdentity {\n         val creditFundingTransaction = blockchainIdentityData.findCreditFundingTransaction(wallet)\n-        if (creditFundingTransaction != null) {\n-            return BlockchainIdentity(platform, creditFundingTransaction, wallet).apply {\n+        val blockchainIdentity = if (creditFundingTransaction != null) {\n+            BlockchainIdentity(platform, creditFundingTransaction, wallet)\n+        } else {\n+            val blockchainIdentity = BlockchainIdentity(platform, 0, wallet)\n+            if (blockchainIdentityData.creationState >= BlockchainIdentityData.CreationState.DONE) {\n+                blockchainIdentity.apply {\n+                    uniqueId = Sha256Hash.wrap(Base58.decode(blockchainIdentityData.userId))\n+                }\n+            } else {\n+                return blockchainIdentity", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODk0OTEy", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499894912", "createdAt": "2020-09-30T23:49:21Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0OToyMVrOHazD-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo0OToyMVrOHazD-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTYyNA==", "bodyText": "oops.  left a comment", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497861624", "createdAt": "2020-09-30T23:49:21Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -719,14 +739,22 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             }\n \n             if (!platform.hasApp(\"dashpay\")) {\n+                log.info(\"update contacts not completed because there is no dashpay contract\")\n                 return\n             }\n \n             val blockchainIdentityData = blockchainIdentityDataDao.load() ?: return\n             if (blockchainIdentityData.creationState < BlockchainIdentityData.CreationState.DONE) {\n+                log.info(\"update contacts not completed username registration/recovery is not complete\")\n                 return\n             }\n-            val userId = blockchainIdentityData.getIdentity(walletApplication.wallet) ?: return\n+\n+            if (blockchainIdentity == null) {\n+                log.info(\"update contacts not completed: blockchainIdentity has not been initialized\")\n+            }\n+\n+            val userId = blockchainIdentity.uniqueIdString!! //blockchainIdentityData!!.getIdentity(walletApplication.wallet) ?: return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODk1OTg2", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499895986", "createdAt": "2020-09-30T23:50:00Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDowMFrOHazEwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDowMFrOHazEwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTgyNQ==", "bodyText": "This was moved up in case there is an exception when processing profiles.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497861825", "createdAt": "2020-09-30T23:50:00Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -795,6 +823,13 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n                 }\n             }\n \n+            // If new keychains were added to the wallet, then update the bloom filters\n+            if (addedContact) {\n+                val intent = Intent(BlockchainService.ACTION_RESET_BLOOMFILTERS, null, walletApplication,\n+                        BlockchainServiceImpl::class.java)\n+                walletApplication.startService(intent)\n+            }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODk2OTY0", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499896964", "createdAt": "2020-09-30T23:50:36Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDozNlrOHazFYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDozNlrOHazFYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTk4NA==", "bodyText": "comment", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497861984", "createdAt": "2020-09-30T23:50:36Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -959,9 +995,48 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             preDownloadBlocks.set(true)\n             preDownloadBlocksFuture = future\n             log.info(\"PreDownloadBlocks: starting\")\n+\n+            //first check to see if there is a blockchain identity\n+            if (blockchainIdentityDataDao.load() == null) {\n+                log.info(\"PreDownloadBlocks: checking for existing associated identity\")\n+\n+                //val fundingKey = walletApplication.wallet.watchingKey\n+                val identity = getIdentityFromPublicKeyId()\n+                //log.info(\"key hash: ${fundingKey.pubKeyHash.toHexString()}, identityBytes: ${identityBytes != null}\")\n+                if (identity != null) {\n+                    log.info(\"PreDownloadBlocks: initiate recovery of existing identity ${identity.id}\")\n+                    ContextCompat.startForegroundService(walletApplication, createIntentForRestore(walletApplication, identity.id))\n+                    return@launch\n+                } else {\n+                    log.info(\"PreDownloadBlocks: no existing identity found\")\n+                }\n+            }\n+\n+            // update contacts, profiles and other platform data\n             if (!updatingContacts.get()) {\n                 updateContactRequests()\n             }\n         }\n     }\n+\n+    /**\n+        This is used by java code, outside of coroutines\n+     */\n+    fun clearDatabases() {\n+        val database = AppDatabase.getAppDatabase()\n+        database.blockchainIdentityDataDaoAsync().clear()\n+        database.dashPayProfileDaoAsync().clear()\n+        database.dashPayContactRequestDaoAsync().clear()\n+\n+        // TODO: how do we make the blockchainIdentity == null\n+    }\n+\n+    fun getIdentityFromPublicKeyId(): Identity? {\n+        val fundingKey = walletApplication.wallet.blockchainIdentityKeyChain.watchingKey//currentAuthenticationKey(AuthenticationKeyChain.KeyChainType.BLOCKCHAIN_IDENTITY)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 244}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODk3NDE0", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-499897414", "createdAt": "2020-09-30T23:50:53Z", "commit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDo1M1rOHazFvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMzo1MDo1M1rOHazFvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MjA3OA==", "bodyText": "extra comments", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r497862078", "createdAt": "2020-09-30T23:50:53Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -959,9 +995,48 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             preDownloadBlocks.set(true)\n             preDownloadBlocksFuture = future\n             log.info(\"PreDownloadBlocks: starting\")\n+\n+            //first check to see if there is a blockchain identity\n+            if (blockchainIdentityDataDao.load() == null) {\n+                log.info(\"PreDownloadBlocks: checking for existing associated identity\")\n+\n+                //val fundingKey = walletApplication.wallet.watchingKey\n+                val identity = getIdentityFromPublicKeyId()\n+                //log.info(\"key hash: ${fundingKey.pubKeyHash.toHexString()}, identityBytes: ${identityBytes != null}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983529e01a4381dc89932979bb018a948a197c03"}, "originalPosition": 214}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebb810f968f2392ed107d6d6f7293d6dbbea4bdd", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/ebb810f968f2392ed107d6d6f7293d6dbbea4bdd", "committedDate": "2020-10-05T19:24:28Z", "message": "PlatformRepo.kt: Reformat, remove comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTkwMDU2", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-503190056", "createdAt": "2020-10-06T17:16:57Z", "commit": {"oid": "ebb810f968f2392ed107d6d6f7293d6dbbea4bdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoxNjo1OFrOHdSAaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoxNjo1OFrOHdSAaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NTc3MQ==", "bodyText": "The defaultValue argument is not being used.", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r500465771", "createdAt": "2020-10-06T17:16:58Z", "author": {"login": "sambarboza"}, "path": "wallet/src/de/schildbach/wallet/data/DashPayProfile.kt", "diffHunk": "@@ -16,18 +16,28 @@ data class DashPayProfile(@PrimaryKey val userId: String,\n                           val createdAt: Long = 0,\n                           val updatedAt: Long = 0) : Parcelable {\n     companion object {\n-        fun fromDocument(document: Document, username: String): DashPayProfile? {\n-            return try {\n-                DashPayProfile(document.ownerId,\n-                        username,\n-                        document.data[\"displayName\"] as String,\n-                        document.data[\"publicMessage\"] as String,\n-                        document.data[\"avatarUrl\"] as String,\n-                        if (document.createdAt != null) document.createdAt!! else 0L,\n-                        if (document.updatedAt != null) document.updatedAt!! else 0L)\n-            } catch (e: Exception) {\n-                null\n+\n+        private fun getField(document: Document, field: String, defaultValue: String = \"\"): String {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb810f968f2392ed107d6d6f7293d6dbbea4bdd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTk2NTA0", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-503196504", "createdAt": "2020-10-06T17:25:03Z", "commit": {"oid": "ebb810f968f2392ed107d6d6f7293d6dbbea4bdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNTowNFrOHdSTug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNTowNFrOHdSTug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDcxNA==", "bodyText": "Since we have a single database, shouldn't this be called clearDatabase (in singular) or clearTables?", "url": "https://github.com/dashevo/dash-wallet/pull/513#discussion_r500470714", "createdAt": "2020-10-06T17:25:04Z", "author": {"login": "sambarboza"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -959,9 +995,45 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             preDownloadBlocks.set(true)\n             preDownloadBlocksFuture = future\n             log.info(\"PreDownloadBlocks: starting\")\n+\n+            //first check to see if there is a blockchain identity\n+            if (blockchainIdentityDataDao.load() == null) {\n+                log.info(\"PreDownloadBlocks: checking for existing associated identity\")\n+\n+                val identity = getIdentityFromPublicKeyId()\n+                if (identity != null) {\n+                    log.info(\"PreDownloadBlocks: initiate recovery of existing identity ${identity.id}\")\n+                    ContextCompat.startForegroundService(walletApplication, createIntentForRestore(walletApplication, identity.id))\n+                    return@launch\n+                } else {\n+                    log.info(\"PreDownloadBlocks: no existing identity found\")\n+                }\n+            }\n+\n+            // update contacts, profiles and other platform data\n             if (!updatingContacts.get()) {\n                 updateContactRequests()\n             }\n         }\n     }\n+\n+    /**\n+    This is used by java code, outside of coroutines\n+\n+    This should not be a suspended method.\n+     */\n+    fun clearDatabases() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb810f968f2392ed107d6d6f7293d6dbbea4bdd"}, "originalPosition": 265}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e26f7bbb9a9366b77163e89eab6dce58b538efa", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/4e26f7bbb9a9366b77163e89eab6dce58b538efa", "committedDate": "2020-10-06T18:20:12Z", "message": "rename clearDatabases() to clearDatabase(), move database live data to PlatformRepo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9945008258db372d2274ab3ef48ee5a191b6b8f", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/e9945008258db372d2274ab3ef48ee5a191b6b8f", "committedDate": "2020-10-06T18:26:23Z", "message": "Use defaultValue in getField"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjU0MDQ0", "url": "https://github.com/dashevo/dash-wallet/pull/513#pullrequestreview-503254044", "createdAt": "2020-10-06T18:37:24Z", "commit": {"oid": "e9945008258db372d2274ab3ef48ee5a191b6b8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2828, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}