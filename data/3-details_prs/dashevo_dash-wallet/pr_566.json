{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODg2Mjkw", "number": 566, "title": "NMA-602 | Contacts | Show users suggestions", "bodyText": "Issue being fixed or feature implemented\n\n\n\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-12-03T15:53:57Z", "url": "https://github.com/dashevo/dash-wallet/pull/566", "merged": true, "mergeCommit": {"oid": "6c348b33b85b75c7c640c1ce874401c355bc96c5"}, "closed": true, "closedAt": "2020-12-31T21:21:41Z", "author": {"login": "sambarboza"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhCe8sgH2gAyNTMxODg2MjkwOmMxZjBhNDliMmMxOTUxMjQzYmY1NjYwYTFkYTAzNjAwNGQ2MTRiMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpKxZSAFqTU1ODMxMzk1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1f0a49b2c1951243bf5660a1da036004d614b21", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/c1f0a49b2c1951243bf5660a1da036004d614b21", "committedDate": "2020-11-28T20:50:21Z", "message": "Initial Layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "337e251199a197a92f518db7f1fcc4d0bb4bbb9d", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/337e251199a197a92f518db7f1fcc4d0bb4bbb9d", "committedDate": "2020-12-01T00:45:35Z", "message": "Suggestions layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a7e9eada7b8c9d57cdf88a90f8f9ead174fcfd", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/33a7e9eada7b8c9d57cdf88a90f8f9ead174fcfd", "committedDate": "2020-12-01T02:04:59Z", "message": "Adding user rows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10be7a1d835e69412137d6d7efbd3f67b08d2d78", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/10be7a1d835e69412137d6d7efbd3f67b08d2d78", "committedDate": "2020-12-02T07:47:59Z", "message": "Showing username and avatar placeholder correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69eef5a189b0add84a2b8ae003da65c0608ab12c", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/69eef5a189b0add84a2b8ae003da65c0608ab12c", "committedDate": "2020-12-02T09:51:22Z", "message": "Limiting to 3 suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7215a54fe116b923c55fb84f61ee3cde2d70691a", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/7215a54fe116b923c55fb84f61ee3cde2d70691a", "committedDate": "2020-12-02T10:37:04Z", "message": "Keep showing search bar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d7ab4d1818258028a437678b725c88089abf22", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/98d7ab4d1818258028a437678b725c88089abf22", "committedDate": "2020-12-03T15:35:40Z", "message": "Empty suggestions layout."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTUwMTY2", "url": "https://github.com/dashevo/dash-wallet/pull/566#pullrequestreview-544550166", "createdAt": "2020-12-03T23:36:59Z", "commit": {"oid": "98d7ab4d1818258028a437678b725c88089abf22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNjo1OVrOH-6GDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNjo1OVrOH-6GDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA==", "bodyText": "limit is set to 3 earlier in the process, but limit is supplied as the startAt argument of search\nCurrently, search does not support a limit parameter.\n    /**\n     * Searches for and returns a list of all name documents that match the given name based\n     * on these criteria: starts with.  Contains is not supported\n     * @param text String\n     * @param parentDomain String\n     * @param retrieveAll Boolean\n     * @param startAtIndex Int\n     * @return List<Documents>\n     */\n    fun search(text: String, parentDomain: String, retrieveAll: Boolean, startAtIndex: Int = 0): List<Document>", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r535725580", "createdAt": "2020-12-03T23:36:59Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -195,13 +195,14 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n      */\n \n     @Throws(Exception::class)\n-    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false): List<UsernameSearchResult> {\n+    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false, limit: Int = -1): List<UsernameSearchResult> {\n         val userIdString = blockchainIdentity.uniqueIdString\n         val userId = blockchainIdentity.uniqueIdentifier\n \n         // Names.search does support retrieving 100 names at a time if retrieveAll = false\n         //TODO: Maybe add pagination later? Is very unlikely that a user will scroll past 100 search results\n-        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN, false)\n+        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN,\n+                false, limit)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98d7ab4d1818258028a437678b725c88089abf22"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87a1a1343c927948a2a81b99371353a5b3f36a2a", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/87a1a1343c927948a2a81b99371353a5b3f36a2a", "committedDate": "2020-12-04T01:12:36Z", "message": "Fixed empty/initial state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Mjg4NTk0", "url": "https://github.com/dashevo/dash-wallet/pull/566#pullrequestreview-545288594", "createdAt": "2020-12-04T20:52:59Z", "commit": {"oid": "87a1a1343c927948a2a81b99371353a5b3f36a2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMDo1Mjo1OVrOH_hnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMDo1Mjo1OVrOH_hnWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzA4Mg==", "bodyText": "if query is \"\" (empty) then we shouldn't execute the search.\nI/DapiClient: [DefaultDispatcher-worker-3] getDocuments(H9AxLAvgxEpq72pDg41nsqR3bY5Cv9hTT6yZdKzY3PaE, domain, {limit=3, orderBy=[[normalizedLabel, asc]], where=[[normalizedParentDomainName, ==, dash], [normalizedLabel, startsWith, ]], startAt=0})\n...\nW/DapiClient: [DefaultDispatcher-worker-3] RPC failed with 34.216.205.76: Status{code=INVALID_ARGUMENT, description=Invalid query: should be equal to one of the allowed values, cause=null}: Metadata(server=nginx/1.19.3,date=Fri, 04 Dec 2020 20:41:46 GMT,content-type=application/grpc,content-length=0,errors=[{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"enum\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/0/items/1/enum\",\"params\":{\"allowedValues\":[\"<\",\"<=\",\"==\",\">\",\">=\"]}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"enum\",\"dataPath\":\".where[1][0]\",\"schemaPath\":\"#/properties/where/items/oneOf/1/items/0/enum\",\"params\":{\"allowedValues\":[\"$createdAt\",\"$updatedAt\"]}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/2/items/1/const\",\"params\":{\"allowedValue\":\"in\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"minLength\",\"dataPath\":\".where[1][2]\",\"schemaPath\":\"#/properties/where/items/oneOf/3/items/2/minLength\",\"params\":{\"limit\":1}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/4/items/1/const\",\"params\":{\"allowedValue\":\"elementMatch\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/5/items/1/const\",\"params\":{\"allowedValue\":\"length\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/6/items/1/const\",\"params\":{\"allowedValue\":\"contains\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"oneOf\",\"dataPath\":\".where[1]\",\"schemaPath\":\"#/properties/where/items/oneOf\",\"params\":{\"passingSchemas\":null}}])\n..\nE/Documents: [DefaultDispatcher-worker-3] Document creation: unable to get documents of H9AxLAvgxEpq72pDg41nsqR3bY5Cv9hTT6yZdKzY3PaE: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: Invalid query: should be equal to one of the allowed values\nE/DashPayViewModel: [DefaultDispatcher-worker-3] search usernames: INVALID_ARGUMENT: Invalid query: should be equal to one of the allowed values", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r536373082", "createdAt": "2020-12-04T20:52:59Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/ContactsFragment.kt", "diffHunk": "@@ -123,12 +136,18 @@ class ContactsFragment : Fragment(R.layout.fragment_contacts_root), TextWatcher,\n                 if (initialSearch && (mode != MODE_VIEW_REQUESTS)) {\n                     if (it.data == null || it.data.isEmpty() || it.data.find { u -> u.requestReceived } == null) {\n                         empty_state_pane.visibility = View.VISIBLE\n-                        contacts_pane.visibility = View.GONE\n+                        search.visibility = View.GONE\n+                        icon.visibility = View.GONE\n                     } else {\n+                        search.visibility = View.VISIBLE\n+                        icon.visibility = View.VISIBLE\n                         empty_state_pane.visibility = View.GONE\n-                        contacts_pane.visibility = View.VISIBLE\n                     }\n                     initialSearch = false\n+                } else {\n+                    if (it.data == null || it.data.isEmpty()) {\n+                        dashPayViewModel.searchUsernames(query, 3)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87a1a1343c927948a2a81b99371353a5b3f36a2a"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff044a6f3d124a8c1b947e7894d67d2bd8a26ec", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/3ff044a6f3d124a8c1b947e7894d67d2bd8a26ec", "committedDate": "2020-12-11T08:32:35Z", "message": "Layout adjustments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24d4bc68f441567bb21897566d78529aafcaee88", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/24d4bc68f441567bb21897566d78529aafcaee88", "committedDate": "2020-12-15T22:35:20Z", "message": "resetting initalSearch flag  whwhen leaving contact fragments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df5ee4008d6e5824354aa13cc9b294e3cf55da9", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/8df5ee4008d6e5824354aa13cc9b294e3cf55da9", "committedDate": "2020-12-15T22:35:31Z", "message": "Merge branch 'dashpay-user-suggestion-contact-search' of github.com:dashevo/dash-wallet into dashpay-user-suggestion-contact-search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f87ac53621983f58eb17303bf54556790789d34", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/3f87ac53621983f58eb17303bf54556790789d34", "committedDate": "2020-12-15T23:02:53Z", "message": "Merge branch 'evonet-develop' into dashpay-user-suggestion-contact-search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb9ff717fb723cc2088b9acd8ab19245975db2c3", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/bb9ff717fb723cc2088b9acd8ab19245975db2c3", "committedDate": "2020-12-16T02:34:20Z", "message": "fixed user search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c633ae301fccf67b410a4ded440bcc3c56485a2", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/1c633ae301fccf67b410a4ded440bcc3c56485a2", "committedDate": "2020-12-16T03:07:57Z", "message": "Preventing search for empty string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDE0ODQ1", "url": "https://github.com/dashevo/dash-wallet/pull/566#pullrequestreview-553414845", "createdAt": "2020-12-16T07:24:07Z", "commit": {"oid": "1c633ae301fccf67b410a4ded440bcc3c56485a2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzoyNDowOFrOIG3VOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzoyNDowOFrOIG3VOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2ODkyMw==", "bodyText": "This solution relies on https://github.com/dashevo/android-dashpay/pull/30/files which has merge conflicts due to parameter order differences with Names.search.  Either the merge conflicts on the previously mentioned android-dashpay PR must be resolved or the parameter order must be changed here.", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r544068923", "createdAt": "2020-12-16T07:24:08Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -195,13 +195,14 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n      */\n \n     @Throws(Exception::class)\n-    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false): List<UsernameSearchResult> {\n+    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false, limit: Int = -1): List<UsernameSearchResult> {\n         val userIdString = blockchainIdentity.uniqueIdString\n         val userId = blockchainIdentity.uniqueIdentifier\n \n         // Names.search does support retrieving 100 names at a time if retrieveAll = false\n         //TODO: Maybe add pagination later? Is very unlikely that a user will scroll past 100 search results\n-        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN, false)\n+        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c633ae301fccf67b410a4ded440bcc3c56485a2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa83414a5a5a464b4055d4efd40d6d350efccbc", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/8fa83414a5a5a464b4055d4efd40d6d350efccbc", "committedDate": "2020-12-17T02:29:03Z", "message": "fixed Names.search params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdfd7e045ad718c985c889ea400b46fbd8dc9e32", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/cdfd7e045ad718c985c889ea400b46fbd8dc9e32", "committedDate": "2020-12-17T23:15:11Z", "message": "fixed crash on empty results."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "518f9f46217b2a716f7abd1c0d6cccba38104c01", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/518f9f46217b2a716f7abd1c0d6cccba38104c01", "committedDate": "2020-12-24T01:49:32Z", "message": "resetting inital state after deleting query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzEzOTU5", "url": "https://github.com/dashevo/dash-wallet/pull/566#pullrequestreview-558313959", "createdAt": "2020-12-24T03:01:08Z", "commit": {"oid": "518f9f46217b2a716f7abd1c0d6cccba38104c01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2761, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}