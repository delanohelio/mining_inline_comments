{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDM1OTYz", "number": 527, "title": "NMA-603 | (Contacts in) Transaction History | Home Screen", "bodyText": "Issue being fixed or feature implemented\n\n\n\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-10-09T08:33:38Z", "url": "https://github.com/dashevo/dash-wallet/pull/527", "merged": true, "mergeCommit": {"oid": "a5b63fbf73c8e0a12b8749ea2a84188554e1d849"}, "closed": true, "closedAt": "2020-10-09T18:33:36Z", "author": {"login": "sambarboza"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQWn3qgH2gAyNTAwNDM1OTYzOjcwMDQ2OWYwYmE2OGViN2E2YTJmZDcxZGVmZTNkODllYzE1Y2FlZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ6iJggFqTUwNTkwNDM1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "700469f0ba68eb7a6a2fd71defe3d89ec15caef4", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/700469f0ba68eb7a6a2fd71defe3d89ec15caef4", "committedDate": "2020-10-08T00:41:29Z", "message": "Created TransactionsViewModel and associated LiveDatas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/5dbe0c4de76a75fcf648033ce44b751e84dfb206", "committedDate": "2020-10-09T08:31:43Z", "message": "Loading contacts into transactions adapter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDc3NTIz", "url": "https://github.com/dashevo/dash-wallet/pull/527#pullrequestreview-505477523", "createdAt": "2020-10-09T08:44:00Z", "commit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NDowMFrOHfAshA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NDowMFrOHfAshA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3OTMwMA==", "bodyText": "Most of the below code should be handled by LiveData/ViewModel, however walletChangeReceiver part can be ignored since we do not use ACTION_WALLET_REFERENCE_CHANGED anymore (it is a legacy code).", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502279300", "createdAt": "2020-10-09T08:44:00Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/ui/WalletTransactionsFragment.java", "diffHunk": "@@ -317,10 +272,8 @@ private void showEmptyView() {\n         recyclerView.setVisibility(View.INVISIBLE);\n     }\n \n-    @Override\n-    public void onLoaderReset(final Loader<List<Transaction>> loader) {\n-        // don't clear the adapter, because it will confuse users\n-    }\n+    //TODO: Do we need to handle this?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "originalPosition": 229}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDgxODk3", "url": "https://github.com/dashevo/dash-wallet/pull/527#pullrequestreview-505481897", "createdAt": "2020-10-09T08:50:03Z", "commit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo1MDowNFrOHfA6pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo1MDowNFrOHfA6pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4MjkxOQ==", "bodyText": "the wallet val should be moved inside the method body", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502282919", "createdAt": "2020-10-09T08:50:04Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/TransactionsViewModel.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.app.Application\n+import androidx.lifecycle.AndroidViewModel\n+import androidx.lifecycle.MediatorLiveData\n+import androidx.lifecycle.MutableLiveData\n+import androidx.lifecycle.viewModelScope\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.DashPayProfile\n+import de.schildbach.wallet.data.UsernameSortOrderBy\n+import kotlinx.coroutines.launch\n+import org.bitcoinj.core.Context\n+import org.bitcoinj.core.Sha256Hash\n+import org.bitcoinj.core.Transaction\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.wallet.Wallet\n+import java.util.*\n+import kotlin.collections.HashMap\n+\n+class TransactionsViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    enum class Direction {\n+        RECEIVED, SENT\n+    }\n+\n+    val direction = MutableLiveData<Direction?>()\n+    val transactionsLiveData = MediatorLiveData<Pair<List<Transaction>,\n+            Map<Sha256Hash, DashPayProfile>>>()\n+    private val balanceLiveData = WalletBalanceLiveData()\n+\n+    init {\n+        load()\n+        transactionsLiveData.addSource(direction) {\n+            load()\n+        }\n+        transactionsLiveData.addSource(balanceLiveData) {\n+            load()\n+        }\n+    }\n+\n+    fun load(wallet: Wallet = WalletApplication.getInstance().wallet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDgzMzEw", "url": "https://github.com/dashevo/dash-wallet/pull/527#pullrequestreview-505483310", "createdAt": "2020-10-09T08:52:01Z", "commit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo1MjowMVrOHfA-tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo1MjowMVrOHfA-tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4Mzk1OA==", "bodyText": "This part will be changed by #526 but is ok for this PR", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502283958", "createdAt": "2020-10-09T08:52:01Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/TransactionsViewModel.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.app.Application\n+import androidx.lifecycle.AndroidViewModel\n+import androidx.lifecycle.MediatorLiveData\n+import androidx.lifecycle.MutableLiveData\n+import androidx.lifecycle.viewModelScope\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.DashPayProfile\n+import de.schildbach.wallet.data.UsernameSortOrderBy\n+import kotlinx.coroutines.launch\n+import org.bitcoinj.core.Context\n+import org.bitcoinj.core.Sha256Hash\n+import org.bitcoinj.core.Transaction\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.wallet.Wallet\n+import java.util.*\n+import kotlin.collections.HashMap\n+\n+class TransactionsViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    enum class Direction {\n+        RECEIVED, SENT\n+    }\n+\n+    val direction = MutableLiveData<Direction?>()\n+    val transactionsLiveData = MediatorLiveData<Pair<List<Transaction>,\n+            Map<Sha256Hash, DashPayProfile>>>()\n+    private val balanceLiveData = WalletBalanceLiveData()\n+\n+    init {\n+        load()\n+        transactionsLiveData.addSource(direction) {\n+            load()\n+        }\n+        transactionsLiveData.addSource(balanceLiveData) {\n+            load()\n+        }\n+    }\n+\n+    fun load(wallet: Wallet = WalletApplication.getInstance().wallet) {\n+        viewModelScope.launch {\n+            Context.propagate(Constants.CONTEXT)\n+\n+            val contactsTransactions: HashMap<Sha256Hash, DashPayProfile> = hashMapOf()\n+            val contactsByIdentity: HashMap<String, DashPayProfile> = hashMapOf()\n+            val platformRepo = PlatformRepo.getInstance()\n+            val userIdentity = platformRepo.getBlockchainIdentity()\n+            if (userIdentity != null) {\n+                val contacts = PlatformRepo.getInstance().searchContacts(\"\",\n+                        UsernameSortOrderBy.LAST_ACTIVITY, false)\n+                contacts.data?.forEach {\n+                    contactsByIdentity[it.dashPayProfile.userId] = it.dashPayProfile\n+                }\n+            }\n+\n+            val transactions = wallet.getTransactions(true)\n+            val filteredTransactions = arrayListOf<Transaction>()\n+            transactions.filterTo(filteredTransactions, {\n+                val sent = it.getValue(wallet).signum() < 0\n+                val isInternal = it.purpose == Transaction.Purpose.KEY_ROTATION\n+                direction.value == Direction.RECEIVED && !sent\n+                        && !isInternal || direction.value == null ||\n+                        direction.value == Direction.SENT && sent && !isInternal\n+            })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2af9750b1af3890f7cbc5839affea3ceb3f2b884", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/2af9750b1af3890f7cbc5839affea3ceb3f2b884", "committedDate": "2020-10-09T09:31:38Z", "message": "Tx row layout changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55f7a80c91caee8315f35c12b42582a5b52f9f00", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/55f7a80c91caee8315f35c12b42582a5b52f9f00", "committedDate": "2020-10-09T09:35:26Z", "message": "Moved wallet reference inside method body"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTI1MjU1", "url": "https://github.com/dashevo/dash-wallet/pull/527#pullrequestreview-505525255", "createdAt": "2020-10-09T09:50:05Z", "commit": {"oid": "55f7a80c91caee8315f35c12b42582a5b52f9f00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c26a50365f537849b313d8794685ff844465cf2", "author": {"user": {"login": "sambarboza", "name": "Sam B."}}, "url": "https://github.com/dashevo/dash-wallet/commit/2c26a50365f537849b313d8794685ff844465cf2", "committedDate": "2020-10-09T10:10:08Z", "message": "Removed commented code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTA0MzU5", "url": "https://github.com/dashevo/dash-wallet/pull/527#pullrequestreview-505904359", "createdAt": "2020-10-09T18:31:49Z", "commit": {"oid": "2c26a50365f537849b313d8794685ff844465cf2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2854, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}