{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3OTIyNDc2", "number": 502, "title": "BIP70 | Broadcast Transaction After Server Ack", "bodyText": "Issue being fixed or feature implemented\n\n\n\nNMA-593 BIP70 | Broadcast Transaction After Server\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\nPerformed few BIP70 payments and analysed operations order in logs.\nPerformed few regular transactions in order to make sure that nothing was accidentally broken.\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-09-02T15:57:58Z", "url": "https://github.com/dashevo/dash-wallet/pull/502", "merged": true, "mergeCommit": {"oid": "91416e474a53a71ca8534cab577d49cac77cd3c5"}, "closed": true, "closedAt": "2020-09-15T21:12:41Z", "author": {"login": "tomasz-ludek"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE6bOnAH2gAyNDc3OTIyNDc2OmY2Y2UyZDZhZGViYmEyZDA0MDc0N2RjMDk2ODMxYzA3NjBlMDMzZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG6-O7gH2gAyNDc3OTIyNDc2OjI5M2FlNDI4NTVmYWI1NmNjY2RiZTFjNzAzYzI4MTM4ZGQ1MzUwNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6ce2d6adebba2d040747dc096831c0760e033d1", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/f6ce2d6adebba2d040747dc096831c0760e033d1", "committedDate": "2020-09-02T11:37:10Z", "message": "Removed obsolete test code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eff79428068a436912b13f724086d61ef85a4f1", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/9eff79428068a436912b13f724086d61ef85a4f1", "committedDate": "2020-09-02T15:17:12Z", "message": "Avoid broadcast BIP70 transaction is server did not acknowledge first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "214d78410f79dcdc4c788648c5e98f40c1fe43bd", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/214d78410f79dcdc4c788648c5e98f40c1fe43bd", "committedDate": "2020-09-02T15:56:06Z", "message": "Changed the BIP70 payment error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/af444fa05fec1e0f6e56b242a7f5394f0707b94a", "committedDate": "2020-09-02T16:12:28Z", "message": "Fixed the issue with Electrum based BIP70 servers that doesn't provide PaymentUrl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjg5Njg5", "url": "https://github.com/dashevo/dash-wallet/pull/502#pullrequestreview-481289689", "createdAt": "2020-09-02T20:50:22Z", "commit": {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDo1MDoyMlrOHMGT4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDo1MDoyMlrOHMGT4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0ODM1NA==", "bodyText": "I am not sure what txAlreadyCompleted means.  On line 126 above, txAlreadyCompleted is set to ensureMinRequiredFee which I thought was usually set to true.", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482448354", "createdAt": "2020-09-02T20:50:22Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/send/PaymentProtocolViewModel.kt", "diffHunk": "@@ -127,14 +126,22 @@ class PaymentProtocolViewModel(application: Application) : SendCoinsBaseViewMode\n         signAndSendPayment(finalPaymentIntent!!, baseSendRequest!!.ensureMinRequiredFee)\n     }\n \n-    fun directPay(transaction: Transaction) {\n+    override fun signAndSendPayment(sendRequest: SendRequest, txAlreadyCompleted: Boolean) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjk0MjA2", "url": "https://github.com/dashevo/dash-wallet/pull/502#pullrequestreview-481294206", "createdAt": "2020-09-02T20:56:10Z", "commit": {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDo1NjoxMVrOHMG0Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDo1NjoxMVrOHMG0Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ1NjYxMA==", "bodyText": "Where does the value of txAlreadyComplete come from? The logic here seems to be that if the tx is completed (wallet.completeTx was called) then it only needs to be committed, otherwise wallet.sendCoinsOffline will complete and commit the transaction.  I suppose this makes sense, so this relates to a comment above about how the value of txAlreadyComplete is set.", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482456610", "createdAt": "2020-09-02T20:56:11Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/send/SendCoinsOfflineTask.java", "diffHunk": "@@ -51,14 +51,23 @@ public SendCoinsOfflineTask(final Wallet wallet, final Handler backgroundHandler\n     }\n \n     public final void sendCoinsOffline(final SendRequest sendRequest) {\n+        sendCoinsOffline(sendRequest, false);\n+    }\n+\n+    public final void sendCoinsOffline(final SendRequest sendRequest, final boolean txAlreadyCompleted) {\n         backgroundHandler.post(new Runnable() {\n             @Override\n             public void run() {\n                 org.bitcoinj.core.Context.propagate(Constants.CONTEXT);\n \n                 try {\n                     log.info(\"sending: {}\", sendRequest);\n-                    final Transaction transaction = wallet.sendCoinsOffline(sendRequest); // can take long\n+                    if (txAlreadyCompleted) {\n+                        wallet.commitTx(sendRequest.tx);\n+                    } else {\n+                        wallet.sendCoinsOffline(sendRequest);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "293ae42855fab56cccdbe1c703c28138dd535050", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/293ae42855fab56cccdbe1c703c28138dd535050", "committedDate": "2020-09-08T17:23:15Z", "message": "Checking expiration date once again just before performing payment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2819, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}