{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNzk2Nzk2", "number": 579, "title": "Avatar Hash and Fingerprint", "bodyText": "Issue being fixed or feature implemented\n\n\n\nNMA-698 v17 | Avatar Hash\nNMA-697 v17 | Avatar Fingerprint\nRelated PR's and Dependencies\n\n#578\ndashevo/android-dashpay#35\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-12-17T11:23:51Z", "url": "https://github.com/dashevo/dash-wallet/pull/579", "merged": true, "mergeCommit": {"oid": "78b276d20421d982a6d8279ac1860fca617a4092"}, "closed": true, "closedAt": "2021-01-05T00:06:25Z", "author": {"login": "tomasz-ludek"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm4sr5gH2gAyNTQxNzk2Nzk2OjQ4YWFhNDFkMTJjN2Q2NDAzODU0NDkwODRjY2IxMGYyODUwYzdjMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds_bhZgH2gAyNTQxNzk2Nzk2OmMwYzBkMGRmYWFmMTk4NjYyNGE2OGQ1ZDRiNDEwYTkzYTBhZmE1ZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48aaa41d12c7d640385449084ccb10f2850c7c0e", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/48aaa41d12c7d640385449084ccb10f2850c7c0e", "committedDate": "2020-12-17T00:49:51Z", "message": "Use 0.17-SNAPSHOT of platform related libraries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9e346efa3a29f448fca5ce292fd34c2e0b7e19", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/fd9e346efa3a29f448fca5ce292fd34c2e0b7e19", "committedDate": "2020-12-17T00:53:09Z", "message": "Add fields to profile and contact request tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93fbbf339cb4812641b512534a7e45a7417eab86", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/93fbbf339cb4812641b512534a7e45a7417eab86", "committedDate": "2020-12-17T00:53:33Z", "message": "Add accountReference to exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe86a7835abdef0e83df8ef895c5400338a70a40", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/fe86a7835abdef0e83df8ef895c5400338a70a40", "committedDate": "2020-12-17T00:53:58Z", "message": "DashPayContactRequestDaoAsync: Return lists of contact requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e45c0a233589857591a3098b206ef729d8bc7d", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/34e45c0a233589857591a3098b206ef729d8bc7d", "committedDate": "2020-12-17T00:54:51Z", "message": "Add some support for avatar hash values\n\n* feature is not complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55dfc7b7f8531a61d5929452a48569c2b1ad545b", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/55dfc7b7f8531a61d5929452a48569c2b1ad545b", "committedDate": "2020-12-17T00:56:12Z", "message": "Use accountReference to when obtaining contact payment address"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe4cabcbf6f4d487de15a6bae18608d8170b338", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/0fe4cabcbf6f4d487de15a6bae18608d8170b338", "committedDate": "2020-12-17T06:25:19Z", "message": "Use the first contactRequest received for payments and searches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42bc7ba97fbc2c7f716a3a8000173b8300fe7b9e", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/42bc7ba97fbc2c7f716a3a8000173b8300fe7b9e", "committedDate": "2020-12-17T06:36:47Z", "message": "DashPayContactRequest: include accountReference as a primary key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11412a237260d9c95a37ef8ba98ccaaec5dcd669", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/11412a237260d9c95a37ef8ba98ccaaec5dcd669", "committedDate": "2020-12-17T09:56:21Z", "message": "Added avatarHash and avatarFingerprint support to PlatformRepo class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1411bc2a3346494d2388fb1ca20e6bd47818fef0", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/1411bc2a3346494d2388fb1ca20e6bd47818fef0", "committedDate": "2020-12-17T11:20:57Z", "message": "Calculating avatar hash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b583b3eb6ad7c3021c34881c690c6f64a6bf6b4", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/4b583b3eb6ad7c3021c34881c690c6f64a6bf6b4", "committedDate": "2020-12-17T11:43:54Z", "message": "Use avatarHash as a signature with Glide"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c6a5afbd4d41c67e031940b6203e3c5b115bfb", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/99c6a5afbd4d41c67e031940b6203e3c5b115bfb", "committedDate": "2020-12-17T16:31:27Z", "message": "Setting and validating the value of avatarHash being the SHA256 of profile picture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676573e5f1efb18ee42fb923a7d7158ce12bd81f", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/676573e5f1efb18ee42fb923a7d7158ce12bd81f", "committedDate": "2020-12-17T16:53:54Z", "message": "Setting the value of avatarHash for pictures stored on GoogleDrive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8577999902eea3f2892d7a0af58a604dd1075c19", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/8577999902eea3f2892d7a0af58a604dd1075c19", "committedDate": "2020-12-18T17:44:07Z", "message": "Setting the value of avatarFingerprint being the dHash of profile picture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzQ2ODM0", "url": "https://github.com/dashevo/dash-wallet/pull/579#pullrequestreview-556746834", "createdAt": "2020-12-22T00:34:29Z", "commit": {"oid": "676573e5f1efb18ee42fb923a7d7158ce12bd81f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMDozNDoyOVrOIJqUIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMDozNDoyOVrOIJqUIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAwMTM3OA==", "bodyText": "this is leftover code from a previous story.  It is not currently used.", "url": "https://github.com/dashevo/dash-wallet/pull/579#discussion_r547001378", "createdAt": "2020-12-22T00:34:29Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/work/UpdateProfileWorker.kt", "diffHunk": "@@ -72,20 +72,27 @@ class UpdateProfileWorker(context: Context, parameters: WorkerParameters)\n             }\n         }\n \n+        val avatarHash: ByteArray?\n+\n         // Perform the image upload here\n         val avatarUrlToUpload = inputData.getString(KEY_LOCAL_AVATAR_URL_TO_UPLOAD)?:\"\"\n         val uploadService = inputData.getString(KEY_UPLOAD_SERVICE)?:\"\"\n         if (avatarUrlToUpload.isNotEmpty()) {\n+            val avatarFile = File(avatarUrlToUpload)\n+            @Suppress(\"BlockingMethodInNonBlockingContext\")\n+            avatarHash = Sha256Hash.of(avatarFile).bytes\n             when (uploadService) {\n                 EditProfileViewModel.ProfilePictureStorageService.GOOGLE_DRIVE.name -> {\n-                    val avatarFileBytes = File(avatarUrlToUpload).readBytes()\n+                    val avatarFileBytes = avatarFile.readBytes()\n                     val fileId = saveToGoogleDrive(applicationContext, avatarFileBytes)\n                     avatarUrl = \"https://drive.google.com/uc?export=view&id=$fileId\"\n                 }\n                 EditProfileViewModel.ProfilePictureStorageService.IMGUR.name -> {\n                     //TODO:\n                 }\n             }\n+        } else {\n+            avatarHash = inputData.getByteArray(KEY_AVATAR_HASH)\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "676573e5f1efb18ee42fb923a7d7158ce12bd81f"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODMwODQ5", "url": "https://github.com/dashevo/dash-wallet/pull/579#pullrequestreview-556830849", "createdAt": "2020-12-22T05:40:02Z", "commit": {"oid": "8577999902eea3f2892d7a0af58a604dd1075c19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNTo0MDowMlrOIJvDKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNTo0MDowMlrOIJvDKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA3ODk1NA==", "bodyText": "Some commented code here.", "url": "https://github.com/dashevo/dash-wallet/pull/579#discussion_r547078954", "createdAt": "2020-12-22T05:40:02Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/utils/DHash.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 Dash Core Group\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package de.schildbach.wallet.ui.dashpay.utils;\n+\n+import android.graphics.Bitmap;\n+import android.graphics.Canvas;\n+import android.graphics.ColorMatrix;\n+import android.graphics.ColorMatrixColorFilter;\n+import android.graphics.Paint;\n+\n+import java.math.BigInteger;\n+\n+// base on:\n+// https://benhoyt.com/writings/duplicate-image-detection/\n+// https://www.hackerfactor.com/blog/index.php?/archives/529-Kind-of-Like-That.html\n+// https://github.com/tistaharahap/android-dhash/blob/master/src/com/bango/imagereco/Reco.java\n+\n+public class DHash {\n+\n+    private static final int HASH_SIZE = 8;\n+\n+    public static BigInteger of(Bitmap srcBmp) {\n+        Bitmap resizedBmp = Bitmap.createScaledBitmap(srcBmp, HASH_SIZE + 1, HASH_SIZE + 1, false);\n+        if (resizedBmp != srcBmp) {\n+            srcBmp.recycle();\n+        }\n+        Bitmap resizedGrayscaleBmp = toGrayscale(resizedBmp);\n+        if (resizedGrayscaleBmp != resizedBmp) {\n+            resizedBmp.recycle();\n+        }\n+\n+//        String fileName = \"test1.png\";\n+//        File file = new File(storageDir, fileName);\n+//        resizedGrayscaleBmp = BitmapFactory.decodeFile(file.getPath());\n+\n+        String dHashH = getHorizontalDifferences(resizedGrayscaleBmp);\n+//        String dHashV = getVerticalDifferences(resizedGrayscaleBmp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8577999902eea3f2892d7a0af58a604dd1075c19"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "250c6fbb3c8abbeabe4b68596a2bfa0417569f08", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/250c6fbb3c8abbeabe4b68596a2bfa0417569f08", "committedDate": "2020-12-28T13:39:11Z", "message": "Final improvements of CocoaImageDHash based on comparision of results against iOS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbfca5b0a806f3a21c8ddedcb89b7e1b8e74953b", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/bbfca5b0a806f3a21c8ddedcb89b7e1b8e74953b", "committedDate": "2020-12-29T04:53:17Z", "message": "Added tests based on data from iOS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3bc177a4836551d5f318239765a86570290954c", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/d3bc177a4836551d5f318239765a86570290954c", "committedDate": "2020-12-29T06:02:28Z", "message": "Fixed the issue found during the code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0c0d0dfaaf1986624a68d5d4b410a93a0afa5f5", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/c0c0d0dfaaf1986624a68d5d4b410a93a0afa5f5", "committedDate": "2021-01-05T00:03:59Z", "message": "Merge branch 'dpp-0.17' of https://github.com/dashevo/dash-wallet into avatar-hash-fingerprint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2767, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}