{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMzEyMTI4", "number": 570, "title": "DashPay: Only add new ContactRequests to the db/listeners", "bodyText": "Issue being fixed or feature implemented\n\n\n\nNMA-715\nOriginally, the app would always get the most recent contact request during a query, but this will modify it so that if it does get a contact request that we already have, then it is ignored.  Additionally, after a short period of time of receiving a contact request, it won't be included in future queries.\nas a result, the contacts updated listeners won't be triggered every 15 seconds, when there are no new contact requests.\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-12-07T01:17:24Z", "url": "https://github.com/dashevo/dash-wallet/pull/570", "merged": true, "mergeCommit": {"oid": "b368f7143ec865d6db9a7a6dd21a7dc03fc1525a"}, "closed": true, "closedAt": "2020-12-15T17:45:47Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjq_87gH2gAyNTMzMzEyMTI4OjgwMDNiNzUxZGM1OTBmYmYxM2E5ZDM4NTYyOTE4YWQ4MWYwOTZhZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmYnfmgFqTU1MjM1MDQ0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8003b751dc590fbf13a9d38562918ad81f096af0", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/8003b751dc590fbf13a9d38562918ad81f096af0", "committedDate": "2020-12-07T01:10:27Z", "message": "DashPayContactRequestDao: add exist method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "546fb06a853f005ee0980dc3a5819dd2a077663b", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/546fb06a853f005ee0980dc3a5819dd2a077663b", "committedDate": "2020-12-07T01:11:54Z", "message": "PlatformRepo: Only add new contactRequests\n\nOnly fire the contactsUpdatedListeners if contact requests were added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzUwNDQ0", "url": "https://github.com/dashevo/dash-wallet/pull/570#pullrequestreview-552350444", "createdAt": "2020-12-15T11:21:08Z", "commit": {"oid": "546fb06a853f005ee0980dc3a5819dd2a077663b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMToyMTowOFrOIGF9Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMToyNToxOFrOIGGGjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI1OTkxMQ==", "bodyText": "Nice!", "url": "https://github.com/dashevo/dash-wallet/pull/570#discussion_r543259911", "createdAt": "2020-12-15T11:21:08Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/data/DashPayContactRequestDao.kt", "diffHunk": "@@ -19,6 +19,9 @@ interface DashPayContactRequestDao {\n     @Query(\"SELECT * FROM dashpay_contact_request WHERE toUserId = :toUserId\")\n     suspend fun loadFromOthers(toUserId: String): List<DashPayContactRequest>?\n \n+    @Query(\"SELECT EXISTS (SELECT * FROM dashpay_contact_request WHERE userId = :userId AND toUserId = :toUserId)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "546fb06a853f005ee0980dc3a5819dd2a077663b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2MjM0OQ==", "bodyText": "I would prefer to use TimeUnit.MINUTES.toMillis(10) instead of DateUtils.MINUTE_IN_MILLIS * 10 but it isn't a part of this story so we can let well alone ;)", "url": "https://github.com/dashevo/dash-wallet/pull/570#discussion_r543262349", "createdAt": "2020-12-15T11:25:18Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -810,8 +810,15 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             Context.propagate(walletApplication.wallet.context)\n             var encryptionKey: KeyParameter? = null\n \n-            var lastContactRequestTime = if (dashPayContactRequestDao.countAllRequests() > 0)\n-                dashPayContactRequestDao.getLastTimestamp() - DateUtils.MINUTE_IN_MILLIS * 12\n+            var lastContactRequestTime = if (dashPayContactRequestDao.countAllRequests() > 0) {\n+                val lastTimeStamp = dashPayContactRequestDao.getLastTimestamp()\n+                // if the last contact request was received in the past 10 minutes, then query for\n+                // contact requests that are 10 minutes before it.  If the last contact request was\n+                // more than 10 minutes ago, then query all contact requests that came after it.\n+                if (lastTimeStamp < System.currentTimeMillis() - DateUtils.MINUTE_IN_MILLIS * 10)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "546fb06a853f005ee0980dc3a5819dd2a077663b"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2764, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}