{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MDA3MzQ3", "number": 542, "title": "Handling external URLs as profile pictures", "bodyText": "Issue being fixed or feature implemented\n\n\n\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-11-02T11:53:20Z", "url": "https://github.com/dashevo/dash-wallet/pull/542", "merged": true, "mergeCommit": {"oid": "32ff3129b542f960423108cc9f87297c525f79c3"}, "closed": true, "closedAt": "2020-11-08T23:41:53Z", "author": {"login": "tomasz-ludek"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXmDrNAH2gAyNTE0MDA3MzQ3OjdjMWQ4YTJiN2FhZGEyZDg4OGZjZDY5MDlmN2Y5Y2NhM2VlNGM0MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ2MVIgH2gAyNTE0MDA3MzQ3OmRmZGE1ZDkzYmNkM2IxMDFhN2JhNWRlYTBjNTU2OWQwM2UyZDkyY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c1d8a2b7aada2d888fcd6909f7f9cca3ee4c400", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/7c1d8a2b7aada2d888fcd6909f7f9cca3ee4c400", "committedDate": "2020-10-30T12:37:54Z", "message": "Major refactoring of HeaderBalanceFragment removed unused code, replaced Loaders with LiveDatas.\nFixed the issue with not displaying user profile picture."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ced029fffed254cc8e81b72f21f981662fd414e7", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/ced029fffed254cc8e81b72f21f981662fd414e7", "committedDate": "2020-10-30T12:55:02Z", "message": "Unified the way of displaying the profile picture across the app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2173df27f521eaca4dd15a3375ba839199df1a", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/db2173df27f521eaca4dd15a3375ba839199df1a", "committedDate": "2020-11-02T11:51:31Z", "message": "Handling external URLs as profile pictures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fe13922ce16cb94797ff12653ab70f301bc4591", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/4fe13922ce16cb94797ff12653ab70f301bc4591", "committedDate": "2020-11-02T11:58:28Z", "message": "Fixed a bug causing the external URL not to be saved"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "091d25e8eda8a115eea3a4c5ae42f0a7eaf61f19", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/091d25e8eda8a115eea3a4c5ae42f0a7eaf61f19", "committedDate": "2020-11-02T12:29:03Z", "message": "Fixed the bug causing the notifications count text view being displayed during blockchain sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7503c99ee30b1f1032e1c1a0d1cd42cc6eab620", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/f7503c99ee30b1f1032e1c1a0d1cd42cc6eab620", "committedDate": "2020-11-02T12:29:36Z", "message": "Merge branch 'get-profile-picture' into profile-picture-from-url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2749d1f3407e7d1592efcab4748f82281f48df", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/0f2749d1f3407e7d1592efcab4748f82281f48df", "committedDate": "2020-11-02T12:41:51Z", "message": "Fixed the bug causing the notifications count text view being displayed during blockchain sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22a9ac21f3bbe1a6df8323183d366e106a12f580", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/22a9ac21f3bbe1a6df8323183d366e106a12f580", "committedDate": "2020-11-02T12:42:16Z", "message": "Merge remote-tracking branch 'origin/get-profile-picture' into get-profile-picture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "092b61d8fef82112b5ce90ae228dc94207fb4846", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/092b61d8fef82112b5ce90ae228dc94207fb4846", "committedDate": "2020-11-02T12:42:38Z", "message": "Merge branch 'get-profile-picture' into profile-picture-from-url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db30338429dd5fbc5d54643b542f109c07967d60", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/db30338429dd5fbc5d54643b542f109c07967d60", "committedDate": "2020-11-02T13:51:54Z", "message": "Minor UX improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298d5d37c4207733bd2ad335617b9666f9770a18", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/298d5d37c4207733bd2ad335617b9666f9770a18", "committedDate": "2020-11-02T14:13:18Z", "message": "Added missing code removed during tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e4895b9b22b4ff1eaf1b82fafed84076616696e", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/0e4895b9b22b4ff1eaf1b82fafed84076616696e", "committedDate": "2020-11-02T18:26:10Z", "message": "Simplified the use of Google Drive URLs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9904c371b69e0501970a923bb502192169898b0", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/b9904c371b69e0501970a923bb502192169898b0", "committedDate": "2020-11-02T21:31:55Z", "message": "Fixed the IOException(Cleartext HTTP traffic to drive.google.com not permitted) on Android 10\nAdded logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2611a81ed651921026c4515d38b39d10bdab0c97", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/2611a81ed651921026c4515d38b39d10bdab0c97", "committedDate": "2020-11-03T09:34:47Z", "message": "Zoom the profile picture when editing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5db2ea43e01214df91322d71f941c4ba9f13c7ec", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/5db2ea43e01214df91322d71f941c4ba9f13c7ec", "committedDate": "2020-11-03T09:42:36Z", "message": "Merge branch 'get-profile-picture' into profile-picture-extarnal-drive\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61f78ab0075fd1ccd7c8878fc2da9fee0e095d68", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/61f78ab0075fd1ccd7c8878fc2da9fee0e095d68", "committedDate": "2020-11-03T09:47:23Z", "message": "Fixed the bug reported during code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4645135c9b4feb018f04393a1bcb1f93ad2fef", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/cc4645135c9b4feb018f04393a1bcb1f93ad2fef", "committedDate": "2020-11-03T09:52:29Z", "message": "Minor code refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7757c24a5e7fab7b6b1aac79ef7969672bcccc0", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/c7757c24a5e7fab7b6b1aac79ef7969672bcccc0", "committedDate": "2020-11-03T10:10:37Z", "message": "Optimised memory management in ExternalUrlProfilePictureDialog\nAdded an option to discontinue use of the profile picture URL at any time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c7a54d9d66ab89f77fc243d3102ba5c2167080", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/43c7a54d9d66ab89f77fc243d3102ba5c2167080", "committedDate": "2020-11-03T10:33:30Z", "message": "Unified the way od displaying profile picture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1685b3a7ab687a7c282299c42ae3a1be07bbf09", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/d1685b3a7ab687a7c282299c42ae3a1be07bbf09", "committedDate": "2020-11-03T11:08:40Z", "message": "Fixed the issue with removing profile picture URL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/77b0a3448917fea5c17f861602dc7805bd32d7c9", "committedDate": "2020-11-03T12:25:31Z", "message": "Avoid resetting profile picture when changing display name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTUyMzE0", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-522952314", "createdAt": "2020-11-03T23:42:08Z", "commit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0MjowOFrOHtEWhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0MjowOFrOHtEWhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxOTI3MA==", "bodyText": "prosilePictureChanged - profile is mispelled.", "url": "https://github.com/dashevo/dash-wallet/pull/542#discussion_r517019270", "createdAt": "2020-11-03T23:42:08Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt", "diffHunk": "@@ -66,9 +63,13 @@ class EditProfileActivity : BaseMenuActivity() {\n \n     private lateinit var editProfileViewModel: EditProfileViewModel\n     private lateinit var selectProfilePictureSharedViewModel: SelectProfilePictureSharedViewModel\n+    private lateinit var externalUrlSharedViewModel: ExternalUrlProfilePictureViewModel\n+\n     private var isEditing: Boolean = false\n     private var defaultAvatar: TextDrawable? = null\n \n+    private var prosilePictureChanged = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTUzMTA3", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-522953107", "createdAt": "2020-11-03T23:44:28Z", "commit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0NDoyOFrOHtEZPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0NDoyOFrOHtEZPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxOTk2Ng==", "bodyText": "Is this commented line not needed?", "url": "https://github.com/dashevo/dash-wallet/pull/542#discussion_r517019966", "createdAt": "2020-11-03T23:44:28Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/CropImageActivity.kt", "diffHunk": "@@ -41,25 +57,41 @@ class CropImageActivity : InteractionAwareActivity() {\n \n         val tempFile = intent.getParcelableExtra<Uri>(TEMP_FILE)\n         val destinationFile = intent.getParcelableExtra<Uri>(DESTINATION_FILE)\n-        Glide.with(this).load(tempFile).listener(object : RequestListener<Drawable> {\n-            override fun onLoadFailed(e: GlideException?, model: Any?, target: Target<Drawable>?, isFirstResource: Boolean): Boolean {\n-                Toast.makeText(this@CropImageActivity,\n-                        R.string.unable_to_load_image, Toast.LENGTH_SHORT).show()\n-                finish()\n-                return false\n-            }\n+        Glide.with(this)\n+                .load(tempFile)\n+//                .override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTUzNDM3", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-522953437", "createdAt": "2020-11-03T23:45:25Z", "commit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0NToyNVrOHtEaZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0NToyNVrOHtEaZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMDI2Mw==", "bodyText": "is this commented coded not needed?", "url": "https://github.com/dashevo/dash-wallet/pull/542#discussion_r517020263", "createdAt": "2020-11-03T23:45:25Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/ExternalUrlProfilePictureDialog.kt", "diffHunk": "@@ -0,0 +1,221 @@\n+/*\n+ * Copyright 2020 Dash Core Group\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.annotation.SuppressLint\n+import android.app.Dialog\n+import android.graphics.Bitmap\n+import android.graphics.drawable.BitmapDrawable\n+import android.graphics.drawable.Drawable\n+import android.net.Uri\n+import android.os.Bundle\n+import android.text.Editable\n+import android.text.TextWatcher\n+import android.view.View\n+import android.widget.Button\n+import android.widget.EditText\n+import android.widget.ImageView\n+import android.widget.Toast\n+import androidx.annotation.NonNull\n+import androidx.annotation.Nullable\n+import androidx.appcompat.app.AlertDialog\n+import androidx.fragment.app.DialogFragment\n+import androidx.lifecycle.ViewModelProvider\n+import com.bumptech.glide.Glide\n+import com.bumptech.glide.load.DataSource\n+import com.bumptech.glide.load.engine.GlideException\n+import com.bumptech.glide.request.RequestListener\n+import com.bumptech.glide.request.target.CustomTarget\n+import com.bumptech.glide.request.target.Target\n+import com.bumptech.glide.request.transition.Transition\n+import de.schildbach.wallet.ui.ExternalUrlProfilePictureViewModel\n+import de.schildbach.wallet.ui.RestoreWalletFromFileViewModel\n+import de.schildbach.wallet.util.KeyboardUtil\n+import de.schildbach.wallet_test.R\n+import org.slf4j.LoggerFactory\n+\n+\n+class ExternalUrlProfilePictureDialog : DialogFragment() {\n+\n+    companion object {\n+\n+        private val log = LoggerFactory.getLogger(RestoreWalletFromFileViewModel::class.java)\n+\n+        private const val ARG_INITIAL_URL = \"arg_initial_url\"\n+\n+        @JvmStatic\n+        fun newInstance(initialUrl: String?): ExternalUrlProfilePictureDialog {\n+            val dialog = ExternalUrlProfilePictureDialog()\n+            dialog.arguments = Bundle().apply {\n+                putString(ARG_INITIAL_URL, initialUrl)\n+            }\n+            return dialog\n+        }\n+    }\n+\n+    private val initialUrl by lazy {\n+        arguments?.getString(ARG_INITIAL_URL)\n+    }\n+\n+    private lateinit var customView: View\n+    private lateinit var edit: EditText\n+    private lateinit var urlPreviewPane: View\n+    private lateinit var urlPreview: ImageView\n+    private lateinit var positiveButton: Button\n+    private lateinit var neutralButton: Button\n+\n+    private lateinit var sharedViewModel: ExternalUrlProfilePictureViewModel\n+\n+    override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {\n+        val dialogBuilder = AlertDialog.Builder(requireContext())\n+                .setTitle(\"External URL\")\n+                .setPositiveButton(R.string.button_ok) { _, _ ->\n+                    sharedViewModel.confirm()\n+                    KeyboardUtil.hideKeyboard(requireContext(), edit)\n+                }\n+                .setNegativeButton(android.R.string.cancel) { _, _ ->\n+                    KeyboardUtil.hideKeyboard(requireContext(), edit)\n+                }\n+                .setNeutralButton(\"clear\", null)\n+                .setView(initCustomView())\n+\n+        val dialog = dialogBuilder.create()\n+        dialog.setOnShowListener {\n+            positiveButton = dialog.getButton(AlertDialog.BUTTON_POSITIVE)\n+            positiveButton.isEnabled = false\n+            neutralButton = dialog.getButton(AlertDialog.BUTTON_NEUTRAL)\n+            neutralButton.setOnClickListener {\n+                edit.text = null\n+            }\n+            if (edit.length() == 0) {\n+                neutralButton.visibility = View.GONE\n+            }\n+            if (initialUrl != null) {\n+                edit.setText(initialUrl)\n+            }\n+        }\n+        return dialog\n+    }\n+\n+    @SuppressLint(\"InflateParams\")\n+    private fun initCustomView(): View {\n+        customView = requireActivity().layoutInflater.inflate(R.layout.dialog_input_text, null)\n+        edit = customView.findViewById(R.id.input)\n+        urlPreviewPane = customView.findViewById(R.id.url_preview_pane)\n+        urlPreview = customView.findViewById(R.id.url_preview)\n+        edit.addTextChangedListener(object : TextWatcher {\n+            override fun afterTextChanged(s: Editable?) {\n+                urlPreviewPane.visibility = View.GONE\n+                neutralButton.visibility = if (edit.length() > 0) View.VISIBLE else View.GONE\n+\n+                cleanup()\n+\n+                if (edit.text.isEmpty()) {\n+                    positiveButton.isEnabled = true\n+                    return\n+                }\n+                val pictureUrl = edit.text.trim().toString()\n+                loadUrl(pictureUrl)\n+            }\n+\n+            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}\n+\n+            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}\n+        })\n+        return customView\n+    }\n+\n+    private fun cleanup() {\n+        urlPreview.setImageBitmap(null)\n+//        sharedViewModel.bitmapCache?.recycle()\n+        sharedViewModel.bitmapCache = null\n+        sharedViewModel.externalUrl = null\n+    }\n+\n+    private fun loadUrl(pictureUrlBase: String) {\n+        val googleDrivePreview = \"https://drive.google.com/file/d/\"\n+        val googleDrivePublic = \"http://drive.google.com/uc?export=view&id=\"\n+        val pictureUrl = if (pictureUrlBase.startsWith(googleDrivePreview)) {\n+            pictureUrlBase.replace(googleDrivePreview, googleDrivePublic).replace(\"/view\", \"\").replace(\"?usp=drivesdk\", \"\")\n+        } else {\n+            pictureUrlBase\n+        }\n+        Glide.with(requireContext())\n+                .load(pictureUrl)\n+                .override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL)\n+//                        .listener(object : RequestListener<Drawable> {\n+//                            override fun onLoadFailed(e: GlideException?, model: Any?, target: Target<Drawable>?, isFirstResource: Boolean): Boolean {\n+//                                urlPreviewPane.visibility = View.GONE\n+//                                positiveButton.isEnabled = false\n+//                                return false\n+//                            }\n+//                            override fun onResourceReady(resource: Drawable?, model: Any?, target: Target<Drawable>?, dataSource: DataSource?, isFirstResource: Boolean): Boolean {\n+//                                urlPreviewPane.visibility = View.VISIBLE\n+//                                positiveButton.isEnabled = true\n+//                                return false\n+//                            }\n+//                        })\n+//                        .into(urlPreview)\n+                .listener(object : RequestListener<Drawable> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "originalPosition": 173}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTUzNzI1", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-522953725", "createdAt": "2020-11-03T23:46:15Z", "commit": {"oid": "77b0a3448917fea5c17f861602dc7805bd32d7c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98a92e06b664eeabc054f176797a215004b900db", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/98a92e06b664eeabc054f176797a215004b900db", "committedDate": "2020-11-04T13:01:53Z", "message": "Refactored profile picture URLs support for Google Drive added Dropbox support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNTIxMjkz", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-523521293", "createdAt": "2020-11-04T16:20:20Z", "commit": {"oid": "98a92e06b664eeabc054f176797a215004b900db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNjI5MzI4", "url": "https://github.com/dashevo/dash-wallet/pull/542#pullrequestreview-523629328", "createdAt": "2020-11-04T18:30:15Z", "commit": {"oid": "98a92e06b664eeabc054f176797a215004b900db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxODozMDoxNVrOHtkpaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxODozMDoxNVrOHtkpaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU0ODM5Mw==", "bodyText": "externalUrlSharedViewModel.externalUrl is null when selecting a picture from Camera or Device.", "url": "https://github.com/dashevo/dash-wallet/pull/542#discussion_r517548393", "createdAt": "2020-11-04T18:30:15Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt", "diffHunk": "@@ -311,17 +333,51 @@ class EditProfileActivity : BaseMenuActivity() {\n                 }\n                 REQUEST_CODE_CROP_IMAGE -> {\n                     if (resultCode == Activity.RESULT_OK) {\n-                        setAvatarFromFile(editProfileViewModel.profilePictureFile!!)\n+                        if (externalUrlSharedViewModel.externalUrl != null) {\n+                            saveUrl(CropImageActivity.extractZoomedRect(data!!))\n+                        } else {\n+                            setAvatarFromFile(editProfileViewModel.profilePictureFile!!)\n+                        }\n                     }\n                 }\n             }\n         }\n     }\n \n+    private fun saveUrl(zoomedRect: RectF) {\n+        if (externalUrlSharedViewModel.externalUrl != null) {\n+            val zoomedRectStr = \"${zoomedRect.left},${zoomedRect.top},${zoomedRect.right},${zoomedRect.bottom}\"\n+            externalUrlSharedViewModel.externalUrl = setUriParameter(externalUrlSharedViewModel.externalUrl!!, \"dashpay-profile-pic-zoom\", zoomedRectStr)\n+\n+            val file = editProfileViewModel.tmpPictureFile\n+            val imgUri = getFileUri(file)\n+            Glide.with(dashpayUserAvatar).load(imgUri)\n+                    .signature(ObjectKey(file.lastModified()))\n+                    .placeholder(defaultAvatar)\n+                    .transform(ProfilePictureTransformation.create(zoomedRect))\n+                    .into(dashpayUserAvatar)\n+        }\n+    }\n+\n+    private fun setUriParameter(uri: Uri, key: String, newValue: String): Uri {\n+        val newUriBuilder = uri.buildUpon()\n+        if (uri.getQueryParameter(key) == null) {\n+            newUriBuilder.appendQueryParameter(key, newValue)\n+        } else {\n+            newUriBuilder.clearQuery()\n+            for (param in uri.queryParameterNames) {\n+                newUriBuilder.appendQueryParameter(param,\n+                        if (param == key) newValue else uri.getQueryParameter(param))\n+            }\n+        }\n+        return newUriBuilder.build()\n+    }\n+\n     private fun cropProfilePicture() {\n         val tmpPictureUri = editProfileViewModel.tmpPictureFile.toUri()\n         val profilePictureUri = editProfileViewModel.profilePictureFile!!.toUri()\n-        val intent = CropImageActivity.createIntent(this, tmpPictureUri, profilePictureUri)\n+        val initZoomedRect = ProfilePictureTransformation.extractZoomedRect(externalUrlSharedViewModel.externalUrl)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a92e06b664eeabc054f176797a215004b900db"}, "originalPosition": 182}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77546f5f02a237878c46687b4eb57ca36c96efa8", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/77546f5f02a237878c46687b4eb57ca36c96efa8", "committedDate": "2020-11-05T08:06:52Z", "message": "Fixed crash when trying to use GIF as a profile picture via in External URls.\nConverted ProfilePictureTransformation to kotlin and fixed NPE when taking photo from Camera.\nAdded Copyright headers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82134c680f66fbae7178261ee003678a07a0f51c", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/82134c680f66fbae7178261ee003678a07a0f51c", "committedDate": "2020-11-06T08:30:42Z", "message": "Fixed IllegalStateException: Cannot obtain size for recycled Bitmap: android.graphics.Bitmap\nRemoved annoying error toasts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a388e3cee59a0c08ce4cc3cf616d8e6c006e443", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/3a388e3cee59a0c08ce4cc3cf616d8e6c006e443", "committedDate": "2020-11-06T09:10:06Z", "message": "Merge branch 'evonet-develop' into profile-picture-from-url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3e11f185089c4bb9273c13f1cbf55ddb8dcfddd", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/b3e11f185089c4bb9273c13f1cbf55ddb8dcfddd", "committedDate": "2020-11-06T09:26:28Z", "message": "Minor code refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03477efb89a42c3ffac6e9a1d403b44ed052f37d", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/03477efb89a42c3ffac6e9a1d403b44ed052f37d", "committedDate": "2020-11-06T12:32:30Z", "message": "Avoid locking the app when playing with ExternalUrlProfilePictureDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfda5d93bcd3b101a7ba5dea0c5569d03e2d92cb", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/dfda5d93bcd3b101a7ba5dea0c5569d03e2d92cb", "committedDate": "2020-11-06T12:33:41Z", "message": "Remove dashpay-profile-pic-zoom URL parameter before displaying profile picture to avoid blocking the requests by server"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2865, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}