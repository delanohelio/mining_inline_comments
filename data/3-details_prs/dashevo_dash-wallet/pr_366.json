{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3OTQzNTM3", "number": 366, "title": "NMA-453 Fix for Notification / Network Monitor do not update during sync process", "bodyText": "Replace sync percentage calculation (use relative progress rather than absolute)\n\n\nbroadcast ACTION_BLOCKCHAIN_STATE for Network Monitor (no other activity listens for this since 10f34a6, #339).  The network monitor needs to know when the blockchain tip has changed so it can display that last 50+ transactions.  It does not need the blockchain state itself (at least not until information about chainlocks needs to be displayed).\n\n\nUpdate blockchain state more regularly, possibly.  This may help the sync notification close more often.  The assumption is made that the progress and doneDownload  methods may not always trigger the blockchain state to be updated and the notification stays on for a longer period of time.  This is only a guess, but returns some behavior to the v6 app, which did work for having the notification close when the app was done syncing.", "createdAt": "2020-04-03T05:22:58Z", "url": "https://github.com/dashevo/dash-wallet/pull/366", "merged": true, "mergeCommit": {"oid": "1f827b54650d695122e9585592382dd6a2276542"}, "closed": true, "closedAt": "2020-04-08T19:21:26Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT5z7UgH2gAyMzk3OTQzNTM3OjJkYjViZGVmOGY0MDgxZmY4MzlkZmU1NDFmMzBmNjkzN2E0Y2E5OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVsQd1AFqTM5MDIyODg5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "committedDate": "2020-04-03T05:11:57Z", "message": "BlockchainServiceImpl: Replace sync percentage, broadcast actions and\nupdate blockchains state more regularly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTQ0MTkx", "url": "https://github.com/dashevo/dash-wallet/pull/366#pullrequestreview-386944191", "createdAt": "2020-04-03T05:24:23Z", "commit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNToyNDoyM1rOGAFgRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNToyNDoyM1rOGAFgRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0MzM2NQ==", "bodyText": "before the Prevent Sending when Syncing story in v7 or v6, this was where the blockchain state was updated and broadcast.", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402743365", "createdAt": "2020-04-03T05:24:23Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -377,19 +378,32 @@ public void run() {\n                     if(timeAgo < DateUtils.DAY_IN_MILLIS)\n                         config.setRestoringBackup(false);\n                 }\n+                // this method is always called after progress or doneDownload\n+                updateBlockchainState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTQ1NDYx", "url": "https://github.com/dashevo/dash-wallet/pull/366#pullrequestreview-386945461", "createdAt": "2020-04-03T05:28:55Z", "commit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNToyODo1NVrOGAFkrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNToyODo1NVrOGAFkrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDQ5NQ==", "bodyText": "There may be a better way to do this in the BlockListFragment, with a database observer.  For now this is the quickest way to trigger the block loader in BlockListFragment without more significant rewrites.", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402744495", "createdAt": "2020-04-03T05:28:55Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -1026,6 +1040,11 @@ private void broadcastPeerState(final int numPeers) {\n     }\n \n     private void handleBlockchainStateNotification(BlockchainState blockchainState) {\n+        // send this out for the Network Monitor, other activities observe the database\n+        final Intent broadcast = new Intent(ACTION_BLOCKCHAIN_STATE);\n+        broadcast.setPackage(getPackageName());\n+        LocalBroadcastManager.getInstance(this).sendBroadcast(broadcast);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTQ1OTg3", "url": "https://github.com/dashevo/dash-wallet/pull/366#pullrequestreview-386945987", "createdAt": "2020-04-03T05:30:52Z", "commit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNTozMDo1MlrOGAFmTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNTozMDo1MlrOGAFmTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDkwOQ==", "bodyText": "This is a calculation that gives the percentage in terms how much the entire blockchain is synced (from block 0).  This is some left over code that should have been caught in a previous review 4 months ago when the method was changed to match what dashj provides in the progress method above.  If a user starts the app after 1 week with this code, the % will be displayed as 99% instead of 0 when the app starts to sync.", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402744909", "createdAt": "2020-04-03T05:30:52Z", "author": {"login": "HashEngineering"}, "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -1045,19 +1064,7 @@ private void handleBlockchainStateNotification(BlockchainState blockchainState)\n     }\n \n     private int percentageSync() {\n-        int chainHeadHeight = blockChain.getChainHead().getHeight();\n-        int mostCommonChainHeight;\n-        if (peerGroup == null) {\n-            return 0;\n-        }\n-        if (peerGroup.getMostCommonChainHeight() > 0) {\n-            mostCommonChainHeight = peerGroup.getMostCommonChainHeight();\n-        } else {\n-            mostCommonChainHeight = chainHeadHeight;\n-        }\n-        float percentage = ((float) chainHeadHeight / (float) mostCommonChainHeight) * 100;\n-        log.info(\"mostCommonChainHeight: \" + mostCommonChainHeight + \"\\tchainHeadHeight: \" + chainHeadHeight + \"\\t\" + percentage + \"%\\t\" + config.getBestChainHeightEver());\n-        return (int) percentage;\n+        return syncPercentage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjI4ODk3", "url": "https://github.com/dashevo/dash-wallet/pull/366#pullrequestreview-390228897", "createdAt": "2020-04-08T18:32:18Z", "commit": {"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2884, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}