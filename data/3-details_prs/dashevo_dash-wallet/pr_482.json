{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NzcxNDI4", "number": 482, "title": "Chain Sync Improvements (Phase 3)", "bodyText": "Issue being fixed or feature implemented\n\n\n\nImproves Platform / L1 Blockchain syncing to reduce losing payments from contacts\nRelated PR's and Dependencies\n\nScreenshots / Videos\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-08-18T22:08:51Z", "url": "https://github.com/dashevo/dash-wallet/pull/482", "merged": true, "mergeCommit": {"oid": "d8f87347907575de0d675bc080a73fd05c035380"}, "closed": true, "closedAt": "2020-09-11T20:52:29Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFUkiaAH2gAyNDY5NzcxNDI4OjVhZTg4OTI5MGFiZTE2NjEzZTY0MmI3YjE4Mzc2MmY0MDI0MmExZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH5xtBgFqTQ4NzAzNDE3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ae889290abe16613e642b7b183762f40242a1f3", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/5ae889290abe16613e642b7b183762f40242a1f3", "committedDate": "2020-09-03T18:04:52Z", "message": "PlatformRepo:  Fix issue that causes searchContacts to fail on null profiles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6991270db6a99df070dd3bb4f60c12e81d555fbc", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/6991270db6a99df070dd3bb4f60c12e81d555fbc", "committedDate": "2020-09-07T17:38:34Z", "message": "proguard: keep classes extended from Fragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ed9fd4ad99b798e3847b353786cb5919bb3a6d", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/d7ed9fd4ad99b798e3847b353786cb5919bb3a6d", "committedDate": "2020-09-07T18:44:04Z", "message": "Add contact request keychain when sending a contact request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f76e3aa7a81d27df485fb7488fa91a7b30e324", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/03f76e3aa7a81d27df485fb7488fa91a7b30e324", "committedDate": "2020-09-07T21:38:18Z", "message": "Constants: Add more parameters that depend on network\n\n* Supports Platform\n* Sync Logic (headers first, or not)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b94d84a936cbe3eb2d77f6d2d30f2248f378712", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/9b94d84a936cbe3eb2d77f6d2d30f2248f378712", "committedDate": "2020-09-07T21:38:19Z", "message": "PlatformRepo: Improve Syncing\n\n* Support DashJ's header first sync system\n* Add a keychain to the wallet after contact request is confirmed, then update bloom filters\n* Don't update bloom filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09a2b22df40d194292611e27ca67c261b198029f", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/09a2b22df40d194292611e27ca67c261b198029f", "committedDate": "2020-09-07T21:38:19Z", "message": "Use new Constants for initializing Dash."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cae73e8dc8afaa75d34b106ae58be8816f3cf01c", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/cae73e8dc8afaa75d34b106ae58be8816f3cf01c", "committedDate": "2020-09-07T21:38:20Z", "message": "BlockchainServiceImpl: Support headers first synchronization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "600edf7234f6419f4b9b62c3a79afc2b57771354", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/600edf7234f6419f4b9b62c3a79afc2b57771354", "committedDate": "2020-09-07T21:38:20Z", "message": "BlockchainServiceImpl: Add header support (syncing, persistence)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ac30630b374343c06839d0e24b3e58532ffefd4", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/9ac30630b374343c06839d0e24b3e58532ffefd4", "committedDate": "2020-09-07T21:38:20Z", "message": "PlatformRepo: Move everything in updateContactRequest inside a try block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2875e5538c3136a3274826e361a195819f92797c", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/2875e5538c3136a3274826e361a195819f92797c", "committedDate": "2020-09-07T21:38:20Z", "message": "Sync headers on mainnet and testnet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1ec316360e9052bac2a94dfadfc86167242261", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/4a1ec316360e9052bac2a94dfadfc86167242261", "committedDate": "2020-09-07T21:38:20Z", "message": "Close headers file on shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfaf5620b203773f51a7a120729c18a3cc6a9675", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/cfaf5620b203773f51a7a120729c18a3cc6a9675", "committedDate": "2020-09-07T21:38:20Z", "message": "Remove unused listener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fbf351a91cb98fa580836da78c51b237a1260b2", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/6fbf351a91cb98fa580836da78c51b237a1260b2", "committedDate": "2020-08-26T15:14:34Z", "message": "Remove unused listener"}, "afterCommit": {"oid": "cfaf5620b203773f51a7a120729c18a3cc6a9675", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/cfaf5620b203773f51a7a120729c18a3cc6a9675", "committedDate": "2020-09-07T21:38:20Z", "message": "Remove unused listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c93ed9b5f21c5c04de40a61a002ba5148bf7fd1", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/9c93ed9b5f21c5c04de40a61a002ba5148bf7fd1", "committedDate": "2020-09-07T21:59:27Z", "message": "Merge branch 'fix-missing-profiles' of https://github.com/dashevo/dash-wallet into chain-sync-improvements-3\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7d2275c0226696147d58d40e77e04f4622481f", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/4f7d2275c0226696147d58d40e77e04f4622481f", "committedDate": "2020-09-09T16:40:25Z", "message": "BlockchainServiceImpl: Ensure that blockchain state is updated upon completion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82", "committedDate": "2020-09-09T16:40:59Z", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into chain-sync-improvements-3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzMwMTYx", "url": "https://github.com/dashevo/dash-wallet/pull/482#pullrequestreview-486730161", "createdAt": "2020-09-11T11:38:25Z", "commit": {"oid": "89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTozODoyNlrOHQbXxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTozODoyNlrOHQbXxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4NzcxOQ==", "bodyText": "This whole method is duplicated below.", "url": "https://github.com/dashevo/dash-wallet/pull/482#discussion_r486987719", "createdAt": "2020-09-11T11:38:26Z", "author": {"login": "tomasz-ludek"}, "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -798,7 +801,66 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             log.error(formatExceptionMessage(\"error updating contacts\", e))\n         } finally {\n             updatingContacts.set(false)\n+            if (preDownloadBlocks.get()) {\n+                log.info(\"PreDownloadBlocks: complete\")\n+                preDownloadBlocksFuture?.set(true)\n+                preDownloadBlocks.set(false)\n+            }\n+        }\n+    }\n+\n+    // This will check for missing profiles, download them and update the database\n+    private suspend fun checkDatabaseIntegrity() {\n+        val watch = Stopwatch.createStarted()\n+        log.info(\"check database integrity: starting\");\n+\n+        val userIdList = HashSet<String>()\n+        val missingProfiles = HashSet<String>()\n+        val userId = blockchainIdentity.uniqueIdString\n+\n+        var toContactDocuments = dashPayContactRequestDaoAsync.loadToOthers(userId)\n+        val toContactMap = HashMap<String, DashPayContactRequest>()\n+        toContactDocuments!!.forEach {\n+            userIdList.add(it.toUserId)\n+            toContactMap[it.toUserId] = it\n+        }\n+        // Get all contact requests where toUserId == userId, the users who have added me\n+        val fromContactDocuments = dashPayContactRequestDaoAsync.loadFromOthers(userId)\n+        val fromContactMap = HashMap<String, DashPayContactRequest>()\n+        fromContactDocuments!!.forEach {\n+            userIdList.add(it.userId)\n+            fromContactMap[it.userId] = it\n+        }\n+\n+        for (user in userIdList) {\n+            val profile = dashPayProfileDaoAsync.load(user)\n+            if (profile == null) {\n+                missingProfiles.add(user)\n+            }\n+        }\n+\n+        if (missingProfiles.isNotEmpty()) {\n+            val profileDocuments = Profiles(platform).getList(missingProfiles.toList()) //only handles 100 userIds\n+            val profileById = profileDocuments.associateBy({ it.ownerId }, { it })\n+\n+            val nameDocuments = platform.names.getList(missingProfiles.toList())\n+            val nameById = nameDocuments.associateBy({ getIdentityForName(it) }, { it })\n+\n+            for (id in missingProfiles) {\n+                val nameDocument = nameById[id] // what happens if there is no username for the identity? crash\n+                val username = nameDocument!!.data[\"normalizedLabel\"] as String\n+                val identityId = getIdentityForName(nameDocument)\n+\n+                val profileDocument = profileById[id] ?: profiles.createProfileDocument(\"\", \"\",\n+                        \"\", platform.identities.get(identityId)!!)\n+\n+                val profile = DashPayProfile.fromDocument(profileDocument, username)\n+                dashPayProfileDaoAsync.insert(profile!!)\n+                log.info(\"check database integrity: adding missing profile $username:$id\")\n+            }\n         }\n+\n+        log.info(\"check database integrity complete in $watch\")\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82"}, "originalPosition": 143}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38706a1dd284351f43d19cc11cde1e2540cc992b", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/38706a1dd284351f43d19cc11cde1e2540cc992b", "committedDate": "2020-09-11T18:19:45Z", "message": "PlatformRepo: Remove duplicate method from merging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDM0MTc1", "url": "https://github.com/dashevo/dash-wallet/pull/482#pullrequestreview-487034175", "createdAt": "2020-09-11T18:33:35Z", "commit": {"oid": "38706a1dd284351f43d19cc11cde1e2540cc992b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2795, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}