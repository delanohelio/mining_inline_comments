{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxOTI4MDg5", "number": 528, "title": "DashPay: Profile Picture | Select Picture", "bodyText": "Issue being fixed or feature implemented\n\n\n\nNMA-418\nShow a menu that allows the user to take a picture or to choose an existing picture.  The path of the image is saved to the shared preferences.\nKnown issues:\n\nThe top of the selection dialog does not have rounded corners\n\nRelated PR's and Dependencies\n\nNone\nScreenshots / Videos\n\n\nHow Has This Been Tested?\n\n\n\n\n QA (Mobile Team)\n\nChecklist:\n\n\n I have performed a self-review of my own code and added comments where necessary\n I have added or updated relevant unit/integration/functional/e2e tests", "createdAt": "2020-10-13T02:14:46Z", "url": "https://github.com/dashevo/dash-wallet/pull/528", "merged": true, "mergeCommit": {"oid": "3ab784a1c5a0f7bb72a870893e22e82bb3257a7a"}, "closed": true, "closedAt": "2020-10-23T19:48:50Z", "author": {"login": "HashEngineering"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR-6FFAH2gAyNTAxOTI4MDg5OjE3YWU4MDQ4NzA3ZTIwYThlMDc2NjdjOGMyZTU5MThmYjI1NjY0NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVbVCyAH2gAyNTAxOTI4MDg5OmExMWEzMTFiYzI2MzI4MWQ3NDA3MGQzMGNjZjNlNDUwNDMxMDE0NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17ae8048707e20a8e07667c8c2e5918fb256645d", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/17ae8048707e20a8e07667c8c2e5918fb256645d", "committedDate": "2020-10-13T02:11:30Z", "message": "Add picture selection and save the path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dfcb0ff7df947c473ce427fa90384cc2f7c203f", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/1dfcb0ff7df947c473ce427fa90384cc2f7c203f", "committedDate": "2020-10-13T21:19:53Z", "message": "close the choose dialog after clicking, save the taken picture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTIzMjk4", "url": "https://github.com/dashevo/dash-wallet/pull/528#pullrequestreview-507923298", "createdAt": "2020-10-14T00:51:47Z", "commit": {"oid": "1dfcb0ff7df947c473ce427fa90384cc2f7c203f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo1MTo0N1rOHg-X_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo1MTo0N1rOHg-X_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzODQzMQ==", "bodyText": ".apply() needs to be called to save the image path to preferences.", "url": "https://github.com/dashevo/dash-wallet/pull/528#discussion_r504338431", "createdAt": "2020-10-14T00:51:47Z", "author": {"login": "sambarboza"}, "path": "common/src/main/java/org/dash/wallet/common/Configuration.java", "diffHunk": "@@ -431,7 +432,15 @@ public long getLastSeenNotificationTime() {\n         return prefs.getLong(PREFS_LAST_SEEN_NOTIFICATION_TIME, 0);\n     }\n \n-    public void setPrefsLastSeenNotificationTime(long lastSeenNotificationTime) {\n+    public void setLastSeenNotificationTime(long lastSeenNotificationTime) {\n         prefs.edit().putLong(PREFS_LAST_SEEN_NOTIFICATION_TIME, lastSeenNotificationTime).apply();\n     }\n+\n+    public void setLocalProfilePictureUri(String picturePath) {\n+        prefs.edit().putString(PREFS_KEY_LOCAL_PROFILE_PICTURE_URI, picturePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dfcb0ff7df947c473ce427fa90384cc2f7c203f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "649f0091a5dc9d8caaf4046096c9d15993998ff3", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/649f0091a5dc9d8caaf4046096c9d15993998ff3", "committedDate": "2020-10-14T01:55:06Z", "message": "Configuration: add .apply()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533ae5cdc9a49614dc377f59e2e4e342def31cbe", "author": {"user": {"login": "tomasz-ludek", "name": null}}, "url": "https://github.com/dashevo/dash-wallet/commit/533ae5cdc9a49614dc377f59e2e4e342def31cbe", "committedDate": "2020-10-15T23:14:03Z", "message": "Fixed the crash when taking picture on KitKat. (#529)\n\nImprove the way of storing profile picture in the app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de474d38ec3508ca8d75c8c837cbe0a6c6a6189", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/4de474d38ec3508ca8d75c8c837cbe0a6c6a6189", "committedDate": "2020-10-15T23:15:18Z", "message": "Fix permissions bug with taking a picture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d006090e401bdbba812adc882667cd4352a2bbae", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/d006090e401bdbba812adc882667cd4352a2bbae", "committedDate": "2020-10-15T23:20:57Z", "message": "remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e77c31f5a7ea1432d9c51977401e5dbdee9e8c9", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/9e77c31f5a7ea1432d9c51977401e5dbdee9e8c9", "committedDate": "2020-10-19T15:15:13Z", "message": "PlatformRepo: Only update the local copy of a Profile if it was updated on Platform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjk4OTc5", "url": "https://github.com/dashevo/dash-wallet/pull/528#pullrequestreview-513298979", "createdAt": "2020-10-21T04:32:26Z", "commit": {"oid": "9e77c31f5a7ea1432d9c51977401e5dbdee9e8c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNDozMjoyNlrOHlZ3qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNDozMjoyNlrOHlZ3qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk4MzIwOA==", "bodyText": "I think the ger... is a typo?", "url": "https://github.com/dashevo/dash-wallet/pull/528#discussion_r508983208", "createdAt": "2020-10-21T04:32:26Z", "author": {"login": "sambarboza"}, "path": "wallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt", "diffHunk": "@@ -177,4 +221,115 @@ class EditProfileActivity : BaseMenuActivity() {\n         this.isEditing = isEditing\n     }\n \n+    private fun takePictureWithPermission() {\n+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED) {\n+            takePicture()\n+        } else {\n+            ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.CAMERA), REQUEST_CODE_TAKE_PICTURE_PERMISSION)\n+        }\n+    }\n+\n+    private fun choosePictureWithPermission() {\n+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.READ_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED) {\n+            choosePicture()\n+        } else {\n+            ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.READ_EXTERNAL_STORAGE), REQUEST_CODE_CHOOSE_PICTURE_PERMISSION)\n+        }\n+    }\n+\n+    private fun selectImage(context: Context) {\n+        SelectProfilePictureDialog.createDialog()\n+                .show(supportFragmentManager, \"selectPictureDialog\");\n+    }\n+\n+    private fun choosePicture() {\n+        if (editProfileViewModel.createTmpPictureFile()) {\n+            val pickPhoto = Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI)\n+            startActivityForResult(pickPhoto, REQUEST_CODE_URI)\n+        } else {\n+            Toast.makeText(this, \"Unable to create temporary file\", Toast.LENGTH_LONG).show()\n+        }\n+    }\n+\n+    private fun takePicture() {\n+        if (editProfileViewModel.createTmpPictureFile()) {\n+            dispatchTakePictureIntent()\n+        } else {\n+            Toast.makeText(this, \"Unable to create temporary file\", Toast.LENGTH_LONG).show()\n+        }\n+    }\n+\n+    private fun dispatchTakePictureIntent() {\n+        Intent(MediaStore.ACTION_IMAGE_CAPTURE).also { takePictureIntent ->\n+            // Ensure that there's a camera activity to handle the intent\n+            takePictureIntent.resolveActivity(packageManager)?.also {\n+                val tmpFileUri = gerFileUri(editProfileViewModel.tmpPictureFile)\n+                takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, tmpFileUri)\n+                if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.LOLLIPOP) {\n+                    // to avoid 'SecurityException: Permission Denial' on KitKat\n+                    takePictureIntent.clipData = ClipData.newRawUri(\"\", tmpFileUri)\n+                    takePictureIntent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION or Intent.FLAG_GRANT_READ_URI_PERMISSION)\n+                }\n+                startActivityForResult(takePictureIntent, REQUEST_CODE_IMAGE)\n+            }\n+        }\n+    }\n+\n+    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {\n+        super.onActivityResult(requestCode, resultCode, data)\n+        if (resultCode != RESULT_CANCELED) {\n+            when (requestCode) {\n+                REQUEST_CODE_IMAGE -> {\n+                    if (resultCode == RESULT_OK) {\n+                        // picture saved in editProfileViewModel.profilePictureTmpFile\n+                        editProfileViewModel.onTmpPictureReadyForEditEvent.call(editProfileViewModel.tmpPictureFile)\n+                    }\n+                }\n+                REQUEST_CODE_URI -> if (resultCode == RESULT_OK && data != null) {\n+                    val selectedImage: Uri? = data.data\n+                    val filePathColumn = arrayOf(MediaStore.Images.Media.DATA)\n+                    if (selectedImage != null) {\n+                        val cursor: Cursor? = contentResolver.query(selectedImage,\n+                                filePathColumn, null, null, null)\n+                        if (cursor != null) {\n+                            cursor.moveToFirst()\n+                            val columnIndex: Int = cursor.getColumnIndex(filePathColumn[0])\n+                            val picturePath: String = cursor.getString(columnIndex)\n+                            editProfileViewModel.saveAsProfilePictureTmp(picturePath)\n+                            cursor.close()\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    private fun cropProfilePicture() {\n+        val tmpPictureFile = editProfileViewModel.tmpPictureFile\n+        //TODO: this line is for debugging - show the selected image on the screen\n+        dashpayUserAvatar.setImageURI(gerFileUri(tmpPictureFile))\n+        editProfileViewModel.saveTmpAsProfilePicture()\n+    }\n+\n+    override fun onRequestPermissionsResult(requestCode: Int, permissions: Array<out String>, grantResults: IntArray) {\n+        when (requestCode) {\n+            REQUEST_CODE_TAKE_PICTURE_PERMISSION -> {\n+                when {\n+                    grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED -> takePicture()\n+                    else -> takePictureWithPermission()\n+                }\n+            }\n+            REQUEST_CODE_CHOOSE_PICTURE_PERMISSION -> {\n+                when {\n+                    grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED -> choosePicture()\n+                    else -> choosePictureWithPermission()\n+                }\n+            }\n+            else -> super.onRequestPermissionsResult(requestCode, permissions, grantResults)\n+        }\n+    }\n+\n+    private fun gerFileUri(file: File): Uri {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e77c31f5a7ea1432d9c51977401e5dbdee9e8c9"}, "originalPosition": 207}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206c8d1fd6aee934a93541071dbfbd893a4c6004", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/206c8d1fd6aee934a93541071dbfbd893a4c6004", "committedDate": "2020-10-21T13:41:25Z", "message": "rename gerFileUri to getFileUri"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjY5MDEy", "url": "https://github.com/dashevo/dash-wallet/pull/528#pullrequestreview-514269012", "createdAt": "2020-10-21T23:55:54Z", "commit": {"oid": "206c8d1fd6aee934a93541071dbfbd893a4c6004"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NDIxNzk3", "url": "https://github.com/dashevo/dash-wallet/pull/528#pullrequestreview-515421797", "createdAt": "2020-10-23T07:47:46Z", "commit": {"oid": "206c8d1fd6aee934a93541071dbfbd893a4c6004"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09464c72325a7d2502177ccca38082adac87cfd3", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/09464c72325a7d2502177ccca38082adac87cfd3", "committedDate": "2020-10-23T15:35:41Z", "message": "Merge branch 'evonet-develop' into dashpay-choose-image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a11a311bc263281d74070d30ccf3e45043101449", "author": {"user": {"login": "HashEngineering", "name": "Hash Engineering Solutions"}}, "url": "https://github.com/dashevo/dash-wallet/commit/a11a311bc263281d74070d30ccf3e45043101449", "committedDate": "2020-10-23T19:00:04Z", "message": "rename button"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2857, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}