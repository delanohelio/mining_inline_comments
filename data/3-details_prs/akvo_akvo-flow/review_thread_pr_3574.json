{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxOTE5MTgz", "number": 3574, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0MTo1N1rOD_AnZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1Njo0MFrOD_A6zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3Mzk2OTY3OnYy", "diffSide": "RIGHT", "path": "ci/flip-production-traffic.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0MTo1N1rOGZdVCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNzoxNzo1MFrOGZ3DiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODEwNQ==", "bodyText": "Why CLUSTER ? In App Engine you work with projects", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429348105", "createdAt": "2020-05-22T16:41:57Z", "author": {"login": "iperdomo"}, "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTYwOQ==", "bodyText": "Copy and paste legacy ...", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429769609", "createdAt": "2020-05-25T07:17:50Z", "author": {"login": "dlebrero"}, "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODEwNQ=="}, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3Mzk5Njg2OnYy", "diffSide": "RIGHT", "path": "ci/flip-production-traffic.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0ODo0N1rOGZdmbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNzoyMzoyNlrOGZ3M4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1MjU1OQ==", "bodyText": "I've seen those pipe tricks elsewhere. If you want to continue working with text:\ngcloud app versions list --project=akvoflow-uat1 --hide-no-traffic --service=default | awk '/^default/ {print $2}'\nOr gcloud has --format=json for structured output\ngcloud app versions list --project=akvoflow-uat1 --hide-no-traffic --service=default --format=json | jq -M -r '.[].version.id'", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429352559", "createdAt": "2020-05-22T16:48:47Z", "author": {"login": "iperdomo"}, "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MjAwMg==", "bodyText": "opted for --format=\"value(VERSION.id)\"", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429772002", "createdAt": "2020-05-25T07:23:26Z", "author": {"login": "dlebrero"}, "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1MjU1OQ=="}, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAxMzE0OnYy", "diffSide": "RIGHT", "path": "ci/promote-test-to-prod.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1NDozMlrOGZdw1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNzoyNTozMVrOGZ3Qdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTIyMQ==", "bodyText": "In promote-test-to-prod.sh line 72:\nif [ \"${FIX}\" != \"n\" ] || [ \"${FIX}\" != \"N\" ]; then\n                       ^-- SC2252: You probably wanted && here, otherwise it's always true.\n\nFor more information:\n  https://www.shellcheck.net/wiki/SC2252 -- You probably wanted && here, othe...", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355221", "createdAt": "2020-05-22T16:54:32Z", "author": {"login": "iperdomo"}, "path": "ci/promote-test-to-prod.sh", "diffHunk": "@@ -0,0 +1,85 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+GITHUB_PROJECT=akvo-flow\n+NOTIFICATION=${4:-slack}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )\n+}\n+\n+if [[ -z \"$(gcloud config list --format='value(core.account)')\" ]]; then\n+  gcloud auth login\n+fi\n+\n+read_version \"akvoflow-dev2\"\n+TEST_LIVE_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev1\"\n+PROD_DARK_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev3\" # WHH instance\n+PROD_LIVE_VERSION=$VERSION\n+\n+log \"Deployed test version is $TEST_LIVE_VERSION\"\n+log \"Deployed prod dark version is $PROD_DARK_VERSION\"\n+log \"Diff between test and dark prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_DARK_VERSION..$TEST_LIVE_VERSION\"\n+\n+if [[ \"$PROD_DARK_VERSION\" = \"$PROD_LIVE_VERSION\" ]]; then\n+  log \"Deployed prod live version is same as prod dark version\"\n+else\n+  log \"Deployed prod live version is $PROD_LIVE_VERSION\"\n+  log \"Diff between test and live prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_LIVE_VERSION..$TEST_LIVE_VERSION\"\n+fi\n+\n+## Lets assume this git history:\n+# v1 (prod-live)\n+# v2\n+# v3 (prod-dark)\n+# v4\n+# v5 (test)\n+# When promoting a build, we want to report the new changes (v4, v5) that will show in dark.\n+# But lets say that we have the previous history and we do a flip in production. We have:\n+# v1 (prod-dark)\n+# v2\n+# v3 (prod-live)\n+# v4\n+# v5 (test)\n+# So in this case we really want to report the changes between test and prod-live (still v4, v5)\n+# In general terms, we want to see the diff between test and the last promotion.\n+# Instead of looking at git tags, we just check which of the prod envs is older\n+if git merge-base --is-ancestor \"$PROD_LIVE_VERSION\" \"$PROD_DARK_VERSION\"; then\n+  NEWEST_VERSION_IN_PROD=$PROD_DARK_VERSION\n+else\n+  NEWEST_VERSION_IN_PROD=$PROD_LIVE_VERSION\n+fi\n+log \"Commits to be deployed:\"\n+echo \"\"\n+\n+git log --oneline \"$NEWEST_VERSION_IN_PROD\"..\"$TEST_LIVE_VERSION\" | grep -v \"Merge pull request\" | grep -v \"Merge branch\"\n+\n+TAG_NAME=\"promote-$(TZ=UTC date +\"%Y%m%d-%H%M%S\")\"\n+\n+echo \"\"\n+read -r -e -p \"Does this deployment contain a hotfix, rollback or fix-forward for a previous deployment? [Y/n] \" FIX\n+if [ \"${FIX}\" != \"n\" ] || [ \"${FIX}\" != \"N\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MjkxOQ==", "bodyText": "I copy and pasted this error 3 times at least", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429772919", "createdAt": "2020-05-25T07:25:31Z", "author": {"login": "dlebrero"}, "path": "ci/promote-test-to-prod.sh", "diffHunk": "@@ -0,0 +1,85 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+GITHUB_PROJECT=akvo-flow\n+NOTIFICATION=${4:-slack}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )\n+}\n+\n+if [[ -z \"$(gcloud config list --format='value(core.account)')\" ]]; then\n+  gcloud auth login\n+fi\n+\n+read_version \"akvoflow-dev2\"\n+TEST_LIVE_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev1\"\n+PROD_DARK_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev3\" # WHH instance\n+PROD_LIVE_VERSION=$VERSION\n+\n+log \"Deployed test version is $TEST_LIVE_VERSION\"\n+log \"Deployed prod dark version is $PROD_DARK_VERSION\"\n+log \"Diff between test and dark prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_DARK_VERSION..$TEST_LIVE_VERSION\"\n+\n+if [[ \"$PROD_DARK_VERSION\" = \"$PROD_LIVE_VERSION\" ]]; then\n+  log \"Deployed prod live version is same as prod dark version\"\n+else\n+  log \"Deployed prod live version is $PROD_LIVE_VERSION\"\n+  log \"Diff between test and live prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_LIVE_VERSION..$TEST_LIVE_VERSION\"\n+fi\n+\n+## Lets assume this git history:\n+# v1 (prod-live)\n+# v2\n+# v3 (prod-dark)\n+# v4\n+# v5 (test)\n+# When promoting a build, we want to report the new changes (v4, v5) that will show in dark.\n+# But lets say that we have the previous history and we do a flip in production. We have:\n+# v1 (prod-dark)\n+# v2\n+# v3 (prod-live)\n+# v4\n+# v5 (test)\n+# So in this case we really want to report the changes between test and prod-live (still v4, v5)\n+# In general terms, we want to see the diff between test and the last promotion.\n+# Instead of looking at git tags, we just check which of the prod envs is older\n+if git merge-base --is-ancestor \"$PROD_LIVE_VERSION\" \"$PROD_DARK_VERSION\"; then\n+  NEWEST_VERSION_IN_PROD=$PROD_DARK_VERSION\n+else\n+  NEWEST_VERSION_IN_PROD=$PROD_LIVE_VERSION\n+fi\n+log \"Commits to be deployed:\"\n+echo \"\"\n+\n+git log --oneline \"$NEWEST_VERSION_IN_PROD\"..\"$TEST_LIVE_VERSION\" | grep -v \"Merge pull request\" | grep -v \"Merge branch\"\n+\n+TAG_NAME=\"promote-$(TZ=UTC date +\"%Y%m%d-%H%M%S\")\"\n+\n+echo \"\"\n+read -r -e -p \"Does this deployment contain a hotfix, rollback or fix-forward for a previous deployment? [Y/n] \" FIX\n+if [ \"${FIX}\" != \"n\" ] || [ \"${FIX}\" != \"N\" ]; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTIyMQ=="}, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAxNTUwOnYy", "diffSide": "RIGHT", "path": "ci/generate-slack-notification.sh", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1NToxN1rOGZdyTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNzozMDoxM1rOGZ3ZHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTU5Nw==", "bodyText": "Why do we need a script to generate another script!? \ud83e\udd2f", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355597", "createdAt": "2020-05-22T16:55:17Z", "author": {"login": "iperdomo"}, "path": "ci/generate-slack-notification.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#!/usr/bin/env bash\n+\n+OLDER_GIT_VERSION=$1\n+NEWEST_GIT_VERSION=$2\n+MSG=$3\n+COLOR=$4\n+WRAP_SLACK=$5\n+GITHUB_PROJECT=$6\n+\n+cat << EOF > notify.team.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NTEzMw==", "bodyText": "This is because as a confirmation for the promote or flip, we expect the developer to manually run some commands.", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429775133", "createdAt": "2020-05-25T07:30:13Z", "author": {"login": "dlebrero"}, "path": "ci/generate-slack-notification.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#!/usr/bin/env bash\n+\n+OLDER_GIT_VERSION=$1\n+NEWEST_GIT_VERSION=$2\n+MSG=$3\n+COLOR=$4\n+WRAP_SLACK=$5\n+GITHUB_PROJECT=$6\n+\n+cat << EOF > notify.team.sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTU5Nw=="}, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAxNjczOnYy", "diffSide": "RIGHT", "path": "ci/promote-test-to-prod.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1NTo0NFrOGZdzIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1NTo0NFrOGZdzIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTgxMQ==", "bodyText": "Ideam. Projects no cluster.", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355811", "createdAt": "2020-05-22T16:55:44Z", "author": {"login": "iperdomo"}, "path": "ci/promote-test-to-prod.sh", "diffHunk": "@@ -0,0 +1,85 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+GITHUB_PROJECT=akvo-flow\n+NOTIFICATION=${4:-slack}\n+\n+function read_version () {\n+    CLUSTER=$1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAxOTM0OnYy", "diffSide": "RIGHT", "path": "ci/deploy.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1Njo0MFrOGZd0ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1Njo0MFrOGZd0ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NjIyNw==", "bodyText": "Let's use CI_GIT_SHA or similar", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429356227", "createdAt": "2020-05-22T16:56:40Z", "author": {"login": "iperdomo"}, "path": "ci/deploy.sh", "diffHunk": "@@ -2,36 +2,15 @@\n \n set -euo pipefail\n \n-CI_BRANCH=\"${SEMAPHORE_GIT_BRANCH:=}\"\n-CI_TAG=\"${SEMAPHORE_GIT_TAG_NAME:=}\"\n-CI_PULL_REQUEST=\"${SEMAPHORE_GIT_PR_NAME:=}\"\n-\n function log {\n    echo \"$(date +\"%T\") - INFO - $*\"\n }\n \n-if [[ \"${CI_BRANCH}\" != \"master\" ]] && [[ -z \"${CI_TAG}\" ]]; then\n-   exit 0\n-fi\n-\n-if [[ -n \"${CI_PULL_REQUEST}\" ]]; then\n-    exit 0\n-fi\n-\n-if [[ \"${CI_TAG:0:8}\" == \"promote-\" ]]; then\n-    echo \"Skipping deployment\"\n-    exit 0\n-fi\n-\n-develop_project_id=\"${DEVELOP_PROJECT_ID:=akvoflow-uat2}\"\n-release_project_id=\"${RELEASE_PROJECT_ID:=akvoflow-uat1}\"\n+develop_project_id=\"${DEVELOP_PROJECT_ID:=akvoflow-dev2}\"\n+FLOW_VERSION=${FLOW_VERSION:-${SEMAPHORE_GIT_SHA}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4554, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}