{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNDUzNTA0", "number": 3567, "title": "Fix webform validation conditions and refactor logic application contexts", "bodyText": "Before the PR (what is the issue or what needed to be done)\n\nRemove Cascade question type as not allowed\nValidate survey (and update webform boolean column db) only on surveys/{id}/webform_id and publishing survey logic (thus webform python backend only uses s3 survey published definitions)\n\nReviewer Checklist\n\n Added an explanation about the work done\n Connected the PR and the issue on Zenhub\n Added a test plan to the issue\n Updated the copyright header (when relevant)\n Formatted the code\n Added a documentation (if relevant)\n Added some unit tests (if relevant)", "createdAt": "2020-05-21T16:30:42Z", "url": "https://github.com/akvo/akvo-flow/pull/3567", "merged": true, "mergeCommit": {"oid": "7b6ba2c885f0c7f83b63c75caf6681963838b142"}, "closed": true, "closedAt": "2020-05-22T11:14:35Z", "author": {"login": "tangrammer"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjdhyZgH2gAyNDIxNDUzNTA0OjMxODU5N2UxZDE0Njg3MTc4ZmRhZDRlYTJkMjdmMmIxMGE2NTJlNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjwRkiAFqTQxNjgyOTYyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "318597e1d14687178fdad4ea2d27f2b10a652e40", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/318597e1d14687178fdad4ea2d27f2b10a652e40", "committedDate": "2020-05-21T13:17:35Z", "message": "[#3562] Fix webform constraints\n\nAllow cascade types and don't allow monitoring surveys nor repeatable\nquestion groups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60a2e81242230632671f8b47eb54eefec6a563d8", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/60a2e81242230632671f8b47eb54eefec6a563d8", "committedDate": "2020-05-21T16:05:57Z", "message": "[#3562] Move webform validation to publishing survey place\n\nInstead of having validation every time a question is changed or a\nquestionGroup is changed or a form is changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/ed0ffc57cc551342a4c675aed85883bce9082ba3", "committedDate": "2020-05-21T17:28:55Z", "message": "[#3526] Update webform only if enabled on publishing action"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDE0MTI2", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416414126", "createdAt": "2020-05-21T19:05:48Z", "commit": {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxOTowNTo0OFrOGY_MtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxOTowNjoxM1rOGY_NeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDQ1Mw==", "bodyText": "Why do we need an explicit boolean primitive? .... using i.getRepeatable() does the trick", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854453", "createdAt": "2020-05-21T19:05:48Z", "author": {"login": "iperdomo"}, "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDY0OA==", "bodyText": "Idem, that extra .booleanValue() is not required, I think", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854648", "createdAt": "2020-05-21T19:06:13Z", "author": {"login": "iperdomo"}, "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup().booleanValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "committedDate": "2020-05-22T07:48:54Z", "message": "[#3526] Use Boolean instead of boolean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzMyNjgw", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416732680", "createdAt": "2020-05-22T08:20:46Z", "commit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwODoyMDo0NlrOGZOxog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwODoyMDo0NlrOGZOxog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng==", "bodyText": "So this one is a bit more subtle. It should be that webforms doesn't support monitoring forms. I.e. in a survey you have registration form and monitoring forms.  We should allow a registration form to be filled in.  Registration form id is === SurveyGroup.newLocaleSurveyId @marvinkome I guess this is already done on UI side?", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429109666", "createdAt": "2020-05-22T08:20:46Z", "author": {"login": "muloem"}, "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Nzc0ODky", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416774892", "createdAt": "2020-05-22T09:29:53Z", "commit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOToyOTo1M1rOGZQyPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOToyOTo1M1rOGZQyPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0MjU4OA==", "bodyText": "Let's always use { } in if conditions.", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429142588", "createdAt": "2020-05-22T09:29:53Z", "author": {"login": "iperdomo"}, "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup();\n+    }\n+\n+    public static boolean validWebForm(final SurveyGroup surveyGroup, final Survey survey, final List<Question> questions){\n+        boolean validQuestionGroups = validQuestionGroups(survey);\n+        if (!validQuestionGroups) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Nzc1NDE4", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416775418", "createdAt": "2020-05-22T09:30:47Z", "commit": {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d10548622314c88794b2c0a8709ddba31d630e", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/29d10548622314c88794b2c0a8709ddba31d630e", "committedDate": "2020-05-22T09:32:09Z", "message": "[#3526] Adapt to PR review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "committedDate": "2020-05-22T09:40:16Z", "message": "[#3562] Refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5843daa211b2469ac8a635214f2d5bcf178ec68", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/b5843daa211b2469ac8a635214f2d5bcf178ec68", "committedDate": "2020-05-22T09:39:59Z", "message": "[#3562] Refactor"}, "afterCommit": {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "committedDate": "2020-05-22T09:40:16Z", "message": "[#3562] Refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Nzg4OTky", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416788992", "createdAt": "2020-05-22T09:53:30Z", "commit": {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOTo1MzozMFrOGZRcvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOTo1MzozMFrOGZRcvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MzQ3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {\n          \n          \n            \n                public static boolean validForm(final Survey survey, final SurveyGroup surveyGroup) {", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429153471", "createdAt": "2020-05-22T09:53:30Z", "author": {"login": "muloem"}, "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -23,19 +23,32 @@\n \n public class WebForm {\n \n-    public static Set<String> unsupportedQuestionTypes(){\n+    public static Set<String> unsupportedQuestionTypes() {\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey) {\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7b6dd28a7a8781303777b9533e2b9c491512c5", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/ce7b6dd28a7a8781303777b9533e2b9c491512c5", "committedDate": "2020-05-22T10:27:54Z", "message": "Update GAE/src/com/gallatinsystems/survey/domain/WebForm.java\n\nCo-authored-by: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f015b53941acf2db97edcdfa75c7ac578a2942", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/78f015b53941acf2db97edcdfa75c7ac578a2942", "committedDate": "2020-05-22T10:47:39Z", "message": "[#3562] Fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2ODI5NjIz", "url": "https://github.com/akvo/akvo-flow/pull/3567#pullrequestreview-416829623", "createdAt": "2020-05-22T11:08:04Z", "commit": {"oid": "78f015b53941acf2db97edcdfa75c7ac578a2942"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4498, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}