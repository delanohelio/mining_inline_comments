{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NjczOTg4", "number": 3592, "title": "[#3591] Datascript to delete specified iterations for a survey instance", "bodyText": "The solution\n\nDelete one or more iterations by specifying at the command line\nUpdate the iteration index in the responses if needed (not strictly necessary)\nUpdate the dependency libraries\n\nReviewer Checklist\n\n Added an explanation about the work done\n Connected the PR and the issue on Zenhub\n Added a test plan to the issue\n Updated the copyright header (when relevant)\n Formatted the code\n Added a documentation (if relevant)\n Added some unit tests (if relevant)", "createdAt": "2020-05-28T19:01:16Z", "url": "https://github.com/akvo/akvo-flow/pull/3592", "merged": true, "mergeCommit": {"oid": "be337da92c3325b8f5a79054ec3f5affc1af9898"}, "closed": true, "closedAt": "2020-05-29T11:22:48Z", "author": {"login": "muloem"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclymVIAH2gAyNDI0NjczOTg4OmY0NzVhYzhlNWQ3MDQ1YTNhZTgyNjBkMDgxZmNlYzdlNGQ1YzYyYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmAiMOgFqTQyMDg2MDA0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4", "committedDate": "2020-05-28T18:58:24Z", "message": "[#3591] Datascript to delete specified iterations for a survey instance\n\n* Delete one or more iterations by specifying at the command line\n* Update the iteration index in the responses if needed (not strictly necessary)\n* Update the dependency libraries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDgwODA4", "url": "https://github.com/akvo/akvo-flow/pull/3592#pullrequestreview-420480808", "createdAt": "2020-05-28T20:49:26Z", "commit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0OToyN1rOGcGM3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0OToyN1rOGcGM3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDkwOA==", "bodyText": "So in order to delete and update, you need to run the script twice? you cannot have both d and u?", "url": "https://github.com/akvo/akvo-flow/pull/3592#discussion_r432114908", "createdAt": "2020-05-28T20:49:27Z", "author": {"login": "valllllll2000"}, "path": "scripts/data/delete-repeat-iterations.sh", "diffHunk": "@@ -0,0 +1,17 @@\n+#!/bin/sh\n+\n+# USAGE: ./delete-repeat-iterations.sh akvoflow-uat1 [surveyInstanceId] [group name] [1,2,4] [d | u]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDg4NjE2", "url": "https://github.com/akvo/akvo-flow/pull/3592#pullrequestreview-420488616", "createdAt": "2020-05-28T21:00:57Z", "commit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMTowMDo1N1rOGcGkBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMTowMDo1N1rOGcGkBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMDgzOQ==", "bodyText": "what happens is formId is null?", "url": "https://github.com/akvo/akvo-flow/pull/3592#discussion_r432120839", "createdAt": "2020-05-28T21:00:57Z", "author": {"login": "valllllll2000"}, "path": "scripts/data/src/org/akvo/gae/remoteapi/DeleteRepeatQuestionGroupIteration.java", "diffHunk": "@@ -0,0 +1,315 @@\n+/*\n+ *  Copyright (C) 2020 Stichting Akvo (Akvo Foundation)\n+ *\n+ *  This file is part of Akvo FLOW.\n+ *\n+ *  Akvo FLOW is free software: you can redistribute it and modify it under the terms of\n+ *  the GNU Affero General Public License (AGPL) as published by the Free Software Foundation,\n+ *  either version 3 of the License or any later version.\n+ *\n+ *  Akvo FLOW is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ *  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ *  See the GNU Affero General Public License included below for more details.\n+ *\n+ *  The full license text can also be seen at <http://www.gnu.org/licenses/agpl.html>.\n+ */\n+\n+package org.akvo.gae.remoteapi;\n+\n+import com.google.appengine.api.datastore.DatastoreService;\n+import com.google.appengine.api.datastore.Entity;\n+import com.google.appengine.api.datastore.EntityNotFoundException;\n+import com.google.appengine.api.datastore.FetchOptions;\n+import com.google.appengine.api.datastore.Key;\n+import com.google.appengine.api.datastore.KeyFactory;\n+import com.google.appengine.api.datastore.PreparedQuery;\n+import com.google.appengine.api.datastore.Query;\n+import com.google.appengine.api.datastore.Query.Filter;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+public class DeleteRepeatQuestionGroupIteration implements Process {\n+\n+    private static long NON_EXISTENT_ID = -1L;\n+\n+    private Long surveyInstanceId;\n+\n+    private Long formId;\n+\n+    private String questionGroupName;\n+\n+    private List<Long> iterationsToDelete;\n+\n+    private boolean deleteIterations;\n+\n+    private boolean updateIterations;\n+\n+    @Override\n+    public void execute(DatastoreService ds, String[] args) throws Exception {\n+        System.out.println(\"##############################################################\");\n+        System.out.printf(\n+                        \"#      Arguments: survey instance id, current question group name between quotes, %n\" +\n+                        \"#      comma-separated list of iterations (as they appear in data  %n\" +\n+                        \"#      cleaning report i.e. starting at number 1...) to delete %n\" +\n+                        \"#      d to confirm deletion of iterations %n\");\n+        System.out.printf(\"##############################################################%n%n%n\");\n+\n+        parseArgs(args, ds);\n+\n+        List<Long> repeatGroupQuestionIds = retrieveRepeatGroupQuestionIds(ds);\n+        if (repeatGroupQuestionIds.isEmpty()) {\n+            System.out.println(\"No questions found for group: *\" + questionGroupName + \"*\");\n+            System.exit(0);\n+        }\n+\n+        List<Entity> responses = retrieveResponses(ds, this.surveyInstanceId, repeatGroupQuestionIds);\n+\n+        if (deleteIterations) {\n+            deleteRepeatGroupIterations(ds, responses, this.iterationsToDelete);\n+        } else {\n+            System.out.println(\"No delete request made\");\n+        }\n+\n+        if (updateIterations) {\n+            updateResponseIterations(ds, responses, this.iterationsToDelete);\n+        } else {\n+            System.out.println(\"No iterations to update\");\n+        }\n+    }\n+\n+    private void parseArgs(String[] args, DatastoreService ds) {\n+        Long surveyInstanceId = parseSurveyInstanceId(args);\n+        if (surveyInstanceId.equals(-1L)) {\n+            System.out.println(\"No survey instance id found. Exiting\");\n+            System.exit(1);\n+        } else {\n+            this.surveyInstanceId = surveyInstanceId;\n+        }\n+\n+        this.formId = retrieveFormId(surveyInstanceId, ds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODYwMDQx", "url": "https://github.com/akvo/akvo-flow/pull/3592#pullrequestreview-420860041", "createdAt": "2020-05-29T11:12:33Z", "commit": {"oid": "f475ac8e5d7045a3ae8260d081fcec7e4d5c62c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4513, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}