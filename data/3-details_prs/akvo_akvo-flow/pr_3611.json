{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNzY0MTYz", "number": 3611, "title": "[#3608] Download datapoints", "bodyText": "Before the PR (what is the issue or what needed to be done)\n\nFrequent timeouts while downloading datapoints from the device\nNot all datapoints downloaded\n\nThe solution\n\nReduce the number of datapoints downloaded in a single batch to 30\nUse the cursor query parameter to enable selective/incremental downloading\n\nScreenshots (if appropriate)\nReviewer Checklist\n\n Added an explanation about the work done\n Connected the PR and the issue on Zenhub\n Added a test plan to the issue\n Updated the copyright header (when relevant)\n Formatted the code\n Added a documentation (if relevant)\n Added some unit tests (if relevant)", "createdAt": "2020-07-01T15:09:40Z", "url": "https://github.com/akvo/akvo-flow/pull/3611", "merged": true, "mergeCommit": {"oid": "5d7630808a663658f35194d32ce0f3d7d5486b47"}, "closed": true, "closedAt": "2020-07-07T15:28:41Z", "author": {"login": "muloem"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuz0EnAH2gAyNDQyNzY0MTYzOmM5ZjNjNTJjYWUyNzNlYzM4ZTA2MzE1NjBiYzI3MzdmNDQ4YjFjMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyneZuAFqTQ0Mzk5OTM1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9f3c52cae273ec38e0631560bc2737f448b1c21", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/c9f3c52cae273ec38e0631560bc2737f448b1c21", "committedDate": "2020-06-25T19:28:38Z", "message": "[#3608] Add utility method to SurveyAssignment DAO\n\n* Enable retrieval of survey assignments by filtering both on survey and device IDs\n* Remove ununsed utility method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ca2d562d96ad698e61289369e2c3d4d1bd20425", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/9ca2d562d96ad698e61289369e2c3d4d1bd20425", "committedDate": "2020-06-26T09:33:43Z", "message": "[#3608] Fix query parameter for SurveyAssignment entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fcf4914f88683856e0dfd75df5f13da792d35d9", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/4fcf4914f88683856e0dfd75df5f13da792d35d9", "committedDate": "2020-06-26T17:09:27Z", "message": "[#3608] Refactor existing datapoint retrieval logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/3f724fcc64df1ea1be564082af4c8595c70bd444", "committedDate": "2020-06-29T13:00:24Z", "message": "[#3608] Add support for lastUpdateTime query parameter\n\n* When retrieving datapoints on the device, we can now pass in the lastUpdateTime parameter to filter out which datapoints will be returned to the device.\n* We also limit the number of datapoints returned to 30. This means the device will have to repeatedly query the backend for datapoints using the lastUpdateTime parameter as a cursor\n* Also added corresponding test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzIzNTU0", "url": "https://github.com/akvo/akvo-flow/pull/3611#pullrequestreview-441323554", "createdAt": "2020-07-02T03:20:43Z", "commit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzoyMDo0M1rOGr8ETg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzo1MDozM1rOGr8egQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyNjA5NA==", "bodyText": "We're changing the status code from HTTP 404 to HTTP 403. If we don't find the device or the datapoint list is empty, we keep using HTTP 404. Why this case is different?", "url": "https://github.com/akvo/akvo-flow/pull/3611#discussion_r448726094", "createdAt": "2020-07-02T03:20:43Z", "author": {"login": "iperdomo"}, "path": "GAE/src/org/akvo/flow/api/app/DataPointServlet.java", "diffHunk": "@@ -77,63 +80,89 @@ protected RestRequest convertRequest() throws Exception {\n     protected RestResponse handleRequest(RestRequest req) throws Exception {\n         DataPointRequest dpReq = (DataPointRequest) req;\n         RestResponse res = new RestResponse();\n-        if (dpReq.getSurveyId() != null) {\n-            //Find the device (if any)\n-            DeviceDAO deviceDao = new DeviceDAO();\n-            Device device = deviceDao.getDevice(dpReq.getAndroidId(), null, null);\n-            if (device != null) {\n-                log.info(\"Found device id: \" + device.getKey().getId());\n-                log.fine(\"Found device: \" + device);\n-                List<SurveyedLocale> dpList = getDataPointList(dpReq.getSurveyId(), device.getKey().getId());\n-                if (dpList == null) {\n-                    res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-                    res.setMessage(\"No assignment was found\");\n-                    return res;\n-                }\n-                res = convertToResponse(dpList, dpReq.getSurveyId());\n-                return res;\n-            }\n-            res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-            res.setMessage(\"Unknown device\");\n-        } else {\n+        if (dpReq.getSurveyId() == null) {\n             res.setCode(String.valueOf(HttpServletResponse.SC_FORBIDDEN));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMjgwMQ==", "bodyText": "I don't think we should filter by lastUpdatedDateTime, but if we need to. We can create a few datapoints \"in the future\" directly instead of dealing with Thread.sleep ? \ud83e\udd14", "url": "https://github.com/akvo/akvo-flow/pull/3611#discussion_r448732801", "createdAt": "2020-07-02T03:50:33Z", "author": {"login": "iperdomo"}, "path": "GAE/test/org/akvo/flow/api/app/DataPointServletTest.java", "diffHunk": "@@ -219,6 +220,44 @@ public void noAssignmentTest() {\n         final Long surveyId = randomId();\n         final DataPointServlet servlet = new DataPointServlet();\n         final List<SurveyedLocale> foundDataPoints = servlet.getDataPointList(surveyId, randomId());\n-        assertNull(foundDataPoints);\n+        assertTrue(foundDataPoints.isEmpty());\n+    }\n+\n+    @Test\n+    public void testRetrieveDataPointsByLastUpdateTime() throws InterruptedException {\n+        final Long surveyId = randomId();\n+        final List<SurveyedLocale> oldDataPoints = createDataPoints(surveyId, 5);\n+        final Date lastUpdateTime = new Date();\n+        Thread.sleep(1500); // only datapoints created after this point should be retrieved", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d3e5cd3537f7a88b513bdc5df32bf323ee7f079", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/4d3e5cd3537f7a88b513bdc5df32bf323ee7f079", "committedDate": "2020-07-03T16:26:55Z", "message": "[#3608] Limit results returned by the datapoints endpoint to a max of 30\n\n* Modify the endpoint to return a maximum of 30 datapoints.  This applies to the old assignments setup where no datapoints were specifically assigned, and the new assignments setup where its possible to specify that all datapoints are assigned to a device\n\n* Add utility methods to the SurveyedLocaleDAO to retrieve datapoints based on a supplied cursor if its available\n\n* Remove broken tests that were using lastUpdateTime parameter when retrieving datapoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc6d566045a4f094825244ec307189ba3a53fa9", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/2dc6d566045a4f094825244ec307189ba3a53fa9", "committedDate": "2020-07-03T16:30:53Z", "message": "[#3608] Enable extended stack traces in unit testing output\n\n* By default the value is set to false.  If for some reason you would like to see the extended stack trace while testing you need to temporarily switch this to true."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaae5382f3a56e20218e6439659d19480823a9d0", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/eaae5382f3a56e20218e6439659d19480823a9d0", "committedDate": "2020-07-03T16:57:19Z", "message": "[#3608] Remove the `lastUpdateTime` parameter from datapoints endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4814a463cfe0e57092afe86471c0937449008c", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/cc4814a463cfe0e57092afe86471c0937449008c", "committedDate": "2020-07-07T14:10:26Z", "message": "[#3608] Return a cursor along with the datapoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzOTk5MzU4", "url": "https://github.com/akvo/akvo-flow/pull/3611#pullrequestreview-443999358", "createdAt": "2020-07-07T15:21:48Z", "commit": {"oid": "cc4814a463cfe0e57092afe86471c0937449008c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4533, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}