{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNzY0MTYz", "number": 3611, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzoyMDo0M1rOEKuwxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzo1MDozM1rOEKvCWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5Njg3MzY3OnYy", "diffSide": "RIGHT", "path": "GAE/src/org/akvo/flow/api/app/DataPointServlet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzoyMDo0M1rOGr8ETg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwODozMTo0MVrOGsC2lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyNjA5NA==", "bodyText": "We're changing the status code from HTTP 404 to HTTP 403. If we don't find the device or the datapoint list is empty, we keep using HTTP 404. Why this case is different?", "url": "https://github.com/akvo/akvo-flow/pull/3611#discussion_r448726094", "createdAt": "2020-07-02T03:20:43Z", "author": {"login": "iperdomo"}, "path": "GAE/src/org/akvo/flow/api/app/DataPointServlet.java", "diffHunk": "@@ -77,63 +80,89 @@ protected RestRequest convertRequest() throws Exception {\n     protected RestResponse handleRequest(RestRequest req) throws Exception {\n         DataPointRequest dpReq = (DataPointRequest) req;\n         RestResponse res = new RestResponse();\n-        if (dpReq.getSurveyId() != null) {\n-            //Find the device (if any)\n-            DeviceDAO deviceDao = new DeviceDAO();\n-            Device device = deviceDao.getDevice(dpReq.getAndroidId(), null, null);\n-            if (device != null) {\n-                log.info(\"Found device id: \" + device.getKey().getId());\n-                log.fine(\"Found device: \" + device);\n-                List<SurveyedLocale> dpList = getDataPointList(dpReq.getSurveyId(), device.getKey().getId());\n-                if (dpList == null) {\n-                    res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-                    res.setMessage(\"No assignment was found\");\n-                    return res;\n-                }\n-                res = convertToResponse(dpList, dpReq.getSurveyId());\n-                return res;\n-            }\n-            res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-            res.setMessage(\"Unknown device\");\n-        } else {\n+        if (dpReq.getSurveyId() == null) {\n             res.setCode(String.valueOf(HttpServletResponse.SC_FORBIDDEN));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgzNzI3MA==", "bodyText": "The 403 was always there in the else branch so I have just made it more explicit. I am not sure how the older versions process the returned status so I did not want to change it. Otherwise I actually wanted to return a 401 if there is no surveyId", "url": "https://github.com/akvo/akvo-flow/pull/3611#discussion_r448837270", "createdAt": "2020-07-02T08:31:41Z", "author": {"login": "muloem"}, "path": "GAE/src/org/akvo/flow/api/app/DataPointServlet.java", "diffHunk": "@@ -77,63 +80,89 @@ protected RestRequest convertRequest() throws Exception {\n     protected RestResponse handleRequest(RestRequest req) throws Exception {\n         DataPointRequest dpReq = (DataPointRequest) req;\n         RestResponse res = new RestResponse();\n-        if (dpReq.getSurveyId() != null) {\n-            //Find the device (if any)\n-            DeviceDAO deviceDao = new DeviceDAO();\n-            Device device = deviceDao.getDevice(dpReq.getAndroidId(), null, null);\n-            if (device != null) {\n-                log.info(\"Found device id: \" + device.getKey().getId());\n-                log.fine(\"Found device: \" + device);\n-                List<SurveyedLocale> dpList = getDataPointList(dpReq.getSurveyId(), device.getKey().getId());\n-                if (dpList == null) {\n-                    res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-                    res.setMessage(\"No assignment was found\");\n-                    return res;\n-                }\n-                res = convertToResponse(dpList, dpReq.getSurveyId());\n-                return res;\n-            }\n-            res.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));\n-            res.setMessage(\"Unknown device\");\n-        } else {\n+        if (dpReq.getSurveyId() == null) {\n             res.setCode(String.valueOf(HttpServletResponse.SC_FORBIDDEN));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyNjA5NA=="}, "originalCommit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjkxODY1OnYy", "diffSide": "RIGHT", "path": "GAE/test/org/akvo/flow/api/app/DataPointServletTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzo1MDozM1rOGr8egQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMzo1MDozM1rOGr8egQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczMjgwMQ==", "bodyText": "I don't think we should filter by lastUpdatedDateTime, but if we need to. We can create a few datapoints \"in the future\" directly instead of dealing with Thread.sleep ? \ud83e\udd14", "url": "https://github.com/akvo/akvo-flow/pull/3611#discussion_r448732801", "createdAt": "2020-07-02T03:50:33Z", "author": {"login": "iperdomo"}, "path": "GAE/test/org/akvo/flow/api/app/DataPointServletTest.java", "diffHunk": "@@ -219,6 +220,44 @@ public void noAssignmentTest() {\n         final Long surveyId = randomId();\n         final DataPointServlet servlet = new DataPointServlet();\n         final List<SurveyedLocale> foundDataPoints = servlet.getDataPointList(surveyId, randomId());\n-        assertNull(foundDataPoints);\n+        assertTrue(foundDataPoints.isEmpty());\n+    }\n+\n+    @Test\n+    public void testRetrieveDataPointsByLastUpdateTime() throws InterruptedException {\n+        final Long surveyId = randomId();\n+        final List<SurveyedLocale> oldDataPoints = createDataPoints(surveyId, 5);\n+        final Date lastUpdateTime = new Date();\n+        Thread.sleep(1500); // only datapoints created after this point should be retrieved", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f724fcc64df1ea1be564082af4c8595c70bd444"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4584, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}