{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTc2ODYx", "number": 3648, "title": "[#3645] Create new endpoints for the app to retrieve datapoints in smaller chunks", "bodyText": "Before the PR (what is the issue or what needed to be done)\n\nThe backend would Time out when there are lots of form instances associated with a specific data point\n\nThe solution\n\nSplit the retrieval of datapoints into smaller chunks. One endpoint returns only the datapoints and a second one returns all form instances (paginated) for a single datapoint.\n\nScreenshots (if appropriate)\nReviewer Checklist\n\n Added an explanation about the work done\n Connected the PR and the issue on Zenhub\n Added a test plan to the issue\n Updated the copyright header (when relevant)\n Formatted the code\n Added a documentation (if relevant)\n Added some unit tests (if relevant)", "createdAt": "2020-10-07T11:23:17Z", "url": "https://github.com/akvo/akvo-flow/pull/3648", "merged": true, "mergeCommit": {"oid": "e94172fcc645de1135d43ad810e0177bf9c45a83"}, "closed": true, "closedAt": "2020-10-07T11:37:13Z", "author": {"login": "muloem"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN7VssgH2gAyNDk5MTc2ODYxOjdmZmUzZmQ0YTNkYWQxMDJjNTBhZDQ0MjFkNDJkZTBmMjQ0YzZhMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQLZq0gFqTUwMzc4NTc4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7ffe3fd4a3dad102c50ad4421d42de0f244c6a03", "author": {"user": {"login": "kardan", "name": "Daniel Sunnerek"}}, "url": "https://github.com/akvo/akvo-flow/commit/7ffe3fd4a3dad102c50ad4421d42de0f244c6a03", "committedDate": "2020-09-30T11:46:21Z", "message": "[#3645] WIP new simple datapoint endpoint\n\nCo-authored-by: Juan A. Ruz <juanantonioruz@gmail.com>\nCo-authored-by: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36eaaf7dcf5524a60c027673a74b39d9184c6105", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/36eaaf7dcf5524a60c027673a74b39d9184c6105", "committedDate": "2020-10-01T11:07:31Z", "message": "[#3645] Increase the query limit for datapoints\n\n* The new servlet only returns datapoints without subentities like form instances or responses included.  We are thus able to return more entities in a single request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b87ec76a53242b541274e77b7c91978c54732f6", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/7b87ec76a53242b541274e77b7c91978c54732f6", "committedDate": "2020-10-02T10:03:42Z", "message": "[#3645] Refactor code - Extract common method to DataPointUtil\n\nCo-Authored-By: Juan A. Ruz <juanantonioruz@gmail.com>\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2990b7fcb9e071393ecacf2831c08bb3b2a49d1a", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/2990b7fcb9e071393ecacf2831c08bb3b2a49d1a", "committedDate": "2020-10-02T11:45:33Z", "message": "[#3645] Add FormInstanceUtil and DataUtil test support\n\nCo-Authored-By: Ivan Perdomo <ivan@akvo.org>\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ba65efd9f3aacfcf1f8e0d2482675d26e6aad91", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/6ba65efd9f3aacfcf1f8e0d2482675d26e6aad91", "committedDate": "2020-10-02T12:02:44Z", "message": "[#3645] Fix test and implementation of FormInstanceUtil\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45b8ad65737e17dd0e9f29ffe176de3cd78ffb7", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/e45b8ad65737e17dd0e9f29ffe176de3cd78ffb7", "committedDate": "2020-10-02T12:06:25Z", "message": "[#3645] Optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c737d4ea782a05fb9035a05d84afb35fbb8b83e", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/3c737d4ea782a05fb9035a05d84afb35fbb8b83e", "committedDate": "2020-10-02T12:11:54Z", "message": "[#3645] Update copyright headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59e144ac2dbb46eb6e9a688e06d4a26adee7b55b", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/59e144ac2dbb46eb6e9a688e06d4a26adee7b55b", "committedDate": "2020-10-02T13:06:16Z", "message": "[#3645] Rename test methods, adds a new test\n\n* Test that we're filtering data by \"Assignment\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497b43931ff685a8fce912cb4a61320414d380c8", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/497b43931ff685a8fce912cb4a61320414d380c8", "committedDate": "2020-10-05T10:24:17Z", "message": "[#3645] Use more direct assertion and rename variable to clarify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3812b5357be307796b4cb75339f1b484fed1cc9b", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/3812b5357be307796b4cb75339f1b484fed1cc9b", "committedDate": "2020-10-05T12:50:04Z", "message": "[#3645]Refactor and rename DataPointServlet2 to DataPointOnlyServlet\n\nRemoving redundant check for SurveyAssignments without\nDataPointAssignment #3511 ensures that all SurveyAssignments have the\ncorrespondent datapoint assignment\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abf27612e04cac742a9ccb87da2cf10f9812e1cd", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/abf27612e04cac742a9ccb87da2cf10f9812e1cd", "committedDate": "2020-10-05T12:59:57Z", "message": "[#3645] Renaming DataPointServletTest > DataPointUtilTest and\n\nDataUtil > DataStoreTestUtil\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60134ccd05df4163e9db6e3735d06dd328848fdb", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/60134ccd05df4163e9db6e3735d06dd328848fdb", "committedDate": "2020-10-05T13:11:16Z", "message": "[#3645] Add explicit limit in DataPointUtil.getAssignedDataPoints\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10fe4fb7e2b9ba749f37150e1c9aad9d61f9cfad", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/10fe4fb7e2b9ba749f37150e1c9aad9d61f9cfad", "committedDate": "2020-10-06T08:39:37Z", "message": "[#3645] Add explicit pageSize to FormInstanceUtil/getFormInstances\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5801c6ba3b796ab43a7ddb2dcc61414fa84df74", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/e5801c6ba3b796ab43a7ddb2dcc61414fa84df74", "committedDate": "2020-10-06T10:16:15Z", "message": "[#3645] Remove o.w.m.a.w.dto.QasDto o.w.m.a.w.dto.SurveyInstanceDto\n\nAnd use o.w.m.a.g.c.surveyinstance.SurveyInstanceDto instead\n\nCo-Authored-By: Emmanuel Mulo <emmanuel@akvo.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb3bf689772d59fc9a20d2a3dcb0792de443df35", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/bb3bf689772d59fc9a20d2a3dcb0792de443df35", "committedDate": "2020-10-06T11:38:33Z", "message": "[#3645] Add test for date serialization format\n\nCo-Authored-By: Juan A. Ruz <juanantonioruz@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ce7fd016c8f70131c31df88a5d9096f38c9cd74", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/3ce7fd016c8f70131c31df88a5d9096f38c9cd74", "committedDate": "2020-10-06T12:40:47Z", "message": "[#3654] Add new servlet action to retrieve the list of form instances\n\n* The form instances are not yet fully populated with the responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51cd4b932c081f63ff83358bfb768f61b22a18a0", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/51cd4b932c081f63ff83358bfb768f61b22a18a0", "committedDate": "2020-10-06T14:42:53Z", "message": "[#3654] Implement formInstanceUtil.getFormInstancesDtoList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7565e8a8767dab17722e4c9cbaa526953098159f", "author": {"user": {"login": "tangrammer", "name": "Juan A. Ruz"}}, "url": "https://github.com/akvo/akvo-flow/commit/7565e8a8767dab17722e4c9cbaa526953098159f", "committedDate": "2020-10-06T15:42:33Z", "message": "[#3645] Test formInstanceUtil.getFormInstancesDtoList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24048a1c705400a2f90f11086159b9657d06919e", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/24048a1c705400a2f90f11086159b9657d06919e", "committedDate": "2020-10-07T04:10:47Z", "message": "[#3645] Modify FormInstanceUtilTest\n\n* Compare the input form instances with the out put DTO list\n* Use a more realistic question"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99378e3c6258ff946d4b684a6a2d5b5db1372ffa", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/99378e3c6258ff946d4b684a6a2d5b5db1372ffa", "committedDate": "2020-10-07T04:18:22Z", "message": "[#3654] Update copyright notice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2ef674343172fa0d0e1f621680e5301bc78eb1", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/de2ef674343172fa0d0e1f621680e5301bc78eb1", "committedDate": "2020-10-07T09:46:04Z", "message": "[#3654] Use datapoint identifier parameter for retrieving form instance\n\nCo-Authored-By: Juan A. Ruz <juanantonioruz@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "593d27410012040277154fc830d0db45b7562797", "author": {"user": {"login": "muloem", "name": "Emmanuel Mulo"}}, "url": "https://github.com/akvo/akvo-flow/commit/593d27410012040277154fc830d0db45b7562797", "committedDate": "2020-10-07T11:15:49Z", "message": "[#3645] Include exception logging and response for error conditions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzgxMzgx", "url": "https://github.com/akvo/akvo-flow/pull/3648#pullrequestreview-503781381", "createdAt": "2020-10-07T11:30:31Z", "commit": {"oid": "593d27410012040277154fc830d0db45b7562797"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTozMDozMlrOHdu1uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTozMDozMlrOHdu1uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzODE3MQ==", "bodyText": "not sure if every exception is a not found exception \ud83e\udd14 ... maybe we need a couple of specific exceptions to know which kind was thrown (eg: DeviceNotFoundException) from the formInstanceUtil", "url": "https://github.com/akvo/akvo-flow/pull/3648#discussion_r500938171", "createdAt": "2020-10-07T11:30:32Z", "author": {"login": "tangrammer"}, "path": "GAE/src/org/waterforpeople/mapping/app/web/SurveyInstanceServlet.java", "diffHunk": "@@ -85,14 +90,21 @@ protected RestResponse handleRequest(RestRequest req) throws Exception {\n         if (GET_INSTANCE_DATA_ACTION.equals(siReq.getAction())) {\n             return retrieveInstanceData(siReq.surveyInstanceId);\n         } else  if (GET_FORM_INSTANCES_ACTION.equals(siReq.getAction())) {\n-            FormInstanceUtil formInstanceUtil = new FormInstanceUtil();\n-            List<SurveyInstance> formInstances = formInstanceUtil.getFormInstances(siReq.getAndroidId(), siReq.getDataPointIdentifier(), LIMIT_FORM_INSTANCES_30, siReq.getCursor());\n-\n             FormInstanceResponse response = new FormInstanceResponse();\n-            response.setSurveyInstances(formInstanceUtil.getFormInstancesDtoList(formInstances));\n-            response.setCursor(BaseDAO.getCursor(formInstances));\n-            response.setResultCount(formInstances.size());\n+            FormInstanceUtil formInstanceUtil = new FormInstanceUtil();\n \n+            try {\n+                List<SurveyInstance> formInstances = formInstanceUtil.getFormInstances(siReq.getAndroidId(), siReq.getDataPointIdentifier(), LIMIT_FORM_INSTANCES_30, siReq.getCursor());\n+                response.setSurveyInstances(formInstanceUtil.getFormInstancesDtoList(formInstances));\n+                response.setCursor(BaseDAO.getCursor(formInstances));\n+                response.setResultCount(formInstances.size());\n+\n+                return response;\n+            } catch (Exception e) {\n+                log.warning(\"Exception accessing endpoint: \" + e.getMessage());\n+                response.setCode(String.valueOf(HttpServletResponse.SC_NOT_FOUND));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593d27410012040277154fc830d0db45b7562797"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzgyODI0", "url": "https://github.com/akvo/akvo-flow/pull/3648#pullrequestreview-503782824", "createdAt": "2020-10-07T11:32:34Z", "commit": {"oid": "593d27410012040277154fc830d0db45b7562797"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTozMjozNFrOHdu6Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTozMjozNFrOHdu6Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzOTI4Mw==", "bodyText": "We're not using this class. Let's remove the import.", "url": "https://github.com/akvo/akvo-flow/pull/3648#discussion_r500939283", "createdAt": "2020-10-07T11:32:34Z", "author": {"login": "iperdomo"}, "path": "GAE/src/org/waterforpeople/mapping/app/web/SurveyInstanceServlet.java", "diffHunk": "@@ -18,14 +18,17 @@\n \n import java.util.ArrayList;\n import java.util.List;\n+import java.util.logging.Logger;\n \n import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n \n import com.gallatinsystems.framework.dao.BaseDAO;\n import org.akvo.flow.api.app.FormInstanceResponse;\n import org.akvo.flow.api.app.FormInstanceUtil;\n import org.akvo.flow.util.FlowJsonObjectWriter;\n import org.springframework.beans.BeanUtils;\n+import org.springframework.http.HttpStatus;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593d27410012040277154fc830d0db45b7562797"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67a390dadbe7a13a5c266e6719125917eec171f5", "author": {"user": {"login": "iperdomo", "name": "Iv\u00e1n Perdomo"}}, "url": "https://github.com/akvo/akvo-flow/commit/67a390dadbe7a13a5c266e6719125917eec171f5", "committedDate": "2020-10-07T11:33:21Z", "message": "[#3645] Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzg1Nzgz", "url": "https://github.com/akvo/akvo-flow/pull/3648#pullrequestreview-503785783", "createdAt": "2020-10-07T11:37:01Z", "commit": {"oid": "67a390dadbe7a13a5c266e6719125917eec171f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4545, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}