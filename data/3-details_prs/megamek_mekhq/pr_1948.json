{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjQwODg3", "number": 1948, "title": "fix refits involving ammo-based weapons", "bodyText": "Took a while, but this fixes an observed and reported issue where units being customized would not begin refit once all parts had arrived. Turns out that the \"is there enough of the right type of ammo present\" check wasn't working (it would attempt to load an ammo bin, and the call would immediately fail because the bin wasn't attached to a unit yet).", "createdAt": "2020-08-20T03:55:47Z", "url": "https://github.com/MegaMek/mekhq/pull/1948", "merged": true, "mergeCommit": {"oid": "7d70531f2e7c519eba49cd836755e8fa5f1f08cd"}, "closed": true, "closedAt": "2020-08-20T18:18:28Z", "author": {"login": "NickAragua"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAn9zHAH2gAyNDcwNjQwODg3Ojc2ODRjMTU2YjY5NTZhOGI3NmQ2NTczNmNjZGZmNjcxYzdlNzdhODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA0VcJgH2gAyNDcwNjQwODg3OjgxNTljMjQ1YjRjZWViNDJmODhhZGFmMGVlYTVlOWNmYWMxMWUwOGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7684c156b6956a8b76d65736ccdff671c7e77a82", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/7684c156b6956a8b76d65736ccdff671c7e77a82", "committedDate": "2020-08-20T03:51:02Z", "message": "fix refits involving ammo-based weapons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/88756b3d1ccfd7f9984193f9069787e14ed60a3b", "committedDate": "2020-08-20T03:54:00Z", "message": "formatting fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTI4MDUw", "url": "https://github.com/MegaMek/mekhq/pull/1948#pullrequestreview-471528050", "createdAt": "2020-08-20T12:07:57Z", "commit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTQwMDgw", "url": "https://github.com/MegaMek/mekhq/pull/1948#pullrequestreview-471540080", "createdAt": "2020-08-20T12:22:23Z", "commit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMjoyMjoyM1rOHD-Trg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMjoyMzoxN1rOHD-ViQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyODYyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            && curType.getMunitionType() == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType();\n          \n          \n            \n                            && curType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();", "url": "https://github.com/MegaMek/mekhq/pull/1948#discussion_r473928622", "createdAt": "2020-08-20T12:22:23Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -286,13 +286,20 @@ public String failToFind() {\n         return \"<font color='red'><b> part not found</b>.</font>\";\n     }\n \n-    public void changeAmountAvailable(int amount, final AmmoType curType) {\n-        final long curMunition = curType.getMunitionType();\n-        AmmoStorage a = (AmmoStorage)campaign.findSparePart(part -> {\n-            return part instanceof AmmoStorage\n+    /**\n+     * Boolean function that determines if the given part is of the correct ammo. \n+     * Useful as a predicate for campaign.findSparePart()\n+     */\n+    public static boolean IsRightAmmo(Part part, AmmoType curType) {\n+        return part instanceof AmmoStorage\n                 && part.isPresent()\n                 && ((AmmoType)((AmmoStorage)part).getType()).equals(curType)\n-                && curMunition == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType();\n+                && curType.getMunitionType() == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyODcyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    AmmoStorage a = (AmmoStorage)campaign.findSparePart(part -> {\n          \n          \n            \n                    AmmoStorage a = (AmmoStorage) campaign.findSparePart(part -> {", "url": "https://github.com/MegaMek/mekhq/pull/1948#discussion_r473928724", "createdAt": "2020-08-20T12:22:34Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -286,13 +286,20 @@ public String failToFind() {\n         return \"<font color='red'><b> part not found</b>.</font>\";\n     }\n \n-    public void changeAmountAvailable(int amount, final AmmoType curType) {\n-        final long curMunition = curType.getMunitionType();\n-        AmmoStorage a = (AmmoStorage)campaign.findSparePart(part -> {\n-            return part instanceof AmmoStorage\n+    /**\n+     * Boolean function that determines if the given part is of the correct ammo. \n+     * Useful as a predicate for campaign.findSparePart()\n+     */\n+    public static boolean IsRightAmmo(Part part, AmmoType curType) {\n+        return part instanceof AmmoStorage\n                 && part.isPresent()\n                 && ((AmmoType)((AmmoStorage)part).getType()).equals(curType)\n-                && curMunition == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType();\n+                && curType.getMunitionType() == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType();\n+    }\n+    \n+    public void changeAmountAvailable(int amount, final AmmoType curType) {\n+        AmmoStorage a = (AmmoStorage)campaign.findSparePart(part -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyOTA5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (foundAmmo == null || (((AmmoStorage) foundAmmo).getShots() < bin.getShotsNeeded())) {\n          \n          \n            \n                            if ((foundAmmo == null) || (((AmmoStorage) foundAmmo).getShots() < bin.getShotsNeeded())) {", "url": "https://github.com/MegaMek/mekhq/pull/1948#discussion_r473929097", "createdAt": "2020-08-20T12:23:17Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1168,15 +1169,20 @@ public boolean acquireParts() {\n                 }\n             }\n         }\n-        // Cycle through newUnitParts, find any ammo bins and if they need loading, try to load them\n+        \n+        // Cycle through newUnitParts, find any ammo bins and see if we have the ammo to load them\n         boolean missingAmmo = false;\n-        for(int pid : newUnitParts) {\n-            Part part = oldUnit.getCampaign().getPart(pid);\n-            if(part instanceof AmmoBin && null == part.getUnit()) {\n-                AmmoBin bin = (AmmoBin)part;\n-                bin.loadBin();\n-                if(bin.needsFixing()) {\n+        for (int pid : newUnitParts) {\n+            Part part = getCampaign().getPart(pid);\n+            \n+            if (part instanceof AmmoBin) {\n+                AmmoBin bin = (AmmoBin) part;\n+                Part foundAmmo = getCampaign().findSparePart(campaignPart -> AmmoStorage.IsRightAmmo(campaignPart, (AmmoType) bin.getType()));\n+\n+                if (foundAmmo == null || (((AmmoStorage) foundAmmo).getShots() < bin.getShotsNeeded())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88756b3d1ccfd7f9984193f9069787e14ed60a3b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8159c245b4ceeb42f88adaf0eea5e9cfac11e08b", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/8159c245b4ceeb42f88adaf0eea5e9cfac11e08b", "committedDate": "2020-08-20T18:15:43Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4176, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}