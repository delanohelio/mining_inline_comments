{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NDk4ODE1", "number": 2088, "title": "Switch to strong references instead of IDs for child parts", "bodyText": "I have never reliably reproduced the issues seen with child parts (such as bay doors, etc), but have always disliked our usage of IDs instead of strong references. MekHQ plays loose with IDs in order to aggregate spare parts and I'm not confident it isn't a cause of these problems.\nI'm only confident this will resolve the class of errors where the part ID changed but the child part IDs were not updated.", "createdAt": "2020-10-01T19:32:26Z", "url": "https://github.com/MegaMek/mekhq/pull/2088", "merged": true, "mergeCommit": {"oid": "032d9175419685163f2a114f0462e385ed9802a5"}, "closed": true, "closedAt": "2020-10-02T19:25:01Z", "author": {"login": "sixlettervariables"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOWishgH2gAyNDk2NDk4ODE1OjA4YWI3MmY5NGFjYjdiNjI5Njk0OGM1NjNiZjU1ZWQ5OWEzMmI0NGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOqattAH2gAyNDk2NDk4ODE1OjVmZjdlNzljYjA3ZGIyNWE1OTQ0YTQ0NzEyNjA4YzQyMTNkNzAxZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/08ab72f94acb7b6296948c563bf55ed99a32b44c", "committedDate": "2020-10-01T19:27:59Z", "message": "Switch to strong references instead of IDs for child parts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjU5MDA0", "url": "https://github.com/MegaMek/mekhq/pull/2088#pullrequestreview-500659004", "createdAt": "2020-10-01T19:35:35Z", "commit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTozNTozNVrOHbYR2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDoyOVrOHbYiFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTM4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tfor(Part p : bestPart.getChildParts()) {\n          \n          \n            \n            \t\t\t\t\tfor (Part p : bestPart.getChildParts()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498471386", "createdAt": "2020-10-01T19:35:35Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -332,25 +329,19 @@ public Part findReplacement(boolean refit) {\n \t\t\t\t\tint currentPartArmor = 0;\n \t\t\t\t\tint bestPartQuantity = 0;\n \t\t\t\t\tint currentPartQuantity = 0;\n-\t\t\t\t\tfor(int childId : bestPart.childPartIds) {\n-\t\t\t\t\t\tPart p = campaign.getPart(childId);\n-\t\t\t\t\t\tif(p != null) {\n-\t\t\t\t\t\t\tif(p instanceof BaArmor) {\n-\t\t\t\t\t\t\t\tbestPartArmor = ((BaArmor)p).getAmount();\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tbestPartQuantity++;\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n+\t\t\t\t\tfor(Part p : bestPart.getChildParts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MTU1Mg==", "bodyText": "This looks odd, likely tab vs space issues", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498471552", "createdAt": "2020-10-01T19:36:02Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -253,14 +251,13 @@ public void fix() {\n                 }\n                 missingStuff.add(missingBaEquip);\n             }\n-            for(int childId : replacement.getChildPartIds()) {\n-        \t\tPart childPart = campaign.getPart(childId);\n-        \t\tif(childPart instanceof BaArmor && null != origArmor) {\n+            for (Part childPart : replacement.getChildParts()) {\n+        \t\tif (childPart instanceof BaArmor && null != origArmor) {\n         \t\t\tunit.getEntity().setArmor(((BaArmor)childPart).getAmount(), trooper);\n         \t\t\torigArmor.updateConditionFromEntity(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3Mjk1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Part p : getChildParts()) {\n          \n          \n            \n                    for (Part p : getChildParts()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498472952", "createdAt": "2020-10-01T19:38:50Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -267,14 +267,11 @@ public Money getStickerPrice() {\n             cost = cost.plus(50000 * (jumpMP + 1));\n         }\n         cost = cost.plus(25000 * (groundMP-1));\n-        for(int childId : getChildPartIds()) {\n-            Part p = campaign.getPart(childId);\n-            if(null != p) {\n-                if(p instanceof BaArmor) {\n-                    cost = cost.plus(p.getCurrentValue());\n-                } else if (!(p instanceof BattleArmorSuit)) {\n-                    cost = cost.plus(p.getStickerPrice());\n-                }\n+        for(Part p : getChildParts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzAzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473032", "createdAt": "2020-10-01T19:39:02Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -234,7 +234,7 @@ else if(jumpType == EntityMovementMode.VTOL) {\n     public Money getStickerPrice() {\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded alternate costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzE1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Part p : getChildParts()) {\n          \n          \n            \n                    for (Part p : getChildParts()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473154", "createdAt": "2020-10-01T19:39:19Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -218,12 +219,11 @@ else if(jumpType == EntityMovementMode.VTOL) {\n         }\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded extra costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {\n             tons += alternateTon;\n         }\n-        for(int childId : getChildPartIds()) {\n-            Part p = campaign.getPart(childId);\n-            if(null != p && !(p instanceof BattleArmorSuit)) {\n+        for(Part p : getChildParts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzIyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473223", "createdAt": "2020-10-01T19:39:27Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -218,12 +219,11 @@ else if(jumpType == EntityMovementMode.VTOL) {\n         }\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded extra costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzI3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(null == unit && getChildParts().isEmpty()) {\n          \n          \n            \n                    if ((null == unit) && getChildParts().isEmpty()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473271", "createdAt": "2020-10-01T19:39:36Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/BattleArmorSuit.java", "diffHunk": "@@ -139,7 +140,7 @@ public void setTrooper(int i) {\n     public double getTonnage() {\n         //if there are no linked parts and the unit is null,\n         //then use the pre-recorded alternate costs\n-        if(null == unit && getChildPartIds().size()==0) {\n+        if(null == unit && getChildParts().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3MzkyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (null == p.getUnit() && !p.hasParentPart()) {\n          \n          \n            \n                    if ((null == p.getUnit()) && !p.hasParentPart()) {", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498473920", "createdAt": "2020-10-01T19:40:50Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1634,7 +1634,7 @@ public void addPart(Part p, int transitDays) {\n             p.setId(-1);\n             return;\n         }\n-        if (null == p.getUnit()) {\n+        if (null == p.getUnit() && !p.hasParentPart()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTIxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    /**\n          \n          \n            \n                     *\n          \n          \n            \n                     */\n          \n          \n            \n                    private static final long serialVersionUID = 1L;\n          \n          \n            \n                    private static final long serialVersionUID = 1L;", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475210", "createdAt": "2020-10-01T19:43:45Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {\n+        /**\n+         *\n+         */\n+        private static final long serialVersionUID = 1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTMzNQ==", "bodyText": "Why 1L instead of an actual serialVersionUID?", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475335", "createdAt": "2020-10-01T19:44:02Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {\n+        /**\n+         *\n+         */\n+        private static final long serialVersionUID = 1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTU0Mw==", "bodyText": "Please clear out the TODOs unless they are useful.", "url": "https://github.com/MegaMek/mekhq/pull/2088#discussion_r498475543", "createdAt": "2020-10-01T19:44:29Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1775,4 +1761,144 @@ public SimpleTechLevel getStaticTechLevel() {\n         }\n         return getTechAdvancement().getStaticTechLevel();\n     }\n+\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (parentPart instanceof PartRef) {\n+            int id = parentPart.getId();\n+            parentPart = knownParts.get(id);\n+            if (parentPart == null) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing parent part %d\",\n+                        getId(), getName(), id));\n+            }\n+        }\n+\n+        for (int ii = childParts.size() - 1; ii >= 0; --ii) {\n+            Part childPart = childParts.get(ii);\n+            if (childPart instanceof PartRef) {\n+                Part realPart = knownParts.get(childPart.getId());\n+                if (realPart != null) {\n+                    childParts.set(ii, realPart);\n+                } else {\n+                    MekHQ.getLogger().error(PartRef.class,\n+                        String.format(\"Part %d ('%s') references missing child part %d\",\n+                            getId(), getName(), id));\n+                    childParts.remove(ii);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class PartRef extends Part {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08ab72f94acb7b6296948c563bf55ed99a32b44c"}, "originalPosition": 196}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7abe6d435e1e53e871244714277f841d8d5d7e6e", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/7abe6d435e1e53e871244714277f841d8d5d7e6e", "committedDate": "2020-10-01T19:56:51Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b14ab027dd7a235b0ca3d0fe8d056b0318829f35", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/b14ab027dd7a235b0ca3d0fe8d056b0318829f35", "committedDate": "2020-10-01T20:04:08Z", "message": "Switch from tabs to spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c121e2a6b5c43c22681995832f6a44e882f216", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/c8c121e2a6b5c43c22681995832f6a44e882f216", "committedDate": "2020-10-01T20:05:05Z", "message": "Remove unnecessary comments from Part.PartRef"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjgyMDg0", "url": "https://github.com/MegaMek/mekhq/pull/2088#pullrequestreview-500682084", "createdAt": "2020-10-01T20:10:44Z", "commit": {"oid": "c8c121e2a6b5c43c22681995832f6a44e882f216"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ff7e79cb07db25a5944a44712608c4213d701dc", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/5ff7e79cb07db25a5944a44712608c4213d701dc", "committedDate": "2020-10-02T18:37:22Z", "message": "Don't log a missing part if it wasn't missing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3968, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}