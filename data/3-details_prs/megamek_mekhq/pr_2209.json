{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MTYwNTA2", "number": 2209, "title": "Random Portrait Generator", "bodyText": "This PR moves the portrait generation code out of campaign and into a random portrait generator.", "createdAt": "2020-11-07T16:32:43Z", "url": "https://github.com/MegaMek/mekhq/pull/2209", "merged": true, "mergeCommit": {"oid": "76f57ccbde3ae98e58e5264c5d06be29b03ce3af"}, "closed": true, "closedAt": "2020-11-07T20:16:08Z", "author": {"login": "Windchild292"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaNd3NgH2gAyNTE3MTYwNTA2OmYyNDZlZTIwODUyNjJmZTcxM2E5ZjI0YjNlYWY2ZTdhZGIxNDJlNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdaRYC7gFqTUyNTY3ODczNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f246ee2085262fe713a9f24b3eaf6e7adb142e41", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/f246ee2085262fe713a9f24b3eaf6e7adb142e41", "committedDate": "2020-11-07T15:40:39Z", "message": "Moving portrait generation code into a random portrait generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c5148c01c2c7c9bc958abf852c64622e85ead1b", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/5c5148c01c2c7c9bc958abf852c64622e85ead1b", "committedDate": "2020-11-07T15:47:36Z", "message": "Fixing error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjY3NTY0", "url": "https://github.com/MegaMek/mekhq/pull/2209#pullrequestreview-525667564", "createdAt": "2020-11-07T17:21:02Z", "commit": {"oid": "5c5148c01c2c7c9bc958abf852c64622e85ead1b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxNzoyMTowMlrOHvJWww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxNzoyMTowMlrOHvJWww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE5ODQwMw==", "bodyText": "Existing Portraits should be a Set to avoid bad runtimes on large campaigns.", "url": "https://github.com/MegaMek/mekhq/pull/2209#discussion_r519198403", "createdAt": "2020-11-07T17:21:02Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/personnel/generator/RandomPortraitGenerator.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright (c) 2020 - The MegaMek Team. All Rights Reserved.\n+ *\n+ * This file is part of MekHQ.\n+ *\n+ * MekHQ is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * MekHQ is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with MekHQ. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package mekhq.campaign.personnel.generator;\n+\n+import megamek.common.Compute;\n+import megamek.common.icons.AbstractIcon;\n+import megamek.common.icons.Portrait;\n+import mekhq.MHQStaticDirectoryManager;\n+import mekhq.MekHQ;\n+import mekhq.campaign.personnel.Person;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+public class RandomPortraitGenerator {\n+    private RandomPortraitGenerator() {\n+\n+    }\n+\n+    /**\n+     * This generates a unique Portrait based on the supplied {@link Person}\n+     *\n+     * @param personnel a list of all personnel, from which existing portraits are determined\n+     * @param p the {@link Person} to generate a unique portrait for\n+     * @return the generated portrait\n+     */\n+    public static AbstractIcon generate(Collection<Person> personnel, Person p) {\n+        // first create a list of existing portrait strings, so we can check for\n+        // duplicates\n+        List<String> existingPortraits = new ArrayList<>();\n+        for (Person existingPerson : personnel) {\n+            existingPortraits.add(existingPerson.getPortraitCategory() + \":\"\n+                    + existingPerson.getPortraitFileName());\n+        }\n+\n+        List<String> possiblePortraits;\n+\n+        // Will search for portraits in the /gender/primaryrole folder first,\n+        // and if none are found then /gender/rolegroup, then /gender/combat or\n+        // /gender/support, then in /gender.\n+        File genderFile = new File(p.getGender().isFemale() ? \"Female\" : \"Male\");\n+        File searchFile = new File(genderFile, Person.getRoleDesc(p.getPrimaryRole(), p.isClanner()));\n+\n+        possiblePortraits = getPossibleRandomPortraits(existingPortraits, searchFile);\n+\n+        if (possiblePortraits.isEmpty()) {\n+            String searchCat_RoleGroup = \"\";\n+            if (p.isAdminPrimary()) {\n+                searchCat_RoleGroup = \"Admin\";\n+            } else if (p.getPrimaryRole() == Person.T_SPACE_CREW\n+                    || p.getPrimaryRole() == Person.T_SPACE_GUNNER\n+                    || p.getPrimaryRole() == Person.T_SPACE_PILOT\n+                    || p.getPrimaryRole() == Person.T_NAVIGATOR) {\n+                searchCat_RoleGroup = \"Vessel Crew\";\n+            } else if (p.isTechPrimary()) {\n+                searchCat_RoleGroup = \"Tech\";\n+            } else if (p.getPrimaryRole() == Person.T_MEDIC\n+                    || p.getPrimaryRole() == Person.T_DOCTOR) {\n+                searchCat_RoleGroup = \"Medical\";\n+            }\n+\n+            // TODO : Java 11 : Swap to isBlank\n+            if (!searchCat_RoleGroup.trim().isEmpty()) {\n+                searchFile = new File(genderFile, searchCat_RoleGroup);\n+                possiblePortraits = getPossibleRandomPortraits(existingPortraits, searchFile);\n+            }\n+        }\n+\n+        if (possiblePortraits.isEmpty()) {\n+            searchFile = new File(genderFile, p.hasPrimaryCombatRole() ? \"Combat\" : \"Support\");\n+            possiblePortraits = getPossibleRandomPortraits(existingPortraits, searchFile);\n+        }\n+\n+        if (possiblePortraits.isEmpty()) {\n+            possiblePortraits = getPossibleRandomPortraits(existingPortraits, genderFile);\n+        }\n+\n+        if (!possiblePortraits.isEmpty()) {\n+            String chosenPortrait = possiblePortraits.get(Compute.randomInt(possiblePortraits.size()));\n+            String[] temp = chosenPortrait.split(\":\");\n+            if (temp.length == 2) {\n+                return new Portrait(temp[0], temp[1]);\n+            } else {\n+                MekHQ.getLogger().error(\"Failed to generate portrait for \" + p.getFullTitle() + \". \"\n+                        + chosenPortrait + \" does not split into an array of length 2.\");\n+            }\n+        } else {\n+            MekHQ.getLogger().warning(\"Failed to generate portrait for \" + p.getFullTitle()\n+                    + \". No possible portraits found.\");\n+        }\n+\n+        return new Portrait();\n+    }\n+\n+    /**\n+     * This is a helper method that determines what possible unassigned portraits can be generated\n+     * based on the supplied subdirectory\n+     *\n+     * @param existingPortraits the list of existing portraits that have already been assigned\n+     * @param subDir the subdirectory to search\n+     * @return a list of all possible unassigned random portraits\n+     */\n+    private static List<String> getPossibleRandomPortraits(List<String> existingPortraits, File subDir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5148c01c2c7c9bc958abf852c64622e85ead1b"}, "originalPosition": 122}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c7c4db77053a1ed291f71fef7c19328aedf36f5", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/4c7c4db77053a1ed291f71fef7c19328aedf36f5", "committedDate": "2020-11-07T17:57:44Z", "message": "Swapping existing portraits to a hashset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Njc4NzM0", "url": "https://github.com/MegaMek/mekhq/pull/2209#pullrequestreview-525678734", "createdAt": "2020-11-07T20:13:56Z", "commit": {"oid": "4c7c4db77053a1ed291f71fef7c19328aedf36f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4122, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}