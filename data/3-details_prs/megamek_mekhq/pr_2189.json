{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NjQ4OTc5", "number": 2189, "title": "Adds a Quartermaster class to manage machines and materiel", "bodyText": "Does what it says, centralizing adding, arriving, buying, etc. Slims down Campaign a lot, and enables us to slim down Part::fix and Part::remove in a future PR.\nAs always, lots of new tests.", "createdAt": "2020-11-04T21:26:11Z", "url": "https://github.com/MegaMek/mekhq/pull/2189", "merged": true, "mergeCommit": {"oid": "de7f670c923d066a54f7d58f7dbc523f6014ed4e"}, "closed": true, "closedAt": "2020-11-08T19:30:24Z", "author": {"login": "sixlettervariables"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZUfErgH2gAyNTE1NjQ4OTc5OjBjYmU4MzZmOWU4MDdmYWY0Y2JlZjFkMzkxYjFjZTNhZDBlODY1ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdak9T6gFqTUyNTgzNTU5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0cbe836f9e807faf4cbef1d391b1ce3ad0e865d1", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/0cbe836f9e807faf4cbef1d391b1ce3ad0e865d1", "committedDate": "2020-11-04T21:17:23Z", "message": "Add Quartermaster to manage machines and materiel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44c6ff970456f95ac4d79046ed61eba6dcebeffb", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/44c6ff970456f95ac4d79046ed61eba6dcebeffb", "committedDate": "2020-11-04T21:17:23Z", "message": "Add tests for addPart and arrivePart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8cdc872b4e095761c6650b66cd084d5b4543b15", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/b8cdc872b4e095761c6650b66cd084d5b4543b15", "committedDate": "2020-11-04T21:17:23Z", "message": "Add tests for buyUnit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeb9815df83d78e213918204b3b22b1c582d4e05", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/aeb9815df83d78e213918204b3b22b1c582d4e05", "committedDate": "2020-11-04T21:17:24Z", "message": "Add sellUnit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4ca1e44b92c87881a0c7bef23af9588fdcdd35e", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/d4ca1e44b92c87881a0c7bef23af9588fdcdd35e", "committedDate": "2020-11-04T21:17:24Z", "message": "Add tests for buyPart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "638961dc85ff6b341e1e08c07de65a6255c37e1f", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/638961dc85ff6b341e1e08c07de65a6255c37e1f", "committedDate": "2020-11-04T21:17:24Z", "message": "Add tests for buyRefurbishment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad48edf33535d6701d4206e2427d34e761973136", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/ad48edf33535d6701d4206e2427d34e761973136", "committedDate": "2020-11-04T21:17:25Z", "message": "Fix broken unit tests for Quartermaster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f8fff83d2c161281b9cab4934409b7bc5ae3c5", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/11f8fff83d2c161281b9cab4934409b7bc5ae3c5", "committedDate": "2020-11-04T21:24:06Z", "message": "Fix whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f63e0ed33bdaa979b2552791bfaf7a3829cdfcb5", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/f63e0ed33bdaa979b2552791bfaf7a3829cdfcb5", "committedDate": "2020-11-05T02:13:50Z", "message": "Fix LGTM nit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac845141711b011c7a68e6af3a18f06b83a59e75", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/ac845141711b011c7a68e6af3a18f06b83a59e75", "committedDate": "2020-11-05T18:08:48Z", "message": "Add tests for sellPart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d433d9bb98e9deea549f57121a46e8b87ca8a352", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/d433d9bb98e9deea549f57121a46e8b87ca8a352", "committedDate": "2020-11-05T19:09:33Z", "message": "Add AmmoStorage::getType AmmoType overload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1f71fa90806e28cf9edff2d62c0c3fcc64fed34", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/e1f71fa90806e28cf9edff2d62c0c3fcc64fed34", "committedDate": "2020-11-05T19:09:44Z", "message": "Add sellAmmo tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253b2e5e1e8bc35b0e286240868570227a8cf549", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/253b2e5e1e8bc35b0e286240868570227a8cf549", "committedDate": "2020-11-05T19:13:08Z", "message": "Add sellPart Ammo overload tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acc99bd02ef26c450a7eeebec5a098df5d7804d", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/0acc99bd02ef26c450a7eeebec5a098df5d7804d", "committedDate": "2020-11-05T19:16:18Z", "message": "Add sellArmor tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/5382ad3a6c68d00fad1a9e1c6449d10268e35c64", "committedDate": "2020-11-05T20:21:47Z", "message": "Add depodPart tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2f664dcf3e07f74e6c3c00461793050321004a1", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/c2f664dcf3e07f74e6c3c00461793050321004a1", "committedDate": "2020-11-06T20:18:33Z", "message": "Fix NRE in adjustCostsForCampaignOptions loading a bad CPNX"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDM3MzE0", "url": "https://github.com/MegaMek/mekhq/pull/2189#pullrequestreview-525437314", "createdAt": "2020-11-06T19:35:04Z", "commit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOTozNTowNFrOHu68AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOTo0ODo1M1rOHu7Uog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjE3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                getCampaign().getShoppingList().addShoppingItem((Armor)newArmorSupplies.getNewPart(),1,getCampaign());\n          \n          \n            \n                                getCampaign().getShoppingList().addShoppingItem((Armor) newArmorSupplies.getNewPart(), 1, getCampaign());", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518962177", "createdAt": "2020-11-06T19:35:04Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1126,7 +1130,7 @@ else if (part instanceof IAcquisitionWork) {\n                 }\n                 while(armorSupplied < armorNeeded) {\n                     armorSupplied += ((Armor)newArmorSupplies.getNewPart()).getAmount();\n-                    oldUnit.getCampaign().getShoppingList().addShoppingItem((Armor)newArmorSupplies.getNewPart(),1,oldUnit.getCampaign());\n+                    getCampaign().getShoppingList().addShoppingItem((Armor)newArmorSupplies.getNewPart(),1,getCampaign());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjY0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Part suit = new BattleArmorSuit((BattleArmor)newEntity, t, getCampaign());\n          \n          \n            \n                            Part suit = new BattleArmorSuit((BattleArmor) newEntity, t, getCampaign());", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518962641", "createdAt": "2020-11-06T19:35:56Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1426,7 +1430,7 @@ private void complete() {\n         //We've already made the old suits go *poof*; now we materialize new ones.\n         if (newEntity instanceof BattleArmor) {\n             for (int t = BattleArmor.LOC_TROOPER_1; t < newEntity.locations(); t++) {\n-                Part suit = new BattleArmorSuit((BattleArmor)newEntity, t, oldUnit.getCampaign());\n+                Part suit = new BattleArmorSuit((BattleArmor)newEntity, t, getCampaign());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 258}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NDE5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    pw1.println(MekHqXmlUtil.writeEntityToXmlString(newEntity, indentLvl+1, getCampaign().getEntities()));\n          \n          \n            \n                    pw1.println(MekHqXmlUtil.writeEntityToXmlString(newEntity, indentLvl + 1, getCampaign().getEntities()));", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518964190", "createdAt": "2020-11-06T19:39:26Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1891,7 +1895,7 @@ public String checkFixable() {\n     @Override\n     public void writeToXml(PrintWriter pw1, int indentLvl) {\n         pw1.println(MekHqXmlUtil.indentStr(indentLvl) + \"<refit>\");\n-        pw1.println(MekHqXmlUtil.writeEntityToXmlString(newEntity, indentLvl+1, oldUnit.getCampaign().getEntities()));\n+        pw1.println(MekHqXmlUtil.writeEntityToXmlString(newEntity, indentLvl+1, getCampaign().getEntities()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 369}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NzQ3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    //      location...but I don't think that's likely.\n          \n          \n            \n                    //      location... but I don't think that's likely.", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518967471", "createdAt": "2020-11-06T19:46:41Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -74,39 +71,32 @@ public AmmoStorage clone() {\n     \treturn storage;\n     }\n \n+    @Override\n+    public AmmoType getType() {\n+        return (AmmoType) super.getType();\n+    }\n+\n     @Override\n     public double getTonnage() {\n-    \tif(((AmmoType)type).getKgPerShot() > 0) {\n-    \t\treturn ((AmmoType)type).getKgPerShot() * shots/1000.0;\n+    \tif (getType().getKgPerShot() > 0) {\n+    \t\treturn getType().getKgPerShot() * shots/1000.0;\n     \t}\n-     \treturn ((double)shots / ((AmmoType)type).getShots());\n+     \treturn ((double)shots / getType().getShots());\n     }\n \n     @Override\n     public Money getStickerPrice() {\n-    \t//costs are a total nightmare\n-        //some costs depend on entity, but we can't do it that way\n-        //because spare parts don't have entities. If parts start on an entity\n-        //that's fine, but this will become problematic when we set up a parts\n-        //store. For now I am just going to pass in a null entity and attempt\n-    \t//to catch any resulting NPEs\n-    \tEntity en = null;\n-    \tboolean isArmored = false;\n-    \tif (unit != null) {\n-            en = unit.getEntity();\n-            Mounted mounted = unit.getEntity().getEquipment(equipmentNum);\n-            if(null != mounted) {\n-            \tisArmored = mounted.isArmored();\n-            }\n-    \t}\n-\n-        Money itemCost = Money.zero();\n-        try {\n-        \titemCost = itemCost.plus(type.getCost(en, isArmored, -1));\n-        } catch(NullPointerException ex) {\n-            MekHQ.getLogger().error(AmmoStorage.class, \"getStickerPrice\", ex);\n-        }\n-    \treturn itemCost;\n+        // CAW: previously we went thru AmmoType::getCost, which\n+        //      for AmmoType was the default implementation\n+        //      that simply returned 'cost'. Avoid the hassle for\n+        //      now and just return the raw cost as our sticker price.\n+        //\n+        //      We should revisit this if you can ever have ammo that\n+        //      should be sold for more based on the unit which carries\n+        //      it, or which location the ammo is stored in, or if\n+        //      the unit which carries the ammo does so in an armored\n+        //      location...but I don't think that's likely.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NzY2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            return getType().getMunitionType() == ((AmmoStorage)part).getType().getMunitionType()\n          \n          \n            \n                                    && getType().equals( (Object)((EquipmentPart)part).getType());\n          \n          \n            \n                            return getType().getMunitionType() == ((AmmoStorage) part).getType().getMunitionType()\n          \n          \n            \n                                    && getType().equals( (Object) ((EquipmentPart) part).getType());", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518967662", "createdAt": "2020-11-06T19:47:03Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -136,8 +126,8 @@ public boolean isSamePartType(Part part) {\n                 return ((EquipmentPart)part).getType() instanceof BombType\n                         && ((BombType)getType()).getBombType() == ((BombType)((EquipmentPart)part).getType()).getBombType();\n             } else {\n-                return ((AmmoType)getType()).getMunitionType() == ((AmmoType)((AmmoStorage)part).getType()).getMunitionType()\n-                        && ((AmmoType)getType()).equals( (Object)((EquipmentPart)part).getType());\n+                return getType().getMunitionType() == ((AmmoStorage)part).getType().getMunitionType()\n+                        && getType().equals( (Object)((EquipmentPart)part).getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2Nzc5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            && ((AmmoStorage)part).getType().equals(curType)\n          \n          \n            \n                            && ((AmmoStorage) part).getType().equals(curType)", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518967798", "createdAt": "2020-11-06T19:47:17Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -293,8 +283,8 @@ public String failToFind() {\n     public static boolean IsRightAmmo(Part part, AmmoType curType) {\n         return part instanceof AmmoStorage\n                 && part.isPresent()\n-                && ((AmmoType)((AmmoStorage)part).getType()).equals(curType)\n-                && curType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                && ((AmmoStorage)part).getType().equals(curType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2ODM1MQ==", "bodyText": "Formatting looks odd...", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518968351", "createdAt": "2020-11-06T19:48:37Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -61,8 +58,8 @@ public AmmoStorage() {\n     public AmmoStorage(int tonnage, EquipmentType et, int shots, Campaign c) {\n         super(tonnage, et, -1, 1.0, c);\n         this.shots = shots;\n-        if(null != type && type instanceof AmmoType) {\n-        \tthis.munition = ((AmmoType)type).getMunitionType();\n+        if (type instanceof AmmoType) {\n+        \tthis.munition = ((AmmoType) type).getMunitionType();\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2ODQ4Mg==", "bodyText": "Wait, we require this to be AmmoType as per getType. Is the if necessary, and if not this should be swapped to using getType.", "url": "https://github.com/MegaMek/mekhq/pull/2189#discussion_r518968482", "createdAt": "2020-11-06T19:48:53Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/AmmoStorage.java", "diffHunk": "@@ -61,8 +58,8 @@ public AmmoStorage() {\n     public AmmoStorage(int tonnage, EquipmentType et, int shots, Campaign c) {\n         super(tonnage, et, -1, 1.0, c);\n         this.shots = shots;\n-        if(null != type && type instanceof AmmoType) {\n-        \tthis.munition = ((AmmoType)type).getMunitionType();\n+        if (type instanceof AmmoType) {\n+        \tthis.munition = ((AmmoType) type).getMunitionType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5382ad3a6c68d00fad1a9e1c6449d10268e35c64"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a516abfa711427795f54ab0e76c3a3d9bb29afd9", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/a516abfa711427795f54ab0e76c3a3d9bb29afd9", "committedDate": "2020-11-07T00:50:14Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a593003cbefd4dc87de41013e6ea0b6c2e95e3f", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/0a593003cbefd4dc87de41013e6ea0b6c2e95e3f", "committedDate": "2020-11-07T11:50:22Z", "message": "Resolve PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38a43b4cc7f7670aa7ffad2bf318bc15334d0a1", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/a38a43b4cc7f7670aa7ffad2bf318bc15334d0a1", "committedDate": "2020-11-08T18:55:37Z", "message": "Merge remote-tracking branch 'upstream/master' into add-quartermaster-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7d611def2e3d78d243b05042c0d97317a7a1690", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/b7d611def2e3d78d243b05042c0d97317a7a1690", "committedDate": "2020-11-08T19:00:14Z", "message": "Fix missing ammo names for tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODM1NTk1", "url": "https://github.com/MegaMek/mekhq/pull/2189#pullrequestreview-525835595", "createdAt": "2020-11-08T19:02:49Z", "commit": {"oid": "b7d611def2e3d78d243b05042c0d97317a7a1690"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4115, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}