{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NjIwNjI4", "number": 2334, "title": "Issue #2332: Delete refit file if unable to read it back when saving", "bodyText": "When we begin a custom refit, we save the file to disk and then load it back into the cache. However, if we encounter a fatal error at this point and cannot read the file we simply alert the user. The file itself is never removed from disk. This causes an odd situation where you are allowed to make a mech with the same name, but it won't save it back to disk and each attempt at fixing or recreating the mech will fail unless you rename it.\nThis changes the behavior of Refit::saveCustomization slightly, in that if the refit file cannot be read back by MHQ the file itself is deleted and the cache is refreshed. The downside is that we won't have the files to look back at to see why it failed on load. The upside is that users do not have to take manual actions to restore their campaign.\nFixes part of #2332.", "createdAt": "2020-12-29T20:17:23Z", "url": "https://github.com/MegaMek/mekhq/pull/2334", "merged": true, "mergeCommit": {"oid": "3694eb375d0af25bd0c31b183775e758a3658a7d"}, "closed": true, "closedAt": "2020-12-30T03:23:50Z", "author": {"login": "sixlettervariables"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdrAgdbAH2gAyNTQ2NjIwNjI4OjIxYzNlYjRlNjVlZTYzZjdhMWYxYWZmN2VjMWI4MTdiMzMwZWVjNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrFZJJAFqTU1OTc1Njk0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47", "committedDate": "2020-12-29T20:11:26Z", "message": "Delete refit file if unable to read it, fixes #2332"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NzQyMTI3", "url": "https://github.com/MegaMek/mekhq/pull/2334#pullrequestreview-559742127", "createdAt": "2020-12-29T23:55:39Z", "commit": {"oid": "21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMzo1NTozOVrOIMaraA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMzo1NTozOVrOIMaraA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MDkyMA==", "bodyText": "Space after //, and equip should be the full word", "url": "https://github.com/MegaMek/mekhq/pull/2334#discussion_r549890920", "createdAt": "2020-12-29T23:55:39Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1558,41 +1558,67 @@ public void saveCustomization() throws EntityLoadingException {\n             }\n         }\n \n+        String fileNameCampaign;\n         try {\n             if (newEntity instanceof Mech) {\n                 //if this file already exists then don't overwrite it or we will end up with a bunch of copies\n                 String fileOutName = sCustomsDir + File.separator + fileName + \".mtf\";\n-                String fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".mtf\";\n+                fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".mtf\";\n                 if ((new File(fileOutName)).exists() || (new File(fileNameCampaign)).exists()) {\n                     throw new IOException(\"A file already exists with the custom name \"+fileNameCampaign+\". Please choose a different name. (Unit name and/or model)\");\n                 }\n-                FileOutputStream out = new FileOutputStream(fileNameCampaign);\n-                PrintStream p = new PrintStream(out);\n-                p.println(((Mech) newEntity).getMtf());\n-                p.close();\n-                out.close();\n+                try (FileOutputStream out = new FileOutputStream(fileNameCampaign);\n+                    PrintStream p = new PrintStream(out)) {\n+                    p.println(((Mech) newEntity).getMtf());\n+                }\n             } else {\n                 //if this file already exists then don't overwrite it or we will end up with a bunch of copies\n                 String fileOutName = sCustomsDir + File.separator + fileName + \".blk\";\n-                String fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".blk\";\n+                fileNameCampaign = sCustomsDirCampaign + File.separator + fileName + \".blk\";\n                 if ((new File(fileOutName)).exists() || (new File(fileNameCampaign)).exists()) {\n                     throw new IOException(\"A file already exists with the custom name \"+fileNameCampaign+\". Please choose a different name. (Unit name and/or model)\");\n                 }\n                 BLKFile.encode(fileNameCampaign, newEntity);\n             }\n         } catch (Exception e) {\n             MekHQ.getLogger().error(e);\n+            fileNameCampaign = null;\n         }\n+\n         getCampaign().addCustom(newEntity.getChassis() + \" \" + newEntity.getModel());\n-        MechSummaryCache.getInstance().loadMechData();\n-        //I need to change the new entity to the one from the mtf file now, so that equip\n-        //numbers will match\n-        MechSummary summary = MechSummaryCache.getInstance().getMech(newEntity.getChassis() + \" \" + newEntity.getModel());\n-        if (null == summary) {\n-            throw(new EntityLoadingException());\n-        }\n \n-        newEntity = new MechFileParser(summary.getSourceFile(), summary.getEntryName()).getEntity();\n+        try {\n+            MechSummaryCache.getInstance().loadMechData();\n+\n+            //I need to change the new entity to the one from the mtf file now, so that equip\n+            //numbers will match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21c3eb4e65ee63f7a1f1aff7ec1b817b330eec47"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139733141537fc2ffff80e3a40e6fd2b1ebe4c11", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/139733141537fc2ffff80e3a40e6fd2b1ebe4c11", "committedDate": "2020-12-30T01:30:56Z", "message": "Update Refit.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NzU2OTQw", "url": "https://github.com/MegaMek/mekhq/pull/2334#pullrequestreview-559756940", "createdAt": "2020-12-30T01:52:58Z", "commit": {"oid": "139733141537fc2ffff80e3a40e6fd2b1ebe4c11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3965, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}