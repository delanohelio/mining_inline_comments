{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMDEzMjU4", "number": 2030, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMzoyODoxNVrOElfcIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMzoyODoxNVrOElfcIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3NzQ3ODc0OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/Utilities.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMzoyODoxNlrOHU_zaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMzozMzo1NVrOHU_3Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA==", "bodyText": "This should be able to use updateConditionFromEntity to fix the mismatch first.", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491778920", "createdAt": "2020-09-21T03:28:16Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/Utilities.java", "diffHunk": "@@ -1170,7 +1170,16 @@ public static void unscrambleEquipmentNumbers(Unit unit, boolean refit) {\n                         if (refit) {\n                             if (m.getType().equals(epart.getType()) && !m.isDestroyed()) {\n                                 epart.setEquipmentNum(equipNum);\n-                                ((AmmoBin) epart).changeMunition(m.getType());\n+                                AmmoBin bin = (AmmoBin) epart;\n+                                // Unload bin before munition change\n+                                // TODO: if part's unit is set, both .unload() and .changeMunition check entity's\n+                                // TODO: bin instead of unit's bin. The bins can be out of sync here,\n+                                // TODO: resulting in full bins replacing empty bins\n+                                // TODO: work-around is to clear then restore part's unit\n+                                bin.setUnit(null);\n+                                bin.unload();\n+                                bin.changeMunition(m.getType());\n+                                bin.setUnit(unit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e595fc94c7a615f10d12451cbe87a3b97e03485"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3OTM2Mw==", "bodyText": "In this case, the Entity has the wrong value though.  Is there a function to update the entity from the unit/part?", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491779363", "createdAt": "2020-09-21T03:30:45Z", "author": {"login": "RexPearce"}, "path": "MekHQ/src/mekhq/Utilities.java", "diffHunk": "@@ -1170,7 +1170,16 @@ public static void unscrambleEquipmentNumbers(Unit unit, boolean refit) {\n                         if (refit) {\n                             if (m.getType().equals(epart.getType()) && !m.isDestroyed()) {\n                                 epart.setEquipmentNum(equipNum);\n-                                ((AmmoBin) epart).changeMunition(m.getType());\n+                                AmmoBin bin = (AmmoBin) epart;\n+                                // Unload bin before munition change\n+                                // TODO: if part's unit is set, both .unload() and .changeMunition check entity's\n+                                // TODO: bin instead of unit's bin. The bins can be out of sync here,\n+                                // TODO: resulting in full bins replacing empty bins\n+                                // TODO: work-around is to clear then restore part's unit\n+                                bin.setUnit(null);\n+                                bin.unload();\n+                                bin.changeMunition(m.getType());\n+                                bin.setUnit(unit);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA=="}, "originalCommit": {"oid": "9e595fc94c7a615f10d12451cbe87a3b97e03485"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3OTg5OQ==", "bodyText": ".updateConditionFromPart looks promising", "url": "https://github.com/MegaMek/mekhq/pull/2030#discussion_r491779899", "createdAt": "2020-09-21T03:33:55Z", "author": {"login": "RexPearce"}, "path": "MekHQ/src/mekhq/Utilities.java", "diffHunk": "@@ -1170,7 +1170,16 @@ public static void unscrambleEquipmentNumbers(Unit unit, boolean refit) {\n                         if (refit) {\n                             if (m.getType().equals(epart.getType()) && !m.isDestroyed()) {\n                                 epart.setEquipmentNum(equipNum);\n-                                ((AmmoBin) epart).changeMunition(m.getType());\n+                                AmmoBin bin = (AmmoBin) epart;\n+                                // Unload bin before munition change\n+                                // TODO: if part's unit is set, both .unload() and .changeMunition check entity's\n+                                // TODO: bin instead of unit's bin. The bins can be out of sync here,\n+                                // TODO: resulting in full bins replacing empty bins\n+                                // TODO: work-around is to clear then restore part's unit\n+                                bin.setUnit(null);\n+                                bin.unload();\n+                                bin.changeMunition(m.getType());\n+                                bin.setUnit(unit);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3ODkyMA=="}, "originalCommit": {"oid": "9e595fc94c7a615f10d12451cbe87a3b97e03485"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2254, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}