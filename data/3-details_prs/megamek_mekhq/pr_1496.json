{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NDE4NDkx", "number": 1496, "title": "Scenario template various improvements", "bodyText": "Implements a few improvements to scenario templates. Notably:\n\n\"minimum unit weight\" now works\nchanged text on 'finalize' button to be more reflective of what it will do when the user clicks it\ntransports might wind up having battle armor inside them (goes back to classic AtB too)\nclan stars generated for template scenarios might be novas with battle armor\nclans don't mix tanks and mechs until the republic of the sphere starts putting its foot down\n\nbest reviewed by individual commit", "createdAt": "2020-02-18T05:01:26Z", "url": "https://github.com/MegaMek/mekhq/pull/1496", "merged": true, "mergeCommit": {"oid": "f80cc74adf8c0a5c15ba0d1d71a5f268cd883725"}, "closed": true, "closedAt": "2020-02-22T00:57:56Z", "author": {"login": "NickAragua"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEbpE8gH2gAyMzc2NDE4NDkxOjI4OWE3ZjM0MTM2YjJjNzEzNjBmMDAwMzgyZWQzNmJlMzM1MWY3ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGlzxkAFqTM2Mjg5OTQyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "289a7f34136b2c71360f000382ed36be3351f7e1", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/289a7f34136b2c71360f000382ed36be3351f7e1", "committedDate": "2020-02-15T03:34:05Z", "message": "implement min weight"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6834d4dd493b68fba951f72bf14f19a4880ccc30", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/6834d4dd493b68fba951f72bf14f19a4880ccc30", "committedDate": "2020-02-15T03:38:22Z", "message": "better button messaging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa3ed96896ba6ac90a856a3a15322ea22f9d3445", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/fa3ed96896ba6ac90a856a3a15322ea22f9d3445", "committedDate": "2020-02-18T03:13:01Z", "message": "can now generate battle armor to be transported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f362ee731419087c0e3dd3b89ae1c7048cd67946", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/f362ee731419087c0e3dd3b89ae1c7048cd67946", "committedDate": "2020-02-18T04:14:54Z", "message": "elementals for clan novas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "947b638f527e04ccad89dfbcb8f1d09d151b90a4", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/947b638f527e04ccad89dfbcb8f1d09d151b90a4", "committedDate": "2020-02-18T04:58:08Z", "message": "clan opfor generation updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzA0Mzcz", "url": "https://github.com/MegaMek/mekhq/pull/1496#pullrequestreview-360304373", "createdAt": "2020-02-18T12:39:42Z", "commit": {"oid": "289a7f34136b2c71360f000382ed36be3351f7e1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjozOTo0MlrOFrAzdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjo0ODoxMFrOFrBDKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0NjI2MQ==", "bodyText": "What was this used for?", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380646261", "createdAt": "2020-02-18T12:39:42Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -30,6 +30,7 @@\n import java.util.UUID;\n import java.util.stream.Collectors;\n \n+import org.apache.xalan.xsltc.compiler.Pattern;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "289a7f34136b2c71360f000382ed36be3351f7e1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0Njk4NA==", "bodyText": "Is transportedUnit guaranteed to be non-null here?", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380646984", "createdAt": "2020-02-18T12:41:13Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -977,48 +982,96 @@ public static Entity getInfantryEntity(UnitGeneratorParameters params, int skill\n \n                 UnitGeneratorParameters newParams = params.clone();\n                 newParams.clearMovementModes();\n-                newParams.setUnitType(UnitType.INFANTRY);\n                 newParams.setWeightClass(AtBDynamicScenarioFactory.UNIT_WEIGHT_UNSPECIFIED);\n-\n-                // to save ourselves having to re-generate a bunch of infantry for smaller bays (3 tons and lower)\n-                // we will limit ourselves to generating low-weight foot platoons\n-                if(bayCapacity <= IUnitGenerator.FOOT_PLATOON_INFANTRY_WEIGHT) {\n-                    newParams.getMovementModes().add(EntityMovementMode.INF_LEG);\n-                    newParams.setFilter(inf -> inf.getTons() <= IUnitGenerator.FOOT_PLATOON_INFANTRY_WEIGHT);\n-                } else {\n-                    newParams.getMovementModes().addAll(IUnitGenerator.ALL_INFANTRY_MODES);\n-                    newParams.setFilter(inf -> inf.getTons() <= bayCapacity);\n+                \n+                Entity transportedUnit = null;\n+                \n+                // for now, we'll assign BA units with greater likelyhood to units with higher-rated equipment\n+                int baRoll = Compute.d6(2);                \n+                if(baRoll >= infantryToBAUpgradeTNs[params.getQuality()]) {\n+                    transportedUnit = generateTransportedBAUnit(newParams, bayCapacity, skill, campaign);\n+                }\n+                \n+                if(transportedUnit == null) {\n+                    transportedUnit = generateTransportedInfantryUnit(newParams, bayCapacity, skill, campaign);\n                 }\n \n-                MechSummary ms = campaign.getUnitGenerator().generate(newParams);\n+                // sometimes something crazy will happen and we will not be able to load the unit into the transport\n+                // so let's at least have it deploy at the same time as the transport\n+                transportedUnit.setDeployRound(transport.getDeployRound());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3ed96896ba6ac90a856a3a15322ea22f9d3445"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0ODQ0MQ==", "bodyText": "Clan Blood Spirit I'd imagine.", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380648441", "createdAt": "2020-02-18T12:44:20Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f362ee731419087c0e3dd3b89ae1c7048cd67946"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDEzNQ==", "bodyText": "We're picking the slowest one assuming its the heaviest?", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380650135", "createdAt": "2020-02-18T12:47:51Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there\n+        int roll = Compute.d6(2);\n+        int novaTarget = 8;\n+        if (factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\")) {\n+            novaTarget = 6;\n+        } else if (factionCode.equals(\"CBS\")) {\n+            novaTarget = 13;\n+        }\n+        \n+        if(roll < novaTarget) {\n+            return transportedUnits;\n+        }\n+        \n+        Entity actualTransport = null;\n+        for(Entity transport : starUnits) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f362ee731419087c0e3dd3b89ae1c7048cd67946"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDI4MQ==", "bodyText": "Are we guaranteed transportedUnit is non-null?", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380650281", "createdAt": "2020-02-18T12:48:10Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there\n+        int roll = Compute.d6(2);\n+        int novaTarget = 8;\n+        if (factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\")) {\n+            novaTarget = 6;\n+        } else if (factionCode.equals(\"CBS\")) {\n+            novaTarget = 13;\n+        }\n+        \n+        if(roll < novaTarget) {\n+            return transportedUnits;\n+        }\n+        \n+        Entity actualTransport = null;\n+        for(Entity transport : starUnits) {\n+            if(transport instanceof Mech && transport.isOmni()) {\n+                if((actualTransport == null) || (actualTransport.getWalkMP() < transport.getWalkMP())) {\n+                    actualTransport = transport;\n+                }\n+            }\n+        }\n+        \n+        if(actualTransport == null) {\n+            return transportedUnits;\n+        }\n+        \n+        // if we're generating a riding BA, do so now, then associate it with the designated transport\n+        UnitGeneratorParameters params = new UnitGeneratorParameters();\n+        params.setFaction(factionCode);\n+        params.setQuality(quality);\n+        params.setYear(campaign.getGameYear());\n+        params.addMissionRole(MissionRole.MECHANIZED_BA);\n+        params.setWeightClass(UNIT_WEIGHT_UNSPECIFIED);\n+\n+        Entity transportedUnit = generateTransportedBAUnit(params, IUnitGenerator.NO_WEIGHT_LIMIT, skill, campaign);\n+        transportedUnit.setDeployRound(actualTransport.getDeployRound());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f362ee731419087c0e3dd3b89ae1c7048cd67946"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDc4OTg3", "url": "https://github.com/MegaMek/mekhq/pull/1496#pullrequestreview-360478987", "createdAt": "2020-02-18T16:20:48Z", "commit": {"oid": "947b638f527e04ccad89dfbcb8f1d09d151b90a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoyMDo0OFrOFrJDvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoyMDo0OFrOFrJDvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4MTUwMA==", "bodyText": "I'm pretty sure the logic or description here is flawed. A base target of 6 on 2d6 is 27.8% (just below 2/6) whereas a base target of 4 would be 16.7% (1/6) on 2d6.", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380781500", "createdAt": "2020-02-18T16:20:48Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1310,6 +1463,36 @@ private static String adjustWeightsForFaction(String weights, String faction) {\n \n         return unitTypes;\n     }\n+    \n+    /**\n+     * Specialized logic for generating clan units\n+     * @return\n+     */\n+    private static List<Integer> generateClanUnitTypes(int unitCount, int forceQuality, String factionCode, Campaign campaign) {        \n+        // per AtB, we have a 1/6 odds of encountering a vehicle star\n+        // for fluff reasons, hell's horses + pals use more vehicles\n+        // higher-rated clan units become increasingly unlikely to use vehicles\n+        int vehicleTarget = 6;\n+        if(factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\") || factionCode.equals(\"CBS\")) {\n+            vehicleTarget = 8;\n+        } else {\n+            vehicleTarget -= forceQuality;\n+        }\n+        \n+        // we randomly determine tank or mek\n+        int roll = Compute.d6(2); ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "947b638f527e04ccad89dfbcb8f1d09d151b90a4"}, "originalPosition": 360}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d0ee45f409490142c057b7600542d4ac804a588", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/4d0ee45f409490142c057b7600542d4ac804a588", "committedDate": "2020-02-19T01:16:33Z", "message": "code review fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9967567c8cb4c2bd4a5aeeeeb4ccd682690deef0", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/9967567c8cb4c2bd4a5aeeeeb4ccd682690deef0", "committedDate": "2020-02-19T01:22:42Z", "message": "merge from upstream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODk5NDIz", "url": "https://github.com/MegaMek/mekhq/pull/1496#pullrequestreview-362899423", "createdAt": "2020-02-21T20:32:40Z", "commit": {"oid": "9967567c8cb4c2bd4a5aeeeeb4ccd682690deef0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4457, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}