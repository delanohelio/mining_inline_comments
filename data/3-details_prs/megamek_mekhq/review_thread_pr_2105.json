{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MzM2MDk2", "number": 2105, "reviewThreads": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNjo0MlrOEqH4lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowOTowN1rOEqIFyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA0ODIzOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNjo0MlrOHcKOYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNjo0MlrOHcKOYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTY5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\n          \n          \n            \n                            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289699", "createdAt": "2020-10-04T21:16:42Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1634,7 +1634,8 @@ public void addPart(Part p, int transitDays) {\n             p.setId(-1);\n             return;\n         }\n-        if ((null == p.getUnit()) && !p.hasParentPart()) {\n+        if ((null == p.getUnit()) && !p.hasParentPart()\n+            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA0ODU2OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNzoxMVrOHcKOjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNzoxMVrOHcKOjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTc0Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\n          \n          \n            \n                            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289743", "createdAt": "2020-10-04T21:17:11Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1746,7 +1747,8 @@ public void addPartWithoutId(Part p) {\n         // go ahead and check for existing parts because some version weren't\n         // properly collecting parts\n         Part mergedWith = null;\n-        if (!(p instanceof MissingPart) && null == p.getUnitId()) {\n+        if (!(p instanceof MissingPart) && (null == p.getUnitId())\n+            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA0ODY1OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNzoyMVrOHcKOmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxNzoyMVrOHcKOmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTc1NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Go through each unit and its refits to see if the new armorshould be updated\n          \n          \n            \n                        // Go through each unit and its refits to see if the new armor should be updated", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289754", "createdAt": "2020-10-04T21:17:21Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1773,39 +1775,19 @@ public void addPartWithoutId(Part p) {\n             parts.put(p.getId(), p);\n             MekHQ.triggerEvent(new PartNewEvent(p));\n         } else {\n-            // Go through each unit and its refits to see if the new armor ID should be updated\n+            // Go through each unit and its refits to see if the new armorshould be updated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1MDA4OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxOTozMlrOHcKPWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToxOTozMlrOHcKPWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTk0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        Armor mergedArmor = (Armor)mergedWith;\n          \n          \n            \n                                        Armor mergedArmor = (Armor) mergedWith;", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289944", "createdAt": "2020-10-04T21:19:32Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1773,39 +1775,19 @@ public void addPartWithoutId(Part p) {\n             parts.put(p.getId(), p);\n             MekHQ.triggerEvent(new PartNewEvent(p));\n         } else {\n-            // Go through each unit and its refits to see if the new armor ID should be updated\n+            // Go through each unit and its refits to see if the new armorshould be updated\n             // CAW: I believe all other parts on a refit have a unit assigned to them.\n-            for (Unit u : getUnits()) {\n-                Refit r = u.getRefit();\n-                // If there is a refit and this part matches the new armor, update the ID\n-                if (null != r) {\n-                    if (mergedWith instanceof Armor\n-                        && r.getNewArmorSuppliesId() == p.getId()) {\n-                        MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                            String.format(\"%s (%d) was merged with %s (%d) used in a refit for %s\", p.getName(),\n-                                p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                        Armor mergedArmor = (Armor)mergedWith;\n-                        r.setNewArmorSupplies(mergedArmor);\n-                    } else {\n-                        List<Integer> ids = r.getOldUnitPartIds();\n-                        for (int ii = 0; ii < ids.size(); ++ii) {\n-                            int oid = ids.get(ii);\n-                            if (p.getId() == oid) {\n-                                MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                                String.format(\"%s (%d) was merged with %s (%d) used in the old unit in a refit for %s\", p.getName(),\n-                                    p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                                ids.set(ii, mergedWith.getId());\n-                            }\n-                        }\n-                        ids = r.getNewUnitPartIds();\n-                        for (int ii = 0; ii < ids.size(); ++ii) {\n-                            int nid = ids.get(ii);\n-                            if (p.getId() == nid) {\n-                                MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                                String.format(\"%s (%d) was merged with %s (%d) used in the new unit in a refit for %s\", p.getName(),\n+            if (mergedWith instanceof Armor) {\n+                for (Unit u : getUnits()) {\n+                    Refit r = u.getRefit();\n+                    // If there is a refit and this part matches the new armor, update the armor entry\n+                    if (null != r) {\n+                        if (r.getNewArmorSupplies() == p) {\n+                            MekHQ.getLogger().info(\n+                                String.format(\"%s (%d) was merged with %s (%d) used in a refit for %s\", p.getName(),\n                                     p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                                ids.set(ii, mergedWith.getId());\n-                            }\n+                            Armor mergedArmor = (Armor)mergedWith;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1MjM4OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyMjo1NFrOHcKQfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyMjo1NFrOHcKQfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDIzNw==", "bodyText": "Tab vs Space formatting", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290237", "createdAt": "2020-10-04T21:22:54Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -161,12 +161,10 @@ public Part findReplacement(boolean refit) {\n \t\tPart bestPart = null;\n \n \t\t//check to see if we already have a replacement assigned\n-\t\tif(replacementId > -1) {\n-\t\t\tbestPart = campaign.getPart(replacementId);\n-\t\t\tif(null != bestPart) {\n-\t\t\t\treturn bestPart;\n-\t\t\t}\n-\t\t}\n+\t\tif (hasReplacementPart()) {\n+\t\t\treturn getReplacementPart();\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1Mzg4OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNToyNFrOHcKROg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNToyNFrOHcKROg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDQyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        pw1.println(MekHqXmlUtil.indentStr(indent+1)\n          \n          \n            \n                                +\"<replacementId>\"\n          \n          \n            \n                                + getReplacementPart().getId()\n          \n          \n            \n                                +\"</replacementId>\");\n          \n          \n            \n                        MekHqXmlUtil.writeSimpleXmlTag(pw1, indent + 1, \"replacementId\", getReplacementPart().getId());", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290426", "createdAt": "2020-10-04T21:25:24Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -347,11 +345,13 @@ public void writeToXmlBegin(PrintWriter pw1, int indent) {\n \t\tpw1.println(MekHqXmlUtil.indentStr(indent+1)\n \t\t\t\t+\"<daysToWait>\"\n \t\t\t\t+daysToWait\n-\t\t\t\t+\"</daysToWait>\");\n-\t\tpw1.println(MekHqXmlUtil.indentStr(indent+1)\n-\t\t\t\t+\"<replacementId>\"\n-\t\t\t\t+replacementId\n-\t\t\t\t+\"</replacementId>\");\n+                +\"</daysToWait>\");\n+        if (hasReplacementPart()) {\n+            pw1.println(MekHqXmlUtil.indentStr(indent+1)\n+                    +\"<replacementId>\"\n+                    + getReplacementPart().getId()\n+                    +\"</replacementId>\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1NDEzOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNjowMlrOHcKRXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNjowMlrOHcKRXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDQ2Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (hasReplacementPart() && null != replacement) {\n          \n          \n            \n            \t\tif (hasReplacementPart() && (null != replacement)) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290462", "createdAt": "2020-10-04T21:26:02Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -402,29 +402,29 @@ public void reservePart() {\n \t\t//shouldn't be null, but it never hurts to check\n \t\tPart replacement = findReplacement(false);\n \t\tUUID teamId = getTeamId();\n-\t\tif(null != replacement && null != teamId) {\n-\t\t\tif(replacement.getQuantity() > 1) {\n+\t\tif ((null != replacement) &&(null != teamId)) {\n+\t\t\tif (replacement.getQuantity() > 1) {\n \t\t\t\tPart actualReplacement = replacement.clone();\n \t\t\t\tactualReplacement.setReserveId(teamId);\n-\t\t\t\tcampaign.addPart(actualReplacement, 0);\n-\t\t\t\treplacementId = actualReplacement.getId();\n+                campaign.addPart(actualReplacement, 0);\n+                setReplacementPart(actualReplacement);\n \t\t\t\treplacement.decrementQuantity();\n \t\t\t} else {\n-\t\t\t\treplacement.setReserveId(teamId);\n-\t\t\t\treplacementId = replacement.getId();\n+                replacement.setReserveId(teamId);\n+                setReplacementPart(replacement);\n \t\t\t}\n \t\t}\n \t}\n \n \t@Override\n \tpublic void cancelReservation() {\n \t\tPart replacement = findReplacement(false);\n-\t\tif(replacementId > -1 && null != replacement) {\n-\t\t\treplacementId = -1;\n+\t\tif (hasReplacementPart() && null != replacement) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1NDU5OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNjo0OFrOHcKRng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMToyNjo0OFrOHcKRng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDUyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            MekHQ.getLogger().error(PartRef.class,\n          \n          \n            \n                                String.format(\"Part %d ('%s') references missing replacement part %d\",\n          \n          \n            \n                                    getId(), getName(), id));\n          \n          \n            \n                            MekHQ.getLogger().error(\n          \n          \n            \n                                String.format(\"Part %d ('%s') references missing replacement part %d\",\n          \n          \n            \n                                    getId(), getName(), id));", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290526", "createdAt": "2020-10-04T21:26:48Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1783,6 +1823,16 @@ public SimpleTechLevel getStaticTechLevel() {\n     }\n \n     public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (replacementPart instanceof PartRef) {\n+            int id = replacementPart.getId();\n+            replacementPart = knownParts.get(id);\n+            if ((replacementPart == null) && (id > 0)) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing replacement part %d\",\n+                        getId(), getName(), id));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 144}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1NjcxOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMDozMFrOHcKSwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMDozMFrOHcKSwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDgxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    converted = (int)Math.round((double)converted/curType.getRackSize());\n          \n          \n            \n                    converted = (int) Math.round((double) converted / curType.getRackSize());", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290818", "createdAt": "2020-10-04T21:30:30Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -582,13 +582,17 @@ public void swapAmmoFromCompatible(int needed, AmmoStorage as) {\n                 }\n             }\n         }\n-        converted = Math.round((float)converted/curType.getRackSize());\n-        as.changeAmountAvailable(converted, curType);\n+        converted = (int)Math.round((double)converted/curType.getRackSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1NzYzOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMTo0OVrOHcKTQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMTo0OVrOHcKTQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return getAmountAvailable(campaign, (AmmoType)getType());\n          \n          \n            \n                    return getAmountAvailable(campaign, (AmmoType) getType());", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290944", "createdAt": "2020-10-04T21:31:49Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1NzgwOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMjowN1rOHcKTWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMjowN1rOHcKTWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                           } else if (isCompatibleAmmo(campaign, aType, ammoType) && ammoType.getRackSize() != 0) {\n          \n          \n            \n                                           } else if (isCompatibleAmmo(campaign, aType, ammoType) && (ammoType.getRackSize() != 0)) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290968", "createdAt": "2020-10-04T21:32:07Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());\n+    }\n+\n+    public static int getAmountAvailable(Campaign campaign, AmmoType ammoType) {\n         if (campaign.getCampaignOptions().useAmmoByType()) {\n             Predicate<Part> predicate;\n-            if (AmmoBin.ALLOWED_BY_TYPE.contains(thisType.getAmmoType())) {\n+            if (AmmoBin.ALLOWED_BY_TYPE.contains(ammoType.getAmmoType())) {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             } else {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equals(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equals(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             }\n             AmmoStorage a = (AmmoStorage) campaign.findSparePart(predicate);\n             return a != null ? a.getShots() : 0;\n         } else {\n             return campaign.streamSpareParts()\n-                            .filter(part -> part instanceof AmmoStorage && part.isPresent())\n-                            .mapToInt(part -> {\n-                                AmmoStorage a = (AmmoStorage)part;\n-                                AmmoType aType = (AmmoType)a.getType();\n-                                if (aType.equals(getType()) && thisType.getMunitionType() == aType.getMunitionType()) {\n-                                    return a.getShots();\n-                                } else if (isCompatibleAmmo(aType, thisType) && thisType.getRackSize() != 0) {\n-                                    return (a.getShots() * aType.getRackSize()) / thisType.getRackSize();\n-                                }\n-                                return 0;\n-                            })\n-                            .sum();\n+                           .filter(part -> part instanceof AmmoStorage && part.isPresent())\n+                           .mapToInt(part -> {\n+                               AmmoStorage a = (AmmoStorage)part;\n+                               AmmoType aType = (AmmoType)a.getType();\n+                               if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {\n+                                   return a.getShots();\n+                               } else if (isCompatibleAmmo(campaign, aType, ammoType) && ammoType.getRackSize() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA1Nzk0OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMjoxNlrOHcKTaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMTozMjoxNlrOHcKTaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                           if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {\n          \n          \n            \n                                           if (aType.equals(ammoType) && (ammoType.getMunitionType() == aType.getMunitionType())) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290985", "createdAt": "2020-10-04T21:32:16Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());\n+    }\n+\n+    public static int getAmountAvailable(Campaign campaign, AmmoType ammoType) {\n         if (campaign.getCampaignOptions().useAmmoByType()) {\n             Predicate<Part> predicate;\n-            if (AmmoBin.ALLOWED_BY_TYPE.contains(thisType.getAmmoType())) {\n+            if (AmmoBin.ALLOWED_BY_TYPE.contains(ammoType.getAmmoType())) {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             } else {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equals(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equals(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             }\n             AmmoStorage a = (AmmoStorage) campaign.findSparePart(predicate);\n             return a != null ? a.getShots() : 0;\n         } else {\n             return campaign.streamSpareParts()\n-                            .filter(part -> part instanceof AmmoStorage && part.isPresent())\n-                            .mapToInt(part -> {\n-                                AmmoStorage a = (AmmoStorage)part;\n-                                AmmoType aType = (AmmoType)a.getType();\n-                                if (aType.equals(getType()) && thisType.getMunitionType() == aType.getMunitionType()) {\n-                                    return a.getShots();\n-                                } else if (isCompatibleAmmo(aType, thisType) && thisType.getRackSize() != 0) {\n-                                    return (a.getShots() * aType.getRackSize()) / thisType.getRackSize();\n-                                }\n-                                return 0;\n-                            })\n-                            .sum();\n+                           .filter(part -> part instanceof AmmoStorage && part.isPresent())\n+                           .mapToInt(part -> {\n+                               AmmoStorage a = (AmmoStorage)part;\n+                               AmmoType aType = (AmmoType)a.getType();\n+                               if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3Njk2OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMDozNVrOHcKc0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMDozNVrOHcKc0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzM5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (null != replacement && null == partQuantity.get(replacement)) {\n          \n          \n            \n                            if ((null != replacement) && (null == partQuantity.get(replacement))) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293392", "createdAt": "2020-10-04T22:00:35Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 162}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3NzE3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMDo1MVrOHcKc7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMDo1MVrOHcKc7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQyMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (null != replacement && partQuantity.get(replacement) > 0) {\n          \n          \n            \n            \n          \n          \n            \n                            if ((null != replacement) && (partQuantity.get(replacement) > 0)) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293421", "createdAt": "2020-10-04T22:00:51Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {\n+                    partQuantity.put(replacement, replacement.getQuantity());\n                 }\n-                if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                    newUnitParts.add(replacement.getId());\n+                if (null != replacement && partQuantity.get(replacement) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3NzQ2OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMToxOVrOHcKdEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMToxOVrOHcKdEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQ1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                partQuantity.put(replacement, partQuantity.get(replacement)-1);\n          \n          \n            \n                                partQuantity.put(replacement, partQuantity.get(replacement) - 1);", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293459", "createdAt": "2020-10-04T22:01:19Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {\n+                    partQuantity.put(replacement, replacement.getQuantity());\n                 }\n-                if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                    newUnitParts.add(replacement.getId());\n+                if (null != replacement && partQuantity.get(replacement) > 0) {\n+                    newUnitParts.add(replacement);\n                     //adjust quantity\n-                    partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId())-1);\n+                    partQuantity.put(replacement, partQuantity.get(replacement)-1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3NzYxOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMTo0MVrOHcKdKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMTo0MVrOHcKdKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQ4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (null != replacement && null == partQuantity.get(replacement)) {\n          \n          \n            \n                                if ((null != replacement) && (null == partQuantity.get(replacement))) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293480", "createdAt": "2020-10-04T22:01:41Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -554,15 +549,15 @@ public void calculate() {\n                     Part replacement = mab.findReplacement(true);\n                     //check quantity\n                     //TODO: the one weakness here is that we will not pick up damaged parts\n-                    if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                        partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                    if (null != replacement && null == partQuantity.get(replacement)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 184}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3Nzg2OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMTo1OVrOHcKdRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowMTo1OVrOHcKdRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzUwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (null != replacement && partQuantity.get(replacement) > 0) {\n          \n          \n            \n            \n          \n          \n            \n                                if ((null != replacement) && (partQuantity.get(replacement) > 0)) {", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293509", "createdAt": "2020-10-04T22:01:59Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -554,15 +549,15 @@ public void calculate() {\n                     Part replacement = mab.findReplacement(true);\n                     //check quantity\n                     //TODO: the one weakness here is that we will not pick up damaged parts\n-                    if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                        partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                    if (null != replacement && null == partQuantity.get(replacement)) {\n+                        partQuantity.put(replacement, replacement.getQuantity());\n                     }\n-                    if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                        newUnitParts.add(replacement.getId());\n+                    if (null != replacement && partQuantity.get(replacement) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 189}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3OTMxOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNDo0M1rOHcKeCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNDo0M1rOHcKeCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzcwNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);\n          \n          \n            \n                        && ((null == newArmorSupplies) || (armorNeeded - newArmorSupplies.getAmount()) <= 0);", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293707", "createdAt": "2020-10-04T22:04:43Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1214,7 +1224,8 @@ public boolean acquireParts() {\n             return false;\n         }\n \n-        return shoppingList.size() == 0 && !missingAmmo && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);\n+        return shoppingList.size() == 0\n+            && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 445}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3OTUzOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNDo1NlrOHcKeJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNDo1NlrOHcKeJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzczMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage)part;\n          \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage) part;", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293732", "createdAt": "2020-10-04T22:04:56Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1276,13 +1275,20 @@ private void updateRefitClass(int rClass) {\n \n     public void cancel() {\n         oldUnit.setRefit(null);\n-        for (int pid : newUnitParts) {\n-            Part part = oldUnit.getCampaign().getPart(pid);\n-            if (null == part) {\n-                MekHQ.getLogger().error(this, \"part with id \" + pid + \" not found for refit of \" + getDesc());\n-                continue;\n+\n+        // Return our reserved ammo back to the campaign\n+        for (Part part : newUnitParts) {\n+            if (part instanceof AmmoStorage) {\n+                // merge back into the campaign\n+                AmmoStorage ammoStorage = (AmmoStorage)part;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 482}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA3OTg3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNTowNFrOHcKeTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNTowNFrOHcKeTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5Mzc3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293772", "createdAt": "2020-10-04T22:05:04Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1276,13 +1275,20 @@ private void updateRefitClass(int rClass) {\n \n     public void cancel() {\n         oldUnit.setRefit(null);\n-        for (int pid : newUnitParts) {\n-            Part part = oldUnit.getCampaign().getPart(pid);\n-            if (null == part) {\n-                MekHQ.getLogger().error(this, \"part with id \" + pid + \" not found for refit of \" + getDesc());\n-                continue;\n+\n+        // Return our reserved ammo back to the campaign\n+        for (Part part : newUnitParts) {\n+            if (part instanceof AmmoStorage) {\n+                // merge back into the campaign\n+                AmmoStorage ammoStorage = (AmmoStorage)part;\n+                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 483}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MDI0OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNTo0MlrOHcKeew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowNTo0MlrOHcKeew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzgxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage)part;\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());\n          \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage) part;\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293819", "createdAt": "2020-10-04T22:05:42Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1465,6 +1458,12 @@ else if ((part instanceof AeroHeatSink) && (newEntity instanceof Aero) && !part.\n                     oldUnit.getCampaign().removePart(part);\n                     continue;\n                 }\n+            } else if (part instanceof AmmoStorage) {\n+                // merge back into the campaign before completing the refit\n+                AmmoStorage ammoStorage = (AmmoStorage)part;\n+                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 591}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MTU4OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODoyMFrOHcKfMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODoyMFrOHcKfMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAwMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            newArmorSupplies = (Armor)realPart;\n          \n          \n            \n                            newArmorSupplies = (Armor) realPart;", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294000", "createdAt": "2020-10-04T22:08:20Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 702}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MTcwOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODoyN1rOHcKfPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODoyN1rOHcKfPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            MekHQ.getLogger().error(RefitArmorRef.class,\n          \n          \n            \n                            MekHQ.getLogger().error(", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294012", "createdAt": "2020-10-04T22:08:27Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 704}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MTg1OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODo0MFrOHcKfTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODo0MFrOHcKfTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294030", "createdAt": "2020-10-04T22:08:40Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 718}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MTk3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODo1NVrOHcKfYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowODo1NVrOHcKfYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDA1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294051", "createdAt": "2020-10-04T22:08:55Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing old unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    oldUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        for (int ii = newUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = newUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    newUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 733}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjA4MjAyOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowOTowN1rOHcKfbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMjowOTowN1rOHcKfbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDA2Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294062", "createdAt": "2020-10-04T22:09:07Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing old unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    oldUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        for (int ii = newUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = newUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    newUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing new unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    newUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        List<Part> realParts = new ArrayList<>();\n+        Iterator<Part> it = lcBinsToChange.iterator();\n+        while (it.hasNext()) {\n+            Part part = it.next();\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                it.remove();\n+                if (realPart != null) {\n+                    realParts.add(realPart);\n+                } else {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6"}, "originalPosition": 751}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2017, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}