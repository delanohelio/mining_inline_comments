{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDQ4OTYw", "number": 1509, "title": "Adding Monthly and Yearly Autosave Options", "bodyText": "This adds monthly and yearly autosave options to MekHQ, in addition to some protection against bad directories and file names.", "createdAt": "2020-02-21T19:59:50Z", "url": "https://github.com/MegaMek/mekhq/pull/1509", "merged": true, "mergeCommit": {"oid": "9efb4055a9ece186093e03c95ef5b5e018a4b791"}, "closed": true, "closedAt": "2020-02-25T00:55:00Z", "author": {"login": "Windchild292"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGk_f3AH2gAyMzc4NDQ4OTYwOjU2NDI0ZmIwNDEwY2I1ZjIzMGNhNjNkY2I2ZDdiZDAyNGQyMDcyNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHjutfgFqTM2MzY4NTcwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56424fb0410cb5f230ca63dcb6d7bd024d207271", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/56424fb0410cb5f230ca63dcb6d7bd024d207271", "committedDate": "2020-02-21T19:35:34Z", "message": "Adding Monthly and Yearly autosave options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67ad05c522a8d45c274e767099bcf30cbb87cab", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/a67ad05c522a8d45c274e767099bcf30cbb87cab", "committedDate": "2020-02-21T19:50:17Z", "message": "Changing the base autosave index to 1 so that it makes more sense to non-programmers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "287b082c5fe655c6be953f7ea106301d506769d6", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/287b082c5fe655c6be953f7ea106301d506769d6", "committedDate": "2020-02-21T19:53:39Z", "message": "Adding a check to ensure the autosave file is deleted successfully and otherwise write it as an error to the logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODg2MTkw", "url": "https://github.com/MegaMek/mekhq/pull/1509#pullrequestreview-362886190", "createdAt": "2020-02-21T20:07:11Z", "commit": {"oid": "287b082c5fe655c6be953f7ea106301d506769d6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDowNzoxMVrOFtDJyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDowNzoxMVrOFtDJyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTg5OA==", "bodyText": "nit: whiteline", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382781898", "createdAt": "2020-02-21T20:07:11Z", "author": {"login": "VicenteCartas"}, "path": "MekHQ/src/mekhq/service/AutosaveService.java", "diffHunk": "@@ -73,20 +82,33 @@ private boolean isWeeklyAutosaveEnabled() {\n         return this.userPreferences.getBoolean(MekHqConstants.SAVE_WEEKLY_KEY, false);\n     }\n \n+    private boolean isMonthlyAutosaveEnabled() {\n+        return this.userPreferences.getBoolean(MekHqConstants.SAVE_MONTHLY_KEY, false);\n+    }\n+\n+    private boolean isYearlyAutosaveEnabled() {\n+        return this.userPreferences.getBoolean(MekHqConstants.SAVE_YEARLY_KEY, false);\n+    }\n+\n     private boolean isMissionAutosaveEnabled() {\n         return this.userPreferences.getBoolean(MekHqConstants.SAVE_BEFORE_MISSIONS_KEY, false);\n     }\n \n     private void performAutosave(Campaign campaign) {\n         try {\n             String fileName = this.getAutosaveFilename(campaign);\n-\n-            try (FileOutputStream fos = new FileOutputStream(fileName);\n-                 GZIPOutputStream output = new GZIPOutputStream(fos)) {\n-                PrintWriter writer = new PrintWriter(new OutputStreamWriter(output, \"UTF-8\"));\n-                campaign.writeToXml(writer);\n-                writer.flush();\n-                writer.close();\n+            if (!StringUtil.isNullOrEmpty(fileName)) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "287b082c5fe655c6be953f7ea106301d506769d6"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d", "author": {"user": {"login": "Windchild292", "name": "Justin Bowen"}}, "url": "https://github.com/MegaMek/mekhq/commit/22e5df395c560692739a4daa7c79e5dc789f8a8d", "committedDate": "2020-02-21T20:15:16Z", "message": "Removing accidental whitespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk2ODUy", "url": "https://github.com/MegaMek/mekhq/pull/1509#pullrequestreview-362996852", "createdAt": "2020-02-22T01:18:10Z", "commit": {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMToxODoxMFrOFtIoTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMToxODoxMFrOFtIoTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MTYyOQ==", "bodyText": "Seems like if you turned autosaveFiles into a map, you could get an O(1) run time here, rather than O(#files)", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382871629", "createdAt": "2020-02-22T01:18:10Z", "author": {"login": "NickAragua"}, "path": "MekHQ/src/mekhq/service/AutosaveService.java", "diffHunk": "@@ -98,39 +119,51 @@ private String getAutosaveFilename(Campaign campaign) {\n         // Get all autosave files in ascending order of date creation\n         String savesDirectoryPath = MekHQ.getCampaignsDirectory().getValue();\n         File folder = new File(savesDirectoryPath);\n-        List<File> autosaveFiles = Arrays.stream(folder.listFiles())\n-                .filter(f -> f.getName().startsWith(\"Autosave-\"))\n-                .sorted(Comparator.comparing(f -> f.lastModified()))\n-                .collect(Collectors.toList());\n-\n-        // Delete older autosave files if needed\n-        int maxNumberAutosaves = this.userPreferences.getInt(MekHqConstants.MAXIMUM_NUMBER_SAVES_KEY, MekHqConstants.DEFAULT_NUMBER_SAVES);\n-        while (autosaveFiles.size() >= maxNumberAutosaves && autosaveFiles.size() > 0) {\n-            autosaveFiles.get(0).delete();\n-            autosaveFiles.remove(0);\n-        }\n+        File[] files = folder.listFiles();\n+        if (files != null) {\n+            List<File> autosaveFiles = Arrays.stream(files)\n+                    .filter(f -> f.getName().startsWith(\"Autosave-\"))\n+                    .sorted(Comparator.comparing(File::lastModified))\n+                    .collect(Collectors.toList());\n+\n+            // Delete older autosave files if needed\n+            int maxNumberAutosaves = this.userPreferences.getInt(MekHqConstants.MAXIMUM_NUMBER_SAVES_KEY,\n+                    MekHqConstants.DEFAULT_NUMBER_SAVES);\n+\n+            int index = 0;\n+            while (autosaveFiles.size() >= maxNumberAutosaves && autosaveFiles.size() > index) {\n+                if (autosaveFiles.get(index).delete()) {\n+                    autosaveFiles.remove(index);\n+                } else {\n+                    this.logger.error(this.getClass(), \"getAutosaveFilename\",\n+                            \"Unable to delete file \" + autosaveFiles.get(index).getName());\n+                    index++;\n+                }\n+            }\n \n-        // Find a unique name for this autosave\n-        String fileName = null;\n-\n-        boolean repeatedName = true;\n-        int index = 0;\n-        while (repeatedName) {\n-            fileName = String.format(\n-                    \"Autosave-%d-%s-%s.cpnx.gz\",\n-                    index++,\n-                    campaign.getName(),\n-                    campaign.getShortDateAsString());\n-\n-            repeatedName = false;\n-            for (File file : autosaveFiles) {\n-                if (file.getName().compareToIgnoreCase(fileName) == 0) {\n-                    repeatedName = true;\n-                    break;\n+            // Find a unique name for this autosave\n+            String fileName = null;\n+\n+            boolean repeatedName = true;\n+            index = 1;\n+            while (repeatedName) {\n+                fileName = String.format(\n+                        \"Autosave-%d-%s-%s.cpnx.gz\",\n+                        index++,\n+                        campaign.getName(),\n+                        campaign.getShortDateAsString());\n+\n+                repeatedName = false;\n+                for (File file : autosaveFiles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYwOTk1", "url": "https://github.com/MegaMek/mekhq/pull/1509#pullrequestreview-363060995", "createdAt": "2020-02-23T02:04:47Z", "commit": {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjg1NzAy", "url": "https://github.com/MegaMek/mekhq/pull/1509#pullrequestreview-363685702", "createdAt": "2020-02-24T20:41:15Z", "commit": {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4468, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}