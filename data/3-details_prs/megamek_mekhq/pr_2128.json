{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTEyMzkx", "number": 2128, "title": "Improve performance of searching for spare parts", "bodyText": "In large campaigns the number of spare parts is typically overwhelming (I've seen it as high as 100k). In many areas we go ahead and make a huge copy of the array, plus the iteration costs. This PR adds forEachSparePart to improve cases where we're just walking the collection. This PR also switches to streamSpareParts where appropriate. In both cases the number of allocations and iterations is markedly reduced.", "createdAt": "2020-10-07T20:56:31Z", "url": "https://github.com/MegaMek/mekhq/pull/2128", "merged": true, "mergeCommit": {"oid": "5fdde199ab8751f55d3820cd3c87efe48c2b9385"}, "closed": true, "closedAt": "2020-10-08T17:29:59Z", "author": {"login": "sixlettervariables"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQTPwnAH2gAyNDk5NTEyMzkxOjA0MDBhYWMxNzVjMjE5ZGMyZmI3M2VhMGE4ZGZiYmY0MjlhYWZmNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQYbi_AH2gAyNDk5NTEyMzkxOjRkZjM2YjNmMjY5ZmNjYTVmMzc4NTY3YmUwZTM1ZTE1M2Q5ZTkzNDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/0400aac175c219dc2fb73ea0a8dfbbf429aaff6e", "committedDate": "2020-10-07T20:45:26Z", "message": "Add forEachSparePart to improve performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzQ2Njkx", "url": "https://github.com/MegaMek/mekhq/pull/2128#pullrequestreview-504346691", "createdAt": "2020-10-08T00:01:52Z", "commit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowMTo1MlrOHeJmRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowMTo1MlrOHeJmRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4MQ==", "bodyText": "Was this supposed to be swapped over?", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501376581", "createdAt": "2020-10-08T00:01:52Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -552,6 +552,8 @@ public static void swapAmmoFromCompatible(Campaign campaign, int needed, AmmoSto\n         AmmoType aType;\n         AmmoType curType = (AmmoType)as.getType();\n         int converted = 0;\n+\n+        // TODO: make this less intensive.\n         for(Part part : campaign.getSpareParts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzQ4NDUy", "url": "https://github.com/MegaMek/mekhq/pull/2128#pullrequestreview-504348452", "createdAt": "2020-10-08T00:07:16Z", "commit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowNzoxNlrOHeJsFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowOTozNFrOHeJuUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODA2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            bestPartArmor = ((BaArmor)p).getAmount();\n          \n          \n            \n                                            bestPartArmor = ((BaArmor) p).getAmount();", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378069", "createdAt": "2020-10-08T00:07:16Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODM3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            currentPartArmor = ((BaArmor)p).getAmount();\n          \n          \n            \n                                            currentPartArmor = ((BaArmor) p).getAmount();", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378372", "createdAt": "2020-10-08T00:08:30Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODQ3Nw==", "bodyText": "Pre-existing, but I find it weird.", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378477", "createdAt": "2020-10-08T00:08:56Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                currentPartQuantity++;\n+                            }\n+                        }\n+                        if (currentPartQuantity > bestPartQuantity) {\n+                            return part;\n+                        } else if (currentPartArmor > bestPartArmor) {\n+                            return part;\n                         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    if (currentPartQuantity > bestPartQuantity) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    } else if (currentPartArmor > bestPartArmor) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    }\n          \n          \n            \n                                    if ((currentPartQuantity > bestPartQuantity) || (currentPartArmor > bestPartArmor)) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    }", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378642", "createdAt": "2020-10-08T00:09:34Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                currentPartQuantity++;\n+                            }\n+                        }\n+                        if (currentPartQuantity > bestPartQuantity) {\n+                            return part;\n+                        } else if (currentPartArmor > bestPartArmor) {\n+                            return part;\n                         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4df36b3f269fcca5f378567be0e35e153d9e9347", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/4df36b3f269fcca5f378567be0e35e153d9e9347", "committedDate": "2020-10-08T02:47:50Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4008, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}