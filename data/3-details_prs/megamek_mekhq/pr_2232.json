{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMjUxOTAx", "number": 2232, "title": "Issue #2231: Don't give back free parts when fixing a missing part", "bodyText": "When we reserved a part for overnight work, we would give back an extra part in two possible situations:\n\nThe work was for a missing part.\nThe work on a missing part failed, destroying the part.\n\nIn both of the cases the cause is simple: we were not checking if the part had any quantity left before finding a spare and incrementing its quantity.\nThis fixes #2231 by doing two things:\n\nNot manually finding spares when fixing/reserving and incrementing their quantities.\nOnly giving parts back to the Quartermaster if they have a non-zero quantity.\na. The Quartermaster class actually handles zero quantities, but this seemed like the more defensive solution.\n\nI've also added tests for the reservation logic in MissingPart.", "createdAt": "2020-11-15T20:09:31Z", "url": "https://github.com/MegaMek/mekhq/pull/2232", "merged": true, "mergeCommit": {"oid": "e39222d5d3c70dae51aaee34ecea7857629c6051"}, "closed": true, "closedAt": "2020-12-02T17:09:55Z", "author": {"login": "sixlettervariables"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdc2_E0gH2gAyNTIxMjUxOTAxOmFhNTllNDdlZTY3YTI3NmIzYTQxNWFiM2NiNzYxMjkxZmEyZDE1OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiGqPrAFqTU0MjQ4NjcwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa59e47ee67a276b3a415ab3cb761291fa2d1593", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/aa59e47ee67a276b3a415ab3cb761291fa2d1593", "committedDate": "2020-11-15T21:10:53Z", "message": "Only return non-zero quantities of parts, fixing #2231"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e07445c5e112f902589f521e5b6da283ce9809b", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/9e07445c5e112f902589f521e5b6da283ce9809b", "committedDate": "2020-11-15T21:10:53Z", "message": "Add tests covering #2231"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7faa89c6e3eeb8f51a4027fa0ad99878fc9cae96", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/7faa89c6e3eeb8f51a4027fa0ad99878fc9cae96", "committedDate": "2020-11-15T20:01:11Z", "message": "Add tests covering #2231"}, "afterCommit": {"oid": "9e07445c5e112f902589f521e5b6da283ce9809b", "author": {"user": {"login": "sixlettervariables", "name": "Christopher Watford"}}, "url": "https://github.com/MegaMek/mekhq/commit/9e07445c5e112f902589f521e5b6da283ce9809b", "committedDate": "2020-11-15T21:10:53Z", "message": "Add tests covering #2231"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDQxMDQw", "url": "https://github.com/MegaMek/mekhq/pull/2232#pullrequestreview-542441040", "createdAt": "2020-12-02T02:00:08Z", "commit": {"oid": "9e07445c5e112f902589f521e5b6da283ce9809b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMjowMDowOFrOH9HUpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMjowMDowOFrOH9HUpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg0NTE1Nw==", "bodyText": "Remind me, what's the second argument here?", "url": "https://github.com/MegaMek/mekhq/pull/2232#discussion_r533845157", "createdAt": "2020-12-02T02:00:08Z", "author": {"login": "NickAragua"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -419,18 +421,19 @@ public void reservePart() {\n \n     @Override\n     public void cancelReservation() {\n-        Part replacement = findReplacement(false);\n-        if (hasReplacementPart() && (null != replacement)) {\n-            setReplacementPart(null);\n-            replacement.setReservedBy(null);\n-            if (replacement.isSpare()) {\n-                Part spare = campaign.getWarehouse().checkForExistingSparePart(replacement);\n-                if (null != spare) {\n-                    spare.incrementQuantity();\n-                    campaign.getWarehouse().removePart(replacement);\n+        if (hasReplacementPart()) {\n+            Part replacement = getReplacementPart();\n+            if (replacement != null) {\n+                replacement.setReservedBy(null);\n+\n+                // Only return the replacement part to the campaign if we have one\n+                if (replacement.getQuantity() > 0) {\n+                    campaign.getQuartermaster().addPart(replacement, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e07445c5e112f902589f521e5b6da283ce9809b"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDg2NzA2", "url": "https://github.com/MegaMek/mekhq/pull/2232#pullrequestreview-542486706", "createdAt": "2020-12-02T04:16:14Z", "commit": {"oid": "9e07445c5e112f902589f521e5b6da283ce9809b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4146, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}