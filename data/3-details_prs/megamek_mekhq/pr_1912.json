{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MDk4Mzg0", "number": 1912, "title": "Parts availability indicator", "bodyText": "Two changes:\n\nDetailed reason why \"this part is not available to your unit\"\nCurrent 'parts availability' indicator for the campaign, displays next to temp medics/astechs and only displays if AtB is on\n\nFinally implements #399", "createdAt": "2020-08-09T02:38:33Z", "url": "https://github.com/MegaMek/mekhq/pull/1912", "merged": true, "mergeCommit": {"oid": "342c78ce0894031cb6c9c714a1f6e4df52707309"}, "closed": true, "closedAt": "2020-08-11T01:33:35Z", "author": {"login": "NickAragua"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9ERm_gH2gAyNDY1MDk4Mzg0OjFiM2IzZTgwZWM5ODkwZDBkMGY2ODFhZmFmNTAzYjhhOWM5MGRkZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9sloFgFqTQ2NDY5MDk5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b3b3e80ec9890d0d0f681afaf503b8a9c90ddd8", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/1b3b3e80ec9890d0d0f681afaf503b8a9c90ddd8", "committedDate": "2020-08-09T02:34:19Z", "message": "parts availability indicator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/78dbd3fb0d0c898f11240784decde68d6192ce48", "committedDate": "2020-08-09T02:34:43Z", "message": "merge from upstream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTI5NjIx", "url": "https://github.com/MegaMek/mekhq/pull/1912#pullrequestreview-463929621", "createdAt": "2020-08-10T02:07:43Z", "commit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjowNzo0M1rOG9_vFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjoxODoyNlrOG9_1AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDU2Ng==", "bodyText": "Why not just chain appends?", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660566", "createdAt": "2020-08-10T02:07:43Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5663,12 +5663,17 @@ public TargetRoll getTargetForAcquisition(IAcquisitionWork acquisition,\n                 et = ((MissingEquipmentPart) acquisition).getType();\n             }\n \n+            StringBuilder partAvailabilityLog = new StringBuilder();\n+            partAvailabilityLog.append(\"Part Rating Level: \" + partAvailability);\n+            partAvailabilityLog.append(\"(\" + EquipmentType.ratingNames[partAvailability] + \")\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {                        \n          \n          \n            \n                                if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660642", "createdAt": "2020-08-10T02:08:21Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5682,27 +5687,33 @@ public TargetRoll getTargetForAcquisition(IAcquisitionWork acquisition,\n                         && !(et instanceof megamek.common.weapons.flamers.FlamerWeapon)\n                         && partAvailability < EquipmentType.RATING_C) {\n                     partAvailability = EquipmentType.RATING_C;\n+                    partAvailabilityLog.append(\";(non-flamer lasers)\");\n                 }\n                 if (et instanceof megamek.common.weapons.autocannons.ACWeapon) {\n                     partAvailability -= 2;\n+                    partAvailabilityLog.append(\";(autocannon): -2\");\n                 }\n                 if (et instanceof megamek.common.weapons.gaussrifles.GaussWeapon\n                         || et instanceof megamek.common.weapons.flamers.FlamerWeapon) {\n                     partAvailability--;\n+                    partAvailabilityLog.append(\";(gauss rifle or flamer): -1\");\n                 }\n                 if (et instanceof megamek.common.AmmoType) {\n                     switch (((megamek.common.AmmoType) et).getAmmoType()) {\n                         case megamek.common.AmmoType.T_AC:\n                             partAvailability -= 2;\n+                            partAvailabilityLog.append(\";(autocannon ammo): -2\");\n                             break;\n                         case megamek.common.AmmoType.T_GAUSS:\n                             partAvailability -= 1;\n+                            partAvailabilityLog.append(\";(gauss ammo): -1\");\n+                            break;\n                     }\n-                    if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {\n+                    if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {                        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDgzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n          \n          \n            \n                    AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660834", "createdAt": "2020-08-10T02:09:53Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDkwNg==", "bodyText": "Very much just a suggestion, but one I find makes it easier to parse later.", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660906", "createdAt": "2020-08-10T02:10:14Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDgzNA=="}, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTUwNQ==", "bodyText": "This could be simplified and its performance can be boosted by swapping to an if statement checking hasActiveContract() followed by using getActiveContracts()", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661505", "createdAt": "2020-08-10T02:14:41Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTYyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (null != contract && contract.getStartDate().isBefore(currentDay)) {\n          \n          \n            \n                    if ((null != contract) && contract.getStartDate().isBefore(currentDay)) {", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661620", "createdAt": "2020-08-10T02:15:13Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n                 if (null == contract\n                         || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n                     contract = (AtBContract) m;\n                 }\n             }\n         }\n-        if (null != contract) {\n+        \n+        // if we have a contract and it has started\n+        if (null != contract && contract.getStartDate().isBefore(currentDay)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTY4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(adminLog != null) {\n          \n          \n            \n                        if (adminLog != null) {", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661683", "createdAt": "2020-08-10T02:15:31Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n                 if (null == contract\n                         || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n                     contract = (AtBContract) m;\n                 }\n             }\n         }\n-        if (null != contract) {\n+        \n+        // if we have a contract and it has started\n+        if (null != contract && contract.getStartDate().isBefore(currentDay)) {\n+            if (reportBuilder != null) {\n+                reportBuilder.append(contract.getPartsAvailabilityLevel() + \" (\" + contract.getType() +\")\");\n+            }\n             return contract.getPartsAvailabilityLevel();\n         }\n         /* If contract is still null, the unit is not in a contract. */\n         Person adminLog = findBestInRole(Person.T_ADMIN_LOG, SkillType.S_ADMIN);\n         int adminLogExp = (adminLog == null) ? SkillType.EXP_ULTRA_GREEN\n                 : adminLog.getSkill(SkillType.S_ADMIN).getExperienceLevel();\n-        return getUnitRatingMod() + adminLogExp - SkillType.EXP_REGULAR;\n+        int adminMod = adminLogExp - SkillType.EXP_REGULAR;\n+        \n+        if (reportBuilder != null) {\n+            reportBuilder.append(getUnitRatingMod() + \"(unit rating)\");\n+            if(adminLog != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTkyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!getCampaign().getCampaignOptions().getUseAtB()) {\n          \n          \n            \n                    if (!getCampaign().getCampaignOptions().getUseAtB()) {", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661922", "createdAt": "2020-08-10T02:17:22Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2586,6 +2590,16 @@ private void refreshTempMedics() {\n         String text = \"<html><b>Temp Medics:</b> \" + getCampaign().getMedicPool() + \"</html>\";\n         lblTempMedics.setText(text);\n     }\n+    \n+    private void refreshPartsAvailability() {\n+        if(!getCampaign().getCampaignOptions().getUseAtB()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTk1MA==", "bodyText": "Suggested change", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661950", "createdAt": "2020-08-10T02:17:35Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2662,7 +2680,18 @@ public void handle(MedicPoolChangedEvent ev) {\n     public void handleLocationChanged(LocationChangedEvent ev) {\n         refreshLocation();\n     }\n-\n+    \n+    @Subscribe\n+    public void handleMissionChanged(MissionEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    @Subscribe\n+    public void handleMissionChanged(PersonChangedEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA==", "bodyText": "This name doesn't make sense, did you mean to name it handlePersonChanged?\nAlso, why are we refreshing parts whenever any person is changed?", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467662080", "createdAt": "2020-08-10T02:18:26Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2662,7 +2680,18 @@ public void handle(MedicPoolChangedEvent ev) {\n     public void handleLocationChanged(LocationChangedEvent ev) {\n         refreshLocation();\n     }\n-\n+    \n+    @Subscribe\n+    public void handleMissionChanged(MissionEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    @Subscribe\n+    public void handleMissionChanged(PersonChangedEvent ev) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b13bd1d7a7f655d67b16c09b89bfe6dd3a2dfdda", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/b13bd1d7a7f655d67b16c09b89bfe6dd3a2dfdda", "committedDate": "2020-08-10T04:11:17Z", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c21dd8fc551092849fca7a3cc1d07f6f2a391ce", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/3c21dd8fc551092849fca7a3cc1d07f6f2a391ce", "committedDate": "2020-08-10T04:12:52Z", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca51b0d21435ed8ab0fefbd767a1670053b1309f", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/ca51b0d21435ed8ab0fefbd767a1670053b1309f", "committedDate": "2020-08-10T04:12:59Z", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6feb6efe80404fb7ac2e5da175200daef2293c84", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/6feb6efe80404fb7ac2e5da175200daef2293c84", "committedDate": "2020-08-10T04:13:07Z", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c25bbbbdb29f5bc836032d8d9b5ae5d0989fe61e", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/c25bbbbdb29f5bc836032d8d9b5ae5d0989fe61e", "committedDate": "2020-08-10T04:13:16Z", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c63151ed2f60fcff32effd5e62bbd666aeb7455", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/4c63151ed2f60fcff32effd5e62bbd666aeb7455", "committedDate": "2020-08-10T04:13:24Z", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495c75be6592aac424b20447e423d95468796252", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/495c75be6592aac424b20447e423d95468796252", "committedDate": "2020-08-10T04:41:27Z", "message": "performance improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/c2d55d9939e019ec8c0edbd22d39d539c80ff677", "committedDate": "2020-08-10T04:48:15Z", "message": "fix npe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "committedDate": "2020-08-10T04:56:29Z", "message": "update parts availability on contract start"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTU3Mjk0", "url": "https://github.com/MegaMek/mekhq/pull/1912#pullrequestreview-463957294", "createdAt": "2020-08-10T04:56:37Z", "commit": {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNDo1NjozN1rOG-BZVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNTowMDowNFrOG-Bbyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4Nzc2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (c instanceof AtBContract && \n          \n          \n            \n                            if ((c instanceof AtBContract) &&", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687766", "createdAt": "2020-08-10T04:56:37Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,15 +5762,18 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {\n+            for (Contract c : getActiveContracts()) {\n+                if (c instanceof AtBContract && ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4NzgwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    (contract == null || \n          \n          \n            \n                                    ((contract == null) ||", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687804", "createdAt": "2020-08-10T04:56:48Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,15 +5762,18 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {\n+            for (Contract c : getActiveContracts()) {\n+                if (c instanceof AtBContract && \n+                        c.getStartDate().isBefore(currentDay) && \n+                        (contract == null || ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4Nzg2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {\n          \n          \n            \n                    if (ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687860", "createdAt": "2020-08-10T04:57:04Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2687,8 +2687,12 @@ public void handleMissionChanged(MissionEvent ev) {\n     }\n     \n     @Subscribe\n-    public void handleMissionChanged(PersonChangedEvent ev) {\n-        refreshPartsAvailability();\n+    public void handlePersonUpdate(PersonEvent ev) {\n+        // only bother recalculating AtB parts availability if a logistics admin has been changed\n+        // refreshPartsAvailability cuts out early with a \"use AtB\" check so it's not necessary here\n+        if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4ODIwMw==", "bodyText": "Isn't there an option to determine which type of personnel does this?", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467688203", "createdAt": "2020-08-10T04:59:06Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2687,8 +2687,12 @@ public void handleMissionChanged(MissionEvent ev) {\n     }\n     \n     @Subscribe\n-    public void handleMissionChanged(PersonChangedEvent ev) {\n-        refreshPartsAvailability();\n+    public void handlePersonUpdate(PersonEvent ev) {\n+        // only bother recalculating AtB parts availability if a logistics admin has been changed\n+        // refreshPartsAvailability cuts out early with a \"use AtB\" check so it's not necessary here\n+        if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {\n+            refreshPartsAvailability();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4ODM5NQ==", "bodyText": "contact == null should be impossible for hasActiveContact, otherwise it is a bug in hasActiveContact.", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467688395", "createdAt": "2020-08-10T05:00:04Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,26 +5762,30 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b822780f2db06e4dd62d6fdfd78f263e66f18a76", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/b822780f2db06e4dd62d6fdfd78f263e66f18a76", "committedDate": "2020-08-10T14:43:40Z", "message": "code review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e3fbf36f5c2327a8b4d880660157d483c41a9c", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/34e3fbf36f5c2327a8b4d880660157d483c41a9c", "committedDate": "2020-08-10T14:44:03Z", "message": "merge from upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0660141d6b7cd3266767b4479a126f75326e7536", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/0660141d6b7cd3266767b4479a126f75326e7536", "committedDate": "2020-08-11T01:10:41Z", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Njg1MTcx", "url": "https://github.com/MegaMek/mekhq/pull/1912#pullrequestreview-464685171", "createdAt": "2020-08-11T01:13:35Z", "commit": {"oid": "0660141d6b7cd3266767b4479a126f75326e7536"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMToxMzozNlrOG-k82A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMToxNjoyOFrOG-k_5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MDI5Ng==", "bodyText": "These three are all cancelled out by the getActiveContracts, which only returns those whose date is active.", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468270296", "createdAt": "2020-08-11T01:13:36Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5734,19 +5734,19 @@ public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBui\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        if (hasActiveContract() && (contract == null)) {\n+        if (hasActiveContract()) {\n             for (Contract c : getActiveContracts()) {\n-                if (c instanceof AtBContract && \n-                        c.getStartDate().isBefore(currentDay) && \n-                        (contract == null || \n+                if ((c instanceof AtBContract) && \n+                        (c.getStartDate().isBefore(currentDay) || c.getStartDate().equals(currentDay)) && \n+                        ((contract == null) || ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0660141d6b7cd3266767b4479a126f75326e7536"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTA3OA==", "bodyText": "The getStartDate stuff is not required because of the use of getActiveContracts. Additionally, currentDay should never be directly used outside of the increase day.", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468271078", "createdAt": "2020-08-11T01:16:28Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5734,19 +5734,19 @@ public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBui\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        if (hasActiveContract() && (contract == null)) {\n+        if (hasActiveContract()) {\n             for (Contract c : getActiveContracts()) {\n-                if (c instanceof AtBContract && \n-                        c.getStartDate().isBefore(currentDay) && \n-                        (contract == null || \n+                if ((c instanceof AtBContract) && \n+                        (c.getStartDate().isBefore(currentDay) || c.getStartDate().equals(currentDay)) && \n+                        ((contract == null) || \n                         (((AtBContract) c).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()))) {\n                     contract = (AtBContract) c;\n                 }\n             }\n         }\n         \n         // if we have a contract and it has started\n-        if ((null != contract) && contract.getStartDate().isBefore(currentDay)) {\n+        if ((null != contract) && (contract.getStartDate().isBefore(currentDay) || contract.getStartDate().equals(currentDay))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0660141d6b7cd3266767b4479a126f75326e7536"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce59b5cbe34bda87a84c1e877861e913826eeb1", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/9ce59b5cbe34bda87a84c1e877861e913826eeb1", "committedDate": "2020-08-11T01:21:51Z", "message": "replaced field usage with property"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d31adf60d8b843be61c2672d13529d4936f6dd5c", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/d31adf60d8b843be61c2672d13529d4936f6dd5c", "committedDate": "2020-08-11T01:22:21Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27a8099ef1f3d747d09a1ae503fac20d61b89b36", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/27a8099ef1f3d747d09a1ae503fac20d61b89b36", "committedDate": "2020-08-11T01:25:07Z", "message": "simplify date comparisons"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjkwNTQ3", "url": "https://github.com/MegaMek/mekhq/pull/1912#pullrequestreview-464690547", "createdAt": "2020-08-11T01:30:57Z", "commit": {"oid": "27a8099ef1f3d747d09a1ae503fac20d61b89b36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMTozMDo1N1rOG-lQbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMTozMDo1N1rOG-lQbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3NTMwOQ==", "bodyText": "This is still superfluous.", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468275309", "createdAt": "2020-08-11T01:30:57Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5713,28 +5727,48 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract()) {\n+            for (Contract c : getActiveContracts()) {\n+                if ((c instanceof AtBContract) && \n+                        getLocalDate().isBefore(c.getStartDate()) && ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27a8099ef1f3d747d09a1ae503fac20d61b89b36"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "484fa063cd856bce9bef7f9de2227b09f9f2158b", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/mekhq/commit/484fa063cd856bce9bef7f9de2227b09f9f2158b", "committedDate": "2020-08-11T01:31:33Z", "message": "simplify date comparisons 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjkwOTk5", "url": "https://github.com/MegaMek/mekhq/pull/1912#pullrequestreview-464690999", "createdAt": "2020-08-11T01:32:23Z", "commit": {"oid": "484fa063cd856bce9bef7f9de2227b09f9f2158b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4165, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}