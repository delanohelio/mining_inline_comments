{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODczNjk1", "number": 1756, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNDoxNTo0MlrOD90Xiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTozNDo1NlrOD98aHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MTQ3NzIzOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNDoxNTo0MlrOGXig5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNDoxNTo0MlrOGXig5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMzNTkwOA==", "bodyText": "After building a list of all eligible weapons, you're still picking randomly from all weapons.", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427335908", "createdAt": "2020-05-19T14:15:42Z", "author": {"login": "neoancient"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,7 +221,16 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n         int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n         return entity.getIndividualWeaponList().get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fdee679305faf54d7ae757432a077d022d9cff1"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Mjc5NDU0OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTozNDo1NlrOGXvpAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDo1MjoyMVrOGYdYeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ==", "bodyText": "What happens if the entity doesn't have any eligible weapons?", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427550979", "createdAt": "2020-05-19T19:34:56Z", "author": {"login": "neoancient"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MTYyMQ==", "bodyText": "Array out of bounds exception, probably. I'll add some more defensive coding when I get back to it tonight.", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427551621", "createdAt": "2020-05-19T19:36:09Z", "author": {"login": "NickAragua"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MDg4OA==", "bodyText": "Fixed. I suppose I could have it re-roll in that case, but it's a lot more work and I don't think anybody's going to complain about bot unit crews having a tiny amount less SPAs.", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427670888", "createdAt": "2020-05-20T00:13:35Z", "author": {"login": "NickAragua"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2NDUwNQ==", "bodyText": "Does this have the effect of giving the crew the SPA, but making it ineffective because it doesn't match any weapon?", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428264505", "createdAt": "2020-05-20T19:42:28Z", "author": {"login": "neoancient"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2Nzg3MQ==", "bodyText": "Basically. I suppose a better solution would be to have the calling function check whether this method returned anything and avoid adding the SPA in that case.", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428267871", "createdAt": "2020-05-20T19:49:05Z", "author": {"login": "NickAragua"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwMDQwOQ==", "bodyText": "It's functional as is, but probably clearer without the non-functional SPA.", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428300409", "createdAt": "2020-05-20T20:52:21Z", "author": {"login": "neoancient"}, "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, "originalCommit": {"oid": "91581dd492d8322912c3f470cf317432d3502a95"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2308, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}