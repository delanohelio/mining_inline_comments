{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTEyMzkx", "number": 2128, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowMTo1MlrOErZk2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowOTozNFrOErZqNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzOTQzMjU2OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowMTo1MlrOHeJmRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDoyMjoxMVrOHeJ7XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4MQ==", "bodyText": "Was this supposed to be swapped over?", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501376581", "createdAt": "2020-10-08T00:01:52Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -552,6 +552,8 @@ public static void swapAmmoFromCompatible(Campaign campaign, int needed, AmmoSto\n         AmmoType aType;\n         AmmoType curType = (AmmoType)as.getType();\n         int converted = 0;\n+\n+        // TODO: make this less intensive.\n         for(Part part : campaign.getSpareParts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MTk4MQ==", "bodyText": "No it has side effects and needs a different solution.", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501381981", "createdAt": "2020-10-08T00:22:11Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -552,6 +552,8 @@ public static void swapAmmoFromCompatible(Campaign campaign, int needed, AmmoSto\n         AmmoType aType;\n         AmmoType curType = (AmmoType)as.getType();\n         int converted = 0;\n+\n+        // TODO: make this less intensive.\n         for(Part part : campaign.getSpareParts()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NjU4MQ=="}, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzOTQ0MjQ3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowNzoxNlrOHeJsFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowNzoxNlrOHeJsFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODA2OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            bestPartArmor = ((BaArmor)p).getAmount();\n          \n          \n            \n                                            bestPartArmor = ((BaArmor) p).getAmount();", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378069", "createdAt": "2020-10-08T00:07:16Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzOTQ0NDQ3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowODozMFrOHeJtRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowODozMFrOHeJtRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODM3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            currentPartArmor = ((BaArmor)p).getAmount();\n          \n          \n            \n                                            currentPartArmor = ((BaArmor) p).getAmount();", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378372", "createdAt": "2020-10-08T00:08:30Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzOTQ0NTE3OnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowODo1NlrOHeJtrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMjo0NzowOFrOHeMD_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODQ3Nw==", "bodyText": "Pre-existing, but I find it weird.", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378477", "createdAt": "2020-10-08T00:08:56Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                currentPartQuantity++;\n+                            }\n+                        }\n+                        if (currentPartQuantity > bestPartQuantity) {\n+                            return part;\n+                        } else if (currentPartArmor > bestPartArmor) {\n+                            return part;\n                         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQxNjk1OQ==", "bodyText": "Yeah I haven't dug into the why for some of these.", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501416959", "createdAt": "2020-10-08T02:47:08Z", "author": {"login": "sixlettervariables"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                currentPartQuantity++;\n+                            }\n+                        }\n+                        if (currentPartQuantity > bestPartQuantity) {\n+                            return part;\n+                        } else if (currentPartArmor > bestPartArmor) {\n+                            return part;\n                         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODQ3Nw=="}, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzOTQ0NjMxOnYy", "diffSide": "RIGHT", "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowOTozNFrOHeJuUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDowOTozNFrOHeJuUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3ODY0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    if (currentPartQuantity > bestPartQuantity) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    } else if (currentPartArmor > bestPartArmor) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    }\n          \n          \n            \n                                    if ((currentPartQuantity > bestPartQuantity) || (currentPartArmor > bestPartArmor)) {\n          \n          \n            \n                                        return part;\n          \n          \n            \n                                    }", "url": "https://github.com/MegaMek/mekhq/pull/2128#discussion_r501378642", "createdAt": "2020-10-08T00:09:34Z", "author": {"login": "Windchild292"}, "path": "MekHQ/src/mekhq/campaign/parts/MissingBattleArmorSuit.java", "diffHunk": "@@ -306,49 +306,45 @@ public String getDetails(boolean includeRepairDetails) {\n \n     @Override\n     public Part findReplacement(boolean refit) {\n-        Part bestPart = null;\n-\n         //check to see if we already have a replacement assigned\n         if (hasReplacementPart()) {\n             return getReplacementPart();\n         }\n         // don't just return with the first part if it is damaged\n-        for(Part part : campaign.getSpareParts()) {\n-            if(part.isReservedForRefit() || part.isBeingWorkedOn() || part.isReservedForReplacement() || !part.isPresent() || part.hasParentPart()) {\n-                continue;\n-            }\n-\n-            if(isAcceptableReplacement(part, refit)) {\n-                if(null == bestPart) {\n-                    bestPart = part;\n-                } else {\n-                    int bestPartArmor = 0;\n-                    int currentPartArmor = 0;\n-                    int bestPartQuantity = 0;\n-                    int currentPartQuantity = 0;\n-                    for (Part p : bestPart.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            bestPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            bestPartQuantity++;\n+        return campaign.streamSpareParts()\n+            .filter(MissingPart::isAvailableAsReplacement)\n+            .reduce(null, (bestPart, part) -> {\n+                if (isAcceptableReplacement(part, refit)) {\n+                    if (bestPart == null) {\n+                        return part;\n+                    } else {\n+                        int bestPartArmor = 0;\n+                        int currentPartArmor = 0;\n+                        int bestPartQuantity = 0;\n+                        int currentPartQuantity = 0;\n+                        for (Part p : bestPart.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                bestPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                bestPartQuantity++;\n+                            }\n                         }\n-                    }\n-                    for (Part p : part.getChildParts()) {\n-                        if (p instanceof BaArmor) {\n-                            currentPartArmor = ((BaArmor)p).getAmount();\n-                        } else {\n-                            currentPartQuantity++;\n+                        for (Part p : part.getChildParts()) {\n+                            if (p instanceof BaArmor) {\n+                                currentPartArmor = ((BaArmor)p).getAmount();\n+                            } else {\n+                                currentPartQuantity++;\n+                            }\n+                        }\n+                        if (currentPartQuantity > bestPartQuantity) {\n+                            return part;\n+                        } else if (currentPartArmor > bestPartArmor) {\n+                            return part;\n                         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0400aac175c219dc2fb73ea0a8dfbbf429aaff6e"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2038, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}