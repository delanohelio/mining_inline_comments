{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4OTQzODM3", "number": 440, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoxODo0NlrOEq_yJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MjoyOVrOErSerQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTIwNjc5OnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoxODo0NlrOHdhLuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoxODo0NlrOHdhLuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNDQyNw==", "bodyText": "The documentation in rest.li should be generic, because this is open source. So, for instance, instead of \"It will be a combination of hostname and instanceId\" say something like \"For example, it can be a combination of the hostname and an instance identifier\".", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500714427", "createdAt": "2020-10-07T03:18:46Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/ResponseValidationMetricsHeader.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.linkedin.darkcluster.api;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+\n+/**\n+ * This represents the response validation metrics sent to dark clusters in the form of a request header\n+ * This header stores two fields:\n+ * 1) source: uniquely identifying the instance of the application running on a dispatcher. It will be a combination of hostname and instanceId (i000, i001...)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfab0a776f576e8ca77bd000b555667f1f762583"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTIxNDQ5OnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoyMzo1NFrOHdhQOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoyMzo1NFrOHdhQOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNTU3Nw==", "bodyText": "move this to the api package and directory.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500715577", "createdAt": "2020-10-07T03:23:54Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterConstants.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.linkedin.darkcluster.impl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfab0a776f576e8ca77bd000b555667f1f762583"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTIxODgwOnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoyNjozNFrOHdhSuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzoyNjozNFrOHdhSuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxNjIxOQ==", "bodyText": "can you try to add an argument to the rewriteRequest to add the header(s)? Otherwise we are producing intermediate garbage by creating the request and then throwing it away after copying it to create another request.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r500716219", "createdAt": "2020-10-07T03:26:34Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkClusterManagerImpl.java", "diffHunk": "@@ -102,9 +128,10 @@ public boolean handleDarkRequest(RestRequest originalRequest, RequestContext ori\n         for (String darkClusterName : configMap.keySet())\n         {\n           RestRequest newD2Request = rewriteRequest(reqCopy, darkClusterName);\n+          RestRequest d2RequestWithHeaders = addDarkRequestHeaders(darkClusterName, newD2Request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfab0a776f576e8ca77bd000b555667f1f762583"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODI0NTMwOnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozNTo1OFrOHd-Tog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozNTo1OFrOHd-Tog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MTU4Ng==", "bodyText": "this is good, but lets also add a sentence saying why this is a useful feature to have. Something like:\n\"This allows response comparison metrics about a dark cluster to be displayed (via a monitoring/graphing system) with all other system metrics in a dark cluster host. These response comparison metrics are not specific to this dark cluster host, but that should be sufficient for most cases, and further granularity can be achieved by having separate dark clusters.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501191586", "createdAt": "2020-10-07T17:35:58Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/api/DarkClusterResponseValidationMetricsCollector.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.linkedin.darkcluster.api;\n+\n+import java.util.Map;\n+\n+/**\n+ * Collector of incoming response validation metrics from dispatchers.\n+ * This is meant to be called on the dark cluster hosts where the request headers containing response validation metrics are read.\n+ * A dark cluster host may receive metrics from multiple dispatchers and this interface defines method for collecting these\n+ * incoming metrics.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODI1NzIxOnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozOToxNFrOHd-bRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozOToxNFrOHd-bRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MzU0Mg==", "bodyText": "check for null in the constructor. If null,  have a no-op/default implementation, so you don't need to check for null later. or, if appropriate, add the Nonnull annotations.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501193542", "createdAt": "2020-10-07T17:39:14Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/filter/DarkClusterResponseValidationMetricsReaderFilter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.linkedin.darkcluster.filter;\n+\n+import com.linkedin.darkcluster.api.DarkClusterResponseValidationMetricsCollector;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import com.linkedin.darkcluster.api.DarkClusterConstants;\n+import com.linkedin.r2.filter.NextFilter;\n+import com.linkedin.r2.filter.message.rest.RestFilter;\n+import com.linkedin.r2.message.RequestContext;\n+import com.linkedin.r2.message.rest.RestRequest;\n+import com.linkedin.r2.message.rest.RestResponse;\n+import java.util.Map;\n+import java.util.concurrent.ExecutorService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A filter that is to be enabled only in a dark cluster that is meant to handle response validation metrics\n+ * sent from source\n+ */\n+public class DarkClusterResponseValidationMetricsReaderFilter implements RestFilter {\n+  private final DarkClusterResponseValidationMetricsCollector _metricsCollector;\n+  private final ExecutorService _executorService;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkClusterResponseValidationMetricsReaderFilter.class);\n+\n+  public DarkClusterResponseValidationMetricsReaderFilter(\n+      DarkClusterResponseValidationMetricsCollector metricsCollector,\n+      ExecutorService executorService) {\n+    _metricsCollector = metricsCollector;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODI2MzUwOnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MDo1MFrOHd-fLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MDo1MFrOHd-fLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NDU0MA==", "bodyText": "same here, maybe add Nonnull annotation?", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501194540", "createdAt": "2020-10-07T17:40:50Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseMetricsHeaderGenerator.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.linkedin.darkcluster.api.DarkClusterConstants;\n+import com.linkedin.darkcluster.api.DarkRequestHeaderGenerator;\n+import com.linkedin.darkcluster.api.DispatcherResponseValidationMetricsHolder;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Impl of {@link DarkRequestHeaderGenerator} for generating headers for dark cluster response validation metrics.\n+ * The header value consists of the serialized form of the validation metrics which the dark cluster can consume.\n+ */\n+public class DarkResponseMetricsHeaderGenerator implements DarkRequestHeaderGenerator {\n+  private final DispatcherResponseValidationMetricsHolder _metricsHolder;\n+  private final Supplier<String> _sourceSupplier;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkRequestHeaderGenerator.class);\n+\n+  /**\n+   * @param metricsHolder  impl of {@link DispatcherResponseValidationMetricsHolder} to return the metrics aggregated so far\n+   *                       in the dispatcher\n+   * @param sourceSupplier a supplier of source identifier that can uniquely identify a dispatcher instance sending out\n+   *                       validation metrics\n+   */\n+  public DarkResponseMetricsHeaderGenerator(DispatcherResponseValidationMetricsHolder metricsHolder,\n+      Supplier<String> sourceSupplier) {\n+    _metricsHolder = metricsHolder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODI2NTk4OnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MTozMFrOHd-gsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MTozMFrOHd-gsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NDkzMA==", "bodyText": "nonnull on clock.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501194930", "createdAt": "2020-10-07T17:41:30Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DarkResponseValidationMetricsCollectorImpl.java", "diffHunk": "@@ -0,0 +1,228 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.darkcluster.api.DarkClusterResponseValidationMetricsCollector;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import com.linkedin.util.clock.Clock;\n+\n+\n+/**\n+ * This is executed on dark cluster where it collects metrics from multiple sources by maintaining an in-memory map of sources to metrics.\n+ * It has two responsibilities:\n+ * 1. Populate the in-memory map with the metrics from incoming request headers. This will be an async call where multiple\n+ * threads may try to aggregate metrics as and when there are incoming dark requests. This ensures that we do not double\n+ * count metrics from the same source.\n+ * 2. A single threaded getter to retrieve the aggregated metrics from across all sources. This is single threaded to ensure\n+ * that the consumer of metrics is always called synchronously so that the consumer receives metrics that are increasing\n+ * monotonically. This is all the more important if the consumer emits ingraph metrics (most consumers use this to emit to ingraphs)\n+ * as counters where counters are meant to be increasing monotonically.\n+ */\n+public class DarkResponseValidationMetricsCollectorImpl implements DarkClusterResponseValidationMetricsCollector {\n+  /**\n+   * this is a a map of source -> metrics where metrics is a map of metric name -> metric value\n+   * Example: host1 -> ((success_count -> 10, failure_count -> 1), 12345L)\n+   */\n+  private final Map<String, Long> _defaultBucketMetrics = new ConcurrentHashMap<>();\n+  private final Map<String, Lock> _sourceLockMap = new ConcurrentHashMap<>();\n+  private final Map<String, MetricsInternal> _internalMetricsMap = new ConcurrentHashMap<>();\n+  private final Object _defaultBucketLock = new Object();\n+  private final Clock _clock;\n+  private final long _collectionFrequencyInMillis;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DarkResponseValidationMetricsCollectorImpl.class);\n+\n+  public DarkResponseValidationMetricsCollectorImpl(Clock clock, long collectionFrequencyInMillis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODI2OTg5OnYy", "diffSide": "RIGHT", "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MjoyOVrOHd-jDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo0MjoyOVrOHd-jDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NTUzNQ==", "bodyText": "ditto.", "url": "https://github.com/linkedin/rest.li/pull/440#discussion_r501195535", "createdAt": "2020-10-07T17:42:29Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/DispatcherResponseValidationMetricsHolderImpl.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.darkcluster.api.DispatcherResponseValidationMetricsHolder;\n+import com.linkedin.darkcluster.api.ResponseValidationMetricsHeader;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.LongAdder;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import com.linkedin.util.clock.Clock;\n+\n+\n+/**\n+ * Impl of {@link DispatcherResponseValidationMetricsHolder} which uses in-memory map to store response validation metrics for each\n+ * dark cluster. These metrics are essentially counters which are added up as and when response validation is done.\n+ * This is an object that lives through the course of application's life cycle, incrementing validation metrics over time.\n+ */\n+public class DispatcherResponseValidationMetricsHolderImpl implements DispatcherResponseValidationMetricsHolder {\n+  /**\n+   * this is a a map of dark cluster -> metrics where metrics is a map of metric name -> metric value\n+   * Example: dark_cluster1 -> (success_count -> 10, failure_count -> 1)\n+   */\n+  private final ConcurrentMap<String, ConcurrentMap<String, LongAdder>> _darkClusterToMetricsMap = new ConcurrentHashMap<>();\n+  private final Clock _clock;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DispatcherResponseValidationMetricsHolderImpl.class);\n+\n+  public DispatcherResponseValidationMetricsHolderImpl(Clock clock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943d1b60fc4a2c655863a81c4d5eb06ba83effc"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 385, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}