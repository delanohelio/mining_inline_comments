{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3ODc2OTQw", "number": 383, "title": "Treat ReadOnly fields as optional in PU patches", "bodyText": "This fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input.\nNOTE: This PR is incomplete, as I still need to add integration tests.", "createdAt": "2020-08-14T09:24:57Z", "url": "https://github.com/linkedin/rest.li/pull/383", "merged": true, "mergeCommit": {"oid": "a289a3dc755a3a24acc3a2c03ec73dd65d39c598"}, "closed": true, "closedAt": "2020-08-18T03:18:43Z", "author": {"login": "evanw555"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-6TdSAFqTQ2Nzg0NTQ4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_8FcvAFqTQ2ODkxOTM2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODQ1NDgy", "url": "https://github.com/linkedin/rest.li/pull/383#pullrequestreview-467845482", "createdAt": "2020-08-14T20:05:08Z", "commit": {"oid": "33e852c7410ea476609d8d6603a337cb260201dc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33e852c7410ea476609d8d6603a337cb260201dc", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/33e852c7410ea476609d8d6603a337cb260201dc", "committedDate": "2020-08-14T09:15:13Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}, "afterCommit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/f7720b0802d13ff045e8b0b6bb4f00e1f01020d9", "committedDate": "2020-08-15T02:02:30Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTM5Mzgy", "url": "https://github.com/linkedin/rest.li/pull/383#pullrequestreview-467939382", "createdAt": "2020-08-15T02:05:58Z", "commit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTUxMTQy", "url": "https://github.com/linkedin/rest.li/pull/383#pullrequestreview-467951142", "createdAt": "2020-08-15T06:09:12Z", "commit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwNjowOToxMlrOHBIHOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwNjoxNDo0NFrOHBII2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0MzU0Nw==", "bodyText": "I think what the original comment was trying to say is: \"Partial update is not supported on arrays, as we always replace the entire array\".\nSo in the patch, the entire array record has to be present (full update).\nThis is not true for other complex types or Maps.  So the original comment is correct and this issue is specific to arrays.\nSo in partial update, the required createOnly fields must be present (it must be treated as update, so for existing items they should've been present in original and for new items they behave like create) and readonly fields should be treated as optional (can be present for items being updated and can be absent for new array items)\nFor Maps/other complex types, patch is supported, so if the operation is $set, then they should be treated as CREATE (ie, CreateOnly fields are required, ReadOnly fields should not be present).", "url": "https://github.com/linkedin/rest.li/pull/383#discussion_r470943547", "createdAt": "2020-08-15T06:09:12Z", "author": {"login": "karthikbalasub"}, "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataValidator.java", "diffHunk": "@@ -464,15 +464,15 @@ protected ValidationResult validateOutputAgainstSchema(RecordTemplate dataTempla\n    * Checks that if the patch is applied to a valid entity, the modified entity will also be valid.\n    * This method\n    * (1) Checks that required/ReadOnly/CreateOnly fields are not deleted.\n-   * (2) Checks that new values for record templates contain all required fields.\n+   * (2) Checks that new values for record templates contain all required fields (treating ReadOnly fields as optional).\n    * (3) Applies the patch to an empty entity and validates the entity for custom validation rules\n    * and Rest.li annotations (Allows required fields to be absent by using {@link RequiredMode#IGNORE},\n    * because a patch does not necessarily contain all fields).\n    *\n-   * NOTE: Updating a part of an array is not supported. So if the array contains a required field that is\n-   * readonly or createonly, the field cannot be present (no partial updates on readonly/createonly)\n-   * but cannot be absent either (no missing required fields). This means the array cannot be changed by a\n-   * partial update request. This is something that should be fixed.\n+   * NOTE: Updating a part of an array or other complex object is not supported if the object contains a required field\n+   * that is CreateOnly. In this case, the field cannot be present (no partial updates on CreateOnly fields), but cannot\n+   * be absent either (no missing required fields).\n+   * TODO: This is something that should be fixed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0Mzk2MQ==", "bodyText": "This should be done only for $set on array fields, see my comment above.", "url": "https://github.com/linkedin/rest.li/pull/383#discussion_r470943961", "createdAt": "2020-08-15T06:14:44Z", "author": {"login": "karthikbalasub"}, "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataValidator.java", "diffHunk": "@@ -534,7 +540,9 @@ private ValidationResult checkNewRecordsAreNotMissingFields(RecordTemplate entit\n         // Replace $set with the field name to get the full path\n         path[path.length - 1] = message.getFormat();\n         DataElement element = DataElementUtil.element(new SimpleDataElement(entity.data(), entity.schema()), path);\n-        ValidationResult result = ValidateDataAgainstSchema.validate(element, new ValidationOptions());\n+        ValidationOptions validationOptions = new ValidationOptions();\n+        validationOptions.setTreatOptional(_readOnlyOptionalPredicate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7720b0802d13ff045e8b0b6bb4f00e1f01020d9", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/f7720b0802d13ff045e8b0b6bb4f00e1f01020d9", "committedDate": "2020-08-15T02:02:30Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}, "afterCommit": {"oid": "2a30c60530362666df81a5a95d515b10b770f730", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/2a30c60530362666df81a5a95d515b10b770f730", "committedDate": "2020-08-15T07:11:27Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec972d88d29db224c8d6f41c43a986717f9278e1", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/ec972d88d29db224c8d6f41c43a986717f9278e1", "committedDate": "2020-08-18T00:28:44Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "834dd7c05b15f3023fb8b78949150475e89adfcd", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/834dd7c05b15f3023fb8b78949150475e89adfcd", "committedDate": "2020-08-18T00:24:41Z", "message": "Update comment to reflect next steps"}, "afterCommit": {"oid": "ec972d88d29db224c8d6f41c43a986717f9278e1", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/ec972d88d29db224c8d6f41c43a986717f9278e1", "committedDate": "2020-08-18T00:28:44Z", "message": "Treat ReadOnly fields as optional in PU patches\n\nThis fix treats ReadOnly required fields as optional when validating\n(BATCH)PARTIAL_UPDATE patch inputs. Without this fix, users were unable\nto perform patch set operations on record fields where the record\ncontains a ReadOnly field. Were the field included, it would fail\nReadOnly validation; were it omitted, it would fail since it's required.\nWith this fix, users can omit the field from the patch input."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTE5MzY5", "url": "https://github.com/linkedin/rest.li/pull/383#pullrequestreview-468919369", "createdAt": "2020-08-18T00:43:34Z", "commit": {"oid": "ec972d88d29db224c8d6f41c43a986717f9278e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4621, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}