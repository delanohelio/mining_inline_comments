{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyODk5MzAz", "number": 444, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDoxNDoyOFrOEtRLCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNToyMTowMFrOEuDGAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1OTAyNzI4OnYy", "diffSide": "RIGHT", "path": "data/src/main/java/com/linkedin/data/Data.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDoxNDoyOFrOHg9wqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0NjowOVrOHg-SQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyODM2MQ==", "bodyText": "1\nPreviously it didn't handle the orderedEntrySet is null case, is this condition handling here a bug fix?\n2\nAnd line 490's callback.orderMap(map); is getting the map's entrySet internally and return orderedEntrySet.\nBut here I see we are using map.forEach... is it actually going to do anything in the case that there is no entries?", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504328361", "createdAt": "2020-10-14T00:14:28Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -491,11 +488,49 @@ private static void traverse(Object obj, TraverseCallback callback, CycleChecker\n             cycleChecker.startMap(map);\n             callback.startMap(map);\n             Iterable<Map.Entry<String, Object>> orderedEntrySet = callback.orderMap(map);\n-            for (Map.Entry<String, Object> entry : orderedEntrySet)\n+\n+            //\n+            // If the ordered entry set is null, use Java 8 forEach to avoid intermediary object\n+            // creation for better performance.\n+            //\n+            if (orderedEntrySet == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNDg5NA==", "bodyText": "Not a bug fix. I changed the contract to return null if we were ok with the map's natural ordering. This enables faster iteration on the map and lesser garbage since we can directly use forEach. It is backward compatible as well.\n\n\norderMap will return an ordered iterable if it cares about order, else null. We will process it accordingly.", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504334894", "createdAt": "2020-10-14T00:38:27Z", "author": {"login": "karthikrg"}, "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -491,11 +488,49 @@ private static void traverse(Object obj, TraverseCallback callback, CycleChecker\n             cycleChecker.startMap(map);\n             callback.startMap(map);\n             Iterable<Map.Entry<String, Object>> orderedEntrySet = callback.orderMap(map);\n-            for (Map.Entry<String, Object> entry : orderedEntrySet)\n+\n+            //\n+            // If the ordered entry set is null, use Java 8 forEach to avoid intermediary object\n+            // creation for better performance.\n+            //\n+            if (orderedEntrySet == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyODM2MQ=="}, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNjk2MA==", "bodyText": "I see, so it depends on what actual map it is.\nIf it is a tree map, then the orderedEntrySet will not be null\nin hash map, the orderedEntrySet will be null and goes into this condition.\nIn both cases the entries are there.\nGood learn for me", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504336960", "createdAt": "2020-10-14T00:46:09Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -491,11 +488,49 @@ private static void traverse(Object obj, TraverseCallback callback, CycleChecker\n             cycleChecker.startMap(map);\n             callback.startMap(map);\n             Iterable<Map.Entry<String, Object>> orderedEntrySet = callback.orderMap(map);\n-            for (Map.Entry<String, Object> entry : orderedEntrySet)\n+\n+            //\n+            // If the ordered entry set is null, use Java 8 forEach to avoid intermediary object\n+            // creation for better performance.\n+            //\n+            if (orderedEntrySet == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyODM2MQ=="}, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1OTAzNzMyOnYy", "diffSide": "RIGHT", "path": "data/src/main/java/com/linkedin/data/codec/DataCodec.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDoxOTo0OVrOHg92lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo1MToyNVrOHg-XrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyOTg3Nw==", "bodyText": "Is it somewhat more visible if we put this two util functions to DataMapUtils.java", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504329877", "createdAt": "2020-10-14T00:19:49Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/codec/DataCodec.java", "diffHunk": "@@ -54,6 +55,34 @@\n    */\n   byte[] listToBytes(DataList list) throws IOException;\n \n+  /**\n+   * Serialize a {@link DataMap} to a {@link ByteString}.\n+   *\n+   * @param map to serialize.\n+   * @return the output serialized from the {@link DataMap}.\n+   * @throws IOException if there is a serialization error.\n+   */\n+  default ByteString mapToByteString(DataMap map) throws IOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTYzNg==", "bodyText": "We already have equivalents of these in DataMapUtils. The entire point behind introducing them here and invoking these versions from DataMapUtils is to optimize memory copies, instead of just wrapping a ByteString around a merged byte array.\nBefore this change, memory copies are 3x:\nDataMap -> Codec Buffer -> FastByteArrayOutputStream internal buffer -> join bytes\nAfter this change it becomes 2x for JSON:\nDataMap -> Codec Buffer -> FastByteArrayOutputStream internal buffer\nAnd 1x for Protobuf:\nDataMap -> FastByteArrayOutputStream internal buffer", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504335636", "createdAt": "2020-10-14T00:41:12Z", "author": {"login": "karthikrg"}, "path": "data/src/main/java/com/linkedin/data/codec/DataCodec.java", "diffHunk": "@@ -54,6 +55,34 @@\n    */\n   byte[] listToBytes(DataList list) throws IOException;\n \n+  /**\n+   * Serialize a {@link DataMap} to a {@link ByteString}.\n+   *\n+   * @param map to serialize.\n+   * @return the output serialized from the {@link DataMap}.\n+   * @throws IOException if there is a serialization error.\n+   */\n+  default ByteString mapToByteString(DataMap map) throws IOException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyOTg3Nw=="}, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzODM0OQ==", "bodyText": "Well, for understanding it more,\ncan you tell me where the join bytes is saved\nand where the Codec Buffer  is saved", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r504338349", "createdAt": "2020-10-14T00:51:25Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/codec/DataCodec.java", "diffHunk": "@@ -54,6 +55,34 @@\n    */\n   byte[] listToBytes(DataList list) throws IOException;\n \n+  /**\n+   * Serialize a {@link DataMap} to a {@link ByteString}.\n+   *\n+   * @param map to serialize.\n+   * @return the output serialized from the {@link DataMap}.\n+   * @throws IOException if there is a serialization error.\n+   */\n+  default ByteString mapToByteString(DataMap map) throws IOException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyOTg3Nw=="}, "originalCommit": {"oid": "df81658d53646c99a7e84fd0325400446916b681"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NzIwNjQyOnYy", "diffSide": "RIGHT", "path": "data/src/main/java/com/linkedin/data/DataMap.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNToyMTowMFrOHiNRFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNToyMTowMFrOHiNRFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMDk5Nw==", "bodyText": "nit: a space after 'String,'", "url": "https://github.com/linkedin/rest.li/pull/444#discussion_r505630997", "createdAt": "2020-10-15T15:21:00Z", "author": {"login": "nickibi"}, "path": "data/src/main/java/com/linkedin/data/DataMap.java", "diffHunk": "@@ -415,17 +428,12 @@ private void instrumentAccess(Object key)\n     }\n   }\n \n-  private final static MapChecker<String,Object> _checker = new MapChecker<String,Object>()\n-  {\n-    @Override\n-    public void checkKeyValue(CommonMap<String, Object> map, String key, Object value)\n+  private final static MapChecker<String,Object> _checker = (map, key, value) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f729857dd08763310fbb6ac3a9d3844cc53274bd"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 390, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}