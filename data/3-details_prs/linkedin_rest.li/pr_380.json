{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NTY3NTA3", "number": 380, "title": "Provide an option in SmoothRateLimiter to not drop tasks if going above", "bodyText": "the max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit.", "createdAt": "2020-08-13T18:40:44Z", "url": "https://github.com/linkedin/rest.li/pull/380", "merged": true, "mergeCommit": {"oid": "00796a80636fd0532137e9d5f64174bfd98fc9fc"}, "closed": true, "closedAt": "2020-08-15T00:03:12Z", "author": {"login": "FreCap"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-mrmSAFqTQ2NzEyNjQ0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-8WAwABqjM2NTc4NzM2Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTI2NDQ0", "url": "https://github.com/linkedin/rest.li/pull/380#pullrequestreview-467126444", "createdAt": "2020-08-13T21:00:37Z", "commit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMTowMDozN1rOHAdhQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMToxMDo0OVrOHAd0Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0NTY5OQ==", "bodyText": "Should this be a warning instead? And \"PEGA_xxx\" is normally only returned with exception right? Without the exception I don't see why we want to give this code in a rate limited log", "url": "https://github.com/linkedin/rest.li/pull/380#discussion_r470245699", "createdAt": "2020-08-13T21:00:37Z", "author": {"login": "rachelhanhan"}, "path": "r2-core/src/main/java/com/linkedin/r2/transport/http/client/SmoothRateLimiter.java", "diffHunk": "@@ -107,7 +133,17 @@ public void submit(Callback<None> callback) throws RejectedExecutionException\n \n     if (_pendingCount.get() >= _maxBuffered)\n     {\n-      throw new RejectedExecutionException(\"Cannot submit callback because the buffer is full at \" + _maxBuffered);\n+      if (_bufferOverflowMode == BufferOverflowMode.DROP)\n+      {\n+        throw new RejectedExecutionException(\n+          String.format(\"PEGA_2000: Cannot submit callback because the buffer is full at %d tasks for ratelimiter: %s\", _maxBuffered, _rateLimiterName));\n+      }\n+      else\n+      {\n+        _rateLimitedLoggerOverBuffer.error(String.format(\n+          \"PEGA_2001: the buffer is full at %d tasks for ratelimiter: %s. Executing a request immediately to avoid overflowing and dropping the task.\", _maxBuffered,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDU0Mw==", "bodyText": "What is the rateLimiterName used for? Do we expect CapacityAwareClient to pass the name?", "url": "https://github.com/linkedin/rest.li/pull/380#discussion_r470250543", "createdAt": "2020-08-13T21:10:49Z", "author": {"login": "rachelhanhan"}, "path": "r2-core/src/main/java/com/linkedin/r2/transport/http/client/SmoothRateLimiter.java", "diffHunk": "@@ -78,19 +97,26 @@ public SmoothRateLimiter(ScheduledExecutorService scheduler, Executor executor,\n     _executor = executor;\n     _pendingCallbacks = pendingCallbacks;\n     _maxBuffered = maxBuffered;\n+    _bufferOverflowMode = bufferOverflowMode;\n+    _rateLimiterName = rateLimiterName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTM4OTg2", "url": "https://github.com/linkedin/rest.li/pull/380#pullrequestreview-467138986", "createdAt": "2020-08-13T21:20:50Z", "commit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMToyMDo1MVrOHAeICw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMToyMDo1MVrOHAeICw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NTYyNw==", "bodyText": "Just wondering if the queue is full, does it mean the enqueue rate and dequeue rate would be exactly the same at that point? Basically if the queue is full, we would not perform any rate limiting? Just want to get some clarification on the expected behavior.", "url": "https://github.com/linkedin/rest.li/pull/380#discussion_r470255627", "createdAt": "2020-08-13T21:20:51Z", "author": {"login": "rachelhanhan"}, "path": "r2-core/src/main/java/com/linkedin/r2/transport/http/client/SmoothRateLimiter.java", "diffHunk": "@@ -207,6 +250,13 @@ public void loop()\n         return;\n       }\n \n+      // the size of the pending cannot be ever greater than the maxBuffered. We prefer\n+      // running above the limit then risking a leak", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "originalPosition": 152}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTg5MDMz", "url": "https://github.com/linkedin/rest.li/pull/380#pullrequestreview-467189033", "createdAt": "2020-08-13T23:09:15Z", "commit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzMyMTgw", "url": "https://github.com/linkedin/rest.li/pull/380#pullrequestreview-467732180", "createdAt": "2020-08-14T17:02:43Z", "commit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0be7f9608a8b05dc5c77cc8ea021feac2bb061a", "author": {"user": {"login": "FreCap", "name": "Francesco Capponi"}}, "url": "https://github.com/linkedin/rest.li/commit/d0be7f9608a8b05dc5c77cc8ea021feac2bb061a", "committedDate": "2020-08-13T18:06:59Z", "message": "Provide an option in SmoothRateLimiter to not drop tasks if going above\nthe max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit."}, "afterCommit": {"oid": "a8af80eff9e7e6ba1dc55f21ba096efe78e8fa11", "author": {"user": {"login": "FreCap", "name": "Francesco Capponi"}}, "url": "https://github.com/linkedin/rest.li/commit/a8af80eff9e7e6ba1dc55f21ba096efe78e8fa11", "committedDate": "2020-08-14T17:17:09Z", "message": "Provide an option in SmoothRateLimiter to not drop tasks if going above\nthe max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f81c7e1c8d3c6ce65eeb145f8fcd568259b47d3f", "author": {"user": {"login": "FreCap", "name": "Francesco Capponi"}}, "url": "https://github.com/linkedin/rest.li/commit/f81c7e1c8d3c6ce65eeb145f8fcd568259b47d3f", "committedDate": "2020-08-14T22:27:29Z", "message": "Provide an option in SmoothRateLimiter to not drop tasks if going above\nthe max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8af80eff9e7e6ba1dc55f21ba096efe78e8fa11", "author": {"user": {"login": "FreCap", "name": "Francesco Capponi"}}, "url": "https://github.com/linkedin/rest.li/commit/a8af80eff9e7e6ba1dc55f21ba096efe78e8fa11", "committedDate": "2020-08-14T17:17:09Z", "message": "Provide an option in SmoothRateLimiter to not drop tasks if going above\nthe max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit."}, "afterCommit": {"oid": "f81c7e1c8d3c6ce65eeb145f8fcd568259b47d3f", "author": {"user": {"login": "FreCap", "name": "Francesco Capponi"}}, "url": "https://github.com/linkedin/rest.li/commit/f81c7e1c8d3c6ce65eeb145f8fcd568259b47d3f", "committedDate": "2020-08-14T22:27:29Z", "message": "Provide an option in SmoothRateLimiter to not drop tasks if going above\nthe max buffered. Dropping tasks might be more diruptive to workflows\ncompared to just not ratelimit."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4613, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}