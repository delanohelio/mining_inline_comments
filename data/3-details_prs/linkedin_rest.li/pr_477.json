{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDcxMjc2", "number": 477, "title": "[Relative Load Balancer] Add parity of do not slow start in Dyno test", "bodyText": "Background\nIn the existing degrader load balancer, we have one special logic about Dyno tests: When a dyno test is started, they will explicitly indicate uriProperties \"doNotSlowStart\" for the uri, so that when a host's weight is adjusted in Zookeeper, it does not perform any slow start. However, I just realized the same feature is not added to relative load balancer. Hence this PR will add the parity.", "createdAt": "2020-11-11T21:52:06Z", "url": "https://github.com/linkedin/rest.li/pull/477", "merged": true, "mergeCommit": {"oid": "1f69d2c09f684e55544ffecd70e72f3e8220df3f"}, "closed": true, "closedAt": "2020-11-17T07:26:25Z", "author": {"login": "rachelhanhan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb7uZYAFqTUyOTYwMjE4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddTbFSgBqjQwMDM3Njc1Nzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NjAyMTg2", "url": "https://github.com/linkedin/rest.li/pull/477#pullrequestreview-529602186", "createdAt": "2020-11-13T00:04:29Z", "commit": {"oid": "b586a0d9a832e866b02273f7943e628081996299"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMDowNDoyOVrOHyUArw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMDowNjowM1rOHyUCfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxODcwMw==", "bodyText": "minor: bracket on the new line", "url": "https://github.com/linkedin/rest.li/pull/477#discussion_r522518703", "createdAt": "2020-11-13T00:04:29Z", "author": {"login": "rickzx"}, "path": "d2/src/main/java/com/linkedin/d2/balancer/strategies/relative/StateUpdater.java", "diffHunk": "@@ -313,9 +313,16 @@ else if (trackerClientState.getHealthScore() < MAX_HEALTH_SCORE\n       }\n       else\n       {\n-        // If it is a new client, we directly set health score as the initial health score to initialize\n-        trackerClientStateMap.put(trackerClient, new TrackerClientState(_relativeStrategyProperties.getInitialHealthScore(),\n-            _relativeStrategyProperties.getMinCallCount()));\n+        // Initializing a new client score\n+        if (trackerClient.doNotSlowStart())\n+        {\n+          trackerClientStateMap.put(trackerClient, new TrackerClientState(MAX_HEALTH_SCORE,\n+              _relativeStrategyProperties.getMinCallCount()));\n+        }\n+        else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b586a0d9a832e866b02273f7943e628081996299"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxOTE2NA==", "bodyText": "minor: bracket on the new line", "url": "https://github.com/linkedin/rest.li/pull/477#discussion_r522519164", "createdAt": "2020-11-13T00:06:03Z", "author": {"login": "rickzx"}, "path": "d2/src/test/java/com/linkedin/d2/balancer/strategies/relative/StateUpdaterTest.java", "diffHunk": "@@ -97,25 +97,43 @@ public void testInitializePartition(int partitionId)\n         };\n   }\n \n-  @Test\n-  public void testInitializePartitionWithSlowStartInitialHealthScore()\n+  @Test(dataProvider = \"doNotSlowStart\")\n+  public void testInitializePartitionWithSlowStartInitialHealthScore(boolean doNotSlowStart)\n   {\n     double initialHealthScore = 0.01;\n     D2RelativeStrategyProperties relativeStrategyProperties = new D2RelativeStrategyProperties()\n         .setInitialHealthScore(initialHealthScore);\n     setup(relativeStrategyProperties, new ConcurrentHashMap<>());\n \n     List<TrackerClient> trackerClients = TrackerClientMockHelper.mockTrackerClients(2,\n-        Arrays.asList(20, 20), Arrays.asList(10, 10), Arrays.asList(200L, 500L), Arrays.asList(100L, 200L), Arrays.asList(0, 0));\n+        Arrays.asList(20, 20), Arrays.asList(10, 10), Arrays.asList(200L, 500L), Arrays.asList(100L, 200L), Arrays.asList(0, 0), doNotSlowStart);\n \n     assertTrue(_stateUpdater.getPointsMap(DEFAULT_PARTITION_ID).isEmpty(), \"There should be no state before initialization\");\n \n     _stateUpdater.updateState(new HashSet<>(trackerClients), DEFAULT_PARTITION_ID, DEFAULT_CLUSTER_GENERATION_ID);\n \n-    assertEquals(_stateUpdater.getPointsMap(DEFAULT_PARTITION_ID).get(trackerClients.get(0).getUri()).intValue(),\n-        (int) (initialHealthScore * RelativeLoadBalancerStrategyFactory.DEFAULT_POINTS_PER_WEIGHT));\n-    assertEquals(_stateUpdater.getPointsMap(DEFAULT_PARTITION_ID).get(trackerClients.get(1).getUri()).intValue(),\n-        (int) (initialHealthScore * RelativeLoadBalancerStrategyFactory.DEFAULT_POINTS_PER_WEIGHT));\n+    if (!doNotSlowStart)\n+    {\n+      assertEquals(_stateUpdater.getPointsMap(DEFAULT_PARTITION_ID).get(trackerClients.get(0).getUri()).intValue(),\n+          (int) (initialHealthScore * RelativeLoadBalancerStrategyFactory.DEFAULT_POINTS_PER_WEIGHT));\n+      assertEquals(_stateUpdater.getPointsMap(DEFAULT_PARTITION_ID).get(trackerClients.get(1).getUri()).intValue(),\n+          (int) (initialHealthScore * RelativeLoadBalancerStrategyFactory.DEFAULT_POINTS_PER_WEIGHT));\n+    }\n+    else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b586a0d9a832e866b02273f7943e628081996299"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ce0b07c6e8d759b3470a17287c3959986fcd3f", "author": {"user": {"login": "rachelhanhan", "name": "Ruxin Han"}}, "url": "https://github.com/linkedin/rest.li/commit/05ce0b07c6e8d759b3470a17287c3959986fcd3f", "committedDate": "2020-11-17T06:14:44Z", "message": "[Relative Load Balancer] Add parity of do not slow start in Dyno tests in relative load balancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6c27c91abd2adc772d13b52138ef31141a03f33", "author": {"user": {"login": "rachelhanhan", "name": "Ruxin Han"}}, "url": "https://github.com/linkedin/rest.li/commit/d6c27c91abd2adc772d13b52138ef31141a03f33", "committedDate": "2020-11-17T06:14:44Z", "message": "Change java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0443f51f56735376ce82f9a9583d5a1dd96c1c2a", "author": {"user": {"login": "rachelhanhan", "name": "Ruxin Han"}}, "url": "https://github.com/linkedin/rest.li/commit/0443f51f56735376ce82f9a9583d5a1dd96c1c2a", "committedDate": "2020-11-17T06:17:35Z", "message": "Add change log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b586a0d9a832e866b02273f7943e628081996299", "author": {"user": {"login": "rachelhanhan", "name": "Ruxin Han"}}, "url": "https://github.com/linkedin/rest.li/commit/b586a0d9a832e866b02273f7943e628081996299", "committedDate": "2020-11-11T21:55:57Z", "message": "Change java doc"}, "afterCommit": {"oid": "0443f51f56735376ce82f9a9583d5a1dd96c1c2a", "author": {"user": {"login": "rachelhanhan", "name": "Ruxin Han"}}, "url": "https://github.com/linkedin/rest.li/commit/0443f51f56735376ce82f9a9583d5a1dd96c1c2a", "committedDate": "2020-11-17T06:17:35Z", "message": "Add change log"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4572, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}