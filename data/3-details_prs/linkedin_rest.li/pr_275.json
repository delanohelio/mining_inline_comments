{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwOTkzMTg5", "number": 275, "title": "Enable tests in Travis, use retries for some tests", "bodyText": "Enabling tests in the Travis CI build to give us higher confidence in proposed changes. Addresses tests with CI flakiness:\n\nTests that are flaky in Travis are added to the group ci-flaky, which is excluded only in the CI environment (i.e. they'll still run locally).\nSome flaky tests were given one retry using the SingleRetry class, though they should still be investigated (note that some tests might need a retry even when run locally).\nI've created two internal tracking tickets to track addressing the flaky tests: one for R2/D2-related tests, and one for everything else.\n\nOther changes:\n\nAdded a new script scripts/travis/build.sh which is run for each tag, master, and each PR. However, the tests are skipped when building on a tag to avoid flaky releases.\nAdded extra logging for test failures to show the actual assertion message.\nAdded an override in RestLiIntegrationTest for the client timeout to be increased from 10000 to 20000 when being run in the CI environment.", "createdAt": "2020-04-29T22:41:33Z", "url": "https://github.com/linkedin/rest.li/pull/275", "merged": true, "mergeCommit": {"oid": "b6d0e05eb529f95fefe0fd63e7337172127a2e2f"}, "closed": true, "closedAt": "2020-05-19T21:52:16Z", "author": {"login": "evanw555"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfDevzABqjMzMTQ1NzkzNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci7fF4AFqTQxNDg0MjE5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6fd00d8db8296f63a6acab1c27215fbf583ac8b", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/b6fd00d8db8296f63a6acab1c27215fbf583ac8b", "committedDate": "2020-05-07T20:18:47Z", "message": "Enable stacktrace, add retry for one more test"}, "afterCommit": {"oid": "2988a10e6e0f1ef6285247c55a36a9eb7368ae6d", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/2988a10e6e0f1ef6285247c55a36a9eb7368ae6d", "committedDate": "2020-05-07T20:40:50Z", "message": "Enable tests in Travis, use retries for some tests\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. Addresses tests with recent flakiness by adding retry\nsupport."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57ef9b1c8f5266a6169140ff135bcbbfbe57bc18", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/57ef9b1c8f5266a6169140ff135bcbbfbe57bc18", "committedDate": "2020-05-12T19:08:27Z", "message": "Added back retry for compression test"}, "afterCommit": {"oid": "f352908f1214a7c9449005649e86fe5b13ac9217", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/f352908f1214a7c9449005649e86fe5b13ac9217", "committedDate": "2020-05-12T22:44:56Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDM3NzQz", "url": "https://github.com/linkedin/rest.li/pull/275#pullrequestreview-411437743", "createdAt": "2020-05-14T03:17:47Z", "commit": {"oid": "07b53f83fe16a02ee002081094bf9682b0d05aee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzoxNzo0OFrOGVKpvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzoyMjo1MlrOGVKuXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0NzgwNw==", "bodyText": "It is not necessary but I think 3 times will be better, sort of industry standard?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r424847807", "createdAt": "2020-05-14T03:17:48Z", "author": {"login": "junchuanwang"}, "path": "d2/src/test/java/com/linkedin/d2/balancer/servers/ZookeeperConnectionManagerTest.java", "diffHunk": "@@ -352,7 +353,7 @@ public void testMarkUpDuringSessionExpiration()\n     shutdownManager(manager);\n   }\n \n-  @Test(invocationCount = 10, timeOut = 10000)\n+  @Test(invocationCount = 10, timeOut = 10000, retryAnalyzer = SingleRetry.class) // TODO: temporary retry to alleviate CI failures, should be investigated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b53f83fe16a02ee002081094bf9682b0d05aee"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0ODEzOQ==", "bodyText": "what does this group do? Is there a way to disable all ci-flaky tests after you group them?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r424848139", "createdAt": "2020-05-14T03:19:19Z", "author": {"login": "junchuanwang"}, "path": "d2/src/test/java/com/linkedin/d2/balancer/servers/ZookeeperConnectionManagerTest.java", "diffHunk": "@@ -437,7 +438,7 @@ public void testMarkUpAndDownMultipleTimesFinalDown()\n     executorService.shutdown();\n   }\n \n-  @Test(invocationCount = 10, timeOut = 10000)\n+  @Test(invocationCount = 10, timeOut = 10000, groups = { \"ci-flaky\" })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b53f83fe16a02ee002081094bf9682b0d05aee"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0ODk5MA==", "bodyText": "I am afraid I am not a fan of this naming. How about just Retires or RetrySetup ?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r424848990", "createdAt": "2020-05-14T03:22:52Z", "author": {"login": "junchuanwang"}, "path": "test-util/src/main/java/com/linkedin/test/util/VariableRetries.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.test.util;\n+\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestResult;\n+\n+\n+/**\n+ * Allows N retries for a given test method. Subclass implementations must specify the value of N.\n+ *\n+ * Note that the same instance is used for all iterations of a test method, meaning that even if there are multiple\n+ * iterations (e.g. data provider provides multiple sets of input) only N retries will be allowed.\n+ *\n+ * @author Evan Williams\n+ */\n+public abstract class VariableRetries implements IRetryAnalyzer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b53f83fe16a02ee002081094bf9682b0d05aee"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjY4OTY3", "url": "https://github.com/linkedin/rest.li/pull/275#pullrequestreview-412268967", "createdAt": "2020-05-15T00:20:33Z", "commit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMDoyMDozNFrOGVyacA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMDoyMDozNFrOGVyacA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5OTI0OA==", "bodyText": "Should we check System.getenv('TRAVIS') != null first?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r425499248", "createdAt": "2020-05-15T00:20:34Z", "author": {"login": "nickibi"}, "path": "build.gradle", "diffHunk": "@@ -290,6 +290,16 @@ subprojects {\n     }\n   }\n \n+  // Exclude tests which are known to be flaky in the Travis CI environment\n+  if (System.getenv('TRAVIS') == 'true' && System.getenv('USER') == 'travis') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzc5NTky", "url": "https://github.com/linkedin/rest.li/pull/275#pullrequestreview-412379592", "createdAt": "2020-05-15T06:30:20Z", "commit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNjozMDoyMFrOGV4IeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNjozOToxN1rOGV4Upw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU5Mjk1Mw==", "bodyText": "remove MAX_RETRIES constant", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r425592953", "createdAt": "2020-05-15T06:30:20Z", "author": {"login": "karthikbalasub"}, "path": "restli-int-test/src/test/java/com/linkedin/restli/examples/instrumentation/TestLatencyInstrumentation.java", "diffHunk": "@@ -167,37 +168,19 @@ public void afterMethod() throws Exception\n    * using streaming should be inconsequential for this test, but the server using the streaming codec will actually\n    * affect the outcome.\n    *\n-   * This test allows for multiple retries in case of an anomalous test run to prevent test flakiness.\n-   *\n    * @param useStreaming whether the server should use an underlying streaming server (\"restOverStream\") and whether the\n    *                     downstream request should use streaming (see the disclaimer above)\n    * @param forceException whether the upstream and downstream resources should trigger the error response path\n    * @param timingImportanceThreshold impacts which keys are included in the request context\n    */\n-  @Test(dataProvider = \"latencyInstrumentation\")\n+  @Test(dataProvider = \"latencyInstrumentation\", retryAnalyzer = SingleRetry.class)\n   public void testLatencyInstrumentation(boolean useStreaming, boolean forceException, boolean useScatterGather,\n       TimingImportance timingImportanceThreshold) throws RemoteInvocationException, InterruptedException\n   {\n-    AssertionError testFailure = null;\n-    for (int iteration = 0; iteration <= MAX_RETRIES; iteration++)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU5NDkwMA==", "bodyText": "Why do we need this? With the change to skip flaky tests this shouldn't be a problem, right?\nAlso, even if release job fails, we can retry again?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r425594900", "createdAt": "2020-05-15T06:35:55Z", "author": {"login": "karthikbalasub"}, "path": "scripts/travis/build.sh", "diffHunk": "@@ -0,0 +1,29 @@\n+#!/usr/bin/env bash\n+\n+# Ensure that this is being run by Travis\n+if [ \"$TRAVIS\" != \"true\" ] || [ \"$USER\" != \"travis\" ]; then\n+  echo \"This script should only be run by Travis CI.\"\n+  exit 2\n+fi\n+\n+# Output something every 9 minutes, otherwise Travis will abort after 10 minutes of no output\n+while sleep 9m; do echo \"[Ping] Keeping Travis job alive ($((SECONDS / 60)) minutes)\"; done &\n+WAITER_PID=$!\n+\n+# Skip tests if building a tag to prevent flaky releases", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU5NjA3MQ==", "bodyText": "Did you check the tests in ci-flaky group with 3 retires?", "url": "https://github.com/linkedin/rest.li/pull/275#discussion_r425596071", "createdAt": "2020-05-15T06:39:17Z", "author": {"login": "karthikbalasub"}, "path": "d2/src/test/java/com/linkedin/d2/balancer/servers/ZookeeperConnectionManagerTest.java", "diffHunk": "@@ -352,7 +353,7 @@ public void testMarkUpDuringSessionExpiration()\n     shutdownManager(manager);\n   }\n \n-  @Test(invocationCount = 10, timeOut = 10000)\n+  @Test(invocationCount = 10, timeOut = 10000, retryAnalyzer = SingleRetry.class) // TODO: temporary retry to alleviate CI failures, should be investigated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0NzgwNw=="}, "originalCommit": {"oid": "07b53f83fe16a02ee002081094bf9682b0d05aee"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODMxMjE5", "url": "https://github.com/linkedin/rest.li/pull/275#pullrequestreview-412831219", "createdAt": "2020-05-15T17:21:24Z", "commit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02bf43099186633e1aa637c834f20ab265fd374b", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/02bf43099186633e1aa637c834f20ab265fd374b", "committedDate": "2020-05-14T06:04:16Z", "message": "Add 3-retry class, clean up package structure"}, "afterCommit": {"oid": "5b4d6f64355115b14cf927d58f57701f251b7eec", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/5b4d6f64355115b14cf927d58f57701f251b7eec", "committedDate": "2020-05-15T22:14:46Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60eca456a84931629707c4b7c2fdae1fa4e82951", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/60eca456a84931629707c4b7c2fdae1fa4e82951", "committedDate": "2020-05-19T19:57:14Z", "message": "Add another 3-retry"}, "afterCommit": {"oid": "544eb670829dfed6df109ba2fccde3a3ace1ea72", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/544eb670829dfed6df109ba2fccde3a3ace1ea72", "committedDate": "2020-05-19T20:31:23Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon.\n\nThe process for addressing flakiness is:\n- if a test is flaky, give it one retry using SingleRetry\n- if it's still flaky, give it three retries using ThreeRetries\n- if it's still flaky, disable it in CI using the group \"ci-flaky\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b36069be10fae9378c7a42be18bbbd2acfb50648", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/b36069be10fae9378c7a42be18bbbd2acfb50648", "committedDate": "2020-05-19T20:47:38Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon.\n\nThe process for addressing flakiness is:\n- if a test is flaky, give it one retry using SingleRetry\n- if it's still flaky, give it three retries using ThreeRetries\n- if it's still flaky, disable it in CI using the group \"ci-flaky\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "544eb670829dfed6df109ba2fccde3a3ace1ea72", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/544eb670829dfed6df109ba2fccde3a3ace1ea72", "committedDate": "2020-05-19T20:31:23Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon.\n\nThe process for addressing flakiness is:\n- if a test is flaky, give it one retry using SingleRetry\n- if it's still flaky, give it three retries using ThreeRetries\n- if it's still flaky, disable it in CI using the group \"ci-flaky\""}, "afterCommit": {"oid": "b36069be10fae9378c7a42be18bbbd2acfb50648", "author": {"user": {"login": "evanw555", "name": "Evan Williams"}}, "url": "https://github.com/linkedin/rest.li/commit/b36069be10fae9378c7a42be18bbbd2acfb50648", "committedDate": "2020-05-19T20:47:38Z", "message": "Enable tests in Travis, add some exclusions\n\nEnabling tests in the Travis CI build to give us higher confidence in\nproposed changes. The Travis environment seems to introduce flakiness or\neven total failure for some tests, so this adds test retries for some\ntests and total exclusion for other tests in order to alleviate this.\nThe 'ci-flaky' test group is excluded for all test tasks in the CI\nenvironment, though these tests should be addressed soon.\n\nThe process for addressing flakiness is:\n- if a test is flaky, give it one retry using SingleRetry\n- if it's still flaky, give it three retries using ThreeRetries\n- if it's still flaky, disable it in CI using the group \"ci-flaky\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODQyMTkz", "url": "https://github.com/linkedin/rest.li/pull/275#pullrequestreview-414842193", "createdAt": "2020-05-19T21:37:52Z", "commit": {"oid": "b36069be10fae9378c7a42be18bbbd2acfb50648"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4762, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}