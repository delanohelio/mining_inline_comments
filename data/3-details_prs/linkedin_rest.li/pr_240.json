{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0OTkxMjY5", "number": 240, "title": "Feature/zk batch with jitter", "bodyText": "One of the major problems identified during Zookeeper Capacity investigation is the read storm created during deployments.  During deployment, nodes in the cluster de-announce and announce to zookeeper and this can create thousands of watch notifications based on the number of nodes in the deploying cluster. This can create read storms in Zookeeper if all the upstream nodes started reading for every watch update. This read storm is more visible for big clusters with large numbers of upstreams like identity-mt.\nThis pull request is to batch or delay setting the watch by the configured threshold duration along with applying jitter to randomize the point in which the actual watch is set.", "createdAt": "2020-03-27T22:14:29Z", "url": "https://github.com/linkedin/rest.li/pull/240", "merged": true, "mergeCommit": {"oid": "e2f85c714507191912f7fdfcbae0743693314c5a"}, "closed": true, "closedAt": "2020-04-08T22:15:15Z", "author": {"login": "nizarm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS17SrgFqTM4NDI2MDI3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVvQd6gH2gAyMzk0OTkxMjY5OmQ5YzllOWZlNGQyNWI5YTM4MDI1YmVmYzZlOTY2ZDFmMThmNDhlMmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MjYwMjcx", "url": "https://github.com/linkedin/rest.li/pull/240#pullrequestreview-384260271", "createdAt": "2020-03-30T21:55:13Z", "commit": {"oid": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMTo1NToxM1rOF99rdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMjowMjo1N1rOF995Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxODAwNQ==", "bodyText": "the config name (readWindowMs) is not self-identified. Can we have a more descriptive name (eg zookeeperReadWindowMs)?", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400518005", "createdAt": "2020-03-30T21:55:13Z", "author": {"login": "cx-super"}, "path": "d2/src/main/java/com/linkedin/d2/balancer/D2ClientConfig.java", "diffHunk": "@@ -71,6 +72,7 @@\n   int retryLimit = DEAULT_RETRY_LIMIT;\n   boolean warmUp = false;\n   int warmUpTimeoutSeconds = WarmUpLoadBalancer.DEFAULT_SEND_REQUESTS_TIMEOUT_SECONDS;\n+  int readWindowMs = ZooKeeperStore.DEFAULT_READ_WINDOW_MS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyMTU0Nw==", "bodyText": "So the delay is in the range of [midPoint, readWindowMs] -- why not [0, readWindowMs]? There is no need to explicitly add latency for the calls.", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r400521547", "createdAt": "2020-03-30T22:02:57Z", "author": {"login": "cx-super"}, "path": "d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperEphemeralStore.java", "diffHunk": "@@ -610,7 +638,19 @@ public void processResult(int rc, String path, Object ctx, Stat stat)\n     protected void processWatch(String propertyName, WatchedEvent event)\n     {\n       // Reset the watch\n-      _zk.getChildren(getPath(propertyName), this, this, false);\n+      if (_readWindowMs > 0 && _executorService != null)\n+      {\n+        // Delay setting the watch based on configured _readWindowMs\n+        int midPoint = _readWindowMs / 2;\n+        int delay = midPoint + ThreadLocalRandom.current().nextInt(midPoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7aa674a2c2028c947b2fde72118a8616b439432", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/a7aa674a2c2028c947b2fde72118a8616b439432", "committedDate": "2020-03-31T01:33:47Z", "message": "Zookeeper Read Batching with Jitter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2b8bb96c51918475cd6d1543efa123e4fdc25b6", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/d2b8bb96c51918475cd6d1543efa123e4fdc25b6", "committedDate": "2020-03-31T01:33:47Z", "message": "Update the config parameters in LastSeenLoadBalancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/d0587855b73cbf6868a5d3a83674bd1475aa17d9", "committedDate": "2020-03-31T01:33:47Z", "message": "Iterate with Chao review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/f55f3da0c4b8f90446b1d2ffcaadc6a48c4d2000", "committedDate": "2020-03-27T22:02:30Z", "message": "Update the config parameters in LastSeenLoadBalancer"}, "afterCommit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/d0587855b73cbf6868a5d3a83674bd1475aa17d9", "committedDate": "2020-03-31T01:33:47Z", "message": "Iterate with Chao review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODAxNDU4", "url": "https://github.com/linkedin/rest.li/pull/240#pullrequestreview-385801458", "createdAt": "2020-04-01T17:31:44Z", "commit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjU1NDUw", "url": "https://github.com/linkedin/rest.li/pull/240#pullrequestreview-386655450", "createdAt": "2020-04-02T17:42:16Z", "commit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzo0MjoxNlrOF_2e9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNDozODo1OVrOGAE2vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NzI3MQ==", "bodyText": "any reason not to use Timespan? for easier tweaking in the future and better readability.", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r402497271", "createdAt": "2020-04-02T17:42:16Z", "author": {"login": "bohhyang"}, "path": "d2/src/main/java/com/linkedin/d2/discovery/stores/zk/ZooKeeperStore.java", "diffHunk": "@@ -42,8 +42,9 @@\n     PropertyEventPublisher<T>,\n     PropertyStore<T>\n {\n-  private static final Logger           _log =\n-                                                 LoggerFactory.getLogger(ZooKeeperStore.class);\n+  private static final Logger           _log = LoggerFactory.getLogger(ZooKeeperStore.class);\n+\n+  public static final int DEFAULT_READ_WINDOW_MS = -1; //disabled by default", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjczMjczNQ==", "bodyText": "just for my understanding, which config is this executor service coming from? where is it defined?", "url": "https://github.com/linkedin/rest.li/pull/240#discussion_r402732735", "createdAt": "2020-04-03T04:38:59Z", "author": {"login": "bohhyang"}, "path": "d2/src/main/java/com/linkedin/d2/balancer/LastSeenBalancerWithFacilitiesFactory.java", "diffHunk": "@@ -73,15 +75,21 @@ public LoadBalancerWithFacilities create(D2ClientConfig config)\n     }\n \n     // init all the stores\n-    LastSeenZKStore<ClusterProperties> lsClusterStore = getClusterPropertiesLastSeenZKStore(config, zkPersistentConnection, d2ClientJmxManager);\n+    LastSeenZKStore<ClusterProperties> lsClusterStore =\n+      getClusterPropertiesLastSeenZKStore(config, zkPersistentConnection, d2ClientJmxManager,\n+                                          config._executorService, config.zookeeperReadWindowMs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTAyMTY1", "url": "https://github.com/linkedin/rest.li/pull/240#pullrequestreview-390102165", "createdAt": "2020-04-08T15:47:25Z", "commit": {"oid": "d0587855b73cbf6868a5d3a83674bd1475aa17d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c9e9fe4d25b9a38025befc6e966d1f18f48e2e", "author": {"user": {"login": "nizarm", "name": "Nizar Mankulangara"}}, "url": "https://github.com/linkedin/rest.li/commit/d9c9e9fe4d25b9a38025befc6e966d1f18f48e2e", "committedDate": "2020-04-08T22:02:01Z", "message": "Merge branch 'master' into feature/ZKBatchWithJitter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 22, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}