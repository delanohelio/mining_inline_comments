{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NjE0NDcz", "number": 359, "title": "[darkcluster] Adding identical traffic multiplier strategy", "bodyText": "This changeset contains a new dark cluster traffic routing strategy called identical traffic multiplier which is meant to serve a usecase where we want to identical requests to be dispatched to all dark clusters configured with this strategy.", "createdAt": "2020-07-30T21:30:28Z", "url": "https://github.com/linkedin/rest.li/pull/359", "merged": true, "mergeCommit": {"oid": "a3eee9ad0826955dbc97a49ab3a12efd0adc2593"}, "closed": true, "closedAt": "2020-08-04T22:31:00Z", "author": {"login": "srikrish-19"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6GX_8AH2gAyNDU5NjE0NDczOjFlZjQxMmYzYzExNDAwYzM1MjlkNzQ0YTI4OWVhZjQ1MGEyZGE1MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7tji5AFqTQ2MTE4OTY1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ef412f3c11400c3529d744a289eaf450a2da519", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/1ef412f3c11400c3529d744a289eaf450a2da519", "committedDate": "2020-07-30T21:19:20Z", "message": "[darkcluster] Adding identical traffic multiplier strategy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NzcyNDg1", "url": "https://github.com/linkedin/rest.li/pull/359#pullrequestreview-458772485", "createdAt": "2020-07-30T21:34:18Z", "commit": {"oid": "1ef412f3c11400c3529d744a289eaf450a2da519"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTozNDoxOFrOG50odg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTozODoyMlrOG50vpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NDM0Mg==", "bodyText": "javadoc. this should mention that it is similar to RelativeTraffic, etc.", "url": "https://github.com/linkedin/rest.li/pull/359#discussion_r463284342", "createdAt": "2020-07-30T21:34:18Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/IdenticalTrafficMultiplierDarkClusterStrategy.java", "diffHunk": "@@ -0,0 +1,132 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.common.util.Notifier;\n+import com.linkedin.d2.DarkClusterConfig;\n+import com.linkedin.d2.balancer.ServiceUnavailableException;\n+import com.linkedin.d2.balancer.util.ClusterInfoProvider;\n+import com.linkedin.darkcluster.api.BaseDarkClusterDispatcher;\n+import com.linkedin.darkcluster.api.DarkClusterStrategy;\n+import com.linkedin.r2.message.RequestContext;\n+import com.linkedin.r2.message.rest.RestRequest;\n+import java.util.Random;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef412f3c11400c3529d744a289eaf450a2da519"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NjE4Mg==", "bodyText": "why is one \"< 0.2\" and the other \"< 0.3\" if they have the same multiplier?", "url": "https://github.com/linkedin/rest.li/pull/359#discussion_r463286182", "createdAt": "2020-07-30T21:38:22Z", "author": {"login": "davidhoa"}, "path": "darkcluster/src/main/java/com/linkedin/darkcluster/impl/IdenticalTrafficMultiplierDarkClusterStrategy.java", "diffHunk": "@@ -0,0 +1,132 @@\n+package com.linkedin.darkcluster.impl;\n+\n+import com.linkedin.common.util.Notifier;\n+import com.linkedin.d2.DarkClusterConfig;\n+import com.linkedin.d2.balancer.ServiceUnavailableException;\n+import com.linkedin.d2.balancer.util.ClusterInfoProvider;\n+import com.linkedin.darkcluster.api.BaseDarkClusterDispatcher;\n+import com.linkedin.darkcluster.api.DarkClusterStrategy;\n+import com.linkedin.r2.message.RequestContext;\n+import com.linkedin.r2.message.rest.RestRequest;\n+import java.util.Random;\n+\n+\n+public class IdenticalTrafficMultiplierDarkClusterStrategy implements DarkClusterStrategy {\n+  private final String _originalClusterName;\n+  private final String _darkClusterName;\n+  private final Float _multiplier;\n+  private final BaseDarkClusterDispatcher _baseDarkClusterDispatcher;\n+  private final Notifier _notifier;\n+  private final Random _random;\n+  private final ClusterInfoProvider _clusterInfoProvider;\n+\n+  private static final String RANDOM_NUMBER_KEY = \"identicalTrafficMultiplier.randomNumber\";\n+\n+  public IdenticalTrafficMultiplierDarkClusterStrategy(String sourceClusterName,\n+      String darkClusterName,\n+      Float multiplier,\n+      BaseDarkClusterDispatcher baseDarkClusterDispatcher,\n+      Notifier notifier,\n+      ClusterInfoProvider clusterInfoProvider, Random random)\n+  {\n+    _originalClusterName = sourceClusterName;\n+    _darkClusterName = darkClusterName;\n+    _multiplier = multiplier;\n+    _baseDarkClusterDispatcher = baseDarkClusterDispatcher;\n+    _notifier = notifier;\n+    _random = random;\n+    _clusterInfoProvider = clusterInfoProvider;\n+  }\n+\n+  @Override\n+  public boolean handleRequest(RestRequest originalRequest, RestRequest darkRequest, RequestContext requestContext)\n+  {\n+    int numRequestDuplicates = getNumDuplicateRequests(requestContext);\n+    return _baseDarkClusterDispatcher.sendRequest(originalRequest, darkRequest, requestContext, numRequestDuplicates);\n+  }\n+\n+  /**\n+   * We won't create this strategy if this config isn't valid for this strategy. For instance, we don't want to create\n+   * the IdenticalTrafficMultiplierDarkClusterStrategy if there's no multiplier or if the multiplier is zero, because we'd\n+   * be doing pointless work on every getOrCreate. Instead if will go to the next strategy (or NoOpDarkClusterStrategy).\n+   *\n+   * This is a static method defined here because we don't want to instantiate a strategy to check this. It cannot be a\n+   * method that is on the interface because static methods on an interface cannot be overridden by implementations.\n+   * @param darkClusterConfig\n+   * @return true if config is valid for this strategy\n+   */\n+  public static boolean isValidConfig(DarkClusterConfig darkClusterConfig)\n+  {\n+    return darkClusterConfig.hasMultiplier() && darkClusterConfig.getMultiplier() > 0;\n+  }\n+\n+  /**\n+   * The high level goal of this strategy is to send identical traffic to all the dark clusters configured with this\n+   * strategy. It accomplishes this by persisting the random number generated for a request in {@link RequestContext}\n+   * and reusing the same so that if a request is chosen to be sent to one dark cluster, it will be sent for all other\n+   * dark clusters as well.\n+   *\n+   * The logic to determine if a request should be sent to dark cluster or not for the first time is determined similar\n+   * to {@link RelativeTrafficMultiplierDarkClusterStrategy}\n+   *\n+   * Example 1:\n+   * There are 3 dark clusters: A, B and C all of which are configured with same multiplier of 0.1.\n+   * There is 1 source instance and 1 dark instance in each cluster.\n+   * Assume that the strategy is called for A, B and C in the same order.\n+   * For A, there will be no random number persisted in requestContext since we're seeing this request for the first time\n+   * So we compute random number, say 0.05 and persist the same in requestContext\n+   * Avg#DarkRequests = 1 * 0.1 / 1 = 0.1\n+   * since 0.05 < 0.1, request will be sent to A\n+   * When it comes to B, the random number is already present and since it is < 0.2, request will be sent to B", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef412f3c11400c3529d744a289eaf450a2da519"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee09c898fb75b9cfb3e7e2a0e061b69fc222465c", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/ee09c898fb75b9cfb3e7e2a0e061b69fc222465c", "committedDate": "2020-07-31T01:32:25Z", "message": "[darkcluster] Adding identical traffic multiplier strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe84dba85315eebaa989fd306766499e86911d1", "author": {"user": {"login": "junchuanwang", "name": "Junchuan Wang"}}, "url": "https://github.com/linkedin/rest.li/commit/0fe84dba85315eebaa989fd306766499e86911d1", "committedDate": "2020-08-04T17:21:10Z", "message": "Add gradle property to skip generateRestModel task (#362)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9916eab00528bf26af5e84c660b59c69eca91c97", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/9916eab00528bf26af5e84c660b59c69eca91c97", "committedDate": "2020-08-04T17:23:08Z", "message": "Implement support for always projecting fields by name. (#358)\n\n* Release 29.4.7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f3559a3f61d657a5e0c43e9b16d92f8729a1816", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/3f3559a3f61d657a5e0c43e9b16d92f8729a1816", "committedDate": "2020-08-04T17:24:19Z", "message": "[darkcluster] Adding identical traffic multiplier strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "090f1a9d810a3830c080454a3e0679aafa9618a6", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/090f1a9d810a3830c080454a3e0679aafa9618a6", "committedDate": "2020-08-04T17:24:20Z", "message": "[darkcluster] Adding identical traffic multiplier strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "901639b8d7689081f4b846fad4cca3b1169b49aa", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/901639b8d7689081f4b846fad4cca3b1169b49aa", "committedDate": "2020-08-04T17:30:13Z", "message": "Merge remote-tracking branch 'upstream/master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac220fac4a770d80a82262d068694eb9de03ea0e", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/ac220fac4a770d80a82262d068694eb9de03ea0e", "committedDate": "2020-08-04T17:38:42Z", "message": "Merge remote-tracking branch 'upstream/master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40b11c3f232affd887d9a0d569d0b8c7f776703b", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/40b11c3f232affd887d9a0d569d0b8c7f776703b", "committedDate": "2020-08-04T17:44:04Z", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDM5NDMz", "url": "https://github.com/linkedin/rest.li/pull/359#pullrequestreview-461039433", "createdAt": "2020-08-04T17:52:45Z", "commit": {"oid": "40b11c3f232affd887d9a0d569d0b8c7f776703b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDUzNzYz", "url": "https://github.com/linkedin/rest.li/pull/359#pullrequestreview-461053763", "createdAt": "2020-08-04T18:13:17Z", "commit": {"oid": "40b11c3f232affd887d9a0d569d0b8c7f776703b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e48e44c9f91bad387d4015710168692110fd25b", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/4e48e44c9f91bad387d4015710168692110fd25b", "committedDate": "2020-08-04T18:17:29Z", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cc3957d0d6d8100cdb4c57d9a3a4c5ea8fe8e79", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/9cc3957d0d6d8100cdb4c57d9a3a4c5ea8fe8e79", "committedDate": "2020-08-04T18:17:39Z", "message": "darkcluster - identical traffic multiplier: Adding the formula for avg # of dark requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478fa28e9a7acdc45c314e26fd751d614aad0eab", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/478fa28e9a7acdc45c314e26fd751d614aad0eab", "committedDate": "2020-08-04T18:18:37Z", "message": "Merge branch 'master' of github.com:srikrish-19/rest.li into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDYwOTY5", "url": "https://github.com/linkedin/rest.li/pull/359#pullrequestreview-461060969", "createdAt": "2020-08-04T18:23:31Z", "commit": {"oid": "478fa28e9a7acdc45c314e26fd751d614aad0eab"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60568b5a6d391cdf1fcec170de90951e8eaf263", "author": {"user": null}, "url": "https://github.com/linkedin/rest.li/commit/d60568b5a6d391cdf1fcec170de90951e8eaf263", "committedDate": "2020-08-04T21:30:20Z", "message": "updating changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTg5NjUy", "url": "https://github.com/linkedin/rest.li/pull/359#pullrequestreview-461189652", "createdAt": "2020-08-04T21:32:10Z", "commit": {"oid": "d60568b5a6d391cdf1fcec170de90951e8eaf263"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4896, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}