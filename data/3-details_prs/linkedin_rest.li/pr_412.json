{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNDQ4MDEw", "number": 412, "title": "Generate code to avoid reflection and map access to improve generated data template runtime performance", "bodyText": "Important changes:\n\nUse member variables to avoid looking in to DataMap for every read calls. ChangeListeners on Map added to invalidate these fields when underlying map changes.\nUse optimized coercion methods for primitive fields.\nUse generated constants for default values for faster lookup.\nExamples:\nSimpleAfter.txt\nSimpleBefore.txt\nWithOptionalComplexTypeDefaultsAfter.txt\nWIthOptionalComplexTypeDefaultsBefore.txt", "createdAt": "2020-09-09T03:02:50Z", "url": "https://github.com/linkedin/rest.li/pull/412", "merged": true, "mergeCommit": {"oid": "5e3db48c65e69fa47ca9422cfe0f127da2a96c91"}, "closed": true, "closedAt": "2020-09-23T17:11:54Z", "author": {"login": "karthikrg"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHEufFABqjM3NDM4NTcwMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLmY9-AH2gAyNDgyNDQ4MDEwOjI1ODE4OTQ1Y2UwYmEyMjM4OTA3YjMzMmE4MDczYjQwMWU1NzVlMWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "583481387eb868eac810721446062651c0780c7c", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/583481387eb868eac810721446062651c0780c7c", "committedDate": "2020-09-09T03:00:36Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "b992f7036699dcd5b6e71ead28a567eab318e840", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/b992f7036699dcd5b6e71ead28a567eab318e840", "committedDate": "2020-09-09T04:44:53Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b992f7036699dcd5b6e71ead28a567eab318e840", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/b992f7036699dcd5b6e71ead28a567eab318e840", "committedDate": "2020-09-09T04:44:53Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "c494ea7e33b998a528649fbefae26462caab877b", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/c494ea7e33b998a528649fbefae26462caab877b", "committedDate": "2020-09-09T05:23:13Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c494ea7e33b998a528649fbefae26462caab877b", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/c494ea7e33b998a528649fbefae26462caab877b", "committedDate": "2020-09-09T05:23:13Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "23590dd439724ad79d2332075c8942ccf8b29f10", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/23590dd439724ad79d2332075c8942ccf8b29f10", "committedDate": "2020-09-09T06:57:16Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23590dd439724ad79d2332075c8942ccf8b29f10", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/23590dd439724ad79d2332075c8942ccf8b29f10", "committedDate": "2020-09-09T06:57:16Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "6f309c1f7550c816463d1c8b2b09dfbc1444fb06", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/6f309c1f7550c816463d1c8b2b09dfbc1444fb06", "committedDate": "2020-09-09T07:32:25Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODkxODAz", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-484891803", "createdAt": "2020-09-09T10:57:53Z", "commit": {"oid": "6f309c1f7550c816463d1c8b2b09dfbc1444fb06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDo1Nzo1NFrOHPB7Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDo1Nzo1NFrOHPB7Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUyMjIxOQ==", "bodyText": "This might not be safe?\nAtleast for existing record templates, we need to do the checks to ensure there are no cycles in the data.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r485522219", "createdAt": "2020-09-09T10:57:54Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/template/WrappingArrayTemplate.java", "diffHunk": "@@ -43,15 +43,14 @@ protected WrappingArrayTemplate(DataList list, ArrayDataSchema schema, Class<E>\n       throws TemplateOutputCastException\n   {\n     super(list, schema, elementClass, DataList.class);\n-    _constructor = DataTemplateUtil.templateConstructor(elementClass, schema.getItems());\n-    _cache = new DataObjectToObjectCache<E>(data().size());\n+    _cache = new DataObjectToObjectCache<>(DataMapBuilder.getOptimumHashMapCapacityFromSize(list.size()));\n   }\n \n   @Override\n   public boolean add(E element) throws ClassCastException\n   {\n     Object unwrapped;\n-    boolean result = _list.add(unwrapped = unwrap(element));\n+    boolean result = CheckedUtil.addWithoutChecking(_list, unwrapped = unwrap(element));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f309c1f7550c816463d1c8b2b09dfbc1444fb06"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f309c1f7550c816463d1c8b2b09dfbc1444fb06", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/6f309c1f7550c816463d1c8b2b09dfbc1444fb06", "committedDate": "2020-09-09T07:32:25Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/93c1e95f96d4dd6b948b04521bd207d70bfb23d8", "committedDate": "2020-09-10T00:33:24Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDM5NTQ0", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-487039544", "createdAt": "2020-09-11T18:42:21Z", "commit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODo0MjoyMVrOHQpzEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMDowMjo0MFrOHQwxoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyNDA4MA==", "bodyText": "This should also check for Data.NULL.\nwe put Data.NULL in the datamap if we see null while decoding. Mainly used for union with null, but can also happen for other fields", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487224080", "createdAt": "2020-09-11T18:42:21Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/collections/CheckedMap.java", "diffHunk": "@@ -241,13 +258,22 @@ public void putAll(Map<? extends K, ? extends V> m)\n     checkAll(m);\n     checkMutability();\n     _map.putAll(m);\n+    notifyChangeListenersOnPutAll(m);\n   }\n \n   @Override\n+  @SuppressWarnings(\"unchecked\")\n   public V remove(Object key)\n   {\n     checkMutability();\n-    return _map.remove(key);\n+    V oldValue = _map.remove(key);\n+\n+    if (oldValue != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI0MjUxNg==", "bodyText": "Add @OverRide (same for similar changes in other files)", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487242516", "createdAt": "2020-09-11T19:18:59Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/template/BooleanArray.java", "diffHunk": "@@ -68,4 +69,16 @@ public BooleanArray copy() throws CloneNotSupportedException\n   {\n     return (BooleanArray) super.copy();\n   }\n+\n+  protected Object coerceInput(Boolean object) throws ClassCastException\n+  {\n+    ArgumentUtil.notNull(object, \"object\");\n+    return object;\n+  }\n+\n+  protected Boolean coerceOutput(Object object) throws TemplateOutputCastException\n+  {\n+    assert(object != null);\n+    return DataTemplateUtil.coerceBooleanOutput(object);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyNzQ1NQ==", "bodyText": "We can avoid this if we override ::data() in IdResponse to return null..\n--- a/restli-common/src/main/java/com/linkedin/restli/common/IdResponse.java\n+++ b/restli-common/src/main/java/com/linkedin/restli/common/IdResponse.java\n@@ -17,6 +17,7 @@\n package com.linkedin.restli.common;\n \n \n+import com.linkedin.data.DataMap;\n import com.linkedin.data.template.RecordTemplate;\n \n \n@@ -41,10 +42,15 @@ public class IdResponse<K> extends RecordTemplate\n \n   public IdResponse(K key)\n   {\n-    super(null, null);\n+    super(new DataMap(), null);\n     _key = key;\n   }\n \n+  @Override\n+  public DataMap data() {\n+    return null;\n+  }\n+\n   public K getId()\n   {\n     return _key;", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487327455", "createdAt": "2020-09-11T23:08:13Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/template/RecordTemplate.java", "diffHunk": "@@ -403,6 +404,21 @@ else if ((template = (DataTemplate<?>) getCache().get(found)) != null && templat\n     return wrapped;\n   }\n \n+  /**\n+   * Register a change listener to get notified when the underlying map changes.\n+   */\n+  protected void addChangeListener(BiFunction<String, Object, Void> listener)\n+  {\n+    //\n+    // This UGLY hack is needed because IdResponse breaks the implicit RecordTemplate contract and passes in\n+    // a null datamap. We even have a test for this obnoxious behavior.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyOTg3MQ==", "bodyText": "The last argument is supposed to be the type of object stored in DataList(dataClass), so using DataList.class here is wrong. This was not failing because the dataClass is not used for Wrapping*Template classes.\nHowever, using DataList (and DataMap for MapTemplate) is confusing. We should atleast change it to Object.class", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487329871", "createdAt": "2020-09-11T23:19:46Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/template/WrappingArrayTemplate.java", "diffHunk": "@@ -43,15 +43,14 @@ protected WrappingArrayTemplate(DataList list, ArrayDataSchema schema, Class<E>\n       throws TemplateOutputCastException\n   {\n     super(list, schema, elementClass, DataList.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyOTk3MA==", "bodyText": "DataMap.class -> Object.class (see my comment above)", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487329970", "createdAt": "2020-09-11T23:20:15Z", "author": {"login": "karthikbalasub"}, "path": "data/src/main/java/com/linkedin/data/template/WrappingMapTemplate.java", "diffHunk": "@@ -48,8 +50,7 @@ protected WrappingMapTemplate(DataMap map, MapDataSchema schema, Class<V> valueC\n       throws TemplateOutputCastException\n   {\n     super(map, schema, valueClass, DataMap.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMzODQwMA==", "bodyText": "What if we set the instance vars for primitive fields to the value if the value is not null? It would avoid a map lookup when the field is accessed later.\neg,\nprivate Void onUnderlyingMapChanged(String key, Object value) {\nswitch (key) {\n           // _owner_name is primitive, so we can initialize the field\n            case \"owner_name\":\n                _owner_name = value instanceOf String.class ? (String) value : null;\n                return null;\n            case \"acls\":\n               // _acls is ACLArray so no need to wrap unless the field is accessed. \n                _acls = null;\n                return null;\n        }\n        return null;", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r487338400", "createdAt": "2020-09-12T00:02:40Z", "author": {"login": "karthikbalasub"}, "path": "generator/src/main/java/com/linkedin/pegasus/generator/JavaDataTemplateGenerator.java", "diffHunk": "@@ -1218,6 +1443,110 @@ private void generateConstructorWithMap(JDefinedClass cls, JClass valueClass)\n     argConstructor.body().invoke(\"putAll\").arg(m);\n   }\n \n+  private void generateOnUnderlyingMapChanged(JDefinedClass cls, Map<String, JVar> fieldMap)\n+  {\n+    final JMethod method = cls.method(JMod.PRIVATE, Void.class, \"onUnderlyingMapChanged\");\n+    final JVar keyParam = method.param(String.class, \"key\");\n+    method.param(_objectClass, \"value\");\n+    JSwitch keySwitch = method.body()._switch(keyParam);\n+    fieldMap.forEach((key, field) -> {\n+      JCase keyCase = keySwitch._case(JExpr.lit(key));\n+      keyCase.body().assign(field, JExpr._null());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 623}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/93c1e95f96d4dd6b948b04521bd207d70bfb23d8", "committedDate": "2020-09-10T00:33:24Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/57c3149aef41a96fada7b0844b9fbd0e149e89ab", "committedDate": "2020-09-14T06:38:48Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MTM3MzY1", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-488137365", "createdAt": "2020-09-14T21:00:17Z", "commit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMTowMDoxN1rOHRmZUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMToxMTo1OVrOHRmwfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxNjkxMw==", "bodyText": "Is it possible to just reduce this to being package-private? Don't think we'd want this field to be settable by subclasses.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r488216913", "createdAt": "2020-09-14T21:00:17Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/RecordTemplate.java", "diffHunk": "@@ -499,7 +515,7 @@ private boolean checkPutNullValue(RecordDataSchema.Field field, Object object, S\n     return _cache;\n   }\n \n-  private DataMap _map;\n+  protected DataMap _map;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxODcwOQ==", "bodyText": "I'd suggest being a little more clear in this Javadoc: say that this method returns the class of this type's in-memory data representation (perhaps can be rephrased).", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r488218709", "createdAt": "2020-09-14T21:04:02Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/DataTemplateUtil.java", "diffHunk": "@@ -392,6 +415,41 @@ public static TyperefInfo getTyperefInfo(Class<? extends DataTemplate> type)\n     return typerefInfo;\n   }\n \n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyMDk0OA==", "bodyText": "For all of these new methods you're introducing, consider the access level carefully. Do all of these need to be public? Can we reduce any of them to private, or package-private? If so, then we definitely should.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r488220948", "createdAt": "2020-09-14T21:08:33Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/DataTemplateUtil.java", "diffHunk": "@@ -832,14 +903,46 @@ public static boolean hasCoercer(Class<?> klass)\n       if (fromClass.isEnum())\n         return object.toString();\n     }\n-    @SuppressWarnings(\"unchecked\") DirectCoercer<T> coercer = (DirectCoercer<T>) _classToCoercerMap.get(fromClass);\n+\n+    return coerceCustomInput(object, fromClass);\n+  }\n+\n+  public static Object coerceIntInput(Integer value)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyMjIzOQ==", "bodyText": "Would splitting the work up into 2 PRs be backward-compatible? For instance, we don't want to introduce a public method in PR 1, then remove it in PR 2 once we have the fix. If not, then I'd suggest doing the fix in this PR.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r488222239", "createdAt": "2020-09-14T21:10:44Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/RecordTemplate.java", "diffHunk": "@@ -403,6 +404,21 @@ else if ((template = (DataTemplate<?>) getCache().get(found)) != null && templat\n     return wrapped;\n   }\n \n+  /**\n+   * Register a change listener to get notified when the underlying map changes.\n+   */\n+  protected void addChangeListener(BiFunction<String, Object, Void> listener)\n+  {\n+    //\n+    // This UGLY hack is needed because IdResponse breaks the implicit RecordTemplate contract and passes in\n+    // a null datamap. We even have a test for this obnoxious behavior.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyNzQ1NQ=="}, "originalCommit": {"oid": "93c1e95f96d4dd6b948b04521bd207d70bfb23d8"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyMjg0NA==", "bodyText": "If this is no longer just for unit tests, please remove the comment.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r488222844", "createdAt": "2020-09-14T21:11:59Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/DataMap.java", "diffHunk": "@@ -401,7 +401,7 @@ void disableChecker()\n   }\n \n   // Unit test use only\n-  Map<String, Object> getUnderlying()\n+  protected Map<String, Object> getUnderlying()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57c3149aef41a96fada7b0844b9fbd0e149e89ab", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/57c3149aef41a96fada7b0844b9fbd0e149e89ab", "committedDate": "2020-09-14T06:38:48Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/2d76cf2f22a762b62f93bdf61cb7e644e8f770d8", "committedDate": "2020-09-16T22:04:34Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxOTc5NTkw", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-491979590", "createdAt": "2020-09-19T07:39:31Z", "commit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzozOTozMVrOHUjeRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzozOTozMVrOHUjeRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTMxNDc1Ng==", "bodyText": "nit: This cycled situation does not sounds like an IOException, we probably want to throw exceptions more close to whats happening.\nOne question to ask is, if previously we don't check this cycling condition and now we are blocking them, would it cause any unexpected runtime issue we have to deal with?", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r491314756", "createdAt": "2020-09-19T07:39:31Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -693,6 +720,29 @@ private static boolean reachable(DataComplex source, Object destination)\n     return false;\n   }\n \n+  /**\n+   * Check for cycles.\n+   *\n+   * <p>This checks if the given {@link DataComplex} is present in the given set of ancestor complexes. If yes,\n+   * then it indicates that a cycle exists and we throw an exception. If not, we add it to the set.</p>\n+   *\n+   * @param dataComplex The current {@link DataComplex}\n+   * @param ancestorSet The set containing all ancestors of the {@link DataComplex}\n+   * @param pathList The list of paths encountered so far. Used to populate a useful exception message when a cycle is\n+   *                 detected.\n+   * @throws IOException If this {@link DataComplex} is present in the ancestor set indicating a cycle.\n+   */\n+  private static void checkForCyclesAndAdd(DataComplex dataComplex,\n+      Set<DataComplex> ancestorSet, List<String> pathList) throws IOException\n+  {\n+    if (ancestorSet.contains(dataComplex))\n+    {\n+      throw new IOException(\"Cycle detected. Path: \" + pathList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxOTgwMjI1", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-491980225", "createdAt": "2020-09-19T07:48:21Z", "commit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzo0ODoyMVrOHUjppg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzo0ODoyMVrOHUjppg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTMxNzY3MA==", "bodyText": "Just curious, how/and why do we want to put WeakReference here.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r491317670", "createdAt": "2020-09-19T07:48:21Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/collections/CheckedMap.java", "diffHunk": "@@ -299,6 +326,27 @@ private final void checkMutability()\n     }\n   }\n \n+  /**\n+   * Add a change listener to be notified of changes to the underlying map.\n+   *\n+   * <p>This class internally maintains weak references to the listeners to avoid leaking them.</p>\n+   *\n+   * @param listener The listener to register.\n+   */\n+  public final void addChangeListener(BiFunction<K, V, Void> listener)\n+  {\n+    if (_changeListeners == null)\n+    {\n+      // Change listeners are mostly used by map wrappers, and most maps will only have 1\n+      // wrapper, so initialize list with a capacity of 1.\n+      _changeListeners = new ArrayList<>(1);\n+    }\n+\n+    // Maintain a weak reference to to the listener to avoid leaking the wrapper beyond its\n+    // lifetime.\n+    _changeListeners.add(new WeakReference<>(listener));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 164}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxOTgwMzA2", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-491980306", "createdAt": "2020-09-19T07:49:54Z", "commit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzo0OTo1NVrOHUjrgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNzo0OTo1NVrOHUjrgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTMxODE0Nw==", "bodyText": "New to restli, why do we want to listen to data structure changes?", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r491318147", "createdAt": "2020-09-19T07:49:55Z", "author": {"login": "BrianPin"}, "path": "data/src/main/java/com/linkedin/data/collections/CheckedMap.java", "diffHunk": "@@ -149,14 +156,23 @@ public CheckedMap(int initialCapacity, MapChecker<K,V> checker)\n   public CheckedMap(int initialCapacity, float loadFactor, MapChecker<K,V> checker)\n   {\n     _checker = checker;\n-    _map = new HashMap<K,V>(initialCapacity, loadFactor);\n+    _map = new HashMap<>(initialCapacity, loadFactor);\n   }\n \n   @Override\n   public void clear()\n   {\n     checkMutability();\n+    Set<K> keys = null;\n+    if (_changeListeners != null)\n+    {\n+      keys = new HashSet<>(keySet());\n+    }\n     _map.clear();\n+    if (keys != null)\n+    {\n+      notifyChangeListenersOnClear(keys);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTI2NDMy", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-493126432", "createdAt": "2020-09-22T04:54:30Z", "commit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDo1NDozMFrOHVqMHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNToxMToxMlrOHVqarQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MzM3Mw==", "bodyText": "Can we keep this protected, then reduce it to private in a later major version release? Doing this would be better practice and I doubt it would cause problems (since I don't think anyone is gonna set it between now and the next major version).", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r492473373", "createdAt": "2020-09-22T04:54:30Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/WrappingArrayTemplate.java", "diffHunk": "@@ -162,7 +161,17 @@ protected E cacheLookup(Object object, int index) throws TemplateOutputCastExcep\n     return wrapped;\n   }\n \n-  protected final Constructor<E> _constructor;\n+  protected E coerceOutput(Object value) throws TemplateOutputCastException\n+  {\n+    if (_constructor == null)\n+    {\n+      _constructor = DataTemplateUtil.templateConstructor(_elementClass, schema().getItems());\n+    }\n+\n+    return DataTemplateUtil.wrap(value, _constructor);\n+  }\n+\n+  private Constructor<E> _constructor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MzQ1Mg==", "bodyText": "Same comment as above.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r492473452", "createdAt": "2020-09-22T04:54:49Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/template/WrappingMapTemplate.java", "diffHunk": "@@ -318,7 +329,7 @@ public V setValue(V value) throws ClassCastException, TemplateOutputCastExceptio\n \n   }\n \n-  protected final Constructor<V> _constructor;\n+  private Constructor<V> _constructor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NzEwMQ==", "bodyText": "Why bother having the \"add\" logic bundled in with this method? I can think of a couple reasons to move it out:\n\nImproves readability in the containing method because there's visible symmetry between the \"add ancestor\" and \"remove ancestor\" statements.\nAdds an on-success side effect to an otherwise assertion-like method. Method is cleaner and simpler if it's just a \"check for cycles\" method.\nAdding the ancestor isn't really related to this method and could just be included outside the method. Could just move the last line outside to get the same effect.", "url": "https://github.com/linkedin/rest.li/pull/412#discussion_r492477101", "createdAt": "2020-09-22T05:11:12Z", "author": {"login": "evanw555"}, "path": "data/src/main/java/com/linkedin/data/Data.java", "diffHunk": "@@ -693,6 +720,29 @@ private static boolean reachable(DataComplex source, Object destination)\n     return false;\n   }\n \n+  /**\n+   * Check for cycles.\n+   *\n+   * <p>This checks if the given {@link DataComplex} is present in the given set of ancestor complexes. If yes,\n+   * then it indicates that a cycle exists and we throw an exception. If not, we add it to the set.</p>\n+   *\n+   * @param dataComplex The current {@link DataComplex}\n+   * @param ancestorSet The set containing all ancestors of the {@link DataComplex}\n+   * @param pathList The list of paths encountered so far. Used to populate a useful exception message when a cycle is\n+   *                 detected.\n+   * @throws IOException If this {@link DataComplex} is present in the ancestor set indicating a cycle.\n+   */\n+  private static void checkForCyclesAndAdd(DataComplex dataComplex,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6c0a1514b135ac197a6015a19a5cedda3600bc", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/6e6c0a1514b135ac197a6015a19a5cedda3600bc", "committedDate": "2020-09-22T05:32:52Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d76cf2f22a762b62f93bdf61cb7e644e8f770d8", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/2d76cf2f22a762b62f93bdf61cb7e644e8f770d8", "committedDate": "2020-09-16T22:04:34Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}, "afterCommit": {"oid": "6e6c0a1514b135ac197a6015a19a5cedda3600bc", "author": {"user": {"login": "li-kramgopa", "name": null}}, "url": "https://github.com/linkedin/rest.li/commit/6e6c0a1514b135ac197a6015a19a5cedda3600bc", "committedDate": "2020-09-22T05:32:52Z", "message": "Generate code to avoid reflection and map access to improve generated datatemplate runtime performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTc5Nzg5", "url": "https://github.com/linkedin/rest.li/pull/412#pullrequestreview-493179789", "createdAt": "2020-09-22T07:14:05Z", "commit": {"oid": "6e6c0a1514b135ac197a6015a19a5cedda3600bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25818945ce0ba2238907b332a8073b401e575e1f", "author": {"user": {"login": "karthikrg", "name": "Karthik Ramgopal"}}, "url": "https://github.com/linkedin/rest.li/commit/25818945ce0ba2238907b332a8073b401e575e1f", "committedDate": "2020-09-23T06:14:04Z", "message": "Merge branch 'master' into master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4654, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}