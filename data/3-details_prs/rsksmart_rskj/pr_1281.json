{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MzI3Njk1", "number": 1281, "title": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork", "bodyText": "Creating this as draft for review since it has placeholders for hardfork activation name and RSKIP names as well.\nThe bulk of the testing is done via DSL, which allowed for testing behavior with and without MutableTrieCache effects and pre and post activation of the hardfork", "createdAt": "2020-07-24T14:45:34Z", "url": "https://github.com/rsksmart/rskj/pull/1281", "merged": true, "mergeCommit": {"oid": "ab77e77d5aaa74279819dccf3eb8335b2a9593b4"}, "closed": true, "closedAt": "2020-09-03T14:04:56Z", "author": {"login": "nicops"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4Gm4-gBqjM1ODQ2MzMzOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFRIhWgFqTQ4MTg3Mjg3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c367f42afc6b1a95b593e0f0bbf14cd60138db40", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/c367f42afc6b1a95b593e0f0bbf14cd60138db40", "committedDate": "2020-07-24T14:41:06Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}, "afterCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d2e7865af2a39a7fbf75c764563623f16254153d", "committedDate": "2020-07-24T16:19:10Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzIxNDM2", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-457721436", "createdAt": "2020-07-29T17:07:23Z", "commit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzowNzoyNFrOG5B62w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzozNjozOVrOG5C_4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1MzQ2Nw==", "bodyText": "was it agree by the team ?  hah", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r462453467", "createdAt": "2020-07-29T17:07:24Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/NetworkUpgrade.java", "diffHunk": "@@ -26,7 +26,8 @@\n     ORCHID_060(\"orchid060\"),\n     WASABI_100(\"wasabi100\"),\n     PAPYRUS_200(\"papyrus200\"),\n-    TWOTOTHREE(\"twoToThree\");\n+    TWOTOTHREE(\"twoToThree\"),\n+    COVID220(\"covid220\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2ODYwMA==", "bodyText": "It's wrong. The key is an address that it's a contract but without code. Then, we are in the case it has empty code. The answer should be KECCAK_256_OF_EMPTY_ARRAY", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r462468600", "createdAt": "2020-07-29T17:32:16Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/db/MutableRepository.java", "diffHunk": "@@ -158,21 +159,47 @@ public synchronized int getCodeLength(RskAddress addr) {\n     }\n \n     @Override\n-    public synchronized Keccak256 getCodeHash(RskAddress addr) {\n+    public synchronized Keccak256 getCodeHashNonStandard(RskAddress addr) {\n \n         if (!isExist(addr)) {\n             return Keccak256.ZERO_HASH;\n         }\n \n         if (!isContract(addr)) {\n-            return new Keccak256(\n-                    Keccak256Helper.keccak256(EMPTY_BYTE_ARRAY));\n+            return KECCAK_256_OF_EMPTY_ARRAY;\n         }\n \n         byte[] key = trieKeyMapper.getCodeKey(addr);\n-        return mutableTrie.getValueHash(key);\n-    }\n+        Keccak256 valueHash = mutableTrie.getValueHash(key);\n+\n+        if (valueHash == null) {\n+            //This is the non standard implementation we had pre RskipEXTCODEHASH implementation\n+            //and thus me must honor it.\n+            return Keccak256.ZERO_HASH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2ODk5Nw==", "bodyText": "Well, this is correct", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r462468997", "createdAt": "2020-07-29T17:32:59Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/db/MutableRepository.java", "diffHunk": "@@ -158,21 +159,47 @@ public synchronized int getCodeLength(RskAddress addr) {\n     }\n \n     @Override\n-    public synchronized Keccak256 getCodeHash(RskAddress addr) {\n+    public synchronized Keccak256 getCodeHashNonStandard(RskAddress addr) {\n \n         if (!isExist(addr)) {\n             return Keccak256.ZERO_HASH;\n         }\n \n         if (!isContract(addr)) {\n-            return new Keccak256(\n-                    Keccak256Helper.keccak256(EMPTY_BYTE_ARRAY));\n+            return KECCAK_256_OF_EMPTY_ARRAY;\n         }\n \n         byte[] key = trieKeyMapper.getCodeKey(addr);\n-        return mutableTrie.getValueHash(key);\n-    }\n+        Keccak256 valueHash = mutableTrie.getValueHash(key);\n+\n+        if (valueHash == null) {\n+            //This is the non standard implementation we had pre RskipEXTCODEHASH implementation\n+            //and thus me must honor it.\n+            return Keccak256.ZERO_HASH;\n+        }\n+\n+        return valueHash;    }\n \n+    @Override\n+    public synchronized Keccak256 getCodeHashStandard(RskAddress addr) {\n+\n+        if (!isExist(addr)) {\n+            return Keccak256.ZERO_HASH;\n+        }\n+\n+        if (!isContract(addr)) {\n+            return KECCAK_256_OF_EMPTY_ARRAY;\n+        }\n+\n+        byte[] key = trieKeyMapper.getCodeKey(addr);\n+        Keccak256 valueHash = mutableTrie.getValueHash(key);\n+\n+        if (valueHash == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ3MTEzNw==", "bodyText": "is zeroHash variable being used ?", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r462471137", "createdAt": "2020-07-29T17:36:39Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/test/java/co/rsk/db/MutableTrieCacheTest.java", "diffHunk": "@@ -433,8 +433,8 @@ public void testGetValueNotStoredAndGetHash() {\n         byte[] wrongKey = toBytes(\"BOB\");\n         Keccak256 zeroHash = Keccak256.ZERO_HASH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2e7865af2a39a7fbf75c764563623f16254153d", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d2e7865af2a39a7fbf75c764563623f16254153d", "committedDate": "2020-07-24T16:19:10Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}, "afterCommit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/500c5c6aca365d668b602dfe5bb0e857334ddc0e", "committedDate": "2020-08-03T14:31:13Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjcwNDcz", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-460670473", "createdAt": "2020-08-04T09:59:25Z", "commit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTo1OToyNVrOG7ZqbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDowNzoxNlrOG7Z61Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzOTYyOQ==", "bodyText": "can we mark this method with @Nullable annotation. Some IDE's and static code analysis tools will complain when calling methods on a result of this method without checking it for null.", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r464939629", "createdAt": "2020-08-04T09:59:25Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/db/MutableTrieCache.java", "diffHunk": "@@ -235,7 +235,7 @@ public Uint24 getValueLength(byte[] key) {\n \n     @Override\n     public Keccak256 getValueHash(byte[] key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzOTgyMQ==", "bodyText": "Same here - @Nullable result", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r464939821", "createdAt": "2020-08-04T09:59:48Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/db/MutableTrieImpl.java", "diffHunk": "@@ -89,9 +89,8 @@ public Uint24 getValueLength(byte[] key) {\n     @Override\n     public Keccak256 getValueHash(byte[] key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0MzgyOQ==", "bodyText": "2020 ? J", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r464943829", "createdAt": "2020-08-04T10:07:16Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/test/java/co/rsk/vm/ExtCodeHashDslTest.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2018 RSK Labs Ltd.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDYwODI5", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-461060829", "createdAt": "2020-08-04T18:23:20Z", "commit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "500c5c6aca365d668b602dfe5bb0e857334ddc0e", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/500c5c6aca365d668b602dfe5bb0e857334ddc0e", "committedDate": "2020-08-03T14:31:13Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}, "afterCommit": {"oid": "4a0881f53f3b0641a468575deb06c0a9fd8a99a7", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/4a0881f53f3b0641a468575deb06c0a9fd8a99a7", "committedDate": "2020-08-04T20:24:28Z", "message": "Changed MutableTrie#getValueHash to return Optional"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a0881f53f3b0641a468575deb06c0a9fd8a99a7", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/4a0881f53f3b0641a468575deb06c0a9fd8a99a7", "committedDate": "2020-08-04T20:24:28Z", "message": "Changed MutableTrie#getValueHash to return Optional"}, "afterCommit": {"oid": "94acf60cd68963533897cfb2a7fd0e8d41affac5", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/94acf60cd68963533897cfb2a7fd0e8d41affac5", "committedDate": "2020-08-28T15:08:14Z", "message": "Rename hardfork to iris"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3ODE3MzQy", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-477817342", "createdAt": "2020-08-28T15:19:48Z", "commit": {"oid": "94acf60cd68963533897cfb2a7fd0e8d41affac5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNToxOTo0OFrOHJKoSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNToxOTo0OFrOHJKoSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM3MzM4Ng==", "bodyText": "iris300?", "url": "https://github.com/rsksmart/rskj/pull/1281#discussion_r479373386", "createdAt": "2020-08-28T15:19:48Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/resources/reference.conf", "diffHunk": "@@ -37,7 +37,7 @@ blockchain = {\n             rskip152 = papyrus200\n             rskip156 = papyrus200\n             rskipUMM = papyrus200\n-            rskip169 = hop\n+            rskip169 = iris", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94acf60cd68963533897cfb2a7fd0e8d41affac5"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94acf60cd68963533897cfb2a7fd0e8d41affac5", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/94acf60cd68963533897cfb2a7fd0e8d41affac5", "committedDate": "2020-08-28T15:08:14Z", "message": "Rename hardfork to iris"}, "afterCommit": {"oid": "2c87c35588ced35560b2309f805070cdcb8ec03b", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/2c87c35588ced35560b2309f805070cdcb8ec03b", "committedDate": "2020-09-02T15:08:50Z", "message": "Rename hardfork to iris"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21773f3faa38310c5b1e3ecf58294ae5113540bf", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/21773f3faa38310c5b1e3ecf58294ae5113540bf", "committedDate": "2020-09-02T15:59:37Z", "message": "Fix issue #1264 incompatible EXTCODEHASH implementation, with hardfork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef990277ffe8d93e602bc42f78b252781bb2fe6b", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/ef990277ffe8d93e602bc42f78b252781bb2fe6b", "committedDate": "2020-09-02T15:59:37Z", "message": "Changed MutableTrie#getValueHash to return Optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6988fdafbc6ca8b76375dfdb64814e170b37a2b9", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/6988fdafbc6ca8b76375dfdb64814e170b37a2b9", "committedDate": "2020-09-02T16:09:22Z", "message": "Rename hardfork to iris300"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c87c35588ced35560b2309f805070cdcb8ec03b", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/2c87c35588ced35560b2309f805070cdcb8ec03b", "committedDate": "2020-09-02T15:08:50Z", "message": "Rename hardfork to iris"}, "afterCommit": {"oid": "6988fdafbc6ca8b76375dfdb64814e170b37a2b9", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/6988fdafbc6ca8b76375dfdb64814e170b37a2b9", "committedDate": "2020-09-02T16:09:22Z", "message": "Rename hardfork to iris300"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMDIwMTg1", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-481020185", "createdAt": "2020-09-02T16:59:02Z", "commit": {"oid": "6988fdafbc6ca8b76375dfdb64814e170b37a2b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxODcyODc5", "url": "https://github.com/rsksmart/rskj/pull/1281#pullrequestreview-481872879", "createdAt": "2020-09-03T14:04:33Z", "commit": {"oid": "6988fdafbc6ca8b76375dfdb64814e170b37a2b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 494, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}