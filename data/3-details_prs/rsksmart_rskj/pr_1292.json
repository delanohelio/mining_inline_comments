{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTU5MTM4", "number": 1292, "title": "Fix index DB shutdown NPE", "bodyText": "Issue\n\nWhen we a halt of the JVM (on purpose or not), we have a NPE trying to commit the changes on the indexDB. So last blocks were lost.\nThe problem was that the DB was initialised with a property of closeOnShutdown, so when we try to flush it's already closed (shouldn't throw a NPE, but thats because we use an older version of mapdb).\n\nSolution\n\nWhat i did was just remove the option of automatically closing the db when shutdown, and do it \"manually\" after flushing.\n\nTest\n\nDont know how to properly test it, i just run a node -> stop it by halting the jvm -> start it again (checking that the last block number its the same as when starts).\n\nException thrown\n\nException in thread \"Thread-3\" java.lang.NullPointerException\n\tat org.mapdb.StoreDirect.indexValGet(StoreDirect.java:1575)\n\tat org.mapdb.StoreWAL.indexValGet(StoreWAL.java:307)\n\tat org.mapdb.StoreDirect.update2(StoreDirect.java:378)\n\tat org.mapdb.StoreCached.flushWriteCacheSegment(StoreCached.java:454)\n\tat org.mapdb.StoreCached.flushWriteCache(StoreCached.java:429)\n\tat org.mapdb.StoreWAL.commit(StoreWAL.java:613)\n\tat org.mapdb.Engine$CloseOnJVMShutdown.commit(Engine.java:489)\n\tat org.mapdb.DB.commit(DB.java:2638)\n\tat co.rsk.db.MapDBBlocksIndex.flush(MapDBBlocksIndex.java:136)\n\tat org.ethereum.db.IndexedBlockStore.flush(IndexedBlockStore.java:182)\n\tat co.rsk.core.bc.BlockChainFlusher.flushAll(BlockChainFlusher.java:87)\n\tat co.rsk.core.bc.BlockChainFlusher.stop(BlockChainFlusher.java:69)\n\tat co.rsk.FullNodeRunner.stop(FullNodeRunner.java:76)\n\tat java.lang.Thread.run(Thread.java:748)", "createdAt": "2020-08-12T19:19:56Z", "url": "https://github.com/rsksmart/rskj/pull/1292", "merged": true, "mergeCommit": {"oid": "9262324e2f04329b234f9e7bb6ce7d84c56be519"}, "closed": true, "closedAt": "2020-09-03T21:39:25Z", "author": {"login": "patogallaiovlabs"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-kqLFAFqTQ2NzA0MTUzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFXDB9gFqTQ4MjE5NzkyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDQxNTM3", "url": "https://github.com/rsksmart/rskj/pull/1292#pullrequestreview-467041537", "createdAt": "2020-08-13T18:51:15Z", "commit": {"oid": "8e7bde44a8833e37eecf3204287352e1321c8c9d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo1MToxNVrOHAZIZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo1MToxNVrOHAZIZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3Mzc5Ng==", "bodyText": "Should we add  trieStore.dispose()?", "url": "https://github.com/rsksmart/rskj/pull/1292#discussion_r470173796", "createdAt": "2020-08-13T18:51:15Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/co/rsk/core/bc/BlockChainFlusher.java", "diffHunk": "@@ -67,6 +67,13 @@ public void start() {\n     public void stop() {\n         emitter.removeListener(listener);\n         flushAll();\n+        closeAll();\n+    }\n+\n+    private void closeAll() {\n+        logger.trace(\"closing blockStore.\");\n+        blockStore.close();\n+        logger.trace(\"blockStore closed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e7bde44a8833e37eecf3204287352e1321c8c9d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTY4NDgw", "url": "https://github.com/rsksmart/rskj/pull/1292#pullrequestreview-467568480", "createdAt": "2020-08-14T13:20:52Z", "commit": {"oid": "8e7bde44a8833e37eecf3204287352e1321c8c9d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e7bde44a8833e37eecf3204287352e1321c8c9d", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8e7bde44a8833e37eecf3204287352e1321c8c9d", "committedDate": "2020-08-12T19:07:49Z", "message": "Fix logback"}, "afterCommit": {"oid": "be6323a3bd8fbf96b51d78fe5340e8538696b0bb", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/be6323a3bd8fbf96b51d78fe5340e8538696b0bb", "committedDate": "2020-08-19T14:49:10Z", "message": "Fix logback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be6323a3bd8fbf96b51d78fe5340e8538696b0bb", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/be6323a3bd8fbf96b51d78fe5340e8538696b0bb", "committedDate": "2020-08-19T14:49:10Z", "message": "Fix logback"}, "afterCommit": {"oid": "ca0909f6e23a69c8b537318fecfcf7ca4383b99e", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ca0909f6e23a69c8b537318fecfcf7ca4383b99e", "committedDate": "2020-08-27T15:48:00Z", "message": "Fix logback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2OTA0ODcx", "url": "https://github.com/rsksmart/rskj/pull/1292#pullrequestreview-476904871", "createdAt": "2020-08-27T16:47:57Z", "commit": {"oid": "ca0909f6e23a69c8b537318fecfcf7ca4383b99e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fea70b842961ceb43f6268be5d46336f8e4e6697", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/fea70b842961ceb43f6268be5d46336f8e4e6697", "committedDate": "2020-09-03T20:28:07Z", "message": "Fix index DB shutdown issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "352e9331e9ee794f3b20587b167f54a4e23436b5", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/352e9331e9ee794f3b20587b167f54a4e23436b5", "committedDate": "2020-09-03T20:28:07Z", "message": "Fix logback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca0909f6e23a69c8b537318fecfcf7ca4383b99e", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ca0909f6e23a69c8b537318fecfcf7ca4383b99e", "committedDate": "2020-08-27T15:48:00Z", "message": "Fix logback"}, "afterCommit": {"oid": "352e9331e9ee794f3b20587b167f54a4e23436b5", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/352e9331e9ee794f3b20587b167f54a4e23436b5", "committedDate": "2020-09-03T20:28:07Z", "message": "Fix logback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTk3OTIz", "url": "https://github.com/rsksmart/rskj/pull/1292#pullrequestreview-482197923", "createdAt": "2020-09-03T20:57:59Z", "commit": {"oid": "352e9331e9ee794f3b20587b167f54a4e23436b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 506, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}