{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MDQ3Nzk4", "number": 1377, "title": "Consider MGP in eth_getPrice", "bodyText": "Considering best block's MGP in eth_getPrice.\nDescription\nThis change takes into account best block's MGP while calculating gas price in the eth_getPrice JSON-RPC method. This resolves #1343\nMotivation and Context\n\n\nHow Has This Been Tested?\n\n\n\nUsing unit tests\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n Tests for the changes have been added (for bug fixes / features)\n Requires Activation Code (Hard Fork)\n\n\nOther information:", "createdAt": "2020-11-26T12:33:21Z", "url": "https://github.com/rsksmart/rskj/pull/1377", "merged": true, "mergeCommit": {"oid": "35292c1cc2836badbc7b524b46d8788042fb4aaf"}, "closed": true, "closedAt": "2020-12-17T16:43:46Z", "author": {"login": "Vovchyk"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgTXvEABqjQwNDI2NTQwNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnGVt7AFqTU1NDc4NjMyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd9098386bfcaf2be55fccd38fe22085f9dabc3a", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/bd9098386bfcaf2be55fccd38fe22085f9dabc3a", "committedDate": "2020-11-26T12:28:26Z", "message": "Consider MGP in eth_getPrice"}, "afterCommit": {"oid": "b53a190533ddd14c9ee878284430b446abe68ff7", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b53a190533ddd14c9ee878284430b446abe68ff7", "committedDate": "2020-11-26T13:55:59Z", "message": "Consider MGP in eth_getPrice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTExMjU1", "url": "https://github.com/rsksmart/rskj/pull/1377#pullrequestreview-539511255", "createdAt": "2020-11-26T18:50:29Z", "commit": {"oid": "b53a190533ddd14c9ee878284430b446abe68ff7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODo1MDoyOVrOH6lMBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODo1MDoyOVrOH6lMBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE4ODc0Mw==", "bodyText": "Empty blocks or unusued block space should reduce the suggested gas price, which is not happening with this formula. Probably an idea to track in the backlog, nothing actually related to this task", "url": "https://github.com/rsksmart/rskj/pull/1377#discussion_r531188743", "createdAt": "2020-11-26T18:50:29Z", "author": {"login": "donequis"}, "path": "rskj-core/src/main/java/org/ethereum/listener/GasPriceTracker.java", "diffHunk": "@@ -61,30 +75,39 @@ public void onBlock(Block block, List<TransactionReceipt> receipts) {\n         logger.trace(\"End onBlock\");\n     }\n \n-    public void onTransaction(Transaction tx) {\n+    private void onTransaction(Transaction tx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b53a190533ddd14c9ee878284430b446abe68ff7"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTc2NTUw", "url": "https://github.com/rsksmart/rskj/pull/1377#pullrequestreview-540176550", "createdAt": "2020-11-27T19:56:55Z", "commit": {"oid": "b53a190533ddd14c9ee878284430b446abe68ff7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxOTo1Njo1NVrOH7HS6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxOTo1Njo1NVrOH7HS6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc0NzU2MQ==", "bodyText": "wouldnt be better to declare max() in Coin? would be consistent with BigInteger.max()", "url": "https://github.com/rsksmart/rskj/pull/1377#discussion_r531747561", "createdAt": "2020-11-27T19:56:55Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/org/ethereum/listener/GasPriceTracker.java", "diffHunk": "@@ -61,30 +75,39 @@ public void onBlock(Block block, List<TransactionReceipt> receipts) {\n         logger.trace(\"End onBlock\");\n     }\n \n-    public void onTransaction(Transaction tx) {\n+    private void onTransaction(Transaction tx) {\n         if (tx instanceof RemascTransaction) {\n             return;\n         }\n \n         if (idx == -1) {\n-            idx = window.length - 1;\n-            filled = true;\n+            idx = WINDOW_SIZE - 1;\n             lastVal = null;  // recalculate only 'sometimes'\n         }\n \n         window[idx--] = tx.getGasPrice();\n     }\n \n-    public Coin getGasPrice() {\n-        if (!filled) {\n+    public synchronized Coin getGasPrice() {\n+        if (window[0] == null) { // not filled yet\n             return defaultPrice;\n         } else {\n             if (lastVal == null) {\n-                Coin[] values = Arrays.copyOf(window, window.length);\n+                Coin[] values = Arrays.copyOf(window, WINDOW_SIZE);\n                 Arrays.sort(values);\n                 lastVal = values[values.length / 4];  // 25% percentile\n             }\n-            return lastVal;\n+\n+            Coin bestBlockPrice = bestBlockPriceRef.get();\n+            if (bestBlockPrice == null) {\n+                return lastVal;\n+            } else {\n+                return max(lastVal, bestBlockPrice.multiply(BI_11).divide(BI_10));\n+            }\n         }\n     }\n+\n+    private static Coin max(Coin a, Coin b) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b53a190533ddd14c9ee878284430b446abe68ff7"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTE4MDIy", "url": "https://github.com/rsksmart/rskj/pull/1377#pullrequestreview-540918022", "createdAt": "2020-11-30T13:43:00Z", "commit": {"oid": "3a522fa15e05202baf6ffa6d727587a542105114"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a65bdfc84703f0f533ab613347ae6ab3124cf8", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/64a65bdfc84703f0f533ab613347ae6ab3124cf8", "committedDate": "2020-12-14T15:42:16Z", "message": "Consider MGP in eth_getPrice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "committedDate": "2020-12-14T15:42:16Z", "message": "Extracted max method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a522fa15e05202baf6ffa6d727587a542105114", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/3a522fa15e05202baf6ffa6d727587a542105114", "committedDate": "2020-11-30T13:28:00Z", "message": "Extracted max method"}, "afterCommit": {"oid": "62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663", "committedDate": "2020-12-14T15:42:16Z", "message": "Extracted max method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Nzg2MzI4", "url": "https://github.com/rsksmart/rskj/pull/1377#pullrequestreview-554786328", "createdAt": "2020-12-17T16:43:26Z", "commit": {"oid": "62e6c5e3706e19ca6b78c3ac5a95f07d7d1ff663"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 438, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}