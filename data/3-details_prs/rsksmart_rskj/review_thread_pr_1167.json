{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5NzUxMDQ4", "number": 1167, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDozMjozMVrODdePrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoyMTo1N1rODdrdtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjMwODMwOnYy", "diffSide": "LEFT", "path": "rskj-core/src/main/java/org/ethereum/core/ReceivedTxSignatureCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDozMjozMVrOFmGOiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDozMjozMVrOFmGOiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5MjIzNQ==", "bodyText": "Why change this for the if? Looks like this is a better option.", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375492235", "createdAt": "2020-02-05T20:32:31Z", "author": {"login": "joaquinlpereyra-iov"}, "path": "rskj-core/src/main/java/org/ethereum/core/ReceivedTxSignatureCache.java", "diffHunk": "@@ -23,10 +42,27 @@ public RskAddress getSender(Transaction transaction) {\n             return RemascTransaction.REMASC_ADDRESS;\n         }\n \n-        return addressesCache.computeIfAbsent(transaction, Transaction::getSender);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM0NTE1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/SignatureCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjozNTozMFrOFmZjcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjozNTozMFrOFmZjcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgwODg4Mw==", "bodyText": "Interfaces should start with a capital I so it should be ISignatureCache", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375808883", "createdAt": "2020-02-06T12:35:30Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/SignatureCache.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+\n+public interface SignatureCache {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM0NzUwOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjozNjoyNVrOFmZk8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjozNjoyNVrOFmZk8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgwOTI2Ng==", "bodyText": "you should receive by parameter a Signaturecache instead of a ReceivedTxSignatureCache in case in the feature you want to have another cache", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375809266", "createdAt": "2020-02-06T12:36:25Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM1Nzc1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjo0MDozM1rOFmZrUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjo0MDozM1rOFmZrUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMDg5Nw==", "bodyText": "Use the same patter as in https://github.com/rsksmart/rskj/pull/1167/files#diff-d7ef64078e614be54c9ed736c516b5a0R45 to avoid accessing twice to the array", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375810897", "createdAt": "2020-02-06T12:40:33Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM2MDE1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjo0MTozMFrOFmZsyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODowMjozN1rOFmk26w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMTI3Mg==", "bodyText": "Same here, do RskAddress sender = cacheN2.getSender(transaction); and then  in the if check for not null instead of first checking for contains and then getting the value", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375811272", "createdAt": "2020-02-06T12:41:30Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NDA5MQ==", "bodyText": "You repeat the comment here #1167 (comment)", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375994091", "createdAt": "2020-02-06T18:02:37Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMTI3Mg=="}, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM2MzUzOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjo0Mjo1NFrOFmZu7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODowMjoxMFrOFmk2Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMTgyMw==", "bodyText": "I recomend exposing the get instead of the containsTx as its more useful", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375811823", "createdAt": "2020-02-06T12:42:54Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);\n+            addressesCache.put(transaction, sender);\n+            return sender;\n+        }\n+\n+        return transaction.getSender();\n+    }\n+\n+    @Override\n+    public boolean containsTx(Transaction transaction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5Mzg5NQ==", "bodyText": "GetSender is responsible for returns sender if it cache has the transaction or get sender from the transaction and then returns it.\nNull is never returned.", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375993895", "createdAt": "2020-02-06T18:02:10Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);\n+            addressesCache.put(transaction, sender);\n+            return sender;\n+        }\n+\n+        return transaction.getSender();\n+    }\n+\n+    @Override\n+    public boolean containsTx(Transaction transaction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMTgyMw=="}, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDM2NjE1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjo0Mzo0NlrOFmZwXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODowMDo0OVrOFmkzkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMjE4OA==", "bodyText": "use the get and then check for null instead of first checking for contains and then getting the value.", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375812188", "createdAt": "2020-02-06T12:43:46Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);\n+            addressesCache.put(transaction, sender);\n+            return sender;\n+        }\n+\n+        return transaction.getSender();\n+    }\n+\n+    @Override\n+    public boolean containsTx(Transaction transaction) {\n+        return addressesCache.containsKey(transaction);\n+    }\n+\n+    @Override\n+    public void storeSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return;\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5MzIzNA==", "bodyText": "The problem with that solution is getSender method has two chances\n\nIf sender is in cache, it returns the queried sender\nIf it is not, the cache asks tx for the sender and then returns it.\n\nThen in the case which BlockTxSignatureCache queries a transaction sender to cacheN2, it first needs to verify if cacheN2 containsTx and in affirmative case, compute cacheN2.getSender.", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375993234", "createdAt": "2020-02-06T18:00:49Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockTxSignatureCache.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.core;\n+\n+import co.rsk.core.RskAddress;\n+import co.rsk.remasc.RemascTransaction;\n+import co.rsk.util.MaxSizeHashMap;\n+\n+import java.util.Map;\n+\n+public class BlockTxSignatureCache implements SignatureCache {\n+\n+    private static final int MAX_CACHE_SIZE = 6000;\n+\n+    private final Map<Transaction, RskAddress> addressesCache;\n+    private SignatureCache cacheN2;\n+\n+    public BlockTxSignatureCache(ReceivedTxSignatureCache cacheN2) {\n+        this.cacheN2 = cacheN2;\n+        addressesCache = new MaxSizeHashMap<>(MAX_CACHE_SIZE,true);\n+    }\n+\n+    public RskAddress getSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return RemascTransaction.REMASC_ADDRESS;\n+        }\n+\n+        if (containsTx(transaction)) {\n+            return addressesCache.get(transaction);\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);\n+            addressesCache.put(transaction, sender);\n+            return sender;\n+        }\n+\n+        return transaction.getSender();\n+    }\n+\n+    @Override\n+    public boolean containsTx(Transaction transaction) {\n+        return addressesCache.containsKey(transaction);\n+    }\n+\n+    @Override\n+    public void storeSender(Transaction transaction) {\n+\n+        if (transaction instanceof RemascTransaction) {\n+            return;\n+        }\n+\n+        if (cacheN2.containsTx(transaction)) {\n+            RskAddress sender = cacheN2.getSender(transaction);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgxMjE4OA=="}, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDQ0NjYwOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/core/bc/TransactionPoolImplTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoxMjoyNVrOFmahAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMzo0MzozOFrOFm9YPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNDY0MA==", "bodyText": "could you add a spy to signatureCache = rskTestContext.getReceivedTxSignatureCache();\nAnd create a test where you add two times the same transaction, then check that the cached called only once the storeSender for that transaction and the getSender was called at least twice", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375824640", "createdAt": "2020-02-06T13:12:25Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/test/java/co/rsk/core/bc/TransactionPoolImplTest.java", "diffHunk": "@@ -710,6 +711,52 @@ public void checkTxWhichCanNotBePaidIsRejected() {\n         Assert.assertTrue(transactionPool.getQueuedTransactions().isEmpty());\n     }\n \n+    @Test\n+    public void aNewTxIsAddedInTxPoolAndShouldBeAddedInCache(){\n+        Coin balance = Coin.valueOf(1000000);\n+        createTestAccounts(2, balance);\n+        Account account1 = createAccount(1);\n+        Transaction tx = createSampleTransaction(1, 2, 1000, 0);\n+        transactionPool.addTransaction(tx);\n+\n+        Assert.assertTrue(signatureCache.containsTx(tx));\n+        Assert.assertArrayEquals(signatureCache.getSender(tx).getBytes(), account1.getAddress().getBytes());\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDQyNA==", "bodyText": "i will do this in \"integration\" tests", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r376000424", "createdAt": "2020-02-06T18:16:03Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/test/java/co/rsk/core/bc/TransactionPoolImplTest.java", "diffHunk": "@@ -710,6 +711,52 @@ public void checkTxWhichCanNotBePaidIsRejected() {\n         Assert.assertTrue(transactionPool.getQueuedTransactions().isEmpty());\n     }\n \n+    @Test\n+    public void aNewTxIsAddedInTxPoolAndShouldBeAddedInCache(){\n+        Coin balance = Coin.valueOf(1000000);\n+        createTestAccounts(2, balance);\n+        Account account1 = createAccount(1);\n+        Transaction tx = createSampleTransaction(1, 2, 1000, 0);\n+        transactionPool.addTransaction(tx);\n+\n+        Assert.assertTrue(signatureCache.containsTx(tx));\n+        Assert.assertArrayEquals(signatureCache.getSender(tx).getBytes(), account1.getAddress().getBytes());\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNDY0MA=="}, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5NTgzNg==", "bodyText": "ok", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r376395836", "createdAt": "2020-02-07T13:43:38Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/test/java/co/rsk/core/bc/TransactionPoolImplTest.java", "diffHunk": "@@ -710,6 +711,52 @@ public void checkTxWhichCanNotBePaidIsRejected() {\n         Assert.assertTrue(transactionPool.getQueuedTransactions().isEmpty());\n     }\n \n+    @Test\n+    public void aNewTxIsAddedInTxPoolAndShouldBeAddedInCache(){\n+        Coin balance = Coin.valueOf(1000000);\n+        createTestAccounts(2, balance);\n+        Account account1 = createAccount(1);\n+        Transaction tx = createSampleTransaction(1, 2, 1000, 0);\n+        transactionPool.addTransaction(tx);\n+\n+        Assert.assertTrue(signatureCache.containsTx(tx));\n+        Assert.assertArrayEquals(signatureCache.getSender(tx).getBytes(), account1.getAddress().getBytes());\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNDY0MA=="}, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNDQ3NDE0OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/test/builders/BlockChainBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoyMTo1N1rOFmaxxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoyMTo1N1rOFmaxxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyODkzNQ==", "bodyText": "put the 100 on the same line as the rest", "url": "https://github.com/rsksmart/rskj/pull/1167#discussion_r375828935", "createdAt": "2020-02-06T13:21:57Z", "author": {"login": "pmprete"}, "path": "rskj-core/src/test/java/co/rsk/test/builders/BlockChainBuilder.java", "diffHunk": "@@ -206,19 +206,24 @@ public BlockChainImpl build() {\n \n         BlockValidator blockValidator = validatorBuilder.build();\n \n+        ReceivedTxSignatureCache receivedTxSignatureCache = new ReceivedTxSignatureCache();\n+        BlockTxSignatureCache blockTxSignatureCache = new BlockTxSignatureCache(receivedTxSignatureCache);\n+\n         TransactionExecutorFactory transactionExecutorFactory = new TransactionExecutorFactory(\n                 config,\n                 blockStore,\n                 receiptStore,\n                 blockFactory,\n                 new ProgramInvokeFactoryImpl(),\n-                new PrecompiledContracts(config, bridgeSupportFactory)\n+                new PrecompiledContracts(config, bridgeSupportFactory),\n+                blockTxSignatureCache\n         );\n         repositoryLocator = new RepositoryLocator(trieStore, stateRootHandler);\n+\n         transactionPool = new TransactionPoolImpl(\n                 config, repositoryLocator, this.blockStore, blockFactory, new TestCompositeEthereumListener(),\n-                transactionExecutorFactory, 10, 100\n-        );\n+                transactionExecutorFactory, receivedTxSignatureCache, 10,\n+                100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda11d912132086328297d7865dcdf01d732df28"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4555, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}