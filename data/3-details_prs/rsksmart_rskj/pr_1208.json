{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMDUxNzcy", "number": 1208, "title": "Persistent store for logs bloom", "bodyText": "", "createdAt": "2020-04-08T20:02:37Z", "url": "https://github.com/rsksmart/rskj/pull/1208", "merged": true, "mergeCommit": {"oid": "8b30e8de4e42ee362a4a2058e7dd3c34c072e9ad"}, "closed": true, "closedAt": "2020-05-06T19:04:59Z", "author": {"login": "ajlopezrsk"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVuK30AFqTM5MDMxODY5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcetdw_gFqTQwNjkwMzQ2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzE4Njk1", "url": "https://github.com/rsksmart/rskj/pull/1208#pullrequestreview-390318695", "createdAt": "2020-04-08T20:46:00Z", "commit": {"oid": "489e8538f2e8f096cfcc43c56c0a426a282db53c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0NjowMFrOGDAT1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0NjowMFrOGDAT1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMzk5MA==", "bodyText": "wouldn't you want to load everything in memory when it starts?", "url": "https://github.com/rsksmart/rskj/pull/1208#discussion_r405803990", "createdAt": "2020-04-08T20:46:00Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomStore.java", "diffHunk": "@@ -29,22 +32,58 @@\n     private final int noBlocks;\n     private final int noConfirmations;\n     private final Map<Long, BlocksBloom> blocksBloom = new ConcurrentHashMap<>();\n+    private final KeyValueDataSource dataSource;\n \n-    public BlocksBloomStore(int noBlocks, int noConfirmations) {\n+    public BlocksBloomStore(int noBlocks, int noConfirmations, KeyValueDataSource dataSource) {\n         this.noBlocks = noBlocks;\n         this.noConfirmations = noConfirmations;\n+        this.dataSource = dataSource;\n     }\n \n     public boolean hasBlockNumber(long blockNumber) {\n-        return this.blocksBloom.containsKey(this.firstNumberInRange(blockNumber));\n+        if (this.blocksBloom.containsKey(this.firstNumberInRange(blockNumber))) {\n+            return true;\n+        }\n+\n+        if (this.dataSource != null && this.dataSource.get(longToKey(blockNumber)) != null) {\n+            return true;\n+        }\n+\n+        return false;\n     }\n \n     public BlocksBloom getBlocksBloomByNumber(long number) {\n-        return this.blocksBloom.get(firstNumberInRange(number));\n+        long key = firstNumberInRange(number);\n+\n+        BlocksBloom blocksBloom = this.blocksBloom.get(key);\n+\n+        if (blocksBloom != null) {\n+            return blocksBloom;\n+        }\n+\n+        if (this.dataSource == null) {\n+            return null;\n+        }\n+\n+        byte[] data = this.dataSource.get(longToKey(key));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "489e8538f2e8f096cfcc43c56c0a426a282db53c"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzI3NzYw", "url": "https://github.com/rsksmart/rskj/pull/1208#pullrequestreview-390327760", "createdAt": "2020-04-08T20:59:39Z", "commit": {"oid": "489e8538f2e8f096cfcc43c56c0a426a282db53c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1OTozOVrOGDAxmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1OTozOVrOGDAxmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTYwOQ==", "bodyText": "should we encode something extra like noBlocks / noConfirmations or a maybe just a version number to ease a future migration if the structure of this changes?", "url": "https://github.com/rsksmart/rskj/pull/1208#discussion_r405811609", "createdAt": "2020-04-08T20:59:39Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomEncoder.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package co.rsk.logfilter;\n+\n+import org.bouncycastle.util.BigIntegers;\n+import org.ethereum.core.Bloom;\n+import org.ethereum.util.RLP;\n+import org.ethereum.util.RLPList;\n+\n+import java.math.BigInteger;\n+\n+/**\n+ * Created by ajlopez on 19/02/2020.\n+ */\n+public class BlocksBloomEncoder {\n+    private BlocksBloomEncoder() {\n+\n+    }\n+\n+    public static byte[] encode(BlocksBloom blocksBloom) {\n+        byte[] rlpFrom = encodeLong(blocksBloom.fromBlock());\n+        byte[] rlpTo = encodeLong(blocksBloom.toBlock());\n+        byte[] rlpData = RLP.encodeElement(blocksBloom.getBloom().getData());\n+\n+        return RLP.encodeList(rlpFrom, rlpTo, rlpData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "489e8538f2e8f096cfcc43c56c0a426a282db53c"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "489e8538f2e8f096cfcc43c56c0a426a282db53c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/489e8538f2e8f096cfcc43c56c0a426a282db53c", "committedDate": "2020-04-08T14:32:58Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "e797c49a8daa75036861389fe77f212d3e51c5bd", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/e797c49a8daa75036861389fe77f212d3e51c5bd", "committedDate": "2020-04-12T20:28:00Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzE1Mzk5", "url": "https://github.com/rsksmart/rskj/pull/1208#pullrequestreview-392315399", "createdAt": "2020-04-13T17:54:39Z", "commit": {"oid": "e797c49a8daa75036861389fe77f212d3e51c5bd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e797c49a8daa75036861389fe77f212d3e51c5bd", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/e797c49a8daa75036861389fe77f212d3e51c5bd", "committedDate": "2020-04-12T20:28:00Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "118e7af589163a4cbdc41e66e17a36283efa0968", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/118e7af589163a4cbdc41e66e17a36283efa0968", "committedDate": "2020-04-13T18:15:06Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "118e7af589163a4cbdc41e66e17a36283efa0968", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/118e7af589163a4cbdc41e66e17a36283efa0968", "committedDate": "2020-04-13T18:15:06Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "e10d9d356a09dbcd0105d8d4a05c230aff884a17", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/e10d9d356a09dbcd0105d8d4a05c230aff884a17", "committedDate": "2020-04-14T15:16:12Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e10d9d356a09dbcd0105d8d4a05c230aff884a17", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/e10d9d356a09dbcd0105d8d4a05c230aff884a17", "committedDate": "2020-04-14T15:16:12Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "0ca59de88951c6111f8f9922cbc51b085f96fa6d", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0ca59de88951c6111f8f9922cbc51b085f96fa6d", "committedDate": "2020-04-16T19:15:06Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ca59de88951c6111f8f9922cbc51b085f96fa6d", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0ca59de88951c6111f8f9922cbc51b085f96fa6d", "committedDate": "2020-04-16T19:15:06Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "288d20f15450510309117e392526c92afaa5518c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/288d20f15450510309117e392526c92afaa5518c", "committedDate": "2020-04-16T21:44:26Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "288d20f15450510309117e392526c92afaa5518c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/288d20f15450510309117e392526c92afaa5518c", "committedDate": "2020-04-16T21:44:26Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "ae52d929431d6713d75ddbb3cb82e3e125f9631c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ae52d929431d6713d75ddbb3cb82e3e125f9631c", "committedDate": "2020-04-24T17:24:17Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae52d929431d6713d75ddbb3cb82e3e125f9631c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ae52d929431d6713d75ddbb3cb82e3e125f9631c", "committedDate": "2020-04-24T17:24:17Z", "message": "Put retrieve blocks bloom into cache"}, "afterCommit": {"oid": "6e4f708badf5e5d52c113ad8e2831eb1e76681ea", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/6e4f708badf5e5d52c113ad8e2831eb1e76681ea", "committedDate": "2020-04-27T19:12:45Z", "message": "Using block 0 in BlocksBloom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "374123c26a84483555f18f8450c9eea3ea6b0e80", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/374123c26a84483555f18f8450c9eea3ea6b0e80", "committedDate": "2020-04-28T20:24:24Z", "message": "BlocksBloomEncoder first tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "badfbc4a197a106719ce2b93ac311e6777911dba", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/badfbc4a197a106719ce2b93ac311e6777911dba", "committedDate": "2020-04-28T20:24:24Z", "message": "BlocksBloomEncoder encode, decode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db065b421ae32dab41b6ea8498060dc58951a5c5", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/db065b421ae32dab41b6ea8498060dc58951a5c5", "committedDate": "2020-04-28T20:24:24Z", "message": "Data source in BlocksBloomStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05372970743f36b337ee99cb4834c1663cbfdd4", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/d05372970743f36b337ee99cb4834c1663cbfdd4", "committedDate": "2020-04-28T20:24:25Z", "message": "Blocks bloom data source in RskContext and RskTestContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a972fe60d2387c8b1feb826321ea58da75e556e8", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/a972fe60d2387c8b1feb826321ea58da75e556e8", "committedDate": "2020-04-28T20:24:25Z", "message": "Put retrieve blocks bloom into cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcbcb877932720e3d68eb2150655c74a0d48574", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/bdcbcb877932720e3d68eb2150655c74a0d48574", "committedDate": "2020-04-28T20:24:25Z", "message": "Using block 0 in BlocksBloom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54e4150f4b7ad95f542a3dcc314a3f621df930ca", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/54e4150f4b7ad95f542a3dcc314a3f621df930ca", "committedDate": "2020-04-28T20:24:25Z", "message": "Encode decode empty BlocksBloom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad07ad19c2cada481e1984d4eb98e15328c8494", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8ad07ad19c2cada481e1984d4eb98e15328c8494", "committedDate": "2020-04-28T20:24:25Z", "message": "Using emptyBloom in BlocksBloomEncoder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cb616172767df4f9b6c2eda102c2dc8885059d9", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/3cb616172767df4f9b6c2eda102c2dc8885059d9", "committedDate": "2020-04-27T19:56:16Z", "message": "Using emptyBloom in BlocksBloomEncoder"}, "afterCommit": {"oid": "8ad07ad19c2cada481e1984d4eb98e15328c8494", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8ad07ad19c2cada481e1984d4eb98e15328c8494", "committedDate": "2020-04-28T20:24:25Z", "message": "Using emptyBloom in BlocksBloomEncoder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTAzNDYz", "url": "https://github.com/rsksmart/rskj/pull/1208#pullrequestreview-406903463", "createdAt": "2020-05-06T19:02:03Z", "commit": {"oid": "8ad07ad19c2cada481e1984d4eb98e15328c8494"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 691, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}