{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MTk5MjMy", "number": 1395, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQxNTo1MTozNlrOFR8v8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQyMToxMDozNFrOFSzTAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MzY1NDI3OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/peg/utils/BridgeEventLoggerImplTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQxNTo1MTozNlrOIYqEMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQyMToxMzowOFrOIZ6rvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcyNTkzOA==", "bodyText": "Could we have an explicit test of event having the signature expected by external tools? ie, an assert equals against a calculated hash. So, we could be sure the event is consumible and queryable by external tools, using a code test. My concert is that, if we apply fuzzy testing to the event function code (and then, changing the resulting signature), all these tests could pass in green", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r562725938", "createdAt": "2021-01-22T15:51:36Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/test/java/co/rsk/peg/utils/BridgeEventLoggerImplTest.java", "diffHunk": "@@ -625,6 +625,76 @@ public void logReleaseBtcRequested() {\n         Assert.assertArrayEquals(event.encodeEventData(amount.getValue()), result.getData());\n     }\n \n+    @Test\n+    public void logRejectedPegin() {\n+        // Setup event logger\n+        ActivationConfig.ForBlock activations = mock(ActivationConfig.ForBlock.class);\n+        List<LogInfo> eventLogs = new LinkedList<>();\n+\n+        BridgeEventLogger eventLogger = new BridgeEventLoggerImpl(null, activations, eventLogs);\n+\n+        BtcTransaction btcTx = new BtcTransaction(BridgeRegTestConstants.getInstance().getBtcParams());\n+\n+        eventLogger.logRejectedPegin(btcTx, RejectedPeginReason.PEGIN_CAP_SURPASSED);\n+\n+        Assert.assertEquals(1, eventLogs.size());\n+        LogInfo entry = eventLogs.get(0);\n+\n+        Assert.assertEquals(PrecompiledContracts.BRIDGE_ADDR, new RskAddress(entry.getAddress()));\n+\n+        // Assert address that made the log\n+        LogInfo result = eventLogs.get(0);\n+        Assert.assertArrayEquals(PrecompiledContracts.BRIDGE_ADDR.getBytes(), result.getAddress());\n+\n+        // Assert log topics\n+        Assert.assertEquals(2, result.getTopics().size());\n+        CallTransaction.Function event = BridgeEvents.REJECTED_PEGIN.getEvent();\n+\n+        byte[][] topics = event.encodeEventTopics(btcTx.getHash().getBytes());\n+\n+        for (int i=0; i<topics.length; i++) {\n+            Assert.assertArrayEquals(topics[i], result.getTopics().get(i).getData());\n+        }\n+\n+        // Assert log data\n+        Assert.assertArrayEquals(event.encodeEventData(RejectedPeginReason.PEGIN_CAP_SURPASSED.getValue()), result.getData());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a52062f5feeec9add508bb68f2b820527829e48"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0Njc4MA==", "bodyText": "@ajlopezrsk has a good point here. We are doing this though in the integration tests already, so we can leave this comment as tech debt to be solved by the fed team afterwards", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564046780", "createdAt": "2021-01-25T21:13:08Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/utils/BridgeEventLoggerImplTest.java", "diffHunk": "@@ -625,6 +625,76 @@ public void logReleaseBtcRequested() {\n         Assert.assertArrayEquals(event.encodeEventData(amount.getValue()), result.getData());\n     }\n \n+    @Test\n+    public void logRejectedPegin() {\n+        // Setup event logger\n+        ActivationConfig.ForBlock activations = mock(ActivationConfig.ForBlock.class);\n+        List<LogInfo> eventLogs = new LinkedList<>();\n+\n+        BridgeEventLogger eventLogger = new BridgeEventLoggerImpl(null, activations, eventLogs);\n+\n+        BtcTransaction btcTx = new BtcTransaction(BridgeRegTestConstants.getInstance().getBtcParams());\n+\n+        eventLogger.logRejectedPegin(btcTx, RejectedPeginReason.PEGIN_CAP_SURPASSED);\n+\n+        Assert.assertEquals(1, eventLogs.size());\n+        LogInfo entry = eventLogs.get(0);\n+\n+        Assert.assertEquals(PrecompiledContracts.BRIDGE_ADDR, new RskAddress(entry.getAddress()));\n+\n+        // Assert address that made the log\n+        LogInfo result = eventLogs.get(0);\n+        Assert.assertArrayEquals(PrecompiledContracts.BRIDGE_ADDR.getBytes(), result.getAddress());\n+\n+        // Assert log topics\n+        Assert.assertEquals(2, result.getTopics().size());\n+        CallTransaction.Function event = BridgeEvents.REJECTED_PEGIN.getEvent();\n+\n+        byte[][] topics = event.encodeEventTopics(btcTx.getHash().getBytes());\n+\n+        for (int i=0; i<topics.length; i++) {\n+            Assert.assertArrayEquals(topics[i], result.getTopics().get(i).getData());\n+        }\n+\n+        // Assert log data\n+        Assert.assertArrayEquals(event.encodeEventData(RejectedPeginReason.PEGIN_CAP_SURPASSED.getValue()), result.getData());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcyNTkzOA=="}, "originalCommit": {"oid": "9a52062f5feeec9add508bb68f2b820527829e48"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1MjU5MTM2OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQyMToxMDozNFrOIZ6mVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMDoyNzowNFrOIaQh4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng==", "bodyText": "This is not correct.\nThe status of RSKIP170 doesn't ensure the pegin was a pegin-v1. pegin v1 and pegin legacy will co exist after Iris activation.\nYou can check the type of pegin using the peginInformation object (see https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/co/rsk/peg/PeginInformation.java#L44 )\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (activations.isActive(ConsensusRule.RSKIP170)) {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n          \n          \n            \n                            } else {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n          \n          \n            \n                            }\n          \n          \n            \n                            if (peginInformation.getProtocolVersion() == 1) {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n          \n          \n            \n                            } else {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n          \n          \n            \n                            }\n          \n      \n    \n    \n  \n\nThis could be improved by at least encoding the 1 in an enum. What do you think @marcos-iov ?", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564045396", "createdAt": "2021-01-25T21:10:34Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -475,6 +495,14 @@ private void refundTxSender(\n             generateRejectionRelease(btcTx, btcRefundAddress, rskTx, amount);\n         } else {\n             logger.debug(\"[refundTxSender] No btc refund address provided, couldn't get sender address either. Can't refund\");\n+\n+            if (activations.isActive(ConsensusRule.RSKIP181)) {\n+                if (activations.isActive(ConsensusRule.RSKIP170)) {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n+                } else {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a52062f5feeec9add508bb68f2b820527829e48"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA3NTExMA==", "bodyText": "Good catch! Yes, an enum with the different peg-in protocol versions (0 and 1 for the moment) should do it", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564075110", "createdAt": "2021-01-25T22:04:46Z", "author": {"login": "marcos-iov"}, "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -475,6 +495,14 @@ private void refundTxSender(\n             generateRejectionRelease(btcTx, btcRefundAddress, rskTx, amount);\n         } else {\n             logger.debug(\"[refundTxSender] No btc refund address provided, couldn't get sender address either. Can't refund\");\n+\n+            if (activations.isActive(ConsensusRule.RSKIP181)) {\n+                if (activations.isActive(ConsensusRule.RSKIP170)) {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n+                } else {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng=="}, "originalCommit": {"oid": "9a52062f5feeec9add508bb68f2b820527829e48"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQwNDcwNQ==", "bodyText": "thanks @josedahlquist. Applied your suggestion.", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564404705", "createdAt": "2021-01-26T10:27:04Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -475,6 +495,14 @@ private void refundTxSender(\n             generateRejectionRelease(btcTx, btcRefundAddress, rskTx, amount);\n         } else {\n             logger.debug(\"[refundTxSender] No btc refund address provided, couldn't get sender address either. Can't refund\");\n+\n+            if (activations.isActive(ConsensusRule.RSKIP181)) {\n+                if (activations.isActive(ConsensusRule.RSKIP170)) {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n+                } else {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng=="}, "originalCommit": {"oid": "9a52062f5feeec9add508bb68f2b820527829e48"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4415, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}