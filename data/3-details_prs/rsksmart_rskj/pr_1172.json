{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTQ0ODc1", "number": 1172, "title": "initial queue commit", "bodyText": "", "createdAt": "2020-02-14T19:42:33Z", "url": "https://github.com/rsksmart/rskj/pull/1172", "merged": true, "mergeCommit": {"oid": "3fb07b012c5852ec23a19bb1a0a3e8eae0ad1095"}, "closed": true, "closedAt": "2020-02-18T18:22:21Z", "author": {"login": "joaquinlpereyra-iov"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFTUpTgFqTM1OTk0NzE5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFk9ZigFqTM2MDUxMDQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTQ3MTkw", "url": "https://github.com/rsksmart/rskj/pull/1172#pullrequestreview-359947190", "createdAt": "2020-02-17T20:10:44Z", "commit": {"oid": "c4b9dcf694ae41ac065ff917367637915844a339"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoxMDo0NFrOFquzBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoyNjowN1rOFqvCXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MTIzNg==", "bodyText": "This condition is never true, as this.queue.offer never returns false:\n     * Inserts the specified element into this priority queue.\n     * As the queue is unbounded, this method will never return {@code false}.", "url": "https://github.com/rsksmart/rskj/pull/1172#discussion_r380351236", "createdAt": "2020-02-17T20:10:44Z", "author": {"login": "joaquinlpereyra-iov"}, "path": "rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java", "diffHunk": "@@ -123,7 +124,10 @@ private void tryAddMessage(Peer sender, Message message) {\n                 }\n                 this.receivedMessages.add(encodedMessage);\n             }\n-            if (!this.queue.offer(new MessageTask(sender, message))){\n+\n+            double score = sender.score(System.currentTimeMillis(), message.getMessageType());\n+\n+            if (score >= 0 && !this.queue.offer(new MessageTask(sender, message, score))){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4b9dcf694ae41ac065ff917367637915844a339"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1NTE2NQ==", "bodyText": "I think it's weird to have MessageTask be naturally ordered by their score. It certainly helps in this implementation, but it is weird to read taskA > taskB and assign it any meaning. Maybe use the other constructor to the queue which allows to define a Comparator<MessageTask>?\nMaybe I'm being too picky here, take just a note/discussion.", "url": "https://github.com/rsksmart/rskj/pull/1172#discussion_r380355165", "createdAt": "2020-02-17T20:26:07Z", "author": {"login": "joaquinlpereyra-iov"}, "path": "rskj-core/src/main/java/co/rsk/net/NodeMessageHandler.java", "diffHunk": "@@ -236,6 +247,31 @@ public String toString() {\n                     \", message=\" + message +\n                     '}';\n         }\n+\n+        @Override\n+        public int compareTo(MessageTask messageTask) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4b9dcf694ae41ac065ff917367637915844a339"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f42c6636cf5642121b703fd10a172261f2bcf4", "author": {"user": {"login": "donequis", "name": "Mat\u00edas Marquez"}}, "url": "https://github.com/rsksmart/rskj/commit/f8f42c6636cf5642121b703fd10a172261f2bcf4", "committedDate": "2020-02-18T14:51:29Z", "message": "Initial priority queue work"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTEwNDE5", "url": "https://github.com/rsksmart/rskj/pull/1172#pullrequestreview-360510419", "createdAt": "2020-02-18T16:59:21Z", "commit": {"oid": "f8f42c6636cf5642121b703fd10a172261f2bcf4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}