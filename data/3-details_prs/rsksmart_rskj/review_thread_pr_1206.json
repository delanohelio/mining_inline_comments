{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODg0MzY3", "number": 1206, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo0MzoxNFrODxtN1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjo0Mjo0N1rODxuz1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDQ3NjM5OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/co/rsk/net/eth/LightClientHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo0MzoxNFrOGFU-Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo0MzoxNFrOGFU-Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzOTYyMw==", "bodyText": "In fact, it is sending \"account response\", I think it's better to log \"Read message: {} GET_ACCOUNTS.\", for ACCOUNTS too.", "url": "https://github.com/rsksmart/rskj/pull/1206#discussion_r408239623", "createdAt": "2020-04-14T15:43:14Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/main/java/co/rsk/net/eth/LightClientHandler.java", "diffHunk": "@@ -80,6 +80,18 @@ protected void channelRead0(ChannelHandlerContext ctx, LightClientMessage msg) t\n                 CodeMessage codeMsg = (CodeMessage) msg;\n                 lightProcessor.processCodeMessage(codeMsg.getId(), codeMsg.getCodeHash(), msgQueue);\n                 break;\n+            case GET_ACCOUNTS:\n+                logger.debug(\"Read message: {} GET_ACCOUNTS. Sending code request\", msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486bc9f1b5b04840df7331327b9940137ff71fcb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDU2NTczOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/net/LightProcessorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjowMjoyMFrOGFV1pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjowMjoyMFrOGFV1pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1Mzg2MQ==", "bodyText": "Repeat this sentence twice", "url": "https://github.com/rsksmart/rskj/pull/1206#discussion_r408253861", "createdAt": "2020-04-14T16:02:20Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/test/java/co/rsk/net/LightProcessorTest.java", "diffHunk": "@@ -207,6 +206,67 @@ public void processCodeMessageAndShouldThrowAnException() {\n         }\n     }\n \n+    @Test\n+    public void processGetAccountsMessageAndShouldReturnsAccountsCorrectly() {\n+        long id = 101;\n+        Coin balance = Coin.valueOf(1010);\n+        long nonce = 100;\n+        RskAddress address = randomAddress();\n+        final Block block = mock(Block.class);\n+        final RepositorySnapshot repositorySnapshot = mock(RepositorySnapshot.class);\n+        Keccak256 codeHash = randomHash();\n+        byte[] storageRoot = randomHash().getBytes();\n+        AccountState accountState = mock(AccountState.class);\n+\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);\n+        when(block.getHash()).thenReturn(blockHash);\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486bc9f1b5b04840df7331327b9940137ff71fcb"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDU3MzM0OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/net/LightProcessorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjowNDowMFrOGFV6bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjowNDowMFrOGFV6bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NTA4Ng==", "bodyText": "As we talked, we should change the way we test these cases", "url": "https://github.com/rsksmart/rskj/pull/1206#discussion_r408255086", "createdAt": "2020-04-14T16:04:00Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/test/java/co/rsk/net/LightProcessorTest.java", "diffHunk": "@@ -207,6 +206,67 @@ public void processCodeMessageAndShouldThrowAnException() {\n         }\n     }\n \n+    @Test\n+    public void processGetAccountsMessageAndShouldReturnsAccountsCorrectly() {\n+        long id = 101;\n+        Coin balance = Coin.valueOf(1010);\n+        long nonce = 100;\n+        RskAddress address = randomAddress();\n+        final Block block = mock(Block.class);\n+        final RepositorySnapshot repositorySnapshot = mock(RepositorySnapshot.class);\n+        Keccak256 codeHash = randomHash();\n+        byte[] storageRoot = randomHash().getBytes();\n+        AccountState accountState = mock(AccountState.class);\n+\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);\n+        when(block.getHash()).thenReturn(blockHash);\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);\n+        when(repositoryLocator.snapshotAt(block.getHeader())).thenReturn(repositorySnapshot);\n+        when(repositorySnapshot.getAccountState(address)).thenReturn(accountState);\n+\n+        when(accountState.getNonce()).thenReturn(BigInteger.valueOf(nonce));\n+        when(accountState.getBalance()).thenReturn(balance);\n+        when(repositorySnapshot.getCodeHash(address)).thenReturn(codeHash);\n+        when(repositorySnapshot.getRoot()).thenReturn(storageRoot);\n+\n+        AccountsMessage expectedMessage = new AccountsMessage(id, new byte[] {0x00}, nonce,\n+                balance.asBigInteger().longValue(), codeHash.getBytes(), storageRoot);\n+\n+        ArgumentCaptor<AccountsMessage> argument = forClass(AccountsMessage.class);\n+        lightProcessor.processGetAccountsMessage(id, blockHash.getBytes(), address.getBytes(), msgQueue);\n+        verify(msgQueue).sendMessage(argument.capture());\n+\n+        assertArrayEquals(expectedMessage.getEncoded(), argument.getValue().getEncoded());\n+    }\n+\n+    @Test\n+    public void processGetAccountsMessageWithInvalidBlockHash() {\n+        long requestId = 100;\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(null);\n+        byte[] addressHash = HashUtil.randomHash();\n+\n+        lightProcessor.processGetAccountsMessage(requestId, blockHash.getBytes(), addressHash, msgQueue);\n+\n+        verify(msgQueue, times(0)).sendMessage(any());\n+    }\n+\n+    @Test\n+    public void processAccountsMessageAndShouldThrowAnException() {\n+        long id = 1;\n+        byte [] merkleInclusionProof = new byte[] {0x01};\n+        long nonce = 123;\n+        long balance = 100;\n+        byte[] codeHash = HashUtil.randomHash();\n+        byte[] storageRoot = HashUtil.randomHash();\n+\n+        String expected = \"Not supported AccountsMessage processing\";\n+        try {\n+            lightProcessor.processAccountsMessage(id, merkleInclusionProof, nonce, balance, codeHash, storageRoot, msgQueue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486bc9f1b5b04840df7331327b9940137ff71fcb"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDczNzUwOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/net/eth/LightClientHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjo0Mjo0N1rOGFXipg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjo0Mjo0N1rOGFXipg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MTc2Ng==", "bodyText": "You repeat this sentence too", "url": "https://github.com/rsksmart/rskj/pull/1206#discussion_r408281766", "createdAt": "2020-04-14T16:42:47Z", "author": {"login": "julianlen"}, "path": "rskj-core/src/test/java/co/rsk/net/eth/LightClientHandlerTest.java", "diffHunk": "@@ -180,6 +184,58 @@ public void lightClientHandlerSendsCodeMsgToQueueAndShouldThrowAnException() thr\n         }\n     }\n \n+    @Test\n+    public void lightClientHandlerSendsGetAccountsToQueue() throws Exception {\n+        long id = 101;\n+        Keccak256 blockHash = randomHash();\n+        RskAddress address = randomAddress();\n+        final Block block = mock(Block.class);\n+        final RepositorySnapshot repositorySnapshot = mock(RepositorySnapshot.class);\n+        Keccak256 codeHash = randomHash();\n+        byte[] storageRoot = randomHash().getBytes();\n+        AccountState accountState = mock(AccountState.class);\n+        Coin balance = Coin.valueOf(1010);\n+        long nonce = 100;\n+\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "486bc9f1b5b04840df7331327b9940137ff71fcb"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4590, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}