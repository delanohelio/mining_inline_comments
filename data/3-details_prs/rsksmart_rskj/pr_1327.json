{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTc3NjE1", "number": 1327, "title": "Build Block Blooms Database", "bodyText": "Description\nUsing a new configuration option, the build and save of block blooms data could be executed within the normal operation of the node. This data is used to retrieve log information efficiently.\nMotivation and Context\nUsually, this block blooms information is used only in nodes that has JSON RPC open, and log query operation enabled. And with the first query, the data is build and saved. But even with this feature, the operation could take many minutes and resources from the node.\nSo, this new code allow the build of the same data along the blockchain node normal processing, ie, during long synchronization or normal synchronization. To do this, a new internal service was added, and it is activated by configuration (the default value is not activated),\nHow Has This Been Tested?\nIt has code tests, and also was tested running a long sync against testnet network,\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n Tests for the changes have been added (for bug fixes / features)\n Requires Activation Code (Hard Fork)\n\n\nOther information:", "createdAt": "2020-10-05T16:35:09Z", "url": "https://github.com/rsksmart/rskj/pull/1327", "merged": true, "mergeCommit": {"oid": "13944c6525db728359453ffc00fb93be70a0a9d9"}, "closed": true, "closedAt": "2020-11-12T19:59:37Z", "author": {"login": "ajlopezrsk"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSFQhxgFqTUwNzE4NzgwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb4Hi9gFqTUyOTQ0NDk1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTg3ODA1", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-507187805", "createdAt": "2020-10-13T08:25:23Z", "commit": {"oid": "af9ae7757759f834a861b0be928e7cfef4cb9621"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwODoyNToyM1rOHgbKXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwOTozNTowNlrOHgeCJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2MTUwMg==", "bodyText": "I'd rather use colon symbol instead of equals sign, as above.", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r503761502", "createdAt": "2020-10-13T08:25:23Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/resources/reference.conf", "diffHunk": "@@ -403,3 +403,10 @@ crypto {\n     # - 'native' (Native C lib) <- not yet implemented\n     library: 'bc'\n }\n+\n+blooms = {\n+    blocks = 64\n+    service = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9ae7757759f834a861b0be928e7cfef4cb9621"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2Nzk1Nw==", "bodyText": "shouldn't we handle the case when blockNumber is negative?", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r503767957", "createdAt": "2020-10-13T08:34:46Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomProcessor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package co.rsk.logfilter;\n+\n+import org.ethereum.core.Bloom;\n+import org.ethereum.db.BlockStore;\n+\n+/**\n+ * Created by ajlopez on 29/09/2020.\n+ */\n+public class BlocksBloomProcessor {\n+    private final BlocksBloomStore blocksBloomStore;\n+    private final BlockStore blockStore;\n+\n+    private BlocksBloom blocksBloomInProcess = null;\n+\n+    public BlocksBloomProcessor(BlocksBloomStore blocksBloomStore, BlockStore blockStore) {\n+        this.blocksBloomStore = blocksBloomStore;\n+        this.blockStore = blockStore;\n+    }\n+\n+    public BlocksBloom getBlocksBloomInProcess() {\n+        return this.blocksBloomInProcess;\n+    }\n+\n+    public void processNewBlockNumber(long newBlockNumber) {\n+        long blockNumber = newBlockNumber - this.blocksBloomStore.getNoConfirmations();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dde21f9d4009ad359591a8d2cf97e3e58f1bf67a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwODU1MQ==", "bodyText": "shouldn't we listen to onBestBlock event instead?", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r503808551", "createdAt": "2020-10-13T09:35:06Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomService.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package co.rsk.logfilter;\n+\n+import co.rsk.config.InternalService;\n+import org.ethereum.core.Block;\n+import org.ethereum.core.TransactionReceipt;\n+import org.ethereum.db.BlockStore;\n+import org.ethereum.listener.CompositeEthereumListener;\n+import org.ethereum.listener.EthereumListenerAdapter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+\n+/**\n+ * Created by ajlopez on 01/10/2020.\n+ */\n+public class BlocksBloomService implements InternalService {\n+    private static final Logger logger = LoggerFactory.getLogger(\"blooms\");\n+\n+    private final CompositeEthereumListener emitter;\n+    private final BlocksBloomProcessor blocksBloomProcessor;\n+\n+    private final BlocksBloomService.OnBlockListener listener = new BlocksBloomService.OnBlockListener();\n+\n+    public BlocksBloomService(CompositeEthereumListener emitter, BlocksBloomStore blocksBloomStore, BlockStore blockStore) {\n+        this.emitter = emitter;\n+        this.blocksBloomProcessor = new BlocksBloomProcessor(blocksBloomStore, blockStore);\n+    }\n+\n+    @Override\n+    public void start() {\n+        logger.info(\"blocks bloom service started\");\n+\n+        emitter.addListener(listener);\n+    }\n+\n+    @Override\n+    public void stop() {\n+        logger.info(\"blocks bloom service stopped\");\n+\n+        emitter.removeListener(listener);\n+    }\n+\n+    public void processNewBlock(long blockNumber) {\n+        this.blocksBloomProcessor.processNewBlockNumber(blockNumber);\n+    }\n+\n+    private class OnBlockListener extends EthereumListenerAdapter {\n+        @Override\n+        public void onBlock(Block block, List<TransactionReceipt> receipts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dde21f9d4009ad359591a8d2cf97e3e58f1bf67a"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTE0Mzkx", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-508114391", "createdAt": "2020-10-14T08:32:19Z", "commit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODozMjoxOVrOHhIHcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo1OToxOVrOHhJN8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5ODAzMw==", "bodyText": "Seems dataSource field cannot be null (non-nullable)? It's being checked for null in a few places in this class. But in other places (e.g. in flush method) it is not.", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r504498033", "createdAt": "2020-10-14T08:32:19Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomStore.java", "diffHunk": "@@ -40,22 +44,25 @@ public BlocksBloomStore(int noBlocks, int noConfirmations, KeyValueDataSource da\n         this.dataSource = dataSource;\n     }\n \n-    public boolean hasBlockNumber(long blockNumber) {\n-        if (this.blocksBloom.containsKey(this.firstNumberInRange(blockNumber))) {\n-            return true;\n-        }\n+    public synchronized boolean hasBlockNumber(long blockNumber) {\n+        long key = this.firstNumberInRange(blockNumber);\n \n-        if (this.dataSource != null && this.dataSource.get(longToKey(blockNumber)) != null) {\n-            return true;\n-        }\n+        return hasBlockNumberInCache(key)\n+            || hasBlockNumberInStore(key);\n+    }\n+\n+    private boolean hasBlockNumberInStore(long key) {\n+        return this.dataSource != null && this.dataSource.get(longToKey(key)) != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzQwNg==", "bodyText": "I guess here we could use HashMap instead of ConcurrentHashMap. Access to this filed is synchronized in this class.", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r504507406", "createdAt": "2020-10-14T08:46:40Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomStore.java", "diffHunk": "@@ -29,9 +31,11 @@\n  * Created by ajlopez on 05/02/2019.\n  */\n public class BlocksBloomStore {\n+    private static final Logger logger = LoggerFactory.getLogger(\"blooms\");\n+\n     private final int noBlocks;\n     private final int noConfirmations;\n-    private final Map<Long, BlocksBloom> blocksBloom = new ConcurrentHashMap<>();\n+    private final Map<Long, BlocksBloom> blocksBloomCache = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNjA4Mw==", "bodyText": "Looks like this method is not thread-safe. Shouldn't it be synchronized?", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r504516083", "createdAt": "2020-10-14T08:59:19Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomProcessor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package co.rsk.logfilter;\n+\n+import org.ethereum.core.Bloom;\n+import org.ethereum.db.BlockStore;\n+\n+/**\n+ * Created by ajlopez on 29/09/2020.\n+ */\n+public class BlocksBloomProcessor {\n+    private final BlocksBloomStore blocksBloomStore;\n+    private final BlockStore blockStore;\n+\n+    private BlocksBloom blocksBloomInProcess = null;\n+\n+    public BlocksBloomProcessor(BlocksBloomStore blocksBloomStore, BlockStore blockStore) {\n+        this.blocksBloomStore = blocksBloomStore;\n+        this.blockStore = blockStore;\n+    }\n+\n+    public BlocksBloom getBlocksBloomInProcess() {\n+        return this.blocksBloomInProcess;\n+    }\n+\n+    public void processNewBlockNumber(long newBlockNumber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTQyODA0", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-508142804", "createdAt": "2020-10-14T09:06:11Z", "commit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTowNjoxMVrOHhJgBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTowNjoxMVrOHhJgBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyMDcxMA==", "bodyText": "blocksBloomInProcess field is not synchronized. And it looks like it's only needed for unit testing. Shouldn't the method be marked as synchronized or VisibleForTesting?", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r504520710", "createdAt": "2020-10-14T09:06:11Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomProcessor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package co.rsk.logfilter;\n+\n+import org.ethereum.core.Bloom;\n+import org.ethereum.db.BlockStore;\n+\n+/**\n+ * Created by ajlopez on 29/09/2020.\n+ */\n+public class BlocksBloomProcessor {\n+    private final BlocksBloomStore blocksBloomStore;\n+    private final BlockStore blockStore;\n+\n+    private BlocksBloom blocksBloomInProcess = null;\n+\n+    public BlocksBloomProcessor(BlocksBloomStore blocksBloomStore, BlockStore blockStore) {\n+        this.blocksBloomStore = blocksBloomStore;\n+        this.blockStore = blockStore;\n+    }\n+\n+    public BlocksBloom getBlocksBloomInProcess() {\n+        return this.blocksBloomInProcess;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "742c5282110aaaeed4c569f600db2e973a14526a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzA2ODYw", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-513706860", "createdAt": "2020-10-21T13:49:03Z", "commit": {"oid": "92b5ae45306d70068a406d779637b6607b01a4fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0OTowM1rOHltRKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0OTowM1rOHltRKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwMTAzMg==", "bodyText": "shouldn't we limit the size of this map?", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r509301032", "createdAt": "2020-10-21T13:49:03Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomStore.java", "diffHunk": "@@ -21,17 +21,31 @@\n \n import org.ethereum.datasource.KeyValueDataSource;\n import org.ethereum.vm.DataWord;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n+import java.util.HashMap;\n import java.util.Map;\n-import java.util.concurrent.ConcurrentHashMap;\n \n /**\n+ * Block blooms store\n+ *\n+ * It saves and retrieves coalesced bloom filters\n+ *\n+ * Each record represents a range of blocks\n+ *\n+ * The key is the block number of the first block in the range\n+ *\n+ * It keeps also an in-memory cache of those records\n+ *\n  * Created by ajlopez on 05/02/2019.\n  */\n public class BlocksBloomStore {\n+    private static final Logger logger = LoggerFactory.getLogger(\"blooms\");\n+\n     private final int noBlocks;\n     private final int noConfirmations;\n-    private final Map<Long, BlocksBloom> blocksBloom = new ConcurrentHashMap<>();\n+    private final Map<Long, BlocksBloom> blocksBloomCache = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92b5ae45306d70068a406d779637b6607b01a4fb"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTM0NDI4", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-514534428", "createdAt": "2020-10-22T09:30:49Z", "commit": {"oid": "92b5ae45306d70068a406d779637b6607b01a4fb"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MDkyNTg3", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-505092587", "createdAt": "2020-10-08T19:17:27Z", "commit": {"oid": "e601ebc1fef4d56f7233b6d05d9f234f9da12be6"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxOToxNzoyN1rOHes_OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNjowNVrOHfXqJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk1NjQwOA==", "bodyText": "Shouldn't be?\n!this.empty && this.fromBlock <= blockNumber && blockNumber <= this.toBlock;", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r501956408", "createdAt": "2020-10-08T19:17:27Z", "author": {"login": "fedejinich"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloom.java", "diffHunk": "@@ -58,6 +58,14 @@ public long size() {\n         return this.toBlock - this.fromBlock + 1;\n     }\n \n+    public boolean hasBlockBloom(long blockNumber) {\n+        if (this.empty) {\n+            return false;\n+        }\n+\n+        return this.fromBlock <= blockNumber && blockNumber <= this.toBlock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e601ebc1fef4d56f7233b6d05d9f234f9da12be6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1NTUyNg==", "bodyText": "it'd be nice to abstract complex conditions\nmaybe something like this?\n    public synchronized boolean hasBlockNumber(long blockNumber) {\n        // if a block is contained in a block range\n        long firstNumber = this.firstNumberInRange(blockNumber);\n        \n        return isBlockInCache(firstNumber) || isBlockInDataSource(firstNumber);\n    }\n\n    private boolean isBlockInDataSource(long firstNumber) {\n        return this.dataSource != null && this.dataSource.get(longToKey(firstNumber)) != null;\n    }\n\n    private boolean isBlockInCache(long firstNumber) {\n        return this.blocksBloom.containsKey(firstNumber);\n    }", "url": "https://github.com/rsksmart/rskj/pull/1327#discussion_r502655526", "createdAt": "2020-10-09T20:26:05Z", "author": {"login": "fedejinich"}, "path": "rskj-core/src/main/java/co/rsk/logfilter/BlocksBloomStore.java", "diffHunk": "@@ -40,7 +44,7 @@ public BlocksBloomStore(int noBlocks, int noConfirmations, KeyValueDataSource da\n         this.dataSource = dataSource;\n     }\n \n-    public boolean hasBlockNumber(long blockNumber) {\n+    public synchronized boolean hasBlockNumber(long blockNumber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e601ebc1fef4d56f7233b6d05d9f234f9da12be6"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4f7be8c5d6f3af3a9042d9006a963b369ac7d40", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/d4f7be8c5d6f3af3a9042d9006a963b369ac7d40", "committedDate": "2020-10-22T20:28:30Z", "message": "extracted methods for BlocksBloomProcessor"}, "afterCommit": {"oid": "c8797d3860b1c70dec138220320b4a57c870c496", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/c8797d3860b1c70dec138220320b4a57c870c496", "committedDate": "2020-10-26T11:46:07Z", "message": "extracted methods for BlocksBloomProcessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2Nzg0NjM2", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-516784636", "createdAt": "2020-10-26T13:39:41Z", "commit": {"oid": "c8797d3860b1c70dec138220320b4a57c870c496"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8797d3860b1c70dec138220320b4a57c870c496", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/c8797d3860b1c70dec138220320b4a57c870c496", "committedDate": "2020-10-26T11:46:07Z", "message": "extracted methods for BlocksBloomProcessor"}, "afterCommit": {"oid": "9052665e08dae3d60f9767a9932ccde20f898898", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/9052665e08dae3d60f9767a9932ccde20f898898", "committedDate": "2020-11-11T18:21:16Z", "message": "extracted methods for BlocksBloomProcessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MDk1ODgw", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-529095880", "createdAt": "2020-11-12T13:42:17Z", "commit": {"oid": "9052665e08dae3d60f9767a9932ccde20f898898"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474fdc5288200305eebaefbc609bc448daf41212", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/474fdc5288200305eebaefbc609bc448daf41212", "committedDate": "2020-11-12T17:35:58Z", "message": "Adding blocks to BlocksBloomBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5ad363c2c5d406b5f3a049853dd52eb597f042d", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b5ad363c2c5d406b5f3a049853dd52eb597f042d", "committedDate": "2020-11-12T17:35:59Z", "message": "BlocksBloomBuilder saves BlocksBloom in process"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c67ae53c885a46a957ac5fe68cc60eb1da7b7bc", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8c67ae53c885a46a957ac5fe68cc60eb1da7b7bc", "committedDate": "2020-11-12T17:35:59Z", "message": "Bloom blocks configuration, service, synchronized store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47d5687f3b00433f3d6419c52b352b8e5d5906f", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/f47d5687f3b00433f3d6419c52b352b8e5d5906f", "committedDate": "2020-11-12T17:35:59Z", "message": "Set default no of blocks to 64; logging messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c413be37569e4662b82e6123d47ecb29b459654", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/6c413be37569e4662b82e6123d47ecb29b459654", "committedDate": "2020-11-12T17:35:59Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d033f432ba4789f324d63b635fac3bfea37470", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/66d033f432ba4789f324d63b635fac3bfea37470", "committedDate": "2020-11-12T17:35:59Z", "message": "Rename BlocksBloomBuilder to BlocksBloomProcessor; rename setBlocksBloom method to addBlocksBloom; rename blocksBloom private variable to blocksBloomCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9341e07da0897f24fe9349b21d6ed87e3c2c5658", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/9341e07da0897f24fe9349b21d6ed87e3c2c5658", "committedDate": "2020-11-12T17:36:00Z", "message": "Fix bug and refactor method BlocksBloomStore hasBlockNumber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "931289ea867b8fc2f57b5a6d1bc7c739ef6f95db", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/931289ea867b8fc2f57b5a6d1bc7c739ef6f95db", "committedDate": "2020-11-12T17:36:00Z", "message": "Improve reference.conf declaration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa19462038b46cc30b5a1b49b1da72316b75f065", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/fa19462038b46cc30b5a1b49b1da72316b75f065", "committedDate": "2020-11-12T17:36:00Z", "message": "Avoid processing negative block number; adding synchronization; adding visibility for testing; use HashMap instead of ConcurrentHashMap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6c3967ce60dfce452890206882115bdf55533a7", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/f6c3967ce60dfce452890206882115bdf55533a7", "committedDate": "2020-11-12T17:36:00Z", "message": "Adding comments to classes and methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7eda5aaee4a500e1c875ca4cdce12f8c4b0648f", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/f7eda5aaee4a500e1c875ca4cdce12f8c4b0648f", "committedDate": "2020-11-12T17:36:00Z", "message": "Adding null checks to BlocksBloomStore dataSource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a1c66e92205d514c6ad019b9ff9859300460fca", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/3a1c66e92205d514c6ad019b9ff9859300460fca", "committedDate": "2020-11-12T17:36:00Z", "message": "extracted methods for BlocksBloomProcessor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9052665e08dae3d60f9767a9932ccde20f898898", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/9052665e08dae3d60f9767a9932ccde20f898898", "committedDate": "2020-11-11T18:21:16Z", "message": "extracted methods for BlocksBloomProcessor"}, "afterCommit": {"oid": "3a1c66e92205d514c6ad019b9ff9859300460fca", "author": {"user": {"login": "fedejinich", "name": "Fede Jinich"}}, "url": "https://github.com/rsksmart/rskj/commit/3a1c66e92205d514c6ad019b9ff9859300460fca", "committedDate": "2020-11-12T17:36:00Z", "message": "extracted methods for BlocksBloomProcessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDQ0OTU4", "url": "https://github.com/rsksmart/rskj/pull/1327#pullrequestreview-529444958", "createdAt": "2020-11-12T19:56:07Z", "commit": {"oid": "3a1c66e92205d514c6ad019b9ff9859300460fca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 579, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}