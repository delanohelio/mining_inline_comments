{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjM2NTMz", "number": 1215, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxMDo1M1rOD2xPyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDoyNVrOD2xW2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NzU2NTU1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/vm/VM.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxMDo1M1rOGMrgoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxMDo1M1rOGMrgoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk0ODk2MA==", "bodyText": "I would call this something different from calculate. calculate makes me think this is a transparently referential function, but because this can do a program.stackPop(), it's actually imperative. In fact, it almost always does a stackPop, it seems, except in two exceptional op codes. So it makes sense to me to call it something like popCallValue(), or even maybePopCallValue().", "url": "https://github.com/rsksmart/rskj/pull/1215#discussion_r415948960", "createdAt": "2020-04-27T16:10:53Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/org/ethereum/vm/VM.java", "diffHunk": "@@ -1553,25 +1549,38 @@ protected void doCALL(){\n \n         program.memoryExpand(outDataOffs, outDataSize);\n \n-        MessageCall msg = new MessageCall(\n+        return new MessageCall(\n                 MsgType.fromOpcode(op),\n                 DataWord.valueOf(calleeGas), codeAddress, value, inDataOffs, inDataSize,\n                 outDataOffs, outDataSize);\n+    }\n \n-        callToAddress(codeAddress, msg);\n-\n-        program.step();\n+    private DataWord calculateCallValue(ActivationConfig.ForBlock activations) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200689b59df5ca2626b3c0485271e840b07741ca"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NzU4MzYzOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/vm/VM.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDoyNVrOGMrrjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDoyNVrOGMrrjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTc1Ng==", "bodyText": "This function is not cohesive and the naming is unclear. It's doing two things, and one of them is validating and maybe throwing an exception. At the very least is should be called calculateAndValidateMinimumTransferGas", "url": "https://github.com/rsksmart/rskj/pull/1215#discussion_r415951756", "createdAt": "2020-04-27T16:14:25Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/org/ethereum/vm/VM.java", "diffHunk": "@@ -1553,25 +1549,38 @@ protected void doCALL(){\n \n         program.memoryExpand(outDataOffs, outDataSize);\n \n-        MessageCall msg = new MessageCall(\n+        return new MessageCall(\n                 MsgType.fromOpcode(op),\n                 DataWord.valueOf(calleeGas), codeAddress, value, inDataOffs, inDataSize,\n                 outDataOffs, outDataSize);\n+    }\n \n-        callToAddress(codeAddress, msg);\n-\n-        program.step();\n+    private DataWord calculateCallValue(ActivationConfig.ForBlock activations) {\n+        DataWord value;\n+        if (activations.isActive(RSKIP103)) {\n+            // value is always zero in a DELEGATECALL or STATICCALL operation\n+            value = op == OpCode.DELEGATECALL || op == OpCode.STATICCALL ? DataWord.ZERO : program.stackPop();\n+        } else {\n+            // value is always zero in a DELEGATECALL operation\n+            value = op == OpCode.DELEGATECALL ? DataWord.ZERO : program.stackPop();\n+        }\n+        return value;\n     }\n \n-    private void callToAddress(DataWord codeAddress, MessageCall msg) {\n-        ActivationConfig.ForBlock activations = program.getActivations();\n-        PrecompiledContracts.PrecompiledContract contract = precompiledContracts.getContractForAddress(activations, codeAddress);\n+    private long calculateGetMinimumTransferGas(DataWord value, long remainingGas) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200689b59df5ca2626b3c0485271e840b07741ca"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4593, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}