{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1Mjk5MTgx", "number": 1311, "title": "Fixed issue when contract deployment burns previous balance", "bodyText": "Contract addresses are deterministic. So it's possible to calculate an address of a contract before actual deployment (for some particular Externally Owned Account and nonce).\nThis pull request addresses the issue when some funds are transferred in advance to the contract address which is not deployed yet. And then after deployment the balance becomes zero.\nNote: The issue is only relevant to the case when a contract is created directly, not via CREATE or CREATE2 opcodes.", "createdAt": "2020-09-11T17:35:57Z", "url": "https://github.com/rsksmart/rskj/pull/1311", "merged": true, "mergeCommit": {"oid": "912378c1f47d3ee6cbe9dc168c7ee51aa2491a03"}, "closed": true, "closedAt": "2020-09-25T13:40:19Z", "author": {"login": "Vovchyk"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH6XaHAFqTQ4NzA2MTE2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMCa6eAFqTQ5NTY1OTcxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDYxMTY0", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-487061164", "createdAt": "2020-09-11T19:14:35Z", "commit": {"oid": "8d52b9fff5e69bf27107d3cf07d14e42cda41477"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxOToxNDozNlrOHQquHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxOToxNDozNlrOHQquHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzOTE5OA==", "bodyText": "Why not simply NOT create account?", "url": "https://github.com/rsksmart/rskj/pull/1311#discussion_r487239198", "createdAt": "2020-09-11T19:14:36Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/org/ethereum/core/TransactionExecutor.java", "diffHunk": "@@ -369,7 +369,15 @@ private void call() {\n \n     private void create() {\n         RskAddress newContractAddress = tx.getContractAddress();\n-        cacheTrack.createAccount(newContractAddress); // pre-created\n+\n+        // Keep prior balance of a contract address (if any)\n+        if (cacheTrack.isExist(newContractAddress)) {\n+            Coin oldBalance = cacheTrack.getBalance(newContractAddress);\n+            cacheTrack.createAccount(newContractAddress);\n+            cacheTrack.addBalance(newContractAddress, oldBalance);\n+        } else {\n+            cacheTrack.createAccount(newContractAddress);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d52b9fff5e69bf27107d3cf07d14e42cda41477"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODE2NzI1", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-487816725", "createdAt": "2020-09-14T14:16:58Z", "commit": {"oid": "d44686790f7cc0455554e454b0f6cd470af3f3ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDoxNjo1OFrOHRXBiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDoxNjo1OFrOHRXBiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk2NTA2Nw==", "bodyText": "isnt it better to pass a flag to createAccount? something like \"keepBalance\"?", "url": "https://github.com/rsksmart/rskj/pull/1311#discussion_r487965067", "createdAt": "2020-09-14T14:16:58Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/org/ethereum/core/TransactionExecutor.java", "diffHunk": "@@ -369,7 +370,15 @@ private void call() {\n \n     private void create() {\n         RskAddress newContractAddress = tx.getContractAddress();\n-        cacheTrack.createAccount(newContractAddress); // pre-created\n+\n+        if (activations.isActive(RSKIP174) && cacheTrack.isExist(newContractAddress)) {\n+            // Keep prior balance of a contract address (if any)\n+            Coin oldBalance = cacheTrack.getBalance(newContractAddress);\n+            cacheTrack.createAccount(newContractAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44686790f7cc0455554e454b0f6cd470af3f3ad"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDI4OTE2", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-489028916", "createdAt": "2020-09-15T20:03:44Z", "commit": {"oid": "49b530991c67566be5342fc4de3f652b8212bab2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e9d63a1a8078b92745b367dc4a318778f5d15f0", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8e9d63a1a8078b92745b367dc4a318778f5d15f0", "committedDate": "2020-09-16T13:47:43Z", "message": "Updated a few test to bypass sonarcloud complaints"}, "afterCommit": {"oid": "fd09be0a117ad48dc74a7914efd14af831a799ec", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/fd09be0a117ad48dc74a7914efd14af831a799ec", "committedDate": "2020-09-17T07:10:51Z", "message": "Updated a few test to bypass sonarcloud complaints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjAzNjk3", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-490603697", "createdAt": "2020-09-17T13:38:04Z", "commit": {"oid": "fd09be0a117ad48dc74a7914efd14af831a799ec"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd09be0a117ad48dc74a7914efd14af831a799ec", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/fd09be0a117ad48dc74a7914efd14af831a799ec", "committedDate": "2020-09-17T07:10:51Z", "message": "Updated a few test to bypass sonarcloud complaints"}, "afterCommit": {"oid": "a159fa4742afc8eabd71eb9f474418e588eb1d16", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/a159fa4742afc8eabd71eb9f474418e588eb1d16", "committedDate": "2020-09-22T18:03:23Z", "message": "Updated a few test to bypass sonarcloud complaints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzI3OTY4", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-493727968", "createdAt": "2020-09-22T18:16:56Z", "commit": {"oid": "a159fa4742afc8eabd71eb9f474418e588eb1d16"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cafff4580d2198f8db2f23f43e1899fa0adb24c", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/1cafff4580d2198f8db2f23f43e1899fa0adb24c", "committedDate": "2020-09-24T14:26:52Z", "message": "Fixed issue when contract deployment burns previous balance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36b4e6643bbece4ca21f4305e7682f2fc750dd35", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/36b4e6643bbece4ca21f4305e7682f2fc750dd35", "committedDate": "2020-09-24T14:26:52Z", "message": "Added activation logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385616b26763a5ddeb6d24187f244dd9815c05f7", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/385616b26763a5ddeb6d24187f244dd9815c05f7", "committedDate": "2020-09-24T14:26:52Z", "message": "Moved balance preserving logic to Repository class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcc97c46782c1096ded6d34b342d2e1e0493db20", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/bcc97c46782c1096ded6d34b342d2e1e0493db20", "committedDate": "2020-09-24T14:26:52Z", "message": "Added some tests for Repository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350d2ee0c306bc2ecd4b49691ba2dc618aa9fb90", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/350d2ee0c306bc2ecd4b49691ba2dc618aa9fb90", "committedDate": "2020-09-24T14:26:52Z", "message": "Updated a few test to bypass sonarcloud complaints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a159fa4742afc8eabd71eb9f474418e588eb1d16", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/a159fa4742afc8eabd71eb9f474418e588eb1d16", "committedDate": "2020-09-22T18:03:23Z", "message": "Updated a few test to bypass sonarcloud complaints"}, "afterCommit": {"oid": "350d2ee0c306bc2ecd4b49691ba2dc618aa9fb90", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/350d2ee0c306bc2ecd4b49691ba2dc618aa9fb90", "committedDate": "2020-09-24T14:26:52Z", "message": "Updated a few test to bypass sonarcloud complaints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjU5NzE1", "url": "https://github.com/rsksmart/rskj/pull/1311#pullrequestreview-495659715", "createdAt": "2020-09-24T14:53:32Z", "commit": {"oid": "350d2ee0c306bc2ecd4b49691ba2dc618aa9fb90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 548, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}