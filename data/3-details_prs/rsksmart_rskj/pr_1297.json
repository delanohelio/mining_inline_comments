{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNDE0NTIy", "number": 1297, "title": "Refactor RegisterBtcTransaction", "bodyText": "Move lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them", "createdAt": "2020-08-25T19:37:48Z", "url": "https://github.com/rsksmart/rskj/pull/1297", "merged": true, "mergeCommit": {"oid": "6007c242540b7983cf744f480ebf5fc400e035e1"}, "closed": true, "closedAt": "2020-09-11T14:37:21Z", "author": {"login": "guidohernan93"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCctEPgFqTQ3NDc5NTkyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH2EVngFqTQ4Njg0NDY1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Nzk1OTI2", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-474795926", "createdAt": "2020-08-25T19:41:10Z", "commit": {"oid": "0a577abbab04fb4d46417e23707a624072014fae"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOTo0MToxMFrOHGnDIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOTo0MzowNlrOHGnGtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5MzI4Mg==", "bodyText": "maybe mock the repository", "url": "https://github.com/rsksmart/rskj/pull/1297#discussion_r476693282", "createdAt": "2020-08-25T19:41:10Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeSupportTest.java", "diffHunk": "@@ -4803,6 +4804,104 @@ public void addSignatureMultipleInputsPartiallyValid() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void processPegIn_no_lock_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+\n+        Assert.assertFalse(bridgeSupport.processPegIn(new BtcTransaction(btcParams),\n+                mock(Transaction.class),\n+                0,\n+                mock(Sha256Hash.class)));\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_invalid_sender() throws IOException {\n+        assertProcessPegIn(ConsensusRule.RSKIP143,true, false,\n+                BtcLockSender.TxType.P2SHMULTISIG);\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_not_whitelisted_address() throws IOException {\n+        assertProcessPegIn(null,false, false,\n+                BtcLockSender.TxType.P2PKH);\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_surpassing_locking_cap() throws IOException {\n+        assertProcessPegIn(ConsensusRule.RSKIP134,true, true,\n+                BtcLockSender.TxType.P2PKH);\n+    }\n+\n+    @Test\n+    public void processRelease_no_release_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+        Assert.assertFalse(bridgeSupport.processRelease(new BtcTransaction(btcParams), mock(Sha256Hash.class)));\n+    }\n+\n+    @Test\n+    public void processMigration_no_migration_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+        Assert.assertFalse(bridgeSupport.processMigration(new BtcTransaction(btcParams), mock(Sha256Hash.class)));\n+    }\n+\n+    private void assertProcessPegIn(@Nullable ConsensusRule consensusRule, boolean isWhitelisted,\n+                                    boolean mockLockingCap, BtcLockSender.TxType lockSender) throws IOException {\n+        ActivationConfig.ForBlock activations = mock(ActivationConfig.ForBlock.class);\n+\n+        if (consensusRule != null) {\n+            when(activations.isActive(consensusRule)).thenReturn(true);\n+        }\n+\n+        Repository repository = createRepository();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a577abbab04fb4d46417e23707a624072014fae"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5MzkyOQ==", "bodyText": "If I'm not wrong, you are testing refunds in here, right?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void assertProcessPegIn(@Nullable ConsensusRule consensusRule, boolean isWhitelisted,\n          \n          \n            \n                private void assertRefundInProcessPegIn(@Nullable ConsensusRule consensusRule, boolean isWhitelisted,", "url": "https://github.com/rsksmart/rskj/pull/1297#discussion_r476693929", "createdAt": "2020-08-25T19:42:29Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeSupportTest.java", "diffHunk": "@@ -4803,6 +4804,104 @@ public void addSignatureMultipleInputsPartiallyValid() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void processPegIn_no_lock_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+\n+        Assert.assertFalse(bridgeSupport.processPegIn(new BtcTransaction(btcParams),\n+                mock(Transaction.class),\n+                0,\n+                mock(Sha256Hash.class)));\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_invalid_sender() throws IOException {\n+        assertProcessPegIn(ConsensusRule.RSKIP143,true, false,\n+                BtcLockSender.TxType.P2SHMULTISIG);\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_not_whitelisted_address() throws IOException {\n+        assertProcessPegIn(null,false, false,\n+                BtcLockSender.TxType.P2PKH);\n+    }\n+\n+    @Test\n+    public void processPegIn_tx_no_lockable_by_surpassing_locking_cap() throws IOException {\n+        assertProcessPegIn(ConsensusRule.RSKIP134,true, true,\n+                BtcLockSender.TxType.P2PKH);\n+    }\n+\n+    @Test\n+    public void processRelease_no_release_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+        Assert.assertFalse(bridgeSupport.processRelease(new BtcTransaction(btcParams), mock(Sha256Hash.class)));\n+    }\n+\n+    @Test\n+    public void processMigration_no_migration_tx() throws IOException {\n+        BridgeSupport bridgeSupport = getBridgeSupport(bridgeConstants, mock(BridgeStorageProvider.class));\n+        Assert.assertFalse(bridgeSupport.processMigration(new BtcTransaction(btcParams), mock(Sha256Hash.class)));\n+    }\n+\n+    private void assertProcessPegIn(@Nullable ConsensusRule consensusRule, boolean isWhitelisted,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a577abbab04fb4d46417e23707a624072014fae"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5NDE5OQ==", "bodyText": "?", "url": "https://github.com/rsksmart/rskj/pull/1297#discussion_r476694199", "createdAt": "2020-08-25T19:43:06Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeSupportTest.java", "diffHunk": "@@ -53,6 +53,7 @@\n import org.mockito.ArgumentCaptor;\n import org.mockito.Mockito;\n \n+import javax.annotation.Nullable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a577abbab04fb4d46417e23707a624072014fae"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a577abbab04fb4d46417e23707a624072014fae", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0a577abbab04fb4d46417e23707a624072014fae", "committedDate": "2020-08-25T19:36:38Z", "message": "Refactor RegisterBtcTransaction\n\nMove lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them"}, "afterCommit": {"oid": "ce54a983fd0da9c0ad9613933b0e4c7f2551582a", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ce54a983fd0da9c0ad9613933b0e4c7f2551582a", "committedDate": "2020-08-25T20:16:43Z", "message": "Refactor RegisterBtcTransaction\n\nMove lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce54a983fd0da9c0ad9613933b0e4c7f2551582a", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ce54a983fd0da9c0ad9613933b0e4c7f2551582a", "committedDate": "2020-08-25T20:16:43Z", "message": "Refactor RegisterBtcTransaction\n\nMove lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them"}, "afterCommit": {"oid": "0170768759e85cd9d9cc3874617ac2212582f84b", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0170768759e85cd9d9cc3874617ac2212582f84b", "committedDate": "2020-08-25T21:08:46Z", "message": "Refactor RegisterBtcTransaction\n\nMove lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTAzMTQx", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-477903141", "createdAt": "2020-08-28T17:23:19Z", "commit": {"oid": "5e8d48225d2bb83dbb989582760080f9e4d0f014"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzoyMzoyMFrOHJOoZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzoyMzoyMFrOHJOoZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzODk0OQ==", "bodyText": "registerBtcTransaction shouldn't throw RegisterBtcTransactionException. It is caught inside the method", "url": "https://github.com/rsksmart/rskj/pull/1297#discussion_r479438949", "createdAt": "2020-08-28T17:23:20Z", "author": {"login": "marcos-iov"}, "path": "rskj-core/src/main/java/co/rsk/peg/Bridge.java", "diffHunk": "@@ -446,7 +446,7 @@ public void registerBtcTransaction(Object[] args) {\n         byte[] pmtSerialized = (byte[]) args[2];\n         try {\n             bridgeSupport.registerBtcTransaction(rskTx, btcTxSerialized, height, pmtSerialized);\n-        } catch (IOException | BlockStoreException e) {\n+        } catch (IOException | BlockStoreException | RegisterBtcTransactionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e8d48225d2bb83dbb989582760080f9e4d0f014"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e8d48225d2bb83dbb989582760080f9e4d0f014", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/5e8d48225d2bb83dbb989582760080f9e4d0f014", "committedDate": "2020-08-28T16:58:48Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}, "afterCommit": {"oid": "becd22ffb46c513480f3c1fcd33a7a043676d085", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/becd22ffb46c513480f3c1fcd33a7a043676d085", "committedDate": "2020-08-28T17:53:06Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTIyNTk3", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-477922597", "createdAt": "2020-08-28T17:55:29Z", "commit": {"oid": "becd22ffb46c513480f3c1fcd33a7a043676d085"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTIyMTgx", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-478922181", "createdAt": "2020-08-31T20:14:38Z", "commit": {"oid": "becd22ffb46c513480f3c1fcd33a7a043676d085"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "becd22ffb46c513480f3c1fcd33a7a043676d085", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/becd22ffb46c513480f3c1fcd33a7a043676d085", "committedDate": "2020-08-28T17:53:06Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}, "afterCommit": {"oid": "2b5207fc7c52f1affa35999e1e762f686eb45f3b", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2b5207fc7c52f1affa35999e1e762f686eb45f3b", "committedDate": "2020-09-07T15:14:23Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTU0Mzg4", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-486154388", "createdAt": "2020-09-10T17:25:26Z", "commit": {"oid": "2b5207fc7c52f1affa35999e1e762f686eb45f3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNzoyNToyNlrOHP-T9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNzoyNToyNlrOHP-T9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxMTYwNA==", "bodyText": "Check the indentation here", "url": "https://github.com/rsksmart/rskj/pull/1297#discussion_r486511604", "createdAt": "2020-09-10T17:25:26Z", "author": {"login": "marcos-iov"}, "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -258,81 +265,118 @@ public Wallet getNoSpendWalletForLiveFederations() throws IOException {\n      * @throws BlockStoreException\n      * @throws IOException\n      */\n-    public void registerBtcTransaction(Transaction rskTx, byte[] btcTxSerialized, int height, byte[] pmtSerialized) throws IOException, BlockStoreException {\n-        Context.propagate(btcContext);\n-        Sha256Hash btcTxHash = BtcTransactionFormatUtils.calculateBtcTxHash(btcTxSerialized);\n+    public void registerBtcTransaction(Transaction rskTx, byte[] btcTxSerialized, int height, byte[] pmtSerialized)\n+            throws IOException, BlockStoreException {\n+            Context.propagate(btcContext);\n+            Sha256Hash btcTxHash = BtcTransactionFormatUtils.calculateBtcTxHash(btcTxSerialized);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b5207fc7c52f1affa35999e1e762f686eb45f3b"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b5207fc7c52f1affa35999e1e762f686eb45f3b", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2b5207fc7c52f1affa35999e1e762f686eb45f3b", "committedDate": "2020-09-07T15:14:23Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}, "afterCommit": {"oid": "77ea4d7e83e5b5493f7c4e5419b55779548b6cfe", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/77ea4d7e83e5b5493f7c4e5419b55779548b6cfe", "committedDate": "2020-09-10T17:49:37Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69d25e9a53bbf712d83ccabd545c576210360e1b", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/69d25e9a53bbf712d83ccabd545c576210360e1b", "committedDate": "2020-09-11T14:13:17Z", "message": "Refactor RegisterBtcTransaction\n\nMove lock, release and migration logic to their own methods\nRefactor lock validations to extract refund logic from them"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b86052ce716dd61e340800eac61461c9def36be9", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b86052ce716dd61e340800eac61461c9def36be9", "committedDate": "2020-09-11T14:13:17Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77ea4d7e83e5b5493f7c4e5419b55779548b6cfe", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/77ea4d7e83e5b5493f7c4e5419b55779548b6cfe", "committedDate": "2020-09-10T17:49:37Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}, "afterCommit": {"oid": "b86052ce716dd61e340800eac61461c9def36be9", "author": {"user": {"login": "guidohernan93", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b86052ce716dd61e340800eac61461c9def36be9", "committedDate": "2020-09-11T14:13:17Z", "message": "Refactor registerBtcTransaction method in order to avoid having multiple return statements and create a new type of exception: RegisterBtcTransactionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODQ0NjUy", "url": "https://github.com/rsksmart/rskj/pull/1297#pullrequestreview-486844652", "createdAt": "2020-09-11T14:14:19Z", "commit": {"oid": "b86052ce716dd61e340800eac61461c9def36be9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 519, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}