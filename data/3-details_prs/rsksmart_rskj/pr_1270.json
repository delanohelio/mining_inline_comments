{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NDI4Njcx", "number": 1270, "title": "Fix race condition around newPeers in ChannelManagerImpl", "bodyText": "This fixes the bug where a MessageQueue was witnessed accumulating messages that are never sent, creating a memory leak.\nThe root cause of the bug is due to a race condition that happens when there is a disconnection of a channel at the same time the channel is being promoted to active in the ChannelManagerImpl class.\nHow it happens\n\nThere is a disconnection in the channel. Two things happen here. There is a listener set up on EthereumChannelInitializer for disconnection that ends up calling ChannelManagerImpl#notifyDisconnect with the Channel. This ends up removing the channel from activePeers and/or newPeers collection. There is also the P2pHandler channelInactive method which is also called on the disconnection by Netty which ends up calling MessageQueue#close, which stops the MessageQueue timer that sends the messages and empties the queue.\nAt the same time this is happening, ChannelManagerImpl#handleNewPeersAndDisconnections is being called, since it runs automatically once per second with an ScheduledExecutorService. So the channel got removed from newPeers at the same time it was being promoted to active. This is the sequence being called: ChannelManagerImpl#handleNewPeersAndDisconnections -> ChannelManagerImpl#tryProcessNewPeers -> ChannelManagerImpl#processNewPeers -> ChannelManagerImpl#processNewPeer -> ChannelManagerImpl#addToActives -> SyncPool#addToActives\n\nSo after that, the MessageQueue gets deactivated (logged as \"Cancelling Message Queue\") but because it's still referenced as active by ChannelManagerImpl, it still sends messages. The messages AREN'T actually being sent, the deactivated MessageQueue simply keeps them piling up, thus creating a memory leak.\nTo reproduce it, I added this at the end of EthereumChannelInitializer\n        new Thread(() -> {\n            try {\n                int milis = new Random().nextInt(3000);\n                logger.info(\"sleeping {}\", milis);\n                Thread.sleep(milis);\n                logger.info(\"finished sleeping {}\", milis);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n            ch.close();\n        }).start();\n\nTo kill every new connection after a few seconds. Also I added a Thread Sleep at the beginning of ChannelManagerImpl#processNewPeer. This forces the race condition to happen, which can be verified by the new logs I added to MessageQueue.\nTo fix the race condition I added synchronization blocks around the usage of the newPeers attribute in ChannelManagerImpl. I've verified that, with the code I added to force the race condition, the problem does not appear. If disconnection happens at the same time a promotion to active were to happen, promotion OR disconnection can't run at the same time. So it either gets disconnected so it can't be promoted, or if it happened to be promoted then it's disconnected.\nI decided to include the new logs in the MessageQueue in this PR in case we happen to need them again, but by default, those logs are not set up in the logback.xml", "createdAt": "2020-07-08T19:03:34Z", "url": "https://github.com/rsksmart/rskj/pull/1270", "merged": true, "mergeCommit": {"oid": "c4237fd62c3f740e34ac37dcc2096099b5bf9f9c"}, "closed": true, "closedAt": "2020-07-29T14:49:10Z", "author": {"login": "nicops"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1LyRWAFqTQ0OTAzMzkxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5cjZNAFqTQ1Njk5MTI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDMzOTEx", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-449033911", "createdAt": "2020-07-15T14:47:35Z", "commit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NzozNVrOGyBsvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NzozNVrOGyBsvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwOTgyMg==", "bodyText": "could we log both cases? \"new\" and \"active\"?", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455109822", "createdAt": "2020-07-15T14:47:35Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {\n+            if(newPeers.remove(channel)) {\n+                logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjIzMzQz", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-449223343", "createdAt": "2020-07-15T18:28:34Z", "commit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODozNFrOGyKqhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODozNFrOGyKqhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjcwOQ==", "bodyText": "Why not add synchronization to add(Channel peer)?", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455256709", "createdAt": "2020-07-15T18:28:34Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/be644bb9d2a883fcf978ef090454b92ab5f798f2", "committedDate": "2020-07-13T16:55:24Z", "message": "Removed extra tracing logging in MessageQueue"}, "afterCommit": {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/979bc70e9e2b08364728c0adae4ad2510d190b46", "committedDate": "2020-07-15T18:34:48Z", "message": "Removed extra tracing logging in MessageQueue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDQ2NTYz", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-450046563", "createdAt": "2020-07-16T17:07:41Z", "commit": {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDgxNzIy", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-450081722", "createdAt": "2020-07-16T17:53:28Z", "commit": {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTIxMzYz", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-450121363", "createdAt": "2020-07-16T18:49:12Z", "commit": {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de4214ec123d3e9981c474eee0738396dfd7773", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/6de4214ec123d3e9981c474eee0738396dfd7773", "committedDate": "2020-07-28T18:50:50Z", "message": "Fix race condition around newPeers in ChannelManagerImpl, plus extra logs in MessageQueue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14929adebeaf9b97dcb4b82dcf0a835e25a19b84", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/14929adebeaf9b97dcb4b82dcf0a835e25a19b84", "committedDate": "2020-07-28T18:50:50Z", "message": "better logging in ChannelManagerImpl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "committedDate": "2020-07-28T18:50:50Z", "message": "Removed extra tracing logging in MessageQueue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/979bc70e9e2b08364728c0adae4ad2510d190b46", "committedDate": "2020-07-15T18:34:48Z", "message": "Removed extra tracing logging in MessageQueue"}, "afterCommit": {"oid": "19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "committedDate": "2020-07-28T18:50:50Z", "message": "Removed extra tracing logging in MessageQueue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTkxMjY1", "url": "https://github.com/rsksmart/rskj/pull/1270#pullrequestreview-456991265", "createdAt": "2020-07-28T20:35:46Z", "commit": {"oid": "19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 482, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}