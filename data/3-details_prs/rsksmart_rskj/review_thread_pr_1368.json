{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzOTMwMzI0", "number": 1368, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoxNjo1NlrOE81xoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODowMTo0OFrOE826fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMjMxMDczOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoxNjo1NlrOH5NEFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoxNjo1NlrOH5NEFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0NDkxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Sha256Hash rskTxHash = PegTestUtils.createHash(2);\n          \n          \n            \n                    Sha256Hash btcTxHash = PegTestUtils.createHash(2);", "url": "https://github.com/rsksmart/rskj/pull/1368#discussion_r529744919", "createdAt": "2020-11-24T17:16:56Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "diffHunk": "@@ -2154,13 +2154,16 @@ public void saveCoinBaseInformation_after_RSKIP143() throws IOException {\n     public void isFastBridgeFederationDerivationHashUsed_afterRSKIP176_returnTrue() {\n         Repository repository = mock(Repository.class);\n \n-        Sha256Hash hash = Sha256Hash.ZERO_HASH;\n+        Sha256Hash derivationHash = PegTestUtils.createHash(1);\n+        Sha256Hash rskTxHash = PegTestUtils.createHash(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46ff7bbaa57dc7482488e33b9510f0681b48aba6"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMjMxNTMxOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoxODowNFrOH5NG9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoxODowNFrOH5NG9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0NTY1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void saveDerivationArgumentsScriptHash_afterRSKIP176_nullrskTxHash_notSaved() throws IOException {\n          \n          \n            \n                public void saveDerivationArgumentsScriptHash_afterRSKIP176_null_derivationHash_notSaved() throws IOException {", "url": "https://github.com/rsksmart/rskj/pull/1368#discussion_r529745652", "createdAt": "2020-11-24T17:18:04Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "diffHunk": "@@ -2281,24 +2297,72 @@ public void saveDerivationArgumentsScriptHash_afterRSKIP176_Ok() throws IOExcept\n                 activations\n         );\n \n-        provider.markFastBridgeFederationDerivationHashAsUsed(hash);\n+        provider.markFastBridgeFederationDerivationHashAsUsed(rskTxHash, derivationHash);\n \n         provider.save();\n \n         verify(repository, times(1)).addStorageBytes(\n                 PrecompiledContracts.BRIDGE_ADDR,\n-                DataWord.fromLongString(\"fastBridgeScriptHash-\" + hash.toString()),\n+                DataWord.fromLongString(\"fastBridgeHashUsedInBtcTx-\" + rskTxHash.toString() + derivationHash.toString()),\n                 new byte[]{FAST_BRIDGE_FEDERATION_SCRIPT_HASH_TRUE_VALUE_TEST}\n         );\n         verifyNoMoreInteractions(repository);\n     }\n \n+    @Test\n+    public void saveDerivationArgumentsScriptHash_afterRSKIP176_nullBtcTxHash_notSaved() throws IOException {\n+        Repository repository = mock(Repository.class);\n+\n+        Sha256Hash derivationHash = PegTestUtils.createHash(1);\n+        Sha256Hash rskTxHash = null;\n+\n+        ActivationConfig.ForBlock activations = mock(ActivationConfig.ForBlock.class);\n+        when(activations.isActive(ConsensusRule.RSKIP176)).thenReturn(true);\n+\n+        BridgeStorageProvider provider = new BridgeStorageProvider(\n+                repository,\n+                PrecompiledContracts.BRIDGE_ADDR,\n+                config.getNetworkConstants().getBridgeConstants(),\n+                activations\n+        );\n+\n+        provider.markFastBridgeFederationDerivationHashAsUsed(rskTxHash, derivationHash);\n+\n+        provider.save();\n+        \n+        verifyZeroInteractions(repository);\n+    }\n+\n+    @Test\n+    public void saveDerivationArgumentsScriptHash_afterRSKIP176_nullrskTxHash_notSaved() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46ff7bbaa57dc7482488e33b9510f0681b48aba6"}, "originalPosition": 189}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMjQ5NzI3OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODowMTo0OFrOH5O2Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODowMTo0OFrOH5O2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3NDEzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void saveDerivationArgumentsScriptHash_afterRSKIP176_nullBtcTxHash_notSaved() throws IOException {\n          \n          \n            \n                public void saveDerivationArgumentsScriptHash_afterRSKIP176_null_derivationHash_notSaved() throws IOException {", "url": "https://github.com/rsksmart/rskj/pull/1368#discussion_r529774130", "createdAt": "2020-11-24T18:01:48Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/test/java/co/rsk/peg/BridgeStorageProviderTest.java", "diffHunk": "@@ -2281,24 +2297,48 @@ public void saveDerivationArgumentsScriptHash_afterRSKIP176_Ok() throws IOExcept\n                 activations\n         );\n \n-        provider.markFastBridgeFederationDerivationHashAsUsed(hash);\n+        provider.markFastBridgeFederationDerivationHashAsUsed(btcTxHash, derivationHash);\n \n         provider.save();\n \n         verify(repository, times(1)).addStorageBytes(\n                 PrecompiledContracts.BRIDGE_ADDR,\n-                DataWord.fromLongString(\"fastBridgeScriptHash-\" + hash.toString()),\n+                DataWord.fromLongString(\"fastBridgeHashUsedInBtcTx-\" + btcTxHash.toString() + derivationHash.toString()),\n                 new byte[]{FAST_BRIDGE_FEDERATION_SCRIPT_HASH_TRUE_VALUE_TEST}\n         );\n         verifyNoMoreInteractions(repository);\n     }\n \n+    @Test\n+    public void saveDerivationArgumentsScriptHash_afterRSKIP176_nullBtcTxHash_notSaved() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b313289d9532c3e715c93e4a9049338c89f0b87"}, "originalPosition": 165}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4548, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}