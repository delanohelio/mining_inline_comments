{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMDM3NzEy", "number": 1285, "title": "ForkDetectionData retrieval performance", "bodyText": "We found out that the conversion of native byte arrays (byte[]) to object lists (List<Byte>) was adding a bit of overhead when performing merge mining tag lookups in the block's btc coinbase data in ProofOfWorkRule as well as in the fork detection data retrieval in BlockHeader. So we decided to temporarily use an implementation of the lookup algorithm that uses native types instead of objects. Altough the change is small, we felt it was a good first step before jumping to a faster or complex implementation.", "createdAt": "2020-08-04T22:13:53Z", "url": "https://github.com/rsksmart/rskj/pull/1285", "merged": true, "mergeCommit": {"oid": "4e5b6b8d4da5b3f7a5a38ac9f34da46f7189033d"}, "closed": true, "closedAt": "2020-08-19T14:31:08Z", "author": {"login": "M-Picco"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8NFdYAFqTQ2MjM4OTEyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdANlrEgFqTQ2OTgzMTM3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzg5MTI1", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-462389125", "createdAt": "2020-08-06T10:16:00Z", "commit": {"oid": "420cb2fe41d874b6874cd96de112c261b0fab950"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMDoxNjowMFrOG8taOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMDoxNjowMFrOG8taOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMTczOA==", "bodyText": "Could we use UMM_LEAVES_LENGTH instead of magic number 20?", "url": "https://github.com/rsksmart/rskj/pull/1285#discussion_r466311738", "createdAt": "2020-08-06T10:16:00Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockHeader.java", "diffHunk": "@@ -570,6 +560,24 @@ public String getParentShortHash() {\n         return new byte[0];\n     }\n \n+    /**\n+     * Compute the base hash for merged mining, taking into account whether the block is a umm block.\n+     * This base hash is later modified to include the forkdetectiondata in its last 12 bytes\n+     *\n+     * @return The computed hash for merged mining\n+     */\n+    private byte[] getBaseHashForMergedMining() {\n+        byte[] encodedBlock = getEncoded(false, false);\n+        byte[] hashForMergedMining = HashUtil.keccak256(encodedBlock);\n+\n+        if (isUMMBlock()) {\n+            byte[] leftHash = Arrays.copyOfRange(hashForMergedMining, 0, 20);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "420cb2fe41d874b6874cd96de112c261b0fab950"}, "originalPosition": 91}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "420cb2fe41d874b6874cd96de112c261b0fab950", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/420cb2fe41d874b6874cd96de112c261b0fab950", "committedDate": "2020-08-04T22:02:13Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "d5026b645e0f02b154ea3ea26b92068adc1ba651", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d5026b645e0f02b154ea3ea26b92068adc1ba651", "committedDate": "2020-08-06T15:16:26Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NTQwMTg0", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-464540184", "createdAt": "2020-08-10T20:04:40Z", "commit": {"oid": "d5026b645e0f02b154ea3ea26b92068adc1ba651"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5026b645e0f02b154ea3ea26b92068adc1ba651", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d5026b645e0f02b154ea3ea26b92068adc1ba651", "committedDate": "2020-08-06T15:16:26Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "ef1cb6234ed0eeed8da50f42bb22474db1e049be", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/ef1cb6234ed0eeed8da50f42bb22474db1e049be", "committedDate": "2020-08-12T16:40:25Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODkzNzE3", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-467893717", "createdAt": "2020-08-14T21:51:44Z", "commit": {"oid": "ef1cb6234ed0eeed8da50f42bb22474db1e049be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTo1MTo0NFrOHBEQzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTo1MTo0NFrOHBEQzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4MDQ2MQ==", "bodyText": "I think we should definitely validate that the fork detection data in the coinbase transaction is always 12 bytes and avoid these potentially consensus threatening blocks.", "url": "https://github.com/rsksmart/rskj/pull/1285#discussion_r470880461", "createdAt": "2020-08-14T21:51:44Z", "author": {"login": "amendelzon"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockHeader.java", "diffHunk": "@@ -539,28 +533,24 @@ public String getParentShortHash() {\n     public byte[] getMiningForkDetectionData() {\n         if(includeForkDetectionData) {\n             if (hasMiningFields() && miningForkDetectionData.length == 0) {\n-                byte[] encodedBlock = getEncoded(false, false);\n-                byte[] hashForMergedMining = HashUtil.keccak256(encodedBlock);\n-\n-                byte[] hashForMergedMiningPrefix = Arrays.copyOfRange(\n-                        hashForMergedMining,\n-                        0,\n-                        HASH_FOR_MERGED_MINING_PREFIX_LENGTH\n-                );\n+                byte[] hashForMergedMining = getBaseHashForMergedMining();\n+\n                 byte[] coinbaseTransaction = getBitcoinMergedMiningCoinbaseTransaction();\n \n-                List<Byte> hashForMergedMiningPrefixAsList = Arrays.asList(ArrayUtils.toObject(hashForMergedMiningPrefix));\n-                List<Byte> coinbaseAsList = Arrays.asList(ArrayUtils.toObject(coinbaseTransaction));\n+                byte[] mergeMiningTagPrefix = Arrays.copyOf(RskMiningConstants.RSK_TAG, RskMiningConstants.RSK_TAG.length + HASH_FOR_MERGED_MINING_PREFIX_LENGTH);\n+                arraycopy(hashForMergedMining, 0, mergeMiningTagPrefix, RskMiningConstants.RSK_TAG.length, HASH_FOR_MERGED_MINING_PREFIX_LENGTH);\n \n-                int position = Collections.lastIndexOfSubList(coinbaseAsList, hashForMergedMiningPrefixAsList);\n+                int position = ListArrayUtil.lastIndexOfSubList(coinbaseTransaction, mergeMiningTagPrefix);\n                 if (position == -1) {\n                     throw new IllegalStateException(\n                             String.format(\"Mining fork detection data could not be found. Header: %s\", getShortHash())\n                     );\n                 }\n \n-                int from = position + HASH_FOR_MERGED_MINING_PREFIX_LENGTH;\n+                int from = position + RskMiningConstants.RSK_TAG.length + HASH_FOR_MERGED_MINING_PREFIX_LENGTH;\n                 int to = from + FORK_DETECTION_DATA_LENGTH;\n+\n+                // should the fork detection data in the coinbase be under 12 bytes, copyOfRange pads with zeros", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef1cb6234ed0eeed8da50f42bb22474db1e049be"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef1cb6234ed0eeed8da50f42bb22474db1e049be", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/ef1cb6234ed0eeed8da50f42bb22474db1e049be", "committedDate": "2020-08-12T16:40:25Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "8efa5cd6aadc4717a4b75415512f650c712ac047", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/8efa5cd6aadc4717a4b75415512f650c712ac047", "committedDate": "2020-08-18T14:30:06Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8efa5cd6aadc4717a4b75415512f650c712ac047", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/8efa5cd6aadc4717a4b75415512f650c712ac047", "committedDate": "2020-08-18T14:30:06Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "d139c4fdbab911f065ab13d6a6138e56dcd3502f", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d139c4fdbab911f065ab13d6a6138e56dcd3502f", "committedDate": "2020-08-18T14:57:08Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d139c4fdbab911f065ab13d6a6138e56dcd3502f", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/d139c4fdbab911f065ab13d6a6138e56dcd3502f", "committedDate": "2020-08-18T14:57:08Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "155a9bce7caca62d36ef6e21e25317499779a417", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/155a9bce7caca62d36ef6e21e25317499779a417", "committedDate": "2020-08-18T17:02:41Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "155a9bce7caca62d36ef6e21e25317499779a417", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/155a9bce7caca62d36ef6e21e25317499779a417", "committedDate": "2020-08-18T17:02:41Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "91e6dd4e462196892727078926e7bc659f605241", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/91e6dd4e462196892727078926e7bc659f605241", "committedDate": "2020-08-18T17:46:31Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91e6dd4e462196892727078926e7bc659f605241", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/91e6dd4e462196892727078926e7bc659f605241", "committedDate": "2020-08-18T17:46:31Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "86ff1ee4f54e70d089e729b6f35087bb37f991bb", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/86ff1ee4f54e70d089e729b6f35087bb37f991bb", "committedDate": "2020-08-18T19:16:55Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86ff1ee4f54e70d089e729b6f35087bb37f991bb", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/86ff1ee4f54e70d089e729b6f35087bb37f991bb", "committedDate": "2020-08-18T19:16:55Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "35cafce5d298b54655cd51c061bf4934c023a32d", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/35cafce5d298b54655cd51c061bf4934c023a32d", "committedDate": "2020-08-18T19:24:45Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODA0ODY4", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-469804868", "createdAt": "2020-08-18T20:25:31Z", "commit": {"oid": "35cafce5d298b54655cd51c061bf4934c023a32d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDoyNTozMVrOHClKjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDoyNTozMVrOHClKjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2ODExMQ==", "bodyText": "Shouldn't FORK_DETECTION_DATA_LENGTH - (to - coinbaseTransaction.length) (the Got: %d bit) be coinbaseTransaction.length - from - 1?", "url": "https://github.com/rsksmart/rskj/pull/1285#discussion_r472468111", "createdAt": "2020-08-18T20:25:31Z", "author": {"login": "amendelzon"}, "path": "rskj-core/src/main/java/org/ethereum/core/BlockHeader.java", "diffHunk": "@@ -539,28 +533,29 @@ public String getParentPrintableHash() {\n     public byte[] getMiningForkDetectionData() {\n         if(includeForkDetectionData) {\n             if (hasMiningFields() && miningForkDetectionData.length == 0) {\n-                byte[] encodedBlock = getEncoded(false, false);\n-                byte[] hashForMergedMining = HashUtil.keccak256(encodedBlock);\n-\n-                byte[] hashForMergedMiningPrefix = Arrays.copyOfRange(\n-                        hashForMergedMining,\n-                        0,\n-                        HASH_FOR_MERGED_MINING_PREFIX_LENGTH\n-                );\n+                byte[] hashForMergedMining = getBaseHashForMergedMining();\n+\n                 byte[] coinbaseTransaction = getBitcoinMergedMiningCoinbaseTransaction();\n \n-                List<Byte> hashForMergedMiningPrefixAsList = Arrays.asList(ArrayUtils.toObject(hashForMergedMiningPrefix));\n-                List<Byte> coinbaseAsList = Arrays.asList(ArrayUtils.toObject(coinbaseTransaction));\n+                byte[] mergeMiningTagPrefix = Arrays.copyOf(RskMiningConstants.RSK_TAG, RskMiningConstants.RSK_TAG.length + HASH_FOR_MERGED_MINING_PREFIX_LENGTH);\n+                arraycopy(hashForMergedMining, 0, mergeMiningTagPrefix, RskMiningConstants.RSK_TAG.length, HASH_FOR_MERGED_MINING_PREFIX_LENGTH);\n \n-                int position = Collections.lastIndexOfSubList(coinbaseAsList, hashForMergedMiningPrefixAsList);\n+                int position = ListArrayUtil.lastIndexOfSubList(coinbaseTransaction, mergeMiningTagPrefix);\n                 if (position == -1) {\n                     throw new IllegalStateException(\n                             String.format(\"Mining fork detection data could not be found. Header: %s\", getPrintableHash())\n                     );\n                 }\n \n-                int from = position + HASH_FOR_MERGED_MINING_PREFIX_LENGTH;\n+                int from = position + RskMiningConstants.RSK_TAG.length + HASH_FOR_MERGED_MINING_PREFIX_LENGTH;\n                 int to = from + FORK_DETECTION_DATA_LENGTH;\n+\n+                if (coinbaseTransaction.length < to) {\n+                    throw new IllegalStateException(\n+                            String.format(\"Invalid fork detection data length. Expected: %d. Got: %d. Header: %s\", FORK_DETECTION_DATA_LENGTH, FORK_DETECTION_DATA_LENGTH - (to - coinbaseTransaction.length), getPrintableHash())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35cafce5d298b54655cd51c061bf4934c023a32d"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODA1NTY0", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-469805564", "createdAt": "2020-08-18T20:26:36Z", "commit": {"oid": "35cafce5d298b54655cd51c061bf4934c023a32d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0da798faf029b90d9941bc1bcd0fc6c27a54fd0a", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/0da798faf029b90d9941bc1bcd0fc6c27a54fd0a", "committedDate": "2020-08-18T20:56:37Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35cafce5d298b54655cd51c061bf4934c023a32d", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/35cafce5d298b54655cd51c061bf4934c023a32d", "committedDate": "2020-08-18T19:24:45Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}, "afterCommit": {"oid": "0da798faf029b90d9941bc1bcd0fc6c27a54fd0a", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/0da798faf029b90d9941bc1bcd0fc6c27a54fd0a", "committedDate": "2020-08-18T20:56:37Z", "message": "Improve forkDetectionData and hashForMergedMining lookup in ProofOfWork by replacing the convertion to List<Byte> and use of Collections.lastIndexOfSubList for an implementation of lastIndexOfSubList with native byte arrays"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODMxMzcx", "url": "https://github.com/rsksmart/rskj/pull/1285#pullrequestreview-469831371", "createdAt": "2020-08-18T21:07:09Z", "commit": {"oid": "0da798faf029b90d9941bc1bcd0fc6c27a54fd0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 500, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}