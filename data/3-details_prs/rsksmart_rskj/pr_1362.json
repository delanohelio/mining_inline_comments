{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNTE0MTY5", "number": 1362, "title": "Implemented timestamp linking validation", "bodyText": "This implementation checks if BTC and RSK block timestamps are close enough.\nDescription\nThis extends BlockTimeStampValidationRule class with the timestamps validation logic and its activation in the next HF.\nMotivation and Context\nThis aims to prevent a merge-miner attacker from mining old RSK blocks with the current Bitcoin hashrate.\nHow Has This Been Tested?\nUsing unit tests and running the node locally.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n Tests for the changes have been added (for bug fixes / features)\n Requires Activation Code (Hard Fork)\n\n\nOther information:", "createdAt": "2020-11-16T08:55:26Z", "url": "https://github.com/rsksmart/rskj/pull/1362", "merged": true, "mergeCommit": {"oid": "e4260bb76268fb628c4730af8f9deb70c279814d"}, "closed": true, "closedAt": "2020-12-30T13:48:22Z", "author": {"login": "Vovchyk"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnD1g_gBqjQxMjUxOTA4NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrPlvvgFqTU2MDA1MzY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56526d66acc02fd2b458f404bc9359487be17bb2", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/56526d66acc02fd2b458f404bc9359487be17bb2", "committedDate": "2020-11-16T08:44:53Z", "message": "Implemented timestamp linking validation"}, "afterCommit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/69cda482a2b6703a16f82a3c812e6dfb045002d9", "committedDate": "2020-12-17T13:48:03Z", "message": "Implemented timestamp linking validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjQxNzIw", "url": "https://github.com/rsksmart/rskj/pull/1362#pullrequestreview-554641720", "createdAt": "2020-12-17T14:14:46Z", "commit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDoxNDo0NlrOIH3kJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxOTo0MTo1N1rOIIF2IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEyMTMxOA==", "bodyText": "2020?", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545121318", "createdAt": "2020-12-17T14:14:46Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/co/rsk/util/TimeProvider.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MDUyNw==", "bodyText": "Could you leave a comment here, telling what #179 is all about, short comment (title?)?\nWe are trying to identify faster whats the main reason behind the code.", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545350527", "createdAt": "2020-12-17T19:34:01Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/org/ethereum/config/blockchain/upgrades/ConsensusRule.java", "diffHunk": "@@ -54,6 +54,7 @@\n     RSKIP171(\"rskip171\"),\n     RSKIP172(\"rskip172\"),\n     RSKIP174(\"rskip174\"),\n+    RSKIP179(\"rskip179\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NTI5Ng==", "bodyText": "Its the same to use RegTestParams than MainNetParams in this logic class? Because I dont see any other use than this default constructor, so no matter which network we are, it will use regtest params.", "url": "https://github.com/rsksmart/rskj/pull/1362#discussion_r545355296", "createdAt": "2020-12-17T19:41:57Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/co/rsk/validators/BlockTimeStampValidationRule.java", "diffHunk": "@@ -18,22 +18,51 @@\n \n package co.rsk.validators;\n \n+import co.rsk.bitcoinj.core.BtcBlock;\n+import co.rsk.bitcoinj.core.NetworkParameters;\n+import co.rsk.bitcoinj.params.RegTestParams;\n+import co.rsk.util.TimeProvider;\n+import org.ethereum.config.Constants;\n+import org.ethereum.config.blockchain.upgrades.ActivationConfig;\n+import org.ethereum.config.blockchain.upgrades.ConsensusRule;\n import org.ethereum.core.Block;\n import org.ethereum.core.BlockHeader;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n /**\n  * Created by mario on 23/01/17.\n  */\n public class BlockTimeStampValidationRule implements BlockParentDependantValidationRule, BlockHeaderParentDependantValidationRule, BlockValidationRule, BlockHeaderValidationRule {\n \n     private static final Logger logger = LoggerFactory.getLogger(\"blockvalidator\");\n \n-    private int validPeriodLength;\n+    private static final long MAX_TIMESTAMPS_DIFF_IN_SECS = Constants.getMaxTimestampsDiffInSecs();\n+\n+    private final int validPeriodLength;\n+    private final ActivationConfig activationConfig;\n+    private final TimeProvider timeProvider;\n+    private final NetworkParameters bitcoinNetworkParameters;\n \n-    public BlockTimeStampValidationRule(int validPeriodLength) {\n+    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig,\n+                                        TimeProvider timeProvider, NetworkParameters bitcoinNetworkParameters) {\n         this.validPeriodLength = validPeriodLength;\n+        this.activationConfig = Objects.requireNonNull(activationConfig);\n+        this.timeProvider = Objects.requireNonNull(timeProvider);\n+        this.bitcoinNetworkParameters = Objects.requireNonNull(bitcoinNetworkParameters);\n+    }\n+\n+    public BlockTimeStampValidationRule(int validPeriodLength, ActivationConfig activationConfig,\n+                                        TimeProvider timeProvider) {\n+        this(validPeriodLength, activationConfig, timeProvider, RegTestParams.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69cda482a2b6703a16f82a3c812e6dfb045002d9", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/69cda482a2b6703a16f82a3c812e6dfb045002d9", "committedDate": "2020-12-17T13:48:03Z", "message": "Implemented timestamp linking validation"}, "afterCommit": {"oid": "de57eabf6ae94757eae194e650b6be1760704766", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/de57eabf6ae94757eae194e650b6be1760704766", "committedDate": "2020-12-21T12:50:29Z", "message": "Added a comment in ConsensusRule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDY5MDQ2", "url": "https://github.com/rsksmart/rskj/pull/1362#pullrequestreview-556469046", "createdAt": "2020-12-21T15:37:59Z", "commit": {"oid": "de57eabf6ae94757eae194e650b6be1760704766"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de57eabf6ae94757eae194e650b6be1760704766", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/de57eabf6ae94757eae194e650b6be1760704766", "committedDate": "2020-12-21T12:50:29Z", "message": "Added a comment in ConsensusRule"}, "afterCommit": {"oid": "de675eb67023baebbd61fb91a430104fe8b03c3c", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/de675eb67023baebbd61fb91a430104fe8b03c3c", "committedDate": "2020-12-28T13:54:44Z", "message": "Added a comment in ConsensusRule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de675eb67023baebbd61fb91a430104fe8b03c3c", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/de675eb67023baebbd61fb91a430104fe8b03c3c", "committedDate": "2020-12-28T13:54:44Z", "message": "Added a comment in ConsensusRule"}, "afterCommit": {"oid": "2d47c78792cdc3d25452642c66457417bf8daa3d", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2d47c78792cdc3d25452642c66457417bf8daa3d", "committedDate": "2020-12-29T08:30:17Z", "message": "Added a comment in ConsensusRule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa3c45c1b3c5acef45a656978506aab241dad61", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/cfa3c45c1b3c5acef45a656978506aab241dad61", "committedDate": "2020-12-29T10:09:16Z", "message": "Implemented timestamp linking validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3cfcfcbf1468817eee96edffe2d804fa495958", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/6f3cfcfcbf1468817eee96edffe2d804fa495958", "committedDate": "2020-12-29T10:09:18Z", "message": "Added a comment in ConsensusRule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d47c78792cdc3d25452642c66457417bf8daa3d", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2d47c78792cdc3d25452642c66457417bf8daa3d", "committedDate": "2020-12-29T08:30:17Z", "message": "Added a comment in ConsensusRule"}, "afterCommit": {"oid": "6f3cfcfcbf1468817eee96edffe2d804fa495958", "author": {"user": {"login": "Vovchyk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/6f3cfcfcbf1468817eee96edffe2d804fa495958", "committedDate": "2020-12-29T10:09:18Z", "message": "Added a comment in ConsensusRule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMDUzNjU3", "url": "https://github.com/rsksmart/rskj/pull/1362#pullrequestreview-560053657", "createdAt": "2020-12-30T13:45:47Z", "commit": {"oid": "6f3cfcfcbf1468817eee96edffe2d804fa495958"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 627, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}