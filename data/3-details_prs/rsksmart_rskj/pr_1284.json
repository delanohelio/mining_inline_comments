{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMTk4ODU2", "number": 1284, "title": "Fix JSON RPC trace_transaction and trace_block", "bodyText": "This  code fix two issues in current JSON RPC output for trace_transaction and trace_block:\n\ncallType value should be delegatecall when the call from contract A to contract B was executed via a DELEGATECALL opcode\n\n  {\n    \"action\": {\n      \"callType\": \"delegatecall\",         //   <-------------- this value\n      \"from\": \"0x9653f73cbf95b738a44019aeb1efc4e1b5632d71\",\n      \"gas\": \"0x3fd19\",\n      \"input\": \"0xb63e800d0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000d5d82b6addc9027b22dca772aa68d5d74cdbdf4400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023fe3a2cefb32800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000140f54704b9b5d6d4158501f0aed48474ddc0529000000000000000000000000150d407e066f079fbbdce728fac8b51d2c56f26800000000000000000000000086425fba06faaf4353e275b925af0aa13a2af99100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\n      \"to\": \"0x34cfac646f301356faa8b21e94227e3583fe3f5f\",\n      \"value\": \"0x0\"\n    },\n    \"blockHash\": \"0x17162e1eae50987a63bcd3e046d3f370a28125c9735b6624b32333df2d765c69\",\n    \"blockNumber\": 10356397,\n    \"result\": {\n      \"gasUsed\": \"0x30fb8\",\n      \"output\": \"0x\"\n    },\n    \"subtraces\": 1,\n    \"traceAddress\": [\n      1,\n      0\n    ],\n    \"transactionHash\": \"0xabf3f349e585a728441ce9a45c06897fb4d15fd4cc7bfdbdd0c449d0096fe79a\",\n    \"transactionPosition\": 21,\n    \"type\": \"call\"\n  },\n\nThis new code also solves #1291\n.- the creationMethod value should be create2 when a contract is created from another contract using the CREATE2 opcode (this code also adds this field with value create when a CREATE opcode is used):\n  {\n    \"action\": {\n      \"creationMethod\": \"create2\",     //   <-------------- this value\n      \"from\": \"0x76e2cfc1f5fa8f6a5b3fc4c8f4788f0116861f9b\",\n      \"gas\": \"0x4eaea\",\n      \"init\": \"0x608060405234801561001057600080fd5b506040516101e73803806101e78339818101604052602081101561003357600080fd5b8101908080519060200190929190505050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156100ca576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001806101c36024913960400191505060405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505060aa806101196000396000f3fe608060405273ffffffffffffffffffffffffffffffffffffffff600054167fa619486e0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000f35b3660008037600080366000845af43d6000803e60008114156070573d6000fd5b3d6000f3fea265627a7a72315820d8a00dc4fe6bf675a9d7416fc2d00bb3433362aa8186b750f76c4027269667ff64736f6c634300050e0032496e76616c6964206d617374657220636f707920616464726573732070726f766964656400000000000000000000000034cfac646f301356faa8b21e94227e3583fe3f5f\",\n      \"value\": \"0x0\"\n    },\n    \"blockHash\": \"0x17162e1eae50987a63bcd3e046d3f370a28125c9735b6624b32333df2d765c69\",\n    \"blockNumber\": 10356397,\n    \"result\": {\n      \"address\": \"0x9653f73cbf95b738a44019aeb1efc4e1b5632d71\",\n      \"code\": \"0x608060405273ffffffffffffffffffffffffffffffffffffffff600054167fa619486e0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000f35b3660008037600080366000845af43d6000803e60008114156070573d6000fd5b3d6000f3fea265627a7a72315820d8a00dc4fe6bf675a9d7416fc2d00bb3433362aa8186b750f76c4027269667ff64736f6c634300050e0032\",\n      \"gasUsed\": \"0xd745\"\n    },\n    \"subtraces\": 0,\n    \"traceAddress\": [\n      0\n    ],\n    \"transactionHash\": \"0xabf3f349e585a728441ce9a45c06897fb4d15fd4cc7bfdbdd0c449d0096fe79a\",\n    \"transactionPosition\": 21,\n    \"type\": \"create\"\n  },\n  {\n    \"action\": {\n      \"callType\": \"call\",\n      \"from\": \"0x76e2cfc1f5fa8f6a5b3fc4c8f4788f0116861f9b\",\n      \"gas\": \"0x413ce\",\n      \"input\": \"0xb63e800d0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000d5d82b6addc9027b22dca772aa68d5d74cdbdf4400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023fe3a2cefb32800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000140f54704b9b5d6d4158501f0aed48474ddc0529000000000000000000000000150d407e066f079fbbdce728fac8b51d2c56f26800000000000000000000000086425fba06faaf4353e275b925af0aa13a2af99100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\n      \"to\": \"0x9653f73cbf95b738a44019aeb1efc4e1b5632d71\",\n      \"value\": \"0x0\"\n    },\n    \"blockHash\": \"0x17162e1eae50987a63bcd3e046d3f370a28125c9735b6624b32333df2d765c69\",\n    \"blockNumber\": 10356397,\n    \"result\": {\n      \"gasUsed\": \"0x31662\",\n      \"output\": \"0x\"\n    },\n    \"subtraces\": 1,\n    \"traceAddress\": [\n      1\n    ],\n    \"transactionHash\": \"0xabf3f349e585a728441ce9a45c06897fb4d15fd4cc7bfdbdd0c449d0096fe79a\",\n    \"transactionPosition\": 21,\n    \"type\": \"call\"\n  },", "createdAt": "2020-07-31T14:29:06Z", "url": "https://github.com/rsksmart/rskj/pull/1284", "merged": true, "mergeCommit": {"oid": "c1a2e7faab6512fb3c99a05b6bcbd9172840b6f7"}, "closed": true, "closedAt": "2020-08-27T14:43:57Z", "author": {"login": "ajlopezrsk"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6Y14kABqjM2MDk4MjA4MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDAkICAFqTQ3NjcyOTA2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a422cc69e681ad2318cc38d5407ce5830ffad304", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/a422cc69e681ad2318cc38d5407ce5830ffad304", "committedDate": "2020-07-30T16:28:45Z", "message": "CREATE2 code test"}, "afterCommit": {"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/7d0b9debd2c70c730f6d95604096c7576cae43ec", "committedDate": "2020-07-31T18:49:10Z", "message": "CREATE2 code test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDUyMjcx", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-459452271", "createdAt": "2020-07-31T20:31:21Z", "commit": {"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDozMToyMlrOG6VaFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDozMToyMlrOG6VaFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMTMzMg==", "bodyText": "shouldn't be \"create2\" : \"create\" ?", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r463821332", "createdAt": "2020-07-31T20:31:22Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/trace/ProgramSubtrace.java", "diffHunk": "@@ -29,26 +29,28 @@\n     private final TraceType traceType;\n     private final CallType callType;\n     private final CreationData creationData;\n+    private final String creationMethod;\n     private final InvokeData invokeData;\n     private final ProgramResult programResult;\n     private final List<ProgramSubtrace> subtraces;\n \n     public static ProgramSubtrace newSuicideSubtrace(InvokeData invokeData) {\n-        return new ProgramSubtrace(TraceType.SUICIDE, CallType.NONE, null, invokeData, null, Collections.emptyList());\n+        return new ProgramSubtrace(TraceType.SUICIDE, CallType.NONE, null, null, invokeData, null, Collections.emptyList());\n     }\n \n-    public static ProgramSubtrace newCreateSubtrace(CreationData creationData, InvokeData invokeData, ProgramResult programResult, List<ProgramSubtrace> subtraces) {\n-        return new ProgramSubtrace(TraceType.CREATE, CallType.NONE, creationData, invokeData, programResult, subtraces);\n+    public static ProgramSubtrace newCreateSubtrace(CreationData creationData, InvokeData invokeData, ProgramResult programResult, List<ProgramSubtrace> subtraces, boolean isCreate2) {\n+        return new ProgramSubtrace(TraceType.CREATE, CallType.NONE, creationData, isCreate2 ? \"create2\" : null, invokeData, programResult, subtraces);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzY3OTUw", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-461767950", "createdAt": "2020-08-05T15:18:20Z", "commit": {"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxODoyMVrOG8OfDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxODoyMVrOG8OfDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwNTA3MA==", "bodyText": "what does this do? are you using this to simulate something related to create2? I don't really follow it.", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r465805070", "createdAt": "2020-08-05T15:18:21Z", "author": {"login": "nicops"}, "path": "rskj-core/src/test/java/co/rsk/test/dsl/WorldDslProcessor.java", "diffHunk": "@@ -121,14 +122,35 @@ private void processAccountNewCommand(DslCommand cmd) {\n         String name = cmd.getArgument(0);\n         builder.name(name);\n \n-        if (cmd.getArity() > 1)\n+        if (cmd.getArity() > 1) {\n             builder.balance(new Coin(new BigInteger(cmd.getArgument(1))));\n+        }\n+\n+        if (cmd.getArity() > 2) {\n+            builder.code(Hex.decode(expandAccounts(cmd.getArgument(2))));\n+        }\n \n         Account account = builder.build();\n \n         world.saveAccount(name, account);\n     }\n \n+    private String expandAccounts(String bytecodes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "846b3100d97f36682f802dee18628cebfb91dc27", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/846b3100d97f36682f802dee18628cebfb91dc27", "committedDate": "2020-08-11T17:06:19Z", "message": "Add creationMethod to action that uses the CREATE opcode"}, "afterCommit": {"oid": "06b3e2efe89c8f806125d2505737651ce44a1496", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/06b3e2efe89c8f806125d2505737651ce44a1496", "committedDate": "2020-08-13T20:06:24Z", "message": "Add creationMethod to action that uses the CREATE opcode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06b3e2efe89c8f806125d2505737651ce44a1496", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/06b3e2efe89c8f806125d2505737651ce44a1496", "committedDate": "2020-08-13T20:06:24Z", "message": "Add creationMethod to action that uses the CREATE opcode"}, "afterCommit": {"oid": "97028d43f300862a55751a3b6aab3b2e29391ff4", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/97028d43f300862a55751a3b6aab3b2e29391ff4", "committedDate": "2020-08-14T17:43:56Z", "message": "Add creationMethod to action that uses the CREATE opcode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNDM4Mzc4", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-470438378", "createdAt": "2020-08-19T13:08:35Z", "commit": {"oid": "97028d43f300862a55751a3b6aab3b2e29391ff4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowODozNVrOHDGj8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowODozNVrOHDGj8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxNTI4MA==", "bodyText": "Here you don't check codeAddress for null when calling codeAddress.getLast20Bytes(). But there are some places where null is being passed for the codeAddress argument, like here, so looks like this param is nullable.\nI understand that it could be the case (btw.. is it ? ) that according to the logic codeAddress should never be null when callType == CallType.DELEGATECALL, but I guess it should be explicitly specified here in the code and properly handled if for some odd reason codeAddress is null when callType == CallType.DELEGATECALL", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r473015280", "createdAt": "2020-08-19T13:08:35Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/trace/TraceTransformer.java", "diffHunk": "@@ -168,7 +176,14 @@ public static TraceAction toAction(TraceType traceType, InvokeData invoke, CallT\n         if (traceType == TraceType.CALL) {\n             input = TypeConverter.toUnformattedJsonHex(invoke.getDataCopy(DataWord.ZERO, invoke.getDataSize()));;\n             value = TypeConverter.toQuantityJsonHex(callValue.getData());\n-            to = new RskAddress(invoke.getOwnerAddress().getLast20Bytes()).toJsonString();\n+\n+            if (callType == CallType.DELEGATECALL) {\n+                to = new RskAddress(codeAddress.getLast20Bytes()).toJsonString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97028d43f300862a55751a3b6aab3b2e29391ff4"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNDk4ODU2", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-470498856", "createdAt": "2020-08-19T14:12:06Z", "commit": {"oid": "2b3e406efe1b483344160b697bd7b8f77b36067b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b3e406efe1b483344160b697bd7b8f77b36067b", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2b3e406efe1b483344160b697bd7b8f77b36067b", "committedDate": "2020-08-19T14:07:36Z", "message": "Checking callAddress is not null in TraceTransformer"}, "afterCommit": {"oid": "3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "committedDate": "2020-08-19T14:54:37Z", "message": "Checking callAddress is not null in TraceTransformer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTA3NDMw", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-472507430", "createdAt": "2020-08-21T13:52:13Z", "commit": {"oid": "3a8871de1eb46cb0fc697ebc116c3617debc2fe6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17da212fe8550809c33f7cf9873162e157fb0a1f", "author": {"user": {"login": "ajlopezrsk", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/17da212fe8550809c33f7cf9873162e157fb0a1f", "committedDate": "2020-08-26T13:41:20Z", "message": "Fix trace delegate call string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69a219de0890fab12d6e5925e6b2969da3b3db4", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b69a219de0890fab12d6e5925e6b2969da3b3db4", "committedDate": "2020-08-26T13:41:21Z", "message": "Add creationMethod in trace action when CREATE2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350a46cda9979fb3e72a23f16bfa1fb630fff67b", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/350a46cda9979fb3e72a23f16bfa1fb630fff67b", "committedDate": "2020-08-26T13:41:21Z", "message": "DSL account_new with code and account address expansion in code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9009e400c7b3aee1b9ec7bc586558355555d498c", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/9009e400c7b3aee1b9ec7bc586558355555d498c", "committedDate": "2020-08-26T13:41:21Z", "message": "Delegate call trace transaction DSL test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c00cbeebfc7dd89e14c391b5929773f38893329", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8c00cbeebfc7dd89e14c391b5929773f38893329", "committedDate": "2020-08-26T13:41:21Z", "message": "CREATE2 code test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee5dd60df461cfc5970e7c099b6c6a47ec629e06", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/ee5dd60df461cfc5970e7c099b6c6a47ec629e06", "committedDate": "2020-08-26T13:41:21Z", "message": "Fix trace transaction delegate call action fields (from, to)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26e5425b0ec730e94f134ec381869f577c0d4b49", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/26e5425b0ec730e94f134ec381869f577c0d4b49", "committedDate": "2020-08-26T13:41:21Z", "message": "Add creationMethod to action that uses the CREATE opcode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70798618540d3ffdd901c9c915015d790c529ca0", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/70798618540d3ffdd901c9c915015d790c529ca0", "committedDate": "2020-08-26T13:41:21Z", "message": "Checking callAddress is not null in TraceTransformer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "committedDate": "2020-08-19T14:54:37Z", "message": "Checking callAddress is not null in TraceTransformer"}, "afterCommit": {"oid": "70798618540d3ffdd901c9c915015d790c529ca0", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/70798618540d3ffdd901c9c915015d790c529ca0", "committedDate": "2020-08-26T13:41:21Z", "message": "Checking callAddress is not null in TraceTransformer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzI5MDY1", "url": "https://github.com/rsksmart/rskj/pull/1284#pullrequestreview-476729065", "createdAt": "2020-08-27T13:38:28Z", "commit": {"oid": "70798618540d3ffdd901c9c915015d790c529ca0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 498, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}