{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NDI4Njcx", "number": 1270, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NzozNVrOEOuDyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODozNFrOEOzo-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODcwMTUzOnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NzozNVrOGyBsvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NzozNVrOGyBsvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwOTgyMg==", "bodyText": "could we log both cases? \"new\" and \"active\"?", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455109822", "createdAt": "2020-07-15T14:47:35Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {\n+            if(newPeers.remove(channel)) {\n+                logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzOTYxNTk1OnYy", "diffSide": "RIGHT", "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODozNFrOGyKqhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMDoyNzo0OVrOGyOpoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjcwOQ==", "bodyText": "Why not add synchronization to add(Channel peer)?", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455256709", "createdAt": "2020-07-15T18:28:34Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyMjAxNg==", "bodyText": "It wouldn't make a difference. The newPeers array itself is thread safe. EthereumChannelInitializer both calls this add method and registers the listener that will call notifyDisconnect, and it does the add first, so there is no possible race condition there.\nSee https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/org/ethereum/net/server/EthereumChannelInitializer.java#L119", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455322016", "createdAt": "2020-07-15T20:27:49Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjcwOQ=="}, "originalCommit": {"oid": "be644bb9d2a883fcf978ef090454b92ab5f798f2"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4438, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}