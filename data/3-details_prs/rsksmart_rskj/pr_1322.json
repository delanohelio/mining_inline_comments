{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTA1MDU3", "number": 1322, "title": "Update peg-in instructions parser according to changes in the protocol", "bodyText": "", "createdAt": "2020-09-30T13:20:56Z", "url": "https://github.com/rsksmart/rskj/pull/1322", "merged": true, "mergeCommit": {"oid": "5d440b7c6f38f00695457b4ca6bdc72b94ee8b4c"}, "closed": true, "closedAt": "2020-10-05T18:52:34Z", "author": {"login": "marcos-iov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOUUxhAH2gAyNDk1NTA1MDU3OjAyMmJkZTBiNmU3NmJiMzdlNTc3ZWM3ZDg4Mzk5NDBkMzRmNjEwY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPoMPGABqjM4NDE4ODc1NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "022bde0b6e76bb37e577ec7d8839940d34f610ce", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/022bde0b6e76bb37e577ec7d8839940d34f610ce", "committedDate": "2020-10-01T16:52:58Z", "message": "Peg-in protocol version uses 1 byte instead of 2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d11270b91e3bbe234557dfe34f89457a04646302", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/d11270b91e3bbe234557dfe34f89457a04646302", "committedDate": "2020-10-01T16:42:36Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}, "afterCommit": {"oid": "e1dd837134ca93853f9012661011517f98a3f9a3", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/e1dd837134ca93853f9012661011517f98a3f9a3", "committedDate": "2020-10-01T16:52:58Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1dd837134ca93853f9012661011517f98a3f9a3", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/e1dd837134ca93853f9012661011517f98a3f9a3", "committedDate": "2020-10-01T16:52:58Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}, "afterCommit": {"oid": "0af8958e8fee039386225b65398753e92c3c6831", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/0af8958e8fee039386225b65398753e92c3c6831", "committedDate": "2020-10-01T17:20:53Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0af8958e8fee039386225b65398753e92c3c6831", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/0af8958e8fee039386225b65398753e92c3c6831", "committedDate": "2020-10-01T17:20:53Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}, "afterCommit": {"oid": "1e72f3d5c3d148beacff01d855e9d9f1b3cdd927", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/1e72f3d5c3d148beacff01d855e9d9f1b3cdd927", "committedDate": "2020-10-01T17:22:20Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjA5MDk2", "url": "https://github.com/rsksmart/rskj/pull/1322#pullrequestreview-500609096", "createdAt": "2020-10-01T18:24:19Z", "commit": {"oid": "1e72f3d5c3d148beacff01d855e9d9f1b3cdd927"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjUxNDkz", "url": "https://github.com/rsksmart/rskj/pull/1322#pullrequestreview-500651493", "createdAt": "2020-10-01T19:24:44Z", "commit": {"oid": "1e72f3d5c3d148beacff01d855e9d9f1b3cdd927"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToyNDo0NVrOHbX93Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToyNDo0NVrOHbX93Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NjI2OQ==", "bodyText": "I guess you could define RSKT_HEX with the result of this Hex.decode instead so you avoid parsing it all the time", "url": "https://github.com/rsksmart/rskj/pull/1322#discussion_r498466269", "createdAt": "2020-10-01T19:24:45Z", "author": {"login": "josedahlquist"}, "path": "rskj-core/src/main/java/co/rsk/peg/pegininstructions/PeginInstructionsProvider.java", "diffHunk": "@@ -53,45 +55,49 @@\n         return Optional.of(peginInstructions);\n     }\n \n-    protected static byte[] extractOpReturnData(BtcTransaction btcTx)\n-        throws PeginInstructionsException {\n-        byte[] data = new byte[]{};\n-        int opReturnOccurrences = 0;\n-\n+    protected static byte[] extractOpReturnData(BtcTransaction btcTx) throws PeginInstructionsException {\n         logger.trace(\"[extractOpReturnData] Getting OP_RETURN data for btc tx: {}\", btcTx.getHash());\n \n-        for (int i=0; i<btcTx.getOutputs().size(); i++) {\n-            List<ScriptChunk> chunksByOutput = btcTx.getOutput(i).getScriptPubKey().getChunks();\n-            if (chunksByOutput.get(0).opcode == ScriptOpCodes.OP_RETURN) {\n-                if (chunksByOutput.size() > 1) {\n-                    data = btcTx.getOutput(i).getScriptPubKey().getChunks().get(1).data;\n-                    opReturnOccurrences++;\n-                } else {\n-                    // OP_RETURN exist but data is empty\n-                    opReturnOccurrences++;\n-                    data = null;\n-                }\n+        byte[] data = new byte[]{};\n+        int opReturnForRskOccurrences = 0;\n+\n+        for (int i = 0; i < btcTx.getOutputs().size(); i++) {\n+            TransactionOutput txOutput = btcTx.getOutput(i);\n+            if(hasOpReturnForRsk(txOutput)) {\n+                data = txOutput.getScriptPubKey().getChunks().get(1).data;\n+                opReturnForRskOccurrences++;\n             }\n         }\n \n-        if (opReturnOccurrences == 0) {\n+        if (opReturnForRskOccurrences == 0) {\n             String message = String.format(\"No OP_RETURN output found for tx %s\", btcTx.getHash());\n             throw new NoOpReturnException(message);\n         }\n \n-        if (opReturnOccurrences > 1) {\n-            String message = String.format(\"Only one output with OP_RETURN is allowed. Found %d\",\n-                opReturnOccurrences);\n+        if (opReturnForRskOccurrences > 1) {\n+            String message = String.format(\"Only one output with OP_RETURN for RSK is allowed. Found %d\",\n+                opReturnForRskOccurrences);\n             logger.debug(\"[extractOpReturnData] {}\", message);\n             throw new PeginInstructionsException(message);\n         }\n \n-        if (data == null) {\n-            String message = \"Empty OP_RETURN data found\";\n-            logger.debug(\"[extractOpReturnData] {}\", message);\n-            throw new PeginInstructionsException(message);\n+        return data;\n+    }\n+\n+    private static boolean hasOpReturnForRsk(TransactionOutput txOutput) {\n+        if(txOutput.getScriptPubKey().isOpReturn()) {\n+            // Check if it has data with `RSKT` prefix\n+            List<ScriptChunk> chunksByOutput = txOutput.getScriptPubKey().getChunks();\n+            if (chunksByOutput.size() > 1 &&\n+                chunksByOutput.get(1).data != null &&\n+                chunksByOutput.get(1).data.length >= 4) {\n+                byte[] prefix = Arrays.copyOfRange(chunksByOutput.get(1).data, 0, 4);\n+                if (Arrays.equals(prefix, Hex.decode(RSKT_HEX))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e72f3d5c3d148beacff01d855e9d9f1b3cdd927"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2794c97aed48cd8f0fa78b70d387664ff6ac40f", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/b2794c97aed48cd8f0fa78b70d387664ff6ac40f", "committedDate": "2020-10-05T18:35:10Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e72f3d5c3d148beacff01d855e9d9f1b3cdd927", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/1e72f3d5c3d148beacff01d855e9d9f1b3cdd927", "committedDate": "2020-10-01T17:22:20Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}, "afterCommit": {"oid": "b2794c97aed48cd8f0fa78b70d387664ff6ac40f", "author": {"user": {"login": "marcos-iov", "name": "Marcos Irisarri"}}, "url": "https://github.com/rsksmart/rskj/commit/b2794c97aed48cd8f0fa78b70d387664ff6ac40f", "committedDate": "2020-10-05T18:35:10Z", "message": "Add prefix verification to peg-in instrcutions parser.\n\nPeg-in instructions parser now verifies that a prefix is included in the payload indicating the OP_RETURN output is for RSK. Updated tests to create transaction objects for each case instead of using raw txs."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 571, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}