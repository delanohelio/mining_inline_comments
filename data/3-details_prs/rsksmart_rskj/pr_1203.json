{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzMyODA2", "number": 1203, "title": "TrieKeyMapper - accountKeys cache not initialized (LGTM alert).", "bodyText": "Cache was only checked but not element added.\nAdded a line where the element is added before returning it.\nAnd added a Unit Test for verifying the functionality.", "createdAt": "2020-04-03T18:53:13Z", "url": "https://github.com/rsksmart/rskj/pull/1203", "merged": true, "mergeCommit": {"oid": "ccfc65297b0aca9302962895213334f4bbc4fee1"}, "closed": true, "closedAt": "2020-04-13T17:23:49Z", "author": {"login": "patogallaiovlabs"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTuZyzgH2gAyMzk4MzMyODA2OjhjZDVmY2JmZjIxNzFkOTAyZTIzNjc1NjlmY2RhZWY4YjQ5YjQ2ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXQ8jtAFqTM5MjIzMzE5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8cd5fcbff2171d902e2367569fcdaef8b49b4681", "author": {"user": {"login": "ajlopez", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/8cd5fcbff2171d902e2367569fcdaef8b49b4681", "committedDate": "2020-04-02T15:54:27Z", "message": "Fix TrieKeyMapper to save key value in cache\n\n(cherry picked from commit 674ed74d4c664a84fde71a65df1dd6f417488a62)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e3260a5005fa106db35e40b6847bb9d827cde4", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b0e3260a5005fa106db35e40b6847bb9d827cde4", "committedDate": "2020-04-03T16:45:18Z", "message": "TrieKeyMapper cache fix, small refactor and unit testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTQxNzg4", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-388541788", "createdAt": "2020-04-06T19:12:46Z", "commit": {"oid": "b0e3260a5005fa106db35e40b6847bb9d827cde4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxMjo0NlrOGBmH5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxNDo1MlrOGBmM1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjM3Mg==", "bodyText": "Could this method be static? Maybe also secureKeyPrefix\nAny explicit visibility to add?\nBut maybe these additions complicate the testing verifying number of invocations", "url": "https://github.com/rsksmart/rskj/pull/1203#discussion_r404326372", "createdAt": "2020-04-06T19:12:46Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/org/ethereum/db/TrieKeyMapper.java", "diffHunk": "@@ -78,4 +79,10 @@\n     public static byte[] storagePrefix() {\n         return Arrays.copyOf(STORAGE_PREFIX, STORAGE_PREFIX.length);\n     }\n+\n+    byte[] mapRskAddressToKey(RskAddress addr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0e3260a5005fa106db35e40b6847bb9d827cde4"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNzYzOQ==", "bodyText": "Could we add an additional test using MANY keys?\nI guess the code could be rewritten to have only a variable with the last key processed, and this test would pass", "url": "https://github.com/rsksmart/rskj/pull/1203#discussion_r404327639", "createdAt": "2020-04-06T19:14:52Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/test/java/org/ethereum/db/TrieKeyMapperTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.db;\n+\n+import co.rsk.core.RskAddress;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.mockito.Mockito.*;\n+\n+public class TrieKeyMapperTest {\n+\n+    private TrieKeyMapper trieKeyMapper;\n+\n+    @Before\n+    public void setup() {\n+        trieKeyMapper = spy(new TrieKeyMapper());\n+    }\n+\n+    @Test\n+    public void getAccountKey_new() {\n+        RskAddress address = new RskAddress(\"1000000000000000000000000000000000000000\");\n+        this.trieKeyMapper.getAccountKey(address);\n+        verify(this.trieKeyMapper, times(1)).mapRskAddressToKey(eq(address));\n+    }\n+\n+    @Test\n+    public void getAccountKey_fromCache() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0e3260a5005fa106db35e40b6847bb9d827cde4"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODQ1Mjky", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-388845292", "createdAt": "2020-04-07T07:19:28Z", "commit": {"oid": "b0e3260a5005fa106db35e40b6847bb9d827cde4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd51995b18f26deb9657e0e7525eade6c263313", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/2cd51995b18f26deb9657e0e7525eade6c263313", "committedDate": "2020-04-07T19:24:57Z", "message": "ajlopez comments on PR: - add explicit visibility to method, - new test case with many keys."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NDMwMzU5", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-389430359", "createdAt": "2020-04-07T19:36:46Z", "commit": {"oid": "2cd51995b18f26deb9657e0e7525eade6c263313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozNjo0NlrOGCTF7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozNjo0NlrOGCTF7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MzE0OQ==", "bodyText": "Could we add a second for, testing again each address? I guess this code could still be satisfied having only one internal variable derived from the last address processed.", "url": "https://github.com/rsksmart/rskj/pull/1203#discussion_r405063149", "createdAt": "2020-04-07T19:36:46Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/test/java/org/ethereum/db/TrieKeyMapperTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.db;\n+\n+import co.rsk.core.RskAddress;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.mockito.Mockito.*;\n+\n+public class TrieKeyMapperTest {\n+\n+    private static final int BATCH_TEST = 500;\n+    private TrieKeyMapper trieKeyMapper;\n+\n+    @Before\n+    public void setup() {\n+        trieKeyMapper = spy(new TrieKeyMapper());\n+    }\n+\n+    @Test\n+    public void getAccountKey_new() {\n+        RskAddress address = new RskAddress(\"1000000000000000000000000000000000000000\");\n+        this.trieKeyMapper.getAccountKey(address);\n+        verify(this.trieKeyMapper, times(1)).mapRskAddressToKey(eq(address));\n+    }\n+\n+    @Test\n+    public void getAccountKey_fromCache() {\n+        RskAddress address = new RskAddress(\"1000000000000000000000000000000000000001\");\n+\n+        byte[] accountKey = this.trieKeyMapper.getAccountKey(address);\n+        verify(this.trieKeyMapper, times(1)).mapRskAddressToKey(eq(address));\n+\n+        byte[] accountKeyCache = this.trieKeyMapper.getAccountKey(address);\n+        verify(this.trieKeyMapper, times(1)).mapRskAddressToKey(eq(address));\n+        Assert.assertArrayEquals(\"Account key diff from diff calls.\", accountKey, accountKeyCache);\n+\n+    }\n+\n+    @Test\n+    public void getAccountKey_fromCache_multipleKeys() {\n+        String addressPrefix = \"1000000000000000000000000000000000000\";\n+\n+        int offset = 100;\n+        for (int i = offset; i < BATCH_TEST + offset; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd51995b18f26deb9657e0e7525eade6c263313"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7de03691f7013f444485f7ca90200cc882293468", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/7de03691f7013f444485f7ca90200cc882293468", "committedDate": "2020-04-07T19:37:02Z", "message": "Merge branch 'master' into bugfix/trieKeyMapper-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad3ddc49803e0abaf05981770f61c855e6c1e27", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0ad3ddc49803e0abaf05981770f61c855e6c1e27", "committedDate": "2020-04-07T19:51:39Z", "message": "As ajlopez suggested, add new case testing multiple keys from cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NDQ0MDU3", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-389444057", "createdAt": "2020-04-07T19:57:01Z", "commit": {"oid": "0ad3ddc49803e0abaf05981770f61c855e6c1e27"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTY4ODMy", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-389968832", "createdAt": "2020-04-08T13:23:18Z", "commit": {"oid": "0ad3ddc49803e0abaf05981770f61c855e6c1e27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoyMzoxOFrOGCvBpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoyMzoxOFrOGCvBpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMDgwNg==", "bodyText": "I would add a comment explaining that this cache is safe because we a RskAddress is immutable and it's a purely functional mapping", "url": "https://github.com/rsksmart/rskj/pull/1203#discussion_r405520806", "createdAt": "2020-04-08T13:23:18Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/org/ethereum/db/TrieKeyMapper.java", "diffHunk": "@@ -45,8 +45,9 @@\n             return Arrays.copyOf(key, key.length);\n         }\n \n-        byte[] secureKey = secureKeyPrefix(addr.getBytes());\n-        byte[] key = ByteUtil.merge(DOMAIN_PREFIX, secureKey, addr.getBytes());\n+        byte[] key = mapRskAddressToKey(addr);\n+\n+        accountKeys.put(addr, key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ad3ddc49803e0abaf05981770f61c855e6c1e27"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15f966e06e8ea71e667f620db65407ff5fcc70f", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/e15f966e06e8ea71e667f620db65407ff5fcc70f", "committedDate": "2020-04-08T15:21:11Z", "message": "@nicops suggested comments on the cache functionality, on the PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjE5OTgx", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-390219981", "createdAt": "2020-04-08T18:20:09Z", "commit": {"oid": "e15f966e06e8ea71e667f620db65407ff5fcc70f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "140ac783ab9fe62a93f1e8658ec87c65f0c3128b", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/140ac783ab9fe62a93f1e8658ec87c65f0c3128b", "committedDate": "2020-04-13T14:04:30Z", "message": "Merge branch 'master' into bugfix/trieKeyMapper-cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjMzMTky", "url": "https://github.com/rsksmart/rskj/pull/1203#pullrequestreview-392233192", "createdAt": "2020-04-13T15:50:58Z", "commit": {"oid": "140ac783ab9fe62a93f1e8658ec87c65f0c3128b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 681, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}