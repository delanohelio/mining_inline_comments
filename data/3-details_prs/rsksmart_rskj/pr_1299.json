{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NTI0NDY2", "number": 1299, "title": "Preserve Txn revert reason", "bodyText": "RSK is not notifying the revert reason when a transaction invoked by RPC is reverted. This PR decodes and adds the revert reason to the exception thrown in such case.", "createdAt": "2020-08-31T20:30:29Z", "url": "https://github.com/rsksmart/rskj/pull/1299", "merged": true, "mergeCommit": {"oid": "34972c0a4c209837e832a8bb36275a4f72552b3e"}, "closed": true, "closedAt": "2020-11-18T19:08:33Z", "author": {"login": "ppedemon"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLAzIVgFqTQ5MjQ2MTI3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddy_nvgFqTUzMzc4NTE0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDYxMjc1", "url": "https://github.com/rsksmart/rskj/pull/1299#pullrequestreview-492461275", "createdAt": "2020-09-21T10:25:14Z", "commit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoyNToxNFrOHVJgzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoyNToxNFrOHVJgzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzNzk5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Optional.of(decoded.get(0).getValue().toString());\n          \n          \n            \n                    return decoded.isEmpty() ? Optional.empty() : Optional.of(decoded.get(0).getValue().toString());", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r491937996", "createdAt": "2020-09-21T10:25:14Z", "author": {"login": "Vovchyk"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {\n+            return Optional.empty();\n+        }\n+\n+        List<TypeReference<Type>> revertReasonTypes =\n+                Collections.singletonList(TypeReference.create((Class<Type>) AbiTypes.getType(\"string\")));\n+        String encodedRevertReason = value.substring(8);\n+        List<Type> decoded = FunctionReturnDecoder.decode(encodedRevertReason, revertReasonTypes);\n+        return Optional.of(decoded.get(0).getValue().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzU2NjYw", "url": "https://github.com/rsksmart/rskj/pull/1299#pullrequestreview-493756660", "createdAt": "2020-09-22T18:55:20Z", "commit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo1NToyMFrOHWIG1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo1ODoxNlrOHWINlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MzU0MQ==", "bodyText": "Magic value? Add comment and Constant.", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492963541", "createdAt": "2020-09-22T18:55:20Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2Mzk0Ng==", "bodyText": "Extract these lines to a method and add docs (at least some doc).", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492963946", "createdAt": "2020-09-22T18:56:03Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -227,6 +240,25 @@ private ProgramResult callConstant(Web3.CallArguments args, Block executionBlock\n         );\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Optional<String> decodeRevertReason(ProgramResult res) {\n+        byte[] bytes = res.getHReturn();\n+        if (bytes == null || bytes.length == 0) {\n+            return Optional.empty();\n+        }\n+\n+        String value = Hex.toHexString(res.getHReturn());\n+        if (!value.startsWith(\"08c379a0\")) {\n+            return Optional.empty();\n+        }\n+\n+        List<TypeReference<Type>> revertReasonTypes =\n+                Collections.singletonList(TypeReference.create((Class<Type>) AbiTypes.getType(\"string\")));\n+        String encodedRevertReason = value.substring(8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2NTI2OQ==", "bodyText": "What does this value means? Add some comments. We could check other possible values (?)", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r492965269", "createdAt": "2020-09-22T18:58:16Z", "author": {"login": "patogallaiovlabs"}, "path": "rskj-core/src/test/java/co/rsk/rpc/modules/eth/EthModuleTest.java", "diffHunk": "@@ -78,6 +80,50 @@ public void callSmokeTest() {\n         assertThat(result, is(TypeConverter.toJsonHex(hreturn)));\n     }\n \n+    @Test\n+    public void test_revertedTransaction() {\n+        Web3.CallArguments args = new Web3.CallArguments();\n+        BlockResult blockResult = mock(BlockResult.class);\n+        Block block = mock(Block.class);\n+        ExecutionBlockRetriever retriever = mock(ExecutionBlockRetriever.class);\n+        when(retriever.getExecutionBlock_workaround(\"latest\"))\n+                .thenReturn(blockResult);\n+        when(blockResult.getBlock()).thenReturn(block);\n+\n+        byte[] hreturn = Hex.decode(\n+                \"08c379a000000000000000000000000000000000000000000000000000000000\" +\n+                        \"0000002000000000000000000000000000000000000000000000000000000000\" +\n+                        \"0000000f6465706f73697420746f6f2062696700000000000000000000000000\" +\n+                        \"00000000\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e224f3f501fa7796132a389aa240338a2b0f81a"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8970a39eae11e9bc82fdf7c6f47bf57ad263ad3", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/f8970a39eae11e9bc82fdf7c6f47bf57ad263ad3", "committedDate": "2020-10-07T12:51:07Z", "message": "dependency fix"}, "afterCommit": {"oid": "1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "committedDate": "2020-10-07T13:06:39Z", "message": "dependency fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/1be59a97b6bd2b76af52661e0a2e188fec26f4c0", "committedDate": "2020-10-07T13:06:39Z", "message": "dependency fix"}, "afterCommit": {"oid": "5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "committedDate": "2020-10-07T13:08:06Z", "message": "dependency fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/5289207e2ad9d60c9b9fc608f47a006cb30cfcad", "committedDate": "2020-10-07T13:08:06Z", "message": "dependency fix"}, "afterCommit": {"oid": "64e1037fa0a561288d3941d73ad25fdf81bd4462", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/64e1037fa0a561288d3941d73ad25fdf81bd4462", "committedDate": "2020-10-26T14:02:49Z", "message": "Remove Web3j dependency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTIyMzgz", "url": "https://github.com/rsksmart/rskj/pull/1299#pullrequestreview-518922383", "createdAt": "2020-10-28T17:35:04Z", "commit": {"oid": "64e1037fa0a561288d3941d73ad25fdf81bd4462"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNzozNTowNVrOHp13kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNzozNTowNVrOHp13kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNjI0MQ==", "bodyText": "Any real transaction executed in a code test (maybe using DSL), to test this signature?", "url": "https://github.com/rsksmart/rskj/pull/1299#discussion_r513636241", "createdAt": "2020-10-28T17:35:05Z", "author": {"login": "ajlopezrsk"}, "path": "rskj-core/src/main/java/co/rsk/rpc/modules/eth/EthModule.java", "diffHunk": "@@ -58,6 +58,9 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(\"web3\");\n \n+    private static final CallTransaction.Function ERROR_ABI_FUNCTION = CallTransaction.Function.fromSignature(\"Error\", \"string\");\n+    private static final byte[] ERROR_ABI_FUNCTION_SIGNATURE = ERROR_ABI_FUNCTION.encodeSignature(); //08c379a0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64e1037fa0a561288d3941d73ad25fdf81bd4462"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDY1MDg2", "url": "https://github.com/rsksmart/rskj/pull/1299#pullrequestreview-519065086", "createdAt": "2020-10-28T20:40:08Z", "commit": {"oid": "0830ba5c7e932b226b0a5c6a78368829ce2bea24"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32df3b06dc88fb0aea5999cb718e49aa1bc10856", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/32df3b06dc88fb0aea5999cb718e49aa1bc10856", "committedDate": "2020-11-18T17:32:38Z", "message": "Preserve txn revert reason"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e319a3be9698787a162e6346f54798b38c207b4c", "author": {"user": null}, "url": "https://github.com/rsksmart/rskj/commit/e319a3be9698787a162e6346f54798b38c207b4c", "committedDate": "2020-11-18T17:32:38Z", "message": "Add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe8c53cbb45fede321b6b412f0863e286a78845c", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/fe8c53cbb45fede321b6b412f0863e286a78845c", "committedDate": "2020-11-18T17:33:23Z", "message": "Remove Web3j dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d61afe38b088eff0026e393ec4c8ec8371f82387", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/d61afe38b088eff0026e393ec4c8ec8371f82387", "committedDate": "2020-11-18T17:33:23Z", "message": "Add DSL test, simulating a revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "437b644382bd8f0c43a0ddf026c43f0b1e0e0a64", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/437b644382bd8f0c43a0ddf026c43f0b1e0e0a64", "committedDate": "2020-11-18T17:33:23Z", "message": "remove call to gc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "151aa541b76fa10600cc21237e3d9bdb418e150e", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/151aa541b76fa10600cc21237e3d9bdb418e150e", "committedDate": "2020-11-18T17:33:23Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38c9ca1a006ecbd897a50fe4c116249a406a12aa", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/38c9ca1a006ecbd897a50fe4c116249a406a12aa", "committedDate": "2020-10-28T20:59:02Z", "message": "fix test"}, "afterCommit": {"oid": "151aa541b76fa10600cc21237e3d9bdb418e150e", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/151aa541b76fa10600cc21237e3d9bdb418e150e", "committedDate": "2020-11-18T17:33:23Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzg1MTQy", "url": "https://github.com/rsksmart/rskj/pull/1299#pullrequestreview-533785142", "createdAt": "2020-11-18T19:05:47Z", "commit": {"oid": "151aa541b76fa10600cc21237e3d9bdb418e150e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 526, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}