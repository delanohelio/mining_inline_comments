{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2Mjc0ODE3", "number": 1235, "title": "Refactor of ECKey signature related methods: signatureToKey / recover\u2026", "bodyText": "The idea is to refactor ECKey class in order to prepare functionality for Native Signature implementation with a C Native library.\u2028What i did is a Singleton service class, that defines an interface of methods that should be implemented in Bouncy Castle / Native implementations.\u2028The refactor includes only the methods (and where its used):\n\nsignatureToKey()\n\n\nPeerDiscoveryMessage.getKey()\nTransaction.getSender()\nPrecompiledContract.ERecover.execute()\n\n\nrecoverFromSignature()\n\n\nProofOfWorkRule.validFallbackBlockSignature()\nTransaction.getKey()\nECKey.sign() \u2192 (for making it recoverable)\nEncryptionHandshake.makeAuthInitiate()\n\n\n-verify()\n\n\nBootstrapDataVerifier.verifyEntries()", "createdAt": "2020-05-11T18:39:30Z", "url": "https://github.com/rsksmart/rskj/pull/1235", "merged": true, "mergeCommit": {"oid": "9feb5a08b0c4d1996760b43f69d293367388073f"}, "closed": true, "closedAt": "2020-05-27T14:28:12Z", "author": {"login": "patogallaiovlabs"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg6NZRgBqjMzMzI1MTY2MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclZEV7gFqTQxOTE5MTc4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13c21e48037c0e53afedf3e23806ec3045dda931", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/13c21e48037c0e53afedf3e23806ec3045dda931", "committedDate": "2020-05-11T20:17:52Z", "message": "Merge branch 'signature_refactor_1' of github.com:rsksmart/rskj into signature_refactor_1"}, "afterCommit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/889b5487a52f798220a2ba1e9151e038b9a0b1df", "committedDate": "2020-05-13T14:56:28Z", "message": "Refactor of ECKey signature related methods: signatureToKey / recoverFromSignature / verify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjE5NDk4", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-411219498", "createdAt": "2020-05-13T19:08:06Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNTg3NDg3", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-411587487", "createdAt": "2020-05-14T08:41:43Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODUwODkx", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-412850891", "createdAt": "2020-05-15T17:50:59Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODk0ODQ2", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-412894846", "createdAt": "2020-05-15T18:58:27Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NDc2NDMx", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-415476431", "createdAt": "2020-05-20T15:49:40Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0OTo0MFrOGYSZsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0OTo0MFrOGYSZsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEyMDQ5OQ==", "bodyText": "I would move this somewhere else because CLI tools don't build the node runner and thus they never execute this line. We would want ideally to have this run in those tools as well.", "url": "https://github.com/rsksmart/rskj/pull/1235#discussion_r428120499", "createdAt": "2020-05-20T15:49:40Z", "author": {"login": "nicops"}, "path": "rskj-core/src/main/java/co/rsk/RskContext.java", "diffHunk": "@@ -848,6 +849,7 @@ protected NodeRunner buildNodeRunner() {\n                     getRepositoryLocator()\n             ));\n         }\n+        Secp256k1.initialize(getRskSystemProperties());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NDc3MjA4", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-415477208", "createdAt": "2020-05-20T15:50:31Z", "commit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo1MDozMVrOGYScBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo1MDozMVrOGYScBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEyMTA5NA==", "bodyText": "remove these two methods and point to the actual methods in ECDSASignature", "url": "https://github.com/rsksmart/rskj/pull/1235#discussion_r428121094", "createdAt": "2020-05-20T15:50:31Z", "author": {"login": "nicops"}, "path": "rskj-core/src/test/java/org/ethereum/crypto/signature/ECDSASignatureTest.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * This file is part of RskJ\n+ * Copyright (C) 2017 RSK Labs Ltd.\n+ * (derived from ethereumJ library, Copyright (c) 2016 <ether.camp>)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Lesser General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.ethereum.crypto.signature;\n+\n+import org.ethereum.crypto.ECKey;\n+import org.ethereum.crypto.HashUtil;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.math.BigInteger;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ECDSASignatureTest {\n+\n+    private final String exampleMessage = \"This is an example of a signed message.\";\n+    private static final BigInteger SECP256K1N = new BigInteger(\"fffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141\", 16);\n+\n+    @Test\n+    public void testValidateComponents() {\n+\n+        // Valid components.\n+        // valid v\n+        assertTrue(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 27).validateComponents());\n+        assertTrue(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 28).validateComponents());\n+        //valid r\n+        assertTrue(new ECDSASignature(SECP256K1N.subtract(BigInteger.ONE), BigInteger.ONE, (byte) 28).validateComponents());\n+        //valid s\n+        assertTrue(new ECDSASignature(BigInteger.ONE, SECP256K1N.subtract(BigInteger.ONE), (byte) 28).validateComponents());\n+\n+        // Not Valid components.\n+        //invalid \"r\"\n+        assertFalse(new ECDSASignature(BigInteger.ZERO, BigInteger.ONE, (byte) 27).validateComponents());\n+        assertFalse(new ECDSASignature(SECP256K1N, BigInteger.ONE, (byte) 27).validateComponents());\n+\n+        //invalid \"s\"\n+        assertFalse(new ECDSASignature(BigInteger.ONE, BigInteger.ZERO, (byte) 27).validateComponents());\n+        assertFalse(new ECDSASignature(BigInteger.ONE, SECP256K1N, (byte) 27).validateComponents());\n+\n+        //invalid \"v\"\n+        assertFalse(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 29).validateComponents());\n+        assertFalse(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 26).validateComponents());\n+    }\n+\n+    @Test\n+    public void testEquals() {\n+        ECDSASignature expected = new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 27);\n+\n+        //same instance\n+        assertTrue(expected.equals(expected));\n+\n+        //same values\n+        assertTrue(expected.equals(new ECDSASignature(expected.getR(), expected.getS(), expected.getV())));\n+\n+        //same values - but diff v\n+        assertTrue(expected.equals(new ECDSASignature(expected.getR(), expected.getS(), (byte) 0)));\n+\n+        // null\n+        assertFalse(expected.equals(null));\n+\n+        //dif classes\n+        assertFalse(expected.equals(BigInteger.ZERO));\n+\n+        //diff r\n+        assertFalse(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 27).equals(new ECDSASignature(BigInteger.TEN, BigInteger.ONE, (byte) 27)));\n+\n+        //diff s\n+        assertFalse(new ECDSASignature(BigInteger.ONE, BigInteger.ONE, (byte) 27).equals(new ECDSASignature(BigInteger.ONE, BigInteger.TEN, (byte) 27)));\n+\n+    }\n+\n+    @Test\n+    public void testValidateComponents_SignedMsg() {\n+        ECKey key = new ECKey();\n+        byte[] hash = HashUtil.keccak256(exampleMessage.getBytes());\n+        ECDSASignature signature = ECDSASignature.fromSignature(key.sign(hash));\n+        assertTrue(signature.validateComponents());\n+    }\n+\n+    @Test\n+    public void fromComponentsWithRecoveryCalculation() {\n+        ECKey key = new ECKey();\n+        byte[] hash = HashUtil.randomHash();\n+        ECDSASignature signature = ECDSASignature.fromSignature(key.sign(hash));\n+\n+        // With uncompressed public key\n+        ECDSASignature signatureWithCalculatedV = fromComponentsWithRecoveryCalculation(\n+                signature.getR().toByteArray(),\n+                signature.getS().toByteArray(),\n+                hash,\n+                key.getPubKey(false)\n+        );\n+\n+        Assert.assertEquals(signature.getR(), signatureWithCalculatedV.getR());\n+        Assert.assertEquals(signature.getS(), signatureWithCalculatedV.getS());\n+        Assert.assertEquals(signature.getV(), signatureWithCalculatedV.getV());\n+\n+        // With compressed public key\n+        signatureWithCalculatedV = fromComponentsWithRecoveryCalculation(\n+                signature.getR().toByteArray(),\n+                signature.getS().toByteArray(),\n+                hash,\n+                key.getPubKey(true)\n+        );\n+\n+        Assert.assertEquals(signature.getR(), signatureWithCalculatedV.getR());\n+        Assert.assertEquals(signature.getS(), signatureWithCalculatedV.getS());\n+        Assert.assertEquals(signature.getV(), signatureWithCalculatedV.getV());\n+    }\n+\n+\n+    /**\n+     * @param r    -\n+     * @param s    -\n+     * @param hash - the hash used to compute this signature\n+     * @param pub  - public key bytes, used to calculate the recovery byte 'v'\n+     * @return -\n+     */\n+    public static ECDSASignature fromComponentsWithRecoveryCalculation(byte[] r, byte[] s, byte[] hash, byte[] pub) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68b16d2feed66a06b36d8d9dd0f6b3d26afa4b80", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/68b16d2feed66a06b36d8d9dd0f6b3d26afa4b80", "committedDate": "2020-05-21T22:09:06Z", "message": "Refactor of ECKey signature related methods: signatureToKey / recoverFromSignature / verify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b87a273748a17e5db747378eb88b315a15f723aa", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b87a273748a17e5db747378eb88b315a15f723aa", "committedDate": "2020-05-21T22:09:06Z", "message": "removing duplicate code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "889b5487a52f798220a2ba1e9151e038b9a0b1df", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/889b5487a52f798220a2ba1e9151e038b9a0b1df", "committedDate": "2020-05-13T14:56:28Z", "message": "Refactor of ECKey signature related methods: signatureToKey / recoverFromSignature / verify"}, "afterCommit": {"oid": "b87a273748a17e5db747378eb88b315a15f723aa", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/b87a273748a17e5db747378eb88b315a15f723aa", "committedDate": "2020-05-21T22:09:06Z", "message": "removing duplicate code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9978ca65c992cfc62224b799f6d792575ac898", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/5d9978ca65c992cfc62224b799f6d792575ac898", "committedDate": "2020-05-21T22:27:04Z", "message": "fix smells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fbf1690bfd4d9e0caaa06d1dc82750e251f2993", "author": {"user": {"login": "patogallaiovlabs", "name": null}}, "url": "https://github.com/rsksmart/rskj/commit/0fbf1690bfd4d9e0caaa06d1dc82750e251f2993", "committedDate": "2020-05-26T19:18:14Z", "message": "Nico comment, on initialization of Singleton. Minor rename refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjgxMzgx", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-418681381", "createdAt": "2020-05-26T21:09:56Z", "commit": {"oid": "0fbf1690bfd4d9e0caaa06d1dc82750e251f2993"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njk1NzMy", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-418695732", "createdAt": "2020-05-26T21:34:19Z", "commit": {"oid": "0fbf1690bfd4d9e0caaa06d1dc82750e251f2993"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTkxNzg4", "url": "https://github.com/rsksmart/rskj/pull/1235#pullrequestreview-419191788", "createdAt": "2020-05-27T13:13:39Z", "commit": {"oid": "0fbf1690bfd4d9e0caaa06d1dc82750e251f2993"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 722, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}