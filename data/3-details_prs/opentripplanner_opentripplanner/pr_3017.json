{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTkzNDMw", "number": 3017, "title": "router-config file is ignored by server, it uses router-config found in loaded graph", "bodyText": "Expected behavior\nWhen starting server, if router-config file is present, any router-config embedded in the loaded graph is ignored and the config is read from the file.\nObserved behavior\nEven when router-config file is present, router-config embedded in the loaded graph is used.\nBehavior after applying this PR:\n\nThe rout-config.json overrides any config loaded from the serialized graph.\nThe routing-config and build-config was part of the graph to be able to serialize it, this made it tempting to access the contents of the configuration via the reference in a Graph field, instead of accessing it via the application context/configuration. This is fixed by removing the config field from the graph and instead serializing it as part of the wrapping SerializedGraphObject instead (which disappears upon deserialization). All config users are now updated to use the config from the application context instead.\nAll serialization logic is removed from the graph. This is now the responsibility of the GraphRepository and the SerializedGraphObject.\nThe EmbedConfig graph-builder is deleted, and replaced by a more direct(simpler) way to save the build-/routing- config in the serialized graph.\nThe saving of the Norwegian(Entur) graph takes 30 seconds, so I have added a progress tracker for the graph saving process.\n\nTo be completed by pull request submitter:\n\n issue: There is no issue for this.\n roadmap: No, this is a bugfix.\n tests: Relevant unit-tests are updated\n formatting: Yes\n documentation: No.\n changelog: No. This bug was introduced during the OTP2 development.\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-03-24T18:44:13Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017", "merged": true, "mergeCommit": {"oid": "20aee7f53a939719f2700f31c11bd3e67d2cd22a"}, "closed": true, "closedAt": "2020-03-31T09:37:44Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ3V2fgH2gAyMzkzMTkzNDMwOmJkYmU2NGU5YTgzNTgwMjRkY2MwN2M0YzRjMDY2OWZjYzBmODg3ZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS_zxMgFqTM4NDU2MzE4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff", "committedDate": "2020-03-24T18:37:31Z", "message": "Bugfix - The router-config in the serialized graph should not override the config loaded from the filesystem. This commit fixes this.\n  - The `rout-config.json` override any config loaded from the serialized graph.\n  - The routing-config and build-config was part of the graph to be able to serialize it, this made it tempting\n    to also get it from the graph instead of the application context/configuration. This is fixed by removing the\n    config from the graph and serialize it as part of the temporary `SerializedGraphObject` instead. All config\n    users are now updated to use the config from the application context instead.\n  - All serialization logic is removed from the graph. This is now the responsibility of the `GraphRepository`\n    and the `SerializedGraphObject`.\n  - The `EmbedConfig` graph-builder is deleted, and replaced by a more direct(simpler) way to save the\n    build-/routing- config in the serialized graph.\n  - The saving of the Norwegian(Entur) graph takes 30 seconds, so I have added a progress tracker for the graph\n    saving process."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNjU1NTk2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#pullrequestreview-382655596", "createdAt": "2020-03-27T08:24:16Z", "commit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwODoyNDoxNlrOF8nKYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwODoyNTo0OFrOF8nNTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMDUxMg==", "bodyText": "We should find a more descriptive name and add Javadoc", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#discussion_r399100512", "createdAt": "2020-03-27T08:24:16Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/routing/graph/GraphRepository.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.opentripplanner.routing.graph;\n+\n+import org.opentripplanner.datastore.DataSource;\n+import org.opentripplanner.standalone.config.BuildConfig;\n+import org.opentripplanner.standalone.config.RouterConfig;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GraphRepository {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMDg5MQ==", "bodyText": "We should discuss whether we want to allow embedding configuration at all.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#discussion_r399100891", "createdAt": "2020-03-27T08:25:03Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/routing/graph/SerializedGraphObject.java", "diffHunk": "@@ -50,9 +56,60 @@\n \n     private final Collection<Edge> edges;\n \n-    public SerializedGraphObject(Graph graph) {\n+    /** The config JSON used to build this graph. Allows checking whether the configuration has changed. */\n+    public final BuildConfig buildConfig;\n+\n+    /** Embed a router configuration inside the graph, for starting up with a single file. */\n+    public final RouterConfig routerConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMTI2Mw==", "bodyText": "Class name is not needed when calling method on same class.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#discussion_r399101263", "createdAt": "2020-03-27T08:25:48Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/routing/graph/SerializedGraphObject.java", "diffHunk": "@@ -50,9 +56,60 @@\n \n     private final Collection<Edge> edges;\n \n-    public SerializedGraphObject(Graph graph) {\n+    /** The config JSON used to build this graph. Allows checking whether the configuration has changed. */\n+    public final BuildConfig buildConfig;\n+\n+    /** Embed a router configuration inside the graph, for starting up with a single file. */\n+    public final RouterConfig routerConfig;\n+\n+    public SerializedGraphObject(Graph graph, BuildConfig buildConfig, RouterConfig routerConfig) {\n         this.graph = graph;\n         this.edges = graph.getEdges();\n+        this.buildConfig = buildConfig;\n+        this.routerConfig = routerConfig;\n+    }\n+\n+    public static void save(Graph graph, BuildConfig buildConfig, RouterConfig routerConfig, DataSource graphSource) {\n+        new SerializedGraphObject(graph,buildConfig, routerConfig).save(graphSource);\n+    }\n+\n+    public static SerializedGraphObject load(DataSource source) {\n+        return load(source.asInputStream(), source.path());\n+    }\n+\n+    public static Graph load(File file) {\n+        try {\n+            SerializedGraphObject serObj = SerializedGraphObject.load(\n+                    new FileInputStream(file),\n+                    file.getAbsolutePath()\n+            );\n+            return serObj == null ? null : serObj.graph;\n+        } catch (FileNotFoundException e) {\n+            LOG.error(\"Graph file not found: \" + file, e);\n+            throw new OtpAppException(e.getMessage());\n+        }\n+    }\n+\n+    public static SerializedGraphObject load(InputStream inputStream, String sourceDescription) {\n+        // TODO store version information, halt load if versions mismatch\n+        try(inputStream) {\n+            LOG.info(\"Reading graph from '{}'\", sourceDescription);\n+            Input input = new Input(inputStream);\n+            Kryo kryo = SerializedGraphObject.makeKryo();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzA0ODI1", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#pullrequestreview-382704825", "createdAt": "2020-03-27T09:39:53Z", "commit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTozOTo1NFrOF8ppZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTozOTo1NFrOF8ppZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTIyMg==", "bodyText": "We discussed this - repository does seem to be the right abstraction but some readers might not make the connection. So Javadoc will give a very short statement of what it does, and maybe a link to an explanation. As a repository it should also contain the logic for loading (not just saving) Graphs from DataSources.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#discussion_r399141222", "createdAt": "2020-03-27T09:39:54Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/routing/graph/GraphRepository.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.opentripplanner.routing.graph;\n+\n+import org.opentripplanner.datastore.DataSource;\n+import org.opentripplanner.standalone.config.BuildConfig;\n+import org.opentripplanner.standalone.config.RouterConfig;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GraphRepository {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMDUxMg=="}, "originalCommit": {"oid": "bdbe64e9a8358024dcc07c4c4c0669fcc0f887ff"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12285b53e4281e518ef5d975d23b2dfa9c262ca5", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/12285b53e4281e518ef5d975d23b2dfa9c262ca5", "committedDate": "2020-03-27T12:46:10Z", "message": "Code review - The GraphRepository is merged into the SerializedGraphObject, and some minor refactorings and code cleanup i done."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d6a83db57588276eaf0eaa06dd0cd0a0a7a1d4", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/66d6a83db57588276eaf0eaa06dd0cd0a0a7a1d4", "committedDate": "2020-03-27T13:35:36Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_bugfix_routing_config_overloaded"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "681370ea5ce762e1cb9d4d45a39dfeb0efcea32a", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/681370ea5ce762e1cb9d4d45a39dfeb0efcea32a", "committedDate": "2020-03-27T12:48:09Z", "message": "Merge branch 'otp2_bugfix_routing_config_overloaded' of https://github.com/entur/OpenTripPlanner into otp2_bugfix_routing_config_overloaded"}, "afterCommit": {"oid": "66d6a83db57588276eaf0eaa06dd0cd0a0a7a1d4", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/66d6a83db57588276eaf0eaa06dd0cd0a0a7a1d4", "committedDate": "2020-03-27T13:35:36Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_bugfix_routing_config_overloaded"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTYzMTg4", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3017#pullrequestreview-384563188", "createdAt": "2020-03-31T09:37:17Z", "commit": {"oid": "66d6a83db57588276eaf0eaa06dd0cd0a0a7a1d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2090, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}