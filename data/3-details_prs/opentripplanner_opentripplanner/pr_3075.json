{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NTI1MjE0", "number": 3075, "title": "Optimize multi-criteria Range Raptor to skip none optimal pattern boardings", "bodyText": "To be completed by pull request submitter:\n\n issue: closes #3064\n roadmap: Raptor\n tests: A test added and a few unit tests updated. The PR is tested with the SpeedTest.\n formatting: Yes.\n documentation: No doc i added.\n changelog: Part of Raptor.\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-05-12T06:54:36Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075", "merged": true, "mergeCommit": {"oid": "17f456e80e848c884eba515ea7bcb33bf8047689"}, "closed": true, "closedAt": "2020-06-02T09:09:15Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgeasXAH2gAyNDE2NTI1MjE0OmY4NmVmNGFiMzY5MjAxYjYxYjZjNjU3MDY3NDMwYzM2MzgzOTNlOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnQ_ntAFqTQyMjQ3Njk0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f86ef4ab369201b61b6c657067430c3638393e9b", "committedDate": "2020-05-12T06:37:58Z", "message": "Optimize the Multi-criteria Range Raptor pattern traversal using a pareto-set for all boardings when traversing the pattern. This allow us to trow away some of the boardings, so we do not have to test each of the remaining stops in the pattern for optimal stop arrivals. The effect will vary depending on the transit data, but when measured on the Norwegian graph from November 2019 with the PARETO_CHECK_AGAINST_DESTINATION enabled the improvement was roughly 20%."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fda36a8c495be861c5ed7e1ae31edf2f0b7469a4", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fda36a8c495be861c5ed7e1ae31edf2f0b7469a4", "committedDate": "2020-05-12T06:37:58Z", "message": "Clean code - In RaptorTripSchedule/Pattern move 'debugInfo' from trip to pattern and include 'mode' in debugInfo, delete modeInfo(). This make the debug logging and SpeedTest report in a more consistent way, and clean up the code a bit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94a2b55ee5db4f832979ee2328c07b2d042cbba1", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/94a2b55ee5db4f832979ee2328c07b2d042cbba1", "committedDate": "2020-05-12T06:37:58Z", "message": "Clean code - Apply time-shift of access-legs to the ArrivalView, this way the time-shift can be done in a limited places (once for McRR and once for StdRR).\n - Move leg specific data in ArrivalView to separate leg types. Reduce clutter and make the model closer to real life domain; Hence easier to understand.\n - Small clean-up inserting a space in the ToStringBuilder to improve readability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e652f9fb7fed014839697baff028cf9432b2e755", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e652f9fb7fed014839697baff028cf9432b2e755", "committedDate": "2020-05-12T06:50:08Z", "message": "Clean code - Remove the departure-time from stop arrivals. The field is not used by the algorithm and causes a source of error en confusion, since it is tempting to use in calculating other fields.\n - Fix SpeedTest Table report after refactor, reuse TableFormatter(renamed from OutputTable)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03772fcd600fa467ff56a1b04aa89010182e1292", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/03772fcd600fa467ff56a1b04aa89010182e1292", "committedDate": "2020-05-18T16:07:09Z", "message": "Make the McRR handle diffrent cost increments for different trips (same pattern) and add documentation on the implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b32b7d45ec1d595198e7c71ddfbd97a37d93928", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3b32b7d45ec1d595198e7c71ddfbd97a37d93928", "committedDate": "2020-05-18T16:07:28Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_optimize_mc_raptor_patterns"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b28276876838929ae310d7c05424a98d88aa3325", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b28276876838929ae310d7c05424a98d88aa3325", "committedDate": "2020-05-18T16:01:55Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_optimize_mc_raptor_patterns"}, "afterCommit": {"oid": "3b32b7d45ec1d595198e7c71ddfbd97a37d93928", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3b32b7d45ec1d595198e7c71ddfbd97a37d93928", "committedDate": "2020-05-18T16:07:28Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_optimize_mc_raptor_patterns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MjUyMTYw", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-414252160", "createdAt": "2020-05-19T09:10:48Z", "commit": {"oid": "03772fcd600fa467ff56a1b04aa89010182e1292"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToxMDo0OVrOGXXK8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToxMDo0OVrOGXXK8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MDA2NQ==", "bodyText": "stop-arrival (labels)", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#discussion_r427150065", "createdAt": "2020-05-19T09:10:49Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/transit/raptor/rangeraptor/multicriteria/Boarding.java", "diffHunk": "@@ -10,6 +10,34 @@\n  * while possessing the stops in the pattern. This class keep the needed state for these\n  * boardings to avoid recalculating each value more than once and to be able put then in a\n  * {@link org.opentripplanner.transit.raptor.util.paretoset.ParetoSet}.\n+ * <p>\n+ * A boarding represent one path from the {@code origin} to a trip is boarded(onboard of a vehicle).\n+ * It represent the STATE of riding a trip, having boarded at a given stop, but not yet alighted.\n+ * <p>\n+ * We do not do this the same way as described in the original Raptor paper. The original McRaptor\n+ * algorithm keep a bag of stop-arrivals while traversing the pattern. We keep a \"bag\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03772fcd600fa467ff56a1b04aa89010182e1292"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Mjg5NTkz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-414289593", "createdAt": "2020-05-19T09:58:59Z", "commit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOTo1ODo1OVrOGXY_Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOTo1ODo1OVrOGXY_Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE3OTc5MQ==", "bodyText": "Just a pure refactoring - inlined method.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#discussion_r427179791", "createdAt": "2020-05-19T09:58:59Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/transit/raptor/rangeraptor/RangeRaptorWorker.java", "diffHunk": "@@ -202,24 +202,15 @@ private void findAllTransitForRound() {\n             // Prepare for transit\n             transitWorker.prepareForTransitWith(pattern, tripSearch);\n \n-            // perform transit\n-            performTransitForRoundAndEachStopInPattern(pattern);\n+            // perform transit - iterate over given pattern and calculate transit for each stop.\n+            IntIterator it = calculator.patternStopIterator(pattern.numberOfStopsInPattern());\n+            while (it.hasNext()) {\n+                transitWorker.routeTransitAtStop(it.next());\n+            }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Mjk0NTMz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-414294533", "createdAt": "2020-05-19T10:05:26Z", "commit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDowNToyNlrOGXZODg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDowNToyNlrOGXZODg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE4MzYzMA==", "bodyText": "OnBoard Riding Vehicle State RouteBag Label", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#discussion_r427183630", "createdAt": "2020-05-19T10:05:26Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/transit/raptor/rangeraptor/multicriteria/Boarding.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package org.opentripplanner.transit.raptor.rangeraptor.multicriteria;\n+\n+import org.opentripplanner.transit.raptor.api.transit.RaptorTripSchedule;\n+import org.opentripplanner.transit.raptor.rangeraptor.multicriteria.arrivals.AbstractStopArrival;\n+import org.opentripplanner.transit.raptor.util.paretoset.ParetoComparator;\n+\n+\n+/**\n+ * The multi-criteria Range Raptor need to keep all pareto-optimal boardings for each pattern\n+ * while possessing the stops in the pattern. This class keep the needed state for these\n+ * boardings to avoid recalculating each value more than once and to be able put then in a\n+ * {@link org.opentripplanner.transit.raptor.util.paretoset.ParetoSet}.\n+ *\n+ * @param <T> The TripSchedule type defined by the user of the raptor API.\n+ */\n+final class Boarding<T extends RaptorTripSchedule> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Mjk4MjYx", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-414298261", "createdAt": "2020-05-19T10:10:01Z", "commit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDoxMDowMlrOGXZZog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMDoxMDowMlrOGXZZog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE4NjU5NA==", "bodyText": "riding cost", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#discussion_r427186594", "createdAt": "2020-05-19T10:10:02Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/transit/raptor/rangeraptor/transit/DefaultCostCalculator.java", "diffHunk": "@@ -40,6 +40,24 @@ public DefaultCostCalculator(\n         lifeCycle.onPrepareForNextRound(this::initWaitFactor);\n     }\n \n+    @Override\n+    public int relativePatternBoardCost(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f86ef4ab369201b61b6c657067430c3638393e9b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31d7dd0750e88b1beaecd80806c1133623f7ee1", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c31d7dd0750e88b1beaecd80806c1133623f7ee1", "committedDate": "2020-05-27T13:08:28Z", "message": "Improve the documentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f104fcd8354f7bc9f0bf2b502d9be97415a1ee0e", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f104fcd8354f7bc9f0bf2b502d9be97415a1ee0e", "committedDate": "2020-05-27T13:09:04Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_optimize_mc_raptor_patterns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b3af7bddc42089b5eb456e9fcfcfea9e0e8d60", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/35b3af7bddc42089b5eb456e9fcfcfea9e0e8d60", "committedDate": "2020-05-27T13:26:37Z", "message": "Rename the `onTripRelativeCost` method to `onTripRidingCost`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a56ae2ae4331211997c32255842c0125f4929bdc", "author": {"user": {"login": "abyrd", "name": "Andrew Byrd"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a56ae2ae4331211997c32255842c0125f4929bdc", "committedDate": "2020-05-28T07:45:33Z", "message": "docs: adjusting wording and details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTQwOTg0", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-420140984", "createdAt": "2020-05-28T14:04:32Z", "commit": {"oid": "a56ae2ae4331211997c32255842c0125f4929bdc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07115caf343979dc30ec48672fa318f29b51930d", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/07115caf343979dc30ec48672fa318f29b51930d", "committedDate": "2020-05-29T13:07:21Z", "message": "Rename Boarding to PatternRide and update variable names and JavaDoc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6dfbafd856d244eee755f3b9cef70dbc6a0fabb", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e6dfbafd856d244eee755f3b9cef70dbc6a0fabb", "committedDate": "2020-06-02T08:54:24Z", "message": "Merge branch 'dev-2.x' into otp2_optimize_mc_raptor_patterns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNDc2OTQ3", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3075#pullrequestreview-422476947", "createdAt": "2020-06-02T08:57:06Z", "commit": {"oid": "e6dfbafd856d244eee755f3b9cef70dbc6a0fabb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2116, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}