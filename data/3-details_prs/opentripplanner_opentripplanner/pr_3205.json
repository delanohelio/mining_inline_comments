{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NjkzMzgz", "number": 3205, "title": "Realtime updater optimisations and fixes", "bodyText": "This pull request is done based on discussions on the OTP dev meeting last Thursday. It contains the following:\n\nDo not overwrite TripPattern ids\nMake TransitEntity equals and hashCode final, removing the three implementations extending those.\nStore original trip pattern on trip patterns created from realtime updates\nCache or move expensive calculations outside loops in realtime updaters\nFix purging of old data, so it is run only on actual day changes\nFix TimetableSnapshot by only adding modified patterns to the cache of new patterns and make it explicitly a SetMultimap , so the same pattern is not added more than once.\n\nTo be completed by pull request submitter:\n\n issue: #3110\n roadmap: Check the roadmap for this feature or bug. If it is not already on the roadmap, PLC will discuss as part of the review process.\n tests: Have you added relevant test coverage? Are all the tests passing on the continuous integration service (Travis CI)?\n formatting: Have you followed the suggested code style?\n documentation: If you are adding a new configuration option, have you added an explanation to the configuration documentation tables and sections?\n changelog: add a bullet point to the changelog file with description and link to the linked issue\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-10-05T08:43:30Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205", "merged": true, "mergeCommit": {"oid": "10ffdf255ace17a73956a82b1d3460ce46980f88"}, "closed": true, "closedAt": "2020-10-06T09:41:13Z", "author": {"login": "hannesj"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPelH6AH2gAyNDk3NjkzMzgzOjU1YzlkZjNkY2NjZThlYjI3Y2FhNDQyZDg4NjExNWI2YjkzYjQ4NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP1JCEAFqTUwMjc2MTI1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55c9df3dccce8eb27caa442d886115b6b93b4861", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/55c9df3dccce8eb27caa442d886115b6b93b4861", "committedDate": "2020-10-05T07:23:48Z", "message": "Keep generated id on TripPattern, the equals method is based only on matching ids"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee03a730c5992f80301488a2df3455a3240c513", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3ee03a730c5992f80301488a2df3455a3240c513", "committedDate": "2020-10-05T07:23:48Z", "message": "Purge data only if we have changed date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64197c0ed66290884c6ab81f725e1b9fe698f939", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/64197c0ed66290884c6ab81f725e1b9fe698f939", "committedDate": "2020-10-05T07:23:48Z", "message": "Update Changelog.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16c031b5ff80729111eb04c8f015276abfc59128", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/16c031b5ff80729111eb04c8f015276abfc59128", "committedDate": "2020-10-05T07:23:48Z", "message": "Add patterns to patternsForStop only if they are coming from real-time updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae82e4ead75ab2fd62b777e4c2585437fcb0e167", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ae82e4ead75ab2fd62b777e4c2585437fcb0e167", "committedDate": "2020-10-05T07:23:48Z", "message": "Re-use previous servicesRunningForDate if on the same date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8363f047c17a3bd30fbd8783a9895fee5b843bfd", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8363f047c17a3bd30fbd8783a9895fee5b843bfd", "committedDate": "2020-10-05T07:23:48Z", "message": "Force usage of SetMultimap, in order to not insert the same TripPattern more than once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5939c9d1d0629940b35ddbecc943c01f233e31d9", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5939c9d1d0629940b35ddbecc943c01f233e31d9", "committedDate": "2020-10-05T07:23:48Z", "message": "Move expensive calculation of midnight outside loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8afd66107af2c11641b13cdfa0c02841c11ed7f", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d8afd66107af2c11641b13cdfa0c02841c11ed7f", "committedDate": "2020-10-05T08:31:50Z", "message": "Make TransitEntity equals and hashcode non-extendable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e7398d1964c3aec554a1cc3e7d71bac6254288c5", "committedDate": "2020-10-06T08:32:17Z", "message": "Merge branch 'dev-2.x' into realtime-optimizations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzI3OTc2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#pullrequestreview-502727976", "createdAt": "2020-10-06T08:59:53Z", "commit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwODo1OTo1M1rOHc8uyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwODo1OTo1M1rOHc8uyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNzE5Mg==", "bodyText": "Add final", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500117192", "createdAt": "2020-10-06T08:59:53Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/Timetable.java", "diffHunk": "@@ -265,6 +264,8 @@ public TripTimes createUpdatedTripTimes(TripUpdate tripUpdate, TimeZone timeZone\n             int numStops = newTimes.getNumStops();\n             Integer delay = null;\n \n+            long today = updateServiceDate.getAsDate(timeZone).getTime() / 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzI5MDkz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#pullrequestreview-502729093", "createdAt": "2020-10-06T09:01:10Z", "commit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowMToxMVrOHc8x7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowMToxMVrOHc8x7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNzk5OA==", "bodyText": "Add  a comment to this, why we need a SetMultimap.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500117998", "createdAt": "2020-10-06T09:01:11Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/TimetableSnapshot.java", "diffHunk": "@@ -123,7 +122,7 @@ public boolean equals(Object obj) {\n      *\n      * TODO Find a generic way to keep all realtime indexes.\n      */\n-    private Multimap<Stop, TripPattern> patternsForStop = ArrayListMultimap.create();\n+    private SetMultimap<Stop, TripPattern> patternsForStop = HashMultimap.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzMxMzA0", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#pullrequestreview-502731304", "createdAt": "2020-10-06T09:03:58Z", "commit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowMzo1OFrOHc84WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowMzo1OFrOHc84WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExOTY0MQ==", "bodyText": "Add a method to the TripPattern.isCreatedByRealTimeUpdater() : boolean and use it here.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500119641", "createdAt": "2020-10-06T09:03:58Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/TimetableSnapshot.java", "diffHunk": "@@ -386,17 +385,22 @@ public String toString() {\n         return timetables.keySet();\n     }\n \n+    /**\n+     * Add the patterns to the stop index, only if they come from a modified pattern\n+     */\n     private void addPatternToIndex(TripPattern tripPattern) {\n-        for (Stop stop: tripPattern.getStops()) {\n-            patternsForStop.put(stop, tripPattern);\n+        if (tripPattern.getOriginalTripPattern() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzMzMzUy", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#pullrequestreview-502733352", "createdAt": "2020-10-06T09:06:24Z", "commit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowNjoyNFrOHc8-TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTowNjoyNFrOHc8-TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEyMTE2NA==", "bodyText": "This is great! Should  have been done a long  time ago!", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500121164", "createdAt": "2020-10-06T09:06:24Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/TransitEntity.java", "diffHunk": "@@ -30,7 +30,7 @@ public void setId(T id) {\n      * example after reloading a serialized instance.\n      */\n     @Override\n-    public boolean equals(Object obj) {\n+    final public boolean equals(Object obj) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2fa33c192e6af4b6d9ca4bcd99d74a1528ed6ce", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e2fa33c192e6af4b6d9ca4bcd99d74a1528ed6ce", "committedDate": "2020-10-06T09:35:54Z", "message": "Add setCreatedByRealtimeUpdater"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b76e3c14435c9e8d4b679bd062917ffcd5172924", "author": {"user": {"login": "hannesj", "name": "Hannes Junnila"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b76e3c14435c9e8d4b679bd062917ffcd5172924", "committedDate": "2020-10-06T09:35:54Z", "message": "Changes based on comments from the review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzYxMjU1", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#pullrequestreview-502761255", "createdAt": "2020-10-06T09:40:56Z", "commit": {"oid": "b76e3c14435c9e8d4b679bd062917ffcd5172924"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1988, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}