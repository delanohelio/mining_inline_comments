{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3OTUwODYx", "number": 3185, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozOToyOVrOEwQTLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODowMDozNFrOEwpOZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM0MTU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/NetexModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozOToyOVrOHlsrOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozOToyOVrOHlsrOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5MTMyMg==", "bodyText": "I looked at the side-effect, it is very simple to remove it, just returning the result an add it here. I will provide a commit that do that.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509291322", "createdAt": "2020-10-21T13:39:29Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/NetexModule.java", "diffHunk": "@@ -86,6 +88,11 @@ public void buildGraph(\n \n                 calendarServiceData.add(transitBuilder.buildCalendarServiceData());\n \n+                // NB! The calls below have side effects - the builder state is updated!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM2NDA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/NetexBundle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Mzo1M1rOHls5Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Mzo1M1rOHls5Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDg2Ng==", "bodyText": "Revert changing this file - this import is wrong.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509294866", "createdAt": "2020-10-21T13:43:53Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/NetexBundle.java", "diffHunk": "@@ -13,6 +17,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import javax.swing.text.html.parser.Entity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDU0MDY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/parser/SiteFrameParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxMzowNFrOHlumrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxMzowNFrOHlumrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMyMjkyNQ==", "bodyText": "Suggestion: if (OTPFeature.FlexRouting.isOn() && frame.getFlexibleStopPlaces() != null) {\nThis should allow us to move this code into production, with Flex in the data and use the OTPFeature to toggle FLEX on off, even if there is problems in the import mapping.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509322925", "createdAt": "2020-10-21T14:13:04Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/parser/SiteFrameParser.java", "diffHunk": "@@ -37,6 +40,10 @@ public void parse(Site_VersionFrameStructure frame) {\n         if (frame.getGroupsOfStopPlaces() != null) {\n             parseGroupsOfStopPlaces(frame.getGroupsOfStopPlaces().getGroupOfStopPlaces());\n         }\n+        if (frame.getFlexibleStopPlaces() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDU1OTQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/parser/ServiceFrameParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxNjoyMlrOHluyTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxNjoyMlrOHluyTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMyNTkwMw==", "bodyText": "else if (stopAssignment.getValue() instanceof FlexibleStopAssignment) {\n  if(OTPFeature.FlexRouting.isOn()) {", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509325903", "createdAt": "2020-10-21T14:16:22Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/parser/ServiceFrameParser.java", "diffHunk": "@@ -143,6 +159,24 @@ private void parseStopAssignments(StopAssignmentsInFrame_RelStructure stopAssign\n                     LOG.warn(\"Quay {} not found in stop place file.\", quayRef);\n                 }\n             }\n+            else if (stopAssignment.getValue() instanceof FlexibleStopAssignment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDU2NzQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/parser/ServiceFrameParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxNzo1NFrOHlu3XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoxNzo1NFrOHlu3XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMyNzE5Ng==", "bodyText": "if(OTPFeature.FlexRouting.isOn()) {\n  this.flexibleLines.add((FlexibleLine) element.getValue());\n}", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509327196", "createdAt": "2020-10-21T14:17:54Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/parser/ServiceFrameParser.java", "diffHunk": "@@ -193,6 +227,8 @@ private void parseLines(LinesInFrame_RelStructure lines) {\n         for (JAXBElement element : lines.getLine_()) {\n             if (element.getValue() instanceof Line) {\n                 this.lines.add((Line) element.getValue());\n+            } else if (element.getValue() instanceof FlexibleLine) {\n+                this.flexibleLines.add((FlexibleLine) element.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDY5MzkyOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo0MToyN1rOHlwG3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo0MToyN1rOHlwG3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0NzU0OQ==", "bodyText": "This should be a WARNING not halt the build process.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509347549", "createdAt": "2020-10-21T14:41:27Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.opentripplanner.netex.loader.mapping;\n+\n+import net.opengis.gml._3.AbstractRingPropertyType;\n+import net.opengis.gml._3.LinearRingType;\n+import net.opengis.gml._3.PolygonType;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.CoordinateSequence;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.LinearRing;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opentripplanner.api.resource.CoordinateArrayListSequence;\n+import org.opentripplanner.common.geometry.GeometryUtils;\n+import org.opentripplanner.model.FlexStopLocation;\n+import org.rutebanken.netex.model.FlexibleArea;\n+import org.rutebanken.netex.model.FlexibleStopPlace;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class FlexStopLocationMapper {\n+\n+  private final FeedScopedIdFactory idFactory;\n+\n+  public FlexStopLocationMapper(FeedScopedIdFactory idFactory) {\n+    this.idFactory = idFactory;\n+  }\n+\n+  /**\n+   * Maps NeTEx FlexibleStopPlace to FlexStopLocation. This currently does not support\n+   * FlexLocationGroup, as an equivalent is not defined in the NeTEx Nordic profile.\n+   */\n+  public FlexStopLocation map(FlexibleStopPlace flexibleStopPlace) {\n+    FlexStopLocation result = new FlexStopLocation(idFactory.createId(flexibleStopPlace.getId()));\n+    result.setName(flexibleStopPlace.getName().getValue());\n+\n+    Object flexibleAreaOrFlexibleAreaRefOrHailAndRideArea = flexibleStopPlace\n+        .getAreas()\n+        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n+        .get(0); // Only one area allowed in NeTEx Nordic profile.\n+\n+    if (flexibleAreaOrFlexibleAreaRefOrHailAndRideArea instanceof FlexibleArea) {\n+      result.setGeometry(mapGeometry((\n+          (FlexibleArea) flexibleAreaOrFlexibleAreaRefOrHailAndRideArea\n+      ).getPolygon()));\n+    }\n+    else {\n+      throw new IllegalArgumentException(\"Hail and ride areas are not currently supported.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDc1MzQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo1MjozNVrOHlwr9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo1MjozNVrOHlwr9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1NzA0NA==", "bodyText": "This is not readable. There is 3 problems: 1) Do NOT use long variable names for short lived local variables. 2) The line breaks should be breaking the outer-most scope, what is the expression before .getPolygon(). 3) C-style comment TRAILING code is not allowed, it should be put on a separate line BEFORE the expression.  This is much more readable:\n    // Only one area allowed in NeTEx Nordic profile, get the first one\n    Object area = flexibleStopPlace\n        .getAreas()\n        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n        .get(0); \n\n    if (area instanceof FlexibleArea) {\n      var flexibleArea = (FlexibleArea) area;\n      result.setGeometry(mapGeometry(flexibleArea.getPolygon()));\n    }", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509357044", "createdAt": "2020-10-21T14:52:35Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.opentripplanner.netex.loader.mapping;\n+\n+import net.opengis.gml._3.AbstractRingPropertyType;\n+import net.opengis.gml._3.LinearRingType;\n+import net.opengis.gml._3.PolygonType;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.CoordinateSequence;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.LinearRing;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opentripplanner.api.resource.CoordinateArrayListSequence;\n+import org.opentripplanner.common.geometry.GeometryUtils;\n+import org.opentripplanner.model.FlexStopLocation;\n+import org.rutebanken.netex.model.FlexibleArea;\n+import org.rutebanken.netex.model.FlexibleStopPlace;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class FlexStopLocationMapper {\n+\n+  private final FeedScopedIdFactory idFactory;\n+\n+  public FlexStopLocationMapper(FeedScopedIdFactory idFactory) {\n+    this.idFactory = idFactory;\n+  }\n+\n+  /**\n+   * Maps NeTEx FlexibleStopPlace to FlexStopLocation. This currently does not support\n+   * FlexLocationGroup, as an equivalent is not defined in the NeTEx Nordic profile.\n+   */\n+  public FlexStopLocation map(FlexibleStopPlace flexibleStopPlace) {\n+    FlexStopLocation result = new FlexStopLocation(idFactory.createId(flexibleStopPlace.getId()));\n+    result.setName(flexibleStopPlace.getName().getValue());\n+\n+    Object flexibleAreaOrFlexibleAreaRefOrHailAndRideArea = flexibleStopPlace\n+        .getAreas()\n+        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n+        .get(0); // Only one area allowed in NeTEx Nordic profile.\n+\n+    if (flexibleAreaOrFlexibleAreaRefOrHailAndRideArea instanceof FlexibleArea) {\n+      result.setGeometry(mapGeometry((\n+          (FlexibleArea) flexibleAreaOrFlexibleAreaRefOrHailAndRideArea\n+      ).getPolygon()));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDkzNDc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyODo0MVrOHlyeQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyODo0MVrOHlyeQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4NjMwNQ==", "bodyText": "Move these mapping functions into a separat mapper, for example to OpenGisMapper. These are not part of Netex flex, but OpenGis. They are subject to reuse.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509386305", "createdAt": "2020-10-21T15:28:41Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.opentripplanner.netex.loader.mapping;\n+\n+import net.opengis.gml._3.AbstractRingPropertyType;\n+import net.opengis.gml._3.LinearRingType;\n+import net.opengis.gml._3.PolygonType;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.CoordinateSequence;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.LinearRing;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opentripplanner.api.resource.CoordinateArrayListSequence;\n+import org.opentripplanner.common.geometry.GeometryUtils;\n+import org.opentripplanner.model.FlexStopLocation;\n+import org.rutebanken.netex.model.FlexibleArea;\n+import org.rutebanken.netex.model.FlexibleStopPlace;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class FlexStopLocationMapper {\n+\n+  private final FeedScopedIdFactory idFactory;\n+\n+  public FlexStopLocationMapper(FeedScopedIdFactory idFactory) {\n+    this.idFactory = idFactory;\n+  }\n+\n+  /**\n+   * Maps NeTEx FlexibleStopPlace to FlexStopLocation. This currently does not support\n+   * FlexLocationGroup, as an equivalent is not defined in the NeTEx Nordic profile.\n+   */\n+  public FlexStopLocation map(FlexibleStopPlace flexibleStopPlace) {\n+    FlexStopLocation result = new FlexStopLocation(idFactory.createId(flexibleStopPlace.getId()));\n+    result.setName(flexibleStopPlace.getName().getValue());\n+\n+    Object flexibleAreaOrFlexibleAreaRefOrHailAndRideArea = flexibleStopPlace\n+        .getAreas()\n+        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n+        .get(0); // Only one area allowed in NeTEx Nordic profile.\n+\n+    if (flexibleAreaOrFlexibleAreaRefOrHailAndRideArea instanceof FlexibleArea) {\n+      result.setGeometry(mapGeometry((\n+          (FlexibleArea) flexibleAreaOrFlexibleAreaRefOrHailAndRideArea\n+      ).getPolygon()));\n+    }\n+    else {\n+      throw new IllegalArgumentException(\"Hail and ride areas are not currently supported.\");\n+    }\n+    return result;\n+  }\n+\n+  private Geometry mapGeometry(PolygonType polygonType) {\n+    return new Polygon(\n+        new LinearRing(mapCoordinateSequence(polygonType.getExterior()),\n+            GeometryUtils.getGeometryFactory()\n+        ),\n+        polygonType\n+            .getInterior()\n+            .stream()\n+            .map(c -> new LinearRing(mapCoordinateSequence(c), GeometryUtils.getGeometryFactory()))\n+            .toArray(LinearRing[]::new),\n+        GeometryUtils.getGeometryFactory()\n+    );\n+  }\n+\n+  private CoordinateSequence mapCoordinateSequence(\n+      AbstractRingPropertyType abstractRingPropertyType\n+  ) {\n+    List<Double> posList = ((LinearRingType) abstractRingPropertyType.getAbstractRing().getValue())\n+        .getPosList()\n+        .getValue();\n+\n+    // Convert a single list of alternating lat/lon values into coordinates\n+    ArrayList<Coordinate> coordinates = new ArrayList<>();\n+    for (int i = 0; i < posList.size(); i += 2) {\n+      coordinates.add(new Coordinate(posList.get(i + 1), posList.get(i)));\n+    }\n+\n+    return new CoordinateArrayListSequence(coordinates);\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MTAxMzc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/mapping/StopTimesMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTo0NToxNFrOHlzQGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTo0NToxNFrOHlzQGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM5OTA2NA==", "bodyText": "Class member fields passed to a class member function. No need to pass these on.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509399064", "createdAt": "2020-10-21T15:45:14Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/StopTimesMapper.java", "diffHunk": "@@ -76,7 +87,13 @@ MappedStopTimes mapToStopTimes(\n             String pointInJourneyPattern = currentPassingTime.getPointInJourneyPatternRef().getValue().getRef();\n \n             StopPointInJourneyPattern stopPoint = findStopPoint(pointInJourneyPattern, journeyPattern);\n-            Stop stop = lookupStop(stopPoint, quayIdByStopPointRef, stopsById);\n+            StopLocation stop = lookUpStopLocation(\n+                stopPoint,\n+                quayIdByStopPointRef,\n+                flexibleStopPlaceIdByStopPointRef,\n+                stopsById,\n+                flexibleStopLocationsById", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NDQyNTM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODowMDozNFrOHmVT5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwOTozMDozNlrOHmY-Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1NzA5NA==", "bodyText": "Wouldn't it be safe to always construct a multipolygon?", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r509957094", "createdAt": "2020-10-22T08:00:34Z", "author": {"login": "hannesj"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.opentripplanner.netex.loader.mapping;\n+\n+import net.opengis.gml._3.AbstractRingPropertyType;\n+import net.opengis.gml._3.LinearRingType;\n+import net.opengis.gml._3.PolygonType;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.CoordinateSequence;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.LinearRing;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opentripplanner.api.resource.CoordinateArrayListSequence;\n+import org.opentripplanner.common.geometry.GeometryUtils;\n+import org.opentripplanner.model.FlexStopLocation;\n+import org.rutebanken.netex.model.FlexibleArea;\n+import org.rutebanken.netex.model.FlexibleStopPlace;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class FlexStopLocationMapper {\n+\n+  private final FeedScopedIdFactory idFactory;\n+\n+  public FlexStopLocationMapper(FeedScopedIdFactory idFactory) {\n+    this.idFactory = idFactory;\n+  }\n+\n+  /**\n+   * Maps NeTEx FlexibleStopPlace to FlexStopLocation. This currently does not support\n+   * FlexLocationGroup, as an equivalent is not defined in the NeTEx Nordic profile.\n+   */\n+  public FlexStopLocation map(FlexibleStopPlace flexibleStopPlace) {\n+    FlexStopLocation result = new FlexStopLocation(idFactory.createId(flexibleStopPlace.getId()));\n+    result.setName(flexibleStopPlace.getName().getValue());\n+\n+    Object flexibleAreaOrFlexibleAreaRefOrHailAndRideArea = flexibleStopPlace\n+        .getAreas()\n+        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n+        .get(0); // Only one area allowed in NeTEx Nordic profile.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAxNzA4Nw==", "bodyText": "We could construct a multipolygon here, but it would only contain one polygon, as we are mapping from OpenGIS polygon in the NeTEx XML.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3185#discussion_r510017087", "createdAt": "2020-10-22T09:30:36Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/netex/loader/mapping/FlexStopLocationMapper.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.opentripplanner.netex.loader.mapping;\n+\n+import net.opengis.gml._3.AbstractRingPropertyType;\n+import net.opengis.gml._3.LinearRingType;\n+import net.opengis.gml._3.PolygonType;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.CoordinateSequence;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.LinearRing;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opentripplanner.api.resource.CoordinateArrayListSequence;\n+import org.opentripplanner.common.geometry.GeometryUtils;\n+import org.opentripplanner.model.FlexStopLocation;\n+import org.rutebanken.netex.model.FlexibleArea;\n+import org.rutebanken.netex.model.FlexibleStopPlace;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class FlexStopLocationMapper {\n+\n+  private final FeedScopedIdFactory idFactory;\n+\n+  public FlexStopLocationMapper(FeedScopedIdFactory idFactory) {\n+    this.idFactory = idFactory;\n+  }\n+\n+  /**\n+   * Maps NeTEx FlexibleStopPlace to FlexStopLocation. This currently does not support\n+   * FlexLocationGroup, as an equivalent is not defined in the NeTEx Nordic profile.\n+   */\n+  public FlexStopLocation map(FlexibleStopPlace flexibleStopPlace) {\n+    FlexStopLocation result = new FlexStopLocation(idFactory.createId(flexibleStopPlace.getId()));\n+    result.setName(flexibleStopPlace.getName().getValue());\n+\n+    Object flexibleAreaOrFlexibleAreaRefOrHailAndRideArea = flexibleStopPlace\n+        .getAreas()\n+        .getFlexibleAreaOrFlexibleAreaRefOrHailAndRideArea()\n+        .get(0); // Only one area allowed in NeTEx Nordic profile.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1NzA5NA=="}, "originalCommit": {"oid": "510b2caf15e4e25a690f4e9795f189512a1fee47"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1679, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}