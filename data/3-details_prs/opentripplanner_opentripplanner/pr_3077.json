{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjQ3Nzc1", "number": 3077, "title": "Otp2 fix debug filter error", "bodyText": "Bugfix:\n\n\nThe itinerary filter debug mode did not always report all removed trips, this has been fixed by slightly changing the debug-filtering strategy.\n\n\nThis also fixes the potential error of having an itinerary marked with a system notice pass through the filtering without being deleted even when it should.\n\n\nThe request parameter numberOfItineraries is respected.\n\n\nFix the sorting order for arriveBy search.\n\n\n issue: closes #3073, closes #3068\n\n\n roadmap: Bugfix\n\n\n tests: Yes\n\n\n formatting: No\n\n\n documentation: Updated, no major changes.\n\n\n changelog: No.\n\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-05-13T22:33:26Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077", "merged": true, "mergeCommit": {"oid": "916792ce225991acc9423ffe20022d36744821fc"}, "closed": true, "closedAt": "2020-05-20T13:03:08Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchAniTAH2gAyNDE3NjQ3Nzc1OjBiZjE4YzFmMzZhMWU3ZDk3ZDJmYmQxMjJhNWMwNjA4NTk3MDFlZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjG4pSAFqTQxNTIxNjc0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "committedDate": "2020-05-13T22:28:46Z", "message": "Bugfix\n - The itinerary filter debug mode did not always report all removed trips, this has been fixed by slightly changing the debug-filtering strategy.\n - This also fixes the potential error of having an itinerary marked with a system notice pass through the filtering without being deleted even when it should."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7636b8fd9a85d7c6f46a032df78e50c80fdb8c47", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/7636b8fd9a85d7c6f46a032df78e50c80fdb8c47", "committedDate": "2020-05-13T22:28:46Z", "message": "Bugfix - Fix the sorting order for arrive-by search."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4", "committedDate": "2020-05-15T15:39:23Z", "message": "Bug-fix on search-widow metadata returned to client for arriveBy routing search. The nex- and prev- dateTime was not calculated correct for arriveBy search.\n- There are also a some small cleanups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTUzMDkw", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#pullrequestreview-414153090", "createdAt": "2020-05-19T07:00:19Z", "commit": {"oid": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzowMDoxOVrOGXSbFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzoyMzo0OFrOGXTHfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3MjI3Nw==", "bodyText": "Typo: Wrppers => Wrappers", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427072277", "createdAt": "2020-05-19T07:00:19Z", "author": {"login": "hannesj"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java", "diffHunk": "@@ -103,6 +104,18 @@ public ItineraryFilter build() {\n             filters.add(new MaxLimitFilter(\"MAX\", maxLimit));\n         }\n \n-        return debug ? new DebugFilterChain(filters) : new FilterChain(filters);\n+        if(debug) {\n+            filters = addDebugWrppers(filters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NTM3Mg==", "bodyText": "remaning? Although I think something like previouslyUnfiltered might make more sense.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427075372", "createdAt": "2020-05-19T07:07:07Z", "author": {"login": "hannesj"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.opentripplanner.routing.algorithm.filterchain.filters;\n+\n+import org.opentripplanner.model.SystemNotice;\n+import org.opentripplanner.model.plan.Itinerary;\n+import org.opentripplanner.routing.algorithm.filterchain.ItineraryFilter;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class DebugFilterWrapper implements ItineraryFilter {\n+\n+  private final ItineraryFilter delegate;\n+  private final List<Itinerary> deletedItineraries;\n+\n+  public DebugFilterWrapper(ItineraryFilter delegate, List<Itinerary> deletedItineraries) {\n+    this.delegate = delegate;\n+    this.deletedItineraries = deletedItineraries;\n+  }\n+\n+  @Override\n+  public String name() {\n+    return delegate.name();\n+  }\n+\n+  @Override\n+  public List<Itinerary> filter(List<Itinerary> itineraries) {\n+    List<Itinerary> reminding = remindingItineraries(itineraries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4MzY0Nw==", "bodyText": "We might want to make it more explicit, that this is only when changing the direction of the search. Now it is not clear, when skimming the text. When searching in the same direction, there is no need to se the numOfItineraries any higher.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427083647", "createdAt": "2020-05-19T07:23:48Z", "author": {"login": "hannesj"}, "path": "src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java", "diffHunk": "@@ -9,12 +9,18 @@\n      * This is the time window used by the raptor search. The window is an optional parameter and\n      * OTP might override it/dynamically assign a new value.\n      * <p>\n+     * Note! This parameter is NOT adjusted when the number of itineraries are reduced due to the\n+     * request {@code numOfItineraries} parameter. When getting the next results\n+     * ({@code arriveBy=true}) or previous results({@code arriveBy=false}), be sure to set the\n+     * {@code numOfItineraries} high enough to include all itineraries. If not, the combined results\n+     * will be missing trips.\n+     * <p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd904d3f32e7383913d86ce677eb5648ec83a3b", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/4fd904d3f32e7383913d86ce677eb5648ec83a3b", "committedDate": "2020-05-20T10:14:13Z", "message": "Review fixes - Otp2 fix debug filter error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "committedDate": "2020-05-20T10:41:48Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_fix_debug_filter_error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "409ccf01b9c33e6028bda8a10ddf93158e0ef688", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/409ccf01b9c33e6028bda8a10ddf93158e0ef688", "committedDate": "2020-05-20T10:31:24Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_fix_debug_filter_error"}, "afterCommit": {"oid": "11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "committedDate": "2020-05-20T10:41:48Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_fix_debug_filter_error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MjE2NzQz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#pullrequestreview-415216743", "createdAt": "2020-05-20T10:54:44Z", "commit": {"oid": "11d093308abbcc0ca76dbb81ca2dc1feee23d4b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2119, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}