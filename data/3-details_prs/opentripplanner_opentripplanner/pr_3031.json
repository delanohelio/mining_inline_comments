{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjkwNjM2", "number": 3031, "title": "Otp2 api types", "bodyText": "This pull request cleans up the code for the (legacy) REST API, such that no OTP2 internal model classes are exposed on the API anymore. For example, rich functionality in the domain model (like circular references between stops and their parent stations) is not present in the API model classes so it is clear how they should be serialized to JSON (issue #X). It also prepares for a new ID strategy.\nSome of the changes in this PR is:\n\n\nAPI types are consistent named API[Short] (not Type)\n\n\nAll mapping of internal domain objects are done calling mappers from the resources, no magic Adapters.\n\n\nReference to entities are done using feed-scoped-id, there should not be any need to use semantics to resolve any relationships.\n\n\nXML as a (de-)serialization mechanism is NOT SUPPORTED any more, only JSON.\n\n\nMany small code cleanups/refactoring.\n\n\nType-safe interface for the INDEX API -- NOT-FOUND and BAD-REQUEST are now exceptions with detailed error messages for easy client trouble shooting.\n\n\n issues: Close #2968\n\n\n documentation: The OTP2 Migration Guide is updated.", "createdAt": "2020-04-09T08:41:18Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031", "merged": true, "mergeCommit": {"oid": "b00a045de5310316ca7738421ae4bb66b528f39f"}, "closed": true, "closedAt": "2020-04-16T09:48:55Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU-ZIgAH2gAyNDAxMjkwNjM2OjIxODhkMGFkOGQxZDE3MGJiYzAzNmZmMjYwZDg5ZmI3NzgzNTRhYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYJdIpAH2gAyNDAxMjkwNjM2OmJkMGI2NDVlZDY5YjhmNDFkODRmNTIxNzI1ZWE1OWRlNDYyZTA0N2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2188d0ad8d1d170bbc036ff260d89fb778354aba", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2188d0ad8d1d170bbc036ff260d89fb778354aba", "committedDate": "2020-04-06T13:06:08Z", "message": "Clean Code - The API POJOs should follow the same pattern with writable public fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba3c369453efcf377900a4b085d22772cf6fd038", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ba3c369453efcf377900a4b085d22772cf6fd038", "committedDate": "2020-04-06T13:08:05Z", "message": "Clean Code - Rename 'AgencyAndIdType' to 'ApiFeedScopedId'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53539fa7720007b052715b14398e9e3cf8d37f3b", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/53539fa7720007b052715b14398e9e3cf8d37f3b", "committedDate": "2020-04-06T13:53:29Z", "message": "Clean Code - Delete unused adapters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf95b4209cd0cc2e382f03607769f89a1f2d5b5f", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/cf95b4209cd0cc2e382f03607769f89a1f2d5b5f", "committedDate": "2020-04-06T13:54:37Z", "message": "Clean Code - Move ApiFeedScopedId from adapters to model."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0345390a5c0d79ce39f6b6eb414160e432d410ad", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0345390a5c0d79ce39f6b6eb414160e432d410ad", "committedDate": "2020-04-06T14:50:22Z", "message": "Clean Code - Convert FeedScopedIdAdapter to FeedScopedIdMapper."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358859c83a5bd11a1422445807bd66804982e618", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/358859c83a5bd11a1422445807bd66804982e618", "committedDate": "2020-04-06T16:06:52Z", "message": "Clean Code\n - Move JSON (de)serializers out of 'api.model' into 'api.json'.\n - Simplify all API ids from ApiFeedScopedId to String, this will enable us to have different strategies for ids later.\n - Do not use the GtfsLibrary to map ids, instead use the FeedScopedIdMapper. This enable us to use different mapping for reading input files, and having anothe strategy for our APIS.\n - Move api Transfer from innerclass of ApiIndex to model."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e00532a06835777fd5d9c6730b23ddacffa5434", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5e00532a06835777fd5d9c6730b23ddacffa5434", "committedDate": "2020-04-08T08:16:45Z", "message": "Clean Code - Move 'GeometryAdapter' from api.model to api.mapping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e04682ef817af2ea4bd140d938f673678e0ed70", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2e04682ef817af2ea4bd140d938f673678e0ed70", "committedDate": "2020-04-08T08:21:13Z", "message": "Clean Code - Move StopTimesInPattern and TripTimeShort from api.model to model."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "505ff3c533bfc14bdfa2215f681e088839b9e725", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/505ff3c533bfc14bdfa2215f681e088839b9e725", "committedDate": "2020-04-08T08:28:45Z", "message": "Clean Code - Rename all api.model classes to follow the convention with \"Api\" as a prefix.\n - ApiPatternShort, ApiRealTimeState, ApiRouterList, ApiStopTimesInPattern and ApiTripTimeShort."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3957af82ea95648d8185983326967aef162bd3", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9d3957af82ea95648d8185983326967aef162bd3", "committedDate": "2020-04-08T08:38:32Z", "message": "Clean Code - Replace internal Stop with new ApiStop in IndexApi."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a09e883412955d96d6924b416ca9e912c392b159", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a09e883412955d96d6924b416ca9e912c392b159", "committedDate": "2020-04-08T12:10:43Z", "message": "Clean Code - Rename all index.model classes to follow the convention with \"Api\" as a prefix.\n - ApiRouteShort, ApiPatternDetail, ApiStopShort and ApiTripShort."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbd0f44275bb1f4763a6c9b6f9b096c17dd6472c", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fbd0f44275bb1f4763a6c9b6f9b096c17dd6472c", "committedDate": "2020-04-08T12:11:42Z", "message": "Clean Code - Replace use of internal model Agency with ApiAgency in IndexAPI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7497d41b6252a90d8c305417ab0568a8fe4a4f3", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f7497d41b6252a90d8c305417ab0568a8fe4a4f3", "committedDate": "2020-04-08T12:11:42Z", "message": "Clean Code - Replace use of internal model Route with ApiRoute in IndexAPI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acadddfc075941f29758df3fabee351d4ee9968", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0acadddfc075941f29758df3fabee351d4ee9968", "committedDate": "2020-04-08T12:11:43Z", "message": "Clean Code\n   - Return BAD_REQUEST on IndexAPI for invalid FeedScopedId.\n   - Add graceful exception handling of WebApplicationExceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7864b8b7e7f278bc4af04332c32fb175c084064", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a7864b8b7e7f278bc4af04332c32fb175c084064", "committedDate": "2020-04-08T12:11:52Z", "message": "Clean Code\n   - Update OTP2 MigrationGuide on error handling for REST API and Index API.\n   - Add graceful exception handling all Resources, except IndexAPI(cleanup in separate commit later)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "278bf712f4238b6832205750f1d83b6c5e9aac02", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/278bf712f4238b6832205750f1d83b6c5e9aac02", "committedDate": "2020-04-08T13:23:39Z", "message": "Clean Code - Various Index API cleanup.\n - Replace internal FeedInfo with new ApiFeedInfo in IndexApi.\n - Add ServiceDateMapper mapper, uses ISO-8601 for service dates.\n - Extract mapping code from API types into Mapper classes for StopTimesInPattern, TripPattern, and TripTime.\n - Fix ApiPatternDetail witch was extending domain class PatternShort, not the ApiPatternShort.\n - Fix internal StopTimesInPattern ref to TripPattern (wa using the API type)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "326f6dbfc78eb2cd3cda8e46bf56461710cd6b57", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/326f6dbfc78eb2cd3cda8e46bf56461710cd6b57", "committedDate": "2020-04-08T17:11:09Z", "message": "Clean Code - Allow ServiceDate parse to accept ISO 8601 and improve test coverage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd845dc070e2d2908ef7badd1fda6fda7067f5ab", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/dd845dc070e2d2908ef7badd1fda6fda7067f5ab", "committedDate": "2020-04-08T17:16:45Z", "message": "Clean Code - Update OTP2 Migration Guide for changes to Route entity in Index API."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c0267effdb62251a58b4988f17202949f3d916f", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1c0267effdb62251a58b4988f17202949f3d916f", "committedDate": "2020-04-09T00:02:43Z", "message": "Clean Code - Cleanup TripPattern in API\n- Use TripPattern 'id' not 'code' as index in 'Graph.tripPatternForId'.\n- Update OTP2 Migration Guide for changes to Route entity in Index API.\n- Delete duplicate TripPatternShort.\n- Remove unused reindex in GTFS import, no longer needed.\n- Make FeedScopedId immutable.\n- Remove code from TripPattern."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e63d602e6782f6aa1a6bd7870de6dccd6a1bbe1b", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e63d602e6782f6aa1a6bd7870de6dccd6a1bbe1b", "committedDate": "2020-04-09T00:04:47Z", "message": "Clean Code - Make 'ApiRouteShort.id' in a String and not FeedScopedId(internal model type)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f5c8fa83801287c59c24b8d043a9a9fc7fc6b34", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0f5c8fa83801287c59c24b8d043a9a9fc7fc6b34", "committedDate": "2020-04-09T00:23:50Z", "message": "Clean Code - Cleanup Trip in API\n- A new ApiTrip is added and replace the old exposure of the internal Trip type.\n- Update OTP2 Migration Guide for changes to the Trip entity in Index API.\n- Delete unused TripType."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjQyMTMz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#pullrequestreview-390642133", "createdAt": "2020-04-09T09:41:11Z", "commit": {"oid": "358859c83a5bd11a1422445807bd66804982e618"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwOTo0MToxMVrOGDRWcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwOTo0MToxMVrOGDRWcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA4MzE4Ng==", "bodyText": "Use the SEPARATOR constant here.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#discussion_r406083186", "createdAt": "2020-04-09T09:41:11Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/api/mapping/FeedScopedIdMapper.java", "diffHunk": "@@ -1,22 +1,22 @@\n package org.opentripplanner.api.mapping;\n \n-import org.opentripplanner.api.model.ApiFeedScopedId;\n import org.opentripplanner.model.FeedScopedId;\n \n public class FeedScopedIdMapper {\n \n-    public static FeedScopedId mapToDomain(ApiFeedScopedId arg) {\n-        if (arg == null) {\n-            return null;\n-        }\n-        return new FeedScopedId(arg.agency, arg.id);\n+\n+    private static final String SEPARATOR = \":\";\n+\n+    public static FeedScopedId mapToDomain(String api) {\n+        if (api == null) { return null; }\n+        String[] parts = api.split(SEPARATOR, 2);\n+        return new FeedScopedId(parts[0], parts[1]);\n     }\n \n-    public static ApiFeedScopedId mapToApi(FeedScopedId arg) {\n+    public static String mapToApi(FeedScopedId arg) {\n         if (arg == null) {\n             return null;\n         }\n-        return new ApiFeedScopedId(arg.getFeedId(), arg.getId());\n+        return arg.getFeedId() + \":\" + arg.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358859c83a5bd11a1422445807bd66804982e618"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjQ1MzEx", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#pullrequestreview-390645311", "createdAt": "2020-04-09T09:45:43Z", "commit": {"oid": "5e00532a06835777fd5d9c6730b23ddacffa5434"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwOTo0NTo0M1rOGDRgdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwOTo0NTo0M1rOGDRgdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA4NTc0OQ==", "bodyText": "Eliminate use of adapter here", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#discussion_r406085749", "createdAt": "2020-04-09T09:45:43Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/api/model/ApiRouterInfo.java", "diffHunk": "@@ -31,7 +32,7 @@\n     \n     @JsonSerialize(using= GeometrySerializer.class)\n     @JsonDeserialize(using= GeometryDeserializer.class)\n-    @XmlJavaTypeAdapter(value=GeometryAdapter.class,type=Geometry.class)\n+    @XmlJavaTypeAdapter(value= GeometryAdapter.class,type=Geometry.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e00532a06835777fd5d9c6730b23ddacffa5434"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjYyNDI2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#pullrequestreview-390662426", "createdAt": "2020-04-09T10:09:59Z", "commit": {"oid": "a7864b8b7e7f278bc4af04332c32fb175c084064"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDoxMDowMFrOGDSX0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDoxMDowMFrOGDSX0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA5OTkyMQ==", "bodyText": "Remove the header description from the migration guide, it may be nice to have in the response but we don't want anyone to depend on this as an API \"feature\".", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#discussion_r406099921", "createdAt": "2020-04-09T10:10:00Z", "author": {"login": "abyrd"}, "path": "docs/OTP2-MigrationGuide.md", "diffHunk": "@@ -37,6 +37,9 @@ These properties changed names from:\n   - `searchWindowUsed`\n   - `nextDateTime`\n   - `prevDateTime`\n-   \n+\n+### Changes to the Index API\n+- Error handling is improved, this is now consistently applied and uses build in framework support. \n+  - The HTTP 400 and 404 response now contains an error message in plain text in addition to the header \"FOUR HUNDRED\" and \"FOUR ZERO FOUR\".   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7864b8b7e7f278bc4af04332c32fb175c084064"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjc2NTE2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#pullrequestreview-390676516", "createdAt": "2020-04-09T10:32:05Z", "commit": {"oid": "1c0267effdb62251a58b4988f17202949f3d916f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDozMjowNVrOGDTFYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDozMjowNVrOGDTFYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExMTU4NQ==", "bodyText": "delete rather then comment", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#discussion_r406111585", "createdAt": "2020-04-09T10:32:05Z", "author": {"login": "abyrd"}, "path": "src/test/java/org/opentripplanner/updater/stoptime/TimetableSnapshotSourceTest.java", "diffHunk": "@@ -53,9 +53,14 @@\n \n     @BeforeClass\n     public static void setUpClass() throws Exception {\n+        // The \".turnOnSetAgencyToFeedIdForAllElements()\" is commented out so it can be\n+        // removed from the code, it in no longer in use. It is not deleted here to better\n+        // allow the reader of the test understand how the test once worked. There should\n+        // be new test to replace this one.\n+\n         context = contextBuilder(ConstantsForTests.FAKE_GTFS)\n                 .withIssueStoreAndDeduplicator(graph)\n-                .turnOnSetAgencyToFeedIdForAllElements()\n+                //.turnOnSetAgencyToFeedIdForAllElements()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c0267effdb62251a58b4988f17202949f3d916f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41fad5005649c1c44a117dc383f86072b48dd2e", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e41fad5005649c1c44a117dc383f86072b48dd2e", "committedDate": "2020-04-14T14:58:54Z", "message": "Code review\n  - Remove unused Adapters.\n  - Update OTP2-MigrationGuide.\n  - Use the SEPARATOR constant everywhere, and this the string \":\".\n  - Add API mapping methods for all \"Short\" types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af3f64d4c4192ed69677e95a6cdd93dccc362473", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/af3f64d4c4192ed69677e95a6cdd93dccc362473", "committedDate": "2020-04-14T14:59:44Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_api_types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6909461b3ea6c5a98a5ef763c1da57153feacd97", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6909461b3ea6c5a98a5ef763c1da57153feacd97", "committedDate": "2020-04-15T17:28:31Z", "message": "XML as a in-/out-put serialization mechanism is removed from almost all APIs - except some of the RT-updaters and AlertPatcher resource. The JSON support is the appropriate serialization to use when integrating with OTP. The existing XML API was not consistent using attributes for some fields and elements for other fields, also some of the mapping code was custom to the XML, using something else than the JSON. So to simplify maintenance and readability the XML support is removed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9955f5ded36d308ab372adc2afe0113bb6c03b54", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9955f5ded36d308ab372adc2afe0113bb6c03b54", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Move the `index.model` API POJOs into the `api.model`. The Index API POJOs is not logically organized(some in `api` and some in `index`). This commit moves everything into one package, but we might extract ALL Index API POJOs into a separate package later."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6147aa4ffcf6105115d53718a835db35167b8b7b", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6147aa4ffcf6105115d53718a835db35167b8b7b", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Remove routerId from call to OTPServer.getRouter()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c77cdfe455a03f118296011f9c42d1dd72e1877c", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c77cdfe455a03f118296011f9c42d1dd72e1877c", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Add transfer mapper."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a711fe0eccd7c063f02637e2c2da61ef068dae71", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a711fe0eccd7c063f02637e2c2da61ef068dae71", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Encapsulate the internal index for agencies, stops, routes and Transfers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869fc2b80405d89be68dec97894f92831ffa5180", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/869fc2b80405d89be68dec97894f92831ffa5180", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Add a 'createRoutingRequestService' factory method to OTPServer to start hiding the graph."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f9f0660277b2cb88f8c70d90b29e46fae662eac", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/7f9f0660277b2cb88f8c70d90b29e46fae662eac", "committedDate": "2020-04-15T17:28:42Z", "message": "Clean Code - Cleanup modes in Route and TripPattern and add it to ApiRoute.\n  - Eliminate the old GtfsLibrary.getTraverseMode() and replace it with mapping done once.\n  - Cleanup in IndexAPI\n  - Fix OTP Client routId parsing error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "242796dbf825fff1c6125cb0e38d2c2d802a2fa7", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/242796dbf825fff1c6125cb0e38d2c2d802a2fa7", "committedDate": "2020-04-15T17:28:42Z", "message": "Make IndexAPI type-safe, improve validation and error handling and push business logic into RoutingService."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46e68d9497bbe079c252d92c11c93fdac0863f48", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/46e68d9497bbe079c252d92c11c93fdac0863f48", "committedDate": "2020-04-15T17:23:07Z", "message": "Make IndexAPI type-safe, improve validation and error handling and push business logic into RoutingService."}, "afterCommit": {"oid": "242796dbf825fff1c6125cb0e38d2c2d802a2fa7", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/242796dbf825fff1c6125cb0e38d2c2d802a2fa7", "committedDate": "2020-04-15T17:28:42Z", "message": "Make IndexAPI type-safe, improve validation and error handling and push business logic into RoutingService."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37f030286114434da609c27df421e976980473c0", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/37f030286114434da609c27df421e976980473c0", "committedDate": "2020-04-15T17:34:58Z", "message": "Merge branch 'dev-2.x' into otp2_api_types"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDQ0MzY2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#pullrequestreview-394444366", "createdAt": "2020-04-16T09:13:26Z", "commit": {"oid": "a711fe0eccd7c063f02637e2c2da61ef068dae71"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOToxMzoyN1rOGGcDtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOToxMzoyN1rOGGcDtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwNDM0Mg==", "bodyText": "Doc on this method, this is not threadsafe and is used by updaters.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3031#discussion_r409404342", "createdAt": "2020-04-16T09:13:27Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/routing/graph/GraphIndex.java", "diffHunk": "@@ -111,30 +105,68 @@ public GraphIndex (Graph graph) {\n         LOG.info(\"GraphIndex init complete.\");\n     }\n \n-  public Map<String, Map<String, Agency>> getAgenciesForFeedId() {\n-    return agenciesForFeedId;\n+  public Collection<Agency> getAgenciesForFeedId(String feedId) {\n+    return agenciesForFeedId.get(feedId);\n+  }\n+\n+  public Agency getAgency(String feedId, String agencyId) {\n+    for (Agency agency : agenciesForFeedId.get(feedId)) {\n+      if(agency.getId().equals(agencyId)) {\n+        return agency;\n+      }\n+    }\n+    return null;\n+  }\n+\n+  /**\n+   * Construct a set of all Agencies in this graph, spanning across all feed IDs. I am creating this\n+   * method only to allow merging pull request #2032 which adds GraphQL. This should probably be\n+   * done some other way, see javadoc on getAgencyWithoutFeedId.\n+   */\n+  public Collection<Agency> getAllAgencies() {\n+    return agenciesForFeedId.values();\n   }\n \n   public Map<FeedScopedId, Operator> getOperatorForId() {\n     return operatorForId;\n   }\n \n+  /**\n+   * Get a list of all operators spanning across all feeds.\n+   */\n+  public Collection<Operator> getAllOperators() {\n+    return getOperatorForId().values();\n+  }\n+\n   public Map<String, FeedInfo> getFeedInfoForId() {\n     return feedInfoForId;\n   }\n \n-  public Map<FeedScopedId, Stop> getStopForId() {\n-    return stopForId;\n+  public Stop getStopForId(FeedScopedId id) {\n+    return stopForId.get(id);\n+  }\n+\n+  public Collection<Stop> getAllStops() {\n+    return stopForId.values();\n   }\n \n   public Map<FeedScopedId, Trip> getTripForId() {\n     return tripForId;\n   }\n \n-  public Map<FeedScopedId, Route> getRouteForId() {\n-    return routeForId;\n+  public Route getRouteForId(FeedScopedId id) {\n+    return routeForId.get(id);\n+  }\n+\n+  public Collection<Route> getAllRoutes() {\n+    return routeForId.values();\n   }\n \n+  public void addRoutes(Route route) {\n+    routeForId.put(route.getId(), route);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a711fe0eccd7c063f02637e2c2da61ef068dae71"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "befda4c63e100d3c31e329028bd16766e77361ff", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/befda4c63e100d3c31e329028bd16766e77361ff", "committedDate": "2020-04-16T09:33:09Z", "message": "Merge branch 'dev-2.x' into otp2_api_types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0b645ed69b8f41d84f521725ea59de462e047f", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/bd0b645ed69b8f41d84f521725ea59de462e047f", "committedDate": "2020-04-16T09:41:14Z", "message": "Code review - add comment to GraphIndex.addRoutes(...)."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2096, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}