{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NDQ0OTgy", "number": 3233, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNjoxNlrOFAJ3Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo0MTowOVrOFCQIBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NzA1OTM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNjoxNlrOH-SkhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNjo0OFrOH-SnFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3ODAyMA==", "bodyText": "Rename to flexibleTrip", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r535078020", "createdAt": "2020-12-03T10:36:16Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,11 @@\n     */\n    public Boolean realTime = false;\n \n+  /**\n+   * Whether this Leg describes a flexible trip\n+   */\n+  public Boolean flexible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3ODY3OQ==", "bodyText": "Document that the reference to flexibleTrip is lost at this point", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r535078679", "createdAt": "2020-12-03T10:36:48Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,11 @@\n     */\n    public Boolean realTime = false;\n \n+  /**\n+   * Whether this Leg describes a flexible trip\n+   */\n+  public Boolean flexible = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3ODAyMA=="}, "originalCommit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NzEyODczOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDo0Njo1OFrOH-TSHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDo0Njo1OFrOH-TSHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4OTY5Mg==", "bodyText": "Check for otpFeature flexible (also in other places in the code)", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r535089692", "createdAt": "2020-12-03T10:46:58Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -168,9 +205,14 @@ public RoutingResponse route(Router router) {\n                 egressStops\n             );\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MzczMzg0OnYy", "diffSide": "RIGHT", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLPlanner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzowMzoyNlrOH_P_sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzowMzoyNlrOH_P_sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDQwMA==", "bodyText": "List.of() is preferred instead of Collections.emptyList()", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536084400", "createdAt": "2020-12-04T13:03:26Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLPlanner.java", "diffHunk": "@@ -188,15 +188,15 @@ private RoutingRequest createRequest(DataFetchingEnvironment environment) {\n             ElementWrapper<StreetMode> accessMode = new ElementWrapper<>();\n             ElementWrapper<StreetMode> egressMode = new ElementWrapper<>();\n             ElementWrapper<StreetMode> directMode = new ElementWrapper<>();\n-            ElementWrapper<ArrayList<TransitMode>> transitModes = new ElementWrapper<>();\n+            ElementWrapper<List<TransitMode>> transitModes = new ElementWrapper<>();\n             callWith.argument(\"modes.accessMode\", accessMode::set);\n             callWith.argument(\"modes.egressMode\", egressMode::set);\n             callWith.argument(\"modes.directMode\", directMode::set);\n             callWith.argument(\"modes.transportMode\", transitModes::set);\n \n             if (transitModes.get() == null) {\n-                // Default to all transport modes if transport modes not specified\n-                transitModes.set(new ArrayList<>(Arrays.asList(TransitMode.values())));\n+                // Default to no transport modes if transport modes not specified\n+                transitModes.set(Collections.emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MzczNzMxOnYy", "diffSide": "RIGHT", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/plan/ModeInputType.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzowNDoyMVrOH_QBoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzowNDoyMVrOH_QBoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDg5Nw==", "bodyText": "List.of()", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536084897", "createdAt": "2020-12-04T13:04:21Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/plan/ModeInputType.java", "diffHunk": "@@ -41,9 +46,10 @@\n       .field(GraphQLInputObjectField\n           .newInputObjectField()\n           .name(\"transportMode\")\n+          .defaultValue(Collections.emptyList())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2Mzk4Nzc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDowMzo0OFrOH_SQrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODoyOToxOFrOIAbIlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMTUxOQ==", "bodyText": "The routeTransit should give an overview of the transit routing - and delegate as much of the business logic as possible - the FLEX now complicate to main logic a lot and if we introduced another similar concept then it would become hard to understand. Also, people who do not care about FLEX should be able to skip all flex code. The new code in this method is not at the same abstraction level and it need to refactored out. Some of it should maybe be pushed to other classes and some into methods in this class. Enums are compared by equals. Also, the flow is very hard to follow, the check on mode is/is not FLEX is probably a business concept (not DRY) witch should have a name.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536121519", "createdAt": "2020-12-04T14:03:48Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();\n \n         List<Itinerary> itineraries = new ArrayList<>();\n \n-        if (OTPFeature.FlexRouting.isOn() && request.modes.transitModes.contains(TransitMode.FLEXIBLE)) {\n-            FlexRouter flexRouter = new FlexRouter(\n-                request.rctx.graph,\n-                request.getDateTime().toInstant(),\n-                request.arriveBy,\n-                ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n-                ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n-                accessStops,\n-                egressStops\n-            );\n+        // Add non-flex access transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+            accessTransfers.addAll(accessEgressMapper.mapNearbyStops(accessStops, false));\n+        }\n+        // Add non-flex egress transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+            egressTransfers.addAll(accessEgressMapper.mapNearbyStops(egressStops, true));\n+        }\n \n-            itineraries.addAll(flexRouter.createFlexOnlyItineraries());\n-            accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n-            egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+        if (OTPFeature.FlexRouting.isOn()) {\n+            if (request.modes.contains(StreetMode.FLEXIBLE)) {\n+                FlexRouter flexRouter = new FlexRouter(\n+                    request.rctx.graph,\n+                    request.getDateTime().toInstant(),\n+                    request.arriveBy,\n+                    ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n+                    ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n+                    accessStops,\n+                    egressStops\n+                );\n+\n+                // Add flex access transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+                    accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n+                }\n+                // Add flex egress transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+                    egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMxNTQ3Nw==", "bodyText": "I have refactored out some of the access/egress logic for flex. I had to duplicate some code, as the flex access/egress search requires a regular access/egress search as input. It might be that a few lines of duplicated code is better than combining the logic for flex access/egress and regular access/egress.\nI still does look somewhat complicated, because you need to perform a check on access and egress separately, to see if you should use the flex logic or the regular logic. Still, it is more readable than what it was before.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537315477", "createdAt": "2020-12-07T08:29:18Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();\n \n         List<Itinerary> itineraries = new ArrayList<>();\n \n-        if (OTPFeature.FlexRouting.isOn() && request.modes.transitModes.contains(TransitMode.FLEXIBLE)) {\n-            FlexRouter flexRouter = new FlexRouter(\n-                request.rctx.graph,\n-                request.getDateTime().toInstant(),\n-                request.arriveBy,\n-                ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n-                ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n-                accessStops,\n-                egressStops\n-            );\n+        // Add non-flex access transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+            accessTransfers.addAll(accessEgressMapper.mapNearbyStops(accessStops, false));\n+        }\n+        // Add non-flex egress transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+            egressTransfers.addAll(accessEgressMapper.mapNearbyStops(egressStops, true));\n+        }\n \n-            itineraries.addAll(flexRouter.createFlexOnlyItineraries());\n-            accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n-            egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+        if (OTPFeature.FlexRouting.isOn()) {\n+            if (request.modes.contains(StreetMode.FLEXIBLE)) {\n+                FlexRouter flexRouter = new FlexRouter(\n+                    request.rctx.graph,\n+                    request.getDateTime().toInstant(),\n+                    request.arriveBy,\n+                    ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n+                    ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n+                    accessStops,\n+                    egressStops\n+                );\n+\n+                // Add flex access transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+                    accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n+                }\n+                // Add flex egress transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+                    egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+                }\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMTUxOQ=="}, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDAxODE2OnYy", "diffSide": "RIGHT", "path": "src/client/js/otp/config.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoxMDo1MlrOH_SiZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoxMDo1MlrOH_SiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyNjA1NQ==", "bodyText": "This should be listed after all bicycle options. This will also make the text appear in a more natural order in the translation files above.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536126055", "createdAt": "2020-12-04T14:10:52Z", "author": {"login": "t2gran"}, "path": "src/client/js/otp/config.js", "diffHunk": "@@ -316,6 +316,14 @@ otp.config.modes = {\n     \"CAR,WALK,TRANSIT\"          : _tr('Kiss and Ride'),\n     //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n     \"BICYCLE_PARK,WALK,TRANSIT\" : _tr('Bike and Ride'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_ACCESS,WALK,TRANSIT\" : _tr('Transit with flex access'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_EGRESS,WALK,TRANSIT\" : _tr('Transit with flex egress'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_ACCESS,FLEX_EGRESS,TRANSIT\" : _tr('Transit with flex access and egress'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_DIRECT\" : _tr('Direct flex search'),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDA2MjEyOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyMDozOVrOH_S79w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODoyNjoxOFrOIAbBcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzMjU5OQ==", "bodyText": "accessTransfers is not a good name, maybe accessListTransit or accessToTransit ?", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536132599", "createdAt": "2020-12-04T14:20:39Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMxMzY0OQ==", "bodyText": "I have renamed them to accessList and egressList, but it is hard to find a name that fits.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537313649", "createdAt": "2020-12-07T08:26:18Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzMjU5OQ=="}, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzcyNTkxOnYy", "diffSide": "RIGHT", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/TripTimeShortHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMTo1OTowMlrOIAjaKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowNzozMlrOIAjunA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MTA1MA==", "bodyText": "Below there is some code that is commented out, should that be deleted or is this just a temporary guard, in witch case there should probably be a comment here telling why we can retrieve this info on a FLEX trip.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537451050", "createdAt": "2020-12-07T11:59:02Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/TripTimeShortHelper.java", "diffHunk": "@@ -23,6 +23,7 @@ private TripTimeShortHelper() { }\n     @Nullable\n     public static TripTimeShort getTripTimeShortForFromPlace(Leg leg, RoutingService routingService) {\n         if (!leg.isTransitLeg()) { return null; }\n+        if (leg.isFlexibleTrip()) { return null; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NjI4NA==", "bodyText": "This is used to retrieve information to populate the estimateCall for to/from place. We have to decide if the EstimatedCallType is applicable to flexible trips. I can add a comment about it.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537456284", "createdAt": "2020-12-07T12:07:32Z", "author": {"login": "gmellemstrand"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/TripTimeShortHelper.java", "diffHunk": "@@ -23,6 +23,7 @@ private TripTimeShortHelper() { }\n     @Nullable\n     public static TripTimeShort getTripTimeShortForFromPlace(Leg leg, RoutingService routingService) {\n         if (!leg.isTransitLeg()) { return null; }\n+        if (leg.isFlexibleTrip()) { return null; }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MTA1MA=="}, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzczOTc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowMjoyOFrOIAjiZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowMjoyOFrOIAjiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzE1OQ==", "bodyText": "This is redundant, the field is public", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537453159", "createdAt": "2020-12-07T12:02:28Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -193,6 +200,10 @@ public boolean isOnStreetNonTransit() {\n         return mode.isOnStreetNonTransit();\n     }\n \n+    public boolean isFlexibleTrip() {\n+     return flexibleTrip;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Mzg1MjY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozMTowOVrOIAki9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozMTowOVrOIAki9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTY4NA==", "bodyText": "These 2 parameters are passed inn with the request in several places, if we move them to the request they no longer need to be passed in. This would also make these parameters configurable.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537469684", "createdAt": "2020-12-07T12:31:09Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -96,6 +98,20 @@ public RoutingResponse route(Router router) {\n             routingErrors.addAll(e.getRoutingErrors());\n         }\n \n+        // Direct flex routing\n+        if (OTPFeature.FlexRouting.isOn()) {\n+            try {\n+                itineraries.addAll(DirectFlexRouter.route(\n+                    request,\n+                    ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n+                    ADDITIONAL_SEARCH_DAYS_AFTER_TODAY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3ODk1NzA4OnYy", "diffSide": "RIGHT", "path": "src/ext/java/org/opentripplanner/ext/flex/FlexRouter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyMzoyOVrOIBSDJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoxNDowMlrOICM0lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxNTIwNg==", "bodyText": "Check how many itineraries are initially created here, and if we should prevent that from happening earlier.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538215206", "createdAt": "2020-12-08T10:23:29Z", "author": {"login": "gmellemstrand"}, "path": "src/ext/java/org/opentripplanner/ext/flex/FlexRouter.java", "diffHunk": "@@ -95,21 +96,32 @@ public FlexRouter(\n \n     Set<StopLocation> egressStops = streetEgressByStop.keySet();\n \n-    Collection<Itinerary> itineraries = new ArrayList<>();\n+    Map<FlexTrip, Itinerary> itinerariesByTrip = new HashMap<>();\n \n     for (FlexAccessTemplate template : this.flexAccessTemplates) {\n       StopLocation transferStop = template.getTransferStop();\n+      FlexTrip trip = template.getFlexTrip();\n       if (egressStops.contains(transferStop)) {\n-        for(NearbyStop egress : streetEgressByStop.get(transferStop)) {\n-          Itinerary itinerary = template.createDirectItinerary(egress, arriveBy, departureTime, startOfTime);\n-          if (itinerary != null) {\n-            itineraries.add(itinerary);\n+        for (NearbyStop egress : streetEgressByStop.get(transferStop)) {\n+          Itinerary itinerary = template.createDirectItinerary(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3ODEzNA==", "bodyText": "This has been reverted, and will probably be part of the filtering in a future PR.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r539178134", "createdAt": "2020-12-09T10:14:02Z", "author": {"login": "gmellemstrand"}, "path": "src/ext/java/org/opentripplanner/ext/flex/FlexRouter.java", "diffHunk": "@@ -95,21 +96,32 @@ public FlexRouter(\n \n     Set<StopLocation> egressStops = streetEgressByStop.keySet();\n \n-    Collection<Itinerary> itineraries = new ArrayList<>();\n+    Map<FlexTrip, Itinerary> itinerariesByTrip = new HashMap<>();\n \n     for (FlexAccessTemplate template : this.flexAccessTemplates) {\n       StopLocation transferStop = template.getTransferStop();\n+      FlexTrip trip = template.getFlexTrip();\n       if (egressStops.contains(transferStop)) {\n-        for(NearbyStop egress : streetEgressByStop.get(transferStop)) {\n-          Itinerary itinerary = template.createDirectItinerary(egress, arriveBy, departureTime, startOfTime);\n-          if (itinerary != null) {\n-            itineraries.add(itinerary);\n+        for (NearbyStop egress : streetEgressByStop.get(transferStop)) {\n+          Itinerary itinerary = template.createDirectItinerary(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxNTIwNg=="}, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3ODk3NzQ4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/api/parameter/Qualifier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyNzo1M1rOIBSO4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyNzo1M1rOIBSO4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxODIwOA==", "bodyText": "These can be deleted", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538218208", "createdAt": "2020-12-08T10:27:53Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/api/parameter/Qualifier.java", "diffHunk": "@@ -1,5 +1,32 @@\n package org.opentripplanner.api.parameter;\n \n public enum Qualifier {\n-  RENT, HAVE, PARK, KEEP, PICKUP, DROPOFF\n+  /** The vehicle has to be rented */\n+  RENT,\n+  @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3OTAwNzM1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozMjo1N1rOIBSgcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDozMDozNlrOICNhiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMjcwNQ==", "bodyText": "Ask @hannesj Why FlexTrip does not extend Trip", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538222705", "createdAt": "2020-12-08T10:32:57Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,13 @@\n     */\n    public Boolean realTime = false;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4OTY0MA==", "bodyText": "I had a discussion with Hannes about this, and he agreed that it would probably be a good idea to have FlexTrip extend Trip. It is not quite straightforward, so we can handle it in another PR.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r539189640", "createdAt": "2020-12-09T10:30:36Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,13 @@\n     */\n    public Boolean realTime = false;\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMjcwNQ=="}, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3OTA1NjY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/router/street/FlexAccessEgressRouter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo0MTowOVrOIBS9mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo0MTowOVrOIBS9mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIzMDE3MQ==", "bodyText": "Formatting", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538230171", "createdAt": "2020-12-08T10:41:09Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/router/street/FlexAccessEgressRouter.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.opentripplanner.routing.algorithm.raptor.router.street;\n+\n+import org.opentripplanner.ext.flex.FlexAccessEgress;\n+import org.opentripplanner.ext.flex.FlexRouter;\n+import org.opentripplanner.routing.api.request.RoutingRequest;\n+import org.opentripplanner.routing.api.request.StreetMode;\n+import org.opentripplanner.routing.graphfinder.NearbyStop;\n+\n+import java.util.Collection;\n+import java.util.List;\n+\n+public class FlexAccessEgressRouter {\n+\n+  private FlexAccessEgressRouter() {}\n+\n+  public static Collection<FlexAccessEgress> routeAccessEgress(\n+      RoutingRequest request,\n+      boolean isEgress\n+  ) {\n+\n+    Collection<NearbyStop> accessStops = !isEgress ? AccessEgressRouter.streetSearch(request,\n+        StreetMode.WALK,\n+        false,\n+        2000\n+    ) : List.of();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1716, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}