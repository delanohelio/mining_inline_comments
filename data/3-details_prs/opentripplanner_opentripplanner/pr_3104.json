{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDcxMTE0", "number": 3104, "title": "Clean-up Itinerary filters, fixing the Pattern loop problem", "bodyText": "This PR:\n\nFixes the problem with looping patterns in issue #3091\nClean up the CostCalculator method parameters to prepare for alternative CostCalculators.\nClean up ItineraryFilterChain unit tests.\nMerge GroupByLegDistanceFilter and ReduceTimeTableVariationFilter into GroupBySimilarLegsFilter.\nMake the GroupBySimilarLegsFilter configurable using the router-config.json.\n\nTo be completed by pull request submitter:\n\n issue: closes #3091\n roadmap: No - Bugfix/refactor\n tests: Unit-test for itinerary filterting is cleaned up\n formatting: yes\n documentation: JavaDoc is added to the RoutingRequest for configurable filters - this is referenced in the configuration.md doc.\n changelog: Not added.\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-06-16T08:54:33Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104", "merged": true, "mergeCommit": {"oid": "c44d8a84b8ccc83032e34a36d6d7ec815b7f0e06"}, "closed": true, "closedAt": "2020-06-24T07:39:24Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrj9beAH2gAyNDM1MDcxMTE0OjkwN2FiNjUwNTYzMTJhMmE2OTI2YjFkYjFkMTFmY2M3MTE2OGM5MGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuUzMYgFqTQzNjM4NjE1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "907ab65056312a2a6926b1db1d11fcc71168c90c", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/907ab65056312a2a6926b1db1d11fcc71168c90c", "committedDate": "2020-06-15T17:18:36Z", "message": "Log system errors with stacktrace. These errors are critical and should be fixed.\nLogging the cause is critical to be able to fix them - even if this mean opening up\nthe system to security risks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "727eef52592c7c39961a648d6c0bff505e13c9b0", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/727eef52592c7c39961a648d6c0bff505e13c9b0", "committedDate": "2020-06-15T17:28:11Z", "message": "Simplify ToStringBuilder, take away unused list and exclude ignored values, not default values."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb8338af588fa14471d38b5f958e6f95aee82a7", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ceb8338af588fa14471d38b5f958e6f95aee82a7", "committedDate": "2020-06-15T17:32:45Z", "message": "Minor bugfix in toString for itinerary."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de9ea1fc56bb83518e03d3860f54ae5b3bc19a22", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/de9ea1fc56bb83518e03d3860f54ae5b3bc19a22", "committedDate": "2020-06-15T18:15:27Z", "message": "Clean code - refactor CostCalculator so the interface is not so specific to the calculation of today's generalized-cost. This will allow us to create other calculators to introduce other criteria later."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f11dc3eb3ff48cf395134d0b0a7d9bf4c81139", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/79f11dc3eb3ff48cf395134d0b0a7d9bf4c81139", "committedDate": "2020-06-15T23:48:23Z", "message": "- Prepare to configure filter-chain by extracting a parameters interface to be able to inject parameters later.\n- Merge GroupByLegDistanceFilter and ReduceTimeTableVariationFilter into GroupBySimilarLegsFilter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9f4a379d7637b1bb84f91b5ca0d66af67a3106", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3f9f4a379d7637b1bb84f91b5ca0d66af67a3106", "committedDate": "2020-06-16T00:50:09Z", "message": "Make the GroupBySimilarLegsFilter configurable using the `router-config.json`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c88d57113454db1c9e3bc522eabac31e04795db1", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c88d57113454db1c9e3bc522eabac31e04795db1", "committedDate": "2020-06-16T08:55:43Z", "message": "Merge branch 'dev-2.x' into otp2_trip_to_trip_cost"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "435ccc9ed0b9af4a5dc3474fb952091a8e1c7556", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/435ccc9ed0b9af4a5dc3474fb952091a8e1c7556", "committedDate": "2020-06-18T09:07:43Z", "message": "Merge branch 'dev-2.x' into otp2_trip_to_trip_cost"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMTE2NjA3", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104#pullrequestreview-433116607", "createdAt": "2020-06-18T09:44:24Z", "commit": {"oid": "435ccc9ed0b9af4a5dc3474fb952091a8e1c7556"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTo0NDoyNFrOGln11g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTo0NDoyNFrOGln11g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMzI1NA==", "bodyText": "Use the to/from stopIndex, also fix the itinerary mapper.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104#discussion_r442103254", "createdAt": "2020-06-18T09:44:24Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -244,19 +244,22 @@ public void addAlertPatch(AlertPatch alertPatch) {\n     }\n \n     /**\n-     * Compare to legs to determine if they start and end at the same place and time.\n-     *\n-     * Note! Properties like mode and trip is NOT considered.\n+     * Return {@code true} if to legs ride the same trip(same tripId) and at least part of the\n+     * rides overlap in time.\n      */\n-    public boolean sameStartAndEnd(Leg other) {\n-        if (this == other) { return true; }\n-        return startTime.equals(other.startTime)\n-                && endTime.equals(other.endTime)\n-                && from.sameLocation(other.from)\n-                && to.sameLocation(other.to);\n+    public boolean isPartiallySameTransitLeg(Leg other) {\n+      // Assert both legs are transit legs\n+      if(!isTransitLeg() || !other.isTransitLeg()) { throw new IllegalStateException(); }\n+\n+      // If NOT the same trip, return false\n+      if(!tripId.equals(other.tripId)) { return false; }\n+\n+      // If not riding at least part of the same stretch of the trip.\n+      // If a pattern goes in a loop, this make sure two legs are riding the trip in the same loop.\n+      return startTime.before(other.endTime) && endTime.after(other.startTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "435ccc9ed0b9af4a5dc3474fb952091a8e1c7556"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc5ca8c12fef15cc65458e26177746a7faf0f6d", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/dcc5ca8c12fef15cc65458e26177746a7faf0f6d", "committedDate": "2020-06-18T11:53:26Z", "message": "Change the code for testing if to legs overlap from using departure/arrival time to using the rout stop index instead. In some cases two sequential stops may have the same departure time, same minute departure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde99e9807ec2882a30335ae2e73410333a51191", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fde99e9807ec2882a30335ae2e73410333a51191", "committedDate": "2020-06-18T14:23:02Z", "message": "Bugfix - The Itinerary mapper did not account for the same departure time for multiple stops in a pattern, it would resolve the stopIndex incorrect. This commit fixes this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "380c55fc87aad47317896d6f8f024d40465f0f09", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/380c55fc87aad47317896d6f8f024d40465f0f09", "committedDate": "2020-06-23T14:31:23Z", "message": "Unit test on Itinerary added, JavaDoc on TestItineraryBuilder, and make sure the place#stopIndex is set in a correct, consistent way in unit-tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Mzg2MTU0", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104#pullrequestreview-436386154", "createdAt": "2020-06-24T07:20:37Z", "commit": {"oid": "380c55fc87aad47317896d6f8f024d40465f0f09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2139, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}