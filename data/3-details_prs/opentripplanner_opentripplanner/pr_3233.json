{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NDQ0OTgy", "number": 3233, "title": "Specify flex as StreetMode instead of TransportMode", "bodyText": "To be completed by pull request submitter:\n\n issue: Link to or create an issue that describes the relevant feature or bug. Add GitHub keywords to this PR's description (e.g., closes #45).\n roadmap: Check the roadmap for this feature or bug. If it is not already on the roadmap, PLC will discuss as part of the review process.\n tests: Have you added relevant test coverage? Are all the tests passing on the continuous integration service (Travis CI)?\n formatting: Have you followed the suggested code style?\n documentation: If you are adding a new configuration option, have you added an explanation to the configuration documentation tables and sections?\n changelog: add a bullet point to the changelog file with description and link to the linked issue\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-11-04T15:04:26Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233", "merged": true, "mergeCommit": {"oid": "78e21926c7b9fd90c815f25c764ffd0df9b551af"}, "closed": true, "closedAt": "2020-12-15T09:19:10Z", "author": {"login": "gmellemstrand"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZiko4AH2gAyNTE1NDQ0OTgyOmIzNmY4MmE5MTY2M2M4YmNhOTNkYzRiYTQ5YTNkOGI4NjRmMTFlYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmWxufgFqTU1MjI0NzgyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b36f82a91663c8bca93dc4ba49a3d8b864f11ea2", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b36f82a91663c8bca93dc4ba49a3d8b864f11ea2", "committedDate": "2020-11-05T13:42:08Z", "message": "Specify flex as StreetMode instead of TransportMode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eba997f9b476219c19debae7a5a4eb4372a66f5", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0eba997f9b476219c19debae7a5a4eb4372a66f5", "committedDate": "2020-11-05T13:43:01Z", "message": "Only add the earliest itinerary per trip for direct flex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0565374bc489f26f936daa9bd9d361af6350a5a8", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0565374bc489f26f936daa9bd9d361af6350a5a8", "committedDate": "2020-11-10T08:43:23Z", "message": "Merge branch 'dev-2.x' into otp2_flex_as_streetmode"}, "afterCommit": {"oid": "0eba997f9b476219c19debae7a5a4eb4372a66f5", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0eba997f9b476219c19debae7a5a4eb4372a66f5", "committedDate": "2020-11-05T13:43:01Z", "message": "Only add the earliest itinerary per trip for direct flex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de919f80ad88a0bd38f7e4095de3054a52102ce6", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/de919f80ad88a0bd38f7e4095de3054a52102ce6", "committedDate": "2020-11-13T13:09:42Z", "message": "Update documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15cefca9c15421cc0eb8b2ca284b24e3646bcfab", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/15cefca9c15421cc0eb8b2ca284b24e3646bcfab", "committedDate": "2020-11-16T09:58:01Z", "message": "Set default RequestModes to access/egress/direct walk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bbd037a2ec3aaa042286f7028fee12a739c62ad", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/4bbd037a2ec3aaa042286f7028fee12a739c62ad", "committedDate": "2020-11-16T09:59:47Z", "message": "Remove obsolete code in TransmodelGraphQLPlanner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9abd20a5a8345d6feb0aa9eb0094fab54063a382", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9abd20a5a8345d6feb0aa9eb0094fab54063a382", "committedDate": "2020-11-16T11:12:53Z", "message": "Default TransportModes to empty list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6af58293ca99532c77bb310ee73d04f4c971b963", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6af58293ca99532c77bb310ee73d04f4c971b963", "committedDate": "2020-11-16T11:15:52Z", "message": "Merge branch 'dev-2.x' into otp2_flex_as_streetmode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abb0163345fda14391246b61319cb9ad90a36026", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/abb0163345fda14391246b61319cb9ad90a36026", "committedDate": "2020-11-16T14:56:43Z", "message": "Typo in FLEXEGRESS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "685e142f49df00e77037b4f4f28dd2144b1633e1", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/685e142f49df00e77037b4f4f28dd2144b1633e1", "committedDate": "2020-12-02T10:51:00Z", "message": "Merge branch 'dev-2.x' into otp2_flex_as_streetmode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6b5148ee63c8770638ba936ebaa2e08a22050545", "committedDate": "2020-12-02T14:21:03Z", "message": "Do not return TripTimesShort from flexible Legs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODE4ODI2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-543818826", "createdAt": "2020-12-03T10:36:15Z", "commit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNjoxNlrOH-SkhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNjoxNlrOH-SkhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3ODAyMA==", "bodyText": "Rename to flexibleTrip", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r535078020", "createdAt": "2020-12-03T10:36:16Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,11 @@\n     */\n    public Boolean realTime = false;\n \n+  /**\n+   * Whether this Leg describes a flexible trip\n+   */\n+  public Boolean flexible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODI3Mzcw", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-543827370", "createdAt": "2020-12-03T10:46:58Z", "commit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDo0Njo1OFrOH-TSHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDo0Njo1OFrOH-TSHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4OTY5Mg==", "bodyText": "Check for otpFeature flexible (also in other places in the code)", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r535089692", "createdAt": "2020-12-03T10:46:58Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -168,9 +205,14 @@ public RoutingResponse route(Router router) {\n                 egressStops\n             );\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5148ee63c8770638ba936ebaa2e08a22050545"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e8e3107ce17dc1f0e7a254697f96dd33281b4c", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/27e8e3107ce17dc1f0e7a254697f96dd33281b4c", "committedDate": "2020-12-04T10:16:33Z", "message": "Rename flexible to flexibleTrip and document"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3414ec557df7a33ca7392662ac1bfdb305679a2e", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3414ec557df7a33ca7392662ac1bfdb305679a2e", "committedDate": "2020-12-04T10:19:26Z", "message": "Add checks if OTPFeature flexRouting is on"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50c01b6a789d6949310619888558ac50dc9949e", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f50c01b6a789d6949310619888558ac50dc9949e", "committedDate": "2020-12-04T11:04:06Z", "message": "Merge branch 'dev-2.x' into otp2_flex_as_streetmode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e256b117240a66dcf845931b1e68cf5fd4acd00b", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e256b117240a66dcf845931b1e68cf5fd4acd00b", "committedDate": "2020-12-04T12:09:39Z", "message": "Change flex access/egress/direct to be qualified modes in rest api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/121b67c848403e87ad217bfd6cd5153004b287c5", "committedDate": "2020-12-04T12:14:45Z", "message": "Update translations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTM5MzA3", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-544939307", "createdAt": "2020-12-04T13:03:25Z", "commit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzowMzoyNlrOH_P_sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoxMDo1MlrOH_SiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDQwMA==", "bodyText": "List.of() is preferred instead of Collections.emptyList()", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536084400", "createdAt": "2020-12-04T13:03:26Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLPlanner.java", "diffHunk": "@@ -188,15 +188,15 @@ private RoutingRequest createRequest(DataFetchingEnvironment environment) {\n             ElementWrapper<StreetMode> accessMode = new ElementWrapper<>();\n             ElementWrapper<StreetMode> egressMode = new ElementWrapper<>();\n             ElementWrapper<StreetMode> directMode = new ElementWrapper<>();\n-            ElementWrapper<ArrayList<TransitMode>> transitModes = new ElementWrapper<>();\n+            ElementWrapper<List<TransitMode>> transitModes = new ElementWrapper<>();\n             callWith.argument(\"modes.accessMode\", accessMode::set);\n             callWith.argument(\"modes.egressMode\", egressMode::set);\n             callWith.argument(\"modes.directMode\", directMode::set);\n             callWith.argument(\"modes.transportMode\", transitModes::set);\n \n             if (transitModes.get() == null) {\n-                // Default to all transport modes if transport modes not specified\n-                transitModes.set(new ArrayList<>(Arrays.asList(TransitMode.values())));\n+                // Default to no transport modes if transport modes not specified\n+                transitModes.set(Collections.emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDg5Nw==", "bodyText": "List.of()", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536084897", "createdAt": "2020-12-04T13:04:21Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/plan/ModeInputType.java", "diffHunk": "@@ -41,9 +46,10 @@\n       .field(GraphQLInputObjectField\n           .newInputObjectField()\n           .name(\"transportMode\")\n+          .defaultValue(Collections.emptyList())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMTUxOQ==", "bodyText": "The routeTransit should give an overview of the transit routing - and delegate as much of the business logic as possible - the FLEX now complicate to main logic a lot and if we introduced another similar concept then it would become hard to understand. Also, people who do not care about FLEX should be able to skip all flex code. The new code in this method is not at the same abstraction level and it need to refactored out. Some of it should maybe be pushed to other classes and some into methods in this class. Enums are compared by equals. Also, the flow is very hard to follow, the check on mode is/is not FLEX is probably a business concept (not DRY) witch should have a name.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536121519", "createdAt": "2020-12-04T14:03:48Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();\n \n         List<Itinerary> itineraries = new ArrayList<>();\n \n-        if (OTPFeature.FlexRouting.isOn() && request.modes.transitModes.contains(TransitMode.FLEXIBLE)) {\n-            FlexRouter flexRouter = new FlexRouter(\n-                request.rctx.graph,\n-                request.getDateTime().toInstant(),\n-                request.arriveBy,\n-                ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n-                ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n-                accessStops,\n-                egressStops\n-            );\n+        // Add non-flex access transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+            accessTransfers.addAll(accessEgressMapper.mapNearbyStops(accessStops, false));\n+        }\n+        // Add non-flex egress transfers\n+        if (!StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+            egressTransfers.addAll(accessEgressMapper.mapNearbyStops(egressStops, true));\n+        }\n \n-            itineraries.addAll(flexRouter.createFlexOnlyItineraries());\n-            accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n-            egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+        if (OTPFeature.FlexRouting.isOn()) {\n+            if (request.modes.contains(StreetMode.FLEXIBLE)) {\n+                FlexRouter flexRouter = new FlexRouter(\n+                    request.rctx.graph,\n+                    request.getDateTime().toInstant(),\n+                    request.arriveBy,\n+                    ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n+                    ADDITIONAL_SEARCH_DAYS_AFTER_TODAY,\n+                    accessStops,\n+                    egressStops\n+                );\n+\n+                // Add flex access transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.accessMode)) {\n+                    accessTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexAccesses()));\n+                }\n+                // Add flex egress transfers\n+                if (StreetMode.FLEXIBLE.equals(request.modes.egressMode)) {\n+                    egressTransfers.addAll(accessEgressMapper.mapFlexAccessEgresses(flexRouter.createFlexEgresses()));\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyNjA1NQ==", "bodyText": "This should be listed after all bicycle options. This will also make the text appear in a more natural order in the translation files above.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536126055", "createdAt": "2020-12-04T14:10:52Z", "author": {"login": "t2gran"}, "path": "src/client/js/otp/config.js", "diffHunk": "@@ -316,6 +316,14 @@ otp.config.modes = {\n     \"CAR,WALK,TRANSIT\"          : _tr('Kiss and Ride'),\n     //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n     \"BICYCLE_PARK,WALK,TRANSIT\" : _tr('Bike and Ride'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_ACCESS,WALK,TRANSIT\" : _tr('Transit with flex access'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_EGRESS,WALK,TRANSIT\" : _tr('Transit with flex egress'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_ACCESS,FLEX_EGRESS,TRANSIT\" : _tr('Transit with flex access and egress'),\n+    //TRANSLATORS: Travel by: mode of transport (Used in selection in Travel Options widgets)\n+    \"FLEX_DIRECT\" : _tr('Direct flex search'),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTk4Njc4", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-544998678", "createdAt": "2020-12-04T14:20:39Z", "commit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyMDozOVrOH_S79w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyMDozOVrOH_S79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzMjU5OQ==", "bodyText": "accessTransfers is not a good name, maybe accessListTransit or accessToTransit ?", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r536132599", "createdAt": "2020-12-04T14:20:39Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -148,29 +164,59 @@ public RoutingResponse route(Router router) {\n         this.debugAggregator.finishedPatternFiltering();\n \n         // Prepare access/egress transfers\n-        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(request, false, 2000);\n-        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(request, true, 2000);\n+        Collection<NearbyStop> accessStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.accessMode)\n+                ? StreetMode.WALK\n+                : request.modes.accessMode,\n+            false,\n+            2000\n+        );\n+        Collection<NearbyStop> egressStops = AccessEgressRouter.streetSearch(\n+            request,\n+            StreetMode.FLEXIBLE.equals(request.modes.egressMode)\n+                ? StreetMode.WALK\n+                : request.modes.egressMode,\n+            true,\n+            2000\n+        );\n \n         AccessEgressMapper accessEgressMapper = new AccessEgressMapper(transitLayer.getStopIndex());\n-        Collection<AccessEgress> accessTransfers = accessEgressMapper.mapNearbyStops(accessStops, false);\n-        Collection<AccessEgress> egressTransfers = accessEgressMapper.mapNearbyStops(egressStops, true);\n+        Collection<AccessEgress> accessTransfers = new ArrayList<>();\n+        Collection<AccessEgress> egressTransfers = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121b67c848403e87ad217bfd6cd5153004b287c5"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5847850b555be40f954c85ec84b6a318aadcbfe0", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5847850b555be40f954c85ec84b6a318aadcbfe0", "committedDate": "2020-12-04T15:17:08Z", "message": "Separate flex access/egress routing more from the rest of the routing code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6cfda2c1f6e990541e2ee9107e6f50d2d72c1a3", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c6cfda2c1f6e990541e2ee9107e6f50d2d72c1a3", "committedDate": "2020-12-07T08:11:29Z", "message": "Use List.of and formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea9917e3b736603d93f8d3b94e86298e7351f2d", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/dea9917e3b736603d93f8d3b94e86298e7351f2d", "committedDate": "2020-12-07T08:23:52Z", "message": "Change order of modes in built-in client and update translations again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9fa6a6f39c0f42b694001e166e12737239fc5bd7", "committedDate": "2020-12-07T09:12:34Z", "message": "Add javadoc to Qualifier, remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDgxMjUy", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-546081252", "createdAt": "2020-12-07T11:59:02Z", "commit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMTo1OTowMlrOIAjaKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMTo1OTowMlrOIAjaKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MTA1MA==", "bodyText": "Below there is some code that is commented out, should that be deleted or is this just a temporary guard, in witch case there should probably be a comment here telling why we can retrieve this info on a FLEX trip.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537451050", "createdAt": "2020-12-07T11:59:02Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/TripTimeShortHelper.java", "diffHunk": "@@ -23,6 +23,7 @@ private TripTimeShortHelper() { }\n     @Nullable\n     public static TripTimeShort getTripTimeShortForFromPlace(Leg leg, RoutingService routingService) {\n         if (!leg.isTransitLeg()) { return null; }\n+        if (leg.isFlexibleTrip()) { return null; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDgzNzE5", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-546083719", "createdAt": "2020-12-07T12:02:28Z", "commit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowMjoyOFrOIAjiZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowMjoyOFrOIAjiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzE1OQ==", "bodyText": "This is redundant, the field is public", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537453159", "createdAt": "2020-12-07T12:02:28Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -193,6 +200,10 @@ public boolean isOnStreetNonTransit() {\n         return mode.isOnStreetNonTransit();\n     }\n \n+    public boolean isFlexibleTrip() {\n+     return flexibleTrip;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTAzMzA4", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-546103308", "createdAt": "2020-12-07T12:31:09Z", "commit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozMTowOVrOIAki9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozMTowOVrOIAki9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTY4NA==", "bodyText": "These 2 parameters are passed inn with the request in several places, if we move them to the request they no longer need to be passed in. This would also make these parameters configurable.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r537469684", "createdAt": "2020-12-07T12:31:09Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/RoutingWorker.java", "diffHunk": "@@ -96,6 +98,20 @@ public RoutingResponse route(Router router) {\n             routingErrors.addAll(e.getRoutingErrors());\n         }\n \n+        // Direct flex routing\n+        if (OTPFeature.FlexRouting.isOn()) {\n+            try {\n+                itineraries.addAll(DirectFlexRouter.route(\n+                    request,\n+                    ADDITIONAL_SEARCH_DAYS_BEFORE_TODAY,\n+                    ADDITIONAL_SEARCH_DAYS_AFTER_TODAY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fa6a6f39c0f42b694001e166e12737239fc5bd7"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22f009b6b6a2c57567fb4e7d48bd4f1b8f19b39", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f22f009b6b6a2c57567fb4e7d48bd4f1b8f19b39", "committedDate": "2020-12-07T17:32:07Z", "message": "Todo about TripTimeShortHelper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb2f31e7d52f7ac4256393b855f4b1dc7f9764f", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9cb2f31e7d52f7ac4256393b855f4b1dc7f9764f", "committedDate": "2020-12-07T17:35:26Z", "message": "Remove getter for public field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/bd195ac288219c2403ae8570fcc5646960a0459e", "committedDate": "2020-12-07T17:41:39Z", "message": "Move additional search days configuration to RoutingRequest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDM2NDc2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-547036476", "createdAt": "2020-12-08T10:23:29Z", "commit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyMzoyOVrOIBSDJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyMzoyOVrOIBSDJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxNTIwNg==", "bodyText": "Check how many itineraries are initially created here, and if we should prevent that from happening earlier.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538215206", "createdAt": "2020-12-08T10:23:29Z", "author": {"login": "gmellemstrand"}, "path": "src/ext/java/org/opentripplanner/ext/flex/FlexRouter.java", "diffHunk": "@@ -95,21 +96,32 @@ public FlexRouter(\n \n     Set<StopLocation> egressStops = streetEgressByStop.keySet();\n \n-    Collection<Itinerary> itineraries = new ArrayList<>();\n+    Map<FlexTrip, Itinerary> itinerariesByTrip = new HashMap<>();\n \n     for (FlexAccessTemplate template : this.flexAccessTemplates) {\n       StopLocation transferStop = template.getTransferStop();\n+      FlexTrip trip = template.getFlexTrip();\n       if (egressStops.contains(transferStop)) {\n-        for(NearbyStop egress : streetEgressByStop.get(transferStop)) {\n-          Itinerary itinerary = template.createDirectItinerary(egress, arriveBy, departureTime, startOfTime);\n-          if (itinerary != null) {\n-            itineraries.add(itinerary);\n+        for (NearbyStop egress : streetEgressByStop.get(transferStop)) {\n+          Itinerary itinerary = template.createDirectItinerary(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDQ1MTk0", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-547045194", "createdAt": "2020-12-08T10:27:53Z", "commit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyNzo1M1rOIBSO4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyNzo1M1rOIBSO4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxODIwOA==", "bodyText": "These can be deleted", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538218208", "createdAt": "2020-12-08T10:27:53Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/api/parameter/Qualifier.java", "diffHunk": "@@ -1,5 +1,32 @@\n package org.opentripplanner.api.parameter;\n \n public enum Qualifier {\n-  RENT, HAVE, PARK, KEEP, PICKUP, DROPOFF\n+  /** The vehicle has to be rented */\n+  RENT,\n+  @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDUyNjcz", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-547052673", "createdAt": "2020-12-08T10:32:57Z", "commit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozMjo1N1rOIBSgcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozMjo1N1rOIBSgcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMjcwNQ==", "bodyText": "Ask @hannesj Why FlexTrip does not extend Trip", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538222705", "createdAt": "2020-12-08T10:32:57Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -58,6 +58,13 @@\n     */\n    public Boolean realTime = false;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDYzNjA0", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-547063604", "createdAt": "2020-12-08T10:41:09Z", "commit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo0MTowOVrOIBS9mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo0MTowOVrOIBS9mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIzMDE3MQ==", "bodyText": "Formatting", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#discussion_r538230171", "createdAt": "2020-12-08T10:41:09Z", "author": {"login": "gmellemstrand"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/router/street/FlexAccessEgressRouter.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.opentripplanner.routing.algorithm.raptor.router.street;\n+\n+import org.opentripplanner.ext.flex.FlexAccessEgress;\n+import org.opentripplanner.ext.flex.FlexRouter;\n+import org.opentripplanner.routing.api.request.RoutingRequest;\n+import org.opentripplanner.routing.api.request.StreetMode;\n+import org.opentripplanner.routing.graphfinder.NearbyStop;\n+\n+import java.util.Collection;\n+import java.util.List;\n+\n+public class FlexAccessEgressRouter {\n+\n+  private FlexAccessEgressRouter() {}\n+\n+  public static Collection<FlexAccessEgress> routeAccessEgress(\n+      RoutingRequest request,\n+      boolean isEgress\n+  ) {\n+\n+    Collection<NearbyStop> accessStops = !isEgress ? AccessEgressRouter.streetSearch(request,\n+        StreetMode.WALK,\n+        false,\n+        2000\n+    ) : List.of();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd195ac288219c2403ae8570fcc5646960a0459e"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa777a00e36839c48fde3aadacaea145e0ceadd", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5aa777a00e36839c48fde3aadacaea145e0ceadd", "committedDate": "2020-12-08T15:35:48Z", "message": "Deleted unused Qualifier enum values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907e90a9e27de58ad6261aa63a2e3032e8784812", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/907e90a9e27de58ad6261aa63a2e3032e8784812", "committedDate": "2020-12-08T15:36:22Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8de7594a05c69e24a5682c055a5b173860d9a58", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e8de7594a05c69e24a5682c055a5b173860d9a58", "committedDate": "2020-12-09T10:12:45Z", "message": "Revert \"Only add the earliest itinerary per trip for direct flex\"\n\nThis reverts commit 0eba997f9b476219c19debae7a5a4eb4372a66f5."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDMwOTM2", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-549030936", "createdAt": "2020-12-10T10:02:57Z", "commit": {"oid": "e8de7594a05c69e24a5682c055a5b173860d9a58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0ab98802557c683f85c837c96449f918a71a054", "author": {"user": {"login": "abyrd", "name": "Andrew Byrd"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e0ab98802557c683f85c837c96449f918a71a054", "committedDate": "2020-12-15T08:55:45Z", "message": "Merge branch 'dev-2.x' into otp2_flex_as_streetmode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjQ3ODIx", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3233#pullrequestreview-552247821", "createdAt": "2020-12-15T09:18:35Z", "commit": {"oid": "e0ab98802557c683f85c837c96449f918a71a054"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2007, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}