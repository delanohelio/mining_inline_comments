{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MzMzMTAy", "number": 3238, "title": "Otp2 fix SIRI timezones", "bodyText": "To be completed by pull request submitter:\n\n issue: Link to or create an issue that describes the relevant feature or bug. Add GitHub keywords to this PR's description (e.g., closes #45).\n roadmap: Check the roadmap for this feature or bug. If it is not already on the roadmap, PLC will discuss as part of the review process.\n tests: Have you added relevant test coverage? Are all the tests passing on the continuous integration service (Travis CI)?\n formatting: Have you followed the suggested code style?\n documentation: If you are adding a new configuration option, have you added an explanation to the configuration documentation tables and sections?\n changelog: add a bullet point to the changelog file with description and link to the linked issue\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-11-10T09:03:15Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238", "merged": true, "mergeCommit": {"oid": "63ea073af2bf017f6ccb9bf2d0efe81fa35270fe"}, "closed": true, "closedAt": "2020-11-12T15:51:35Z", "author": {"login": "gmellemstrand"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ3PFmAH2gAyNTE4MzMzMTAyOmYxNDcyZDQwYTVmZTIxNDY0YWU0ODU3ZjdiNzcxMGQxNTcxOGZiNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb0neJAFqTUyOTIyNjkyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f1472d40a5fe21464ae4857f7b7710d15718fb48", "committedDate": "2020-11-06T13:46:36Z", "message": "Move siri stoptime calculation to DateMapper and take graph timezone into account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a9a466725e39cd5f58696a93e511ee557036324", "author": {"user": {"login": "lassetyr", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1a9a466725e39cd5f58696a93e511ee557036324", "committedDate": "2020-11-09T12:43:38Z", "message": "One more zone taken into account when fuzzy-matching realtime with planned data"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjE1NDc4", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#pullrequestreview-527215478", "createdAt": "2020-11-10T13:46:34Z", "commit": {"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0NjozNFrOHwdQZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0NjozNFrOHwdQZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3MzAyOA==", "bodyText": "Could you add a comment on the above method on why we skip the noon - 12 hours calculation here. Comment:\n// In OTP LocalDate is sometimes used to represent ServiceDate. This calculation is \"safe\" because \n// calculations on LocalDate ignore TimeZone adjustments, just like the ServiceDate. So, in this case it is not \n// necessary to: 'NOON - 12 hours + secondsSinceStartOfDay'\n\nThis method would also be clearer if the variable names was serviceDate and serviceTimeInSeconds. To me the secondsSinceStartOfDay means midnight, which is not true given a time-zone and DST switch.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r520573028", "createdAt": "2020-11-10T13:46:34Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java", "diffHunk": "@@ -33,4 +33,15 @@ public static int secondsSinceStartOfTime(ZonedDateTime startOfTime, Instant ins\n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NzAxMzg5", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#pullrequestreview-527701389", "createdAt": "2020-11-10T23:55:20Z", "commit": {"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzo1NToyMFrOHw0OBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzo1NToyMFrOHw0OBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0OTI1Mw==", "bodyText": "I do not think this is correct. I had to write a little test to verify it:\nZoneId fi = ZoneId.of(\"Europe/Helsinki\");\nZoneId no = ZoneId.of(\"Europe/Oslo\");\nZonedDateTime t0 = ZonedDateTime.of(2020, 11, 1, 0, 20, 0,0, fi);\nZonedDateTime t1 = ZonedDateTime.of(2020, 11, 1, 1, 20, 0,0, fi);\nSystem.out.println(TimeUtils.timeToStrShort(secondsSinceStartOfService(t0, t0, no)));\nSystem.out.println(TimeUtils.timeToStrShort(secondsSinceStartOfService(t1, t1, no)));\n$ 23:20\n$ 00:20\n\nThe Netex import uses the \"raw\" local date of the xsd:Date passed in as the service date. The SiriTimetableSnapshotSource seems to use the first estimated call and the \"raw\" date from that.\nOne problem here is that for input times with time-zone ahead of the graph timezone we may get negative time offset, assuming we use the \"raw\" date. The other option is to move the service date to the day before, but that is very confusing. So, I am in favor of using the \"raw\" date and then risk negative times.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r520949253", "createdAt": "2020-11-10T23:55:20Z", "author": {"login": "t2gran"}, "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java", "diffHunk": "@@ -33,4 +33,15 @@ public static int secondsSinceStartOfTime(ZonedDateTime startOfTime, Instant ins\n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n+\n+    public static int secondsSinceStartOfService(\n+        ZonedDateTime departureDate, ZonedDateTime dateTime, ZoneId zoneId\n+    ) {\n+        ZonedDateTime startOfService = asStartOfService(departureDate, zoneId);\n+        return (int) Duration.between(startOfService, dateTime).toSeconds();\n+    }\n+\n+    private static ZonedDateTime asStartOfService(ZonedDateTime dateTime, ZoneId zoneId) {\n+        return asStartOfService(dateTime.withZoneSameInstant(zoneId));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23190a97e32907ad1a842aeacbc4b871c2d98495", "author": {"user": {"login": "gmellemstrand", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/23190a97e32907ad1a842aeacbc4b871c2d98495", "committedDate": "2020-11-11T13:28:15Z", "message": "Changes based on comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b3be2ed6e7ed9f919c6a10cd0eabeb6deeb8db9", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/9b3be2ed6e7ed9f919c6a10cd0eabeb6deeb8db9", "committedDate": "2020-11-11T20:21:22Z", "message": "Create a ScheduledIndex to store TripPatternsForDate"}, "afterCommit": {"oid": "768fe3e61e6a5c0109e3864174c51fd997012b4f", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/768fe3e61e6a5c0109e3864174c51fd997012b4f", "committedDate": "2020-11-12T00:17:09Z", "message": "Create a ScheduledIndex to store TripPatternsForDate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2430becb340864d695b6493909ce66028f8db563", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2430becb340864d695b6493909ce66028f8db563", "committedDate": "2020-11-12T11:07:48Z", "message": "Update ServiceDate and deprecate all methods using the system TimeZone."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd", "author": {"user": {"login": "lassetyr", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a534ac2546944ec6921f2131ced5d9325e5dd2dd", "committedDate": "2020-11-12T11:10:31Z", "message": "Taking graph timezone into account when calculating alert validity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c097532bcf3d329263558e15ab81216eeb751ce0", "author": {"user": {"login": "lassetyr", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c097532bcf3d329263558e15ab81216eeb751ce0", "committedDate": "2020-11-12T10:48:47Z", "message": "Taking graph timezone into account when calculating alert validity"}, "afterCommit": {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd", "author": {"user": {"login": "lassetyr", "name": null}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a534ac2546944ec6921f2131ced5d9325e5dd2dd", "committedDate": "2020-11-12T11:10:31Z", "message": "Taking graph timezone into account when calculating alert validity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4OTkzNTEw", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#pullrequestreview-528993510", "createdAt": "2020-11-12T11:26:20Z", "commit": {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToyNjoyMFrOHx2ebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToyNjoyMFrOHx2ebQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNDc5Nw==", "bodyText": "I think you should pass in the graphTimezone here, not the graph.\nIf all you need is the \"salt\", why do you pass the \"dinner table\"?\n(Sorry for my bad humor ;-)", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r522034797", "createdAt": "2020-11-12T11:26:20Z", "author": {"login": "t2gran"}, "path": "src/ext/java/org/opentripplanner/ext/siri/SiriAlertsUpdateHandler.java", "diffHunk": "@@ -69,10 +65,13 @@\n \n     private final String feedId;\n \n+    private final Graph graph;\n+\n     private final Set<TransitAlert> alerts = new HashSet<>();\n \n-    public SiriAlertsUpdateHandler(String feedId) {\n+    public SiriAlertsUpdateHandler(String feedId, Graph graph) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a79a0cd2a25d4e5b17a6cf785dd6febddc4535b1", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a79a0cd2a25d4e5b17a6cf785dd6febddc4535b1", "committedDate": "2020-11-12T14:55:36Z", "message": "Merge branch 'dev-2.x' into otp2_fix_realtime_timezones"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjI2OTIw", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#pullrequestreview-529226920", "createdAt": "2020-11-12T15:51:22Z", "commit": {"oid": "a79a0cd2a25d4e5b17a6cf785dd6febddc4535b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2012, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}