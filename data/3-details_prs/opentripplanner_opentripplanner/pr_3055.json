{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzM0Mjcz", "number": 3055, "title": "Use Range Raptor Iteration instead of departure time as result path criteria", "bodyText": "Fix undesired routing results when using timetable view buy using the Range Raptor iteration instead of departure time in the path pareto-set comparator.\nThe 3 first commits are just \"clean code\" commits improving the SpeedTest, which I used to verify and debug this bug.\n\n\n issue: Fix #3053\n\n\n roadmap: Raptor\n\n\n tests: Affected unit tests are updated.\n\n\n formatting: Yes\n\n\n documentation: JavaDoc updated, some of the text in the issue documentation should maybe be added to the Raptor doc.\n\n\n changelog: No, this is just a bug fix on Raptor witch is new.\n\n\nTo be completed by @opentripplanner/plc:\n\n reviews and approvals by 2 members, ideally from different organizations\n after merging: update the relevant card on the roadmap", "createdAt": "2020-04-29T14:03:11Z", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3055", "merged": true, "mergeCommit": {"oid": "c5f37280cb4decfcc66a2ee55f6eca1f92aa1f07"}, "closed": true, "closedAt": "2020-05-05T21:51:28Z", "author": {"login": "t2gran"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccZAh5AH2gAyNDEwNzM0MjczOjdlNjdlYmI4Y2JiMjk1YTI5NTgzZjdhYmU5MGRmZTA2ODExMjIzMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceaw8UAH2gAyNDEwNzM0MjczOmEwOWRlODVmZDYyMTU1YzRjNGJkNTdhZTI1OWQxMGI5NjViYzQ1NmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e67ebb8cbb295a29583f7abe90dfe068112232a", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/7e67ebb8cbb295a29583f7abe90dfe068112232a", "committedDate": "2020-04-29T14:04:10Z", "message": "Clean code - Make 'TimeUtils.timeStrCompact(..)' skip seconds[if 0] not hours. This method was historically used to print durations, but a dedicated method for printing duration now exist. Hence the 'timeStrCompact' could be converted to print times in a compact format like hh:mm (13:45) when the second part is 0. It the second part is not zero, the long format hh:mm:ss is used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49903e089fde6931e0a8c6f9146b89356b7cb387", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/49903e089fde6931e0a8c6f9146b89356b7cb387", "committedDate": "2020-04-29T14:04:10Z", "message": "Clean code - Improve SpeedTest:\n - by adding modes, agencies and routes to result file.\n - removing SpeedTestItinerary.\n - fixing time and duration to string converting.\n - Reuse the PathStringBuilder.\n - Cleanup api/model delete unused code.\n - Make the SpeedTest result compare more robust."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9980aca3645f4f544dd47cbd82ee287f1f0bdbb", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b9980aca3645f4f544dd47cbd82ee287f1f0bdbb", "committedDate": "2020-04-29T14:04:10Z", "message": "Clean code - Add mode to PathStringBuilder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8141c27b87c0acfbe4f137aa323eafc1ddcd58d9", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8141c27b87c0acfbe4f137aa323eafc1ddcd58d9", "committedDate": "2020-04-29T14:04:10Z", "message": "Fix undesired routing results when using timetable view buy using the Range Raptor iteration instead of departure time in the path pareto-set comparator. This fixes issue #3053."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa77b1257b389b2510e3c11a98c1572ac65130b9", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/aa77b1257b389b2510e3c11a98c1572ac65130b9", "committedDate": "2020-04-29T13:51:16Z", "message": "Fix undesired routing results when using timetable view buy using the Range Raptor iteration instead of departure time in the path pareto-set comparator. This fixes issue #3053."}, "afterCommit": {"oid": "8141c27b87c0acfbe4f137aa323eafc1ddcd58d9", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8141c27b87c0acfbe4f137aa323eafc1ddcd58d9", "committedDate": "2020-04-29T14:04:10Z", "message": "Fix undesired routing results when using timetable view buy using the Range Raptor iteration instead of departure time in the path pareto-set comparator. This fixes issue #3053."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497437d06af96a4db794e105dab3f767c37e96cd", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/497437d06af96a4db794e105dab3f767c37e96cd", "committedDate": "2020-04-29T14:34:07Z", "message": "Clean code - In the SpeedTest prevent IndexOutOfBoundException when there is just one test case. Also, remove origin from the details section in the test comparison."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7059a44fa3a20544c75ed8dddca634607667ea0", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b7059a44fa3a20544c75ed8dddca634607667ea0", "committedDate": "2020-05-04T10:13:02Z", "message": "Rename field/parameter `iteration` to `iterationDepartureTime`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjI3MDAx", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3055#pullrequestreview-405627001", "createdAt": "2020-05-05T09:29:35Z", "commit": {"oid": "8141c27b87c0acfbe4f137aa323eafc1ddcd58d9"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyOTozNVrOGQhbTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo0NDoxMVrOGQh7zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3ODA2MA==", "bodyText": "Clarify Javadoc: \"all results found in previous iterations are kept\" at the egress stations, but not in the main search itself, where the range raptor optimization depends on kicking out states from previous (later departure) iterations.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3055#discussion_r419978060", "createdAt": "2020-05-05T09:29:35Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/transit/raptor/api/path/Path.java", "diffHunk": "@@ -43,13 +45,23 @@ private Path(int startTime, int endTime, int numberOfTransfers, int generalizedC\n         this.egressPathLeg = null;\n     }\n \n-    public Path(AccessPathLeg<T> accessLeg, int generalizedCost) {\n-        this.accessLeg = accessLeg;\n-        this.egressPathLeg = findEgressLeg(accessLeg);\n+    public Path(int iteration, AccessPathLeg<T> accessLeg, int generalizedCost) {\n+        this.iteration = iteration;\n         this.startTime = accessLeg.fromTime();\n-        this.endTime = egressPathLeg.toTime();\n         this.numberOfTransfers = countNumberOfTransfers(accessLeg);\n         this.generalizedCost = generalizedCost;\n+        this.accessLeg = accessLeg;\n+        this.egressPathLeg = findEgressLeg(accessLeg);\n+        this.endTime = egressPathLeg.toTime();\n+    }\n+\n+    /**\n+     * The Range Raptor iteration. This can be used in the path-pareto-function to make sure\n+     * all results found in previous iterations are kept, and not dominated by new results.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8141c27b87c0acfbe4f137aa323eafc1ddcd58d9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4NjM4MA==", "bodyText": "We discussed the fact that this optimization cuts about 50% of the run time. It is the most effective optimization, and a paper came out in January explaining why it is so effective. Javadoc should be updated to include that reference.", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3055#discussion_r419986380", "createdAt": "2020-05-05T09:44:11Z", "author": {"login": "abyrd"}, "path": "src/main/java/org/opentripplanner/transit/raptor/rangeraptor/path/DestinationArrivalPaths.java", "diffHunk": "@@ -72,12 +74,16 @@ public boolean isReachedCurrentRound() {\n         return reachedCurrentRound;\n     }\n \n+    public void setRangeRaptorIteration(int iteration) {\n+        this.iteration = iteration;\n+    }\n+\n     public boolean isEmpty() {\n         return paths.isEmpty();\n     }\n \n     public boolean qualify(int departureTime, int arrivalTime, int numberOfTransfers, int cost) {\n-        return paths.qualify(Path.dummyPath(departureTime, arrivalTime, numberOfTransfers, cost));\n+        return paths.qualify(Path.dummyPath(iteration, departureTime, arrivalTime, numberOfTransfers, cost));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8141c27b87c0acfbe4f137aa323eafc1ddcd58d9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2af9607e97b051d69066f5e7a0477bbabf1eff9", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d2af9607e97b051d69066f5e7a0477bbabf1eff9", "committedDate": "2020-05-05T20:38:12Z", "message": "Remove the 'allowWaitingBetweenAccessAndTransit'search parameter. This optimization is not valid with the raptor algorithm and we need to implement it in another way. What we want is that the first iteration should provide some good results for the next search-window and let these results be part of the pareto-filtering to exclude none optimal results in the current search-window."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358d45986740e9cf9fb59f347b907f67e2592d93", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/358d45986740e9cf9fb59f347b907f67e2592d93", "committedDate": "2020-05-05T21:00:35Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_timeshidt_paths"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c1b40c6fdf7895d20da638dd681f21bf72649a3", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6c1b40c6fdf7895d20da638dd681f21bf72649a3", "committedDate": "2020-05-04T16:24:47Z", "message": "Revert removal of TripScheduleExactMatchSearch."}, "afterCommit": {"oid": "358d45986740e9cf9fb59f347b907f67e2592d93", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/358d45986740e9cf9fb59f347b907f67e2592d93", "committedDate": "2020-05-05T21:00:35Z", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_timeshidt_paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a09de85fd62155c4c4bd57ae259d10b965bc456e", "author": {"user": {"login": "t2gran", "name": "Thomas Gran"}}, "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a09de85fd62155c4c4bd57ae259d10b965bc456e", "committedDate": "2020-05-05T21:14:48Z", "message": "Merge branch 'dev-2.x' into otp2_timeshidt_paths"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2111, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}