{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1ODU4NTE0", "number": 435, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODowOTozOVrOE1ilAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDozMToyMlrOE_jdfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NTc2NTE0OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.deploy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODowOTozOVrOHt3kwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODowOTozOVrOHt3kwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg1ODQ5Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    def options = [\"-s ${env.GLOBAL_MAVEN_SETTINGS}\", '-fae']\n          \n          \n            \n                    if(params.MAVEN_DEPENDENCIES_REPOSITORY){\n          \n          \n            \n                        options += ['-Denforcer.skip']\n          \n          \n            \n                    }\n          \n          \n            \n                    maven.runMaven(mvnCmd, skipTests, options)\n          \n          \n            \n                    def opts = [\"-s ${env.GLOBAL_MAVEN_SETTINGS}\", '-fae']\n          \n          \n            \n                    if(params.MAVEN_DEPENDENCIES_REPOSITORY){\n          \n          \n            \n                        opts += ['-Denforcer.skip']\n          \n          \n            \n                    }\n          \n          \n            \n                    maven.runMaven(mvnCmd, skipTests, opts)", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r517858497", "createdAt": "2020-11-05T08:09:39Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -306,6 +347,10 @@ void runMaven(String command, String directory, boolean skipTests = false, List\n         mvnCmd += \" ${extraArgs}\"\n     }\n     dir(directory) {\n-        maven.runMaven(mvnCmd, skipTests, ['-fae'])\n+        def options = [\"-s ${env.GLOBAL_MAVEN_SETTINGS}\", '-fae']\n+        if(params.MAVEN_DEPENDENCIES_REPOSITORY){\n+            options += ['-Denforcer.skip']\n+        }\n+        maven.runMaven(mvnCmd, skipTests, options)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a16b3689212d2397d9d03be7e9d67c0970b8ec4"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NTk0ODk4OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.deploy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NjozMlrOHt5TCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NjozMlrOHt5TCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4NjczMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r517886730", "createdAt": "2020-11-05T08:56:32Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -292,9 +307,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \"--projects ${parentProjectName ?: directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "188d3ef1811820c401e624ef8771c73a6156b242"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjAzNjI2OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.deploy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOToxODo0NVrOHt6J6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOToxODo0NVrOHt6J6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMDc3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r517900776", "createdAt": "2020-11-05T09:18:45Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -292,9 +307,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects ${parentProjectName ?: directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9d5fddec14cc9f1d3301a63ae0e6f82e4a5c8a4"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjE1OTY1OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.deploy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0OTo0MVrOHt7W1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0OTo0MVrOHt7W1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyMDQ2OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r517920469", "createdAt": "2020-11-05T09:49:41Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -292,9 +307,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects :${parentProjectName ?: directory}\"\n+        cmd += \" -DnexusUrl=${env.NEXUS_RELEASE_URL}\"\n+        cmd += \" -DserverId=${env.NEXUS_RELEASE_REPOSITORY_ID}\" \n+        cmd += \" -DrepositoryDirectory=${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        cmd += \" -DstagingProfileId=${env.NEXUS_STAGING_REPOSITORY_ID}\" \n+        cmd += \" -DstagingDescription=\\\"Kogito Runtimes ${getProjectVersion()}\\\"\"\n+        echo \"Run maven cmd $cmd\"\n+        runMaven(cmd, directory)\n+\n+        // Promote to build profile\n+        cmd = \"org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:promote -DbuildPromotionProfileId=${env.NEXUS_BUILD_PROMOTION_PROFILE_ID}\"\n+        cmd += \"--projects ${directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23966a7655c7988e754dfd67882a1b7f008ab868"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjQ3MDE2OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.deploy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTowODozNVrOHt-Wng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTowODozNVrOHt-Wng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2OTU2Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            sh \"echo '\\n-Denforcer.skip' | tee -a optaplanner/.mvn/maven.config\"\n          \n          \n            \n                                            sh \"echo '\\n-Denforcer.skip' | tee -a .mvn/maven.config\"", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r517969566", "createdAt": "2020-11-05T11:08:35Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -88,16 +102,17 @@ pipeline {\n             steps {\n                 script {\n                     dir('kogito-examples') {\n-                        configFileProvider([configFile(fileId: maven.getSubmarineSettingsXmlId(), targetLocation: 'maven-settings.xml', variable: 'MAVEN_SETTINGS_FILE')]){\n+                        configFileProvider([configFile(fileId: env.MAVEN_SETTINGS_CONFIG_FILE_ID, targetLocation: 'maven-settings.xml', variable: 'MAVEN_SETTINGS_FILE')]){\n                             // expose the temp file via a global environment variable for other stages\n                             env.GLOBAL_MAVEN_SETTINGS = \"${MAVEN_SETTINGS_FILE}\"\n                             sh \"echo '\\n-B -s ${MAVEN_SETTINGS_FILE}' | tee -a .mvn/maven.config\"\n-                            if(params.MAVEN_DEPENDENCIES_REPOSITORY != ''){\n-                                sh \"echo '\\n-Denforcer.skip=true' | tee -a .mvn/maven.config\"\n-                                sh \"sed -i 's|<repositories>|<repositories><repository><id>staging</id><name>Staging Repository</name><url>${params.MAVEN_DEPENDENCIES_REPOSITORY}</url><layout>default</layout><snapshots><enabled>true</enabled></snapshots><releases><enabled>true</enabled></releases></repository>|g' ${MAVEN_SETTINGS_FILE}\"\n-                                sh \"sed -i 's|<pluginRepositories>|<pluginRepositories><pluginRepository><id>staging</id><name>Staging Repository</name><url>${params.MAVEN_DEPENDENCIES_REPOSITORY}</url><layout>default</layout><snapshots><enabled>true</enabled></snapshots><releases><enabled>true</enabled></releases></pluginRepository>|g' ${MAVEN_SETTINGS_FILE}\"\n-                                // Done to allow Maven to download release artificats from MAVEN_DEPENDENCIES_REPOSITORY\n-                                sh \"sed -i 's|external:\\\\*|external:*,!staging|g' ${MAVEN_SETTINGS_FILE}\"\n+                            if(params.MAVEN_DEPENDENCIES_REPOSITORY){\n+                                depsRepositoryContent = \"<id>deps-repo</id><name>Dependencies Repository</name><url>${params.MAVEN_DEPENDENCIES_REPOSITORY}</url><layout>default</layout><snapshots><enabled>true</enabled></snapshots><releases><enabled>true</enabled></releases>\"\n+                                sh \"echo '\\n-Denforcer.skip' | tee -a optaplanner/.mvn/maven.config\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "516dfb37f3ab717c58ecfa26d2e9128f66fdced5"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDc2NzMzOnYy", "diffSide": "RIGHT", "path": "Jenkinsfile.promote", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDozMToyM1rOH9UeAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDozNDozN1rOH9Ul1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA2MDU0Ng==", "bodyText": "Here we use getMavenConfig() while in kogito-runtimes we create a defaultMavenCmd. Would be nice to keep consistency across the pipelines.\nBtw, I prefer this approach over the defaultMavenCmd: the getMavenConfig() always returns a new instance. Thus, there is no risk of accidentally changing the defaultMavenCmd due to forgetting to call clone().", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r534060546", "createdAt": "2020-12-02T10:31:23Z", "author": {"login": "rsynek"}, "path": "Jenkinsfile.promote", "diffHunk": "@@ -104,17 +107,17 @@ pipeline {\n                 script {\n                     dir('kogito-examples-bot') {\n                         prepareForPR('kogito-examples')\n-                        setupMavenConfig()\n-                        maven.mvnVersionsSet(getSnapshotVersion(), true)\n-                        updateOptaPlannerVersion(util.getNextVersion(getOptaPlannerVersion(), 'micro'))\n+\n+                        maven.mvnVersionsSet(getMavenConfig(), getSnapshotVersion(), true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e557404e1b3068b075273b22eab428ed2872d573"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA2MjU0OQ==", "bodyText": "Until now, promote has the getMavenConfig and deploy use the default[...] var.\nCould be changed indeed to getMavenConfig. will do that.", "url": "https://github.com/kiegroup/kogito-examples/pull/435#discussion_r534062549", "createdAt": "2020-12-02T10:34:37Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.promote", "diffHunk": "@@ -104,17 +107,17 @@ pipeline {\n                 script {\n                     dir('kogito-examples-bot') {\n                         prepareForPR('kogito-examples')\n-                        setupMavenConfig()\n-                        maven.mvnVersionsSet(getSnapshotVersion(), true)\n-                        updateOptaPlannerVersion(util.getNextVersion(getOptaPlannerVersion(), 'micro'))\n+\n+                        maven.mvnVersionsSet(getMavenConfig(), getSnapshotVersion(), true)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA2MDU0Ng=="}, "originalCommit": {"oid": "e557404e1b3068b075273b22eab428ed2872d573"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 353, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}