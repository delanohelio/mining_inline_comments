{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MjEyMDkx", "number": 1099, "title": "Implemented restricted mTLS certs", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-09-01T16:54:38Z", "url": "https://github.com/AthenZ/athenz/pull/1099", "merged": true, "mergeCommit": {"oid": "6db634582dcfff72e2d62fd7ab31ef94dd40e87a"}, "closed": true, "closedAt": "2020-09-03T15:54:06Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEs3pOAH2gAyNDc3MjEyMDkxOmE2YjQ5YWYxOWNkNGI0NDVjYWY0YmFlMjNhM2E3MTEwZmQ4ODdjNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFSsjsgFqTQ4MTk3OTQ4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a6b49af19cd4b445caf4bae23a3a7110fd887c71", "committedDate": "2020-09-01T19:49:32Z", "message": "Implemented restricted mTLS certs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8a434dd5d54f8bcba8055b6f8ef8149863a2010", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/e8a434dd5d54f8bcba8055b6f8ef8149863a2010", "committedDate": "2020-09-01T16:53:52Z", "message": "Implemented restricted mTLS certs"}, "afterCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a6b49af19cd4b445caf4bae23a3a7110fd887c71", "committedDate": "2020-09-01T19:49:32Z", "message": "Implemented restricted mTLS certs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTY5NjQx", "url": "https://github.com/AthenZ/athenz/pull/1099#pullrequestreview-480169641", "createdAt": "2020-09-01T22:50:49Z", "commit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo1MDo0OVrOHLK5nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzowOTo0NlrOHLLRtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NDk3Mw==", "bodyText": "any reason not just combine these two lines?", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r481474973", "createdAt": "2020-09-01T22:50:49Z", "author": {"login": "havetisyan"}, "path": "libs/java/auth_core/src/main/java/com/yahoo/athenz/auth/impl/CertificateAuthority.java", "diffHunk": "@@ -111,6 +112,9 @@ public Principal authenticate(X509Certificate[] certs, StringBuilder errMsg) {\n         principal.setUnsignedCreds(x509Cert.getSubjectX500Principal().toString());\n         principal.setX509Certificate(x509Cert);\n         principal.setRoles(certId.getRoles());\n+        boolean isRestrictedCert = Crypto.isRestrictedCertificate(x509Cert);\n+        principal.setMtlsRestricted(isRestrictedCert);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NjI1MA==", "bodyText": "This could turn out to be a very expensive method since we're parsing and generating new strings matcher every time. This is a static property. While I understand the logic of adding the function here since it simplifies the authority code, I believe each authority should create a static strings matcher object itself and then pass this as an argument. this way we're not creating a new one for every single request.", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r481476250", "createdAt": "2020-09-01T22:54:58Z", "author": {"login": "havetisyan"}, "path": "libs/java/auth_core/src/main/java/com/yahoo/athenz/auth/util/Crypto.java", "diffHunk": "@@ -1115,6 +1117,12 @@ public static String extractX509CertSubjectOField(X509Certificate x509Cert) {\n         return extractX509CertSubjectField(x509Cert, BCStyle.O);\n     }\n \n+    public static boolean isRestrictedCertificate(X509Certificate x509Cert) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3OTE3Mg==", "bodyText": "we should update the debug statement on line 35 below. it's referring to Ignored services - we should just include the property name in the statement", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r481479172", "createdAt": "2020-09-01T23:03:47Z", "author": {"login": "havetisyan"}, "path": "libs/java/auth_core/src/main/java/com/yahoo/athenz/auth/util/GlobStringsMatcher.java", "diffHunk": "@@ -30,7 +29,7 @@\n     private final List<String> patterns;\n \n     public GlobStringsMatcher(String systemProperty) {\n-        List<String> globList = ZTSUtils.splitCommaSeperatedSystemProperty(systemProperty);\n+        List<String> globList = AthenzUtils.splitCommaSeperatedSystemProperty(systemProperty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3OTY2NQ==", "bodyText": "For ZMS - why not just put the check in the authorize call. We should not allow any write operations with the restricted cert.", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r481479665", "createdAt": "2020-09-01T23:05:12Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3482,6 +3482,8 @@ public void putMembership(ResourceContext ctx, String domainName, String roleNam\n \n         verifyAuthorizedServiceRoleOperation(principal.getAuthorizedService(), caller, roleName);\n \n+        validateNotMtlsRestricted(ctx, caller);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4MTE0MA==", "bodyText": "For ZTS, we should be probably be more strict and add it to the authenticate method. We should not allow anyone with the restricted certs to connect to ZTS. I can't think of any reason, can you? This would simplify the code for any future commands as well.", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r481481140", "createdAt": "2020-09-01T23:09:46Z", "author": {"login": "havetisyan"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -1372,6 +1372,8 @@ public RoleToken getRoleToken(ResourceContext ctx, String domainName, String rol\n                     ZTSConsts.ZTS_UNKNOWN_DOMAIN, principalDomain);\n         }\n \n+        validateNotMtlsRestricted(ctx, caller, domainName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ebc39e98c2f41a3259d610701c0f0bcce3041b7", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/8ebc39e98c2f41a3259d610701c0f0bcce3041b7", "committedDate": "2020-09-02T13:20:35Z", "message": "Fix following code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjQ5OTEx", "url": "https://github.com/AthenZ/athenz/pull/1099#pullrequestreview-481249911", "createdAt": "2020-09-02T19:51:41Z", "commit": {"oid": "8ebc39e98c2f41a3259d610701c0f0bcce3041b7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOTo1MTo0MVrOHMBhUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDowMTowNVrOHMCTcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2OTg3NQ==", "bodyText": "we should optimize the use of this function. If I don't have a restricted set, the code parses and gets the ou field anyway and then just does nothing. before doing this we should check if there are any values in our strings matcher and if it's empty, then return false right away without doing anything.", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r482369875", "createdAt": "2020-09-02T19:51:41Z", "author": {"login": "havetisyan"}, "path": "libs/java/auth_core/src/main/java/com/yahoo/athenz/auth/util/Crypto.java", "diffHunk": "@@ -1115,6 +1115,19 @@ public static String extractX509CertSubjectOField(X509Certificate x509Cert) {\n         return extractX509CertSubjectField(x509Cert, BCStyle.O);\n     }\n \n+    public static boolean isRestrictedCertificate(X509Certificate x509Cert, GlobStringsMatcher globStringsMatcher) {\n+        if (globStringsMatcher == null) {\n+            LOG.error(\"isRestrictedCertificate: Required argument globStringsMatcher is null. Returning true.\");\n+            return true;\n+        }\n+        if (x509Cert == null) {\n+            LOG.error(\"isRestrictedCertificate: Required argument x509Cert is null. Returning true.\");\n+            return true;\n+        }\n+        String x509Ou = extractX509CertSubjectOUField(x509Cert);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ebc39e98c2f41a3259d610701c0f0bcce3041b7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM4MjcwNA==", "bodyText": "those operations can be carried out against ZMS. There is no point of going to ZTS to get a service or public keys. and if you have a restricted cert, you should not really carry out any access checks. It's basically a limited client certificate. So I think I'm ok restricting from zts server completely.", "url": "https://github.com/AthenZ/athenz/pull/1099#discussion_r482382704", "createdAt": "2020-09-02T20:01:05Z", "author": {"login": "havetisyan"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -1372,6 +1372,8 @@ public RoleToken getRoleToken(ResourceContext ctx, String domainName, String rol\n                     ZTSConsts.ZTS_UNKNOWN_DOMAIN, principalDomain);\n         }\n \n+        validateNotMtlsRestricted(ctx, caller, domainName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4MTE0MA=="}, "originalCommit": {"oid": "a6b49af19cd4b445caf4bae23a3a7110fd887c71"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aae0d9d942222b39129d78c97e8d7b76489f7c1", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/1aae0d9d942222b39129d78c97e8d7b76489f7c1", "committedDate": "2020-09-03T09:09:05Z", "message": "Fix following code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTc5NDgz", "url": "https://github.com/AthenZ/athenz/pull/1099#pullrequestreview-481979483", "createdAt": "2020-09-03T15:53:49Z", "commit": {"oid": "1aae0d9d942222b39129d78c97e8d7b76489f7c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2896, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}