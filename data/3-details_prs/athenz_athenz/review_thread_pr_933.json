{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNzM4NDE0", "number": 933, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNjoyMlrODymyjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0MzoyMFrODzWkiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzkwOTI2OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationEmail.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNjoyMlrOGGwF6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNjoyMlrOGGwF6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMjU4Nw==", "bodyText": "The structure returned from NotificationToEmailConverter. EmailNotificationService will get the subject / body / email of recipients from it.", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409732587", "createdAt": "2020-04-16T17:36:22Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationEmail.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+public class NotificationEmail {\n+    private String subject;\n+    private String body;\n+    private Set<String> fullyQualifiedRecipientsEmail;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzkxMTE1OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNjo1MlrOGGwHFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNjo1MlrOGGwHFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMjg4Ng==", "bodyText": "Common class used by all NotificationToEmailConverters.", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409732886", "createdAt": "2020-04-16T17:36:52Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class NotificationToEmailConverterCommon {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzkxMzcxOnYy", "diffSide": "LEFT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNzo0MFrOGGwIyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozNzo0MFrOGGwIyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMzMyMg==", "bodyText": "All notification specific logic was removed.", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409733322", "createdAt": "2020-04-16T17:37:40Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "diffHunk": "@@ -48,86 +46,24 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(EmailNotificationService.class);\n \n-    private static final String AT = \"@\";\n-    private static final String USER_DOMAIN_DEFAULT = \"user\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzkxOTE4OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozOTowN1rOGGwMWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozOTowN1rOGGwMWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczNDIzMg==", "bodyText": "This method gets ClassLoader as it will be called from both ZTS and ZMS (each with its own resources).", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409734232", "createdAt": "2020-04-16T17:39:07Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class NotificationToEmailConverterCommon {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(NotificationToEmailConverterCommon.class);\n+\n+    private static final String AT = \"@\";\n+    private static final String USER_DOMAIN_DEFAULT = \"user\";\n+    private static final String PROP_USER_DOMAIN = \"athenz.user_domain\";\n+    private static final String PROP_NOTIFICATION_EMAIL_DOMAIN_TO = \"athenz.notification_email_domain_to\";\n+    private static final String PROP_NOTIFICATION_WORKFLOW_URL = \"athenz.notification_workflow_url\";\n+    private static final String PROP_NOTIFICATION_ATHENZ_UI_URL = \"athenz.notification_athenz_ui_url\";\n+    private static final String PROP_NOTIFICATION_SUPPORT_TEXT = \"athenz.notification_support_text\";\n+    private static final String PROP_NOTIFICATION_SUPPORT_URL = \"athenz.notification_support_url\";\n+    private static final String EMAIL_TEMPLATE_CSS = \"emails/base.css\";\n+\n+    private static final String HTML_STYLE_TAG_START = \"<style>\";\n+    private static final String HTML_STYLE_TAG_END = \"</style>\";\n+    private static final String HTML_TBODY_TAG_START = \"<tbody>\";\n+    private static final String HTML_TBODY_TAG_END = \"</tbody>\";\n+\n+    // can be moved to constructor which can take Locale as input parameter and return appropriate resource bundle\n+    private static final ResourceBundle RB = ResourceBundle.getBundle(\"messages/ServerCommon\");\n+\n+    private String userDomainPrefix;\n+    private String emailDomainTo;\n+    private String workflowUrl;\n+    private String athenzUIUrl;\n+    private String supportText;\n+    private String supportUrl;\n+    private String emailBaseCSS;\n+\n+\n+    public NotificationToEmailConverterCommon() {\n+        String userDomain = System.getProperty(PROP_USER_DOMAIN, USER_DOMAIN_DEFAULT);\n+        userDomainPrefix = userDomain + \"\\\\.\";\n+        emailDomainTo = System.getProperty(PROP_NOTIFICATION_EMAIL_DOMAIN_TO);\n+        workflowUrl = System.getProperty(PROP_NOTIFICATION_WORKFLOW_URL);\n+        athenzUIUrl = System.getProperty(PROP_NOTIFICATION_ATHENZ_UI_URL);\n+        supportText = System.getProperty(PROP_NOTIFICATION_SUPPORT_TEXT);\n+        supportUrl = System.getProperty(PROP_NOTIFICATION_SUPPORT_URL);\n+\n+        emailBaseCSS = readContentFromFile(getClass().getClassLoader(), EMAIL_TEMPLATE_CSS);\n+\n+    }\n+\n+    public String readContentFromFile(ClassLoader classLoader, String fileName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MTczNDgyOnYy", "diffSide": "LEFT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0MToyNVrOGH0ezg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0MToyNVrOGH0ezg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzA3MA==", "bodyText": "Removed the type from notification as it is no longer required (was used in EmailNotificationService in a switch statement to determine which body / subject to generate.", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r410853070", "createdAt": "2020-04-19T08:41:25Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -20,27 +20,24 @@\n \n public class Notification {\n \n-    // Denotes notification type. MEMBERSHIP_APPROVAL, MEMBERSHIP_EXPIRY etc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9db91decdbbc3445daa5dabf4242844fa109eac"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1MTczNzcxOnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0MzoyMFrOGH0gIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0MzoyMFrOGH0gIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzQwOQ==", "bodyText": "NotificationToEmailConverter will be implemented inside each NotificationTask. Its purpose is to convert the notification into an email", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r410853409", "createdAt": "2020-04-19T08:43:20Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -20,27 +20,24 @@\n \n public class Notification {\n \n-    // Denotes notification type. MEMBERSHIP_APPROVAL, MEMBERSHIP_EXPIRY etc.\n-    private String type;\n-\n     // Intended recipients of notification\n     private Set<String> recipients;\n \n     // key value pair describing additional details about notification\n     private Map<String, String> details;\n \n-    public Notification (String type, Set<String> recipients, Map<String, String> details) {\n-        this.type = type;\n+    // Utility class to convert the notification into an email", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9db91decdbbc3445daa5dabf4242844fa109eac"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1758, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}