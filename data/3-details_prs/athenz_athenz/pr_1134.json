{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTU1NTIx", "number": 1134, "title": "Implemented notification to metrics converters", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-06T13:40:46Z", "url": "https://github.com/AthenZ/athenz/pull/1134", "merged": true, "mergeCommit": {"oid": "2d6c30ea02b33fd660d1613e9e1013464315e096"}, "closed": true, "closedAt": "2020-10-08T21:41:35Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP9n0WABqjM4NDcyMjc4Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQopZ1gFqTUwNTE4NjM0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c632645ac37761b96894756258c867ba965f4a77", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/c632645ac37761b96894756258c867ba965f4a77", "committedDate": "2020-10-06T13:33:52Z", "message": "Implemented notification to metrics converters"}, "afterCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a22a52cca1266238d404ce149d520d22e4ca8bdf", "committedDate": "2020-10-06T19:33:35Z", "message": "Implemented notification to metrics converters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjk2Nzg2", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-503296786", "createdAt": "2020-10-06T19:37:15Z", "commit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTozNzoxNlrOHdXErw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTozNzoxNlrOHdXErw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU0ODc4Mw==", "bodyText": "NotificationToMetricConverter purpose is similar to NotificationToEmailConverter (instead of mail convert to metrics)", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500548783", "createdAt": "2020-10-06T19:37:16Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -26,12 +26,12 @@\n     // key value pair describing additional details about notification\n     private Map<String, String> details;\n \n-    // Type of notification\n-    private String type;\n-\n     // Utility class to convert the notification into an email\n     private NotificationToEmailConverter notificationToEmailConverter;\n \n+    // Utility class to convert the notification into metric attributes\n+    private NotificationToMetricConverter notificationToMetricConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjk4ODA2", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-503298806", "createdAt": "2020-10-06T19:40:11Z", "commit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0MDoxMVrOHdXKqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0MDoxMVrOHdXKqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MDMxMg==", "bodyText": "NotificationMetric holds attributes in the data structure List<String[]> (a list of flat array metric records).\nSo I had to implement custom equals and hashCode (for tests to check equality correctly and to enable holding this structure in a hashmap if we would like to do so in the future).", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500550312", "createdAt": "2020-10-06T19:40:11Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationMetric.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class NotificationMetric {\n+\n+    // Metric attributes as a list of flat arrays\n+    private List<String[]> attributes;\n+\n+    public NotificationMetric(List<String[]> attributes) {\n+        this.attributes = attributes;\n+    }\n+\n+    public List<String[]> getAttributes() {\n+        return attributes;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        NotificationMetric that = (NotificationMetric) o;\n+\n+        if (attributes.size() != ((NotificationMetric) o).attributes.size()) {\n+            return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzAxODU5", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-503301859", "createdAt": "2020-10-06T19:44:30Z", "commit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0NDozMFrOHdXTew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0NDozMFrOHdXTew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MjU3MQ==", "bodyText": "There are two notification tasks that don't contain details at all (PendingGroupMembershipApprovalNotificationToMetricConverter and PendingRoleMembershipApprovalNotificationToMetricConverter).\nCurrently, I only record that notification of that type happened. Let me know if I should record the recipients.", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500552571", "createdAt": "2020-10-06T19:44:30Z", "author": {"login": "OferLevi85"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/notification/PendingGroupMembershipApprovalNotificationTask.java", "diffHunk": "@@ -88,4 +91,20 @@ public NotificationEmail getNotificationAsEmail(Notification notification) {\n             return new NotificationEmail(subject, body, fullyQualifiedEmailAddresses);\n         }\n     }\n+\n+    public static class PendingGroupMembershipApprovalNotificationToMetricConverter implements NotificationToMetricConverter {\n+        private final static String NOTIFICATION_TYPE = \"pending_group_membership_approval\";\n+\n+        @Override\n+        public NotificationMetric getNotificationAsMetrics(Notification notification) {\n+            String[] record = new String[] {\n+                    METRIC_NOTIFICATION_TYPE_KEY, NOTIFICATION_TYPE\n+            };\n+\n+            List<String[]> attributes = new ArrayList<>();\n+            attributes.add(record);\n+            // This notification doesn't contain any details. We should consider adding the recipients in their own tags.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a22a52cca1266238d404ce149d520d22e4ca8bdf", "committedDate": "2020-10-06T19:33:35Z", "message": "Implemented notification to metrics converters"}, "afterCommit": {"oid": "9eadcde6bd7a30087da1c5298ff55d54e320104c", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/9eadcde6bd7a30087da1c5298ff55d54e320104c", "committedDate": "2020-10-06T20:47:50Z", "message": "Implemented notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9eadcde6bd7a30087da1c5298ff55d54e320104c", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/9eadcde6bd7a30087da1c5298ff55d54e320104c", "committedDate": "2020-10-06T20:47:50Z", "message": "Implemented notification to metrics converters"}, "afterCommit": {"oid": "b72474c81183505cb4034759593970e387d4886c", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/b72474c81183505cb4034759593970e387d4886c", "committedDate": "2020-10-06T21:42:29Z", "message": "Implemented notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b72474c81183505cb4034759593970e387d4886c", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/b72474c81183505cb4034759593970e387d4886c", "committedDate": "2020-10-06T21:42:29Z", "message": "Implemented notification to metrics converters"}, "afterCommit": {"oid": "763ef6e7519d4a15333f4def5c077ef07edfcf88", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/763ef6e7519d4a15333f4def5c077ef07edfcf88", "committedDate": "2020-10-06T22:17:24Z", "message": "Implement notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "763ef6e7519d4a15333f4def5c077ef07edfcf88", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/763ef6e7519d4a15333f4def5c077ef07edfcf88", "committedDate": "2020-10-06T22:17:24Z", "message": "Implement notification to metrics converters"}, "afterCommit": {"oid": "7b4ac90f8be636843f6678895b782b75d7dc6b8f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/7b4ac90f8be636843f6678895b782b75d7dc6b8f", "committedDate": "2020-10-06T22:45:05Z", "message": "Implement notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b4ac90f8be636843f6678895b782b75d7dc6b8f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/7b4ac90f8be636843f6678895b782b75d7dc6b8f", "committedDate": "2020-10-06T22:45:05Z", "message": "Implement notification to metrics converters"}, "afterCommit": {"oid": "3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "committedDate": "2020-10-07T07:41:29Z", "message": "Implement notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "committedDate": "2020-10-07T07:41:29Z", "message": "Implement notification to metrics converters"}, "afterCommit": {"oid": "384a299bbd48e00968d93575f33f5a544babccd5", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/384a299bbd48e00968d93575f33f5a544babccd5", "committedDate": "2020-10-07T08:40:23Z", "message": "Implement notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "384a299bbd48e00968d93575f33f5a544babccd5", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/384a299bbd48e00968d93575f33f5a544babccd5", "committedDate": "2020-10-07T08:40:23Z", "message": "Implement notification to metrics converters"}, "afterCommit": {"oid": "785bbff855c1d5136318b459c1c04c8d287952b4", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/785bbff855c1d5136318b459c1c04c8d287952b4", "committedDate": "2020-10-07T09:07:03Z", "message": "Implement notification to metrics converters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/2da05a38e91075fd3fdcba1d2631b27d505323f6", "committedDate": "2020-10-07T10:29:26Z", "message": "Implement notification to metrics converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "785bbff855c1d5136318b459c1c04c8d287952b4", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/785bbff855c1d5136318b459c1c04c8d287952b4", "committedDate": "2020-10-07T09:07:03Z", "message": "Implement notification to metrics converters"}, "afterCommit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/2da05a38e91075fd3fdcba1d2631b27d505323f6", "committedDate": "2020-10-07T10:29:26Z", "message": "Implement notification to metrics converters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzQyNzcy", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-503742772", "createdAt": "2020-10-07T10:33:31Z", "commit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDozMzozMVrOHds_iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDozMzozMVrOHds_iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkwNzkxMg==", "bodyText": "I get the currentTime as an interface argument so equality checks will be successful in tests (calculating the currentTime inside each notification makes a difference for attributes such as \"expiry_days\" which can sometimes result in test failures)", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500907912", "createdAt": "2020-10-07T10:33:31Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -93,6 +86,18 @@ public NotificationEmail getNotificationAsEmail() {\n         return null;\n     }\n \n+    public Notification setNotificationToMetricConverter(NotificationToMetricConverter notificationToMetricConverter) {\n+        this.notificationToMetricConverter = notificationToMetricConverter;\n+        return this;\n+    }\n+\n+    public NotificationMetric getNotificationAsMetrics(Timestamp currentTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDUxMDEx", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-504451011", "createdAt": "2020-10-08T06:03:06Z", "commit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowMzowNlrOHePIKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowMzowNlrOHePIKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2NzE3Ng==", "bodyText": "I also took advantage of the changes to change the Timestamps used in this notification from \"java.sql.Timestamp\" to \"com.yahoo.rdl.Timestamp\".", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r501467176", "createdAt": "2020-10-08T06:03:06Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "diffHunk": "@@ -25,17 +25,18 @@\n import com.yahoo.athenz.zts.ZTSConsts;\n import com.yahoo.athenz.zts.cert.InstanceCertManager;\n import com.yahoo.athenz.zts.store.DataStore;\n+import com.yahoo.rdl.Timestamp;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import java.sql.Timestamp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTg2MzQ2", "url": "https://github.com/AthenZ/athenz/pull/1134#pullrequestreview-505186346", "createdAt": "2020-10-08T21:41:27Z", "commit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2913, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}