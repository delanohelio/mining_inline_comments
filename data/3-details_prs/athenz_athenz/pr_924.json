{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MzYyNTEx", "number": 924, "title": "new zms api to delete pending members", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-03-30T01:51:45Z", "url": "https://github.com/AthenZ/athenz/pull/924", "merged": true, "mergeCommit": {"oid": "72e8eabe8418298113666b4b1875e699fb9e126b"}, "closed": true, "closedAt": "2020-03-30T20:26:53Z", "author": {"login": "havetisyan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSkhRzgH2gAyMzk1MzYyNTExOmU2NzBiNGY5ZTk5OTgxZTU3NjlhNzFmNTJkYzY1MTliNzNjODUwZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS0TbOAFqTM4NDE5NDAyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/e670b4f9e99981e5769a71f52dc6519b73c850ef", "committedDate": "2020-03-30T01:49:39Z", "message": "new zms api to delete pending members"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDQ2MDcz", "url": "https://github.com/AthenZ/athenz/pull/924#pullrequestreview-384046073", "createdAt": "2020-03-30T16:50:59Z", "commit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDkyNjM1", "url": "https://github.com/AthenZ/athenz/pull/924#pullrequestreview-384092635", "createdAt": "2020-03-30T17:50:56Z", "commit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzo1MDo1N1rOF91Vqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzo1MDo1N1rOF91Vqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTM1NA==", "bodyText": "should this be autoCommit=false?", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400381354", "createdAt": "2020-03-30T17:50:57Z", "author": {"login": "abvaidya"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -1230,7 +1230,54 @@ void executeDeleteMembership(ResourceContext ctx, String domainName, String role\n             }\n         }\n     }\n-    \n+\n+    void executeDeletePendingMembership(ResourceContext ctx, String domainName, String roleName,\n+                String normalizedMember, String auditRef, String caller) {\n+\n+        // our exception handling code does the check for retry count\n+        // and throws the exception it had received when the retry\n+        // count reaches 0\n+\n+        for (int retryCount = defaultRetryCount; ; retryCount--) {\n+\n+            try (ObjectStoreConnection con = store.getConnection(true, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDkzMTgz", "url": "https://github.com/AthenZ/athenz/pull/924#pullrequestreview-384093183", "createdAt": "2020-03-30T17:51:36Z", "commit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzo1MTozN1rOF91XUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzo1MTozN1rOF91XUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4MTc3Nw==", "bodyText": "should this be deletependingmembership_timing?", "url": "https://github.com/AthenZ/athenz/pull/924#discussion_r400381777", "createdAt": "2020-03-30T17:51:37Z", "author": {"login": "abvaidya"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3282,6 +3282,56 @@ void sendMembershipApprovalNotification(final String domain, final String org, f\n         notificationManager.sendNotifications(notifications);\n     }\n \n+    public void deletePendingMembership(ResourceContext ctx, String domainName, String roleName,\n+            String memberName, String auditRef) {\n+\n+        final String caller = \"deletependingmembership\";\n+        metric.increment(ZMSConsts.HTTP_DELETE);\n+        logPrincipal(ctx);\n+\n+        if (readOnlyMode) {\n+            throw ZMSUtils.requestError(SERVER_READ_ONLY_MESSAGE, caller);\n+        }\n+\n+        validateRequest(ctx.request(), caller);\n+\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+        validate(roleName, TYPE_ENTITY_NAME, caller);\n+        validate(memberName, TYPE_MEMBER_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all incoming object values into lower case (e.g. domain, role,\n+        // policy, service, etc name)\n+\n+        domainName = domainName.toLowerCase();\n+        roleName = roleName.toLowerCase();\n+        memberName = normalizeDomainAliasUser(memberName.toLowerCase());\n+\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        metric.increment(ZMSConsts.HTTP_REQUEST, domainName, principalDomain);\n+        metric.increment(caller, domainName, principalDomain);\n+        Object timerMetric = metric.startTiming(\"deletemembership_timing\", domainName, principalDomain);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDk1MDE4", "url": "https://github.com/AthenZ/athenz/pull/924#pullrequestreview-384095018", "createdAt": "2020-03-30T17:53:55Z", "commit": {"oid": "e670b4f9e99981e5769a71f52dc6519b73c850ef"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5425a18f57bfb6f5b24694e5dccb4744d48f0b6e", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/5425a18f57bfb6f5b24694e5dccb4744d48f0b6e", "committedDate": "2020-03-30T19:17:05Z", "message": "fixed metric name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTk0MDI3", "url": "https://github.com/AthenZ/athenz/pull/924#pullrequestreview-384194027", "createdAt": "2020-03-30T20:13:00Z", "commit": {"oid": "5425a18f57bfb6f5b24694e5dccb4744d48f0b6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3079, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}