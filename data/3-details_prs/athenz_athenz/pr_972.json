{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDA2OTk0", "number": 972, "title": "Template api implementation to expose metadata details", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-05-08T02:10:11Z", "url": "https://github.com/AthenZ/athenz/pull/972", "merged": true, "mergeCommit": {"oid": "2998392ee22dde508f7725d7dc6b5e1d4cbe6b69"}, "closed": true, "closedAt": "2020-05-14T16:36:44Z", "author": {"login": "jothi-prasad"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfVKgagFqTQwODM4Mzk2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchQLdjgFqTQxMTk4NjMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MzgzOTY0", "url": "https://github.com/AthenZ/athenz/pull/972#pullrequestreview-408383964", "createdAt": "2020-05-08T17:06:33Z", "commit": {"oid": "3c00cfffa3691dce18541bac7d41aec5b0dc242e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNzowNjozM1rOGSstGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNzoxNjowMFrOGSs-uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1OTk5Mg==", "bodyText": "these should be created after the validation of data otherwise we're just wasting resources if the request is invalid", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422259992", "createdAt": "2020-05-08T17:06:33Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2603,6 +2603,55 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = new DomainTemplateDetailsList();\n+        List<TemplateMetaData> templateMetaDataList = new ArrayList<>();\n+        Map<String, Integer> templateDomainMapping = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c00cfffa3691dce18541bac7d41aec5b0dc242e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2MTM5MQ==", "bodyText": "what are the possible cases for exception and why are hiding them?\notherwise it looks like if there is some type of exception we're going to return an empty list to the client which is not correct.\nso unless we're absolutely sure we want to swallow the exception, we shouldn't catch it and let an error be returned to the client", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422261391", "createdAt": "2020-05-08T17:09:27Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2603,6 +2603,55 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = new DomainTemplateDetailsList();\n+        List<TemplateMetaData> templateMetaDataList = new ArrayList<>();\n+        Map<String, Integer> templateDomainMapping = new HashMap<>();\n+        final String caller = \"getDomainTemplateDetailsList\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        metric.increment(ZMSConsts.HTTP_REQUEST);\n+        metric.increment(caller);\n+        logPrincipal(ctx);\n+        validateRequest(ctx.request(), caller);\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all domain into lower case\n+\n+        domainName = domainName.toLowerCase();\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        Object timerMetric = metric.startTiming(\"getdomainrolemembers_timing\", domainName, principalDomain);\n+\n+        templateDomainMapping = dbService.getDomainTemplates(domainName);\n+        if (templateDomainMapping != null) {\n+            try {\n+                for (String templateName : templateDomainMapping.keySet()) {\n+                    TemplateMetaData metaData = new TemplateMetaData();\n+                    Template template = serverSolutionTemplates.get(templateName);\n+                    // there is a possibility of a stale template coming back from DB over time(caused by template clean up)\n+                    if (template != null) {\n+                        //Merging template metadata fields from solution-templates.json and template data from DB\n+                        metaData.setTemplateName(templateName);\n+                        metaData.setCurrentVersion(templateDomainMapping.get(templateName));\n+                        metaData.setLatestVersion(template.getMetadata().getLatestVersion());\n+                        metaData.setAutoUpdate(template.getMetadata().getAutoUpdate());\n+                        metaData.setDescription(template.getMetadata().getDescription());\n+                        metaData.setKeywordsToReplace(template.metadata.getKeywordsToReplace());\n+                        metaData.setTimestamp(template.metadata.getTimestamp());\n+                        templateMetaDataList.add(metaData);\n+                    }\n+                }\n+                domainTemplateDetailsList.setMetaData(templateMetaDataList);\n+            } catch (Exception ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c00cfffa3691dce18541bac7d41aec5b0dc242e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2NDUwNw==", "bodyText": "Not sure why we're returning Map<String, Integer> here. if we add additional attributes, then this is not going to work thus is going to be changed again.\nLooking at the server side, it looks like we're taking this Map<String, Integer> and then we generate List by filling the rest of the fields in the template meta objects. So why not just return here. the api should be:\nList getDomainTemplates(String domainName);\nthen you just need fill in the other fields before returning to the client. in the future, if we need to add additional attributes, it would just require updating the TemplateMetaData object and not the api itself", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r422264507", "createdAt": "2020-05-08T17:16:00Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/ObjectStoreConnection.java", "diffHunk": "@@ -146,4 +146,6 @@\n     boolean updateRoleMemberReviewNotificationTimestamp(String server, long timestamp);\n \n     DomainRoleMembers listOverdueReviewRoleMembers(String domainName);\n+\n+    Map<String, Integer> getDomainTemplates(String domainName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c00cfffa3691dce18541bac7d41aec5b0dc242e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61796270a76a15e175e801177737510ff87e076f", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/61796270a76a15e175e801177737510ff87e076f", "committedDate": "2020-05-12T03:26:00Z", "message": "api implementation to expose template metadata details"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "033e0d753c0b2a5f46ac6fd0348c1025a6759582", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/033e0d753c0b2a5f46ac6fd0348c1025a6759582", "committedDate": "2020-05-08T22:52:37Z", "message": "Addressed review comments"}, "afterCommit": {"oid": "61796270a76a15e175e801177737510ff87e076f", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/61796270a76a15e175e801177737510ff87e076f", "committedDate": "2020-05-12T03:26:00Z", "message": "api implementation to expose template metadata details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTgwMzYz", "url": "https://github.com/AthenZ/athenz/pull/972#pullrequestreview-410180363", "createdAt": "2020-05-12T15:48:16Z", "commit": {"oid": "61796270a76a15e175e801177737510ff87e076f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNTo0ODoxNlrOGUNPOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNTo0OTozM1rOGUNSyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTU5Mg==", "bodyText": "there is no need to create this list again. we already have a list returned from dbservice. we should just add attributes and set that and return as part of our data. This way we're not just creating another set of objects which contains the same data as the original list. So just go through the list that we got on line 2629, update the objects and then on line 2650 we use that to set the meta data.\nif we come across an entry that has not value then we should send it back since that shows something not right in the db - where we have a template that no longer exists in the server.", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423841592", "createdAt": "2020-05-12T15:48:16Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;\n+        List<TemplateMetaData> templateMetaDataList;\n+        final String caller = \"getDomainTemplateDetailsList\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        metric.increment(ZMSConsts.HTTP_REQUEST);\n+        metric.increment(caller);\n+        logPrincipal(ctx);\n+        validateRequest(ctx.request(), caller);\n+        validate(domainName, TYPE_DOMAIN_NAME, caller);\n+\n+        // for consistent handling of all requests, we're going to convert\n+        // all domain into lower case\n+\n+        domainName = domainName.toLowerCase();\n+        final String principalDomain = getPrincipalDomain(ctx);\n+        Object timerMetric = metric.startTiming(\"getdomainrolemembers_timing\", domainName, principalDomain);\n+\n+        List<TemplateMetaData> templateDomainMapping = dbService.getDomainTemplates(domainName);\n+        if (templateDomainMapping != null) {\n+            domainTemplateDetailsList = new DomainTemplateDetailsList();\n+            templateMetaDataList = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61796270a76a15e175e801177737510ff87e076f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTc0Mg==", "bodyText": "this one is not needed, please see my comment below.", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423841742", "createdAt": "2020-05-12T15:48:29Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;\n+        List<TemplateMetaData> templateMetaDataList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61796270a76a15e175e801177737510ff87e076f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjUwNw==", "bodyText": "we should move this down before line 2630 to be consistent with all other methods in the class.", "url": "https://github.com/AthenZ/athenz/pull/972#discussion_r423842507", "createdAt": "2020-05-12T15:49:33Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2607,6 +2607,53 @@ public Template getTemplate(ResourceContext ctx, String templateName) {\n         return template;\n     }\n \n+    @Override\n+    public DomainTemplateDetailsList getDomainTemplateDetailsList(ResourceContext ctx, String domainName) {\n+        DomainTemplateDetailsList domainTemplateDetailsList = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61796270a76a15e175e801177737510ff87e076f"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d09af231c6e7dfd44ee83e2579488830308e1c", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/22d09af231c6e7dfd44ee83e2579488830308e1c", "committedDate": "2020-05-13T06:52:56Z", "message": "addressing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTg2MzI1", "url": "https://github.com/AthenZ/athenz/pull/972#pullrequestreview-411986325", "createdAt": "2020-05-14T16:36:35Z", "commit": {"oid": "22d09af231c6e7dfd44ee83e2579488830308e1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3110, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}