{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NTE2NDgw", "number": 1156, "title": "Fix DynamoDB errors for records with missing info in notifications", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-21T12:57:50Z", "url": "https://github.com/AthenZ/athenz/pull/1156", "merged": true, "mergeCommit": {"oid": "72d33747454d3824e4cfc03a1807683bfd99c4ea"}, "closed": true, "closedAt": "2020-10-21T15:09:48Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUs9f7gFqTUxMzY0NzExNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUu1avAFqTUxMzc5Njg2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjQ3MTE3", "url": "https://github.com/AthenZ/athenz/pull/1156#pullrequestreview-513647117", "createdAt": "2020-10-21T12:58:42Z", "commit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1ODo0M1rOHlqf3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1ODo0M1rOHlqf3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NTY0Nw==", "bodyText": "If clientCert attribute doesn't exist for some reason I set it to false.", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509255647", "createdAt": "2020-10-21T12:58:43Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -101,6 +101,13 @@ public X509CertRecord getX509CertRecord(String provider, String instanceId, Stri\n     }\n \n     private X509CertRecord itemToX509CertRecord(Item item) {\n+        boolean clientCert;\n+        try {\n+            clientCert = item.getBoolean(KEY_CLIENT_CERT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjQ3ODMz", "url": "https://github.com/AthenZ/athenz/pull/1156#pullrequestreview-513647833", "createdAt": "2020-10-21T12:59:28Z", "commit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1OToyOFrOHlqh5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1OToyOFrOHlqh5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NjE2NQ==", "bodyText": "If we'll find a problematic record, we'll print an error and continue so it won't affect other records.", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509256165", "createdAt": "2020-10-21T12:59:28Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -259,21 +266,25 @@ private String getPrimaryKey(final String provider, final String instanceId, fin\n \n         List<X509CertRecord> updatedRecords = new ArrayList<>();\n         for (Item item : items) {\n-            // For each item, update lastNotifiedTime and lastNotifiedServer (unless they were already updated)\n-            UpdateItemSpec updateItemSpec = new UpdateItemSpec().withPrimaryKey(KEY_PRIMARY, item.getString(KEY_PRIMARY))\n-                    .withReturnValues(ReturnValue.ALL_NEW)\n-                    .withUpdateExpression(\"set lastNotifiedTime = :lastNotifiedTimeVal, lastNotifiedServer = :lastNotifiedServerVal\")\n-                    .withConditionExpression(\"attribute_not_exists(lastNotifiedTime) OR lastNotifiedTime < :v_yesterday\")\n-                    .withValueMap(new ValueMap()\n-                            .with(\":lastNotifiedTimeVal\", lastNotifiedTime)\n-                            .withNumber(\":v_yesterday\", yesterday)\n-                            .withString(\":lastNotifiedServerVal\", lastNotifiedServer));\n-\n-            Item updatedItem = table.updateItem(updateItemSpec).getItem();\n-\n-            if (isRecordUpdatedWithNotificationTimeAndServer(lastNotifiedServer, lastNotifiedTime, updatedItem)) {\n-                X509CertRecord x509CertRecord = itemToX509CertRecord(updatedItem);\n-                updatedRecords.add(x509CertRecord);\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjQ5MDI3", "url": "https://github.com/AthenZ/athenz/pull/1156#pullrequestreview-513649027", "createdAt": "2020-10-21T13:00:44Z", "commit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzowMDo0NFrOHlqlUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzowMDo0NFrOHlqlUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NzA0MA==", "bodyText": "If an error is thrown for a specific combination of provider + date, we'll print it and continue so it won't affect other records.", "url": "https://github.com/AthenZ/athenz/pull/1156#discussion_r509257040", "createdAt": "2020-10-21T13:00:44Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -303,19 +314,25 @@ private boolean isRecordUpdatedWithNotificationTimeAndServer(String lastNotified\n     }\n \n     private List<Item> getUnrefreshedCertRecordsByDate(String provider, Index index, long yesterday, String unrefreshedCertDate) {\n-        QuerySpec spec = new QuerySpec()\n-                .withKeyConditionExpression(\"currentDate = :v_current_date\")\n-                .withFilterExpression(\"provider = :v_provider AND (attribute_not_exists(lastNotifiedTime) OR lastNotifiedTime < :v_last_notified)\")\n-                .withValueMap(new ValueMap()\n-                        .withString(\":v_current_date\", unrefreshedCertDate)\n-                        .withNumber(\":v_last_notified\", yesterday)\n-                        .withString(\":v_provider\", provider));\n-\n-        ItemCollection<QueryOutcome> outcome = index.query(spec);\n-        List<Item> items = new ArrayList<>();\n-        for (Item item : outcome) {\n-            items.add(item);\n+        try {\n+            QuerySpec spec = new QuerySpec()\n+                    .withKeyConditionExpression(\"currentDate = :v_current_date\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7223aa96bb5358cf445d8c6b93721fd84b62124e", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/7223aa96bb5358cf445d8c6b93721fd84b62124e", "committedDate": "2020-10-21T13:55:49Z", "message": "Fix DynamoDB errors for records with missing info in notifications"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d22d1e541602bbb825181abf9e948f75e811d40", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/2d22d1e541602bbb825181abf9e948f75e811d40", "committedDate": "2020-10-21T12:56:49Z", "message": "Fix DynamoDB errors for records with missing info in notifications"}, "afterCommit": {"oid": "7223aa96bb5358cf445d8c6b93721fd84b62124e", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/7223aa96bb5358cf445d8c6b93721fd84b62124e", "committedDate": "2020-10-21T13:55:49Z", "message": "Fix DynamoDB errors for records with missing info in notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzk2ODY0", "url": "https://github.com/AthenZ/athenz/pull/1156#pullrequestreview-513796864", "createdAt": "2020-10-21T15:09:42Z", "commit": {"oid": "7223aa96bb5358cf445d8c6b93721fd84b62124e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2921, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}